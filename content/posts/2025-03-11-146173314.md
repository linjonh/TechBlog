---
layout: post
title: "构建一个主助理代理Primary-Assistant,它可以根据用户需求调用不同的工具如航班查询酒店预订汽车租赁等,并确保对话逻辑合理"
date: 2025-03-11 11:20:57 +0800
description: "构建了一个“主助理”系统，它可以使用多种工具（搜索、航班查询、租车、酒店预订等）。使用 Assistant 类 确保大模型回答有效，避免返回空内容。定义了 ToFlightBookingAssistant 等助理任务，确保用户输入符合格式，并调用相应的工具。使用 self.builder.add_node(...) 构建系统节点，让“主助理”成为整个代理系统的一部分。"
keywords: "构建一个“主助理”代理（Primary Assistant），它可以根据用户需求调用不同的工具（如航班查询、酒店预订、汽车租赁等），并确保对话逻辑合理"
categories: ['Langgraph']
tags: ['Tools', 'Python', 'Langgraph', 'Agent']
artid: "146173314"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146173314
    alt: "构建一个主助理代理Primary-Assistant,它可以根据用户需求调用不同的工具如航班查询酒店预订汽车租赁等,并确保对话逻辑合理"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146173314
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146173314
cover: https://bing.ee123.net/img/rand?artid=146173314
image: https://bing.ee123.net/img/rand?artid=146173314
img: https://bing.ee123.net/img/rand?artid=146173314
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     构建一个“主助理”代理（Primary Assistant），它可以根据用户需求调用不同的工具（如航班查询、酒店预订、汽车租赁等），并确保对话逻辑合理
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     <strong>
      build_agent_runnables.py
     </strong>
    </p>
    <pre><code class="prism language-python"><span class="token keyword">from</span> tools<span class="token punctuation">.</span>tools_lookup_policy <span class="token keyword">import</span> lookup_policy
<span class="token keyword">from</span> tools<span class="token punctuation">.</span>tools_flights <span class="token keyword">import</span> search_flights<span class="token punctuation">,</span> update_ticket_to_new_flight<span class="token punctuation">,</span> cancel_ticket
<span class="token keyword">from</span> tools<span class="token punctuation">.</span>tools_hotels <span class="token keyword">import</span> search_hotels<span class="token punctuation">,</span> book_hotel<span class="token punctuation">,</span> update_hotel<span class="token punctuation">,</span> cancel_hotel
<span class="token keyword">from</span> tools<span class="token punctuation">.</span>tools_excursions <span class="token keyword">import</span> search_trip_recommendations<span class="token punctuation">,</span> book_excursion<span class="token punctuation">,</span> update_excursion<span class="token punctuation">,</span> cancel_excursion
<span class="token keyword">from</span> tools<span class="token punctuation">.</span>tools_car_rental <span class="token keyword">import</span> search_car_rentals<span class="token punctuation">,</span> book_car_rental<span class="token punctuation">,</span> update_car_rental<span class="token punctuation">,</span> cancel_car_rental
<span class="token keyword">from</span> load_config <span class="token keyword">import</span> LoadConfig
<span class="token keyword">from</span> langchain_community<span class="token punctuation">.</span>tools<span class="token punctuation">.</span>tavily_search <span class="token keyword">import</span> TavilySearchResults
<span class="token keyword">from</span> agentic_system_design<span class="token punctuation">.</span>build_agent_prompts <span class="token keyword">import</span> AgentPrompts
<span class="token keyword">from</span> agentic_system_design<span class="token punctuation">.</span>complete_or_escalate <span class="token keyword">import</span> CompleteOrEscalate
<span class="token keyword">from</span> agentic_system_design<span class="token punctuation">.</span>build_agent_assistants <span class="token keyword">import</span> ToFlightBookingAssistant<span class="token punctuation">,</span> ToBookCarRentalAssistant<span class="token punctuation">,</span> ToHotelBookingAssistant<span class="token punctuation">,</span> ToBookExcursionAssistant

<span class="token keyword">def</span> <span class="token function">build_primary_assistant_runnable</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    primary_assistant_tools <span class="token operator">=</span> <span class="token punctuation">[</span>
        TavilySearchResults<span class="token punctuation">(</span>max_results<span class="token operator">=</span>CFG<span class="token punctuation">.</span>tavily_search_max_results<span class="token punctuation">)</span><span class="token punctuation">,</span>
        search_flights<span class="token punctuation">,</span>
        lookup_policy<span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
    primary_assistant_runnable <span class="token operator">=</span> AGENT_PROMPTS<span class="token punctuation">.</span>primary_assistant_prompt <span class="token operator">|</span> CFG<span class="token punctuation">.</span>llm<span class="token punctuation">.</span>bind_tools<span class="token punctuation">(</span>
        primary_assistant_tools
        <span class="token operator">+</span> <span class="token punctuation">[</span>
            ToFlightBookingAssistant<span class="token punctuation">,</span>
            ToBookCarRentalAssistant<span class="token punctuation">,</span>
            ToHotelBookingAssistant<span class="token punctuation">,</span>
            ToBookExcursionAssistant<span class="token punctuation">,</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">return</span> primary_assistant_tools<span class="token punctuation">,</span> primary_assistant_runnable
</code></pre>
    <p>
     <strong>
      build_agent_assistants.py
     </strong>
    </p>
    <pre><code class="prism language-python"><span class="token keyword">from</span> langchain_core<span class="token punctuation">.</span>runnables <span class="token keyword">import</span> Runnable<span class="token punctuation">,</span> RunnableConfig
<span class="token keyword">from</span> agentic_system_design<span class="token punctuation">.</span>build_agent_state <span class="token keyword">import</span> State
<span class="token comment"># from langchain_core.pydantic_v1 import BaseModel, Field</span>
<span class="token keyword">from</span> pydantic <span class="token keyword">import</span> BaseModel<span class="token punctuation">,</span> Field


<span class="token keyword">class</span> <span class="token class-name">Assistant</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    A class to manage interactions with a runnable agent and ensure valid responses.

    Attributes:
        runnable (Runnable): An instance of the Runnable class used to invoke actions and obtain results.

    Methods:
        __call__(state: State, config: RunnableConfig) -&gt; dict:
            Executes the runnable with the provided state and configuration, and handles invalid responses by updating
            the state with appropriate messages until a valid response is obtained.

    Args:
        runnable (Runnable): The runnable instance that performs the actual work and provides the result.
    """</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> runnable<span class="token punctuation">:</span> Runnable<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Initializes the Assistant with a runnable instance.

        Args:
            runnable (Runnable): An instance of the Runnable class to be used for invoking actions.
        """</span>
        self<span class="token punctuation">.</span>runnable <span class="token operator">=</span> runnable

    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> state<span class="token punctuation">:</span> State<span class="token punctuation">,</span> config<span class="token punctuation">:</span> RunnableConfig<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Executes the runnable with the given state and configuration, and ensures the response is valid.

        The method continuously invokes the runnable until a valid response is obtained. If the response is invalid (e.g., 
        no tool calls and empty or invalid content), it updates the state with a message prompting for a real output.

        Args:
            state (State): The current state of the agent, including messages and other relevant information.
            config (RunnableConfig): Configuration settings for the runnable.

        Returns:
            dict: A dictionary containing the updated messages and result from the runnable invocation.

        Example:
            result = self(state, config)
        """</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            result <span class="token operator">=</span> self<span class="token punctuation">.</span>runnable<span class="token punctuation">.</span>invoke<span class="token punctuation">(</span>state<span class="token punctuation">)</span>

            <span class="token keyword">if</span> <span class="token keyword">not</span> result<span class="token punctuation">.</span>tool_calls <span class="token keyword">and</span> <span class="token punctuation">(</span>
                <span class="token keyword">not</span> result<span class="token punctuation">.</span>content
                <span class="token keyword">or</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>content<span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span>
                <span class="token keyword">and</span> <span class="token keyword">not</span> result<span class="token punctuation">.</span>content<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"text"</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">:</span>
                messages <span class="token operator">=</span> state<span class="token punctuation">[</span><span class="token string">"messages"</span><span class="token punctuation">]</span> <span class="token operator">+</span> \
                    <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"Respond with a real output."</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
                state <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token operator">**</span>state<span class="token punctuation">,</span> <span class="token string">"messages"</span><span class="token punctuation">:</span> messages<span class="token punctuation">}</span>
                messages <span class="token operator">=</span> state<span class="token punctuation">[</span><span class="token string">"messages"</span><span class="token punctuation">]</span> <span class="token operator">+</span> \
                    <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"Respond with a real output."</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
                state <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token operator">**</span>state<span class="token punctuation">,</span> <span class="token string">"messages"</span><span class="token punctuation">:</span> messages<span class="token punctuation">}</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">break</span>
        <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span><span class="token string">"messages"</span><span class="token punctuation">:</span> result<span class="token punctuation">}</span>


<span class="token comment"># Primary Assistant</span>
<span class="token keyword">class</span> <span class="token class-name">ToFlightBookingAssistant</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Transfers work to a specialized assistant to handle flight updates and cancellations."""</span>

    request<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>
        description<span class="token operator">=</span><span class="token string">"Any necessary followup questions the update flight assistant should clarify before proceeding."</span>
    <span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">ToBookCarRentalAssistant</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Transfers work to a specialized assistant to handle car rental bookings."""</span>

    location<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>
        description<span class="token operator">=</span><span class="token string">"The location where the user wants to rent a car."</span>
    <span class="token punctuation">)</span>
    start_date<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>description<span class="token operator">=</span><span class="token string">"The start date of the car rental."</span><span class="token punctuation">)</span>
    end_date<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>description<span class="token operator">=</span><span class="token string">"The end date of the car rental."</span><span class="token punctuation">)</span>
    request<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>
        description<span class="token operator">=</span><span class="token string">"Any additional information or requests from the user regarding the car rental."</span>
    <span class="token punctuation">)</span>

    <span class="token keyword">class</span> <span class="token class-name">Config</span><span class="token punctuation">:</span>
        schema_extra <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"example"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">"location"</span><span class="token punctuation">:</span> <span class="token string">"Basel"</span><span class="token punctuation">,</span>
                <span class="token string">"start_date"</span><span class="token punctuation">:</span> <span class="token string">"2023-07-01"</span><span class="token punctuation">,</span>
                <span class="token string">"end_date"</span><span class="token punctuation">:</span> <span class="token string">"2023-07-05"</span><span class="token punctuation">,</span>
                <span class="token string">"request"</span><span class="token punctuation">:</span> <span class="token string">"I need a compact car with automatic transmission."</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>


<span class="token keyword">class</span> <span class="token class-name">ToHotelBookingAssistant</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Transfer work to a specialized assistant to handle hotel bookings."""</span>

    location<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>
        description<span class="token operator">=</span><span class="token string">"The location where the user wants to book a hotel."</span>
    <span class="token punctuation">)</span>
    checkin_date<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>description<span class="token operator">=</span><span class="token string">"The check-in date for the hotel."</span><span class="token punctuation">)</span>
    checkout_date<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>description<span class="token operator">=</span><span class="token string">"The check-out date for the hotel."</span><span class="token punctuation">)</span>
    request<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>
        description<span class="token operator">=</span><span class="token string">"Any additional information or requests from the user regarding the hotel booking."</span>
    <span class="token punctuation">)</span>

    <span class="token keyword">class</span> <span class="token class-name">Config</span><span class="token punctuation">:</span>
        schema_extra <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"example"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">"location"</span><span class="token punctuation">:</span> <span class="token string">"Zurich"</span><span class="token punctuation">,</span>
                <span class="token string">"checkin_date"</span><span class="token punctuation">:</span> <span class="token string">"2023-08-15"</span><span class="token punctuation">,</span>
                <span class="token string">"checkout_date"</span><span class="token punctuation">:</span> <span class="token string">"2023-08-20"</span><span class="token punctuation">,</span>
                <span class="token string">"request"</span><span class="token punctuation">:</span> <span class="token string">"I prefer a hotel near the city center with a room that has a view."</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>


<span class="token keyword">class</span> <span class="token class-name">ToBookExcursionAssistant</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Transfers work to a specialized assistant to handle trip recommendation and other excursion bookings."""</span>

    location<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>
        description<span class="token operator">=</span><span class="token string">"The location where the user wants to book a recommended trip."</span>
    <span class="token punctuation">)</span>
    request<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>
        description<span class="token operator">=</span><span class="token string">"Any additional information or requests from the user regarding the trip recommendation."</span>
    <span class="token punctuation">)</span>

    <span class="token keyword">class</span> <span class="token class-name">Config</span><span class="token punctuation">:</span>
        schema_extra <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"example"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">"location"</span><span class="token punctuation">:</span> <span class="token string">"Lucerne"</span><span class="token punctuation">,</span>
                <span class="token string">"request"</span><span class="token punctuation">:</span> <span class="token string">"The user is interested in outdoor activities and scenic views."</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

self<span class="token punctuation">.</span>builder<span class="token punctuation">.</span>add_node<span class="token punctuation">(</span><span class="token string">"primary_assistant"</span><span class="token punctuation">,</span> Assistant<span class="token punctuation">(</span>
            AGENT_RUNNABLES<span class="token punctuation">.</span>primary_assistant_runnable<span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>builder<span class="token punctuation">.</span>add_node<span class="token punctuation">(</span>
            <span class="token string">"primary_assistant_tools"</span><span class="token punctuation">,</span> create_tool_node_with_fallback<span class="token punctuation">(</span>
                AGENT_RUNNABLES<span class="token punctuation">.</span>primary_assistant_tools<span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
</code></pre>
    <p>
     这段代码的作用是构建一个“主助理”代理（Primary Assistant），它可以根据用户需求调用不同的工具（如航班查询、酒店预订、汽车租赁等），并确保对话逻辑合理。代码主要由以下几个部分组成：
    </p>
    <hr/>
    <h4>
     <a id="1_build_primary_assistant_runnableself__187">
     </a>
     <strong>
      1.
      <code>
       build_primary_assistant_runnable(self)
      </code>
      方法
     </strong>
    </h4>
    <p>
     <strong>
      功能：
     </strong>
     <br/>
     这个方法创建了主助理（Primary Assistant），并为它绑定多个可用的工具，让它能够处理各种任务。
    </p>
    <p>
     <strong>
      关键步骤：
     </strong>
    </p>
    <ul>
     <li>
      <p>
       <strong>
        定义工具
        <code>
         primary_assistant_tools
        </code>
        ：
       </strong>
      </p>
      <pre><code class="prism language-python">primary_assistant_tools <span class="token operator">=</span> <span class="token punctuation">[</span>
    TavilySearchResults<span class="token punctuation">(</span>max_results<span class="token operator">=</span>CFG<span class="token punctuation">.</span>tavily_search_max_results<span class="token punctuation">)</span><span class="token punctuation">,</span>
    search_flights<span class="token punctuation">,</span>
    lookup_policy<span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre>
      <ul>
       <li>
        <code>
         TavilySearchResults(max_results=CFG.tavily_search_max_results)
        </code>
        ：使用 Tavily 搜索 API 进行信息查询，最多返回
        <code>
         CFG.tavily_search_max_results
        </code>
        个搜索结果。例如，如果
        <code>
         CFG.tavily_search_max_results=5
        </code>
        ，那么搜索 “瑞士旅游” 可能返回 5 个相关网页。
       </li>
       <li>
        <code>
         search_flights
        </code>
        ：一个航班搜索工具（未提供具体实现），假设它能查询航班价格、时间等信息。
       </li>
       <li>
        <code>
         lookup_policy
        </code>
        ：是一个查询政策信息的工具，比如航班改签政策等。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        绑定其他工具（代理任务）
       </strong>
      </p>
      <pre><code class="prism language-python">primary_assistant_runnable <span class="token operator">=</span> AGENT_PROMPTS<span class="token punctuation">.</span>primary_assistant_prompt <span class="token operator">|</span> CFG<span class="token punctuation">.</span>llm<span class="token punctuation">.</span>bind_tools<span class="token punctuation">(</span>
    primary_assistant_tools
    <span class="token operator">+</span> <span class="token punctuation">[</span>
        ToFlightBookingAssistant<span class="token punctuation">,</span>
        ToBookCarRentalAssistant<span class="token punctuation">,</span>
        ToHotelBookingAssistant<span class="token punctuation">,</span>
        ToBookExcursionAssistant<span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">)</span>
</code></pre>
      <ul>
       <li>
        这里
        <code>
         AGENT_PROMPTS.primary_assistant_prompt
        </code>
        可能是一个预设的提示词（Prompt），用来指导 LLM（大模型）回答问题。
       </li>
       <li>
        <code>
         CFG.llm.bind_tools(...)
        </code>
        绑定了所有工具，包括
        <code>
         primary_assistant_tools
        </code>
        和四个具体的助理任务：
        <ul>
         <li>
          <code>
           ToFlightBookingAssistant
          </code>
          ：航班更新/取消助理
         </li>
         <li>
          <code>
           ToBookCarRentalAssistant
          </code>
          ：租车预订助理
         </li>
         <li>
          <code>
           ToHotelBookingAssistant
          </code>
          ：酒店预订助理
         </li>
         <li>
          <code>
           ToBookExcursionAssistant
          </code>
          ：旅行推荐助理
         </li>
        </ul>
       </li>
      </ul>
      <p>
       <strong>
        示例
       </strong>
      </p>
      <ul>
       <li>
        用户询问：“我想预订 3 月 15 日从纽约到伦敦的航班。”
       </li>
       <li>
        <code>
         primary_assistant_runnable
        </code>
        可能会调用
        <code>
         search_flights
        </code>
        来获取航班信息，并返回可选航班列表。
       </li>
      </ul>
     </li>
    </ul>
    <hr/>
    <h4>
     <a id="2_Assistant__229">
     </a>
     <strong>
      2.
      <code>
       Assistant
      </code>
      类
     </strong>
    </h4>
    <p>
     <strong>
      功能：
     </strong>
    </p>
    <ul>
     <li>
      这个类用于执行
      <code>
       Runnable
      </code>
      （可运行对象），确保大模型的回答是有效的。
     </li>
     <li>
      如果大模型的回答无效，比如内容为空或没有调用工具，它会不断地让大模型重试，直到得到有效的回答。
     </li>
    </ul>
    <p>
     <strong>
      关键步骤：
     </strong>
    </p>
    <pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">Assistant</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> runnable<span class="token punctuation">:</span> Runnable<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>runnable <span class="token operator">=</span> runnable
</code></pre>
    <ul>
     <li>
      <code>
       self.runnable
      </code>
      绑定了
      <code>
       Runnable
      </code>
      对象，表示这个助手可以运行大模型的推理逻辑。
     </li>
    </ul>
    <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> state<span class="token punctuation">:</span> State<span class="token punctuation">,</span> config<span class="token punctuation">:</span> RunnableConfig<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        result <span class="token operator">=</span> self<span class="token punctuation">.</span>runnable<span class="token punctuation">.</span>invoke<span class="token punctuation">(</span>state<span class="token punctuation">)</span>
</code></pre>
    <ul>
     <li>
      <code>
       invoke(state)
      </code>
      运行模型，并传入
      <code>
       state
      </code>
      （对话的当前状态，例如用户的历史对话信息）。
     </li>
    </ul>
    <pre><code class="prism language-python"><span class="token keyword">if</span> <span class="token keyword">not</span> result<span class="token punctuation">.</span>tool_calls <span class="token keyword">and</span> <span class="token punctuation">(</span>
    <span class="token keyword">not</span> result<span class="token punctuation">.</span>content
    <span class="token keyword">or</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>content<span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span>
    <span class="token keyword">and</span> <span class="token keyword">not</span> result<span class="token punctuation">.</span>content<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"text"</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>
</code></pre>
    <ul>
     <li>
      这里检查模型的输出是否有效：
      <ul>
       <li>
        <code>
         result.tool_calls
        </code>
        是否为空？（即模型有没有调用工具）
       </li>
       <li>
        <code>
         result.content
        </code>
        是否为空？（即回答内容是否为空）
       </li>
       <li>
        <code>
         result.content[0].get("text")
        </code>
        是否为空？（如果内容是一个列表，里面有没有文本）
       </li>
      </ul>
     </li>
    </ul>
    <p>
     如果模型回答无效，则：
    </p>
    <pre><code class="prism language-python">messages <span class="token operator">=</span> state<span class="token punctuation">[</span><span class="token string">"messages"</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"Respond with a real output."</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
state <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token operator">**</span>state<span class="token punctuation">,</span> <span class="token string">"messages"</span><span class="token punctuation">:</span> messages<span class="token punctuation">}</span>
</code></pre>
    <ul>
     <li>
      强制让模型返回一个“真实的”回答，并更新
      <code>
       state
      </code>
      ，让它重试。
     </li>
    </ul>
    <p>
     <strong>
      示例
     </strong>
    </p>
    <ul>
     <li>
      用户：
      <strong>
       “请帮我预订一辆车。”
      </strong>
      <ul>
       <li>
        如果模型的初次回答是空的，代码会让它重试，直到返回“我可以帮您预订，请提供租车的地点和时间。”
       </li>
      </ul>
     </li>
    </ul>
    <hr/>
    <h4>
     <a id="3_ToFlightBookingAssistant__274">
     </a>
     <strong>
      3.
      <code>
       ToFlightBookingAssistant
      </code>
      等四个工具
     </strong>
    </h4>
    <p>
     这些
     <code>
      BaseModel
     </code>
     代表具体的助理任务。
     <strong>
      使用
      <code>
       pydantic
      </code>
      定义数据结构，确保用户提供的参数符合要求
     </strong>
     。
    </p>
    <h5>
     <a id="_277">
     </a>
     <strong>
      航班更新助理
     </strong>
    </h5>
    <pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">ToFlightBookingAssistant</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    request<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>
        description<span class="token operator">=</span><span class="token string">"更新航班助手在继续操作之前需要澄清任何必要的后续问题"</span>
    <span class="token punctuation">)</span>
</code></pre>
    <ul>
     <li>
      这个助理用于处理航班更新或取消，
      <code>
       request
      </code>
      字段表示它可能需要向用户询问更多信息。
     </li>
    </ul>
    <p>
     <strong>
      示例
     </strong>
    </p>
    <ul>
     <li>
      用户输入：“帮我取消航班。”
     </li>
     <li>
      <code>
       request
      </code>
      可能被设为
      <code>
       "请提供航班号，以便处理取消请求。"
      </code>
     </li>
    </ul>
    <hr/>
    <h5>
     <a id="_292">
     </a>
     <strong>
      租车预订助理
     </strong>
    </h5>
    <pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">ToBookCarRentalAssistant</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    location<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>description<span class="token operator">=</span><span class="token string">"The location where the user wants to rent a car."</span><span class="token punctuation">)</span>
    start_date<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>description<span class="token operator">=</span><span class="token string">"The start date of the car rental."</span><span class="token punctuation">)</span>
    end_date<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>description<span class="token operator">=</span><span class="token string">"The end date of the car rental."</span><span class="token punctuation">)</span>
    request<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>description<span class="token operator">=</span><span class="token string">"Any additional information or requests from the user regarding the car rental."</span><span class="token punctuation">)</span>
</code></pre>
    <ul>
     <li>
      需要提供
      <code>
       location
      </code>
      （地点）、
      <code>
       start_date
      </code>
      （开始日期）、
      <code>
       end_date
      </code>
      （结束日期）和
      <code>
       request
      </code>
      （额外需求）。
     </li>
    </ul>
    <p>
     <strong>
      示例
     </strong>
    </p>
    <pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"location"</span><span class="token operator">:</span> <span class="token string">"Basel"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"start_date"</span><span class="token operator">:</span> <span class="token string">"2023-07-01"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"end_date"</span><span class="token operator">:</span> <span class="token string">"2023-07-05"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"request"</span><span class="token operator">:</span> <span class="token string">"I need a compact car with automatic transmission."</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     用户可能输入：“我要在巴塞尔租一辆车，从 7 月 1 日到 7 月 5 日。”
     <br/>
     助理会调用相应的租车 API 进行查询。
    </p>
    <hr/>
    <h4>
     <a id="4_selfbuilderadd_node_316">
     </a>
     <strong>
      4.
      <code>
       self.builder.add_node(...)
      </code>
     </strong>
    </h4>
    <pre><code class="prism language-python">self<span class="token punctuation">.</span>builder<span class="token punctuation">.</span>add_node<span class="token punctuation">(</span><span class="token string">"primary_assistant"</span><span class="token punctuation">,</span> Assistant<span class="token punctuation">(</span>
    AGENT_RUNNABLES<span class="token punctuation">.</span>primary_assistant_runnable<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
    <ul>
     <li>
      这里将
      <code>
       primary_assistant_runnable
      </code>
      （主助理）添加到构建器
      <code>
       self.builder
      </code>
      中，表示它是系统的一个节点。
     </li>
    </ul>
    <pre><code class="prism language-python">self<span class="token punctuation">.</span>builder<span class="token punctuation">.</span>add_node<span class="token punctuation">(</span>
    <span class="token string">"primary_assistant_tools"</span><span class="token punctuation">,</span> create_tool_node_with_fallback<span class="token punctuation">(</span>
        AGENT_RUNNABLES<span class="token punctuation">.</span>primary_assistant_tools<span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre>
    <ul>
     <li>
      <code>
       create_tool_node_with_fallback(...)
      </code>
      可能是一个函数，用来保证工具可用。如果工具失败，系统可能会尝试其他方法。
     </li>
    </ul>
    <hr/>
    <h4>
     <a id="_333">
     </a>
     <strong>
      总结
     </strong>
    </h4>
    <ol>
     <li>
      <strong>
       构建了一个“主助理”系统
      </strong>
      ，它可以使用多种工具（搜索、航班查询、租车、酒店预订等）。
     </li>
     <li>
      <strong>
       使用
       <code>
        Assistant
       </code>
       类
      </strong>
      确保大模型回答有效，避免返回空内容。
     </li>
     <li>
      <strong>
       定义了
       <code>
        ToFlightBookingAssistant
       </code>
       等助理任务
      </strong>
      ，确保用户输入符合格式，并调用相应的工具。
     </li>
     <li>
      <strong>
       使用
       <code>
        self.builder.add_node(...)
       </code>
       构建系统节点
      </strong>
      ，让“主助理”成为整个代理系统的一部分。
     </li>
    </ol>
    <p>
     <strong>
      示例流程
     </strong>
     <br/>
     用户：
     <strong>
      “我要预订 3 月 10 日到 3 月 15 日在伦敦的酒店。”
     </strong>
     <br/>
     →
     <code>
      primary_assistant_runnable
     </code>
     识别到需要
     <code>
      ToHotelBookingAssistant
     </code>
     <br/>
     → 助理询问：“您是否有酒店偏好，比如靠近地铁或带早餐？”
     <br/>
     → 调用 API 返回可选酒店列表
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f:626c6f672e6373646e2e6e65742f753031333536353133332f:61727469636c652f64657461696c732f313436313733333134" class_="artid" style="display:none">
 </p>
</div>


