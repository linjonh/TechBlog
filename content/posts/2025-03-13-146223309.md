---
layout: post
title: "用PHP的Guzzle库编写的图片爬虫程序"
date: 2025-03-13 09:58:39 +0800
description: "使用 PHP 的 Guzzle 库编写一个图片爬虫程序是一个非常常见的任务，Guzzle 是一个流行的 HTTP 请求库，允许你轻松地发送请求和处理响应。"
keywords: "用PHP的Guzzle库编写的图片爬虫程序"
categories: ['未分类']
tags: ['爬虫', '开发语言', 'Php', 'Http', 'Golang', 'Android']
artid: "146223309"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146223309
    alt: "用PHP的Guzzle库编写的图片爬虫程序"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146223309
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146223309
cover: https://bing.ee123.net/img/rand?artid=146223309
image: https://bing.ee123.net/img/rand?artid=146223309
img: https://bing.ee123.net/img/rand?artid=146223309
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     用PHP的Guzzle库编写的图片爬虫程序
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     使用 PHP 的 Guzzle 库编写一个图片爬虫程序是一个非常常见的任务，Guzzle 是一个流行的 HTTP 请求库，允许你轻松地发送请求和处理响应。
    </p>
    <p>
     下面是一个使用 Guzzle 编写的图片爬虫程序示例。此程序将从指定的网页中提取图片链接并将图片下载到本地。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/c5683707eb7a46128dbc59d98af5d6cb.png#pic_center"/>
    </p>
    <p>
     <strong>
      1、安装 Guzzle
     </strong>
    </p>
    <p>
     首先，确保你已经安装了 Guzzle 库。你可以通过 Composer 安装 Guzzle：
    </p>
    <pre><code class="prism language-bash"><span class="token function">composer</span> require guzzlehttp/guzzle
</code></pre>
    <p>
     <strong>
      2、创建图片爬虫程序
     </strong>
    </p>
    <p>
     接下来，我们创建一个 PHP 文件
     <code>
      image_scraper.php
     </code>
     ，该文件会爬取指定网页中的图片链接，并将其下载到本地。
    </p>
    <p>
     <strong>
      代码示例：
     </strong>
    </p>
    <pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">require</span> <span class="token string single-quoted-string">'vendor/autoload.php'</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">GuzzleHttp<span class="token punctuation">\</span>Client</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">GuzzleHttp<span class="token punctuation">\</span>Exception<span class="token punctuation">\</span>RequestException</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">GuzzleHttp<span class="token punctuation">\</span>Exception<span class="token punctuation">\</span>GuzzleException</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Symfony<span class="token punctuation">\</span>Component<span class="token punctuation">\</span>DomCrawler<span class="token punctuation">\</span>Crawler</span><span class="token punctuation">;</span>

<span class="token comment">// 创建 Guzzle 客户端</span>
<span class="token variable">$client</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Client</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 下载图片函数</span>
<span class="token keyword">function</span> <span class="token function-definition function">downloadImage</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">,</span> <span class="token variable">$savePath</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">global</span> <span class="token variable">$client</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 发送 GET 请求获取图片数据</span>
        <span class="token variable">$response</span> <span class="token operator">=</span> <span class="token variable">$client</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'sink'</span> <span class="token operator">=&gt;</span> <span class="token variable">$savePath</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"下载完成: <span class="token interpolation"><span class="token variable">$savePath</span></span>\n"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RequestException</span> <span class="token variable">$e</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"下载失败: <span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token variable">$e</span><span class="token operator">-&gt;</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 爬取网页中的图片链接</span>
<span class="token keyword">function</span> <span class="token function-definition function">scrapeImages</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">,</span> <span class="token variable">$saveDir</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">global</span> <span class="token variable">$client</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 发送 GET 请求获取网页内容</span>
        <span class="token variable">$response</span> <span class="token operator">=</span> <span class="token variable">$client</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$html</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword type-casting">string</span><span class="token punctuation">)</span> <span class="token variable">$response</span><span class="token operator">-&gt;</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 使用 DomCrawler 提取图片标签中的 src 属性</span>
        <span class="token variable">$crawler</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Crawler</span><span class="token punctuation">(</span><span class="token variable">$html</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$images</span> <span class="token operator">=</span> <span class="token variable">$crawler</span><span class="token operator">-&gt;</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'img'</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">each</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token class-name type-declaration">Crawler</span> <span class="token variable">$node</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token variable">$node</span><span class="token operator">-&gt;</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'src'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 确保保存目录存在</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_dir</span><span class="token punctuation">(</span><span class="token variable">$saveDir</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token variable">$saveDir</span><span class="token punctuation">,</span> <span class="token number">0777</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 下载每一张图片</span>
        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$images</span> <span class="token keyword">as</span> <span class="token variable">$index</span> <span class="token operator">=&gt;</span> <span class="token variable">$imageUrl</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token variable">$imageUrl</span> <span class="token operator">=</span> <span class="token function">filter_var</span><span class="token punctuation">(</span><span class="token variable">$imageUrl</span><span class="token punctuation">,</span> <span class="token constant">FILTER_VALIDATE_URL</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token variable">$imageUrl</span> <span class="token punctuation">:</span> <span class="token variable">$url</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'/'</span> <span class="token operator">.</span> <span class="token function">ltrim</span><span class="token punctuation">(</span><span class="token variable">$imageUrl</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$imagePath</span> <span class="token operator">=</span> <span class="token variable">$saveDir</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'/image_'</span> <span class="token operator">.</span> <span class="token punctuation">(</span><span class="token variable">$index</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'.jpg'</span><span class="token punctuation">;</span>
            <span class="token function">downloadImage</span><span class="token punctuation">(</span><span class="token variable">$imageUrl</span><span class="token punctuation">,</span> <span class="token variable">$imagePath</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">GuzzleException</span> <span class="token variable">$e</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"请求失败: <span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token variable">$e</span><span class="token operator">-&gt;</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>\n"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 主程序</span>
<span class="token variable">$url</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'https://example.com'</span><span class="token punctuation">;</span>  <span class="token comment">// 替换为要爬取的网页 URL</span>
<span class="token variable">$saveDir</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'downloaded_images'</span><span class="token punctuation">;</span>  <span class="token comment">// 图片保存目录</span>
<span class="token function">scrapeImages</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">,</span> <span class="token variable">$saveDir</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     <strong>
      代码说明：
     </strong>
    </p>
    <ol>
     <li>
      <p>
       <strong>
        Guzzle 客户端
       </strong>
       ：
      </p>
      <ul>
       <li>
        使用
        <code>
         new Client()
        </code>
        创建一个 Guzzle HTTP 客户端实例，用于发送请求。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        <code>
         downloadImage
        </code>
        函数
       </strong>
       ：
      </p>
      <ul>
       <li>
        这个函数接收图片的 URL 和保存路径，发送 GET 请求获取图片并将其保存到指定路径。
       </li>
       <li>
        <code>
         sink
        </code>
        选项告诉 Guzzle 直接将响应的内容保存到文件中。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        <code>
         scrapeImages
        </code>
        函数
       </strong>
       ：
      </p>
      <ul>
       <li>
        发送 GET 请求获取网页 HTML 内容。
       </li>
       <li>
        使用
        <code>
         Symfony\Component\DomCrawler\Crawler
        </code>
        类解析网页并提取所有
        <code>
         &lt;img&gt;
        </code>
        标签的
        <code>
         src
        </code>
        属性值，获取图片的 URL。
       </li>
       <li>
        <code>
         filter('img')
        </code>
        用于选择网页中的所有图片标签。
       </li>
       <li>
        <code>
         each
        </code>
        方法用于遍历每个图片节点，提取其
        <code>
         src
        </code>
        属性并保存到数组中。
       </li>
       <li>
        为每个图片 URL 下载并保存图片，保存路径为
        <code>
         downloaded_images/image_1.jpg
        </code>
        等。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        相对路径问题
       </strong>
       ：
      </p>
      <ul>
       <li>
        如果图片链接是相对路径，代码会自动将它转换为绝对路径。
        <code>
         filter_var($imageUrl, FILTER_VALIDATE_URL)
        </code>
        判断 URL 是否为有效的绝对路径，如果不是，则拼接基 URL。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        文件夹创建
       </strong>
       ：
      </p>
      <ul>
       <li>
        <code>
         mkdir($saveDir, 0777, true)
        </code>
        会创建保存图片的目录，如果目录不存在的话。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        错误处理
       </strong>
       ：
      </p>
      <ul>
       <li>
        使用
        <code>
         try-catch
        </code>
        捕获请求失败或下载失败的错误，并打印错误消息。
       </li>
      </ul>
     </li>
    </ol>
    <p>
     <strong>
      3、运行程序
     </strong>
    </p>
    <ol>
     <li>
      将上述代码保存为
      <code>
       image_scraper.php
      </code>
      文件。
     </li>
     <li>
      运行 PHP 文件：
     </li>
    </ol>
    <pre><code class="prism language-bash">php image_scraper.php
</code></pre>
    <p>
     程序会从指定的网页中提取图片 URL，并将其保存到本地目录
     <code>
      downloaded_images
     </code>
     中。
    </p>
    <p>
     <strong>
      4、总结
     </strong>
    </p>
    <p>
     此程序使用 Guzzle 和 Symfony 的
     <code>
      DomCrawler
     </code>
     来抓取网页中的图片并将其下载到本地。它能够处理网页中的图片 URL，并确保下载的文件保存到指定的目录中。
    </p>
    <p>
     如果网页的图片链接是相对路径，程序会自动拼接成完整的 URL。你可以根据需要扩展此程序，例如支持下载其他类型的资源、处理不同类型的网页结构等。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f34343631373635312f:61727469636c652f64657461696c732f313436323233333039" class_="artid" style="display:none">
 </p>
</div>


