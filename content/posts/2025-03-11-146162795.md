---
layout: post
title: "Android12-应用更新开机动画"
date: 2025-03-11 13:56:49 +0800
description: "项目selinux是打开的，会涉及到权限问题，所以实在具有系统签名的应用中实现。将动画资源包放到目录在中添加路径。"
keywords: "Android12 应用更新开机动画"
categories: ['系统修改与定制', 'Android']
tags: ['Bootanimation']
artid: "146162795"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146162795
    alt: "Android12-应用更新开机动画"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146162795
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146162795
cover: https://bing.ee123.net/img/rand?artid=146162795
image: https://bing.ee123.net/img/rand?artid=146162795
img: https://bing.ee123.net/img/rand?artid=146162795
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Android12 应用更新开机动画
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-tomorrow-night" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     项目selinux是打开的，会涉及到权限问题，所以实在具有系统签名的应用中实现。
    </p>
    <p>
     将动画资源包放到
     <code>
      "/data/local/traces"
     </code>
     目录
    </p>
    <ul>
     <li>
      system/core/rootdir/init.rc
     </li>
    </ul>
    <pre><code class="prism language-java"> # <span class="token class-name">For</span> security reasons<span class="token punctuation">,</span> <span class="token operator">/</span>data<span class="token operator">/</span>local<span class="token operator">/</span>tmp should always be empty<span class="token punctuation">.</span>
 # <span class="token class-name">Do</span> not place files or directories in <span class="token operator">/</span>data<span class="token operator">/</span>local<span class="token operator">/</span>tmp
 mkdir <span class="token operator">/</span>data<span class="token operator">/</span>local<span class="token operator">/</span>tmp <span class="token number">0771</span> shell shell
 mkdir <span class="token operator">/</span>data<span class="token operator">/</span>local<span class="token operator">/</span>traces <span class="token number">0777</span> shell shell
 mkdir <span class="token operator">/</span>data<span class="token operator">/</span>data <span class="token number">0771</span> system system encryption<span class="token operator">=</span><span class="token class-name">None</span>
 mkdir <span class="token operator">/</span>data<span class="token operator">/</span>app<span class="token operator">-</span><span class="token keyword">private</span> <span class="token number">0771</span> system system encryption<span class="token operator">=</span><span class="token class-name">Require</span>
</code></pre>
    <p>
     在
     <code>
      BootAnimation.cpp
     </code>
     中添加路径
    </p>
    <ul>
     <li>
      /frameworks/base/cmds/bootanimation/BootAnimation.cpp
     </li>
    </ul>
    <pre><code class="prism language-java"><span class="token operator">+</span><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token constant">CUSTOM_BOOTANIMATION_FILE</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"/data/local/traces/bootanimation.zip"</span><span class="token punctuation">;</span>
 <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token constant">OEM_BOOTANIMATION_FILE</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"/oem/media/bootanimation.zip"</span><span class="token punctuation">;</span>
 <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token constant">PRODUCT_BOOTANIMATION_DARK_FILE</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"/product/media/bootanimation-dark.zip"</span><span class="token punctuation">;</span>
 <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token constant">PRODUCT_BOOTANIMATION_FILE</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"/product/media/bootanimation.zip"</span><span class="token punctuation">;</span>
@@ <span class="token operator">-</span><span class="token number">583</span><span class="token punctuation">,</span><span class="token number">7</span> <span class="token operator">+</span><span class="token number">584</span><span class="token punctuation">,</span><span class="token number">7</span> @@ <span class="token keyword">void</span> <span class="token class-name">BootAnimation</span><span class="token operator">::</span><span class="token function">findBootAnimationFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
     <span class="token punctuation">}</span>
 
     <span class="token keyword">const</span> bool playDarkAnim <span class="token operator">=</span> android<span class="token operator">::</span><span class="token function">base</span><span class="token operator">::</span><span class="token class-name">GetIntProperty</span><span class="token punctuation">(</span><span class="token string">"ro.boot.theme"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">;</span>
     <span class="token comment">// 将添加的路径放在第一位</span>
<span class="token operator">-</span>    <span class="token keyword">static</span> <span class="token keyword">const</span> std<span class="token operator">::</span><span class="token function">vector</span><span class="token operator">&lt;</span>std<span class="token operator">::</span><span class="token function">string</span><span class="token operator">&gt;</span> bootFiles <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
<span class="token operator">+</span>    <span class="token keyword">static</span> <span class="token keyword">const</span> std<span class="token operator">::</span><span class="token function">vector</span><span class="token operator">&lt;</span>std<span class="token operator">::</span><span class="token function">string</span><span class="token operator">&gt;</span> bootFiles <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token constant">CUSTOM_BOOTANIMATION_FILE</span><span class="token punctuation">,</span>
         <span class="token constant">APEX_BOOTANIMATION_FILE</span><span class="token punctuation">,</span> playDarkAnim <span class="token operator">?</span> <span class="token constant">PRODUCT_BOOTANIMATION_DARK_FILE</span> <span class="token operator">:</span> <span class="token constant">PRODUCT_BOOTANIMATION_FILE</span><span class="token punctuation">,</span>
         <span class="token constant">OEM_BOOTANIMATION_FILE</span><span class="token punctuation">,</span> <span class="token constant">SYSTEM_BOOTANIMATION_FILE</span>
     <span class="token punctuation">}</span><span class="token punctuation">;</span>
     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token comment">// 获取可用开机动画路径</span>
 bool <span class="token class-name">BootAnimation</span><span class="token operator">::</span><span class="token function">findBootAnimationFileInternal</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">::</span><span class="token function">vector</span><span class="token operator">&lt;</span>std<span class="token operator">::</span><span class="token function">string</span><span class="token operator">&gt;</span> <span class="token operator">&amp;</span>files<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
     <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">::</span><span class="token function">string</span><span class="token operator">&amp;</span> f <span class="token operator">:</span> files<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">access</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">R_OK</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
             mZipFileName <span class="token operator">=</span> f<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
     <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
</code></pre>
    <h6>
     <a id="_44">
     </a>
     添加权限
    </h6>
    <ul>
     <li>
      /device/mediatek/sepolicy/basic/non_plat/bootanim.te
     </li>
    </ul>
    <pre><code class="prism language-java"><span class="token operator">+</span>allow bootanim trace_data_file<span class="token operator">:</span>dir <span class="token punctuation">{<!-- --></span> search read <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token operator">+</span>allow bootanim trace_data_file<span class="token operator">:</span>file <span class="token punctuation">{<!-- --></span> read <span class="token keyword">open</span> <span class="token namespace">map</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <ul>
     <li>
      /device/mediatek/sepolicy/basic/non_plat/system_app.te
     </li>
    </ul>
    <pre><code class="prism language-java"><span class="token operator">+</span>allow system_app trace_data_file<span class="token operator">:</span>dir <span class="token punctuation">{<!-- --></span> search read create write add_name remove_name <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token operator">+</span>allow system_app trace_data_file<span class="token operator">:</span>file <span class="token punctuation">{<!-- --></span> read create write <span class="token keyword">open</span> <span class="token namespace">getattr</span> setattr unlink <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <h6>
     <a id="zip_57">
     </a>
     复制zip包到指定路径
    </h6>
    <pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">DEST_PATH</span> <span class="token operator">=</span> <span class="token string">"/data/local/traces/bootanimation.zip"</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">setSystemBootAnimation</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">File</span> file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
			<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
				<span class="token class-name">File</span> destFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token constant">DEST_PATH</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">"chmod 777"</span> <span class="token operator">+</span> <span class="token constant">DEST_PATH</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>destFile<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
					destFile<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>

				<span class="token class-name">FileInputStream</span> fis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token class-name">FileOutputStream</span> fos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token constant">DEST_PATH</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
				<span class="token keyword">int</span> byteRead<span class="token punctuation">;</span>
				<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">!=</span> <span class="token punctuation">(</span>byteRead <span class="token operator">=</span> fis<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
					fos<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> byteRead<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>

				fis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				fos<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				fos<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
				e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>

		<span class="token class-name">File</span> nFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token constant">DEST_PATH</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>nFile<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
			<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
				<span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">setPosixFilePermissions</span><span class="token punctuation">(</span>nFile<span class="token punctuation">.</span><span class="token function">toPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
						<span class="token class-name">PosixFilePermissions</span><span class="token punctuation">.</span><span class="token function">fromString</span><span class="token punctuation">(</span><span class="token string">"rw-rw-rw-"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre>
    <p>
     需要系统签名，包在data目录下，恢复出厂设置会被清除。
     <br/>
     如果项目的selinux是关闭的，也可以自己创建其他路径
    </p>
    <ul>
     <li>
      system/core/rootdir/init.rc
     </li>
    </ul>
    <pre><code class="prism language-java">mkdir <span class="token operator">/</span>data<span class="token operator">/</span>local<span class="token operator">/</span>animation <span class="token number">0777</span> shell shell
</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f:672e6373646e2e6e65742f7778645f6373646e5f323031362f:61727469636c652f64657461696c732f313436313632373935" class_="artid" style="display:none">
 </p>
</div>


