---
arturl_encode: "68747470733a2f2f626c6f:672e6373646e2e6e65742f323430315f38333334323235312f:61727469636c652f64657461696c732f313436323331303739"
layout: post
title: "使用kubeadm方式以及使用第三方工具sealos搭建K8S集群"
date: 2025-03-15 18:35:40 +0800
description: "kubeadm是官方社区推出的一个用于快速部署kubernetes集群的工具。"
keywords: "使用kubeadm方式以及使用第三方工具sealos搭建K8S集群"
categories: ['未分类']
tags: ['运维', '容器', 'Linux', 'Kubernetes', 'Java']
artid: "146231079"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146231079
    alt: "使用kubeadm方式以及使用第三方工具sealos搭建K8S集群"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146231079
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146231079
cover: https://bing.ee123.net/img/rand?artid=146231079
image: https://bing.ee123.net/img/rand?artid=146231079
img: https://bing.ee123.net/img/rand?artid=146231079
---

# 使用kubeadm方式以及使用第三方工具sealos搭建K8S集群

---

## kubeadm方式:

kubeadm
是官方社区推出的一个用于快速部署kubernetes集群的工具。这个工具能通过两条指令完成一个kubernetes集群的部署：

```
# 创建一个 Master 节点
kubeadm init

# 将一个 Node 节点加入到当前集群中
kubeadm join <Master节点的IP和端口 >
```

**使用kubeadm方式搭建K8s集群主要分为以下几步：**

* 准备三台虚拟机，同时安装操作系统CentOS 7.x
* 对三个安装之后的操作系统进行初始化操作
* 在三个节点安装 docker kubelet kubeadm kubectl
* 在master节点执行kubeadm init命令初始化
* 在node节点上执行 kubeadm join命令，把node节点添加到当前集群
* 配置CNI网络插件，用于节点之间的连通【失败了可以多试几次】
* 通过拉取一个nginx进行测试，能否进行外网测试

## 一、安装要求

> 在开始之前，部署Kubernetes集群机器需要满足以下几个条件：
>
> * 一台或多台机器，操作系统 CentOS7.x-86\_x64
> * 硬件配置：3GB或更多RAM，2个CPU或更多CPU，硬盘30GB或更多【
>   注意master需要两核
>   】
> * 可以访问外网，需要拉取镜像，如果服务器不能上网，需要提前下载镜像并导入节点
> * 禁止swap分区

## 二、环境准备

| 角色 | IP |
| --- | --- |
| master | 192.168.8.172 |
| node1 | 192.168.8.173 |
| node2 | 192.168.8.174 |

**在每台机器上面执行下面命令：**

```
# 关闭防火墙
systemctl stop firewalld
systemctl disable firewalld

# 关闭selinux
# 永久关闭
sed -i 's/enforcing/disabled/' /etc/selinux/config  
# 临时关闭
setenforce 0  

# 关闭swap
# 临时
swapoff -a 
# 永久关闭
sed -ri 's/.*swap.*/#&/' /etc/fstab

# 根据规划设置主机名【master节点上操作】
hostnamectl set-hostname k8s-master
# 根据规划设置主机名【node1节点操作】
hostnamectl set-hostname k8s-node01
# 根据规划设置主机名【node2节点操作】
hostnamectl set-hostname k8s-node02

# 在master添加hosts
cat >> /etc/hosts << EOF
192.168.8.172 k8s-master
192.168.8.173 k8s-node01
192.168.8.174 k8s-node02
EOF


# 将桥接的IPv4流量传递到iptables的链
cat > /etc/sysctl.d/k8s.conf << EOF
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
EOF
# 生效
sysctl --system  

# 时间同步
yum install chrony -y
systemctl restart chronyd

```

## 二、安装Docker、kubeadm、kubelet

所有节点安装Docker/kubeadm/kubelet ，Kubernetes默认CRI（容器运行时）为Docker，因此先安装Docker

### 1、安装Docker

#### （1）首先配置一下Docker的阿里yum源

```
cat >/etc/yum.repos.d/docker.repo<<EOF
[docker-ce-edge]
name=Docker CE Edge - \$basearch
baseurl=https://mirrors.aliyun.com/docker-ce/linux/centos/7/\$basearch/edge
enabled=1
gpgcheck=1
gpgkey=https://mirrors.aliyun.com/docker-ce/linux/centos/gpg
EOF
```

#### （2）然后用yum 方式安装docker

```
# yum安装
yum -y install docker-ce

# 查看docker版本
docker --version  

# 启动docker
systemctl enable docker
systemctl start docker
```

#### （3）配置Docker镜像加速器

```
cat >> /etc/docker/daemon.json << EOF
{
  "registry-mirrors": ["https://b9pmyelo.mirror.aliyuncs.com"]
}
EOF
```

#### （4）重启Docker

```
systemctl restart docker
```

### 2、添加 kubernetes软件源

#### （1）我们需要配置一下yum的k8s软件源

```
cat > /etc/yum.repos.d/kubernetes.repo << EOF
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=0
repo_gpgcheck=0
gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF
```

#### （2）安装kubeam、kubelet和kubectl

```
# 安装kubelet、kubeadm、kubectl，同时指定版本
yum install -y kubelet-1.18.0 kubeadm-1.18.0 kubectl-1.18.0
# 设置开机启动
systemctl enable kubelet
```

### 3、部署 Kubernetes Master（mster 节点上）

```
kubeadm init --apiserver-advertise-address=192.168.8.172 --image-repository registry.aliyuncs.com/google_containers --kubernetes-version v1.18.0 --service-cidr=10.96.0.0/12  --pod-network-cidr=10.244.0.0/16
```

![](https://i-blog.csdnimg.cn/direct/9150240c28924204b2bca33f56e6af46.png)
**使用kubectl工具 【master节点操作】**

```
 mkdir -p $HOME/.kube
  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
  sudo chown $(id -u):$(id -g) $HOME/.kube/config

```

执行完成后，我们可以使用下面命令，查看我们正在运行的节点：

```
kubectl get nodes
```

![](https://i-blog.csdnimg.cn/direct/88774fc4f20f4e0ea92a1793b48b68f3.png)

能够看到，目前有一个master节点已经运行了，但是还处于未准备状态

下面我们还需要在Node节点执行其它的命令，将node1和node2加入到我们的master节点上

### 4、加入 Kubernetes Node（在node节点上面）

下面我们需要到 k8s-node01 和 k8s-node02服务器，执行下面的代码向集群添加新节点

执行在kubeadm init输出的kubeadm join命令：

注意，以下的命令是在master初始化完成后，每个人的都不一样！！！需要复制自己生成

```
kubeadm join 192.168.8.172:6443 --token qpoymy.yx2t97sn368q4udl \
    --discovery-token-ca-cert-hash sha256:948606060e1a95f36daeac85cde3b231f544904802eed017060391bb606ddf31

```

![](https://i-blog.csdnimg.cn/direct/3b41742875eb4d80951ae5bba6275c10.png)
![](https://i-blog.csdnimg.cn/direct/f19201bf7bfb4bde844132f61a78bc00.png)
默认token有效期为24小时，当过期之后，该token就不可用了。这时就需要重新创建token，操作如下：

```
kubeadm token create --print-join-command

```

当我们把两个节点都加入进来后，我们就可以去Master节点 执行下面命令查看情况

```
kubectl get node
```

![](https://i-blog.csdnimg.cn/direct/ee8df9e6c7a44d6c860afdf5c2a37cc2.png)

## 三、部署 CNI 网络插件

**网络插件选型对比**

| 插件 | 网络模式 | 性能损耗 | 适用场景 |
| --- | --- | --- | --- |
| Flannel | VXLAN | 8-10% | 中小型集群 |
| Calico | BGP | 3-5% | 大规模生产环境 |
| Cilium | eBPF | 1-3% | 云原生安全场景 |
| Weave | mesh | 10-15% | 混合云环境 |

### 1.使用 Calico 插件

由于网络的问题，我将需要的文件（
calico.yaml和calico.tar.gz
）下载到本地，然后再上传到主机上面

#### （1）上传文件：

#### （2）拉取镜像：

[root@k8s-master~]# docker load -i calico.tar.gz  （
需要再三个节点上面操作
）
![](https://i-blog.csdnimg.cn/direct/90f081a0837b4c89a3092f184f961a21.png)

#### （3）部署calico网络：

[root@k8s-master ~]# kubectl apply -f calico.yaml

![](https://i-blog.csdnimg.cn/direct/69e3794960194218bd8eeb590d803f3f.png)

#### （4）发现出现了问题：

原因是 Kubernetes 集群版本不支持当前 calico 版本中
`calico.yaml`
文件使用的
`policy/v1`
版本的
`PodDisruptionBudget`
资源类型

**我们可以去检查 K8S 集群支持的 API 版本**
：运行命令
**`kubectl api-versions | grep policy`**
，查看当前 K8S 集群支持的
`policy`
相关 API 版本。

[root@k8s-master ~]#
kubectl api-versions | grep policy

policy/v1beta1

然后我们需要修改calico.yaml 文件，在文件内搜索

`policy/v1`
，将
涉及
`PodDisruptionBudget`

的部分
改为
`policy/v1beta1`

[root@k8s-master ~]# kubectl apply -f calico.yaml   删掉之前创建的，然后再次执行

#### （5）检查：

![](https://i-blog.csdnimg.cn/direct/773a25e292ea4c2fab8aea558ee03d35.png)

![](https://i-blog.csdnimg.cn/direct/395f493b238b4b5cbc08ee438429cadf.png)

### ***#到此为此kubeadm安装k8s集群安装完成。***

## Sealos 方式：

## 一、环境准备

> 所有主机上面操作：
>
> 1.主机名
>
> hostnamectl set-hostname xxx
>   
> 2. 主机名解析
>   
> 192.168.8.177 k8s-master
>   
> 192.168.8.143 k8s-node01
>   
> 192.168.8.143 k8s-node02
>
> 3.关闭系统防火墙
>
> 4.时间同步

## 二、k8s-master 上安装sealos

![](https://i-blog.csdnimg.cn/direct/2daf0ca4ea1a4a4dbdb6f5a1bc6e185c.png)

## 三、sealos cli部署K8S集群

* 需要在 K8s 集群的
  **第一个 master 节点**
  上运行
  `sealos run`
  命令，目前
  **集群外的节点不支持集群安装**
  。
* 建议使用干净的操作系统来创建集群。
  **不要自己装 Docker！**

> 只在 k8s-master 上操作：
>
> [root@k8s-master ~]#
> sealos run registry.cn-shanghai.aliyuncs.com/labring/kubernetes-docker:v1.30.5 registry.cn-shanghai.aliyuncs.com/labring/helm:v3.9.4 registry.cn-shanghai.aliyuncs.com/labring/calico:v3.26.1 --masters 192.168.8.177 --nodes 192.168.8.143,192.168.8.147 -p '123'

参数说明：

| 参数名 | 参数值示例 | 参数说明 |
| --- | --- | --- |
| --masters | 192.168.8.177 | K8s master 节点地址列表 |
| --nodes | 192.168.8.143,192.168.8.147 | K8s node 节点地址列表 |
| --ssh-passwd | [your-ssh-passwd] | ssh 登录密码 |
| kubernetes | labring/kubernetes-docker:v1.30.5 | K8s 集群镜像 |

### 出现这个代表部署成功：

### 检查：

![](https://i-blog.csdnimg.cn/direct/a85b8d7898bb4510aa440aa85a985e4f.png)

### 然后需要再各个节点上配置镜像加速器，不然可能后面做实验的时候镜像拉取不下来：

![](https://i-blog.csdnimg.cn/direct/c8dd5618ad294dabbcd80856200ebee6.png)

### 测试： **Kubectl命令自动补全** ：

> yum -y install bash-completion
>   
> source /usr/share/bash-completion/bash\_completion
>   
> source <(kubectl completion bash)
>   
> echo "source <(kubectl completion bash)" >> ~/.bashrc

###