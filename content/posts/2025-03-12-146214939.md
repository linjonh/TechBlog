---
layout: post
title: "Go-Context深度剖析"
date: 2025-03-12 21:04:14 +0800
description: "/ 创建一个新的通道// 等待父Context的Done通道关闭<-done// 记录操作耗时// 关闭我们的通道close(ch)}()return ch这个自定义Context可以在操作取消或完成时自动记录指标，而不需要修改现有代码。"
keywords: "Go Context深度剖析"
categories: ['开发']
tags: ['开发语言', '后端', 'Golang']
artid: "146214939"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146214939
    alt: "Go-Context深度剖析"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146214939
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146214939
cover: https://bing.ee123.net/img/rand?artid=146214939
image: https://bing.ee123.net/img/rand?artid=146214939
img: https://bing.ee123.net/img/rand?artid=146214939
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Go Context深度剖析
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-github-gist" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <p>
    </p>
    <h3>
     <a id="Context_2">
     </a>
     为什么需要Context？
    </h3>
    <p>
     当我刚开始使用Go构建微服务时，很快就遇到了一个常见问题：如何优雅地处理请求取消和超时？
    </p>
    <p>
     想象这样一个场景：用户发起了一个API请求，这个请求需要调用多个下游服务，查询数据库，可能还需要进行一些计算密集型操作。然后，用户突然关闭了浏览器标签页 - 我们应该如何停止所有正在进行的工作？
    </p>
    <p>
     在没有Context之前，我们可能会这样解决：
    </p>
    <pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">processRequest</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 创建一个取消通道</span>
    done <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    
    <span class="token comment">// 监听连接关闭</span>
    notifyChan <span class="token operator">:=</span> w<span class="token punctuation">.</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>CloseNotifier<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">CloseNotify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token operator">&lt;-</span>notifyChan
        <span class="token function">close</span><span class="token punctuation">(</span>done<span class="token punctuation">)</span> <span class="token comment">// 通知所有工作停止</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    result<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">doWork</span><span class="token punctuation">(</span>done<span class="token punctuation">)</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">doWork</span><span class="token punctuation">(</span>done <span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>Result<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 做一些工作</span>
    <span class="token keyword">select</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">case</span> <span class="token operator">&lt;-</span>done<span class="token punctuation">:</span>
        <span class="token keyword">return</span> Result<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"操作被取消"</span><span class="token punctuation">)</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span>
        <span class="token comment">// 继续工作</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 调用其他函数</span>
    subResult<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">doMoreWork</span><span class="token punctuation">(</span>done<span class="token punctuation">)</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     这种方法有几个明显问题：
    </p>
    <ol>
     <li>
      我们需要手动将
      <code>
       done
      </code>
      通道传递给每个函数
     </li>
     <li>
      无法设置超时
     </li>
     <li>
      无法携带请求特定的值
     </li>
     <li>
      没有标准化的接口，每个库可能使用不同的取消机制
     </li>
    </ol>
    <p>
     这就是为什么Go团队引入了
     <code>
      context
     </code>
     包 - 提供一个标准化的解决方案来处理请求范围内的取消、超时和值传递。
    </p>
    <h3>
     <a id="Context_51">
     </a>
     Context接口的深度剖析
    </h3>
    <p>
     让我们先深入理解Context接口：
    </p>
    <pre><code class="prism language-go"><span class="token keyword">type</span> Context <span class="token keyword">interface</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">Deadline</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>deadline time<span class="token punctuation">.</span>Time<span class="token punctuation">,</span> ok <span class="token builtin">bool</span><span class="token punctuation">)</span>
    <span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
    <span class="token function">Value</span><span class="token punctuation">(</span>key <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     这个看似简单的接口实际上非常强大。每个方法都有其特定的用途，让我们逐个分析：
    </p>
    <h4>
     <a id="Done_chan_struct_66">
     </a>
     Done() &lt;-chan struct{}
    </h4>
    <p>
     <code>
      Done()
     </code>
     方法是Context最核心的部分，它返回一个只读的通道，这个通道在Context被取消时关闭。为什么使用通道而不是简单的布尔值？
    </p>
    <p>
     答案在于Go的并发模型：
     <font color="red">
      通道的关闭可以同时通知多个goroutine。当Context被取消时，所有监听这个通道的goroutine都会收到通知
     </font>
     。
    </p>
    <pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">worker</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">select</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">case</span> <span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment">// Context被取消，清理并退出</span>
            <span class="token keyword">return</span>
        <span class="token keyword">default</span><span class="token punctuation">:</span>
            <span class="token comment">// 继续工作</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     这种模式非常强大，因为它允许我们优雅地处理取消，无需额外的锁或同步原语。
    </p>
    <h4>
     <a id="Err_error_88">
     </a>
     Err() error
    </h4>
    <p>
     当
     <code>
      Done()
     </code>
     通道关闭时，
     <code>
      Err()
     </code>
     方法返回Context被取消的原因。通常有两种可能：
    </p>
    <ol>
     <li>
      <code>
       context.Canceled
      </code>
      - Context被显式取消
     </li>
     <li>
      <code>
       context.DeadlineExceeded
      </code>
      - Context超时
     </li>
    </ol>
    <p>
     理解这个错误非常重要，因为它可以帮助我们区分取消是由于用户操作还是由于超时。
    </p>
    <h4>
     <a id="Deadline_deadline_timeTime_ok_bool_97">
     </a>
     Deadline() (deadline time.Time, ok bool)
    </h4>
    <p>
     <code>
      Deadline()
     </code>
     返回Context的截止时间（如果有的话）。这对于实现自适应超时特别有用。例如，一个函数可以根据剩余时间调整其行为：
    </p>
    <pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">fetchData</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> url <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Data<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    deadline<span class="token punctuation">,</span> ok <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">Deadline</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> ok <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 计算剩余时间</span>
        timeLeft <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Until</span><span class="token punctuation">(</span>deadline<span class="token punctuation">)</span>
        
        <span class="token keyword">if</span> timeLeft <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Millisecond <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 时间不足，返回缓存数据</span>
            <span class="token keyword">return</span> <span class="token function">getCachedData</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">// 设置HTTP客户端超时略小于Context超时</span>
        client <span class="token operator">:=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Client<span class="token punctuation">{<!-- --></span>
            Timeout<span class="token punctuation">:</span> timeLeft <span class="token operator">-</span> <span class="token number">50</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">// ...使用client进行请求</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 没有截止时间，使用默认行为</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="Valuekey_interface_interface_126">
     </a>
     Value(key interface{}) interface{}
    </h4>
    <p>
     <code>
      Value()
     </code>
     方法允许Context携带请求范围的值，这些值可以在整个调用链中访问。这是一个强大但容易被滥用的特性。
    </p>
    <p>
     让我们看看Context值的内部实现原理：
    </p>
    <pre><code class="prism language-go"><span class="token keyword">type</span> valueCtx <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
    Context
    key<span class="token punctuation">,</span> val <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>valueCtx<span class="token punctuation">)</span> <span class="token function">Value</span><span class="token punctuation">(</span>key <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> c<span class="token punctuation">.</span>key <span class="token operator">==</span> key <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> c<span class="token punctuation">.</span>val
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> c<span class="token punctuation">.</span>Context<span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     <font color="red">
      注意到该实现使用了委托模式：如果当前Context没有找到key，它会委托给父Context继续查找。这形成了一个查找链，直到根Context
     </font>
     。
    </p>
    <h3>
     <a id="Context_148">
     </a>
     Context的内部实现深度解析
    </h3>
    <p>
     要真正理解Context，我们需要深入其内部实现。Go的标准库中实现了几种不同类型的Context：
    </p>
    <h4>
     <a id="emptyCtx__Context_152">
     </a>
     emptyCtx - 所有Context的起点
    </h4>
    <pre><code class="prism language-go"><span class="token keyword">type</span> emptyCtx <span class="token builtin">int</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>emptyCtx<span class="token punctuation">)</span> <span class="token function">Deadline</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>deadline time<span class="token punctuation">.</span>Time<span class="token punctuation">,</span> ok <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>emptyCtx<span class="token punctuation">)</span> <span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>emptyCtx<span class="token punctuation">)</span> <span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>emptyCtx<span class="token punctuation">)</span> <span class="token function">Value</span><span class="token punctuation">(</span>key <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     <code>
      emptyCtx
     </code>
     是最简单的Context实现，它不做任何事情：没有截止时间，不能被取消，不包含任何值。
     <code>
      Background()
     </code>
     和
     <code>
      TODO()
     </code>
     函数返回的就是这种类型的Context。
    </p>
    <h4>
     <a id="cancelCtx__Context_176">
     </a>
     cancelCtx - 可取消的Context
    </h4>
    <pre><code class="prism language-go"><span class="token keyword">type</span> cancelCtx <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
    Context

    mu       sync<span class="token punctuation">.</span>Mutex
    done     <span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    children <span class="token keyword">map</span><span class="token punctuation">[</span>canceler<span class="token punctuation">]</span><span class="token keyword">struct</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    err      <span class="token builtin">error</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     <code>
      cancelCtx
     </code>
     是可取消的Context实现。它维护了一个子Context列表，当
     <code>
      cancelCtx
     </code>
     被取消时，它会先关闭
     <code>
      done
     </code>
     通道，然后取消所有子Context。这就是取消信号如何在Context树中传播的。
    </p>
    <div class="mermaid">
     <svg class="mermaid-svg" height="402" id="mermaid-svg-myMxuBiDxwaLF7Yt" viewbox="0 0 309.15625 402" width="309.15625" xmlns="http://www.w3.org/2000/svg">
      <style>
       #mermaid-svg-myMxuBiDxwaLF7Yt {font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}#mermaid-svg-myMxuBiDxwaLF7Yt .error-icon{fill:#552222;}#mermaid-svg-myMxuBiDxwaLF7Yt .error-text{fill:#552222;stroke:#552222;}#mermaid-svg-myMxuBiDxwaLF7Yt .edge-thickness-normal{stroke-width:2px;}#mermaid-svg-myMxuBiDxwaLF7Yt .edge-thickness-thick{stroke-width:3.5px;}#mermaid-svg-myMxuBiDxwaLF7Yt .edge-pattern-solid{stroke-dasharray:0;}#mermaid-svg-myMxuBiDxwaLF7Yt .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-svg-myMxuBiDxwaLF7Yt .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-svg-myMxuBiDxwaLF7Yt .marker{fill:#333333;stroke:#333333;}#mermaid-svg-myMxuBiDxwaLF7Yt .marker.cross{stroke:#333333;}#mermaid-svg-myMxuBiDxwaLF7Yt svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-svg-myMxuBiDxwaLF7Yt .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#mermaid-svg-myMxuBiDxwaLF7Yt .cluster-label text{fill:#333;}#mermaid-svg-myMxuBiDxwaLF7Yt .cluster-label span{color:#333;}#mermaid-svg-myMxuBiDxwaLF7Yt .label text,#mermaid-svg-myMxuBiDxwaLF7Yt span{fill:#333;color:#333;}#mermaid-svg-myMxuBiDxwaLF7Yt .node rect,#mermaid-svg-myMxuBiDxwaLF7Yt .node circle,#mermaid-svg-myMxuBiDxwaLF7Yt .node ellipse,#mermaid-svg-myMxuBiDxwaLF7Yt .node polygon,#mermaid-svg-myMxuBiDxwaLF7Yt .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#mermaid-svg-myMxuBiDxwaLF7Yt .node .label{text-align:center;}#mermaid-svg-myMxuBiDxwaLF7Yt .node.clickable{cursor:pointer;}#mermaid-svg-myMxuBiDxwaLF7Yt .arrowheadPath{fill:#333333;}#mermaid-svg-myMxuBiDxwaLF7Yt .edgePath .path{stroke:#333333;stroke-width:2.0px;}#mermaid-svg-myMxuBiDxwaLF7Yt .flowchart-link{stroke:#333333;fill:none;}#mermaid-svg-myMxuBiDxwaLF7Yt .edgeLabel{background-color:#e8e8e8;text-align:center;}#mermaid-svg-myMxuBiDxwaLF7Yt .edgeLabel rect{opacity:0.5;background-color:#e8e8e8;fill:#e8e8e8;}#mermaid-svg-myMxuBiDxwaLF7Yt .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#mermaid-svg-myMxuBiDxwaLF7Yt .cluster text{fill:#333;}#mermaid-svg-myMxuBiDxwaLF7Yt .cluster span{color:#333;}#mermaid-svg-myMxuBiDxwaLF7Yt div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#mermaid-svg-myMxuBiDxwaLF7Yt :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}
      </style>
      <g>
       <g class="output">
        <g class="clusters">
        </g>
        <g class="edgePaths">
         <g class="edgePath LS-A LE-B" id="L-A-B" style="opacity: 1;">
          <path class="path" d="M135.78336588541666,54L129.11764865451389,58.166666666666664C122.4519314236111,62.333333333333336,109.12049696180554,70.66666666666667,102.45477973090277,79C95.7890625,87.33333333333333,95.7890625,95.66666666666667,95.7890625,99.83333333333333L95.7890625,104" marker-end="url(#arrowhead229)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead229" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-A LE-C" id="L-A-C" style="opacity: 1;">
          <path class="path" d="M209.37288411458334,54L216.03860134548611,58.166666666666664C222.7043185763889,62.333333333333336,236.03575303819446,70.66666666666667,242.7014702690972,79C249.3671875,87.33333333333333,249.3671875,95.66666666666667,249.3671875,99.83333333333333L249.3671875,104" marker-end="url(#arrowhead230)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead230" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-B LE-D" id="L-B-D" style="opacity: 1;">
          <path class="path" d="M75.42840676229508,150L69.8218493852459,156.33333333333334C64.21529200819673,162.66666666666666,53.00217725409836,175.33333333333334,49.26447233606557,188C45.52676741803279,200.66666666666666,49.26447233606558,213.33333333333334,51.13332479508197,219.66666666666666L53.00217725409836,226" marker-end="url(#arrowhead231)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead231" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-B LE-E" id="L-B-E" style="opacity: 1;">
          <path class="path" d="M117.95543032786885,150L124.05921277322405,156.33333333333334C130.16299521857923,162.66666666666666,142.3705601092896,175.33333333333334,154.578125,188C166.7856898907104,200.66666666666666,178.99325478142077,213.33333333333334,185.097037226776,219.66666666666666L191.20081967213116,226" marker-end="url(#arrowhead232)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead232" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-D LE-F" id="L-D-F" style="opacity: 1;">
          <path class="path" d="M53.00217725409836,272L51.13332479508197,278.3333333333333C49.26447233606558,284.6666666666667,45.52676741803279,297.3333333333333,45.52676741803279,310C45.52676741803279,322.6666666666667,49.26447233606558,335.3333333333333,51.13332479508197,341.6666666666667L53.00217725409836,348" marker-end="url(#arrowhead233)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead233" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-B LE-D" id="L-B-D" style="opacity: 1;">
          <path class="path" d="M89.00217725409836,150L87.13332479508195,156.33333333333334C85.26447233606557,162.66666666666666,81.52676741803278,175.33333333333334,77.7890625,188C74.05135758196722,200.66666666666666,70.31365266393443,213.33333333333334,68.44480020491804,219.66666666666666L66.57594774590164,226" marker-end="url(#arrowhead234)" style="fill:none;stroke-width:2px;stroke-dasharray:3;">
          </path>
          <defs>
           <marker id="arrowhead234" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-D LE-F" id="L-D-F" style="opacity: 1;">
          <path class="path" d="M66.57594774590164,272L68.44480020491804,278.3333333333333C70.31365266393443,284.6666666666667,74.05135758196722,297.3333333333333,74.05135758196722,310C74.05135758196722,322.6666666666667,70.31365266393443,335.3333333333333,68.44480020491804,341.6666666666667L66.57594774590164,348" marker-end="url(#arrowhead235)" style="fill:none;stroke-width:2px;stroke-dasharray:3;">
          </path>
          <defs>
           <marker id="arrowhead235" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-B LE-E" id="L-B-E" style="opacity: 1;">
          <path class="path" d="M146.90868340163934,150L160.9851007513661,156.33333333333334C175.0615181010929,162.66666666666666,203.21435280054644,175.33333333333334,215.42191769125682,188C227.6294825819672,200.66666666666666,223.89177766393445,213.33333333333334,222.02292520491804,219.66666666666666L220.15407274590163,226" marker-end="url(#arrowhead236)" style="fill:none;stroke-width:2px;stroke-dasharray:3;">
          </path>
          <defs>
           <marker id="arrowhead236" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
        </g>
        <g class="edgeLabels">
         <g class="edgeLabel" style="opacity: 1;" transform="">
          <g class="label" transform="translate(0,0)">
           <rect height="0" rx="0" ry="0" width="0">
           </rect>
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-A' L-LE-B" id="L-L-A-B">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="">
          <g class="label" transform="translate(0,0)">
           <rect height="0" rx="0" ry="0" width="0">
           </rect>
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-A' L-LE-C" id="L-L-A-C">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="">
          <g class="label" transform="translate(0,0)">
           <rect height="0" rx="0" ry="0" width="0">
           </rect>
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-B' L-LE-D" id="L-L-B-D">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="">
          <g class="label" transform="translate(0,0)">
           <rect height="0" rx="0" ry="0" width="0">
           </rect>
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-B' L-LE-E" id="L-L-B-E">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="">
          <g class="label" transform="translate(0,0)">
           <rect height="0" rx="0" ry="0" width="0">
           </rect>
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-D' L-LE-F" id="L-L-D-F">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="translate(77.7890625,188)">
          <g class="label" transform="translate(-16,-13)">
           <rect height="26" rx="0" ry="0" width="32">
           </rect>
           <foreignobject height="26" width="32">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-B' L-LE-D" id="L-L-B-D">
              取消
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="translate(77.7890625,310)">
          <g class="label" transform="translate(-16,-13)">
           <rect height="26" rx="0" ry="0" width="32">
           </rect>
           <foreignobject height="26" width="32">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-D' L-LE-F" id="L-L-D-F">
              取消
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="translate(231.3671875,188)">
          <g class="label" transform="translate(-16,-13)">
           <rect height="26" rx="0" ry="0" width="32">
           </rect>
           <foreignobject height="26" width="32">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-B' L-LE-E" id="L-L-B-E">
              取消
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
        </g>
        <g class="nodes">
         <g class="node default" id="flowchart-A-233" style="opacity: 1;" transform="translate(172.578125,31)">
          <rect class="label-container" height="46" rx="0" ry="0" width="102.6875" x="-51.34375" y="-23">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-41.34375,-13)">
            <foreignobject height="26" width="82.6875">
             <div style="display: inline-block; white-space: nowrap;">
              Background
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-B-234" style="opacity: 1;" transform="translate(95.7890625,127)">
          <rect class="label-container" height="46" rx="0" ry="0" style="fill:#f96;stroke:#333;stroke-width:2px;" width="103.578125" x="-51.7890625" y="-23">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-41.7890625,-13)">
            <foreignobject height="26" width="83.578125">
             <div style="display: inline-block; white-space: nowrap;">
              cancelCtx 1
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-C-236" style="opacity: 1;" transform="translate(249.3671875,127)">
          <rect class="label-container" height="46" rx="0" ry="0" width="103.578125" x="-51.7890625" y="-23">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-41.7890625,-13)">
            <foreignobject height="26" width="83.578125">
             <div style="display: inline-block; white-space: nowrap;">
              cancelCtx 2
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-D-238" style="opacity: 1;" transform="translate(59.7890625,249)">
          <rect class="label-container" height="46" rx="0" ry="0" width="103.578125" x="-51.7890625" y="-23">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-41.7890625,-13)">
            <foreignobject height="26" width="83.578125">
             <div style="display: inline-block; white-space: nowrap;">
              cancelCtx 3
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-E-240" style="opacity: 1;" transform="translate(213.3671875,249)">
          <rect class="label-container" height="46" rx="0" ry="0" width="103.578125" x="-51.7890625" y="-23">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-41.7890625,-13)">
            <foreignobject height="26" width="83.578125">
             <div style="display: inline-block; white-space: nowrap;">
              cancelCtx 4
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-F-242" style="opacity: 1;" transform="translate(59.7890625,371)">
          <rect class="label-container" height="46" rx="0" ry="0" width="103.578125" x="-51.7890625" y="-23">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-41.7890625,-13)">
            <foreignobject height="26" width="83.578125">
             <div style="display: inline-block; white-space: nowrap;">
              cancelCtx 5
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
        </g>
       </g>
      </g>
     </svg>
    </div>
    <p>
     当
     <code>
      cancelCtx 1
     </code>
     被取消时，它会自动取消
     <code>
      cancelCtx 3
     </code>
     和
     <code>
      cancelCtx 4
     </code>
     ，然后
     <code>
      cancelCtx 3
     </code>
     会取消
     <code>
      cancelCtx 5
     </code>
     。这种级联取消确保了所有相关工作都能被正确停止。
    </p>
    <h4>
     <a id="timerCtx__Context_208">
     </a>
     timerCtx - 定时取消的Context
    </h4>
    <pre><code class="prism language-go"><span class="token keyword">type</span> timerCtx <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
    cancelCtx
    timer <span class="token operator">*</span>time<span class="token punctuation">.</span>Timer
    deadline time<span class="token punctuation">.</span>Time
<span class="token punctuation">}</span>
</code></pre>
    <p>
     <code>
      timerCtx
     </code>
     扩展了
     <code>
      cancelCtx
     </code>
     ，添加了一个定时器和截止时间。当定时器触发或Context被手动取消时，它会取消内部的
     <code>
      cancelCtx
     </code>
     。
    </p>
    <h4>
     <a id="valueCtx__Context_220">
     </a>
     valueCtx - 携带值的Context
    </h4>
    <pre><code class="prism language-go"><span class="token keyword">type</span> valueCtx <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
    Context
    key<span class="token punctuation">,</span> val <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     <code>
      valueCtx
     </code>
     在父Context的基础上关联了一个键值对。每次添加新值时，都会创建一个新的
     <code>
      valueCtx
     </code>
     ，形成一个链式结构。
    </p>
    <div class="mermaid">
     <svg class="mermaid-svg" height="454" id="mermaid-svg-TwKjSue0VxG52fkt" viewbox="0 0 120.96875 454" width="120.96875" xmlns="http://www.w3.org/2000/svg">
      <style>
       #mermaid-svg-TwKjSue0VxG52fkt {font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}#mermaid-svg-TwKjSue0VxG52fkt .error-icon{fill:#552222;}#mermaid-svg-TwKjSue0VxG52fkt .error-text{fill:#552222;stroke:#552222;}#mermaid-svg-TwKjSue0VxG52fkt .edge-thickness-normal{stroke-width:2px;}#mermaid-svg-TwKjSue0VxG52fkt .edge-thickness-thick{stroke-width:3.5px;}#mermaid-svg-TwKjSue0VxG52fkt .edge-pattern-solid{stroke-dasharray:0;}#mermaid-svg-TwKjSue0VxG52fkt .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-svg-TwKjSue0VxG52fkt .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-svg-TwKjSue0VxG52fkt .marker{fill:#333333;stroke:#333333;}#mermaid-svg-TwKjSue0VxG52fkt .marker.cross{stroke:#333333;}#mermaid-svg-TwKjSue0VxG52fkt svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-svg-TwKjSue0VxG52fkt .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#mermaid-svg-TwKjSue0VxG52fkt .cluster-label text{fill:#333;}#mermaid-svg-TwKjSue0VxG52fkt .cluster-label span{color:#333;}#mermaid-svg-TwKjSue0VxG52fkt .label text,#mermaid-svg-TwKjSue0VxG52fkt span{fill:#333;color:#333;}#mermaid-svg-TwKjSue0VxG52fkt .node rect,#mermaid-svg-TwKjSue0VxG52fkt .node circle,#mermaid-svg-TwKjSue0VxG52fkt .node ellipse,#mermaid-svg-TwKjSue0VxG52fkt .node polygon,#mermaid-svg-TwKjSue0VxG52fkt .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#mermaid-svg-TwKjSue0VxG52fkt .node .label{text-align:center;}#mermaid-svg-TwKjSue0VxG52fkt .node.clickable{cursor:pointer;}#mermaid-svg-TwKjSue0VxG52fkt .arrowheadPath{fill:#333333;}#mermaid-svg-TwKjSue0VxG52fkt .edgePath .path{stroke:#333333;stroke-width:2.0px;}#mermaid-svg-TwKjSue0VxG52fkt .flowchart-link{stroke:#333333;fill:none;}#mermaid-svg-TwKjSue0VxG52fkt .edgeLabel{background-color:#e8e8e8;text-align:center;}#mermaid-svg-TwKjSue0VxG52fkt .edgeLabel rect{opacity:0.5;background-color:#e8e8e8;fill:#e8e8e8;}#mermaid-svg-TwKjSue0VxG52fkt .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#mermaid-svg-TwKjSue0VxG52fkt .cluster text{fill:#333;}#mermaid-svg-TwKjSue0VxG52fkt .cluster span{color:#333;}#mermaid-svg-TwKjSue0VxG52fkt div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#mermaid-svg-TwKjSue0VxG52fkt :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}
      </style>
      <g>
       <g class="output">
        <g class="clusters">
        </g>
        <g class="edgePaths">
         <g class="edgePath LS-A LE-B" id="L-A-B" style="opacity: 1;">
          <path class="path" d="M60.484375,54L60.484375,58.166666666666664C60.484375,62.333333333333336,60.484375,70.66666666666667,60.484375,79C60.484375,87.33333333333333,60.484375,95.66666666666667,60.484375,99.83333333333333L60.484375,104" marker-end="url(#arrowhead253)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead253" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-B LE-C" id="L-B-C" style="opacity: 1;">
          <path class="path" d="M60.484375,202L60.484375,206.16666666666666C60.484375,210.33333333333334,60.484375,218.66666666666666,60.484375,227C60.484375,235.33333333333334,60.484375,243.66666666666666,60.484375,247.83333333333334L60.484375,252" marker-end="url(#arrowhead254)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead254" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-C LE-D" id="L-C-D" style="opacity: 1;">
          <path class="path" d="M60.484375,350L60.484375,354.1666666666667C60.484375,358.3333333333333,60.484375,366.6666666666667,60.484375,375C60.484375,383.3333333333333,60.484375,391.6666666666667,60.484375,395.8333333333333L60.484375,400" marker-end="url(#arrowhead255)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead255" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
        </g>
        <g class="edgeLabels">
         <g class="edgeLabel" style="opacity: 1;" transform="">
          <g class="label" transform="translate(0,0)">
           <rect height="0" rx="0" ry="0" width="0">
           </rect>
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-A' L-LE-B" id="L-L-A-B">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="">
          <g class="label" transform="translate(0,0)">
           <rect height="0" rx="0" ry="0" width="0">
           </rect>
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-B' L-LE-C" id="L-L-B-C">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="">
          <g class="label" transform="translate(0,0)">
           <rect height="0" rx="0" ry="0" width="0">
           </rect>
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-C' L-LE-D" id="L-L-C-D">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
        </g>
        <g class="nodes">
         <g class="node default" id="flowchart-A-260" style="opacity: 1;" transform="translate(60.484375,31)">
          <rect class="label-container" height="46" rx="0" ry="0" style="fill:#f9f;stroke:#333;stroke-width:2px;" width="102.6875" x="-51.34375" y="-23">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-41.34375,-13)">
            <foreignobject height="26" width="82.6875">
             <div style="display: inline-block; white-space: nowrap;">
              Background
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-B-261" style="opacity: 1;" transform="translate(60.484375,153)">
          <rect class="label-container" height="98" rx="0" ry="0" style="fill:#9cf;stroke:#333;stroke-width:2px;" width="97.515625" x="-48.7578125" y="-49">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-38.7578125,-39)">
            <foreignobject height="78" width="77.515625">
             <div style="display: inline-block; white-space: nowrap;">
              valueCtx
              <br/>
              key=userID
              <br/>
              val=123
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-C-263" style="opacity: 1;" transform="translate(60.484375,301)">
          <rect class="label-container" height="98" rx="0" ry="0" style="fill:#9cf;stroke:#333;stroke-width:2px;" width="104.96875" x="-52.484375" y="-49">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-42.484375,-39)">
            <foreignobject height="78" width="84.96875">
             <div style="display: inline-block; white-space: nowrap;">
              valueCtx
              <br/>
              key=traceID
              <br/>
              val=abc
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-D-265" style="opacity: 1;" transform="translate(60.484375,423)">
          <rect class="label-container" height="46" rx="0" ry="0" style="fill:#f96;stroke:#333;stroke-width:2px;" width="90.375" x="-45.1875" y="-23">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-35.1875,-13)">
            <foreignobject height="26" width="70.375">
             <div style="display: inline-block; white-space: nowrap;">
              cancelCtx
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
        </g>
       </g>
      </g>
     </svg>
    </div>
    <p>
     当我们在这个链中调用
     <code>
      Value(key)
     </code>
     时，它会从当前Context开始，沿着链向上查找，直到找到匹配的键或到达根Context。
    </p>
    <h3>
     <a id="Context_245">
     </a>
     Context取消的实现细节
    </h3>
    <p>
     Context的取消机制是其最强大的特性之一，让我们深入了解它的实现细节：
    </p>
    <pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">WithCancel</span><span class="token punctuation">(</span>parent Context<span class="token punctuation">)</span> <span class="token punctuation">(</span>ctx Context<span class="token punctuation">,</span> cancel CancelFunc<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    c <span class="token operator">:=</span> <span class="token function">newCancelCtx</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span>
    <span class="token function">propagateCancel</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> <span class="token operator">&amp;</span>c<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>c<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> c<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> Canceled<span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">propagateCancel</span><span class="token punctuation">(</span>parent Context<span class="token punctuation">,</span> child canceler<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    done <span class="token operator">:=</span> parent<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> done <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token comment">// 父Context不能被取消</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">select</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">case</span> <span class="token operator">&lt;-</span>done<span class="token punctuation">:</span>
        <span class="token comment">// 父Context已经被取消</span>
        child<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> parent<span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 找到可以取消的父Context</span>
    <span class="token keyword">if</span> p<span class="token punctuation">,</span> ok <span class="token operator">:=</span> <span class="token function">parentCancelCtx</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{<!-- --></span>
        p<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> p<span class="token punctuation">.</span>err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 父Context已经被取消</span>
            child<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 将子Context添加到父Context的children映射中</span>
            <span class="token keyword">if</span> p<span class="token punctuation">.</span>children <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
                p<span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>canceler<span class="token punctuation">]</span><span class="token keyword">struct</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            p<span class="token punctuation">.</span>children<span class="token punctuation">[</span>child<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        p<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 如果无法找到可取消的父Context，启动一个goroutine监听父Context的Done通道</span>
        <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">select</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">case</span> <span class="token operator">&lt;-</span>parent<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                child<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> parent<span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">case</span> <span class="token operator">&lt;-</span>child<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     这段代码展示了Context取消机制的核心实现：
    </p>
    <ol>
     <li>
      创建一个新的
      <code>
       cancelCtx
      </code>
     </li>
     <li>
      将其连接到父Context的取消链中
     </li>
     <li>
      返回Context和取消函数
     </li>
    </ol>
    <p>
     <code>
      propagateCancel
     </code>
     函数确保当父Context被取消时，子Context也会被取消。如果父Context不能直接访问子Context（例如，父Context是
     <code>
      valueCtx
     </code>
     ），它会启动一个goroutine来监听父Context的Done通道。
    </p>
    <p>
     这种设计确保了取消信号能够正确地在Context树中传播，无论树的结构如何复杂。
    </p>
    <h3>
     <a id="Context_307">
     </a>
     Context在实际项目中的应用
    </h3>
    <p>
     让我们看看Context在实际项目中的一些高级应用：
    </p>
    <h4>
     <a id="_311">
     </a>
     分布式追踪
    </h4>
    <p>
     在微服务架构中，一个用户请求可能需要调用多个服务。分布式追踪允许我们跟踪请求在不同服务之间的流动。
    </p>
    <pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">handleRequest</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 从请求头中提取追踪ID，或生成新的</span>
    traceID <span class="token operator">:=</span> r<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"X-Trace-ID"</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> traceID <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{<!-- --></span>
        traceID <span class="token operator">=</span> <span class="token function">generateTraceID</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 将追踪ID添加到Context</span>
    ctx <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithValue</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> traceIDKey<span class="token punctuation">,</span> traceID<span class="token punctuation">)</span>
    
    <span class="token comment">// 使用带追踪ID的Context调用服务</span>
    result<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">processRequest</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
    
    <span class="token comment">// 在响应中包含追踪ID</span>
    w<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"X-Trace-ID"</span><span class="token punctuation">,</span> traceID<span class="token punctuation">)</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">processRequest</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">(</span>Result<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 从Context中获取追踪ID</span>
    traceID <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span>traceIDKey<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span>
    
    <span class="token comment">// 记录操作，包含追踪ID</span>
    log<span class="token punctuation">.</span><span class="token function">WithField</span><span class="token punctuation">(</span><span class="token string">"trace_id"</span><span class="token punctuation">,</span> traceID<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"Processing request"</span><span class="token punctuation">)</span>
    
    <span class="token comment">// 调用其他服务，传递追踪ID</span>
    req<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">NewRequestWithContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"GET"</span><span class="token punctuation">,</span> <span class="token string">"http://other-service/api"</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
    req<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"X-Trace-ID"</span><span class="token punctuation">,</span> traceID<span class="token punctuation">)</span>
    
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     这种方式允许我们跟踪请求在整个系统中的流动，大大简化了问题诊断。
    </p>
    <h4>
     <a id="_351">
     </a>
     并发控制和资源限制
    </h4>
    <p>
     Context可以用来实现复杂的并发控制模式，如信号量和工作池：
    </p>
    <pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">processItems</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> items <span class="token punctuation">[</span><span class="token punctuation">]</span>Item<span class="token punctuation">,</span> concurrency <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 创建信号量</span>
    sem <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> concurrency<span class="token punctuation">)</span>
    
    <span class="token comment">// 创建错误通道</span>
    errCh <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">error</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    
    <span class="token comment">// 创建等待组</span>
    <span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup
    
    <span class="token comment">// 启动worker</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> item <span class="token operator">:=</span> <span class="token keyword">range</span> items <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 获取信号量令牌</span>
        <span class="token keyword">select</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">case</span> sem <span class="token operator">&lt;-</span> <span class="token keyword">struct</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">:</span>
            <span class="token comment">// 获取到令牌，继续处理</span>
        <span class="token keyword">case</span> <span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment">// Context已取消，停止处理</span>
            <span class="token keyword">return</span> ctx<span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        
        wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>item Item<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token operator">&lt;-</span>sem <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 释放令牌</span>
            
            <span class="token comment">// 处理单个项目</span>
            <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">processItem</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 将第一个错误发送到通道</span>
                <span class="token keyword">select</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">case</span> errCh <span class="token operator">&lt;-</span> err<span class="token punctuation">:</span>
                <span class="token keyword">default</span><span class="token punctuation">:</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 等待所有worker完成</span>
    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">close</span><span class="token punctuation">(</span>errCh<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token comment">// 等待完成或Context取消</span>
    <span class="token keyword">select</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">case</span> err<span class="token punctuation">,</span> ok <span class="token operator">:=</span> <span class="token operator">&lt;-</span>errCh<span class="token punctuation">:</span>
        <span class="token keyword">if</span> ok <span class="token operator">&amp;&amp;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> err
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span>
    <span class="token keyword">case</span> <span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> ctx<span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     这个模式允许我们限制并发处理的项目数量，同时仍然保持对Context取消的响应。
    </p>
    <h4>
     <a id="_414">
     </a>
     优雅关闭
    </h4>
    <p>
     Context还可以用来实现服务的优雅关闭：
    </p>
    <pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 创建可取消的根Context</span>
    ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithCancel</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token comment">// 启动HTTP服务器</span>
    server <span class="token operator">:=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Server<span class="token punctuation">{<!-- --></span>
        Addr<span class="token punctuation">:</span> <span class="token string">":8080"</span><span class="token punctuation">,</span>
        Handler<span class="token punctuation">:</span> handler<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> err <span class="token operator">:=</span> server<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> err <span class="token operator">!=</span> http<span class="token punctuation">.</span>ErrServerClosed <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"HTTP server error: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token comment">// 监听信号</span>
    stop <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> os<span class="token punctuation">.</span>Signal<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    signal<span class="token punctuation">.</span><span class="token function">Notify</span><span class="token punctuation">(</span>stop<span class="token punctuation">,</span> os<span class="token punctuation">.</span>Interrupt<span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>SIGTERM<span class="token punctuation">)</span>
    
    <span class="token comment">// 等待信号</span>
    <span class="token operator">&lt;-</span>stop
    
    <span class="token comment">// 取消根Context</span>
    <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token comment">// 创建关闭超时</span>
    shutdownCtx<span class="token punctuation">,</span> shutdownCancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
    <span class="token keyword">defer</span> <span class="token function">shutdownCancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token comment">// 优雅关闭服务器</span>
    <span class="token keyword">if</span> err <span class="token operator">:=</span> server<span class="token punctuation">.</span><span class="token function">Shutdown</span><span class="token punctuation">(</span>shutdownCtx<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"HTTP server shutdown error: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Server gracefully stopped"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     这个模式确保服务器在接收到终止信号后能够优雅地关闭，等待现有请求完成，但不接受新请求。
    </p>
    <h3>
     <a id="Context_461">
     </a>
     Context性能分析与优化
    </h3>
    <p>
     使用Context可能会对性能产生影响，特别是在高并发场景下。让我们看看一些优化策略：
    </p>
    <h4>
     <a id="Context_465">
     </a>
     避免过深的Context链
    </h4>
    <p>
     每次调用
     <code>
      WithValue
     </code>
     都会创建一个新的Context对象并增加链的深度，这会影响
     <code>
      Value
     </code>
     方法的性能。
    </p>
    <p>
     不好的做法：
    </p>
    <pre><code class="prism language-go">ctx <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
ctx <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">WithValue</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> key1<span class="token punctuation">,</span> val1<span class="token punctuation">)</span>
ctx <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">WithValue</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> key2<span class="token punctuation">,</span> val2<span class="token punctuation">)</span>
ctx <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> timeout<span class="token punctuation">)</span>
ctx <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">WithValue</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> key3<span class="token punctuation">,</span> val3<span class="token punctuation">)</span>
<span class="token comment">// ...继续添加更多值</span>
</code></pre>
    <p>
     更好的做法是将相关的值组合到一个结构体中：
    </p>
    <pre><code class="prism language-go"><span class="token keyword">type</span> RequestInfo <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
    UserID    <span class="token builtin">string</span>
    TraceID   <span class="token builtin">string</span>
    SessionID <span class="token builtin">string</span>
    <span class="token comment">// ...其他请求相关信息</span>
<span class="token punctuation">}</span>

ctx <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
ctx <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">WithValue</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> requestInfoKey<span class="token punctuation">,</span> <span class="token operator">&amp;</span>RequestInfo<span class="token punctuation">{<!-- --></span>
    UserID<span class="token punctuation">:</span>    <span class="token string">"123"</span><span class="token punctuation">,</span>
    TraceID<span class="token punctuation">:</span>   <span class="token string">"abc"</span><span class="token punctuation">,</span>
    SessionID<span class="token punctuation">:</span> <span class="token string">"xyz"</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
ctx <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> timeout<span class="token punctuation">)</span>
</code></pre>
    <p>
     这样可以减少Context链的深度，提高
     <code>
      Value
     </code>
     方法的性能。
    </p>
    <h4>
     <a id="Context_501">
     </a>
     Context池化
    </h4>
    <p>
     在某些高性能场景下，可以考虑使用对象池来减少Context创建的开销：
    </p>
    <pre><code class="prism language-go"><span class="token keyword">var</span> timeoutCtxPool <span class="token operator">=</span> sync<span class="token punctuation">.</span>Pool<span class="token punctuation">{<!-- --></span>
    New<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">new</span><span class="token punctuation">(</span>timerCtx<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">CustomWithTimeout</span><span class="token punctuation">(</span>parent Context<span class="token punctuation">,</span> timeout time<span class="token punctuation">.</span>Duration<span class="token punctuation">)</span> <span class="token punctuation">(</span>Context<span class="token punctuation">,</span> CancelFunc<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 从池中获取对象</span>
    ctx <span class="token operator">:=</span> timeoutCtxPool<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>timerCtx<span class="token punctuation">)</span>
    
    <span class="token comment">// 初始化</span>
    ctx<span class="token punctuation">.</span>Context <span class="token operator">=</span> parent
    ctx<span class="token punctuation">.</span>timer <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">AfterFunc</span><span class="token punctuation">(</span>timeout<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        ctx<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> DeadlineExceeded<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    ctx<span class="token punctuation">.</span>deadline <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> ctx<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        ctx<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> Canceled<span class="token punctuation">)</span>
        ctx<span class="token punctuation">.</span>timer<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// 重置并返回池</span>
        ctx<span class="token punctuation">.</span>Context <span class="token operator">=</span> <span class="token boolean">nil</span>
        ctx<span class="token punctuation">.</span>timer <span class="token operator">=</span> <span class="token boolean">nil</span>
        timeoutCtxPool<span class="token punctuation">.</span><span class="token function">Put</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     这种方法可以减少内存分配和GC压力，但增加了实现复杂性，应谨慎使用。
    </p>
    <h4>
     <a id="Context_536">
     </a>
     Context设计理念
    </h4>
    <ol>
     <li>
      显式传递控制：Go倾向于显式传递控制流，而不是使用全局变量或隐式状态。Context作为第一个参数在函数间传递，使得控制流清晰可见。
     </li>
     <li>
      组合优于继承：Context的设计采用了嵌套组合而非继承，每个新Context都包装一个父Context，而不是继承它。这种组合方式更加灵活和可控。
     </li>
     <li>
      并发安全：Context设计为不可变的，一旦创建就不能修改，这使得它天然并发安全，可以在多个goroutine之间共享。
     </li>
     <li>
      功能分离：Context专注于解决特定问题：请求范围内的取消、超时和值传递。它不试图解决所有问题，而是与其他Go机制（如通道和WaitGroup）协同工作。
     </li>
    </ol>
    <h3>
     <a id="Context_543">
     </a>
     Context常见反模式
    </h3>
    <p>
     在使用Context时，有一些常见的反模式应该避免：
    </p>
    <h4>
     <a id="Context_547">
     </a>
     在结构体中存储Context
    </h4>
    <pre><code class="prism language-go"><span class="token comment">// 反模式</span>
<span class="token keyword">type</span> Service <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
    ctx context<span class="token punctuation">.</span>Context
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token comment">// 更好的方式</span>
<span class="token keyword">type</span> Service <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// ...没有存储Context</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>Service<span class="token punctuation">)</span> <span class="token function">DoSomething</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// ...使用传入的Context</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     Context应该作为函数参数传递，而不是存储在结构体中。这确保了每个操作都可以有自己的生命周期控制。
    </p>
    <h4>
     <a id="Context_568">
     </a>
     忽略Context取消
    </h4>
    <pre><code class="prism language-go"><span class="token comment">// 反模式</span>
<span class="token keyword">func</span> <span class="token function">doWork</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// ...执行一些工作</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span> <span class="token comment">// 没有检查ctx.Done()</span>
<span class="token punctuation">}</span>

<span class="token comment">// 更好的方式</span>
<span class="token keyword">func</span> <span class="token function">doWork</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">select</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">case</span> <span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> ctx<span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span>
        <span class="token comment">// ...执行一些工作</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 对于长时间运行的操作，定期检查</span>
    <span class="token keyword">for</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">select</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">case</span> <span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> ctx<span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">default</span><span class="token punctuation">:</span>
            <span class="token comment">// ...执行一部分工作</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     始终检查Context是否已取消，特别是在长时间运行的操作中。
    </p>
    <h4>
     <a id="BackgroundContext_600">
     </a>
     使用Background()而不是传入的Context
    </h4>
    <pre><code class="prism language-go"><span class="token comment">// 反模式</span>
<span class="token keyword">func</span> <span class="token function">fetchData</span><span class="token punctuation">(</span>url <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Data<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    ctx <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// ...使用ctx调用其他函数</span>
<span class="token punctuation">}</span>

<span class="token comment">// 更好的方式</span>
<span class="token keyword">func</span> <span class="token function">fetchData</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> url <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Data<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// ...使用传入的ctx</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     始终使用传入的Context，而不是创建新的Background Context。这确保了取消信号可以正确传播。
    </p>
    <h4>
     <a id="Context_617">
     </a>
     滥用Context值
    </h4>
    <pre><code class="prism language-go"><span class="token comment">// 反模式</span>
<span class="token keyword">func</span> <span class="token function">processRequest</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
    userID <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span><span class="token string">"user_id"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span>
    db <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span><span class="token string">"database"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span>Database<span class="token punctuation">)</span>
    config <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span><span class="token string">"config"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span>Config<span class="token punctuation">)</span>
    <span class="token comment">// ...使用这些值</span>
<span class="token punctuation">}</span>

<span class="token comment">// 更好的方式</span>
<span class="token keyword">func</span> <span class="token function">processRequest</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> userID <span class="token builtin">string</span><span class="token punctuation">,</span> db Database<span class="token punctuation">,</span> config Config<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// ...使用传入的参数</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     Context值应该用于请求范围的数据，而不是函数参数或依赖项。
    </p>
    <h3>
     <a id="Context_636">
     </a>
     高级Context模式
    </h3>
    <p>
     除了基本用法外，还有一些高级Context模式值得了解：
    </p>
    <h4>
     <a id="_640">
     </a>
     嵌套超时
    </h4>
    <p>
     有时我们需要为不同的操作阶段设置不同的超时：
    </p>
    <pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">processTwoPhase</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 第一阶段：准备，最多允许2秒</span>
    prepCtx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token number">2</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
    <span class="token keyword">defer</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">prepare</span><span class="token punctuation">(</span>prepCtx<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"准备阶段失败: %w"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 检查原始Context是否已取消</span>
    <span class="token keyword">select</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">case</span> <span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> ctx<span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 第二阶段：执行，最多允许5秒</span>
    execCtx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token number">5</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
    <span class="token keyword">defer</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">execute</span><span class="token punctuation">(</span>execCtx<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"执行阶段失败: %w"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     这种模式允许为操作的不同阶段设置不同的超时，同时仍然尊重父Context的取消信号。
    </p>
    <h4>
     <a id="Context_675">
     </a>
     自定义Context类型
    </h4>
    <p>
     在某些复杂场景下，可能需要实现自定义Context类型：
    </p>
    <pre><code class="prism language-go"><span class="token keyword">type</span> metricContext <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
    context<span class="token punctuation">.</span>Context
    startTime time<span class="token punctuation">.</span>Time
    operation <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">WithMetrics</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> operation <span class="token builtin">string</span><span class="token punctuation">)</span> context<span class="token punctuation">.</span>Context <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>metricContext<span class="token punctuation">{<!-- --></span>
        Context<span class="token punctuation">:</span>   ctx<span class="token punctuation">,</span>
        startTime<span class="token punctuation">:</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        operation<span class="token punctuation">:</span> operation<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>metricContext<span class="token punctuation">)</span> <span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span> <span class="token punctuation">{<!-- --></span>
    done <span class="token operator">:=</span> c<span class="token punctuation">.</span>Context<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token comment">// 创建一个新的通道</span>
    ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    
    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 等待父Context的Done通道关闭</span>
        <span class="token operator">&lt;-</span>done
        
        <span class="token comment">// 记录操作耗时</span>
        duration <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>startTime<span class="token punctuation">)</span>
        metrics<span class="token punctuation">.</span><span class="token function">RecordOperationDuration</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>operation<span class="token punctuation">,</span> duration<span class="token punctuation">)</span>
        
        <span class="token comment">// 关闭我们的通道</span>
        <span class="token function">close</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> ch
<span class="token punctuation">}</span>
</code></pre>
    <p>
     这个自定义Context可以在操作取消或完成时自动记录指标，而不需要修改现有代码。
    </p>
    <h4>
     <a id="_718">
     </a>
     协调多个取消源
    </h4>
    <p>
     有时需要从多个来源协调取消信号：
    </p>
    <pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">withMultipleCancel</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> cancels <span class="token operator">...</span><span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> context<span class="token punctuation">.</span>CancelFunc<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithCancel</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
    
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ch <span class="token operator">:=</span> <span class="token keyword">range</span> cancels <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ch <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">select</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">case</span> <span class="token operator">&lt;-</span>ch<span class="token punctuation">:</span>
                <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">case</span> <span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">return</span> ctx<span class="token punctuation">,</span> cancel
<span class="token punctuation">}</span>
</code></pre>
    <p>
     这个函数创建一个会在任何取消源触发时取消的Context，可用于协调来自不同系统的取消信号。
    </p>
    <hr/>
    <p>
     <em>
      参考资料：
     </em>
    </p>
    <ol>
     <li>
      Go官方文档：https://golang.org/pkg/context/
     </li>
     <li>
      Go博客 - Context包介绍：https://blog.golang.org/context
     </li>
     <li>
      Go源码：https://github.com/golang/go/blob/master/src/context/context.go
     </li>
     <li>
      Dave Cheney - Context是错误的设计吗？：https://dave.cheney.net/2017/01/26/context-is-for-cancelation
     </li>
     <li>
      Rob Pike - Go Concurrency Patterns：https://talks.golang.org/2012/concurrency.slide
     </li>
    </ol>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="6874747073:3a2f2f626c6f672e6373646e2e6e65742f687a66303730312f:61727469636c652f64657461696c732f313436323134393339" class_="artid" style="display:none">
 </p>
</div>


