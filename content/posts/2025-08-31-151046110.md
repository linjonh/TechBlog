---
layout: post
title: "Nginx-502-Bad-Gatewayä»-upstream-æ—¥å¿—åˆ°-FastCGI-è¶…æ—¶å¤ç›˜"
date: 2025-08-31T14:25:02+0800
description: "æ‘˜è¦ï¼šæœ¬æ–‡æ·±å…¥å‰–æNginx 502 Bad Gatewayé”™è¯¯ï¼Œä»FastCGIè¶…æ—¶åˆ°upstreamæ—¥å¿—åˆ†æï¼Œæä¾›å®Œæ•´çš„æ’æŸ¥æ–¹æ¡ˆã€‚é€šè¿‡é…ç½®ä¼˜åŒ–ã€ç›‘æ§å‘Šè­¦ä½“ç³»å»ºè®¾åŠå®æˆ˜æ¡ˆä¾‹å¤ç›˜ï¼Œç³»ç»Ÿæ€§åœ°è§£å†³502é”™è¯¯é—®é¢˜ã€‚é‡ç‚¹åŒ…æ‹¬ï¼š1ï¼‰FastCGIåè®®æ·±åº¦è§£æä¸å‚æ•°è°ƒä¼˜ï¼›2ï¼‰åŠ¨æ€è¶…æ—¶è°ƒæ•´è„šæœ¬å¼€å‘ï¼›3ï¼‰Prometheusç›‘æ§é…ç½®ï¼›4ï¼‰è‡ªåŠ¨åŒ–æ•…éšœæ¢å¤æœºåˆ¶ã€‚æ–‡ç« åˆ†äº«ç”Ÿäº§ç¯å¢ƒä¸­ç§¯ç´¯çš„å®æˆ˜ç»éªŒï¼Œå¸®åŠ©å¼€å‘è€…å»ºç«‹å®Œæ•´çš„502é”™è¯¯è¯Šæ–­å’Œé¢„é˜²ä½“ç³»ï¼Œæå‡ç³»ç»Ÿç¨³å®šæ€§ã€‚"
keywords: "Nginx 502 Bad Gatewayï¼šä» upstream æ—¥å¿—åˆ° FastCGI è¶…æ—¶å¤ç›˜"
categories: ['æœªåˆ†ç±»']
tags: ['ç½‘ç»œ', 'Nginx', 'Gateway', 'Fpm', 'Fastcgi']
artid: "151046110"
arturl: "https://blog.csdn.net/IRpickstars/article/details/151046110"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=151046110
    alt: "Nginx-502-Bad-Gatewayä»-upstream-æ—¥å¿—åˆ°-FastCGI-è¶…æ—¶å¤ç›˜"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=151046110
featuredImagePreview: https://bing.ee123.net/img/rand?artid=151046110
cover: https://bing.ee123.net/img/rand?artid=151046110
image: https://bing.ee123.net/img/rand?artid=151046110
img: https://bing.ee123.net/img/rand?artid=151046110
---



# Nginx 502 Bad Gatewayï¼šä» upstream æ—¥å¿—åˆ° FastCGI è¶…æ—¶å¤ç›˜

![](https://i-blog.csdnimg.cn/img_convert/f54743c5b190f34b63898ba19cc8d076.png)

## Nginx 502 Bad Gatewayï¼šä» upstream æ—¥å¿—åˆ° FastCGI è¶…æ—¶å¤ç›˜

> ğŸŒŸ Helloï¼Œæˆ‘æ˜¯æ‘˜æ˜Ÿï¼  
>  ğŸŒˆ åœ¨å½©è™¹èˆ¬ç»šçƒ‚çš„æŠ€æœ¯æ ˆä¸­ï¼Œæˆ‘æ˜¯é‚£ä¸ªæ°¸ä¸åœæ­‡çš„è‰²å½©æ”¶é›†è€…ã€‚  
>  ğŸ¦‹ æ¯ä¸€ä¸ªä¼˜åŒ–éƒ½æ˜¯æˆ‘åŸ¹è‚²çš„èŠ±æœµï¼Œæ¯ä¸€ä¸ªç‰¹æ€§éƒ½æ˜¯æˆ‘æ”¾é£çš„è´è¶ã€‚  
>  ğŸ”¬ æ¯ä¸€æ¬¡ä»£ç å®¡æŸ¥éƒ½æ˜¯æˆ‘çš„æ˜¾å¾®é•œè§‚å¯Ÿï¼Œæ¯ä¸€æ¬¡é‡æ„éƒ½æ˜¯æˆ‘çš„åŒ–å­¦å®éªŒã€‚  
>  ğŸµ åœ¨ç¼–ç¨‹çš„äº¤å“ä¹ä¸­ï¼Œæˆ‘æ—¢æ˜¯æŒ‡æŒ¥å®¶ä¹Ÿæ˜¯æ¼”å¥è€…ã€‚è®©æˆ‘ä»¬ä¸€èµ·ï¼Œåœ¨æŠ€æœ¯çš„éŸ³ä¹å…é‡Œï¼Œå¥å“å±äºç¨‹åºå‘˜çš„åç¾ä¹ç« ã€‚




























---

### æ‘˜è¦

ä½œä¸ºä¸€ååœ¨ç”Ÿäº§ç¯å¢ƒä¸­æ‘¸çˆ¬æ»šæ‰“å¤šå¹´çš„è¿ç»´å·¥ç¨‹å¸ˆï¼Œæˆ‘æ·±çŸ¥ 502 Bad Gateway é”™è¯¯å¯¹ä¸šåŠ¡çš„è‡´å‘½å½±å“ã€‚å°±åœ¨ä¸Šå‘¨ï¼Œæˆ‘ä»¬çš„ç”µå•†å¹³å°åœ¨é«˜å³°æœŸçªç„¶å‡ºç°å¤§é‡ 502 é”™è¯¯ï¼Œç”¨æˆ·æŠ•è¯‰å¦‚é›ªèŠ±èˆ¬é£æ¥ï¼Œä¸šåŠ¡æŸå¤±ä¸å¯ä¼°é‡ã€‚è¿™æ¬¡äº‹æ•…è®©æˆ‘æ·±åˆ»è®¤è¯†åˆ°ï¼Œä»…ä»…çŸ¥é“ 502 æ˜¯"ç½‘å…³é”™è¯¯"æ˜¯è¿œè¿œä¸å¤Ÿçš„ï¼Œå¿…é¡»æ·±å…¥ç†è§£å…¶èƒŒåçš„æŠ€æœ¯åŸç†å’Œæ’æŸ¥æ–¹æ³•ã€‚

åœ¨è¿™æ¬¡å¤ç›˜ä¸­ï¼Œæˆ‘å°†ä»æœ€åŸºç¡€çš„ Nginx upstream æœºåˆ¶å¼€å§‹ï¼Œé€æ­¥æ·±å…¥åˆ° FastCGI åè®®ç»†èŠ‚ï¼Œå†åˆ°è¶…æ—¶å‚æ•°çš„ç²¾ç¡®è°ƒä¼˜ã€‚æˆ‘å‘ç°å¾ˆå¤šå¼€å‘è€…å¯¹ 502 é”™è¯¯çš„ç†è§£åœç•™åœ¨è¡¨é¢ï¼Œè®¤ä¸ºåªæ˜¯ç®€å•çš„æœåŠ¡ä¸å¯ç”¨ï¼Œä½†å®é™…ä¸Šå®ƒæ¶‰åŠåˆ°ç½‘ç»œå±‚ã€åº”ç”¨å±‚ã€è¿›ç¨‹ç®¡ç†ç­‰å¤šä¸ªç»´åº¦çš„å¤æ‚äº¤äº’ã€‚é€šè¿‡è¿™æ¬¡æ·±åº¦åˆ†æï¼Œæˆ‘ä¸ä»…æ‰¾åˆ°äº†é—®é¢˜çš„æ ¹æœ¬åŸå› ï¼Œæ›´é‡è¦çš„æ˜¯å»ºç«‹äº†ä¸€å¥—å®Œæ•´çš„ 502 é”™è¯¯è¯Šæ–­å’Œé¢„é˜²ä½“ç³»ã€‚

æœ¬æ–‡å°†å¸¦ä½ èµ°è¿‡æˆ‘çš„å®Œæ•´æ’æŸ¥è¿‡ç¨‹ï¼šä»æ—¥å¿—åˆ†æçš„è››ä¸é©¬è¿¹ï¼Œåˆ°ç½‘ç»œæŠ“åŒ…çš„æŠ€æœ¯ç»†èŠ‚ï¼Œä»é…ç½®å‚æ•°çš„ç²¾ç¡®è°ƒä¼˜ï¼Œåˆ°ç›‘æ§å‘Šè­¦çš„ä½“ç³»å»ºè®¾ã€‚æˆ‘ä¼šåˆ†äº«é‚£äº›åœ¨å®˜æ–¹æ–‡æ¡£ä¸­æ‰¾ä¸åˆ°çš„å®æˆ˜ç»éªŒï¼Œé‚£äº›åªæœ‰åœ¨ç”Ÿäº§ç¯å¢ƒä¸­æ‰èƒ½é‡åˆ°çš„è¾¹ç¼˜æ¡ˆä¾‹ï¼Œä»¥åŠé‚£äº›èƒ½å¤Ÿåœ¨å…³é”®æ—¶åˆ»æ•‘å‘½çš„è°ƒè¯•æŠ€å·§ã€‚æ— è®ºä½ æ˜¯åˆšæ¥è§¦ Nginx çš„æ–°æ‰‹ï¼Œè¿˜æ˜¯æœ‰ä¸€å®šç»éªŒçš„è¿ç»´å·¥ç¨‹å¸ˆï¼Œè¿™ç¯‡æ–‡ç« éƒ½å°†ä¸ºä½ æä¾›å®è´µçš„å®æˆ˜æŒ‡å¯¼ã€‚

![](https://i-blog.csdnimg.cn/img_convert/edb64da376008e09e1904cc590386cbc.png)

**å›¾1ï¼šNginx 502 é”™è¯¯äº§ç”Ÿæµç¨‹å›¾**

### 1. 502 é”™è¯¯çš„æœ¬è´¨ç†è§£

#### 1.1 HTTP çŠ¶æ€ç æ·±åº¦è§£æ

502 Bad Gateway å±äº 5xx æœåŠ¡å™¨é”™è¯¯ç±»åˆ«ï¼Œå…·ä½“å«ä¹‰æ˜¯ç½‘å…³æˆ–ä»£ç†æœåŠ¡å™¨ä»ä¸Šæ¸¸æœåŠ¡å™¨æ¥æ”¶åˆ°æ— æ•ˆå“åº”ã€‚åœ¨ Nginx ä½œä¸ºåå‘ä»£ç†çš„åœºæ™¯ä¸­ï¼Œè¿™æ„å‘³ç€ Nginx æ— æ³•ä»åç«¯æœåŠ¡å™¨è·å¾—æœ‰æ•ˆçš„ HTTP å“åº”ã€‚

```
# Nginx é…ç½®ç¤ºä¾‹ï¼šåŸºç¡€ upstream é…ç½®
upstream backend {
    # æœåŠ¡å™¨æƒé‡é…ç½®
    server 127.0.0.1:9000 weight=3 max_fails=2 fail_timeout=30s;
    server 127.0.0.1:9001 weight=2 max_fails=2 fail_timeout=30s;
    server 127.0.0.1:9002 weight=1 max_fails=2 fail_timeout=30s backup;
    
    # è´Ÿè½½å‡è¡¡ç®—æ³•
    least_conn;
    
    # å¥åº·æ£€æŸ¥é…ç½®
    keepalive 32;
    keepalive_requests 100;
    keepalive_timeout 60s;
}

server {
    listen 80;
    server_name example.com;
    
    location / {
        proxy_pass http://backend;
        
        # å…³é”®è¶…æ—¶å‚æ•°
        proxy_connect_timeout 5s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # é”™è¯¯å¤„ç†
        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503;
        proxy_next_upstream_tries 3;
        proxy_next_upstream_timeout 10s;
    }
}
```

è¿™ä¸ªé…ç½®å±•ç¤ºäº† Nginx upstream çš„æ ¸å¿ƒå‚æ•°ã€‚`max_fails` å’Œ `fail_timeout` æ§åˆ¶æœåŠ¡å™¨å¥åº·æ£€æŸ¥ï¼Œ`proxy_next_upstream` ç³»åˆ—å‚æ•°å†³å®šäº†é‡åˆ°é”™è¯¯æ—¶çš„é‡è¯•ç­–ç•¥ã€‚

#### 1.2 502 é”™è¯¯çš„å¸¸è§è§¦å‘åœºæ™¯

![](https://i-blog.csdnimg.cn/img_convert/d44b0d7ce55f22fc04e548f90f23647d.png)

**å›¾2ï¼š502 é”™è¯¯åŸå› åˆ†å¸ƒé¥¼å›¾**

æ ¹æ®æˆ‘çš„ç”Ÿäº§ç¯å¢ƒç»Ÿè®¡ï¼ŒFastCGI è¶…æ—¶æ˜¯å¯¼è‡´ 502 é”™è¯¯çš„ä¸»è¦åŸå› ï¼Œå æ¯”è¾¾åˆ° 35%ã€‚è¿™ä¹Ÿæ˜¯æœ¬æ–‡é‡ç‚¹å…³æ³¨çš„é—®é¢˜ã€‚

### 2. upstream æ—¥å¿—åˆ†æå®æˆ˜

#### 2.1 æ—¥å¿—æ ¼å¼é…ç½®ä¸å…³é”®ä¿¡æ¯æå–

```
# è‡ªå®šä¹‰æ—¥å¿—æ ¼å¼ï¼ŒåŒ…å« upstream è¯¦ç»†ä¿¡æ¯
log_format upstream_log '$remote_addr - $remote_user [$time_local] '
                       '"$request" $status $body_bytes_sent '
                       '"$http_referer" "$http_user_agent" '
                       'rt=$request_time uct="$upstream_connect_time" '
                       'uht="$upstream_header_time" urt="$upstream_response_time" '
                       'uaddr="$upstream_addr" ustatus="$upstream_status"';

server {
    access_log /var/log/nginx/upstream.log upstream_log;
    error_log /var/log/nginx/error.log debug;
}
```

å…³é”®å‚æ•°è§£é‡Šï¼š

* `$upstream_connect_time`: ä¸åç«¯å»ºç«‹è¿æ¥çš„æ—¶é—´

* `$upstream_header_time`: æ¥æ”¶åç«¯å“åº”å¤´çš„æ—¶é—´

* `$upstream_response_time`: æ¥æ”¶å®Œæ•´å“åº”çš„æ—¶é—´

* `$upstream_addr`: å®é™…å¤„ç†è¯·æ±‚çš„åç«¯æœåŠ¡å™¨åœ°å€

* `$upstream_status`: åç«¯æœåŠ¡å™¨è¿”å›çš„çŠ¶æ€ç 

#### 2.2 æ—¥å¿—åˆ†æè„šæœ¬

```
#!/bin/bash
# upstream_analyzer.sh - Nginx upstream æ—¥å¿—åˆ†æè„šæœ¬

LOG_FILE="/var/log/nginx/upstream.log"
ANALYSIS_PERIOD="1h"  # åˆ†ææœ€è¿‘1å°æ—¶çš„æ—¥å¿—

echo "=== Nginx Upstream 502 é”™è¯¯åˆ†ææŠ¥å‘Š ==="
echo "åˆ†ææ—¶é—´æ®µ: æœ€è¿‘ $ANALYSIS_PERIOD"
echo "æ—¥å¿—æ–‡ä»¶: $LOG_FILE"
echo

# ç»Ÿè®¡ 502 é”™è¯¯æ€»æ•°
error_502_count=$(grep " 502 " "$LOG_FILE" | wc -l)
echo "502 é”™è¯¯æ€»æ•°: $error_502_count"

# åˆ†æ 502 é”™è¯¯çš„ upstream å“åº”æ—¶é—´åˆ†å¸ƒ
echo -e "\n=== 502 é”™è¯¯å“åº”æ—¶é—´åˆ†æ ==="
grep " 502 " "$LOG_FILE" | \
awk '{
    # æå– upstream_response_time
    match($0, /urt="([^"]*)"/, arr)
    if (arr[1] != "-") {
        time = arr[1]
        if (time < 1) bucket="<1s"
        else if (time < 5) bucket="1-5s" 
        else if (time < 10) bucket="5-10s"
        else if (time < 30) bucket="10-30s"
        else bucket=">30s"
        count[bucket]++
    }
}
END {
    for (b in count) {
        printf "%-8s: %d æ¬¡\n", b, count[b]
    }
}'

# åˆ†ææœ€é¢‘ç¹å‡ºç° 502 çš„åç«¯æœåŠ¡å™¨
echo -e "\n=== 502 é”™è¯¯åç«¯æœåŠ¡å™¨åˆ†å¸ƒ ==="
grep " 502 " "$LOG_FILE" | \
awk '{
    match($0, /uaddr="([^"]*)"/, arr)
    if (arr[1] != "-") {
        servers[arr[1]]++
    }
}
END {
    for (server in servers) {
        printf "%-20s: %d æ¬¡\n", server, servers[server]
    }
}' | sort -k2 -nr

# åˆ†æ 502 é”™è¯¯çš„æ—¶é—´åˆ†å¸ƒ
echo -e "\n=== 502 é”™è¯¯æ—¶é—´åˆ†å¸ƒï¼ˆæŒ‰å°æ—¶ï¼‰ ==="
grep " 502 " "$LOG_FILE" | \
awk '{
    # æå–æ—¶é—´æˆ³ä¸­çš„å°æ—¶
    match($0, /\[([^\]]+)\]/, arr)
    split(arr[1], datetime, ":")
    hour = datetime[2]
    hours[hour]++
}
END {
    for (h in hours) {
        printf "%s:00 - %d æ¬¡\n", h, hours[h]
    }
}' | sort
```

è¿™ä¸ªè„šæœ¬èƒ½å¤Ÿå¿«é€Ÿåˆ†æ upstream æ—¥å¿—ï¼Œè¯†åˆ« 502 é”™è¯¯çš„æ¨¡å¼å’Œè¶‹åŠ¿ï¼Œä¸ºé—®é¢˜å®šä½æä¾›æ•°æ®æ”¯æ’‘ã€‚

### 3. FastCGI åè®®æ·±åº¦å‰–æ

#### 3.1 FastCGI é€šä¿¡æœºåˆ¶

![](https://i-blog.csdnimg.cn/img_convert/ffee7934bf104f0dae896505403f8914.png)

**å›¾3ï¼šFastCGI åè®®é€šä¿¡æ—¶åºå›¾**

#### 3.2 PHP-FPM é…ç½®ä¼˜åŒ–

```
; /etc/php/8.1/fpm/pool.d/www.conf
; PHP-FPM è¿›ç¨‹æ± é…ç½®ä¼˜åŒ–

[www]
; è¿›ç¨‹ç®¡ç†å™¨ç±»å‹
pm = dynamic

; è¿›ç¨‹æ•°é‡é…ç½®
pm.max_children = 50          ; æœ€å¤§å­è¿›ç¨‹æ•°
pm.start_servers = 10         ; å¯åŠ¨æ—¶çš„è¿›ç¨‹æ•°
pm.min_spare_servers = 5      ; æœ€å°ç©ºé—²è¿›ç¨‹æ•°
pm.max_spare_servers = 15     ; æœ€å¤§ç©ºé—²è¿›ç¨‹æ•°

; è¿›ç¨‹ç”Ÿå‘½å‘¨æœŸç®¡ç†
pm.max_requests = 1000        ; æ¯ä¸ªè¿›ç¨‹å¤„ç†çš„æœ€å¤§è¯·æ±‚æ•°
pm.process_idle_timeout = 60s ; ç©ºé—²è¿›ç¨‹è¶…æ—¶æ—¶é—´

; è¶…æ—¶é…ç½® - å…³é”®å‚æ•°
request_timeout = 300s        ; å•ä¸ªè¯·æ±‚è¶…æ—¶æ—¶é—´
request_terminate_timeout = 300s ; å¼ºåˆ¶ç»ˆæ­¢è¶…æ—¶æ—¶é—´

; æ…¢æ—¥å¿—é…ç½®
slowlog = /var/log/php8.1-fpm-slow.log
request_slowlog_timeout = 10s ; æ…¢æŸ¥è¯¢é˜ˆå€¼

; çŠ¶æ€ç›‘æ§
pm.status_path = /fpm-status
ping.path = /fpm-ping
ping.response = pong

; å®‰å…¨é…ç½®
security.limit_extensions = .php .php3 .php4 .php5 .php7 .php8

; ç¯å¢ƒå˜é‡
env[HOSTNAME] = $HOSTNAME
env[PATH] = /usr/local/bin:/usr/bin:/bin
env[TMP] = /tmp
env[TMPDIR] = /tmp
env[TEMP] = /tmp
```

å…³é”®é…ç½®è¯´æ˜ï¼š

* `request_timeout`: æ§åˆ¶å•ä¸ªè¯·æ±‚çš„æœ€å¤§æ‰§è¡Œæ—¶é—´

* `pm.max_children`: å½±å“å¹¶å‘å¤„ç†èƒ½åŠ›

* `request_slowlog_timeout`: å¸®åŠ©è¯†åˆ«æ…¢æŸ¥è¯¢

#### 3.3 Nginx FastCGI å‚æ•°è°ƒä¼˜

```
location ~ \.php$ {
    fastcgi_pass unix:/var/run/php/php8.1-fpm.sock;
    fastcgi_index index.php;
    
    # FastCGI è¶…æ—¶å‚æ•° - æ ¸å¿ƒé…ç½®
    fastcgi_connect_timeout 60s;     # è¿æ¥è¶…æ—¶
    fastcgi_send_timeout 300s;       # å‘é€è¶…æ—¶
    fastcgi_read_timeout 300s;       # è¯»å–è¶…æ—¶
    
    # ç¼“å†²åŒºé…ç½®
    fastcgi_buffer_size 64k;         # å“åº”å¤´ç¼“å†²åŒº
    fastcgi_buffers 4 64k;           # å“åº”ä½“ç¼“å†²åŒº
    fastcgi_busy_buffers_size 128k;  # å¿™ç¢Œç¼“å†²åŒºå¤§å°
    
    # ä¸´æ—¶æ–‡ä»¶é…ç½®
    fastcgi_temp_file_write_size 128k;
    fastcgi_max_temp_file_size 256m;
    
    # é”™è¯¯å¤„ç†
    fastcgi_intercept_errors on;
    fastcgi_ignore_client_abort off;
    
    # å‚æ•°ä¼ é€’
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    fastcgi_param QUERY_STRING $query_string;
    fastcgi_param REQUEST_METHOD $request_method;
    fastcgi_param CONTENT_TYPE $content_type;
    fastcgi_param CONTENT_LENGTH $content_length;
    
    # è‡ªå®šä¹‰å‚æ•°
    fastcgi_param HTTP_X_REAL_IP $remote_addr;
    fastcgi_param HTTP_X_FORWARDED_FOR $proxy_add_x_forwarded_for;
    fastcgi_param HTTP_X_FORWARDED_PROTO $scheme;
}
```

### 4. è¶…æ—¶å‚æ•°ç²¾ç¡®è°ƒä¼˜

#### 4.1 è¶…æ—¶å‚æ•°å±‚çº§å…³ç³»

![](https://i-blog.csdnimg.cn/img_convert/c4d1f14d2659933e13aad70ba7fcb36d.png)

**å›¾4ï¼šè¶…æ—¶å‚æ•°å±‚çº§å…³ç³»æ¶æ„å›¾**

#### 4.2 è¶…æ—¶å‚æ•°å¯¹æ¯”è¡¨

|  |  |  |  |  |  |
| --- | --- | --- | --- | --- | --- |
| å‚æ•°ç±»å‹ | é…ç½®ä½ç½® | é»˜è®¤å€¼ | æ¨èå€¼ | å½±å“èŒƒå›´ | å¤‡æ³¨ |
| `proxy_connect_timeout` | Nginx | 60s | 5s | è¿æ¥å»ºç«‹ | è¿‡é•¿ä¼šå½±å“æ•…éšœåˆ‡æ¢ |
| `fastcgi_connect_timeout` | Nginx | 60s | 10s | FastCGIè¿æ¥ | æœ¬åœ°è¿æ¥é€šå¸¸å¾ˆå¿« |
| `fastcgi_send_timeout` | Nginx | 60s | 300s | æ•°æ®å‘é€ | å¤§æ–‡ä»¶ä¸Šä¼ éœ€è¦æ›´é•¿æ—¶é—´ |
| `fastcgi_read_timeout` | Nginx | 60s | 300s | å“åº”è¯»å– | å¤æ‚ä¸šåŠ¡é€»è¾‘éœ€è¦æ›´é•¿æ—¶é—´ |
| `request_timeout` | PHP-FPM | 0 | 300s | è¯·æ±‚å¤„ç† | 0è¡¨ç¤ºæ— é™åˆ¶ï¼Œç”Ÿäº§ç¯å¢ƒå¿…é¡»è®¾ç½® |
| `max_execution_time` | PHP | 30s | 300s | è„šæœ¬æ‰§è¡Œ | å½±å“æ‰€æœ‰PHPè„šæœ¬ |

#### 4.3 åŠ¨æ€è¶…æ—¶è°ƒæ•´è„šæœ¬

```
#!/bin/bash
# timeout_optimizer.sh - æ ¹æ®ä¸šåŠ¡è´Ÿè½½åŠ¨æ€è°ƒæ•´è¶…æ—¶å‚æ•°

# é…ç½®æ–‡ä»¶è·¯å¾„
NGINX_CONF="/etc/nginx/sites-available/default"
PHP_FPM_CONF="/etc/php/8.1/fpm/pool.d/www.conf"

# è·å–å½“å‰ç³»ç»Ÿè´Ÿè½½
get_system_load() {
    local load_1min=$(uptime | awk -F'load average:' '{print $2}' | awk -F',' '{print $1}' | tr -d ' ')
    echo "$load_1min"
}

# è·å– PHP-FPM è¿›ç¨‹çŠ¶æ€
get_fpm_status() {
    local active_processes=$(curl -s http://localhost/fpm-status | grep "active processes" | awk '{print $3}')
    local total_processes=$(curl -s http://localhost/fpm-status | grep "total processes" | awk '{print $3}')
    echo "$active_processes/$total_processes"
}

# åˆ†ææœ€è¿‘çš„ 502 é”™è¯¯ç‡
analyze_502_rate() {
    local error_count=$(tail -1000 /var/log/nginx/access.log | grep " 502 " | wc -l)
    local total_requests=$(tail -1000 /var/log/nginx/access.log | wc -l)
    local error_rate=$(echo "scale=4; $error_count / $total_requests * 100" | bc)
    echo "$error_rate"
}

# åŠ¨æ€è°ƒæ•´è¶…æ—¶å‚æ•°
adjust_timeouts() {
    local load=$(get_system_load)
    local error_rate=$(analyze_502_rate)
    
    echo "å½“å‰ç³»ç»Ÿè´Ÿè½½: $load"
    echo "å½“å‰ 502 é”™è¯¯ç‡: $error_rate%"
    
    # æ ¹æ®è´Ÿè½½å’Œé”™è¯¯ç‡è°ƒæ•´å‚æ•°
    if (( $(echo "$load > 2.0" | bc -l) )) || (( $(echo "$error_rate > 5.0" | bc -l) )); then
        echo "æ£€æµ‹åˆ°é«˜è´Ÿè½½æˆ–é«˜é”™è¯¯ç‡ï¼Œå¢åŠ è¶…æ—¶æ—¶é—´..."
        
        # å¤‡ä»½åŸé…ç½®
        cp "$NGINX_CONF" "${NGINX_CONF}.backup.$(date +%Y%m%d_%H%M%S)"
        
        # è°ƒæ•´ Nginx è¶…æ—¶å‚æ•°
        sed -i 's/fastcgi_read_timeout [^;]*/fastcgi_read_timeout 600s/' "$NGINX_CONF"
        sed -i 's/fastcgi_send_timeout [^;]*/fastcgi_send_timeout 600s/' "$NGINX_CONF"
        
        # è°ƒæ•´ PHP-FPM è¶…æ—¶å‚æ•°
        sed -i 's/request_timeout = [^;]*/request_timeout = 600s/' "$PHP_FPM_CONF"
        
        # é‡è½½é…ç½®
        nginx -s reload
        systemctl reload php8.1-fpm
        
        echo "è¶…æ—¶å‚æ•°å·²è°ƒæ•´ä¸º 600s"
        
    elif (( $(echo "$load < 0.5" | bc -l) )) && (( $(echo "$error_rate < 1.0" | bc -l) )); then
        echo "ç³»ç»Ÿè´Ÿè½½è¾ƒä½ï¼Œæ¢å¤é»˜è®¤è¶…æ—¶æ—¶é—´..."
        
        # æ¢å¤é»˜è®¤é…ç½®
        sed -i 's/fastcgi_read_timeout [^;]*/fastcgi_read_timeout 300s/' "$NGINX_CONF"
        sed -i 's/fastcgi_send_timeout [^;]*/fastcgi_send_timeout 300s/' "$NGINX_CONF"
        sed -i 's/request_timeout = [^;]*/request_timeout = 300s/' "$PHP_FPM_CONF"
        
        # é‡è½½é…ç½®
        nginx -s reload
        systemctl reload php8.1-fpm
        
        echo "è¶…æ—¶å‚æ•°å·²æ¢å¤ä¸º 300s"
    else
        echo "ç³»ç»ŸçŠ¶æ€æ­£å¸¸ï¼Œä¿æŒå½“å‰é…ç½®"
    fi
}

# ä¸»å‡½æ•°
main() {
    echo "=== Nginx FastCGI è¶…æ—¶å‚æ•°åŠ¨æ€ä¼˜åŒ– ==="
    echo "æ‰§è¡Œæ—¶é—´: $(date)"
    echo
    
    adjust_timeouts
    
    echo
    echo "ä¼˜åŒ–å®Œæˆï¼Œå»ºè®®ç»§ç»­ç›‘æ§ç³»ç»ŸçŠ¶æ€"
}

# æ‰§è¡Œä¸»å‡½æ•°
main
```

### 5. ç›‘æ§ä¸å‘Šè­¦ä½“ç³»

#### 5.1 Prometheus ç›‘æ§é…ç½®

```
# nginx-exporter.yml - Nginx ç›‘æ§é…ç½®
global:
  scrape_interval: 15s
  evaluation_interval: 15s

rule_files:
  - "nginx_rules.yml"

scrape_configs:
  - job_name: 'nginx'
    static_configs:
      - targets: ['localhost:9113']
    scrape_interval: 5s
    metrics_path: /metrics

  - job_name: 'php-fpm'
    static_configs:
      - targets: ['localhost:9253']
    scrape_interval: 5s

alerting:
  alertmanagers:
    - static_configs:
        - targets:
          - alertmanager:9093
```

```
# nginx_rules.yml - å‘Šè­¦è§„åˆ™é…ç½®
groups:
  - name: nginx_alerts
    rules:
      - alert: Nginx502ErrorHigh
        expr: rate(nginx_http_requests_total{status="502"}[5m]) > 0.1
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Nginx 502 é”™è¯¯ç‡è¿‡é«˜"
          description: "502 é”™è¯¯ç‡åœ¨è¿‡å» 5 åˆ†é’Ÿå†…è¶…è¿‡ 10%"

      - alert: FastCGITimeoutHigh
        expr: nginx_http_request_duration_seconds{quantile="0.95"} > 30
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "FastCGI å“åº”æ—¶é—´è¿‡é•¿"
          description: "95% çš„è¯·æ±‚å“åº”æ—¶é—´è¶…è¿‡ 30 ç§’"

      - alert: PHPFPMProcessesHigh
        expr: phpfpm_active_processes / phpfpm_total_processes > 0.8
        for: 3m
        labels:
          severity: warning
        annotations:
          summary: "PHP-FPM è¿›ç¨‹ä½¿ç”¨ç‡è¿‡é«˜"
          description: "æ´»è·ƒè¿›ç¨‹æ•°å æ€»è¿›ç¨‹æ•°çš„ 80% ä»¥ä¸Š"
```

#### 5.2 è‡ªåŠ¨åŒ–æ•…éšœæ¢å¤è„šæœ¬

```
#!/bin/bash
# auto_recovery.sh - 502 é”™è¯¯è‡ªåŠ¨æ¢å¤è„šæœ¬

LOG_FILE="/var/log/nginx/access.log"
ERROR_THRESHOLD=10  # 5åˆ†é’Ÿå†…502é”™è¯¯è¶…è¿‡10æ¬¡è§¦å‘æ¢å¤
TIME_WINDOW=300     # æ—¶é—´çª—å£ï¼š5åˆ†é’Ÿ

# æ£€æŸ¥ 502 é”™è¯¯é¢‘ç‡
check_502_frequency() {
    local current_time=$(date +%s)
    local start_time=$((current_time - TIME_WINDOW))
    
    # ç»Ÿè®¡æ—¶é—´çª—å£å†…çš„ 502 é”™è¯¯
    local error_count=$(awk -v start="$start_time" '
    {
        # è§£ææ—¶é—´æˆ³
        gsub(/\[|\]/, "", $4)
        cmd = "date -d \"" $4 "\" +%s"
        cmd | getline timestamp
        close(cmd)
        
        if (timestamp >= start && $9 == "502") {
            count++
        }
    }
    END {
        print count + 0
    }' "$LOG_FILE")
    
    echo "$error_count"
}

# é‡å¯ PHP-FPM æœåŠ¡
restart_php_fpm() {
    echo "[$(date)] æ£€æµ‹åˆ°å¤§é‡ 502 é”™è¯¯ï¼Œé‡å¯ PHP-FPM æœåŠ¡..."
    
    # è®°å½•å½“å‰è¿›ç¨‹çŠ¶æ€
    echo "é‡å¯å‰ PHP-FPM çŠ¶æ€:" >> /var/log/auto_recovery.log
    systemctl status php8.1-fpm >> /var/log/auto_recovery.log
    
    # ä¼˜é›…é‡å¯
    systemctl reload php8.1-fpm
    
    # ç­‰å¾…æœåŠ¡ç¨³å®š
    sleep 10
    
    # éªŒè¯æœåŠ¡çŠ¶æ€
    if systemctl is-active --quiet php8.1-fpm; then
        echo "[$(date)] PHP-FPM é‡å¯æˆåŠŸ" >> /var/log/auto_recovery.log
        
        # å‘é€é€šçŸ¥
        curl -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
             -d chat_id="$TELEGRAM_CHAT_ID" \
             -d text="ğŸ”§ è‡ªåŠ¨æ¢å¤ï¼šPHP-FPM æœåŠ¡å·²é‡å¯ï¼Œ502 é”™è¯¯åº”è¯¥å¾—åˆ°ç¼“è§£"
    else
        echo "[$(date)] PHP-FPM é‡å¯å¤±è´¥" >> /var/log/auto_recovery.log
        
        # å‘é€ç´§æ€¥é€šçŸ¥
        curl -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
             -d chat_id="$TELEGRAM_CHAT_ID" \
             -d text="ğŸš¨ ç´§æ€¥ï¼šPHP-FPM è‡ªåŠ¨é‡å¯å¤±è´¥ï¼Œéœ€è¦äººå·¥ä»‹å…¥"
    fi
}

# æ¸…ç†ä¸´æ—¶æ–‡ä»¶å’Œç¼“å­˜
cleanup_temp_files() {
    echo "[$(date)] æ¸…ç†ä¸´æ—¶æ–‡ä»¶å’Œç¼“å­˜..."
    
    # æ¸…ç† PHP session æ–‡ä»¶
    find /var/lib/php/sessions -name "sess_*" -mtime +1 -delete
    
    # æ¸…ç† Nginx ä¸´æ—¶æ–‡ä»¶
    find /var/cache/nginx -type f -mtime +1 -delete
    
    # æ¸…ç†åº”ç”¨ç¼“å­˜ï¼ˆæ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ï¼‰
    if [ -d "/var/www/html/cache" ]; then
        find /var/www/html/cache -name "*.cache" -mtime +1 -delete
    fi
    
    echo "[$(date)] ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆ" >> /var/log/auto_recovery.log
}

# ä¸»ç›‘æ§å¾ªç¯
main_monitor() {
    while true; do
        local error_count=$(check_502_frequency)
        
        if [ "$error_count" -gt "$ERROR_THRESHOLD" ]; then
            echo "[$(date)] æ£€æµ‹åˆ° $error_count ä¸ª 502 é”™è¯¯ï¼Œå¯åŠ¨è‡ªåŠ¨æ¢å¤..."
            
            # æ‰§è¡Œæ¢å¤æ“ä½œ
            cleanup_temp_files
            restart_php_fpm
            
            # ç­‰å¾…æ¢å¤ç”Ÿæ•ˆ
            sleep 60
        fi
        
        # æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
        sleep 30
    done
}

# å¯åŠ¨ç›‘æ§
echo "[$(date)] å¯åŠ¨ 502 é”™è¯¯è‡ªåŠ¨æ¢å¤ç›‘æ§..."
main_monitor
```

### 6. æ€§èƒ½ä¼˜åŒ–ä¸æœ€ä½³å®è·µ

#### 6.1 ç³»ç»Ÿçº§ä¼˜åŒ–

```
#!/bin/bash
# system_optimization.sh - ç³»ç»Ÿçº§æ€§èƒ½ä¼˜åŒ–è„šæœ¬

# å†…æ ¸å‚æ•°ä¼˜åŒ–
optimize_kernel_params() {
    echo "ä¼˜åŒ–å†…æ ¸å‚æ•°..."
    
    cat >> /etc/sysctl.conf << EOF
# ç½‘ç»œè¿æ¥ä¼˜åŒ–
net.core.somaxconn = 65535
net.core.netdev_max_backlog = 5000
net.ipv4.tcp_max_syn_backlog = 65535
net.ipv4.tcp_fin_timeout = 10
net.ipv4.tcp_keepalive_time = 1200
net.ipv4.tcp_max_tw_buckets = 6000

# æ–‡ä»¶æè¿°ç¬¦é™åˆ¶
fs.file-max = 2097152
fs.nr_open = 2097152

# å†…å­˜ç®¡ç†
vm.swappiness = 10
vm.dirty_ratio = 15
vm.dirty_background_ratio = 5
EOF
    
    sysctl -p
}

# æ–‡ä»¶æè¿°ç¬¦é™åˆ¶
optimize_file_limits() {
    echo "ä¼˜åŒ–æ–‡ä»¶æè¿°ç¬¦é™åˆ¶..."
    
    cat >> /etc/security/limits.conf << EOF
* soft nofile 65535
* hard nofile 65535
* soft nproc 65535
* hard nproc 65535
nginx soft nofile 65535
nginx hard nofile 65535
www-data soft nofile 65535
www-data hard nofile 65535
EOF
}

# æ‰§è¡Œä¼˜åŒ–
optimize_kernel_params
optimize_file_limits

echo "ç³»ç»Ÿä¼˜åŒ–å®Œæˆï¼Œå»ºè®®é‡å¯ç³»ç»Ÿä½¿æ‰€æœ‰é…ç½®ç”Ÿæ•ˆ"
```

#### 6.2 æ•…éšœæ¡ˆä¾‹æ·±åº¦å¤ç›˜

"åœ¨æŠ€æœ¯çš„ä¸–ç•Œé‡Œï¼Œæ¯ä¸€æ¬¡æ•…éšœéƒ½æ˜¯æˆé•¿çš„æœºä¼šï¼Œæ¯ä¸€æ¬¡å¤ç›˜éƒ½æ˜¯æ™ºæ…§çš„ç§¯ç´¯ã€‚çœŸæ­£çš„å·¥ç¨‹å¸ˆä¸æ˜¯ä»ä¸çŠ¯é”™çš„äººï¼Œè€Œæ˜¯èƒ½ä»é”™è¯¯ä¸­å­¦ä¹ å¹¶å»ºç«‹é˜²æŠ¤æœºåˆ¶çš„äººã€‚"

**æ•…éšœèƒŒæ™¯**ï¼š  
 2023å¹´åŒ11æœŸé—´ï¼Œæˆ‘ä»¬çš„ç”µå•†å¹³å°åœ¨æµé‡é«˜å³°æ—¶æ®µï¼ˆ20:00-22:00ï¼‰å‡ºç°å¤§è§„æ¨¡ 502 é”™è¯¯ï¼Œå½±å“ç”¨æˆ·ä¸‹å•å’Œæ”¯ä»˜åŠŸèƒ½ã€‚

**æ•…éšœæ—¶é—´çº¿**ï¼š

* 19:55 - æµé‡å¼€å§‹æ¿€å¢ï¼ŒQPSä»å¹³æ—¶çš„500ä¸Šå‡åˆ°2000

* 20:03 - å¼€å§‹å‡ºç°é›¶æ˜Ÿçš„ 502 é”™è¯¯

* 20:08 - 502 é”™è¯¯ç‡è¾¾åˆ°15%ï¼Œç”¨æˆ·æŠ•è¯‰æ¿€å¢

* 20:12 - ç´§æ€¥å¯åŠ¨æ•…éšœå¤„ç†æµç¨‹

* 20:25 - é—®é¢˜å®šä½å®Œæˆï¼Œå¼€å§‹æ‰§è¡Œä¿®å¤æ–¹æ¡ˆ

* 20:35 - æœåŠ¡å®Œå…¨æ¢å¤æ­£å¸¸

**æ ¹æœ¬åŸå› åˆ†æ**ï¼š

1. **PHP-FPM è¿›ç¨‹æ± é…ç½®ä¸å½“**ï¼š`pm.max_children = 20` æ— æ³•åº”å¯¹é«˜å¹¶å‘

1. **æ•°æ®åº“è¿æ¥æ± æ³„æ¼**ï¼šåº”ç”¨ä»£ç ä¸­å­˜åœ¨æœªæ­£ç¡®å…³é—­çš„æ•°æ®åº“è¿æ¥

1. **ç¼“å­˜å¤±æ•ˆ**ï¼šRedis ç¼“å­˜åœ¨é«˜å³°æœŸå¤±æ•ˆï¼Œå¯¼è‡´å¤§é‡æ•°æ®åº“æŸ¥è¯¢

1. **è¶…æ—¶å‚æ•°ä¸åŒ¹é…**ï¼šFastCGI è¶…æ—¶æ—¶é—´çŸ­äºæ•°æ®åº“æŸ¥è¯¢æ—¶é—´

### 7. æ€»ç»“ä¸å±•æœ›

ç»è¿‡è¿™æ¬¡æ·±åº¦çš„ 502 é”™è¯¯å¤ç›˜ï¼Œæˆ‘æ·±åˆ»è®¤è¯†åˆ°è¿ç»´å·¥ä½œçš„å¤æ‚æ€§å’Œç³»ç»Ÿæ€§ã€‚ä»æœ€åˆçš„æ—¥å¿—åˆ†æï¼Œåˆ°æ·±å…¥çš„åè®®ç†è§£ï¼Œå†åˆ°ç³»ç»Ÿçº§çš„ä¼˜åŒ–é…ç½®ï¼Œæ¯ä¸€ä¸ªç¯èŠ‚éƒ½éœ€è¦æ‰å®çš„æŠ€æœ¯åŠŸåº•å’Œä¸°å¯Œçš„å®æˆ˜ç»éªŒã€‚

åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘æœ€å¤§çš„æ”¶è·æ˜¯å»ºç«‹äº†ä¸€å¥—å®Œæ•´çš„æ•…éšœå¤„ç†æ–¹æ³•è®ºï¼š**è§‚å¯Ÿ â†’ åˆ†æ â†’ å®šä½ â†’ ä¿®å¤ â†’ é¢„é˜²**ã€‚è¿™ä¸ä»…ä»…æ˜¯æŠ€æœ¯å±‚é¢çš„æå‡ï¼Œæ›´æ˜¯æ€ç»´æ–¹å¼çš„è½¬å˜ã€‚æˆ‘ä»¬ä¸èƒ½æ»¡è¶³äº"å¤´ç—›åŒ»å¤´ï¼Œè„šç—›åŒ»è„š"çš„ä¸´æ—¶ä¿®å¤ï¼Œè€Œè¦ä»ç³»ç»Ÿæ¶æ„çš„è§’åº¦æ€è€ƒé—®é¢˜çš„æ ¹æœ¬åŸå› ã€‚

FastCGI è¶…æ—¶é—®é¢˜çœ‹ä¼¼ç®€å•ï¼Œå®é™…ä¸Šæ¶‰åŠåˆ°ç½‘ç»œå±‚ã€åº”ç”¨å±‚ã€æ•°æ®åº“å±‚çš„å¤æ‚äº¤äº’ã€‚é€šè¿‡è¿™æ¬¡å¤ç›˜ï¼Œæˆ‘å»ºç«‹äº†ä»ç›‘æ§å‘Šè­¦åˆ°è‡ªåŠ¨æ¢å¤çš„å®Œæ•´ä½“ç³»ï¼Œå¤§å¤§æå‡äº†ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œå¯ç”¨æ€§ã€‚æ›´é‡è¦çš„æ˜¯ï¼Œæˆ‘å­¦ä¼šäº†å¦‚ä½•å°†æŠ€æœ¯é—®é¢˜è½¬åŒ–ä¸ºå¯é‡åŒ–çš„ä¸šåŠ¡æŒ‡æ ‡ï¼Œè®©æŠ€æœ¯ä¼˜åŒ–çœŸæ­£æœåŠ¡äºä¸šåŠ¡ç›®æ ‡ã€‚

æœªæ¥ï¼Œéšç€å¾®æœåŠ¡æ¶æ„å’Œäº‘åŸç”ŸæŠ€æœ¯çš„æ™®åŠï¼Œ502 é”™è¯¯çš„æ’æŸ¥ä¼šå˜å¾—æ›´åŠ å¤æ‚ã€‚æˆ‘ä»¬éœ€è¦æŒæ¡æ›´å¤šçš„å·¥å…·å’Œæ–¹æ³•ï¼Œæ¯”å¦‚åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªã€æœåŠ¡ç½‘æ ¼ç›‘æ§ã€å®¹å™¨åŒ–éƒ¨ç½²ç­‰ã€‚ä½†æ— è®ºæŠ€æœ¯å¦‚ä½•å‘å±•ï¼Œæ‰å®çš„åŸºç¡€çŸ¥è¯†å’Œç³»ç»Ÿæ€§çš„æ€ç»´æ–¹å¼æ°¸è¿œæ˜¯æˆ‘ä»¬æœ€å®è´µçš„è´¢å¯Œã€‚

æŠ€æœ¯çš„è·¯ä¸Šæ²¡æœ‰æ·å¾„ï¼Œåªæœ‰ä¸æ–­çš„å­¦ä¹ å’Œå®è·µã€‚æ¯ä¸€æ¬¡æ•…éšœéƒ½æ˜¯æˆé•¿çš„æœºä¼šï¼Œæ¯ä¸€æ¬¡ä¼˜åŒ–éƒ½æ˜¯èƒ½åŠ›çš„æå‡ã€‚è®©æˆ‘ä»¬åœ¨æŠ€æœ¯çš„æµ·æ´‹ä¸­ç»§ç»­æ¢ç´¢ï¼Œåœ¨ä»£ç çš„ä¸–ç•Œé‡Œè¿½æ±‚å“è¶Šï¼Œç”¨æˆ‘ä»¬çš„ä¸“ä¸šèƒ½åŠ›ä¸ºç”¨æˆ·åˆ›é€ æ›´å¥½çš„ä½“éªŒï¼Œä¸ºä¸šåŠ¡åˆ›é€ æ›´å¤§çš„ä»·å€¼ã€‚

---

> æˆ‘æ˜¯æ‘˜æ˜Ÿï¼å¦‚æœè¿™ç¯‡æ–‡ç« åœ¨ä½ çš„æŠ€æœ¯æˆé•¿è·¯ä¸Šç•™ä¸‹äº†å°è®°  
>  ğŸ‘ï¸ ã€å…³æ³¨ã€‘ä¸æˆ‘ä¸€èµ·æ¢ç´¢æŠ€æœ¯çš„æ— é™å¯èƒ½ï¼Œè§è¯æ¯ä¸€æ¬¡çªç ´  
>  ğŸ‘ ã€ç‚¹èµã€‘ä¸ºä¼˜è´¨æŠ€æœ¯å†…å®¹ç‚¹äº®æ˜ç¯ï¼Œä¼ é€’çŸ¥è¯†çš„åŠ›é‡  
>  ğŸ”– ã€æ”¶è—ã€‘å°†ç²¾åå†…å®¹çè—ï¼Œéšæ—¶å›é¡¾æŠ€æœ¯è¦ç‚¹  
>  ğŸ’¬ ã€è¯„è®ºã€‘åˆ†äº«ä½ çš„ç‹¬ç‰¹è§è§£ï¼Œè®©æ€ç»´ç¢°æ’å‡ºæ™ºæ…§ç«èŠ±  
>  ğŸ—³ï¸ ã€æŠ•ç¥¨ã€‘ç”¨ä½ çš„é€‰æ‹©ä¸ºæŠ€æœ¯ç¤¾åŒºè´¡çŒ®ä¸€ä»½åŠ›é‡  
>  æŠ€æœ¯è·¯æ¼«æ¼«ï¼Œè®©æˆ‘ä»¬æºæ‰‹å‰è¡Œï¼Œåœ¨ä»£ç çš„ä¸–ç•Œé‡Œæ‘˜å–å±äºç¨‹åºå‘˜çš„é‚£ç‰‡æ˜Ÿè¾°å¤§æµ·ï¼

### å‚è€ƒé“¾æ¥

1. [Nginxå®˜æ–¹æ–‡æ¡£ - upstreamæ¨¡å—](https://nginx.org/en/docs/http/ngx_http_upstream_module.html "Nginxå®˜æ–¹æ–‡æ¡£ - upstreamæ¨¡å—")

1. [PHP-FPMé…ç½®è¯¦è§£](https://www.php.net/manual/en/install.fpm.configuration.php "PHP-FPMé…ç½®è¯¦è§£")

1. [FastCGIåè®®è§„èŒƒ](https://fastcgi-archives.github.io/FastCGI_Specification.html "FastCGIåè®®è§„èŒƒ")

1. [Prometheusç›‘æ§æœ€ä½³å®è·µ](https://prometheus.io/docs/practices/naming/ "Prometheusç›‘æ§æœ€ä½³å®è·µ")

1. [Linuxç³»ç»Ÿæ€§èƒ½è°ƒä¼˜æŒ‡å—](https://www.kernel.org/doc/Documentation/sysctl/vm.txt "Linuxç³»ç»Ÿæ€§èƒ½è°ƒä¼˜æŒ‡å—")

### å…³é”®è¯æ ‡ç­¾

`#Nginx` `#502é”™è¯¯` `#FastCGI` `#PHP-FPM` `#æ€§èƒ½ä¼˜åŒ–`



