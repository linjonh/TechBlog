---
layout: post
title: "Node-使用-SSE-结合redis-推送数据echarts-图表实时更新"
date: 2025-03-11 14:59:13 +0800
description: "创建// 可以添加更多类型的统计查询。"
keywords: "Node 使用 SSE 结合redis 推送数据(echarts 图表实时更新)"
categories: ['Node']
tags: ['数据库', 'Redis', 'Echarts']
artid: "146097142"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146097142
    alt: "Node-使用-SSE-结合redis-推送数据echarts-图表实时更新"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146097142
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146097142
cover: https://bing.ee123.net/img/rand?artid=146097142
image: https://bing.ee123.net/img/rand?artid=146097142
img: https://bing.ee123.net/img/rand?artid=146097142
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Node 使用 SSE 结合redis 推送数据(echarts 图表实时更新)
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-tomorrow-night" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="1_0">
     </a>
     1、实时通信有哪些实现方式？
    </h2>
    <table>
     <thead>
      <tr>
       <th>
        <strong>
         特性
        </strong>
       </th>
       <th>
        <strong>
         轮询（Polling）
        </strong>
       </th>
       <th>
        <strong>
         WebSocket
        </strong>
       </th>
       <th>
        <strong>
         SSE (Server-Sent Events)
        </strong>
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        <strong>
         通信方向
        </strong>
       </td>
       <td>
        单向（客户端 → 服务端）
       </td>
       <td>
        双向（客户端 ↔ 服务端）
       </td>
       <td>
        单向（服务端 → 客户端）
       </td>
      </tr>
      <tr>
       <td>
        <strong>
         连接方式
        </strong>
       </td>
       <td>
        客户端定时发起HTTP请求
       </td>
       <td>
        持久连接（基于TCP协议）
       </td>
       <td>
        持久连接（基于HTTP协议）
       </td>
      </tr>
      <tr>
       <td>
        <strong>
         实现复杂度
        </strong>
       </td>
       <td>
        简单
       </td>
       <td>
        较复杂（需处理握手、协议转换等）
       </td>
       <td>
        简单
       </td>
      </tr>
      <tr>
       <td>
        <strong>
         实时性
        </strong>
       </td>
       <td>
        低（依赖轮询间隔）
       </td>
       <td>
        高（支持实时双向通信）
       </td>
       <td>
        高（服务端实时推送）
       </td>
      </tr>
      <tr>
       <td>
        <strong>
         性能开销
        </strong>
       </td>
       <td>
        高（频繁建立/关闭连接）
       </td>
       <td>
        低（单个持久连接）
       </td>
       <td>
        低（单个持久连接）
       </td>
      </tr>
      <tr>
       <td>
        <strong>
         示例场景
        </strong>
       </td>
       <td>
        定时获取天气、股票数据
       </td>
       <td>
        在线聊天、多人游戏、实时协作
       </td>
       <td>
        新闻推送、通知、实时股票行情
       </td>
      </tr>
     </tbody>
    </table>
    <ul>
     <li>
      <strong>
       轮询
      </strong>
      ：开发简单，但是效率太低了，适合对实时性要求不高的场景。在项目中，基本是不推荐使用，这种做法比较 low。
     </li>
     <li>
      <strong>
       WebSocket
      </strong>
      ：开发起来较为复杂。性能好，可以双向实时通信，适合需要交互的场景。推荐使用 Socket.IO 包来开发。
     </li>
     <li>
      <strong>
       SSE
      </strong>
      ：开发简单。性能好，但只能单向实时通信，适合服务端向客户端主动推送数据的场景。
     </li>
    </ul>
    <p>
     另外值得一提的是，现在各个
     <code>
      AI 平台的消息推送
     </code>
     ，也都是使用
     <code>
      SSE
     </code>
     来实现的。
    </p>
    <h2>
     <a id="2SSE__16">
     </a>
     2、SSE 的基础实现
    </h2>
    <pre><code class="prism language-js"><span class="token comment">// 设置正确的响应头</span>
res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'text/event-stream'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Cache-Control'</span><span class="token punctuation">,</span> <span class="token string">'no-cache'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Connection'</span><span class="token punctuation">,</span> <span class="token string">'keep-alive'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 定时发送数据</span>
 <span class="token keyword">const</span> intervalId <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">当前时间是 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLocaleTimeString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">data: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 处理客户端断开连接</span>
req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'close'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token function">clearInterval</span><span class="token punctuation">(</span>intervalId<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 清除定时器</span>
  res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 结束响应</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre>
    <ul>
     <li>
      想要用
      <code>
       SSE来推送数据
      </code>
      ，
      <code>
       顶部
      </code>
      要按照这个格式来
      <code>
       设置响应头
      </code>
      ，明确指明为
      <code>
       event-stream
      </code>
      。这样才能被识别成SSE。
     </li>
     <li>
      <code>
       中间
      </code>
      部分，简单的写了一个
      <code>
       定时执行
      </code>
      。每隔两秒钟，计算一下当前的时间。
     </li>
     <li>
      然后注意了，这里用的是
      <code>
       res.write
      </code>
      ，这是实现
      <code>
       SSE的关键代码
      </code>
      。使用
      <code>
       res.write可以不断的，分多次发送数据，而不需要一次性发送完整的响应
      </code>
      。
     </li>
     <li>
      还有要注意的是，我们这里
      <code>
       发送数据的格式
      </code>
      ，按照
      <code>
       SSE的规则
      </code>
      ，必须是
      <code>
       以data:开头，以两个\n结束
      </code>
      。\n是换行的意思。
     </li>
     <li>
      最下面，如果
      <code>
       连接断开了
      </code>
      ，就
      <code>
       停止定时器
      </code>
      ，并
      <code>
       结束响应
      </code>
      。
     </li>
    </ul>
    <h2>
     <a id="3_44">
     </a>
     3、前端部分实现
    </h2>
    <p>
     <code>
      SSE默认不支持在header中传递数据
     </code>
     ，那就直接在URL里传token好了
    </p>
    <pre><code class="prism language-js"><span class="token comment">// 定义管理员令牌，用于身份验证，在实际使用时需将 'xxxx' 替换为真实有效的令牌</span>
<span class="token keyword">const</span> token <span class="token operator">=</span> <span class="token string">'xxxx'</span><span class="token punctuation">;</span>

<span class="token comment">// 创建一个 EventSource 对象，用于建立与服务器的 SSE 连接</span>
<span class="token comment">// 这里使用模板字符串将 token 拼接到请求的 URL 中，该 URL 指向服务器上处理订单流数据的接口</span>
<span class="token keyword">const</span> eventSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventSource</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">http://localhost:3000/admin/charts/stream_order?token=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span> token <span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 当服务器向客户端发送消息时，会触发 onmessage 事件</span>
eventSource<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 使用 try...catch 块来捕获可能出现的异常，例如数据解析失败的情况</span>
  <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 服务器发送的数据存储在 event.data 中，通常是 JSON 格式的字符串</span>
    <span class="token comment">// 使用 JSON.parse 方法将其解析为 JavaScript 对象</span>
    <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 将解析后的数据打印到控制台，方便调试和查看</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 如果解析数据过程中出现错误，将错误信息打印到控制台</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'解析数据出错:'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 当 SSE 连接出现错误时，会触发 onerror 事件</span>
eventSource<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 将连接错误信息打印到控制台，方便调试和排查问题</span>
  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'SSE 连接出错:'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <h2>
     <a id="4_79">
     </a>
     4、测试
    </h2>
    <p>
     <code>
      检查
     </code>
     ，
     <code>
      选择网络
     </code>
     。然后
     <code>
      刷新一下
     </code>
     ，就能看到
     <code>
      发出的请求
     </code>
     了
     <br/>
     <code>
      注意
     </code>
     ：请求的状态是
     <code>
      pending
     </code>
     ，等待
     <code>
      2 秒钟
     </code>
     后，状态变为
     <code>
      200
     </code>
     的时候我们再点进去。这是因为如
     <code>
      果点早了
     </code>
     ，
     <code>
      浏览器还没有将它识别成SSE
     </code>
     。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/d12dd7994aeb4d7bbcd72bb7d5ca9dac.png">
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/d3933a5657e44d08a45e6d7b96e9d5c5.png">
       <br/>
       <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/cdab725b5d914ad0acffe0288658bae7.png"/>
      </img>
     </img>
    </p>
    <h2>
     <a id="5_SSE__87">
     </a>
     5、 SSE 小结
    </h2>
    <ul>
     <li>
      在
      <code>
       Node
      </code>
      部分，
      <code>
       设置好响应头
      </code>
      ，并用
      <code>
       res.write
      </code>
      不断的发数据出去就好。
     </li>
     <li>
      <code>
       前端
      </code>
      部分，用
      <code>
       new EventSource
      </code>
      建立连接。并通过
      <code>
       onmessage
      </code>
      事件，来接收数据。
     </li>
    </ul>
    <h2>
     <a id="6_92">
     </a>
     6、实践
    </h2>
    <p>
     <a href="https://blog.csdn.net/IT_iosers/article/details/145324391?spm=1001.2014.3001.5502">
      redis 封装
     </a>
    </p>
    <h3>
     <a id="61_94">
     </a>
     6.1、后端代码实现
    </h3>
    <h4>
     <a id="611_SSE__95">
     </a>
     6.1.1、新建 SSE 处理工具类
    </h4>
    <p>
     在
     <code>
      根目录
     </code>
     新建
     <code>
      streams
     </code>
     文件夹，里面再新建一个
     <code>
      sse-handler.js
     </code>
     ，用于处理服务器发送事件（Server-Sent Events, SSE）的工具类，代码如下：
    </p>
    <pre><code class="prism language-js"><span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span>setKey<span class="token punctuation">,</span> getKey<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../utils/redis'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 定义一个名为 SSEHandler 的类，用于处理服务器发送事件（SSE）的连接和数据广播</span>
<span class="token keyword">class</span> <span class="token class-name">SSEHandler</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 构造函数，在创建 SSEHandler 实例时会自动调用</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 使用 ES6 的 Set 数据结构来存储与浏览器建立 SSE 连接的响应对象（res）</span>
    <span class="token comment">// Set 可以确保存储的元素唯一，避免重复</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>clients <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 初始化 SSE 数据流，处理新的客户端连接
   * @param {Object} res - Express 响应对象，用于向客户端发送数据
   * @param {Object} req - Express 请求对象，包含客户端的请求信息
   */</span>
  <span class="token function">initStream</span><span class="token punctuation">(</span><span class="token parameter">res<span class="token punctuation">,</span> req</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 设置响应头，指定响应内容类型为 text/event-stream，这是 SSE 的标准内容类型</span>
    res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'text/event-stream'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 设置缓存控制，禁止浏览器缓存响应内容，确保每次请求都能获取最新数据</span>
    res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Cache-Control'</span><span class="token punctuation">,</span> <span class="token string">'no-cache'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 设置连接类型为 keep-alive，保持与客户端的长连接</span>
    res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Connection'</span><span class="token punctuation">,</span> <span class="token string">'keep-alive'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 刷新响应头，将设置的响应头信息发送给客户端</span>
    res<span class="token punctuation">.</span><span class="token function">flushHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 将当前客户端的响应对象添加到 clients 集合中，以便后续广播数据时使用</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>clients<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 监听客户端连接关闭事件，当客户端断开连接时触发回调函数</span>
    req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'close'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 从 clients 集合中删除当前客户端的响应对象</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>clients<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 打印日志，提示客户端已断开连接</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Client disconnected'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 向所有连接的客户端广播数据
   * @param {Object} data - 要广播的数据对象，会被序列化为 JSON 字符串发送给客户端
   */</span>
 <span class="token keyword">async</span> <span class="token function">broadcastData</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">await</span> <span class="token function">setKey</span><span class="token punctuation">(</span><span class="token string">'sse_broadcast_data'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 遍历 clients 集合中的每个客户端响应对象</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>clients<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">client</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 检查客户端响应是否已经结束，如果未结束则继续发送数据</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>client<span class="token punctuation">.</span>finished<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 按照 SSE 的格式，以 "data: " 开头，后面跟上 JSON 序列化后的数据，以两个换行符 "\n\n" 结尾</span>
        <span class="token comment">// 并将其写入客户端响应流，发送给客户端</span>
        client<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">data: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 将 SSEHandler 类导出，以便其他模块可以引入和使用</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> SSEHandler<span class="token punctuation">;</span>
</code></pre>
    <h4>
     <a id="612_SQL__159">
     </a>
     6.1.2、定义和管理统计查询的 SQL 语句·
    </h4>
    <p>
     创建
     <code>
      utils/stats-query.js
     </code>
     文件，用于定义和管理统计查询的 SQL 语句：
    </p>
    <pre><code class="prism language-js"><span class="token keyword">const</span> statsQueries <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">order</span><span class="token operator">:</span> <span class="token string">"SELECT DATE_FORMAT(`createdAt`, '%Y-%m') AS `month`, COUNT(*) AS `value` FROM `Orders` GROUP BY `month` ORDER BY `month` ASC"</span><span class="token punctuation">,</span>
  <span class="token literal-property property">user</span><span class="token operator">:</span> <span class="token string">"SELECT DATE_FORMAT(`createdAt`, '%Y-%m') AS `month`, COUNT(*) AS `value` FROM `Users` GROUP BY `month` ORDER BY `month` ASC"</span><span class="token punctuation">,</span>
  <span class="token comment">// 可以添加更多类型的统计查询</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">getStatsQuery</span><span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> statsQueries<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
  getStatsQuery
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <h4>
     <a id="613__176">
     </a>
     6.1.3、 广播服务的实现
    </h4>
    <p>
     创建
     <code>
      utils/broadcast-service.js
     </code>
     文件，实现广播服务：
    </p>
    <pre><code class="prism language-js"><span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span>sequelize<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../models'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> SSEHandler <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../streams/sse-handler'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 直接在 broadcast-service.js 中定义统计查询配置</span>
<span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span>getStatsQuery<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./stats-query'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 存储不同类型的 SSE 处理程序</span>
<span class="token keyword">const</span> sseHandlers <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">broadcastStats</span><span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getStatsQuery</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Invalid stats type: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sseHandlers<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      sseHandlers<span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SSEHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> <span class="token punctuation">[</span>results<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">await</span> sequelize<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token function">getStatsQuery</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">months</span><span class="token operator">:</span> results<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span>month<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token literal-property property">values</span><span class="token operator">:</span> results<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    sseHandlers<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">broadcastData</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> stats broadcasted successfully</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Error broadcasting </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> stats:</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">initSSEStream</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> res<span class="token punctuation">,</span> req</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getStatsQuery</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Invalid stats type: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sseHandlers<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    sseHandlers<span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SSEHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  sseHandlers<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">initStream</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> req<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
  broadcastStats<span class="token punctuation">,</span>
  initSSEStream
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <h4>
     <a id="614_chartsjs__ECharts__227">
     </a>
     6.1.4、新建
     <code>
      charts.js
     </code>
     文件实现
     <code>
      ECharts
     </code>
     路由（仅展示关键代码）
    </h4>
    <p>
     在这一部分，我们将创建一个 charts.js 文件，用于实现与 ECharts 相关的路由功能。该文件主要负责处理不同类型的统计数据请求，并利用 Redis 进行数据缓存，同时支持通过 SSE（Server-Sent Events）进行实时数据推送。
    </p>
    <pre><code class="prism language-js"><span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span>getStatsQuery<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../../utils/stats-query'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span>initSSEStream<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../../utils/broadcast-service'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span>getKey<span class="token punctuation">,</span> setKey<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../../utils/redis'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 获取统计数据的通用路由</span>
<span class="token comment">// 此路由根据请求参数中的 type 来获取相应的统计数据</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/:type'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 从请求参数中获取统计数据的类型</span>
  <span class="token keyword">const</span> type <span class="token operator">=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>type<span class="token punctuation">;</span>

  <span class="token comment">// 根据类型获取对应的统计查询语句</span>
  <span class="token keyword">const</span> query <span class="token operator">=</span> <span class="token function">getStatsQuery</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 如果未找到对应的查询语句，返回错误信息</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>query<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">failure</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Invalid stats type'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 首先尝试从 Redis 中获取缓存的数据</span>
    <span class="token keyword">let</span> cachedData <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getKey</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">stats_data_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果 Redis 中存在缓存数据，直接返回该数据</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cachedData<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token function">success</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> <span class="token string">'Stats data fetched successfully'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token literal-property property">data</span><span class="token operator">:</span> cachedData<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 若 Redis 中没有缓存数据，执行数据库查询</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>results<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">await</span> sequelize<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 对查询结果进行处理，将月份和对应的值分别提取出来</span>
    <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">months</span><span class="token operator">:</span> results<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span>month<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token literal-property property">values</span><span class="token operator">:</span> results<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// 将处理后的数据存储到 Redis 中，以便后续请求可以直接使用缓存数据</span>
    <span class="token keyword">await</span> <span class="token function">setKey</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">stats_data_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 返回查询成功的响应，并将数据发送给客户端</span>
    <span class="token function">success</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> <span class="token string">'Stats data fetched successfully'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>data<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 若出现错误，返回错误响应</span>
    <span class="token function">failure</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * SSE 统计不同类型数据
 * GET /admin/charts/stream/:type
 * 此路由用于处理 SSE 连接，实时推送不同类型的统计数据
 */</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/stream/:type'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 从请求参数中获取统计数据的类型</span>
  <span class="token keyword">const</span> type <span class="token operator">=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>type<span class="token punctuation">;</span>

  <span class="token comment">// 初始化 SSE 数据流，开始向客户端推送数据</span>
  <span class="token function">initSSEStream</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> res<span class="token punctuation">,</span> req<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <h4>
     <a id="615_redis_289">
     </a>
     6.1.5、表单
     <code>
      新增数据
     </code>
     时
     <code>
      删除redis缓存
     </code>
    </h4>
    <p>
     以
     <code>
      order
     </code>
     为例
    </p>
    <pre><code class="prism language-js"><span class="token comment">// 定义一个处理 POST 请求的路由，路径为根路径（'/'）</span>
<span class="token comment">// 当客户端向该路径发送 POST 请求时，此中间件函数会被调用</span>
<span class="token comment">// req 表示请求对象，包含客户端发送的请求信息</span>
<span class="token comment">// res 表示响应对象，用于向客户端发送响应</span>
<span class="token comment">// next 是 Express 中的中间件函数，用于将控制权传递给下一个中间件</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 生成一个唯一的订单号</span>
        <span class="token comment">// 使用 uuidv4 函数生成一个通用唯一识别码（UUID）</span>
        <span class="token comment">// 然后使用 replace 方法将 UUID 中的连字符（-）替换为空字符串，得到一个无连字符的订单号</span>
        <span class="token keyword">const</span> outTradeNo <span class="token operator">=</span> <span class="token function">uuidv4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">-</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 调用 getMembership 函数，根据请求对象 req 获取会员信息</span>
        <span class="token comment">// 这个函数可能会从数据库、缓存或其他数据源中获取与当前请求相关的会员信息</span>
        <span class="token keyword">const</span> membership <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getMembership</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 使用 Sequelize 的 create 方法创建一个新的订单记录</span>
        <span class="token comment">// 传入一个包含订单信息的对象，这些信息将被插入到数据库的 Order 表中</span>
        <span class="token keyword">const</span> order <span class="token operator">=</span> <span class="token keyword">await</span> Order<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 订单号，使用前面生成的唯一订单号</span>
            <span class="token literal-property property">outTradeNo</span><span class="token operator">:</span> outTradeNo<span class="token punctuation">,</span>
            <span class="token comment">// 用户 ID，从请求对象中获取当前用户的 ID</span>
            <span class="token literal-property property">userId</span><span class="token operator">:</span> req<span class="token punctuation">.</span>userId<span class="token punctuation">,</span>
            <span class="token comment">// 订单主题，使用会员的名称</span>
            <span class="token literal-property property">subject</span><span class="token operator">:</span> membership<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
            <span class="token comment">// 会员时长（月），从会员信息中获取会员的持续月数</span>
            <span class="token literal-property property">membershipMonths</span><span class="token operator">:</span> membership<span class="token punctuation">.</span>durationMonths<span class="token punctuation">,</span>
            <span class="token comment">// 订单总金额，使用会员的价格</span>
            <span class="token literal-property property">totalAmount</span><span class="token operator">:</span> membership<span class="token punctuation">.</span>price<span class="token punctuation">,</span>
            <span class="token comment">// 订单状态，初始状态设为 0，通常表示待支付</span>
            <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 删除 Redis 中存储的订单统计数据缓存</span>
        <span class="token comment">// 当有新订单创建时，之前的统计数据可能不再准确，所以需要删除缓存</span>
        <span class="token comment">// 后续请求统计数据时会重新从数据库获取最新数据</span>
        <span class="token keyword">await</span> <span class="token function">delKey</span><span class="token punctuation">(</span><span class="token string">'stats_data_order'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 调用广播服务，将订单统计数据的更新广播出去</span>
        <span class="token comment">// 这可能会触发前端页面或其他相关服务更新订单统计信息</span>
        <span class="token keyword">await</span> <span class="token function">broadcastStats</span><span class="token punctuation">(</span><span class="token string">'order'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 调用 success 函数，向客户端发送成功响应</span>
        <span class="token comment">// 第一个参数是响应对象 res，用于发送响应</span>
        <span class="token comment">// 第二个参数是成功消息，告知客户端订单创建成功</span>
        <span class="token comment">// 第三个参数是包含订单信息的对象，客户端可以使用这些信息进行后续处理</span>
        <span class="token function">success</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> <span class="token string">'订单创建成功。'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> order <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 如果在订单创建过程中出现错误，调用 failure 函数向客户端发送错误响应</span>
        <span class="token comment">// 第一个参数是响应对象 res，用于发送响应</span>
        <span class="token comment">// 第二个参数是捕获到的错误对象，客户端可以根据错误信息进行相应处理</span>
        <span class="token function">failure</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <h3>
     <a id="62_348">
     </a>
     6.2、前端代码实现
    </h3>
    <h4>
     <a id="621charts_349">
     </a>
     6.2.1、前端
     <code>
      charts
     </code>
     封装
    </h4>
    <p>
     在前端开发中，为了高效管理 ECharts 图表，我们封装了 ChartManager 类，它能处理图表的初始化、数据获取、SSE 连接以及错误处理等操作。以下是详细的代码及说明：
    </p>
    <pre><code class="prism language-js"><span class="token comment">// 配置对象，可根据实际情况灵活修改，用于存储与图表管理相关的配置信息</span>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// API 请求的基础 URL，用于获取图表数据和建立 SSE 连接</span>
    <span class="token constant">API_BASE_URL</span><span class="token operator">:</span> <span class="token string">'http://localhost:3000'</span><span class="token punctuation">,</span>
    <span class="token comment">// 最大重试次数，当 SSE 连接失败时会进行重试，达到该次数后停止重试</span>
    <span class="token constant">MAX_RETRIES</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
    <span class="token comment">// 重试延迟时间（毫秒），每次重试之间的间隔时长</span>
    <span class="token constant">RETRY_DELAY</span><span class="token operator">:</span> <span class="token number">3000</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * ChartManager 类，负责管理 ECharts 图表的初始化、数据获取、SSE 连接以及错误处理等功能
 */</span>
<span class="token keyword">class</span> <span class="token class-name">ChartManager</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/**
     * 构造函数，用于初始化图表管理器的基本属性
     * @param {string} chartId - 图表容器的 ID，用于查找对应的 DOM 元素
     * @param {string} type - 图表类型，例如 'order' 或 'user'，决定获取数据的接口路径
     * @param {string} token - 用于身份验证的令牌，在请求数据时使用
     * @param {Object} [option={}] - 可选的 ECharts 配置选项，用于自定义图表样式
     */</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">chartId<span class="token punctuation">,</span> type<span class="token punctuation">,</span> token<span class="token punctuation">,</span> option <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>chartId <span class="token operator">=</span> chartId<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> type<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>token <span class="token operator">=</span> token<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>chart <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>initialDataFetched <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>sseSource <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>retryCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>maxRetries <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token constant">MAX_RETRIES</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>retryDelay <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token constant">RETRY_DELAY</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>option <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token literal-property property">text</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">月度</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>type <span class="token operator">===</span> <span class="token string">'order'</span> <span class="token operator">?</span> <span class="token string">'订单'</span> <span class="token operator">:</span> <span class="token string">'用户'</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">统计</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
                <span class="token literal-property property">textStyle</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token string">'#333'</span> <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token literal-property property">tooltip</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token literal-property property">trigger</span><span class="token operator">:</span> <span class="token string">'axis'</span><span class="token punctuation">,</span>
                <span class="token literal-property property">axisPointer</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'shadow'</span> <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token literal-property property">grid</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token literal-property property">left</span><span class="token operator">:</span> <span class="token string">'3%'</span><span class="token punctuation">,</span>
                <span class="token literal-property property">right</span><span class="token operator">:</span> <span class="token string">'4%'</span><span class="token punctuation">,</span>
                <span class="token literal-property property">bottom</span><span class="token operator">:</span> <span class="token string">'3%'</span><span class="token punctuation">,</span>
                <span class="token literal-property property">containLabel</span><span class="token operator">:</span> <span class="token boolean">true</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token literal-property property">xAxis</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'category'</span><span class="token punctuation">,</span>
                <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token literal-property property">axisTick</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">alignWithLabel</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token literal-property property">yAxis</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'value'</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token literal-property property">series</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span>
                <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'数量'</span><span class="token punctuation">,</span>
                <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'bar'</span><span class="token punctuation">,</span>
                <span class="token literal-property property">barWidth</span><span class="token operator">:</span> <span class="token string">'60%'</span><span class="token punctuation">,</span>
                <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token operator">...</span>option
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 初始化图表，包含创建 ECharts 实例、获取初始数据以及建立 SSE 连接等操作
     */</span>
    <span class="token keyword">async</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">const</span> chartDom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>chartId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>chartDom<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">未找到指定 ID 的图表容器：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token keyword">this</span><span class="token punctuation">.</span>chartId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>chart <span class="token operator">=</span> echarts<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>chartDom<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>chart<span class="token punctuation">.</span><span class="token function">setOption</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>option<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fetchInitialData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">connectSSE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">图表 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token keyword">this</span><span class="token punctuation">.</span>chartId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 初始化失败：</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">showError</span><span class="token punctuation">(</span><span class="token string">'图表初始化失败，请尝试刷新页面重试'</span><span class="token punctuation">,</span> error<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 异步获取初始数据
     */</span>
    <span class="token keyword">async</span> <span class="token function">fetchInitialData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>config<span class="token punctuation">.</span><span class="token constant">API_BASE_URL</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/admin/charts/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token keyword">this</span><span class="token punctuation">.</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?token=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token keyword">this</span><span class="token punctuation">.</span>token<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fetchData</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> data <span class="token punctuation">}</span> <span class="token operator">=</span> response<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>data<span class="token punctuation">.</span>months<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">showError</span><span class="token punctuation">(</span><span class="token string">'当前暂无数据，10 秒后将尝试重新获取'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fetchInitialData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>data<span class="token punctuation">.</span>months<span class="token punctuation">.</span>length<span class="token operator">!==</span> data<span class="token punctuation">.</span>data<span class="token punctuation">.</span>values<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">showError</span><span class="token punctuation">(</span><span class="token string">'数据格式存在错误：月份和数量数组长度不匹配'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">this</span><span class="token punctuation">.</span>option<span class="token punctuation">.</span>xAxis<span class="token punctuation">.</span>data <span class="token operator">=</span> data<span class="token punctuation">.</span>data<span class="token punctuation">.</span>months<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>option<span class="token punctuation">.</span>series<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>data <span class="token operator">=</span> data<span class="token punctuation">.</span>data<span class="token punctuation">.</span>values<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>initialDataFetched <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>chart<span class="token punctuation">.</span><span class="token function">setOption</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>option<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">showError</span><span class="token punctuation">(</span><span class="token string">'数据加载失败，5 秒后将尝试重新加载'</span><span class="token punctuation">,</span> error<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fetchInitialData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 建立 SSE 连接，实时监听服务器发送的数据
     */</span>
    <span class="token function">connectSSE</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sseSource <span class="token operator">&amp;&amp;</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>sseSource<span class="token punctuation">.</span>closed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>sseSource<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>config<span class="token punctuation">.</span><span class="token constant">API_BASE_URL</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/admin/charts/stream/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token keyword">this</span><span class="token punctuation">.</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?token=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token keyword">this</span><span class="token punctuation">.</span>token<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>sseSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventSource</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>sseSource<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">const</span> responseData <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">const</span> data <span class="token operator">=</span> responseData<span class="token punctuation">.</span>data <span class="token operator">||</span> responseData<span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>data <span class="token operator">||</span><span class="token operator">!</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>months<span class="token punctuation">)</span> <span class="token operator">||</span><span class="token operator">!</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>values<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">showError</span><span class="token punctuation">(</span><span class="token string">'SSE 返回的数据格式有误，请检查后端接口'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>months<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">showError</span><span class="token punctuation">(</span><span class="token string">'暂无数据，请创建订单后再进行查看'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>months<span class="token punctuation">.</span>length<span class="token operator">!==</span> data<span class="token punctuation">.</span>values<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">showError</span><span class="token punctuation">(</span><span class="token string">'SSE 数据格式错误：月份和数量数组长度不匹配'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">this</span><span class="token punctuation">.</span>option<span class="token punctuation">.</span>xAxis<span class="token punctuation">.</span>data <span class="token operator">=</span> data<span class="token punctuation">.</span>months<span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>option<span class="token punctuation">.</span>series<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>data <span class="token operator">=</span> data<span class="token punctuation">.</span>values<span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>chart<span class="token punctuation">.</span><span class="token function">setOption</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>option<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>parseError<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'解析 SSE 数据时出现错误：'</span><span class="token punctuation">,</span> parseError<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">showError</span><span class="token punctuation">(</span><span class="token string">'实时数据解析失败，请检查网络连接或尝试刷新页面'</span><span class="token punctuation">,</span> parseError<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>sseSource<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
            console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'SSE 连接出现错误：'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">showError</span><span class="token punctuation">(</span><span class="token string">'实时数据连接中断，正在尝试重新连接...'</span><span class="token punctuation">,</span> error<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleSseError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 处理 SSE 连接错误，执行重试操作
     */</span>
    <span class="token function">handleSseError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>retryCount<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>retryCount <span class="token operator">&lt;=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>maxRetries<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">connectSSE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>retryDelay<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">showError</span><span class="token punctuation">(</span><span class="token string">'重连失败，请手动刷新页面'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>retryCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 发起网络请求获取数据
     * @param {string} url - 请求的 URL
     * @returns {Promise&lt;Object&gt;} - 返回解析后的 JSON 数据
     */</span>
    <span class="token keyword">async</span> <span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>response<span class="token punctuation">.</span>ok<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">HTTP 请求失败，状态码：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>response<span class="token punctuation">.</span>status<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">const</span> contentType <span class="token operator">=</span> response<span class="token punctuation">.</span>headers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>contentType <span class="token operator">||</span><span class="token operator">!</span>contentType<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'application/json'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'响应数据并非 JSON 格式'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">showError</span><span class="token punctuation">(</span><span class="token string">'网络请求出现问题'</span><span class="token punctuation">,</span> error<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> error<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 显示错误信息并更新图表标题
     * @param {string} message - 错误消息内容
     * @param {string} [errorCode=null] - 可选的错误代码
     */</span>
    <span class="token function">showError</span><span class="token punctuation">(</span><span class="token parameter">message<span class="token punctuation">,</span> errorCode <span class="token operator">=</span> <span class="token keyword">null</span></span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">const</span> errorDiv <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        errorDiv<span class="token punctuation">.</span>className <span class="token operator">=</span> <span class="token string">'error-message'</span><span class="token punctuation">;</span>
        errorDiv<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
            </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
            </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>errorCode<span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;small&gt;错误码: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>errorCode<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/small&gt;</span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token string">''</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
            &lt;button onclick="this.parentElement.remove()"&gt;关闭&lt;/button&gt;
        </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
        document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">prepend</span><span class="token punctuation">(</span>errorDiv<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>option<span class="token punctuation">.</span>series<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>chart<span class="token punctuation">.</span><span class="token function">setOption</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>option<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 销毁图表和 SSE 连接，释放相关资源
     */</span>
    <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>chart<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>chart<span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>chart <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sseSource <span class="token operator">&amp;&amp;</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>sseSource<span class="token punctuation">.</span>closed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>sseSource<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 将 ChartManager 类暴露到全局作用域，方便在其他地方使用</span>
window<span class="token punctuation">.</span>ChartManager <span class="token operator">=</span> ChartManager<span class="token punctuation">;</span>
</code></pre>
    <h4>
     <a id="621demo_583">
     </a>
     6.2.1、前端
     <code>
      demo
     </code>
     实现
    </h4>
    <p>
     面是一个前端示例，展示了如何使用 ChartManager 类创建实时统计图表：
    </p>
    <pre><code class="prism language-js"><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token constant">DOCTYPE</span> html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>html lang<span class="token operator">=</span><span class="token string">"zh-CN"</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>head<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>meta charset<span class="token operator">=</span><span class="token string">"UTF-8"</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 让页面在移动设备上能正确显示 <span class="token operator">--</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>meta name<span class="token operator">=</span><span class="token string">"viewport"</span> content<span class="token operator">=</span><span class="token string">"width=device-width, initial-scale=1.0"</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>实时统计图表<span class="token operator">&lt;</span><span class="token operator">/</span>title<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 引入 ECharts 库，用于创建各种类型的图表 <span class="token operator">--</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">"https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 引入自定义的图表管理脚本，包含 ChartManager 类等逻辑 <span class="token operator">--</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">"charts.js"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>style<span class="token operator">&gt;</span>
    body <span class="token punctuation">{<!-- --></span>
      <span class="token comment">/* 设置页面整体字体为 Arial 无衬线字体 */</span>
      font<span class="token operator">-</span>family<span class="token operator">:</span> Arial<span class="token punctuation">,</span> sans<span class="token operator">-</span>serif<span class="token punctuation">;</span>
      <span class="token comment">/* 使用 Flexbox 布局，让内容水平和垂直居中 */</span>
      <span class="token literal-property property">display</span><span class="token operator">:</span> flex<span class="token punctuation">;</span>
      justify<span class="token operator">-</span>content<span class="token operator">:</span> center<span class="token punctuation">;</span>
      align<span class="token operator">-</span>items<span class="token operator">:</span> center<span class="token punctuation">;</span>
      <span class="token comment">/* 让内容垂直排列 */</span>
      flex<span class="token operator">-</span>direction<span class="token operator">:</span> column<span class="token punctuation">;</span>
      <span class="token comment">/* 页面四周添加 20px 的外边距 */</span>
      <span class="token literal-property property">margin</span><span class="token operator">:</span> 20px<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span>chart<span class="token operator">-</span>container <span class="token punctuation">{<!-- --></span>
      <span class="token comment">/* 设置图表容器的宽度为 800px */</span>
      <span class="token literal-property property">width</span><span class="token operator">:</span> 800px<span class="token punctuation">;</span>
      <span class="token comment">/* 设置图表容器的高度为 500px */</span>
      <span class="token literal-property property">height</span><span class="token operator">:</span> 500px<span class="token punctuation">;</span>
      <span class="token comment">/* 图表容器四周添加 20px 的外边距 */</span>
      <span class="token literal-property property">margin</span><span class="token operator">:</span> 20px<span class="token punctuation">;</span>
      <span class="token comment">/* 图表容器添加 1px 宽的浅灰色边框 */</span>
      <span class="token literal-property property">border</span><span class="token operator">:</span> 1px solid #eee<span class="token punctuation">;</span>
      <span class="token comment">/* 图表容器四个角设置 4px 的圆角 */</span>
      border<span class="token operator">-</span>radius<span class="token operator">:</span> 4px<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span>error<span class="token operator">-</span>message <span class="token punctuation">{<!-- --></span>
      <span class="token comment">/* 错误消息文本颜色设置为红色 */</span>
      <span class="token literal-property property">color</span><span class="token operator">:</span> red<span class="token punctuation">;</span>
      <span class="token comment">/* 错误消息四周添加 20px 的外边距 */</span>
      <span class="token literal-property property">margin</span><span class="token operator">:</span> 20px<span class="token punctuation">;</span>
      <span class="token comment">/* 错误消息内容四周添加 10px 的内边距 */</span>
      <span class="token literal-property property">padding</span><span class="token operator">:</span> 10px<span class="token punctuation">;</span>
      <span class="token comment">/* 错误消息背景颜色设置为浅红色 */</span>
      background<span class="token operator">-</span>color<span class="token operator">:</span> #ffebee<span class="token punctuation">;</span>
      <span class="token comment">/* 错误消息框四个角设置 4px 的圆角 */</span>
      border<span class="token operator">-</span>radius<span class="token operator">:</span> 4px<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>style<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>head<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 订单统计图表的容器，后续 ECharts 图表会渲染到这个容器中 <span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"chart-container"</span> id<span class="token operator">=</span><span class="token string">"orderChart"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 用户统计图表的容器，后续 ECharts 图表会渲染到这个容器中 <span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"chart-container"</span> id<span class="token operator">=</span><span class="token string">"userChart"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
  <span class="token comment">// 当文档的 DOM 内容加载完成后执行以下逻辑</span>
  document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'DOMContentLoaded'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 这里的 token 用于身份验证，实际使用时需要替换为从后端获取的真实 token</span>
      <span class="token keyword">const</span> token <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>

      <span class="token comment">// 自定义的 ECharts 配置选项，可用于覆盖默认配置</span>
      <span class="token keyword">const</span> customOption <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 修改图表标题的文本颜色为蓝色</span>
        <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token literal-property property">textStyle</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token string">'blue'</span> <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>

      <span class="token comment">// 创建订单统计图表的管理实例，传入容器 ID、图表类型、token 和自定义配置</span>
      <span class="token keyword">const</span> orderChart <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChartManager</span><span class="token punctuation">(</span><span class="token string">'orderChart'</span><span class="token punctuation">,</span> <span class="token string">'order'</span><span class="token punctuation">,</span> token<span class="token punctuation">,</span> customOption<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 创建用户统计图表的管理实例，传入容器 ID、图表类型、token 和自定义配置</span>
      <span class="token keyword">const</span> userChart <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChartManager</span><span class="token punctuation">(</span><span class="token string">'userChart'</span><span class="token punctuation">,</span> <span class="token string">'user'</span><span class="token punctuation">,</span> token<span class="token punctuation">,</span> customOption<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 使用 Promise.all 并行初始化订单图表和用户图表</span>
      <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>orderChart<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userChart<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 监听窗口的 beforeunload 事件，当用户关闭或刷新页面时执行以下逻辑</span>
      window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'beforeunload'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 销毁订单图表实例，释放相关资源</span>
        orderChart<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 销毁用户图表实例，释放相关资源</span>
        userChart<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 如果在初始化过程中出现错误，在控制台输出错误信息</span>
      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'图表初始化失败:'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 调用 showGlobalError 函数显示全局错误消息</span>
      <span class="token function">showGlobalError</span><span class="token punctuation">(</span><span class="token string">'图表初始化失败，请检查浏览器控制台'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * 显示全局错误消息的函数
   * @param {string} message - 要显示的错误消息内容
   */</span>
  <span class="token keyword">function</span> <span class="token function">showGlobalError</span><span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 创建一个新的 div 元素用于显示错误消息</span>
    <span class="token keyword">const</span> errorDiv <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 为错误消息 div 元素添加 error-message 类名，以便应用相应的样式</span>
    errorDiv<span class="token punctuation">.</span>className <span class="token operator">=</span> <span class="token string">'error-message'</span><span class="token punctuation">;</span>
    <span class="token comment">// 设置错误消息 div 元素的文本内容为传入的消息</span>
    errorDiv<span class="token punctuation">.</span>textContent <span class="token operator">=</span> message<span class="token punctuation">;</span>
    <span class="token comment">// 将错误消息 div 元素添加到页面 body 元素的最前面</span>
    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">prepend</span><span class="token punctuation">(</span>errorDiv<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span><span class="token operator">/</span>html<span class="token operator">&gt;</span>
</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f:2f626c6f672e6373646e2e6e65742f49545f696f736572732f:61727469636c652f64657461696c732f313436303937313432" class_="artid" style="display:none">
 </p>
</div>


