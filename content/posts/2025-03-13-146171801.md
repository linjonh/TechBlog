---
layout: post
title: "Android-Framwork-之深入理解-IPC-Binder机制"
date: 2025-03-13 20:06:59 +0800
description: "我们都知道 Android 系统分成三层。最上层是 application 应用层，第二层是 Framework 层，第三层是 native 层。Android 应用和系统 Service 运行在不同进程中是为了安全、稳定以及内存管理的原因，但是应用和系统服务需要通信和分享数据。跨进程设计的好处：1.安全性：每个进程都单独运行的，可以保证应用层对系统层的隔离。2.稳定性：如果某个进程崩溃了不会导致其他进程崩溃。3.内存分配：如果某个进程以及不需要了可以从内存中移除，并且回收相应的内存。"
keywords: "Android Framwork 之深入理解 IPC Binder机制"
categories: ['未分类']
tags: ['Binder', 'Android']
artid: "146171801"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146171801
    alt: "Android-Framwork-之深入理解-IPC-Binder机制"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146171801
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146171801
cover: https://bing.ee123.net/img/rand?artid=146171801
image: https://bing.ee123.net/img/rand?artid=146171801
img: https://bing.ee123.net/img/rand?artid=146171801
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Android Framwork 之深入理解 IPC Binder机制
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="1_App_0">
     </a>
     1. App跨进程的系统设计及意义
    </h2>
    <p>
     我们都知道 Android 系统分成三层。最上层是 application 应用层，第二层是 Framework 层，第三层是 native 层。
    </p>
    <ul>
     <li>
      Android 中的应用层和系统服务层不在同一个进程，系统服务在单独的进程中。
     </li>
     <li>
      Android 中不同应用属于不同的进程。
     </li>
    </ul>
    <p>
     Android 应用和系统 Service 运行在不同进程中是为了安全、稳定以及内存管理的原因，但是应用和系统服务需要通信和分享数据。
    </p>
    <p>
     跨进程设计的好处：
     <br/>
     1.安全性：每个进程都单独运行的，可以保证应用层对系统层的隔离。
     <br/>
     2.稳定性：如果某个进程崩溃了不会导致其他进程崩溃。
     <br/>
     3.内存分配：如果某个进程以及不需要了可以从内存中移除，并且回收相应的内存。
    </p>
    <p>
     对于单独 App 程序中的多进程，跨进程设计的好处：
     <br/>
     虚拟机分配给各个进程的运行内存是有限制的，LMK 也会优先回收对系统资源的占用多的进程
     <br/>
     1.突破进程内存限制，如图库占用内存过多；
     <br/>
     2.功能稳定性：独立的通信进程保持长连接的稳定性；
     <br/>
     3.规避系统内存泄漏：独立的 webview 进程阻隔内存泄漏导致的问题；
     <br/>
     4.隔离风险：对于不稳定的功能放入独立进程，避免导致主进程崩溃；
    </p>
    <h2>
     <a id="2_Binder__20">
     </a>
     2. Binder 是什么？，
    </h2>
    <p>
     Binder 就是 Android 中的血管。在 Android 中我们所使用的 Activity、Service 等组件都需要和 AMS（system_server）通信，这种跨进程的通信都是通过 BInder 完成。
    </p>
    <ul>
     <li>
      机制：Binder 是一种进程间通信机制。
     </li>
     <li>
      驱动：Binder 是一个虚拟物理设备驱动。
     </li>
     <li>
      应用层：Binder 是一个能发起通信 Java 类。
     </li>
     <li>
      Framework/Native：Binder 连接了 Client、Server、ServiceManager 和 Binder 驱动程序，形成一套 C/S 的通信架构。
     </li>
    </ul>
    <h2>
     <a id="3__27">
     </a>
     3. 跨进程通信都有哪些？
    </h2>
    <p>
     Linux 的 IPC 有管道、消息队列、内存共享、Socket、binder。
    </p>
    <p>
     （1）内存共享机制
    </p>
    <ul>
     <li>
      <p>
       定义：
      </p>
      <ul>
       <li>
        共享内存允许多个进程共享同一块内存区域，进程可以直接读写这块内存。
       </li>
       <li>
        共享内存是最快的IPC机制，因为数据不需要在内核和用户空间之间拷贝。
       </li>
      </ul>
     </li>
     <li>
      <p>
       优点：
      </p>
      <ul>
       <li>
        高效：数据直接共享，无需拷贝，性能最高。
       </li>
       <li>
        适合大数据量：可以共享大量数据。
       </li>
      </ul>
     </li>
     <li>
      <p>
       缺点：
      </p>
      <ul>
       <li>
        需要同步机制：多个进程同时访问共享内存时，需要额外的同步机制（如信号量）来避免竞争条件。
       </li>
       <li>
        复杂性较高：需要手动管理内存的分配和释放。
       </li>
      </ul>
     </li>
     <li>
      <p>
       使用场景：
      </p>
      <ul>
       <li>
        需要高效共享大数据量的场景，如多媒体数据处理。
        <br/>
        <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/bb6e6cb9414a4af592055cf059e0a394.png"/>
       </li>
      </ul>
     </li>
    </ul>
    <p>
     （2）管道 Pipe
    </p>
    <ul>
     <li>
      <p>
       定义：
      </p>
      <ul>
       <li>
        管道是一种半双工的通信机制，数据只能单向流动。
       </li>
       <li>
        管道分为匿名管道（用于父子进程或兄弟进程之间的通信）和命名管道（FIFO，用于任意进程之间的通信）。
       </li>
      </ul>
     </li>
     <li>
      <p>
       优点：
      </p>
      <ul>
       <li>
        简单易用：实现简单，适合小规模数据传递。
       </li>
       <li>
        轻量级：开销较小，适合频繁的小数据量通信。
       </li>
      </ul>
     </li>
     <li>
      <p>
       缺点：
      </p>
      <ul>
       <li>
        单向通信：数据只能单向流动，双向通信需要创建两个管道。
       </li>
       <li>
        仅限于父子进程或兄弟进程：匿名管道只能用于有亲缘关系的进程之间。
       </li>
       <li>
        数据容量有限：管道的数据缓冲区大小有限，不适合传递大数据量。
       </li>
      </ul>
     </li>
     <li>
      <p>
       使用场景：
      </p>
      <ul>
       <li>
        父子进程或兄弟进程之间的简单通信。
        <br/>
        <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/1dbc3d0402ca4703873c2988acd59492.png"/>
       </li>
      </ul>
     </li>
    </ul>
    <p>
     （3）消息队列 Message Queue
    </p>
    <ul>
     <li>
      定义：
      <ul>
       <li>
        消息队列是一种消息链表，进程可以通过消息队列发送和接收消息。
       </li>
       <li>
        消息队列中的每条消息都有一个类型字段，接收方可以根据类型选择性地接收消息。
       </li>
      </ul>
     </li>
     <li>
      优点：
      <ul>
       <li>
        支持消息类型：可以根据消息类型选择性地接收消息。
       </li>
       <li>
        异步通信：发送方和接收方不需要同时存在。
       </li>
       <li>
        适合结构化数据：可以传递复杂的数据结构。
       </li>
      </ul>
     </li>
     <li>
      缺点：
      <ul>
       <li>
        性能较低：相比于共享内存和管道，消息队列的性能较低。
       </li>
       <li>
        容量有限：消息队列的大小有限，不适合传递大数据量。
       </li>
       <li>
        复杂性较高：需要手动管理消息的发送和接收。
       </li>
      </ul>
     </li>
     <li>
      使用场景：
      <ul>
       <li>
        需要异步通信和选择性接收消息的场景。
        <br/>
        <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/77374c484df344caaa36512b98ef9855.png"/>
       </li>
      </ul>
     </li>
    </ul>
    <p>
     （4）Socket
    </p>
    <ul>
     <li>
      <p>
       定义：
      </p>
      <ul>
       <li>
        Socket是一种网络通信机制，支持TCP和UDP协议。
       </li>
       <li>
        Socket不仅可以用于不同设备之间的通信，还可以用于同一设备的不同进程之间的通信。
       </li>
      </ul>
     </li>
     <li>
      <p>
       优点：
      </p>
      <ul>
       <li>
        跨设备通信：支持不同设备之间的通信。
       </li>
       <li>
        灵活性高：支持多种协议（TCP、UDP）和通信模式（流式、数据报）。
       </li>
       <li>
        适合分布式系统：广泛应用于网络编程和分布式系统。
       </li>
      </ul>
     </li>
     <li>
      <p>
       缺点：
      </p>
      <ul>
       <li>
        性能较低：相比于共享内存和管道，Socket的性能较低。
       </li>
       <li>
        复杂性较高：需要处理网络协议、连接管理等问题。
       </li>
      </ul>
     </li>
     <li>
      <p>
       使用场景：
      </p>
      <ul>
       <li>
        跨设备通信或分布式系统中的进程间通信。
        <br/>
        <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/af07e15af8a5415783a48359936ea0e3.png"/>
       </li>
      </ul>
     </li>
    </ul>
    <p>
     （5）Binder
    </p>
    <ul>
     <li>
      <p>
       定义：
      </p>
      <ul>
       <li>
        Binder是Android特有的IPC机制，基于C/S架构，客户端通过Binder代理对象调用服务端的方法。
       </li>
       <li>
        Binder使用内存映射（mmap）技术，减少了数据拷贝，性能优异。
       </li>
      </ul>
     </li>
     <li>
      <p>
       优点：
      </p>
      <ul>
       <li>
        高效：使用内存映射技术，性能优于传统的IPC机制。
       </li>
       <li>
        安全性高：支持基于UID/PID的权限检查。
       </li>
       <li>
        易用性：Android提供了AIDL工具，简化了Binder的使用。
       </li>
      </ul>
     </li>
     <li>
      <p>
       缺点：
      </p>
      <ul>
       <li>
        平台限制：仅适用于Android系统。
       </li>
       <li>
        复杂性较高：需要理解Binder的底层机制和AIDL的使用。
       </li>
      </ul>
     </li>
     <li>
      <p>
       使用场景：
      </p>
      <ul>
       <li>
        Android系统中的跨进程通信，如系统服务与应用程序之间的通信。
       </li>
      </ul>
     </li>
    </ul>
    <p>
     binder 和其它通信机制的不同在于它是用的内存映射方案，而不是内核空间。binder 通信的数据大小是1M-8k。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/c4bae64ae0cc4b388747a91eeb33e93c.png">
      <br/>
      mmap 内存映射的过程：
      <br/>
      一个数据发送方 client，一个数据接收方 server，两个进程之间通信，会让 server 端中的一块内存与物理内存进行内存映射。内核地址空间里也会有一块内存和物理内存一一映射。这就会形成一个结果，假如运用内核空间一块地址往物理内存写数据，等价于数据写到了 server 端。
     </img>
    </p>
    <h2>
     <a id="4__121">
     </a>
     4. 内存模型：
    </h2>
    <p>
     内存被操作系统划分成两块：用户空间和内核空间。为了安全，它们是隔离的，即使用户的程序崩溃了，内核也不受影响。
    </p>
    <ul>
     <li>
      用户空间：是用户程序代码运行的地方；
     </li>
     <li>
      内核空间：是内核代码运行的地方；
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/5778732bdb7f4daf9d913389f4dad0e9.png"/>
     </li>
    </ul>
    <h2>
     <a id="5_Binder__126">
     </a>
     5. Binder 通信的基本原理：
    </h2>
    <p>
     Client 要和 Server 端通信，需要拿到 server 端的 binder。这就需要 Server 端先启动，然后将自己的 binder 注册到 ServiceManager，这里就需要 ServiceManager 维持一个表，这个表包含了 Server 端的 binder。这个时候 Client 就可以从 ServiceManager 的表中获取 Server 的 binder，再利用 binder 完成通信。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/db9cf456355a4768b3fa62650653a5b9.png"/>
    </p>
    <ul>
     <li>
      Binder 是在什么时间创建的？
      <br/>
      进程创建的时候，就准备了 binder。
     </li>
     <li>
      Binder 的初始化过程
      <ul>
       <li>
        ServiceManager 的启动：
        <br/>
        1.Android系统启动时，会启动ServiceManager进程，它是所有Binder服务的注册中心。
        <br/>
        2.ServiceManager通过binder_open()和binder_become_context_manager()初始化Binder驱动。
       </li>
       <li>
        服务的注册：
        <br/>
        1.服务端通过ServiceManager.addService()将服务注册到ServiceManager中。
        <br/>
        2.ServiceManager会为每个服务分配一个唯一的Binder句柄。
       </li>
       <li>
        客户端的获取：
        <br/>
        客户端通过ServiceManager.getService()获取服务的Binder代理对象（BinderProxy）。
       </li>
      </ul>
     </li>
    </ul>
    <h2>
     <a id="6_Aidl__140">
     </a>
     6. Aidl 跨进程通信
    </h2>
    <p>
     （1）基本使用
    </p>
    <ul>
     <li>
      首先在 main目录下创建一个 aidl 文件夹，在该文件夹下创建一个 aidl 文件，把服务公布给客户端使用。
      <br/>
      如：IMediaInterface.aidl
     </li>
    </ul>
    <pre><code class="prism language-java"><span class="token keyword">interface</span> <span class="token class-name">IMediaInterface</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/**
         * 同步请求
         */</span>
        <span class="token class-name">String</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <ul>
     <li>
      然后 build 编译，自动生成接口的 java 文件，在…/xxmodule/build/generated/aidl_source_output_dir/xx/out/com/example/media/aidl/IMediaInterface.java 路径下。
      <br/>
      如：
     </li>
    </ul>
    <pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IMediaInterface</span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span>IInterface</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token comment">/** Default implementation for IMediaInterface. */</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Default</span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>media<span class="token punctuation">.</span>aidl<span class="token punctuation">.</span></span>IMediaInterface</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/**
             * 同步请求
             */</span>
    <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>String</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span>RemoteException</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span>IBinder</span> <span class="token function">asBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/** Local-side IPC implementation stub class. */</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Stub</span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span>Binder</span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>media<span class="token punctuation">.</span>aidl<span class="token punctuation">.</span></span>IMediaInterface</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>String</span> <span class="token constant">DESCRIPTOR</span> <span class="token operator">=</span> <span class="token string">"com.example.media.aidl.IMediaInterface"</span><span class="token punctuation">;</span>
    <span class="token comment">/** Construct the stub at attach it to the interface. */</span>
    <span class="token keyword">public</span> <span class="token class-name">Stub</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">attachInterface</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">DESCRIPTOR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * Cast an IBinder object into an com.autoai.media.aidl.IMediaInterface interface,
     * generating a proxy if needed.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>media<span class="token punctuation">.</span>aidl<span class="token punctuation">.</span></span>IMediaInterface</span> <span class="token function">asInterface</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span>IBinder</span> obj<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>obj<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span>IInterface</span> iin <span class="token operator">=</span> obj<span class="token punctuation">.</span><span class="token function">queryLocalInterface</span><span class="token punctuation">(</span><span class="token constant">DESCRIPTOR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>iin<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>iin <span class="token keyword">instanceof</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>media<span class="token punctuation">.</span>aidl<span class="token punctuation">.</span></span>IMediaInterface</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>media<span class="token punctuation">.</span>aidl<span class="token punctuation">.</span></span>IMediaInterface</span><span class="token punctuation">)</span>iin<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>media<span class="token punctuation">.</span>aidl<span class="token punctuation">.</span></span>IMediaInterface<span class="token punctuation">.</span>Stub<span class="token punctuation">.</span>Proxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span>IBinder</span> <span class="token function">asBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">onTransact</span><span class="token punctuation">(</span><span class="token keyword">int</span> code<span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span>Parcel</span> data<span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span>Parcel</span> reply<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span>RemoteException</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>String</span> descriptor <span class="token operator">=</span> <span class="token constant">DESCRIPTOR</span><span class="token punctuation">;</span>
      <span class="token keyword">switch</span> <span class="token punctuation">(</span>code<span class="token punctuation">)</span>
      <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">case</span> <span class="token constant">INTERFACE_TRANSACTION</span><span class="token operator">:</span>
        <span class="token punctuation">{<!-- --></span>
          reply<span class="token punctuation">.</span><span class="token function">writeString</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">case</span> <span class="token class-name">TRANSACTION_request</span><span class="token operator">:</span>
        <span class="token punctuation">{<!-- --></span>
          data<span class="token punctuation">.</span><span class="token function">enforceInterface</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>String</span> _arg0<span class="token punctuation">;</span>
          _arg0 <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">readString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>String</span> _arg1<span class="token punctuation">;</span>
          _arg1 <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">readString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>String</span> _result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          reply<span class="token punctuation">.</span><span class="token function">writeNoException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          reply<span class="token punctuation">.</span><span class="token function">writeString</span><span class="token punctuation">(</span>_result<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onTransact</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> data<span class="token punctuation">,</span> reply<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Proxy</span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>media<span class="token punctuation">.</span>aidl<span class="token punctuation">.</span></span>IMediaInterface</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">private</span> <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span>IBinder</span> mRemote<span class="token punctuation">;</span>
      <span class="token class-name">Proxy</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span>IBinder</span> remote<span class="token punctuation">)</span>
      <span class="token punctuation">{<!-- --></span>
        mRemote <span class="token operator">=</span> remote<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span>IBinder</span> <span class="token function">asBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> mRemote<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">public</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>String</span> <span class="token function">getInterfaceDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token constant">DESCRIPTOR</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">/**
               * 同步请求
               */</span>
      <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>String</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span>RemoteException</span>
      <span class="token punctuation">{<!-- --></span>
        <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span>Parcel</span> _data <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span>Parcel</span><span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span>Parcel</span> _reply <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span>Parcel</span><span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>String</span> _result<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
          _data<span class="token punctuation">.</span><span class="token function">writeInterfaceToken</span><span class="token punctuation">(</span><span class="token constant">DESCRIPTOR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          _data<span class="token punctuation">.</span><span class="token function">writeString</span><span class="token punctuation">(</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>
          _data<span class="token punctuation">.</span><span class="token function">writeString</span><span class="token punctuation">(</span>jsonParams<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// 实际请求</span>
          <span class="token keyword">boolean</span> _status <span class="token operator">=</span> mRemote<span class="token punctuation">.</span><span class="token function">transact</span><span class="token punctuation">(</span><span class="token class-name">Stub<span class="token punctuation">.</span>TRANSACTION_request</span><span class="token punctuation">,</span> _data<span class="token punctuation">,</span> _reply<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_status <span class="token operator">&amp;&amp;</span> <span class="token function">getDefaultImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token function">getDefaultImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>packageName<span class="token punctuation">,</span> jsonParams<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          _reply<span class="token punctuation">.</span><span class="token function">readException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          _result <span class="token operator">=</span> _reply<span class="token punctuation">.</span><span class="token function">readString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
          _reply<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          _data<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> _result<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>autoai<span class="token punctuation">.</span>media<span class="token punctuation">.</span>aidl<span class="token punctuation">.</span></span>IMediaInterface</span> sDefaultImpl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token class-name">TRANSACTION_request</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span>IBinder</span><span class="token punctuation">.</span><span class="token constant">FIRST_CALL_TRANSACTION</span> <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">setDefaultImpl</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>media<span class="token punctuation">.</span>aidl<span class="token punctuation">.</span></span>IMediaInterface</span> impl<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// Only one user of this interface can use this function</span>
      <span class="token comment">// at a time. This is a heuristic to detect if two different</span>
      <span class="token comment">// users in the same process use this function.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Stub<span class="token punctuation">.</span>Proxy</span><span class="token punctuation">.</span>sDefaultImpl <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"setDefaultImpl() called twice"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>impl <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Stub<span class="token punctuation">.</span>Proxy</span><span class="token punctuation">.</span>sDefaultImpl <span class="token operator">=</span> impl<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>media<span class="token punctuation">.</span>aidl<span class="token punctuation">.</span></span>IMediaInterface</span> <span class="token function">getDefaultImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token class-name">Stub<span class="token punctuation">.</span>Proxy</span><span class="token punctuation">.</span>sDefaultImpl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/**
           * 同步请求
           */</span>
  <span class="token keyword">public</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>String</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span>RemoteException</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
    <ul>
     <li>
      实现服务端
     </li>
    </ul>
    <pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyService</span> <span class="token keyword">extends</span> <span class="token class-name">Service</span> <span class="token punctuation">{<!-- --></span>
	<span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">IBinder</span> <span class="token function">onBind</span><span class="token punctuation">(</span><span class="token class-name">Intent</span> intent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token keyword">return</span> <span class="token class-name">Mybind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token keyword">class</span> <span class="token class-name">Mybind</span> <span class="token keyword">extends</span> <span class="token class-name">IMediaInterface<span class="token punctuation">.</span>Stub</span> <span class="token punctuation">{<!-- --></span>
   		<span class="token annotation punctuation">@Override</span>
   		<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">{<!-- --></span>
   			<span class="token comment">// todo</span>
   		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <ul>
     <li>
      实现客户端
     </li>
    </ul>
    <pre><code class="prism language-java"><span class="token class-name">IMediaInterface</span> myService<span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token class-name">ServiceConnection</span> connection <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onServiceConnected</span><span class="token punctuation">(</span><span class="token class-name">ComponentName</span> name<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> service<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
               myService <span class="token operator">=</span> <span class="token class-name">IMediaInterface<span class="token punctuation">.</span>Stub</span><span class="token punctuation">.</span><span class="token function">asInterface</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onServiceDisconnected</span><span class="token punctuation">(</span><span class="token class-name">ComponentName</span> name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token class-name">Intent</span> intent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
intent<span class="token punctuation">.</span><span class="token function">setAction</span><span class="token punctuation">(</span><span class="token string">"com.example.media.aidl.IMediaInterface"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
intent<span class="token punctuation">.</span><span class="token function">setPackages</span><span class="token punctuation">(</span><span class="token string">"com.example.media.aidl"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">bindService</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> connection<span class="token punctuation">,</span> <span class="token constant">BIND_AUTO_CREATE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     看这一句
     <code>
      IMediaInterface.Stub.asInterface(service)
     </code>
     ，service 是服务端的 IBinder，asInterface() 里会将 IBinder 转成 Proxy，代理的是 stub，Proxy是给客户端用的，并且会将Stub封装到Proxy中。客户端调用Proxy接口，但Proxy没有功能，又会转交给Remote，到Stub，最终交给Stub完成请求，客户端最终调用接口是 mRemote.transact() 。
    </p>
    <h2>
     <a id="7_Client__Server__Binder__339">
     </a>
     7. Client 与 Server 通过 Binder 通信的过程
    </h2>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/649a1720a2074b6dbf41b95dbc7e8c9b.png"/>
    </p>
    <ul>
     <li>
      <p>
       客户端调用：
      </p>
      <ul>
       <li>
        <p>
         客户端通过Binder代理对象（Proxy）调用远程方法。
        </p>
       </li>
       <li>
        <p>
         Proxy将方法调用封装成Parcel对象，并通过Binder驱动发送给服务端。
        </p>
       </li>
      </ul>
     </li>
     <li>
      <p>
       Binder 驱动：
      </p>
      <ul>
       <li>
        Binder驱动在内核空间接收数据，并将请求传递给目标进程的Binder线程池。
       </li>
      </ul>
     </li>
     <li>
      <p>
       服务端处理：
      </p>
      <ul>
       <li>
        <p>
         服务端的Binder Stub对象接收到请求后，解析Parcel数据并调用实际的方法。
        </p>
       </li>
       <li>
        <p>
         方法执行完毕后，Stub将结果封装成Parcel对象，通过Binder驱动返回给客户端。
        </p>
       </li>
      </ul>
     </li>
     <li>
      <p>
       客户端接收结果：
      </p>
      <ul>
       <li>
        客户端接收到结果后，Proxy将结果返回给调用者。
       </li>
      </ul>
     </li>
    </ul>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f:626c6f672e6373646e2e6e65742f426f6e6e69655f6361742f:61727469636c652f64657461696c732f313436313731383031" class_="artid" style="display:none">
 </p>
</div>


