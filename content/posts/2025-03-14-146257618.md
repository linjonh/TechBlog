---
arturl_encode: "68747470733a2f2f626c6f:672e6373646e2e6e65742f323330315f37373530393736322f:61727469636c652f64657461696c732f313436323537363138"
layout: post
title: "C11å¤šçº¿ç¨‹,é”ä¸æ¡ä»¶å˜é‡"
date: 2025-03-14 17:49:05 +08:00
description: "C++11å¤šçº¿ç¨‹ï¼Œæ¡ä»¶å˜é‡ï¼Œäº’æ–¥é”çš„å­¦ä¹ ç¬”è®°"
keywords: "C++11å¤šçº¿ç¨‹ï¼Œé”ä¸æ¡ä»¶å˜é‡"
categories: ['C']
tags: ['æ¡ä»¶å˜é‡', 'å¤šçº¿ç¨‹', 'äº’æ–¥é”', 'Java', 'C', 'C']
artid: "146257618"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146257618
    alt: "C11å¤šçº¿ç¨‹,é”ä¸æ¡ä»¶å˜é‡"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146257618
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146257618
cover: https://bing.ee123.net/img/rand?artid=146257618
image: https://bing.ee123.net/img/rand?artid=146257618
img: https://bing.ee123.net/img/rand?artid=146257618
---

# C++11å¤šçº¿ç¨‹ï¼Œé”ä¸æ¡ä»¶å˜é‡

![](https://i-blog.csdnimg.cn/direct/d4babccb42bb4596928b030de7371f48.jpeg#pic_center)

**ğŸ‘ä¸ªäººä¸»é¡µï¼šJupiter.**

**ğŸš€ æ‰€å±ä¸“æ ï¼šC++å­¦ä¹ ç¬”è®°**

**æ¬¢è¿å¤§å®¶ç‚¹èµæ”¶è—è¯„è®ºğŸ˜Š**

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/1be8fa655d014659ab7b34b4e1695c5a.gif#pic_center)

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/6d40a7ef5b4049b584d8f33e81c9da06.jpeg#pic_center)

---

## `çº¿ç¨‹åº“`

### `1. threadç±»çš„ç®€å•ä»‹ç»`

[å®˜æ–¹æ–‡æ¡£é“¾æ¥](https://legacy.cplusplus.com/reference/thread/thread/?kw=thread)

#### 1.1constructoræ„é€ å‡½æ•°

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/06fa7d5dd1cd44dab906059ec9efb3e2.png)

1. `threadç±»æ˜¯é˜²æ‹·è´çš„ï¼Œä¸å…è®¸æ‹·è´æ„é€ ä»¥åŠèµ‹å€¼ï¼Œä½†æ˜¯å¯ä»¥ç§»åŠ¨æ„é€ å’Œç§»åŠ¨èµ‹å€¼ï¼Œå³å°†ä¸€ä¸ª çº¿ç¨‹å¯¹è±¡å…³è”çº¿ç¨‹çš„çŠ¶æ€è½¬ç§»ç»™å…¶ä»–çº¿ç¨‹å¯¹è±¡ï¼Œè½¬ç§»æœŸé—´ä¸æ„å‘çº¿ç¨‹çš„æ‰§è¡Œã€‚`
2. å½“åˆ›å»ºä¸€ä¸ªçº¿ç¨‹å¯¹è±¡åï¼Œæ²¡æœ‰æä¾›çº¿ç¨‹å‡½æ•°ï¼Œè¯¥å¯¹è±¡å®é™…æ²¡æœ‰å¯¹åº”ä»»ä½•çº¿ç¨‹ã€‚

```cpp
#include <thread>
int main()
{
 std::thread t1;
 cout << t1.get_id() << endl;
 return 0;
}

```

3. å½“åˆ›å»ºä¸€ä¸ªçº¿ç¨‹å¯¹è±¡åï¼Œå¹¶ä¸”ç»™çº¿ç¨‹å…³è”çº¿ç¨‹å‡½æ•°ï¼Œè¯¥çº¿ç¨‹å°±è¢«å¯åŠ¨ï¼Œä¸ä¸»çº¿ç¨‹ä¸€èµ·è¿è¡Œã€‚
     
   çº¿ç¨‹å‡½æ•°ä¸€èˆ¬æƒ…å†µä¸‹å¯æŒ‰ç…§ä»¥ä¸‹ä¸‰ç§æ–¹å¼æä¾›ï¼š

* å‡½æ•°æŒ‡é’ˆ
* lambdaè¡¨è¾¾å¼
* å‡½æ•°å¯¹è±¡

```cpp
#include <iostream>
using namespace std;
#include <thread>
void ThreadFunc(int a)
{
	cout << "Thread1" << a << endl;
}
class TF
{
public:
	void operator()()
	{
		cout << "Thread3" << endl;
	}
};
int main()
{
	// çº¿ç¨‹å‡½æ•°ä¸ºå‡½æ•°æŒ‡é’ˆ
	thread t1(ThreadFunc, 10);

	// çº¿ç¨‹å‡½æ•°ä¸ºlambdaè¡¨è¾¾å¼
	thread t2([] {cout << "Thread2" << endl; });
	// çº¿ç¨‹å‡½æ•°ä¸ºå‡½æ•°å¯¹è±¡
	TF tf;
	thread t3(tf);

	t1.join();
	t2.join();
	t3.join();
	cout << "Main thread!" << endl;
	return 0;
}

```

4. å¯ä»¥é€šè¿‡jionable()å‡½æ•°åˆ¤æ–­çº¿ç¨‹æ˜¯å¦æ˜¯æœ‰æ•ˆçš„ï¼Œå¦‚æœæ˜¯ä»¥ä¸‹ä»»æ„æƒ…å†µï¼Œåˆ™çº¿ç¨‹æ— æ•ˆ

* é‡‡ç”¨æ— å‚æ„é€ å‡½æ•°æ„é€ çš„çº¿ç¨‹å¯¹è±¡
* çº¿ç¨‹å¯¹è±¡çš„çŠ¶æ€å·²ç»è½¬ç§»ç»™å…¶ä»–çº¿ç¨‹å¯¹è±¡
* çº¿ç¨‹å·²ç»è°ƒç”¨jionæˆ–è€…detachç»“æŸ

***é¢è¯•é¢˜ï¼šå¹¶å‘ä¸å¹¶è¡Œçš„åŒºåˆ«ï¼Ÿ***

* å¹¶å‘ï¼šå¹¶å‘æ˜¯æŒ‡ä¸¤ä¸ªæˆ–å¤šä¸ªäº‹ä»¶åœ¨åŒä¸€æ—¶é—´é—´éš”å†…å‘ç”Ÿï¼Œä½†å¹¶ä¸æ„å‘³ç€åœ¨åŒä¸€æ—¶é—´ç‚¹åŒæ—¶è¿è¡Œã€‚åœ¨å¹¶å‘å¤„ç†ä¸­ï¼Œä»»åŠ¡è¢«åˆ†é…åˆ°ä¸åŒçš„æ—¶é—´ç‚¹ç”±å¤„ç†å™¨è¿›è¡Œå¤„ç†ï¼Œå®è§‚ä¸Šçœ‹èµ·æ¥åƒæ˜¯åŒæ—¶å¤„ç†å¤šä¸ªä»»åŠ¡ï¼Œä½†å®é™…ä¸Šåœ¨å¾®è§‚å±‚é¢ï¼ŒCPUæ˜¯åœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´å¿«é€Ÿäº¤æ›¿æ‰§è¡Œçš„ã€‚
* å¹¶è¡Œï¼šå¹¶è¡Œåˆ™æ˜¯æŒ‡ä¸¤ä¸ªæˆ–å¤šä¸ªäº‹ä»¶åœ¨åŒä¸€æ—¶åˆ»å‘ç”Ÿï¼Œå³åœ¨åŒä¸€æ—¶é—´ç‚¹ä»»åŠ¡ä¸€å®šæ˜¯åŒæ—¶è¿è¡Œçš„ã€‚åœ¨å¹¶è¡Œå¤„ç†ä¸­ï¼Œæ¯ä¸ªä»»åŠ¡è¢«åˆ†é…ç»™ä¸åŒçš„å¤„ç†å™¨ç‹¬ç«‹å®Œæˆï¼Œå¤šä¸ªå¤„ç†å™¨å¯ä»¥åŒæ—¶å¤„ç†å¤šä¸ªçº¿ç¨‹ä»»åŠ¡ã€‚

#### `1.2 çº¿ç¨‹å‡½æ•°å‚æ•°`

çº¿ç¨‹å‡½æ•°çš„å‚æ•°æ˜¯ä»¥
`å€¼æ‹·è´`
çš„æ–¹å¼æ‹·è´åˆ°
`çº¿ç¨‹æ ˆç©ºé—´`
ä¸­çš„ï¼Œå› æ­¤ï¼šå³ä½¿çº¿ç¨‹å‚æ•°ä¸ºå¼•ç”¨ç±»å‹ï¼Œåœ¨çº¿ç¨‹ä¸­ä¿®æ”¹åä¹Ÿä¸èƒ½ä¿®æ”¹å¤–éƒ¨å®å‚ï¼Œå› ä¸ºå…¶å®é™…å¼•ç”¨çš„æ˜¯çº¿ç¨‹æ ˆä¸­çš„æ‹·è´ï¼Œè€Œä¸æ˜¯å¤–éƒ¨å®å‚ã€‚

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/f12abfd3904d42e1b137d43ffe12268d.png)

è§£å†³æ–¹æ³•ï¼š

1. å°†xä¸mtxçš„åœ°å€ä¼ è¿‡å»ï¼Œç”¨æŒ‡é’ˆæ¥æ”¶ï¼›
2. ç¬¬äºŒç§è§£å†³æ–¹æ¡ˆï¼Œç”¨c++11æä¾›çš„ref

```cpp
#include <thread>
void ThreadFunc1(int& x)
{
	x += 10;
}
void ThreadFunc2(int* x)
{
	*x += 10;
}
int main()
{
	int a = 10;
	// åœ¨çº¿ç¨‹å‡½æ•°ä¸­å¯¹aä¿®æ”¹ï¼Œä¸ä¼šå½±å“å¤–éƒ¨å®å‚ï¼Œå› ä¸ºï¼šçº¿ç¨‹å‡½æ•°å‚æ•°è™½ç„¶æ˜¯å¼•ç”¨æ–¹å¼ï¼Œä½†å…¶å®é™…
	//å¼•ç”¨çš„æ˜¯çº¿ç¨‹æ ˆä¸­çš„æ‹·è´
	thread t1(ThreadFunc1, a);   //ä¼šæŠ¥é”™
	t1.join();
	cout << a << endl;
	
	// å¦‚æœæƒ³è¦é€šè¿‡å½¢å‚æ”¹å˜å¤–éƒ¨å®å‚æ—¶ï¼Œå¿…é¡»å€ŸåŠ©std::ref()å‡½æ•°
	thread t2(ThreadFunc1, std::ref(a));
	t2.join();
	cout << a << endl;
	
	// åœ°å€çš„æ‹·è´
	thread t3(ThreadFunc2, &a);
	t3.join();
	cout << a << endl;

	while (1);
	return 0;
}

```

å½“ä¼ å…¥çš„æ˜¯
`ref(x)`
ä¸ref(mtx)çš„æ—¶å€™ï¼Œåœ¨pthread_createæ¥æ”¶å‚æ•°çš„æ—¶å€™ï¼Œå®é™…ä¸Šæ¨å¯¼å‡ºæ¥æ˜¯æ¥å—åˆ°çš„æ˜¯å®å‚çš„å¼•ç”¨ï¼Œä¸­é—´å°±æ²¡æœ‰äº§ç”Ÿæ‹·è´ï¼Œæ‰€ä»¥è§£å†³äº†é—®é¢˜ã€‚
  
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/27eb8afe24cb47a994b15061d354b761.png#pic_center)

* å¦‚æœæƒ³è¦é€šè¿‡å½¢å‚æ”¹å˜å¤–éƒ¨å®å‚æ—¶ï¼Œå¿…é¡»å€ŸåŠ©
  `std::ref()å‡½æ•°`
* `æ³¨æ„`
  ï¼šå¦‚æœæ˜¯ç±»æˆå‘˜å‡½æ•°ä½œä¸ºçº¿ç¨‹å‚æ•°æ—¶ï¼Œå¿…é¡»å°†thisä½œä¸ºçº¿ç¨‹å‡½æ•°å‚æ•°ã€‚

#### `2. åŸå­æ€§æ“ä½œåº“(atomic)`

å¤šçº¿ç¨‹æœ€ä¸»è¦çš„é—®é¢˜æ˜¯å…±äº«æ•°æ®å¸¦æ¥çš„é—®é¢˜(å³çº¿ç¨‹å®‰å…¨)ã€‚å¦‚æœå…±äº«æ•°æ®éƒ½æ˜¯åªè¯»çš„ï¼Œé‚£ä¹ˆæ²¡é—®é¢˜ï¼Œå› ä¸ºåªè¯»æ“ä½œä¸ä¼šå½±å“åˆ°æ•°æ®ï¼Œæ›´ä¸ä¼šæ¶‰åŠå¯¹æ•°æ®çš„ä¿®æ”¹ï¼Œæ‰€ä»¥æ‰€æœ‰çº¿ç¨‹éƒ½ä¼šè·å¾—åŒæ ·çš„æ•°æ®ã€‚ä½†æ˜¯ï¼Œå½“ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹è¦ä¿®æ”¹å…±äº«æ•°æ®æ—¶ï¼Œå°±ä¼šäº§ç”Ÿå¾ˆå¤šæ½œåœ¨çš„éº»çƒ¦ã€‚æ¯”å¦‚ï¼š

```cpp
int x = 0;   //å…¨å±€å˜é‡   å…±äº«èµ„æº

//ä¸åŠ é”æ˜¯å­˜åœ¨çº¿ç¨‹å®‰å…¨çš„é—®é¢˜
void Print(int n) {
	for (int i = 0; i < n; i++){
		x++;   //å¯¹å…±äº«èµ„æºè¿›è¡Œä¿®æ”¹
	}
}
int main()
{
	thread t1(Print, 100000);
	thread t2(Print, 200000);

	t1.join();
	t2.join();

	cout << x << endl;

	return 0;
}


```

C++98ä¸­ä¼ ç»Ÿçš„è§£å†³æ–¹å¼ï¼šå¯ä»¥å¯¹å…±äº«ä¿®æ”¹çš„æ•°æ®å¯ä»¥åŠ é”ä¿æŠ¤ã€‚

```cpp
int x = 0;
mutex mtx;

void Print(int n){
	mtx.lock();   //åŠ é”
	for (int i = 0; i < n; i++)
	{
		x++;
	}
	mtx.unlock();  //è§£é”
}
int main()
{
	thread t1(Print, 100000);
	thread t2(Print, 200000);

	t1.join();
	t2.join();

	cout << x << endl;
	return 0;
}

```

è™½ç„¶åŠ é”å¯ä»¥è§£å†³ï¼Œä½†æ˜¯åŠ é”æœ‰ä¸€ä¸ª
`ç¼ºé™·`
å°±æ˜¯ï¼šåªè¦ä¸€ä¸ªçº¿ç¨‹åœ¨å¯¹sum++æ—¶ï¼Œå…¶ä»–çº¿ç¨‹å°±ä¼šè¢«é˜»å¡ï¼Œä¼šå½±å“ç¨‹åºè¿è¡Œçš„æ•ˆç‡ï¼Œè€Œä¸”é”å¦‚æœæ§åˆ¶ä¸å¥½ï¼Œè¿˜å®¹æ˜“é€ æˆæ­»é”ã€‚

å› æ­¤C++11ä¸­å¼•å…¥äº†åŸå­æ“ä½œã€‚æ‰€è°“åŸå­æ“ä½œï¼šå³ä¸å¯è¢«ä¸­æ–­çš„ä¸€ä¸ªæˆ–ä¸€ç³»åˆ—æ“ä½œï¼ŒC++11å¼•å…¥çš„åŸå­æ“ä½œç±»å‹ï¼Œä½¿å¾—çº¿ç¨‹é—´æ•°æ®çš„åŒæ­¥å˜å¾—éå¸¸é«˜æ•ˆã€‚
  
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/b0c34d4b538a4460af8329a6253470bb.png#pic_center)
  
æ³¨æ„ï¼šéœ€è¦ä½¿ç”¨ä»¥ä¸ŠåŸå­æ“ä½œå˜é‡æ—¶ï¼Œå¿…é¡»æ·»åŠ å¤´æ–‡ä»¶
`#include <atomic>`

```cpp
#inlcude<iostream>
#include<thread>
#include<atomic>
using namespace std;

atomic<int> x = 0;

void Print(int n){
	for (int i = 0; i < n; i++)
	{
		x++;
	}
}
int main()
{
	thread t1(Print, 100000);
	thread t2(Print, 200000);

	t1.join();
	t2.join();

	cout << x << endl;
	return 0;
}

```

åœ¨C++11ä¸­ï¼Œç¨‹åºå‘˜ä¸éœ€è¦å¯¹åŸå­ç±»å‹å˜é‡è¿›è¡ŒåŠ é”è§£é”æ“ä½œï¼Œçº¿ç¨‹èƒ½å¤Ÿå¯¹åŸå­ç±»å‹å˜é‡äº’æ–¥çš„è®¿é—®ã€‚æ›´ä¸ºæ™®éçš„ï¼Œç¨‹åºå‘˜å¯ä»¥ä½¿ç”¨atomicç±»æ¨¡æ¿ï¼Œå®šä¹‰å‡ºéœ€è¦çš„ä»»æ„åŸå­ç±»å‹ã€‚

```cpp
atmoic<T> t;    // å£°æ˜ä¸€ä¸ªç±»å‹ä¸ºTçš„åŸå­ç±»å‹å˜é‡t

```

æ³¨æ„ï¼šåŸå­ç±»å‹é€šå¸¸å±äº"èµ„æºå‹"æ•°æ®ï¼Œå¤šä¸ªçº¿ç¨‹åªèƒ½è®¿é—®å•ä¸ªåŸå­ç±»å‹çš„æ‹·è´ï¼Œå› æ­¤åœ¨C++11ä¸­ï¼ŒåŸå­ç±»å‹åªèƒ½ä»å…¶æ¨¡æ¿å‚æ•°ä¸­è¿›è¡Œæ„é€ ï¼Œ
`ä¸å…è®¸åŸå­ç±»å‹è¿›è¡Œæ‹·è´æ„é€ ã€ç§»åŠ¨æ„é€ ä»¥åŠoperator=ç­‰ï¼Œä¸ºäº†é˜²æ­¢æ„å¤–ï¼Œæ ‡å‡†åº“å·²ç»å°†atmoicæ¨¡æ¿ç±»ä¸­çš„æ‹·è´æ„é€ ã€ç§»åŠ¨æ„é€ ã€èµ‹å€¼è¿ç®—ç¬¦é‡è½½é»˜è®¤åˆ é™¤æ‰äº†ã€‚`

```cpp
#include <atomic>
int main()
{
 atomic<int> a1(0);
 //atomic<int> a2(a1);   // ç¼–è¯‘å¤±è´¥
 atomic<int> a2(0);
 //a2 = a1;               // ç¼–è¯‘å¤±è´¥
 return 0;
}

```

#### `3. lock_guardä¸unique_lock`

åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œå¦‚æœæƒ³è¦ä¿è¯æŸä¸ªå˜é‡çš„å®‰å…¨æ€§ï¼Œåªè¦å°†å…¶è®¾ç½®æˆå¯¹åº”çš„åŸå­ç±»å‹å³å¯ï¼Œå³é«˜æ•ˆåˆä¸å®¹æ˜“å‡ºç°æ­»é”é—®é¢˜ã€‚ä½†æ˜¯æœ‰äº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦ä¿è¯ä¸€æ®µä»£ç çš„å®‰å…¨æ€§ï¼Œé‚£ä¹ˆå°±åªèƒ½é€šè¿‡é”çš„æ–¹å¼æ¥è¿›è¡Œæ§åˆ¶ã€‚

é”æ§åˆ¶ä¸å¥½æ—¶ï¼Œå¯èƒ½ä¼šé€ æˆæ­»é”ï¼Œæœ€å¸¸è§çš„æ¯”å¦‚åœ¨é”ä¸­é—´ä»£ç è¿”å›ï¼Œæˆ–è€…åœ¨é”çš„èŒƒå›´å†…æŠ›å¼‚å¸¸ã€‚å› æ­¤ï¼šC++11é‡‡ç”¨
`RAII`
çš„æ–¹å¼å¯¹é”è¿›è¡Œäº†å°è£…ï¼Œå³
`lock_guard`
å’Œ
`unique_lock`
ã€‚

#### `3.1 mutexçš„ç§ç±»`

åœ¨C++11ä¸­ï¼ŒMutexæ€»å…±åŒ…äº†å››ä¸ªäº’æ–¥é‡çš„ç§ç±»ï¼š

1. **std::mutex**
     
   C++11æä¾›çš„æœ€åŸºæœ¬çš„äº’æ–¥é‡ï¼Œè¯¥ç±»çš„å¯¹è±¡ä¹‹é—´ä¸èƒ½æ‹·è´ï¼Œä¹Ÿä¸èƒ½è¿›è¡Œç§»åŠ¨ã€‚mutexæœ€å¸¸ç”¨çš„ä¸‰ä¸ªå‡½æ•°ï¼š
     
   ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/1ca9d963752e40e39b9c8f2144dedeae.png)
     
   æ³¨æ„ï¼Œçº¿ç¨‹å‡½æ•°è°ƒç”¨lock()æ—¶ï¼Œå¯èƒ½ä¼šå‘ç”Ÿä»¥ä¸‹ä¸‰ç§æƒ…å†µï¼š

* å¦‚æœè¯¥äº’æ–¥é‡å½“å‰æ²¡æœ‰è¢«é”ä½ï¼Œåˆ™è°ƒç”¨çº¿ç¨‹å°†è¯¥äº’æ–¥é‡é”ä½ï¼Œç›´åˆ°è°ƒç”¨ unlockä¹‹å‰ï¼Œè¯¥çº¿ç¨‹ä¸€ç›´æ‹¥æœ‰è¯¥é”
* å¦‚æœå½“å‰äº’æ–¥é‡è¢«å…¶ä»–çº¿ç¨‹é”ä½ï¼Œåˆ™å½“å‰çš„è°ƒç”¨çº¿ç¨‹è¢«é˜»å¡ä½
* å¦‚æœå½“å‰äº’æ–¥é‡è¢«å½“å‰è°ƒç”¨çº¿ç¨‹ å†æ¬¡ é”ä½ï¼ˆè¿™åœ¨å¤§å¤šæ•°äº’æ–¥é‡å®ç°ä¸­æ˜¯ä¸å¯èƒ½çš„ï¼Œå› ä¸ºæ ‡å‡†äº’æ–¥é‡ä¸å…è®¸åŒä¸€ä¸ªçº¿ç¨‹å¤šæ¬¡é”å®šï¼‰ï¼Œåˆ™ç¡®å®å¯èƒ½äº§ç”Ÿæ­»é”ã€‚ä½†æ˜¯ï¼Œå¯¹äº std::recursive_mutex å’Œ std::recursive_timed_mutexï¼ŒåŒä¸€ä¸ªçº¿ç¨‹å¯ä»¥å¤šæ¬¡é”å®šäº’æ–¥é‡è€Œä¸ä¼šå¯¼è‡´æ­»é”ï¼Œå› ä¸ºè¿™äº›äº’æ–¥é‡è¢«è®¾è®¡ä¸ºæ”¯æŒé€’å½’é”å®šã€‚

çº¿ç¨‹å‡½æ•°è°ƒç”¨try_lock()æ—¶ï¼Œå¯èƒ½ä¼šå‘ç”Ÿä»¥ä¸‹ä¸‰ç§æƒ…å†µï¼š

* å¦‚æœå½“å‰äº’æ–¥é‡æ²¡æœ‰è¢«å…¶ä»–çº¿ç¨‹å æœ‰ï¼Œåˆ™è¯¥çº¿ç¨‹é”ä½äº’æ–¥é‡ï¼Œç›´åˆ°è¯¥çº¿ç¨‹è°ƒç”¨ unlock é‡Šæ”¾äº’æ–¥é‡
* å¦‚æœå½“å‰äº’æ–¥é‡è¢«å…¶ä»–çº¿ç¨‹é”ä½ï¼Œåˆ™å½“å‰è°ƒç”¨çº¿ç¨‹è¿”å› falseï¼Œè€Œå¹¶ä¸ä¼šè¢«é˜»å¡æ‰
* å¦‚æœå½“å‰äº’æ–¥é‡è¢«å½“å‰è°ƒç”¨çº¿ç¨‹é”ä½ï¼Œåˆ™ä¼šäº§ç”Ÿæ­»é”(deadlock)ï¼Œä½†æ˜¯ï¼Œå¯¹äº std::recursive_mutex å’Œ std::recursive_timed_mutexï¼ŒåŒä¸€ä¸ªçº¿ç¨‹å¯ä»¥å¤šæ¬¡é”å®šäº’æ–¥é‡è€Œä¸ä¼šå¯¼è‡´æ­»é”ï¼Œå› ä¸ºè¿™äº›äº’æ–¥é‡è¢«è®¾è®¡ä¸ºæ”¯æŒé€’å½’é”å®šã€‚

2. **std::recursive_mutex**

å…¶å…è®¸åŒä¸€ä¸ªçº¿ç¨‹å¯¹äº’æ–¥é‡å¤šæ¬¡ä¸Šé”ï¼ˆå³
`é€’å½’ä¸Šé”`
ï¼‰ï¼Œæ¥è·å¾—å¯¹äº’æ–¥é‡å¯¹è±¡çš„å¤šå±‚æ‰€æœ‰æƒï¼Œé‡Šæ”¾äº’æ–¥é‡æ—¶éœ€è¦è°ƒç”¨ä¸è¯¥é”å±‚æ¬¡æ·±åº¦ç›¸åŒæ¬¡æ•°çš„ unlock()ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œstd::recursive_mutex çš„ç‰¹æ€§å’Œ std::mutex å¤§è‡´ç›¸åŒã€‚

```cpp
int x = 0;

recursive_mutex mtx;

void Print(int n){
	mtx.lock();
	for (int i = 0; i < n; i++)
	{
		x++;
	}
	mtx.unlock();
}
int main()
{
	thread t1(Print, 100000);
	thread t2(Print, 200000);

	t1.join();
	t2.join();

	cout << x << endl;
	return 0;
}

```

***recursive_mutexè§£å†³çš„é—®é¢˜***

æ”¯æŒé€’å½’è°ƒç”¨

* åœ¨é€’å½’å‡½æ•°æˆ–å¤šå±‚åµŒå¥—å‡½æ•°ä¸­ï¼Œå¦‚æœéœ€è¦å¯¹åŒä¸€ä¸ªäº’æ–¥é”è¿›è¡Œå¤šæ¬¡åŠ é”å’Œè§£é”æ“ä½œï¼Œä½¿ç”¨æ™®é€šçš„äº’æ–¥é”ï¼ˆå¦‚std::mutexï¼‰å¯èƒ½ä¼šå¯¼è‡´æ­»é”æˆ–æœªå®šä¹‰è¡Œä¸ºï¼Œå› ä¸ºæ™®é€šäº’æ–¥é”ä¸å…è®¸åŒä¸€ä¸ªçº¿ç¨‹å¤šæ¬¡é”å®šã€‚
* recursive_mutexåˆ™å…è®¸åŒä¸€ä¸ªçº¿ç¨‹å¤šæ¬¡è·å–åŒä¸€ä¸ªé”è€Œä¸ä¼šå¯¼è‡´æ­»é”ï¼Œå› ä¸ºå®ƒå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªè®¡æ•°å™¨ï¼Œæ¯æ¬¡è·å–é”æ—¶è®¡æ•°å™¨åŠ 1ï¼Œé‡Šæ”¾é”æ—¶è®¡æ•°å™¨å‡1ï¼Œåªæœ‰å½“è®¡æ•°å™¨å½’é›¶æ—¶é”æ‰ä¼šçœŸæ­£é‡Šæ”¾ã€‚

3. **std::timed_mutex**
     
   timed_mutexæ¯” std::mutex å¤šäº†ä¸¤ä¸ªæˆå‘˜å‡½æ•°ï¼Œtry_lock_for()ï¼Œtry_lock_until() ã€‚

**try_lock_for()**

* åŠŸèƒ½ï¼šå°è¯•åœ¨ç»™å®šçš„æ—¶é—´æ®µå†…è·å–é”ã€‚
* å‚æ•°ï¼šæ¥å—ä¸€ä¸ªè¡¨ç¤ºæ—¶é—´èŒƒå›´çš„
  `std::chrono::duration`
  å¯¹è±¡ã€‚
* è¡Œä¸ºï¼š
  + å¦‚æœåœ¨æŒ‡å®šæ—¶é—´å†…é”è¢«æˆåŠŸè·å–ï¼Œåˆ™è¿”å› trueã€‚
  + å¦‚æœåœ¨æŒ‡å®šæ—¶é—´å†…é”æ²¡æœ‰è¢«è·å–ï¼ˆå³è¶…æ—¶ï¼‰ï¼Œåˆ™è¿”å› falseã€‚
  + åœ¨ç­‰å¾…æœŸé—´ï¼Œå¦‚æœå…¶ä»–çº¿ç¨‹é‡Šæ”¾äº†é”ï¼Œåˆ™å½“å‰çº¿ç¨‹å¯èƒ½ä¼šè·å–è¯¥é”ã€‚

**try_lock_until()**

* åŠŸèƒ½ï¼šå°è¯•åœ¨æŒ‡å®šçš„æ—¶é—´ç‚¹ä¹‹å‰è·å–é”ã€‚
* å‚æ•°ï¼šæ¥å—ä¸€ä¸ªè¡¨ç¤ºæ—¶é—´ç‚¹çš„
  `std::chrono::time_point`
  å¯¹è±¡ã€‚
* è¡Œä¸ºï¼š
  + å¦‚æœåœ¨æŒ‡å®šæ—¶é—´ç‚¹ä¹‹å‰é”è¢«æˆåŠŸè·å–ï¼Œåˆ™è¿”å› trueã€‚
  + å¦‚æœåœ¨æŒ‡å®šæ—¶é—´ç‚¹åˆ°è¾¾æ—¶é”è¿˜æ²¡æœ‰è¢«è·å–ï¼Œåˆ™è¿”å› falseã€‚
  + ä¸ try_lock_for() ç±»ä¼¼ï¼Œåœ¨ç­‰å¾…æœŸé—´ï¼Œå¦‚æœå…¶ä»–çº¿ç¨‹é‡Šæ”¾äº†é”ï¼Œåˆ™å½“å‰çº¿ç¨‹å¯èƒ½ä¼šè·å–è¯¥é”ã€‚

```cpp
#include <iostream>
#include <thread>
#include <chrono>
#include <mutex>

std::timed_mutex mtx;

void try_lock_example() {
    auto timeout = std::chrono::milliseconds(1000); // 1ç§’è¶…æ—¶
    // å°è¯•åœ¨1ç§’å†…è·å–é”
    if (mtx.try_lock_for(timeout)) {
        //.........
        //........ æ¨¡æ‹Ÿä¸€äº›å·¥ä½œ
        mtx.unlock();
    }
    else {
        //.........
    }
}
void try_lock_until_example() {
    auto now = std::chrono::steady_clock::now();
    auto timeout_point = now + std::chrono::milliseconds(1000); // 1ç§’åè¶…æ—¶

    // å°è¯•åœ¨æŒ‡å®šæ—¶é—´ç‚¹ä¹‹å‰è·å–é”
    if (mtx.try_lock_until(timeout_point)) {
        //........... æ¨¡æ‹Ÿä¸€äº›å·¥ä½œ
        mtx.unlock();
    }
    else {
    //.......   
    }
}

int main() {
    std::thread t1(try_lock_example);
    std::thread t2(try_lock_until_example);

    t1.join();
    t2.join();

    return 0;
}

```

4. **std::recursive_timed_mutex**
     
   äº†è§£ã€‚

#### `3.2 lock_guard`

**lock_guardçš„æ¨¡æ‹Ÿå®ç°**

```cpp
//lock_guardæ¨¡æ‹Ÿå®ç°
template<class Lock>
class LockGruad 
{
public:
	LockGruad(Lock& lk)
		:_lk(lk)
	{
		_lk.lock();
	}
	~LockGruad()
	{
		_lk.unlock();
	}
private:
	Lock _lk;
};

```

é€šè¿‡ä¸Šè¿°ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œlock_guardç±»æ¨¡æ¿ä¸»è¦æ˜¯é€šè¿‡RAIIçš„æ–¹å¼ï¼Œå¯¹å…¶ç®¡ç†çš„äº’æ–¥é‡è¿›è¡Œäº†å°è£…ï¼Œåœ¨éœ€è¦åŠ é”çš„åœ°æ–¹ï¼Œåªéœ€è¦ç”¨ä¸Šè¿°ä»‹ç»çš„ä»»æ„äº’æ–¥ä½“å®ä¾‹åŒ–ä¸€ä¸ªlock_guardï¼Œè°ƒç”¨æ„é€ å‡½æ•°æˆåŠŸä¸Šé”ï¼Œå‡ºä½œç”¨åŸŸå‰ï¼Œlock_guardå¯¹è±¡è¦è¢«é”€æ¯ï¼Œè°ƒç”¨ææ„å‡½æ•°è‡ªåŠ¨è§£é”ï¼Œå¯ä»¥æœ‰æ•ˆé¿å…æ­»é”é—®é¢˜ã€‚

å¯ä»¥ç”¨å±€éƒ¨åŸŸå»æ§åˆ¶é”çš„ç”Ÿå‘½å‘¨æœŸï¼›+
`{ }`
å³å¯
  
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/5a9c52613dd5493284270918fba87820.png)

`lock_guardçš„ç¼ºé™·`
ï¼šå¤ªå•ä¸€ï¼Œç”¨æˆ·æ²¡æœ‰åŠæ³•å¯¹è¯¥é”è¿›è¡Œæ§åˆ¶ï¼Œå› æ­¤C++11åˆæä¾›äº† unique_lockã€‚

#### `3.3 unique_lock`

ä¸lock_gardç±»ä¼¼ï¼Œunique_lockç±»æ¨¡æ¿ä¹Ÿæ˜¯é‡‡ç”¨RAIIçš„æ–¹å¼å¯¹é”è¿›è¡Œäº†å°è£…ï¼Œå¹¶ä¸”ä¹Ÿæ˜¯ä»¥ç‹¬å æ‰€æœ‰æƒçš„æ–¹å¼ç®¡ç†mutexå¯¹è±¡çš„ä¸Šé”å’Œè§£é”æ“ä½œï¼Œå³å…¶å¯¹è±¡ä¹‹é—´ä¸èƒ½å‘ç”Ÿæ‹·è´ã€‚åœ¨æ„é€ (æˆ–ç§»åŠ¨(move)èµ‹å€¼)æ—¶ï¼Œunique_lock å¯¹è±¡éœ€è¦ä¼ é€’ä¸€ä¸ª Mutex å¯¹è±¡ä½œä¸ºå®ƒçš„å‚æ•°ï¼Œæ–°åˆ›å»ºçš„
  
unique_lock å¯¹è±¡è´Ÿè´£ä¼ å…¥çš„ Mutex å¯¹è±¡çš„ä¸Šé”å’Œè§£é”æ“ä½œã€‚ä½¿ç”¨ä»¥ä¸Šç±»å‹äº’æ–¥é‡å®ä¾‹åŒ–unique_lockçš„å¯¹è±¡æ—¶ï¼Œè‡ªåŠ¨è°ƒç”¨æ„é€ å‡½æ•°ä¸Šé”ï¼Œunique_lockå¯¹è±¡é”€æ¯æ—¶è‡ªåŠ¨è°ƒç”¨ææ„å‡½æ•°è§£é”ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„é˜²æ­¢æ­»é”é—®é¢˜ã€‚

ä¸lock_guardä¸åŒçš„æ˜¯ï¼Œunique_lockæ›´åŠ çš„çµæ´»ï¼Œæä¾›äº†æ›´å¤šçš„æˆå‘˜å‡½æ•°ï¼š

* ä¸Šé”/è§£é”æ“ä½œï¼š
  `lock`
  ã€
  `try_lock`
  ã€
  `try_lock_for`
  ã€
  `try_lock_until`
  å’Œ
  `unlock`
* ä¿®æ”¹æ“ä½œï¼šç§»åŠ¨èµ‹å€¼ã€äº¤æ¢(
  `swap`
  ï¼‰ï¼šä¸å¦ä¸€ä¸ªunique_lockå¯¹è±¡äº’æ¢æ‰€ç®¡ç†çš„äº’æ–¥é‡æ‰€æœ‰æƒ)ã€é‡Šæ”¾(releaseï¼šè¿”å›å®ƒæ‰€ç®¡ç†çš„äº’æ–¥é‡å¯¹è±¡çš„æŒ‡é’ˆï¼Œå¹¶é‡Šæ”¾æ‰€æœ‰æƒ)
* è·å–å±æ€§ï¼šowns_lock(è¿”å›å½“å‰å¯¹è±¡æ˜¯å¦ä¸Šäº†é”)ã€operator bool()(ä¸owns_lock()çš„åŠŸèƒ½ç›¸åŒ)ã€mutex(è¿”å›å½“å‰unique_lockæ‰€ç®¡ç†çš„äº’æ–¥é‡çš„æŒ‡é’ˆ)ã€‚

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/1c159a9117af45609051fce6563d9bbf.png)

```cpp

void Print(int n){
	unique_lock<mutex> lk(mtx);
	for (int i = 0; i < n; i++)
	{
		lk.unlock();
		//.....
		//å‡è®¾è¿™é‡Œé¢æœ‰éƒ¨åˆ†ä»£ç æ˜¯ä¸éœ€è¦åŠ é”çš„ï¼Œå¦‚æœä½¿ç”¨çš„æ˜¯lock_guardå°±ä¸èƒ½å¾ˆå¥½çš„æ§åˆ¶
		//....
		lk.lock();
		
		x++;
	}
}
int main()
{
	thread t1(Print, 100000);
	thread t2(Print, 200000);

	t1.join();
	t2.join();

	cout << x << endl;
	return 0;
}


```

#### `4. æ¡ä»¶å˜é‡çš„ä½¿ç”¨ä»¥åŠé¢è¯•é¢˜`

**condition_variableçš„ä½¿ç”¨**

1. **æ„é€ **
     
   ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/e8a1c511fb3b4bf5acc0dd4a76e0454f.png)
2. **æˆå‘˜å‡½æ•°çš„ä½¿ç”¨**

**wait**

* åŠŸèƒ½ï¼šç­‰å¾…æ¡ä»¶å˜é‡è¢«é€šçŸ¥ã€‚
* ç”¨æ³•ï¼šé€šå¸¸ä¸ std::unique_lockstd::mutex æˆ– std::lock_guardstd::mutex ä¸€èµ·ä½¿ç”¨ï¼Œä»¥åœ¨ç­‰å¾…æœŸé—´é‡Šæ”¾äº’æ–¥é”ã€‚
* ç¤ºä¾‹ï¼š
  `cv.wait(lck);`
  å…¶ä¸­ cv æ˜¯æ¡ä»¶å˜é‡ï¼Œlck æ˜¯é”å¯¹è±¡ã€‚

**wait_for**

* åŠŸèƒ½ï¼šç­‰å¾…æ¡ä»¶å˜é‡è¢«é€šçŸ¥æˆ–ç›´åˆ°æŒ‡å®šçš„è¶…æ—¶æ—¶é—´åˆ°è¾¾ã€‚
* ç”¨æ³•ï¼šæ¥å—ä¸€ä¸ªè¡¨ç¤ºè¶…æ—¶æ—¶é—´çš„ std::chrono::duration å¯¹è±¡ã€‚
* è¿”å›å€¼ï¼šå¦‚æœå› ä¸ºè¶…æ—¶è€Œè¿”å›ï¼Œåˆ™è¿”å›ä¸€ä¸ª std::cv_status æšä¸¾å€¼ï¼ŒæŒ‡ç¤ºç­‰å¾…æ˜¯å¦å› ä¸ºè¶…æ—¶ï¼ˆstd::cv_status::timeoutï¼‰æˆ–å…¶ä»–åŸå› ï¼ˆå¦‚è¢«é€šçŸ¥ï¼‰è€Œç»“æŸã€‚
* ç¤ºä¾‹ï¼š
  `std::cv_status status = cv.wait_for(lck, std::chrono::seconds(1));`

**wait_until**

* åŠŸèƒ½ï¼šç­‰å¾…æ¡ä»¶å˜é‡è¢«é€šçŸ¥æˆ–ç›´åˆ°æŒ‡å®šçš„æ—¶é—´ç‚¹åˆ°è¾¾ã€‚
* ç”¨æ³•ï¼šæ¥å—ä¸€ä¸ªè¡¨ç¤ºç»å¯¹æ—¶é—´ç‚¹çš„ std::chrono::time_point å¯¹è±¡ã€‚
* è¿”å›å€¼ï¼šä¸ wait_for ç±»ä¼¼ï¼Œè¿”å›ä¸€ä¸ª std::cv_status æšä¸¾å€¼ã€‚
* ç¤ºä¾‹ï¼šauto timeout = std::chrono::steady_clock::now() + std::chrono::seconds(1); std::cv_status status = cv.wait_until(lck, timeout);

**notify_one**

* åŠŸèƒ½ï¼šé€šçŸ¥ä¸€ä¸ªç­‰å¾…è¯¥æ¡ä»¶å˜é‡çš„çº¿ç¨‹ã€‚
* ç”¨æ³•ï¼šå¦‚æœæœ‰å¤šä¸ªçº¿ç¨‹åœ¨ç­‰å¾…ï¼Œåˆ™é€‰æ‹©å…¶ä¸­ä¸€ä¸ªè¿›è¡Œé€šçŸ¥ï¼ˆå…·ä½“é€‰æ‹©å“ªä¸ªçº¿ç¨‹æ˜¯æœªå®šä¹‰çš„ï¼‰ã€‚
* ç¤ºä¾‹ï¼š
  `cv.notify_one();`

**notify_all**

* åŠŸèƒ½ï¼šé€šçŸ¥æ‰€æœ‰ç­‰å¾…è¯¥æ¡ä»¶å˜é‡çš„çº¿ç¨‹ã€‚
* ç”¨æ³•ï¼šå”¤é†’æ‰€æœ‰ç­‰å¾…è¯¥æ¡ä»¶å˜é‡çš„çº¿ç¨‹ã€‚
* ç¤ºä¾‹ï¼š
  `cv.notify_all();`

***é¢è¯•é¢˜ç›®ï¼šæ”¯æŒä¸¤ä¸ªçº¿ç¨‹äº¤æ›¿æ‰“å°ï¼Œä¸€ä¸ªæ‰“å°å¥‡æ•°ï¼Œä¸€ä¸ªæ‰“å°å¶æ•°***

æœ¬èŠ‚ä¸»è¦æ¼”ç¤ºäº†condition_variableçš„ä½¿ç”¨ï¼Œcondition_variableç†Ÿæ‚‰æˆ‘ä»¬linuxè¯¾ç¨‹å·²ç»è®²è¿‡äº†ï¼Œä»–ä»¬
  
ç”¨æ¥è¿›è¡Œçº¿ç¨‹ä¹‹é—´çš„äº’ç›¸é€šçŸ¥ã€‚condition_variableå’ŒLinux posixçš„æ¡ä»¶å˜é‡å¹¶æ²¡æœ‰ä»€ä¹ˆå¤§çš„åŒºåˆ«ï¼Œä¸»
  
è¦è¿˜æ˜¯é¢å‘å¯¹è±¡å®ç°çš„ã€‚

```cpp
#include<iostream>
#include<thread>
#include<mutex>
#include<atomic>
#include <condition_variable>

using namespace std;


void two_thread_print()
{
	std::mutex mtx;
	condition_variable c;
	int n = 100;
	bool flag = true;
	thread t1([&]() {
		int i = 0;
		while (i < n)
		{
			unique_lock<mutex> lock(mtx);
			c.wait(lock, [&]()->bool {return flag; });
			cout << i << endl;
			flag = false;
			i += 2; // å¶æ•°
			c.notify_one();
		}
		});
	thread t2([&]() {
		int j = 1;
		while (j < n)
		{
			unique_lock<mutex> lock(mtx);
			c.wait(lock, [&]()->bool {return !flag; });
			cout << j << endl;
			j += 2; // å¥‡æ•°
			flag = true;
			c.notify_one();
		}
		});
	t1.join();
	t2.join();
}
int main()
{
	two_thread_print();
	return 0;
}


```

---