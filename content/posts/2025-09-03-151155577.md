---
layout: post
title: "RabbitMQ高级延迟消息"
date: 2025-09-03T20:59:12+0800
description: "其实就是如果支付服务确实不能通知交易服务去修改订单状态，那就让交易服务等30分钟，30分钟之后，如果交易服务还没有通知，就会主动去查支付服务，如果查到已支付，就更新订单状态，保证一致性。如果查到未支付，说明订单支付超时，直接取消订单。所以就需要一个延迟消息，要在下单那一刻发送，延迟一定时间后发给交易服务通知其去查支付服务。"
keywords: "RabbitMQ高级：延迟消息"
categories: ['未分类']
tags: ['分布式', 'Rabbitmq']
artid: "151155577"
arturl: "https://blog.csdn.net/2401_87663076/article/details/151155577"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=151155577
    alt: "RabbitMQ高级延迟消息"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=151155577
featuredImagePreview: https://bing.ee123.net/img/rand?artid=151155577
cover: https://bing.ee123.net/img/rand?artid=151155577
image: https://bing.ee123.net/img/rand?artid=151155577
img: https://bing.ee123.net/img/rand?artid=151155577
---



# RabbitMQ高级：延迟消息

## 什么是延迟消息

![](https://i-blog.csdnimg.cn/direct/4d73b3a30c41423da01e7d665b163d80.png)

        其实就是如果支付服务确实不能通知交易服务去修改订单状态，那就让交易服务等30分钟，30分钟之后，如果交易服务还没有通知，就会主动去查支付服务，如果查到已支付，就更新订单状态，保证一致性。如果查到未支付，说明订单支付超时，直接取消订单。所以就需要一个延迟消息，要在下单那一刻发送，延迟一定时间后发给交易服务通知其去查支付服务。

## 死信交换机

![](https://i-blog.csdnimg.cn/direct/53b359bcde1c4eddb2707ac0be2fb9f0.png)

        利用了成为死信的第二个条件，过期消息。也就是publisher发送一个设置了TTL的消息到normal.queue，然后这个队列通过dead-letter-exchange属性指定了dlx.direct交换机，由于normal.queue没有消费者，所以这个消息在MQ里TTL过期之后，就会投递到dlx.direct，从而投递到consumer，实现了延迟消息。注意这里normal的交换机和队列的BindingKey要和dlx的交换机和队列的BindingKey一致，不然消息传不过去。

![](https://i-blog.csdnimg.cn/direct/61b9be6c1ddf4e919e33dfb562f6e985.png)

        这是声明一个绑定了死信交换机的队列，也就是normal.queue。

```

@Test
void testSendDelayMessage() {
    rabbitTemplate.convertAndSend("normal.direct", "hi", "hello", new MessagePostProcessor() {
        @Override
        public Message postProcessMessage(Message message) throws AmqpException {
            message.getMessageProperties().setExpiration("10000");
            return message;
        }
    });
}

```

        这个是发送带TTL消息的代码，convertAndSend方法最后还可以带一个参数，叫做消息后置处理器，可以在Java对象转换为消息对象之后，对消息做处理。需要实现postProcessMessage方法，这个方法的形参就是转换后的消息，可以给它设置参数。

## 延迟消息插件

![](https://i-blog.csdnimg.cn/direct/d0784468bb7a4e2e94e320937799dfc2.png)

        给RabbitMQ装了插件之后，就是设置个delayed属性，这个交换机就有了延迟消息的功能。

![](https://i-blog.csdnimg.cn/direct/1f5ae039ba314b9bbbedef44615bc9ba.png)

        发消息也不一样了，变成setDelay了。

## 取消超时订单

![](https://i-blog.csdnimg.cn/direct/1ea2aa0d052b4786bec702197a66b902.png)

        这里是假设最坏情况，支付服务无法向MQ发送消息。

![](https://i-blog.csdnimg.cn/direct/ed8dcbaae8b844ab9b9f11a95685de4a.png)

        为啥要先查询本地订单状态呢，这是因为，如果本地订单状态是已支付，说明支付服务成功通知到交易服务了。交易服务自己发自己收。



