---
layout: post
title: "FFmpeg入门最简单的音视频播放器"
date: 2025-03-05 21:00:52 +0800
description: "终于做完了，恭喜你，完成了一个非常粗糙，而且有很多问题的简单音视频播放器。接下来几期，我们跟着大家一起对这个简单的播放器进行优化。当然我也是个小萌新，所以一步一步来嘛哈哈。时钟同步怎么做如何边读出packet，边解码frame并播放我们如何对输出的解码帧进行转化ps. 鼓励大家阅读ffplay源码，所有的问题都能迎刃而解，哈哈哈！"
keywords: "ffmpeg视频播放器"
categories: ['未分类']
tags: ['音视频', 'Ffmpeg']
artid: "145999242"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=145999242
    alt: "FFmpeg入门最简单的音视频播放器"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=145999242
featuredImagePreview: https://bing.ee123.net/img/rand?artid=145999242
cover: https://bing.ee123.net/img/rand?artid=145999242
image: https://bing.ee123.net/img/rand?artid=145999242
img: https://bing.ee123.net/img/rand?artid=145999242
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     FFmpeg入门：最简单的音视频播放器
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="FFmpeg_0">
     </a>
     FFmpeg入门：最简单的音视频播放器
    </h2>
    <p>
     前两章，我们已经了解了分别如何构建一个简单和音频播放器和视频播放器。
     <br/>
     <a href="https://blog.csdn.net/m0_51433562/article/details/145955498?spm=1001.2014.3001.5502">
      FFmpeg入门：最简单的音频播放器
     </a>
     <br/>
     <a href="https://blog.csdn.net/m0_51433562/article/details/145927660?spm=1001.2014.3001.5502">
      FFmpeg入门：最简单的视频播放器
     </a>
    </p>
    <p>
     本章我们将结合上述两章的知识，看看如何融合成一个完整的音视频播放器，跟上我的节奏，本章将是咱们后续完成一个完整的音视频播放器的起点。
    </p>
    <h3>
     <a id="_7">
     </a>
     整体流程图
    </h3>
    <p>
     话不多说，先上图
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/dbb3c83bad534e0fa8d71b8789126fc6.png">
      <br/>
      这个图似乎有点复杂了，这里我会分别将每个模块拿出来讲述，方便大家一步一步分析整个流程。
     </img>
    </p>
    <h3>
     <a id="_11">
     </a>
     第一步：初始化
    </h3>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/4d6dad52c9de4492869a2859a5e26444.png">
      <br/>
      我们首先关注整个流程图的最上面一部分，这部分其实和之前的流程一样，主要就是将做一些前置的初始化工作：
     </img>
    </p>
    <blockquote>
     <p>
      1：打开文件，获取文件上下文
      <br/>
      2：找到对应的音频/视频流，获取到Codec上下文
      <br/>
      3：打开解码器
      <br/>
      4：分配输出空间缓存，用于后续存储解码的输出数据
      <br/>
      5：音频/视频帧的格式转化上下文
      <br/>
      6：初始化SDL组件，主要是视频的播放窗口和音频播放器
     </p>
    </blockquote>
    <p>
     代码（
     <em>
      省略了部分校验和参数初始化，方便阅读，原码见文章末尾
     </em>
     ）：
    </p>
    <pre><code class="prism language-c">	<span class="token comment">/** 初始化函数 */</span>
	<span class="token function">init_video_state</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>video_state<span class="token punctuation">)</span><span class="token punctuation">;</span>
	audio_param <span class="token operator">=</span> video_state<span class="token operator">-&gt;</span>audioParam<span class="token punctuation">;</span>
	video_param <span class="token operator">=</span> video_state<span class="token operator">-&gt;</span>videoParam<span class="token punctuation">;</span>
	
	<span class="token function">avformat_network_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 1. 打开视频文件，获取格式上下文</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">avformat_open_input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>video_state<span class="token operator">-&gt;</span>formatCtx<span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Couldn't open input stream.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token comment">// 2. 对文件探测流信息</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">avformat_find_stream_info</span><span class="token punctuation">(</span>video_state<span class="token operator">-&gt;</span>formatCtx<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Couldn't find stream information.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token comment">// 3. 找到对应的 音频流/视频流 索引</span>
	video_state<span class="token operator">-&gt;</span>audioStream<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	video_state<span class="token operator">-&gt;</span>videoStream<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> video_state<span class="token operator">-&gt;</span>formatCtx<span class="token operator">-&gt;</span>nb_streams<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>video_state<span class="token operator">-&gt;</span>formatCtx<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>codec_type<span class="token operator">==</span>AVMEDIA_TYPE_AUDIO<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
			video_state<span class="token operator">-&gt;</span>audioStream<span class="token operator">=</span>i<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>video_state<span class="token operator">-&gt;</span>formatCtx<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>codec_type<span class="token operator">==</span>AVMEDIA_TYPE_VIDEO<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			video_state<span class="token operator">-&gt;</span>videoStream<span class="token operator">=</span>i<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	
	<span class="token comment">// 4. 将 音频流/视频流 编码参数写入上下文</span>
	AVCodecParameters<span class="token operator">*</span> aCodecParam <span class="token operator">=</span> video_state<span class="token operator">-&gt;</span>formatCtx<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>video_state<span class="token operator">-&gt;</span>audioStream<span class="token punctuation">]</span><span class="token operator">-&gt;</span>codecpar<span class="token punctuation">;</span>
	<span class="token function">avcodec_parameters_to_context</span><span class="token punctuation">(</span>video_state<span class="token operator">-&gt;</span>aCodecCtx<span class="token punctuation">,</span> aCodecParam<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	AVCodecParameters<span class="token operator">*</span> vCodecParam <span class="token operator">=</span> video_state<span class="token operator">-&gt;</span>formatCtx<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>video_state<span class="token operator">-&gt;</span>videoStream<span class="token punctuation">]</span><span class="token operator">-&gt;</span>codecpar<span class="token punctuation">;</span>
	<span class="token function">avcodec_parameters_to_context</span><span class="token punctuation">(</span>video_state<span class="token operator">-&gt;</span>vCodecCtx<span class="token punctuation">,</span> vCodecParam<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">// 5. 查找流的编码器</span>
	video_state<span class="token operator">-&gt;</span>aCodec <span class="token operator">=</span> <span class="token function">avcodec_find_decoder</span><span class="token punctuation">(</span>video_state<span class="token operator">-&gt;</span>aCodecCtx<span class="token operator">-&gt;</span>codec_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
	video_state<span class="token operator">-&gt;</span>vCodec <span class="token operator">=</span> <span class="token function">avcodec_find_decoder</span><span class="token punctuation">(</span>video_state<span class="token operator">-&gt;</span>vCodecCtx<span class="token operator">-&gt;</span>codec_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">// 6. 打开流的编解码器</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">avcodec_open2</span><span class="token punctuation">(</span>video_state<span class="token operator">-&gt;</span>aCodecCtx<span class="token punctuation">,</span> video_state<span class="token operator">-&gt;</span>aCodec<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Could not open audio codec.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">avcodec_open2</span><span class="token punctuation">(</span>video_state<span class="token operator">-&gt;</span>vCodecCtx<span class="token punctuation">,</span> video_state<span class="token operator">-&gt;</span>vCodec<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Could not open video codec.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token comment">/** 音频输出信息构建 */</span>
	<span class="token function">audio_output_set</span><span class="token punctuation">(</span>video_state<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/** 视频输出信息构建 */</span>
	<span class="token function">video_output_set</span><span class="token punctuation">(</span>video_state<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	
	<span class="token comment">//	SDL 初始化</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">USE_SDL</span></span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">SDL_Init</span><span class="token punctuation">(</span>SDL_INIT_VIDEO <span class="token operator">|</span> SDL_INIT_AUDIO <span class="token operator">|</span> SDL_INIT_TIMER<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span> <span class="token string">"Could not initialize SDL - %s\n"</span><span class="token punctuation">,</span> <span class="token function">SDL_GetError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token comment">/** 初始化音频SDL设备 */</span>
	SDL_AudioSpec wanted_spec<span class="token punctuation">;</span>
	wanted_spec<span class="token punctuation">.</span>freq <span class="token operator">=</span> audio_param<span class="token operator">-&gt;</span>out_sample_rate<span class="token punctuation">;</span>					<span class="token comment">// 采样率</span>
	wanted_spec<span class="token punctuation">.</span>format <span class="token operator">=</span> AUDIO_S16SYS<span class="token punctuation">;</span>									<span class="token comment">// 采样格式 16bit</span>
	wanted_spec<span class="token punctuation">.</span>channels <span class="token operator">=</span> audio_param<span class="token operator">-&gt;</span>out_channels<span class="token punctuation">;</span>					<span class="token comment">// 通道数</span>
	wanted_spec<span class="token punctuation">.</span>silence <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	wanted_spec<span class="token punctuation">.</span>samples <span class="token operator">=</span> audio_param<span class="token operator">-&gt;</span>out_nb_samples<span class="token punctuation">;</span>					<span class="token comment">// 单帧处理的采样点</span>
	wanted_spec<span class="token punctuation">.</span>callback <span class="token operator">=</span> fill_audio<span class="token punctuation">;</span>									<span class="token comment">// 回调函数</span>
	wanted_spec<span class="token punctuation">.</span>userdata <span class="token operator">=</span> video_state<span class="token operator">-&gt;</span>aCodecCtx<span class="token punctuation">;</span>						<span class="token comment">// 回调函数的参数</span>
	
	<span class="token comment">/** 初始化视频SDL设备 */</span>
	SDL_Window<span class="token operator">*</span>       window <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	SDL_Renderer<span class="token operator">*</span>     renderer <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	SDL_Texture<span class="token operator">*</span>      texture<span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token comment">/** 窗口 */</span>
	window <span class="token operator">=</span> <span class="token function">SDL_CreateWindow</span><span class="token punctuation">(</span><span class="token string">"SDL2 window"</span><span class="token punctuation">,</span>
							  SDL_WINDOWPOS_CENTERED<span class="token punctuation">,</span>
							  SDL_WINDOWPOS_CENTERED<span class="token punctuation">,</span>
							  video_state<span class="token operator">-&gt;</span>vCodecCtx<span class="token operator">-&gt;</span>width<span class="token punctuation">,</span>
							  video_state<span class="token operator">-&gt;</span>vCodecCtx<span class="token operator">-&gt;</span>height<span class="token punctuation">,</span>
							  SDL_WINDOW_SHOWN<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/** 渲染 */</span>
	renderer <span class="token operator">=</span> <span class="token function">SDL_CreateRenderer</span><span class="token punctuation">(</span>window<span class="token punctuation">,</span>
								  <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
								  SDL_RENDERER_ACCELERATED <span class="token operator">|</span> SDL_RENDERER_PRESENTVSYNC<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/** 纹理 */</span>
	texture <span class="token operator">=</span> <span class="token function">SDL_CreateTexture</span><span class="token punctuation">(</span>renderer<span class="token punctuation">,</span>
								SDL_PIXELFORMAT_YV12<span class="token punctuation">,</span>
								SDL_TEXTUREACCESS_STREAMING<span class="token punctuation">,</span>
								video_state<span class="token operator">-&gt;</span>vCodecCtx<span class="token operator">-&gt;</span>width<span class="token punctuation">,</span>
								video_state<span class="token operator">-&gt;</span>vCodecCtx<span class="token operator">-&gt;</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">// 打开音频播放器</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">SDL_OpenAudio</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wanted_spec<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"can't open audio.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	
	<span class="token comment">// 音频上下文格式转换</span>
	<span class="token function">swr_alloc_set_opts2</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>video_state<span class="token operator">-&gt;</span>swrCtx<span class="token punctuation">,</span>
						<span class="token operator">&amp;</span>audio_param<span class="token operator">-&gt;</span>out_channel_layout<span class="token punctuation">,</span>			<span class="token comment">// 输出layout</span>
						audio_param<span class="token operator">-&gt;</span>out_sample_fmt<span class="token punctuation">,</span>				<span class="token comment">// 输出格式</span>
						audio_param<span class="token operator">-&gt;</span>out_sample_rate<span class="token punctuation">,</span>				<span class="token comment">// 输出采样率</span>
						<span class="token operator">&amp;</span>video_state<span class="token operator">-&gt;</span>aCodecCtx<span class="token operator">-&gt;</span>ch_layout<span class="token punctuation">,</span>			<span class="token comment">// 输入layout</span>
						video_state<span class="token operator">-&gt;</span>aCodecCtx<span class="token operator">-&gt;</span>sample_fmt<span class="token punctuation">,</span>			<span class="token comment">// 输入格式</span>
						video_state<span class="token operator">-&gt;</span>aCodecCtx<span class="token operator">-&gt;</span>sample_rate<span class="token punctuation">,</span>		<span class="token comment">// 输入采样率</span>
						<span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">swr_init</span><span class="token punctuation">(</span>video_state<span class="token operator">-&gt;</span>swrCtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">// 视频上下文格式转换</span>
	video_state<span class="token operator">-&gt;</span>swsCtx <span class="token operator">=</span> <span class="token function">sws_getContext</span><span class="token punctuation">(</span>video_state<span class="token operator">-&gt;</span>vCodecCtx<span class="token operator">-&gt;</span>width<span class="token punctuation">,</span>			<span class="token comment">// src 宽</span>
										 video_state<span class="token operator">-&gt;</span>vCodecCtx<span class="token operator">-&gt;</span>height<span class="token punctuation">,</span>		<span class="token comment">// src 高</span>
										 video_state<span class="token operator">-&gt;</span>vCodecCtx<span class="token operator">-&gt;</span>pix_fmt<span class="token punctuation">,</span>		<span class="token comment">// src 格式</span>
										 video_param<span class="token operator">-&gt;</span>width<span class="token punctuation">,</span>					<span class="token comment">// dst 宽</span>
										 video_param<span class="token operator">-&gt;</span>height<span class="token punctuation">,</span>					<span class="token comment">// dst 高</span>
										 video_param<span class="token operator">-&gt;</span>pix_fmt<span class="token punctuation">,</span>					<span class="token comment">// dst 格式</span>
										 SWS_BILINEAR<span class="token punctuation">,</span>
										 <span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">// 开始播放</span>
	<span class="token function">SDL_PauseAudio</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <h3>
     <a id="packet_152">
     </a>
     第二步：packet队列写入
    </h3>
    <p>
     做完准备工作之后，我们就将源文件中的输入packet都取出来，放入到对应的音频packet队列和视频packet队列中，方便后续使用。然后然后分别启动音频解码进程和视频解码进程同时进行解码。
    </p>
    <blockquote>
     <ol>
      <li>
       读出packet，判断packet类型
      </li>
      <li>
       根据类型放入音频和视频packet队列
      </li>
      <li>
       创建解码进程
      </li>
     </ol>
    </blockquote>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/0e10b14a03e0479680a5aab21fbc7a4e.png"/>
    </p>
    <pre><code class="prism language-c"><span class="token comment">// 循环1: 从文件中读取packet</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">av_read_frame</span><span class="token punctuation">(</span>video_state<span class="token operator">-&gt;</span>formatCtx<span class="token punctuation">,</span> packet<span class="token punctuation">)</span><span class="token operator">&gt;=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token comment">/** 写入音频pkt队列 */</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>packet<span class="token operator">-&gt;</span>stream_index<span class="token operator">==</span>video_state<span class="token operator">-&gt;</span>audioStream<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
			<span class="token function">packet_queue_push</span><span class="token punctuation">(</span>video_state<span class="token operator">-&gt;</span>aQueue<span class="token punctuation">,</span> packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">/** 写入视频pkt队列 */</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>packet<span class="token operator">-&gt;</span>stream_index<span class="token operator">==</span>video_state<span class="token operator">-&gt;</span>videoStream<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">packet_queue_push</span><span class="token punctuation">(</span>video_state<span class="token operator">-&gt;</span>vQueue<span class="token punctuation">,</span> packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token function">av_packet_unref</span><span class="token punctuation">(</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">SDL_PollEvent</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">switch</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">case</span> SDL_QUIT<span class="token operator">:</span>
				<span class="token function">SDL_Quit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">default</span><span class="token operator">:</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"audio queue.size=%d\n"</span><span class="token punctuation">,</span> video_state<span class="token operator">-&gt;</span>aQueue<span class="token operator">-&gt;</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">// 创建一个线程并启动</span>
	<span class="token function">SDL_CreateThread</span><span class="token punctuation">(</span>audio_thread<span class="token punctuation">,</span> <span class="token string">"audio_thread"</span><span class="token punctuation">,</span> video_state<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">SDL_CreateThread</span><span class="token punctuation">(</span>video_thread<span class="token punctuation">,</span> <span class="token string">"video_thread"</span><span class="token punctuation">,</span> video_state<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <h3>
     <a id="_189">
     </a>
     第三步：音频解码+播放
    </h3>
    <p>
     接下来会分别讲一下音频和视频解码进程，这两个进程是同时开始的。
    </p>
    <p>
     首先音频解码进程的步骤可以参考之前的音频播放器文章。我简单说一下步骤
    </p>
    <blockquote>
     <ol>
      <li>
       从音频packet队列中取出packet
      </li>
      <li>
       对packet进行解码得到frame
      </li>
      <li>
       按音频输出格式进行swr_convert转换得到输出值，并写入buffer。
      </li>
      <li>
       SDL音频播放器通过回调函数从buffer不断读取数据播放。
      </li>
     </ol>
    </blockquote>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/df08653a18de46d1ad4397a3941a43d3.png">
      <br/>
      代码如下：
     </img>
    </p>
    <pre><code class="prism language-c"><span class="token comment">/**
 音频线程
 */</span>
<span class="token keyword">int</span> <span class="token function">audio_thread</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">/**
	 1. 从packet_queue队列中取出packet
	 2. 将packet进行解码
	 3. 写入到sdl的缓冲区中
	 */</span> 	VideoState<span class="token operator">*</span> video_state <span class="token operator">=</span> <span class="token punctuation">(</span>VideoState<span class="token operator">*</span><span class="token punctuation">)</span> arg<span class="token punctuation">;</span>
	AudioParam<span class="token operator">*</span> audio_param <span class="token operator">=</span> video_state<span class="token operator">-&gt;</span>audioParam<span class="token punctuation">;</span>
	PacketQueue<span class="token operator">*</span> queue <span class="token operator">=</span> video_state<span class="token operator">-&gt;</span>aQueue<span class="token punctuation">;</span>
	audio_param<span class="token operator">-&gt;</span>index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	
	AVRational time_base <span class="token operator">=</span> video_state<span class="token operator">-&gt;</span>formatCtx<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>video_state<span class="token operator">-&gt;</span>audioStream<span class="token punctuation">]</span><span class="token operator">-&gt;</span>time_base<span class="token punctuation">;</span>
	<span class="token class-name">int64_t</span> av_start_time <span class="token operator">=</span> <span class="token function">av_gettime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>								<span class="token comment">// 播放开始时间戳</span>
	
	AVPacket 	packet<span class="token punctuation">;</span>
	<span class="token keyword">int</span> 		ret<span class="token punctuation">;</span>
	AVFrame<span class="token operator">*</span> 	pFrame <span class="token operator">=</span> <span class="token function">av_frame_alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>queue<span class="token operator">-&gt;</span>size <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			
			<span class="token function">packet_queue_pop</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> <span class="token operator">&amp;</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// 将packet写入编解码器</span>
			ret <span class="token operator">=</span> <span class="token function">avcodec_send_packet</span><span class="token punctuation">(</span>video_state<span class="token operator">-&gt;</span>aCodecCtx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
			
			<span class="token comment">// 获取解码后的帧</span>
			<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">avcodec_receive_frame</span><span class="token punctuation">(</span>video_state<span class="token operator">-&gt;</span>aCodecCtx<span class="token punctuation">,</span> pFrame<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token comment">// 格式转化</span>
				<span class="token function">swr_convert</span><span class="token punctuation">(</span>video_state<span class="token operator">-&gt;</span>swrCtx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>audio_param<span class="token operator">-&gt;</span>out_buffer<span class="token punctuation">,</span> audio_param<span class="token operator">-&gt;</span>out_buffer_size<span class="token punctuation">,</span>
							<span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span>pFrame<span class="token operator">-&gt;</span>data<span class="token punctuation">,</span> pFrame<span class="token operator">-&gt;</span>nb_samples<span class="token punctuation">)</span><span class="token punctuation">;</span>
				audio_param<span class="token operator">-&gt;</span>index<span class="token operator">++</span><span class="token punctuation">;</span>
				<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"第%d帧 | pts:%lld | 帧大小(采样点):%d | 实际播放点%.2fs | 预期播放点%.2fs\n"</span><span class="token punctuation">,</span>
					   audio_param<span class="token operator">-&gt;</span>index<span class="token punctuation">,</span>
					   packet<span class="token punctuation">.</span>pts<span class="token punctuation">,</span>
					   packet<span class="token punctuation">.</span>size<span class="token punctuation">,</span>
					   <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">av_gettime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> av_start_time<span class="token punctuation">)</span><span class="token operator">/</span>AV_TIME_BASE<span class="token punctuation">,</span>
					   pFrame<span class="token operator">-&gt;</span>pts <span class="token operator">*</span> <span class="token function">av_q2d</span><span class="token punctuation">(</span>time_base<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">USE_SDL</span></span>
				<span class="token comment">// 设置读取的音频数据</span>
				audio_info<span class="token punctuation">.</span>audio_len <span class="token operator">=</span> audio_param<span class="token operator">-&gt;</span>out_buffer_size<span class="token punctuation">;</span>
				audio_info<span class="token punctuation">.</span>audio_pos <span class="token operator">=</span> <span class="token punctuation">(</span>Uint8 <span class="token operator">*</span><span class="token punctuation">)</span> audio_param<span class="token operator">-&gt;</span>out_buffer<span class="token punctuation">;</span>
				<span class="token comment">// 等待SDL播放完成</span>
				<span class="token keyword">while</span><span class="token punctuation">(</span>audio_info<span class="token punctuation">.</span>audio_len <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
					<span class="token function">SDL_Delay</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
			<span class="token punctuation">}</span>
			<span class="token function">av_packet_unref</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	
	<span class="token function">av_frame_free</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pFrame<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 结束</span>
	video_state<span class="token operator">-&gt;</span>isEnd <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="_264">
     </a>
     第四步：视频解码（子线程）+播放（主线程）
    </h3>
    <p>
     说视频的解码和播放之前，先提一点：
     <em>
      <strong>
       SDL的主窗口操作是需要在主线程中进行的。因此我们不能再解码子线程中直接渲染SDL窗口，否则会造成内存泄漏
      </strong>
     </em>
     。知道这个知识之后，更能理解接下来的流程分析。
    </p>
    <p>
     我们视频解码播放拆成两个部分：解码+播放
    </p>
    <blockquote>
     <p>
      第一部分：解码子线程，在子线程中完成解码，通过标识符的方式通知到主线程帧已更新，并渲染出来。
      <br/>
      第二部分：主线程播放，循环监听子线程的通知标识，并更新窗口帧进行显示。
     </p>
    </blockquote>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/4cb5aaa0eb164c6295297feb8b71d11b.png">
      <br/>
      代码如下：
     </img>
    </p>
    <p>
     视频解码子线程
    </p>
    <pre><code class="prism language-c"><span class="token comment">/**
 视频线程
 */</span>
<span class="token keyword">int</span> <span class="token function">video_thread</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">/**
	 1. 从视频pkt队列中读出packet
	 2. 送入解码器解码并取出
	 3. 使用SDL进行渲染
	 4. 根据pts计算延迟SDL_DELAY
	 */</span>
	VideoState<span class="token operator">*</span> 	video_state <span class="token operator">=</span> <span class="token punctuation">(</span>VideoState<span class="token operator">*</span><span class="token punctuation">)</span> arg<span class="token punctuation">;</span>
	PacketQueue<span class="token operator">*</span> 	video_queue <span class="token operator">=</span> video_state<span class="token operator">-&gt;</span>vQueue<span class="token punctuation">;</span>
	AVCodecContext<span class="token operator">*</span> pCodecCtx <span class="token operator">=</span> video_state<span class="token operator">-&gt;</span>vCodecCtx<span class="token punctuation">;</span>
	AVFrame<span class="token operator">*</span> 		out_frame <span class="token operator">=</span> video_state<span class="token operator">-&gt;</span>videoParam<span class="token operator">-&gt;</span>out_frame<span class="token punctuation">;</span>
	
	AVPacket packet<span class="token punctuation">;</span>
	AVFrame<span class="token operator">*</span> pFrame <span class="token operator">=</span> <span class="token function">av_frame_alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	AVRational time_base <span class="token operator">=</span> video_state<span class="token operator">-&gt;</span>formatCtx<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>video_state<span class="token operator">-&gt;</span>videoStream<span class="token punctuation">]</span><span class="token operator">-&gt;</span>time_base<span class="token punctuation">;</span>
	<span class="token class-name">int64_t</span> av_start_time <span class="token operator">=</span> <span class="token function">av_gettime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>							<span class="token comment">// 开始播放时间(ms*1000)</span>
	<span class="token class-name">int64_t</span> frame_delay <span class="token operator">=</span> <span class="token function">av_q2d</span><span class="token punctuation">(</span>time_base<span class="token punctuation">)</span> <span class="token operator">*</span> AV_TIME_BASE<span class="token punctuation">;</span>		<span class="token comment">// pts单位(ms*1000)</span>
	
	<span class="token class-name">int64_t</span> frame_start_time <span class="token operator">=</span> <span class="token function">av_gettime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>video_queue<span class="token operator">-&gt;</span>size <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">packet_queue_pop</span><span class="token punctuation">(</span>video_queue<span class="token punctuation">,</span> <span class="token operator">&amp;</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// 将packet写入编解码器</span>
			<span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">avcodec_send_packet</span><span class="token punctuation">(</span>pCodecCtx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// 从解码器中取出原始帧</span>
			<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">avcodec_receive_frame</span><span class="token punctuation">(</span>pCodecCtx<span class="token punctuation">,</span> pFrame<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token comment">// 帧格式转化，转为YUV420P</span>
				<span class="token function">sws_scale</span><span class="token punctuation">(</span>video_state<span class="token operator">-&gt;</span>swsCtx<span class="token punctuation">,</span>						<span class="token comment">// sws_context转换</span>
						  <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token keyword">const</span> <span class="token operator">*</span> <span class="token keyword">const</span> <span class="token operator">*</span><span class="token punctuation">)</span>pFrame<span class="token operator">-&gt;</span>data<span class="token punctuation">,</span>	<span class="token comment">// 输入 data</span>
						  pFrame<span class="token operator">-&gt;</span>linesize<span class="token punctuation">,</span>							<span class="token comment">// 输入 每行数据的大小（对齐）</span>
						  <span class="token number">0</span><span class="token punctuation">,</span>										<span class="token comment">// 输入 Y轴位置</span>
						  pCodecCtx<span class="token operator">-&gt;</span>height<span class="token punctuation">,</span>						<span class="token comment">// 输入 height</span>
						  out_frame<span class="token operator">-&gt;</span>data<span class="token punctuation">,</span>							<span class="token comment">// 输出 data</span>
						  out_frame<span class="token operator">-&gt;</span>linesize<span class="token punctuation">)</span><span class="token punctuation">;</span>						<span class="token comment">// 输出 linesize</span>
				
				<span class="token comment">// 帧更新</span>
				video_state<span class="token operator">-&gt;</span>videoParam<span class="token operator">-&gt;</span>frame_update <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
				
				<span class="token comment">// 计算延迟</span>
				<span class="token class-name">int64_t</span> pts <span class="token operator">=</span> pFrame<span class="token operator">-&gt;</span>pts<span class="token punctuation">;</span>											<span class="token comment">// pts</span>
				<span class="token class-name">int64_t</span> actual_playback_time <span class="token operator">=</span> av_start_time <span class="token operator">+</span> pts <span class="token operator">*</span> frame_delay<span class="token punctuation">;</span>	<span class="token comment">// 实际播放时间</span>
				<span class="token class-name">int64_t</span> current_time <span class="token operator">=</span> <span class="token function">av_gettime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>actual_playback_time <span class="token operator">&gt;</span> current_time<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					<span class="token function">SDL_Delay</span><span class="token punctuation">(</span><span class="token punctuation">(</span>Uint32<span class="token punctuation">)</span><span class="token punctuation">(</span>actual_playback_time<span class="token operator">-</span>current_time<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 延迟当前时间和实际播放时间</span>
				<span class="token punctuation">}</span>
				
				video_state<span class="token operator">-&gt;</span>videoParam<span class="token operator">-&gt;</span>index<span class="token operator">++</span><span class="token punctuation">;</span>
				<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"第%i帧 | 属于%s | pts为%d | 时长为%.2fms | 实际播放点为%.2fs | 预期播放点为%.2fs\n "</span><span class="token punctuation">,</span>
					   video_state<span class="token operator">-&gt;</span>videoParam<span class="token operator">-&gt;</span>index<span class="token punctuation">,</span>
					   <span class="token function">get_frame_type</span><span class="token punctuation">(</span>pFrame<span class="token punctuation">)</span><span class="token punctuation">,</span>
					   <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>pFrame<span class="token operator">-&gt;</span>pts<span class="token punctuation">,</span>
					   <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">av_gettime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> frame_start_time<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">1000</span><span class="token punctuation">,</span>
					   <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">av_gettime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> av_start_time<span class="token punctuation">)</span><span class="token operator">/</span>AV_TIME_BASE<span class="token punctuation">,</span>
					   pFrame<span class="token operator">-&gt;</span>pts <span class="token operator">*</span> <span class="token function">av_q2d</span><span class="token punctuation">(</span>time_base<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				
				frame_start_time <span class="token operator">=</span> <span class="token function">av_gettime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			
			<span class="token function">av_packet_unref</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	
	<span class="token function">av_frame_free</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pFrame<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 结束</span>
	video_state<span class="token operator">-&gt;</span>isEnd <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     渲染主线程
    </p>
    <pre><code class="prism language-c"><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>video_state<span class="token operator">-&gt;</span>isEnd<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 处理事件（必须由主线程执行）</span>
		<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">SDL_PollEvent</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>type <span class="token operator">==</span> SDL_QUIT<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				video_state<span class="token operator">-&gt;</span>isEnd <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		
		<span class="token keyword">if</span> <span class="token punctuation">(</span>video_state<span class="token operator">-&gt;</span>videoParam<span class="token operator">-&gt;</span>frame_update<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// 将AVFrame的数据写入到texture中，然后渲染后windows上</span>
			rect<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			rect<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			rect<span class="token punctuation">.</span>w <span class="token operator">=</span> video_state<span class="token operator">-&gt;</span>vCodecCtx<span class="token operator">-&gt;</span>width<span class="token punctuation">;</span>
			rect<span class="token punctuation">.</span>h <span class="token operator">=</span> video_state<span class="token operator">-&gt;</span>vCodecCtx<span class="token operator">-&gt;</span>height<span class="token punctuation">;</span>
			
			out_frame <span class="token operator">=</span> video_state<span class="token operator">-&gt;</span>videoParam<span class="token operator">-&gt;</span>out_frame<span class="token punctuation">;</span>
			
			<span class="token comment">// 更新纹理</span>
			<span class="token function">SDL_UpdateYUVTexture</span><span class="token punctuation">(</span>texture<span class="token punctuation">,</span> <span class="token operator">&amp;</span>rect<span class="token punctuation">,</span>
								 out_frame<span class="token operator">-&gt;</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> out_frame<span class="token operator">-&gt;</span>linesize<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>	<span class="token comment">// 	Y</span>
								 out_frame<span class="token operator">-&gt;</span>data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> out_frame<span class="token operator">-&gt;</span>linesize<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>	<span class="token comment">// 	U</span>
								 out_frame<span class="token operator">-&gt;</span>data<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> out_frame<span class="token operator">-&gt;</span>linesize<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//  V</span>
			<span class="token comment">// 渲染页面</span>
			<span class="token function">SDL_RenderClear</span><span class="token punctuation">(</span>renderer<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">SDL_RenderCopy</span><span class="token punctuation">(</span>renderer<span class="token punctuation">,</span> texture<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">SDL_RenderPresent</span><span class="token punctuation">(</span>renderer<span class="token punctuation">)</span><span class="token punctuation">;</span>
			
			<span class="token comment">// 重置标志</span>
			video_state<span class="token operator">-&gt;</span>videoParam<span class="token operator">-&gt;</span>frame_update <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="_388">
     </a>
     完整代码
    </h3>
    <h4>
     <a id="sample_playerh_389">
     </a>
     sample_player.h
    </h4>
    <pre><code class="prism language-c"><span class="token comment">//</span>
<span class="token comment">//  sample_player.h</span>
<span class="token comment">//  learning</span>
<span class="token comment">//</span>
<span class="token comment">//  Created by chenhuaiyi on 2025/2/26.</span>
<span class="token comment">//</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">sample_player_h</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">sample_player_h</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token comment">// ffmpeg</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"libavcodec/avcodec.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"libswresample/swresample.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"libavformat/avformat.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"libswscale/swscale.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"libavutil/imgutils.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"libavutil/time.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"libavutil/fifo.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"libavutil/channel_layout.h"</span></span>
<span class="token comment">// SDL</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"SDL.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"SDL_thread.h"</span></span>

<span class="token comment">/**
 宏定义
 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">USE_SDL</span> <span class="token expression"><span class="token number">1</span></span></span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">MyAVPacketList</span> <span class="token punctuation">{<!-- --></span>
	AVPacket 		<span class="token operator">*</span>pkt<span class="token punctuation">;</span>
	<span class="token keyword">int</span> 			serial<span class="token punctuation">;</span>
<span class="token punctuation">}</span> MyAVPacketList<span class="token punctuation">;</span>

<span class="token comment">/**
 packet队列
 */</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">PacketQueue</span> <span class="token punctuation">{<!-- --></span>
	AVFifo<span class="token operator">*</span> 		pkt_list<span class="token punctuation">;</span>		<span class="token comment">// fifo队列</span>
	<span class="token keyword">int</span> 			size<span class="token punctuation">;</span>			<span class="token comment">// 队列大小</span>
	
	SDL_mutex<span class="token operator">*</span>		mutex<span class="token punctuation">;</span>			<span class="token comment">// 互斥信号量</span>
	SDL_cond<span class="token operator">*</span>		cond<span class="token punctuation">;</span>			<span class="token comment">// 条件变量，阻塞线程</span>
<span class="token punctuation">}</span> PacketQueue<span class="token punctuation">;</span>

<span class="token comment">/**
 数据类型定义
 */</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">AudioInfo</span><span class="token punctuation">{<!-- --></span>
	Uint32  		audio_len<span class="token punctuation">;</span>		<span class="token comment">// 缓冲区长度</span>
	Uint8<span class="token operator">*</span>			audio_pos<span class="token punctuation">;</span>		<span class="token comment">// 缓冲区起始地址指针</span>
<span class="token punctuation">}</span> AudioInfo<span class="token punctuation">;</span>

<span class="token comment">/**
 语音输出参数
 */</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">AudioParam</span> <span class="token punctuation">{<!-- --></span>
	AVChannelLayout 	out_channel_layout<span class="token punctuation">;</span>			<span class="token comment">// layout</span>
	<span class="token keyword">int</span> 				out_nb_samples<span class="token punctuation">;</span>				<span class="token comment">// 每一帧的样本数</span>
	<span class="token keyword">enum</span> <span class="token class-name">AVSampleFormat</span> out_sample_fmt<span class="token punctuation">;</span>				<span class="token comment">// 格式</span>
	<span class="token keyword">int</span> 				out_sample_rate<span class="token punctuation">;</span>			<span class="token comment">// 采样率</span>
	<span class="token keyword">int</span> 				out_channels<span class="token punctuation">;</span>				<span class="token comment">// 输出通道数</span>
	<span class="token keyword">int</span>					index<span class="token punctuation">;</span>						<span class="token comment">// 音频帧总数</span>
	
	<span class="token keyword">int</span> 				out_buffer_size<span class="token punctuation">;</span>			<span class="token comment">// 音频输出缓冲区大小</span>
	<span class="token class-name">uint8_t</span><span class="token operator">*</span> 			out_buffer<span class="token punctuation">;</span>					<span class="token comment">// 音频输出缓冲区</span>
<span class="token punctuation">}</span> AudioParam<span class="token punctuation">;</span>

<span class="token comment">/**
 视频输出参数
 */</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">VideoParam</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> 				width<span class="token punctuation">;</span>						<span class="token comment">// 宽</span>
	<span class="token keyword">int</span> 				height<span class="token punctuation">;</span>						<span class="token comment">// 高</span>
	<span class="token keyword">enum</span> <span class="token class-name">AVPixelFormat</span>	pix_fmt<span class="token punctuation">;</span>					<span class="token comment">// 格式 YUV420P</span>
	<span class="token keyword">int</span> 				num_bytes<span class="token punctuation">;</span>					<span class="token comment">// 单帧字节数</span>
	<span class="token keyword">int</span>					index<span class="token punctuation">;</span>						<span class="token comment">// 视频帧总数</span>
	
	AVFrame<span class="token operator">*</span>			out_frame<span class="token punctuation">;</span>					<span class="token comment">// 输出帧</span>
	<span class="token keyword">int</span>					frame_update<span class="token punctuation">;</span>				<span class="token comment">// 帧更新标识</span>
<span class="token punctuation">}</span> VideoParam<span class="token punctuation">;</span>

<span class="token comment">/**
 全局参数
 */</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">VideoState</span> <span class="token punctuation">{<!-- --></span>
	AVFormatContext<span class="token operator">*</span> 	formatCtx<span class="token punctuation">;</span>			<span class="token comment">// format上下文</span>
	
	<span class="token keyword">int</span>				 	audioStream<span class="token punctuation">;</span>		<span class="token comment">// 音频流索引</span>
	AVCodecContext<span class="token operator">*</span>  	aCodecCtx<span class="token punctuation">;</span>			<span class="token comment">// 音频codec上下文</span>
	<span class="token keyword">const</span> AVCodec<span class="token operator">*</span>	 	aCodec<span class="token punctuation">;</span>				<span class="token comment">// 音频解码器</span>
	AudioParam<span class="token operator">*</span>		 	audioParam<span class="token punctuation">;</span>			<span class="token comment">// 音频参数</span>
	SwrContext<span class="token operator">*</span>			swrCtx<span class="token punctuation">;</span>				<span class="token comment">// 音频上线文转换</span>
	
	<span class="token keyword">int</span>					videoStream<span class="token punctuation">;</span>		<span class="token comment">// 视频流索引</span>
	AVCodecContext<span class="token operator">*</span>  	vCodecCtx<span class="token punctuation">;</span>			<span class="token comment">// 视频codec上新闻</span>
	<span class="token keyword">const</span> AVCodec<span class="token operator">*</span>	 	vCodec<span class="token punctuation">;</span>				<span class="token comment">// 视频解码器</span>
	VideoParam<span class="token operator">*</span>			videoParam<span class="token punctuation">;</span>			<span class="token comment">// 视频参数</span>
	<span class="token keyword">struct</span> <span class="token class-name">SwsContext</span><span class="token operator">*</span> 	swsCtx<span class="token punctuation">;</span>				<span class="token comment">// 视频上下文转换</span>
	
	PacketQueue<span class="token operator">*</span>		aQueue<span class="token punctuation">;</span>				<span class="token comment">// 音频pkt队列</span>
	PacketQueue<span class="token operator">*</span>		vQueue<span class="token punctuation">;</span>				<span class="token comment">// 视频pkt队列</span>
	
	<span class="token keyword">int</span>					isEnd<span class="token punctuation">;</span>				<span class="token comment">// 结束标志</span>
<span class="token punctuation">}</span> VideoState<span class="token punctuation">;</span>

<span class="token comment">/**
 全局变量
 */</span>
<span class="token keyword">extern</span> AudioInfo audio_info<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* sample_player_h */</span></span>
</code></pre>
    <h4>
     <a id="utilsh_505">
     </a>
     utils.h
    </h4>
    <pre><code class="prism language-c"><span class="token comment">//</span>
<span class="token comment">//  utils.h</span>
<span class="token comment">//  sample_player</span>
<span class="token comment">//</span>
<span class="token comment">//  Created by chenhuaiyi on 2025/2/27.</span>
<span class="token comment">//</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">utils_h</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">utils_h</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"sample_player.h"</span></span>

<span class="token keyword">int</span> <span class="token function">init_video_state</span><span class="token punctuation">(</span>VideoState<span class="token operator">*</span><span class="token operator">*</span> video_state<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">destory_video_state</span><span class="token punctuation">(</span>VideoState<span class="token operator">*</span><span class="token operator">*</span> video_state<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">packet_queue_push</span><span class="token punctuation">(</span>PacketQueue<span class="token operator">*</span> q<span class="token punctuation">,</span> AVPacket<span class="token operator">*</span> pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">packet_queue_init</span><span class="token punctuation">(</span>PacketQueue<span class="token operator">*</span><span class="token operator">*</span> q<span class="token punctuation">,</span> <span class="token class-name">size_t</span> max_size<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">packet_queue_pop</span><span class="token punctuation">(</span>PacketQueue<span class="token operator">*</span> q<span class="token punctuation">,</span> AVPacket<span class="token operator">*</span> pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">packet_queue_destroy</span><span class="token punctuation">(</span>PacketQueue<span class="token operator">*</span><span class="token operator">*</span> q<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">char</span><span class="token operator">*</span> <span class="token function">get_frame_type</span><span class="token punctuation">(</span>AVFrame<span class="token operator">*</span> frame<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* utils_h */</span></span>
</code></pre>
    <h4>
     <a id="managerh_536">
     </a>
     manager.h
    </h4>
    <pre><code class="prism language-c"><span class="token comment">//</span>
<span class="token comment">//  manager.h</span>
<span class="token comment">//  sample_player</span>
<span class="token comment">//</span>
<span class="token comment">//  Created by chenhuaiyi on 2025/2/27.</span>
<span class="token comment">//</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">manager_h</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">manager_h</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"sample_player.h"</span></span>

<span class="token comment">/**
 音频输出信息设置
 */</span>
<span class="token keyword">int</span> <span class="token function">audio_output_set</span><span class="token punctuation">(</span>VideoState<span class="token operator">*</span> video_state<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 视频输出信息设置
 */</span>
<span class="token keyword">int</span> <span class="token function">video_output_set</span><span class="token punctuation">(</span>VideoState<span class="token operator">*</span> video_state<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 音频SDL初始化
 */</span>
<span class="token keyword">int</span> <span class="token function">audio_sdl_set</span><span class="token punctuation">(</span>VideoState<span class="token operator">*</span> video_state<span class="token punctuation">,</span> SDL_AudioSpec<span class="token operator">*</span> wanted_spec<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>fn<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">,</span> Uint8<span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 视频SDL初始化
 */</span>
<span class="token keyword">int</span> <span class="token function">video_sdl_set</span><span class="token punctuation">(</span>VideoState<span class="token operator">*</span> video_state<span class="token punctuation">,</span> SDL_Window<span class="token operator">*</span><span class="token operator">*</span> window<span class="token punctuation">,</span> SDL_Renderer<span class="token operator">*</span><span class="token operator">*</span> renderer<span class="token punctuation">,</span> SDL_Texture<span class="token operator">*</span><span class="token operator">*</span> texture<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* manager_h */</span></span>
</code></pre>
    <h4>
     <a id="utilsc_573">
     </a>
     utils.c
    </h4>
    <pre><code class="prism language-c"><span class="token comment">//</span>
<span class="token comment">//  utils.c</span>
<span class="token comment">//  sample_player</span>
<span class="token comment">//</span>
<span class="token comment">//  Created by chenhuaiyi on 2025/2/27.</span>
<span class="token comment">//</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"utils.h"</span></span>

<span class="token comment">/**
 初始化VideoState
 */</span>
<span class="token keyword">int</span> <span class="token function">init_video_state</span><span class="token punctuation">(</span>VideoState<span class="token operator">*</span><span class="token operator">*</span> video_state<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token operator">*</span>video_state <span class="token operator">=</span> <span class="token function">av_malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>VideoState<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">(</span><span class="token operator">*</span>video_state<span class="token punctuation">)</span><span class="token operator">-&gt;</span>formatCtx <span class="token operator">=</span> <span class="token function">avformat_alloc_context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token punctuation">(</span><span class="token operator">*</span>video_state<span class="token punctuation">)</span><span class="token operator">-&gt;</span>audioStream <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">(</span><span class="token operator">*</span>video_state<span class="token punctuation">)</span><span class="token operator">-&gt;</span>aCodecCtx <span class="token operator">=</span> <span class="token function">avcodec_alloc_context3</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">(</span><span class="token operator">*</span>video_state<span class="token punctuation">)</span><span class="token operator">-&gt;</span>audioParam <span class="token operator">=</span> <span class="token function">av_malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>AudioParam<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token punctuation">(</span><span class="token operator">*</span>video_state<span class="token punctuation">)</span><span class="token operator">-&gt;</span>videoStream <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">(</span><span class="token operator">*</span>video_state<span class="token punctuation">)</span><span class="token operator">-&gt;</span>vCodecCtx <span class="token operator">=</span> <span class="token function">avcodec_alloc_context3</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">(</span><span class="token operator">*</span>video_state<span class="token punctuation">)</span><span class="token operator">-&gt;</span>videoParam <span class="token operator">=</span> <span class="token function">av_malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>VideoParam<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">(</span><span class="token operator">*</span>video_state<span class="token punctuation">)</span><span class="token operator">-&gt;</span>videoParam<span class="token operator">-&gt;</span>frame_update <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	
	<span class="token comment">/** pkt队列初始化 */</span>
	<span class="token punctuation">(</span><span class="token operator">*</span>video_state<span class="token punctuation">)</span><span class="token operator">-&gt;</span>aQueue <span class="token operator">=</span> <span class="token function">av_malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>PacketQueue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">packet_queue_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token operator">*</span>video_state<span class="token punctuation">)</span><span class="token operator">-&gt;</span>aQueue<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">(</span><span class="token operator">*</span>video_state<span class="token punctuation">)</span><span class="token operator">-&gt;</span>vQueue <span class="token operator">=</span> <span class="token function">av_malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>PacketQueue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">packet_queue_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token operator">*</span>video_state<span class="token punctuation">)</span><span class="token operator">-&gt;</span>vQueue<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token punctuation">(</span><span class="token operator">*</span>video_state<span class="token punctuation">)</span><span class="token operator">-&gt;</span>isEnd <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	
	<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 销毁VideoState
 */</span>
<span class="token keyword">int</span> <span class="token function">destory_video_state</span><span class="token punctuation">(</span>VideoState<span class="token operator">*</span><span class="token operator">*</span> video_state<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	
	<span class="token function">swr_free</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token operator">*</span>video_state<span class="token punctuation">)</span><span class="token operator">-&gt;</span>swrCtx<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">avcodec_free_context</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token operator">*</span>video_state<span class="token punctuation">)</span><span class="token operator">-&gt;</span>aCodecCtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">av_free</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>video_state<span class="token punctuation">)</span><span class="token operator">-&gt;</span>audioParam<span class="token operator">-&gt;</span>out_buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">av_free</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>video_state<span class="token punctuation">)</span><span class="token operator">-&gt;</span>audioParam<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token function">sws_freeContext</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>video_state<span class="token punctuation">)</span><span class="token operator">-&gt;</span>swsCtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">avcodec_free_context</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token operator">*</span>video_state<span class="token punctuation">)</span><span class="token operator">-&gt;</span>vCodecCtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">av_frame_free</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token operator">*</span>video_state<span class="token punctuation">)</span><span class="token operator">-&gt;</span>videoParam<span class="token operator">-&gt;</span>out_frame<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">av_free</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>video_state<span class="token punctuation">)</span><span class="token operator">-&gt;</span>videoParam<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">/** 队列释放 */</span>
	<span class="token function">packet_queue_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token operator">*</span>video_state<span class="token punctuation">)</span><span class="token operator">-&gt;</span>aQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">packet_queue_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token operator">*</span>video_state<span class="token punctuation">)</span><span class="token operator">-&gt;</span>vQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>video_state<span class="token punctuation">)</span><span class="token operator">-&gt;</span>formatCtx <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">avformat_close_input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token operator">*</span>video_state<span class="token punctuation">)</span><span class="token operator">-&gt;</span>formatCtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">(</span><span class="token operator">*</span>video_state<span class="token punctuation">)</span><span class="token operator">-&gt;</span>formatCtx <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	
	<span class="token function">av_free</span><span class="token punctuation">(</span><span class="token operator">*</span>video_state<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 初始化队列
 */</span>
<span class="token keyword">int</span> <span class="token function">packet_queue_init</span><span class="token punctuation">(</span>PacketQueue<span class="token operator">*</span><span class="token operator">*</span> q<span class="token punctuation">,</span> <span class="token class-name">size_t</span> max_size<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 创建一个 AVFifo 队列，每个元素的大小为 sizeof(AVPacket)</span>
	<span class="token operator">*</span>q <span class="token operator">=</span> <span class="token function">av_malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>PacketQueue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">(</span><span class="token operator">*</span>q<span class="token punctuation">)</span><span class="token operator">-&gt;</span>pkt_list <span class="token operator">=</span> <span class="token function">av_fifo_alloc2</span><span class="token punctuation">(</span>max_size<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>MyAVPacketList<span class="token punctuation">)</span><span class="token punctuation">,</span> AV_FIFO_FLAG_AUTO_GROW<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">(</span><span class="token operator">*</span>q<span class="token punctuation">)</span><span class="token operator">-&gt;</span>size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">(</span><span class="token operator">*</span>q<span class="token punctuation">)</span><span class="token operator">-&gt;</span>mutex <span class="token operator">=</span> <span class="token function">SDL_CreateMutex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">(</span><span class="token operator">*</span>q<span class="token punctuation">)</span><span class="token operator">-&gt;</span>cond <span class="token operator">=</span> <span class="token function">SDL_CreateCond</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token operator">*</span>q<span class="token punctuation">)</span><span class="token operator">-&gt;</span>pkt_list<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 写入队列
 */</span>
<span class="token keyword">int</span> <span class="token function">packet_queue_push</span><span class="token punctuation">(</span>PacketQueue<span class="token operator">*</span> q<span class="token punctuation">,</span> AVPacket<span class="token operator">*</span> pkt<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	MyAVPacketList pNode<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>q <span class="token operator">||</span> <span class="token operator">!</span>pkt<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	AVPacket<span class="token operator">*</span> pkt1 <span class="token operator">=</span> <span class="token function">av_packet_alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pkt1<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">av_packet_unref</span><span class="token punctuation">(</span>pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token function">SDL_LockMutex</span><span class="token punctuation">(</span>q<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">av_packet_ref</span><span class="token punctuation">(</span>pkt1<span class="token punctuation">,</span> pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
	pNode<span class="token punctuation">.</span>pkt <span class="token operator">=</span> pkt1<span class="token punctuation">;</span>
	<span class="token comment">// 将 pkt 压入队列</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">av_fifo_write</span><span class="token punctuation">(</span>q<span class="token operator">-&gt;</span>pkt_list<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pNode<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">SDL_UnlockMutex</span><span class="token punctuation">(</span>q<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	q<span class="token operator">-&gt;</span>size<span class="token operator">++</span><span class="token punctuation">;</span>
	<span class="token function">SDL_CondSignal</span><span class="token punctuation">(</span>q<span class="token operator">-&gt;</span>cond<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">SDL_UnlockMutex</span><span class="token punctuation">(</span>q<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 弹出队列
 */</span>
<span class="token keyword">int</span> <span class="token function">packet_queue_pop</span><span class="token punctuation">(</span>PacketQueue<span class="token operator">*</span> q<span class="token punctuation">,</span> AVPacket<span class="token operator">*</span> pkt<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>q <span class="token operator">||</span> <span class="token operator">!</span>pkt<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">SDL_LockMutex</span><span class="token punctuation">(</span>q<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	MyAVPacketList pNode<span class="token punctuation">;</span>
	<span class="token comment">// 从队列中弹出一个元素, 没找到则阻塞线程，等待生产者释放</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">av_fifo_read</span><span class="token punctuation">(</span>q<span class="token operator">-&gt;</span>pkt_list<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pNode<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">SDL_CondWait</span><span class="token punctuation">(</span>q<span class="token operator">-&gt;</span>cond<span class="token punctuation">,</span> q<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	q<span class="token operator">-&gt;</span>size<span class="token operator">--</span><span class="token punctuation">;</span>
	<span class="token function">av_packet_move_ref</span><span class="token punctuation">(</span>pkt<span class="token punctuation">,</span> pNode<span class="token punctuation">.</span>pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">av_packet_free</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pNode<span class="token punctuation">.</span>pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">SDL_UnlockMutex</span><span class="token punctuation">(</span>q<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 销毁队列
 */</span>
<span class="token keyword">void</span> <span class="token function">packet_queue_destroy</span><span class="token punctuation">(</span>PacketQueue<span class="token operator">*</span><span class="token operator">*</span> q<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>q<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">*</span>q<span class="token punctuation">)</span><span class="token operator">-&gt;</span>pkt_list<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 释放队列中的所有 AVPacket</span>
		MyAVPacketList pNode<span class="token punctuation">;</span>
		<span class="token function">SDL_LockMutex</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>q<span class="token punctuation">)</span><span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">av_fifo_read</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>q<span class="token punctuation">)</span><span class="token operator">-&gt;</span>pkt_list<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pNode<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">av_packet_free</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pNode<span class="token punctuation">.</span>pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 释放 AVPacket 的资源</span>
		<span class="token punctuation">}</span>
		<span class="token function">SDL_UnlockMutex</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>q<span class="token punctuation">)</span><span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token comment">// 释放 AVFifo 队列</span>
		<span class="token punctuation">(</span><span class="token operator">*</span>q<span class="token punctuation">)</span><span class="token operator">-&gt;</span>size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token function">av_fifo_freep2</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token operator">*</span>q<span class="token punctuation">)</span><span class="token operator">-&gt;</span>pkt_list<span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token function">SDL_DestroyMutex</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>q<span class="token punctuation">)</span><span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">SDL_DestroyCond</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>q<span class="token punctuation">)</span><span class="token operator">-&gt;</span>cond<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">av_free</span><span class="token punctuation">(</span><span class="token operator">*</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 获取帧类型
 */</span>
<span class="token keyword">char</span><span class="token operator">*</span> <span class="token function">get_frame_type</span><span class="token punctuation">(</span>AVFrame<span class="token operator">*</span> frame<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">switch</span> <span class="token punctuation">(</span>frame<span class="token operator">-&gt;</span>pict_type<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">case</span> AV_PICTURE_TYPE_I<span class="token operator">:</span>
			<span class="token keyword">return</span> <span class="token string">"I"</span><span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> AV_PICTURE_TYPE_P<span class="token operator">:</span>
			<span class="token keyword">return</span> <span class="token string">"P"</span><span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> AV_PICTURE_TYPE_B<span class="token operator">:</span>
			<span class="token keyword">return</span> <span class="token string">"B"</span><span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> AV_PICTURE_TYPE_S<span class="token operator">:</span>
			<span class="token keyword">return</span> <span class="token string">"S"</span><span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> AV_PICTURE_TYPE_SI<span class="token operator">:</span>
			<span class="token keyword">return</span> <span class="token string">"SI"</span><span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> AV_PICTURE_TYPE_SP<span class="token operator">:</span>
			<span class="token keyword">return</span> <span class="token string">"SP"</span><span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> AV_PICTURE_TYPE_BI<span class="token operator">:</span>
			<span class="token keyword">return</span> <span class="token string">"BI"</span><span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">default</span><span class="token operator">:</span>
			<span class="token keyword">return</span> <span class="token string">"N"</span><span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre>
    <h4>
     <a id="managerc_762">
     </a>
     manager.c
    </h4>
    <pre><code class="prism language-c"><span class="token comment">//</span>
<span class="token comment">//  manager.c</span>
<span class="token comment">//  sample_player</span>
<span class="token comment">//</span>
<span class="token comment">//  Created by chenhuaiyi on 2025/2/27.</span>
<span class="token comment">//</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"manager.h"</span></span>

<span class="token comment">/**
 音频输出信息构建
 */</span>
<span class="token keyword">int</span> <span class="token function">audio_output_set</span><span class="token punctuation">(</span>VideoState<span class="token operator">*</span> video_state<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	
	AudioParam<span class="token operator">*</span> audio_param <span class="token operator">=</span> video_state<span class="token operator">-&gt;</span>audioParam<span class="token punctuation">;</span>
	
	<span class="token comment">// 输出用到的信息</span>
	<span class="token function">av_channel_layout_default</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>audio_param<span class="token operator">-&gt;</span>out_channel_layout<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	audio_param<span class="token operator">-&gt;</span>out_nb_samples <span class="token operator">=</span> video_state<span class="token operator">-&gt;</span>aCodecCtx<span class="token operator">-&gt;</span>frame_size<span class="token punctuation">;</span>			<span class="token comment">// 编解码器每个帧需要处理或者输出的采样点的大小 AAC:1024  MP3:1152</span>
	audio_param<span class="token operator">-&gt;</span>out_sample_fmt <span class="token operator">=</span> AV_SAMPLE_FMT_S16<span class="token punctuation">;</span>							<span class="token comment">// 采样格式</span>
	audio_param<span class="token operator">-&gt;</span>out_sample_rate <span class="token operator">=</span> <span class="token number">44100</span><span class="token punctuation">;</span>										<span class="token comment">// 采样率</span>
	audio_param<span class="token operator">-&gt;</span>out_channels <span class="token operator">=</span> audio_param<span class="token operator">-&gt;</span>out_channel_layout<span class="token punctuation">.</span>nb_channels<span class="token punctuation">;</span>	<span class="token comment">// 通道数</span>
	
	<span class="token comment">// 获取需要使用的缓冲区大小 -&gt; 通道数，单通道样本数，位深 1024(单帧处理的采样点)*2(双通道)*2(16bit对应2字节)</span>
	audio_param<span class="token operator">-&gt;</span>out_buffer_size <span class="token operator">=</span> <span class="token function">av_samples_get_buffer_size</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> audio_param<span class="token operator">-&gt;</span>out_channels<span class="token punctuation">,</span>
													 audio_param<span class="token operator">-&gt;</span>out_nb_samples<span class="token punctuation">,</span>
													 audio_param<span class="token operator">-&gt;</span>out_sample_fmt<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 分配缓冲区空间</span>
	audio_param<span class="token operator">-&gt;</span>out_buffer <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token function">av_samples_alloc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>audio_param<span class="token operator">-&gt;</span>out_buffer<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> audio_param<span class="token operator">-&gt;</span>out_channels<span class="token punctuation">,</span>
					 audio_param<span class="token operator">-&gt;</span>out_nb_samples<span class="token punctuation">,</span> audio_param<span class="token operator">-&gt;</span>out_sample_fmt<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 视频输出信息构建
 */</span>
<span class="token keyword">int</span> <span class="token function">video_output_set</span><span class="token punctuation">(</span>VideoState<span class="token operator">*</span> video_state<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	
	VideoParam<span class="token operator">*</span> video_param <span class="token operator">=</span> video_state<span class="token operator">-&gt;</span>videoParam<span class="token punctuation">;</span>
	
	<span class="token comment">// 基础信息</span>
	video_param<span class="token operator">-&gt;</span>width <span class="token operator">=</span> video_state<span class="token operator">-&gt;</span>vCodecCtx<span class="token operator">-&gt;</span>width<span class="token punctuation">;</span>
	video_param<span class="token operator">-&gt;</span>height <span class="token operator">=</span> video_state<span class="token operator">-&gt;</span>vCodecCtx<span class="token operator">-&gt;</span>height<span class="token punctuation">;</span>
	video_param<span class="token operator">-&gt;</span>pix_fmt <span class="token operator">=</span> AV_PIX_FMT_YUV420P<span class="token punctuation">;</span>
	
	<span class="token comment">// 计算单帧大小, 分配单帧内存</span>
	video_param<span class="token operator">-&gt;</span>num_bytes <span class="token operator">=</span> <span class="token function">av_image_get_buffer_size</span><span class="token punctuation">(</span>AV_PIX_FMT_YUV420P<span class="token punctuation">,</span> video_param<span class="token operator">-&gt;</span>width<span class="token punctuation">,</span> video_param<span class="token operator">-&gt;</span>height<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	video_param<span class="token operator">-&gt;</span>out_frame <span class="token operator">=</span> <span class="token function">av_frame_alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">av_image_alloc</span><span class="token punctuation">(</span>video_param<span class="token operator">-&gt;</span>out_frame<span class="token operator">-&gt;</span>data<span class="token punctuation">,</span> video_param<span class="token operator">-&gt;</span>out_frame<span class="token operator">-&gt;</span>linesize<span class="token punctuation">,</span>
				   video_param<span class="token operator">-&gt;</span>width<span class="token punctuation">,</span> video_param<span class="token operator">-&gt;</span>height<span class="token punctuation">,</span> AV_PIX_FMT_YUV420P<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 音频SDL初始化
 */</span>
<span class="token keyword">int</span> <span class="token function">audio_sdl_set</span><span class="token punctuation">(</span>VideoState<span class="token operator">*</span> video_state<span class="token punctuation">,</span> SDL_AudioSpec<span class="token operator">*</span> wanted_spec<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>fn<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">,</span> Uint8<span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	AudioParam<span class="token operator">*</span> audio_param <span class="token operator">=</span> video_state<span class="token operator">-&gt;</span>audioParam<span class="token punctuation">;</span>
	
	wanted_spec<span class="token operator">-&gt;</span>freq <span class="token operator">=</span> audio_param<span class="token operator">-&gt;</span>out_sample_rate<span class="token punctuation">;</span>					<span class="token comment">// 采样率</span>
	wanted_spec<span class="token operator">-&gt;</span>format <span class="token operator">=</span> AUDIO_S16SYS<span class="token punctuation">;</span>									<span class="token comment">// 采样格式 16bit</span>
	wanted_spec<span class="token operator">-&gt;</span>channels <span class="token operator">=</span> audio_param<span class="token operator">-&gt;</span>out_channels<span class="token punctuation">;</span>					<span class="token comment">// 通道数</span>
	wanted_spec<span class="token operator">-&gt;</span>silence <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	wanted_spec<span class="token operator">-&gt;</span>samples <span class="token operator">=</span> audio_param<span class="token operator">-&gt;</span>out_nb_samples<span class="token punctuation">;</span>					<span class="token comment">// 单帧处理的采样点</span>
	wanted_spec<span class="token operator">-&gt;</span>callback <span class="token operator">=</span> fn<span class="token punctuation">;</span>											<span class="token comment">// 回调函数</span>
	wanted_spec<span class="token operator">-&gt;</span>userdata <span class="token operator">=</span> video_state<span class="token operator">-&gt;</span>aCodecCtx<span class="token punctuation">;</span>						<span class="token comment">// 回调函数的参数</span>
	
	
	<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 视频SDL初始化
 */</span>
<span class="token keyword">int</span> <span class="token function">video_sdl_set</span><span class="token punctuation">(</span>VideoState<span class="token operator">*</span> video_state<span class="token punctuation">,</span> SDL_Window<span class="token operator">*</span><span class="token operator">*</span> window<span class="token punctuation">,</span> SDL_Renderer<span class="token operator">*</span><span class="token operator">*</span> renderer<span class="token punctuation">,</span> SDL_Texture<span class="token operator">*</span><span class="token operator">*</span> texture<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	
	AVCodecContext<span class="token operator">*</span> pCodecCtx <span class="token operator">=</span> video_state<span class="token operator">-&gt;</span>vCodecCtx<span class="token punctuation">;</span>
	
	<span class="token comment">/** 窗口 */</span>
	<span class="token operator">*</span>window <span class="token operator">=</span> <span class="token function">SDL_CreateWindow</span><span class="token punctuation">(</span><span class="token string">"SDL2 window"</span><span class="token punctuation">,</span>
										   SDL_WINDOWPOS_CENTERED<span class="token punctuation">,</span>
										   SDL_WINDOWPOS_CENTERED<span class="token punctuation">,</span>
										   pCodecCtx<span class="token operator">-&gt;</span>width<span class="token punctuation">,</span>
										   pCodecCtx<span class="token operator">-&gt;</span>height<span class="token punctuation">,</span>
										   SDL_WINDOW_SHOWN<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">*</span>window<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"SDL_CreateWindow Error: %s\n"</span><span class="token punctuation">,</span> <span class="token function">SDL_GetError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">SDL_Quit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">/** 渲染 */</span>
	<span class="token operator">*</span>renderer <span class="token operator">=</span> <span class="token function">SDL_CreateRenderer</span><span class="token punctuation">(</span><span class="token operator">*</span>window<span class="token punctuation">,</span>
								   <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
								   SDL_RENDERER_ACCELERATED <span class="token operator">|</span> SDL_RENDERER_PRESENTVSYNC<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">*</span>renderer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"SDL_CreateRenderer Error: %s\n"</span><span class="token punctuation">,</span> <span class="token function">SDL_GetError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">SDL_DestroyWindow</span><span class="token punctuation">(</span><span class="token operator">*</span>window<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">SDL_Quit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">/** 纹理 */</span>
	<span class="token operator">*</span>texture <span class="token operator">=</span> <span class="token function">SDL_CreateTexture</span><span class="token punctuation">(</span><span class="token operator">*</span>renderer<span class="token punctuation">,</span>
								SDL_PIXELFORMAT_YV12<span class="token punctuation">,</span>
								 SDL_TEXTUREACCESS_STREAMING<span class="token punctuation">,</span>
								 pCodecCtx<span class="token operator">-&gt;</span>width<span class="token punctuation">,</span>
								 pCodecCtx<span class="token operator">-&gt;</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="mainc_877">
     </a>
     main.c
    </h4>
    <pre><code class="prism language-c"><span class="token comment">//</span>
<span class="token comment">//  main.c</span>
<span class="token comment">//  sample_player</span>
<span class="token comment">//</span>
<span class="token comment">//  Created by chenhuaiyi on 2025/2/26.</span>
<span class="token comment">//</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"utils.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"manager.h"</span></span>

AudioInfo audio_info<span class="token punctuation">;</span>

<span class="token comment">/* udata: 传入的参数
 * stream: SDL音频缓冲区
 * len: SDL音频缓冲区大小
 * 回调函数
 */</span>
<span class="token keyword">void</span> <span class="token function">fill_audio</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>udata<span class="token punctuation">,</span> Uint8 <span class="token operator">*</span>stream<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	<span class="token function">SDL_memset</span><span class="token punctuation">(</span>stream<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">// 必须重置，不然全是电音!!!</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>audio_info<span class="token punctuation">.</span>audio_len<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>					<span class="token comment">// 有音频数据时才调用</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	len <span class="token operator">=</span> <span class="token punctuation">(</span>len<span class="token operator">&gt;</span>audio_info<span class="token punctuation">.</span>audio_len <span class="token operator">?</span> audio_info<span class="token punctuation">.</span>audio_len <span class="token operator">:</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 最多填充缓冲区大小的数据</span>
	<span class="token function">SDL_MixAudio</span><span class="token punctuation">(</span>stream<span class="token punctuation">,</span> audio_info<span class="token punctuation">.</span>audio_pos<span class="token punctuation">,</span> len<span class="token punctuation">,</span> SDL_MIX_MAXVOLUME<span class="token punctuation">)</span><span class="token punctuation">;</span>
	audio_info<span class="token punctuation">.</span>audio_pos <span class="token operator">+=</span> len<span class="token punctuation">;</span>
	audio_info<span class="token punctuation">.</span>audio_len <span class="token operator">-=</span> len<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 音频线程
 */</span>
<span class="token keyword">int</span> <span class="token function">audio_thread</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">/**
	 1. 从packet_queue队列中取出packet
	 2. 将packet进行解码
	 3. 写入到sdl的缓冲区中
	 */</span> 	VideoState<span class="token operator">*</span> video_state <span class="token operator">=</span> <span class="token punctuation">(</span>VideoState<span class="token operator">*</span><span class="token punctuation">)</span> arg<span class="token punctuation">;</span>
	AudioParam<span class="token operator">*</span> audio_param <span class="token operator">=</span> video_state<span class="token operator">-&gt;</span>audioParam<span class="token punctuation">;</span>
	PacketQueue<span class="token operator">*</span> queue <span class="token operator">=</span> video_state<span class="token operator">-&gt;</span>aQueue<span class="token punctuation">;</span>
	audio_param<span class="token operator">-&gt;</span>index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	
	AVRational time_base <span class="token operator">=</span> video_state<span class="token operator">-&gt;</span>formatCtx<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>video_state<span class="token operator">-&gt;</span>audioStream<span class="token punctuation">]</span><span class="token operator">-&gt;</span>time_base<span class="token punctuation">;</span>
	<span class="token class-name">int64_t</span> av_start_time <span class="token operator">=</span> <span class="token function">av_gettime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>								<span class="token comment">// 播放开始时间戳</span>
	
	AVPacket 	packet<span class="token punctuation">;</span>
	<span class="token keyword">int</span> 		ret<span class="token punctuation">;</span>
	AVFrame<span class="token operator">*</span> 	pFrame <span class="token operator">=</span> <span class="token function">av_frame_alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>queue<span class="token operator">-&gt;</span>size <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			
			<span class="token function">packet_queue_pop</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> <span class="token operator">&amp;</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// 将packet写入编解码器</span>
			ret <span class="token operator">=</span> <span class="token function">avcodec_send_packet</span><span class="token punctuation">(</span>video_state<span class="token operator">-&gt;</span>aCodecCtx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span> ret <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"send packet error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			
			<span class="token comment">// 获取解码后的帧</span>
			<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">avcodec_receive_frame</span><span class="token punctuation">(</span>video_state<span class="token operator">-&gt;</span>aCodecCtx<span class="token punctuation">,</span> pFrame<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token comment">// 格式转化</span>
				<span class="token function">swr_convert</span><span class="token punctuation">(</span>video_state<span class="token operator">-&gt;</span>swrCtx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>audio_param<span class="token operator">-&gt;</span>out_buffer<span class="token punctuation">,</span> audio_param<span class="token operator">-&gt;</span>out_buffer_size<span class="token punctuation">,</span>
							<span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span>pFrame<span class="token operator">-&gt;</span>data<span class="token punctuation">,</span> pFrame<span class="token operator">-&gt;</span>nb_samples<span class="token punctuation">)</span><span class="token punctuation">;</span>
				audio_param<span class="token operator">-&gt;</span>index<span class="token operator">++</span><span class="token punctuation">;</span>
				<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"第%d帧 | pts:%lld | 帧大小(采样点):%d | 实际播放点%.2fs | 预期播放点%.2fs\n"</span><span class="token punctuation">,</span>
					   audio_param<span class="token operator">-&gt;</span>index<span class="token punctuation">,</span>
					   packet<span class="token punctuation">.</span>pts<span class="token punctuation">,</span>
					   packet<span class="token punctuation">.</span>size<span class="token punctuation">,</span>
					   <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">av_gettime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> av_start_time<span class="token punctuation">)</span><span class="token operator">/</span>AV_TIME_BASE<span class="token punctuation">,</span>
					   pFrame<span class="token operator">-&gt;</span>pts <span class="token operator">*</span> <span class="token function">av_q2d</span><span class="token punctuation">(</span>time_base<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">USE_SDL</span></span>
				<span class="token comment">// 设置读取的音频数据</span>
				audio_info<span class="token punctuation">.</span>audio_len <span class="token operator">=</span> audio_param<span class="token operator">-&gt;</span>out_buffer_size<span class="token punctuation">;</span>
				audio_info<span class="token punctuation">.</span>audio_pos <span class="token operator">=</span> <span class="token punctuation">(</span>Uint8 <span class="token operator">*</span><span class="token punctuation">)</span> audio_param<span class="token operator">-&gt;</span>out_buffer<span class="token punctuation">;</span>
				<span class="token comment">// 等待SDL播放完成</span>
				<span class="token keyword">while</span><span class="token punctuation">(</span>audio_info<span class="token punctuation">.</span>audio_len <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
					<span class="token function">SDL_Delay</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
			<span class="token punctuation">}</span>
			<span class="token function">av_packet_unref</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	
	<span class="token function">av_frame_free</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pFrame<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 结束</span>
	video_state<span class="token operator">-&gt;</span>isEnd <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 视频线程
 */</span>
<span class="token keyword">int</span> <span class="token function">video_thread</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">/**
	 1. 从视频pkt队列中读出packet
	 2. 送入解码器解码并取出
	 3. 使用SDL进行渲染
	 4. 根据pts计算延迟SDL_DELAY
	 */</span>
	VideoState<span class="token operator">*</span> 	video_state <span class="token operator">=</span> <span class="token punctuation">(</span>VideoState<span class="token operator">*</span><span class="token punctuation">)</span> arg<span class="token punctuation">;</span>
	PacketQueue<span class="token operator">*</span> 	video_queue <span class="token operator">=</span> video_state<span class="token operator">-&gt;</span>vQueue<span class="token punctuation">;</span>
	AVCodecContext<span class="token operator">*</span> pCodecCtx <span class="token operator">=</span> video_state<span class="token operator">-&gt;</span>vCodecCtx<span class="token punctuation">;</span>
	AVFrame<span class="token operator">*</span> 		out_frame <span class="token operator">=</span> video_state<span class="token operator">-&gt;</span>videoParam<span class="token operator">-&gt;</span>out_frame<span class="token punctuation">;</span>
	
	AVPacket packet<span class="token punctuation">;</span>
	AVFrame<span class="token operator">*</span> pFrame <span class="token operator">=</span> <span class="token function">av_frame_alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	AVRational time_base <span class="token operator">=</span> video_state<span class="token operator">-&gt;</span>formatCtx<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>video_state<span class="token operator">-&gt;</span>videoStream<span class="token punctuation">]</span><span class="token operator">-&gt;</span>time_base<span class="token punctuation">;</span>
	<span class="token class-name">int64_t</span> av_start_time <span class="token operator">=</span> <span class="token function">av_gettime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>							<span class="token comment">// 开始播放时间(ms*1000)</span>
	<span class="token class-name">int64_t</span> frame_delay <span class="token operator">=</span> <span class="token function">av_q2d</span><span class="token punctuation">(</span>time_base<span class="token punctuation">)</span> <span class="token operator">*</span> AV_TIME_BASE<span class="token punctuation">;</span>		<span class="token comment">// pts单位(ms*1000)</span>
	
	<span class="token class-name">int64_t</span> frame_start_time <span class="token operator">=</span> <span class="token function">av_gettime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>video_queue<span class="token operator">-&gt;</span>size <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">packet_queue_pop</span><span class="token punctuation">(</span>video_queue<span class="token punctuation">,</span> <span class="token operator">&amp;</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// 将packet写入编解码器</span>
			<span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">avcodec_send_packet</span><span class="token punctuation">(</span>pCodecCtx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"packet resolve error!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token comment">// 从解码器中取出原始帧</span>
			<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">avcodec_receive_frame</span><span class="token punctuation">(</span>pCodecCtx<span class="token punctuation">,</span> pFrame<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token comment">// 帧格式转化，转为YUV420P</span>
				<span class="token function">sws_scale</span><span class="token punctuation">(</span>video_state<span class="token operator">-&gt;</span>swsCtx<span class="token punctuation">,</span>						<span class="token comment">// sws_context转换</span>
						  <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token keyword">const</span> <span class="token operator">*</span> <span class="token keyword">const</span> <span class="token operator">*</span><span class="token punctuation">)</span>pFrame<span class="token operator">-&gt;</span>data<span class="token punctuation">,</span>	<span class="token comment">// 输入 data</span>
						  pFrame<span class="token operator">-&gt;</span>linesize<span class="token punctuation">,</span>							<span class="token comment">// 输入 每行数据的大小（对齐）</span>
						  <span class="token number">0</span><span class="token punctuation">,</span>										<span class="token comment">// 输入 Y轴位置</span>
						  pCodecCtx<span class="token operator">-&gt;</span>height<span class="token punctuation">,</span>						<span class="token comment">// 输入 height</span>
						  out_frame<span class="token operator">-&gt;</span>data<span class="token punctuation">,</span>							<span class="token comment">// 输出 data</span>
						  out_frame<span class="token operator">-&gt;</span>linesize<span class="token punctuation">)</span><span class="token punctuation">;</span>						<span class="token comment">// 输出 linesize</span>
				
				<span class="token comment">// 帧更新</span>
				video_state<span class="token operator">-&gt;</span>videoParam<span class="token operator">-&gt;</span>frame_update <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
				
				<span class="token comment">// 计算延迟</span>
				<span class="token class-name">int64_t</span> pts <span class="token operator">=</span> pFrame<span class="token operator">-&gt;</span>pts<span class="token punctuation">;</span>											<span class="token comment">// pts</span>
				<span class="token class-name">int64_t</span> actual_playback_time <span class="token operator">=</span> av_start_time <span class="token operator">+</span> pts <span class="token operator">*</span> frame_delay<span class="token punctuation">;</span>	<span class="token comment">// 实际播放时间</span>
				<span class="token class-name">int64_t</span> current_time <span class="token operator">=</span> <span class="token function">av_gettime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>actual_playback_time <span class="token operator">&gt;</span> current_time<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					<span class="token function">SDL_Delay</span><span class="token punctuation">(</span><span class="token punctuation">(</span>Uint32<span class="token punctuation">)</span><span class="token punctuation">(</span>actual_playback_time<span class="token operator">-</span>current_time<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 延迟当前时间和实际播放时间</span>
				<span class="token punctuation">}</span>
				
				video_state<span class="token operator">-&gt;</span>videoParam<span class="token operator">-&gt;</span>index<span class="token operator">++</span><span class="token punctuation">;</span>
				<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"第%i帧 | 属于%s | pts为%d | 时长为%.2fms | 实际播放点为%.2fs | 预期播放点为%.2fs\n "</span><span class="token punctuation">,</span>
					   video_state<span class="token operator">-&gt;</span>videoParam<span class="token operator">-&gt;</span>index<span class="token punctuation">,</span>
					   <span class="token function">get_frame_type</span><span class="token punctuation">(</span>pFrame<span class="token punctuation">)</span><span class="token punctuation">,</span>
					   <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>pFrame<span class="token operator">-&gt;</span>pts<span class="token punctuation">,</span>
					   <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">av_gettime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> frame_start_time<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">1000</span><span class="token punctuation">,</span>
					   <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">av_gettime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> av_start_time<span class="token punctuation">)</span><span class="token operator">/</span>AV_TIME_BASE<span class="token punctuation">,</span>
					   pFrame<span class="token operator">-&gt;</span>pts <span class="token operator">*</span> <span class="token function">av_q2d</span><span class="token punctuation">(</span>time_base<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				
				frame_start_time <span class="token operator">=</span> <span class="token function">av_gettime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			
			<span class="token function">av_packet_unref</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	
	<span class="token function">av_frame_free</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pFrame<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 结束</span>
	video_state<span class="token operator">-&gt;</span>isEnd <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	
	VideoState<span class="token operator">*</span> 		video_state<span class="token punctuation">;</span>
	AudioParam<span class="token operator">*</span>			audio_param<span class="token punctuation">;</span>
	VideoParam<span class="token operator">*</span>			video_param<span class="token punctuation">;</span>
	
	SDL_Event 			event<span class="token punctuation">;</span>
	SDL_Rect      		rect<span class="token punctuation">;</span>
	
	<span class="token keyword">if</span><span class="token punctuation">(</span>argc <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Usage: test &lt;file&gt;\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token comment">/** 初始化函数 */</span>
	<span class="token function">init_video_state</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>video_state<span class="token punctuation">)</span><span class="token punctuation">;</span>
	audio_param <span class="token operator">=</span> video_state<span class="token operator">-&gt;</span>audioParam<span class="token punctuation">;</span>
	video_param <span class="token operator">=</span> video_state<span class="token operator">-&gt;</span>videoParam<span class="token punctuation">;</span>
	
	<span class="token function">avformat_network_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">// 1. 打开视频文件，获取格式上下文</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">avformat_open_input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>video_state<span class="token operator">-&gt;</span>formatCtx<span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Couldn't open input stream.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token comment">// 2. 对文件探测流信息</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">avformat_find_stream_info</span><span class="token punctuation">(</span>video_state<span class="token operator">-&gt;</span>formatCtx<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Couldn't find stream information.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token comment">// 打印信息</span>
	<span class="token function">av_dump_format</span><span class="token punctuation">(</span>video_state<span class="token operator">-&gt;</span>formatCtx<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">// 3. 找到对应的 音频流/视频流 索引</span>
	video_state<span class="token operator">-&gt;</span>audioStream<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	video_state<span class="token operator">-&gt;</span>videoStream<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> video_state<span class="token operator">-&gt;</span>formatCtx<span class="token operator">-&gt;</span>nb_streams<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>video_state<span class="token operator">-&gt;</span>formatCtx<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>codec_type<span class="token operator">==</span>AVMEDIA_TYPE_AUDIO<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
			video_state<span class="token operator">-&gt;</span>audioStream<span class="token operator">=</span>i<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>video_state<span class="token operator">-&gt;</span>formatCtx<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>codec_type<span class="token operator">==</span>AVMEDIA_TYPE_VIDEO<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			video_state<span class="token operator">-&gt;</span>videoStream<span class="token operator">=</span>i<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>video_state<span class="token operator">-&gt;</span>audioStream<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Didn't find a audio stream.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>video_state<span class="token operator">-&gt;</span>videoStream<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Didn't find a video stream.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token comment">// 4. 将 音频流/视频流 编码参数写入上下文</span>
	AVCodecParameters<span class="token operator">*</span> aCodecParam <span class="token operator">=</span> video_state<span class="token operator">-&gt;</span>formatCtx<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>video_state<span class="token operator">-&gt;</span>audioStream<span class="token punctuation">]</span><span class="token operator">-&gt;</span>codecpar<span class="token punctuation">;</span>
	<span class="token function">avcodec_parameters_to_context</span><span class="token punctuation">(</span>video_state<span class="token operator">-&gt;</span>aCodecCtx<span class="token punctuation">,</span> aCodecParam<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//	avcodec_parameters_free(&amp;aCodecParam); 这个是不需要手动释放的</span>
	
	AVCodecParameters<span class="token operator">*</span> vCodecParam <span class="token operator">=</span> video_state<span class="token operator">-&gt;</span>formatCtx<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>video_state<span class="token operator">-&gt;</span>videoStream<span class="token punctuation">]</span><span class="token operator">-&gt;</span>codecpar<span class="token punctuation">;</span>
	<span class="token function">avcodec_parameters_to_context</span><span class="token punctuation">(</span>video_state<span class="token operator">-&gt;</span>vCodecCtx<span class="token punctuation">,</span> vCodecParam<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//	avcodec_parameters_free(&amp;vCodecParam);</span>
	
	<span class="token comment">// 5. 查找流的编码器</span>
	video_state<span class="token operator">-&gt;</span>aCodec <span class="token operator">=</span> <span class="token function">avcodec_find_decoder</span><span class="token punctuation">(</span>video_state<span class="token operator">-&gt;</span>aCodecCtx<span class="token operator">-&gt;</span>codec_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>video_state<span class="token operator">-&gt;</span>aCodec<span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Audio codec not found.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	video_state<span class="token operator">-&gt;</span>vCodec <span class="token operator">=</span> <span class="token function">avcodec_find_decoder</span><span class="token punctuation">(</span>video_state<span class="token operator">-&gt;</span>vCodecCtx<span class="token operator">-&gt;</span>codec_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>video_state<span class="token operator">-&gt;</span>vCodec<span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Video codec not found.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token comment">// 6. 打开流的编解码器</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">avcodec_open2</span><span class="token punctuation">(</span>video_state<span class="token operator">-&gt;</span>aCodecCtx<span class="token punctuation">,</span> video_state<span class="token operator">-&gt;</span>aCodec<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Could not open audio codec.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">avcodec_open2</span><span class="token punctuation">(</span>video_state<span class="token operator">-&gt;</span>vCodecCtx<span class="token punctuation">,</span> video_state<span class="token operator">-&gt;</span>vCodec<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Could not open video codec.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token comment">/** 音频输出信息构建 */</span>
	<span class="token function">audio_output_set</span><span class="token punctuation">(</span>video_state<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/** 视频输出信息构建 */</span>
	<span class="token function">video_output_set</span><span class="token punctuation">(</span>video_state<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	
	<span class="token comment">//	SDL 初始化</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">USE_SDL</span></span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">SDL_Init</span><span class="token punctuation">(</span>SDL_INIT_VIDEO <span class="token operator">|</span> SDL_INIT_AUDIO <span class="token operator">|</span> SDL_INIT_TIMER<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span> <span class="token string">"Could not initialize SDL - %s\n"</span><span class="token punctuation">,</span> <span class="token function">SDL_GetError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token comment">// 在 main 函数开始处添加</span>
	<span class="token function">SDL_SetHint</span><span class="token punctuation">(</span>SDL_HINT_VIDEO_MAC_FULLSCREEN_SPACES<span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">SDL_SetHint</span><span class="token punctuation">(</span>SDL_HINT_MAC_BACKGROUND_APP<span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">/** 初始化音频SDL设备 */</span>
	SDL_AudioSpec wanted_spec<span class="token punctuation">;</span>
	<span class="token comment">//	audio_sdl_set(video_state, &amp;wanted_spec, fill_audio);</span>
	wanted_spec<span class="token punctuation">.</span>freq <span class="token operator">=</span> audio_param<span class="token operator">-&gt;</span>out_sample_rate<span class="token punctuation">;</span>					<span class="token comment">// 采样率</span>
	wanted_spec<span class="token punctuation">.</span>format <span class="token operator">=</span> AUDIO_S16SYS<span class="token punctuation">;</span>									<span class="token comment">// 采样格式 16bit</span>
	wanted_spec<span class="token punctuation">.</span>channels <span class="token operator">=</span> audio_param<span class="token operator">-&gt;</span>out_channels<span class="token punctuation">;</span>					<span class="token comment">// 通道数</span>
	wanted_spec<span class="token punctuation">.</span>silence <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	wanted_spec<span class="token punctuation">.</span>samples <span class="token operator">=</span> audio_param<span class="token operator">-&gt;</span>out_nb_samples<span class="token punctuation">;</span>					<span class="token comment">// 单帧处理的采样点</span>
	wanted_spec<span class="token punctuation">.</span>callback <span class="token operator">=</span> fill_audio<span class="token punctuation">;</span>									<span class="token comment">// 回调函数</span>
	wanted_spec<span class="token punctuation">.</span>userdata <span class="token operator">=</span> video_state<span class="token operator">-&gt;</span>aCodecCtx<span class="token punctuation">;</span>						<span class="token comment">// 回调函数的参数</span>
	
	<span class="token comment">/** 初始化视频SDL设备 */</span>
	SDL_Window<span class="token operator">*</span>       window <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	SDL_Renderer<span class="token operator">*</span>     renderer <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	SDL_Texture<span class="token operator">*</span>      texture<span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token comment">//	video_sdl_set(video_state, &amp;window, &amp;renderer, &amp;texture);</span>
	<span class="token comment">/** 窗口 */</span>
	window <span class="token operator">=</span> <span class="token function">SDL_CreateWindow</span><span class="token punctuation">(</span><span class="token string">"SDL2 window"</span><span class="token punctuation">,</span>
							  SDL_WINDOWPOS_CENTERED<span class="token punctuation">,</span>
							  SDL_WINDOWPOS_CENTERED<span class="token punctuation">,</span>
							  video_state<span class="token operator">-&gt;</span>vCodecCtx<span class="token operator">-&gt;</span>width<span class="token punctuation">,</span>
							  video_state<span class="token operator">-&gt;</span>vCodecCtx<span class="token operator">-&gt;</span>height<span class="token punctuation">,</span>
							  SDL_WINDOW_SHOWN<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>window<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"SDL_CreateWindow Error: %s\n"</span><span class="token punctuation">,</span> <span class="token function">SDL_GetError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">SDL_Quit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">/** 渲染 */</span>
	renderer <span class="token operator">=</span> <span class="token function">SDL_CreateRenderer</span><span class="token punctuation">(</span>window<span class="token punctuation">,</span>
								  <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
								  SDL_RENDERER_ACCELERATED <span class="token operator">|</span> SDL_RENDERER_PRESENTVSYNC<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>renderer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"SDL_CreateRenderer Error: %s\n"</span><span class="token punctuation">,</span> <span class="token function">SDL_GetError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">SDL_DestroyWindow</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">SDL_Quit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">/** 纹理 */</span>
	texture <span class="token operator">=</span> <span class="token function">SDL_CreateTexture</span><span class="token punctuation">(</span>renderer<span class="token punctuation">,</span>
								SDL_PIXELFORMAT_YV12<span class="token punctuation">,</span>
								SDL_TEXTUREACCESS_STREAMING<span class="token punctuation">,</span>
								video_state<span class="token operator">-&gt;</span>vCodecCtx<span class="token operator">-&gt;</span>width<span class="token punctuation">,</span>
								video_state<span class="token operator">-&gt;</span>vCodecCtx<span class="token operator">-&gt;</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">// 打开音频播放器</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">SDL_OpenAudio</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wanted_spec<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"can't open audio.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	
	<span class="token comment">// 音频上下文格式转换</span>
	<span class="token function">swr_alloc_set_opts2</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>video_state<span class="token operator">-&gt;</span>swrCtx<span class="token punctuation">,</span>
						<span class="token operator">&amp;</span>audio_param<span class="token operator">-&gt;</span>out_channel_layout<span class="token punctuation">,</span>			<span class="token comment">// 输出layout</span>
						audio_param<span class="token operator">-&gt;</span>out_sample_fmt<span class="token punctuation">,</span>				<span class="token comment">// 输出格式</span>
						audio_param<span class="token operator">-&gt;</span>out_sample_rate<span class="token punctuation">,</span>				<span class="token comment">// 输出采样率</span>
						<span class="token operator">&amp;</span>video_state<span class="token operator">-&gt;</span>aCodecCtx<span class="token operator">-&gt;</span>ch_layout<span class="token punctuation">,</span>			<span class="token comment">// 输入layout</span>
						video_state<span class="token operator">-&gt;</span>aCodecCtx<span class="token operator">-&gt;</span>sample_fmt<span class="token punctuation">,</span>			<span class="token comment">// 输入格式</span>
						video_state<span class="token operator">-&gt;</span>aCodecCtx<span class="token operator">-&gt;</span>sample_rate<span class="token punctuation">,</span>		<span class="token comment">// 输入采样率</span>
						<span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">swr_init</span><span class="token punctuation">(</span>video_state<span class="token operator">-&gt;</span>swrCtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">// 视频上下文格式转换</span>
	video_state<span class="token operator">-&gt;</span>swsCtx <span class="token operator">=</span> <span class="token function">sws_getContext</span><span class="token punctuation">(</span>video_state<span class="token operator">-&gt;</span>vCodecCtx<span class="token operator">-&gt;</span>width<span class="token punctuation">,</span>			<span class="token comment">// src 宽</span>
										 video_state<span class="token operator">-&gt;</span>vCodecCtx<span class="token operator">-&gt;</span>height<span class="token punctuation">,</span>		<span class="token comment">// src 高</span>
										 video_state<span class="token operator">-&gt;</span>vCodecCtx<span class="token operator">-&gt;</span>pix_fmt<span class="token punctuation">,</span>		<span class="token comment">// src 格式</span>
										 video_param<span class="token operator">-&gt;</span>width<span class="token punctuation">,</span>					<span class="token comment">// dst 宽</span>
										 video_param<span class="token operator">-&gt;</span>height<span class="token punctuation">,</span>					<span class="token comment">// dst 高</span>
										 video_param<span class="token operator">-&gt;</span>pix_fmt<span class="token punctuation">,</span>					<span class="token comment">// dst 格式</span>
										 SWS_BILINEAR<span class="token punctuation">,</span>
										 <span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">// 开始播放</span>
	<span class="token function">SDL_PauseAudio</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">int64_t</span> av_start_time <span class="token operator">=</span> <span class="token function">av_gettime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 播放开始时间戳</span>
	
	AVPacket<span class="token operator">*</span> packet <span class="token operator">=</span> <span class="token function">av_packet_alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// packet初始化</span>
	
	<span class="token comment">// 循环1: 从文件中读取packet</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">av_read_frame</span><span class="token punctuation">(</span>video_state<span class="token operator">-&gt;</span>formatCtx<span class="token punctuation">,</span> packet<span class="token punctuation">)</span><span class="token operator">&gt;=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token comment">/** 写入音频pkt队列 */</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>packet<span class="token operator">-&gt;</span>stream_index<span class="token operator">==</span>video_state<span class="token operator">-&gt;</span>audioStream<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
			<span class="token function">packet_queue_push</span><span class="token punctuation">(</span>video_state<span class="token operator">-&gt;</span>aQueue<span class="token punctuation">,</span> packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">/** 写入视频pkt队列 */</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>packet<span class="token operator">-&gt;</span>stream_index<span class="token operator">==</span>video_state<span class="token operator">-&gt;</span>videoStream<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">packet_queue_push</span><span class="token punctuation">(</span>video_state<span class="token operator">-&gt;</span>vQueue<span class="token punctuation">,</span> packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token function">av_packet_unref</span><span class="token punctuation">(</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">SDL_PollEvent</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">switch</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">case</span> SDL_QUIT<span class="token operator">:</span>
				<span class="token function">SDL_Quit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">default</span><span class="token operator">:</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"audio queue.size=%d\n"</span><span class="token punctuation">,</span> video_state<span class="token operator">-&gt;</span>aQueue<span class="token operator">-&gt;</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">// 创建一个线程并启动</span>
	<span class="token function">SDL_CreateThread</span><span class="token punctuation">(</span>audio_thread<span class="token punctuation">,</span> <span class="token string">"audio_thread"</span><span class="token punctuation">,</span> video_state<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">SDL_CreateThread</span><span class="token punctuation">(</span>video_thread<span class="token punctuation">,</span> <span class="token string">"video_thread"</span><span class="token punctuation">,</span> video_state<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//	video_thread(video_state);</span>
	
	AVFrame<span class="token operator">*</span> out_frame <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>video_state<span class="token operator">-&gt;</span>isEnd<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 处理事件（必须由主线程执行）</span>
		<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">SDL_PollEvent</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>type <span class="token operator">==</span> SDL_QUIT<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				video_state<span class="token operator">-&gt;</span>isEnd <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		
		<span class="token keyword">if</span> <span class="token punctuation">(</span>video_state<span class="token operator">-&gt;</span>videoParam<span class="token operator">-&gt;</span>frame_update<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// 将AVFrame的数据写入到texture中，然后渲染后windows上</span>
			rect<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			rect<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			rect<span class="token punctuation">.</span>w <span class="token operator">=</span> video_state<span class="token operator">-&gt;</span>vCodecCtx<span class="token operator">-&gt;</span>width<span class="token punctuation">;</span>
			rect<span class="token punctuation">.</span>h <span class="token operator">=</span> video_state<span class="token operator">-&gt;</span>vCodecCtx<span class="token operator">-&gt;</span>height<span class="token punctuation">;</span>
			
			out_frame <span class="token operator">=</span> video_state<span class="token operator">-&gt;</span>videoParam<span class="token operator">-&gt;</span>out_frame<span class="token punctuation">;</span>
			
			<span class="token comment">// 更新纹理</span>
			<span class="token function">SDL_UpdateYUVTexture</span><span class="token punctuation">(</span>texture<span class="token punctuation">,</span> <span class="token operator">&amp;</span>rect<span class="token punctuation">,</span>
								 out_frame<span class="token operator">-&gt;</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> out_frame<span class="token operator">-&gt;</span>linesize<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>	<span class="token comment">// 	Y</span>
								 out_frame<span class="token operator">-&gt;</span>data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> out_frame<span class="token operator">-&gt;</span>linesize<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>	<span class="token comment">// 	U</span>
								 out_frame<span class="token operator">-&gt;</span>data<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> out_frame<span class="token operator">-&gt;</span>linesize<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//  V</span>
			<span class="token comment">// 渲染页面</span>
			<span class="token function">SDL_RenderClear</span><span class="token punctuation">(</span>renderer<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">SDL_RenderCopy</span><span class="token punctuation">(</span>renderer<span class="token punctuation">,</span> texture<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">SDL_RenderPresent</span><span class="token punctuation">(</span>renderer<span class="token punctuation">)</span><span class="token punctuation">;</span>
			
			<span class="token comment">// 重置标志</span>
			video_state<span class="token operator">-&gt;</span>videoParam<span class="token operator">-&gt;</span>frame_update <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	
	
	<span class="token comment">// 打印参数</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"格式: %s\n"</span><span class="token punctuation">,</span> video_state<span class="token operator">-&gt;</span>formatCtx<span class="token operator">-&gt;</span>iformat<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"时长: %lld us\n"</span><span class="token punctuation">,</span> video_state<span class="token operator">-&gt;</span>formatCtx<span class="token operator">-&gt;</span>duration<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"音频持续时长为 %.2f，音频帧总数为 %d\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">av_gettime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>av_start_time<span class="token punctuation">)</span><span class="token operator">/</span>AV_TIME_BASE<span class="token punctuation">,</span> audio_param<span class="token operator">-&gt;</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"码率: %lld\n"</span><span class="token punctuation">,</span> video_state<span class="token operator">-&gt;</span>formatCtx<span class="token operator">-&gt;</span>bit_rate<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"编码器: %s (%s)\n"</span><span class="token punctuation">,</span> video_state<span class="token operator">-&gt;</span>aCodecCtx<span class="token operator">-&gt;</span>codec<span class="token operator">-&gt;</span>long_name<span class="token punctuation">,</span> <span class="token function">avcodec_get_name</span><span class="token punctuation">(</span>video_state<span class="token operator">-&gt;</span>aCodecCtx<span class="token operator">-&gt;</span>codec_id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"通道数: %d\n"</span><span class="token punctuation">,</span> video_state<span class="token operator">-&gt;</span>aCodecCtx<span class="token operator">-&gt;</span>ch_layout<span class="token punctuation">.</span>nb_channels<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"采样率: %d \n"</span><span class="token punctuation">,</span> video_state<span class="token operator">-&gt;</span>aCodecCtx<span class="token operator">-&gt;</span>sample_rate<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"单通道每帧的采样点数目: %d\n"</span><span class="token punctuation">,</span> video_state<span class="token operator">-&gt;</span>aCodecCtx<span class="token operator">-&gt;</span>frame_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pts单位(ms*1000): %.2f\n"</span><span class="token punctuation">,</span> <span class="token function">av_q2d</span><span class="token punctuation">(</span>video_state<span class="token operator">-&gt;</span>formatCtx<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>video_state<span class="token operator">-&gt;</span>audioStream<span class="token punctuation">]</span><span class="token operator">-&gt;</span>time_base<span class="token punctuation">)</span> <span class="token operator">*</span> AV_TIME_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	
	<span class="token comment">// 释放空间</span>
	<span class="token function">av_packet_free</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">USE_SDL</span></span>
	<span class="token function">SDL_CloseAudio</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">SDL_DestroyTexture</span><span class="token punctuation">(</span>texture<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">SDL_DestroyRenderer</span><span class="token punctuation">(</span>renderer<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">SDL_DestroyWindow</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">SDL_Quit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	<span class="token function">destory_video_state</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>video_state<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


</code></pre>
    <h3>
     <a id="_1332">
     </a>
     结语和展望
    </h3>
    <p>
     终于做完了，恭喜你，完成了一个非常粗糙，而且有很多问题的简单音视频播放器。接下来几期，我们跟着大家一起对这个简单的播放器进行优化。当然我也是个小萌新，所以一步一步来嘛哈哈。先抛出几个问题：
    </p>
    <blockquote>
     <ol>
      <li>
       时钟同步怎么做
      </li>
      <li>
       如何边读出packet，边解码frame并播放
      </li>
      <li>
       我们如何对输出的解码帧进行转化
      </li>
     </ol>
    </blockquote>
    <p>
     ps. 鼓励大家阅读ffplay源码，所有的问题都能迎刃而解，哈哈哈！
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f6d305f35313433333536322f:61727469636c652f64657461696c732f313435393939323432" class_="artid" style="display:none">
 </p>
</div>


