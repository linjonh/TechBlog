---
layout: post
title: "Thinkphp的belongsToMany多对多-和-hasManyThrough远程一对多的区别是什么"
date: 2025-03-14 17:51:45 +0800
description: "Thinkphp的belongsToMany（多对多） 和 hasManyThrough（远程一对多）的区别是什么？"
keywords: "Thinkphp的belongsToMany（多对多） 和 hasManyThrough（远程一对多）的区别是什么？"
categories: ['Php']
tags: ['Php']
artid: "146263258"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146263258
    alt: "Thinkphp的belongsToMany多对多-和-hasManyThrough远程一对多的区别是什么"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146263258
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146263258
cover: https://bing.ee123.net/img/rand?artid=146263258
image: https://bing.ee123.net/img/rand?artid=146263258
img: https://bing.ee123.net/img/rand?artid=146263258
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Thinkphp的belongsToMany（多对多） 和 hasManyThrough（远程一对多）的区别是什么？
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     虽然
     <code>
      belongsToMany
     </code>
     （多对多） 和
     <code>
      hasManyThrough
     </code>
     （远程一对多） 都会使用
     <code>
      JOIN
     </code>
     查询，但它们的
     <strong>
      核心区别
     </strong>
     在于
     <strong>
      关联关系的本质不同
     </strong>
     ，具体如下：
    </p>
    <hr/>
    <h3>
     <a id="1_belongsToMany_4">
     </a>
     <strong>
      1️⃣
      <code>
       belongsToMany
      </code>
      （多对多）
     </strong>
    </h3>
    <h4>
     <a id="__5">
     </a>
     <strong>
      📌 适用场景
     </strong>
    </h4>
    <p>
     当
     <strong>
      两个表之间是多对多关系
     </strong>
     ，并且需要
     <strong>
      通过中间表
     </strong>
     来关联数据。例如：
    </p>
    <ul>
     <li>
      <strong>
       用户
       <code>
        users
       </code>
      </strong>
      和
      <strong>
       角色
       <code>
        roles
       </code>
      </strong>
      之间是多对多关系。
     </li>
     <li>
      <strong>
       中间表
       <code>
        access
       </code>
      </strong>
      记录用户与角色的对应关系。
     </li>
    </ul>
    <h4>
     <a id="__10">
     </a>
     <strong>
      🛠 数据库结构
     </strong>
    </h4>
    <pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> users <span class="token punctuation">(</span>
    id <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
    name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> roles <span class="token punctuation">(</span>
    id <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
    role_name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> access <span class="token punctuation">(</span>
    user_id <span class="token keyword">INT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    role_id <span class="token keyword">INT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> role_id<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>user_id<span class="token punctuation">)</span> <span class="token keyword">REFERENCES</span> users<span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token keyword">ON</span> <span class="token keyword">DELETE</span> <span class="token keyword">CASCADE</span><span class="token punctuation">,</span>
    <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>role_id<span class="token punctuation">)</span> <span class="token keyword">REFERENCES</span> roles<span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token keyword">ON</span> <span class="token keyword">DELETE</span> <span class="token keyword">CASCADE</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <h4>
     <a id="_ThinkPHP__31">
     </a>
     <strong>
      🔎 ThinkPHP 代码
     </strong>
    </h4>
    <pre><code class="prism language-php"><span class="token keyword">class</span> <span class="token class-name-definition class-name">User</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span> 
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">roles</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">belongsToMany</span><span class="token punctuation">(</span><span class="token class-name static-context">Role</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'access'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     查询
     <strong>
      <code>
       用户 ID=1
      </code>
     </strong>
     的所有角色：
    </p>
    <pre><code class="prism language-php"><span class="token variable">$user</span> <span class="token operator">=</span> <span class="token class-name static-context">User</span><span class="token operator">::</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$roles</span> <span class="token operator">=</span> <span class="token variable">$user</span><span class="token operator">-&gt;</span><span class="token property">roles</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     最终生成的 SQL：
    </p>
    <pre><code class="prism language-sql"><span class="token keyword">SELECT</span> r<span class="token punctuation">.</span><span class="token operator">*</span>
<span class="token keyword">FROM</span> roles r
<span class="token keyword">JOIN</span> access a <span class="token keyword">ON</span> r<span class="token punctuation">.</span>id <span class="token operator">=</span> a<span class="token punctuation">.</span>role_id
<span class="token keyword">WHERE</span> a<span class="token punctuation">.</span>user_id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     ✅
     <strong>
      特点
     </strong>
    </p>
    <ul>
     <li>
      需要
      <strong>
       中间表（
       <code>
        access
       </code>
       ）
      </strong>
      存储关系。
     </li>
     <li>
      查询时
      <strong>
       通过
       <code>
        JOIN
       </code>
       中间表
      </strong>
      ，找到对应的
      <strong>
       多个
      </strong>
      角色（多对多）。
     </li>
     <li>
      <strong>
       数据模型：
      </strong>
      一个用户有多个角色，一个角色也可能属于多个用户。
     </li>
    </ul>
    <hr/>
    <h3>
     <a id="2_hasManyThrough_61">
     </a>
     <strong>
      2️⃣
      <code>
       hasManyThrough
      </code>
      （远程一对多）
     </strong>
    </h3>
    <h4>
     <a id="__62">
     </a>
     <strong>
      📌 适用场景
     </strong>
    </h4>
    <p>
     当
     <strong>
      两个表之间没有直接关联
     </strong>
     ，但可以
     <strong>
      通过中间表建立关系
     </strong>
     ，例如：
    </p>
    <ul>
     <li>
      <strong>
       每个城市（
       <code>
        cities
       </code>
       ）有多个用户（
       <code>
        users
       </code>
       ）
      </strong>
     </li>
     <li>
      <strong>
       每个用户（
       <code>
        users
       </code>
       ）有多个话题（
       <code>
        topics
       </code>
       ）
      </strong>
     </li>
     <li>
      <strong>
       但
       <code>
        cities
       </code>
       和
       <code>
        topics
       </code>
       之间没有直接的关系
      </strong>
      （需要通过
      <code>
       users
      </code>
      进行关联）
     </li>
    </ul>
    <h4>
     <a id="__68">
     </a>
     <strong>
      🛠 数据库结构
     </strong>
    </h4>
    <pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> cities <span class="token punctuation">(</span>
    id <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
    name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> users <span class="token punctuation">(</span>
    id <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
    name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    city_id <span class="token keyword">INT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>city_id<span class="token punctuation">)</span> <span class="token keyword">REFERENCES</span> cities<span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token keyword">ON</span> <span class="token keyword">DELETE</span> <span class="token keyword">CASCADE</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> topics <span class="token punctuation">(</span>
    id <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
    title <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    user_id <span class="token keyword">INT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>user_id<span class="token punctuation">)</span> <span class="token keyword">REFERENCES</span> users<span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token keyword">ON</span> <span class="token keyword">DELETE</span> <span class="token keyword">CASCADE</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <h4>
     <a id="_ThinkPHP__90">
     </a>
     <strong>
      🔎 ThinkPHP 代码
     </strong>
    </h4>
    <pre><code class="prism language-php"><span class="token keyword">class</span> <span class="token class-name-definition class-name">City</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span> 
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">topics</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">hasManyThrough</span><span class="token punctuation">(</span><span class="token class-name static-context">Topic</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name static-context">User</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     查询
     <strong>
      <code>
       城市 ID=1
      </code>
     </strong>
     的所有话题：
    </p>
    <pre><code class="prism language-php"><span class="token variable">$city</span> <span class="token operator">=</span> <span class="token class-name static-context">City</span><span class="token operator">::</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$topics</span> <span class="token operator">=</span> <span class="token variable">$city</span><span class="token operator">-&gt;</span><span class="token property">topics</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     最终生成的 SQL：
    </p>
    <pre><code class="prism language-sql"><span class="token keyword">SELECT</span> t<span class="token punctuation">.</span><span class="token operator">*</span>
<span class="token keyword">FROM</span> topics t
<span class="token keyword">JOIN</span> users u <span class="token keyword">ON</span> t<span class="token punctuation">.</span>user_id <span class="token operator">=</span> u<span class="token punctuation">.</span>id
<span class="token keyword">WHERE</span> u<span class="token punctuation">.</span>city_id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     ✅
     <strong>
      特点
     </strong>
    </p>
    <ul>
     <li>
      <strong>
       没有中间表
      </strong>
      （不像
      <code>
       belongsToMany
      </code>
      ）。
     </li>
     <li>
      需要通过
      <strong>
       另一张表（
       <code>
        users
       </code>
       ）
      </strong>
      进行
      <strong>
       跨表关联查询
      </strong>
      。
     </li>
     <li>
      <strong>
       数据模型：
      </strong>
      一个
      <strong>
       城市
      </strong>
      有多个
      <strong>
       话题
      </strong>
      ，但
      <strong>
       城市表和话题表之间无直接关系
      </strong>
      ，只能通过
      <code>
       users
      </code>
      关联。
     </li>
    </ul>
    <hr/>
    <h3>
     <a id="__120">
     </a>
     <strong>
      🔎 主要区别总结
     </strong>
    </h3>
    <table>
     <thead>
      <tr>
       <th>
        关联方式
       </th>
       <th>
        适用场景
       </th>
       <th>
        需要中间表？
       </th>
       <th>
        关联方式
       </th>
       <th>
        MySQL 查询
       </th>
       <th>
        关联模型
       </th>
       <th>
        关系类型
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        <strong>
         <code>
          belongsToMany
         </code>
         （多对多）
        </strong>
       </td>
       <td>
        用户 - 角色
       </td>
       <td>
        ✅ 需要（
        <code>
         access
        </code>
        ）
       </td>
       <td>
        <code>
         JOIN
        </code>
        中间表
       </td>
       <td>
        <code>
         JOIN access
        </code>
       </td>
       <td>
        <code>
         User -&gt; roles()
        </code>
       </td>
       <td>
        多对多
       </td>
      </tr>
      <tr>
       <td>
        <strong>
         <code>
          hasManyThrough
         </code>
         （远程一对多）
        </strong>
       </td>
       <td>
        城市 - 话题
       </td>
       <td>
        ❌ 不需要
       </td>
       <td>
        通过
        <strong>
         另一张表
        </strong>
        远程关联
       </td>
       <td>
        <code>
         JOIN users
        </code>
       </td>
       <td>
        <code>
         City -&gt; topics()
        </code>
       </td>
       <td>
        远程一对多
       </td>
      </tr>
     </tbody>
    </table>
    <hr/>
    <h3>
     <a id="__128">
     </a>
     <strong>
      🛠 用类比解释
     </strong>
    </h3>
    <h4>
     <a id="belongsToMany_129">
     </a>
     <code>
      belongsToMany
     </code>
     （多对多）
    </h4>
    <p>
     像是
     <strong>
      学生（User）和课程（Role）
     </strong>
     之间的关系：
    </p>
    <ul>
     <li>
      一个学生可以选多门课
     </li>
     <li>
      一门课可以有多个学生
     </li>
     <li>
      但学生和课程
      <strong>
       不是直接关联的
      </strong>
      ，而是通过
      <strong>
       选课表（access）
      </strong>
      连接的。
     </li>
    </ul>
    <h4>
     <a id="hasManyThrough_135">
     </a>
     <code>
      hasManyThrough
     </code>
     （远程一对多）
    </h4>
    <p>
     像是
     <strong>
      学校（City）和课表（Topic）
     </strong>
     之间的关系：
    </p>
    <ul>
     <li>
      每个
      <strong>
       学校
      </strong>
      有多个
      <strong>
       学生
      </strong>
     </li>
     <li>
      每个
      <strong>
       学生
      </strong>
      有多个
      <strong>
       课表
      </strong>
     </li>
     <li>
      但
      <strong>
       学校和课表
      </strong>
      之间
      <strong>
       没有直接关系
      </strong>
      ，只能通过
      <strong>
       学生表
      </strong>
      关联。
     </li>
    </ul>
    <hr/>
    <h3>
     <a id="__143">
     </a>
     <strong>
      ✅ 结论
     </strong>
    </h3>
    <p>
     虽然
     <strong>
      <code>
       belongsToMany
      </code>
      和
      <code>
       hasManyThrough
      </code>
      都使用
      <code>
       JOIN
      </code>
      查询
     </strong>
     ，但：
    </p>
    <ol>
     <li>
      <strong>
       <code>
        belongsToMany
       </code>
       是多对多关系，必须有中间表
      </strong>
      （
      <code>
       access
      </code>
      ）。
     </li>
     <li>
      <strong>
       <code>
        hasManyThrough
       </code>
       远程一对多，不需要中间表，但需要一个中间关联模型
      </strong>
      （如
      <code>
       users
      </code>
      ）。
     </li>
     <li>
      <strong>
       SQL 查询方式不同
      </strong>
      ：
      <ul>
       <li>
        <code>
         belongsToMany
        </code>
        直接
        <code>
         JOIN
        </code>
        <strong>
         中间表
        </strong>
        。
       </li>
       <li>
        <code>
         hasManyThrough
        </code>
        <strong>
         远程查询，
         <code>
          JOIN
         </code>
         另一张表
        </strong>
        。
       </li>
      </ul>
     </li>
    </ol>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f:2f626c6f672e6373646e2e6e65742f6c69757275696161612f:61727469636c652f64657461696c732f313436323633323538" class_="artid" style="display:none">
 </p>
</div>


