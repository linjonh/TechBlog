---
layout: post
title: "Hadoop详解Zookeeper选主流程"
date: 2025-03-08 21:10:28 +0800
description: "流程分析可以得出：要使Leader获得多数Server的支持，则Server总数必须是奇数2n+1（一般为3，5，7）, 且存活的Server的数目不得少于n+1。是事务 ID，表示 Server 处理的最新事务，zxid 更大的 Server 处理了更多的事务，拥有更完整的数据，减少数据同步的开销。是 Server 的唯一标识，是一个静态配置的值，用于解决完全冲突的情况。表示 Leader 的任期，是一个全局递增的编号，可以确保选举出的 Leader 是最新的，避免旧 Leader 重新当选。"
keywords: "【Hadoop】详解Zookeeper选主流程"
categories: ['未分类']
tags: ['服务器', 'Zookeeper', 'Hadoop']
artid: "146120356"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146120356
    alt: "Hadoop详解Zookeeper选主流程"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146120356
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146120356
cover: https://bing.ee123.net/img/rand?artid=146120356
image: https://bing.ee123.net/img/rand?artid=146120356
img: https://bing.ee123.net/img/rand?artid=146120356
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     【Hadoop】详解Zookeeper选主流程
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <h4>
     <strong>
      1. ZooKeeper 的工作原理
     </strong>
    </h4>
    <p>
     Zookeeper 的核心是
     <strong>
      Zab协议
     </strong>
     。Zab协议有两种模式，它们分别是
     <strong>
      恢复模式
     </strong>
     （选主）和
     <strong>
      广播模式
     </strong>
     （同步）。
    </p>
    <p>
     为了保证事务的顺序一致性，Zookeeper采用了递增的事务id号
     <strong>
      (zxid)来标识事务
     </strong>
     。所有的提议(proposal)都在被提出的时候加上了 zxid,  zxid 是一个 64位的数字，它的
     <strong>
      高 32 位
     </strong>
     是
     <strong>
      epoch
     </strong>
     , 用来
     <strong>
      表示 Leader 的任期
     </strong>
     ，
     <strong>
      标识Leader关系是否改变
     </strong>
     ，每当一个Leader被选出来时，它都会有一 个新的epoch, 表示进入新的 Leader 时期。Zxid的
     <strong>
      低 32 位
     </strong>
     用于递增计数，表示在当前
     <strong>
      Leader 任期内的事务顺序
     </strong>
     ，
     <strong>
      确保事务按全局顺序执行。
     </strong>
    </p>
    <h4>
     <strong>
      2.Leader 选举流程
     </strong>
    </h4>
    <p>
     当 Leader 失效时，ZooKeeper 会通过
     <strong>
      Zab 协议
     </strong>
     （ZooKeeper Atomic Broadcast）选举新的 Leader。
    </p>
    <p>
     Zookeeper 的选举算法有两种：一种是基于 basic paxos 实现的，另外一种是基于 fast paxos 算法实现的。系统默认的选举算法为fast paxos。
    </p>
    <p>
     简单讲讲
     <strong>
      Basic Paxos
     </strong>
     流程：
    </p>
    <ol>
     <li>
      由发起选举的 Server 线程担任，负责统计投票结果并推荐 Leader。
     </li>
     <li>
      选举线程向所有 Server（包括自己）发起询问。
     </li>
     <li>
      选举线程收到回复后，验证回复是否是自己发起的询问（检查 zxid 是否一致），然后获取对方的 id（myid）并存储到当前询问对象列表中。最后获取对方提议的 Leader 信息（id, zxid），并存储到投票记录表中。
     </li>
     <li>
      收到所有 Server 回复后，选举线程计算 zxid 最大的 Server。并将该 Server 设置为下一次投票的推荐 Leader。
     </li>
     <li>
      如果某个 Server 获得
      <strong>
       超过半数
      </strong>
      （n/2 + 1）的票数，则成为 Leader。否则，继续选举流程，直到选出 Leader。
     </li>
    </ol>
    <p>
     通过
     <strong>
      Basic Paxos
     </strong>
     流程分析可以得出：要使Leader获得多数Server的支持，则Server总数必须是奇数2n+1（一般为3，5，7）, 且存活的Server的数目不得少于n+1。每个Server启动后都会重复以上流程。
    </p>
    <p>
     而
     <strong>
      Fast Paxos
     </strong>
     流程是在选举过程中，某Server首先向所有Server提议自己要成为leader, 当其它Server收到提议以后，
     <strong>
      解决epoch和 zxid的冲突（依次比较epoch，zxid，myid的顺序，值较大的一方获得投票）
     </strong>
     ，并接受对方的提议，然后向对方发送接受提议完成的消息，重复这个流程，最后一定能选举出Leader。
    </p>
    <ul>
     <li>
      <strong>
       Basic Paxos
      </strong>
      强调一致性和容错性，适用于需要强一致性的场景。
     </li>
     <li>
      <strong>
       Fast Paxos
      </strong>
      通过减少消息传递的轮次，快速选出一个 Leader。适用于需要快速选举 Leader 的分布式系统场景。
     </li>
    </ul>
    <blockquote>
     <p>
      Q:选举时为什么按照这个顺序
      <strong>
       epoch &gt; zxid &gt; myid
      </strong>
      比较？
     </p>
    </blockquote>
    <blockquote>
     <p>
      A：
      <strong>
       epoch
      </strong>
      表示 Leader 的任期，是一个全局递增的编号，可以确保选举出的 Leader 是最新的，避免旧 Leader 重新当选。
      <strong>
       zxid
      </strong>
      是事务 ID，表示 Server 处理的最新事务，zxid 更大的 Server 处理了更多的事务，拥有更完整的数据，减少数据同步的开销。
      <strong>
       myid
      </strong>
      是 Server 的唯一标识，是一个静态配置的值，用于解决完全冲突的情况。选择 myid 更大的 Server 可以确保选举结果的唯一性。
     </p>
    </blockquote>
   </div>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f:672e6373646e2e6e65742f323330325f37393935323537342f:61727469636c652f64657461696c732f313436313230333536" class_="artid" style="display:none">
 </p>
</div>


