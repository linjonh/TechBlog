---
layout: post
title: "编程助手学Python-Deepseek对Langchain的调用OpenAI的GPT-3.5模型起名字与格式化输出"
date: 2025-03-13 10:22:42 +0800
description: "自定义的输出解析器，继承自。parse方法text（字符串）。功能：打印文本内容，并将文本按逗号分隔成列表。返回：分隔后的列表。功能：代码实现了一个基于 OpenAI 模型的起名服务，生成 5 个名字并以逗号分隔的形式返回。关键点使用创建动态提示。通过调用模型生成文本。"
keywords: "编程助手学Python--Deepseek对Langchain的调用OpenAI的GPT-3.5模型起名字与格式化输出"
categories: ['编程助手学Python']
tags: ['Python', 'Langchain', '3']
artid: "146224063"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146224063
    alt: "编程助手学Python-Deepseek对Langchain的调用OpenAI的GPT-3.5模型起名字与格式化输出"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146224063
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146224063
cover: https://bing.ee123.net/img/rand?artid=146224063
image: https://bing.ee123.net/img/rand?artid=146224063
img: https://bing.ee123.net/img/rand?artid=146224063
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     编程助手学Python--Deepseek对Langchain的调用OpenAI的GPT-3.5模型起名字与格式化输出
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <p>
    </p>
    <pre><code class="prism language-python"><span class="token keyword">from</span> langchain<span class="token punctuation">.</span>llms <span class="token keyword">import</span> OpenAI
<span class="token keyword">from</span> langchain<span class="token punctuation">.</span>prompts <span class="token keyword">import</span> PromptTemplate
<span class="token keyword">from</span> langchain<span class="token punctuation">.</span>schema <span class="token keyword">import</span> BaseOutputParser
<span class="token keyword">import</span> os


<span class="token keyword">class</span> <span class="token class-name">CommaSeparatedListOutPutParser</span><span class="token punctuation">(</span>BaseOutputParser<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">parse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> text<span class="token punctuation">:</span><span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span>
        <span class="token keyword">return</span> text<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span>
    

os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">"OPENAI_API_KEY"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"sk-xx"</span>
os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">"OPENAI_API_BASE"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"https://ai.com/v1"</span>

OPENAI_API_KEY <span class="token operator">=</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">"OPENAI_API_KEY"</span><span class="token punctuation">)</span>
OPENAI_API_BASE <span class="token operator">=</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">"OPENAI_API_BASE"</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>OPENAI_API_KEY<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>OPENAI_API_BASE<span class="token punctuation">)</span>
llm <span class="token operator">=</span> OpenAI<span class="token punctuation">(</span>
    model<span class="token operator">=</span><span class="token string">"gpt-3.5-turbo-instruct"</span><span class="token punctuation">,</span>
    temperature<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    openai_api_key<span class="token operator">=</span>OPENAI_API_KEY<span class="token punctuation">,</span>
    openai_api_base<span class="token operator">=</span>OPENAI_API_BASE
<span class="token punctuation">)</span>

prompt <span class="token operator">=</span> PromptTemplate<span class="token punctuation">.</span>from_template<span class="token punctuation">(</span><span class="token string">"你是一名起名老师，你的客户是一位新生儿的父母，他们想要给自己的孩子起一个名字。请你为他们提供{num}个名字,请返回以逗号分隔的列表形式。仅返回逗号分隔的列表，不要返回其他内容。"</span><span class="token punctuation">)</span>
message <span class="token operator">=</span> prompt<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>num<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
res <span class="token operator">=</span> llm<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>message<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>   详细解释
</code></pre>
    <ul>
     <li>
      <p>
       以下是对代码的详细解释，包括每个部分的功能、实现逻辑以及代码的作用：
      </p>
      <hr/>
      <h4>
       <a id="1__39">
       </a>
       1. 导入库
      </h4>
      <pre><code class="prism language-python"><span class="token keyword">from</span> langchain<span class="token punctuation">.</span>llms <span class="token keyword">import</span> OpenAI
<span class="token keyword">from</span> langchain<span class="token punctuation">.</span>prompts <span class="token keyword">import</span> PromptTemplate
<span class="token keyword">from</span> langchain<span class="token punctuation">.</span>schema <span class="token keyword">import</span> BaseOutputParser
<span class="token keyword">import</span> os
</code></pre>
      <ul>
       <li>
        <strong>
         <code>
          langchain.llms
         </code>
        </strong>
        ：
        <code>
         langchain
        </code>
        是一个用于构建基于大语言模型（LLM）应用的框架。
        <code>
         OpenAI
        </code>
        是
        <code>
         langchain
        </code>
        中用于与 OpenAI 模型交互的类。
       </li>
       <li>
        <strong>
         <code>
          langchain.prompts
         </code>
        </strong>
        ：提供了
        <code>
         PromptTemplate
        </code>
        类，用于创建和管理提示模板。
       </li>
       <li>
        <strong>
         <code>
          langchain.schema
         </code>
        </strong>
        ：提供了
        <code>
         BaseOutputParser
        </code>
        类，用于解析模型输出。
       </li>
       <li>
        <strong>
         <code>
          os
         </code>
        </strong>
        ：Python 标准库，用于与操作系统交互，例如读取环境变量。
       </li>
      </ul>
      <hr/>
      <h4>
       <a id="2__56">
       </a>
       2. 自定义输出解析器
      </h4>
      <pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">CommaSeparatedListOutPutParser</span><span class="token punctuation">(</span>BaseOutputParser<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">parse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> text<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span>
        <span class="token keyword">return</span> text<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span>
</code></pre>
      <ul>
       <li>
        <strong>
         <code>
          CommaSeparatedListOutPutParser
         </code>
        </strong>
        ：自定义的输出解析器，继承自
        <code>
         BaseOutputParser
        </code>
        。
       </li>
       <li>
        <strong>
         <code>
          parse
         </code>
         方法
        </strong>
        ：
        <ul>
         <li>
          输入：
          <code>
           text
          </code>
          （字符串）。
         </li>
         <li>
          功能：打印文本内容，并将文本按逗号分隔成列表。
         </li>
         <li>
          返回：分隔后的列表。
         </li>
        </ul>
       </li>
      </ul>
      <hr/>
      <h4>
       <a id="3__74">
       </a>
       3. 设置环境变量
      </h4>
      <pre><code class="prism language-python">os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">"OPENAI_API_KEY"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"sk-xx"</span>
os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">"OPENAI_API_BASE"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"https://ai.com/v1"</span>
</code></pre>
      <ul>
       <li>
        <strong>
         <code>
          os.environ
         </code>
        </strong>
        ：用于设置或读取环境变量。
       </li>
       <li>
        <strong>
         <code>
          OPENAI_API_KEY
         </code>
        </strong>
        ：OpenAI API 的密钥，用于身份验证。
        <code>
         "sk-xx"
        </code>
        是示例密钥，实际使用时需要替换为有效的 API 密钥。
       </li>
       <li>
        <strong>
         <code>
          OPENAI_API_BASE
         </code>
        </strong>
        ：OpenAI API 的基础 URL。这里设置为
        <code>
         "https://ai.com/v1"
        </code>
        ，可能是自定义的 API 端点（例如，使用代理或本地部署的 OpenAI 兼容服务）。
       </li>
      </ul>
      <hr/>
      <h4>
       <a id="4__88">
       </a>
       4. 读取环境变量
      </h4>
      <pre><code class="prism language-python">OPENAI_API_KEY <span class="token operator">=</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">"OPENAI_API_KEY"</span><span class="token punctuation">)</span>
OPENAI_API_BASE <span class="token operator">=</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">"OPENAI_API_BASE"</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>OPENAI_API_KEY<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>OPENAI_API_BASE<span class="token punctuation">)</span>
</code></pre>
      <ul>
       <li>
        <strong>
         <code>
          os.getenv
         </code>
        </strong>
        ：从环境变量中读取值。
       </li>
       <li>
        <strong>
         <code>
          OPENAI_API_KEY
         </code>
         和
         <code>
          OPENAI_API_BASE
         </code>
        </strong>
        ：分别存储 API 密钥和 API 基础 URL。
       </li>
       <li>
        <strong>
         <code>
          print
         </code>
        </strong>
        ：输出这两个变量的值，用于调试或验证。
       </li>
      </ul>
      <hr/>
      <h4>
       <a id="5__OpenAI_LLM__104">
       </a>
       5. 初始化 OpenAI LLM 对象
      </h4>
      <pre><code class="prism language-python">llm <span class="token operator">=</span> OpenAI<span class="token punctuation">(</span>
    model<span class="token operator">=</span><span class="token string">"gpt-3.5-turbo-instruct"</span><span class="token punctuation">,</span>
    temperature<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    openai_api_key<span class="token operator">=</span>OPENAI_API_KEY<span class="token punctuation">,</span>
    openai_api_base<span class="token operator">=</span>OPENAI_API_BASE
<span class="token punctuation">)</span>
</code></pre>
      <ul>
       <li>
        <strong>
         <code>
          OpenAI
         </code>
        </strong>
        ：
        <code>
         langchain
        </code>
        提供的类，用于与 OpenAI 模型交互。
       </li>
       <li>
        <strong>
         参数说明
        </strong>
        ：
        <ul>
         <li>
          <strong>
           <code>
            model
           </code>
          </strong>
          ：指定使用的模型，这里是
          <code>
           "gpt-3.5-turbo-instruct"
          </code>
          ，适用于指令类任务。
         </li>
         <li>
          <strong>
           <code>
            temperature
           </code>
          </strong>
          ：控制生成文本的随机性。
          <code>
           0
          </code>
          表示完全确定性输出，适合需要精确答案的任务。
         </li>
         <li>
          <strong>
           <code>
            openai_api_key
           </code>
          </strong>
          ：API 密钥，这里正确使用了
          <code>
           OPENAI_API_KEY
          </code>
          变量。
         </li>
         <li>
          <strong>
           <code>
            openai_api_base
           </code>
          </strong>
          ：API 基础 URL，这里正确使用了
          <code>
           OPENAI_API_BASE
          </code>
          变量。
         </li>
        </ul>
       </li>
      </ul>
      <hr/>
      <h4>
       <a id="6__125">
       </a>
       6. 创建提示模板并生成提示
      </h4>
      <pre><code class="prism language-python">prompt <span class="token operator">=</span> PromptTemplate<span class="token punctuation">.</span>from_template<span class="token punctuation">(</span><span class="token string">"你是一名起名老师，你的客户是一位新生儿的父母，他们想要给自己的孩子起一个名字。请你为他们提供{num}个名字,请返回以逗号分隔的列表形式。仅返回逗号分隔的列表，不要返回其他内容。"</span><span class="token punctuation">)</span>
message <span class="token operator">=</span> prompt<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>num<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
</code></pre>
      <ul>
       <li>
        <strong>
         <code>
          PromptTemplate.from_template
         </code>
        </strong>
        ：创建一个提示模板，模板中包含一个占位符
        <code>
         {num}
        </code>
        。
       </li>
       <li>
        <strong>
         <code>
          prompt.format(num=5)
         </code>
        </strong>
        ：将占位符
        <code>
         {num}
        </code>
        替换为
        <code>
         5
        </code>
        ，生成最终的提示文本。
       </li>
      </ul>
      <hr/>
      <h4>
       <a id="7__137">
       </a>
       7. 调用模型生成文本
      </h4>
      <pre><code class="prism language-python">res <span class="token operator">=</span> llm<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>message<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
</code></pre>
      <ul>
       <li>
        <strong>
         <code>
          llm.predict
         </code>
        </strong>
        ：调用
        <code>
         OpenAI
        </code>
        对象的
        <code>
         predict
        </code>
        方法，向模型发送提示文本，并返回生成的文本。
       </li>
       <li>
        <strong>
         <code>
          print(res)
         </code>
        </strong>
        ：输出模型的生成结果。
       </li>
      </ul>
      <hr/>
      <h4>
       <a id="8__150">
       </a>
       8. 代码运行结果
      </h4>
      <p>
       假设模型返回的结果是：
      </p>
      <pre><code class="prism language-python">张伟<span class="token punctuation">,</span>李娜<span class="token punctuation">,</span>王芳<span class="token punctuation">,</span>刘洋<span class="token punctuation">,</span>赵敏
</code></pre>
      <p>
       输出将是：
      </p>
      <pre><code class="prism language-python">张伟<span class="token punctuation">,</span>李娜<span class="token punctuation">,</span>王芳<span class="token punctuation">,</span>刘洋<span class="token punctuation">,</span>赵敏
</code></pre>
      <hr/>
      <h4>
       <a id="9__168">
       </a>
       9. 代码总结
      </h4>
      <ul>
       <li>
        <strong>
         功能
        </strong>
        ：代码实现了一个基于 OpenAI 模型的起名服务，生成 5 个名字并以逗号分隔的形式返回。
       </li>
       <li>
        <strong>
         关键点
        </strong>
        ：
        <ul>
         <li>
          使用
          <code>
           PromptTemplate
          </code>
          创建动态提示。
         </li>
         <li>
          通过
          <code>
           llm.predict
          </code>
          调用模型生成文本。
         </li>
        </ul>
       </li>
      </ul>
      <hr/>
      <h4>
       <a id="10__177">
       </a>
       10. 改进建议
      </h4>
      <ol>
       <li>
        <p>
         <strong>
          错误处理
         </strong>
         ：
        </p>
        <ul>
         <li>
          <p>
           在调用模型时，可以添加错误处理逻辑，防止因网络问题或 API 调用失败而导致程序崩溃。
          </p>
         </li>
         <li>
          <p>
           示例：
          </p>
          <pre><code class="prism language-python"><span class="token keyword">try</span><span class="token punctuation">:</span>
    res <span class="token operator">=</span> llm<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>message<span class="token punctuation">)</span>
<span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"模型调用失败:"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>
    res <span class="token operator">=</span> <span class="token string">""</span>
</code></pre>
         </li>
        </ul>
       </li>
       <li>
        <p>
         <strong>
          安全性
         </strong>
         ：
        </p>
        <ul>
         <li>
          避免将 API 密钥硬编码在代码中，建议通过环境变量或配置文件管理密钥。
         </li>
        </ul>
       </li>
       <li>
        <p>
         <strong>
          扩展性
         </strong>
         ：
        </p>
        <ul>
         <li>
          可以将提示模板和模型调用封装成函数，方便复用和扩展。
         </li>
        </ul>
       </li>
      </ol>
      <hr/>
      <h4>
       <a id="_204">
       </a>
       修正后的完整代码
      </h4>
      <pre><code class="prism language-python"><span class="token keyword">from</span> langchain<span class="token punctuation">.</span>llms <span class="token keyword">import</span> OpenAI
<span class="token keyword">from</span> langchain<span class="token punctuation">.</span>prompts <span class="token keyword">import</span> PromptTemplate
<span class="token keyword">from</span> langchain<span class="token punctuation">.</span>schema <span class="token keyword">import</span> BaseOutputParser
<span class="token keyword">import</span> os


<span class="token keyword">class</span> <span class="token class-name">CommaSeparatedListOutPutParser</span><span class="token punctuation">(</span>BaseOutputParser<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">parse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> text<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"模型输出:"</span><span class="token punctuation">,</span> text<span class="token punctuation">)</span>
        <span class="token keyword">return</span> text<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span>


<span class="token comment"># 设置环境变量</span>
os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">"OPENAI_API_KEY"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"sk-xx"</span>
os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">"OPENAI_API_BASE"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"https://ai.com/v1"</span>

<span class="token comment"># 读取环境变量</span>
OPENAI_API_KEY <span class="token operator">=</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">"OPENAI_API_KEY"</span><span class="token punctuation">)</span>
OPENAI_API_BASE <span class="token operator">=</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">"OPENAI_API_BASE"</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"API Key:"</span><span class="token punctuation">,</span> OPENAI_API_KEY<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"API Base:"</span><span class="token punctuation">,</span> OPENAI_API_BASE<span class="token punctuation">)</span>

<span class="token comment"># 初始化 OpenAI LLM 对象</span>
llm <span class="token operator">=</span> OpenAI<span class="token punctuation">(</span>
    model<span class="token operator">=</span><span class="token string">"gpt-3.5-turbo-instruct"</span><span class="token punctuation">,</span>
    temperature<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    openai_api_key<span class="token operator">=</span>OPENAI_API_KEY<span class="token punctuation">,</span>
    openai_api_base<span class="token operator">=</span>OPENAI_API_BASE
<span class="token punctuation">)</span>

<span class="token comment"># 创建提示模板并生成提示</span>
prompt <span class="token operator">=</span> PromptTemplate<span class="token punctuation">.</span>from_template<span class="token punctuation">(</span>
    <span class="token string">"你是一名起名老师，你的客户是一位新生儿的父母，他们想要给自己的孩子起一个名字。请你为他们提供{num}个名字,请返回以逗号分隔的列表形式。仅返回逗号分隔的列表，不要返回其他内容。"</span>
<span class="token punctuation">)</span>
message <span class="token operator">=</span> prompt<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>num<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>

<span class="token comment"># 调用模型生成文本</span>
<span class="token keyword">try</span><span class="token punctuation">:</span>
    res <span class="token operator">=</span> llm<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>message<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"模型生成结果:"</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span>
<span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"模型调用失败:"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>
    res <span class="token operator">=</span> <span class="token string">""</span>
</code></pre>
     </li>
    </ul>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="6874747073:3a2f2f626c6f672e6373646e2e6e65742f73756e79616f782f:61727469636c652f64657461696c732f313436323234303633" class_="artid" style="display:none">
 </p>
</div>


