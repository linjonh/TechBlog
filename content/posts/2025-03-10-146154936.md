---
layout: post
title: "OpenGL-ES-帧缓冲对象Frame-Buffer-Object离屏渲染获取纹理贴图"
date: 2025-03-10 15:01:46 +0800
description: "OpenGL ES -＞帧缓冲对象(Frame Buffer Object)离屏渲染获取纹理贴图的Kotlin代码"
keywords: "qopenglframebufferobject 转成纹理"
categories: ['Opengl', 'Es']
tags: ['贴图', '开发语言', 'Studio', 'Kotlin', 'Android', 'Android']
artid: "146154936"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146154936
    alt: "OpenGL-ES-帧缓冲对象Frame-Buffer-Object离屏渲染获取纹理贴图"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146154936
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146154936
cover: https://bing.ee123.net/img/rand?artid=146154936
image: https://bing.ee123.net/img/rand?artid=146154936
img: https://bing.ee123.net/img/rand?artid=146154936
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     OpenGL ES -＞帧缓冲对象(Frame Buffer Object)离屏渲染获取纹理贴图
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="XML_0">
     </a>
     XML文件
    </h2>
    <pre><code class="prism language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>RelativeLayout</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>android</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.android.com/apk/res/android<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- OpenGL渲染区域 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>com.example.myapplication.MyGLSurfaceView</span>
        <span class="token attr-name"><span class="token namespace">android:</span>id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@+id/gl_surface_view<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>

    <span class="token comment">&lt;!-- 用于显示FBO截图的ImageView --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ImageView</span>
        <span class="token attr-name"><span class="token namespace">android:</span>id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@+id/image_view<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>120dp<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>120dp<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_alignParentEnd</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_alignParentTop</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_margin</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>16dp<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>background</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#33000000<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>contentDescription</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>FBO截图预览<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>

    <span class="token comment">&lt;!-- 捕获FBO图像的按钮 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Button</span>
        <span class="token attr-name"><span class="token namespace">android:</span>id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@+id/capture_button<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>wrap_content<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>wrap_content<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_alignParentBottom</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_centerHorizontal</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_marginBottom</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>16dp<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>捕获FBO图像<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>padding</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>12dp<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>RelativeLayout</span><span class="token punctuation">&gt;</span></span>
</code></pre>
    <h2>
     <a id="Activity_37">
     </a>
     <code>
      Activity
     </code>
     代码
    </h2>
    <pre><code class="prism language-kotlin"><span class="token keyword">class</span> MainActivity <span class="token operator">:</span> <span class="token function">AppCompatActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">lateinit</span> <span class="token keyword">var</span> glSurfaceView<span class="token operator">:</span> MyGLSurfaceView
    <span class="token keyword">private</span> <span class="token keyword">lateinit</span> <span class="token keyword">var</span> imageView<span class="token operator">:</span> ImageView
    <span class="token keyword">private</span> <span class="token keyword">lateinit</span> <span class="token keyword">var</span> captureButton<span class="token operator">:</span> Button

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token operator">:</span> Bundle<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span>
        <span class="token function">setContentView</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_main<span class="token punctuation">)</span>
        glSurfaceView <span class="token operator">=</span> <span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>gl_surface_view<span class="token punctuation">)</span>
        imageView <span class="token operator">=</span> <span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>image_view<span class="token punctuation">)</span>
        captureButton <span class="token operator">=</span> <span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>capture_button<span class="token punctuation">)</span>
        captureButton<span class="token punctuation">.</span><span class="token function">setOnTouchListener</span><span class="token punctuation">(</span><span class="token keyword">object</span> <span class="token operator">:</span> View<span class="token punctuation">.</span><span class="token function">OnTouchListener</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onTouch</span><span class="token punctuation">(</span>v<span class="token operator">:</span> View<span class="token operator">?</span><span class="token punctuation">,</span> event<span class="token operator">:</span> MotionEvent<span class="token operator">?</span><span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">when</span><span class="token punctuation">(</span>event<span class="token operator">?</span><span class="token punctuation">.</span>action<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    MotionEvent<span class="token punctuation">.</span>ACTION_DOWN <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token function">getFrameBufferBitmap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">let</span> <span class="token punctuation">{<!-- --></span>
                            imageView<span class="token punctuation">.</span><span class="token function">setImageBitmap</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    MotionEvent<span class="token punctuation">.</span>ACTION_UP <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token function">getFrameBufferBitmap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">let</span> <span class="token punctuation">{<!-- --></span>
                            imageView<span class="token punctuation">.</span><span class="token function">setImageBitmap</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">else</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">getFrameBufferBitmap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> Bitmap<span class="token operator">?</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> glSurfaceView<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">getFrameBufferBitmap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h2>
     <a id="GLSurfaceView_75">
     </a>
     自定义
     <code>
      GLSurfaceView
     </code>
     代码
    </h2>
    <pre><code class="prism language-kotlin"><span class="token keyword">class</span> <span class="token function">MyGLSurfaceView</span><span class="token punctuation">(</span>context<span class="token operator">:</span> Context<span class="token punctuation">,</span> attrs<span class="token operator">:</span> AttributeSet<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">GLSurfaceView</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> mRenderer <span class="token operator">=</span> <span class="token function">MyGLRenderer</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>

    <span class="token keyword">init</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 设置 OpenGL ES 3.0 版本</span>
        <span class="token function">setEGLContextClientVersion</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
        <span class="token function">setRenderer</span><span class="token punctuation">(</span>mRenderer<span class="token punctuation">)</span>
        <span class="token comment">// 设置渲染模式, 仅在需要重新绘制时才进行渲染，以节省资源</span>
        renderMode <span class="token operator">=</span> RENDERMODE_WHEN_DIRTY
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">getFrameBufferBitmap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Bitmap<span class="token operator">?</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> mRenderer<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">getFrameBufferBitmap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h2>
     <a id="GLSurfaceViewRenderer_93">
     </a>
     自定义
     <code>
      GLSurfaceView.Renderer
     </code>
     代码
    </h2>
    <pre><code class="prism language-kotlin"><span class="token keyword">class</span> <span class="token function">MyGLRenderer</span><span class="token punctuation">(</span><span class="token keyword">private</span> <span class="token keyword">val</span> mContext<span class="token operator">:</span> Context<span class="token punctuation">)</span> <span class="token operator">:</span> GLSurfaceView<span class="token punctuation">.</span><span class="token function">Renderer</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> mDrawData<span class="token operator">:</span> DrawData<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> mWidth <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> mHeight <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onSurfaceCreated</span><span class="token punctuation">(</span>gl<span class="token operator">:</span> GL10<span class="token operator">?</span><span class="token punctuation">,</span> config<span class="token operator">:</span> EGLConfig<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 当 Surface 创建时调用, 进行 OpenGL ES 环境的初始化操作, 设置清屏颜色为青蓝色 (Red=0, Green=0.5, Blue=0.5, Alpha=1)</span>
        GLES30<span class="token punctuation">.</span><span class="token function">glClearColor</span><span class="token punctuation">(</span><span class="token number">0.0f</span><span class="token punctuation">,</span> <span class="token number">0.5f</span><span class="token punctuation">,</span> <span class="token number">0.5f</span><span class="token punctuation">,</span> <span class="token number">1.0f</span><span class="token punctuation">)</span>
        mDrawData <span class="token operator">=</span> <span class="token function">DrawData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">initShader</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token function">initVertexBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token function">initTexture0</span><span class="token punctuation">(</span>mContext<span class="token punctuation">,</span> R<span class="token punctuation">.</span>drawable<span class="token punctuation">.</span>pic<span class="token punctuation">)</span>
            <span class="token function">initTexture1</span><span class="token punctuation">(</span>mContext<span class="token punctuation">,</span> R<span class="token punctuation">.</span>drawable<span class="token punctuation">.</span>bitmap_shader<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onSurfaceChanged</span><span class="token punctuation">(</span>gl<span class="token operator">:</span> GL10<span class="token operator">?</span><span class="token punctuation">,</span> width<span class="token operator">:</span> Int<span class="token punctuation">,</span> height<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 当 Surface 尺寸发生变化时调用，例如设备的屏幕方向发生改变, 设置视口为新的尺寸，视口是指渲染区域的大小</span>
        GLES30<span class="token punctuation">.</span><span class="token function">glViewport</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">)</span>
        mWidth <span class="token operator">=</span> width
        mHeight <span class="token operator">=</span> height
        mDrawData<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">computeMVPMatrix</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">)</span>
        mDrawData<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">initFrameBuffer</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onDrawFrame</span><span class="token punctuation">(</span>gl<span class="token operator">:</span> GL10<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 每一帧绘制时调用, 清除颜色缓冲区</span>
        GLES30<span class="token punctuation">.</span><span class="token function">glClear</span><span class="token punctuation">(</span>GLES30<span class="token punctuation">.</span>GL_COLOR_BUFFER_BIT<span class="token punctuation">)</span>
        mDrawData<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">enableTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        mDrawData<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">drawOffScreen</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        mDrawData<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">disableTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">getFrameBufferBitmap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Bitmap<span class="token operator">?</span> <span class="token punctuation">{<!-- --></span>
       <span class="token keyword">return</span> mDrawData<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">getScreenBitmap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h2>
     <a id="GLSurfaceViewRenderer_132">
     </a>
     <code>
      GLSurfaceView.Renderer
     </code>
     需要的绘制数据
    </h2>
    <pre><code class="prism language-kotlin"><span class="token keyword">class</span> DrawData <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> mProgram<span class="token operator">:</span> Int <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> NO_OFFSET <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> VERTEX_POS_DATA_SIZE <span class="token operator">=</span> <span class="token number">3</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> TEXTURE_POS_DATA_SIZE <span class="token operator">=</span> <span class="token number">2</span>
    <span class="token comment">// FBO(Frame Buffer Object), 帧缓冲对象，用于存储渲染后的图像</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> mFBO <span class="token operator">=</span> <span class="token function">IntArray</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment">// VAO(Vertex Array Object), 顶点数组对象, 用于存储VBO</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> mVAO <span class="token operator">=</span> <span class="token function">IntArray</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment">// VBO(Vertex Buffer Object), 顶点缓冲对象，用于存储顶点数据和纹理数据</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> mVBO <span class="token operator">=</span> <span class="token function">IntArray</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token comment">// IBO(Index Buffer Object), 索引缓冲对象，用于存储顶点索引数据</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> mIBO <span class="token operator">=</span> <span class="token function">IntArray</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment">// 纹理ID</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> mTextureID <span class="token operator">=</span> <span class="token function">IntArray</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token comment">// FBO中的纹理ID</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> mFBOTextureID <span class="token operator">=</span> <span class="token function">IntArray</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment">// 最终变化矩阵</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> mMVPMatrix <span class="token operator">=</span> <span class="token function">FloatArray</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span>
    <span class="token comment">// 投影矩阵</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> mProjectionMatrix <span class="token operator">=</span> <span class="token function">FloatArray</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span>
    <span class="token comment">// 相机矩阵</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> mViewMatrix <span class="token operator">=</span> <span class="token function">FloatArray</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span>
    <span class="token comment">// 视口比例</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> mViewPortRatio <span class="token operator">=</span> <span class="token number">1f</span>
    <span class="token comment">// 帧缓冲中的Bitmap</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> mFrameBufferBitmap<span class="token operator">:</span> Bitmap<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token comment">// 帧缓冲宽高</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> mFrameBufferWidth <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> mFrameBufferHeight <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token comment">// 帧缓冲最终变换矩阵</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> mFrameBufferMVPMatrix <span class="token operator">=</span> <span class="token function">FloatArray</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span>

    <span class="token comment">// 准备顶点坐标，分配直接内存</span>
    <span class="token comment">// OpenGL ES坐标系：原点在中心，X轴向右为正，Y轴向上为正，Z轴向外为正</span>
    <span class="token keyword">val</span> vertex <span class="token operator">=</span> <span class="token function">floatArrayOf</span><span class="token punctuation">(</span>
        <span class="token operator">-</span><span class="token number">1.0f</span><span class="token punctuation">,</span> <span class="token number">1.0f</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">,</span> <span class="token comment">// 左上</span>
        <span class="token operator">-</span><span class="token number">1.0f</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.0f</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">,</span> <span class="token comment">// 左下</span>
        <span class="token number">1.0f</span><span class="token punctuation">,</span> <span class="token number">1.0f</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">,</span> <span class="token comment">// 右上</span>
        <span class="token number">1.0f</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.0f</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">,</span> <span class="token comment">// 右下</span>
    <span class="token punctuation">)</span>

    <span class="token keyword">val</span> vertexBuffer <span class="token operator">=</span> ByteBuffer<span class="token punctuation">.</span><span class="token function">allocateDirect</span><span class="token punctuation">(</span>vertex<span class="token punctuation">.</span>size <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">order</span><span class="token punctuation">(</span>ByteOrder<span class="token punctuation">.</span><span class="token function">nativeOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">asFloatBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>vertex<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span>NO_OFFSET<span class="token punctuation">)</span>

    <span class="token comment">// 准备纹理坐标，分配直接内存</span>
    <span class="token comment">// 纹理坐标系：原点在左下角，X轴向右为正，Y轴向上为正</span>
    <span class="token keyword">val</span> textureCoords <span class="token operator">=</span> <span class="token function">floatArrayOf</span><span class="token punctuation">(</span>
        <span class="token number">0.0f</span><span class="token punctuation">,</span> <span class="token number">1.0f</span><span class="token punctuation">,</span> <span class="token comment">// 左上</span>
        <span class="token number">0.0f</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">,</span> <span class="token comment">// 左下</span>
        <span class="token number">1.0f</span><span class="token punctuation">,</span> <span class="token number">1.0f</span><span class="token punctuation">,</span> <span class="token comment">// 右上</span>
        <span class="token number">1.0f</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">,</span> <span class="token comment">// 右下</span>
    <span class="token punctuation">)</span>

    <span class="token keyword">val</span> textureBuffer <span class="token operator">=</span> ByteBuffer<span class="token punctuation">.</span><span class="token function">allocateDirect</span><span class="token punctuation">(</span>textureCoords<span class="token punctuation">.</span>size <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">order</span><span class="token punctuation">(</span>ByteOrder<span class="token punctuation">.</span><span class="token function">nativeOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">asFloatBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>textureCoords<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span>NO_OFFSET<span class="token punctuation">)</span>

    <span class="token comment">// 索引坐标，分配直接内存</span>
    <span class="token keyword">val</span> index <span class="token operator">=</span> <span class="token function">shortArrayOf</span><span class="token punctuation">(</span>
        <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment">// 第一个三角形</span>
        <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment">// 第二个三角形</span>
    <span class="token punctuation">)</span>

    <span class="token keyword">val</span> indexBuffer <span class="token operator">=</span> ByteBuffer<span class="token punctuation">.</span><span class="token function">allocateDirect</span><span class="token punctuation">(</span>index<span class="token punctuation">.</span>size <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">order</span><span class="token punctuation">(</span>ByteOrder<span class="token punctuation">.</span><span class="token function">nativeOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">asShortBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span>NO_OFFSET<span class="token punctuation">)</span>

    <span class="token comment">// 初始化着色器程序</span>
    <span class="token keyword">fun</span> <span class="token function">initShader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">val</span> vertexShaderCode <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">""</span></span>"#version <span class="token number">300</span> es
                uniform mat4 uMVPMatrix<span class="token punctuation">;</span> <span class="token comment">// 变换矩阵</span>
                <span class="token keyword">in</span> vec4 aPosition<span class="token punctuation">;</span> <span class="token comment">// 顶点坐标</span>
                <span class="token keyword">in</span> vec2 aTexCoord<span class="token punctuation">;</span> <span class="token comment">// 纹理坐标 </span>
                <span class="token keyword">out</span> vec2 vTexCoord<span class="token punctuation">;</span> 
                void <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 输出顶点坐标和纹理坐标到片段着色器</span>
                    gl_Position <span class="token operator">=</span> uMVPMatrix <span class="token operator">*</span> aPosition<span class="token punctuation">;</span> 
                    vTexCoord <span class="token operator">=</span> aTexCoord<span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token string-literal multiline"><span class="token string">""".trimIndent()

        val fragmentShaderCode = """</span></span>#version <span class="token number">300</span> es
             precision mediump float<span class="token punctuation">;</span>
             uniform sampler2D uTexture_0<span class="token punctuation">;</span>
             uniform sampler2D uTexture_1<span class="token punctuation">;</span>
             <span class="token keyword">in</span> vec2 vTexCoord<span class="token punctuation">;</span>
             <span class="token keyword">out</span> vec4 fragColor<span class="token punctuation">;</span>
             void <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                 fragColor <span class="token operator">=</span> <span class="token function">texture</span><span class="token punctuation">(</span>uTexture_0<span class="token punctuation">,</span> vTexCoord<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">texture</span><span class="token punctuation">(</span>uTexture_1<span class="token punctuation">,</span> vTexCoord<span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token punctuation">}</span><span class="token string-literal singleline"><span class="token string">""</span></span>"<span class="token punctuation">.</span><span class="token function">trimIndent</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment">// 加载顶点着色器和片段着色器, 并创建着色器程序</span>
        <span class="token keyword">val</span> vertexShader <span class="token operator">=</span> LoadShaderUtil<span class="token punctuation">.</span><span class="token function">loadShader</span><span class="token punctuation">(</span>GLES30<span class="token punctuation">.</span>GL_VERTEX_SHADER<span class="token punctuation">,</span> vertexShaderCode<span class="token punctuation">)</span>
        <span class="token keyword">val</span> fragmentShader <span class="token operator">=</span> LoadShaderUtil<span class="token punctuation">.</span><span class="token function">loadShader</span><span class="token punctuation">(</span>GLES30<span class="token punctuation">.</span>GL_FRAGMENT_SHADER<span class="token punctuation">,</span> fragmentShaderCode<span class="token punctuation">)</span>
        mProgram <span class="token operator">=</span> GLES30<span class="token punctuation">.</span><span class="token function">glCreateProgram</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        GLES30<span class="token punctuation">.</span><span class="token function">glAttachShader</span><span class="token punctuation">(</span>mProgram<span class="token punctuation">,</span> vertexShader<span class="token punctuation">)</span>
        GLES30<span class="token punctuation">.</span><span class="token function">glAttachShader</span><span class="token punctuation">(</span>mProgram<span class="token punctuation">,</span> fragmentShader<span class="token punctuation">)</span>
        GLES30<span class="token punctuation">.</span><span class="token function">glLinkProgram</span><span class="token punctuation">(</span>mProgram<span class="token punctuation">)</span>
        GLES30<span class="token punctuation">.</span><span class="token function">glUseProgram</span><span class="token punctuation">(</span>mProgram<span class="token punctuation">)</span>

        <span class="token comment">// 删除着色器对象</span>
        GLES30<span class="token punctuation">.</span><span class="token function">glDeleteShader</span><span class="token punctuation">(</span>vertexShader<span class="token punctuation">)</span>
        GLES30<span class="token punctuation">.</span><span class="token function">glDeleteShader</span><span class="token punctuation">(</span>fragmentShader<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 创建VAO, VBO, IBO</span>
    <span class="token keyword">fun</span> <span class="token function">initVertexBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 绑定VAO</span>
        GLES30<span class="token punctuation">.</span><span class="token function">glGenVertexArrays</span><span class="token punctuation">(</span>mVAO<span class="token punctuation">.</span>size<span class="token punctuation">,</span> mVAO<span class="token punctuation">,</span> NO_OFFSET<span class="token punctuation">)</span>
        GLES30<span class="token punctuation">.</span><span class="token function">glBindVertexArray</span><span class="token punctuation">(</span>mVAO<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token comment">// 绑定VBO</span>
            GLES30<span class="token punctuation">.</span><span class="token function">glGenBuffers</span><span class="token punctuation">(</span>mVBO<span class="token punctuation">.</span>size<span class="token punctuation">,</span> mVBO<span class="token punctuation">,</span> NO_OFFSET<span class="token punctuation">)</span>
                <span class="token comment">// 绑定顶点缓冲区数据到VBO[0]</span>
                GLES30<span class="token punctuation">.</span><span class="token function">glBindBuffer</span><span class="token punctuation">(</span>GLES30<span class="token punctuation">.</span>GL_ARRAY_BUFFER<span class="token punctuation">,</span> mVBO<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                GLES30<span class="token punctuation">.</span><span class="token function">glBufferData</span><span class="token punctuation">(</span>
                    GLES30<span class="token punctuation">.</span>GL_ARRAY_BUFFER<span class="token punctuation">,</span>
                    vertex<span class="token punctuation">.</span>size <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span>
                    vertexBuffer<span class="token punctuation">,</span>
                    GLES30<span class="token punctuation">.</span>GL_STATIC_DRAW
                <span class="token punctuation">)</span>
                <span class="token comment">// 解析顶点缓冲区数据到VBO[0]</span>
                <span class="token keyword">val</span> positionHandle <span class="token operator">=</span> GLES30<span class="token punctuation">.</span><span class="token function">glGetAttribLocation</span><span class="token punctuation">(</span>mProgram<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"aPosition"</span></span><span class="token punctuation">)</span>
                GLES30<span class="token punctuation">.</span><span class="token function">glEnableVertexAttribArray</span><span class="token punctuation">(</span>positionHandle<span class="token punctuation">)</span>
                GLES30<span class="token punctuation">.</span><span class="token function">glVertexAttribPointer</span><span class="token punctuation">(</span>
                    positionHandle<span class="token punctuation">,</span>
                    VERTEX_POS_DATA_SIZE<span class="token punctuation">,</span>
                    GLES30<span class="token punctuation">.</span>GL_FLOAT<span class="token punctuation">,</span>
                    <span class="token boolean">false</span><span class="token punctuation">,</span>
                    <span class="token number">0</span><span class="token punctuation">,</span>
                    NO_OFFSET
                <span class="token punctuation">)</span>
                <span class="token comment">// 解绑顶点缓冲区</span>
                GLES30<span class="token punctuation">.</span><span class="token function">glBindBuffer</span><span class="token punctuation">(</span>GLES30<span class="token punctuation">.</span>GL_ARRAY_BUFFER<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

                <span class="token comment">// 绑定纹理缓冲区数据到VBO[1]</span>
                GLES30<span class="token punctuation">.</span><span class="token function">glBindBuffer</span><span class="token punctuation">(</span>GLES30<span class="token punctuation">.</span>GL_ARRAY_BUFFER<span class="token punctuation">,</span> mVBO<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                GLES30<span class="token punctuation">.</span><span class="token function">glBufferData</span><span class="token punctuation">(</span>
                    GLES30<span class="token punctuation">.</span>GL_ARRAY_BUFFER<span class="token punctuation">,</span>
                    textureCoords<span class="token punctuation">.</span>size <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span>
                    textureBuffer<span class="token punctuation">,</span>
                    GLES30<span class="token punctuation">.</span>GL_STATIC_DRAW
                <span class="token punctuation">)</span>
                <span class="token comment">// 解析纹理缓冲区数据到VBO[1]</span>
                <span class="token keyword">val</span> textureHandle <span class="token operator">=</span> GLES30<span class="token punctuation">.</span><span class="token function">glGetAttribLocation</span><span class="token punctuation">(</span>mProgram<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"aTexCoord"</span></span><span class="token punctuation">)</span>
                GLES30<span class="token punctuation">.</span><span class="token function">glEnableVertexAttribArray</span><span class="token punctuation">(</span>textureHandle<span class="token punctuation">)</span>
                GLES30<span class="token punctuation">.</span><span class="token function">glVertexAttribPointer</span><span class="token punctuation">(</span>
                    textureHandle<span class="token punctuation">,</span>
                    TEXTURE_POS_DATA_SIZE<span class="token punctuation">,</span>
                    GLES30<span class="token punctuation">.</span>GL_FLOAT<span class="token punctuation">,</span>
                    <span class="token boolean">false</span><span class="token punctuation">,</span>
                    <span class="token number">0</span><span class="token punctuation">,</span>
                    NO_OFFSET
                <span class="token punctuation">)</span>
                <span class="token comment">// 解绑纹理缓冲区</span>
                GLES30<span class="token punctuation">.</span><span class="token function">glBindBuffer</span><span class="token punctuation">(</span>GLES30<span class="token punctuation">.</span>GL_ARRAY_BUFFER<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

            <span class="token comment">// 绑定IBO</span>
            GLES30<span class="token punctuation">.</span><span class="token function">glGenBuffers</span><span class="token punctuation">(</span>mIBO<span class="token punctuation">.</span>size<span class="token punctuation">,</span> mIBO<span class="token punctuation">,</span> NO_OFFSET<span class="token punctuation">)</span>
            <span class="token comment">// 绑定索引缓冲区数据到IBO[0]</span>
            GLES30<span class="token punctuation">.</span><span class="token function">glBindBuffer</span><span class="token punctuation">(</span>GLES30<span class="token punctuation">.</span>GL_ELEMENT_ARRAY_BUFFER<span class="token punctuation">,</span> mIBO<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            GLES30<span class="token punctuation">.</span><span class="token function">glBufferData</span><span class="token punctuation">(</span>
                GLES30<span class="token punctuation">.</span>GL_ELEMENT_ARRAY_BUFFER<span class="token punctuation">,</span>
                index<span class="token punctuation">.</span>size <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span>
                indexBuffer<span class="token punctuation">,</span>
                GLES30<span class="token punctuation">.</span>GL_STATIC_DRAW
            <span class="token punctuation">)</span>

        <span class="token comment">// 解绑VAO</span>
        GLES30<span class="token punctuation">.</span><span class="token function">glBindVertexArray</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token comment">// 解绑IBO</span>
        GLES30<span class="token punctuation">.</span><span class="token function">glBindBuffer</span><span class="token punctuation">(</span>GLES30<span class="token punctuation">.</span>GL_ELEMENT_ARRAY_BUFFER<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 计算GLSurfaceView变换矩阵</span>
    <span class="token keyword">fun</span> <span class="token function">computeMVPMatrix</span><span class="token punctuation">(</span>width<span class="token operator">:</span> Int<span class="token punctuation">,</span> height<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 正交投影矩阵</span>
        takeIf <span class="token punctuation">{<!-- --></span> width <span class="token operator">&gt;</span> height <span class="token punctuation">}</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">let</span> <span class="token punctuation">{<!-- --></span>
            mViewPortRatio <span class="token operator">=</span> <span class="token punctuation">(</span>width <span class="token operator">*</span> <span class="token number">1f</span><span class="token punctuation">)</span> <span class="token operator">/</span> height
            Matrix<span class="token punctuation">.</span><span class="token function">orthoM</span><span class="token punctuation">(</span>
                mProjectionMatrix<span class="token punctuation">,</span> <span class="token comment">// 正交投影矩阵</span>
                NO_OFFSET<span class="token punctuation">,</span> <span class="token comment">// 偏移量</span>
                <span class="token operator">-</span>mViewPortRatio<span class="token punctuation">,</span> <span class="token comment">// 近平面的坐标系左边界</span>
                mViewPortRatio<span class="token punctuation">,</span> <span class="token comment">// 近平面的坐标系右边界</span>
                <span class="token operator">-</span><span class="token number">1f</span><span class="token punctuation">,</span> <span class="token comment">// 近平面的坐标系的下边界</span>
                <span class="token number">1f</span><span class="token punctuation">,</span> <span class="token comment">// 近平面坐标系的上边界</span>
                <span class="token number">0f</span><span class="token punctuation">,</span> <span class="token comment">// 近平面距离相机距离</span>
                <span class="token number">1f</span> <span class="token comment">// 远平面距离相机距离</span>
            <span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token operator">?:</span> run <span class="token punctuation">{<!-- --></span>
            mViewPortRatio <span class="token operator">=</span> <span class="token punctuation">(</span>height <span class="token operator">*</span> <span class="token number">1f</span><span class="token punctuation">)</span> <span class="token operator">/</span> width
            Matrix<span class="token punctuation">.</span><span class="token function">orthoM</span><span class="token punctuation">(</span>
                mProjectionMatrix<span class="token punctuation">,</span> <span class="token comment">// 正交投影矩阵</span>
                NO_OFFSET<span class="token punctuation">,</span> <span class="token comment">// 偏移量</span>
                <span class="token operator">-</span><span class="token number">1f</span><span class="token punctuation">,</span> <span class="token comment">// 近平面坐标系左边界</span>
                <span class="token number">1f</span><span class="token punctuation">,</span> <span class="token comment">// 近平面坐标系右边界</span>
                <span class="token operator">-</span>mViewPortRatio<span class="token punctuation">,</span> <span class="token comment">// 近平面坐标系下边界</span>
                mViewPortRatio<span class="token punctuation">,</span> <span class="token comment">// 近平面坐标系上边界</span>
                <span class="token number">0f</span><span class="token punctuation">,</span> <span class="token comment">// 近平面距离相机距离</span>
                <span class="token number">1f</span> <span class="token comment">// 远平面距离相机距离</span>
            <span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 设置相机矩阵</span>
        <span class="token comment">// 相机位置(0f, 0f, 1f)</span>
        <span class="token comment">// 物体位置(0f, 0f, 0f)</span>
        <span class="token comment">// 相机方向(0f, 1f, 0f)</span>
        Matrix<span class="token punctuation">.</span><span class="token function">setLookAtM</span><span class="token punctuation">(</span>
            mViewMatrix<span class="token punctuation">,</span> <span class="token comment">// 相机矩阵</span>
            NO_OFFSET<span class="token punctuation">,</span> <span class="token comment">// 偏移量</span>
            <span class="token number">0f</span><span class="token punctuation">,</span> <span class="token comment">// 相机位置x</span>
            <span class="token number">0f</span><span class="token punctuation">,</span> <span class="token comment">// 相机位置y</span>
            <span class="token number">1f</span><span class="token punctuation">,</span> <span class="token comment">// 相机位置z</span>
            <span class="token number">0f</span><span class="token punctuation">,</span> <span class="token comment">// 物体位置x</span>
            <span class="token number">0f</span><span class="token punctuation">,</span> <span class="token comment">// 物体位置y</span>
            <span class="token number">0f</span><span class="token punctuation">,</span> <span class="token comment">// 物体位置z</span>
            <span class="token number">0f</span><span class="token punctuation">,</span> <span class="token comment">// 相机上方向x</span>
            <span class="token number">1f</span><span class="token punctuation">,</span> <span class="token comment">// 相机上方向y</span>
            <span class="token number">0f</span> <span class="token comment">// 相机上方向z</span>
        <span class="token punctuation">)</span>

        <span class="token comment">// 最终变化矩阵</span>
        Matrix<span class="token punctuation">.</span><span class="token function">multiplyMM</span><span class="token punctuation">(</span>
            mMVPMatrix<span class="token punctuation">,</span> <span class="token comment">// 最终变化矩阵</span>
            NO_OFFSET<span class="token punctuation">,</span> <span class="token comment">// 偏移量</span>
            mProjectionMatrix<span class="token punctuation">,</span> <span class="token comment">// 投影矩阵</span>
            NO_OFFSET<span class="token punctuation">,</span> <span class="token comment">// 投影矩阵偏移量</span>
            mViewMatrix<span class="token punctuation">,</span> <span class="token comment">// 相机矩阵</span>
            NO_OFFSET <span class="token comment">// 相机矩阵偏移量</span>
        <span class="token punctuation">)</span>

        <span class="token comment">// 纹理坐标系为(0, 0), (1, 0), (1, 1), (0, 1)的正方形逆时针坐标系，从Bitmap生成纹理，即像素拷贝到纹理坐标系</span>
        <span class="token comment">// 变换矩阵需要加上一个y方向的翻转, x方向和z方向不改变</span>
        Matrix<span class="token punctuation">.</span><span class="token function">scaleM</span><span class="token punctuation">(</span>
            mMVPMatrix<span class="token punctuation">,</span>
            NO_OFFSET<span class="token punctuation">,</span>
            <span class="token number">1f</span><span class="token punctuation">,</span>
            <span class="token operator">-</span><span class="token number">1f</span><span class="token punctuation">,</span>
            <span class="token number">1f</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 初始化帧缓冲</span>
    <span class="token keyword">fun</span> <span class="token function">initFrameBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 创建FBO</span>
        GLES30<span class="token punctuation">.</span><span class="token function">glGenFramebuffers</span><span class="token punctuation">(</span>mFBO<span class="token punctuation">.</span>size<span class="token punctuation">,</span> mFBO<span class="token punctuation">,</span> NO_OFFSET<span class="token punctuation">)</span>
        <span class="token comment">// 绑定FBO</span>
        GLES30<span class="token punctuation">.</span><span class="token function">glBindFramebuffer</span><span class="token punctuation">(</span>GLES30<span class="token punctuation">.</span>GL_FRAMEBUFFER<span class="token punctuation">,</span> mFBO<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token comment">// 创建空纹理</span>
            GLES30<span class="token punctuation">.</span><span class="token function">glGenTextures</span><span class="token punctuation">(</span>mFBOTextureID<span class="token punctuation">.</span>size<span class="token punctuation">,</span> mFBOTextureID<span class="token punctuation">,</span> NO_OFFSET<span class="token punctuation">)</span>
            <span class="token comment">// 绑定空纹理</span>
            GLES30<span class="token punctuation">.</span><span class="token function">glBindTexture</span><span class="token punctuation">(</span>GLES30<span class="token punctuation">.</span>GL_TEXTURE_2D<span class="token punctuation">,</span> mFBOTextureID<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token comment">// 设置纹理参数</span>
            GLES30<span class="token punctuation">.</span><span class="token function">glTexParameteri</span><span class="token punctuation">(</span>
                GLES30<span class="token punctuation">.</span>GL_TEXTURE_2D<span class="token punctuation">,</span>
                GLES30<span class="token punctuation">.</span>GL_TEXTURE_MIN_FILTER<span class="token punctuation">,</span>
                GLES30<span class="token punctuation">.</span>GL_LINEAR
            <span class="token punctuation">)</span> <span class="token comment">// 纹理缩小时使用线性插值</span>
            GLES30<span class="token punctuation">.</span><span class="token function">glTexParameteri</span><span class="token punctuation">(</span>
                GLES30<span class="token punctuation">.</span>GL_TEXTURE_2D<span class="token punctuation">,</span>
                GLES30<span class="token punctuation">.</span>GL_TEXTURE_MAG_FILTER<span class="token punctuation">,</span>
                GLES30<span class="token punctuation">.</span>GL_LINEAR
            <span class="token punctuation">)</span> <span class="token comment">// 纹理放大时使用线性插值</span>
            GLES30<span class="token punctuation">.</span><span class="token function">glTexParameteri</span><span class="token punctuation">(</span>
                GLES30<span class="token punctuation">.</span>GL_TEXTURE_2D<span class="token punctuation">,</span>
                GLES30<span class="token punctuation">.</span>GL_TEXTURE_WRAP_S<span class="token punctuation">,</span>
                GLES30<span class="token punctuation">.</span>GL_CLAMP_TO_EDGE
            <span class="token punctuation">)</span> <span class="token comment">// 纹理坐标超出范围时，超出部分使用最边缘像素进行填充</span>
            GLES30<span class="token punctuation">.</span><span class="token function">glTexParameteri</span><span class="token punctuation">(</span>
                GLES30<span class="token punctuation">.</span>GL_TEXTURE_2D<span class="token punctuation">,</span>
                GLES30<span class="token punctuation">.</span>GL_TEXTURE_WRAP_T<span class="token punctuation">,</span>
                GLES30<span class="token punctuation">.</span>GL_CLAMP_TO_EDGE
            <span class="token punctuation">)</span> <span class="token comment">// 纹理坐标超出范围时，超出部分使用最边缘像素进行填充</span>

            GLES30<span class="token punctuation">.</span><span class="token function">glTexImage2D</span><span class="token punctuation">(</span>
                GLES30<span class="token punctuation">.</span>GL_TEXTURE_2D<span class="token punctuation">,</span> <span class="token comment">// 纹理类型</span>
                NO_OFFSET<span class="token punctuation">,</span> <span class="token comment">// 偏移量</span>
                GLES30<span class="token punctuation">.</span>GL_RGBA<span class="token punctuation">,</span> <span class="token comment">// 颜色通道</span>
                mFrameBufferWidth<span class="token punctuation">,</span> <span class="token comment">// 纹理宽度</span>
                mFrameBufferHeight<span class="token punctuation">,</span> <span class="token comment">// 纹理高度</span>
                NO_OFFSET<span class="token punctuation">,</span> <span class="token comment">// 偏移量</span>
                GLES30<span class="token punctuation">.</span>GL_RGBA<span class="token punctuation">,</span> <span class="token comment">// 颜色通道</span>
                GLES30<span class="token punctuation">.</span>GL_UNSIGNED_BYTE<span class="token punctuation">,</span> <span class="token comment">// 颜色数据类型</span>
                <span class="token keyword">null</span> <span class="token comment">// 不传入颜色数据</span>
            <span class="token punctuation">)</span>
        <span class="token comment">// 绑定空纹理到FBO，用于绘制到FBO</span>
        GLES30<span class="token punctuation">.</span><span class="token function">glFramebufferTexture2D</span><span class="token punctuation">(</span>
            GLES30<span class="token punctuation">.</span>GL_FRAMEBUFFER<span class="token punctuation">,</span> <span class="token comment">// FBO</span>
            GLES30<span class="token punctuation">.</span>GL_COLOR_ATTACHMENT0<span class="token punctuation">,</span> <span class="token comment">// 颜色缓冲区</span>
            GLES30<span class="token punctuation">.</span>GL_TEXTURE_2D<span class="token punctuation">,</span> <span class="token comment">// 纹理类型</span>
            mFBOTextureID<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 纹理ID</span>
            <span class="token number">0</span>
        <span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>GLES30<span class="token punctuation">.</span><span class="token function">glCheckFramebufferStatus</span><span class="token punctuation">(</span>GLES30<span class="token punctuation">.</span>GL_FRAMEBUFFER<span class="token punctuation">)</span> <span class="token operator">!=</span> GLES30<span class="token punctuation">.</span>GL_FRAMEBUFFER_COMPLETE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"yang"</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"initFrameBuffer: FBO初始化失败"</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 解绑FBO纹理</span>
        GLES30<span class="token punctuation">.</span><span class="token function">glBindTexture</span><span class="token punctuation">(</span>GLES30<span class="token punctuation">.</span>GL_TEXTURE_2D<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token comment">// 解绑FBO</span>
        GLES30<span class="token punctuation">.</span><span class="token function">glBindFramebuffer</span><span class="token punctuation">(</span>GLES30<span class="token punctuation">.</span>GL_FRAMEBUFFER<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 离屏渲染</span>
    <span class="token keyword">fun</span> <span class="token function">drawOffScreen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        takeIf <span class="token punctuation">{<!-- --></span> mFrameBufferBitmap <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token punctuation">}</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">let</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 帧缓冲绘制纹理需要修改视口大小，这里需要进行视口的保存和恢复</span>
            <span class="token keyword">val</span> viewport <span class="token operator">=</span> <span class="token function">IntArray</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
            GLES30<span class="token punctuation">.</span><span class="token function">glGetIntegerv</span><span class="token punctuation">(</span>GLES30<span class="token punctuation">.</span>GL_VIEWPORT<span class="token punctuation">,</span> viewport<span class="token punctuation">,</span> NO_OFFSET<span class="token punctuation">)</span>
                <span class="token comment">// 绑定FBO</span>
                GLES30<span class="token punctuation">.</span><span class="token function">glBindFramebuffer</span><span class="token punctuation">(</span>GLES30<span class="token punctuation">.</span>GL_FRAMEBUFFER<span class="token punctuation">,</span> mFBO<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                    <span class="token comment">// 设置视口为FBO尺寸</span>
                    GLES30<span class="token punctuation">.</span><span class="token function">glViewport</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> mFrameBufferWidth<span class="token punctuation">,</span> mFrameBufferHeight<span class="token punctuation">)</span>

                    <span class="token comment">// 计算帧缓冲纹理宽高的变换矩阵</span>
                    <span class="token function">computeFrameBufferMVPMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

                    <span class="token comment">// 清除FBO</span>
                    GLES30<span class="token punctuation">.</span><span class="token function">glClear</span><span class="token punctuation">(</span>GLES30<span class="token punctuation">.</span>GL_COLOR_BUFFER_BIT<span class="token punctuation">)</span>

                    <span class="token comment">// 绘制图形到FBO, FBO上的内容不会显示</span>
                    <span class="token function">drawFrameBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

                    <span class="token comment">// 缓存FBO内容到Bitmap</span>
                    <span class="token function">getBitmapFromFrameBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">// 解绑FBO，恢复默认帧缓冲</span>
                GLES30<span class="token punctuation">.</span><span class="token function">glBindFramebuffer</span><span class="token punctuation">(</span>GLES30<span class="token punctuation">.</span>GL_FRAMEBUFFER<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token comment">// 恢复原始视口</span>
            GLES30<span class="token punctuation">.</span><span class="token function">glViewport</span><span class="token punctuation">(</span>viewport<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> viewport<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> viewport<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> viewport<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 使用着色器程序绘制图形</span>
    <span class="token keyword">fun</span> <span class="token function">drawSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 解析变换矩阵</span>
        <span class="token keyword">val</span> matrixHandle <span class="token operator">=</span> GLES30<span class="token punctuation">.</span><span class="token function">glGetUniformLocation</span><span class="token punctuation">(</span>mProgram<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"uMVPMatrix"</span></span><span class="token punctuation">)</span>
        GLES30<span class="token punctuation">.</span><span class="token function">glUniformMatrix4fv</span><span class="token punctuation">(</span>matrixHandle<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> mMVPMatrix<span class="token punctuation">,</span> NO_OFFSET<span class="token punctuation">)</span>

        <span class="token comment">// 绑定VAO</span>
        GLES30<span class="token punctuation">.</span><span class="token function">glBindVertexArray</span><span class="token punctuation">(</span>mVAO<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token comment">// 绘制图形</span>
            GLES30<span class="token punctuation">.</span><span class="token function">glDrawElements</span><span class="token punctuation">(</span>
                GLES30<span class="token punctuation">.</span>GL_TRIANGLES<span class="token punctuation">,</span>
                index<span class="token punctuation">.</span>size<span class="token punctuation">,</span>
                GLES30<span class="token punctuation">.</span>GL_UNSIGNED_SHORT<span class="token punctuation">,</span>
                NO_OFFSET
            <span class="token punctuation">)</span>
        <span class="token comment">// 解绑VAO</span>
        GLES30<span class="token punctuation">.</span><span class="token function">glBindVertexArray</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">drawFrameBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 解析帧缓冲变换矩阵</span>
        <span class="token keyword">val</span> matrixHandle <span class="token operator">=</span> GLES30<span class="token punctuation">.</span><span class="token function">glGetUniformLocation</span><span class="token punctuation">(</span>mProgram<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"uMVPMatrix"</span></span><span class="token punctuation">)</span>
        GLES30<span class="token punctuation">.</span><span class="token function">glUniformMatrix4fv</span><span class="token punctuation">(</span>matrixHandle<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> mFrameBufferMVPMatrix<span class="token punctuation">,</span> NO_OFFSET<span class="token punctuation">)</span>

        <span class="token comment">// 绑定VAO</span>
        GLES30<span class="token punctuation">.</span><span class="token function">glBindVertexArray</span><span class="token punctuation">(</span>mVAO<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token comment">// 绘制图形</span>
            GLES30<span class="token punctuation">.</span><span class="token function">glDrawElements</span><span class="token punctuation">(</span>
                GLES30<span class="token punctuation">.</span>GL_TRIANGLES<span class="token punctuation">,</span>
                index<span class="token punctuation">.</span>size<span class="token punctuation">,</span>
                GLES30<span class="token punctuation">.</span>GL_UNSIGNED_SHORT<span class="token punctuation">,</span>
                NO_OFFSET
            <span class="token punctuation">)</span>
        <span class="token comment">// 解绑VAO</span>
        GLES30<span class="token punctuation">.</span><span class="token function">glBindVertexArray</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">enableTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 激活纹理编号0</span>
        GLES30<span class="token punctuation">.</span><span class="token function">glActiveTexture</span><span class="token punctuation">(</span>GLES30<span class="token punctuation">.</span>GL_TEXTURE0<span class="token punctuation">)</span>
        GLES30<span class="token punctuation">.</span><span class="token function">glBindTexture</span><span class="token punctuation">(</span>GLES30<span class="token punctuation">.</span>GL_TEXTURE_2D<span class="token punctuation">,</span> mTextureID<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">val</span> textureSampleHandle <span class="token operator">=</span> GLES30<span class="token punctuation">.</span><span class="token function">glGetUniformLocation</span><span class="token punctuation">(</span>mProgram<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"uTexture_0"</span></span><span class="token punctuation">)</span>
        GLES30<span class="token punctuation">.</span><span class="token function">glUniform1i</span><span class="token punctuation">(</span>textureSampleHandle<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

        <span class="token comment">// 激活纹理编号1</span>
        GLES30<span class="token punctuation">.</span><span class="token function">glActiveTexture</span><span class="token punctuation">(</span>GLES30<span class="token punctuation">.</span>GL_TEXTURE1<span class="token punctuation">)</span>
        GLES30<span class="token punctuation">.</span><span class="token function">glBindTexture</span><span class="token punctuation">(</span>GLES30<span class="token punctuation">.</span>GL_TEXTURE_2D<span class="token punctuation">,</span> mTextureID<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">val</span> textureSampleHandle1 <span class="token operator">=</span> GLES30<span class="token punctuation">.</span><span class="token function">glGetUniformLocation</span><span class="token punctuation">(</span>mProgram<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"uTexture_1"</span></span><span class="token punctuation">)</span>
        GLES30<span class="token punctuation">.</span><span class="token function">glUniform1i</span><span class="token punctuation">(</span>textureSampleHandle1<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">disableTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        GLES30<span class="token punctuation">.</span><span class="token function">glBindTexture</span><span class="token punctuation">(</span>GLES30<span class="token punctuation">.</span>GL_TEXTURE_2D<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">initTexture0</span><span class="token punctuation">(</span>context<span class="token operator">:</span> Context<span class="token punctuation">,</span> resourceId<span class="token operator">:</span> Int<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        mTextureID<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">loadTexture</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceId<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">initTexture1</span><span class="token punctuation">(</span>context<span class="token operator">:</span> Context<span class="token punctuation">,</span> resourceId<span class="token operator">:</span> Int<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        mTextureID<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">loadTexture</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceId<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 加载纹理</span>
    <span class="token keyword">fun</span> <span class="token function">loadTexture</span><span class="token punctuation">(</span>context<span class="token operator">:</span> Context<span class="token punctuation">,</span> resourceId<span class="token operator">:</span> Int<span class="token punctuation">)</span><span class="token operator">:</span> Int <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">val</span> textureId <span class="token operator">=</span> <span class="token function">IntArray</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token comment">// 生成纹理</span>
        GLES30<span class="token punctuation">.</span><span class="token function">glGenTextures</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> textureId<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token comment">// 绑定纹理</span>
        GLES30<span class="token punctuation">.</span><span class="token function">glBindTexture</span><span class="token punctuation">(</span>GLES30<span class="token punctuation">.</span>GL_TEXTURE_2D<span class="token punctuation">,</span> textureId<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment">// 设置纹理参数</span>
        GLES30<span class="token punctuation">.</span><span class="token function">glTexParameteri</span><span class="token punctuation">(</span>
            GLES30<span class="token punctuation">.</span>GL_TEXTURE_2D<span class="token punctuation">,</span>
            GLES30<span class="token punctuation">.</span>GL_TEXTURE_MIN_FILTER<span class="token punctuation">,</span>
            GLES30<span class="token punctuation">.</span>GL_LINEAR
        <span class="token punctuation">)</span> <span class="token comment">// 纹理缩小时使用线性插值</span>
        GLES30<span class="token punctuation">.</span><span class="token function">glTexParameteri</span><span class="token punctuation">(</span>
            GLES30<span class="token punctuation">.</span>GL_TEXTURE_2D<span class="token punctuation">,</span>
            GLES30<span class="token punctuation">.</span>GL_TEXTURE_MAG_FILTER<span class="token punctuation">,</span>
            GLES30<span class="token punctuation">.</span>GL_LINEAR
        <span class="token punctuation">)</span> <span class="token comment">// 纹理放大时使用线性插值</span>
        GLES30<span class="token punctuation">.</span><span class="token function">glTexParameteri</span><span class="token punctuation">(</span>
            GLES30<span class="token punctuation">.</span>GL_TEXTURE_2D<span class="token punctuation">,</span>
            GLES30<span class="token punctuation">.</span>GL_TEXTURE_WRAP_S<span class="token punctuation">,</span>
            GLES30<span class="token punctuation">.</span>GL_CLAMP_TO_EDGE
        <span class="token punctuation">)</span> <span class="token comment">// 纹理坐标超出范围时，超出部分使用最边缘像素进行填充</span>
        GLES30<span class="token punctuation">.</span><span class="token function">glTexParameteri</span><span class="token punctuation">(</span>
            GLES30<span class="token punctuation">.</span>GL_TEXTURE_2D<span class="token punctuation">,</span>
            GLES30<span class="token punctuation">.</span>GL_TEXTURE_WRAP_T<span class="token punctuation">,</span>
            GLES30<span class="token punctuation">.</span>GL_CLAMP_TO_EDGE
        <span class="token punctuation">)</span> <span class="token comment">// 纹理坐标超出范围时，超出部分使用最边缘像素进行填充</span>
        <span class="token comment">// 加载图片</span>
        <span class="token keyword">val</span> options <span class="token operator">=</span> BitmapFactory<span class="token punctuation">.</span><span class="token function">Options</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span> <span class="token punctuation">{<!-- --></span>
            inScaled <span class="token operator">=</span> <span class="token boolean">false</span> <span class="token comment">// 不进行缩放</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">val</span> bitmap <span class="token operator">=</span> BitmapFactory<span class="token punctuation">.</span><span class="token function">decodeResource</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>resources<span class="token punctuation">,</span> resourceId<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
        <span class="token comment">// 将图片数据加载到纹理中</span>
        GLUtils<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>GLES30<span class="token punctuation">.</span>GL_TEXTURE_2D<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> bitmap<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token comment">// 释放资源</span>
        bitmap<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// 解绑纹理</span>
        GLES30<span class="token punctuation">.</span><span class="token function">glBindTexture</span><span class="token punctuation">(</span>GLES30<span class="token punctuation">.</span>GL_TEXTURE_2D<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        mFrameBufferWidth <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span>mFrameBufferWidth<span class="token punctuation">,</span> bitmap<span class="token punctuation">.</span>width<span class="token punctuation">)</span>
        mFrameBufferHeight <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span>mFrameBufferHeight<span class="token punctuation">,</span> bitmap<span class="token punctuation">.</span>height<span class="token punctuation">)</span>
        Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"yang"</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"loadTexture: 纹理加载成功 bitmap.width:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token expression">bitmap<span class="token punctuation">.</span>width</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> bitmap.height:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token expression">bitmap<span class="token punctuation">.</span>height</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> textureId<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">getBitmapFromFrameBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 分配缓冲区来存储像素数据</span>
        <span class="token keyword">val</span> pixelBuffer <span class="token operator">=</span> ByteBuffer<span class="token punctuation">.</span><span class="token function">allocateDirect</span><span class="token punctuation">(</span>mFrameBufferWidth <span class="token operator">*</span> mFrameBufferHeight <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">order</span><span class="token punctuation">(</span>ByteOrder<span class="token punctuation">.</span>LITTLE_ENDIAN<span class="token punctuation">)</span>

        <span class="token comment">// 读取像素数据</span>
        GLES30<span class="token punctuation">.</span><span class="token function">glReadPixels</span><span class="token punctuation">(</span>
            <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> mFrameBufferWidth<span class="token punctuation">,</span> mFrameBufferHeight<span class="token punctuation">,</span>
            GLES30<span class="token punctuation">.</span>GL_RGBA<span class="token punctuation">,</span> GLES30<span class="token punctuation">.</span>GL_UNSIGNED_BYTE<span class="token punctuation">,</span>
            pixelBuffer
        <span class="token punctuation">)</span>

        <span class="token comment">// 将ByteBuffer转换为Bitmap</span>
        <span class="token keyword">val</span> bitmap <span class="token operator">=</span> Bitmap<span class="token punctuation">.</span><span class="token function">createBitmap</span><span class="token punctuation">(</span>mFrameBufferWidth<span class="token punctuation">,</span> mFrameBufferHeight<span class="token punctuation">,</span> Bitmap<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>ARGB_8888<span class="token punctuation">)</span>
        pixelBuffer<span class="token punctuation">.</span><span class="token function">rewind</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        bitmap<span class="token punctuation">.</span><span class="token function">copyPixelsFromBuffer</span><span class="token punctuation">(</span>pixelBuffer<span class="token punctuation">)</span>

        <span class="token comment">// OpenGL和Android的Y轴方向相反，需要围绕中心垂直翻转</span>
        <span class="token keyword">val</span> matrix <span class="token operator">=</span> android<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span><span class="token function">Matrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">setScale</span><span class="token punctuation">(</span><span class="token number">1f</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1f</span><span class="token punctuation">,</span> mFrameBufferWidth <span class="token operator">/</span> <span class="token number">2f</span><span class="token punctuation">,</span> mFrameBufferHeight <span class="token operator">/</span> <span class="token number">2f</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        mFrameBufferBitmap <span class="token operator">=</span> Bitmap<span class="token punctuation">.</span><span class="token function">createBitmap</span><span class="token punctuation">(</span>
            bitmap<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> bitmap<span class="token punctuation">.</span>width<span class="token punctuation">,</span> bitmap<span class="token punctuation">.</span>height<span class="token punctuation">,</span>
            matrix<span class="token punctuation">,</span> <span class="token boolean">true</span>
        <span class="token punctuation">)</span>

        bitmap<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">getScreenBitmap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> Bitmap<span class="token operator">?</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> mFrameBufferBitmap
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">computeFrameBufferMVPMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 正交投影矩阵</span>
        takeIf <span class="token punctuation">{<!-- --></span> mFrameBufferWidth <span class="token operator">&gt;</span> mFrameBufferHeight <span class="token punctuation">}</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">let</span> <span class="token punctuation">{<!-- --></span>
            mViewPortRatio <span class="token operator">=</span> <span class="token punctuation">(</span>mFrameBufferWidth <span class="token operator">*</span> <span class="token number">1f</span><span class="token punctuation">)</span> <span class="token operator">/</span> mFrameBufferHeight
            Matrix<span class="token punctuation">.</span><span class="token function">orthoM</span><span class="token punctuation">(</span>
                mProjectionMatrix<span class="token punctuation">,</span> <span class="token comment">// 正交投影矩阵</span>
                NO_OFFSET<span class="token punctuation">,</span> <span class="token comment">// 偏移量</span>
                <span class="token operator">-</span>mViewPortRatio<span class="token punctuation">,</span> <span class="token comment">// 近平面的坐标系左边界</span>
                mViewPortRatio<span class="token punctuation">,</span> <span class="token comment">// 近平面的坐标系右边界</span>
                <span class="token operator">-</span><span class="token number">1f</span><span class="token punctuation">,</span> <span class="token comment">// 近平面的坐标系的下边界</span>
                <span class="token number">1f</span><span class="token punctuation">,</span> <span class="token comment">// 近平面坐标系的上边界</span>
                <span class="token number">0f</span><span class="token punctuation">,</span> <span class="token comment">// 近平面距离相机距离</span>
                <span class="token number">1f</span> <span class="token comment">// 远平面距离相机距离</span>
            <span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token operator">?:</span> run <span class="token punctuation">{<!-- --></span>
            mViewPortRatio <span class="token operator">=</span> <span class="token punctuation">(</span>mFrameBufferHeight <span class="token operator">*</span> <span class="token number">1f</span><span class="token punctuation">)</span> <span class="token operator">/</span> mFrameBufferWidth
            Matrix<span class="token punctuation">.</span><span class="token function">orthoM</span><span class="token punctuation">(</span>
                mProjectionMatrix<span class="token punctuation">,</span> <span class="token comment">// 正交投影矩阵</span>
                NO_OFFSET<span class="token punctuation">,</span> <span class="token comment">// 偏移量</span>
                <span class="token operator">-</span><span class="token number">1f</span><span class="token punctuation">,</span> <span class="token comment">// 近平面坐标系左边界</span>
                <span class="token number">1f</span><span class="token punctuation">,</span> <span class="token comment">// 近平面坐标系右边界</span>
                <span class="token operator">-</span>mViewPortRatio<span class="token punctuation">,</span> <span class="token comment">// 近平面坐标系下边界</span>
                mViewPortRatio<span class="token punctuation">,</span> <span class="token comment">// 近平面坐标系上边界</span>
                <span class="token number">0f</span><span class="token punctuation">,</span> <span class="token comment">// 近平面距离相机距离</span>
                <span class="token number">1f</span> <span class="token comment">// 远平面距离相机距离</span>
            <span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 设置相机矩阵</span>
        <span class="token comment">// 相机位置(0f, 0f, 1f)</span>
        <span class="token comment">// 物体位置(0f, 0f, 0f)</span>
        <span class="token comment">// 相机方向(0f, 1f, 0f)</span>
        Matrix<span class="token punctuation">.</span><span class="token function">setLookAtM</span><span class="token punctuation">(</span>
            mViewMatrix<span class="token punctuation">,</span> <span class="token comment">// 相机矩阵</span>
            NO_OFFSET<span class="token punctuation">,</span> <span class="token comment">// 偏移量</span>
            <span class="token number">0f</span><span class="token punctuation">,</span> <span class="token comment">// 相机位置x</span>
            <span class="token number">0f</span><span class="token punctuation">,</span> <span class="token comment">// 相机位置y</span>
            <span class="token number">1f</span><span class="token punctuation">,</span> <span class="token comment">// 相机位置z</span>
            <span class="token number">0f</span><span class="token punctuation">,</span> <span class="token comment">// 物体位置x</span>
            <span class="token number">0f</span><span class="token punctuation">,</span> <span class="token comment">// 物体位置y</span>
            <span class="token number">0f</span><span class="token punctuation">,</span> <span class="token comment">// 物体位置z</span>
            <span class="token number">0f</span><span class="token punctuation">,</span> <span class="token comment">// 相机上方向x</span>
            <span class="token number">1f</span><span class="token punctuation">,</span> <span class="token comment">// 相机上方向y</span>
            <span class="token number">0f</span> <span class="token comment">// 相机上方向z</span>
        <span class="token punctuation">)</span>

        <span class="token comment">// 最终变化矩阵</span>
        Matrix<span class="token punctuation">.</span><span class="token function">multiplyMM</span><span class="token punctuation">(</span>
            mFrameBufferMVPMatrix<span class="token punctuation">,</span> <span class="token comment">// 最终变化矩阵</span>
            NO_OFFSET<span class="token punctuation">,</span> <span class="token comment">// 偏移量</span>
            mProjectionMatrix<span class="token punctuation">,</span> <span class="token comment">// 投影矩阵</span>
            NO_OFFSET<span class="token punctuation">,</span> <span class="token comment">// 投影矩阵偏移量</span>
            mViewMatrix<span class="token punctuation">,</span> <span class="token comment">// 相机矩阵</span>
            NO_OFFSET <span class="token comment">// 相机矩阵偏移量</span>
        <span class="token punctuation">)</span>

        <span class="token comment">// 纹理坐标系为(0, 0), (1, 0), (1, 1), (0, 1)的正方形逆时针坐标系，从Bitmap生成纹理，即像素拷贝到纹理坐标系</span>
        <span class="token comment">// 变换矩阵需要加上一个y方向的翻转, x方向和z方向不改变</span>
        Matrix<span class="token punctuation">.</span><span class="token function">scaleM</span><span class="token punctuation">(</span>
            mFrameBufferMVPMatrix<span class="token punctuation">,</span>
            NO_OFFSET<span class="token punctuation">,</span>
            <span class="token number">1f</span><span class="token punctuation">,</span>
            <span class="token operator">-</span><span class="token number">1f</span><span class="token punctuation">,</span>
            <span class="token number">1f</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">object</span> LoadShaderUtil <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 创建着色器对象</span>
        <span class="token keyword">fun</span> <span class="token function">loadShader</span><span class="token punctuation">(</span>type<span class="token operator">:</span> Int<span class="token punctuation">,</span> source<span class="token operator">:</span> String<span class="token punctuation">)</span><span class="token operator">:</span> Int <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">val</span> shader <span class="token operator">=</span> GLES30<span class="token punctuation">.</span><span class="token function">glCreateShader</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span>
            GLES30<span class="token punctuation">.</span><span class="token function">glShaderSource</span><span class="token punctuation">(</span>shader<span class="token punctuation">,</span> source<span class="token punctuation">)</span>
            GLES30<span class="token punctuation">.</span><span class="token function">glCompileShader</span><span class="token punctuation">(</span>shader<span class="token punctuation">)</span>
            <span class="token keyword">return</span> shader
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h2>
     <a id="_692">
     </a>
     效果图
    </h2>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/01a4d38065f543f3b47f63937eb91ddd.gif" width="300"/>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c:6f672e6373646e2e6e65742f73756e7368696e655f67756f2f:61727469636c652f64657461696c732f313436313534393336" class_="artid" style="display:none">
 </p>
</div>


