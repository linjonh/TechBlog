---
layout: post
title: "æ–‡æœ¬è½¬è¯­éŸ³-éŸ³ç”»é€‚æ—¶æ¨é€rtspå¹¶æ’­æ”¾"
date: 2025-03-10 22:08:17 +0800
description: "è€Œä»Šå¤©çš„è¿™ä¸ªç›¸ä¼¼åŠŸèƒ½çš„ä»£ç æ˜¯mac osï¼Œç†è®ºæ”¯æŒwindowsï¼Œå’Œlinuxï¼Œä¾èµ–ffmpegå’Œxiuï¼ˆä¸€ä¸ªrustæµæœåŠ¡å™¨ï¼‰çš„rtspæœåŠ¡ã€‚éŸ³ç”»åŒæ­¥åº”è¯¥æ˜¯å¦ä¸ªé—®é¢˜äº†ï¼Œå‡ å¤©å‰ï¼Œé¼“æ£äº†ä¸€ä¸‹å›¾ç‰‡ã€‚è®©ç¼–è¾‘åçš„ï¼Œé©¬ä¸Š åœ¨è§†é¢‘ä¸­æ˜¾ç¤ºã€‚åšçš„è¿™äº›å°±ä¸ºäº†ï¼Œè®©æŠ¥å·å’Œç‚¹å•ï¼Œæœ‰ä¸ªç•Œé¢ã€‚è¿™ä¸¤å¤©åœ¨å¼„è¿™ä¸ªï¼Œå‰2ç¯‡æ˜¯é€šè¿‡è™šæ‹Ÿå£°å¡ï¼Œè¾¾åˆ°äº†æœ€ç®€å•çš„ä¸€ä¸ªé€»è¾‘ï¼Œæ’­æ”¾æ–‡æœ¬å°±ä»å£°å¡å‘å£°ï¼Œä¸æ’­æ— æ‰€è°“ï¼Œè‡ªåŠ¨å¿™éŸ³ã€‚é‚£ä¸ªå·¥ä½œåœ¨windowså¹³å°ï¼Œå¯¹äºåˆšæ¥è§¦çš„ï¼Œæœ€å¥½æ˜¯æ…¢æ…¢å’ŒAIè°ƒè¯•ç€æ¥ï¼Œä¸€äº›åŠŸèƒ½å°±åšå‡ºæ¥ã€‚åˆå¹¶çš„ä»£ç ï¼Œå°±å½“æˆå‰©ä¸‹çš„ä½œä¸šï¼Œæœ‰ç©ºå†æ¥åšã€‚"
keywords: "æ–‡æœ¬è½¬è¯­éŸ³-éŸ³ç”»é€‚æ—¶æ¨é€rtspå¹¶æ’­æ”¾"
categories: ['æ—¥å¸¸å°æ“ä½œ', 'Python', 'Mac']
tags: ['Python']
artid: "146164664"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146164664
    alt: "æ–‡æœ¬è½¬è¯­éŸ³-éŸ³ç”»é€‚æ—¶æ¨é€rtspå¹¶æ’­æ”¾"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146164664
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146164664
cover: https://bing.ee123.net/img/rand?artid=146164664
image: https://bing.ee123.net/img/rand?artid=146164664
img: https://bing.ee123.net/img/rand?artid=146164664
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     æ–‡æœ¬è½¬è¯­éŸ³-éŸ³ç”»é€‚æ—¶æ¨é€rtspå¹¶æ’­æ”¾
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="./../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="./../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <div class="video">
     <iframe allowfullscreen="true" data-mediaembed="csdn" frameborder="0" id="kTE7WLlr-1741615638923" src="https://live.csdn.net/v/embed/468141" style="width:100%;height:100%;">
     </iframe>
     <p>
      æ–‡æœ¬è¯­éŸ³ rtspé€‚æ—¶æ’­æ”¾å«å·ç³»ç»Ÿçš„åº•å±‚é€»è¾‘
     </p>
    </div>
    <br/>
    å‘å¸ƒLinux, unix socket å’Œwindow win32åšä¸ºéŸ³é¢‘æºçš„ python10ä¸‹çš„(ffmpeg version 7.1) å¯è¿è¡Œç‰ˆæœ¬.
    <p>
    </p>
    <p>
     è¿™ä¸¤å¤©åœ¨å¼„è¿™ä¸ªï¼Œå‰2ç¯‡æ˜¯é€šè¿‡è™šæ‹Ÿå£°å¡ï¼Œè¾¾åˆ°äº†æœ€ç®€å•çš„ä¸€ä¸ªé€»è¾‘ï¼Œæ’­æ”¾æ–‡æœ¬å°±ä»å£°å¡å‘å£°ï¼Œä¸æ’­æ— æ‰€è°“ï¼Œè‡ªåŠ¨å¿™éŸ³ã€‚ é‚£ä¸ªå·¥ä½œåœ¨windowså¹³å°ï¼Œ
     <br/>
     è€Œä»Šå¤©çš„è¿™ä¸ªç›¸ä¼¼åŠŸèƒ½çš„ä»£ç æ˜¯mac osï¼Œç†è®ºæ”¯æŒwindowsï¼Œå’Œlinuxï¼Œä¾èµ–ffmpegå’Œxiuï¼ˆä¸€ä¸ªrustæµæœåŠ¡å™¨ï¼‰çš„rtspæœåŠ¡ã€‚
     <br/>
     ä»Šå¤©çš„éš¾ç‚¹æœ‰ç‚¹å¤š
    </p>
    <ol>
     <li>
      asyncioçš„ä»»åŠ¡ async def _tts_worker(self, text: str) è¿è¡Œä¸­æœ‰å„ç§é”™è¯¯ï¼Œ engine runAndWaitæ˜¯ä¸è¡Œçš„ã€‚ å†…éƒ¨æœ‰å®ƒçš„event loopã€‚æ‰€ä»¥initå’ŒendLoopï¼Œæ˜¯æš‚æ—¶æ‰¾åˆ°çš„è§£å†³åŠæ³•ã€‚åŒæ—¶ç»å†äº†ï¼Œè¿™ä¸ªï¼Œå’Œè°ƒç”¨ ffmpeg å¤–éƒ¨æŒ‡ä»¤ï¼Œå¹¶ç›´æ¥è·å–- ä»£è¡¨çš„stdoutã€‚ ä¼šé‡åˆ°å„ç§é—®é¢˜ã€‚åšäº†æ•è·å’Œå¤„ç†ã€‚ä½†æ˜¯æŸ¥æ‰¾çš„æ—¶å€™ï¼Œä¸æ˜¯å¤ªå®¹æ˜“ã€‚
     </li>
     <li>
      self._start_ffmpeg() ä»–éœ€è¦ï¼Œ create socket æˆ–pipeå®Œæˆä»¥åï¼Œæ‰èƒ½è¿è¡Œã€‚ è°ƒè¯•æˆ‘éƒ½æ‰‹å·¥åœ¨å¤–éƒ¨å¯åŠ¨ã€‚ ä½œç”¨å°±æ˜¯ï¼Œè¾“å‡ºåˆ°rtspæœåŠ¡å™¨ï¼Œä»¥å¤‡æ’­æ”¾ã€‚
     </li>
     <li>
      input handleï¼Œç­‰éƒ½æ˜¯aiç”Ÿæˆçš„ï¼Œå› ä¸ºæœ‰å¥½å¤šç§å¾ªç¯ï¼Œè¿™æ˜¯æ¯”è¾ƒçœå¿ƒåœ¨ã€‚
     </li>
     <li>
      æœ€ç´§æ€¥éšè”½åœ¨æ˜¯ï¼Œ async def _heartbeat(self) ä»–éœ€è¦è®¡ç®—æ’­æ”¾é™éŸ³çš„æ—¶é—´ï¼Œé•¿äº†ä¸è¡Œï¼ŒçŸ­äº†ä¸è¡Œã€‚ è¿™ä¸ªæœ€åˆåœ¨æµ‹è¯•ä»£ç ï¼Œå°±å‡ ä¸ªå‡½æ•°ã€‚ç„¶åAIï¼Œç”Ÿæˆäº†ä¸‰ä¸ªtheadingçš„ç‰ˆæœ¬ï¼Œä¸¤ä¸ªQueueã€‚ ç„¶åè½¬åˆ°äº†å¼‚æ­¥ç‰ˆæœ¬ï¼Œæ˜æ˜¾å¿«äº†å¾ˆå¤šã€‚
     </li>
     <li>
      åœ¨windowsä¸Šä½¿ç”¨win32pipenå¯ä»¥è¾¾åˆ°unix socketçš„æ•ˆæœå¾ˆç›¸ä¼¼ï¼Œ è®°å¾—è¿˜æœ‰FIFOæ˜¯linuxä¸“ç”¨çš„ï¼Œå½“ç„¶è¿˜æœ‰stdinï¼Œå’Œstdoutã€‚å¯¹äºffmpegï¼Œè¿™æ˜¯ä¸€äº›ç¨‹åºå†…éƒ¨çš„ä¼ é€æœºåˆ¶
     </li>
     <li>
      rtspæ˜¯éœ€è¦ä¸€ä¸ªåå°çš„æœåŠ¡çš„ï¼Œxiuæ˜¯å¼€æºçš„rusté¡¹ç›®ï¼Œå¯ä»¥ä½¿ã€‚å¦å¤–windowæ¨èmetamtxï¼ŒåŒå‡»è¿è¡Œï¼Œä»€ä¹ˆä¹Ÿä¸ç®¡ã€‚
      <br/>
      <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://i-blog.csdnimg.cn/direct/c2d51fe12f9b4bc69dcc0720b56d8a26.png#pic_center"/>
     </li>
    </ol>
    <p>
     éŸ³ç”»åŒæ­¥åº”è¯¥æ˜¯å¦ä¸ªé—®é¢˜äº†ï¼Œå‡ å¤©å‰ï¼Œé¼“æ£äº†ä¸€ä¸‹å›¾ç‰‡ã€‚è®©ç¼–è¾‘åçš„ï¼Œé©¬ä¸Š åœ¨è§†é¢‘ä¸­æ˜¾ç¤ºã€‚ è¿™ä¸ªå¦å¤–ä¸€ä¸ªè¯é¢˜äº†ã€‚åšçš„è¿™äº›å°±ä¸ºäº†ï¼Œè®©æŠ¥å·å’Œç‚¹å•ï¼Œæœ‰ä¸ªç•Œé¢ã€‚
    </p>
    <pre><code class="prism language-bash">ffmpeg <span class="token parameter variable">-re</span> <span class="token parameter variable">-framerate</span> <span class="token number">30</span> <span class="token parameter variable">-f</span> image2 <span class="token parameter variable">-loop</span> <span class="token number">1</span> <span class="token parameter variable">-i</span> <span class="token string">"image1.jpg"</span> <span class="token parameter variable">-c:v</span> libx264 <span class="token parameter variable">-preset</span> ultrafast <span class="token parameter variable">-tune</span> zerolatency <span class="token parameter variable">-pix_fmt</span> rgba  <span class="token parameter variable">-f</span> rtsp <span class="token parameter variable">-rtsp_transport</span> tcp rtsp://localhost:8554/live
</code></pre>
    <p>
     åˆå¹¶çš„ä»£ç ï¼Œå°±å½“æˆå‰©ä¸‹çš„ä½œä¸šï¼Œæœ‰ç©ºå†æ¥åšã€‚
    </p>
    <p>
     å¯¹äºåˆšæ¥è§¦çš„ï¼Œæœ€å¥½æ˜¯æ…¢æ…¢å’ŒAIè°ƒè¯•ç€æ¥ï¼Œä¸€äº›åŠŸèƒ½å°±åšå‡ºæ¥ã€‚
    </p>
    <div class="mermaid">
     <svg class="mermaid-svg" height="158.15780639648438" id="mermaid-svg-hcCOYTpsvVM9Wfki" viewbox="0 0 748.2672119140625 158.15780639648438" width="748.2672119140625" xmlns="http://www.w3.org/2000/svg">
      <style>
       #mermaid-svg-hcCOYTpsvVM9Wfki {font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}#mermaid-svg-hcCOYTpsvVM9Wfki .error-icon{fill:#552222;}#mermaid-svg-hcCOYTpsvVM9Wfki .error-text{fill:#552222;stroke:#552222;}#mermaid-svg-hcCOYTpsvVM9Wfki .edge-thickness-normal{stroke-width:2px;}#mermaid-svg-hcCOYTpsvVM9Wfki .edge-thickness-thick{stroke-width:3.5px;}#mermaid-svg-hcCOYTpsvVM9Wfki .edge-pattern-solid{stroke-dasharray:0;}#mermaid-svg-hcCOYTpsvVM9Wfki .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-svg-hcCOYTpsvVM9Wfki .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-svg-hcCOYTpsvVM9Wfki .marker{fill:#333333;stroke:#333333;}#mermaid-svg-hcCOYTpsvVM9Wfki .marker.cross{stroke:#333333;}#mermaid-svg-hcCOYTpsvVM9Wfki svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-svg-hcCOYTpsvVM9Wfki .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#mermaid-svg-hcCOYTpsvVM9Wfki .cluster-label text{fill:#333;}#mermaid-svg-hcCOYTpsvVM9Wfki .cluster-label span{color:#333;}#mermaid-svg-hcCOYTpsvVM9Wfki .label text,#mermaid-svg-hcCOYTpsvVM9Wfki span{fill:#333;color:#333;}#mermaid-svg-hcCOYTpsvVM9Wfki .node rect,#mermaid-svg-hcCOYTpsvVM9Wfki .node circle,#mermaid-svg-hcCOYTpsvVM9Wfki .node ellipse,#mermaid-svg-hcCOYTpsvVM9Wfki .node polygon,#mermaid-svg-hcCOYTpsvVM9Wfki .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#mermaid-svg-hcCOYTpsvVM9Wfki .node .label{text-align:center;}#mermaid-svg-hcCOYTpsvVM9Wfki .node.clickable{cursor:pointer;}#mermaid-svg-hcCOYTpsvVM9Wfki .arrowheadPath{fill:#333333;}#mermaid-svg-hcCOYTpsvVM9Wfki .edgePath .path{stroke:#333333;stroke-width:2.0px;}#mermaid-svg-hcCOYTpsvVM9Wfki .flowchart-link{stroke:#333333;fill:none;}#mermaid-svg-hcCOYTpsvVM9Wfki .edgeLabel{background-color:#e8e8e8;text-align:center;}#mermaid-svg-hcCOYTpsvVM9Wfki .edgeLabel rect{opacity:0.5;background-color:#e8e8e8;fill:#e8e8e8;}#mermaid-svg-hcCOYTpsvVM9Wfki .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#mermaid-svg-hcCOYTpsvVM9Wfki .cluster text{fill:#333;}#mermaid-svg-hcCOYTpsvVM9Wfki .cluster span{color:#333;}#mermaid-svg-hcCOYTpsvVM9Wfki div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#mermaid-svg-hcCOYTpsvVM9Wfki :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}
      </style>
      <g>
       <g class="output">
        <g class="clusters">
        </g>
        <g class="edgePaths">
         <g class="edgePath LS-A LE-B" id="L-A-B" style="opacity: 1;">
          <path class="path" d="M124,60.97283010123752L133.28645833333334,58.073842284071624C142.57291666666666,55.17485446690574,161.14583333333334,49.376878832573965,188.05208333333334,46.47789101540807C214.95833333333334,43.57890319824219,250.19791666666666,43.57890319824219,286.4713541666667,43.57890319824219C322.7447916666667,43.57890319824219,360.0520833333333,43.57890319824219,389.4069895965425,47.151493558491666C418.7618958597516,50.724083918741144,440.16441671950315,57.86926463924009,450.865677149379,61.44185499948957L461.5669375792548,65.01444535973904" marker-end="url(#arrowhead75)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead75" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-A LE-C" id="L-A-C" style="opacity: 1;">
          <path class="path" d="M124,97.18497629524686L133.28645833333334,100.08396411241274C142.57291666666666,102.98295192957863,161.14583333333334,108.78092756391042,179.71875,111.6799153810763C198.29166666666666,114.57890319824219,216.86458333333334,114.57890319824219,226.15104166666666,114.57890319824219L235.4375,114.57890319824219" marker-end="url(#arrowhead76)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead76" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-B LE-D" id="L-B-D" style="opacity: 1;">
          <path class="path" d="M548.109375,79.07890319824219L552.2760416666666,79.07890319824219C556.4427083333334,79.07890319824219,564.7760416666666,79.07890319824219,573.1927088419596,79.16223653157552C581.6093760172525,79.24556986490886,590.1093770345052,79.41223653157552,594.3593775431315,79.49556986490884L598.6093780517577,79.57890319824217" marker-end="url(#arrowhead77)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead77" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-C LE-B" id="L-C-B" style="opacity: 1;">
          <path class="path" d="M335.4375,114.57890319824219L345.7578125,114.57890319824219C356.078125,114.57890319824219,376.71875,114.57890319824219,397.74032292987584,111.00631283799271C418.7618958597516,107.43372247774323,440.16441671950315,100.28854175724427,450.865677149379,96.71595139699481L461.5669375792548,93.14336103674533" marker-end="url(#arrowhead78)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead78" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
        </g>
        <g class="edgeLabels">
         <g class="edgeLabel" style="opacity: 1;" transform="translate(285.4375,43.57890319824219)">
          <g class="label" transform="translate(-16,-13)">
           <rect height="26" rx="0" ry="0" width="32">
           </rect>
           <foreignobject height="26" width="32">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-A' L-LE-B" id="L-L-A-B">
              å¯åŠ¨
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="translate(179.71875,114.57890319824219)">
          <g class="label" transform="translate(-30.71875,-13)">
           <rect height="26" rx="0" ry="0" width="61.4375">
           </rect>
           <foreignobject height="26" width="61.4375">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-A' L-LE-C" id="L-L-A-C">
              æ¥æ”¶text
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="">
          <g class="label" transform="translate(0,0)">
           <rect height="0" rx="0" ry="0" width="0">
           </rect>
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-B' L-LE-D" id="L-L-B-D">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="translate(397.359375,114.57890319824219)">
          <g class="label" transform="translate(-36.921875,-13)">
           <rect height="26" rx="0" ry="0" width="73.84375">
           </rect>
           <foreignobject height="26" width="73.84375">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-C' L-LE-B" id="L-L-C-B">
              FIFOunix..
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
        </g>
        <g class="nodes">
         <g class="node default" id="flowchart-A-40" style="opacity: 1;" transform="translate(66,79.07890319824219)">
          <rect class="label-container" height="46" rx="0" ry="0" width="116" x="-58" y="-23">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-48,-13)">
            <foreignobject height="26" width="96">
             <div style="display: inline-block; white-space: nowrap;">
              åŒæ­¥è¯­éŸ³ä¼ è¾“
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-B-41" style="opacity: 1;" transform="translate(503.6953125,79.07890319824219)">
          <circle class="label-container" r="44.4140625" x="-44.4140625" y="-23">
          </circle>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-34.4140625,-13)">
            <foreignobject height="26" width="68.828125">
             <div style="display: inline-block; white-space: nowrap;">
              è¯­éŸ³ æ¨é€
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-C-43" style="opacity: 1;" transform="translate(285.4375,114.57890319824219)">
          <rect class="label-container" height="46" rx="5" ry="5" width="100" x="-50" y="-23">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-40,-13)">
            <foreignobject height="26" width="80">
             <div style="display: inline-block; white-space: nowrap;">
              æ–‡æœ¬è½¬è¯­éŸ³
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-D-45" style="opacity: 1;" transform="translate(669.1882781982422,79.07890319824219)">
          <polygon class="label-container" points="71.07890625,0 142.1578125,-71.07890625 71.07890625,-142.1578125 0,-71.07890625" transform="translate(-71.07890625,71.07890625)">
          </polygon>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-45.9765625,-13)">
            <foreignobject height="26" width="91.953125">
             <div style="display: inline-block; white-space: nowrap;">
              rtspæµæœåŠ¡å™¨
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
        </g>
       </g>
      </g>
     </svg>
    </div>
    <p>
     è¯­éŸ³æ¨é€ä½¿ç”¨ffmpegç‹¬ç«‹è¿›ç¨‹ï¼Œå®ç°äº†å‰åä¸­æ–­åè‡ªåŠ¨é‡å¯ã€‚
    </p>
    <h3>
     <a id="_32">
     </a>
     ç¨‹åºä¸»ä½“
    </h3>
    <p>
     å¯ç‹¬ç«‹è¿è¡Œï¼Œä¹Ÿå¯ä»¥ç»“åˆffmgç®¡ç†æ¨é€è¿›ç¨‹
    </p>
    <ol>
     <li>
      macos ,ç†è®ºLinuxé€‚ç”¨,å•æ–‡ä»¶å¯æ‰§è¡Œ
      <br/>
      main.py
     </li>
    </ol>
    <pre><code class="prism language-bash"><span class="token function">import</span> asyncio
<span class="token function">import</span> struct
<span class="token function">import</span> pyttsx3
<span class="token function">import</span> tempfile
<span class="token function">import</span> os
<span class="token function">import</span> socket
from aioconsole <span class="token function">import</span> ainput
from contextlib <span class="token function">import</span> suppress
from typing <span class="token function">import</span> Optional

class AsyncTTSController:
    def __init__<span class="token punctuation">(</span>self<span class="token punctuation">)</span>:
        <span class="token comment"># ä½¿ç”¨UnixåŸŸå¥—æ¥å­—</span>
        self.socket_path <span class="token operator">=</span> <span class="token string">"/tmp/tts_audio.sock"</span>
        self.server_socket: Optional<span class="token punctuation">[</span>socket.socket<span class="token punctuation">]</span> <span class="token operator">=</span> None
        self.client_socket: Optional<span class="token punctuation">[</span>socket.socket<span class="token punctuation">]</span> <span class="token operator">=</span> None
        
        <span class="token comment"># è¿›ç¨‹æ§åˆ¶</span>
        self.ffmpeg_process: Optional<span class="token punctuation">[</span>asyncio.subprocess.Process<span class="token punctuation">]</span> <span class="token operator">=</span> None
        self.running <span class="token operator">=</span> False
        
        <span class="token comment"># TTSå¼•æ“</span>
        self.engine <span class="token operator">=</span> pyttsx3.init<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self.engine.setProperty<span class="token punctuation">(</span><span class="token string">'rate'</span>, <span class="token number">180</span><span class="token punctuation">)</span>
        self.engine.setProperty<span class="token punctuation">(</span><span class="token string">'volume'</span>, <span class="token number">1.0</span><span class="token punctuation">)</span>
        
        <span class="token comment"># éŸ³é¢‘å‚æ•°</span>
        self.sample_rate <span class="token operator">=</span> <span class="token number">24000</span>
        self.channels <span class="token operator">=</span> <span class="token number">1</span>
        self.bits_per_sample <span class="token operator">=</span> <span class="token number">16</span>
        self.silence <span class="token operator">=</span> self._generate_silence<span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">)</span>
        self.wav_header <span class="token operator">=</span> self._generate_wav_header<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        <span class="token comment"># çŠ¶æ€ç®¡ç†</span>
        self.connection_active <span class="token operator">=</span> False
        self.last_heartbeat <span class="token operator">=</span> <span class="token number">0.0</span>
        self.heartbeat_interval <span class="token operator">=</span> <span class="token number">2.0</span>
        self.sending_audio <span class="token operator">=</span> <span class="token number">0</span>
    def _generate_wav_header<span class="token punctuation">(</span>self<span class="token punctuation">)</span> -<span class="token operator">&gt;</span> bytes:
        <span class="token string">""</span>"ç”ŸæˆWAVæ–‡ä»¶å¤´<span class="token string">""</span>"
        byte_rate <span class="token operator">=</span> self.sample_rate * self.channels * self.bits_per_sample // <span class="token number">8</span>
        block_align <span class="token operator">=</span> self.channels * self.bits_per_sample // <span class="token number">8</span>
        <span class="token builtin class-name">return</span> struct.pack<span class="token punctuation">(</span>
            <span class="token string">'&lt;4sI4s4sIHHIIHH4sI'</span>,
            b<span class="token string">'RIFF'</span>, <span class="token number">36</span>, b<span class="token string">'WAVE'</span>, b<span class="token string">'fmt '</span>, <span class="token number">16</span>, <span class="token number">1</span>, self.channels,
            self.sample_rate, byte_rate, block_align, self.bits_per_sample,
            b<span class="token string">'data'</span>, <span class="token number">0</span>
        <span class="token punctuation">)</span>

    def _generate_silence<span class="token punctuation">(</span>self, duration: float<span class="token punctuation">)</span> -<span class="token operator">&gt;</span> bytes:
        <span class="token string">""</span>"ç”Ÿæˆé™éŸ³æ•°æ®<span class="token string">""</span>"
        samples <span class="token operator">=</span> int<span class="token punctuation">(</span>self.sample_rate * duration<span class="token punctuation">)</span>
        <span class="token builtin class-name">return</span> bytes<span class="token punctuation">(</span>samples * self.channels * <span class="token punctuation">(</span>self.bits_per_sample // <span class="token number">8</span><span class="token punctuation">))</span>

    async def _async_create_socket<span class="token punctuation">(</span>self<span class="token punctuation">)</span> -<span class="token operator">&gt;</span> None:
        <span class="token string">""</span>"åˆ›å»ºUnixåŸŸå¥—æ¥å­—<span class="token string">""</span>"
        with suppress<span class="token punctuation">(</span>Exception<span class="token punctuation">)</span>:
            <span class="token keyword">if</span> os.path.exists<span class="token punctuation">(</span>self.socket_path<span class="token punctuation">)</span>:
                os.unlink<span class="token punctuation">(</span>self.socket_path<span class="token punctuation">)</span>
                
            self.server_socket <span class="token operator">=</span> socket.socket<span class="token punctuation">(</span>socket.AF_UNIX, socket.SOCK_STREAM<span class="token punctuation">)</span>
            self.server_socket.setblocking<span class="token punctuation">(</span>False<span class="token punctuation">)</span>
            self.server_socket.bind<span class="token punctuation">(</span>self.socket_path<span class="token punctuation">)</span>
            self.server_socket.listen<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
            
            loop <span class="token operator">=</span> asyncio.get_running_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">while</span> self.running and not self.connection_active:
                try:
                    self.client_socket, _ <span class="token operator">=</span> await loop.sock_accept<span class="token punctuation">(</span>self.server_socket<span class="token punctuation">)</span>
                    self.connection_active <span class="token operator">=</span> True
                    print<span class="token punctuation">(</span><span class="token string">"å®¢æˆ·ç«¯å·²è¿æ¥"</span><span class="token punctuation">)</span>
                    await loop.sock_sendall<span class="token punctuation">(</span>self.client_socket, self.wav_header<span class="token punctuation">)</span>
                except <span class="token punctuation">(</span>BlockingIOError, InterruptedError<span class="token punctuation">)</span>:
                    await asyncio.sleep<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>
                except Exception as e:
                    print<span class="token punctuation">(</span>f<span class="token string">"è¿æ¥é”™è¯¯: {str(e)}"</span><span class="token punctuation">)</span>
                    self.connection_active <span class="token operator">=</span> False
                    await asyncio.sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

    async def _start_ffmpeg<span class="token punctuation">(</span>self<span class="token punctuation">)</span> -<span class="token operator">&gt;</span> None:
        <span class="token string">""</span>"å¯åŠ¨FFmpegè¿›ç¨‹<span class="token string">""</span>"
        with suppress<span class="token punctuation">(</span>Exception<span class="token punctuation">)</span>:
            <span class="token keyword">if</span> self.ffmpeg_process:
                self.ffmpeg_process.terminate<span class="token punctuation">(</span><span class="token punctuation">)</span>
                await self.ffmpeg_process.wait<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token assign-left variable">socketid</span><span class="token operator">=</span><span class="token string">'unix:'</span>+self.socket_path

            self.ffmpeg_process <span class="token operator">=</span> await asyncio.create_subprocess_exec<span class="token punctuation">(</span>
                <span class="token string">'ffmpeg'</span>,
                <span class="token string">'-f'</span>, <span class="token string">'s16le'</span>,
                <span class="token string">'-ar'</span>, str<span class="token punctuation">(</span>self.sample_rate<span class="token punctuation">)</span>,
                <span class="token string">'-ac'</span>, str<span class="token punctuation">(</span>self.channels<span class="token punctuation">)</span>,
                <span class="token string">'-i'</span>, socketid,  <span class="token comment"># ä¿®æ”¹è¾“å…¥æºä¸ºå¥—æ¥å­—è·¯å¾„</span>
                <span class="token string">'-c:a'</span>, <span class="token string">'aac'</span>,
                <span class="token string">'-f'</span>, <span class="token string">'rtsp'</span>,
                <span class="token string">'-rtsp_transport'</span>, <span class="token string">'tcp'</span>,
                <span class="token string">'rtsp://localhost:8554/mystream'</span>,
                <span class="token assign-left variable">stdout</span><span class="token operator">=</span>asyncio.subprocess.DEVNULL,
                <span class="token assign-left variable">stdin</span><span class="token operator">=</span>asyncio.subprocess.DEVNULL,
                <span class="token assign-left variable">stderr</span><span class="token operator">=</span>asyncio.subprocess.PIPE
            <span class="token punctuation">)</span>
            asyncio.create_task<span class="token punctuation">(</span>self._monitor_ffmpeg_errors<span class="token punctuation">(</span><span class="token punctuation">))</span>

    async def _monitor_ffmpeg_errors<span class="token punctuation">(</span>self<span class="token punctuation">)</span> -<span class="token operator">&gt;</span> None:
        <span class="token string">""</span>"ç›‘æ§FFmpegé”™è¯¯è¾“å‡º<span class="token string">""</span>"
        <span class="token keyword">while</span> self.running and self.ffmpeg_process:
            line <span class="token operator">=</span> await self.ffmpeg_process.stderr.readline<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> not line:
                <span class="token builtin class-name">break</span>
         <span class="token comment">#   print(f"[FFmpeg Error] {line.decode().strip()}")</span>

    async def _async_write_socket<span class="token punctuation">(</span>self, data: bytes<span class="token punctuation">)</span> -<span class="token operator">&gt;</span> None:
        <span class="token string">""</span>"å®‰å…¨å†™å…¥å¥—æ¥å­—<span class="token string">""</span>"
        try:
            <span class="token keyword">if</span> self.client_socket and self.connection_active:
                loop <span class="token operator">=</span> asyncio.get_running_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
                await loop.sock_sendall<span class="token punctuation">(</span>self.client_socket, data<span class="token punctuation">)</span>
        except <span class="token punctuation">(</span>BrokenPipeError, ConnectionResetError<span class="token punctuation">)</span>:
            print<span class="token punctuation">(</span><span class="token string">"è¿æ¥å·²æ–­å¼€ï¼Œå°è¯•é‡è¿..."</span><span class="token punctuation">)</span>
            await self._reconnect_pipeline<span class="token punctuation">(</span><span class="token punctuation">)</span>
        except Exception as e:
            print<span class="token punctuation">(</span>f<span class="token string">"å†™å…¥é”™è¯¯: {str(e)}"</span><span class="token punctuation">)</span>
            self.connection_active <span class="token operator">=</span> False

    async def _reconnect_pipeline<span class="token punctuation">(</span>self<span class="token punctuation">)</span> -<span class="token operator">&gt;</span> None:
        <span class="token string">""</span>"å®Œæ•´é‡è¿æµç¨‹<span class="token string">""</span>"
        print<span class="token punctuation">(</span><span class="token string">"å¯åŠ¨é‡è¿æµç¨‹..."</span><span class="token punctuation">)</span>
        self.connection_active <span class="token operator">=</span> False
        <span class="token keyword">if</span> self.client_socket:
            self.client_socket.close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token assign-left variable">task1</span><span class="token operator">=</span>asyncio.create_task<span class="token punctuation">(</span>self._async_create_socket<span class="token punctuation">(</span><span class="token punctuation">))</span>,
        <span class="token assign-left variable">task2</span><span class="token operator">=</span>asyncio.create_task<span class="token punctuation">(</span> self._start_ffmpeg<span class="token punctuation">(</span><span class="token punctuation">))</span>,    
        await task2
        await task1
       <span class="token comment"># await asyncio.gather(task1, task2)</span>
        <span class="token comment">#await self._async_create_socket()</span>
        <span class="token comment">#await self._start_ffmpeg()</span>

    <span class="token comment"># å‰©ä½™çš„heartbeatã€tts_workerã€input_handlerç­‰æ–¹æ³•ä¿æŒç›¸åŒ...</span>

    async def stop<span class="token punctuation">(</span>self<span class="token punctuation">)</span> -<span class="token operator">&gt;</span> None:
        <span class="token string">""</span>"å®‰å…¨å…³é—­<span class="token string">""</span>"
        self.running <span class="token operator">=</span> False
        with suppress<span class="token punctuation">(</span>Exception<span class="token punctuation">)</span>:
            <span class="token keyword">if</span> self.ffmpeg_process:
                self.ffmpeg_process.terminate<span class="token punctuation">(</span><span class="token punctuation">)</span>
                await self.ffmpeg_process.wait<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> self.client_socket:
                self.client_socket.close<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> self.server_socket:
                self.server_socket.close<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> os.path.exists<span class="token punctuation">(</span>self.socket_path<span class="token punctuation">)</span>:
                os.unlink<span class="token punctuation">(</span>self.socket_path<span class="token punctuation">)</span>
            print<span class="token punctuation">(</span><span class="token string">"æ‰€æœ‰èµ„æºå·²é‡Šæ”¾"</span><span class="token punctuation">)</span>
    async def _heartbeat<span class="token punctuation">(</span>self<span class="token punctuation">)</span> -<span class="token operator">&gt;</span> None:
        <span class="token string">""</span>"å¿ƒè·³ç»´æŒæœºåˆ¶<span class="token string">""</span>"
        <span class="token keyword">while</span> self.running:
            <span class="token keyword">if</span> self.connection_active <span class="token builtin class-name">:</span>
                <span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>:
                    <span class="token keyword">if</span>   self.sending_audio<span class="token operator">&lt;</span><span class="token number">0</span>:
                       await self._async_write_socket<span class="token punctuation">(</span>self.silence<span class="token punctuation">)</span>
                    <span class="token keyword">else</span> <span class="token builtin class-name">:</span>
                        self.sending_audio-<span class="token operator">=</span> <span class="token number">2</span>
                    await asyncio.sleep<span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">)</span>   
                    
           <span class="token comment">#     print(self.sending_audio,"slend")</span>
              <span class="token comment">#  await asyncio.sleep(self.heartbeat_interval)</span>
            else:
                await asyncio.sleep<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span>
    def _sync_tts<span class="token punctuation">(</span>self,text,tmp_filename<span class="token punctuation">)</span>:
        <span class="token assign-left variable">eng</span><span class="token operator">=</span>pyttsx3.init<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">#  eng.say(text)</span>
        eng.save_to_file<span class="token punctuation">(</span>text, <span class="token string">'temp3.wav'</span><span class="token punctuation">)</span>
        eng.runAndWait<span class="token punctuation">(</span><span class="token punctuation">)</span>
        eng.endLoop<span class="token punctuation">(</span><span class="token punctuation">)</span>
            
    async def _tts_worker<span class="token punctuation">(</span>self, text: str<span class="token punctuation">)</span> -<span class="token operator">&gt;</span> None:
        <span class="token string">""</span>"å¼‚æ­¥TTSå¤„ç†æ ¸å¿ƒ<span class="token string">""</span>"
        tmp_filename <span class="token operator">=</span> None
        <span class="token comment">#with open('audio1.raw','rb') as chunkf:</span>
                <span class="token comment"># data=chunkf.read()</span>
                <span class="token comment"># secdd=len(data)/48000</span>
                <span class="token comment"># self.sending_audio=int(secdd*10) </span>
                <span class="token comment"># await self._async_write_socket(data)</span>
               
              
                <span class="token comment"># #await asyncio.sleep(secdd)</span>
                
 
                <span class="token comment"># print (secdd,len(data) )   </span>
        
            <span class="token comment"># åˆ›å»ºä¸´æ—¶æ–‡ä»¶</span>
        with tempfile.NamedTemporaryFile<span class="token punctuation">(</span>delete<span class="token operator">=</span>False<span class="token punctuation">)</span> as tmp:
                tmp_filename <span class="token operator">=</span> tmp.name

            <span class="token comment"># # åŒæ­¥TTSæ“ä½œè½¬å¼‚æ­¥æ‰§è¡Œ</span>
        loop <span class="token operator">=</span> asyncio.get_running_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
        await loop.run_in_executor<span class="token punctuation">(</span>None, self._sync_tts, *<span class="token punctuation">(</span>text, <span class="token string">'temp3.wav'</span>,<span class="token punctuation">))</span>
            <span class="token comment"># è½¬æ¢éŸ³é¢‘æ ¼å¼</span>
           <span class="token comment"># await asyncio.sleep(1.3)</span>
           <span class="token comment"># self._sync_tts(text,tmp_filename)</span>
        try: 
            proc <span class="token operator">=</span> await asyncio.create_subprocess_exec<span class="token punctuation">(</span>
    <span class="token string">'ffmpeg'</span>,
    <span class="token string">'-hide_banner'</span>,
    <span class="token string">'-loglevel'</span>, <span class="token string">'error'</span>,
    <span class="token string">'-y'</span>,
    <span class="token string">'-i'</span>, <span class="token string">'temp3.wav'</span>,       <span class="token comment"># è¾“å…¥æ–‡ä»¶è·¯å¾„</span>
    <span class="token string">'-f'</span>, <span class="token string">'s16le'</span>,            <span class="token comment"># å¼ºåˆ¶è¾“å‡ºæ ¼å¼ä¸ºPCM s16le</span>
    <span class="token string">'-acodec'</span>, <span class="token string">'pcm_s16le'</span>,   <span class="token comment"># æ˜ç¡®æŒ‡å®šéŸ³é¢‘ç¼–è§£ç å™¨ ğŸ‘ˆ å…³é”®ä¿®å¤</span>
    <span class="token string">'-ar'</span>, str<span class="token punctuation">(</span>self.sample_rate<span class="token punctuation">)</span>,
    <span class="token string">'-ac'</span>, str<span class="token punctuation">(</span>self.channels<span class="token punctuation">)</span>,
    <span class="token string">'-'</span>,                     <span class="token comment"># è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡º</span>
    <span class="token assign-left variable">stdout</span><span class="token operator">=</span>asyncio.subprocess.PIPE
<span class="token punctuation">)</span>

           <span class="token comment"># æµå¼å‘é€éŸ³é¢‘æ•°æ®</span>
            <span class="token assign-left variable">sum</span><span class="token operator">=</span><span class="token number">0</span>
            <span class="token keyword">while</span> chunk :<span class="token operator">=</span> await proc.stdout.read<span class="token punctuation">(</span><span class="token number">4096</span><span class="token punctuation">)</span>:
              
               <span class="token assign-left variable">sum</span><span class="token operator">+=</span>len<span class="token punctuation">(</span>chunk<span class="token punctuation">)</span>
               await self._async_write_socket<span class="token punctuation">(</span>chunk<span class="token punctuation">)</span>
            <span class="token assign-left variable">self.sending_audio</span><span class="token operator">=</span>int<span class="token punctuation">(</span>sum*10/48000<span class="token punctuation">)</span> 
            print<span class="token punctuation">(</span><span class="token string">"write data x0.1s:"</span>,self.sending_audio<span class="token punctuation">)</span>


        finally:
            <span class="token keyword">if</span> tmp_filename and os.path.exists<span class="token punctuation">(</span>tmp_filename<span class="token punctuation">)</span>:
              <span class="token number">1</span>
              <span class="token comment">#  os.unlink(tmp_filename)</span>

    async def _input_handler<span class="token punctuation">(</span>self<span class="token punctuation">)</span> -<span class="token operator">&gt;</span> None:
        <span class="token string">""</span>"å¼‚æ­¥è¾“å…¥å¤„ç†<span class="token string">""</span>"
        <span class="token keyword">while</span> self.running:
            try:
                text <span class="token operator">=</span> await ainput<span class="token punctuation">(</span><span class="token string">"è¯·è¾“å…¥æ–‡æœ¬ï¼ˆè¾“å…¥qé€€å‡ºï¼‰: "</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> text.lower<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'q'</span><span class="token builtin class-name">:</span>
                    self.running <span class="token operator">=</span> False
                    <span class="token builtin class-name">break</span>
                <span class="token keyword">if</span> text.strip<span class="token punctuation">(</span><span class="token punctuation">)</span>:
                  await self._tts_worker<span class="token punctuation">(</span>text<span class="token punctuation">)</span>
            except Exception as e:
                print<span class="token punctuation">(</span>f<span class="token string">"è¾“å…¥é”™è¯¯: {str(e)}"</span><span class="token punctuation">)</span>

    async def run<span class="token punctuation">(</span>self<span class="token punctuation">)</span> -<span class="token operator">&gt;</span> None:
        <span class="token string">""</span>"ä¸»è¿è¡Œå¾ªç¯<span class="token string">""</span>"
        self.running <span class="token operator">=</span> True
       <span class="token comment"># </span>
        <span class="token comment">#await  self._start_ffmpeg()</span>

        tasks <span class="token operator">=</span> <span class="token punctuation">[</span>
            asyncio.create_task<span class="token punctuation">(</span>self._async_create_socket<span class="token punctuation">(</span><span class="token punctuation">))</span>,
            asyncio.create_task<span class="token punctuation">(</span> self._start_ffmpeg<span class="token punctuation">(</span><span class="token punctuation">))</span>,
            asyncio.create_task<span class="token punctuation">(</span>self._input_handler<span class="token punctuation">(</span><span class="token punctuation">))</span>,
            asyncio.create_task<span class="token punctuation">(</span>self._heartbeat<span class="token punctuation">(</span><span class="token punctuation">))</span>,


        <span class="token punctuation">]</span>
       
        await asyncio.gather<span class="token punctuation">(</span>*tasks<span class="token punctuation">)</span>
       
    

<span class="token comment"># ä»¥ä¸‹ä¿æŒä¸å˜...</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token builtin class-name">:</span>
    controller <span class="token operator">=</span> AsyncTTSController<span class="token punctuation">(</span><span class="token punctuation">)</span>
    try:
        asyncio.run<span class="token punctuation">(</span>controller.run<span class="token punctuation">(</span><span class="token punctuation">))</span>
    except KeyboardInterrupt:
        asyncio.run<span class="token punctuation">(</span>controller.stop<span class="token punctuation">(</span><span class="token punctuation">))</span>
<span class="token string">""</span>"
ffmpeg <span class="token parameter variable">-y</span> <span class="token parameter variable">-i</span> temp.wav <span class="token parameter variable">-f</span> s16le <span class="token parameter variable">-acodec</span> pcm_s16le  <span class="token parameter variable">-ar</span> <span class="token number">24000</span>  <span class="token parameter variable">-ac</span> <span class="token number">1</span>   audio.raw
ffmpeg  <span class="token parameter variable">-ar</span> <span class="token number">24000</span> <span class="token parameter variable">-ac</span> <span class="token number">1</span> <span class="token parameter variable">-f</span> s16le  <span class="token parameter variable">-i</span> unix:/tmp/tts_audio.sock <span class="token parameter variable">-f</span> rtsp  rtsp://localhost:8554/mystream
<span class="token string">""</span>"
</code></pre>
    <ol start="2">
     <li>
      window10ç³»ç»Ÿpython10 å¯è¿è¡Œç‰ˆæœ¬
      <br/>
      ä¸»è¦è®©deepseek,æ‰§è¡Œäº†,socket åˆ° win32pipençš„æ›¿æ¢.å› ä¸ºæœ¬æ¥å°±æ˜¯æ¢è¿‡å»çš„.è¿™ä¸€å—çš„ä»£ç å®Œå…¨æ²¡æœ‰æ‰‹å·¥ä»‹å…¥. å”¯ä¸€æ”¹çš„æ˜¯æ³¨é‡Šeng.endLoop(),å¹¶ä¸ç”¨æ¯æ¬¡init() ,åº”æ”¹æ˜¯pyttsx3çš„ä¸€ä¸ªè·¨å¹³å°ç‰¹æ€§. ,å¼‚æ­¥çš„win32ä¸‹æ”¯æŒç¨³å®š.
     </li>
    </ol>
    <pre><code class="prism language-bash">    def _sync_tts<span class="token punctuation">(</span>self, text, tmp_filename<span class="token punctuation">)</span>:
         eng <span class="token operator">=</span> self.engine  <span class="token comment">#pyttsx3.init()</span>
        eng.save_to_file<span class="token punctuation">(</span>text, <span class="token string">'temp3.wav'</span><span class="token punctuation">)</span>
        eng.runAndWait<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">#  eng.endLoop()</span>
</code></pre>
    <p>
     main-win.py
    </p>
    <pre><code class="prism language-bash"><span class="token function">import</span> asyncio
<span class="token function">import</span> struct
<span class="token function">import</span> pyttsx3
<span class="token function">import</span> tempfile
<span class="token function">import</span> os
from aioconsole <span class="token function">import</span> ainput
from contextlib <span class="token function">import</span> suppress
from typing <span class="token function">import</span> Optional
<span class="token function">import</span> win32pipe
<span class="token function">import</span> win32file
<span class="token function">import</span> pywintypes

class AsyncTTSController:
    def __init__<span class="token punctuation">(</span>self<span class="token punctuation">)</span>:
        <span class="token comment"># ä½¿ç”¨Windowså‘½åç®¡é“</span>
        self.pipe_name <span class="token operator">=</span> r<span class="token string">'\\.\pipe\tts_audio_pipe'</span>
        self.pipe_handle <span class="token operator">=</span> None
        
        <span class="token comment"># è¿›ç¨‹æ§åˆ¶</span>
        self.ffmpeg_process: Optional<span class="token punctuation">[</span>asyncio.subprocess.Process<span class="token punctuation">]</span> <span class="token operator">=</span> None
        self.running <span class="token operator">=</span> False
        
        <span class="token comment"># TTSå¼•æ“</span>
        self.engine <span class="token operator">=</span> pyttsx3.init<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self.engine.setProperty<span class="token punctuation">(</span><span class="token string">'rate'</span>, <span class="token number">180</span><span class="token punctuation">)</span>
        self.engine.setProperty<span class="token punctuation">(</span><span class="token string">'volume'</span>, <span class="token number">1.0</span><span class="token punctuation">)</span>
        
        <span class="token comment"># éŸ³é¢‘å‚æ•°</span>
        self.sample_rate <span class="token operator">=</span> <span class="token number">24000</span>
        self.channels <span class="token operator">=</span> <span class="token number">1</span>
        self.bits_per_sample <span class="token operator">=</span> <span class="token number">16</span>
        self.silence <span class="token operator">=</span> self._generate_silence<span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">)</span>
        self.wav_header <span class="token operator">=</span> self._generate_wav_header<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        <span class="token comment"># çŠ¶æ€ç®¡ç†</span>
        self.connection_active <span class="token operator">=</span> False
        self.last_heartbeat <span class="token operator">=</span> <span class="token number">0.0</span>
        self.heartbeat_interval <span class="token operator">=</span> <span class="token number">2.0</span>
        self.sending_audio <span class="token operator">=</span> <span class="token number">0</span>

    def _generate_wav_header<span class="token punctuation">(</span>self<span class="token punctuation">)</span> -<span class="token operator">&gt;</span> bytes:
        <span class="token string">""</span>"ç”ŸæˆWAVæ–‡ä»¶å¤´<span class="token string">""</span>"
        byte_rate <span class="token operator">=</span> self.sample_rate * self.channels * self.bits_per_sample // <span class="token number">8</span>
        block_align <span class="token operator">=</span> self.channels * self.bits_per_sample // <span class="token number">8</span>
        <span class="token builtin class-name">return</span> struct.pack<span class="token punctuation">(</span>
            <span class="token string">'&lt;4sI4s4sIHHIIHH4sI'</span>,
            b<span class="token string">'RIFF'</span>, <span class="token number">36</span>, b<span class="token string">'WAVE'</span>, b<span class="token string">'fmt '</span>, <span class="token number">16</span>, <span class="token number">1</span>, self.channels,
            self.sample_rate, byte_rate, block_align, self.bits_per_sample,
            b<span class="token string">'data'</span>, <span class="token number">0</span>
        <span class="token punctuation">)</span>

    def _generate_silence<span class="token punctuation">(</span>self, duration: float<span class="token punctuation">)</span> -<span class="token operator">&gt;</span> bytes:
        <span class="token string">""</span>"ç”Ÿæˆé™éŸ³æ•°æ®<span class="token string">""</span>"
        samples <span class="token operator">=</span> int<span class="token punctuation">(</span>self.sample_rate * duration<span class="token punctuation">)</span>
        <span class="token builtin class-name">return</span> bytes<span class="token punctuation">(</span>samples * self.channels * <span class="token punctuation">(</span>self.bits_per_sample // <span class="token number">8</span><span class="token punctuation">))</span>

    async def _async_create_pipe<span class="token punctuation">(</span>self<span class="token punctuation">)</span> -<span class="token operator">&gt;</span> None:
        <span class="token string">""</span>"åˆ›å»ºå‘½åç®¡é“<span class="token string">""</span>"
        <span class="token keyword">while</span> self.running and not self.connection_active:
            try:
                <span class="token comment"># åˆ›å»ºå‘½åç®¡é“</span>
                self.pipe_handle <span class="token operator">=</span> win32pipe.CreateNamedPipe<span class="token punctuation">(</span>
                    self.pipe_name,
                    win32pipe.PIPE_ACCESS_DUPLEX,
                    win32pipe.PIPE_TYPE_BYTE <span class="token operator">|</span> win32pipe.PIPE_READMODE_BYTE <span class="token operator">|</span> win32pipe.PIPE_WAIT,
                    <span class="token number">1</span>,  <span class="token comment"># æœ€å¤§å®ä¾‹æ•°</span>
                    <span class="token number">65536</span>, <span class="token number">65536</span>,  <span class="token comment"># è¾“å…¥è¾“å‡ºç¼“å†²åŒºå¤§å°</span>
                    <span class="token number">0</span>,  <span class="token comment"># é»˜è®¤è¶…æ—¶</span>
                    None  <span class="token comment"># å®‰å…¨å±æ€§</span>
                <span class="token punctuation">)</span>
                
                <span class="token comment"># å¼‚æ­¥ç­‰å¾…è¿æ¥</span>
                loop <span class="token operator">=</span> asyncio.get_running_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
                await loop.run_in_executor<span class="token punctuation">(</span>None, win32pipe.ConnectNamedPipe, self.pipe_handle, None<span class="token punctuation">)</span>
                self.connection_active <span class="token operator">=</span> True
                print<span class="token punctuation">(</span><span class="token string">"å®¢æˆ·ç«¯å·²è¿æ¥"</span><span class="token punctuation">)</span>
                await self._async_write_socket<span class="token punctuation">(</span>self.wav_header<span class="token punctuation">)</span>
            except pywintypes.error as e:
                <span class="token keyword">if</span> e.winerror <span class="token operator">==</span> <span class="token number">536</span>:  <span class="token comment"># ERROR_PIPE_CONNECTED</span>
                    self.connection_active <span class="token operator">=</span> True
                    print<span class="token punctuation">(</span><span class="token string">"å®¢æˆ·ç«¯å·²è¿æ¥"</span><span class="token punctuation">)</span>
                <span class="token keyword">elif</span> e.winerror <span class="token operator">==</span> <span class="token number">232</span>:  <span class="token comment"># å®¢æˆ·ç«¯æ–­å¼€</span>
                    print<span class="token punctuation">(</span><span class="token string">"å®¢æˆ·ç«¯æ–­å¼€è¿æ¥"</span><span class="token punctuation">)</span>
                    self.connection_active <span class="token operator">=</span> False
                    <span class="token keyword">if</span> self.pipe_handle:
                        win32file.CloseHandle<span class="token punctuation">(</span>self.pipe_handle<span class="token punctuation">)</span>
                        self.pipe_handle <span class="token operator">=</span> None
                    await asyncio.sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
                else:
                    print<span class="token punctuation">(</span>f<span class="token string">"ç®¡é“é”™è¯¯: {e}"</span><span class="token punctuation">)</span>
                    await asyncio.sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
            except Exception as e:
                print<span class="token punctuation">(</span>f<span class="token string">"å…¶ä»–é”™è¯¯: {e}"</span><span class="token punctuation">)</span>
                await asyncio.sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

    async def _start_ffmpeg<span class="token punctuation">(</span>self<span class="token punctuation">)</span> -<span class="token operator">&gt;</span> None:
        <span class="token string">""</span>"å¯åŠ¨FFmpegè¿›ç¨‹<span class="token string">""</span>"
        with suppress<span class="token punctuation">(</span>Exception<span class="token punctuation">)</span>:
            <span class="token keyword">if</span> self.ffmpeg_process:
                self.ffmpeg_process.terminate<span class="token punctuation">(</span><span class="token punctuation">)</span>
                await self.ffmpeg_process.wait<span class="token punctuation">(</span><span class="token punctuation">)</span>

            self.ffmpeg_process <span class="token operator">=</span> await asyncio.create_subprocess_exec<span class="token punctuation">(</span>
                <span class="token string">'ffmpeg'</span>,
                <span class="token string">'-f'</span>, <span class="token string">'s16le'</span>,
                <span class="token string">'-ar'</span>, str<span class="token punctuation">(</span>self.sample_rate<span class="token punctuation">)</span>,
                <span class="token string">'-ac'</span>, str<span class="token punctuation">(</span>self.channels<span class="token punctuation">)</span>,
                <span class="token string">'-i'</span>, self.pipe_name,
                <span class="token string">'-c:a'</span>, <span class="token string">'aac'</span>,
                <span class="token string">'-f'</span>, <span class="token string">'rtsp'</span>,
                <span class="token string">'-rtsp_transport'</span>, <span class="token string">'tcp'</span>,
                <span class="token string">'rtsp://localhost:8554/mystream'</span>,
                <span class="token assign-left variable">stdout</span><span class="token operator">=</span>asyncio.subprocess.DEVNULL,
                <span class="token assign-left variable">stdin</span><span class="token operator">=</span>asyncio.subprocess.DEVNULL,
                <span class="token assign-left variable">stderr</span><span class="token operator">=</span>asyncio.subprocess.PIPE
            <span class="token punctuation">)</span>
            asyncio.create_task<span class="token punctuation">(</span>self._monitor_ffmpeg_errors<span class="token punctuation">(</span><span class="token punctuation">))</span>

    async def _monitor_ffmpeg_errors<span class="token punctuation">(</span>self<span class="token punctuation">)</span> -<span class="token operator">&gt;</span> None:
        <span class="token string">""</span>"ç›‘æ§FFmpegé”™è¯¯è¾“å‡º<span class="token string">""</span>"
        <span class="token keyword">while</span> self.running and self.ffmpeg_process:
            line <span class="token operator">=</span> await self.ffmpeg_process.stderr.readline<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> not line:
                <span class="token builtin class-name">break</span>
            <span class="token comment"># print(f"[FFmpeg Error] {line.decode().strip()}")</span>

    async def _async_write_socket<span class="token punctuation">(</span>self, data: bytes<span class="token punctuation">)</span> -<span class="token operator">&gt;</span> None:
        <span class="token string">""</span>"å®‰å…¨å†™å…¥ç®¡é“<span class="token string">""</span>"
        try:
            <span class="token keyword">if</span> self.connection_active and self.pipe_handle:
                loop <span class="token operator">=</span> asyncio.get_running_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
                await loop.run_in_executor<span class="token punctuation">(</span>None, win32file.WriteFile, self.pipe_handle, data<span class="token punctuation">)</span>
        except pywintypes.error as e:
            print<span class="token punctuation">(</span>f<span class="token string">"å†™å…¥é”™è¯¯: {e}"</span><span class="token punctuation">)</span>
            self.connection_active <span class="token operator">=</span> False
            await self._reconnect_pipeline<span class="token punctuation">(</span><span class="token punctuation">)</span>
        except Exception as e:
            print<span class="token punctuation">(</span>f<span class="token string">"å…¶ä»–å†™å…¥é”™è¯¯: {e}"</span><span class="token punctuation">)</span>
            self.connection_active <span class="token operator">=</span> False

    async def _reconnect_pipeline<span class="token punctuation">(</span>self<span class="token punctuation">)</span> -<span class="token operator">&gt;</span> None:
        <span class="token string">""</span>"å®Œæ•´é‡è¿æµç¨‹<span class="token string">""</span>"
        print<span class="token punctuation">(</span><span class="token string">"å¯åŠ¨é‡è¿æµç¨‹..."</span><span class="token punctuation">)</span>
        self.connection_active <span class="token operator">=</span> False
        <span class="token keyword">if</span> self.pipe_handle:
            win32file.CloseHandle<span class="token punctuation">(</span>self.pipe_handle<span class="token punctuation">)</span>
            self.pipe_handle <span class="token operator">=</span> None
        await asyncio.gather<span class="token punctuation">(</span>
            self._async_create_pipe<span class="token punctuation">(</span><span class="token punctuation">)</span>,
            self._start_ffmpeg<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>

    async def _heartbeat<span class="token punctuation">(</span>self<span class="token punctuation">)</span> -<span class="token operator">&gt;</span> None:
        <span class="token string">""</span>"å¿ƒè·³ç»´æŒæœºåˆ¶<span class="token string">""</span>"
        <span class="token keyword">while</span> self.running:
            <span class="token keyword">if</span> self.connection_active:
                <span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>:
                    <span class="token keyword">if</span> self.sending_audio <span class="token operator">&lt;</span> <span class="token number">0</span>:
                        await self._async_write_socket<span class="token punctuation">(</span>self.silence<span class="token punctuation">)</span>
                    else:
                        self.sending_audio -<span class="token operator">=</span> <span class="token number">2</span>
                    await asyncio.sleep<span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">)</span>
            else:
                await asyncio.sleep<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span>

    def _sync_tts<span class="token punctuation">(</span>self, text, tmp_filename<span class="token punctuation">)</span>:
        eng <span class="token operator">=</span> pyttsx3.init<span class="token punctuation">(</span><span class="token punctuation">)</span>
        eng.save_to_file<span class="token punctuation">(</span>text, <span class="token string">'temp3.wav'</span><span class="token punctuation">)</span>
        eng.runAndWait<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">#  eng.endLoop()</span>

    async def _tts_worker<span class="token punctuation">(</span>self, text: str<span class="token punctuation">)</span> -<span class="token operator">&gt;</span> None:
        <span class="token string">""</span>"å¼‚æ­¥TTSå¤„ç†æ ¸å¿ƒ<span class="token string">""</span>"
        await asyncio.get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>.run_in_executor<span class="token punctuation">(</span>None, self._sync_tts, text, <span class="token string">'temp3.wav'</span><span class="token punctuation">)</span>

        try:
            proc <span class="token operator">=</span> await asyncio.create_subprocess_exec<span class="token punctuation">(</span>
                <span class="token string">'ffmpeg'</span>,
                <span class="token string">'-hide_banner'</span>,
                <span class="token string">'-loglevel'</span>, <span class="token string">'error'</span>,
                <span class="token string">'-y'</span>,
                <span class="token string">'-i'</span>, <span class="token string">'temp3.wav'</span>,
                <span class="token string">'-f'</span>, <span class="token string">'s16le'</span>,
                <span class="token string">'-acodec'</span>, <span class="token string">'pcm_s16le'</span>,
                <span class="token string">'-ar'</span>, str<span class="token punctuation">(</span>self.sample_rate<span class="token punctuation">)</span>,
                <span class="token string">'-ac'</span>, str<span class="token punctuation">(</span>self.channels<span class="token punctuation">)</span>,
                <span class="token string">'-'</span>,
                <span class="token assign-left variable">stdout</span><span class="token operator">=</span>asyncio.subprocess.PIPE
            <span class="token punctuation">)</span>

            sum_bytes <span class="token operator">=</span> <span class="token number">0</span>
            <span class="token keyword">while</span> chunk :<span class="token operator">=</span> await proc.stdout.read<span class="token punctuation">(</span><span class="token number">4096</span><span class="token punctuation">)</span>:
                sum_bytes <span class="token operator">+=</span> len<span class="token punctuation">(</span>chunk<span class="token punctuation">)</span>
                await self._async_write_socket<span class="token punctuation">(</span>chunk<span class="token punctuation">)</span>
            self.sending_audio <span class="token operator">=</span> int<span class="token punctuation">(</span>sum_bytes * <span class="token number">10</span> / <span class="token number">48000</span><span class="token punctuation">)</span>
            print<span class="token punctuation">(</span>f<span class="token string">"å†™å…¥æ•°æ® x0.1s: {self.sending_audio}"</span><span class="token punctuation">)</span>

        finally:
            <span class="token keyword">if</span> os.path.exists<span class="token punctuation">(</span><span class="token string">'temp3.wav'</span><span class="token punctuation">)</span>:
                os.remove<span class="token punctuation">(</span><span class="token string">'temp3.wav'</span><span class="token punctuation">)</span>

    async def _input_handler<span class="token punctuation">(</span>self<span class="token punctuation">)</span> -<span class="token operator">&gt;</span> None:
        <span class="token string">""</span>"å¼‚æ­¥è¾“å…¥å¤„ç†<span class="token string">""</span>"
        <span class="token keyword">while</span> self.running:
            try:
                text <span class="token operator">=</span> await ainput<span class="token punctuation">(</span><span class="token string">"è¯·è¾“å…¥æ–‡æœ¬ï¼ˆè¾“å…¥qé€€å‡ºï¼‰: "</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> text.lower<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'q'</span><span class="token builtin class-name">:</span>
                    self.running <span class="token operator">=</span> False
                    <span class="token builtin class-name">break</span>
                <span class="token keyword">if</span> text.strip<span class="token punctuation">(</span><span class="token punctuation">)</span>:
                    await self._tts_worker<span class="token punctuation">(</span>text<span class="token punctuation">)</span>
            except Exception as e:
                print<span class="token punctuation">(</span>f<span class="token string">"è¾“å…¥é”™è¯¯: {str(e)}"</span><span class="token punctuation">)</span>

    async def run<span class="token punctuation">(</span>self<span class="token punctuation">)</span> -<span class="token operator">&gt;</span> None:
        <span class="token string">""</span>"ä¸»è¿è¡Œå¾ªç¯<span class="token string">""</span>"
        self.running <span class="token operator">=</span> True
        tasks <span class="token operator">=</span> <span class="token punctuation">[</span>
            asyncio.create_task<span class="token punctuation">(</span>self._async_create_pipe<span class="token punctuation">(</span><span class="token punctuation">))</span>,
            asyncio.create_task<span class="token punctuation">(</span>self._start_ffmpeg<span class="token punctuation">(</span><span class="token punctuation">))</span>,
            asyncio.create_task<span class="token punctuation">(</span>self._input_handler<span class="token punctuation">(</span><span class="token punctuation">))</span>,
            asyncio.create_task<span class="token punctuation">(</span>self._heartbeat<span class="token punctuation">(</span><span class="token punctuation">))</span>,
        <span class="token punctuation">]</span>
        await asyncio.gather<span class="token punctuation">(</span>*tasks<span class="token punctuation">)</span>

    async def stop<span class="token punctuation">(</span>self<span class="token punctuation">)</span> -<span class="token operator">&gt;</span> None:
        <span class="token string">""</span>"å®‰å…¨å…³é—­<span class="token string">""</span>"
        self.running <span class="token operator">=</span> False
        with suppress<span class="token punctuation">(</span>Exception<span class="token punctuation">)</span>:
            <span class="token keyword">if</span> self.ffmpeg_process:
                self.ffmpeg_process.terminate<span class="token punctuation">(</span><span class="token punctuation">)</span>
                await self.ffmpeg_process.wait<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> self.pipe_handle:
                win32pipe.DisconnectNamedPipe<span class="token punctuation">(</span>self.pipe_handle<span class="token punctuation">)</span>
                win32file.CloseHandle<span class="token punctuation">(</span>self.pipe_handle<span class="token punctuation">)</span>
            print<span class="token punctuation">(</span><span class="token string">"æ‰€æœ‰èµ„æºå·²é‡Šæ”¾"</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token builtin class-name">:</span>
    controller <span class="token operator">=</span> AsyncTTSController<span class="token punctuation">(</span><span class="token punctuation">)</span>
    try:
        asyncio.run<span class="token punctuation">(</span>controller.run<span class="token punctuation">(</span><span class="token punctuation">))</span>
    except KeyboardInterrupt:
        asyncio.run<span class="token punctuation">(</span>controller.stop<span class="token punctuation">(</span><span class="token punctuation">))</span>

</code></pre>
    <h3>
     <a id="ffmpeg_570">
     </a>
     ç‹¬ç«‹çš„ffmpegå¯åŠ¨å’Œç›‘æ§çš„ç‹¬ç«‹ä»£ç 
    </h3>
    <p>
     éªŒè¯äº†ä¸€ä¸‹rtspæ–­çº¿é‡å»ºè¿ç»“ï¼Œä¹ŸéªŒè¯äº† ä¸Šé¢ çš„main.pyçš„socket serveré€€å‡ºåï¼Œffmpegè‡ªåŠ¨é‡å¯è¿æ¥ã€‚ è¦ä½¿ç”¨è¿™ä¸ªæ›´ç¨³å¥çƒçš„ç¨‹åºï¼Œéœ€è¦
    </p>
    <blockquote>
     <p>
      æ³¨é‡Šmain.py runä¸­çš„asyncio.create_task( self._start_ffmpeg()),
     </p>
    </blockquote>
    <p>
     ä»£ç ä¸ç”¨ä¿®æ”¹,æŠŠç®¡é“åè¿™ä¸ªå¿«, å½»åº•ä¿®æ”¹ä¸º,ffmpegè®¤è¯†çš„windowæ ·å¼,å°±å¯è¿è¡Œ.
    </p>
    <blockquote>
     <p>
      râ€™\.\pipe\tts_audio_pipeâ€™
     </p>
    </blockquote>
    <p>
     <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://i-blog.csdnimg.cn/direct/b9afd098601a49a0ac40d4169e35355c.png">
      <br/>
      ffmg,py
     </img>
    </p>
    <pre><code class="prism language-bash"><span class="token function">import</span> asyncio
from contextlib <span class="token function">import</span> suppress
<span class="token function">import</span> logging
logging.basicConfig<span class="token punctuation">(</span>level<span class="token operator">=</span>logging.INFO, <span class="token assign-left variable">format</span><span class="token operator">=</span><span class="token string">'%(asctime)s - %(levelname)s - %(message)s'</span><span class="token punctuation">)</span>

class FFmpegManager:
    def __init__<span class="token punctuation">(</span>self<span class="token punctuation">)</span>:
        self.ffmpeg_process <span class="token operator">=</span> None
        self._retry_count <span class="token operator">=</span> <span class="token number">0</span>
        self._max_retries <span class="token operator">=</span> <span class="token number">5</span>
        self._retry_lock <span class="token operator">=</span> asyncio.Lock<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self._is_running <span class="token operator">=</span> False
        <span class="token assign-left variable">self.sample_rate</span><span class="token operator">=</span><span class="token number">24000</span>
        <span class="token assign-left variable">self.channels</span><span class="token operator">=</span><span class="token number">1</span>
        self.socket_path <span class="token operator">=</span> <span class="token string">"/tmp/tts_audio.sock"</span>

    async def _start_ffmpeg<span class="token punctuation">(</span>self<span class="token punctuation">)</span> -<span class="token operator">&gt;</span> None:
        <span class="token string">""</span>"å¸¦è‡ªåŠ¨é‡è¯•çš„FFmpegå¯åŠ¨å‡½æ•°<span class="token string">""</span>"
        async with self._retry_lock:
            await self._safe_terminate<span class="token punctuation">(</span><span class="token punctuation">)</span>
            
            try:
                socketid <span class="token operator">=</span> <span class="token string">'unix:'</span> + self.socket_path
                self.ffmpeg_process <span class="token operator">=</span>await asyncio.create_subprocess_exec<span class="token punctuation">(</span>
                <span class="token string">'ffmpeg'</span>,
                <span class="token string">'-f'</span>, <span class="token string">'s16le'</span>,
                <span class="token string">'-ar'</span>, str<span class="token punctuation">(</span>self.sample_rate<span class="token punctuation">)</span>,
                <span class="token string">'-ac'</span>, str<span class="token punctuation">(</span>self.channels<span class="token punctuation">)</span>,
                <span class="token string">'-i'</span>, socketid,  <span class="token comment"># ä¿®æ”¹è¾“å…¥æºä¸ºå¥—æ¥å­—è·¯å¾„</span>
                <span class="token string">'-c:a'</span>, <span class="token string">'aac'</span>,
                <span class="token string">'-f'</span>, <span class="token string">'rtsp'</span>,
                <span class="token string">'-rtsp_transport'</span>, <span class="token string">'tcp'</span>,
                <span class="token string">'rtsp://localhost:8554/mystream'</span>,
                <span class="token assign-left variable">stdout</span><span class="token operator">=</span>asyncio.subprocess.DEVNULL,
                <span class="token assign-left variable">stdin</span><span class="token operator">=</span>asyncio.subprocess.DEVNULL,
                <span class="token assign-left variable">stderr</span><span class="token operator">=</span>asyncio.subprocess.PIPE
            <span class="token punctuation">)</span>
                self._retry_count <span class="token operator">=</span> <span class="token number">0</span>  <span class="token comment"># é‡ç½®é‡è¯•è®¡æ•°å™¨</span>
                asyncio.create_task<span class="token punctuation">(</span>self._monitor_ffmpeg_errors<span class="token punctuation">(</span><span class="token punctuation">))</span>
                self._is_running <span class="token operator">=</span> True
            except Exception as e:
                logging.error<span class="token punctuation">(</span>f<span class="token string">"FFmpegå¯åŠ¨å¤±è´¥: {str(e)}"</span><span class="token punctuation">)</span>
                await self._handle_retry<span class="token punctuation">(</span><span class="token punctuation">)</span>

    async def _monitor_ffmpeg_errors<span class="token punctuation">(</span>self<span class="token punctuation">)</span>:
        <span class="token string">""</span>"å¢å¼ºå‹è¿›ç¨‹ç›‘æ§<span class="token string">""</span>"
        <span class="token keyword">while</span> self._is_running:
            logging.info<span class="token punctuation">(</span><span class="token string">"loop  error cathch"</span><span class="token punctuation">)</span>
            stderr <span class="token operator">=</span> await self.ffmpeg_process.stderr.readline<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> stderr:
                logging.error<span class="token punctuation">(</span>f<span class="token string">"FFmpegé”™è¯¯è¾“å‡º: {stderr.decode().strip()}"</span><span class="token punctuation">)</span>
            
            <span class="token comment"># æ£€æµ‹è¿›ç¨‹çŠ¶æ€</span>
            return_code <span class="token operator">=</span> self.ffmpeg_process.returncode
            <span class="token keyword">if</span> return_code is not None:
                logging.warning<span class="token punctuation">(</span>f<span class="token string">"FFmpegå¼‚å¸¸é€€å‡ºï¼Œè¿”å›ç : {return_code}"</span><span class="token punctuation">)</span>
                self._is_running <span class="token operator">=</span> False
                await self._handle_retry<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token builtin class-name">break</span>

    async def _handle_retry<span class="token punctuation">(</span>self<span class="token punctuation">)</span>:
        <span class="token string">""</span>"æ™ºèƒ½é‡è¯•ç­–ç•¥<span class="token string">""</span>"
        <span class="token keyword">if</span> self._retry_count <span class="token operator">&gt;=</span> self._max_retries:
            logging.critical<span class="token punctuation">(</span><span class="token string">"è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œæ”¾å¼ƒé‡å¯"</span><span class="token punctuation">)</span>
            <span class="token builtin class-name">return</span>

        <span class="token comment"># æŒ‡æ•°é€€é¿ç®—æ³•</span>
        delay <span class="token operator">=</span> min<span class="token punctuation">(</span><span class="token number">2</span> ** self._retry_count, <span class="token number">30</span><span class="token punctuation">)</span>  <span class="token comment"># æœ€å¤§é—´éš”30ç§’</span>
        self._retry_count <span class="token operator">+=</span> <span class="token number">1</span>
        logging.info<span class="token punctuation">(</span>f<span class="token string">"å°†åœ¨ {delay} ç§’åå°è¯•ç¬¬ {self._retry_count} æ¬¡é‡å¯"</span><span class="token punctuation">)</span>

        await asyncio.sleep<span class="token punctuation">(</span>delay<span class="token punctuation">)</span>
        await self._start_ffmpeg<span class="token punctuation">(</span><span class="token punctuation">)</span>

    async def _safe_terminate<span class="token punctuation">(</span>self<span class="token punctuation">)</span>:
        <span class="token string">""</span>"å®‰å…¨ç»ˆæ­¢ç°æœ‰è¿›ç¨‹<span class="token string">""</span>"
        <span class="token keyword">if</span> self.ffmpeg_process:
            with suppress<span class="token punctuation">(</span>Exception<span class="token punctuation">)</span>:
                self.ffmpeg_process.terminate<span class="token punctuation">(</span><span class="token punctuation">)</span>
                await self.ffmpeg_process.wait<span class="token punctuation">(</span><span class="token punctuation">)</span>
                self.ffmpeg_process <span class="token operator">=</span> None
<span class="token comment"># ä»¥ä¸‹ä¿æŒä¸å˜...</span>
async def main<span class="token punctuation">(</span><span class="token punctuation">)</span>:
    <span class="token assign-left variable">controller</span><span class="token operator">=</span>FFmpegManager<span class="token punctuation">(</span><span class="token punctuation">)</span>
    try:
        await controller._start_ffmpeg<span class="token punctuation">(</span><span class="token punctuation">)</span>
        logging.info<span class="token punctuation">(</span><span class="token string">'rung'</span><span class="token punctuation">)</span>
        await asyncio.sleep<span class="token punctuation">(</span><span class="token number">1160</span><span class="token punctuation">)</span>
    except KeyboardInterrupt:
        logging.info<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
        asyncio.run<span class="token punctuation">(</span>controller._safe_terminate<span class="token punctuation">(</span><span class="token punctuation">))</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token builtin class-name">:</span>
     
     asyncio.run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">))</span>
</code></pre>
   </div>
   <link href="./../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="./../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="6874747073:3a2f2f626c6f672e6373646e2e6e65742f776a63726f6f6d2f:61727469636c652f64657461696c732f313436313634363634" class_="artid" style="display:none">
 </p>
</div>


