---
layout: post
title: "文本转语音-音画适时推送rtsp并播放"
date: 2025-03-10 22:08:17 +0800
description: "而今天的这个相似功能的代码是mac os，理论支持windows，和linux，依赖ffmpeg和xiu（一个rust流服务器）的rtsp服务。音画同步应该是另个问题了，几天前，鼓捣了一下图片。让编辑后的，马上 在视频中显示。做的这些就为了，让报号和点单，有个界面。这两天在弄这个，前2篇是通过虚拟声卡，达到了最简单的一个逻辑，播放文本就从声卡发声，不播无所谓，自动忙音。那个工作在windows平台，对于刚接触的，最好是慢慢和AI调试着来，一些功能就做出来。合并的代码，就当成剩下的作业，有空再来做。"
keywords: "文本转语音-音画适时推送rtsp并播放"
categories: ['日常小操作', 'Python', 'Mac']
tags: ['Python']
artid: "146164664"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146164664
    alt: "文本转语音-音画适时推送rtsp并播放"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146164664
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146164664
cover: https://bing.ee123.net/img/rand?artid=146164664
image: https://bing.ee123.net/img/rand?artid=146164664
img: https://bing.ee123.net/img/rand?artid=146164664
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     文本转语音-音画适时推送rtsp并播放
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="./../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="./../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <div class="video">
     <iframe allowfullscreen="true" data-mediaembed="csdn" frameborder="0" id="kTE7WLlr-1741615638923" src="https://live.csdn.net/v/embed/468141" style="width:100%;height:100%;">
     </iframe>
     <p>
      文本语音 rtsp适时播放叫号系统的底层逻辑
     </p>
    </div>
    <br/>
    发布Linux, unix socket 和window win32做为音频源的 python10下的(ffmpeg version 7.1) 可运行版本.
    <p>
    </p>
    <p>
     这两天在弄这个，前2篇是通过虚拟声卡，达到了最简单的一个逻辑，播放文本就从声卡发声，不播无所谓，自动忙音。 那个工作在windows平台，
     <br/>
     而今天的这个相似功能的代码是mac os，理论支持windows，和linux，依赖ffmpeg和xiu（一个rust流服务器）的rtsp服务。
     <br/>
     今天的难点有点多
    </p>
    <ol>
     <li>
      asyncio的任务 async def _tts_worker(self, text: str) 运行中有各种错误， engine runAndWait是不行的。 内部有它的event loop。所以init和endLoop，是暂时找到的解决办法。同时经历了，这个，和调用 ffmpeg 外部指令，并直接获取- 代表的stdout。 会遇到各种问题。做了捕获和处理。但是查找的时候，不是太容易。
     </li>
     <li>
      self._start_ffmpeg() 他需要， create socket 或pipe完成以后，才能运行。 调试我都手工在外部启动。 作用就是，输出到rtsp服务器，以备播放。
     </li>
     <li>
      input handle，等都是ai生成的，因为有好多种循环，这是比较省心在。
     </li>
     <li>
      最紧急隐蔽在是， async def _heartbeat(self) 他需要计算播放静音的时间，长了不行，短了不行。 这个最初在测试代码，就几个函数。然后AI，生成了三个theading的版本，两个Queue。 然后转到了异步版本，明显快了很多。
     </li>
     <li>
      在windows上使用win32pipen可以达到unix socket的效果很相似， 记得还有FIFO是linux专用的，当然还有stdin，和stdout。对于ffmpeg，这是一些程序内部的传送机制
     </li>
     <li>
      rtsp是需要一个后台的服务的，xiu是开源的rust项目，可以使。另外window推荐metamtx，双击运行，什么也不管。
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/c2d51fe12f9b4bc69dcc0720b56d8a26.png#pic_center"/>
     </li>
    </ol>
    <p>
     音画同步应该是另个问题了，几天前，鼓捣了一下图片。让编辑后的，马上 在视频中显示。 这个另外一个话题了。做的这些就为了，让报号和点单，有个界面。
    </p>
    <pre><code class="prism language-bash">ffmpeg <span class="token parameter variable">-re</span> <span class="token parameter variable">-framerate</span> <span class="token number">30</span> <span class="token parameter variable">-f</span> image2 <span class="token parameter variable">-loop</span> <span class="token number">1</span> <span class="token parameter variable">-i</span> <span class="token string">"image1.jpg"</span> <span class="token parameter variable">-c:v</span> libx264 <span class="token parameter variable">-preset</span> ultrafast <span class="token parameter variable">-tune</span> zerolatency <span class="token parameter variable">-pix_fmt</span> rgba  <span class="token parameter variable">-f</span> rtsp <span class="token parameter variable">-rtsp_transport</span> tcp rtsp://localhost:8554/live
</code></pre>
    <p>
     合并的代码，就当成剩下的作业，有空再来做。
    </p>
    <p>
     对于刚接触的，最好是慢慢和AI调试着来，一些功能就做出来。
    </p>
    <div class="mermaid">
     <svg class="mermaid-svg" height="158.15780639648438" id="mermaid-svg-hcCOYTpsvVM9Wfki" viewbox="0 0 748.2672119140625 158.15780639648438" width="748.2672119140625" xmlns="http://www.w3.org/2000/svg">
      <style>
       #mermaid-svg-hcCOYTpsvVM9Wfki {font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}#mermaid-svg-hcCOYTpsvVM9Wfki .error-icon{fill:#552222;}#mermaid-svg-hcCOYTpsvVM9Wfki .error-text{fill:#552222;stroke:#552222;}#mermaid-svg-hcCOYTpsvVM9Wfki .edge-thickness-normal{stroke-width:2px;}#mermaid-svg-hcCOYTpsvVM9Wfki .edge-thickness-thick{stroke-width:3.5px;}#mermaid-svg-hcCOYTpsvVM9Wfki .edge-pattern-solid{stroke-dasharray:0;}#mermaid-svg-hcCOYTpsvVM9Wfki .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-svg-hcCOYTpsvVM9Wfki .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-svg-hcCOYTpsvVM9Wfki .marker{fill:#333333;stroke:#333333;}#mermaid-svg-hcCOYTpsvVM9Wfki .marker.cross{stroke:#333333;}#mermaid-svg-hcCOYTpsvVM9Wfki svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-svg-hcCOYTpsvVM9Wfki .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#mermaid-svg-hcCOYTpsvVM9Wfki .cluster-label text{fill:#333;}#mermaid-svg-hcCOYTpsvVM9Wfki .cluster-label span{color:#333;}#mermaid-svg-hcCOYTpsvVM9Wfki .label text,#mermaid-svg-hcCOYTpsvVM9Wfki span{fill:#333;color:#333;}#mermaid-svg-hcCOYTpsvVM9Wfki .node rect,#mermaid-svg-hcCOYTpsvVM9Wfki .node circle,#mermaid-svg-hcCOYTpsvVM9Wfki .node ellipse,#mermaid-svg-hcCOYTpsvVM9Wfki .node polygon,#mermaid-svg-hcCOYTpsvVM9Wfki .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#mermaid-svg-hcCOYTpsvVM9Wfki .node .label{text-align:center;}#mermaid-svg-hcCOYTpsvVM9Wfki .node.clickable{cursor:pointer;}#mermaid-svg-hcCOYTpsvVM9Wfki .arrowheadPath{fill:#333333;}#mermaid-svg-hcCOYTpsvVM9Wfki .edgePath .path{stroke:#333333;stroke-width:2.0px;}#mermaid-svg-hcCOYTpsvVM9Wfki .flowchart-link{stroke:#333333;fill:none;}#mermaid-svg-hcCOYTpsvVM9Wfki .edgeLabel{background-color:#e8e8e8;text-align:center;}#mermaid-svg-hcCOYTpsvVM9Wfki .edgeLabel rect{opacity:0.5;background-color:#e8e8e8;fill:#e8e8e8;}#mermaid-svg-hcCOYTpsvVM9Wfki .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#mermaid-svg-hcCOYTpsvVM9Wfki .cluster text{fill:#333;}#mermaid-svg-hcCOYTpsvVM9Wfki .cluster span{color:#333;}#mermaid-svg-hcCOYTpsvVM9Wfki div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#mermaid-svg-hcCOYTpsvVM9Wfki :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}
      </style>
      <g>
       <g class="output">
        <g class="clusters">
        </g>
        <g class="edgePaths">
         <g class="edgePath LS-A LE-B" id="L-A-B" style="opacity: 1;">
          <path class="path" d="M124,60.97283010123752L133.28645833333334,58.073842284071624C142.57291666666666,55.17485446690574,161.14583333333334,49.376878832573965,188.05208333333334,46.47789101540807C214.95833333333334,43.57890319824219,250.19791666666666,43.57890319824219,286.4713541666667,43.57890319824219C322.7447916666667,43.57890319824219,360.0520833333333,43.57890319824219,389.4069895965425,47.151493558491666C418.7618958597516,50.724083918741144,440.16441671950315,57.86926463924009,450.865677149379,61.44185499948957L461.5669375792548,65.01444535973904" marker-end="url(#arrowhead75)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead75" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-A LE-C" id="L-A-C" style="opacity: 1;">
          <path class="path" d="M124,97.18497629524686L133.28645833333334,100.08396411241274C142.57291666666666,102.98295192957863,161.14583333333334,108.78092756391042,179.71875,111.6799153810763C198.29166666666666,114.57890319824219,216.86458333333334,114.57890319824219,226.15104166666666,114.57890319824219L235.4375,114.57890319824219" marker-end="url(#arrowhead76)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead76" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-B LE-D" id="L-B-D" style="opacity: 1;">
          <path class="path" d="M548.109375,79.07890319824219L552.2760416666666,79.07890319824219C556.4427083333334,79.07890319824219,564.7760416666666,79.07890319824219,573.1927088419596,79.16223653157552C581.6093760172525,79.24556986490886,590.1093770345052,79.41223653157552,594.3593775431315,79.49556986490884L598.6093780517577,79.57890319824217" marker-end="url(#arrowhead77)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead77" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-C LE-B" id="L-C-B" style="opacity: 1;">
          <path class="path" d="M335.4375,114.57890319824219L345.7578125,114.57890319824219C356.078125,114.57890319824219,376.71875,114.57890319824219,397.74032292987584,111.00631283799271C418.7618958597516,107.43372247774323,440.16441671950315,100.28854175724427,450.865677149379,96.71595139699481L461.5669375792548,93.14336103674533" marker-end="url(#arrowhead78)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead78" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
        </g>
        <g class="edgeLabels">
         <g class="edgeLabel" style="opacity: 1;" transform="translate(285.4375,43.57890319824219)">
          <g class="label" transform="translate(-16,-13)">
           <rect height="26" rx="0" ry="0" width="32">
           </rect>
           <foreignobject height="26" width="32">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-A' L-LE-B" id="L-L-A-B">
              启动
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="translate(179.71875,114.57890319824219)">
          <g class="label" transform="translate(-30.71875,-13)">
           <rect height="26" rx="0" ry="0" width="61.4375">
           </rect>
           <foreignobject height="26" width="61.4375">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-A' L-LE-C" id="L-L-A-C">
              接收text
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="">
          <g class="label" transform="translate(0,0)">
           <rect height="0" rx="0" ry="0" width="0">
           </rect>
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-B' L-LE-D" id="L-L-B-D">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="translate(397.359375,114.57890319824219)">
          <g class="label" transform="translate(-36.921875,-13)">
           <rect height="26" rx="0" ry="0" width="73.84375">
           </rect>
           <foreignobject height="26" width="73.84375">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-C' L-LE-B" id="L-L-C-B">
              FIFOunix..
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
        </g>
        <g class="nodes">
         <g class="node default" id="flowchart-A-40" style="opacity: 1;" transform="translate(66,79.07890319824219)">
          <rect class="label-container" height="46" rx="0" ry="0" width="116" x="-58" y="-23">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-48,-13)">
            <foreignobject height="26" width="96">
             <div style="display: inline-block; white-space: nowrap;">
              同步语音传输
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-B-41" style="opacity: 1;" transform="translate(503.6953125,79.07890319824219)">
          <circle class="label-container" r="44.4140625" x="-44.4140625" y="-23">
          </circle>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-34.4140625,-13)">
            <foreignobject height="26" width="68.828125">
             <div style="display: inline-block; white-space: nowrap;">
              语音 推送
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-C-43" style="opacity: 1;" transform="translate(285.4375,114.57890319824219)">
          <rect class="label-container" height="46" rx="5" ry="5" width="100" x="-50" y="-23">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-40,-13)">
            <foreignobject height="26" width="80">
             <div style="display: inline-block; white-space: nowrap;">
              文本转语音
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-D-45" style="opacity: 1;" transform="translate(669.1882781982422,79.07890319824219)">
          <polygon class="label-container" points="71.07890625,0 142.1578125,-71.07890625 71.07890625,-142.1578125 0,-71.07890625" transform="translate(-71.07890625,71.07890625)">
          </polygon>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-45.9765625,-13)">
            <foreignobject height="26" width="91.953125">
             <div style="display: inline-block; white-space: nowrap;">
              rtsp流服务器
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
        </g>
       </g>
      </g>
     </svg>
    </div>
    <p>
     语音推送使用ffmpeg独立进程，实现了前后中断后自动重启。
    </p>
    <h3>
     <a id="_32">
     </a>
     程序主体
    </h3>
    <p>
     可独立运行，也可以结合ffmg管理推送进程
    </p>
    <ol>
     <li>
      macos ,理论Linux适用,单文件可执行
      <br/>
      main.py
     </li>
    </ol>
    <pre><code class="prism language-bash"><span class="token function">import</span> asyncio
<span class="token function">import</span> struct
<span class="token function">import</span> pyttsx3
<span class="token function">import</span> tempfile
<span class="token function">import</span> os
<span class="token function">import</span> socket
from aioconsole <span class="token function">import</span> ainput
from contextlib <span class="token function">import</span> suppress
from typing <span class="token function">import</span> Optional

class AsyncTTSController:
    def __init__<span class="token punctuation">(</span>self<span class="token punctuation">)</span>:
        <span class="token comment"># 使用Unix域套接字</span>
        self.socket_path <span class="token operator">=</span> <span class="token string">"/tmp/tts_audio.sock"</span>
        self.server_socket: Optional<span class="token punctuation">[</span>socket.socket<span class="token punctuation">]</span> <span class="token operator">=</span> None
        self.client_socket: Optional<span class="token punctuation">[</span>socket.socket<span class="token punctuation">]</span> <span class="token operator">=</span> None
        
        <span class="token comment"># 进程控制</span>
        self.ffmpeg_process: Optional<span class="token punctuation">[</span>asyncio.subprocess.Process<span class="token punctuation">]</span> <span class="token operator">=</span> None
        self.running <span class="token operator">=</span> False
        
        <span class="token comment"># TTS引擎</span>
        self.engine <span class="token operator">=</span> pyttsx3.init<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self.engine.setProperty<span class="token punctuation">(</span><span class="token string">'rate'</span>, <span class="token number">180</span><span class="token punctuation">)</span>
        self.engine.setProperty<span class="token punctuation">(</span><span class="token string">'volume'</span>, <span class="token number">1.0</span><span class="token punctuation">)</span>
        
        <span class="token comment"># 音频参数</span>
        self.sample_rate <span class="token operator">=</span> <span class="token number">24000</span>
        self.channels <span class="token operator">=</span> <span class="token number">1</span>
        self.bits_per_sample <span class="token operator">=</span> <span class="token number">16</span>
        self.silence <span class="token operator">=</span> self._generate_silence<span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">)</span>
        self.wav_header <span class="token operator">=</span> self._generate_wav_header<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        <span class="token comment"># 状态管理</span>
        self.connection_active <span class="token operator">=</span> False
        self.last_heartbeat <span class="token operator">=</span> <span class="token number">0.0</span>
        self.heartbeat_interval <span class="token operator">=</span> <span class="token number">2.0</span>
        self.sending_audio <span class="token operator">=</span> <span class="token number">0</span>
    def _generate_wav_header<span class="token punctuation">(</span>self<span class="token punctuation">)</span> -<span class="token operator">&gt;</span> bytes:
        <span class="token string">""</span>"生成WAV文件头<span class="token string">""</span>"
        byte_rate <span class="token operator">=</span> self.sample_rate * self.channels * self.bits_per_sample // <span class="token number">8</span>
        block_align <span class="token operator">=</span> self.channels * self.bits_per_sample // <span class="token number">8</span>
        <span class="token builtin class-name">return</span> struct.pack<span class="token punctuation">(</span>
            <span class="token string">'&lt;4sI4s4sIHHIIHH4sI'</span>,
            b<span class="token string">'RIFF'</span>, <span class="token number">36</span>, b<span class="token string">'WAVE'</span>, b<span class="token string">'fmt '</span>, <span class="token number">16</span>, <span class="token number">1</span>, self.channels,
            self.sample_rate, byte_rate, block_align, self.bits_per_sample,
            b<span class="token string">'data'</span>, <span class="token number">0</span>
        <span class="token punctuation">)</span>

    def _generate_silence<span class="token punctuation">(</span>self, duration: float<span class="token punctuation">)</span> -<span class="token operator">&gt;</span> bytes:
        <span class="token string">""</span>"生成静音数据<span class="token string">""</span>"
        samples <span class="token operator">=</span> int<span class="token punctuation">(</span>self.sample_rate * duration<span class="token punctuation">)</span>
        <span class="token builtin class-name">return</span> bytes<span class="token punctuation">(</span>samples * self.channels * <span class="token punctuation">(</span>self.bits_per_sample // <span class="token number">8</span><span class="token punctuation">))</span>

    async def _async_create_socket<span class="token punctuation">(</span>self<span class="token punctuation">)</span> -<span class="token operator">&gt;</span> None:
        <span class="token string">""</span>"创建Unix域套接字<span class="token string">""</span>"
        with suppress<span class="token punctuation">(</span>Exception<span class="token punctuation">)</span>:
            <span class="token keyword">if</span> os.path.exists<span class="token punctuation">(</span>self.socket_path<span class="token punctuation">)</span>:
                os.unlink<span class="token punctuation">(</span>self.socket_path<span class="token punctuation">)</span>
                
            self.server_socket <span class="token operator">=</span> socket.socket<span class="token punctuation">(</span>socket.AF_UNIX, socket.SOCK_STREAM<span class="token punctuation">)</span>
            self.server_socket.setblocking<span class="token punctuation">(</span>False<span class="token punctuation">)</span>
            self.server_socket.bind<span class="token punctuation">(</span>self.socket_path<span class="token punctuation">)</span>
            self.server_socket.listen<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
            
            loop <span class="token operator">=</span> asyncio.get_running_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">while</span> self.running and not self.connection_active:
                try:
                    self.client_socket, _ <span class="token operator">=</span> await loop.sock_accept<span class="token punctuation">(</span>self.server_socket<span class="token punctuation">)</span>
                    self.connection_active <span class="token operator">=</span> True
                    print<span class="token punctuation">(</span><span class="token string">"客户端已连接"</span><span class="token punctuation">)</span>
                    await loop.sock_sendall<span class="token punctuation">(</span>self.client_socket, self.wav_header<span class="token punctuation">)</span>
                except <span class="token punctuation">(</span>BlockingIOError, InterruptedError<span class="token punctuation">)</span>:
                    await asyncio.sleep<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>
                except Exception as e:
                    print<span class="token punctuation">(</span>f<span class="token string">"连接错误: {str(e)}"</span><span class="token punctuation">)</span>
                    self.connection_active <span class="token operator">=</span> False
                    await asyncio.sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

    async def _start_ffmpeg<span class="token punctuation">(</span>self<span class="token punctuation">)</span> -<span class="token operator">&gt;</span> None:
        <span class="token string">""</span>"启动FFmpeg进程<span class="token string">""</span>"
        with suppress<span class="token punctuation">(</span>Exception<span class="token punctuation">)</span>:
            <span class="token keyword">if</span> self.ffmpeg_process:
                self.ffmpeg_process.terminate<span class="token punctuation">(</span><span class="token punctuation">)</span>
                await self.ffmpeg_process.wait<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token assign-left variable">socketid</span><span class="token operator">=</span><span class="token string">'unix:'</span>+self.socket_path

            self.ffmpeg_process <span class="token operator">=</span> await asyncio.create_subprocess_exec<span class="token punctuation">(</span>
                <span class="token string">'ffmpeg'</span>,
                <span class="token string">'-f'</span>, <span class="token string">'s16le'</span>,
                <span class="token string">'-ar'</span>, str<span class="token punctuation">(</span>self.sample_rate<span class="token punctuation">)</span>,
                <span class="token string">'-ac'</span>, str<span class="token punctuation">(</span>self.channels<span class="token punctuation">)</span>,
                <span class="token string">'-i'</span>, socketid,  <span class="token comment"># 修改输入源为套接字路径</span>
                <span class="token string">'-c:a'</span>, <span class="token string">'aac'</span>,
                <span class="token string">'-f'</span>, <span class="token string">'rtsp'</span>,
                <span class="token string">'-rtsp_transport'</span>, <span class="token string">'tcp'</span>,
                <span class="token string">'rtsp://localhost:8554/mystream'</span>,
                <span class="token assign-left variable">stdout</span><span class="token operator">=</span>asyncio.subprocess.DEVNULL,
                <span class="token assign-left variable">stdin</span><span class="token operator">=</span>asyncio.subprocess.DEVNULL,
                <span class="token assign-left variable">stderr</span><span class="token operator">=</span>asyncio.subprocess.PIPE
            <span class="token punctuation">)</span>
            asyncio.create_task<span class="token punctuation">(</span>self._monitor_ffmpeg_errors<span class="token punctuation">(</span><span class="token punctuation">))</span>

    async def _monitor_ffmpeg_errors<span class="token punctuation">(</span>self<span class="token punctuation">)</span> -<span class="token operator">&gt;</span> None:
        <span class="token string">""</span>"监控FFmpeg错误输出<span class="token string">""</span>"
        <span class="token keyword">while</span> self.running and self.ffmpeg_process:
            line <span class="token operator">=</span> await self.ffmpeg_process.stderr.readline<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> not line:
                <span class="token builtin class-name">break</span>
         <span class="token comment">#   print(f"[FFmpeg Error] {line.decode().strip()}")</span>

    async def _async_write_socket<span class="token punctuation">(</span>self, data: bytes<span class="token punctuation">)</span> -<span class="token operator">&gt;</span> None:
        <span class="token string">""</span>"安全写入套接字<span class="token string">""</span>"
        try:
            <span class="token keyword">if</span> self.client_socket and self.connection_active:
                loop <span class="token operator">=</span> asyncio.get_running_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
                await loop.sock_sendall<span class="token punctuation">(</span>self.client_socket, data<span class="token punctuation">)</span>
        except <span class="token punctuation">(</span>BrokenPipeError, ConnectionResetError<span class="token punctuation">)</span>:
            print<span class="token punctuation">(</span><span class="token string">"连接已断开，尝试重连..."</span><span class="token punctuation">)</span>
            await self._reconnect_pipeline<span class="token punctuation">(</span><span class="token punctuation">)</span>
        except Exception as e:
            print<span class="token punctuation">(</span>f<span class="token string">"写入错误: {str(e)}"</span><span class="token punctuation">)</span>
            self.connection_active <span class="token operator">=</span> False

    async def _reconnect_pipeline<span class="token punctuation">(</span>self<span class="token punctuation">)</span> -<span class="token operator">&gt;</span> None:
        <span class="token string">""</span>"完整重连流程<span class="token string">""</span>"
        print<span class="token punctuation">(</span><span class="token string">"启动重连流程..."</span><span class="token punctuation">)</span>
        self.connection_active <span class="token operator">=</span> False
        <span class="token keyword">if</span> self.client_socket:
            self.client_socket.close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token assign-left variable">task1</span><span class="token operator">=</span>asyncio.create_task<span class="token punctuation">(</span>self._async_create_socket<span class="token punctuation">(</span><span class="token punctuation">))</span>,
        <span class="token assign-left variable">task2</span><span class="token operator">=</span>asyncio.create_task<span class="token punctuation">(</span> self._start_ffmpeg<span class="token punctuation">(</span><span class="token punctuation">))</span>,    
        await task2
        await task1
       <span class="token comment"># await asyncio.gather(task1, task2)</span>
        <span class="token comment">#await self._async_create_socket()</span>
        <span class="token comment">#await self._start_ffmpeg()</span>

    <span class="token comment"># 剩余的heartbeat、tts_worker、input_handler等方法保持相同...</span>

    async def stop<span class="token punctuation">(</span>self<span class="token punctuation">)</span> -<span class="token operator">&gt;</span> None:
        <span class="token string">""</span>"安全关闭<span class="token string">""</span>"
        self.running <span class="token operator">=</span> False
        with suppress<span class="token punctuation">(</span>Exception<span class="token punctuation">)</span>:
            <span class="token keyword">if</span> self.ffmpeg_process:
                self.ffmpeg_process.terminate<span class="token punctuation">(</span><span class="token punctuation">)</span>
                await self.ffmpeg_process.wait<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> self.client_socket:
                self.client_socket.close<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> self.server_socket:
                self.server_socket.close<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> os.path.exists<span class="token punctuation">(</span>self.socket_path<span class="token punctuation">)</span>:
                os.unlink<span class="token punctuation">(</span>self.socket_path<span class="token punctuation">)</span>
            print<span class="token punctuation">(</span><span class="token string">"所有资源已释放"</span><span class="token punctuation">)</span>
    async def _heartbeat<span class="token punctuation">(</span>self<span class="token punctuation">)</span> -<span class="token operator">&gt;</span> None:
        <span class="token string">""</span>"心跳维持机制<span class="token string">""</span>"
        <span class="token keyword">while</span> self.running:
            <span class="token keyword">if</span> self.connection_active <span class="token builtin class-name">:</span>
                <span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>:
                    <span class="token keyword">if</span>   self.sending_audio<span class="token operator">&lt;</span><span class="token number">0</span>:
                       await self._async_write_socket<span class="token punctuation">(</span>self.silence<span class="token punctuation">)</span>
                    <span class="token keyword">else</span> <span class="token builtin class-name">:</span>
                        self.sending_audio-<span class="token operator">=</span> <span class="token number">2</span>
                    await asyncio.sleep<span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">)</span>   
                    
           <span class="token comment">#     print(self.sending_audio,"slend")</span>
              <span class="token comment">#  await asyncio.sleep(self.heartbeat_interval)</span>
            else:
                await asyncio.sleep<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span>
    def _sync_tts<span class="token punctuation">(</span>self,text,tmp_filename<span class="token punctuation">)</span>:
        <span class="token assign-left variable">eng</span><span class="token operator">=</span>pyttsx3.init<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">#  eng.say(text)</span>
        eng.save_to_file<span class="token punctuation">(</span>text, <span class="token string">'temp3.wav'</span><span class="token punctuation">)</span>
        eng.runAndWait<span class="token punctuation">(</span><span class="token punctuation">)</span>
        eng.endLoop<span class="token punctuation">(</span><span class="token punctuation">)</span>
            
    async def _tts_worker<span class="token punctuation">(</span>self, text: str<span class="token punctuation">)</span> -<span class="token operator">&gt;</span> None:
        <span class="token string">""</span>"异步TTS处理核心<span class="token string">""</span>"
        tmp_filename <span class="token operator">=</span> None
        <span class="token comment">#with open('audio1.raw','rb') as chunkf:</span>
                <span class="token comment"># data=chunkf.read()</span>
                <span class="token comment"># secdd=len(data)/48000</span>
                <span class="token comment"># self.sending_audio=int(secdd*10) </span>
                <span class="token comment"># await self._async_write_socket(data)</span>
               
              
                <span class="token comment"># #await asyncio.sleep(secdd)</span>
                
 
                <span class="token comment"># print (secdd,len(data) )   </span>
        
            <span class="token comment"># 创建临时文件</span>
        with tempfile.NamedTemporaryFile<span class="token punctuation">(</span>delete<span class="token operator">=</span>False<span class="token punctuation">)</span> as tmp:
                tmp_filename <span class="token operator">=</span> tmp.name

            <span class="token comment"># # 同步TTS操作转异步执行</span>
        loop <span class="token operator">=</span> asyncio.get_running_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
        await loop.run_in_executor<span class="token punctuation">(</span>None, self._sync_tts, *<span class="token punctuation">(</span>text, <span class="token string">'temp3.wav'</span>,<span class="token punctuation">))</span>
            <span class="token comment"># 转换音频格式</span>
           <span class="token comment"># await asyncio.sleep(1.3)</span>
           <span class="token comment"># self._sync_tts(text,tmp_filename)</span>
        try: 
            proc <span class="token operator">=</span> await asyncio.create_subprocess_exec<span class="token punctuation">(</span>
    <span class="token string">'ffmpeg'</span>,
    <span class="token string">'-hide_banner'</span>,
    <span class="token string">'-loglevel'</span>, <span class="token string">'error'</span>,
    <span class="token string">'-y'</span>,
    <span class="token string">'-i'</span>, <span class="token string">'temp3.wav'</span>,       <span class="token comment"># 输入文件路径</span>
    <span class="token string">'-f'</span>, <span class="token string">'s16le'</span>,            <span class="token comment"># 强制输出格式为PCM s16le</span>
    <span class="token string">'-acodec'</span>, <span class="token string">'pcm_s16le'</span>,   <span class="token comment"># 明确指定音频编解码器 👈 关键修复</span>
    <span class="token string">'-ar'</span>, str<span class="token punctuation">(</span>self.sample_rate<span class="token punctuation">)</span>,
    <span class="token string">'-ac'</span>, str<span class="token punctuation">(</span>self.channels<span class="token punctuation">)</span>,
    <span class="token string">'-'</span>,                     <span class="token comment"># 输出到标准输出</span>
    <span class="token assign-left variable">stdout</span><span class="token operator">=</span>asyncio.subprocess.PIPE
<span class="token punctuation">)</span>

           <span class="token comment"># 流式发送音频数据</span>
            <span class="token assign-left variable">sum</span><span class="token operator">=</span><span class="token number">0</span>
            <span class="token keyword">while</span> chunk :<span class="token operator">=</span> await proc.stdout.read<span class="token punctuation">(</span><span class="token number">4096</span><span class="token punctuation">)</span>:
              
               <span class="token assign-left variable">sum</span><span class="token operator">+=</span>len<span class="token punctuation">(</span>chunk<span class="token punctuation">)</span>
               await self._async_write_socket<span class="token punctuation">(</span>chunk<span class="token punctuation">)</span>
            <span class="token assign-left variable">self.sending_audio</span><span class="token operator">=</span>int<span class="token punctuation">(</span>sum*10/48000<span class="token punctuation">)</span> 
            print<span class="token punctuation">(</span><span class="token string">"write data x0.1s:"</span>,self.sending_audio<span class="token punctuation">)</span>


        finally:
            <span class="token keyword">if</span> tmp_filename and os.path.exists<span class="token punctuation">(</span>tmp_filename<span class="token punctuation">)</span>:
              <span class="token number">1</span>
              <span class="token comment">#  os.unlink(tmp_filename)</span>

    async def _input_handler<span class="token punctuation">(</span>self<span class="token punctuation">)</span> -<span class="token operator">&gt;</span> None:
        <span class="token string">""</span>"异步输入处理<span class="token string">""</span>"
        <span class="token keyword">while</span> self.running:
            try:
                text <span class="token operator">=</span> await ainput<span class="token punctuation">(</span><span class="token string">"请输入文本（输入q退出）: "</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> text.lower<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'q'</span><span class="token builtin class-name">:</span>
                    self.running <span class="token operator">=</span> False
                    <span class="token builtin class-name">break</span>
                <span class="token keyword">if</span> text.strip<span class="token punctuation">(</span><span class="token punctuation">)</span>:
                  await self._tts_worker<span class="token punctuation">(</span>text<span class="token punctuation">)</span>
            except Exception as e:
                print<span class="token punctuation">(</span>f<span class="token string">"输入错误: {str(e)}"</span><span class="token punctuation">)</span>

    async def run<span class="token punctuation">(</span>self<span class="token punctuation">)</span> -<span class="token operator">&gt;</span> None:
        <span class="token string">""</span>"主运行循环<span class="token string">""</span>"
        self.running <span class="token operator">=</span> True
       <span class="token comment"># </span>
        <span class="token comment">#await  self._start_ffmpeg()</span>

        tasks <span class="token operator">=</span> <span class="token punctuation">[</span>
            asyncio.create_task<span class="token punctuation">(</span>self._async_create_socket<span class="token punctuation">(</span><span class="token punctuation">))</span>,
            asyncio.create_task<span class="token punctuation">(</span> self._start_ffmpeg<span class="token punctuation">(</span><span class="token punctuation">))</span>,
            asyncio.create_task<span class="token punctuation">(</span>self._input_handler<span class="token punctuation">(</span><span class="token punctuation">))</span>,
            asyncio.create_task<span class="token punctuation">(</span>self._heartbeat<span class="token punctuation">(</span><span class="token punctuation">))</span>,


        <span class="token punctuation">]</span>
       
        await asyncio.gather<span class="token punctuation">(</span>*tasks<span class="token punctuation">)</span>
       
    

<span class="token comment"># 以下保持不变...</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token builtin class-name">:</span>
    controller <span class="token operator">=</span> AsyncTTSController<span class="token punctuation">(</span><span class="token punctuation">)</span>
    try:
        asyncio.run<span class="token punctuation">(</span>controller.run<span class="token punctuation">(</span><span class="token punctuation">))</span>
    except KeyboardInterrupt:
        asyncio.run<span class="token punctuation">(</span>controller.stop<span class="token punctuation">(</span><span class="token punctuation">))</span>
<span class="token string">""</span>"
ffmpeg <span class="token parameter variable">-y</span> <span class="token parameter variable">-i</span> temp.wav <span class="token parameter variable">-f</span> s16le <span class="token parameter variable">-acodec</span> pcm_s16le  <span class="token parameter variable">-ar</span> <span class="token number">24000</span>  <span class="token parameter variable">-ac</span> <span class="token number">1</span>   audio.raw
ffmpeg  <span class="token parameter variable">-ar</span> <span class="token number">24000</span> <span class="token parameter variable">-ac</span> <span class="token number">1</span> <span class="token parameter variable">-f</span> s16le  <span class="token parameter variable">-i</span> unix:/tmp/tts_audio.sock <span class="token parameter variable">-f</span> rtsp  rtsp://localhost:8554/mystream
<span class="token string">""</span>"
</code></pre>
    <ol start="2">
     <li>
      window10系统python10 可运行版本
      <br/>
      主要让deepseek,执行了,socket 到 win32pipen的替换.因为本来就是换过去的.这一块的代码完全没有手工介入. 唯一改的是注释eng.endLoop(),并不用每次init() ,应改是pyttsx3的一个跨平台特性. ,异步的win32下支持稳定.
     </li>
    </ol>
    <pre><code class="prism language-bash">    def _sync_tts<span class="token punctuation">(</span>self, text, tmp_filename<span class="token punctuation">)</span>:
         eng <span class="token operator">=</span> self.engine  <span class="token comment">#pyttsx3.init()</span>
        eng.save_to_file<span class="token punctuation">(</span>text, <span class="token string">'temp3.wav'</span><span class="token punctuation">)</span>
        eng.runAndWait<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">#  eng.endLoop()</span>
</code></pre>
    <p>
     main-win.py
    </p>
    <pre><code class="prism language-bash"><span class="token function">import</span> asyncio
<span class="token function">import</span> struct
<span class="token function">import</span> pyttsx3
<span class="token function">import</span> tempfile
<span class="token function">import</span> os
from aioconsole <span class="token function">import</span> ainput
from contextlib <span class="token function">import</span> suppress
from typing <span class="token function">import</span> Optional
<span class="token function">import</span> win32pipe
<span class="token function">import</span> win32file
<span class="token function">import</span> pywintypes

class AsyncTTSController:
    def __init__<span class="token punctuation">(</span>self<span class="token punctuation">)</span>:
        <span class="token comment"># 使用Windows命名管道</span>
        self.pipe_name <span class="token operator">=</span> r<span class="token string">'\\.\pipe\tts_audio_pipe'</span>
        self.pipe_handle <span class="token operator">=</span> None
        
        <span class="token comment"># 进程控制</span>
        self.ffmpeg_process: Optional<span class="token punctuation">[</span>asyncio.subprocess.Process<span class="token punctuation">]</span> <span class="token operator">=</span> None
        self.running <span class="token operator">=</span> False
        
        <span class="token comment"># TTS引擎</span>
        self.engine <span class="token operator">=</span> pyttsx3.init<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self.engine.setProperty<span class="token punctuation">(</span><span class="token string">'rate'</span>, <span class="token number">180</span><span class="token punctuation">)</span>
        self.engine.setProperty<span class="token punctuation">(</span><span class="token string">'volume'</span>, <span class="token number">1.0</span><span class="token punctuation">)</span>
        
        <span class="token comment"># 音频参数</span>
        self.sample_rate <span class="token operator">=</span> <span class="token number">24000</span>
        self.channels <span class="token operator">=</span> <span class="token number">1</span>
        self.bits_per_sample <span class="token operator">=</span> <span class="token number">16</span>
        self.silence <span class="token operator">=</span> self._generate_silence<span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">)</span>
        self.wav_header <span class="token operator">=</span> self._generate_wav_header<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        <span class="token comment"># 状态管理</span>
        self.connection_active <span class="token operator">=</span> False
        self.last_heartbeat <span class="token operator">=</span> <span class="token number">0.0</span>
        self.heartbeat_interval <span class="token operator">=</span> <span class="token number">2.0</span>
        self.sending_audio <span class="token operator">=</span> <span class="token number">0</span>

    def _generate_wav_header<span class="token punctuation">(</span>self<span class="token punctuation">)</span> -<span class="token operator">&gt;</span> bytes:
        <span class="token string">""</span>"生成WAV文件头<span class="token string">""</span>"
        byte_rate <span class="token operator">=</span> self.sample_rate * self.channels * self.bits_per_sample // <span class="token number">8</span>
        block_align <span class="token operator">=</span> self.channels * self.bits_per_sample // <span class="token number">8</span>
        <span class="token builtin class-name">return</span> struct.pack<span class="token punctuation">(</span>
            <span class="token string">'&lt;4sI4s4sIHHIIHH4sI'</span>,
            b<span class="token string">'RIFF'</span>, <span class="token number">36</span>, b<span class="token string">'WAVE'</span>, b<span class="token string">'fmt '</span>, <span class="token number">16</span>, <span class="token number">1</span>, self.channels,
            self.sample_rate, byte_rate, block_align, self.bits_per_sample,
            b<span class="token string">'data'</span>, <span class="token number">0</span>
        <span class="token punctuation">)</span>

    def _generate_silence<span class="token punctuation">(</span>self, duration: float<span class="token punctuation">)</span> -<span class="token operator">&gt;</span> bytes:
        <span class="token string">""</span>"生成静音数据<span class="token string">""</span>"
        samples <span class="token operator">=</span> int<span class="token punctuation">(</span>self.sample_rate * duration<span class="token punctuation">)</span>
        <span class="token builtin class-name">return</span> bytes<span class="token punctuation">(</span>samples * self.channels * <span class="token punctuation">(</span>self.bits_per_sample // <span class="token number">8</span><span class="token punctuation">))</span>

    async def _async_create_pipe<span class="token punctuation">(</span>self<span class="token punctuation">)</span> -<span class="token operator">&gt;</span> None:
        <span class="token string">""</span>"创建命名管道<span class="token string">""</span>"
        <span class="token keyword">while</span> self.running and not self.connection_active:
            try:
                <span class="token comment"># 创建命名管道</span>
                self.pipe_handle <span class="token operator">=</span> win32pipe.CreateNamedPipe<span class="token punctuation">(</span>
                    self.pipe_name,
                    win32pipe.PIPE_ACCESS_DUPLEX,
                    win32pipe.PIPE_TYPE_BYTE <span class="token operator">|</span> win32pipe.PIPE_READMODE_BYTE <span class="token operator">|</span> win32pipe.PIPE_WAIT,
                    <span class="token number">1</span>,  <span class="token comment"># 最大实例数</span>
                    <span class="token number">65536</span>, <span class="token number">65536</span>,  <span class="token comment"># 输入输出缓冲区大小</span>
                    <span class="token number">0</span>,  <span class="token comment"># 默认超时</span>
                    None  <span class="token comment"># 安全属性</span>
                <span class="token punctuation">)</span>
                
                <span class="token comment"># 异步等待连接</span>
                loop <span class="token operator">=</span> asyncio.get_running_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
                await loop.run_in_executor<span class="token punctuation">(</span>None, win32pipe.ConnectNamedPipe, self.pipe_handle, None<span class="token punctuation">)</span>
                self.connection_active <span class="token operator">=</span> True
                print<span class="token punctuation">(</span><span class="token string">"客户端已连接"</span><span class="token punctuation">)</span>
                await self._async_write_socket<span class="token punctuation">(</span>self.wav_header<span class="token punctuation">)</span>
            except pywintypes.error as e:
                <span class="token keyword">if</span> e.winerror <span class="token operator">==</span> <span class="token number">536</span>:  <span class="token comment"># ERROR_PIPE_CONNECTED</span>
                    self.connection_active <span class="token operator">=</span> True
                    print<span class="token punctuation">(</span><span class="token string">"客户端已连接"</span><span class="token punctuation">)</span>
                <span class="token keyword">elif</span> e.winerror <span class="token operator">==</span> <span class="token number">232</span>:  <span class="token comment"># 客户端断开</span>
                    print<span class="token punctuation">(</span><span class="token string">"客户端断开连接"</span><span class="token punctuation">)</span>
                    self.connection_active <span class="token operator">=</span> False
                    <span class="token keyword">if</span> self.pipe_handle:
                        win32file.CloseHandle<span class="token punctuation">(</span>self.pipe_handle<span class="token punctuation">)</span>
                        self.pipe_handle <span class="token operator">=</span> None
                    await asyncio.sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
                else:
                    print<span class="token punctuation">(</span>f<span class="token string">"管道错误: {e}"</span><span class="token punctuation">)</span>
                    await asyncio.sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
            except Exception as e:
                print<span class="token punctuation">(</span>f<span class="token string">"其他错误: {e}"</span><span class="token punctuation">)</span>
                await asyncio.sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

    async def _start_ffmpeg<span class="token punctuation">(</span>self<span class="token punctuation">)</span> -<span class="token operator">&gt;</span> None:
        <span class="token string">""</span>"启动FFmpeg进程<span class="token string">""</span>"
        with suppress<span class="token punctuation">(</span>Exception<span class="token punctuation">)</span>:
            <span class="token keyword">if</span> self.ffmpeg_process:
                self.ffmpeg_process.terminate<span class="token punctuation">(</span><span class="token punctuation">)</span>
                await self.ffmpeg_process.wait<span class="token punctuation">(</span><span class="token punctuation">)</span>

            self.ffmpeg_process <span class="token operator">=</span> await asyncio.create_subprocess_exec<span class="token punctuation">(</span>
                <span class="token string">'ffmpeg'</span>,
                <span class="token string">'-f'</span>, <span class="token string">'s16le'</span>,
                <span class="token string">'-ar'</span>, str<span class="token punctuation">(</span>self.sample_rate<span class="token punctuation">)</span>,
                <span class="token string">'-ac'</span>, str<span class="token punctuation">(</span>self.channels<span class="token punctuation">)</span>,
                <span class="token string">'-i'</span>, self.pipe_name,
                <span class="token string">'-c:a'</span>, <span class="token string">'aac'</span>,
                <span class="token string">'-f'</span>, <span class="token string">'rtsp'</span>,
                <span class="token string">'-rtsp_transport'</span>, <span class="token string">'tcp'</span>,
                <span class="token string">'rtsp://localhost:8554/mystream'</span>,
                <span class="token assign-left variable">stdout</span><span class="token operator">=</span>asyncio.subprocess.DEVNULL,
                <span class="token assign-left variable">stdin</span><span class="token operator">=</span>asyncio.subprocess.DEVNULL,
                <span class="token assign-left variable">stderr</span><span class="token operator">=</span>asyncio.subprocess.PIPE
            <span class="token punctuation">)</span>
            asyncio.create_task<span class="token punctuation">(</span>self._monitor_ffmpeg_errors<span class="token punctuation">(</span><span class="token punctuation">))</span>

    async def _monitor_ffmpeg_errors<span class="token punctuation">(</span>self<span class="token punctuation">)</span> -<span class="token operator">&gt;</span> None:
        <span class="token string">""</span>"监控FFmpeg错误输出<span class="token string">""</span>"
        <span class="token keyword">while</span> self.running and self.ffmpeg_process:
            line <span class="token operator">=</span> await self.ffmpeg_process.stderr.readline<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> not line:
                <span class="token builtin class-name">break</span>
            <span class="token comment"># print(f"[FFmpeg Error] {line.decode().strip()}")</span>

    async def _async_write_socket<span class="token punctuation">(</span>self, data: bytes<span class="token punctuation">)</span> -<span class="token operator">&gt;</span> None:
        <span class="token string">""</span>"安全写入管道<span class="token string">""</span>"
        try:
            <span class="token keyword">if</span> self.connection_active and self.pipe_handle:
                loop <span class="token operator">=</span> asyncio.get_running_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
                await loop.run_in_executor<span class="token punctuation">(</span>None, win32file.WriteFile, self.pipe_handle, data<span class="token punctuation">)</span>
        except pywintypes.error as e:
            print<span class="token punctuation">(</span>f<span class="token string">"写入错误: {e}"</span><span class="token punctuation">)</span>
            self.connection_active <span class="token operator">=</span> False
            await self._reconnect_pipeline<span class="token punctuation">(</span><span class="token punctuation">)</span>
        except Exception as e:
            print<span class="token punctuation">(</span>f<span class="token string">"其他写入错误: {e}"</span><span class="token punctuation">)</span>
            self.connection_active <span class="token operator">=</span> False

    async def _reconnect_pipeline<span class="token punctuation">(</span>self<span class="token punctuation">)</span> -<span class="token operator">&gt;</span> None:
        <span class="token string">""</span>"完整重连流程<span class="token string">""</span>"
        print<span class="token punctuation">(</span><span class="token string">"启动重连流程..."</span><span class="token punctuation">)</span>
        self.connection_active <span class="token operator">=</span> False
        <span class="token keyword">if</span> self.pipe_handle:
            win32file.CloseHandle<span class="token punctuation">(</span>self.pipe_handle<span class="token punctuation">)</span>
            self.pipe_handle <span class="token operator">=</span> None
        await asyncio.gather<span class="token punctuation">(</span>
            self._async_create_pipe<span class="token punctuation">(</span><span class="token punctuation">)</span>,
            self._start_ffmpeg<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>

    async def _heartbeat<span class="token punctuation">(</span>self<span class="token punctuation">)</span> -<span class="token operator">&gt;</span> None:
        <span class="token string">""</span>"心跳维持机制<span class="token string">""</span>"
        <span class="token keyword">while</span> self.running:
            <span class="token keyword">if</span> self.connection_active:
                <span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>:
                    <span class="token keyword">if</span> self.sending_audio <span class="token operator">&lt;</span> <span class="token number">0</span>:
                        await self._async_write_socket<span class="token punctuation">(</span>self.silence<span class="token punctuation">)</span>
                    else:
                        self.sending_audio -<span class="token operator">=</span> <span class="token number">2</span>
                    await asyncio.sleep<span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">)</span>
            else:
                await asyncio.sleep<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span>

    def _sync_tts<span class="token punctuation">(</span>self, text, tmp_filename<span class="token punctuation">)</span>:
        eng <span class="token operator">=</span> pyttsx3.init<span class="token punctuation">(</span><span class="token punctuation">)</span>
        eng.save_to_file<span class="token punctuation">(</span>text, <span class="token string">'temp3.wav'</span><span class="token punctuation">)</span>
        eng.runAndWait<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">#  eng.endLoop()</span>

    async def _tts_worker<span class="token punctuation">(</span>self, text: str<span class="token punctuation">)</span> -<span class="token operator">&gt;</span> None:
        <span class="token string">""</span>"异步TTS处理核心<span class="token string">""</span>"
        await asyncio.get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>.run_in_executor<span class="token punctuation">(</span>None, self._sync_tts, text, <span class="token string">'temp3.wav'</span><span class="token punctuation">)</span>

        try:
            proc <span class="token operator">=</span> await asyncio.create_subprocess_exec<span class="token punctuation">(</span>
                <span class="token string">'ffmpeg'</span>,
                <span class="token string">'-hide_banner'</span>,
                <span class="token string">'-loglevel'</span>, <span class="token string">'error'</span>,
                <span class="token string">'-y'</span>,
                <span class="token string">'-i'</span>, <span class="token string">'temp3.wav'</span>,
                <span class="token string">'-f'</span>, <span class="token string">'s16le'</span>,
                <span class="token string">'-acodec'</span>, <span class="token string">'pcm_s16le'</span>,
                <span class="token string">'-ar'</span>, str<span class="token punctuation">(</span>self.sample_rate<span class="token punctuation">)</span>,
                <span class="token string">'-ac'</span>, str<span class="token punctuation">(</span>self.channels<span class="token punctuation">)</span>,
                <span class="token string">'-'</span>,
                <span class="token assign-left variable">stdout</span><span class="token operator">=</span>asyncio.subprocess.PIPE
            <span class="token punctuation">)</span>

            sum_bytes <span class="token operator">=</span> <span class="token number">0</span>
            <span class="token keyword">while</span> chunk :<span class="token operator">=</span> await proc.stdout.read<span class="token punctuation">(</span><span class="token number">4096</span><span class="token punctuation">)</span>:
                sum_bytes <span class="token operator">+=</span> len<span class="token punctuation">(</span>chunk<span class="token punctuation">)</span>
                await self._async_write_socket<span class="token punctuation">(</span>chunk<span class="token punctuation">)</span>
            self.sending_audio <span class="token operator">=</span> int<span class="token punctuation">(</span>sum_bytes * <span class="token number">10</span> / <span class="token number">48000</span><span class="token punctuation">)</span>
            print<span class="token punctuation">(</span>f<span class="token string">"写入数据 x0.1s: {self.sending_audio}"</span><span class="token punctuation">)</span>

        finally:
            <span class="token keyword">if</span> os.path.exists<span class="token punctuation">(</span><span class="token string">'temp3.wav'</span><span class="token punctuation">)</span>:
                os.remove<span class="token punctuation">(</span><span class="token string">'temp3.wav'</span><span class="token punctuation">)</span>

    async def _input_handler<span class="token punctuation">(</span>self<span class="token punctuation">)</span> -<span class="token operator">&gt;</span> None:
        <span class="token string">""</span>"异步输入处理<span class="token string">""</span>"
        <span class="token keyword">while</span> self.running:
            try:
                text <span class="token operator">=</span> await ainput<span class="token punctuation">(</span><span class="token string">"请输入文本（输入q退出）: "</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> text.lower<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'q'</span><span class="token builtin class-name">:</span>
                    self.running <span class="token operator">=</span> False
                    <span class="token builtin class-name">break</span>
                <span class="token keyword">if</span> text.strip<span class="token punctuation">(</span><span class="token punctuation">)</span>:
                    await self._tts_worker<span class="token punctuation">(</span>text<span class="token punctuation">)</span>
            except Exception as e:
                print<span class="token punctuation">(</span>f<span class="token string">"输入错误: {str(e)}"</span><span class="token punctuation">)</span>

    async def run<span class="token punctuation">(</span>self<span class="token punctuation">)</span> -<span class="token operator">&gt;</span> None:
        <span class="token string">""</span>"主运行循环<span class="token string">""</span>"
        self.running <span class="token operator">=</span> True
        tasks <span class="token operator">=</span> <span class="token punctuation">[</span>
            asyncio.create_task<span class="token punctuation">(</span>self._async_create_pipe<span class="token punctuation">(</span><span class="token punctuation">))</span>,
            asyncio.create_task<span class="token punctuation">(</span>self._start_ffmpeg<span class="token punctuation">(</span><span class="token punctuation">))</span>,
            asyncio.create_task<span class="token punctuation">(</span>self._input_handler<span class="token punctuation">(</span><span class="token punctuation">))</span>,
            asyncio.create_task<span class="token punctuation">(</span>self._heartbeat<span class="token punctuation">(</span><span class="token punctuation">))</span>,
        <span class="token punctuation">]</span>
        await asyncio.gather<span class="token punctuation">(</span>*tasks<span class="token punctuation">)</span>

    async def stop<span class="token punctuation">(</span>self<span class="token punctuation">)</span> -<span class="token operator">&gt;</span> None:
        <span class="token string">""</span>"安全关闭<span class="token string">""</span>"
        self.running <span class="token operator">=</span> False
        with suppress<span class="token punctuation">(</span>Exception<span class="token punctuation">)</span>:
            <span class="token keyword">if</span> self.ffmpeg_process:
                self.ffmpeg_process.terminate<span class="token punctuation">(</span><span class="token punctuation">)</span>
                await self.ffmpeg_process.wait<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> self.pipe_handle:
                win32pipe.DisconnectNamedPipe<span class="token punctuation">(</span>self.pipe_handle<span class="token punctuation">)</span>
                win32file.CloseHandle<span class="token punctuation">(</span>self.pipe_handle<span class="token punctuation">)</span>
            print<span class="token punctuation">(</span><span class="token string">"所有资源已释放"</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token builtin class-name">:</span>
    controller <span class="token operator">=</span> AsyncTTSController<span class="token punctuation">(</span><span class="token punctuation">)</span>
    try:
        asyncio.run<span class="token punctuation">(</span>controller.run<span class="token punctuation">(</span><span class="token punctuation">))</span>
    except KeyboardInterrupt:
        asyncio.run<span class="token punctuation">(</span>controller.stop<span class="token punctuation">(</span><span class="token punctuation">))</span>

</code></pre>
    <h3>
     <a id="ffmpeg_570">
     </a>
     独立的ffmpeg启动和监控的独立代码
    </h3>
    <p>
     验证了一下rtsp断线重建连结，也验证了 上面 的main.py的socket server退出后，ffmpeg自动重启连接。 要使用这个更稳健球的程序，需要
    </p>
    <blockquote>
     <p>
      注释main.py run中的asyncio.create_task( self._start_ffmpeg()),
     </p>
    </blockquote>
    <p>
     代码不用修改,把管道名这个快, 彻底修改为,ffmpeg认识的window样式,就可运行.
    </p>
    <blockquote>
     <p>
      r’\.\pipe\tts_audio_pipe’
     </p>
    </blockquote>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/b9afd098601a49a0ac40d4169e35355c.png">
      <br/>
      ffmg,py
     </img>
    </p>
    <pre><code class="prism language-bash"><span class="token function">import</span> asyncio
from contextlib <span class="token function">import</span> suppress
<span class="token function">import</span> logging
logging.basicConfig<span class="token punctuation">(</span>level<span class="token operator">=</span>logging.INFO, <span class="token assign-left variable">format</span><span class="token operator">=</span><span class="token string">'%(asctime)s - %(levelname)s - %(message)s'</span><span class="token punctuation">)</span>

class FFmpegManager:
    def __init__<span class="token punctuation">(</span>self<span class="token punctuation">)</span>:
        self.ffmpeg_process <span class="token operator">=</span> None
        self._retry_count <span class="token operator">=</span> <span class="token number">0</span>
        self._max_retries <span class="token operator">=</span> <span class="token number">5</span>
        self._retry_lock <span class="token operator">=</span> asyncio.Lock<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self._is_running <span class="token operator">=</span> False
        <span class="token assign-left variable">self.sample_rate</span><span class="token operator">=</span><span class="token number">24000</span>
        <span class="token assign-left variable">self.channels</span><span class="token operator">=</span><span class="token number">1</span>
        self.socket_path <span class="token operator">=</span> <span class="token string">"/tmp/tts_audio.sock"</span>

    async def _start_ffmpeg<span class="token punctuation">(</span>self<span class="token punctuation">)</span> -<span class="token operator">&gt;</span> None:
        <span class="token string">""</span>"带自动重试的FFmpeg启动函数<span class="token string">""</span>"
        async with self._retry_lock:
            await self._safe_terminate<span class="token punctuation">(</span><span class="token punctuation">)</span>
            
            try:
                socketid <span class="token operator">=</span> <span class="token string">'unix:'</span> + self.socket_path
                self.ffmpeg_process <span class="token operator">=</span>await asyncio.create_subprocess_exec<span class="token punctuation">(</span>
                <span class="token string">'ffmpeg'</span>,
                <span class="token string">'-f'</span>, <span class="token string">'s16le'</span>,
                <span class="token string">'-ar'</span>, str<span class="token punctuation">(</span>self.sample_rate<span class="token punctuation">)</span>,
                <span class="token string">'-ac'</span>, str<span class="token punctuation">(</span>self.channels<span class="token punctuation">)</span>,
                <span class="token string">'-i'</span>, socketid,  <span class="token comment"># 修改输入源为套接字路径</span>
                <span class="token string">'-c:a'</span>, <span class="token string">'aac'</span>,
                <span class="token string">'-f'</span>, <span class="token string">'rtsp'</span>,
                <span class="token string">'-rtsp_transport'</span>, <span class="token string">'tcp'</span>,
                <span class="token string">'rtsp://localhost:8554/mystream'</span>,
                <span class="token assign-left variable">stdout</span><span class="token operator">=</span>asyncio.subprocess.DEVNULL,
                <span class="token assign-left variable">stdin</span><span class="token operator">=</span>asyncio.subprocess.DEVNULL,
                <span class="token assign-left variable">stderr</span><span class="token operator">=</span>asyncio.subprocess.PIPE
            <span class="token punctuation">)</span>
                self._retry_count <span class="token operator">=</span> <span class="token number">0</span>  <span class="token comment"># 重置重试计数器</span>
                asyncio.create_task<span class="token punctuation">(</span>self._monitor_ffmpeg_errors<span class="token punctuation">(</span><span class="token punctuation">))</span>
                self._is_running <span class="token operator">=</span> True
            except Exception as e:
                logging.error<span class="token punctuation">(</span>f<span class="token string">"FFmpeg启动失败: {str(e)}"</span><span class="token punctuation">)</span>
                await self._handle_retry<span class="token punctuation">(</span><span class="token punctuation">)</span>

    async def _monitor_ffmpeg_errors<span class="token punctuation">(</span>self<span class="token punctuation">)</span>:
        <span class="token string">""</span>"增强型进程监控<span class="token string">""</span>"
        <span class="token keyword">while</span> self._is_running:
            logging.info<span class="token punctuation">(</span><span class="token string">"loop  error cathch"</span><span class="token punctuation">)</span>
            stderr <span class="token operator">=</span> await self.ffmpeg_process.stderr.readline<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> stderr:
                logging.error<span class="token punctuation">(</span>f<span class="token string">"FFmpeg错误输出: {stderr.decode().strip()}"</span><span class="token punctuation">)</span>
            
            <span class="token comment"># 检测进程状态</span>
            return_code <span class="token operator">=</span> self.ffmpeg_process.returncode
            <span class="token keyword">if</span> return_code is not None:
                logging.warning<span class="token punctuation">(</span>f<span class="token string">"FFmpeg异常退出，返回码: {return_code}"</span><span class="token punctuation">)</span>
                self._is_running <span class="token operator">=</span> False
                await self._handle_retry<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token builtin class-name">break</span>

    async def _handle_retry<span class="token punctuation">(</span>self<span class="token punctuation">)</span>:
        <span class="token string">""</span>"智能重试策略<span class="token string">""</span>"
        <span class="token keyword">if</span> self._retry_count <span class="token operator">&gt;=</span> self._max_retries:
            logging.critical<span class="token punctuation">(</span><span class="token string">"达到最大重试次数，放弃重启"</span><span class="token punctuation">)</span>
            <span class="token builtin class-name">return</span>

        <span class="token comment"># 指数退避算法</span>
        delay <span class="token operator">=</span> min<span class="token punctuation">(</span><span class="token number">2</span> ** self._retry_count, <span class="token number">30</span><span class="token punctuation">)</span>  <span class="token comment"># 最大间隔30秒</span>
        self._retry_count <span class="token operator">+=</span> <span class="token number">1</span>
        logging.info<span class="token punctuation">(</span>f<span class="token string">"将在 {delay} 秒后尝试第 {self._retry_count} 次重启"</span><span class="token punctuation">)</span>

        await asyncio.sleep<span class="token punctuation">(</span>delay<span class="token punctuation">)</span>
        await self._start_ffmpeg<span class="token punctuation">(</span><span class="token punctuation">)</span>

    async def _safe_terminate<span class="token punctuation">(</span>self<span class="token punctuation">)</span>:
        <span class="token string">""</span>"安全终止现有进程<span class="token string">""</span>"
        <span class="token keyword">if</span> self.ffmpeg_process:
            with suppress<span class="token punctuation">(</span>Exception<span class="token punctuation">)</span>:
                self.ffmpeg_process.terminate<span class="token punctuation">(</span><span class="token punctuation">)</span>
                await self.ffmpeg_process.wait<span class="token punctuation">(</span><span class="token punctuation">)</span>
                self.ffmpeg_process <span class="token operator">=</span> None
<span class="token comment"># 以下保持不变...</span>
async def main<span class="token punctuation">(</span><span class="token punctuation">)</span>:
    <span class="token assign-left variable">controller</span><span class="token operator">=</span>FFmpegManager<span class="token punctuation">(</span><span class="token punctuation">)</span>
    try:
        await controller._start_ffmpeg<span class="token punctuation">(</span><span class="token punctuation">)</span>
        logging.info<span class="token punctuation">(</span><span class="token string">'rung'</span><span class="token punctuation">)</span>
        await asyncio.sleep<span class="token punctuation">(</span><span class="token number">1160</span><span class="token punctuation">)</span>
    except KeyboardInterrupt:
        logging.info<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
        asyncio.run<span class="token punctuation">(</span>controller._safe_terminate<span class="token punctuation">(</span><span class="token punctuation">))</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token builtin class-name">:</span>
     
     asyncio.run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">))</span>
</code></pre>
   </div>
   <link href="./../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="./../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="6874747073:3a2f2f626c6f672e6373646e2e6e65742f776a63726f6f6d2f:61727469636c652f64657461696c732f313436313634363634" class_="artid" style="display:none">
 </p>
</div>


