---
layout: post
title: "rpc和proto"
date: 2025-03-09 20:27:49 +0800
description: "首先，rpc是一种比http和restapi更轻量的协议，应该都知道http要有http头，header，rpc采用更紧凑的编码方式，具体我也不懂，反正它的协议叫做gRPC。然后，为了让rpc流行起来，需要一个在各种语言中都能被使用的方法，protobuf作为一种中间语言，在编写后可以被编译成各种语言的版本，然后供各语言的代码调用，这个编译器叫protoc，c是complier。nest message：它只是一种嵌套形式，在message里定义一个message，毕竟message也是一个变量类型。"
keywords: "rpc和proto"
categories: ['未分类']
tags: ['网络协议', 'Ui', 'Rpc']
artid: "146137132"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146137132
    alt: "rpc和proto"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146137132
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146137132
cover: https://bing.ee123.net/img/rand?artid=146137132
image: https://bing.ee123.net/img/rand?artid=146137132
img: https://bing.ee123.net/img/rand?artid=146137132
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     rpc和proto
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     rpc全称远程过程控制，说白了是一种对信息发送和接收的规则编写方法，来自google，这些规则会以protobuf代码存到proto文件里。我以autoGen中agent_worker.proto为例，大概长这样
    </p>
    <pre><code class="prism language-bash">syntax <span class="token operator">=</span> <span class="token string">"proto3"</span><span class="token punctuation">;</span>

package agents<span class="token punctuation">;</span>

option csharp_namespace <span class="token operator">=</span> <span class="token string">"Microsoft.AutoGen.Protobuf"</span><span class="token punctuation">;</span>

<span class="token function">import</span> <span class="token string">"cloudevent.proto"</span><span class="token punctuation">;</span>
<span class="token function">import</span> <span class="token string">"google/protobuf/any.proto"</span><span class="token punctuation">;</span>


message AgentId <span class="token punctuation">{<!-- --></span>
    string <span class="token builtin class-name">type</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    string key <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

message Payload <span class="token punctuation">{<!-- --></span>
    string data_type <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    string data_content_type <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    bytes data <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

message RpcRequest <span class="token punctuation">{<!-- --></span>
    string request_id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    optional AgentId <span class="token builtin class-name">source</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    AgentId target <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    string method <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
    Payload payload <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
    map<span class="token operator">&lt;</span>string, string<span class="token operator">&gt;</span> metadata <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

message RpcResponse <span class="token punctuation">{<!-- --></span>
    string request_id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    Payload payload <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    string error <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    map<span class="token operator">&lt;</span>string, string<span class="token operator">&gt;</span> metadata <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

message RegisterAgentTypeRequest <span class="token punctuation">{<!-- --></span>
    string <span class="token builtin class-name">type</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

message RegisterAgentTypeResponse <span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span>

message TypeSubscription <span class="token punctuation">{<!-- --></span>
    string topic_type <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    string agent_type <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

message TypePrefixSubscription <span class="token punctuation">{<!-- --></span>
    string topic_type_prefix <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    string agent_type <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

message Subscription <span class="token punctuation">{<!-- --></span>
    string <span class="token function">id</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    oneof subscription <span class="token punctuation">{<!-- --></span>
        TypeSubscription typeSubscription <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
        TypePrefixSubscription typePrefixSubscription <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

message AddSubscriptionRequest <span class="token punctuation">{<!-- --></span>
    Subscription subscription <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

message AddSubscriptionResponse <span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span>

message RemoveSubscriptionRequest <span class="token punctuation">{<!-- --></span>
    string <span class="token function">id</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

message RemoveSubscriptionResponse <span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span>

message GetSubscriptionsRequest <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
message GetSubscriptionsResponse <span class="token punctuation">{<!-- --></span>
    repeated Subscription subscriptions <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

message Message <span class="token punctuation">{<!-- --></span>
    oneof message <span class="token punctuation">{<!-- --></span>
        RpcRequest request <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        RpcResponse response <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
        io.cloudevents.v1.CloudEvent cloudEvent <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

message SaveStateRequest <span class="token punctuation">{<!-- --></span>
    AgentId agentId <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

message SaveStateResponse <span class="token punctuation">{<!-- --></span>
    string state <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    optional string error <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

message LoadStateRequest <span class="token punctuation">{<!-- --></span>
    AgentId agentId <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    string state <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
message LoadStateResponse <span class="token punctuation">{<!-- --></span>
    optional string error <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

message ControlMessage <span class="token punctuation">{<!-- --></span>
    // A response message should have the same <span class="token function">id</span> as the request message
    string rpc_id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    // This is either:
    // <span class="token assign-left variable">agentid</span><span class="token operator">=</span>AGENT_ID
    // <span class="token assign-left variable">clientid</span><span class="token operator">=</span>CLIENT_ID
    string destination <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    // This is either:
    // <span class="token assign-left variable">agentid</span><span class="token operator">=</span>AGENT_ID
    // <span class="token assign-left variable">clientid</span><span class="token operator">=</span>CLIENT_ID
    // Empty string means the message is a response
    optional string respond_to <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    // One of:
    //     SaveStateRequest saveStateRequest <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    //     SaveStateResponse saveStateResponse <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    //     LoadStateRequest loadStateRequest <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
    //     LoadStateResponse loadStateResponse <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
    google.protobuf.Any rpcMessage <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">service</span> AgentRpc <span class="token punctuation">{<!-- --></span>
    rpc OpenChannel <span class="token punctuation">(</span>stream Message<span class="token punctuation">)</span> returns <span class="token punctuation">(</span>stream Message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    rpc OpenControlChannel <span class="token punctuation">(</span>stream ControlMessage<span class="token punctuation">)</span> returns <span class="token punctuation">(</span>stream ControlMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
    rpc RegisterAgent<span class="token punctuation">(</span>RegisterAgentTypeRequest<span class="token punctuation">)</span> returns <span class="token punctuation">(</span>RegisterAgentTypeResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
    rpc AddSubscription<span class="token punctuation">(</span>AddSubscriptionRequest<span class="token punctuation">)</span> returns <span class="token punctuation">(</span>AddSubscriptionResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
    rpc RemoveSubscription<span class="token punctuation">(</span>RemoveSubscriptionRequest<span class="token punctuation">)</span> returns <span class="token punctuation">(</span>RemoveSubscriptionResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
    rpc GetSubscriptions<span class="token punctuation">(</span>GetSubscriptionsRequest<span class="token punctuation">)</span> returns <span class="token punctuation">(</span>GetSubscriptionsResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     为什么要用protobuf定义rpc呢？首先，rpc是一种比http和restapi更轻量的协议，应该都知道http要有http头，header，rpc采用更紧凑的编码方式，具体我也不懂，反正它的协议叫做gRPC。然后，为了让rpc流行起来，需要一个在各种语言中都能被使用的方法，protobuf作为一种中间语言，在编写后可以被编译成各种语言的版本，然后供各语言的代码调用，这个编译器叫protoc，c是complier。
    </p>
    <p>
     你可以简单地把proto代码看作是对数据结构的定义，就像python的dataclass一样。有几个字段需要解释：
     <br/>
     oneof：它里面会包含多个变量名，在你实例化对应数据类时，只能出现其中一个变量，其他的不可用。
     <br/>
     map：看作dict。
     <br/>
     repeat：看作list。
     <br/>
     packed：是跟在某些数据类型的变量后面的定义，用于注明这些值是否需要精简地序列化，proto3里默认开启。
     <br/>
     enum Status：定义一个枚举数据类型Status。像python一样，Status会定义一个名字并附上具体的值，之后可以用Status定义其他变量的类型。
     <br/>
     message：定义发送的信息的数据结构。
     <br/>
     数据类型：在变量名前面注明，可以是某个定义完的数据结构，和python一样。
     <br/>
     变量 = 数字：数字是编号，用于数据在序列化和反序列化时作标记和识别。因此，它可以不是顺序的，可以随便定义（但是最好别这样做）。
     <br/>
     service：与message平级，用于定义一个服务所提供的所有rpc服务。
     <br/>
     rpc：注明这是一个rpc服务，将注明发送和接收的message样式。
     <br/>
     stream：注明这是一个流式传输。如果不是流式传输，rpc服务只会做到“客户端发送message，服务端返回对应的message”，就像一个request一样。
     <br/>
     nest message：它只是一种嵌套形式，在message里定义一个message，毕竟message也是一个变量类型。
     <br/>
     reserved：可以用来预留编号和变量名。
     <br/>
     DynamicMessage：它用来支持动态解析，在不知道来犯的message类型时，对方可能同时传过来一个proto文件的descriptor文件，用它来动态解析message。
    </p>
    <p>
     protobuf已经到protobuf3了，之前所有参数都可以注明可选or必选，现在都是可选。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f33393030363238322f:61727469636c652f64657461696c732f313436313337313332" class_="artid" style="display:none">
 </p>
</div>


