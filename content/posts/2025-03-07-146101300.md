---
layout: post
title: "面试基础-分布式架构基础消息队列Kafka-vs-RabbitMQ-vs-RocketMQ-对比"
date: 2025-03-07 17:40:32 +0800
description: "Kafka、RabbitMQ 和 RocketMQ 在分布式系统中扮演不同角色，理解其设计哲学与核心机制是技术选型的关键。Kafka 通过分区与顺序 I/O 实现高吞吐；RabbitMQ 通过灵活的 Exchange 路由满足复杂业务逻辑；RocketMQ 通过事务消息与主从同步保障金融级可靠性。在实际项目中，建议结合业务需求（如吞吐量、延迟、事务）与团队技术栈进行选择，必要时可混合使用多种消息队列（如 Kafka 处理日志 + RocketMQ 处理交易）。参考文献Kafka 官方文档。"
keywords: "面试基础---分布式架构基础消息队列Kafka vs RabbitMQ vs RocketMQ 对比"
categories: ['分布式架构']
tags: ['面试', '架构', '后端', '分布式', 'Spring', 'Java', 'Dubbo', 'Boot']
artid: "146101300"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146101300
    alt: "面试基础-分布式架构基础消息队列Kafka-vs-RabbitMQ-vs-RocketMQ-对比"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146101300
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146101300
cover: https://bing.ee123.net/img/rand?artid=146101300
image: https://bing.ee123.net/img/rand?artid=146101300
img: https://bing.ee123.net/img/rand?artid=146101300
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     面试基础---分布式架构基础消息队列Kafka vs RabbitMQ vs RocketMQ 对比
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="Kafka_vs_RabbitMQ_vs_RocketMQ_0">
     </a>
     分布式架构消息队列深度解析：Kafka vs RabbitMQ vs RocketMQ
    </h2>
    <h3>
     <a id="_2">
     </a>
     引言
    </h3>
    <p>
     在高并发、高可用的分布式系统中，消息队列是实现异步通信、流量削峰、系统解耦的核心组件。Kafka、RabbitMQ 和 RocketMQ 是当前最主流的消息中间件，各自在性能、可靠性、生态支持等方面有独特优势。本文将深入探讨三者的设计原理、核心特性及适用场景，结合电商、金融等实际案例与源码分析，为技术选型提供全面指导。
    </p>
    <hr/>
    <h3>
     <a id="1__8">
     </a>
     1. 消息队列的核心价值与选型维度
    </h3>
    <h4>
     <a id="11__10">
     </a>
     1.1 核心价值
    </h4>
    <ul>
     <li>
      <strong>
       异步通信
      </strong>
      ：解耦生产者和消费者，提升系统响应速度。
     </li>
     <li>
      <strong>
       流量削峰
      </strong>
      ：缓冲突发流量，避免系统过载。
     </li>
     <li>
      <strong>
       数据持久化
      </strong>
      ：确保消息不丢失，支持故障恢复。
     </li>
     <li>
      <strong>
       顺序性保证
      </strong>
      ：特定场景下保证消息顺序消费。
     </li>
    </ul>
    <h4>
     <a id="12__16">
     </a>
     1.2 选型维度
    </h4>
    <table>
     <thead>
      <tr>
       <th>
        维度
       </th>
       <th>
        说明
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        <strong>
         吞吐量
        </strong>
       </td>
       <td>
        单位时间内处理的消息量（如 Kafka 可达百万级 TPS）
       </td>
      </tr>
      <tr>
       <td>
        <strong>
         延迟
        </strong>
       </td>
       <td>
        消息从生产到消费的时间（如 RabbitMQ 微秒级延迟）
       </td>
      </tr>
      <tr>
       <td>
        <strong>
         可靠性
        </strong>
       </td>
       <td>
        消息不丢失、不重复的保证机制
       </td>
      </tr>
      <tr>
       <td>
        <strong>
         功能特性
        </strong>
       </td>
       <td>
        事务消息、延迟消息、死信队列等
       </td>
      </tr>
      <tr>
       <td>
        <strong>
         生态支持
        </strong>
       </td>
       <td>
        多语言客户端、监控工具、云原生集成
       </td>
      </tr>
     </tbody>
    </table>
    <hr/>
    <h3>
     <a id="2_Kafka_27">
     </a>
     2. Kafka：高吞吐量的分布式日志系统
    </h3>
    <h4>
     <a id="21__29">
     </a>
     2.1 核心架构
    </h4>
    <p>
     Kafka 采用发布-订阅模型，核心组件包括：
    </p>
    <ul>
     <li>
      <strong>
       Producer
      </strong>
      ：消息生产者。
     </li>
     <li>
      <strong>
       Consumer
      </strong>
      ：消息消费者。
     </li>
     <li>
      <strong>
       Broker
      </strong>
      ：服务节点，存储消息。
     </li>
     <li>
      <strong>
       Topic
      </strong>
      ：逻辑消息分类，分为多个 Partition。
     </li>
     <li>
      <strong>
       ZooKeeper
      </strong>
      ：管理集群元数据（新版本已逐步移除依赖）。
     </li>
    </ul>
    <div class="mermaid">
     <svg class="mermaid-svg" height="350" id="mermaid-svg-Ub2foOs8VPSKu2We" viewbox="0 0 531.3359375 350" width="531.3359375" xmlns="http://www.w3.org/2000/svg">
      <style>
       #mermaid-svg-Ub2foOs8VPSKu2We {font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}#mermaid-svg-Ub2foOs8VPSKu2We .error-icon{fill:#552222;}#mermaid-svg-Ub2foOs8VPSKu2We .error-text{fill:#552222;stroke:#552222;}#mermaid-svg-Ub2foOs8VPSKu2We .edge-thickness-normal{stroke-width:2px;}#mermaid-svg-Ub2foOs8VPSKu2We .edge-thickness-thick{stroke-width:3.5px;}#mermaid-svg-Ub2foOs8VPSKu2We .edge-pattern-solid{stroke-dasharray:0;}#mermaid-svg-Ub2foOs8VPSKu2We .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-svg-Ub2foOs8VPSKu2We .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-svg-Ub2foOs8VPSKu2We .marker{fill:#333333;stroke:#333333;}#mermaid-svg-Ub2foOs8VPSKu2We .marker.cross{stroke:#333333;}#mermaid-svg-Ub2foOs8VPSKu2We svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-svg-Ub2foOs8VPSKu2We .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#mermaid-svg-Ub2foOs8VPSKu2We .cluster-label text{fill:#333;}#mermaid-svg-Ub2foOs8VPSKu2We .cluster-label span{color:#333;}#mermaid-svg-Ub2foOs8VPSKu2We .label text,#mermaid-svg-Ub2foOs8VPSKu2We span{fill:#333;color:#333;}#mermaid-svg-Ub2foOs8VPSKu2We .node rect,#mermaid-svg-Ub2foOs8VPSKu2We .node circle,#mermaid-svg-Ub2foOs8VPSKu2We .node ellipse,#mermaid-svg-Ub2foOs8VPSKu2We .node polygon,#mermaid-svg-Ub2foOs8VPSKu2We .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#mermaid-svg-Ub2foOs8VPSKu2We .node .label{text-align:center;}#mermaid-svg-Ub2foOs8VPSKu2We .node.clickable{cursor:pointer;}#mermaid-svg-Ub2foOs8VPSKu2We .arrowheadPath{fill:#333333;}#mermaid-svg-Ub2foOs8VPSKu2We .edgePath .path{stroke:#333333;stroke-width:2.0px;}#mermaid-svg-Ub2foOs8VPSKu2We .flowchart-link{stroke:#333333;fill:none;}#mermaid-svg-Ub2foOs8VPSKu2We .edgeLabel{background-color:#e8e8e8;text-align:center;}#mermaid-svg-Ub2foOs8VPSKu2We .edgeLabel rect{opacity:0.5;background-color:#e8e8e8;fill:#e8e8e8;}#mermaid-svg-Ub2foOs8VPSKu2We .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#mermaid-svg-Ub2foOs8VPSKu2We .cluster text{fill:#333;}#mermaid-svg-Ub2foOs8VPSKu2We .cluster span{color:#333;}#mermaid-svg-Ub2foOs8VPSKu2We div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#mermaid-svg-Ub2foOs8VPSKu2We :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}
      </style>
      <g>
       <g class="output">
        <g class="clusters">
        </g>
        <g class="edgePaths">
         <g class="edgePath LS-P LE-T" id="L-P-T" style="opacity: 1;">
          <path class="path" d="M265.66796875,54L265.66796875,58.166666666666664C265.66796875,62.333333333333336,265.66796875,70.66666666666667,265.66796875,79C265.66796875,87.33333333333333,265.66796875,95.66666666666667,265.66796875,99.83333333333333L265.66796875,104" marker-end="url(#arrowhead271)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead271" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-T LE-P1" id="L-T-P1" style="opacity: 1;">
          <path class="path" d="M237.02734375,134.2952199328386L210.39322916666666,141.07934994403215C183.75911458333334,147.86347995522573,130.49088541666666,161.43173997761286,103.85677083333333,172.3825366554731C77.22265625,183.33333333333334,77.22265625,191.66666666666666,77.22265625,195.83333333333334L77.22265625,200" marker-end="url(#arrowhead272)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead272" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-T LE-P2" id="L-T-P2" style="opacity: 1;">
          <path class="path" d="M265.66796875,150L265.66796875,154.16666666666666C265.66796875,158.33333333333334,265.66796875,166.66666666666666,265.66796875,175C265.66796875,183.33333333333334,265.66796875,191.66666666666666,265.66796875,195.83333333333334L265.66796875,200" marker-end="url(#arrowhead273)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead273" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-T LE-P3" id="L-T-P3" style="opacity: 1;">
          <path class="path" d="M294.30859375,134.2952199328386L320.9427083333333,141.07934994403215C347.5768229166667,147.86347995522573,400.8450520833333,161.43173997761286,427.4791666666667,172.3825366554731C454.11328125,183.33333333333334,454.11328125,191.66666666666666,454.11328125,195.83333333333334L454.11328125,200" marker-end="url(#arrowhead274)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead274" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-P1 LE-C1" id="L-P1-C1" style="opacity: 1;">
          <path class="path" d="M77.22265625,246L77.22265625,250.16666666666666C77.22265625,254.33333333333334,77.22265625,262.6666666666667,77.22265625,271C77.22265625,279.3333333333333,77.22265625,287.6666666666667,77.22265625,291.8333333333333L77.22265625,296" marker-end="url(#arrowhead275)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead275" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-P2 LE-C2" id="L-P2-C2" style="opacity: 1;">
          <path class="path" d="M265.66796875,246L265.66796875,250.16666666666666C265.66796875,254.33333333333334,265.66796875,262.6666666666667,265.66796875,271C265.66796875,279.3333333333333,265.66796875,287.6666666666667,265.66796875,291.8333333333333L265.66796875,296" marker-end="url(#arrowhead276)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead276" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-P3 LE-C3" id="L-P3-C3" style="opacity: 1;">
          <path class="path" d="M454.11328125,246L454.11328125,250.16666666666666C454.11328125,254.33333333333334,454.11328125,262.6666666666667,454.11328125,271C454.11328125,279.3333333333333,454.11328125,287.6666666666667,454.11328125,291.8333333333333L454.11328125,296" marker-end="url(#arrowhead277)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead277" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
        </g>
        <g class="edgeLabels">
         <g class="edgeLabel" style="opacity: 1;" transform="">
          <g class="label" transform="translate(0,0)">
           <rect height="0" rx="0" ry="0" width="0">
           </rect>
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-P' L-LE-T" id="L-L-P-T">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="">
          <g class="label" transform="translate(0,0)">
           <rect height="0" rx="0" ry="0" width="0">
           </rect>
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-T' L-LE-P1" id="L-L-T-P1">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="">
          <g class="label" transform="translate(0,0)">
           <rect height="0" rx="0" ry="0" width="0">
           </rect>
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-T' L-LE-P2" id="L-L-T-P2">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="">
          <g class="label" transform="translate(0,0)">
           <rect height="0" rx="0" ry="0" width="0">
           </rect>
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-T' L-LE-P3" id="L-L-T-P3">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="">
          <g class="label" transform="translate(0,0)">
           <rect height="0" rx="0" ry="0" width="0">
           </rect>
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-P1' L-LE-C1" id="L-L-P1-C1">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="">
          <g class="label" transform="translate(0,0)">
           <rect height="0" rx="0" ry="0" width="0">
           </rect>
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-P2' L-LE-C2" id="L-L-P2-C2">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="">
          <g class="label" transform="translate(0,0)">
           <rect height="0" rx="0" ry="0" width="0">
           </rect>
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-P3' L-LE-C3" id="L-L-P3-C3">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
        </g>
        <g class="nodes">
         <g class="node default" id="flowchart-P-234" style="opacity: 1;" transform="translate(265.66796875,31)">
          <rect class="label-container" height="46" rx="0" ry="0" width="83.5" x="-41.75" y="-23">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-31.75,-13)">
            <foreignobject height="26" width="63.5">
             <div style="display: inline-block; white-space: nowrap;">
              Producer
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-T-235" style="opacity: 1;" transform="translate(265.66796875,127)">
          <rect class="label-container" height="46" rx="0" ry="0" width="57.28125" x="-28.640625" y="-23">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-18.640625,-13)">
            <foreignobject height="26" width="37.28125">
             <div style="display: inline-block; white-space: nowrap;">
              Topic
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-P1-237" style="opacity: 1;" transform="translate(77.22265625,223)">
          <rect class="label-container" height="46" rx="0" ry="0" width="95.1484375" x="-47.57421875" y="-23">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-37.57421875,-13)">
            <foreignobject height="26" width="75.1484375">
             <div style="display: inline-block; white-space: nowrap;">
              Partition 1
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-P2-239" style="opacity: 1;" transform="translate(265.66796875,223)">
          <rect class="label-container" height="46" rx="0" ry="0" width="95.1484375" x="-47.57421875" y="-23">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-37.57421875,-13)">
            <foreignobject height="26" width="75.1484375">
             <div style="display: inline-block; white-space: nowrap;">
              Partition 2
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-P3-241" style="opacity: 1;" transform="translate(454.11328125,223)">
          <rect class="label-container" height="46" rx="0" ry="0" width="95.1484375" x="-47.57421875" y="-23">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-37.57421875,-13)">
            <foreignobject height="26" width="75.1484375">
             <div style="display: inline-block; white-space: nowrap;">
              Partition 3
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-C1-243" style="opacity: 1;" transform="translate(77.22265625,319)">
          <rect class="label-container" height="46" rx="0" ry="0" width="138.4453125" x="-69.22265625" y="-23">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-59.22265625,-13)">
            <foreignobject height="26" width="118.4453125">
             <div style="display: inline-block; white-space: nowrap;">
              Consumer Group
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-C2-245" style="opacity: 1;" transform="translate(265.66796875,319)">
          <rect class="label-container" height="46" rx="0" ry="0" width="138.4453125" x="-69.22265625" y="-23">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-59.22265625,-13)">
            <foreignobject height="26" width="118.4453125">
             <div style="display: inline-block; white-space: nowrap;">
              Consumer Group
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-C3-247" style="opacity: 1;" transform="translate(454.11328125,319)">
          <rect class="label-container" height="46" rx="0" ry="0" width="138.4453125" x="-69.22265625" y="-23">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-59.22265625,-13)">
            <foreignobject height="26" width="118.4453125">
             <div style="display: inline-block; white-space: nowrap;">
              Consumer Group
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
        </g>
       </g>
      </g>
     </svg>
    </div>
    <h4>
     <a id="22__48">
     </a>
     2.2 核心特性
    </h4>
    <ul>
     <li>
      <strong>
       高吞吐量
      </strong>
      ：通过顺序 I/O、零拷贝（Zero-Copy）技术实现百万级 TPS。
     </li>
     <li>
      <strong>
       水平扩展
      </strong>
      ：Topic 分片（Partition）支持横向扩容。
     </li>
     <li>
      <strong>
       持久化存储
      </strong>
      ：消息持久化到磁盘，支持 TB 级数据堆积。
     </li>
     <li>
      <strong>
       流式处理
      </strong>
      ：与 Kafka Streams、Flink 集成实现实时计算。
     </li>
    </ul>
    <h4>
     <a id="23__54">
     </a>
     2.3 源码解析：消息存储机制
    </h4>
    <p>
     Kafka 的消息以 Segment 文件形式存储，每个 Partition 对应一组有序的 Segment。
    </p>
    <pre><code class="prism language-java"><span class="token comment">// Kafka 日志存储核心逻辑（简化版）</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Log</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">File</span> dir<span class="token punctuation">;</span> <span class="token comment">// 存储目录</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ConcurrentNavigableMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">LogSegment</span><span class="token punctuation">&gt;</span></span> segments <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentSkipListMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">RecordBatch</span> records<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 写入当前活跃 Segment</span>
        <span class="token class-name">LogSegment</span> activeSegment <span class="token operator">=</span> segments<span class="token punctuation">.</span><span class="token function">lastEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        activeSegment<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>records<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 触发 Segment 滚动（按时间或大小）</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>activeSegment<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> config<span class="token punctuation">.</span>segmentSize<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">rollSegment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="24__75">
     </a>
     2.4 实际案例：电商用户行为日志收集
    </h4>
    <p>
     <strong>
      场景
     </strong>
     ：某电商平台需实时收集用户点击、加购等行为日志，用于实时推荐和离线分析。
     <br/>
     <strong>
      方案
     </strong>
     ：
    </p>
    <ul>
     <li>
      <strong>
       Producer
      </strong>
      ：前端 SDK 将日志发送至 Kafka。
     </li>
     <li>
      <strong>
       Topic
      </strong>
      ：按业务类型分为
      <code>
       user_click
      </code>
      、
      <code>
       user_cart
      </code>
      等。
     </li>
     <li>
      <strong>
       Consumer
      </strong>
      ：Flink 实时处理日志生成推荐信号；Hadoop 离线分析用户行为。
     </li>
    </ul>
    <hr/>
    <h3>
     <a id="3_RabbitMQ_84">
     </a>
     3. RabbitMQ：企业级消息代理
    </h3>
    <h4>
     <a id="31__86">
     </a>
     3.1 核心架构
    </h4>
    <p>
     RabbitMQ 基于 AMQP 协议，核心组件包括：
    </p>
    <ul>
     <li>
      <strong>
       Exchange
      </strong>
      ：接收生产者消息，按规则路由到队列。
     </li>
     <li>
      <strong>
       Queue
      </strong>
      ：存储消息的缓冲区。
     </li>
     <li>
      <strong>
       Binding
      </strong>
      ：定义 Exchange 与 Queue 的路由规则。
     </li>
    </ul>
    <div class="mermaid">
     <svg class="mermaid-svg" height="158" id="mermaid-svg-jhwlUPZDtDhO6Rre" viewbox="0 0 588.71875 158" width="588.71875" xmlns="http://www.w3.org/2000/svg">
      <style>
       #mermaid-svg-jhwlUPZDtDhO6Rre {font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}#mermaid-svg-jhwlUPZDtDhO6Rre .error-icon{fill:#552222;}#mermaid-svg-jhwlUPZDtDhO6Rre .error-text{fill:#552222;stroke:#552222;}#mermaid-svg-jhwlUPZDtDhO6Rre .edge-thickness-normal{stroke-width:2px;}#mermaid-svg-jhwlUPZDtDhO6Rre .edge-thickness-thick{stroke-width:3.5px;}#mermaid-svg-jhwlUPZDtDhO6Rre .edge-pattern-solid{stroke-dasharray:0;}#mermaid-svg-jhwlUPZDtDhO6Rre .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-svg-jhwlUPZDtDhO6Rre .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-svg-jhwlUPZDtDhO6Rre .marker{fill:#333333;stroke:#333333;}#mermaid-svg-jhwlUPZDtDhO6Rre .marker.cross{stroke:#333333;}#mermaid-svg-jhwlUPZDtDhO6Rre svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-svg-jhwlUPZDtDhO6Rre .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#mermaid-svg-jhwlUPZDtDhO6Rre .cluster-label text{fill:#333;}#mermaid-svg-jhwlUPZDtDhO6Rre .cluster-label span{color:#333;}#mermaid-svg-jhwlUPZDtDhO6Rre .label text,#mermaid-svg-jhwlUPZDtDhO6Rre span{fill:#333;color:#333;}#mermaid-svg-jhwlUPZDtDhO6Rre .node rect,#mermaid-svg-jhwlUPZDtDhO6Rre .node circle,#mermaid-svg-jhwlUPZDtDhO6Rre .node ellipse,#mermaid-svg-jhwlUPZDtDhO6Rre .node polygon,#mermaid-svg-jhwlUPZDtDhO6Rre .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#mermaid-svg-jhwlUPZDtDhO6Rre .node .label{text-align:center;}#mermaid-svg-jhwlUPZDtDhO6Rre .node.clickable{cursor:pointer;}#mermaid-svg-jhwlUPZDtDhO6Rre .arrowheadPath{fill:#333333;}#mermaid-svg-jhwlUPZDtDhO6Rre .edgePath .path{stroke:#333333;stroke-width:2.0px;}#mermaid-svg-jhwlUPZDtDhO6Rre .flowchart-link{stroke:#333333;fill:none;}#mermaid-svg-jhwlUPZDtDhO6Rre .edgeLabel{background-color:#e8e8e8;text-align:center;}#mermaid-svg-jhwlUPZDtDhO6Rre .edgeLabel rect{opacity:0.5;background-color:#e8e8e8;fill:#e8e8e8;}#mermaid-svg-jhwlUPZDtDhO6Rre .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#mermaid-svg-jhwlUPZDtDhO6Rre .cluster text{fill:#333;}#mermaid-svg-jhwlUPZDtDhO6Rre .cluster span{color:#333;}#mermaid-svg-jhwlUPZDtDhO6Rre div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#mermaid-svg-jhwlUPZDtDhO6Rre :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}
      </style>
      <g>
       <g class="output">
        <g class="clusters">
        </g>
        <g class="edgePaths">
         <g class="edgePath LS-P LE-E" id="L-P-E" style="opacity: 1;">
          <path class="path" d="M91.5,79L95.66666666666667,79C99.83333333333333,79,108.16666666666667,79,116.5,79C124.83333333333333,79,133.16666666666666,79,137.33333333333334,79L141.5,79" marker-end="url(#arrowhead298)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead298" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-E LE-Q1" id="L-E-Q1" style="opacity: 1;">
          <path class="path" d="M228.65625,59.976659916870936L239.71940104166666,55.14721659739245C250.78255208333334,50.317773277913965,272.9088541666667,40.65888663895698,295.03515625,35.82944331947849C317.1614583333333,31,339.2877604166667,31,350.3509114583333,31L361.4140625,31" marker-end="url(#arrowhead299)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead299" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-E LE-Q2" id="L-E-Q2" style="opacity: 1;">
          <path class="path" d="M228.65625,98.02334008312906L239.71940104166666,102.85278340260754C250.78255208333334,107.68222672208604,272.9088541666667,117.34111336104301,295.03515625,122.1705566805215C317.1614583333333,127,339.2877604166667,127,350.3509114583333,127L361.4140625,127" marker-end="url(#arrowhead300)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead300" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-Q1 LE-C1" id="L-Q1-C1" style="opacity: 1;">
          <path class="path" d="M440.375,31L444.5416666666667,31C448.7083333333333,31,457.0416666666667,31,465.375,31C473.7083333333333,31,482.0416666666667,31,486.2083333333333,31L490.375,31" marker-end="url(#arrowhead301)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead301" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-Q2 LE-C2" id="L-Q2-C2" style="opacity: 1;">
          <path class="path" d="M440.375,127L444.5416666666667,127C448.7083333333333,127,457.0416666666667,127,465.375,127C473.7083333333333,127,482.0416666666667,127,486.2083333333333,127L490.375,127" marker-end="url(#arrowhead302)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead302" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
        </g>
        <g class="edgeLabels">
         <g class="edgeLabel" style="opacity: 1;" transform="">
          <g class="label" transform="translate(0,0)">
           <rect height="0" rx="0" ry="0" width="0">
           </rect>
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-P' L-LE-E" id="L-L-P-E">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="translate(295.03515625,31)">
          <g class="label" transform="translate(-41.37890625,-13)">
           <rect height="26" rx="0" ry="0" width="82.7578125">
           </rect>
           <foreignobject height="26" width="82.7578125">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-E' L-LE-Q1" id="L-L-E-Q1">
              Binding Key
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="translate(295.03515625,127)">
          <g class="label" transform="translate(-41.37890625,-13)">
           <rect height="26" rx="0" ry="0" width="82.7578125">
           </rect>
           <foreignobject height="26" width="82.7578125">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-E' L-LE-Q2" id="L-L-E-Q2">
              Binding Key
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="">
          <g class="label" transform="translate(0,0)">
           <rect height="0" rx="0" ry="0" width="0">
           </rect>
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-Q1' L-LE-C1" id="L-L-Q1-C1">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="">
          <g class="label" transform="translate(0,0)">
           <rect height="0" rx="0" ry="0" width="0">
           </rect>
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-Q2' L-LE-C2" id="L-L-Q2-C2">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
        </g>
        <g class="nodes">
         <g class="node default" id="flowchart-P-258" style="opacity: 1;" transform="translate(49.75,79)">
          <rect class="label-container" height="46" rx="0" ry="0" width="83.5" x="-41.75" y="-23">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-31.75,-13)">
            <foreignobject height="26" width="63.5">
             <div style="display: inline-block; white-space: nowrap;">
              Producer
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-E-259" style="opacity: 1;" transform="translate(185.078125,79)">
          <rect class="label-container" height="46" rx="0" ry="0" width="87.15625" x="-43.578125" y="-23">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-33.578125,-13)">
            <foreignobject height="26" width="67.15625">
             <div style="display: inline-block; white-space: nowrap;">
              Exchange
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-Q1-261" style="opacity: 1;" transform="translate(400.89453125,31)">
          <rect class="label-container" height="46" rx="0" ry="0" width="78.9609375" x="-39.48046875" y="-23">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-29.48046875,-13)">
            <foreignobject height="26" width="58.9609375">
             <div style="display: inline-block; white-space: nowrap;">
              Queue 1
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-Q2-263" style="opacity: 1;" transform="translate(400.89453125,127)">
          <rect class="label-container" height="46" rx="0" ry="0" width="78.9609375" x="-39.48046875" y="-23">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-29.48046875,-13)">
            <foreignobject height="26" width="58.9609375">
             <div style="display: inline-block; white-space: nowrap;">
              Queue 2
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-C1-265" style="opacity: 1;" transform="translate(535.546875,31)">
          <rect class="label-container" height="46" rx="0" ry="0" width="90.34375" x="-45.171875" y="-23">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-35.171875,-13)">
            <foreignobject height="26" width="70.34375">
             <div style="display: inline-block; white-space: nowrap;">
              Consumer
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-C2-267" style="opacity: 1;" transform="translate(535.546875,127)">
          <rect class="label-container" height="46" rx="0" ry="0" width="90.34375" x="-45.171875" y="-23">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-35.171875,-13)">
            <foreignobject height="26" width="70.34375">
             <div style="display: inline-block; white-space: nowrap;">
              Consumer
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
        </g>
       </g>
      </g>
     </svg>
    </div>
    <h4>
     <a id="32__101">
     </a>
     3.2 核心特性
    </h4>
    <ul>
     <li>
      <strong>
       灵活路由
      </strong>
      ：支持 Direct、Topic、Fanout、Headers 四种 Exchange 类型。
     </li>
     <li>
      <strong>
       消息确认
      </strong>
      ：通过 ACK/NACK 机制保证可靠性。
     </li>
     <li>
      <strong>
       优先级队列
      </strong>
      ：支持消息优先级调度。
     </li>
     <li>
      <strong>
       插件生态
      </strong>
      ：可通过插件支持 MQTT、STOMP 等协议。
     </li>
    </ul>
    <h4>
     <a id="33__107">
     </a>
     3.3 源码解析：消息确认机制
    </h4>
    <p>
     RabbitMQ 通过
     <code>
      basic.ack
     </code>
     和
     <code>
      basic.nack
     </code>
     实现消息确认。
    </p>
    <pre><code class="prism language-erlang"><span class="token comment">%% RabbitMQ 消息确认源码（Erlang 语言）</span>
<span class="token function">handle_method</span><span class="token punctuation">(</span><span class="token punctuation">#</span><span class="token quoted-atom atom">'basic.ack'</span><span class="token punctuation">{<!-- --></span><span class="token atom">delivery_tag</span> <span class="token operator">=</span> <span class="token variable">Tag</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token variable">State</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span>
    <span class="token keyword">case</span> <span class="token atom">rabbit_amqqueue</span><span class="token punctuation">:</span><span class="token function">ack</span><span class="token punctuation">(</span><span class="token variable">Tag</span><span class="token punctuation">,</span> <span class="token variable">State</span><span class="token punctuation">#</span><span class="token atom">state</span><span class="token punctuation">.</span><span class="token atom">channel</span><span class="token punctuation">)</span> <span class="token keyword">of</span>
        <span class="token atom">ok</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token atom">ok</span><span class="token punctuation">;</span>
        <span class="token punctuation">{<!-- --></span><span class="token atom">error</span><span class="token punctuation">,</span> <span class="token atom">not_found</span><span class="token punctuation">}</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token function">protocol_error</span><span class="token punctuation">(</span><span class="token atom">precondition_failed</span><span class="token punctuation">,</span> <span class="token string">"Unknown delivery tag ~w"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token variable">Tag</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span><span class="token punctuation">;</span>
</code></pre>
    <h4>
     <a id="34__119">
     </a>
     3.4 实际案例：金融订单状态更新
    </h4>
    <p>
     <strong>
      场景
     </strong>
     ：支付系统需保证订单状态变更的可靠性，避免掉单。
     <br/>
     <strong>
      方案
     </strong>
     ：
    </p>
    <ul>
     <li>
      <strong>
       生产者
      </strong>
      ：支付服务将订单状态变更发送至 RabbitMQ。
     </li>
     <li>
      <strong>
       Exchange
      </strong>
      ：使用
      <code>
       Direct Exchange
      </code>
      路由到对应队列。
     </li>
     <li>
      <strong>
       队列
      </strong>
      ：启用持久化（Durable）和镜像队列（Mirrored Queue）。
     </li>
     <li>
      <strong>
       消费者
      </strong>
      ：订单服务消费消息并更新数据库，失败时重试或进入死信队列。
     </li>
    </ul>
    <hr/>
    <h3>
     <a id="4_RocketMQ_129">
     </a>
     4. RocketMQ：阿里系金融级消息队列
    </h3>
    <h4>
     <a id="41__131">
     </a>
     4.1 核心架构
    </h4>
    <p>
     RocketMQ 设计参考 Kafka，核心组件包括：
    </p>
    <ul>
     <li>
      <strong>
       NameServer
      </strong>
      ：轻量级注册中心，管理 Broker 元数据。
     </li>
     <li>
      <strong>
       Broker
      </strong>
      ：存储消息，支持主从同步。
     </li>
     <li>
      <strong>
       Producer Group
      </strong>
      ：生产者组，支持事务消息。
     </li>
     <li>
      <strong>
       Consumer Group
      </strong>
      ：消费者组，支持集群或广播消费。
     </li>
    </ul>
    <div class="mermaid">
     <svg class="mermaid-svg" height="350" id="mermaid-svg-lzGJWLHU6JTbj8p1" viewbox="0 0 294.296875 350" width="294.296875" xmlns="http://www.w3.org/2000/svg">
      <style>
       #mermaid-svg-lzGJWLHU6JTbj8p1 {font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}#mermaid-svg-lzGJWLHU6JTbj8p1 .error-icon{fill:#552222;}#mermaid-svg-lzGJWLHU6JTbj8p1 .error-text{fill:#552222;stroke:#552222;}#mermaid-svg-lzGJWLHU6JTbj8p1 .edge-thickness-normal{stroke-width:2px;}#mermaid-svg-lzGJWLHU6JTbj8p1 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-svg-lzGJWLHU6JTbj8p1 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-svg-lzGJWLHU6JTbj8p1 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-svg-lzGJWLHU6JTbj8p1 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-svg-lzGJWLHU6JTbj8p1 .marker{fill:#333333;stroke:#333333;}#mermaid-svg-lzGJWLHU6JTbj8p1 .marker.cross{stroke:#333333;}#mermaid-svg-lzGJWLHU6JTbj8p1 svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-svg-lzGJWLHU6JTbj8p1 .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#mermaid-svg-lzGJWLHU6JTbj8p1 .cluster-label text{fill:#333;}#mermaid-svg-lzGJWLHU6JTbj8p1 .cluster-label span{color:#333;}#mermaid-svg-lzGJWLHU6JTbj8p1 .label text,#mermaid-svg-lzGJWLHU6JTbj8p1 span{fill:#333;color:#333;}#mermaid-svg-lzGJWLHU6JTbj8p1 .node rect,#mermaid-svg-lzGJWLHU6JTbj8p1 .node circle,#mermaid-svg-lzGJWLHU6JTbj8p1 .node ellipse,#mermaid-svg-lzGJWLHU6JTbj8p1 .node polygon,#mermaid-svg-lzGJWLHU6JTbj8p1 .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#mermaid-svg-lzGJWLHU6JTbj8p1 .node .label{text-align:center;}#mermaid-svg-lzGJWLHU6JTbj8p1 .node.clickable{cursor:pointer;}#mermaid-svg-lzGJWLHU6JTbj8p1 .arrowheadPath{fill:#333333;}#mermaid-svg-lzGJWLHU6JTbj8p1 .edgePath .path{stroke:#333333;stroke-width:2.0px;}#mermaid-svg-lzGJWLHU6JTbj8p1 .flowchart-link{stroke:#333333;fill:none;}#mermaid-svg-lzGJWLHU6JTbj8p1 .edgeLabel{background-color:#e8e8e8;text-align:center;}#mermaid-svg-lzGJWLHU6JTbj8p1 .edgeLabel rect{opacity:0.5;background-color:#e8e8e8;fill:#e8e8e8;}#mermaid-svg-lzGJWLHU6JTbj8p1 .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#mermaid-svg-lzGJWLHU6JTbj8p1 .cluster text{fill:#333;}#mermaid-svg-lzGJWLHU6JTbj8p1 .cluster span{color:#333;}#mermaid-svg-lzGJWLHU6JTbj8p1 div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#mermaid-svg-lzGJWLHU6JTbj8p1 :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}
      </style>
      <g>
       <g class="output">
        <g class="clusters">
        </g>
        <g class="edgePaths">
         <g class="edgePath LS-P LE-N" id="L-P-N" style="opacity: 1;">
          <path class="path" d="M149.68359375,54L149.68359375,58.166666666666664C149.68359375,62.333333333333336,149.68359375,70.66666666666667,149.68359375,79C149.68359375,87.33333333333333,149.68359375,95.66666666666667,149.68359375,99.83333333333333L149.68359375,104" marker-end="url(#arrowhead321)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead321" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-N LE-B1" id="L-N-B1" style="opacity: 1;">
          <path class="path" d="M110.35636393229166,150L103.23186577690971,154.16666666666666C96.10736762152777,158.33333333333334,81.85837131076389,166.66666666666666,74.73387315538194,175C67.609375,183.33333333333334,67.609375,191.66666666666666,67.609375,195.83333333333334L67.609375,200" marker-end="url(#arrowhead322)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead322" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-N LE-B2" id="L-N-B2" style="opacity: 1;">
          <path class="path" d="M189.01082356770834,150L196.1353217230903,154.16666666666666C203.25981987847226,158.33333333333334,217.50881618923611,166.66666666666666,224.63331434461804,175C231.7578125,183.33333333333334,231.7578125,191.66666666666666,231.7578125,195.83333333333334L231.7578125,200" marker-end="url(#arrowhead323)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead323" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-B1 LE-C" id="L-B1-C" style="opacity: 1;">
          <path class="path" d="M67.609375,246L67.609375,250.16666666666666C67.609375,254.33333333333334,67.609375,262.6666666666667,74.73387315538194,271C81.85837131076389,279.3333333333333,96.10736762152777,287.6666666666667,103.23186577690971,291.8333333333333L110.35636393229166,296" marker-end="url(#arrowhead324)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead324" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-B2 LE-C" id="L-B2-C" style="opacity: 1;">
          <path class="path" d="M231.7578125,246L231.7578125,250.16666666666666C231.7578125,254.33333333333334,231.7578125,262.6666666666667,224.63331434461804,271C217.50881618923611,279.3333333333333,203.25981987847226,287.6666666666667,196.1353217230903,291.8333333333333L189.01082356770834,296" marker-end="url(#arrowhead325)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead325" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
        </g>
        <g class="edgeLabels">
         <g class="edgeLabel" style="opacity: 1;" transform="">
          <g class="label" transform="translate(0,0)">
           <rect height="0" rx="0" ry="0" width="0">
           </rect>
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-P' L-LE-N" id="L-L-P-N">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="">
          <g class="label" transform="translate(0,0)">
           <rect height="0" rx="0" ry="0" width="0">
           </rect>
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-N' L-LE-B1" id="L-L-N-B1">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="">
          <g class="label" transform="translate(0,0)">
           <rect height="0" rx="0" ry="0" width="0">
           </rect>
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-N' L-LE-B2" id="L-L-N-B2">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="">
          <g class="label" transform="translate(0,0)">
           <rect height="0" rx="0" ry="0" width="0">
           </rect>
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-B1' L-LE-C" id="L-L-B1-C">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="">
          <g class="label" transform="translate(0,0)">
           <rect height="0" rx="0" ry="0" width="0">
           </rect>
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-B2' L-LE-C" id="L-L-B2-C">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
        </g>
        <g class="nodes">
         <g class="node default" id="flowchart-P-278" style="opacity: 1;" transform="translate(149.68359375,31)">
          <rect class="label-container" height="46" rx="0" ry="0" width="83.5" x="-41.75" y="-23">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-31.75,-13)">
            <foreignobject height="26" width="63.5">
             <div style="display: inline-block; white-space: nowrap;">
              Producer
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-N-279" style="opacity: 1;" transform="translate(149.68359375,127)">
          <rect class="label-container" height="46" rx="0" ry="0" width="106.046875" x="-53.0234375" y="-23">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-43.0234375,-13)">
            <foreignobject height="26" width="86.046875">
             <div style="display: inline-block; white-space: nowrap;">
              NameServer
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-B1-281" style="opacity: 1;" transform="translate(67.609375,223)">
          <rect class="label-container" height="46" rx="0" ry="0" width="119.21875" x="-59.609375" y="-23">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-49.609375,-13)">
            <foreignobject height="26" width="99.21875">
             <div style="display: inline-block; white-space: nowrap;">
              Broker Master
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-B2-283" style="opacity: 1;" transform="translate(231.7578125,223)">
          <rect class="label-container" height="46" rx="0" ry="0" width="109.078125" x="-54.5390625" y="-23">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-44.5390625,-13)">
            <foreignobject height="26" width="89.078125">
             <div style="display: inline-block; white-space: nowrap;">
              Broker Slave
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-C-285" style="opacity: 1;" transform="translate(149.68359375,319)">
          <rect class="label-container" height="46" rx="0" ry="0" width="90.34375" x="-45.171875" y="-23">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-35.171875,-13)">
            <foreignobject height="26" width="70.34375">
             <div style="display: inline-block; white-space: nowrap;">
              Consumer
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
        </g>
       </g>
      </g>
     </svg>
    </div>
    <h4>
     <a id="42__147">
     </a>
     4.2 核心特性
    </h4>
    <ul>
     <li>
      <strong>
       事务消息
      </strong>
      ：两阶段提交（2PC）实现分布式事务。
     </li>
     <li>
      <strong>
       定时消息
      </strong>
      ：支持精确到秒级的延迟消息。
     </li>
     <li>
      <strong>
       消息轨迹
      </strong>
      ：记录消息全链路轨迹，便于排查问题。
     </li>
     <li>
      <strong>
       高可用
      </strong>
      ：Broker 主从同步 + Dledger 选举。
     </li>
    </ul>
    <h4>
     <a id="43__153">
     </a>
     4.3 源码解析：事务消息实现
    </h4>
    <p>
     RocketMQ 通过半消息（Half Message）和事务状态回查实现事务。
    </p>
    <pre><code class="prism language-java"><span class="token comment">// RocketMQ 事务消息生产者示例</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransactionProducer</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">TransactionMQProducer</span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransactionMQProducer</span><span class="token punctuation">(</span><span class="token string">"group"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        producer<span class="token punctuation">.</span><span class="token function">setTransactionListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TransactionListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">LocalTransactionState</span> <span class="token function">executeLocalTransaction</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">,</span> <span class="token class-name">Object</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 执行本地事务</span>
                <span class="token keyword">return</span> <span class="token class-name">LocalTransactionState</span><span class="token punctuation">.</span><span class="token constant">COMMIT_MESSAGE</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">LocalTransactionState</span> <span class="token function">checkLocalTransaction</span><span class="token punctuation">(</span><span class="token class-name">MessageExt</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 事务状态回查</span>
                <span class="token keyword">return</span> <span class="token class-name">LocalTransactionState</span><span class="token punctuation">.</span><span class="token constant">COMMIT_MESSAGE</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        producer<span class="token punctuation">.</span><span class="token function">sendMessageInTransaction</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="44__178">
     </a>
     4.4 实际案例：电商订单履约流程
    </h4>
    <p>
     <strong>
      场景
     </strong>
     ：用户下单后需同步扣减库存、生成物流单、发送通知。
     <br/>
     <strong>
      方案
     </strong>
     ：
    </p>
    <ul>
     <li>
      <strong>
       事务消息
      </strong>
      ：订单服务发送半消息，本地事务提交后确认消息。
     </li>
     <li>
      <strong>
       消费者
      </strong>
      ：库存服务、物流服务、通知服务并行消费，保证最终一致性。
     </li>
    </ul>
    <hr/>
    <h3>
     <a id="5__186">
     </a>
     5. 横向对比与选型建议
    </h3>
    <table>
     <thead>
      <tr>
       <th>
        特性
       </th>
       <th>
        Kafka
       </th>
       <th>
        RabbitMQ
       </th>
       <th>
        RocketMQ
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        <strong>
         吞吐量
        </strong>
       </td>
       <td>
        极高（百万级 TPS）
       </td>
       <td>
        中等（万级 TPS）
       </td>
       <td>
        高（十万级 TPS）
       </td>
      </tr>
      <tr>
       <td>
        <strong>
         延迟
        </strong>
       </td>
       <td>
        高（毫秒级）
       </td>
       <td>
        低（微秒级）
       </td>
       <td>
        中（毫秒级）
       </td>
      </tr>
      <tr>
       <td>
        <strong>
         消息顺序
        </strong>
       </td>
       <td>
        分区内有序
       </td>
       <td>
        队列有序
       </td>
       <td>
        队列有序
       </td>
      </tr>
      <tr>
       <td>
        <strong>
         事务支持
        </strong>
       </td>
       <td>
        有限（需外部协调）
       </td>
       <td>
        支持（插件扩展）
       </td>
       <td>
        原生支持
       </td>
      </tr>
      <tr>
       <td>
        <strong>
         典型场景
        </strong>
       </td>
       <td>
        日志收集、流处理
       </td>
       <td>
        企业应用、复杂路由
       </td>
       <td>
        电商交易、金融业务
       </td>
      </tr>
      <tr>
       <td>
        <strong>
         代表用户
        </strong>
       </td>
       <td>
        LinkedIn、Netflix
       </td>
       <td>
        携程、Airbnb
       </td>
       <td>
        阿里巴巴、蚂蚁金服
       </td>
      </tr>
     </tbody>
    </table>
    <p>
     <strong>
      选型建议
     </strong>
     ：
    </p>
    <ul>
     <li>
      <strong>
       大数据场景
      </strong>
      ：选择 Kafka，如日志收集、实时数仓。
     </li>
     <li>
      <strong>
       复杂路由需求
      </strong>
      ：选择 RabbitMQ，如企业 ERP 系统。
     </li>
     <li>
      <strong>
       金融级事务
      </strong>
      ：选择 RocketMQ，如支付、订单系统。
     </li>
    </ul>
    <hr/>
    <h3>
     <a id="6__204">
     </a>
     6. 总结
    </h3>
    <p>
     Kafka、RabbitMQ 和 RocketMQ 在分布式系统中扮演不同角色，理解其设计哲学与核心机制是技术选型的关键。通过源码分析可见：
    </p>
    <ul>
     <li>
      Kafka 通过分区与顺序 I/O 实现高吞吐；
     </li>
     <li>
      RabbitMQ 通过灵活的 Exchange 路由满足复杂业务逻辑；
     </li>
     <li>
      RocketMQ 通过事务消息与主从同步保障金融级可靠性。
     </li>
    </ul>
    <p>
     在实际项目中，建议结合业务需求（如吞吐量、延迟、事务）与团队技术栈进行选择，必要时可混合使用多种消息队列（如 Kafka 处理日志 + RocketMQ 处理交易）。
    </p>
    <hr/>
    <p>
     <strong>
      参考文献
     </strong>
     ：
    </p>
    <ul>
     <li>
      <a href="https://kafka.apache.org/documentation/" rel="nofollow">
       Kafka 官方文档
      </a>
     </li>
     <li>
      <a href="https://www.rabbitmq.com/documentation.html" rel="nofollow">
       RabbitMQ 官方文档
      </a>
     </li>
     <li>
      <a href="https://rocketmq.apache.org/docs/" rel="nofollow">
       RocketMQ 官方文档
      </a>
     </li>
     <li>
      <a href="https://github.com/apache/kafka">
       Kafka 源码
      </a>
     </li>
     <li>
      <a href="https://github.com/apache/rocketmq">
       RocketMQ 源码
      </a>
     </li>
    </ul>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f34333239303337302f:61727469636c652f64657461696c732f313436313031333030" class_="artid" style="display:none">
 </p>
</div>


