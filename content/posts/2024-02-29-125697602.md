---
layout: post
title: "云原生3.3-Kubernetes-中间件部署实战"
date: 2024-02-29 15:16:00 +0800
description: "一个项目总会有数据吧？数据存那里呢？在前面我们讲过，很明显直接存在数据卷里面（PVC），例如 MyS"
keywords: "云原生kubernetes全栈架构师实战 pdf下载"
categories: ['云原生系列']
tags: ['容器', '云原生', '中间件', 'Kubernetes', 'Docker']
artid: "125697602"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=125697602
    alt: "云原生3.3-Kubernetes-中间件部署实战"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=125697602
featuredImagePreview: https://bing.ee123.net/img/rand?artid=125697602
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     【云原生】3.3 Kubernetes 中间件部署实战
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <blockquote>
     <p>
      哈喽~大家好呀，这篇继续上篇的实战讲解——开始我们的中间件部署实战
     </p>
     <p>
     </p>
     <p>
     </p>
     <p style="text-align:center;">
      🥇个人主页：
      <a href="https://blog.csdn.net/aasd23?spm=1000.2115.3001.5343" title="个人主页​​​​​">
       个人主页​​​​​
      </a>
     </p>
     <p style="text-align:center;">
      🥈 系列专栏：
      <a href="https://blog.csdn.net/aasd23/category_11852592.html?spm=1001.2014.3001.5482" title="【云原生系列】">
       【云原生系列】
      </a>
     </p>
     <p style="text-align:center;">
      🥉与这篇相关的文章：
     </p>
     <p>
     </p>
     <table border="1" cellpadding="1" cellspacing="1">
      <tbody>
       <tr>
        <td>
         【云原生】2.5 Kubernetes 核心实战（下）
        </td>
        <td>
         <a href="https://blog.csdn.net/aasd23/article/details/125564019?spm=1001.2014.3001.5501" title="【云原生】2.5 Kubernetes 核心实战（下）_程序猿追的博客-CSDN博客">
          【云原生】2.5 Kubernetes 核心实战（下）_程序猿追的博客-CSDN博客
         </a>
        </td>
       </tr>
       <tr>
        <td>
         【云原生】3.1 Kubernetes平台安装KubeSpher
        </td>
        <td>
         <a href="https://blog.csdn.net/aasd23/article/details/125617467?spm=1001.2014.3001.5501" title="【云原生】3.1 Kubernetes平台安装KubeSpher_程序猿追的博客-CSDN博客">
          【云原生】3.1 Kubernetes平台安装KubeSpher_程序猿追的博客-CSDN博客
         </a>
        </td>
       </tr>
       <tr>
        <td>
         【云原生】3.2 Kubernetes 实战之多租户系统实战
        </td>
        <td>
         <a href="https://blog.csdn.net/aasd23/article/details/125667760?spm=1001.2014.3001.5501" title="【云原生】3.2 Kubernetes 实战之多租户系统实战_程序猿追的博客-CSDN博客">
          【云原生】3.2 Kubernetes 实战之多租户系统实战_程序猿追的博客-CSDN博客
         </a>
        </td>
       </tr>
      </tbody>
     </table>
    </blockquote>
    <p>
    </p>
    <p id="main-toc">
     <strong>
      目录
     </strong>
    </p>
    <p id="%E4%B8%80%E3%80%81%E5%89%8D%E8%A8%80-toc" style="margin-left:0px;">
     <a href="#%E4%B8%80%E3%80%81%E5%89%8D%E8%A8%80" rel="nofollow">
      一、前言
     </a>
    </p>
    <p id="%E4%BA%8C%E3%80%81%E9%83%A8%E7%BD%B2MySQL%E6%9C%89%E7%8A%B6%E6%80%81%E5%89%AF%E6%9C%AC%E9%9B%86-toc" style="margin-left:0px;">
     <a href="#%E4%BA%8C%E3%80%81%E9%83%A8%E7%BD%B2MySQL%E6%9C%89%E7%8A%B6%E6%80%81%E5%89%AF%E6%9C%AC%E9%9B%86" rel="nofollow">
      二、部署MySQL有状态副本集
     </a>
    </p>
    <p id="%E4%B8%89%E3%80%81%E9%83%A8%E7%BD%B2MySQL%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%BD%91%E7%BB%9C-toc" style="margin-left:0px;">
     <a href="#%E4%B8%89%E3%80%81%E9%83%A8%E7%BD%B2MySQL%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%BD%91%E7%BB%9C" rel="nofollow">
      三、部署MySQL负载均衡网络
     </a>
    </p>
    <p id="%E5%9B%9B%E3%80%81%E9%83%A8%E7%BD%AERedis%E8%AE%BE%E7%BD%AE%E7%BD%91%E7%BB%9C-toc" style="margin-left:0px;">
     <a href="#%E5%9B%9B%E3%80%81%E9%83%A8%E7%BD%AERedis%E8%AE%BE%E7%BD%AE%E7%BD%91%E7%BB%9C" rel="nofollow">
      四、部置Redis设置网络
     </a>
    </p>
    <p id="NRstb-toc" style="margin-left:40px;">
     <a href="#NRstb" rel="nofollow">
      1、redis容器启动
     </a>
    </p>
    <p id="%E4%BA%94%E3%80%81%E9%83%A8%E7%BD%B2%20ElasticSearch-toc" style="margin-left:0px;">
     <a href="#%E4%BA%94%E3%80%81%E9%83%A8%E7%BD%B2%20ElasticSearch" rel="nofollow">
      五、部署 ElasticSearch
     </a>
    </p>
    <p id="1%E3%80%81es%E5%AE%B9%E5%99%A8%E5%90%AF%E5%8A%A8-toc" style="margin-left:40px;">
     <a href="#1%E3%80%81es%E5%AE%B9%E5%99%A8%E5%90%AF%E5%8A%A8" rel="nofollow">
      1、es容器启动
     </a>
    </p>
    <hr id="hr-toc"/>
    <p>
    </p>
    <h2 id="%E4%B8%80%E3%80%81%E5%89%8D%E8%A8%80">
     一、前言
    </h2>
    <blockquote>
     <p>
      在前面呢，我们做了一个多租户系统，这次用上次的一个普通用户登入进去系统。
     </p>
     <p>
      我们如何在云上部署一个应用？是以什么样的方式？该应用又是什么样子？
     </p>
     <p>
      在 KubeSphere 里面有个叫工作负载里面有部署、有状态副本集、守护进程集，对应的就是以前的
      <strong>
       部署（Deployment）、有状态副本集（StatefulSet）、守护进程集（DaemonSet）
      </strong>
      <br/>
      <img alt="" height="478" src="https://i-blog.csdnimg.cn/blog_migrate/d2f2d95c2378f13d7d3d824fd4466b65.png" width="1087"/>
     </p>
    </blockquote>
    <blockquote>
     <p>
      一个项目总会有数据吧？数据存那里呢？在前面我们讲过，很明显直接存在数据卷里面（PVC），例如 MySQL的数据。比如 MySQL有自己的配置文件、Redis 有自己的配置文件、微服务也有自己的配置文件，将它们挂在到配置集里面（ConfigMap），服务采用的是 ClusterlP 与
      <br/>
      NodePort。
     </p>
    </blockquote>
    <h2 id="%E4%BA%8C%E3%80%81%E9%83%A8%E7%BD%B2MySQL%E6%9C%89%E7%8A%B6%E6%80%81%E5%89%AF%E6%9C%AC%E9%9B%86">
     二、部署MySQL有状态副本集
    </h2>
    <blockquote>
     <p>
      无论部署一个中间件，都要执行第一步——在 docker hub 里面在到中间件的镜像。
     </p>
     <p>
      在配置中心——&gt;配置里面创建一个配置（名称，描述信息），添加数据（Key 与 value）
     </p>
    </blockquote>
    <p>
     <strong>
      🎡配置一下值
     </strong>
    </p>
    <pre><code>docker run -p 3306:3306 --name mysql-01 \
-v /mydata/mysql/log:/var/log/mysql \
-v /mydata/mysql/data:/var/lib/mysql \
-v /mydata/mysql/conf:/etc/mysql/conf.d \
-e MYSQL_ROOT_PASSWORD=root \
--restart=always \
-d mysql:5.7 </code></pre>
    <p>
     <img alt="" height="757" src="https://i-blog.csdnimg.cn/blog_migrate/8c504b5ec7a31727ca29f5e141d924b7.png" width="1200"/>
    </p>
    <p>
     再创建一个存储的地方（存储卷）使用单个节点读写（ReadWriteOnce(RW0)）
    </p>
    <p>
     <img alt="" height="110" src="https://i-blog.csdnimg.cn/blog_migrate/655ef076313f7094a540cc0bd3f8a36b.png" width="956"/>
    </p>
    <p>
    </p>
    <p>
     设置下容器镜像（记得勾选同步主机时区）、挂在存储（配置文件一般为只读的方式）、高级设置等设置
    </p>
    <p>
     <img alt="" height="777" src="https://i-blog.csdnimg.cn/blog_migrate/b0d0b19c5dde829cf4548de925d07502.png" width="1200"/>
    </p>
    <p>
    </p>
    <p>
     在这里我们的 MySQL 有状态副本集就创建好了，到此时应用还不能访问
    </p>
    <p>
     <strong>
      🎡mysql配置示例
     </strong>
    </p>
    <pre><code>[client]
default-character-set=utf8mb4
 
[mysql]
default-character-set=utf8mb4
 
[mysqld]
init_connect='SET collation_connection = utf8mb4_unicode_ci'
init_connect='SET NAMES utf8mb4'
character-set-server=utf8mb4
collation-server=utf8mb4_unicode_ci
skip-character-set-client-handshake
skip-name-resolve</code></pre>
    <h2 id="%E4%B8%89%E3%80%81%E9%83%A8%E7%BD%B2MySQL%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%BD%91%E7%BB%9C">
     三、部署MySQL负载均衡网络
    </h2>
    <blockquote>
     <p>
      我们在上面创建好的有状态副本集只能在集群里面访问，在集群内部，直接通过应用的 【服务名.项目名】 直接访问
     </p>
    </blockquote>
    <pre><code>mysql -uroot -hhis-mysql-glgf.his -p</code></pre>
    <blockquote>
     <p>
      在应用负载——&gt;服务里面设置
      <strong>
       基本信息（设置名称，描述信息）、服务设置（设置访问类型，添加一个端口）、高级设置（设置访问方式，像外网访问一样）
      </strong>
     </p>
    </blockquote>
    <p>
     <img alt="" height="747" src="https://i-blog.csdnimg.cn/blog_migrate/df70deac4e1336d56810124dcc64e91d.png" width="1200"/>
    </p>
    <p>
     <strong>
      🎡
     </strong>
     <strong>
      启动 MySQL 添加连接名字，IP 地址等信息
     </strong>
    </p>
    <p>
     <img alt="" height="812" src="https://i-blog.csdnimg.cn/blog_migrate/b060e285bb26a3c1de6ad158ed320d64.png" width="1200"/>
    </p>
    <p>
     <strong>
      🎡 这里我们部署的项目在 MySQL 也能访问了
     </strong>
    </p>
    <h2 id="%E5%9B%9B%E3%80%81%E9%83%A8%E7%BD%AERedis%E8%AE%BE%E7%BD%AE%E7%BD%91%E7%BB%9C">
     四、部置Redis设置网络
    </h2>
    <p>
     <strong>
      🎡同样的，先找到 Redis 官方镜像，然后进行设置
     </strong>
    </p>
    <h3 id="NRstb">
     1、redis容器启动
    </h3>
    <p>
     <strong>
      🎡创建配置文件，准备redis配置文件内容
     </strong>
    </p>
    <pre><code>mkdir -p /mydata/redis/conf &amp;&amp; vim /mydata/redis/conf/redis.conf</code></pre>
    <p>
     <br/>
     <strong>
      🎡配置示例
     </strong>
    </p>
    <pre><code>appendonly yes
port 6379
bind 0.0.0.0</code></pre>
    <p>
     <br/>
     <strong>
      🎡docker启动redis
     </strong>
    </p>
    <pre><code>docker run -d -p 6379:6379 --restart=always \
-v /mydata/redis/conf/redis.conf:/etc/redis/redis.conf \
-v  /mydata/redis-01/data:/data \
 --name redis-01 redis:6.2.5 \
 redis-server /etc/redis/redis.conf</code></pre>
    <p>
     <strong>
      🎡配置中心——&gt;配置里面配置一对 KV 。
     </strong>
    </p>
    <p>
     <strong>
      🎡应用负载——&gt;工作负载里面再创建一个有状态副本集（redis 的）
     </strong>
    </p>
    <p>
    </p>
    <h2 id="%E4%BA%94%E3%80%81%E9%83%A8%E7%BD%B2%20ElasticSearch">
     五、部署 ElasticSearch
    </h2>
    <h3 id="1%E3%80%81es%E5%AE%B9%E5%99%A8%E5%90%AF%E5%8A%A8">
     1、es容器启动
    </h3>
    <p>
     <strong>
      🎡创建数据目录
     </strong>
    </p>
    <pre><code>mkdir -p /mydata/es-01 &amp;&amp; chmod 777 -R /mydata/es-01</code></pre>
    <p>
     <strong>
      🎡容器启动
     </strong>
    </p>
    <pre><code>docker run --restart=always -d -p 9200:9200 -p 9300:9300 \
-e "discovery.type=single-node" \
-e ES_JAVA_OPTS="-Xms512m -Xmx512m" \
-v es-config:/usr/share/elasticsearch/config \
-v /mydata/es-01/data:/usr/share/elasticsearch/data \
--name es-01 \
elasticsearch:7.13.4</code></pre>
    <p>
     <img alt="" height="490" src="https://i-blog.csdnimg.cn/blog_migrate/9ef4f4492a221d55be656982eedf829f.png" width="996"/>
    </p>
    <blockquote>
     <p>
      <strong>
       需要注意的是子路径挂载，配置修改后，k8s 不会对其 Pod 内的相关配置文件进行热更新，需要自己重启Pod
      </strong>
     </p>
    </blockquote>
    <p>
    </p>
    <p>
     （求关注）持续更新中……
    </p>
    <p>
     <img alt="" height="200" src="https://i-blog.csdnimg.cn/blog_migrate/c99b6dc8e005c51cb60e4c27f9b1c072.gif" width="200"/>
    </p>
   </div>
  </div>
  <div class="blog-extension-box" id="blogExtensionBox" style="width:400px;margin:auto;margin-top:12px">
  </div>
 </article>
 <p alt="68747470:733a2f2f626c6f672e6373646e2e6e65742f6161736432332f:61727469636c652f64657461696c732f313235363937363032" class_="artid" style="display:none">
 </p>
</div>


