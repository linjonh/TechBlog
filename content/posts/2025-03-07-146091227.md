---
layout: post
title: "Python-Pandas实现导出两个Excel数据集的对应值的差异值分析"
date: 2025-03-07 11:24:30 +0800
description: "【代码】Python Pandas实现导出两个Excel数据集的对应值的差异值分析。"
keywords: "Python Pandas实现导出两个Excel数据集的对应值的差异值分析"
categories: ['未分类']
tags: ['数据分析', '开发语言', 'Python', 'Pandas']
artid: "146091227"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146091227
    alt: "Python-Pandas实现导出两个Excel数据集的对应值的差异值分析"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146091227
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146091227
cover: https://bing.ee123.net/img/rand?artid=146091227
image: https://bing.ee123.net/img/rand?artid=146091227
img: https://bing.ee123.net/img/rand?artid=146091227
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Python Pandas实现导出两个Excel数据集的对应值的差异值分析
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     编写Python Pandas代码实现从一个Excel文件中的一个Sheet中的表格里取两个维度字段，一个度量字段的数据，根据这两个维度字段的数据分组统计，计算度量字段的数据的分组总计值，得到一个包含两个维度字段和度量字段的分组总计值字段的dataframe，再从另一个Excel文件中的一个Sheet中的表格里取两个维度字段，一个度量字段的数据组成一个dataframe，将这两个字段的对应字段full outer join起来，显示所有字段和两个度量字段值相减的值，以及相减的值除以第一个dataframe的度量值的百分比数值。
    </p>
    <p>
     实现您需求的Python Pandas代码：
    </p>
    <pre><code class="prism language-python"><span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd

<span class="token comment"># 第一个Excel处理</span>
<span class="token keyword">def</span> <span class="token function">process_first_excel</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> sheet_name<span class="token punctuation">,</span> dim_cols<span class="token punctuation">,</span> measure_col<span class="token punctuation">)</span><span class="token punctuation">:</span>
    df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_excel<span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> sheet_name<span class="token operator">=</span>sheet_name<span class="token punctuation">,</span> usecols<span class="token operator">=</span>dim_cols <span class="token operator">+</span> <span class="token punctuation">[</span>measure_col<span class="token punctuation">]</span><span class="token punctuation">)</span>
    grouped <span class="token operator">=</span> df<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span>dim_cols<span class="token punctuation">)</span><span class="token punctuation">[</span>measure_col<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reset_index<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> grouped

<span class="token comment"># 第二个Excel处理</span>
<span class="token keyword">def</span> <span class="token function">process_second_excel</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> sheet_name<span class="token punctuation">,</span> dim_cols<span class="token punctuation">,</span> measure_col<span class="token punctuation">)</span><span class="token punctuation">:</span>
    df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_excel<span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> sheet_name<span class="token operator">=</span>sheet_name<span class="token punctuation">,</span> usecols<span class="token operator">=</span>dim_cols <span class="token operator">+</span> <span class="token punctuation">[</span>measure_col<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> df

<span class="token comment"># 执行处理流程</span>
<span class="token comment"># 参数配置（根据实际情况修改）</span>
first_file <span class="token operator">=</span> <span class="token string">"file1.xlsx"</span>
first_sheet <span class="token operator">=</span> <span class="token string">"Sheet1"</span>
first_dims <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"维度字段1"</span><span class="token punctuation">,</span> <span class="token string">"维度字段2"</span><span class="token punctuation">]</span>
first_measure <span class="token operator">=</span> <span class="token string">"度量字段1"</span>

second_file <span class="token operator">=</span> <span class="token string">"file2.xlsx"</span>
second_sheet <span class="token operator">=</span> <span class="token string">"Sheet1"</span>
second_dims <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"维度字段1"</span><span class="token punctuation">,</span> <span class="token string">"维度字段2"</span><span class="token punctuation">]</span>  <span class="token comment"># 确保维度字段名称与第一个文件一致</span>
second_measure <span class="token operator">=</span> <span class="token string">"度量字段2"</span>

<span class="token comment"># 处理数据</span>
df1 <span class="token operator">=</span> process_first_excel<span class="token punctuation">(</span>first_file<span class="token punctuation">,</span> first_sheet<span class="token punctuation">,</span> first_dims<span class="token punctuation">,</span> first_measure<span class="token punctuation">)</span>
df2 <span class="token operator">=</span> process_second_excel<span class="token punctuation">(</span>second_file<span class="token punctuation">,</span> second_sheet<span class="token punctuation">,</span> second_dims<span class="token punctuation">,</span> second_measure<span class="token punctuation">)</span>

<span class="token comment"># 全外连接</span>
merged <span class="token operator">=</span> pd<span class="token punctuation">.</span>merge<span class="token punctuation">(</span>
    df1<span class="token punctuation">,</span>
    df2<span class="token punctuation">,</span>
    on<span class="token operator">=</span>first_dims<span class="token punctuation">,</span>
    how<span class="token operator">=</span><span class="token string">"outer"</span><span class="token punctuation">,</span>
    suffixes<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">"_df1"</span><span class="token punctuation">,</span> <span class="token string">"_df2"</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token comment"># 计算差异和百分比</span>
<span class="token comment"># 处理空值（将NaN转为0以便计算）</span>
merged<span class="token punctuation">.</span>fillna<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>first_measure<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> second_measure<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

<span class="token comment"># 计算差异</span>
merged<span class="token punctuation">[</span><span class="token string">"差异值"</span><span class="token punctuation">]</span> <span class="token operator">=</span> merged<span class="token punctuation">[</span>first_measure<span class="token punctuation">]</span> <span class="token operator">-</span> merged<span class="token punctuation">[</span>second_measure<span class="token punctuation">]</span>

<span class="token comment"># 计算百分比（避免除以零错误）</span>
merged<span class="token punctuation">[</span><span class="token string">"百分比"</span><span class="token punctuation">]</span> <span class="token operator">=</span> merged<span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span>
    <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">[</span><span class="token string">"差异值"</span><span class="token punctuation">]</span> <span class="token operator">/</span> x<span class="token punctuation">[</span>first_measure<span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">100</span> <span class="token keyword">if</span> x<span class="token punctuation">[</span>first_measure<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token keyword">else</span> <span class="token number">0</span><span class="token punctuation">,</span>
    axis<span class="token operator">=</span><span class="token number">1</span>
<span class="token punctuation">)</span>

<span class="token comment"># 格式化输出</span>
pd<span class="token punctuation">.</span>options<span class="token punctuation">.</span>display<span class="token punctuation">.</span>float_format <span class="token operator">=</span> <span class="token string">"{:.2f}%"</span><span class="token punctuation">.</span><span class="token builtin">format</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"结果数据表："</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>merged<span class="token punctuation">)</span>

<span class="token comment"># 可选：保存结果到新Excel</span>
merged<span class="token punctuation">.</span>to_excel<span class="token punctuation">(</span><span class="token string">"comparison_result.xlsx"</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     使用说明：
    </p>
    <ol>
     <li>
      <p>
       需要根据实际数据修改以下参数：
      </p>
      <ul>
       <li>
        文件路径（
        <code>
         first_file
        </code>
        和
        <code>
         second_file
        </code>
        ）
       </li>
       <li>
        Sheet名称（
        <code>
         first_sheet
        </code>
        和
        <code>
         second_sheet
        </code>
        ）
       </li>
       <li>
        维度字段名称（
        <code>
         first_dims
        </code>
        和
        <code>
         second_dims
        </code>
        需保持相同）
       </li>
       <li>
        度量字段名称（
        <code>
         first_measure
        </code>
        和
        <code>
         second_measure
        </code>
        ）
       </li>
      </ul>
     </li>
     <li>
      <p>
       功能特点：
      </p>
      <ul>
       <li>
        自动处理分组聚合
       </li>
       <li>
        支持全外连接保留所有数据
       </li>
       <li>
        自动处理空值（转换为0）
       </li>
       <li>
        包含异常值处理（除零保护）
       </li>
       <li>
        结果输出格式美化
       </li>
      </ul>
     </li>
     <li>
      <p>
       注意事项：
      </p>
      <ul>
       <li>
        确保两个文件的维度字段名称完全一致
       </li>
       <li>
        度量字段建议使用不同的名称以示区分
       </li>
       <li>
        最终结果包含以下列：
        <ul>
         <li>
          所有维度字段
         </li>
         <li>
          第一个度量值（分组合计）
         </li>
         <li>
          第二个度量值
         </li>
         <li>
          差异值（第一个度量 - 第二个度量）
         </li>
         <li>
          百分比（差异值/第一个度量）
         </li>
        </ul>
       </li>
      </ul>
     </li>
    </ol>
    <p>
     示例输出：
    </p>
    <pre><code>维度字段1 维度字段2  度量字段1  度量字段2  差异值    百分比
A       X     150.00   120.00   30.00   20.00%
B       Y     200.00     0.00  200.00  100.00%
C       Z       0.00    80.00  -80.00    0.00%
</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f33303737373931332f:61727469636c652f64657461696c732f313436303931323237" class_="artid" style="display:none">
 </p>
</div>


