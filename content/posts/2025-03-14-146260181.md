---
layout: post
title: "基于动手学强化学习的知识点二第-15-章-模仿学习gym版本-0.26"
date: 2025-03-14 16:15:51 +0800
description: "第 15 章 模仿学习（gym版本 ＞= 0.26）"
keywords: "基于“动手学强化学习”的知识点（二）：第 15 章 模仿学习（gym版本 ＞= 0.26）"
categories: ['动手学强化学习']
tags: ['强化学习']
artid: "146260181"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146260181
    alt: "基于动手学强化学习的知识点二第-15-章-模仿学习gym版本-0.26"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146260181
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146260181
cover: https://bing.ee123.net/img/rand?artid=146260181
image: https://bing.ee123.net/img/rand?artid=146260181
img: https://bing.ee123.net/img/rand?artid=146260181
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     基于“动手学强化学习”的知识点（二）：第 15 章 模仿学习（gym版本 ＞= 0.26）
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <p>
    </p>
    <h2>
     <a id="_2">
     </a>
     摘要
    </h2>
    <p>
     本系列知识点讲解基于
     <a href="https://hrl.boyuai.com/chapter/1/%E5%88%9D%E6%8E%A2%E5%BC%BA%E5%8C%96%E5%AD%A6%E4%B9%A0" rel="nofollow">
      动手学强化学习
     </a>
     中的内容进行详细的疑难点分析！具体内容请阅读
     <a href="https://hrl.boyuai.com/chapter/1/%E5%88%9D%E6%8E%A2%E5%BC%BA%E5%8C%96%E5%AD%A6%E4%B9%A0" rel="nofollow">
      动手学强化学习
     </a>
     ！
    </p>
    <hr/>
    <p>
     对应
     <a href="https://hrl.boyuai.com/chapter/3/%E6%A8%A1%E4%BB%BF%E5%AD%A6%E4%B9%A0" rel="nofollow">
      动手学强化学习——模仿学习
     </a>
    </p>
    <hr/>
    <pre><code class="prism language-python"><span class="token comment"># -*- coding: utf-8 -*-</span>


<span class="token keyword">import</span> gym
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>functional <span class="token keyword">as</span> F
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">from</span> tqdm <span class="token keyword">import</span> tqdm
<span class="token keyword">import</span> random
<span class="token keyword">import</span> rl_utils


<span class="token keyword">class</span> <span class="token class-name">PolicyNet</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> state_dim<span class="token punctuation">,</span> hidden_dim<span class="token punctuation">,</span> action_dim<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>PolicyNet<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fc1 <span class="token operator">=</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>state_dim<span class="token punctuation">,</span> hidden_dim<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fc2 <span class="token operator">=</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>hidden_dim<span class="token punctuation">,</span> action_dim<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        x <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>fc1<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> F<span class="token punctuation">.</span>softmax<span class="token punctuation">(</span>self<span class="token punctuation">.</span>fc2<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">ValueNet</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> state_dim<span class="token punctuation">,</span> hidden_dim<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>ValueNet<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fc1 <span class="token operator">=</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>state_dim<span class="token punctuation">,</span> hidden_dim<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fc2 <span class="token operator">=</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>hidden_dim<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        x <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>fc1<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>fc2<span class="token punctuation">(</span>x<span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">PPO</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">''' PPO算法,采用截断方式 '''</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> state_dim<span class="token punctuation">,</span> hidden_dim<span class="token punctuation">,</span> action_dim<span class="token punctuation">,</span> actor_lr<span class="token punctuation">,</span> critic_lr<span class="token punctuation">,</span>
                 lmbda<span class="token punctuation">,</span> epochs<span class="token punctuation">,</span> eps<span class="token punctuation">,</span> gamma<span class="token punctuation">,</span> device<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>actor <span class="token operator">=</span> PolicyNet<span class="token punctuation">(</span>state_dim<span class="token punctuation">,</span> hidden_dim<span class="token punctuation">,</span> action_dim<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>critic <span class="token operator">=</span> ValueNet<span class="token punctuation">(</span>state_dim<span class="token punctuation">,</span> hidden_dim<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>actor_optimizer <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>self<span class="token punctuation">.</span>actor<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span>actor_lr<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>critic_optimizer <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>self<span class="token punctuation">.</span>critic<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span>critic_lr<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>gamma <span class="token operator">=</span> gamma
        self<span class="token punctuation">.</span>lmbda <span class="token operator">=</span> lmbda
        self<span class="token punctuation">.</span>epochs <span class="token operator">=</span> epochs  <span class="token comment"># 一条序列的数据用于训练轮数</span>
        self<span class="token punctuation">.</span>eps <span class="token operator">=</span> eps  <span class="token comment"># PPO中截断范围的参数</span>
        self<span class="token punctuation">.</span>device <span class="token operator">=</span> device

    <span class="token keyword">def</span> <span class="token function">take_action</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> <span class="token builtin">tuple</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            state <span class="token operator">=</span> state<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        state <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span>state<span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span>
        probs <span class="token operator">=</span> self<span class="token punctuation">.</span>actor<span class="token punctuation">(</span>state<span class="token punctuation">)</span>
        <span class="token triple-quoted-string string">'''根据概率分布创建一个离散分类分布对象，用于采样离散动作。
        离散的概率模型。
        '''</span>
        action_dist <span class="token operator">=</span> torch<span class="token punctuation">.</span>distributions<span class="token punctuation">.</span>Categorical<span class="token punctuation">(</span>probs<span class="token punctuation">)</span>
        action <span class="token operator">=</span> action_dist<span class="token punctuation">.</span>sample<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> action<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">update</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> transition_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>    
        
        processed_state <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> s <span class="token keyword">in</span> transition_dict<span class="token punctuation">[</span><span class="token string">'states'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token builtin">tuple</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token comment"># 如果元素是元组，则取元组的第一个元素</span>
                processed_state<span class="token punctuation">.</span>append<span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                processed_state<span class="token punctuation">.</span>append<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
        <span class="token comment"># states = torch.tensor(transition_dict['states'], dtype=torch.float).to(self.device)</span>
        states <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>processed_state<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span>
        actions <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>transition_dict<span class="token punctuation">[</span><span class="token string">'actions'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span>
        rewards <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>transition_dict<span class="token punctuation">[</span><span class="token string">'rewards'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span>
        next_states <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>transition_dict<span class="token punctuation">[</span><span class="token string">'next_states'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span>
        dones <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>transition_dict<span class="token punctuation">[</span><span class="token string">'dones'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span>
        <span class="token triple-quoted-string string">'''
        计算 TD 目标（即回归目标）：
                            td_target=r+γ×V(s′)×(1−done)
        '''</span>
        td_target <span class="token operator">=</span> rewards <span class="token operator">+</span> self<span class="token punctuation">.</span>gamma <span class="token operator">*</span> self<span class="token punctuation">.</span>critic<span class="token punctuation">(</span>next_states<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span>dones<span class="token punctuation">)</span>
        <span class="token triple-quoted-string string">'''计算 TD 残差（或优势估计的基础）：当前状态的 TD 目标减去当前 critic 估计的状态价值。'''</span>
        td_delta <span class="token operator">=</span> td_target <span class="token operator">-</span> self<span class="token punctuation">.</span>critic<span class="token punctuation">(</span>states<span class="token punctuation">)</span>
        <span class="token triple-quoted-string string">'''调用辅助函数（在 rl_utils 模块中定义）计算优势函数，通常使用广义优势估计（GAE）。'''</span>
        advantage <span class="token operator">=</span> rl_utils<span class="token punctuation">.</span>compute_advantage<span class="token punctuation">(</span>self<span class="token punctuation">.</span>gamma<span class="token punctuation">,</span> self<span class="token punctuation">.</span>lmbda<span class="token punctuation">,</span> td_delta<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span>
        <span class="token triple-quoted-string string">'''
        先将状态输入 actor 网络得到动作概率分布（例如 shape 为 (batch_size, action_dim)）。
        使用 .gather(1, actions) 选出每个样本所执行动作对应的概率（注意 actions 的形状必须匹配）。
        取对数得到旧的对数概率，再 detach() 阻断梯度流，保存旧策略下的概率值。
        '''</span>
        old_log_probs <span class="token operator">=</span> torch<span class="token punctuation">.</span>log<span class="token punctuation">(</span>self<span class="token punctuation">.</span>actor<span class="token punctuation">(</span>states<span class="token punctuation">)</span><span class="token punctuation">.</span>gather<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> actions<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>epochs<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token triple-quoted-string string">'''在当前策略下重新计算所有样本的对数概率，与旧对数概率进行比较。'''</span>
            log_probs <span class="token operator">=</span> torch<span class="token punctuation">.</span>log<span class="token punctuation">(</span>self<span class="token punctuation">.</span>actor<span class="token punctuation">(</span>states<span class="token punctuation">)</span><span class="token punctuation">.</span>gather<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> actions<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token triple-quoted-string string">'''计算概率比率，即新旧策略的概率之比，用于 PPO 的 clip 损失计算。'''</span>
            ratio <span class="token operator">=</span> torch<span class="token punctuation">.</span>exp<span class="token punctuation">(</span>log_probs <span class="token operator">-</span> old_log_probs<span class="token punctuation">)</span>
            <span class="token triple-quoted-string string">'''计算无截断的策略目标，乘上优势值。'''</span>
            surr1 <span class="token operator">=</span> ratio <span class="token operator">*</span> advantage
            <span class="token triple-quoted-string string">'''对 ratio 进行截断，确保其在 [1−ϵ,1+ϵ] 范围内（例如 [0.8, 1.2]），然后乘以优势。'''</span>
            surr2 <span class="token operator">=</span> torch<span class="token punctuation">.</span>clamp<span class="token punctuation">(</span>ratio<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">-</span> self<span class="token punctuation">.</span>eps<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">+</span> self<span class="token punctuation">.</span>eps<span class="token punctuation">)</span> <span class="token operator">*</span> advantage  <span class="token comment"># 截断</span>
            <span class="token triple-quoted-string string">'''PPO 算法的目标是最大化最小值，因此这里取两者中的较小值再取负号作为损失。对整个 batch 求均值。'''</span>
            actor_loss <span class="token operator">=</span> torch<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token operator">-</span>torch<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span>surr1<span class="token punctuation">,</span> surr2<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># PPO损失函数</span>
            <span class="token triple-quoted-string string">'''计算 critic 的均方误差（MSE）损失：当前 critic 估计与 TD 目标之间的误差，对整个 batch 取平均。'''</span>
            critic_loss <span class="token operator">=</span> torch<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>F<span class="token punctuation">.</span>mse_loss<span class="token punctuation">(</span>self<span class="token punctuation">.</span>critic<span class="token punctuation">(</span>states<span class="token punctuation">)</span><span class="token punctuation">,</span> td_target<span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>actor_optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>critic_optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
            actor_loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
            critic_loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>actor_optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>critic_optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>


actor_lr <span class="token operator">=</span> <span class="token number">1e-3</span>
critic_lr <span class="token operator">=</span> <span class="token number">1e-2</span>
num_episodes <span class="token operator">=</span> <span class="token number">250</span>
hidden_dim <span class="token operator">=</span> <span class="token number">128</span>
gamma <span class="token operator">=</span> <span class="token number">0.98</span>
lmbda <span class="token operator">=</span> <span class="token number">0.95</span>
epochs <span class="token operator">=</span> <span class="token number">10</span>
eps <span class="token operator">=</span> <span class="token number">0.2</span>
device <span class="token operator">=</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">"cuda"</span><span class="token punctuation">)</span> <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">"cpu"</span><span class="token punctuation">)</span>

env_name <span class="token operator">=</span> <span class="token string">'CartPole-v0'</span>
env <span class="token operator">=</span> gym<span class="token punctuation">.</span>make<span class="token punctuation">(</span>env_name<span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token string">'seed'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">seed_fn</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> seed<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        env<span class="token punctuation">.</span>reset<span class="token punctuation">(</span>seed<span class="token operator">=</span>seed<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span>seed<span class="token punctuation">]</span>
    env<span class="token punctuation">.</span>seed <span class="token operator">=</span> seed_fn<span class="token punctuation">.</span>__get__<span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># env.seed(0)</span>
torch<span class="token punctuation">.</span>manual_seed<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
state_dim <span class="token operator">=</span> env<span class="token punctuation">.</span>observation_space<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
action_dim <span class="token operator">=</span> env<span class="token punctuation">.</span>action_space<span class="token punctuation">.</span>n
ppo_agent <span class="token operator">=</span> PPO<span class="token punctuation">(</span>state_dim<span class="token punctuation">,</span> hidden_dim<span class="token punctuation">,</span> action_dim<span class="token punctuation">,</span> actor_lr<span class="token punctuation">,</span> critic_lr<span class="token punctuation">,</span> lmbda<span class="token punctuation">,</span> epochs<span class="token punctuation">,</span> eps<span class="token punctuation">,</span> gamma<span class="token punctuation">,</span> device<span class="token punctuation">)</span>

return_list <span class="token operator">=</span> rl_utils<span class="token punctuation">.</span>train_on_policy_agent<span class="token punctuation">(</span>env<span class="token punctuation">,</span> ppo_agent<span class="token punctuation">,</span> num_episodes<span class="token punctuation">)</span>



<span class="token keyword">def</span> <span class="token function">sample_expert_data</span><span class="token punctuation">(</span>n_episode<span class="token punctuation">)</span><span class="token punctuation">:</span>
    states <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    actions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> episode <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>n_episode<span class="token punctuation">)</span><span class="token punctuation">:</span>
        state <span class="token operator">=</span> env<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span>
        done <span class="token operator">=</span> <span class="token boolean">False</span>
        <span class="token keyword">while</span> <span class="token keyword">not</span> done<span class="token punctuation">:</span>
            action <span class="token operator">=</span> ppo_agent<span class="token punctuation">.</span>take_action<span class="token punctuation">(</span>state<span class="token punctuation">)</span>
            states<span class="token punctuation">.</span>append<span class="token punctuation">(</span>state<span class="token punctuation">)</span>
            actions<span class="token punctuation">.</span>append<span class="token punctuation">(</span>action<span class="token punctuation">)</span>
            result <span class="token operator">=</span> env<span class="token punctuation">.</span>step<span class="token punctuation">(</span>action<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">5</span><span class="token punctuation">:</span>
                next_state<span class="token punctuation">,</span> reward<span class="token punctuation">,</span> done<span class="token punctuation">,</span> truncated<span class="token punctuation">,</span> info <span class="token operator">=</span> result
                done <span class="token operator">=</span> done <span class="token keyword">or</span> truncated  <span class="token comment"># 可合并 terminated 和 truncated 标志</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                next_state<span class="token punctuation">,</span> reward<span class="token punctuation">,</span> done<span class="token punctuation">,</span> info <span class="token operator">=</span> result
            <span class="token comment"># next_state, reward, done, _ = env.step(action)</span>
            state <span class="token operator">=</span> next_state
    processed_states <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> s <span class="token keyword">in</span> states<span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token builtin">tuple</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># 如果元素是元组，则取元组的第一个元素</span>
            processed_states<span class="token punctuation">.</span>append<span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            processed_states<span class="token punctuation">.</span>append<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    <span class="token keyword">return</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>processed_states<span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>actions<span class="token punctuation">)</span>


<span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token string">'seed'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">seed_fn</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> seed<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        env<span class="token punctuation">.</span>reset<span class="token punctuation">(</span>seed<span class="token operator">=</span>seed<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span>seed<span class="token punctuation">]</span>
    env<span class="token punctuation">.</span>seed <span class="token operator">=</span> seed_fn<span class="token punctuation">.</span>__get__<span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># env.seed(0)</span>
torch<span class="token punctuation">.</span>manual_seed<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
random<span class="token punctuation">.</span>seed<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
n_episode <span class="token operator">=</span> <span class="token number">1</span>
expert_s<span class="token punctuation">,</span> expert_a <span class="token operator">=</span> sample_expert_data<span class="token punctuation">(</span>n_episode<span class="token punctuation">)</span>

n_samples <span class="token operator">=</span> <span class="token number">30</span>  <span class="token comment"># 采样30个数据</span>
random_index <span class="token operator">=</span> random<span class="token punctuation">.</span>sample<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span>expert_s<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> n_samples<span class="token punctuation">)</span>
expert_s <span class="token operator">=</span> expert_s<span class="token punctuation">[</span>random_index<span class="token punctuation">]</span>
expert_a <span class="token operator">=</span> expert_a<span class="token punctuation">[</span>random_index<span class="token punctuation">]</span>


<span class="token keyword">class</span> <span class="token class-name">BehaviorClone</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> state_dim<span class="token punctuation">,</span> hidden_dim<span class="token punctuation">,</span> action_dim<span class="token punctuation">,</span> lr<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>policy <span class="token operator">=</span> PolicyNet<span class="token punctuation">(</span>state_dim<span class="token punctuation">,</span> hidden_dim<span class="token punctuation">,</span> action_dim<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>optimizer <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>self<span class="token punctuation">.</span>policy<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span>lr<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">learn</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> states<span class="token punctuation">,</span> actions<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""解释：定义一个学习函数，接收一批专家数据中的状态和动作，用于更新策略网络。"""</span>
        states <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>states<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
        actions <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>actions<span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
        <span class="token triple-quoted-string string">'''
        - 将 states 输入 policy 网络，得到每个状态下所有动作的概率分布，
          假设输出形状为 (batch_size, action_dim)；
        - 使用 .gather(1, actions.long()) 从概率分布中取出对应专家动作的概率（注意动作需要转换为长整型索引）；
        - 对这些概率取对数，得到对数概率（log likelihood）。
        '''</span>
        log_probs <span class="token operator">=</span> torch<span class="token punctuation">.</span>log<span class="token punctuation">(</span>self<span class="token punctuation">.</span>policy<span class="token punctuation">(</span>states<span class="token punctuation">)</span><span class="token punctuation">.</span>gather<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> actions<span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># log_probs = torch.log(self.policy(states).gather(1, actions))</span>
        <span class="token triple-quoted-string string">'''计算行为克隆的损失，即负对数似然损失。对所有样本的负对数概率取均值。'''</span>
        bc_loss <span class="token operator">=</span> torch<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token operator">-</span>log_probs<span class="token punctuation">)</span>  <span class="token comment"># 最大似然估计</span>

        self<span class="token punctuation">.</span>optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
        bc_loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">take_action</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> <span class="token builtin">tuple</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            state <span class="token operator">=</span> state<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        state <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span>state<span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
        probs <span class="token operator">=</span> self<span class="token punctuation">.</span>policy<span class="token punctuation">(</span>state<span class="token punctuation">)</span>
        action_dist <span class="token operator">=</span> torch<span class="token punctuation">.</span>distributions<span class="token punctuation">.</span>Categorical<span class="token punctuation">(</span>probs<span class="token punctuation">)</span>
        action <span class="token operator">=</span> action_dist<span class="token punctuation">.</span>sample<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> action<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">test_agent</span><span class="token punctuation">(</span>agent<span class="token punctuation">,</span> env<span class="token punctuation">,</span> n_episode<span class="token punctuation">)</span><span class="token punctuation">:</span>
    return_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> episode <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>n_episode<span class="token punctuation">)</span><span class="token punctuation">:</span>
        episode_return <span class="token operator">=</span> <span class="token number">0</span>
        state <span class="token operator">=</span> env<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span>
        done <span class="token operator">=</span> <span class="token boolean">False</span>
        <span class="token keyword">while</span> <span class="token keyword">not</span> done<span class="token punctuation">:</span>
            action <span class="token operator">=</span> agent<span class="token punctuation">.</span>take_action<span class="token punctuation">(</span>state<span class="token punctuation">)</span>
            result <span class="token operator">=</span> env<span class="token punctuation">.</span>step<span class="token punctuation">(</span>action<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">5</span><span class="token punctuation">:</span>
                next_state<span class="token punctuation">,</span> reward<span class="token punctuation">,</span> done<span class="token punctuation">,</span> truncated<span class="token punctuation">,</span> info <span class="token operator">=</span> result
                done <span class="token operator">=</span> done <span class="token keyword">or</span> truncated  <span class="token comment"># 可合并 terminated 和 truncated 标志</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                next_state<span class="token punctuation">,</span> reward<span class="token punctuation">,</span> done<span class="token punctuation">,</span> info <span class="token operator">=</span> result
            <span class="token comment"># next_state, reward, done, _ = env.step(action)</span>
            state <span class="token operator">=</span> next_state
            episode_return <span class="token operator">+=</span> reward
        return_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>episode_return<span class="token punctuation">)</span>
    <span class="token keyword">return</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>return_list<span class="token punctuation">)</span>


<span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token string">'seed'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">seed_fn</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> seed<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        env<span class="token punctuation">.</span>reset<span class="token punctuation">(</span>seed<span class="token operator">=</span>seed<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span>seed<span class="token punctuation">]</span>
    env<span class="token punctuation">.</span>seed <span class="token operator">=</span> seed_fn<span class="token punctuation">.</span>__get__<span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># env.seed(0)</span>
torch<span class="token punctuation">.</span>manual_seed<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>seed<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

lr <span class="token operator">=</span> <span class="token number">1e-3</span>
bc_agent <span class="token operator">=</span> BehaviorClone<span class="token punctuation">(</span>state_dim<span class="token punctuation">,</span> hidden_dim<span class="token punctuation">,</span> action_dim<span class="token punctuation">,</span> lr<span class="token punctuation">)</span>
n_iterations <span class="token operator">=</span> <span class="token number">1000</span>
batch_size <span class="token operator">=</span> <span class="token number">64</span>
test_returns <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token keyword">with</span> tqdm<span class="token punctuation">(</span>total<span class="token operator">=</span>n_iterations<span class="token punctuation">,</span> desc<span class="token operator">=</span><span class="token string">"进度条"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> pbar<span class="token punctuation">:</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>n_iterations<span class="token punctuation">)</span><span class="token punctuation">:</span>
        sample_indices <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span>low<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> high<span class="token operator">=</span>expert_s<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> size<span class="token operator">=</span>batch_size<span class="token punctuation">)</span>
        bc_agent<span class="token punctuation">.</span>learn<span class="token punctuation">(</span>expert_s<span class="token punctuation">[</span>sample_indices<span class="token punctuation">]</span><span class="token punctuation">,</span> expert_a<span class="token punctuation">[</span>sample_indices<span class="token punctuation">]</span><span class="token punctuation">)</span>
        current_return <span class="token operator">=</span> test_agent<span class="token punctuation">(</span>bc_agent<span class="token punctuation">,</span> env<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
        test_returns<span class="token punctuation">.</span>append<span class="token punctuation">(</span>current_return<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">10</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            pbar<span class="token punctuation">.</span>set_postfix<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">'return'</span><span class="token punctuation">:</span> <span class="token string">'%.3f'</span> <span class="token operator">%</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>test_returns<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        pbar<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

iteration_list <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>test_returns<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>iteration_list<span class="token punctuation">,</span> test_returns<span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">'Iterations'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">'Returns'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'BC on {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>env_name<span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>






<span class="token keyword">class</span> <span class="token class-name">Discriminator</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> state_dim<span class="token punctuation">,</span> hidden_dim<span class="token punctuation">,</span> action_dim<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>Discriminator<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fc1 <span class="token operator">=</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>state_dim <span class="token operator">+</span> action_dim<span class="token punctuation">,</span> hidden_dim<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fc2 <span class="token operator">=</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>hidden_dim<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">:</span>
        cat <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">,</span> a<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        x <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>fc1<span class="token punctuation">(</span>cat<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> torch<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>self<span class="token punctuation">.</span>fc2<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
    
<span class="token keyword">class</span> <span class="token class-name">GAIL</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> agent<span class="token punctuation">,</span> state_dim<span class="token punctuation">,</span> action_dim<span class="token punctuation">,</span> hidden_dim<span class="token punctuation">,</span> lr_d<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>state_dim<span class="token punctuation">,</span> action_dim<span class="token punctuation">,</span> hidden_dim<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>discriminator <span class="token operator">=</span> Discriminator<span class="token punctuation">(</span>state_dim<span class="token punctuation">,</span> hidden_dim<span class="token punctuation">,</span> action_dim<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>discriminator_optimizer <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>self<span class="token punctuation">.</span>discriminator<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span>lr_d<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>agent <span class="token operator">=</span> agent

    <span class="token keyword">def</span> <span class="token function">learn</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> expert_s<span class="token punctuation">,</span> expert_a<span class="token punctuation">,</span> agent_s<span class="token punctuation">,</span> agent_a<span class="token punctuation">,</span> next_s<span class="token punctuation">,</span> dones<span class="token punctuation">)</span><span class="token punctuation">:</span>

        expert_states <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>expert_s<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
        expert_actions <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>expert_a<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>

        processed_state <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> s <span class="token keyword">in</span> agent_s<span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token builtin">tuple</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token comment"># 如果元素是元组，则取元组的第一个元素</span>
                processed_state<span class="token punctuation">.</span>append<span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                processed_state<span class="token punctuation">.</span>append<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
        agent_states <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>processed_state<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
        agent_actions <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>agent_a<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
        <span class="token triple-quoted-string string">'''作用：将专家动作转换为 one-hot 编码形式，转换为浮点数。'''</span>
        expert_actions <span class="token operator">=</span> F<span class="token punctuation">.</span>one_hot<span class="token punctuation">(</span>expert_actions<span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> num_classes<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        agent_actions <span class="token operator">=</span> F<span class="token punctuation">.</span>one_hot<span class="token punctuation">(</span>agent_actions<span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> num_classes<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        expert_prob <span class="token operator">=</span> self<span class="token punctuation">.</span>discriminator<span class="token punctuation">(</span>expert_states<span class="token punctuation">,</span> expert_actions<span class="token punctuation">)</span>
        agent_prob <span class="token operator">=</span> self<span class="token punctuation">.</span>discriminator<span class="token punctuation">(</span>agent_states<span class="token punctuation">,</span> agent_actions<span class="token punctuation">)</span>
        <span class="token triple-quoted-string string">'''
        作用：计算二元交叉熵损失（BCE）：
        - 对 agent 数据，目标标签设为 1（即希望判别器认为 agent 数据为“真”），
          损失为 BCE(agent_prob, 1)；
        - 对专家数据，目标标签设为 0（希望判别器认为专家数据为“假”），
          损失为 BCE(expert_prob, 0)。
        - 然后将两部分损失相加。
        '''</span>
        discriminator_loss <span class="token operator">=</span> nn<span class="token punctuation">.</span>BCELoss<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>
            agent_prob<span class="token punctuation">,</span> torch<span class="token punctuation">.</span>ones_like<span class="token punctuation">(</span>agent_prob<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> nn<span class="token punctuation">.</span>BCELoss<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>
                expert_prob<span class="token punctuation">,</span> torch<span class="token punctuation">.</span>zeros_like<span class="token punctuation">(</span>expert_prob<span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>discriminator_optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
        discriminator_loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>discriminator_optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token triple-quoted-string string">'''
        作用：利用判别器对 agent 数据输出计算奖励：
        - 计算 –log(agent_prob) 作为奖励信号（当 agent_prob 较小时，奖励较高，鼓励 agent 模仿专家）；
        - detach() 阻断梯度，转移到 CPU 并转换为 numpy 数组，方便后续传入 agent.update。
        '''</span>
        rewards <span class="token operator">=</span> <span class="token operator">-</span>torch<span class="token punctuation">.</span>log<span class="token punctuation">(</span>agent_prob<span class="token punctuation">)</span><span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>
        transition_dict <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">'states'</span><span class="token punctuation">:</span> agent_s<span class="token punctuation">,</span>
            <span class="token string">'actions'</span><span class="token punctuation">:</span> agent_a<span class="token punctuation">,</span>
            <span class="token string">'rewards'</span><span class="token punctuation">:</span> rewards<span class="token punctuation">,</span>
            <span class="token string">'next_states'</span><span class="token punctuation">:</span> next_s<span class="token punctuation">,</span>
            <span class="token string">'dones'</span><span class="token punctuation">:</span> dones
        <span class="token punctuation">}</span>
        self<span class="token punctuation">.</span>agent<span class="token punctuation">.</span>update<span class="token punctuation">(</span>transition_dict<span class="token punctuation">)</span>



<span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token string">'seed'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">seed_fn</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> seed<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        env<span class="token punctuation">.</span>reset<span class="token punctuation">(</span>seed<span class="token operator">=</span>seed<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span>seed<span class="token punctuation">]</span>
    env<span class="token punctuation">.</span>seed <span class="token operator">=</span> seed_fn<span class="token punctuation">.</span>__get__<span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># env.seed(0)</span>
torch<span class="token punctuation">.</span>manual_seed<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
lr_d <span class="token operator">=</span> <span class="token number">1e-3</span>
agent <span class="token operator">=</span> PPO<span class="token punctuation">(</span>state_dim<span class="token punctuation">,</span> hidden_dim<span class="token punctuation">,</span> action_dim<span class="token punctuation">,</span> actor_lr<span class="token punctuation">,</span> critic_lr<span class="token punctuation">,</span> lmbda<span class="token punctuation">,</span> epochs<span class="token punctuation">,</span> eps<span class="token punctuation">,</span> gamma<span class="token punctuation">,</span> device<span class="token punctuation">)</span>
gail <span class="token operator">=</span> GAIL<span class="token punctuation">(</span>agent<span class="token punctuation">,</span> state_dim<span class="token punctuation">,</span> action_dim<span class="token punctuation">,</span> hidden_dim<span class="token punctuation">,</span> lr_d<span class="token punctuation">)</span>
n_episode <span class="token operator">=</span> <span class="token number">500</span>
return_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token keyword">with</span> tqdm<span class="token punctuation">(</span>total<span class="token operator">=</span>n_episode<span class="token punctuation">,</span> desc<span class="token operator">=</span><span class="token string">"进度条"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> pbar<span class="token punctuation">:</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>n_episode<span class="token punctuation">)</span><span class="token punctuation">:</span>
        episode_return <span class="token operator">=</span> <span class="token number">0</span>
        state <span class="token operator">=</span> env<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span>
        done <span class="token operator">=</span> <span class="token boolean">False</span>
        state_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        action_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        next_state_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        done_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">while</span> <span class="token keyword">not</span> done<span class="token punctuation">:</span>
            action <span class="token operator">=</span> agent<span class="token punctuation">.</span>take_action<span class="token punctuation">(</span>state<span class="token punctuation">)</span>
            result <span class="token operator">=</span> env<span class="token punctuation">.</span>step<span class="token punctuation">(</span>action<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">5</span><span class="token punctuation">:</span>
                next_state<span class="token punctuation">,</span> reward<span class="token punctuation">,</span> done<span class="token punctuation">,</span> truncated<span class="token punctuation">,</span> info <span class="token operator">=</span> result
                done <span class="token operator">=</span> done <span class="token keyword">or</span> truncated  <span class="token comment"># 可合并 terminated 和 truncated 标志</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                next_state<span class="token punctuation">,</span> reward<span class="token punctuation">,</span> done<span class="token punctuation">,</span> info <span class="token operator">=</span> result
            <span class="token comment"># next_state, reward, done, _ = env.step(action)</span>
            state_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>state<span class="token punctuation">)</span>
            action_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>action<span class="token punctuation">)</span>
            next_state_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>next_state<span class="token punctuation">)</span>
            done_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>done<span class="token punctuation">)</span>
            state <span class="token operator">=</span> next_state
            episode_return <span class="token operator">+=</span> reward
        return_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>episode_return<span class="token punctuation">)</span>
        gail<span class="token punctuation">.</span>learn<span class="token punctuation">(</span>expert_s<span class="token punctuation">,</span> expert_a<span class="token punctuation">,</span> state_list<span class="token punctuation">,</span> action_list<span class="token punctuation">,</span> next_state_list<span class="token punctuation">,</span> done_list<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">10</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            pbar<span class="token punctuation">.</span>set_postfix<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">'return'</span><span class="token punctuation">:</span> <span class="token string">'%.3f'</span> <span class="token operator">%</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>return_list<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        pbar<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    
    
    
iteration_list <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>return_list<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>iteration_list<span class="token punctuation">,</span> return_list<span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">'Episodes'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">'Returns'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'GAIL on {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>env_name<span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f:672e6373646e2e6e65742f787a73313231303635323633362f:61727469636c652f64657461696c732f313436323630313831" class_="artid" style="display:none">
 </p>
</div>


