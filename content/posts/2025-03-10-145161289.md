---
layout: post
title: "Linux第六讲进程控制"
date: 2025-03-10 21:40:37 +0800
description: "Linux第六讲：进程控制"
keywords: "Linux第六讲：进程控制"
categories: ['Linux']
tags: ['服务器', 'Linux', 'Java']
artid: "145161289"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=145161289
    alt: "Linux第六讲进程控制"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=145161289
featuredImagePreview: https://bing.ee123.net/img/rand?artid=145161289
cover: https://bing.ee123.net/img/rand?artid=145161289
image: https://bing.ee123.net/img/rand?artid=145161289
img: https://bing.ee123.net/img/rand?artid=145161289
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Linux第六讲：进程控制
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <p>
    </p>
    <h2>
     <a id="1_1">
     </a>
     1.进程创建
    </h2>
    <h3>
     <a id="11fork_2">
     </a>
     1.1回顾fork
    </h3>
    <blockquote>
     <p>
      fork之前已经讲过了，所以这里我们就简单回顾一下fork：
      <br/>
      fork：创建子进程，父进程返回父进程的pid，子进程返回0，失败返回-1
      <br/>
      总结fork内核（OS）工作原理：
      <br/>
      1.为子进程分配PCB和页表，以及内存块
      <br/>
      2.将父进程的部分数据（页表数据、PCB数据）拷贝给子进程
      <br/>
      3.将子进程添加到系统的进程列表中
      <br/>
      4.fork返回，开始调度器调度
     </p>
    </blockquote>
    <pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token class-name">pid_t</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
返回值：⾃进程中返回<span class="token number">0</span>，⽗进程返回⼦进程id，出错返回<span class="token operator">-</span><span class="token number">1</span>
</code></pre>
    <h3>
     <a id="12_16">
     </a>
     1.2写时拷贝
    </h3>
    <blockquote>
     <p>
      1.写时拷贝的原理为：
      <br/>
      子进程拷贝父进程页表之后，OS会将父进程和子进程所有的代码块的权限设置为只读权限，子进程修改数据时，只读权限，操作系统会发生报错（不是真的报错），有多种情况需要分析，当OS分析，有虚拟地址，有物理地址，访问的数据是数据段的内容，不是代码段的内容，那么就触发写时拷贝，其它情况（缺页中断）就有其它的解决方案
      <br/>
      2.写时拷贝的好处有：
      <br/>
      减少子进程的创建时间、减少空间浪费
     </p>
    </blockquote>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/49dbb0ac0f534f06a5922592e2deeeec.png"/>
    </p>
    <h2>
     <a id="2_23">
     </a>
     2.进程终止
    </h2>
    <blockquote>
     <p>
      进程退出有三种情况：
      <br/>
      1.进程正常执行，结果正常
      <br/>
      2.进程正常执行，结果错误
      <br/>
      3.进程异常终止
      <br/>
      而进程的结果要被父进程拿到，需要靠退出码，退出码为0表示正常，退出码为非0表示不同的出错原因（echo $?可以查看最近一次进程的退出码
     </p>
    </blockquote>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/5caa7f79497e4a8a8bc8845a558358ee.png">
      <br/>
      我们可以使用strerror拿到所有的退出码对应的错误信息：
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/232a881d2e2f4a46b75d738a1a3bdb42.png">
       <br/>
       <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/5e548e8e5aef404e8be50192a0331d3f.png"/>
      </img>
     </img>
    </p>
    <h3>
     <a id="21exit_exit_34">
     </a>
     2.1exit与_exit
    </h3>
    <blockquote>
     <p>
      我们不只可以使用return来终止进程，还可以使用exit和_exit来终止进程，他们两个被放在任意位置都可以终止进程，但是它们的区别在于exit是C标准库中的函数，_exit是系统调用的函数，exit里面封装了_exit，调用_exit之前会对缓冲区进行刷新
     </p>
    </blockquote>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/61b8ebadc694450a86858e7fcb02e3c6.png"/>
    </p>
    <h2>
     <a id="3_38">
     </a>
     3.进程等待
    </h2>
    <blockquote>
     <p>
      为什么需要进程等待：
      <br/>
      1.子进程退出之后，如果父进程什么也不做，就会导致僵尸进程（只有子进程的PCB），进而导致内存泄漏，而kill -9也无法杀掉该子进程，因为该进程已经是死去的进程了
      <br/>
      2.父进程需要关心子进程的执行结果，获取子进程的退出信息
      <br/>
      3.这是最重要的一点：也就是需要回收子进程的资源
     </p>
    </blockquote>
    <h3>
     <a id="31waitwaitpid_43">
     </a>
     3.1进程等待的方法（wait和waitpid）
    </h3>
    <blockquote>
     <p>
      wait： pid_t wait(int* status)
      <br/>
      1.等待任意一个子进程的结束，成功后，解决子进程的僵尸问题，并返回子进程的pid，失败，返回-1
      <br/>
      2.如果等待子进程，父进程会阻塞在wait调用处
      <br/>
      waitpid： pid_t waitpid(pid_t pid, int* status, int options)
      <br/>
      1.pid：-1表示等待任意的子进程，&gt;1表示等待特定pid的子进程
      <br/>
      2.status：输出型参数，通常只有低16位保存有信息，高8位：退出码（错误码），第7位： core dump，其余7位：退出状态（终止信号），需要注意的是对于退出码和终止信号的提取（位运算或者是宏）
      <br/>
      3.options：两个选项：1.0，默认为阻塞调用 2.NOHANG，表示非阻塞调用
     </p>
    </blockquote>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/73c6d0734a274a89815ddc23340cbd65.png"/>
    </p>
    <pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span>

<span class="token comment">//函数指针类型</span>
<span class="token keyword">typedef</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token class-name">func_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NUM</span> <span class="token expression"><span class="token number">5</span></span></span>
<span class="token class-name">func_t</span> handlers<span class="token punctuation">[</span>NUM<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">//注册</span>
<span class="token keyword">void</span> <span class="token function">registerHandler</span><span class="token punctuation">(</span><span class="token class-name">func_t</span> h<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token class-name">func_t</span> t<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span> <span class="token punctuation">;</span> i<span class="token operator">&lt;</span>NUM<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>h<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    h<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> t<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>i <span class="token operator">==</span> NUM<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//下面是任务</span>
<span class="token keyword">void</span> <span class="token function">Download</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"这是一个下载任务\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">Flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"这是一个刷新任务\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">Log</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"这是一个记录日志任务\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">registerHandler</span><span class="token punctuation">(</span>handlers<span class="token punctuation">,</span> Download<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">registerHandler</span><span class="token punctuation">(</span>handlers<span class="token punctuation">,</span> Flush<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">registerHandler</span><span class="token punctuation">(</span>handlers<span class="token punctuation">,</span> Log<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">pid_t</span> id <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>id <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//子进程</span>
        <span class="token keyword">int</span> cnt <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span>cnt<span class="token operator">--</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"我是一个子进程，pid：%d，ppid：%d\n"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getppid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//int b = 1/0;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//父进程</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> status <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token class-name">pid_t</span> rid <span class="token operator">=</span> <span class="token function">waitpid</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token operator">&amp;</span>status<span class="token punctuation">,</span> WNOHANG<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>rid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//printf("wait success: id: %d, exit code: %d, exit singal: %d\n", rid, (status&gt;&gt;8)&amp;0xFF, status&amp;0x7F);</span>
            <span class="token comment">//printf("wait success: id: %d, exit code: %d, exit singal: %d\n", rid, (status&gt;&gt;8)&amp;0xFF, WIFEXITED(status));</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"wait success: id: %d, exit code: %d, exit singal: %d\n"</span><span class="token punctuation">,</span> rid<span class="token punctuation">,</span> <span class="token function">WEXITSTATUS</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">WIFEXITED</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>rid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span> <span class="token punctuation">;</span> handlers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                handlers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"本轮调用结束，子进程没有退出\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//printf("wait success: id: %d, exit code: %d, exit singal: %d\n", rid, (status&gt;&gt;8)&amp;0xFF, status&amp;0x7F);</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"wait unsuccess: rid: %d\n"</span><span class="token punctuation">,</span> rid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h2>
     <a id="4_145">
     </a>
     4.进程程序替换
    </h2>
    <blockquote>
     <p>
      每一个进程都有它的PCB和它的代码和数据，而进程程序替换的本质就是将需要进行替换的进程的代码和数据与现在正在进行的进程的代码和数据进行替换，所以说，一旦发生了进程程序替换，那么原始的代码和数据就被替换，不复存在了，下面我们讲一下关于进程程序替换相关的exec系列函数，注意：exec系列函数只有出错时才会有返回值，返回值为-1，但是一般不需要作返回值判断，因为如果进行了返回，那么就是出错了：
     </p>
    </blockquote>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/601781ed9b1244fabef924b79b010c67.png"/>
    </p>
    <h3>
     <a id="41shell_149">
     </a>
     4.1自定义shell的编写
    </h3>
    <h4>
     <a id="411_150">
     </a>
     4.1.1输出命令行提示符
    </h4>
    <p>
     我们自己的shell中，输入指令之前都会给出一个提示符，所以我们自己实现的shell也要初始命令行提示符：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/4594d3eae7054ee5a397964365d864ff.png">
      <br/>
      对于这些信息，可以在env中找到：
     </img>
    </p>
    <pre><code class="prism language-cpp"><span class="token comment">//输出命令行提示符</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">COMMAND_SIZE</span> <span class="token expression"><span class="token number">1024</span> </span><span class="token comment">//假设命令行可以传入1024字节内容</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FORMAT</span> <span class="token string">"[%s@%s %s]# "</span> <span class="token comment">//snprintf输出格式</span></span>
<span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token function">GetUserName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> ret <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"USER"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ret <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">?</span> <span class="token string">"NULL"</span> <span class="token operator">:</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token function">GetHostName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> ret <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"HOSTNAME"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ret <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">?</span> <span class="token string">"NULL"</span> <span class="token operator">:</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token function">GetPWD</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> ret <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"PWD"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ret <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">?</span> <span class="token string">"NULL"</span> <span class="token operator">:</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//向out数组中写入命令行提示字符串</span>
<span class="token keyword">void</span> <span class="token function">MakeCommandLine</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> out<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//snprintf(char *str, size_t size, const char *format, ...); </span>
    <span class="token function">snprintf</span><span class="token punctuation">(</span>out<span class="token punctuation">,</span> size<span class="token punctuation">,</span> FORMAT<span class="token punctuation">,</span> <span class="token function">GetUserName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">GetHostName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">GetPWD</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">PrintCommandPrompt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span> commandline<span class="token punctuation">[</span>COMMAND_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">MakeCommandLine</span><span class="token punctuation">(</span>commandline<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>commandline<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> commandline<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//1.输出命令行提示符</span>
    <span class="token function">PrintCommandPrompt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="412_197">
     </a>
     4.1.2获取用户输入的命令
    </h4>
    <p>
     我们需要直到用户想要执行什么命令，才能够进行输出
    </p>
    <pre><code class="prism language-cpp"><span class="token comment">//2.获取用户输入的命令，将输入的命令，填写到数组中</span>
<span class="token keyword">bool</span> <span class="token function">GetCommandLine</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> out<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span><span class="token operator">*</span> c <span class="token operator">=</span> <span class="token function">fgets</span><span class="token punctuation">(</span>out<span class="token punctuation">,</span> size<span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//不能使用scanf</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    out<span class="token punctuation">[</span><span class="token function">strlen</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//清理最后一个\n，否则输入之后会自动换行</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//1.输出命令行提示符</span>
        <span class="token function">PrintCommandPrompt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">//2.获取用户输入的命令</span>
        <span class="token keyword">char</span> commandline<span class="token punctuation">[</span>COMMAND_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">GetCommandLine</span><span class="token punctuation">(</span>commandline<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>commandline<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span><span class="token comment">//如果获取失败，重新获取</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="413_226">
     </a>
     4.1.3命令行分析
    </h4>
    <p>
     知道用户输入什么命令之后，我们需要对用户输入的命令进行解析：
    </p>
    <pre><code class="prism language-cpp"><span class="token comment">//3.命令行解析</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAXARGC</span> <span class="token expression"><span class="token number">128</span></span></span>
<span class="token keyword">char</span><span class="token operator">*</span> g_argv<span class="token punctuation">[</span>MAXARGC<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> g_argc<span class="token punctuation">;</span>
<span class="token keyword">bool</span> <span class="token function">CommandPrase</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> commandline<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SEP</span> <span class="token string">" "</span></span>
    g_argc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    g_argv<span class="token punctuation">[</span>g_argc<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">strtok</span><span class="token punctuation">(</span>commandline<span class="token punctuation">,</span> SEP<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//strtok的作用为将commandline数组中的内容以SEP字符分割</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">bool</span><span class="token punctuation">)</span><span class="token punctuation">(</span>g_argv<span class="token punctuation">[</span>g_argc<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">strtok</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> SEP<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//之后传入null继续分割</span>
    g_argc<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//打印输入的命令是否正确</span>
<span class="token keyword">void</span> <span class="token function">Print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>g_argc<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"g_argv[%d]:%s\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> g_argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//1.输出命令行提示符</span>
        <span class="token function">PrintCommandPrompt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">//2.获取用户输入的命令</span>
        <span class="token keyword">char</span> commandline<span class="token punctuation">[</span>COMMAND_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">GetCommandLine</span><span class="token punctuation">(</span>commandline<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>commandline<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span><span class="token comment">//如果获取失败，重新获取</span>
        
        <span class="token comment">//3.命令行解析</span>
        <span class="token function">CommandPrase</span><span class="token punctuation">(</span>commandline<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">Print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="414_273">
     </a>
     4.1.4指令执行
    </h4>
    <p>
     拿到了指令之后，需要执行指令，执行指令需要用到之前学过的exec系列接口了，那么应该选择哪一种接口呢？1.有了argv表，首先排除带l的接口，2.不关心env，排除e接口，3.不需要传入完整的路径，所以最终选择execvp进行指令的执行：
    </p>
    <pre><code class="prism language-cpp"><span class="token comment">//4.指令的执行</span>
<span class="token keyword">int</span> <span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    pid_t id <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>id <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">execvp</span><span class="token punctuation">(</span>g_argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> g_argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    pid_t rid <span class="token operator">=</span> <span class="token function">waitpid</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>rid<span class="token punctuation">;</span><span class="token comment">//防止提示，使用一下</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//1.输出命令行提示符</span>
        <span class="token function">PrintCommandPrompt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">//2.获取用户输入的命令</span>
        <span class="token keyword">char</span> commandline<span class="token punctuation">[</span>COMMAND_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">GetCommandLine</span><span class="token punctuation">(</span>commandline<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>commandline<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span><span class="token comment">//如果获取失败，重新获取</span>
        
        <span class="token comment">//3.命令行解析</span>
        <span class="token function">CommandPrase</span><span class="token punctuation">(</span>commandline<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//Print();</span>

        <span class="token comment">//4.指令的执行</span>
        <span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="415_313">
     </a>
     4.1.5问题演示
    </h4>
    <p>
     写出的myshell并没有什么大的问题，但是有的指令并不能正常执行：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/38bbeaa387cb48e0a12c646240cd52c2.png"/>
     <br/>
     cd、echo等命令属于内建命令，内建命令需要shell自己处理，所以对于内建命令，必须要进行特殊处理：
    </p>
    <h5>
     <a id="4151cd_317">
     </a>
     4.1.5.1cd内建命令处理
    </h5>
    <pre><code class="prism language-cpp"><span class="token comment">//4.内建命令特殊处理</span>
<span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token function">GetHome</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> ret <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"HOME"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ret <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">?</span> <span class="token string">""</span> <span class="token operator">:</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> <span class="token function">Cd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>g_argc <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> 
    <span class="token punctuation">{<!-- --></span>
        std<span class="token double-colon punctuation">::</span>string home <span class="token operator">=</span> <span class="token function">GetHome</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>home<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token function">chdir</span><span class="token punctuation">(</span>home<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
        std<span class="token double-colon punctuation">::</span>string where <span class="token operator">=</span> g_argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>where <span class="token operator">==</span> <span class="token string">"~"</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>

        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>where <span class="token operator">==</span> <span class="token string">"-"</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> 
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">chdir</span><span class="token punctuation">(</span>where<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">Echo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>

<span class="token punctuation">}</span>

<span class="token keyword">bool</span> <span class="token function">CheckAndExecBuiltin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>string cmd <span class="token operator">=</span> g_argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>cmd <span class="token operator">==</span> <span class="token string">"cd"</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">Cd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>cmd <span class="token operator">==</span> <span class="token string">"echo"</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">Echo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>cmd <span class="token operator">==</span> <span class="token string">"export"</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>

    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>cmd <span class="token operator">==</span> <span class="token string">"alias"</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>

    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//1.输出命令行提示符</span>
        <span class="token function">PrintCommandPrompt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">//2.获取用户输入的命令</span>
        <span class="token keyword">char</span> commandline<span class="token punctuation">[</span>COMMAND_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">GetCommandLine</span><span class="token punctuation">(</span>commandline<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>commandline<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span><span class="token comment">//如果获取失败，重新获取</span>
        
        <span class="token comment">//3.命令行解析</span>
        <span class="token function">CommandPrase</span><span class="token punctuation">(</span>commandline<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//Print();</span>

        <span class="token comment">//4.对于内建命令，要进行特殊处理</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CheckAndExecBuiltin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span><span class="token comment">//如果是内建命令的话，就不需要下面的指令执行了</span>

        <span class="token comment">//5.指令的执行</span>
        <span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/0a61f13534064470ae137c554444cdcf.png"/>
     <br/>
     可以看到，确实是切换了路径，但是命令行提示符并没有发生改变，而且使用env进行对比时，env也并没有发生变化，原因是：调用chdir命令之后，并没有对环境变量进行更新，导致拿到的pwd还是旧的环境变量，所以我们需要进行环境变量的更新操作：
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">char</span> cwd<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">char</span> cwdenv<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token function">GetPWD</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//consti char* ret = getenv("PWD");</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> ret <span class="token operator">=</span> <span class="token function">getcwd</span><span class="token punctuation">(</span>cwd<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>cwd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//函数作用为将现在的pwd写入到cwd数组中</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
    	<span class="token comment">//更新环境变量</span>
        <span class="token function">snprintf</span><span class="token punctuation">(</span>cwdenv<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>cwdenv<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"PWD=%s"</span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">putenv</span><span class="token punctuation">(</span>cwdenv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> ret <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">?</span> <span class="token string">"NULL"</span> <span class="token operator">:</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h5>
     <a id="4152_431">
     </a>
     4.1.5.2环境变量表的实现
    </h5>
    <p>
     shell中有自己的命令行参数表，我们已经实现过了（g_argc, g_argv[]），这张表可以让子进程拿到（因为是全局的），子进程就可以根据拿到的命令行指令执行相应的操作。还应该有一张环境变量表，这样每一个子进程都可以拿到环境变量了，即使不进行环境变量的传递：
    </p>
    <pre><code class="prism language-cpp"><span class="token comment">//0.环境变量表的实现</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_ENVS</span> <span class="token expression"><span class="token number">100</span></span></span>
<span class="token keyword">char</span><span class="token operator">*</span> g_env<span class="token punctuation">[</span>MAX_ENVS<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> g_envs <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">//对环境变量表进行初始化</span>
<span class="token keyword">void</span> <span class="token function">Init_ENV</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//本来是需要在配置文件中拿到环境变量的，但是我们只需要知道怎么从父进程拿到即可</span>
    <span class="token keyword">extern</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> environ<span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>g_env<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>g_env<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    g_envs <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">//1.获取环境变量</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> environ<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        g_env<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>environ<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">strcpy</span><span class="token punctuation">(</span>g_env<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> environ<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        g_envs<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    g_env<span class="token punctuation">[</span>g_envs<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token comment">//2.导入环境变量</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> g_env<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">putenv</span><span class="token punctuation">(</span>g_env<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    environ <span class="token operator">=</span> g_env<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h5>
     <a id="4153echo_463">
     </a>
     4.1.5.3echo内建命令的实现
    </h5>
    <pre><code class="prism language-cpp"><span class="token keyword">int</span> lastcode <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//保存最近一次进程的结束码</span>
<span class="token keyword">void</span> <span class="token function">Echo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>g_argc <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// echo "hello world"</span>
        <span class="token comment">// echo $?</span>
        <span class="token comment">// echo $PATH</span>
        std<span class="token double-colon punctuation">::</span>string opt <span class="token operator">=</span> g_argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>opt <span class="token operator">==</span> <span class="token string">"$?"</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> lastcode <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
            lastcode <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>opt<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'$'</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            std<span class="token double-colon punctuation">::</span>string env_name <span class="token operator">=</span> opt<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>env_value <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span>env_name<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>env_value<span class="token punctuation">)</span>
                std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> env_value <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{<!-- --></span>
            std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> opt <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>

<span class="token comment">//5.指令的执行</span>
<span class="token keyword">int</span> <span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    pid_t id <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>id <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">execvp</span><span class="token punctuation">(</span>g_argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> g_argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span> status <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    pid_t rid <span class="token operator">=</span> <span class="token function">waitpid</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>status<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>rid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        lastcode <span class="token operator">=</span> <span class="token function">WEXITSTATUS</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//这里要更新退出码</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h2>
     <a id="5shell_512">
     </a>
     5.自定义shell完整代码实现
    </h2>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>

<span class="token comment">//0.环境变量表的实现</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_ENVS</span> <span class="token expression"><span class="token number">100</span></span></span>
<span class="token keyword">char</span><span class="token operator">*</span> g_env<span class="token punctuation">[</span>MAX_ENVS<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> g_envs <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">//对环境变量表进行初始化</span>
<span class="token keyword">void</span> <span class="token function">Init_ENV</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//本来是需要在配置文件中拿到环境变量的，但是我们只需要知道怎么从父进程拿到即可</span>
    <span class="token keyword">extern</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> environ<span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>g_env<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>g_env<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    g_envs <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">//1.获取环境变量</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> environ<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        g_env<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>environ<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">strcpy</span><span class="token punctuation">(</span>g_env<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> environ<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        g_envs<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    g_env<span class="token punctuation">[</span>g_envs<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token comment">//2.导入环境变量</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> g_env<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">putenv</span><span class="token punctuation">(</span>g_env<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    environ <span class="token operator">=</span> g_env<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//1.输出命令行提示符</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">COMMAND_SIZE</span> <span class="token expression"><span class="token number">1024</span> </span><span class="token comment">//假设命令行可以传入1024字节内容</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FORMAT</span> <span class="token string">"[%s@%s %s]# "</span> <span class="token comment">//snprintf输出格式</span></span>
<span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token function">GetUserName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> ret <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"USER"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ret <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">?</span> <span class="token string">"NULL"</span> <span class="token operator">:</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token function">GetHostName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> ret <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"HOSTNAME"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ret <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">?</span> <span class="token string">"NULL"</span> <span class="token operator">:</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">char</span> cwd<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">char</span> cwdenv<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token function">GetPWD</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//consti char* ret = getenv("PWD");</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> ret <span class="token operator">=</span> <span class="token function">getcwd</span><span class="token punctuation">(</span>cwd<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>cwd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//函数作用为将现在的pwd写入到cwd数组中</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">snprintf</span><span class="token punctuation">(</span>cwdenv<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>cwdenv<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"PWD=%s"</span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">putenv</span><span class="token punctuation">(</span>cwdenv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> ret <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">?</span> <span class="token string">"NULL"</span> <span class="token operator">:</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//截取pwd，否则命令行提示的pwd显示太多</span>
std<span class="token double-colon punctuation">::</span>string <span class="token function">DirName</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> pwd<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SLASH</span> <span class="token string">"/"</span></span>
    std<span class="token double-colon punctuation">::</span>string dir <span class="token operator">=</span> pwd<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>dir <span class="token operator">==</span> SLASH<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">"SLASH"</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> pos <span class="token operator">=</span> dir<span class="token punctuation">.</span><span class="token function">rfind</span><span class="token punctuation">(</span>SLASH<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>pos <span class="token operator">==</span> std<span class="token double-colon punctuation">::</span>string<span class="token double-colon punctuation">::</span>npos<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">"FALSE"</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> dir<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span>pos<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//向out数组中写入命令行提示字符串</span>
<span class="token keyword">void</span> <span class="token function">MakeCommandLine</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> out<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//snprintf(char *str, size_t size, const char *format, ...); </span>
    <span class="token function">snprintf</span><span class="token punctuation">(</span>out<span class="token punctuation">,</span> size<span class="token punctuation">,</span> FORMAT<span class="token punctuation">,</span> <span class="token function">GetUserName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">GetHostName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">DirName</span><span class="token punctuation">(</span><span class="token function">GetPWD</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//snprintf(out, size, FORMAT, GetUserName(), GetHostName(), GetPWD());</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">PrintCommandPrompt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span> commandline<span class="token punctuation">[</span>COMMAND_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">MakeCommandLine</span><span class="token punctuation">(</span>commandline<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>commandline<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> commandline<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//2.获取用户输入的命令，将输入的命令，填写到数组中</span>
<span class="token keyword">bool</span> <span class="token function">GetCommandLine</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> out<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span><span class="token operator">*</span> c <span class="token operator">=</span> <span class="token function">fgets</span><span class="token punctuation">(</span>out<span class="token punctuation">,</span> size<span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//不能使用scanf</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    out<span class="token punctuation">[</span><span class="token function">strlen</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//清理最后一个\n，否则输入之后会自动换行</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//3.命令行解析</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAXARGC</span> <span class="token expression"><span class="token number">128</span></span></span>
<span class="token keyword">char</span><span class="token operator">*</span> g_argv<span class="token punctuation">[</span>MAXARGC<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> g_argc<span class="token punctuation">;</span>
<span class="token keyword">bool</span> <span class="token function">CommandPrase</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> commandline<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SEP</span> <span class="token string">" "</span></span>
    g_argc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    g_argv<span class="token punctuation">[</span>g_argc<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">strtok</span><span class="token punctuation">(</span>commandline<span class="token punctuation">,</span> SEP<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//strtok的作用为将commandline数组中的内容以SEP字符分割</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">bool</span><span class="token punctuation">)</span><span class="token punctuation">(</span>g_argv<span class="token punctuation">[</span>g_argc<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">strtok</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> SEP<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//之后传入null继续分割</span>
    g_argc<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//打印输入的命令是否正确</span>
<span class="token keyword">void</span> <span class="token function">Print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>g_argc<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"g_argv[%d]:%s\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> g_argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//4.内建命令特殊处理</span>
<span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token function">GetHome</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> ret <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"HOME"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ret <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">?</span> <span class="token string">""</span> <span class="token operator">:</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> <span class="token function">Cd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>g_argc <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> 
    <span class="token punctuation">{<!-- --></span>
        std<span class="token double-colon punctuation">::</span>string home <span class="token operator">=</span> <span class="token function">GetHome</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>home<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token function">chdir</span><span class="token punctuation">(</span>home<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
        std<span class="token double-colon punctuation">::</span>string where <span class="token operator">=</span> g_argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>where <span class="token operator">==</span> <span class="token string">"~"</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>

        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>where <span class="token operator">==</span> <span class="token string">"-"</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> 
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">chdir</span><span class="token punctuation">(</span>where<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> lastcode <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//保存最近一次进程的结束码</span>
<span class="token keyword">void</span> <span class="token function">Echo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>g_argc <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// echo "hello world"</span>
        <span class="token comment">// echo $?</span>
        <span class="token comment">// echo $PATH</span>
        std<span class="token double-colon punctuation">::</span>string opt <span class="token operator">=</span> g_argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>opt <span class="token operator">==</span> <span class="token string">"$?"</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> lastcode <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
            lastcode <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>opt<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'$'</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            std<span class="token double-colon punctuation">::</span>string env_name <span class="token operator">=</span> opt<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>env_value <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span>env_name<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>env_value<span class="token punctuation">)</span>
                std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> env_value <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{<!-- --></span>
            std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> opt <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> <span class="token function">CheckAndExecBuiltin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>string cmd <span class="token operator">=</span> g_argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>cmd <span class="token operator">==</span> <span class="token string">"cd"</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">Cd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>cmd <span class="token operator">==</span> <span class="token string">"echo"</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">Echo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>cmd <span class="token operator">==</span> <span class="token string">"export"</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>

    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>cmd <span class="token operator">==</span> <span class="token string">"alias"</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>

    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//5.指令的执行</span>
<span class="token keyword">int</span> <span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    pid_t id <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>id <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">execvp</span><span class="token punctuation">(</span>g_argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> g_argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span> status <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    pid_t rid <span class="token operator">=</span> <span class="token function">waitpid</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>status<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>rid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        lastcode <span class="token operator">=</span> <span class="token function">WEXITSTATUS</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">Init_ENV</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//1.输出命令行提示符</span>
        <span class="token function">PrintCommandPrompt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">//2.获取用户输入的命令</span>
        <span class="token keyword">char</span> commandline<span class="token punctuation">[</span>COMMAND_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">GetCommandLine</span><span class="token punctuation">(</span>commandline<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>commandline<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span><span class="token comment">//如果获取失败，重新获取</span>
        
        <span class="token comment">//3.命令行解析</span>
        <span class="token function">CommandPrase</span><span class="token punctuation">(</span>commandline<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//Print();</span>

        <span class="token comment">//4.对于内建命令，要进行特殊处理</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CheckAndExecBuiltin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span><span class="token comment">//如果是内建命令的话，就不需要下面的指令执行了</span>

        <span class="token comment">//5.指令的执行</span>
        <span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f:672e6373646e2e6e65742f323330315f37393736313833342f:61727469636c652f64657461696c732f313435313631323839" class_="artid" style="display:none">
 </p>
</div>


