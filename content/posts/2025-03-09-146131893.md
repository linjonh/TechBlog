---
layout: post
title: "DeepSeek-DeepEP学习三normal-dispatch"
date: 2025-03-09 14:27:56 +0800
description: "上节介绍了DeepSeek DeepEP的normal kernel执行过程中会分成两部分，第一步通过notify_dispatch计算meta信息，然后本节介绍数据dispatch的过程。"
keywords: "DeepSeek DeepEP学习（三）normal dispatch"
categories: ['Deepseek']
tags: ['Gpu', 'Cuda']
artid: "146131893"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146131893
    alt: "DeepSeek-DeepEP学习三normal-dispatch"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146131893
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146131893
cover: https://bing.ee123.net/img/rand?artid=146131893
image: https://bing.ee123.net/img/rand?artid=146131893
img: https://bing.ee123.net/img/rand?artid=146131893
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     DeepSeek DeepEP学习（三）normal dispatch
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     上节介绍了normal kernel执行过程中会分成两部分，第一步通过notify_dispatch计算meta信息，然后本节介绍数据dispatch的过程。
    </p>
    <p>
     notify_dispatch过程中会计算其他所有rank发送给当前rank多少token，写入到host的moe_recv_counter_mapped，还会计算其他所有rdma_rank发送给当前rank多少token，写入到host的moe_recv_rdma_counter_mapped，这里通过cpu端轮询这个值，轮询到之后就可以在notify_dispatch不结束的情况下开始分配显存，做到overlap。
    </p>
    <pre><code class="prism language-cpp"><span class="token class-name">Buffer</span><span class="token double-colon punctuation">::</span><span class="token function">internode_dispatch</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    internode<span class="token double-colon punctuation">::</span><span class="token function">notify_dispatch</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// Read total count</span>
        num_recv_tokens <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token operator">*</span>moe_recv_counter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        num_rdma_recv_tokens <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token operator">*</span>moe_recv_rdma_counter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// Read per-expert count</span>
        <span class="token keyword">bool</span> ready <span class="token operator">=</span> <span class="token punctuation">(</span>num_recv_tokens <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">and</span> <span class="token punctuation">(</span>num_rdma_recv_tokens <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num_local_experts <span class="token operator">and</span> ready<span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>
            ready <span class="token operator">&amp;=</span> moe_recv_expert_counter<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ready<span class="token punctuation">)</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">auto</span> recv_x <span class="token operator">=</span> torch<span class="token double-colon punctuation">::</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>num_recv_tokens<span class="token punctuation">,</span> hidden<span class="token punctuation">}</span><span class="token punctuation">,</span> x<span class="token punctuation">.</span><span class="token function">options</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    internode<span class="token double-colon punctuation">::</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="_25">
     </a>
     角色分配
    </h3>
    <pre><code class="prism language-cpp"><span class="token keyword">constexpr</span> <span class="token keyword">int</span> kNumDispatchRDMASenderWarps <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>
<span class="token function">SETUP_LAUNCH_CONFIG</span><span class="token punctuation">(</span>num_channels <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>kNumDispatchRDMASenderWarps <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">+</span> NUM_MAX_NVL_PEERS<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">32</span><span class="token punctuation">,</span> stream<span class="token punctuation">)</span><span class="token punctuation">;</span>

__global__ <span class="token keyword">void</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token keyword">auto</span> role_meta <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">=</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> std<span class="token double-colon punctuation">::</span>pair<span class="token operator">&lt;</span>WarpRole<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>is_forwarder<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>warp_id <span class="token operator">&lt;</span> NUM_MAX_NVL_PEERS<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>WarpRole<span class="token double-colon punctuation">::</span>kRDMAAndNVLForwarder<span class="token punctuation">,</span> <span class="token punctuation">(</span>warp_id <span class="token operator">+</span> channel_id<span class="token punctuation">)</span> <span class="token operator">%</span> NUM_MAX_NVL_PEERS<span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>WarpRole<span class="token double-colon punctuation">::</span>kForwarderCoordinator<span class="token punctuation">,</span> warp_id <span class="token operator">-</span> NUM_MAX_NVL_PEERS<span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>    
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>warp_id <span class="token operator">&lt;</span> kNumDispatchRDMASenderWarps<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>WarpRole<span class="token double-colon punctuation">::</span>kRDMASender<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>warp_id <span class="token operator">==</span> kNumDispatchRDMASenderWarps<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>WarpRole<span class="token double-colon punctuation">::</span>kRDMASenderCoordinator<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>WarpRole<span class="token double-colon punctuation">::</span>kNVLReceivers<span class="token punctuation">,</span> <span class="token punctuation">(</span>warp_id <span class="token operator">+</span> channel_id <span class="token operator">-</span> kNumDispatchRDMASenderWarps<span class="token punctuation">)</span> <span class="token operator">%</span> NUM_MAX_NVL_PEERS<span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> warp_role <span class="token operator">=</span> role_meta<span class="token punctuation">.</span>first<span class="token punctuation">;</span>
    <span class="token keyword">auto</span> target_rank <span class="token operator">=</span> role_meta<span class="token punctuation">.</span>second<span class="token punctuation">;</span> <span class="token comment">// Not applicable for RDMA senders</span>
</code></pre>
    <p>
     dispatch的时候会对每个warp分配角色以执行不同的逻辑，可以看到一共有num_channels * 2个sm，每个sm有7 + 1 + 8个warp，角色分配如下图所示
     <br/>
     kRDMASender warp数量为kNumDispatchRDMASenderWarps，即7个，这个角色主要计算token会被发送到哪些rdma_rank，然后将数据拷贝到对应rdma_rank的的buffer。
     <br/>
     kRDMASenderCoordinator warp数量为1
     <br/>
     kNVLReceivers warp数量为NUM_MAX_NVL_PEERS
    </p>
    <p>
     kRDMAAndNVLForwarder warp数量为NUM_MAX_NVL_PEERS
     <br/>
     kForwarderCoordinator warp数量为1
    </p>
    <h3>
     <a id="kRDMASender_56">
     </a>
     kRDMASender
    </h3>
    <p>
     首先是将本端的meta信息发送给其他rank，rdma_channel_meta是SymBuffer，对于当前sm的send_buffer保存了向每一个rdma_rank发送的meta信息。假设当前channel为x。
     <br/>
     对于[0, 7]之间的lane_id，send_buffer(dst_rdma_rank)[lane_id]表示的是channel[0, x - 1]向dst_rdma_rank的gpu[lane_id]发送的token数
     <br/>
     对于[8, 15]之间的lane_id，send_buffer(dst_rdma_rank)[lane_id]表示的是channel[0, x]向dst_rdma_rank的gpu[lane_id]发送的token数
     <br/>
     send_buffer(dst_rdma_rank)[16]表示的是channel[0, x - 1]向dst_rdma_rank这个节点发送的token数
     <br/>
     send_buffer(dst_rdma_rank)[16]表示的是channel[0, x]向dst_rdma_rank这个节点发送的token数
    </p>
    <pre><code class="prism language-cpp"> <span class="token keyword">auto</span> rdma_channel_meta <span class="token operator">=</span> <span class="token generic-function"><span class="token function">SymBuffer</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>rdma_buffer_ptr<span class="token punctuation">,</span> NUM_MAX_NVL_PEERS <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> kNumRDMARanks<span class="token punctuation">,</span> channel_id<span class="token punctuation">,</span> num_channels<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>warp_role <span class="token operator">==</span> WarpRole<span class="token double-colon punctuation">::</span>kRDMASender<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> dst_rdma_rank <span class="token operator">=</span> warp_id<span class="token punctuation">;</span> dst_rdma_rank <span class="token operator">&lt;</span> kNumRDMARanks<span class="token punctuation">;</span> dst_rdma_rank <span class="token operator">+=</span> kNumDispatchRDMASenderWarps<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>lane_id <span class="token operator">&lt;</span> NUM_MAX_NVL_PEERS<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    rdma_channel_meta<span class="token punctuation">.</span><span class="token function">send_buffer</span><span class="token punctuation">(</span>dst_rdma_rank<span class="token punctuation">)</span><span class="token punctuation">[</span>lane_id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token punctuation">(</span>channel_id <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> gbl_channel_prefix_matrix<span class="token punctuation">[</span><span class="token punctuation">(</span>dst_rdma_rank <span class="token operator">*</span> NUM_MAX_NVL_PEERS <span class="token operator">+</span> lane_id<span class="token punctuation">)</span> <span class="token operator">*</span> num_channels <span class="token operator">+</span> channel_id <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>lane_id <span class="token operator">&lt;</span> NUM_MAX_NVL_PEERS <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    rdma_channel_meta<span class="token punctuation">.</span><span class="token function">send_buffer</span><span class="token punctuation">(</span>dst_rdma_rank<span class="token punctuation">)</span><span class="token punctuation">[</span>lane_id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span>gbl_channel_prefix_matrix<span class="token punctuation">[</span><span class="token punctuation">(</span>dst_rdma_rank <span class="token operator">*</span> NUM_MAX_NVL_PEERS <span class="token operator">+</span> lane_id <span class="token operator">-</span> NUM_MAX_NVL_PEERS<span class="token punctuation">)</span> <span class="token operator">*</span> num_channels <span class="token operator">+</span> channel_id<span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>lane_id <span class="token operator">==</span> NUM_MAX_NVL_PEERS <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    rdma_channel_meta<span class="token punctuation">.</span><span class="token function">send_buffer</span><span class="token punctuation">(</span>dst_rdma_rank<span class="token punctuation">)</span><span class="token punctuation">[</span>lane_id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token punctuation">(</span>channel_id <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> rdma_channel_prefix_matrix<span class="token punctuation">[</span>dst_rdma_rank <span class="token operator">*</span> num_channels <span class="token operator">+</span> channel_id <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>lane_id <span class="token operator">==</span> NUM_MAX_NVL_PEERS <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    rdma_channel_meta<span class="token punctuation">.</span><span class="token function">send_buffer</span><span class="token punctuation">(</span>dst_rdma_rank<span class="token punctuation">)</span><span class="token punctuation">[</span>lane_id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span>rdma_channel_prefix_matrix<span class="token punctuation">[</span>dst_rdma_rank <span class="token operator">*</span> num_channels <span class="token operator">+</span> channel_id<span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token function">nvshmemx_int_put_nbi_warp</span><span class="token punctuation">(</span>rdma_channel_meta<span class="token punctuation">.</span><span class="token function">recv_buffer</span><span class="token punctuation">(</span>rdma_rank<span class="token punctuation">)</span><span class="token punctuation">,</span> rdma_channel_meta<span class="token punctuation">.</span><span class="token function">send_buffer</span><span class="token punctuation">(</span>dst_rdma_rank<span class="token punctuation">)</span><span class="token punctuation">,</span> NUM_MAX_NVL_PEERS <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span>
                                          <span class="token generic-function"><span class="token function">translate_dst_rdma_rank</span><span class="token generic class-name"><span class="token operator">&lt;</span>kLowLatencyMode<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>dst_rdma_rank<span class="token punctuation">,</span> nvl_rank<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     每个channel处理一段token_start_idx到token_end_idx的连续token，每个warp每次处理一个token，每个warp内部的一个lane对应一个同号卡节点
    </p>
    <pre><code class="prism language-cpp">__global__ <span class="token keyword">void</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">auto</span> hidden_bytes <span class="token operator">=</span> hidden_int4 <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>int4<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> num_bytes_per_rdma_token <span class="token operator">=</span> <span class="token function">get_num_bytes_per_rdma_token</span><span class="token punctuation">(</span>hidden_int4<span class="token punctuation">,</span> num_scales<span class="token punctuation">,</span> num_topk<span class="token punctuation">,</span> num_topk<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> rdma_channel_data <span class="token operator">=</span> <span class="token generic-function"><span class="token function">SymBuffer</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int8_t</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>rdma_buffer_ptr<span class="token punctuation">,</span> num_max_rdma_chunked_recv_tokens <span class="token operator">*</span> num_bytes_per_rdma_token<span class="token punctuation">,</span> kNumRDMARanks<span class="token punctuation">,</span> channel_id<span class="token punctuation">,</span> num_channels<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> rdma_channel_meta <span class="token operator">=</span> <span class="token generic-function"><span class="token function">SymBuffer</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>rdma_buffer_ptr<span class="token punctuation">,</span> NUM_MAX_NVL_PEERS <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> kNumRDMARanks<span class="token punctuation">,</span> channel_id<span class="token punctuation">,</span> num_channels<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>warp_role <span class="token operator">==</span> WarpRole<span class="token double-colon punctuation">::</span>kRDMASender<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> token_start_idx<span class="token punctuation">,</span> token_end_idx<span class="token punctuation">;</span>
        <span class="token function">get_channel_task_range</span><span class="token punctuation">(</span>num_tokens<span class="token punctuation">,</span> num_channels<span class="token punctuation">,</span> channel_id<span class="token punctuation">,</span> token_start_idx<span class="token punctuation">,</span> token_end_idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> dst_rdma_rank <span class="token operator">=</span> warp_id<span class="token punctuation">;</span> dst_rdma_rank <span class="token operator">&lt;</span> kNumRDMARanks<span class="token punctuation">;</span> dst_rdma_rank <span class="token operator">+=</span> kNumDispatchRDMASenderWarps<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
</code></pre>
    <p>
     rdma_channel_data为SymBuffer，假设一共两个channel，3台机器，当前为channel1，则rdma_channel_data格式如下，send_ptr和recv_ptr指向箭头位置，每一个矩形都是一个类似nccl的fifo，一共有num_max_rdma_chunked_recv_tokens个slot，每个slot存一个token，即num_bytes_per_rdma_token，每个矩形都对应了一个dst_rdma_rank，比如send_ptr开始的第一个矩形表示channel_id为1的warp如果要和rdma_rank 0的机器进行通信，则使用这一个矩形对应的buffer。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/3123a2fa7bc64f2cb7c3dd0e0a1aaabf.png"/>
    </p>
    <center>
     图 1
    </center>
    ### 顺序锁 如下send_ptr(0)表示上述的send_ptr中第一块buffer，对应rdma_rank0，是一个fifo，由head，tail指针进行同步。因为一个warp对应一个token，所以这里warp0和warp1处理的两个token可能都会被发送到rdma_rank0，因此对send_ptr(0)的访问存在竞争，因此这里DeepEP引入了一个顺序锁来保证原子性。
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/1ff3eca648074bd0bd18ec93f8ca62c3.png"/>
    </p>
    <center>
     图 2
    </center>
    <pre><code class="prism language-cpp">__global__ <span class="token keyword">void</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    __shared__ <span class="token keyword">volatile</span> <span class="token keyword">int</span> rdma_send_next_token_idx<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>warp_role <span class="token operator">==</span> WarpRole<span class="token double-colon punctuation">::</span>kRDMASender<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>token_idx <span class="token operator">=</span> token_start_idx <span class="token operator">+</span> warp_id<span class="token punctuation">;</span> token_idx <span class="token operator">&lt;</span> token_end_idx<span class="token punctuation">;</span> token_idx <span class="token operator">+=</span> kNumDispatchRDMASenderWarps<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// Acquire sequential lock</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>lane_id <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">and</span> rdma_send_next_token_idx <span class="token operator">!=</span> token_idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">__syncwarp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token comment">// Release sequential lock</span>
            lane_id <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token punctuation">(</span>rdma_send_next_token_idx <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     rdma_send_next_token_idx初始化为0，每次等到rdma_send_next_token_idx等于自己处理的token_idx的时候，说明轮到自己了，这时候才可以访问临界区，释放锁就将rdma_send_next_token_idx + 1。
    </p>
    <h4>
     <a id="rdma_123">
     </a>
     rdma发送过程中的同步
    </h4>
    <p>
     前边有说到send_ptr(0)是一个fifo，对应发送到rdma_rank0，由head，tail进行同步，生产者就是kRDMASender，假设当前是warp0，正在处理token[x]，然后发现这个token需要被发送到所有rdma_rank，那么首先获取每个rdma_rank对应的tail指针，然后判断每一个rdma_rank对应的fifo是否有空间，判断方法就是对比tail是否大于head，如果大于说明有空间，如果每个fifo都有空间，那么将数据拷贝到每个fifo的tail处。这里的消费者其实是对端rdma_rank，当这个fifo中head位置的token被对端处理完成后，对端会通过rdma_write更新这个head，完整的图如下所示
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/9300288bd9e24c1cafa121ede686fe12.png"/>
    </p>
    <center>
     图 3
    </center>
    然后再看下这一过程的代码 首先获取一个token_idx，每个lane负责一个对端rdma_rank，然后每个lane去is_token_in_rank中获取当前token的mask，即is_token_in_rank_uint64，thread[lane_id]的is_token_in_rank_uint64表示是否需要发送到rdma_rank[lane_id]。 然后开始获取顺序锁，获取到锁之后判断is_token_in_rank_uint64，如果不为0，那么说明需要发送到lane_id这个rdma_rank，然后开始等待fifo中有空闲位置，rdma_tail_idx是这次要填充的位置，如果rdma_tail_idx - cached_rdma_channel_head大于等于fifo中slot数，那么就等待，否则说明有了位置，然后将上一次的tail + 1写入rdma_send_channel_tail，并更新last_rdma_tail_idx，表示上一个token已经写入到了各个fifo。
    <pre><code class="prism language-cpp">__global__ <span class="token keyword">void</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>warp_role <span class="token operator">==</span> WarpRole<span class="token double-colon punctuation">::</span>kRDMASender<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>token_idx <span class="token operator">=</span> token_start_idx <span class="token operator">+</span> warp_id<span class="token punctuation">;</span> token_idx <span class="token operator">&lt;</span> token_end_idx<span class="token punctuation">;</span> token_idx <span class="token operator">+=</span> kNumDispatchRDMASenderWarps<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// Read RDMA rank existence</span>
            <span class="token keyword">uint64_t</span> is_token_in_rank_uint64 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> 
            <span class="token keyword">if</span> <span class="token punctuation">(</span>lane_id <span class="token operator">&lt;</span> kNumRDMARanks<span class="token punctuation">)</span>
                is_token_in_rank_uint64 <span class="token operator">=</span> <span class="token operator">*</span><span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">const</span> <span class="token keyword">uint64_t</span><span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>is_token_in_rank <span class="token operator">+</span> token_idx <span class="token operator">*</span> num_ranks <span class="token operator">+</span> lane_id <span class="token operator">*</span> NUM_MAX_NVL_PEERS<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Acquire sequential lock</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>lane_id <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">and</span> rdma_send_next_token_idx <span class="token operator">!=</span> token_idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">__syncwarp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Acquire next tail</span>
            <span class="token keyword">int</span> rdma_tail_idx <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>is_token_in_rank_uint64 <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> 
                rdma_tail_idx <span class="token operator">=</span> rdma_send_channel_next_tail<span class="token punctuation">[</span>lane_id<span class="token punctuation">]</span> <span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>rdma_tail_idx <span class="token operator">-</span> cached_rdma_channel_head <span class="token operator">&gt;=</span> num_max_rdma_chunked_recv_tokens<span class="token punctuation">)</span>
                    cached_rdma_channel_head <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token function">ld_volatile_global</span><span class="token punctuation">(</span>rdma_channel_head<span class="token punctuation">.</span><span class="token function">buffer</span><span class="token punctuation">(</span>lane_id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>    
            <span class="token function">__syncwarp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Update last token tail</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>last_rdma_tail_idx <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token function">st_release_cta</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">const_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>rdma_send_channel_tail <span class="token operator">+</span> lane_id<span class="token punctuation">)</span><span class="token punctuation">,</span> last_rdma_tail_idx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            last_rdma_tail_idx <span class="token operator">=</span> rdma_tail_idx<span class="token punctuation">;</span>

            <span class="token comment">// Release sequential lock</span>
            lane_id <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token punctuation">(</span>rdma_send_next_token_idx <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="_163">
     </a>
     拷贝数据
    </h4>
    <p>
     现在各个lane_id都拿到了自己的rdma_tail_idx，然后开始拷贝数据，首先需要整个warp知道需要往哪几个lane_id对应的rdma_rank发送数据，然后开始遍历kNumRDMARanks，通过shfl_sync获取第i个lane的rdma_tail_idx，如果rdma_tail_idx大于0，说明需要向rdma_rank[i]发数据，则将i记录到topk_ranks中。
     <br/>
     broadcast函数就是通过shfl_sync将lane[i]输入数据广播到所有lane，将第i个rdma_rank对应的fifo地址广播到dst_send_buffers。
    </p>
    <pre><code class="prism language-cpp">__global__ <span class="token keyword">void</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>warp_role <span class="token operator">==</span> WarpRole<span class="token double-colon punctuation">::</span>kRDMASender<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>    
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            SourceMeta src_meta<span class="token punctuation">;</span>
            <span class="token keyword">int</span> num_topk_ranks <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> topk_ranks<span class="token punctuation">[</span>kNumTopkRDMARanks<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">void</span><span class="token operator">*</span> dst_send_buffers<span class="token punctuation">[</span>kNumTopkRDMARanks<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">unroll</span></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> slot_idx<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> kNumRDMARanks<span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>slot_idx <span class="token operator">=</span> <span class="token function">__shfl_sync</span><span class="token punctuation">(</span><span class="token number">0xffffffff</span><span class="token punctuation">,</span> rdma_tail_idx<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                slot_idx <span class="token operator">=</span> slot_idx <span class="token operator">%</span> num_max_rdma_chunked_recv_tokens<span class="token punctuation">;</span>
                topk_ranks<span class="token punctuation">[</span>num_topk_ranks<span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token punctuation">;</span>
                <span class="token keyword">auto</span> recv_is_token_in_rank_uint64 <span class="token operator">=</span> <span class="token function">broadcast</span><span class="token punctuation">(</span>is_token_in_rank_uint64<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">auto</span> recv_is_token_in_rank_values <span class="token operator">=</span> <span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">const</span> <span class="token keyword">bool</span><span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token operator">&amp;</span>recv_is_token_in_rank_uint64<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>lane_id <span class="token operator">==</span> num_topk_ranks<span class="token punctuation">)</span>
                    src_meta <span class="token operator">=</span> <span class="token function">SourceMeta</span><span class="token punctuation">(</span>rdma_rank<span class="token punctuation">,</span> recv_is_token_in_rank_values<span class="token punctuation">)</span><span class="token punctuation">;</span>
                dst_send_buffers<span class="token punctuation">[</span>num_topk_ranks <span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">uint8_t</span><span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token function">broadcast</span><span class="token punctuation">(</span>send_buffer<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> slot_idx <span class="token operator">*</span> num_bytes_per_rdma_token<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     然后开始拷贝embedding，UNROLLED_WARP_COPY就是一个warp将数据通过LD_FUNC从SRC读取到unrolled_values，然后通过ST_FUNC将unrolled_values写入DST。
     <br/>
     SRC就是用户的输入数据，LD_FUNC就是下边两个PTX中的一个，而ST_FUNC就是st_broadcast，就是将数据写入到dst_send_buffers的每个地址中。
    </p>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">DISABLE_AGGRESSIVE_PTX_INSTRS</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LD_NC_FUNC</span> <span class="token string">"ld.global.nc.L1::no_allocate.L2::256B"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LD_NC_FUNC</span> <span class="token string">"ld.volatile.global"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
__global__ <span class="token keyword">void</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>warp_role <span class="token operator">==</span> WarpRole<span class="token double-colon punctuation">::</span>kRDMASender<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>    
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>           
            <span class="token comment">// Copy `x` into symmetric send buffer</span>
            <span class="token keyword">auto</span> st_broadcast <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">=</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> key<span class="token punctuation">,</span> <span class="token keyword">const</span> int4<span class="token operator">&amp;</span> value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">unroll</span></span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> num_topk_ranks<span class="token punctuation">;</span> <span class="token operator">++</span> j<span class="token punctuation">)</span>
                    <span class="token function">st_na_global</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>int4<span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>dst_send_buffers<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token function">UNROLLED_WARP_COPY</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> lane_id<span class="token punctuation">,</span> hidden_int4<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> x <span class="token operator">+</span> token_idx <span class="token operator">*</span> hidden_int4<span class="token punctuation">,</span> ld_nc_global<span class="token punctuation">,</span> st_broadcast<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">UNROLLED_WARP_COPY</span><span class="token expression"><span class="token punctuation">(</span>UNROLL_FACTOR<span class="token punctuation">,</span> LANE_ID<span class="token punctuation">,</span> N<span class="token punctuation">,</span> DST<span class="token punctuation">,</span> SRC<span class="token punctuation">,</span> LD_FUNC<span class="token punctuation">,</span> ST_FUNC<span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
<span class="token expression"><span class="token punctuation">{<!-- --></span> \         </span></span>
    <span class="token keyword">constexpr</span> <span class="token keyword">int</span> kLoopStride <span class="token operator">=</span> <span class="token number">32</span> <span class="token operator">*</span> <span class="token punctuation">(</span>UNROLL_FACTOR<span class="token punctuation">)</span><span class="token punctuation">;</span> \
    <span class="token keyword">typename</span> <span class="token class-name">std</span><span class="token double-colon punctuation">::</span>remove_reference<span class="token operator">&lt;</span><span class="token keyword">decltype</span><span class="token punctuation">(</span><span class="token function">LD_FUNC</span><span class="token punctuation">(</span><span class="token punctuation">(</span>SRC<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span>type unrolled_values<span class="token punctuation">[</span><span class="token punctuation">(</span>UNROLL_FACTOR<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span> \
    <span class="token keyword">auto</span> __src <span class="token operator">=</span> <span class="token punctuation">(</span>SRC<span class="token punctuation">)</span><span class="token punctuation">;</span> \
    <span class="token keyword">auto</span> __dst <span class="token operator">=</span> <span class="token punctuation">(</span>DST<span class="token punctuation">)</span><span class="token punctuation">;</span> \
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> __i <span class="token operator">=</span> <span class="token punctuation">(</span>LANE_ID<span class="token punctuation">)</span><span class="token punctuation">;</span> __i <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>N<span class="token punctuation">)</span> <span class="token operator">/</span> kLoopStride<span class="token punctuation">)</span> <span class="token operator">*</span> kLoopStride<span class="token punctuation">;</span> __i <span class="token operator">+=</span> kLoopStride<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> \
        <span class="token function">_Pragma</span><span class="token punctuation">(</span><span class="token string">"unroll"</span><span class="token punctuation">)</span> \
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> __j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> __j <span class="token operator">&lt;</span> <span class="token punctuation">(</span>UNROLL_FACTOR<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span> __j<span class="token punctuation">)</span> \
            unrolled_values<span class="token punctuation">[</span>__j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">LD_FUNC</span><span class="token punctuation">(</span>__src <span class="token operator">+</span> __i <span class="token operator">+</span> __j <span class="token operator">*</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span> \
        <span class="token function">_Pragma</span><span class="token punctuation">(</span><span class="token string">"unroll"</span><span class="token punctuation">)</span> \
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> __j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> __j <span class="token operator">&lt;</span> <span class="token punctuation">(</span>UNROLL_FACTOR<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span> __j<span class="token punctuation">)</span> \
            <span class="token function">ST_FUNC</span><span class="token punctuation">(</span>__dst <span class="token operator">+</span> __i <span class="token operator">+</span> __j <span class="token operator">*</span> <span class="token number">32</span><span class="token punctuation">,</span> unrolled_values<span class="token punctuation">[</span>__j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> \
    <span class="token punctuation">}</span> \     
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> __i <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>N<span class="token punctuation">)</span> <span class="token operator">/</span> kLoopStride<span class="token punctuation">)</span> <span class="token operator">*</span> kLoopStride <span class="token operator">+</span> <span class="token punctuation">(</span>LANE_ID<span class="token punctuation">)</span><span class="token punctuation">;</span> __i <span class="token operator">&lt;</span> <span class="token punctuation">(</span>N<span class="token punctuation">)</span><span class="token punctuation">;</span> __i <span class="token operator">+=</span> <span class="token number">32</span><span class="token punctuation">)</span> \
        <span class="token function">ST_FUNC</span><span class="token punctuation">(</span>__dst <span class="token operator">+</span> __i<span class="token punctuation">,</span> <span class="token function">LD_FUNC</span><span class="token punctuation">(</span>__src <span class="token operator">+</span> __i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> \
<span class="token punctuation">}</span> 

</code></pre>
    <p>
     拷贝完数据之后，然后开始拷贝meta data等。
    </p>
    <h4>
     <a id="kRDMASenderCoordinator_230">
     </a>
     kRDMASenderCoordinator
    </h4>
    <p>
     kRDMASenderCoordinator只有一个warp，管理当前sm到其他所有节点的rdma发送，这个warp也参与到上图中rdma发送的同步过程，完整图如下。
     <br/>
     这个warp中的每一个lane对应一个rdma节点，持有这个节点对应fifo的last_issue_tail，表示上一次执行的rdma_write到了哪里。
     <br/>
     处理流程就是轮询每一个节点的last_issue_tail，如果发现有数据可以发送，那么发送数据然后更新last_issue_tail，并将last_issue_tail发送到对端节点。
     <br/>
     如果对NCCL比较熟悉的话会发现下图的同步流程和NCCL非常像，kRDMASender就是NCCL里的kernel，会拷贝数据到fifo，
     <br/>
     kRDMASenderCoordinator相当于proxy线程，轮询到fifo中有新数据之后就执行数据的发送。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/9b69363b321a4956a59a93f0b429d757.png"/>
    </p>
    <center>
     图 4
    </center>
    然后看下代码，回顾上一节，rdma_channel_prefix_matrix记录了当前的每一个channel到每一个dst_rank的token前缀和，这里通过前缀和可以算出num_tokens_to_send，表示当前rank向rdma_rank[lane_id]发送多少token
    <pre><code class="prism language-cpp">__global__ <span class="token keyword">void</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>    
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>warp_role <span class="token operator">==</span> WarpRole<span class="token double-colon punctuation">::</span>kRDMASenderCoordinator<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> num_tokens_to_send <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> 
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lane_id <span class="token operator">&lt;</span> kNumRDMARanks<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            num_tokens_to_send <span class="token operator">=</span> rdma_channel_prefix_matrix<span class="token punctuation">[</span>lane_id <span class="token operator">*</span> num_channels <span class="token operator">+</span> channel_id<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>channel_id <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> 
                num_tokens_to_send <span class="token operator">-=</span> rdma_channel_prefix_matrix<span class="token punctuation">[</span>lane_id <span class="token operator">*</span> num_channels <span class="token operator">+</span> channel_id <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>    
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     然后初始化last_issued_tail为0，while循环直到所有lane的num_tokens_to_send为0，即全部发送完成。
     <br/>
     然后开始轮询每一个rank，这里通过channel_id + i的方式避免尝试打散对其他机器的访问，dst_rdma_rank就是本次尝试发送的对端节点，然后dst_rdma_rank这个lane通过shfl_sync将num_tokens_to_send广播到所有线程，如果synced_num_tokens_to_send为0，则说明不需要向他发送数据。
    </p>
    <pre><code class="prism language-cpp">__global__ <span class="token keyword">void</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>    
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>warp_role <span class="token operator">==</span> WarpRole<span class="token double-colon punctuation">::</span>kRDMASenderCoordinator<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> last_issued_tail <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">__any_sync</span><span class="token punctuation">(</span><span class="token number">0xffffffff</span><span class="token punctuation">,</span> num_tokens_to_send <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> synced_num_tokens_to_send<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> kNumRDMARanks<span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">int</span> dst_rdma_rank <span class="token operator">=</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> channel_id<span class="token punctuation">)</span> <span class="token operator">%</span> kNumRDMARanks<span class="token punctuation">;</span>
                synced_num_tokens_to_send <span class="token operator">=</span> <span class="token function">__shfl_sync</span><span class="token punctuation">(</span><span class="token number">0xffffffff</span><span class="token punctuation">,</span> num_tokens_to_send<span class="token punctuation">,</span> dst_rdma_rank<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>synced_num_tokens_to_send <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     然后去查看dst_rdma_rank对应的fifo队列，首先将lane[dst_rdma_rank]的last_issued_tail广播给所有lane，表示上次网络发送的流程执行到了哪里，然后读取这个fifo的rdma_send_channel_tail，表示数据生产到了哪里，如果这俩值不想等，说明产生了新数据，num_tokens_processed表示这次需要发送多少个token，这里首先会尝试合并到一个比较大的数据量，如果这次发送的token小于一个阈值，并且不是最后一次发送，那么就不执行发送，等合并到较大规模数据再发送
    </p>
    <pre><code class="prism language-cpp">__global__ <span class="token keyword">void</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>    
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>warp_role <span class="token operator">==</span> WarpRole<span class="token double-colon punctuation">::</span>kRDMASenderCoordinator<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token keyword">auto</span> synced_last_issued_tail <span class="token operator">=</span> <span class="token function">__shfl_sync</span><span class="token punctuation">(</span><span class="token number">0xffffffff</span><span class="token punctuation">,</span> last_issued_tail<span class="token punctuation">,</span> dst_rdma_rank<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">auto</span> processed_tail <span class="token operator">=</span> <span class="token function">ld_acquire_cta</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">const_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">const</span> <span class="token keyword">int</span><span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>rdma_send_channel_tail <span class="token operator">+</span> dst_rdma_rank<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">auto</span> num_tokens_processed <span class="token operator">=</span> processed_tail <span class="token operator">-</span> synced_last_issued_tail<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>num_tokens_processed <span class="token operator">!=</span> synced_num_tokens_to_send <span class="token operator">and</span> num_tokens_processed <span class="token operator">&lt;</span> num_max_rdma_chunked_send_tokens<span class="token punctuation">)</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     然后通过synced_last_issued_tail找到fifo中需要发送数据的位置，然后通过nvshmemx_int8_put_nbi_warp执行rdma_write发送数据到对端机器的recv buffer。然后执行fence操作，nvshmem的fence只能保证下发的顺序，不保证完成顺序，因此对于rdma来讲是一个空操作。下发write之后，更新last_issued_tail，通过nvshmemx_signal_op执行一个rdma atomic操作将这次发送的数据量atomic add到对端的rdma_channel_tail，通知对端机器，这里atomic是为了保序，前序的write落盘之后才会执行atomic操作。
    </p>
    <pre><code class="prism language-cpp"> __global__ <span class="token keyword">void</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>    
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>warp_role <span class="token operator">==</span> WarpRole<span class="token double-colon punctuation">::</span>kRDMASenderCoordinator<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token keyword">auto</span> num_tokens_to_issue <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>num_tokens_processed<span class="token punctuation">,</span> num_max_rdma_chunked_send_tokens<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>dst_rdma_rank <span class="token operator">!=</span> rdma_rank<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">auto</span> dst_slot_idx <span class="token operator">=</span> synced_last_issued_tail <span class="token operator">%</span> num_max_rdma_chunked_recv_tokens<span class="token punctuation">;</span>
                    <span class="token function">EP_DEVICE_ASSERT</span><span class="token punctuation">(</span>dst_slot_idx <span class="token operator">+</span> num_tokens_to_issue <span class="token operator">&lt;=</span> num_max_rdma_chunked_recv_tokens<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">nvshmemx_int8_put_nbi_warp</span><span class="token punctuation">(</span>rdma_channel_data<span class="token punctuation">.</span><span class="token function">recv_buffer</span><span class="token punctuation">(</span>rdma_rank<span class="token punctuation">)</span> <span class="token operator">+</span> dst_slot_idx <span class="token operator">*</span> num_bytes_per_rdma_token<span class="token punctuation">,</span>
                                               rdma_channel_data<span class="token punctuation">.</span><span class="token function">send_buffer</span><span class="token punctuation">(</span>dst_rdma_rank<span class="token punctuation">)</span> <span class="token operator">+</span> dst_slot_idx <span class="token operator">*</span> num_bytes_per_rdma_token<span class="token punctuation">,</span>
                                               num_bytes_per_rdma_token <span class="token operator">*</span> num_tokens_to_issue<span class="token punctuation">,</span>
                                               <span class="token generic-function"><span class="token function">translate_dst_rdma_rank</span><span class="token generic class-name"><span class="token operator">&lt;</span>kLowLatencyMode<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>dst_rdma_rank<span class="token punctuation">,</span> nvl_rank<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">nvshmem_fence</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// Lighter fence for local RDMA rank</span>
                    <span class="token function">memory_fence</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>    

                <span class="token comment">// Update tails</span>
                <span class="token function">__syncwarp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>lane_id <span class="token operator">==</span> dst_rdma_rank<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    last_issued_tail <span class="token operator">+=</span> num_tokens_to_issue<span class="token punctuation">;</span>
                    num_tokens_to_send <span class="token operator">-=</span> num_tokens_to_issue<span class="token punctuation">;</span>
                    <span class="token function">nvshmemx_signal_op</span><span class="token punctuation">(</span>rdma_channel_tail<span class="token punctuation">.</span><span class="token function">buffer</span><span class="token punctuation">(</span>rdma_rank<span class="token punctuation">)</span><span class="token punctuation">,</span> num_tokens_to_issue<span class="token punctuation">,</span> NVSHMEM_SIGNAL_ADD<span class="token punctuation">,</span>
                                       <span class="token generic-function"><span class="token function">translate_dst_rdma_rank</span><span class="token generic class-name"><span class="token operator">&lt;</span>kLowLatencyMode<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>dst_rdma_rank<span class="token punctuation">,</span> nvl_rank<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>    
            <span class="token punctuation">}</span>    
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="kRDMAAndNVLForwarder_311">
     </a>
     kRDMAAndNVLForwarder
    </h3>
    <p>
     这个角色的作用就是每个节点上负责接收其他节点发送过来的token，并将这些token转发到当前机器上的其他gpu。
     <br/>
     到这里完整的rdma发送过程中的同步就可以看到了，如下图所示，左边为发送端，右边为接收端，假设是rank0，假设都是sm0，发送端的Coordinator在执行了write之后会通过rdma atomic写rank0的rdma_channel_tail，rank0发现fifo中有数据之后，开始尝试将数据转发给当前机器上的其他gpu。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/0173bbc1c38a4bdfb2fbe16aa92dc924.png"/>
    </p>
    <center>
     图 5
    </center>
    因此这里又涉及到了rdma_rank0这个机器上机内转发时候的同步，当前sm的一个warp对应一个当前机器的gpu，负责将这个fifo中收到的数据转发到自己的负责的gpu 在角色分配的时候，可以看到kRDMAAndNVLForwarder的target_rank为(warp_id + channel_id) % NUM_MAX_NVL_PEERS，即每个warp对应了一个gpu
    <pre><code class="prism language-cpp"><span class="token keyword">const</span> <span class="token keyword">auto</span> role_meta <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">=</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> std<span class="token double-colon punctuation">::</span>pair<span class="token operator">&lt;</span>WarpRole<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>is_forwarder<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>warp_id <span class="token operator">&lt;</span> NUM_MAX_NVL_PEERS<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>WarpRole<span class="token double-colon punctuation">::</span>kRDMAAndNVLForwarder<span class="token punctuation">,</span> <span class="token punctuation">(</span>warp_id <span class="token operator">+</span> channel_id<span class="token punctuation">)</span> <span class="token operator">%</span> NUM_MAX_NVL_PEERS<span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>WarpRole<span class="token double-colon punctuation">::</span>kForwarderCoordinator<span class="token punctuation">,</span> warp_id <span class="token operator">-</span> NUM_MAX_NVL_PEERS<span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>    
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">auto</span> warp_role <span class="token operator">=</span> role_meta<span class="token punctuation">.</span>first<span class="token punctuation">;</span>
    <span class="token keyword">auto</span> target_rank <span class="token operator">=</span> role_meta<span class="token punctuation">.</span>second
</code></pre>
    <p>
     之前有说过，DeepEP初始化的时候，会在每个gpu上分配buffer_ptr，并映射到其他gpu，kRDMAAndNVLForwarder负责数据的发送，假设target_rank为2，当前nvl_rank为1，那么他将拿到gpu2的buffer_ptr，即ws_rr_buffer_ptr，rs_wr_rank为nvl_rank，假设为sm1，那么nvl_channel_x指向ws_rr_buffer_ptr中的位置如下图所示，表示他将写入到gpu2的第一个channel的buffer中src_rank为1的位置。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/8cd50266c80846b3b067cb1c850704c4.png"/>
    </p>
    <center>
     图 6
    </center>
    <pre><code class="prism language-cpp">__global__ <span class="token keyword">void</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>warp_role <span class="token operator">==</span> WarpRole<span class="token double-colon punctuation">::</span>kRDMAAndNVLForwarder<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// NOTES: `rs_wr_buffer_ptr` means "Read for Senders, Write for Receivers", `ws_rr_buffer_ptr` means "Write for Senders, Read for Receivers"</span>
        rs_wr_buffer_ptr <span class="token operator">=</span> buffer_ptrs<span class="token punctuation">[</span>nvl_rank<span class="token punctuation">]</span><span class="token punctuation">,</span> ws_rr_buffer_ptr <span class="token operator">=</span> buffer_ptrs<span class="token punctuation">[</span>target_rank<span class="token punctuation">]</span><span class="token punctuation">,</span> rs_wr_rank <span class="token operator">=</span> nvl_rank<span class="token punctuation">,</span> ws_rr_rank <span class="token operator">=</span> target_rank<span class="token punctuation">;</span>
    <span class="token keyword">auto</span> nvl_channel_x <span class="token operator">=</span> <span class="token generic-function"><span class="token function">AsymBuffer</span><span class="token generic class-name"><span class="token operator">&lt;</span>int4<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>ws_rr_buffer_ptr<span class="token punctuation">,</span> num_max_nvl_chunked_recv_tokens <span class="token operator">*</span> hidden_int4<span class="token punctuation">,</span> NUM_MAX_NVL_PEERS<span class="token punctuation">,</span> channel_id<span class="token punctuation">,</span> num_channels<span class="token punctuation">,</span> rs_wr_rank<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">advance_also</span><span class="token punctuation">(</span>rs_wr_buffer_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> nvl_channel_prefix_start <span class="token operator">=</span> <span class="token generic-function"><span class="token function">AsymBuffer</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>ws_rr_buffer_ptr<span class="token punctuation">,</span> kNumRDMARanks<span class="token punctuation">,</span> NUM_MAX_NVL_PEERS<span class="token punctuation">,</span> channel_id<span class="token punctuation">,</span> num_channels<span class="token punctuation">,</span> rs_wr_rank<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">advance_also</span><span class="token punctuation">(</span>rs_wr_buffer_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> nvl_channel_prefix_end <span class="token operator">=</span> <span class="token generic-function"><span class="token function">AsymBuffer</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>ws_rr_buffer_ptr<span class="token punctuation">,</span> kNumRDMARanks<span class="token punctuation">,</span> NUM_MAX_NVL_PEERS<span class="token punctuation">,</span> channel_id<span class="token punctuation">,</span> num_channels<span class="token punctuation">,</span> rs_wr_rank<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">advance_also</span><span class="token punctuation">(</span>rs_wr_buffer_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     然后看下解析send端发送过来的meta data的逻辑，每个lane_id对应一个源节点，轮询rdma_channel_meta直到收到数据，还是假设target_rank为2，当前nvl_rank为1，channel_id为x，那么对于lane[lane_id]，会从meta中读取到第lane_id个机器的channel[0, x - 1]发到当前机器上gpu[dst_nvl_rank]的token总数，然后将这个作为写入gpu[dst_nvl_rank]的nvl_channel_prefix_start的lane_id位置，同理对于nvl_channel_prefix_end和rdma数据，num_tokens_to_recv_from_rdma表示当前sm会收到lane_id这个机器发送过来多少token。
    </p>
    <pre><code class="prism language-cpp">__global__ <span class="token keyword">void</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>warp_role <span class="token operator">==</span> WarpRole<span class="token double-colon punctuation">::</span>kRDMAAndNVLForwarder<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lane_id <span class="token operator">&lt;</span> kNumRDMARanks<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">auto</span> meta_0 <span class="token operator">=</span> <span class="token function">ld_volatile_global</span><span class="token punctuation">(</span>rdma_channel_meta<span class="token punctuation">.</span><span class="token function">recv_buffer</span><span class="token punctuation">(</span>lane_id<span class="token punctuation">)</span> <span class="token operator">+</span> dst_nvl_rank<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">auto</span> meta_1 <span class="token operator">=</span> <span class="token function">ld_volatile_global</span><span class="token punctuation">(</span>rdma_channel_meta<span class="token punctuation">.</span><span class="token function">recv_buffer</span><span class="token punctuation">(</span>lane_id<span class="token punctuation">)</span> <span class="token operator">+</span> NUM_MAX_NVL_PEERS <span class="token operator">+</span> dst_nvl_rank<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">auto</span> meta_2 <span class="token operator">=</span> <span class="token function">ld_volatile_global</span><span class="token punctuation">(</span>rdma_channel_meta<span class="token punctuation">.</span><span class="token function">recv_buffer</span><span class="token punctuation">(</span>lane_id<span class="token punctuation">)</span> <span class="token operator">+</span> NUM_MAX_NVL_PEERS <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">auto</span> meta_3 <span class="token operator">=</span> <span class="token function">ld_volatile_global</span><span class="token punctuation">(</span>rdma_channel_meta<span class="token punctuation">.</span><span class="token function">recv_buffer</span><span class="token punctuation">(</span>lane_id<span class="token punctuation">)</span> <span class="token operator">+</span> NUM_MAX_NVL_PEERS <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>meta_0 <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">and</span> meta_1 <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">and</span> meta_2 <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">and</span> meta_3 <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// Notify NVL ranks</span>
                    <span class="token keyword">int</span> start_sum <span class="token operator">=</span> <span class="token operator">-</span>meta_0 <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> end_sum <span class="token operator">=</span> <span class="token operator">-</span>meta_1 <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
                    <span class="token function">EP_DEVICE_ASSERT</span><span class="token punctuation">(</span>start_sum <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">and</span> end_sum <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">and</span> end_sum <span class="token operator">&gt;=</span> start_sum<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">st_relaxed_sys_global</span><span class="token punctuation">(</span>nvl_channel_prefix_start<span class="token punctuation">.</span><span class="token function">buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> lane_id<span class="token punctuation">,</span> <span class="token operator">-</span>start_sum <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">st_relaxed_sys_global</span><span class="token punctuation">(</span>nvl_channel_prefix_end<span class="token punctuation">.</span><span class="token function">buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> lane_id<span class="token punctuation">,</span> <span class="token operator">-</span>end_sum <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">// Save RDMA channel received token count</span>
                    src_rdma_channel_prefix <span class="token operator">=</span> <span class="token operator">-</span>meta_2 <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
                    <span class="token keyword">auto</span> src_rdma_channel_prefix_1 <span class="token operator">=</span> <span class="token operator">-</span>meta_3 <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
                    num_tokens_to_recv_from_rdma <span class="token operator">=</span> src_rdma_channel_prefix_1 <span class="token operator">-</span> src_rdma_channel_prefix<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">not</span> kCachedMode<span class="token punctuation">)</span>
                        recv_rdma_channel_prefix_matrix<span class="token punctuation">[</span>lane_id <span class="token operator">*</span> num_channels <span class="token operator">+</span> channel_id<span class="token punctuation">]</span> <span class="token operator">=</span> src_rdma_channel_prefix_1<span class="token punctuation">;</span>
                    src_rdma_channel_prefix <span class="token operator">+=</span> lane_id <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> recv_rdma_rank_prefix_sum<span class="token punctuation">[</span>lane_id <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                    <span class="token function">EP_DEVICE_ASSERT</span><span class="token punctuation">(</span>num_tokens_to_recv_from_rdma <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     然后就是开始转发数据，机内数据的转发同步方式也是通过fifo进行同步，判断head/tail可以知道有没有新数据产生，以及buffer是否满了，这个过程和NCCL的机内kernel同步比较相似，如下图所示。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/cbbe52d8874f43309d50d33932660335.png"/>
    </p>
    <center>
     图 7
    </center>
    <p>
     首先判断是否可以转发数据到其他gpu，第一个while循环表示所有节点发送过来的数据有没有都处理完，如果没处理结束，然后每个warp开始判断对应的gpu的fifo中是否有空闲，fifo总的容量为num_max_nvl_chunked_recv_tokens，已经使用的空间为tail - head，如果剩余的空间大于等于num_max_nvl_chunked_send_tokens，那么可以发送数据。
    </p>
    <pre><code class="prism language-cpp">__global__ <span class="token keyword">void</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>warp_role <span class="token operator">==</span> WarpRole<span class="token double-colon punctuation">::</span>kRDMAAndNVLForwarder<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">__any_sync</span><span class="token punctuation">(</span><span class="token number">0xffffffff</span><span class="token punctuation">,</span> num_tokens_to_recv_from_rdma <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// Check destination queue emptiness, or wait a buffer to be released</span>
            start_time <span class="token operator">=</span> <span class="token function">clock64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>lane_id <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> 
                <span class="token keyword">int</span> num_used_slots <span class="token operator">=</span> cached_nvl_channel_tail <span class="token operator">-</span> cached_nvl_channel_head<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>num_max_nvl_chunked_recv_tokens <span class="token operator">-</span> num_used_slots <span class="token operator">&gt;=</span> num_max_nvl_chunked_send_tokens<span class="token punctuation">)</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                cached_nvl_channel_head <span class="token operator">=</span> <span class="token function">ld_volatile_global</span><span class="token punctuation">(</span>nvl_channel_head<span class="token punctuation">.</span><span class="token function">buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>  
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     还是假设target_rank为2，当前nvl_rank为1，那么当前warp发现gpu[2]的buffer有空闲之后，开始轮询其他所有的机器，假设这次处理的机器是src_rdma_rank，因为每个lane_id对应了一个节点，因此将lane[src_rdma_rank]的剩余token数广播到warp，如果剩余token大于0，那么开始判断src_rdma_rank有没有新发送数据过来，判断方法就是看rdma_channel_tail和rdma_channel_head是否相等，不相等的话说明有新数据产生。
    </p>
    <pre><code class="prism language-cpp">__global__ <span class="token keyword">void</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>warp_role <span class="token operator">==</span> WarpRole<span class="token double-colon punctuation">::</span>kRDMAAndNVLForwarder<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                src_rdma_rank <span class="token operator">=</span> <span class="token punctuation">(</span>src_rdma_rank <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> kNumRDMARanks<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__shfl_sync</span><span class="token punctuation">(</span><span class="token number">0xffffffff</span><span class="token punctuation">,</span> num_tokens_to_recv_from_rdma<span class="token punctuation">,</span> src_rdma_rank<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> 
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>lane_id <span class="token operator">==</span> src_rdma_rank <span class="token operator">and</span> cached_rdma_channel_head <span class="token operator">==</span> cached_rdma_channel_tail<span class="token punctuation">)</span>
                        cached_rdma_channel_tail <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token function">ld_acquire_sys_global</span><span class="token punctuation">(</span>rdma_channel_tail<span class="token punctuation">.</span><span class="token function">buffer</span><span class="token punctuation">(</span>src_rdma_rank<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__shfl_sync</span><span class="token punctuation">(</span><span class="token number">0xffffffff</span><span class="token punctuation">,</span> cached_rdma_channel_tail <span class="token operator">&gt;</span> cached_rdma_channel_head<span class="token punctuation">,</span> src_rdma_rank<span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>    
            <span class="token punctuation">}</span>    
            <span class="token keyword">auto</span> src_rdma_head <span class="token operator">=</span> <span class="token function">__shfl_sync</span><span class="token punctuation">(</span><span class="token number">0xffffffff</span><span class="token punctuation">,</span> cached_rdma_channel_head<span class="token punctuation">,</span> src_rdma_rank<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">auto</span> src_rdma_tail <span class="token operator">=</span> <span class="token function">__shfl_sync</span><span class="token punctuation">(</span><span class="token number">0xffffffff</span><span class="token punctuation">,</span> cached_rdma_channel_tail<span class="token punctuation">,</span> src_rdma_rank<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     然后开始将数据从当前gpu的rdma buffer转发到对端gpu的nvlbuffer。
     <br/>
     遍历rdma buffer中的所有新token，即从src_rdma_head到src_rdma_tail，源数据为shifted，从shifted读取meta信息，判断这个token是否需要被转发到dst_nvl_rank，如果不需要就判断下一个token。通过cached_nvl_channel_tail可以算出这次填充到fifo的那个slot。然后开始实际的拷贝数据到nvl_channel_x。
    </p>
    <pre><code class="prism language-cpp">__global__ <span class="token keyword">void</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>warp_role <span class="token operator">==</span> WarpRole<span class="token double-colon punctuation">::</span>kRDMAAndNVLForwarder<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> src_rdma_head<span class="token punctuation">,</span> num_tokens_sent <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> src_rdma_tail<span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">auto</span> rdma_slot_idx <span class="token operator">=</span> i <span class="token operator">%</span> num_max_rdma_chunked_recv_tokens<span class="token punctuation">;</span>
                <span class="token keyword">void</span><span class="token operator">*</span> shifted <span class="token operator">=</span> rdma_channel_data<span class="token punctuation">.</span><span class="token function">recv_buffer</span><span class="token punctuation">(</span>src_rdma_rank<span class="token punctuation">)</span> <span class="token operator">+</span> rdma_slot_idx <span class="token operator">*</span> num_bytes_per_rdma_token<span class="token punctuation">;</span>
                <span class="token keyword">auto</span> src_meta <span class="token operator">=</span> <span class="token function">ld_nc_global</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>SourceMeta<span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int8_t</span><span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>shifted<span class="token punctuation">)</span> <span class="token operator">+</span> hidden_bytes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                lane_id <span class="token operator">==</span> src_rdma_rank <span class="token operator">?</span> <span class="token punctuation">(</span>num_tokens_to_recv_from_rdma <span class="token operator">-=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">bool</span> is_in_dst_nvl_rank <span class="token operator">=</span> src_meta<span class="token punctuation">.</span><span class="token function">is_token_in_nvl_rank</span><span class="token punctuation">(</span>dst_nvl_rank<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>lane_id <span class="token operator">==</span> src_rdma_rank<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">auto</span> cached_head <span class="token operator">=</span> is_in_dst_nvl_rank <span class="token operator">?</span> rdma_nvl_token_idx <span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                    rdma_nvl_token_idx <span class="token operator">+=</span> is_in_dst_nvl_rank<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">not</span> kCachedMode<span class="token punctuation">)</span>
                        send_nvl_head<span class="token punctuation">[</span>i <span class="token operator">*</span> NUM_MAX_NVL_PEERS<span class="token punctuation">]</span> <span class="token operator">=</span> cached_head<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">not</span> is_in_dst_nvl_rank<span class="token punctuation">)</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                                <span class="token keyword">int</span> dst_slot_idx <span class="token operator">=</span> <span class="token punctuation">(</span>cached_nvl_channel_tail <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token operator">%</span> num_max_nvl_chunked_recv_tokens<span class="token punctuation">;</span>

                <span class="token comment">// Copy data</span>
                <span class="token function">UNROLLED_WARP_COPY</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> lane_id<span class="token punctuation">,</span> hidden_int4<span class="token punctuation">,</span>
                                   nvl_channel_x<span class="token punctuation">.</span><span class="token function">buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> dst_slot_idx <span class="token operator">*</span> hidden_int4<span class="token punctuation">,</span>
                                   <span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>int4<span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>shifted<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                   ld_nc_global<span class="token punctuation">,</span> st_na_global<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//     __shared__ volatile int forward_channel_head[NUM_MAX_NVL_PEERS][kNumRDMARanks];</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>lane_id <span class="token operator">==</span> src_rdma_rank<span class="token punctuation">)</span>
                forward_channel_head<span class="token punctuation">[</span>dst_nvl_rank<span class="token punctuation">]</span><span class="token punctuation">[</span>src_rdma_rank<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>cached_rdma_channel_head <span class="token operator">=</span> src_rdma_tail<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>lane_id <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token function">st_release_sys_global</span><span class="token punctuation">(</span>nvl_channel_tail<span class="token punctuation">.</span><span class="token function">buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cached_nvl_channel_tail<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     可以看到除了更新了tail指针通知对端gpu有新数据之外，还更新了forward_channel_head，forward_channel_head[dst_nvl_rank][src_rdma_rank]表示从src_rdma_rank过来的数据，被转发到dst_nvl_rank的进度到了哪里，这个下边看kForwarderCoordinator的时候会介绍。
    </p>
    <h3>
     <a id="kForwarderCoordinator_455">
     </a>
     kForwarderCoordinator
    </h3>
    <p>
     kForwarderCoordinator只有一个warp，每个lane对应一个源节点，他做的事情就是将新的head通过rdma write写回到源节点，通知源节点自己已经处理过这个数据了。因为比如源节点写过来一个token之后，这个token可能会被转发给多个gpu，kRDMAAndNVLForwarder中每个warp负责转发这个token到一个gpu，那么只有当所有warp都处理完这个token之后，才能通知源节点。
     <br/>
     具体看下代码，每个lane遍历forward_channel_head[0 - NUM_MAX_NVL_PEERS][lane]找到min_head，通过rdma_write将这个min_head发送给节点lane的rdma_channel_head，即图3中的绿线。
    </p>
    <pre><code class="prism language-cpp">__global__ <span class="token keyword">void</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>    
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>warp_role <span class="token operator">==</span> WarpRole<span class="token double-colon punctuation">::</span>kForwarderCoordinator<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> last_head <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> target_rdma <span class="token operator">=</span> lane_id <span class="token operator">&lt;</span> kNumRDMARanks <span class="token operator">?</span> lane_id <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span> 
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// Find minimum head</span>
            <span class="token keyword">int</span> min_head <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token class-name">numeric_limits</span><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">unroll</span></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NUM_MAX_NVL_PEERS<span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">not</span> forward_channel_retired<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
                min_head <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>min_head<span class="token punctuation">,</span> forward_channel_head<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>target_rdma<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__all_sync</span><span class="token punctuation">(</span><span class="token number">0xffffffff</span><span class="token punctuation">,</span> min_head <span class="token operator">==</span> std<span class="token double-colon punctuation">::</span><span class="token class-name">numeric_limits</span><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>

            <span class="token comment">// Update remote head</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>min_head <span class="token operator">!=</span> std<span class="token double-colon punctuation">::</span><span class="token class-name">numeric_limits</span><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">and</span> min_head <span class="token operator">&gt;</span> last_head <span class="token operator">and</span> lane_id <span class="token operator">&lt;</span> kNumRDMARanks<span class="token punctuation">)</span>
                <span class="token function">nvshmem_uint64_p</span><span class="token punctuation">(</span>rdma_channel_head<span class="token punctuation">.</span><span class="token function">buffer</span><span class="token punctuation">(</span>rdma_rank<span class="token punctuation">)</span><span class="token punctuation">,</span> last_head <span class="token operator">=</span> min_head<span class="token punctuation">,</span>
                                 <span class="token generic-function"><span class="token function">translate_dst_rdma_rank</span><span class="token generic class-name"><span class="token operator">&lt;</span>kLowLatencyMode<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>lane_id<span class="token punctuation">,</span> nvl_rank<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Nanosleep and let other warps work</span>
            <span class="token function">__nanosleep</span><span class="token punctuation">(</span>NUM_WAIT_NANOSECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>    
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="kNVLReceivers_482">
     </a>
     kNVLReceivers
    </h3>
    <p>
     kNVLReceivers用于数据的接收，一共有NUM_MAX_NVL_PEERS个warp，每个warp对应一个gpu，即src_nvl_rank，会从这个gpu收数据，每个warp的lane对应一个节点。
     <br/>
     然后从recv_gbl_rank_prefix_sum中获取total_offset，recv_gbl_rank_prefix_sum[i]表示前i个rank发送到当前gpu的总token数，因此这里就是获取第lane_id个机器的gpu[src_nvl_rank]对应的rank发送过来的数据的起始位置。
     <br/>
     假设当前是第x个channel，nvl_channel_prefix_start表示的是第lane_id个机器的channel[0, x - 1]发送到当前rank的token数，因此当前rank处理lane_id机器发送过来的token数需要被存到[total_offset + prefix_sum_start, total_offset + prefix_sum_end)的区间。
     <br/>
     最后通过warp_reduce可以知道其他所有机器的gpu[src_nvl_rank]的同sm发送过来的token总数。
    </p>
    <pre><code class="prism language-cpp">__global__ <span class="token keyword">void</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>    
    <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// NVL consumers</span>
        <span class="token comment">// Retrieve rank offset from barrier results (each lane's register stores an RDMA rank)</span>
        <span class="token keyword">int</span> src_nvl_rank <span class="token operator">=</span> target_rank<span class="token punctuation">,</span> total_offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> 
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lane_id <span class="token operator">&lt;</span> kNumRDMARanks <span class="token operator">and</span> lane_id <span class="token operator">*</span> NUM_MAX_NVL_PEERS <span class="token operator">+</span> src_nvl_rank <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> 
            total_offset <span class="token operator">=</span> recv_gbl_rank_prefix_sum<span class="token punctuation">[</span>lane_id <span class="token operator">*</span> NUM_MAX_NVL_PEERS <span class="token operator">+</span> src_nvl_rank <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token comment">// Receive channel offsets</span>
        <span class="token keyword">int</span> start_offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> end_offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> num_tokens_to_recv<span class="token punctuation">;</span>
        <span class="token keyword">auto</span> start_time <span class="token operator">=</span> <span class="token function">clock64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>lane_id <span class="token operator">&lt;</span> kNumRDMARanks<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            start_offset <span class="token operator">=</span> <span class="token function">ld_volatile_global</span><span class="token punctuation">(</span>nvl_channel_prefix_start<span class="token punctuation">.</span><span class="token function">buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> lane_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            end_offset <span class="token operator">=</span> <span class="token function">ld_volatile_global</span><span class="token punctuation">(</span>nvl_channel_prefix_end<span class="token punctuation">.</span><span class="token function">buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> lane_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>start_offset <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">and</span> end_offset <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> 
                start_offset <span class="token operator">=</span> <span class="token operator">-</span>start_offset <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> end_offset <span class="token operator">=</span> <span class="token operator">-</span>end_offset <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> 
                total_offset <span class="token operator">+=</span> start_offset<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>    
        <span class="token punctuation">}</span>    
        num_tokens_to_recv <span class="token operator">=</span> <span class="token function">warp_reduce_sum</span><span class="token punctuation">(</span>end_offset <span class="token operator">-</span> start_offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     然后通过head和tail判断是否有新数据产生，如果head和tail不相等，说明产生了新的数据。
    </p>
    <pre><code class="prism language-cpp">__global__ <span class="token keyword">void</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>    
    <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> cached_channel_head_idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> cached_channel_tail_idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> 
        <span class="token keyword">while</span> <span class="token punctuation">(</span>num_tokens_to_recv <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> 
            <span class="token keyword">while</span> <span class="token punctuation">(</span>lane_id <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> 
                <span class="token comment">// Ready to copy</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>cached_channel_head_idx <span class="token operator">!=</span> cached_channel_tail_idx<span class="token punctuation">)</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                cached_channel_tail_idx <span class="token operator">=</span> <span class="token function">ld_acquire_sys_global</span><span class="token punctuation">(</span>nvl_channel_tail<span class="token punctuation">.</span><span class="token function">buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>    
            <span class="token punctuation">}</span>    
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     然后开始处理从head开始到tail的token，通过head可以知道元数据在buffer中的哪个slot，读取meta信息可以知道数据是哪个src_rdma_rank发送过来的，然后将src_rdma_rank的total_offset广播到整个warp，即recv_token_idx，数据将被放到输出的这个位置，并将total_offset + 1。
     <br/>
     然后开始拷贝数据，即将数据从nvl_channel_x中的slot拷贝到recv_x + recv_token_idx * hidden_int4。
     <br/>
     同理拷贝scale，topk_idx，topk_weights，最后更新tail。
    </p>
    <pre><code class="prism language-cpp">__global__ <span class="token keyword">void</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>    
    <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> num_recv_tokens <span class="token operator">=</span> cached_channel_tail_idx <span class="token operator">-</span> cached_channel_head_idx<span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> chunk_idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> chunk_idx <span class="token operator">&lt;</span> num_recv_tokens<span class="token punctuation">;</span> <span class="token operator">++</span> chunk_idx<span class="token punctuation">,</span> <span class="token operator">--</span> num_tokens_to_recv<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">int</span> token_idx_in_buffer <span class="token operator">=</span> <span class="token punctuation">(</span>cached_channel_head_idx <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token operator">%</span> num_max_nvl_chunked_recv_tokens<span class="token punctuation">;</span>
                <span class="token keyword">auto</span> meta <span class="token operator">=</span> <span class="token function">ld_nc_global</span><span class="token punctuation">(</span>nvl_channel_src_meta<span class="token punctuation">.</span><span class="token function">buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> token_idx_in_buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">int64_t</span> recv_token_idx <span class="token operator">=</span> <span class="token function">__shfl_sync</span><span class="token punctuation">(</span><span class="token number">0xffffffff</span><span class="token punctuation">,</span> total_offset<span class="token punctuation">,</span> meta<span class="token punctuation">.</span>src_rdma_rank<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">(</span>lane_id <span class="token operator">==</span> meta<span class="token punctuation">.</span>src_rdma_rank<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">(</span>total_offset <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span> 

                <span class="token comment">// Copy data</span>
                <span class="token function">UNROLLED_WARP_COPY</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> lane_id<span class="token punctuation">,</span> hidden_int4<span class="token punctuation">,</span>
                                   recv_x <span class="token operator">+</span> recv_token_idx <span class="token operator">*</span> hidden_int4<span class="token punctuation">,</span>
                                   nvl_channel_x<span class="token punctuation">.</span><span class="token function">buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> token_idx_in_buffer <span class="token operator">*</span> hidden_int4<span class="token punctuation">,</span>
                                   ld_nc_global<span class="token punctuation">,</span> st_na_global<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// Copy source meta</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>lane_id <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">and</span> <span class="token operator">not</span> kCachedMode<span class="token punctuation">)</span>
                    <span class="token function">st_na_global</span><span class="token punctuation">(</span>recv_src_meta <span class="token operator">+</span> recv_token_idx<span class="token punctuation">,</span> meta<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// Copy scales</span>
                <span class="token function">UNROLLED_WARP_COPY</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> lane_id<span class="token punctuation">,</span> num_scales<span class="token punctuation">,</span>
                                   recv_x_scales <span class="token operator">+</span> recv_token_idx <span class="token operator">*</span> num_scales<span class="token punctuation">,</span>
                                   nvl_channel_x_scales<span class="token punctuation">.</span><span class="token function">buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> token_idx_in_buffer <span class="token operator">*</span> num_scales<span class="token punctuation">,</span>
                                   ld_nc_global<span class="token punctuation">,</span> st_na_global<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// Copy `topk_idx` and `topk_weights`</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>lane_id <span class="token operator">&lt;</span> num_topk<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">auto</span> recv_idx <span class="token operator">=</span> recv_token_idx <span class="token operator">*</span> num_topk <span class="token operator">+</span> lane_id<span class="token punctuation">;</span>
                    <span class="token keyword">auto</span> buffer_idx <span class="token operator">=</span> token_idx_in_buffer <span class="token operator">*</span> num_topk <span class="token operator">+</span> lane_id<span class="token punctuation">;</span>
                    <span class="token function">st_na_global</span><span class="token punctuation">(</span>recv_topk_idx <span class="token operator">+</span> recv_idx<span class="token punctuation">,</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int64_t</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token function">ld_nc_global</span><span class="token punctuation">(</span>nvl_channel_topk_idx<span class="token punctuation">.</span><span class="token function">buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> buffer_idx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">st_na_global</span><span class="token punctuation">(</span>recv_topk_weights <span class="token operator">+</span> recv_idx<span class="token punctuation">,</span> <span class="token function">ld_nc_global</span><span class="token punctuation">(</span>nvl_channel_topk_weights<span class="token punctuation">.</span><span class="token function">buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> buffer_idx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// Move queue</span>
            <span class="token function">__syncwarp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>lane_id <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token function">st_relaxed_sys_global</span><span class="token punctuation">(</span>nvl_channel_head<span class="token punctuation">.</span><span class="token function">buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cached_channel_head_idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f:626c6f672e6373646e2e6e65742f4b494447494e373433392f:61727469636c652f64657461696c732f313436313331383933" class_="artid" style="display:none">
 </p>
</div>


