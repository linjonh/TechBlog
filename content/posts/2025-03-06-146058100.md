---
layout: post
title: "优雅处理退出信号在-Node.js-中管理-SIGHUPSIGINT-和-SIGTERM"
date: 2025-03-06 08:42:44 +0800
description: "SIGHUP：通常用于通知守护进程重新加载配置文件。你可以利用这个信号来重新加载配置，而不是直接退出进程。SIGINT：通常用于中断进程。这是最常见的信号，用户可以通过Ctrl+C发送此信号。SIGTERM：请求进程正常终止。这是最常用的终止信号，通常由kill命令发送。"
keywords: "优雅处理退出信号：在 Node.js 中管理 SIGHUP、SIGINT 和 SIGTERM"
categories: ['Javascript']
tags: ['Node']
artid: "146058100"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146058100
    alt: "优雅处理退出信号在-Node.js-中管理-SIGHUPSIGINT-和-SIGTERM"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146058100
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146058100
cover: https://bing.ee123.net/img/rand?artid=146058100
image: https://bing.ee123.net/img/rand?artid=146058100
img: https://bing.ee123.net/img/rand?artid=146058100
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     优雅处理退出信号：在 Node.js 中管理 SIGHUP、SIGINT 和 SIGTERM
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-tomorrow-night" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     在 Node.js 应用程序中，处理各种退出信号（如
     <code>
      SIGHUP
     </code>
     、
     <code>
      SIGINT
     </code>
     和
     <code>
      SIGTERM
     </code>
     ）是非常重要的。这些信号允许你优雅地关闭应用程序，并确保所有资源都被正确释放。下面我们将详细解释这些信号的区别以及如何在 Node.js 中处理它们。
    </p>
    <h4>
     <a id="_2">
     </a>
     信号详解
    </h4>
    <h5>
     <a id="1_SIGHUP_Hang_Up_4">
     </a>
     1.
     <code>
      SIGHUP
     </code>
     (Hang Up)
    </h5>
    <ul>
     <li>
      <strong>
       用途
      </strong>
      ：通常在终端断开连接时发送给进程。它最初用于通知守护进程重新加载配置文件。
     </li>
     <li>
      <strong>
       常见场景
      </strong>
      ：
      <ul>
       <li>
        当用户通过 SSH 连接到服务器并在远程终端上运行一个长时间运行的进程时，如果 SSH 连接中断，系统会向该进程发送
        <code>
         SIGHUP
        </code>
        信号。
       </li>
       <li>
        守护进程（如某些服务或后台任务）可以使用
        <code>
         SIGHUP
        </code>
        来重新加载配置文件而不重启整个进程。
       </li>
      </ul>
     </li>
    </ul>
    <h5>
     <a id="2_SIGINT_Interrupt_11">
     </a>
     2.
     <code>
      SIGINT
     </code>
     (Interrupt)
    </h5>
    <ul>
     <li>
      <strong>
       用途
      </strong>
      ：当用户按下
      <code>
       Ctrl+C
      </code>
      时发送。通常用于中断进程。
     </li>
     <li>
      <strong>
       常见场景
      </strong>
      ：
      <ul>
       <li>
        在命令行界面中运行一个程序时，用户可以通过按下
        <code>
         Ctrl+C
        </code>
        发送
        <code>
         SIGINT
        </code>
        信号来终止该程序。
       </li>
       <li>
        这是一个常见的信号，用于请求程序立即停止当前操作并退出。
       </li>
      </ul>
     </li>
    </ul>
    <h5>
     <a id="3_SIGTERM_Terminate_18">
     </a>
     3.
     <code>
      SIGTERM
     </code>
     (Terminate)
    </h5>
    <ul>
     <li>
      <strong>
       用途
      </strong>
      ：由进程终止命令（如
      <code>
       kill
      </code>
      命令）发送。它请求进程正常终止。
     </li>
     <li>
      <strong>
       常见场景
      </strong>
      ：
      <ul>
       <li>
        当你需要停止一个正在运行的进程时，可以使用
        <code>
         kill &lt;PID&gt;
        </code>
        命令发送
        <code>
         SIGTERM
        </code>
        信号。
       </li>
       <li>
        进程接收到
        <code>
         SIGTERM
        </code>
        信号后，应该进行清理工作（如关闭数据库连接、保存状态等），然后退出。
       </li>
      </ul>
     </li>
    </ul>
    <h4>
     <a id="_25">
     </a>
     处理信号的最佳实践
    </h4>
    <p>
     为了确保应用程序能够优雅地处理这些信号，你应该在代码中监听并处理它们。以下是如何在 Node.js 中实现这一点的示例。
    </p>
    <h4>
     <a id="_29">
     </a>
     示例代码
    </h4>
    <p>
     以下是一个完整的示例，展示了如何在 Node.js 应用程序中监听和处理
     <code>
      SIGHUP
     </code>
     、
     <code>
      SIGINT
     </code>
     和
     <code>
      SIGTERM
     </code>
     信号，并确保在退出时正确关闭数据库连接。
    </p>
    <pre><code class="prism language-javascript"><span class="token keyword">const</span> process <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'process'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Database <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'better-sqlite3'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 打开数据库连接</span>
<span class="token keyword">const</span> db <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Database</span><span class="token punctuation">(</span><span class="token string">'mydb.sqlite'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 创建表</span>
db<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    CREATE TABLE IF NOT EXISTS people (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        first_name TEXT NOT NULL,
        last_name TEXT NOT NULL,
        age INTEGER NOT NULL
    )
</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Table "people" created successfully.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 准备插入语句</span>
<span class="token keyword">const</span> insertStmt <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token string">'INSERT INTO people (first_name, last_name, age) VALUES (?, ?, ?)'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
insertStmt<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token string">'John'</span><span class="token punctuation">,</span> <span class="token string">'Smith'</span><span class="token punctuation">,</span> <span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Inserted John Smith.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 查询所有记录以验证插入结果</span>
<span class="token keyword">const</span> selectStmt <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token string">"SELECT * FROM people"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> rows <span class="token operator">=</span> selectStmt<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
rows<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">row</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">ID: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>row<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, First Name: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>row<span class="token punctuation">.</span>first_name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, Last Name: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>row<span class="token punctuation">.</span>last_name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, Age: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>row<span class="token punctuation">.</span>age<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 监听进程退出事件和其他终止信号</span>
<span class="token keyword">function</span> <span class="token function">handleExit</span><span class="token punctuation">(</span><span class="token parameter">signal<span class="token punctuation">,</span> code</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 关闭数据库连接</span>
        db<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Database connection closed gracefully. Signal: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>signal<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, Code: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>code<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'Error closing database:'</span><span class="token punctuation">,</span> error<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 退出进程</span>
        process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 监听 SIGHUP、SIGINT 和 SIGTERM 信号</span>
<span class="token punctuation">[</span><span class="token string">'SIGHUP'</span><span class="token punctuation">,</span> <span class="token string">'SIGINT'</span><span class="token punctuation">,</span> <span class="token string">'SIGTERM'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">signal</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span>signal<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Received signal: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>signal<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">handleExit</span><span class="token punctuation">(</span>signal<span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Application is running. Press Ctrl+C to exit or send signals using kill command.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <h4>
     <a id="_88">
     </a>
     解释
    </h4>
    <ol>
     <li>
      <p>
       <strong>
        创建表和插入数据
       </strong>
       ：
      </p>
      <ul>
       <li>
        使用
        <code>
         db.exec()
        </code>
        方法创建一个
        <code>
         people
        </code>
        表。
       </li>
       <li>
        使用
        <code>
         insertStmt.run()
        </code>
        方法插入一条记录。
       </li>
       <li>
        使用
        <code>
         selectStmt.all()
        </code>
        方法查询并打印所有记录。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        监听信号
       </strong>
       ：
      </p>
      <ul>
       <li>
        使用
        <code>
         process.on()
        </code>
        方法监听
        <code>
         SIGHUP
        </code>
        、
        <code>
         SIGINT
        </code>
        和
        <code>
         SIGTERM
        </code>
        信号。
       </li>
       <li>
        当接收到这些信号时，调用
        <code>
         handleExit()
        </code>
        函数来关闭数据库连接并退出进程。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        处理退出
       </strong>
       ：
      </p>
      <ul>
       <li>
        在
        <code>
         handleExit()
        </code>
        函数中，使用
        <code>
         db.close()
        </code>
        方法关闭数据库连接。
       </li>
       <li>
        打印退出信息并调用
        <code>
         process.exit(code)
        </code>
        来退出进程。
       </li>
      </ul>
     </li>
    </ol>
    <h4>
     <a id="_103">
     </a>
     运行步骤
    </h4>
    <ol>
     <li>
      <p>
       <strong>
        保存代码
       </strong>
       ：
      </p>
      <ul>
       <li>
        将上述代码保存到一个文件中，例如
        <code>
         app.js
        </code>
        。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        运行应用
       </strong>
       ：
      </p>
      <ul>
       <li>
        在终端中运行以下命令启动应用：
        <pre><code class="prism language-bash"><span class="token function">node</span> app.js
</code></pre>
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        测试信号处理
       </strong>
       ：
      </p>
      <ul>
       <li>
        按下
        <code>
         Ctrl+C
        </code>
        触发
        <code>
         SIGINT
        </code>
        信号。
       </li>
       <li>
        或者在另一个终端窗口中使用
        <code>
         kill
        </code>
        命令发送
        <code>
         SIGTERM
        </code>
        信号：
        <pre><code class="prism language-bash"><span class="token function">kill</span> <span class="token parameter variable">-TERM</span> <span class="token operator">&lt;</span>PID<span class="token operator">&gt;</span>
</code></pre>
        其中
        <code>
         &lt;PID&gt;
        </code>
        是你的 Node.js 应用程序的进程 ID。
       </li>
       <li>
        要发送
        <code>
         SIGHUP
        </code>
        信号，可以使用以下命令：
        <pre><code class="prism language-bash"><span class="token function">kill</span> <span class="token parameter variable">-HUP</span> <span class="token operator">&lt;</span>PID<span class="token operator">&gt;</span>
</code></pre>
       </li>
      </ul>
     </li>
    </ol>
    <h4>
     <a id="_126">
     </a>
     输出示例
    </h4>
    <p>
     假设一切顺利，你应该会看到类似如下的输出：
    </p>
    <pre><code>Table "people" created successfully.
Inserted John Smith.
ID: 1, First Name: John, Last Name: Smith, Age: 45
Application is running. Press Ctrl+C to exit or send signals using kill command.
^CReceived signal: SIGINT
Database connection closed gracefully. Signal: SIGINT, Code: 0
</code></pre>
    <h4>
     <a id="_139">
     </a>
     信号处理总结
    </h4>
    <ul>
     <li>
      <strong>
       <code>
        SIGHUP
       </code>
      </strong>
      ：通常用于通知守护进程重新加载配置文件。你可以利用这个信号来重新加载配置，而不是直接退出进程。
     </li>
     <li>
      <strong>
       <code>
        SIGINT
       </code>
      </strong>
      ：通常用于中断进程。这是最常见的信号，用户可以通过
      <code>
       Ctrl+C
      </code>
      发送此信号。
     </li>
     <li>
      <strong>
       <code>
        SIGTERM
       </code>
      </strong>
      ：请求进程正常终止。这是最常用的终止信号，通常由
      <code>
       kill
      </code>
      命令发送。
     </li>
    </ul>
    <h4>
     <a id="_145">
     </a>
     进一步优化
    </h4>
    <p>
     为了使应用程序更加健壮，可以考虑以下几点：
    </p>
    <ol>
     <li>
      <p>
       <strong>
        日志记录
       </strong>
       ：
      </p>
      <ul>
       <li>
        使用日志库（如
        <code>
         winston
        </code>
        或
        <code>
         pino
        </code>
        ）记录详细的日志信息，以便更好地调试和维护。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        异步操作
       </strong>
       ：
      </p>
      <ul>
       <li>
        如果有其他异步操作（如网络请求或文件操作），确保在退出前等待这些操作完成。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        重试机制
       </strong>
       ：
      </p>
      <ul>
       <li>
        对于可能失败的操作（如数据库连接），可以实现重试机制，以提高应用程序的可靠性。
       </li>
      </ul>
     </li>
    </ol>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c:6f672e6373646e2e6e65742f677573757368616e74616e672f:61727469636c652f64657461696c732f313436303538313030" class_="artid" style="display:none">
 </p>
</div>


