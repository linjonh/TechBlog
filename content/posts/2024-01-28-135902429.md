---
layout: post
title: "游戏中排行榜的后台实现"
date: 2024-01-28 23:03:39 +0800
description: "游戏中经常会有排行榜需求需要实现，例如常见的战力排行榜、积分排行榜等等。排行榜一般会用到 Redis"
keywords: "游戏客户端排行榜实现"
categories: ['未分类']
tags: ['游戏', 'Redis', 'Java']
artid: "135902429"
image:
  path: https://api.vvhan.com/api/bing?rand=sj&artid=135902429
  alt: "游戏中排行榜的后台实现"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=135902429
featuredImagePreview: https://bing.ee123.net/img/rand?artid=135902429
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     游戏中排行榜的后台实现
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="./../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="./../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     游戏中经常会有排行榜需求需要实现，例如常见的战力排行榜、积分排行榜等等。
    </p>
    <p>
     排行榜一般会用到 Redis 来实现，原因是：
    </p>
    <ol>
     <li>
      Redis 基于内存操作，速度快
     </li>
     <li>
      Redis 提供了高效的有序集合 zset
     </li>
    </ol>
    <p>
     例如创建一个名为 rank 的排行榜
    </p>
    <pre><code class="prism language-bash"><span class="token comment"># 为用户user1设置分数为1</span>
<span class="token operator">&gt;</span> zadd rank <span class="token number">1</span> user1

<span class="token comment"># 获取排行榜中全部用户的排名和分数（分数顺序排序）</span>
<span class="token operator">&gt;</span> zrange rank <span class="token number">0</span> -1 withscores
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"user1"</span>
<span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"1"</span>
<span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">"user2"</span>
<span class="token number">4</span><span class="token punctuation">)</span> <span class="token string">"2"</span>
<span class="token number">5</span><span class="token punctuation">)</span> <span class="token string">"user3"</span>
<span class="token number">6</span><span class="token punctuation">)</span> <span class="token string">"3"</span>

<span class="token comment"># 获取排行榜中全部用户的排名和分数（分数倒序排序）</span>
<span class="token operator">&gt;</span> zrevrange rank <span class="token number">0</span> -1 withscores
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"user3"</span>
<span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"3"</span>
<span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">"user2"</span>
<span class="token number">4</span><span class="token punctuation">)</span> <span class="token string">"2"</span>
<span class="token number">5</span><span class="token punctuation">)</span> <span class="token string">"user1"</span>
<span class="token number">6</span><span class="token punctuation">)</span> <span class="token string">"1"</span>

<span class="token comment"># 获取排行榜中排名前 2 的用户的排名和分数（分数倒序排序）</span>
<span class="token operator">&gt;</span> zrevrange rank <span class="token number">0</span> <span class="token number">1</span> withscores
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"user3"</span>
<span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"3"</span>
<span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">"user2"</span>
<span class="token number">4</span><span class="token punctuation">)</span> <span class="token string">"2"</span>

<span class="token comment"># 获取排行榜中用户 user2 的排名</span>
<span class="token operator">&gt;</span> zrank rank user2
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">1</span>
</code></pre>
<p>
纵然 redis 的速度很快，但是再加上网络请求的开销和单线程问题，也比不上应用内直接内存的速度，所以为了速度，一般会在游戏内缓存排行榜。获取排行榜时，优先从内存中获取，并定时从 redis 同步数据到内存。
</p>
<p>
下面是一个简单的例子，实现了获取排行榜信息和用户排名数据。
</p>
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RankTest</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Data</span>
    <span class="token annotation punctuation">@AllArgsConstructor</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">UserRankInfo</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">private</span> <span class="token keyword">long</span> userID<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> rank<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">double</span> score<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 缓存的用户信息
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">UserRankInfo</span><span class="token punctuation">&gt;</span></span> USER_RANK_INFO_MAP <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * 上次同步时间
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> LAST_SYNC_TIME <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * 每隔多长时间从redis同步一次
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> SYNC_EVERY_SECOND <span class="token operator">=</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 获取排行榜
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserRankInfo</span><span class="token punctuation">&gt;</span></span> <span class="token function">getRankList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> LAST_SYNC_TIME <span class="token operator">+</span> SYNC_EVERY_SECOND<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">syncUserRankInfoMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> USER_RANK_INFO_MAP<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">syncUserRankInfoMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">Jedis</span> jedis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jedis</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span> <span class="token number">6379</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 获取前50名的用户  </span>
            <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple</span><span class="token punctuation">&gt;</span></span> tuples <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">zrevrangeWithScores</span><span class="token punctuation">(</span><span class="token string">"rank"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">49</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">putUserRankInfoMap</span><span class="token punctuation">(</span>tuples<span class="token punctuation">)</span><span class="token punctuation">;</span>
            LAST_SYNC_TIME <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">putUserRankInfoMap</span><span class="token punctuation">(</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple</span><span class="token punctuation">&gt;</span></span> tuples<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        USER_RANK_INFO_MAP<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> rank <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Tuple</span> tuple <span class="token operator">:</span> tuples<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">long</span> userID <span class="token operator">=</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>tuple<span class="token punctuation">.</span><span class="token function">getElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">UserRankInfo</span> info <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserRankInfo</span><span class="token punctuation">(</span>userID<span class="token punctuation">,</span> rank<span class="token operator">++</span><span class="token punctuation">,</span> tuple<span class="token punctuation">.</span><span class="token function">getScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            USER_RANK_INFO_MAP<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>userID<span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取用户排名信息
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">UserRankInfo</span> <span class="token function">getUserRankInfo</span><span class="token punctuation">(</span><span class="token keyword">long</span> userID<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> LAST_SYNC_TIME <span class="token operator">+</span> SYNC_EVERY_SECOND<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">syncUserRankInfoMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> USER_RANK_INFO_MAP<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>userID<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 设置用户分数
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setUserRankScore</span><span class="token punctuation">(</span><span class="token keyword">long</span> userID<span class="token punctuation">,</span><span class="token keyword">double</span> score<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">Jedis</span> jedis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jedis</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span> <span class="token number">6379</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

            jedis<span class="token punctuation">.</span><span class="token function">zadd</span><span class="token punctuation">(</span><span class="token string">"rank"</span><span class="token punctuation">,</span> score<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>userID<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 获取前50名的用户  </span>
            <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple</span><span class="token punctuation">&gt;</span></span> tuples <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">zrevrangeWithScores</span><span class="token punctuation">(</span><span class="token string">"rank"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">49</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">putUserRankInfoMap</span><span class="token punctuation">(</span>tuples<span class="token punctuation">)</span><span class="token punctuation">;</span>
            LAST_SYNC_TIME <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre>
<p>
开发中，上面的例子还存在不少问题：
</p>
<ol>
<li>
因为 redis 操作比较耗时，所以一般都会放在异步线程中进行操作
</li>
<li>
缓存数据的更新不是原子的，一旦多个用户同时请求，可能会导致数据重复更新多次
</li>
<li>
相同的分数的用户的排名会按照用户名来排序
</li>
</ol>
<p>
针对于问题 3，因为用户在相同分数的情况下， redis 只支持根据用户名的字典排序，并不支持自定义排序。但是这对玩家来说是不可接受的。一个解决办法让相同分数的玩家按照达成时间的判断，最先抵达的玩家排名最高。
</p>
<p>
我们可以使用（真实分数 + 时间戳倒数）作为排名分数，真实分数作为整数部分，时间戳倒数作为小数部分。
</p>
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setUserRankScore</span><span class="token punctuation">(</span><span class="token keyword">long</span> userID<span class="token punctuation">,</span><span class="token keyword">int</span> score<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>  
 <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">Jedis</span> jedis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jedis</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span> <span class="token number">6379</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
 <span class="token comment">//因为毫秒时间戳最多有 13 位 </span>
<span class="token keyword">double</span> newScore<span class="token operator">=</span>score<span class="token operator">+</span><span class="token number">1000_000_000_000.0D</span><span class="token operator">/</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
 jedis<span class="token punctuation">.</span><span class="token function">zadd</span><span class="token punctuation">(</span><span class="token string">"rank"</span><span class="token punctuation">,</span> newScore<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>userID<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
 <span class="token comment">// 获取前 50 名的用户 </span>
<span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple</span><span class="token punctuation">&gt;</span></span> tuples <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">zrevrangeWithScores</span><span class="token punctuation">(</span><span class="token string">"rank"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">49</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
 <span class="token function">putUserRankInfoMap</span><span class="token punctuation">(</span>tuples<span class="token punctuation">)</span><span class="token punctuation">;</span>  
 LAST_SYNC_TIME <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
 <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>
</code></pre>
<p>
参考：
</p>
<ol>
<li>
<a href="https://redis.io/docs/data-types/sorted-sets/" rel="nofollow">
Redis sorted sets | Redis
</a>
</li>
<li>
<a href="https://zhuanlan.zhihu.com/p/592924303" rel="nofollow">
Redis 实现排行榜及相同积分按时间排序 - 知乎
</a>
</li>
<li>
<a href="https://cloud.tencent.com/developer/article/2324908" rel="nofollow">
Redis 浮点数累计实现-腾讯云开发者社区-腾讯云
</a>
</li>
</ol>

   </div>
   <link href="./../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="./../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f35343232373037352f:61727469636c652f64657461696c732f313335393032343239" class_="artid" style="display:none">
 </p>
</div>
