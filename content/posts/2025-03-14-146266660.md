---
layout: post
title: "ç¬¬P7å‘¨é©¬é“ƒè–¯ç—…å®³è¯†åˆ«VGG-16å¤ç°"
date: 2025-03-14 21:05:19 +0800
description: "loss = loss_fn(pred, y)  # è®¡ç®—ç½‘ç»œè¾“å‡ºå’ŒçœŸå®å€¼ä¹‹é—´çš„å·®è·ï¼Œtargetsä¸ºçœŸå®å€¼ï¼Œè®¡ç®—äºŒè€…å·®å€¼å³ä¸ºæŸå¤±ã€‚num_batches = len(dataloader)          # æ‰¹æ¬¡æ•°ç›®, (size/batch_sizeï¼Œå‘ä¸Šå–æ•´)num_batches = len(dataloader)   # æ‰¹æ¬¡æ•°ç›®, (size/batch_sizeï¼Œå‘ä¸Šå–æ•´)size        = len(dataloader.dataset)  # æµ‹è¯•é›†çš„å¤§å°ã€‚"
keywords: "ç¬¬P7å‘¨ï¼šé©¬é“ƒè–¯ç—…å®³è¯†åˆ«(VGG-16å¤ç°)"
categories: ['æœªåˆ†ç±»']
tags: ['æ·±åº¦å­¦ä¹ ', 'æœºå™¨å­¦ä¹ ', 'Python']
artid: "146266660"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146266660
    alt: "ç¬¬P7å‘¨é©¬é“ƒè–¯ç—…å®³è¯†åˆ«VGG-16å¤ç°"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146266660
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146266660
cover: https://bing.ee123.net/img/rand?artid=146266660
image: https://bing.ee123.net/img/rand?artid=146266660
img: https://bing.ee123.net/img/rand?artid=146266660
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     ç¬¬P7å‘¨ï¼šé©¬é“ƒè–¯ç—…å®³è¯†åˆ«(VGG-16å¤ç°)
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <ul>
     <li id="u5a0cf7ef">
      <strong>
       ğŸ¨
      </strong>
      <strong>
       æœ¬æ–‡ä¸º
      </strong>
      <a href="https://mp.weixin.qq.com/s/kV8ZsJv6cPNzJLEuhPfvXg" rel="nofollow" title="ğŸ”—365å¤©æ·±åº¦å­¦ä¹ è®­ç»ƒè¥">
       ğŸ”—365å¤©æ·±åº¦å­¦ä¹ è®­ç»ƒè¥
      </a>
      <strong>
       ä¸­çš„å­¦ä¹ è®°å½•åšå®¢
      </strong>
     </li>
     <li id="uabaf6a39">
      <strong>
       ğŸ–
      </strong>
      <strong>
       åŸä½œè€…ï¼š
      </strong>
      <a href="https://mtyjkh.blog.csdn.net/" rel="nofollow" title="KåŒå­¦å•Š">
       KåŒå­¦å•Š
      </a>
     </li>
    </ul>
    <p>
    </p>
    <h2>
     ä¸€.å‰æœŸå‡†å¤‡
    </h2>
    <h3>
     1.è®¾ç½®GPU
    </h3>
    <blockquote>
     <pre>import torch
import torch.nn as nn
import torchvision.transforms as transforms
import torchvision
from torchvision import transforms,datasets
import os,PIL,pathlib,warnings

warnings.filterwarnings('ignore')

device=torch.device('cuda' if torch.cuda.is_available() else 'cpu')
device</pre>
    </blockquote>
    <p>
     <img alt="" height="53" src="https://i-blog.csdnimg.cn/direct/35c37aaff98745a4a21fcc29b2c5a4d9.png" width="206"/>
    </p>
    <h3>
     2.å¯¼å…¥æ•°æ®
    </h3>
    <blockquote>
     <pre>data_dir='../data/PotatoPlants/PotatoPlants'
data_dir=pathlib.Path(data_dir)

data_paths=list(data_dir.glob('*'))
classeNames=[str(path).split('\\')[4] for path in data_paths]
classeNames</pre>
    </blockquote>
    <p>
     <img alt="" height="43" src="https://i-blog.csdnimg.cn/direct/373bf8959141471cbfee1b06ebc8c7e4.png" width="365"/>
    </p>
    <blockquote>
     <pre>train_transforms=transforms.Compose([
    transforms.Resize([224,224]),
    transforms.ToTensor(),
    transforms.Normalize(
        mean=[0.485,0.456,0.406],
        std=[0.229,0.224,0.225]
    )
])
test_transforms=transforms.Compose([
    transforms.Resize([224,224]),
    transforms.ToTensor(),
    transforms.Normalize(
        mean=[0.485,0.456,0.406],
        std=[0.229,0.224,0.225]
    )
])
total_data=datasets.ImageFolder('../data/PotatoPlants/PotatoPlants',transform=train_transforms)</pre>
    </blockquote>
    <p>
    </p>
    <blockquote>
     <pre>total_data.class_to_idx</pre>
    </blockquote>
    <p>
     <img alt="" height="34" src="https://i-blog.csdnimg.cn/direct/e618140c07664a078bc9bb292a09a764.png" width="484"/>
    </p>
    <p>
    </p>
    <h3>
     3.åˆ’åˆ†æ•°æ®é›†
    </h3>
    <blockquote>
     <pre>train_size=int(0.8*len(total_data))
test_size=len(total_data)-train_size
train_dataset,test_dataset=torch.utils.data.random_split(total_data,[train_size,test_size])
train_dataset,test_dataset</pre>
    </blockquote>
    <p>
     <img alt="" height="58" src="https://i-blog.csdnimg.cn/direct/47dd607608a94be3b046c8e736f5bca7.png" width="523"/>
    </p>
    <blockquote>
     <pre>batch_size=32

train_dl=torch.utils.data.DataLoader(train_dataset,
                                     batch_size=batch_size,
                                     shuffle=True)
test_dl=torch.utils.data.DataLoader(test_dataset,
                                    batch_size=batch_size,
                                    shuffle=True)</pre>
    </blockquote>
    <p>
    </p>
    <blockquote>
     <pre>for x,y in test_dl:
    print('shape of [N,C,W,H]',x.shape)
    print('shape of y',y.shape,y.dtype)
    break</pre>
    </blockquote>
    <p>
     <img alt="" height="60" src="https://i-blog.csdnimg.cn/direct/80b64bd0289e45b4a8971696c579e7db.png" width="471"/>
    </p>
    <p>
    </p>
    <h2>
     äºŒ.VGG-16æ¨¡å‹
    </h2>
    <h3>
     1.æ­å»ºæ¨¡å‹
    </h3>
    <blockquote>
     <pre>import torch.nn.functional as F

class vgg16(nn.Module):
    def __init__(self):
        super(vgg16, self).__init__()
        # å·ç§¯å—1
        self.block1 = nn.Sequential(
            nn.Conv2d(3, 64, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1)),
            nn.ReLU(),
            nn.Conv2d(64, 64, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1)),
            nn.ReLU(),
            nn.MaxPool2d(kernel_size=(2, 2), stride=(2, 2))
        )
        # å·ç§¯å—2
        self.block2 = nn.Sequential(
            nn.Conv2d(64, 128, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1)),
            nn.ReLU(),
            nn.Conv2d(128, 128, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1)),
            nn.ReLU(),
            nn.MaxPool2d(kernel_size=(2, 2), stride=(2, 2))
        )
        # å·ç§¯å—3
        self.block3 = nn.Sequential(
            nn.Conv2d(128, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1)),
            nn.ReLU(),
            nn.Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1)),
            nn.ReLU(),
            nn.Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1)),
            nn.ReLU(),
            nn.MaxPool2d(kernel_size=(2, 2), stride=(2, 2))
        )
        # å·ç§¯å—4
        self.block4 = nn.Sequential(
            nn.Conv2d(256, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1)),
            nn.ReLU(),
            nn.Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1)),
            nn.ReLU(),
            nn.Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1)),
            nn.ReLU(),
            nn.MaxPool2d(kernel_size=(2, 2), stride=(2, 2))
        )
        # å·ç§¯å—5
        self.block5 = nn.Sequential(
            nn.Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1)),
            nn.ReLU(),
            nn.Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1)),
            nn.ReLU(),
            nn.Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1)),
            nn.ReLU(),
            nn.MaxPool2d(kernel_size=(2, 2), stride=(2, 2))
        )


        # å…¨è¿æ¥ç½‘ç»œå±‚ï¼Œç”¨äºåˆ†ç±»
        self.classifier = nn.Sequential(
            nn.Linear(in_features=512*7*7, out_features=4096),
            nn.ReLU(),
            nn.Linear(in_features=4096, out_features=4096),
            nn.ReLU(),
            nn.Linear(in_features=4096, out_features=3)
        )

    def forward(self, x):

        x = self.block1(x)
        x = self.block2(x)
        x = self.block3(x)
        x = self.block4(x)
        x = self.block5(x)
        x = torch.flatten(x, start_dim=1)
        x = self.classifier(x)

        return x

device = "cuda" if torch.cuda.is_available() else "cpu"
print("Using {} device".format(device))


model = vgg16().to(device)
model</pre>
    </blockquote>
    <p>
     <img alt="" height="346" src="https://i-blog.csdnimg.cn/direct/7ba4e41491ce4d8fa067c0064cf2f3f1.png" width="882"/>
    </p>
    <p>
    </p>
    <h3>
     2.æŸ¥çœ‹æ¨¡å‹è¯¦æƒ…
    </h3>
    <blockquote>
     <pre>import torchsummary as summary

summary.summary(model,(3,224,224))</pre>
    </blockquote>
    <p>
     <img alt="" height="288" src="https://i-blog.csdnimg.cn/direct/19c9b225ba7c439eb5a3c43a807dc801.png" width="629"/>
    </p>
    <h2>
     ä¸‰.è®­ç»ƒæ¨¡å‹
    </h2>
    <h3>
     1.ç¼–å†™è®­ç»ƒå‡½æ•°
    </h3>
    <blockquote>
     <pre># è®­ç»ƒå¾ªç¯
def train(dataloader, model, loss_fn, optimizer):
    size = len(dataloader.dataset)  # è®­ç»ƒé›†çš„å¤§å°
    num_batches = len(dataloader)   # æ‰¹æ¬¡æ•°ç›®, (size/batch_sizeï¼Œå‘ä¸Šå–æ•´)

    train_loss, train_acc = 0, 0  # åˆå§‹åŒ–è®­ç»ƒæŸå¤±å’Œæ­£ç¡®ç‡


    for X, y in dataloader:  # è·å–å›¾ç‰‡åŠå…¶æ ‡ç­¾
        X, y = X.to(device), y.to(device)


        # è®¡ç®—é¢„æµ‹è¯¯å·®
        pred = model(X)          # ç½‘ç»œè¾“å‡º
        loss = loss_fn(pred, y)  # è®¡ç®—ç½‘ç»œè¾“å‡ºå’ŒçœŸå®å€¼ä¹‹é—´çš„å·®è·ï¼Œtargetsä¸ºçœŸå®å€¼ï¼Œè®¡ç®—äºŒè€…å·®å€¼å³ä¸ºæŸå¤±


        # åå‘ä¼ æ’­
        optimizer.zero_grad()  # gradå±æ€§å½’é›¶
        loss.backward()        # åå‘ä¼ æ’­
        optimizer.step()       # æ¯ä¸€æ­¥è‡ªåŠ¨æ›´æ–°


        # è®°å½•accä¸loss
        train_acc  += (pred.argmax(1) == y).type(torch.float).sum().item()
        train_loss += loss.item()


    train_acc  /= size
    train_loss /= num_batches

    return train_acc, train_loss</pre>
    </blockquote>
    <h3>
     2.ç¼–å†™æµ‹è¯•å‡½æ•°
    </h3>
    <blockquote>
     <pre>def test (dataloader, model, loss_fn):
    size        = len(dataloader.dataset)  # æµ‹è¯•é›†çš„å¤§å°
    num_batches = len(dataloader)          # æ‰¹æ¬¡æ•°ç›®, (size/batch_sizeï¼Œå‘ä¸Šå–æ•´)
    test_loss, test_acc = 0, 0


    # å½“ä¸è¿›è¡Œè®­ç»ƒæ—¶ï¼Œåœæ­¢æ¢¯åº¦æ›´æ–°ï¼ŒèŠ‚çœè®¡ç®—å†…å­˜æ¶ˆè€—
    with torch.no_grad():
        for imgs, target in dataloader:
            imgs, target = imgs.to(device), target.to(device)


            # è®¡ç®—loss
            target_pred = model(imgs)
            loss        = loss_fn(target_pred, target)


            test_loss += loss.item()
            test_acc  += (target_pred.argmax(1) == target).type(torch.float).sum().item()

    test_acc  /= size
    test_loss /= num_batches

    return test_acc, test_loss</pre>
    </blockquote>
    <h3>
     3.æ­£å¼è®­ç»ƒ
    </h3>
    <blockquote>
     <pre>import copy

optimizer  = torch.optim.Adam(model.parameters(), lr= 1e-4)
loss_fn    = nn.CrossEntropyLoss() # åˆ›å»ºæŸå¤±å‡½æ•°

epochs     = 40

train_loss = []
train_acc  = []
test_loss  = []
test_acc   = []

best_acc = 0    # è®¾ç½®ä¸€ä¸ªæœ€ä½³å‡†ç¡®ç‡ï¼Œä½œä¸ºæœ€ä½³æ¨¡å‹çš„åˆ¤åˆ«æŒ‡æ ‡

for epoch in range(epochs):


    model.train()
    epoch_train_acc, epoch_train_loss = train(train_dl, model, loss_fn, optimizer)


    model.eval()
    epoch_test_acc, epoch_test_loss = test(test_dl, model, loss_fn)


    # ä¿å­˜æœ€ä½³æ¨¡å‹åˆ° best_model
    if epoch_test_acc &gt; best_acc:
        best_acc   = epoch_test_acc
        best_model = copy.deepcopy(model)


    train_acc.append(epoch_train_acc)
    train_loss.append(epoch_train_loss)
    test_acc.append(epoch_test_acc)
    test_loss.append(epoch_test_loss)


    # è·å–å½“å‰çš„å­¦ä¹ ç‡
    lr = optimizer.state_dict()['param_groups'][0]['lr']


    template = ('Epoch:{:2d}, Train_acc:{:.1f}%, Train_loss:{:.3f}, Test_acc:{:.1f}%, Test_loss:{:.3f}, Lr:{:.2E}')
    print(template.format(epoch+1, epoch_train_acc*100, epoch_train_loss,
                          epoch_test_acc*100, epoch_test_loss, lr))


# ä¿å­˜æœ€ä½³æ¨¡å‹åˆ°æ–‡ä»¶ä¸­
PATH = './best_model.pth'  # ä¿å­˜çš„å‚æ•°æ–‡ä»¶å
torch.save(model.state_dict(), PATH)

print('Done')</pre>
    </blockquote>
    <p>
     <img alt="" height="279" src="https://i-blog.csdnimg.cn/direct/027b5f55044b4c91a9b83734416223f1.png" width="743"/>
    </p>
    <p>
    </p>
    <h2>
     å››.ç»“æœå¯è§†åŒ–
    </h2>
    <h3>
     1.Lossä¸Accuracyå›¾
    </h3>
    <blockquote>
     <pre>import matplotlib.pyplot as plt
#éšè—è­¦å‘Š
import warnings
warnings.filterwarnings("ignore")               #å¿½ç•¥è­¦å‘Šä¿¡æ¯
plt.rcParams['font.sans-serif']    = ['SimHei'] # ç”¨æ¥æ­£å¸¸æ˜¾ç¤ºä¸­æ–‡æ ‡ç­¾
plt.rcParams['axes.unicode_minus'] = False      # ç”¨æ¥æ­£å¸¸æ˜¾ç¤ºè´Ÿå·
plt.rcParams['figure.dpi']         = 100        #åˆ†è¾¨ç‡

from datetime import datetime
current_time = datetime.now() # è·å–å½“å‰æ—¶é—´

epochs_range = range(epochs)

plt.figure(figsize=(12, 3))
plt.subplot(1, 2, 1)

plt.plot(epochs_range, train_acc, label='Training Accuracy')
plt.plot(epochs_range, test_acc, label='Test Accuracy')
plt.legend(loc='lower right')
plt.title('Training and Validation Accuracy')
plt.xlabel(current_time) # æ‰“å¡è¯·å¸¦ä¸Šæ—¶é—´æˆ³ï¼Œå¦åˆ™ä»£ç æˆªå›¾æ— æ•ˆ

plt.subplot(1, 2, 2)
plt.plot(epochs_range, train_loss, label='Training Loss')
plt.plot(epochs_range, test_loss, label='Test Loss')
plt.legend(loc='upper right')
plt.title('Training and Validation Loss')
plt.show()</pre>
    </blockquote>
    <p>
     <img alt="" height="305" src="https://i-blog.csdnimg.cn/direct/0ccc8ef2961b423f85fdc911a1b3e949.png" width="982"/>
    </p>
    <p>
    </p>
    <p>
    </p>
    <h3>
     2.æŒ‡å®šå›¾ç‰‡è¿›è¡Œé¢„æµ‹
    </h3>
    <blockquote>
     <pre>from PIL import Image

classes = list(total_data.class_to_idx)

def predict_one_image(image_path, model, transform, classes):


    test_img = Image.open(image_path).convert('RGB')
    plt.imshow(test_img)  # å±•ç¤ºé¢„æµ‹çš„å›¾ç‰‡

    test_img = transform(test_img)
    img = test_img.to(device).unsqueeze(0)


    model.eval()
    output = model(img)

    _,pred = torch.max(output,1)
    pred_class = classes[pred]
    print(f'é¢„æµ‹ç»“æœæ˜¯ï¼š{pred_class}')</pre>
    </blockquote>
    <h3>
     3.æ¨¡å‹è¯„ä¼°
    </h3>
    <blockquote>
     <pre># é¢„æµ‹è®­ç»ƒé›†ä¸­çš„æŸå¼ ç…§ç‰‡
predict_one_image(image_path=r'D:\AI_Learning\deep_learning\data\PotatoPlants\PotatoPlants\Early_blight\0a8a68ee-f587-4dea-beec-79d02e7d3fa4___RS_Early.B 8461.JPG',
                  model=model,
                  transform=train_transforms,
                  classes=classes)</pre>
    </blockquote>
    <p>
    </p>
    <p>
     <img alt="" height="461" src="https://i-blog.csdnimg.cn/direct/b15c95b40ba54684a55f4661c2e30beb.png" width="480"/>
    </p>
    <p>
    </p>
    <p>
    </p>
    <p>
     åŸºäº VGG16 çš„é©¬é“ƒè–¯ç—…å®³åˆ†ç±»æ¨¡å‹ï¼Œå®Œæˆäº†æ•°æ®é¢„å¤„ç†ã€æ¨¡å‹è®­ç»ƒã€æµ‹è¯•è¯„ä¼°å’Œå¯è§†åŒ–è¿‡ç¨‹ï¼Œå¹¶æœ€ç»ˆä¿å­˜äº†æœ€ä¼˜æ¨¡å‹ï¼Œå®ç°äº†å•å¼ å›¾ç‰‡çš„ç—…å®³é¢„æµ‹ã€‚
    </p>
   </div>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f35393930373339342f:61727469636c652f64657461696c732f313436323636363630" class_="artid" style="display:none">
 </p>
</div>


