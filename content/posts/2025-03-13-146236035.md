---
layout: post
title: "得物-Android-Crash-治理实践"
date: 2025-03-13 16:53:31 +0800
description: "经过架构以及各团队的共同努力下，崩溃率已从最高的万2降至目前的万1.1到万1.5，其中疑难问题占比约90%、因系统bug导致的Crash占比约40%，在本文中将简要介绍一些较典型的系统Crash的治理过程。"
keywords: "得物 Android Crash 治理实践"
categories: ['未分类']
tags: ['后端', 'Android']
artid: "146236035"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146236035
    alt: "得物-Android-Crash-治理实践"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146236035
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146236035
cover: https://bing.ee123.net/img/rand?artid=146236035
image: https://bing.ee123.net/img/rand?artid=146236035
img: https://bing.ee123.net/img/rand?artid=146236035
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     得物 Android Crash 治理实践
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="_0">
     </a>
     一、前言
    </h2>
    <p>
     通过修复历史遗留的Crash漏报问题（包括端侧SDK采集的兼容性优化及Crash平台的数据消费机制完善），得物Android端的Crash监控体系得到显著增强，使得历史Crash数据的完整捕获能力得到系统性改善，相应Crash指标也有所上升，经过架构以及各团队的共同努力下，崩溃率已从最高的万2降至目前的万1.1到万1.5，其中疑难问题占比约90%、因系统bug导致的Crash占比约40%，在本文中将简要介绍一些较典型的系统Crash的治理过程。
    </p>
    <h2>
     <a id="DNS_6">
     </a>
     二、DNS解析崩溃
    </h2>
    <h3>
     <a id="_8">
     </a>
     背景
    </h3>
    <p>
     Android11及以下版本在DNS解析过程中的有几率产生野指针问题导致的Native Crash，其中Android9占比最高。
    </p>
    <p>
     <em>
      堆栈与上报趋势
     </em>
    </p>
    <pre><code class="prism language-java">at <span class="token class-name"><span class="token namespace">libcore<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Linux</span><span class="token punctuation">.</span><span class="token function">android_getaddrinfo</span><span class="token punctuation">(</span><span class="token class-name">Linux</span><span class="token punctuation">.</span>java<span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">libcore<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>BlockGuardOs</span><span class="token punctuation">.</span><span class="token function">android_getaddrinfo</span><span class="token punctuation">(</span><span class="token class-name">BlockGuardOs</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">172</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span>InetAddress</span><span class="token punctuation">.</span><span class="token function">parseNumericAddressNoThrow</span><span class="token punctuation">(</span><span class="token class-name">InetAddress</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1631</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span>Inet6AddressImpl</span><span class="token punctuation">.</span><span class="token function">lookupAllHostAddr</span><span class="token punctuation">(</span><span class="token class-name">Inet6AddressImpl</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">96</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span>InetAddress</span><span class="token punctuation">.</span><span class="token function">getAllByName</span><span class="token punctuation">(</span><span class="token class-name">InetAddress</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1154</span><span class="token punctuation">)</span>

#<span class="token number">00</span> pc <span class="token number">000000000003</span>b938  <span class="token operator">/</span>system<span class="token operator">/</span>lib64<span class="token operator">/</span>libc<span class="token punctuation">.</span>so <span class="token punctuation">(</span>android_detectaddrtype<span class="token operator">+</span><span class="token number">1164</span><span class="token punctuation">)</span>
#<span class="token number">01</span> pc <span class="token number">000000000003</span>b454  <span class="token operator">/</span>system<span class="token operator">/</span>lib64<span class="token operator">/</span>libc<span class="token punctuation">.</span>so <span class="token punctuation">(</span>android_getaddrinfofornet<span class="token operator">+</span><span class="token number">72</span><span class="token punctuation">)</span>
#<span class="token number">02</span> pc <span class="token number">000000000002</span>b5f4  <span class="token operator">/</span>system<span class="token operator">/</span>lib64<span class="token operator">/</span>libjavacore<span class="token punctuation">.</span>so <span class="token punctuation">(</span>_ZL25Linux_android_getaddrinfoP7_JNIEnvP8_jobjectP8_jstringS2_i<span class="token operator">+</span><span class="token number">336</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     <img alt="上报趋势.jpeg" src="https://i-blog.csdnimg.cn/img_convert/a394da4214c977e3b7c804cb5f0ff8db.jpeg"/>
    </p>
    <h3>
     <a id="_30">
     </a>
     问题分析
    </h3>
    <p>
     崩溃入口方法InetAddress.getAllByName用于根据指定的主机名返回与之关联的所有 IP 地址，它会根据系统配置的名称服务进行解析，沿着调用链查看源码发现在parseNumericAddressNoThrow方法内部调用Libcore.os.android_getaddrinfo时中有try catch的容错逻辑，继续查看后续调用的c++的源码，在调用android_getaddrinfofornet函数返回值不为0时抛出GaiException异常。
    </p>
    <pre><code class="prism language-java">https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>cs<span class="token punctuation">.</span>android<span class="token punctuation">.</span>com<span class="token operator">/</span>android<span class="token operator">/</span>platform<span class="token operator">/</span>superproject<span class="token operator">/</span><span class="token operator">+</span><span class="token operator">/</span>android<span class="token operator">-</span><span class="token number">9.0</span><span class="token number">.0_</span>r49<span class="token operator">:</span>libcore<span class="token operator">/</span>ojluni<span class="token operator">/</span>src<span class="token operator">/</span>main<span class="token operator">/</span>java<span class="token operator">/</span>java<span class="token operator">/</span>net<span class="token operator">/</span><span class="token class-name">InetAddress</span><span class="token punctuation">.</span>java

<span class="token keyword">static</span> <span class="token class-name">InetAddress</span> <span class="token function">parseNumericAddressNoThrow</span><span class="token punctuation">(</span><span class="token class-name">String</span> address<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
       <span class="token comment">// Accept IPv6 addresses (only) in square brackets for compatibility.</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>address<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"["</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> address<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">"]"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> address<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token char">':'</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
           address <span class="token operator">=</span> address<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> address<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token class-name">StructAddrinfo</span> hints <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StructAddrinfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       hints<span class="token punctuation">.</span>ai_flags <span class="token operator">=</span> <span class="token constant">AI_NUMERICHOST</span><span class="token punctuation">;</span>
       <span class="token class-name">InetAddress</span><span class="token punctuation">[</span><span class="token punctuation">]</span> addresses <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
       <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
           addresses <span class="token operator">=</span> <span class="token class-name">Libcore</span><span class="token punctuation">.</span>os<span class="token punctuation">.</span><span class="token function">android_getaddrinfo</span><span class="token punctuation">(</span>address<span class="token punctuation">,</span> hints<span class="token punctuation">,</span> <span class="token constant">NETID_UNSET</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">GaiException</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
       <span class="token punctuation">}</span>
       <span class="token keyword">return</span> <span class="token punctuation">(</span>addresses <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> addresses<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
</code></pre>
    <pre><code class="prism language-java">https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>cs<span class="token punctuation">.</span>android<span class="token punctuation">.</span>com<span class="token operator">/</span>android<span class="token operator">/</span>platform<span class="token operator">/</span>superproject<span class="token operator">/</span><span class="token operator">+</span><span class="token operator">/</span>master<span class="token operator">:</span>libcore<span class="token operator">/</span>luni<span class="token operator">/</span>src<span class="token operator">/</span>main<span class="token operator">/</span><span class="token keyword">native</span><span class="token operator">/</span>libcore_io_Linux<span class="token punctuation">.</span>cpp<span class="token operator">?</span>q<span class="token operator">=</span><span class="token class-name">Linux_android_getaddrinfo</span><span class="token operator">&amp;</span>ss<span class="token operator">=</span>android<span class="token operator">%</span><span class="token number">2F</span>platform<span class="token operator">%</span><span class="token number">2F</span>superproject

<span class="token keyword">static</span> jobjectArray <span class="token class-name">Linux_android_getaddrinfo</span><span class="token punctuation">(</span><span class="token class-name">JNIEnv</span><span class="token operator">*</span> env<span class="token punctuation">,</span> jobject<span class="token punctuation">,</span> jstring javaNode<span class="token punctuation">,</span>
        jobject javaHints<span class="token punctuation">,</span> jint netId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">int</span> rc <span class="token operator">=</span> <span class="token function">android_getaddrinfofornet</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> netId<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>addressList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token operator">::</span><span class="token function">unique_ptr</span><span class="token generics"><span class="token punctuation">&lt;</span>addrinfo<span class="token punctuation">,</span> addrinfo_deleter<span class="token punctuation">&gt;</span></span> <span class="token function">addressListDeleter</span><span class="token punctuation">(</span>addressList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">throwGaiException</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token string">"android_getaddrinfo"</span><span class="token punctuation">,</span> rc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="_70">
     </a>
     解决过程
    </h3>
    <p>
     解决思路是代理android_getaddrinfofornet函数，捕捉调用原函数过程中出现的段错误信号，接着吃掉这个信号并返回-1，使之转换为JAVA异常进而走进parseNumericAddressNoThrow方法的容错逻辑，和负责网络的同学提前做了沟通，确定此流程对业务没有影响后开始解决。
    </p>
    <p>
     首先使用inline-hook代理了android_getaddrinfofornet函数，接着使用字节封装好的native try catch工具做吃掉段错误信号并返回-1的，字节工具内部原理是在try块的开始使用sigsetjmp打个锚点并快照当前寄存器的值，然后设置信号量处理器并关联当前线程，在catch块中解绑线程与信号的关联并执行业务兜底代码，在捕捉到信号时通过siglongjmp函数长跳转到catch块中，感兴趣的同学可以用下面精简后的demo试试，以下代码保存为mem_err.c，执行gcc ./mem_err.c;./a.out
    </p>
    <pre><code class="prism language-java">#include <span class="token generics"><span class="token punctuation">&lt;</span>stdio<span class="token punctuation">.</span>h<span class="token punctuation">&gt;</span></span>
#include <span class="token generics"><span class="token punctuation">&lt;</span>signal<span class="token punctuation">.</span>h<span class="token punctuation">&gt;</span></span>
#include <span class="token generics"><span class="token punctuation">&lt;</span>setjmp<span class="token punctuation">.</span>h<span class="token punctuation">&gt;</span></span>

struct sigaction old<span class="token punctuation">;</span>
<span class="token keyword">static</span> sigjmp_buf buf<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token class-name">SIGSEGV_handler</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">,</span> siginfo_t <span class="token operator">*</span>info<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>ucontext<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"信号处理 sig: %d, code: %d\n"</span><span class="token punctuation">,</span> sig<span class="token punctuation">,</span> info<span class="token operator">-&gt;</span>si_code<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">siglongjmp</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">sigsetjmp</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        struct sigaction sa<span class="token punctuation">;</span>

        sa<span class="token punctuation">.</span>sa_sigaction <span class="token operator">=</span> <span class="token class-name">SIGSEGV_handler</span><span class="token punctuation">;</span>
        <span class="token function">sigaction</span><span class="token punctuation">(</span><span class="token constant">SIGSEGV</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>sa<span class="token punctuation">,</span> <span class="token operator">&amp;</span>old<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"try exec\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//产生段错误</span>
        <span class="token keyword">int</span> <span class="token operator">*</span>ptr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token operator">*</span>ptr <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"try-block end\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//走不到</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"catch exec\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sigaction</span><span class="token punctuation">(</span><span class="token constant">SIGSEGV</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>old<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"main func end\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//输出以下日志</span>
<span class="token comment">//try exec</span>
<span class="token comment">//信号处理 sig: 11, code: 2</span>
<span class="token comment">//catch exec</span>
<span class="token comment">//main func end</span>
</code></pre>
    <p>
     <em>
      inline-hook库: https://github.com/bytedance/android-inline-hook
     </em>
    </p>
    <p>
     <em>
      字节native try catch工具: https://github.com/bytedance/android-inline-hook/blob/main/shadowhook/src/main/cpp/common/bytesig.c
     </em>
    </p>
    <h2>
     <a id="MediaCodec__124">
     </a>
     三、MediaCodec 状态异常崩溃
    </h2>
    <h3>
     <a id="_126">
     </a>
     背景
    </h3>
    <p>
     在Android 11系统库的音视频播放过程中，偶尔会出现因状态异常导致的SIGABRT崩溃。音视频团队反馈指出，这是Android 11的一个系统bug。随后，我们协助音视频团队通过hook解决了这一问题。
    </p>
    <p>
     <em>
      堆栈与上报趋势
     </em>
    </p>
    <pre><code class="prism language-java">#<span class="token number">00</span> pc <span class="token number">0000000000089</span>b1c  <span class="token operator">/</span>apex<span class="token operator">/</span>com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>runtime<span class="token operator">/</span>lib64<span class="token operator">/</span>bionic<span class="token operator">/</span>libc<span class="token punctuation">.</span>so <span class="token punctuation">(</span>abort<span class="token operator">+</span><span class="token number">164</span><span class="token punctuation">)</span>
#<span class="token number">01</span> pc <span class="token number">000000000055</span>ed78  <span class="token operator">/</span>apex<span class="token operator">/</span>com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>art<span class="token operator">/</span>lib64<span class="token operator">/</span>libart<span class="token punctuation">.</span>so <span class="token punctuation">(</span>_ZN3art7Runtime5AbortEPKc<span class="token operator">+</span><span class="token number">2308</span><span class="token punctuation">)</span>
#<span class="token number">02</span> pc <span class="token number">0000000000013978</span>  <span class="token operator">/</span>system<span class="token operator">/</span>lib64<span class="token operator">/</span>libbase<span class="token punctuation">.</span>so <span class="token punctuation">(</span>_ZZN7android4base10SetAborterEONSt3__18functionIFvPKcEEEEN3$_38__invokeES4_<span class="token operator">+</span><span class="token number">76</span><span class="token punctuation">)</span>
#<span class="token number">03</span> pc <span class="token number">0000000000006e30</span>  <span class="token operator">/</span>system<span class="token operator">/</span>lib64<span class="token operator">/</span>liblog<span class="token punctuation">.</span>so <span class="token punctuation">(</span>__android_log_assert<span class="token operator">+</span><span class="token number">336</span><span class="token punctuation">)</span>
#<span class="token number">04</span> pc <span class="token number">0000000000122074</span>  <span class="token operator">/</span>system<span class="token operator">/</span>lib64<span class="token operator">/</span>libstagefright<span class="token punctuation">.</span>so <span class="token punctuation">(</span>_ZN7android10MediaCodec37postPendingRepliesAndDeferredMessagesENSt3__112basic_stringIcNS1_11char_traitsIcEENS1_9allocatorIcEEEERKNS_2spINS_8AMessageEEE<span class="token operator">+</span><span class="token number">720</span><span class="token punctuation">)</span>
#<span class="token number">05</span> pc <span class="token number">00000000001215</span>cc  <span class="token operator">/</span>system<span class="token operator">/</span>lib64<span class="token operator">/</span>libstagefright<span class="token punctuation">.</span>so <span class="token punctuation">(</span>_ZN7android10MediaCodec37postPendingRepliesAndDeferredMessagesENSt3__112basic_stringIcNS1_11char_traitsIcEENS1_9allocatorIcEEEEi<span class="token operator">+</span><span class="token number">244</span><span class="token punctuation">)</span>
#<span class="token number">06</span> pc <span class="token number">000000000011</span>c308  <span class="token operator">/</span>system<span class="token operator">/</span>lib64<span class="token operator">/</span>libstagefright<span class="token punctuation">.</span>so <span class="token punctuation">(</span>_ZN7android10MediaCodec17onMessageReceivedERKNS_2spINS_8AMessageEEE<span class="token operator">+</span><span class="token number">8752</span><span class="token punctuation">)</span>
#<span class="token number">07</span> pc <span class="token number">0000000000017814</span>  <span class="token operator">/</span>system<span class="token operator">/</span>lib64<span class="token operator">/</span>libstagefright_foundation<span class="token punctuation">.</span>so <span class="token punctuation">(</span>_ZN7android8AHandler14deliverMessageERKNS_2spINS_8AMessageEEE<span class="token operator">+</span><span class="token number">84</span><span class="token punctuation">)</span>
#<span class="token number">08</span> pc <span class="token number">000000000001d</span><span class="token number">9</span>cc  <span class="token operator">/</span>system<span class="token operator">/</span>lib64<span class="token operator">/</span>libstagefright_foundation<span class="token punctuation">.</span>so <span class="token punctuation">(</span>_ZN7android8AMessage7deliverEv<span class="token operator">+</span><span class="token number">188</span><span class="token punctuation">)</span>
#<span class="token number">09</span> pc <span class="token number">0000000000018</span>b48  <span class="token operator">/</span>system<span class="token operator">/</span>lib64<span class="token operator">/</span>libstagefright_foundation<span class="token punctuation">.</span>so <span class="token punctuation">(</span>_ZN7android7ALooper4loopEv<span class="token operator">+</span><span class="token number">572</span><span class="token punctuation">)</span>
#<span class="token number">10</span> pc <span class="token number">0000000000015598</span>  <span class="token operator">/</span>system<span class="token operator">/</span>lib64<span class="token operator">/</span>libutils<span class="token punctuation">.</span>so <span class="token punctuation">(</span>_ZN7android6Thread11_threadLoopEPv<span class="token operator">+</span><span class="token number">460</span><span class="token punctuation">)</span>
#<span class="token number">11</span> pc <span class="token number">00000000000</span>a1d6c  <span class="token operator">/</span>system<span class="token operator">/</span>lib64<span class="token operator">/</span>libandroid_runtime<span class="token punctuation">.</span>so <span class="token punctuation">(</span>_ZN7android14AndroidRuntime15javaThreadShellEPv<span class="token operator">+</span><span class="token number">144</span><span class="token punctuation">)</span>
#<span class="token number">12</span> pc <span class="token number">0000000000014d</span><span class="token number">94</span>  <span class="token operator">/</span>system<span class="token operator">/</span>lib64<span class="token operator">/</span>libutils<span class="token punctuation">.</span>so <span class="token punctuation">(</span>_ZN13thread_data_t10trampolineEPKS_<span class="token operator">+</span><span class="token number">412</span><span class="token punctuation">)</span>
#<span class="token number">13</span> pc <span class="token number">00000000000</span>eba94  <span class="token operator">/</span>apex<span class="token operator">/</span>com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>runtime<span class="token operator">/</span>lib64<span class="token operator">/</span>bionic<span class="token operator">/</span>libc<span class="token punctuation">.</span>so <span class="token punctuation">(</span>_ZL15__pthread_startPv<span class="token operator">+</span><span class="token number">64</span><span class="token punctuation">)</span>
#<span class="token number">14</span> pc <span class="token number">000000000008</span>bd80  <span class="token operator">/</span>apex<span class="token operator">/</span>com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>runtime<span class="token operator">/</span>lib64<span class="token operator">/</span>bionic<span class="token operator">/</span>libc<span class="token punctuation">.</span>so <span class="token punctuation">(</span>__start_thread<span class="token operator">+</span><span class="token number">64</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     <img alt="状态异常崩溃上报趋势.jpeg" src="https://i-blog.csdnimg.cn/img_convert/6dda490c721bf5f568af690bab898bcd.jpeg"/>
    </p>
    <h3>
     <a id="_155">
     </a>
     问题分析
    </h3>
    <p>
     根据堆栈内容分析Android11的源码以及结合SIGABRT信号采集到的信息(postPendingRepliesAndDeferredMessages: mReplyID == null, from kWhatRelease:STOPPING following kWhatError:STOPPING)，找到崩溃发生在onMessageReceived函数处理kWhatRelease类型消息的过程中，onMessageReceived函数连续收到两条消息，第一条是kWhatError:STOPPING，第二条是kWhatRelease:STOPPING此时因mReplyID已经被置为空，因此走到判空抛异常的逻辑。
    </p>
    <p>
     <em>
      https://cs.android.com/android/_/android/platform/frameworks/av/+/refs/tags/android-11.0.0_r48:media/libstagefright/MediaCodec.cpp;l=2280;drc=789055bbcb4560b42faf19103b1cda5534e8f9cb;bpv=0;bpt=0
     </em>
    </p>
    <p>
     <img alt="问题分析1.jpeg" src="https://i-blog.csdnimg.cn/img_convert/8f163c5b1ee33e7d104fde3cbcd82952.jpeg">
      <br/>
      <img alt="问题分析2.jpeg" src="https://i-blog.csdnimg.cn/img_convert/23af1fd70b571bce1b6864fdd336c574.jpeg">
       <br/>
       <img alt="问题分析3.jpeg" src="https://i-blog.csdnimg.cn/img_convert/6b3015579a2d700e88a2a50a3a6bf2a3.jpeg">
        <br/>
        <img alt="问题分析4.jpeg" src="https://i-blog.csdnimg.cn/img_convert/b423fc7958e5fcf491bb8b70dac53e0a.jpeg">
         <br/>
         对比Android12的源码，在处理kWhatRelease事件且状态为STOPPING抛异常前，增加了对mReplyID不为空的判断来规避这个问题。
        </img>
       </img>
      </img>
     </img>
    </p>
    <p>
     <em>
      https://cs.android.com/android/_/android/platform/frameworks/av/+/ca0c3286a4790a4de2d90cb275ae89a9601b805b:media/libstagefright/MediaCodec.cpp;dlc=7327aab894f6c456ea16c95b64134841da8d5737
     </em>
    </p>
    <p>
     <img alt="规避这个问题.jpeg" src="https://i-blog.csdnimg.cn/img_convert/881662f05facca4b0baacdd86db5de7b.jpeg"/>
    </p>
    <h3>
     <a id="_174">
     </a>
     解决过程
    </h3>
    <p>
     Android12的修复方式意味着上述三个条件结合下吃掉异常是符合预期的，接下来就是想办法通过hook Android11使逻辑对齐Android12。
    </p>
    <p>
     【初探】最先想到的办法是代理相关函数通过判断走到这个场景时提前return出去来规避，音视频的同学尝试后发现不可行，原因如下：
    </p>
    <ul>
     <li>
      void MediaCodec::postPendingRepliesAndDeferredMessages(std::string origin, status_t err): 匹配origin是否为特征字符串(postPendingRepliesAndDeferredMessages: mReplyID == null, from kWhatRelease:STOPPING following kWhatError:STOPPING)；很多设备找不到这个符号不可行；
     </li>
     <li>
      void MediaCodec::onMessageReceived(const sp&amp;msg): 已知MediaCodec实例的内存首地址，需要通过hardcode偏移量来获取mReplay、mState两个字段，这里又缺少可供校验正确性的特征，风险略大担心有不同机型的兼容性问题(不同机型新增、删除字段导致偏移量不准)。
     </li>
    </ul>
    <p>
     【踩坑】接着尝试使用与修复DNS崩溃类似思路的保护方案，使用inline-hook代理onMessageReceived函数调用原函数时使用setjmp打锚点，然后使用plt hook代理_android_log_assert函数并在内部检测错误信息为特征字符串时通过longjmp跳转到onMessageReceived函数的锚点并作return操作，精简后的demo如下：
    </p>
    <p>
     <em>
      Plt-hook 库: https://github.com/iqiyi/xHook
     </em>
    </p>
    <pre><code class="prism language-java">#include <span class="token generics"><span class="token punctuation">&lt;</span>iostream<span class="token punctuation">&gt;</span></span>
#include <span class="token generics"><span class="token punctuation">&lt;</span>setjmp<span class="token punctuation">.</span>h<span class="token punctuation">&gt;</span></span>
#include <span class="token generics"><span class="token punctuation">&lt;</span>csignal<span class="token punctuation">&gt;</span></span>

<span class="token keyword">static</span> thread_local jmp_buf _buf<span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token operator">*</span>origin_onMessageReceived <span class="token operator">=</span> nullptr<span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token operator">*</span>origin__android_log_assert <span class="token operator">=</span> nullptr<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">_android_log_assert_proxy</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> cond<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>tag<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> fmt<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//模拟liblog.so的__android_log_assert函数</span>
    std<span class="token operator">::</span><span class="token function">cout</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"__android_log_assert start"</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">endl</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>fmt<span class="token punctuation">,</span> <span class="token string">"postPendingRepliesAndDeferredMessages: mReplyID == null"</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">longjmp</span><span class="token punctuation">(</span>_buf<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//模拟调用origin__android_log_assert，产生崩溃 </span>
    <span class="token function">raise</span><span class="token punctuation">(</span><span class="token constant">SIGABRT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">onMessageReceived_proxy</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>thiz<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>msg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    std<span class="token operator">::</span><span class="token function">cout</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"onMessageReceived_proxy start"</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">endl</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">setjmp</span><span class="token punctuation">(</span>_buf<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//模拟调用onMessageReceived原函数(origin_onMessageReceived)进入崩溃流程</span>
        std<span class="token operator">::</span><span class="token function">cout</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"onMessageReceived_proxy 1"</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">endl</span><span class="token punctuation">;</span>
        <span class="token function">_android_log_assert_proxy</span><span class="token punctuation">(</span>nullptr<span class="token punctuation">,</span> nullptr<span class="token punctuation">,</span> <span class="token string">"postPendingRepliesAndDeferredMessages: mReplyID == null, from kWhatRelease:STOPPING following kWhatError:STOPPING"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        std<span class="token operator">::</span><span class="token function">cout</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"onMessageReceived_proxy 2"</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">endl</span><span class="token punctuation">;</span><span class="token comment">//走不到</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//保护后从此处返回</span>
        std<span class="token operator">::</span><span class="token function">cout</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"onMessageReceived_proxy 3"</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">endl</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    std<span class="token operator">::</span><span class="token function">cout</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"onMessageReceived_proxy end"</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">endl</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    std<span class="token operator">::</span><span class="token function">cout</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"main func start"</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">endl</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     inline-hook: shadowhook_hook_sym_name("libstagefright.so","_ZN7android10MediaCodec17onMessageReceivedERKNS_2spINS_8AMessageEEE",(void *) onMessageReceived_proxy, (void **) &amp;origin_onMessageReceived);
     plhook: xh_core_register("libstagefright.so", "__android_log_assert", (void *) (_android_log_assert_proxy), (void **) (&amp;origin__android_log_assert));
     */</span>
    <span class="token comment">//模拟调用libstagefright.so的_ZN7android10MediaCodec17onMessageReceivedERKNS_2spINS_8AMessageEEE函数</span>
    <span class="token function">onMessageReceived_proxy</span><span class="token punctuation">(</span>nullptr<span class="token punctuation">,</span> nullptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token operator">::</span><span class="token function">cout</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"main func end"</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">endl</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
日志输出
 main func start
onMessageReceived_proxy start
onMessageReceived_proxy 1
__android_log_assert start
onMessageReceived_proxy 3
onMessageReceived_proxy end
main func end
*/</span>
</code></pre>
    <p>
     线下一阵操作猛如虎经测试保护逻辑符合预期，但是在灰度期间踩到栈溢出保护导致错误转移的坑，堆栈如下：
    </p>
    <pre><code class="prism language-java">#<span class="token number">00</span> pc <span class="token number">000000000004e40</span>c  <span class="token operator">/</span>apex<span class="token operator">/</span>com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>runtime<span class="token operator">/</span>lib64<span class="token operator">/</span>bionic<span class="token operator">/</span>libc<span class="token punctuation">.</span>so <span class="token punctuation">(</span>abort<span class="token operator">+</span><span class="token number">164</span><span class="token punctuation">)</span>
#<span class="token number">01</span> pc <span class="token number">0000000000062730</span>  <span class="token operator">/</span>apex<span class="token operator">/</span>com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>runtime<span class="token operator">/</span>lib64<span class="token operator">/</span>bionic<span class="token operator">/</span>libc<span class="token punctuation">.</span>so <span class="token punctuation">(</span>__stack_chk_fail<span class="token operator">+</span><span class="token number">20</span><span class="token punctuation">)</span>
#<span class="token number">02</span> pc <span class="token number">000000000000</span>a768 <span class="token operator">/</span>data<span class="token operator">/</span>app<span class="token operator">/</span><span class="token operator">~</span><span class="token operator">~</span><span class="token class-name">JaQm4SU8wxP7T2GaSWxYkQ</span><span class="token operator">==</span><span class="token operator">/</span>com<span class="token punctuation">.</span>shizhuang<span class="token punctuation">.</span>duapp<span class="token operator">-</span><span class="token class-name">N5RFIB8WurdccMgAVsBang</span><span class="token operator">==</span><span class="token operator">/</span>lib<span class="token operator">/</span>arm64<span class="token operator">/</span>libduhook<span class="token punctuation">.</span>so <span class="token punctuation">(</span>_ZN25CrashMediaCodecProtection5proxyEPvS0_<span class="token punctuation">)</span>
#<span class="token number">03</span> pc <span class="token number">0000000001091</span>c0c  <span class="token punctuation">[</span>anon<span class="token operator">:</span>scudo<span class="token operator">:</span>primary<span class="token punctuation">]</span>
</code></pre>
    <p>
     *关于栈溢出保护机制感兴趣的同学可以参考这篇文章https://bbs.kanxue.com/thread-221762-1.htm
    </p>
    <p>
     （CSPP 第3版 “3.10.3 内存越界引用和缓冲区溢出”章节讲的更详细）*
    </p>
    <p>
     longjmp函数只是恢复寄存器的值后从锚点处再次返回，过程中也唯一可能会操作栈祯只有inline-hook，当时怀疑是与setjmp/longjmp机制不兼容，由于inline-hook内部逻辑大量使用汇编来实现排查起来比较困难，因此这个问题困扰比较久，网上的资料提到可以使用代理出错函数(__stack_chk_fail)或者编译so时增加参数不让编译器生成保护代码来绕过，这两种方式影响面都比较大所以未采用。有了前面的怀疑点想到使用c++的try catch机制来做跨函数域的跳转，大致的思路同上只是把setjmp替换为c++的try catch，把longjmp替换为throw exception，精简后的demo如下：
    </p>
    <p>
     <em>
      c++异常机制介绍: https://baiy.cn/doc/cpp/inside_exception.htm
     </em>
    </p>
    <pre><code class="prism language-java">#include <span class="token generics"><span class="token punctuation">&lt;</span>iostream<span class="token punctuation">&gt;</span></span>
#include <span class="token generics"><span class="token punctuation">&lt;</span>csignal<span class="token punctuation">&gt;</span></span>

<span class="token keyword">void</span> <span class="token operator">*</span>origin_onMessageReceived <span class="token operator">=</span> nullptr<span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token operator">*</span>origin__android_log_assert <span class="token operator">=</span> nullptr<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">MyCustomException</span> <span class="token operator">:</span> <span class="token keyword">public</span> std<span class="token operator">::</span><span class="token function">exception</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    explicit <span class="token class-name">MyCustomException</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">::</span><span class="token function">string</span><span class="token operator">&amp;</span> message<span class="token punctuation">)</span>
            <span class="token operator">:</span> <span class="token function">msg_</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

    virtual <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token function">what</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> noexcept override <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> msg_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    std<span class="token operator">::</span><span class="token function">string</span> msg_<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">_android_log_assert_proxy</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> cond<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>tag<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> fmt<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//模拟liblog.so的__android_log_assert函数</span>
    std<span class="token operator">::</span><span class="token function">cout</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"__android_log_assert start"</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">endl</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>fmt<span class="token punctuation">,</span> <span class="token string">"postPendingRepliesAndDeferredMessages: mReplyID == null"</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token class-name">MyCustomException</span><span class="token punctuation">(</span><span class="token string">"postPendingRepliesAndDeferredMessages: mReplyID == null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//模拟调用origin__android_log_assert，产生崩溃</span>
    <span class="token function">raise</span><span class="token punctuation">(</span><span class="token constant">SIGABRT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">onMessageReceived_proxy</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>thiz<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>msg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    std<span class="token operator">::</span><span class="token function">cout</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"onMessageReceived_proxy start"</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">endl</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//模拟调用onMessageReceived原函数(origin_onMessageReceived)进入崩溃流程</span>
        std<span class="token operator">::</span><span class="token function">cout</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"onMessageReceived_proxy 1"</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">endl</span><span class="token punctuation">;</span>
        <span class="token function">_android_log_assert_proxy</span><span class="token punctuation">(</span>nullptr<span class="token punctuation">,</span> nullptr<span class="token punctuation">,</span> <span class="token string">"postPendingRepliesAndDeferredMessages: mReplyID == null, from kWhatRelease:STOPPING following kWhatError:STOPPING"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        std<span class="token operator">::</span><span class="token function">cout</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"onMessageReceived_proxy 2"</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">endl</span><span class="token punctuation">;</span><span class="token comment">//走不到</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token class-name">MyCustomException</span><span class="token operator">&amp;</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//保护后从此处返回</span>
        std<span class="token operator">::</span><span class="token function">cout</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"onMessageReceived_proxy 3"</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">endl</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    std<span class="token operator">::</span><span class="token function">cout</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"onMessageReceived_proxy end"</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">endl</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    std<span class="token operator">::</span><span class="token function">cout</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"main func start"</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">endl</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     inline-hook: shadowhook_hook_sym_name("libstagefright.so","_ZN7android10MediaCodec17onMessageReceivedERKNS_2spINS_8AMessageEEE",(void *) onMessageReceived_proxy, (void **) &amp;origin_onMessageReceived);
     plhook: xh_core_register("libstagefright.so", "__android_log_assert", (void *) (_android_log_assert_proxy), (void **) (&amp;origin__android_log_assert));
     */</span>
    <span class="token comment">//模拟调用libstagefright.so的_ZN7android10MediaCodec17onMessageReceivedERKNS_2spINS_8AMessageEEE函数</span>
    <span class="token function">onMessageReceived_proxy</span><span class="token punctuation">(</span>nullptr<span class="token punctuation">,</span> nullptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token operator">::</span><span class="token function">cout</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"main func end"</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">endl</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
日志输出
 main func start
onMessageReceived_proxy start
onMessageReceived_proxy 1
__android_log_assert start
onMessageReceived_proxy 3
onMessageReceived_proxy end
main func end
*/</span>
</code></pre>
    <p>
     灰度上线后发现有设备走到了_android_log_assert代理函数中的throw逻辑，但是未按预期走到catch块而是把错误又转移为" terminating with uncaught exception of type" ，有点搞心态啊。
    </p>
    <p>
     【柳暗花明】C++的异常处理机制在throw执行时，会开始在调用栈中向上查找匹配的catch块，检查每一个函数直到找到一个具有合适类型的catch块，上述的错误信息代表未找到匹配的catch块。从转移的堆栈中注意到没有onMessageReceived代理函数的堆栈，此时基于inline-hook的原理(修改原函数前面的汇编代码跳转到代理函数)又怀疑到它身上，再次排查代码时发现代理函数开头漏写了一个宏，在inline-hook中SHADOWHOOK_STACK_SCOPE就是来管理栈祯的，因此出现找不到catch块以及前面longjmp的问题就不奇怪了。加上这个宏以后柳暗花明，重新放量后保护逻辑按预期执行并且保护生效后视频播放正常。和音视频的小伙伴一努力下，经历了几个版本终于解决了这个系统bug，目前仅剩老版本App有零星的上报。
    </p>
    <h2>
     <a id="bio_345">
     </a>
     四、bio多线程环境崩溃
    </h2>
    <h3>
     <a id="_347">
     </a>
     背景
    </h3>
    <p>
     Android 11 Socket close过程中在多线程场景下有几率产生野指针问题导致Native Crash，现象是多个线程同时close连接时，一个线程已销毁了bio的上下文，另外一个线程仍执行close并在此过程中尝试获取这个bio有多少未写出去的字节数时出现野指针导致的段错误。此问题从21年首次上报以来在得物的Crash列表中一直处于较前的位置。
    </p>
    <p>
     <em>
      堆栈与上报趋势
     </em>
    </p>
    <pre><code class="prism language-Java">at com.android.org.conscrypt.NativeCrypto.SSL_pending_written_bytes_in_BIO(Native method)
at com.android.org.conscrypt.NativeSsl$BioWrapper.getPendingWrittenBytes(NativeSsl.java:660)
at com.android.org.conscrypt.ConscryptEngine.pendingOutboundEncryptedBytes(ConscryptEngine.java:566)
at com.android.org.conscrypt.ConscryptEngineSocket.drainOutgoingQueue(ConscryptEngineSocket.java:584)
at com.android.org.conscrypt.ConscryptEngineSocket.close(ConscryptEngineSocket.java:480)
at okhttp3.internal.Util.closeQuietly_aroundBody0(Util.java:1)
at okhttp3.internal.Util$AjcClosure1.run(Util.java:1)
at org.aspectj.runtime.reflect.JoinPointImpl.proceed(JoinPointImpl.java:3)
at com.shizhuang.duapp.common.aspect.ThirdSdkAspect.t(ThirdSdkAspect.java:1)
at okhttp3.internal.Util.closeQuietly(Util.java:3)
at okhttp3.internal.connection.ExchangeFinder.findConnection(ExchangeFinder.java:42)
at okhttp3.internal.connection.ExchangeFinder.findHealthyConnection(ExchangeFinder.java:1)
at okhttp3.internal.connection.ExchangeFinder.find(ExchangeFinder.java:6)
at okhttp3.internal.connection.Transmitter.newExchange(Transmitter.java:5)
at okhttp3.internal.connection.ConnectInterceptor.intercept(ConnectInterceptor.java:5)

#00 pc 0000000000064060  /system/lib64/libcrypto.so (bio_ctrl+144)
#01 pc 00000000000615d8  /system/lib64/libcrypto.so (BIO_ctrl_pending+40)
#02 pc 00000000000387dc  /apex/com.android.conscrypt/lib64/libjavacrypto.so (_ZL45NativeCrypto_SSL_pending_written_bytes_in_BIOP7_JNIEnvP7_jclassl+20)
</code></pre>
    <p>
     <img alt="bio多线程.jpeg" src="https://i-blog.csdnimg.cn/img_convert/50df4cc16ca334df1d8fc5b7f24d1560.jpeg"/>
    </p>
    <h3>
     <a id="_377">
     </a>
     问题分析
    </h3>
    <p>
     从设备分布上看，出问题都全是Android 11且各个国内厂商的设备都有，怀疑是Android 11引入的bug，对比了Android 11 和 Android 12的源码，发现在Android12 崩溃堆栈中的相关类 com.android.org.conscrypt.NativeSsl$BioWrapper有四个方法增加了读写锁，此时怀疑是多线程问题，通过搜索Android源码的相关issue以及差异代码的MR描述信息，进一步确认此结论。通过源码进一步分析发现NativeSsl的所有加锁的方法，会分发到NativeCrypto.java中的native方法，最终调用到native_crypto.cc中的JNI函数，如果能hook到相关的native函数并在Native层实现与Android12相同的读写锁逻辑，这个问题就可以解决了。
    </p>
    <p>
     <em>
      https://cs.android.com/android/platform/superproject/+/android-12.0.0_r1:external/conscrypt/repackaged/common/src/main/java/com/android/org/conscrypt/NativeSsl.java
      <br/>
      https://cs.android.com/android/platform/superproject/+/android-11.0.0_r48:external/conscrypt/repackaged/common/src/main/java/com/android/org/conscrypt/NativeCrypto.java
      <br/>
      https://cs.android.com/android/platform/superproject/+/android-11.0.0_r48:external/conscrypt/common/src/jni/main/cpp/conscrypt/native_crypto.cc
     </em>
    </p>
    <h3>
     <a id="_389">
     </a>
     解决过程
    </h3>
    <p>
     通过JNI hook代理Android12中增加锁的相关函数，当走到代理函数中时，先分发到JAVA层通过反射获取ReadWriteLock实例并上锁再通过跳板函数调用原来的JNI函数，此时就完成了对Android12 增量锁逻辑的复刻。经历了两个版本的灰度hook方案已稳定在线上运行，期间无因hook导致的网络不可用和其它崩溃问题，目前开关放全量的版本崩溃设备数已降为0。
    </p>
    <p>
     <img alt="解决过程.jpeg" src="https://i-blog.csdnimg.cn/img_convert/45dd64e307fbc43cb5578e6b43b13711.jpeg"/>
     <br/>
     <em>
      JNI hook原理，以及详细修复过程: https://blog.dewu-inc.com/article/MTMwNDU?fromType=personal_blog
     </em>
    </p>
    <h2>
     <a id="Android15__398">
     </a>
     五、小米Android15 焦点处理空指针崩溃
    </h2>
    <h3>
     <a id="_400">
     </a>
     背景
    </h3>
    <p>
     随着Android15开放公测，焦点处理过程中发生的空指针问题逐步增多，并在1月份上升到Top。
    </p>
    <p>
     <em>
      堆栈与上报趋势
     </em>
    </p>
    <pre><code class="prism language-java"><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>NullPointerException</span><span class="token operator">:</span> <span class="token class-name">Attempt</span> <span class="token keyword">to</span> <span class="token namespace">invoke</span> virtual method '<span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span>ViewGroup</span>$<span class="token class-name">LayoutParams</span> <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span>View</span><span class="token punctuation">.</span><span class="token function">getLayoutParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span>' on a <span class="token keyword">null</span> object reference
at <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span>ViewRootImpl</span><span class="token punctuation">.</span><span class="token function">handleWindowFocusChanged</span><span class="token punctuation">(</span><span class="token class-name">ViewRootImpl</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">5307</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span>ViewRootImpl</span><span class="token punctuation">.</span>-$$<span class="token class-name">Nest</span>$<span class="token function">mhandleWindowFocusChanged</span><span class="token punctuation">(</span><span class="token class-name">Unknown</span> <span class="token class-name">Source</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span>ViewRootImpl</span>$<span class="token class-name">ViewRootHandler</span><span class="token punctuation">.</span><span class="token function">handleMessageImpl</span><span class="token punctuation">(</span><span class="token class-name">ViewRootImpl</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">7715</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span>ViewRootImpl</span>$<span class="token class-name">ViewRootHandler</span><span class="token punctuation">.</span><span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token class-name">ViewRootImpl</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">7611</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span>Handler</span><span class="token punctuation">.</span><span class="token function">dispatchMessage</span><span class="token punctuation">(</span><span class="token class-name">Handler</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">107</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span>Looper</span><span class="token punctuation">.</span><span class="token function">loopOnce</span><span class="token punctuation">(</span><span class="token class-name">Looper</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">249</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span>Looper</span><span class="token punctuation">.</span><span class="token function">loop</span><span class="token punctuation">(</span><span class="token class-name">Looper</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">337</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>app<span class="token punctuation">.</span></span>ActivityThread</span><span class="token punctuation">.</span><span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">ActivityThread</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">9568</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span>Method</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Native</span> <span class="token class-name">Method</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span>RuntimeInit</span>$<span class="token class-name">MethodAndArgsCaller</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">RuntimeInit</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">593</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span>ZygoteInit</span><span class="token punctuation">.</span><span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">ZygoteInit</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">935</span><span class="token punctuation">)</span>
</code></pre>
    <h3>
     <a id="_426">
     </a>
     问题分析
    </h3>
    <p>
     通过分析ASOP的源码，崩溃的触发点是mView字段为空。
    </p>
    <p>
     <em>
      https://cs.android.com/android/platform/superproject/main/+/main:frameworks/base/core/java/android/view/ViewRootImpl.java;drc=98e96368cc73432efbacd6fbcf61fe789dcec0ee;l=7243?q=ViewRootImpl
     </em>
    </p>
    <p>
     <img alt="问题分析5.jpeg" src="https://i-blog.csdnimg.cn/img_convert/9dee5f96335e2ef510738f74049ed490.jpeg"/>
     <br/>
     源码中mView为空的情况有两种：
    </p>
    <ul>
     <li>
      未调用setView方法前触发窗口焦点变化事件（只有setView方法才会给mView赋不为空的值）。
     </li>
     <li>
      先正常调用setView使mView不为空，其它地方置为空。
     </li>
    </ul>
    <p>
     结合前置判断了mAdded为true才会走到崩溃点，在源码中寻找到只有先正常调用setView以后在调用dispatchDetachedFromWindow时才满足mAdded=true、mView=null的条件，从采集的logcat日志中可以证明这一点，此时基本可以定位根因是窗口销毁与焦点事件处理的时序问题。
    </p>
    <p>
     <img alt="时序问题.jpeg" src="https://i-blog.csdnimg.cn/img_convert/cda16f593f2e9d280f61fa77875b8084.jpeg"/>
     <br/>
     <img alt="时序问题2.jpeg" src="https://i-blog.csdnimg.cn/img_convert/af9251dfcb90867e3ef32ac2160c6520.jpeg"/>
    </p>
    <h3>
     <a id="_450">
     </a>
     解决过程
    </h3>
    <p>
     在问题初期，尝试通过 Hook 拦截 handleWindowFocusChanged 方法增加防御：当检测到 mView 为空时直接中断后续逻辑执行。本地验证阶段，通过在 Android 15 设备上高频触发商详页 Dialog 弹窗的焦点获取与关闭操作，未复现线上崩溃问题。考虑到 Hook 方案的侵入性风险 ，且无法本地测试，最终放弃此方案上线。
    </p>
    <p>
     通过崩溃日志分析发现，问题设备100% 集中在小米/红米机型，而该品牌在 Android 15 DAU中仅占 36% ，因此怀疑是MIUI对Android15某些定制功能有bug。经与小米技术团队数周的沟通与联合排查，最终小米在v2.0.28版本修复了此问题，需要用户升级ROM解决，目前&gt;=2.0.28的MIUI设备无此问题的上报。
    </p>
    <h2>
     <a id="_460">
     </a>
     六、总结
    </h2>
    <p>
     通过上述问题的治理，系统bug类的崩溃显著减少，希望这些经验对大家有所帮助。
    </p>
    <p>
     文 / 亚鹏
    </p>
    <p>
     关注得物技术，每周更新技术干货
    </p>
    <p>
     要是觉得文章对你有帮助的话，欢迎评论转发点赞～
    </p>
    <p>
     未经得物技术许可严禁转载，否则依法追究法律责任。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f:672e6373646e2e6e65742f536d617274436f6465546563682f:61727469636c652f64657461696c732f313436323336303335" class_="artid" style="display:none">
 </p>
</div>


