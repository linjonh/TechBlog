---
layout: post
title: "项目基于FreeRTOS的STM32四轴飞行器-六.2.4g通信"
date: 2025-03-08 17:36:35 +0800
description: "进行了2.4g通信模块的学习和调试"
keywords: "飞控能freertos系统吗"
categories: ['基于Freertos的Stm32四轴飞行器']
tags: ['嵌入式硬件', '单片机', 'Stm', 'Mcu', 'Iot', 'C']
artid: "146101619"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146101619
    alt: "项目基于FreeRTOS的STM32四轴飞行器-六.2.4g通信"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146101619
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146101619
cover: https://bing.ee123.net/img/rand?artid=146101619
image: https://bing.ee123.net/img/rand?artid=146101619
img: https://bing.ee123.net/img/rand?artid=146101619
---

# [项目]基于FreeRTOS的STM32四轴飞行器: 六.2.4g通信

## 一.Si24Ri原理图

Si24R1芯片原理图如下：  
右侧为晶振。  
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/8843e4f59da74150a6babe0c89a7b591.png)  
模块芯片与主控芯片连接引脚如下：  
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/e182e74091414ad6a03c646c5ae4e1d9.png)  
SI-EN：使能引脚。  
SI-IRO：可屏蔽中断信号，低电平有效。  
SPI1-NSS：片选信号。  
SPI1-CLK：时钟信号。  
SPI1-MOSI：主设备输出从设备输入。  
SPI1-MISO：主设备输入从设备输出。

## 二.Si24R1芯片手册解读

![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/38aac8bb4dcd4a06975e32fa2d7a95e8.png)  
信道取值范围1到126，如果两个人同时使用一个信道会导致干扰。  
**状态机转换图：**  
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/6fcd6ee6376a46f5b60314ccd9992de9.png)  
**TX工作模式：**  
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/088adfc62d0a4450982d51967634a410.png)  
**RX工作模式：**  
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/58400600351e443991a263e47ce9afa6.png)  
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/7b5f60312b644f46a9b3e26c096a1644.png)  
当芯片数据过多处理不过来时，FIFO中可以存储三个数据包起到存储缓冲作用，当满了时接收到的数据包被自动丢掉。所以最好**协调发送接收的频率**
相等，或者发送稍微慢一些。  
**数据包处理协议：**  
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/c50029c378e84e9d99ae951760c3b4f0.png)  
在实际代码编写时在负载数据中加入自己的数据校验。  
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/05e5863c8cb84e09a808e7af32b6e29d.png)

## 三.驱动函数讲解

**定义两个地址：**  
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/ba06354192ef41bb96c6c9b52469c8c7.png)  
**定义两个缓冲区：**  
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/acd99f2cb813454d9a08fcdaf8d8984b.png)  
**在.h文件中extern两个缓冲区：**  
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/d1739fc189734fa9bbcb8fd359936a88.png)  
**标记位：**  
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/511f6f9e8b7448819822328ae2dd5cd1.png)  
**写寄存器：**  
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/5762b99f71f640e096f81d69aa29a3e1.png)  
**读寄存器：**  
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/2da678e2c9b24204830b84fb35b5d72f.png)  
**写多个字节：**  
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/31cc6cf054894fe08420c46008851fec.png)  
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/131db5970d0940fa891bacdc22921568.png)  
**自检判断校验是否成功：**  
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/8725392f36ca4147addbec38f515f2fd.png)  
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/02535ee6d9464ea3af5041a2440588dd.png)

## 五.移植2.4g通讯（飞控部分）

文件夹创建.c.h文件，将代码复制粘贴进文件：  
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/d2554cda891846f3a67c4f9fbb191656.png)  
配置为全双工模式，不能超过18M，设置为4分频：  
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/10fcce5f10a7403b994f8151af49a55e.png)  
观察配置引脚是否与原理图一致：  
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/1ad72d7c713d45ddbc06e76bd8120f2b.png)  
配置片选信号NSS低电平有效，所以PA4引脚设置为高电平，使用时拉低电平：  
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/ab34f3d4267343bc896a8e83c9544329.png)  
配置使能信号，默认使能：  
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/bd04ab6825464d838a772b9edd9d4382.png)  
配置IRQ中断输入引脚，低电平有效默认上拉：  
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/1e9fe9ec94114586a55ac0da866f1888.png)  
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/e31e2e6060dd461c8b88d58fc73c7cd7.png)  
.h文件2.4g通道设置：  
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/202ea09484734ebb872d27799d9c56e3.png)  
将该函数Driver_SPI_SwapByte定义：  
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/2598957e4483414b9dd41a42bf2527be.png)  
在应用层编写Start函数，在中间自检：  
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/18c4e3c7b7f24c94b43026c4c47c70a9.png)  
App_Task中编写通信任务：  
与飞控任务优先级保持一致，与飞控任务重要性差不多。  
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/24b97f4cb5ac4fad9e29f58716283199.png)  
**测试通讯任务：**  
因为通讯任务和飞控任务优先级相同，所以可能会导致硬件出问题，在该处开头延时1000ms。使用Inf_Si24R1_TxPacket函数接受数据包，将数据保存在RX_BUFF中，返回值0接收到数据，1未接收到数据。  
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/d340ec747bcb427d9659d0bcaec53346.png)  
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/350736611d594878ae69dfe670d16635.png)

## 六.移植2.4g通讯（遥控部分）

**根据原理图配置SPI接口：**  
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/60644356ee5447159947ca1c28af3c6a.png)  
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/784ed3e9600144b28c33a29131d22fe6.png)  
**在keil中配置.h文件：**  
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/395eb508e216477abeb0c860b5f8b93c.png)  
**管理目录结构：**  
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/ee6fc079134e4b978f09a04f06c6ab89.png)  
删除多余功能后，**编写通讯任务：**  
将数据填入TX_BUFF并根据返回值判读发射成功与否。  
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/455e7190620042a7ac5528513f80e8fa.png)  
**配置为发送模式：**  
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/00e8e808867b4fc0bf45f05a8dfd11bb.png)  
根据原理图**更改为串口一：**  
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/0f5dba53f08c4b46aecb9a0f35208880.png)  
**飞控端** 串口有数据打印，通讯正常：  
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/f2a4ca7b65164d628c1921482e14c303.png)



