---
layout: post
title: "MyBatis源码分析配置文件解析"
date: 2025-03-15 21:07:26 +0800
description: "本篇主要介绍MyBatis源码中的配置文件解析部分。MyBatis是对于传统JDBC的封装，屏蔽了传统JDBC与数据库进行交互，组装参数，获取查询结果并自己封装成对象的繁琐过程。原生MyBatis首先需要配置> <!> <!> <!> <!> <!> <!> <!> <!> <!> <!> <!> <!> <!> <!> <!> <!> <!> <!> <!> <!> <!> <!> <!> <!> <!> <!> <!> <!> <!> <!> <!> <!> <!> <!> <!> <!</> <"
keywords: "MyBatis源码分析の配置文件解析"
categories: ['源码分析']
tags: ['后端', 'Mybatis', 'Java']
artid: "146282276"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146282276
    alt: "MyBatis源码分析配置文件解析"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146282276
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146282276
cover: https://bing.ee123.net/img/rand?artid=146282276
image: https://bing.ee123.net/img/rand?artid=146282276
img: https://bing.ee123.net/img/rand?artid=146282276
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     MyBatis源码分析の配置文件解析
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-github-gist" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <p>
    </p>
    <hr/>
    <h2>
     <a id="_4">
     </a>
     前言
    </h2>
    <p>
     本篇主要介绍MyBatis源码中的
     <code>
      配置文件解析
     </code>
     部分。MyBatis是对于传统JDBC的封装，屏蔽了传统JDBC与数据库进行交互，组装参数，获取查询结果并自己封装成对象的繁琐过程。
     <br/>
     原生MyBatis首先需要配置
     <code>
      mybatis-config.xml
     </code>
     ：
    </p>
    <pre><code class="prism language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span>
<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">configuration</span> <span class="token name">PUBLIC</span> <span class="token string">"-//mybatis.org//DTD Config 3.0//EN"</span>
        <span class="token string">"http://mybatis.org/dtd/mybatis-3-config.dtd"</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span> <span class="token attr-name">resource</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>jdbc.properties<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>environments</span> <span class="token attr-name">default</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dev<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>environment</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dev<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>transactionManager</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>JDBC<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dataSource</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>POOLED<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>driver<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>${jdbc.driver}<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>url<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>${jdbc.url}<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>${jdbc.username}<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>${jdbc.password}<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dataSource</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>environment</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>environments</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mappers</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapper</span> <span class="token attr-name">resource</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mapper/UserMapper.xml<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mappers</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
</code></pre>
    <p>
     并且指定数据源
     <code>
      jdbc.properties
     </code>
     ：
    </p>
    <pre><code class="prism language-xml">jdbc.driver=com.mysql.cj.jdbc.Driver
jdbc.url=jdbc:mysql://localhost:3306/test?useSSL=false&amp;serverTimezone=UTC
jdbc.username=root
jdbc.password=123456
</code></pre>
    <p>
     创建数据库访问层接口：
    </p>
    <pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserMapper</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> <span class="token function">selectAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">User</span> <span class="token function">selectById</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">insert</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     以及对应的xml文件：
    </p>
    <pre><code class="prism language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span>
<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">mapper</span> <span class="token name">PUBLIC</span> <span class="token string">"-//mybatis.org//DTD Mapper 3.0//EN"</span>
        <span class="token string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapper</span> <span class="token attr-name">namespace</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.example.mybatis.mapper.UserMapper<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>cache</span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resultMap</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>userResultMap<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.example.mybatis.entity.User<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>age<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>age<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resultMap</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>selectAll<span class="token punctuation">"</span></span> <span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>userResultMap<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        SELECT * FROM users
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>selectById<span class="token punctuation">"</span></span> <span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>userResultMap<span class="token punctuation">"</span></span> <span class="token attr-name">parameterType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>int<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        SELECT * FROM users WHERE id = #{id}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>insert</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>insert<span class="token punctuation">"</span></span> <span class="token attr-name">parameterType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.example.mybatis.entity.User<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        INSERT INTO users (name, age) VALUES (#{name}, #{age})
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>insert</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>update</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>update<span class="token punctuation">"</span></span> <span class="token attr-name">parameterType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.example.mybatis.entity.User<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        UPDATE users SET name = #{name}, age = #{age} WHERE id = #{id}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>update</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>delete</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>delete<span class="token punctuation">"</span></span> <span class="token attr-name">parameterType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>int<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        DELETE FROM users WHERE id = #{id}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>delete</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mapper</span><span class="token punctuation">&gt;</span></span>
</code></pre>
    <p>
     <code>
      mybatis-config.xml
     </code>
     常见的标签：
    </p>
    <table>
     <thead>
      <tr>
       <th>
        标签
       </th>
       <th>
        作用
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        <code>
         &lt;settings&gt;
        </code>
       </td>
       <td>
        控制 MyBatis 全局行为（缓存、懒加载、日志等）
       </td>
      </tr>
      <tr>
       <td>
        <code>
         &lt;typeAliases&gt;
        </code>
       </td>
       <td>
        设置类型别名，简化 Mapper XML 中类名书写
       </td>
      </tr>
      <tr>
       <td>
        <code>
         &lt;typeHandlers&gt;
        </code>
       </td>
       <td>
        自定义类型转换器（Java类型 ↔ JDBC类型）
       </td>
      </tr>
      <tr>
       <td>
        <code>
         &lt;plugins&gt;
        </code>
       </td>
       <td>
        注册插件（如分页插件、SQL打印等）
       </td>
      </tr>
      <tr>
       <td>
        <code>
         &lt;objectFactory&gt;
        </code>
       </td>
       <td>
        自定义对象创建逻辑
       </td>
      </tr>
      <tr>
       <td>
        <code>
         &lt;environments&gt;
        </code>
       </td>
       <td>
        配置数据库环境及事务管理
       </td>
      </tr>
      <tr>
       <td>
        <code>
         &lt;mappers&gt;
        </code>
       </td>
       <td>
        注册 Mapper 映射文件或 Mapper 接口
       </td>
      </tr>
     </tbody>
    </table>
    <p>
     原生MyBatis的使用，其中读取配置文件并进行解析，主要体现在
     <code>
      SqlSessionFactoryBuilder
     </code>
     的
     <code>
      build
     </code>
     方法中：
    </p>
    <pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//将xml构筑成configuration配置类</span>
        <span class="token class-name">Reader</span> reader <span class="token operator">=</span> <span class="token class-name">Resources</span><span class="token punctuation">.</span><span class="token function">getResourceAsReader</span><span class="token punctuation">(</span><span class="token string">"mybatis-config.xml"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//解析xml，注册成SqlSessionFactory</span>
        <span class="token class-name">SqlSessionFactory</span> sqlSessionFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SqlSessionFactoryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>reader<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">SqlSession</span> session <span class="token operator">=</span> sqlSessionFactory<span class="token punctuation">.</span><span class="token function">openSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

            <span class="token class-name">User</span> user <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span><span class="token string">"com.example.mybatis.mapper.UserMapper.selectById"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h2>
     <a id="SqlSessionFactoryBuilder_121">
     </a>
     一、SqlSessionFactoryBuilder
    </h2>
    <h3>
     <a id="11XMLConfigBuilder_123">
     </a>
     1.1、XMLConfigBuilder
    </h3>
    <p>
     在调用
     <code>
      SqlSessionFactoryBuilder
     </code>
     的
     <code>
      build
     </code>
     方法时，首先会去创建一个
     <code>
      XMLConfigBuilder
     </code>
     ，目的是构建一个XML配置文件解析器对象。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/0594157ddf914c64a3241e4279993588.png">
      其中的核心代码，这段代码的作用是注册别名，将配置文件中的 “JDBC”、"POOLED"等关键词和实际的类型进行绑定。
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/7a2ee64c29c045dbab46f8b44bd0dc6a.png"/>
     </img>
    </p>
    <table>
     <thead>
      <tr>
       <th>
        别名
       </th>
       <th>
        实际类
       </th>
       <th>
        用途
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        <code>
         "JDBC"
        </code>
       </td>
       <td>
        <code>
         JdbcTransactionFactory
        </code>
       </td>
       <td>
        JDBC事务管理器（默认事务方式）
       </td>
      </tr>
      <tr>
       <td>
        <code>
         "MANAGED"
        </code>
       </td>
       <td>
        <code>
         ManagedTransactionFactory
        </code>
       </td>
       <td>
        受容器管理的事务（如 Spring）
       </td>
      </tr>
      <tr>
       <td>
        <code>
         "JNDI"
        </code>
       </td>
       <td>
        <code>
         JndiDataSourceFactory
        </code>
       </td>
       <td>
        从 JNDI 获取数据源
       </td>
      </tr>
      <tr>
       <td>
        <code>
         "POOLED"
        </code>
       </td>
       <td>
        <code>
         PooledDataSourceFactory
        </code>
       </td>
       <td>
        数据库连接池（MyBatis 内置）
       </td>
      </tr>
      <tr>
       <td>
        <code>
         "UNPOOLED"
        </code>
       </td>
       <td>
        <code>
         UnpooledDataSourceFactory
        </code>
       </td>
       <td>
        不使用连接池的数据源
       </td>
      </tr>
      <tr>
       <td>
        <code>
         "PERPETUAL"
        </code>
       </td>
       <td>
        <code>
         PerpetualCache
        </code>
       </td>
       <td>
        永久缓存
       </td>
      </tr>
      <tr>
       <td>
        <code>
         "FIFO"
        </code>
       </td>
       <td>
        <code>
         FifoCache
        </code>
       </td>
       <td>
        先进先出缓存
       </td>
      </tr>
      <tr>
       <td>
        <code>
         "LRU"
        </code>
       </td>
       <td>
        <code>
         LruCache
        </code>
       </td>
       <td>
        最近最少使用缓存
       </td>
      </tr>
      <tr>
       <td>
        <code>
         "SOFT"
        </code>
       </td>
       <td>
        <code>
         SoftCache
        </code>
       </td>
       <td>
        基于 SoftReference 的缓存
       </td>
      </tr>
      <tr>
       <td>
        <code>
         "WEAK"
        </code>
       </td>
       <td>
        <code>
         WeakCache
        </code>
       </td>
       <td>
        基于 WeakReference 的缓存
       </td>
      </tr>
      <tr>
       <td>
        <code>
         "DB_VENDOR"
        </code>
       </td>
       <td>
        <code>
         VendorDatabaseIdProvider
        </code>
       </td>
       <td>
        根据数据库类型自动切换 SQL
       </td>
      </tr>
      <tr>
       <td>
        <code>
         "XML"
        </code>
       </td>
       <td>
        <code>
         XMLLanguageDriver
        </code>
       </td>
       <td>
        MyBatis 默认的 XML SQL 语言驱动器
       </td>
      </tr>
      <tr>
       <td>
        <code>
         "RAW"
        </code>
       </td>
       <td>
        <code>
         RawLanguageDriver
        </code>
       </td>
       <td>
        原生 SQL 写法语言驱动器
       </td>
      </tr>
      <tr>
       <td>
        <code>
         "SLF4J"
        </code>
       </td>
       <td>
        <code>
         Slf4jImpl
        </code>
       </td>
       <td>
        使用 SLF4J 的日志输出
       </td>
      </tr>
      <tr>
       <td>
        <code>
         "COMMONS_LOGGING"
        </code>
       </td>
       <td>
        <code>
         JakartaCommonsLoggingImpl
        </code>
       </td>
       <td>
        使用 Commons Logging 日志
       </td>
      </tr>
      <tr>
       <td>
        <code>
         "LOG4J"
        </code>
       </td>
       <td>
        <code>
         Log4jImpl
        </code>
       </td>
       <td>
        使用 Log4j 日志
       </td>
      </tr>
      <tr>
       <td>
        <code>
         "LOG4J2"
        </code>
       </td>
       <td>
        <code>
         Log4j2Impl
        </code>
       </td>
       <td>
        使用 Log4j2 日志
       </td>
      </tr>
      <tr>
       <td>
        <code>
         "JDK_LOGGING"
        </code>
       </td>
       <td>
        <code>
         Jdk14LoggingImpl
        </code>
       </td>
       <td>
        使用 JDK 内建日志
       </td>
      </tr>
      <tr>
       <td>
        <code>
         "STDOUT_LOGGING"
        </code>
       </td>
       <td>
        <code>
         StdOutImpl
        </code>
       </td>
       <td>
        输出日志到控制台
       </td>
      </tr>
      <tr>
       <td>
        <code>
         "NO_LOGGING"
        </code>
       </td>
       <td>
        <code>
         NoLoggingImpl
        </code>
       </td>
       <td>
        不输出日志
       </td>
      </tr>
      <tr>
       <td>
        <code>
         "CGLIB"
        </code>
       </td>
       <td>
        <code>
         CglibProxyFactory
        </code>
       </td>
       <td>
        使用 CGLIB 动态代理
       </td>
      </tr>
      <tr>
       <td>
        <code>
         "JAVASSIST"
        </code>
       </td>
       <td>
        <code>
         JavassistProxyFactory
        </code>
       </td>
       <td>
        使用 Javassist 动态代理
       </td>
      </tr>
     </tbody>
    </table>
    <h3>
     <a id="12parse_155">
     </a>
     1.2、parse
    </h3>
    <p>
     真正解析配置文件的是利用上一步构造出的
     <code>
      XMLConfigBuilder
     </code>
     的
     <code>
      parse
     </code>
     方法，首先会进行判断，如果已经解析过，则抛出异常，不会重复解析：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/0fb6d72be4ea4d5fa588029868dd80b7.png">
      否则就将标记设置为true。并且执行
      <code>
       parseConfiguration
      </code>
      方法，从根节点进行解析：
      <br/>
      每一行都对应了一个 &lt;mybatis-config.xml&gt; 中的标签，逐步填充 Configuration 对象内容：
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/37e0f047cfd14217a3ac8c65f35d5c56.png"/>
     </img>
    </p>
    <pre><code class="prism language-java"><span class="token comment">/**
 * 解析 &lt;configuration&gt; 根节点的各个子标签，并将配置信息填充到 Configuration 对象中
 */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">parseConfiguration</span><span class="token punctuation">(</span><span class="token class-name">XNode</span> root<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 【1】先解析 &lt;properties&gt; 标签（必须最优先解析），以便后续标签中的占位符 ${} 能被正确替换</span>
    <span class="token function">propertiesElement</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span><span class="token function">evalNode</span><span class="token punctuation">(</span><span class="token string">"properties"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 【2】解析 &lt;settings&gt; 标签，将其内容转换为 Properties 对象</span>
    <span class="token class-name">Properties</span> settings <span class="token operator">=</span> <span class="token function">settingsAsProperties</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span><span class="token function">evalNode</span><span class="token punctuation">(</span><span class="token string">"settings"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 【3】解析 settings 中的 vfsImpl 属性（如果配置了自定义 VFS 实现类）</span>
    <span class="token function">loadCustomVfs</span><span class="token punctuation">(</span>settings<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 【4】解析 settings 中的 logImpl 属性（设置日志实现类，如 LOG4J、STDOUT_LOGGING 等）</span>
    <span class="token function">loadCustomLogImpl</span><span class="token punctuation">(</span>settings<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 【5】解析 &lt;typeAliases&gt; 标签，注册用户自定义的别名或包扫描别名</span>
    <span class="token function">typeAliasesElement</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span><span class="token function">evalNode</span><span class="token punctuation">(</span><span class="token string">"typeAliases"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 【6】解析 &lt;plugins&gt; 标签，注册 MyBatis 插件（如分页插件、SQL 拦截器等）</span>
    <span class="token function">pluginElement</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span><span class="token function">evalNode</span><span class="token punctuation">(</span><span class="token string">"plugins"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 【7】解析 &lt;objectFactory&gt; 标签，设置自定义对象工厂（用于实例化结果对象）</span>
    <span class="token function">objectFactoryElement</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span><span class="token function">evalNode</span><span class="token punctuation">(</span><span class="token string">"objectFactory"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 【8】解析 &lt;objectWrapperFactory&gt; 标签，自定义对象包装器（封装结果对象属性访问行为）</span>
    <span class="token function">objectWrapperFactoryElement</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span><span class="token function">evalNode</span><span class="token punctuation">(</span><span class="token string">"objectWrapperFactory"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 【9】解析 &lt;reflectorFactory&gt; 标签，自定义反射器工厂（高级反射行为控制）</span>
    <span class="token function">reflectorFactoryElement</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span><span class="token function">evalNode</span><span class="token punctuation">(</span><span class="token string">"reflectorFactory"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 【10】将 &lt;settings&gt; 中的配置项应用到 Configuration 对象中</span>
    <span class="token function">settingsElement</span><span class="token punctuation">(</span>settings<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 【11】解析 &lt;environments&gt; 标签，注册事务管理器和数据源配置（必须在 objectFactory 之后执行）</span>
    <span class="token function">environmentsElement</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span><span class="token function">evalNode</span><span class="token punctuation">(</span><span class="token string">"environments"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 【12】解析 &lt;databaseIdProvider&gt; 标签，支持数据库厂商识别（如区分 MySQL、Oracle）</span>
    <span class="token function">databaseIdProviderElement</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span><span class="token function">evalNode</span><span class="token punctuation">(</span><span class="token string">"databaseIdProvider"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 【13】解析 &lt;typeHandlers&gt; 标签，注册自定义类型处理器（TypeHandler）</span>
    <span class="token function">typeHandlerElement</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span><span class="token function">evalNode</span><span class="token punctuation">(</span><span class="token string">"typeHandlers"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 【14】解析 &lt;mappers&gt; 标签，加载 Mapper 映射器（包括 XML 和接口方式）</span>
    <span class="token function">mapperElement</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span><span class="token function">evalNode</span><span class="token punctuation">(</span><span class="token string">"mappers"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 如果解析过程中发生异常，则封装为 BuilderException 抛出</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BuilderException</span><span class="token punctuation">(</span><span class="token string">"Error parsing SQL Mapper Configuration. Cause: "</span> <span class="token operator">+</span> e<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     当解析完成后，会得到一个
     <code>
      configuration
     </code>
     对象，其中就包含了配置文件中的各种值。相当于此时的xml配置文件已经转化为了
     <code>
      configuration
     </code>
     对象。最后还会将其再次包装成
     <code>
      SqlSessionFactory
     </code>
     ，后续会利用
     <code>
      SqlSessionFactory
     </code>
     进行sql相关逻辑的执行。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/d676ae7afe224c4c8dfbfcc6dbe264f7.png">
      其中最关键的是mappers标签的解析。
     </img>
    </p>
    <h2>
     <a id="mappers_219">
     </a>
     二、mappers标签的解析
    </h2>
    <p>
     <code>
      mapperElement
     </code>
     方法，首先会拿到
     <code>
      mappers
     </code>
     根标签，然后进行解析。
    </p>
    <pre><code class="prism language-java"><span class="token comment">/**
 * 解析 &lt;mappers&gt; 标签，支持三种加载方式：package、resource/url、class
 */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">mapperElement</span><span class="token punctuation">(</span><span class="token class-name">XNode</span> parent<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 遍历 &lt;mappers&gt; 下的所有子节点（可能是 &lt;package&gt; 或 &lt;mapper&gt;）</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">XNode</span> child <span class="token operator">:</span> parent<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

      <span class="token comment">// 情况1：&lt;package name="com.xxx.mapper"/&gt;，批量注册包下所有 Mapper 接口</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"package"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">String</span> mapperPackage <span class="token operator">=</span> child<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 自动扫描指定包下的所有接口，并注册到 Configuration 中</span>
        configuration<span class="token punctuation">.</span><span class="token function">addMappers</span><span class="token punctuation">(</span>mapperPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 情况2~4：单个 &lt;mapper&gt; 节点，通过 resource/url/class 指定加载方式</span>
        <span class="token class-name">String</span> resource <span class="token operator">=</span> child<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"resource"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 从 classpath 中加载 Mapper XML</span>
        <span class="token class-name">String</span> url <span class="token operator">=</span> child<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"url"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">// 从网络路径加载 Mapper XML</span>
        <span class="token class-name">String</span> mapperClass <span class="token operator">=</span> child<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"class"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 直接加载 Mapper 接口类</span>

        <span class="token comment">// 情况2：只指定 resource，加载 Mapper XML 文件</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>resource <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> url <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> mapperClass <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token class-name">ErrorContext</span><span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">resource</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置错误上下文信息</span>
          <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> <span class="token class-name">Resources</span><span class="token punctuation">.</span><span class="token function">getResourceAsStream</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">XMLMapperBuilder</span> mapperParser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLMapperBuilder</span><span class="token punctuation">(</span>
              inputStream<span class="token punctuation">,</span> configuration<span class="token punctuation">,</span> resource<span class="token punctuation">,</span> configuration<span class="token punctuation">.</span><span class="token function">getSqlFragments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mapperParser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 解析 Mapper XML，注册语句映射</span>
          <span class="token punctuation">}</span>

        <span class="token comment">// 情况3：只指定 url，加载远程 Mapper XML 文件</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>resource <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> url <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> mapperClass <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token class-name">ErrorContext</span><span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">resource</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> <span class="token class-name">Resources</span><span class="token punctuation">.</span><span class="token function">getUrlAsStream</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">XMLMapperBuilder</span> mapperParser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLMapperBuilder</span><span class="token punctuation">(</span>
              inputStream<span class="token punctuation">,</span> configuration<span class="token punctuation">,</span> url<span class="token punctuation">,</span> configuration<span class="token punctuation">.</span><span class="token function">getSqlFragments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mapperParser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 同样调用解析逻辑</span>
          <span class="token punctuation">}</span>

        <span class="token comment">// 情况4：只指定 class，注册 Mapper 接口类（无 XML 时适用）</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>resource <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> url <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> mapperClass <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> mapperInterface <span class="token operator">=</span> <span class="token class-name">Resources</span><span class="token punctuation">.</span><span class="token function">classForName</span><span class="token punctuation">(</span>mapperClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
          configuration<span class="token punctuation">.</span><span class="token function">addMapper</span><span class="token punctuation">(</span>mapperInterface<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 注册接口类到 MapperRegistry</span>

        <span class="token comment">// 情况5：配置冲突，三种方式只能选一种，否则抛异常</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BuilderException</span><span class="token punctuation">(</span>
            <span class="token string">"A mapper element may only specify a url, resource or class, but not more than one."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre>
    <p>
     案例中对应的是
     <code>
      情况2
     </code>
     ，首先会注册一个mapper解析器，然后调用其parse方法对案例中
     <code>
      UserMapper.xml
     </code>
     进行解析，在该方法中，首先会进行判断，如果已经进行过解析，则不会重复解析。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/a718eb02f582466d8732bbfa3c4e2871.png">
      解析的核心方法在于
      <code>
       configurationElement
      </code>
      ，同样是对于xml中的各种标签再次分类解析：
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/e1f75ada3c384747a6d152ff76974576.png">
       这里重点看一下
       <code>
        cacheElement
       </code>
       以及
       <code>
        buildStatementFromContext
       </code>
       。
      </img>
     </img>
    </p>
    <h3>
     <a id="21cacheElement_282">
     </a>
     2.1、cacheElement
    </h3>
    <p>
     <code>
      cacheElement
     </code>
     和Mybatis的二级缓存有关。简单的说，Mybatis有两级缓存：
    </p>
    <ul>
     <li>
      一级缓存是SqlSession 级别的，并且默认开启。
     </li>
     <li>
      二级缓存是Mapper 映射级别，默认不开启，如果需要，应该在某个mapper.xml中使用cache标签开启。
     </li>
    </ul>
    <p>
     <code>
      cacheElement
     </code>
     方法正是解析mapper.xml中的cache标签：
    </p>
    <pre><code class="prism language-java"><span class="token comment">/**
 * 解析 &lt;cache&gt; 标签，构建二级缓存对象并注册到 Configuration 中。
 */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">cacheElement</span><span class="token punctuation">(</span><span class="token class-name">XNode</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 1. 判断 &lt;cache&gt; 标签是否存在</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>context <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">// 2. 解析缓存类型（默认是 PERPETUAL，即 PerpetualCache）</span>
    <span class="token class-name">String</span> type <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"type"</span><span class="token punctuation">,</span> <span class="token string">"PERPETUAL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Cache</span><span class="token punctuation">&gt;</span></span> typeClass <span class="token operator">=</span> typeAliasRegistry<span class="token punctuation">.</span><span class="token function">resolveAlias</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 3. 解析缓存淘汰策略（默认是 LRU，即最近最少使用）</span>
    <span class="token class-name">String</span> eviction <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"eviction"</span><span class="token punctuation">,</span> <span class="token string">"LRU"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Cache</span><span class="token punctuation">&gt;</span></span> evictionClass <span class="token operator">=</span> typeAliasRegistry<span class="token punctuation">.</span><span class="token function">resolveAlias</span><span class="token punctuation">(</span>eviction<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 4. 缓存刷新间隔（可选）：指定自动清空缓存的时间（毫秒）</span>
    <span class="token class-name">Long</span> flushInterval <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getLongAttribute</span><span class="token punctuation">(</span><span class="token string">"flushInterval"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 5. 缓存大小（可选）：最大缓存对象个数</span>
    <span class="token class-name">Integer</span> size <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getIntAttribute</span><span class="token punctuation">(</span><span class="token string">"size"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 6. 是否为读写缓存（readOnly=false 表示使用序列化；true 表示共享引用）</span>
    <span class="token comment">//    readWrite = true 表示开启对象副本，确保线程安全</span>
    <span class="token keyword">boolean</span> readWrite <span class="token operator">=</span> <span class="token operator">!</span>context<span class="token punctuation">.</span><span class="token function">getBooleanAttribute</span><span class="token punctuation">(</span><span class="token string">"readOnly"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 7. 是否阻塞：当缓存正在被其他线程刷新时，是否阻塞等待</span>
    <span class="token keyword">boolean</span> blocking <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getBooleanAttribute</span><span class="token punctuation">(</span><span class="token string">"blocking"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 8. 获取 &lt;cache&gt; 中配置的其他 &lt;property&gt; 子节点</span>
    <span class="token class-name">Properties</span> props <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getChildrenAsProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 9. 构建缓存并注册到 Configuration，封装为 MapperBuilderAssistant.useNewCache()</span>
    builderAssistant<span class="token punctuation">.</span><span class="token function">useNewCache</span><span class="token punctuation">(</span>
      typeClass<span class="token punctuation">,</span>          <span class="token comment">// 缓存类型类（如 PerpetualCache）</span>
      evictionClass<span class="token punctuation">,</span>      <span class="token comment">// 淘汰策略类（如 LruCache）</span>
      flushInterval<span class="token punctuation">,</span>      <span class="token comment">// 缓存刷新间隔</span>
      size<span class="token punctuation">,</span>               <span class="token comment">// 缓存容量</span>
      readWrite<span class="token punctuation">,</span>          <span class="token comment">// 是否使用读写模式</span>
      blocking<span class="token punctuation">,</span>           <span class="token comment">// 是否阻塞模式</span>
      props               <span class="token comment">// 自定义属性</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     在
     <code>
      useNewCache
     </code>
     中，最终会调用
     <code>
      CacheBuilder
     </code>
     的
     <code>
      build
     </code>
     方法：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/fd0b65e3b72a43db8e31b88381d0d8c6.png">
      <code>
       build
      </code>
      方法中运用到了
      <code>
       装饰器模式
      </code>
      ，所有的Cache都实现了一个共同的父类Cache。
      <br/>
      在**cache = newCacheDecoratorInstance(decorator, cache);
      <strong>
       这一行代码中，传入
       <code>
        LruCache
       </code>
       和当前的
       <code>
        Cache
       </code>
       实例（PERPETUAL），将
       <code>
        PERPETUAL
       </code>
       包装到
       <code>
        LRU
       </code>
       中：（LruCache的delegate属性，指向的是传入的PerpetualCache实例）
       <br/>
       <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/694a1f5b38fb452590f7b8ba5f6b3993.png"/>
       <br/>
       <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/dbcf86cea4ef4990988929cd4e9a7dc1.png"/>
       然后继续执行到
      </strong>
      cache = setStandardDecorators(cache);**这一行代码，会继续进行装饰器的包装：
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/86407e6568bd4d15985612eb626a2377.png"/>
      <code>
       setStandardDecorators
      </code>
      方法，对于
      <code>
       Cache
      </code>
      实例层层包装，赋值给各自的
      <code>
       delegate
      </code>
      属性：
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/05e4d1116c304efb82824b27da99fceb.png"/>
      <strong>
       包装完成的层次：SynchronizedCache线程同步缓存区-&gt;LoggingCache统计命中率以及打印日志-&gt;SerializedCache序列化-&gt;LruCache最少使用-&gt;PerpetualCache默认。
      </strong>
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/4e66792ea63c496a96a38423554e83d0.png"/>
     </img>
    </p>
    <h4>
     <a id="211_344">
     </a>
     2.1.1、缓存策略
    </h4>
    <p>
     默认的
     <code>
      PerpetualCache
     </code>
     ，使用的是
     <code>
      HashMap
     </code>
     进行存储。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/f7dc379c8b194bffb0c31472ab4a41ba.png"/>
     <br/>
     而
     <code>
      LruCache
     </code>
     ，为了实现最近最少使用的机制，使用了
     <code>
      LinkedHashMap
     </code>
     的数据结构，并且重写了它的
     <code>
      removeEldestEntry
     </code>
     方法，关键在于，
     <code>
      LinkedHashMap
     </code>
     构造时第三个参数为 true 表示按访问顺序排列:
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/1d3f458ef17e4cb1b5c1d4f7d4675921.png"/>
    </p>
    <pre><code class="prism language-java"><span class="token class-name">LruCache</span> cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LruCache</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PerpetualCache</span><span class="token punctuation">(</span><span class="token string">"myCache"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
cache<span class="token punctuation">.</span><span class="token function">setSize</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"A"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// A</span>
cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"B"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// A B</span>
cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"C"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// A B C</span>
cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"A"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// B C A （A 被访问过，移到尾部）</span>
cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"D"</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// C A D（B 被淘汰）</span>

</code></pre>
    <p>
     <code>
      SynchronizedCache
     </code>
     ，每个方法上通过加
     <code>
      synchronized
     </code>
     保证线程安全：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/6afc7188cdff4175a2e7ab8fce3a589b.png"/>
     <code>
      LoggingCache
     </code>
     ，会记录日志，以及统计缓存命中次数：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/1eaa2dddf434422db8fef6776a9514c9.png"/>
    </p>
    <h3>
     <a id="22buildStatementFromContext_366">
     </a>
     2.2、buildStatementFromContext
    </h3>
    <p>
     <code>
      buildStatementFromContext
     </code>
     是用来解析 select、insert、update、delete 标签中sql语句的方法，首先会解析出这些节点，然后进行循环，获取到
     <code>
      XMLStatementBuilder
     </code>
     后，执行
     <code>
      parseStatementNode
     </code>
     方法：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/07ef6424892142519b37a47f520c8ab4.png"/>
     在
     <code>
      parseStatementNode
     </code>
     方法中有几个关键点，这一段代码会判断当前的标签是否为select，如果是select标签，
     <strong>
      则不会清除一级缓存（增删改会清除），以及判断是否使用二级缓存（默认 select 使用）
     </strong>
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/ed315f0286c94a4cae15a0b3b28d1e4d.png"/>
    </p>
    <h4>
     <a id="221sql_371">
     </a>
     2.2.1、sql的解析
    </h4>
    <p>
     真正执行解析sql的是下图中的代码：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/b90dc84b08b348afb9c2da18cb423897.png"/>
     同样地会先去构建一个
     <code>
      XMLScriptBuilder
     </code>
     ，然后调用其
     <code>
      parseScriptNode
     </code>
     方法进行解析：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/a8931f1133ee416b92be9682d15b49b0.png"/>
     在
     <code>
      parseScriptNode
     </code>
     方法中，首先会解析 SQL 标签中的所有子标签，然后去进行判断：
    </p>
    <ul>
     <li>
      包含动态 SQL（即是否包含 if、choose、${} 等动态节点）构建 DynamicSqlSource（运行时动态拼接 SQL）
     </li>
     <li>
      不包含动态 SQL（即是否包含 if、choose、${} 等动态节点）构建 RawSqlSource（直接编译成静态 SQL，提升效率）
     </li>
    </ul>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/2aa6ae20cf6e4f7094c830fa3e54bb7e.png"/>
     <code>
      MixedSqlNode
     </code>
     对象，实现了
     <code>
      SqlNode
     </code>
     接口，SqlNode是所有动态 SQL节点的统一接口，而
     <code>
      MixedSqlNode
     </code>
     代表了 一整个 SQL 脚本块，比如select标签中所有内容就会变成一个 MixedSqlNode。
    </p>
    <blockquote>
     <p>
      SqlNode 接口
      <br/>
      │
      <br/>
      ├── MixedSqlNode // 组合节点
      <br/>
      ├── StaticTextSqlNode // 静态文本节点：普通 SQL 字符串
      <br/>
      ├── TextSqlNode // 动态文本节点：包含 ${}
      <br/>
      ├── IfSqlNode // if 标签
      <br/>
      ├── ChooseSqlNode // choose/when/otherwise
      <br/>
      ├── ForEachSqlNode // foreach
      <br/>
      ├── WhereSqlNode // where
      <br/>
      ├── TrimSqlNode // trim
      <br/>
      ├── SetSqlNode // set
      <br/>
      └── BindSqlNode // bind
     </p>
    </blockquote>
    <p>
     用一个案例说明，假如我在mapper.xml中定义了如下的sql语句：
    </p>
    <pre><code class="prism language-sql"><span class="token operator">&lt;</span><span class="token keyword">select</span> id<span class="token operator">=</span><span class="token string">"findUser"</span> parameterType<span class="token operator">=</span><span class="token string">"map"</span> resultType<span class="token operator">=</span><span class="token string">"User"</span><span class="token operator">&gt;</span>
  <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">user</span>
  <span class="token operator">&lt;</span><span class="token keyword">where</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token keyword">if</span> test<span class="token operator">=</span><span class="token string">"name != null"</span><span class="token operator">&gt;</span>
      <span class="token operator">AND</span> name <span class="token operator">=</span> <span class="token comment">#{name}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token keyword">if</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token keyword">if</span> test<span class="token operator">=</span><span class="token string">"age != null"</span><span class="token operator">&gt;</span>
      <span class="token operator">AND</span> age <span class="token operator">=</span> <span class="token comment">#{age}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token keyword">if</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token keyword">where</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span><span class="token keyword">select</span><span class="token operator">&gt;</span>
</code></pre>
    <p>
     则生成的结构如下：
    </p>
    <blockquote>
     <p>
      MixedSqlNode
      <br/>
      ├── StaticTextSqlNode(“SELECT * FROM user”)
      <br/>
      └── WhereSqlNode
      <br/>
      └── MixedSqlNode
      <br/>
      ├── IfSqlNode(test=“name != null”) → TextSqlNode(“AND name = #{name}”)
      <br/>
      └── IfSqlNode(test=“age != null”) → TextSqlNode(“AND age = #{age}”)
     </p>
    </blockquote>
    <hr/>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f:672e6373646e2e6e65742f323330315f37373539393037362f:61727469636c652f64657461696c732f313436323832323736" class_="artid" style="display:none">
 </p>
</div>


