---
layout: post
title: "解决AWS-EC2实例无法使用IAM角色登录AWS-CLI"
date: 2025-03-07 09:57:51 +0800
description: "解决AWS EC2实例在添加过用户访问秘钥凭据后无法使用IAM角色进行登录认证。"
keywords: "aws iam如何添加访问ec2"
categories: ['未分类']
tags: ['运维', '网络', '服务器', '云计算', 'Aws']
artid: "146086422"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146086422
    alt: "解决AWS-EC2实例无法使用IAM角色登录AWS-CLI"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146086422
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146086422
cover: https://bing.ee123.net/img/rand?artid=146086422
image: https://bing.ee123.net/img/rand?artid=146086422
img: https://bing.ee123.net/img/rand?artid=146086422
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     解决AWS EC2实例无法使用IAM角色登录AWS CLI
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="_0">
     </a>
     问题背景
    </h2>
    <p>
     有时，我们希望一台AWS EC2实例，即云服务器，能够使用
     <a href="https://download.csdn.net/download/xyzzklk/90463853">
      AWS CLI
     </a>
     访问AWS管理控制台资源。
     <br/>
     例如，这里，我们想让它能够列出所有IAM用户组。
    </p>
    <pre><code class="prism language-bash">aws iam list-groups
</code></pre>
    <p>
     于是，我们使用下面的命令，在AWS CLI中添加某位用户的访问秘钥，作为访问时的认证凭据。
    </p>
    <pre><code class="prism language-bash">aws configure
</code></pre>
    <p>
     然而，这并非最佳方法。最佳方法应是给要访问控制台的实例分配一个IAM角色。否则将会有很多问题，例如，当前使用的访问秘钥能直接被以明文列出。
    </p>
    <pre><code class="prism language-bash"><span class="token function">cat</span> ~/.aws/credentials
</code></pre>
    <p>
     于是，我们新建一个具有我们要分配的权限的IAM角色，并把它分配给这个实例。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/818204b6d02f4de1b029e0d05e54ebb4.png">
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/2a5c566f0ac448d18ddb82a946faaa4f.png"/>
     </img>
    </p>
    <h2>
     <a id="_17">
     </a>
     问题描述
    </h2>
    <p>
     之后我们在控制台里删除原来使用的访问秘钥。然而，此时，新分配的角色似乎并没有起作用。
    </p>
    <pre><code> [ec2-user@ip-172-31-6-134 ~]$ aws iam list-groups
An error occurred (InvalidClientTokenId) when calling the ListGroups operation: The security token included in the request is invalid.
</code></pre>
    <h2>
     <a id="_23">
     </a>
     故障排查
    </h2>
    <p>
     我们怀疑AWS CLI似乎还在尝试使用原来的秘钥进行认证。然而，因为这对秘钥已经从控制台内被删除，所以自然而然，认证失败。
    </p>
    <h2>
     <a id="_26">
     </a>
     解决方法
    </h2>
    <p>
     事实确实如此。当一个EC2实例被分配了一个IAM角色时，并不会自动抹除之前使用
     <code>
      aws configure
     </code>
     配置的访问秘钥凭据。不仅如此，当IAM角色凭据和访问秘钥凭据同时存在时，后者具有更高优先级，也就是说AWS CLI会优先使用它们。
     <br/>
     既然如此，移除原来使用的访问秘钥应该就能强迫AWS CLI使用角色进行认证。直接删除储存秘钥的文本文件
     <code>
      credentials
     </code>
     。
    </p>
    <pre><code class="prism language-bash"><span class="token function">rm</span> ~/.aws/credentials
</code></pre>
    <p>
     有人建议再抹除一些环境变量，但尝试下来似乎并不必要。
    </p>
    <pre><code class="prism language-bash"><span class="token keyword">for</span> <span class="token for-or-select variable">var</span> <span class="token keyword">in</span> AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_SESSION_TOKEN AWS_SECURITY_TOKEN <span class="token punctuation">;</span> <span class="token keyword">do</span> <span class="token builtin class-name">eval</span> <span class="token builtin class-name">unset</span> <span class="token variable">$var</span> <span class="token punctuation">;</span> <span class="token keyword">done</span>
</code></pre>
    <p>
     删除完成后，再次尝试从CLI访问AWS管理控制台。
     <br/>
     成功。
    </p>
    <pre><code class="prism language-bash"><span class="token punctuation">[</span>ec2-user@ip-172-31-6-134 ~<span class="token punctuation">]</span>$ aws iam list-groups
</code></pre>
    <pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"Groups"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"Path"</span><span class="token operator">:</span> <span class="token string">"/"</span><span class="token punctuation">,</span>
<span class="token operator">--</span>snip<span class="token operator">--</span>
</code></pre>
    <p>
     并且，我们还能确认，我们当前确实在用角色作为凭据访问。
    </p>
    <pre><code class="prism language-bash"><span class="token punctuation">[</span>ec2-user@ip-172-31-6-134 ~<span class="token punctuation">]</span>$ aws sts get-caller-identity
</code></pre>
    <pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"UserId"</span><span class="token operator">:</span> <span class="token string">"AR...KI:i-0f54eeba8022361ec"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"Account"</span><span class="token operator">:</span> <span class="token string">"5...2"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"Arn"</span><span class="token operator">:</span> <span class="token string">"arn:aws:sts::5...2:assumed-role/IAMReaderRole/i-0f54eeba8022361ec"</span>
<span class="token punctuation">}</span>
</code></pre>
    <pre><code class="prism language-bash"><span class="token punctuation">[</span>ec2-user@ip-172-31-6-134 ~<span class="token punctuation">]</span>$ aws configure list
      Name                    Value             Type    Location
      ----                    -----             ----    --------
   profile                <span class="token operator">&lt;</span>not set<span class="token operator">&gt;</span>             None    None
access_key     ****************6TVT         iam-role    
secret_key     ****************RnOE         iam-role    
    region           ap-southeast-1             imds    
<span class="token punctuation">[</span>ec2-user@ip-172-31-6-134 ~<span class="token punctuation">]</span>$
</code></pre>
    <p>
     问题解决。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="6874747073:3a2f2f626c6f672e6373646e2e6e65742f78797a7a6b6c6b2f:61727469636c652f64657461696c732f313436303836343232" class_="artid" style="display:none">
 </p>
</div>


