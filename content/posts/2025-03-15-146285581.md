---
layout: post
title: "文献阅读-可变形卷积DCN-Deformable-Convolutional-Networks"
date: 2025-03-15 21:14:52 +0800
description: "卷积神经网络（CNN）由于其构建模块固定的几何结构天然地局限于建模几何变换。为了提高CNN的转换建模能力，作者提出了可变形卷积和可变形RoI池化。两者都基于这样的想法：增加模块中的空间采样位置以及额外的偏移量，并且从目标任务中学习偏移量。并且新的模块可以很方便的替换普通的CNN模块，并且可以通过标准反向传播便易地进行端对端训练。实验证明了在深度CNN中学习密集空间变换对于复杂的视觉任务（如目标检测和语义分割）是有效的。"
keywords: "[文献阅读] 可变形卷积DCN - Deformable Convolutional Networks"
categories: ['周报']
tags: ['机器学习']
artid: "146285581"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146285581
    alt: "文献阅读-可变形卷积DCN-Deformable-Convolutional-Networks"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146285581
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146285581
cover: https://bing.ee123.net/img/rand?artid=146285581
image: https://bing.ee123.net/img/rand?artid=146285581
img: https://bing.ee123.net/img/rand?artid=146285581
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     [文献阅读] 可变形卷积DCN - Deformable Convolutional Networks
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     **文献信息：**Deformable Convolutional Networks
     <a href="https://arxiv.org/abs/1703.06211" rel="nofollow">
      arxiv.org/abs/1703.06211
     </a>
     <br/>
     发表于ICCV 2017，提出了可变形卷积DCN（Deformable ConvNets）
    </p>
    <h2>
     <a id="_3">
     </a>
     摘要
    </h2>
    <p>
     卷积神经网络（CNN）由于其构建模块固定的几何结构天然地局限于建模几何变换。
    </p>
    <p>
     为了提高CNN的转换建模能力，作者提出了
     <strong>
      可变形卷积
     </strong>
     和
     <strong>
      可变形RoI池化
     </strong>
     。两者都基于这样的想法：增加模块中的空间采样位置以及额外的偏移量，并且从目标任务中学习偏移量。并且新的模块可以很方便的替换普通的CNN模块，并且可以通过标准反向传播便易地进行端对端训练。
    </p>
    <p>
     实验证明了在深度CNN中学习密集空间变换对于复杂的视觉任务（如目标检测和语义分割）是有效的。
    </p>
    <h2>
     <a id="Abstract_11">
     </a>
     Abstract
    </h2>
    <p>
     This week’s report examines Deformable Convolutional Networks (DCN). DCN introduce deformable convolutions and deformable RoI pooling, which add adaptive offsets to the standard grid sampling positions in convolutional and pooling layers. These offsets are learned from the data, allowing the network to capture complex spatial variations. The report explains how deformable convolutions and pooling layers are integrated into CNN and trained end-to-end via standard backpropagation. Experiments on tasks like object detection and semantic segmentation demonstrate significant improvements in performance, highlighting the effectiveness of DCN in handling geometric deformations in visual data.
    </p>
    <h2>
     <a id="_15">
     </a>
     可变形卷积
    </h2>
    <p>
     CNN本质上局限于建模大量，未知的数据转换。该限制源于CNN模块的固定几何结构：卷积单元在固定位置对输入特征图进行采样；池化层以一个固定的比例降低空间分辨率；一个RoI（感兴趣区域）池化层把RoI分成固定的空间组块等等。
    </p>
    <p>
     而缺乏处理几何变换的内部机制。这会导致明显的问题。举一个例子，同一CNN层中所有激活单元的感受野大小是相同的。对于在空间位置上编码语义的高级CNN层来说，这是不可取的。由于不同的位置可能对应不同尺度或形变的目标，所以对于具有精细定位的视觉识别来说，例如使用全卷积网络的语义分割，尺度或感受野大小的自适应确定是理想的情况。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/96b5e39bc9ab4492a3461889e0b7a851.png"/>
    </p>
    <p>
     可变形卷积将2D偏移添加到标准卷积中的常规网格采样位置上。它可以使采样网格自由形变。
    </p>
    <p>
     （a）标准卷积的定期采样网格（绿点）。（b）变形的采样位置（深蓝色点）和可变形卷积中增大的偏移量（浅蓝色箭头）。©(d)是(b)的特例，表明可变形卷积推广了尺度、长宽比和旋转的各种变换。
    </p>
    <h3>
     <a id="_28">
     </a>
     可变形卷积层
    </h3>
    <p>
     定义标准的卷积过程，对输入的2Dfeature map y上的每一个位置
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        P 
         
        
          0 
         
        
       
      
        P_0
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.8333em; vertical-align: -0.15em;">
         </span>
         <span class="mord">
          <span class="mord mathnormal" style="margin-right: 0.1389em;">
           P
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.3011em;">
              <span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 0
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.15em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     ，进行以下卷积操作
     <br/>
     <span class="katex--display">
      <span class="katex-display">
       <span class="katex">
        <span class="katex-mathml">
         y 
         
        
          ( 
         
         
         
           P 
          
         
           0 
          
         
        
          ) 
         
        
          = 
         
         
         
           ∑ 
          
          
           
           
             P 
            
           
             n 
            
           
          
            ∈ 
           
          
            R 
           
          
         
        
          w 
         
        
          ( 
         
         
         
           P 
          
         
           n 
          
         
        
          ) 
         
        
          ⋅ 
         
        
          x 
         
        
          ( 
         
         
         
           P 
          
         
           0 
          
         
        
          + 
         
         
         
           P 
          
         
           n 
          
         
        
          ) 
         
        
       
         y(P_0)=\sum_{P_n\in R}w(P_n)\cdot x(P_0+P_n)
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 1em; vertical-align: -0.25em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0359em;">
           y
          </span>
          <span class="mopen">
           (
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.1389em;">
            P
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3011em;">
               <span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  0
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mclose">
           )
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           =
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 2.4444em; vertical-align: -1.3944em;">
          </span>
          <span class="mop op-limits">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 1.05em;">
              <span class="" style="top: -1.8557em; margin-left: 0em;">
               <span class="pstrut" style="height: 3.05em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.1389em;">
                   P
                  </span>
                  <span class="msupsub">
                   <span class="vlist-t vlist-t2">
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.1645em;">
                      <span class="" style="top: -2.357em; margin-left: -0.1389em; margin-right: 0.0714em;">
                       <span class="pstrut" style="height: 2.5em;">
                       </span>
                       <span class="sizing reset-size3 size1 mtight">
                        <span class="mord mathnormal mtight">
                         n
                        </span>
                       </span>
                      </span>
                     </span>
                     <span class="vlist-s">
                      ​
                     </span>
                    </span>
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.143em;">
                      <span class="">
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                 <span class="mrel mtight">
                  ∈
                 </span>
                 <span class="mord mathnormal mtight" style="margin-right: 0.0077em;">
                  R
                 </span>
                </span>
               </span>
              </span>
              <span class="" style="top: -3.05em;">
               <span class="pstrut" style="height: 3.05em;">
               </span>
               <span class="">
                <span class="mop op-symbol large-op">
                 ∑
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 1.3944em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0269em;">
           w
          </span>
          <span class="mopen">
           (
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.1389em;">
            P
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.1514em;">
               <span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight">
                  n
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mclose">
           )
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
          <span class="mbin">
           ⋅
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 1em; vertical-align: -0.25em;">
          </span>
          <span class="mord mathnormal">
           x
          </span>
          <span class="mopen">
           (
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.1389em;">
            P
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3011em;">
               <span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  0
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
          <span class="mbin">
           +
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 1em; vertical-align: -0.25em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.1389em;">
            P
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.1514em;">
               <span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight">
                  n
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mclose">
           )
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     <br/>
     其中，P_n是卷积核的每一个位置，w是卷积核.
    </p>
    <p>
     网格R定义了感受野的大小和扩张，如：定义了一个扩张大小为1的3×3卷积核
     <br/>
     <span class="katex--display">
      <span class="katex-display">
       <span class="katex">
        <span class="katex-mathml">
         R 
         
        
          = 
         
        
          { 
         
        
          ( 
         
        
          − 
         
        
          1 
         
        
          , 
         
        
          − 
         
        
          1 
         
        
          ) 
         
        
          , 
         
        
          ( 
         
        
          − 
         
        
          1 
         
        
          , 
         
        
          0 
         
        
          ) 
         
        
          , 
         
        
          . 
         
        
          . 
         
        
          . 
         
        
          , 
         
        
          ( 
         
        
          0 
         
        
          , 
         
        
          1 
         
        
          ) 
         
        
          , 
         
        
          ( 
         
        
          1 
         
        
          , 
         
        
          1 
         
        
          ) 
         
        
          } 
         
        
       
         R = \{(−1, −1),(−1, 0), . . . ,(0, 1),(1, 1)\}
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.6833em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0077em;">
           R
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           =
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 1em; vertical-align: -0.25em;">
          </span>
          <span class="mopen">
           {(
          </span>
          <span class="mord">
           −
          </span>
          <span class="mord">
           1
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord">
           −
          </span>
          <span class="mord">
           1
          </span>
          <span class="mclose">
           )
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mopen">
           (
          </span>
          <span class="mord">
           −
          </span>
          <span class="mord">
           1
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord">
           0
          </span>
          <span class="mclose">
           )
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord">
           ...
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mopen">
           (
          </span>
          <span class="mord">
           0
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord">
           1
          </span>
          <span class="mclose">
           )
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mopen">
           (
          </span>
          <span class="mord">
           1
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord">
           1
          </span>
          <span class="mclose">
           )}
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     <br/>
     在标准卷积操作中，对每一个位置
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        P 
         
        
          0 
         
        
       
      
        P_0
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.8333em; vertical-align: -0.15em;">
         </span>
         <span class="mord">
          <span class="mord mathnormal" style="margin-right: 0.1389em;">
           P
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.3011em;">
              <span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 0
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.15em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     ，对其与它在R中的所有偏移位置（上下左右及对角线）的特征点与卷积核对应的位置进行加权求和，得到新特征图上对应的P_0点。例如
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        R 
        
       
         [ 
        
       
         0 
        
       
         ] 
        
       
         = 
        
       
         ( 
        
       
         − 
        
       
         1 
        
       
         , 
        
       
         − 
        
       
         1 
        
       
         ) 
        
       
      
        R[0]=(-1,-1)
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 1em; vertical-align: -0.25em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0077em;">
          R
         </span>
         <span class="mopen">
          [
         </span>
         <span class="mord">
          0
         </span>
         <span class="mclose">
          ]
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
         <span class="mrel">
          =
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 1em; vertical-align: -0.25em;">
         </span>
         <span class="mopen">
          (
         </span>
         <span class="mord">
          −
         </span>
         <span class="mord">
          1
         </span>
         <span class="mpunct">
          ,
         </span>
         <span class="mspace" style="margin-right: 0.1667em;">
         </span>
         <span class="mord">
          −
         </span>
         <span class="mord">
          1
         </span>
         <span class="mclose">
          )
         </span>
        </span>
       </span>
      </span>
     </span>
     ，就是对应
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        P 
         
        
          0 
         
        
       
      
        P_0
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.8333em; vertical-align: -0.15em;">
         </span>
         <span class="mord">
          <span class="mord mathnormal" style="margin-right: 0.1389em;">
           P
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.3011em;">
              <span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 0
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.15em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     点的左上角的点。
    </p>
    <p>
     输出特征映射y上的每个位置
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        p 
         
        
          0 
         
        
       
      
        p_0
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.625em; vertical-align: -0.1944em;">
         </span>
         <span class="mord">
          <span class="mord mathnormal">
           p
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.3011em;">
              <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 0
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.15em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     ，我们有
     <br/>
     <span class="katex--display">
      <span class="katex-display">
       <span class="katex">
        <span class="katex-mathml">
         y 
         
        
          ( 
         
         
         
           P 
          
         
           0 
          
         
        
          ) 
         
        
          = 
         
         
         
           ∑ 
          
          
           
           
             P 
            
           
             n 
            
           
          
            ∈ 
           
          
            R 
           
          
         
        
          w 
         
        
          ( 
         
         
         
           P 
          
         
           n 
          
         
        
          ) 
         
        
          ⋅ 
         
        
          x 
         
        
          ( 
         
         
         
           P 
          
         
           0 
          
         
        
          + 
         
         
         
           P 
          
         
           n 
          
         
        
          + 
         
        
          Δ 
         
         
         
           P 
          
         
           n 
          
         
        
          ) 
         
        
       
         y(P_0)=\sum_{P_n\in R}w(P_n)\cdot x(P_0+P_n+\Delta P_n)
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 1em; vertical-align: -0.25em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0359em;">
           y
          </span>
          <span class="mopen">
           (
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.1389em;">
            P
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3011em;">
               <span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  0
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mclose">
           )
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           =
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 2.4444em; vertical-align: -1.3944em;">
          </span>
          <span class="mop op-limits">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 1.05em;">
              <span class="" style="top: -1.8557em; margin-left: 0em;">
               <span class="pstrut" style="height: 3.05em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.1389em;">
                   P
                  </span>
                  <span class="msupsub">
                   <span class="vlist-t vlist-t2">
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.1645em;">
                      <span class="" style="top: -2.357em; margin-left: -0.1389em; margin-right: 0.0714em;">
                       <span class="pstrut" style="height: 2.5em;">
                       </span>
                       <span class="sizing reset-size3 size1 mtight">
                        <span class="mord mathnormal mtight">
                         n
                        </span>
                       </span>
                      </span>
                     </span>
                     <span class="vlist-s">
                      ​
                     </span>
                    </span>
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.143em;">
                      <span class="">
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                 <span class="mrel mtight">
                  ∈
                 </span>
                 <span class="mord mathnormal mtight" style="margin-right: 0.0077em;">
                  R
                 </span>
                </span>
               </span>
              </span>
              <span class="" style="top: -3.05em;">
               <span class="pstrut" style="height: 3.05em;">
               </span>
               <span class="">
                <span class="mop op-symbol large-op">
                 ∑
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 1.3944em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0269em;">
           w
          </span>
          <span class="mopen">
           (
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.1389em;">
            P
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.1514em;">
               <span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight">
                  n
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mclose">
           )
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
          <span class="mbin">
           ⋅
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 1em; vertical-align: -0.25em;">
          </span>
          <span class="mord mathnormal">
           x
          </span>
          <span class="mopen">
           (
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.1389em;">
            P
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3011em;">
               <span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  0
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
          <span class="mbin">
           +
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 0.8333em; vertical-align: -0.15em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.1389em;">
            P
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.1514em;">
               <span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight">
                  n
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
          <span class="mbin">
           +
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 1em; vertical-align: -0.25em;">
          </span>
          <span class="mord">
           Δ
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.1389em;">
            P
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.1514em;">
               <span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight">
                  n
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mclose">
           )
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     <br/>
     其中，
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        { 
        
       
         Δ 
        
        
        
          P 
         
        
          n 
         
        
       
         ∣ 
        
       
         n 
        
       
         = 
        
       
         1 
        
       
         , 
        
       
         . 
        
       
         . 
        
       
         . 
        
       
         , 
        
       
         N 
        
       
         } 
        
       
      
        \{\Delta P_n|n=1,...,N \}
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 1em; vertical-align: -0.25em;">
         </span>
         <span class="mopen">
          {
          <!-- -->
         </span>
         <span class="mord">
          Δ
         </span>
         <span class="mord">
          <span class="mord mathnormal" style="margin-right: 0.1389em;">
           P
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.1514em;">
              <span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mathnormal mtight">
                 n
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.15em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
         <span class="mord">
          ∣
         </span>
         <span class="mord mathnormal">
          n
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
         <span class="mrel">
          =
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 1em; vertical-align: -0.25em;">
         </span>
         <span class="mord">
          1
         </span>
         <span class="mpunct">
          ,
         </span>
         <span class="mspace" style="margin-right: 0.1667em;">
         </span>
         <span class="mord">
          ...
         </span>
         <span class="mpunct">
          ,
         </span>
         <span class="mspace" style="margin-right: 0.1667em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.109em;">
          N
         </span>
         <span class="mclose">
          }
         </span>
        </span>
       </span>
      </span>
     </span>
     ,
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        N 
        
       
         = 
        
       
         ∣ 
        
       
         R 
        
       
         ∣ 
        
       
      
        N = |R|
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.6833em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.109em;">
          N
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
         <span class="mrel">
          =
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 1em; vertical-align: -0.25em;">
         </span>
         <span class="mord">
          ∣
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0077em;">
          R
         </span>
         <span class="mord">
          ∣
         </span>
        </span>
       </span>
      </span>
     </span>
     ，对应着图中的offsets的每一个位置。
    </p>
    <p>
     在可形变卷积的操作中，在原来R的偏移量的基础上又加入了一个二维偏移
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        Δ 
        
        
        
          P 
         
        
          n 
         
        
       
      
        \Delta P_n
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.8333em; vertical-align: -0.15em;">
         </span>
         <span class="mord">
          Δ
         </span>
         <span class="mord">
          <span class="mord mathnormal" style="margin-right: 0.1389em;">
           P
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.1514em;">
              <span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mathnormal mtight">
                 n
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.15em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     （x、y轴上的偏移），这个
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        Δ 
        
        
        
          P 
         
        
          n 
         
        
       
      
        \Delta P_n
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.8333em; vertical-align: -0.15em;">
         </span>
         <span class="mord">
          Δ
         </span>
         <span class="mord">
          <span class="mord mathnormal" style="margin-right: 0.1389em;">
           P
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.1514em;">
              <span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mathnormal mtight">
                 n
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.15em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     的值对应图1中offsets对应位置的值。
    </p>
    <p>
     由于offsets要通过学习得到，所以是一个浮点值，因此对应的不是特征图上一个真实的位置，如果直接使用取整函数的话无法反向传播，因此该位置的值是通过计算周围4个真实值的双线性插值得到的。
     <br/>
     <span class="katex--display">
      <span class="katex-display">
       <span class="katex">
        <span class="katex-mathml">
         x 
         
        
          ( 
         
        
          p 
         
        
          ) 
         
        
          = 
         
         
         
           ∑ 
          
         
           q 
          
         
        
          G 
         
        
          ( 
         
        
          q 
         
        
          , 
         
        
          p 
         
        
          ) 
         
        
          ⋅ 
         
        
          x 
         
        
          ( 
         
        
          q 
         
        
          ) 
         
        
       
         x(p)=\sum_{q}G(q,p) \cdot x(q)
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 1em; vertical-align: -0.25em;">
          </span>
          <span class="mord mathnormal">
           x
          </span>
          <span class="mopen">
           (
          </span>
          <span class="mord mathnormal">
           p
          </span>
          <span class="mclose">
           )
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           =
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 2.4361em; vertical-align: -1.3861em;">
          </span>
          <span class="mop op-limits">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 1.05em;">
              <span class="" style="top: -1.9em; margin-left: 0em;">
               <span class="pstrut" style="height: 3.05em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.0359em;">
                  q
                 </span>
                </span>
               </span>
              </span>
              <span class="" style="top: -3.05em;">
               <span class="pstrut" style="height: 3.05em;">
               </span>
               <span class="">
                <span class="mop op-symbol large-op">
                 ∑
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 1.3861em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord mathnormal">
           G
          </span>
          <span class="mopen">
           (
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0359em;">
           q
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord mathnormal">
           p
          </span>
          <span class="mclose">
           )
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
          <span class="mbin">
           ⋅
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 1em; vertical-align: -0.25em;">
          </span>
          <span class="mord mathnormal">
           x
          </span>
          <span class="mopen">
           (
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0359em;">
           q
          </span>
          <span class="mclose">
           )
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     <br/>
     其中，
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        g 
        
       
         ( 
        
       
         a 
        
       
         , 
        
       
         b 
        
       
         ) 
        
       
         = 
        
       
         m 
        
       
         a 
        
       
         x 
        
       
         ( 
        
       
         0 
        
       
         , 
        
       
         1 
        
       
         − 
        
       
         ∣ 
        
       
         a 
        
       
         − 
        
       
         b 
        
       
         ∣ 
        
       
         ) 
        
       
      
        g(a,b)=max(0,1-|a-b|)
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 1em; vertical-align: -0.25em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0359em;">
          g
         </span>
         <span class="mopen">
          (
         </span>
         <span class="mord mathnormal">
          a
         </span>
         <span class="mpunct">
          ,
         </span>
         <span class="mspace" style="margin-right: 0.1667em;">
         </span>
         <span class="mord mathnormal">
          b
         </span>
         <span class="mclose">
          )
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
         <span class="mrel">
          =
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 1em; vertical-align: -0.25em;">
         </span>
         <span class="mord mathnormal">
          ma
         </span>
         <span class="mord mathnormal">
          x
         </span>
         <span class="mopen">
          (
         </span>
         <span class="mord">
          0
         </span>
         <span class="mpunct">
          ,
         </span>
         <span class="mspace" style="margin-right: 0.1667em;">
         </span>
         <span class="mord">
          1
         </span>
         <span class="mspace" style="margin-right: 0.2222em;">
         </span>
         <span class="mbin">
          −
         </span>
         <span class="mspace" style="margin-right: 0.2222em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 1em; vertical-align: -0.25em;">
         </span>
         <span class="mord">
          ∣
         </span>
         <span class="mord mathnormal">
          a
         </span>
         <span class="mspace" style="margin-right: 0.2222em;">
         </span>
         <span class="mbin">
          −
         </span>
         <span class="mspace" style="margin-right: 0.2222em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 1em; vertical-align: -0.25em;">
         </span>
         <span class="mord mathnormal">
          b
         </span>
         <span class="mord">
          ∣
         </span>
         <span class="mclose">
          )
         </span>
        </span>
       </span>
      </span>
     </span>
    </p>
    <p>
     对每一个
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        P 
         
        
          0 
         
        
       
      
        P_0
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.8333em; vertical-align: -0.15em;">
         </span>
         <span class="mord">
          <span class="mord mathnormal" style="margin-right: 0.1389em;">
           P
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.3011em;">
              <span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 0
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.15em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     ，
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        P 
         
        
          n 
         
        
       
      
        P_n
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.8333em; vertical-align: -0.15em;">
         </span>
         <span class="mord">
          <span class="mord mathnormal" style="margin-right: 0.1389em;">
           P
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.1514em;">
              <span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mathnormal mtight">
                 n
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.15em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     有N个值，对应着卷积核的大小，
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        Δ 
        
        
        
          P 
         
        
          n 
         
        
       
      
        \Delta P_n
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.8333em; vertical-align: -0.15em;">
         </span>
         <span class="mord">
          Δ
         </span>
         <span class="mord">
          <span class="mord mathnormal" style="margin-right: 0.1389em;">
           P
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.1514em;">
              <span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mathnormal mtight">
                 n
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.15em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     同样也有N个值，对应上图中offset field特征图的N个通道，对于输出的特征图（对应下图中的output feature map)上的每个点，可以单独决定他在原图上采样的3x3的特征点的空间位置。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/24f43d0384244ea6b3da1e2d4ca30793.png"/>
    </p>
    <h2>
     <a id="_61">
     </a>
     可变形池化
    </h2>
    <p>
     对一个输入特征图x和一个
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        w 
        
       
         × 
        
       
         h 
        
       
      
        w \times h
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.6667em; vertical-align: -0.0833em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0269em;">
          w
         </span>
         <span class="mspace" style="margin-right: 0.2222em;">
         </span>
         <span class="mbin">
          ×
         </span>
         <span class="mspace" style="margin-right: 0.2222em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 0.6944em;">
         </span>
         <span class="mord mathnormal">
          h
         </span>
        </span>
       </span>
      </span>
     </span>
     的RoI，RoI pooling将RoI分割成一个
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        k 
        
       
         × 
        
       
         k 
        
       
      
        k \times k
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.7778em; vertical-align: -0.0833em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0315em;">
          k
         </span>
         <span class="mspace" style="margin-right: 0.2222em;">
         </span>
         <span class="mbin">
          ×
         </span>
         <span class="mspace" style="margin-right: 0.2222em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 0.6944em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0315em;">
          k
         </span>
        </span>
       </span>
      </span>
     </span>
     的区域(bin)，并输出一个
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        k 
        
       
         × 
        
       
         k 
        
       
      
        k \times k
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.7778em; vertical-align: -0.0833em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0315em;">
          k
         </span>
         <span class="mspace" style="margin-right: 0.2222em;">
         </span>
         <span class="mbin">
          ×
         </span>
         <span class="mspace" style="margin-right: 0.2222em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 0.6944em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0315em;">
          k
         </span>
        </span>
       </span>
      </span>
     </span>
     的特征图y。对于第(i,j)的区域：
    </p>
    <p>
     1）标准RoI 池化的操作过程：
     <br/>
     <span class="katex--display">
      <span class="katex-display">
       <span class="katex">
        <span class="katex-mathml">
         y 
         
        
          ( 
         
        
          i 
         
        
          , 
         
        
          j 
         
        
          ) 
         
        
          = 
         
         
         
           ∑ 
          
          
          
            p 
           
          
            ∈ 
           
          
            b 
           
          
            i 
           
          
            n 
           
          
            ( 
           
          
            i 
           
          
            , 
           
          
            j 
           
          
            ) 
           
          
         
        
          x 
         
        
          ( 
         
         
         
           P 
          
         
           0 
          
         
        
          + 
         
        
          P 
         
        
          ) 
         
        
          / 
         
         
         
           n 
          
          
          
            i 
           
          
            j 
           
          
         
        
       
         y(i,j)=\sum_{p \in bin(i,j)} x(P_0+P)/n_{ij}
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 1em; vertical-align: -0.25em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0359em;">
           y
          </span>
          <span class="mopen">
           (
          </span>
          <span class="mord mathnormal">
           i
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0572em;">
           j
          </span>
          <span class="mclose">
           )
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           =
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 2.566em; vertical-align: -1.516em;">
          </span>
          <span class="mop op-limits">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 1.05em;">
              <span class="" style="top: -1.809em; margin-left: 0em;">
               <span class="pstrut" style="height: 3.05em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mathnormal mtight">
                  p
                 </span>
                 <span class="mrel mtight">
                  ∈
                 </span>
                 <span class="mord mathnormal mtight">
                  bin
                 </span>
                 <span class="mopen mtight">
                  (
                 </span>
                 <span class="mord mathnormal mtight">
                  i
                 </span>
                 <span class="mpunct mtight">
                  ,
                 </span>
                 <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                  j
                 </span>
                 <span class="mclose mtight">
                  )
                 </span>
                </span>
               </span>
              </span>
              <span class="" style="top: -3.05em;">
               <span class="pstrut" style="height: 3.05em;">
               </span>
               <span class="">
                <span class="mop op-symbol large-op">
                 ∑
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 1.516em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord mathnormal">
           x
          </span>
          <span class="mopen">
           (
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.1389em;">
            P
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3011em;">
               <span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  0
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
          <span class="mbin">
           +
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 1.0361em; vertical-align: -0.2861em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.1389em;">
           P
          </span>
          <span class="mclose">
           )
          </span>
          <span class="mord">
           /
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            n
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3117em;">
               <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                   ij
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.2861em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
    </p>
    <p>
     2）可形变 RoI 池化的操作过程：
     <br/>
     <span class="katex--display">
      <span class="katex-display">
       <span class="katex">
        <span class="katex-mathml">
         y 
         
        
          ( 
         
        
          i 
         
        
          , 
         
        
          j 
         
        
          ) 
         
        
          = 
         
         
         
           ∑ 
          
          
          
            p 
           
          
            ∈ 
           
          
            b 
           
          
            i 
           
          
            n 
           
          
            ( 
           
          
            i 
           
          
            , 
           
          
            j 
           
          
            ) 
           
          
         
        
          x 
         
        
          ( 
         
         
         
           P 
          
         
           0 
          
         
        
          + 
         
        
          P 
         
        
          + 
         
        
          Δ 
         
         
         
           P 
          
          
          
            i 
           
          
            j 
           
          
         
        
          ) 
         
        
          / 
         
         
         
           n 
          
          
          
            i 
           
          
            j 
           
          
         
        
       
         y(i,j)=\sum_{p \in bin(i,j)} x(P_0+P+\Delta P_{ij})/n_{ij}
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 1em; vertical-align: -0.25em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0359em;">
           y
          </span>
          <span class="mopen">
           (
          </span>
          <span class="mord mathnormal">
           i
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0572em;">
           j
          </span>
          <span class="mclose">
           )
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           =
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 2.566em; vertical-align: -1.516em;">
          </span>
          <span class="mop op-limits">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 1.05em;">
              <span class="" style="top: -1.809em; margin-left: 0em;">
               <span class="pstrut" style="height: 3.05em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mathnormal mtight">
                  p
                 </span>
                 <span class="mrel mtight">
                  ∈
                 </span>
                 <span class="mord mathnormal mtight">
                  bin
                 </span>
                 <span class="mopen mtight">
                  (
                 </span>
                 <span class="mord mathnormal mtight">
                  i
                 </span>
                 <span class="mpunct mtight">
                  ,
                 </span>
                 <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                  j
                 </span>
                 <span class="mclose mtight">
                  )
                 </span>
                </span>
               </span>
              </span>
              <span class="" style="top: -3.05em;">
               <span class="pstrut" style="height: 3.05em;">
               </span>
               <span class="">
                <span class="mop op-symbol large-op">
                 ∑
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 1.516em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord mathnormal">
           x
          </span>
          <span class="mopen">
           (
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.1389em;">
            P
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3011em;">
               <span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  0
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
          <span class="mbin">
           +
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 0.7667em; vertical-align: -0.0833em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.1389em;">
           P
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
          <span class="mbin">
           +
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 1.0361em; vertical-align: -0.2861em;">
          </span>
          <span class="mord">
           Δ
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.1389em;">
            P
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3117em;">
               <span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                   ij
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.2861em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mclose">
           )
          </span>
          <span class="mord">
           /
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            n
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3117em;">
               <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                   ij
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.2861em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     <br/>
     这个操作过程跟可形变卷积的基本一样。
    </p>
    <p>
     讲下
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        Δ 
        
        
        
          P 
         
         
         
           i 
          
         
           j 
          
         
        
       
      
        \Delta P_{ij}
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.9694em; vertical-align: -0.2861em;">
         </span>
         <span class="mord">
          Δ
         </span>
         <span class="mord">
          <span class="mord mathnormal" style="margin-right: 0.1389em;">
           P
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.3117em;">
              <span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                  ij
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.2861em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     的计算。
    </p>
    <p>
     对输入特征图x先做一次标准的RoI池化，然后通过一个全连接层，输出一个标准的
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        k 
        
       
         × 
        
       
         k 
        
       
      
        k \times k
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.7778em; vertical-align: -0.0833em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0315em;">
          k
         </span>
         <span class="mspace" style="margin-right: 0.2222em;">
         </span>
         <span class="mbin">
          ×
         </span>
         <span class="mspace" style="margin-right: 0.2222em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 0.6944em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0315em;">
          k
         </span>
        </span>
       </span>
      </span>
     </span>
     的offsets
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        Δ 
        
        
         
         
           P 
          
          
          
            i 
           
          
            j 
           
          
         
        
          ^ 
         
        
       
      
        \Delta \hat{P_{ij}}
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 1.2329em; vertical-align: -0.2861em;">
         </span>
         <span class="mord">
          Δ
         </span>
         <span class="mord accent">
          <span class="vlist-t vlist-t2">
           <span class="vlist-r">
            <span class="vlist" style="height: 0.9468em;">
             <span class="" style="top: -3em;">
              <span class="pstrut" style="height: 3em;">
              </span>
              <span class="mord">
               <span class="mord mathnormal" style="margin-right: 0.1389em;">
                P
               </span>
               <span class="msupsub">
                <span class="vlist-t vlist-t2">
                 <span class="vlist-r">
                  <span class="vlist" style="height: 0.3117em;">
                   <span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;">
                    <span class="pstrut" style="height: 2.7em;">
                    </span>
                    <span class="sizing reset-size6 size3 mtight">
                     <span class="mord mtight">
                      <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                       ij
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                  <span class="vlist-s">
                   ​
                  </span>
                 </span>
                 <span class="vlist-r">
                  <span class="vlist" style="height: 0.2861em;">
                   <span class="">
                   </span>
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="" style="top: -3.2523em;">
              <span class="pstrut" style="height: 3em;">
              </span>
              <span class="accent-body" style="left: -0.25em;">
               <span class="mord">
                ^
               </span>
              </span>
             </span>
            </span>
            <span class="vlist-s">
             ​
            </span>
           </span>
           <span class="vlist-r">
            <span class="vlist" style="height: 0.2861em;">
             <span class="">
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     ,然后根据公式：
     <br/>
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        Δ 
        
        
        
          P 
         
         
         
           i 
          
         
           j 
          
         
        
       
         = 
        
       
         γ 
        
       
         ⋅ 
        
       
         Δ 
        
        
         
         
           P 
          
          
          
            i 
           
          
            j 
           
          
         
        
          ^ 
         
        
       
         ⋅ 
        
       
         ( 
        
       
         w 
        
       
         , 
        
       
         h 
        
       
         ) 
        
       
      
        \Delta P_{ij}=\gamma \cdot \Delta \hat{P_{ij}} \cdot (w,h)
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.9694em; vertical-align: -0.2861em;">
         </span>
         <span class="mord">
          Δ
         </span>
         <span class="mord">
          <span class="mord mathnormal" style="margin-right: 0.1389em;">
           P
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.3117em;">
              <span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                  ij
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.2861em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
         <span class="mrel">
          =
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 0.6389em; vertical-align: -0.1944em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0556em;">
          γ
         </span>
         <span class="mspace" style="margin-right: 0.2222em;">
         </span>
         <span class="mbin">
          ⋅
         </span>
         <span class="mspace" style="margin-right: 0.2222em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 1.2329em; vertical-align: -0.2861em;">
         </span>
         <span class="mord">
          Δ
         </span>
         <span class="mord accent">
          <span class="vlist-t vlist-t2">
           <span class="vlist-r">
            <span class="vlist" style="height: 0.9468em;">
             <span class="" style="top: -3em;">
              <span class="pstrut" style="height: 3em;">
              </span>
              <span class="mord">
               <span class="mord mathnormal" style="margin-right: 0.1389em;">
                P
               </span>
               <span class="msupsub">
                <span class="vlist-t vlist-t2">
                 <span class="vlist-r">
                  <span class="vlist" style="height: 0.3117em;">
                   <span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;">
                    <span class="pstrut" style="height: 2.7em;">
                    </span>
                    <span class="sizing reset-size6 size3 mtight">
                     <span class="mord mtight">
                      <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                       ij
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                  <span class="vlist-s">
                   ​
                  </span>
                 </span>
                 <span class="vlist-r">
                  <span class="vlist" style="height: 0.2861em;">
                   <span class="">
                   </span>
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="" style="top: -3.2523em;">
              <span class="pstrut" style="height: 3em;">
              </span>
              <span class="accent-body" style="left: -0.25em;">
               <span class="mord">
                ^
               </span>
              </span>
             </span>
            </span>
            <span class="vlist-s">
             ​
            </span>
           </span>
           <span class="vlist-r">
            <span class="vlist" style="height: 0.2861em;">
             <span class="">
             </span>
            </span>
           </span>
          </span>
         </span>
         <span class="mspace" style="margin-right: 0.2222em;">
         </span>
         <span class="mbin">
          ⋅
         </span>
         <span class="mspace" style="margin-right: 0.2222em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 1em; vertical-align: -0.25em;">
         </span>
         <span class="mopen">
          (
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0269em;">
          w
         </span>
         <span class="mpunct">
          ,
         </span>
         <span class="mspace" style="margin-right: 0.1667em;">
         </span>
         <span class="mord mathnormal">
          h
         </span>
         <span class="mclose">
          )
         </span>
        </span>
       </span>
      </span>
     </span>
     计算出
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        Δ 
        
        
        
          P 
         
         
         
           i 
          
         
           j 
          
         
        
       
      
        \Delta P_{ij}
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.9694em; vertical-align: -0.2861em;">
         </span>
         <span class="mord">
          Δ
         </span>
         <span class="mord">
          <span class="mord mathnormal" style="margin-right: 0.1389em;">
           P
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.3117em;">
              <span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                  ij
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.2861em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     。其中,
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        γ 
        
       
      
        \gamma
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.625em; vertical-align: -0.1944em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0556em;">
          γ
         </span>
        </span>
       </span>
      </span>
     </span>
     是一个超参数设置为0.1。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/c5be7addd9d74505ae6ec03d0b70001e.png"/>
    </p>
    <h2>
     <a id="_85">
     </a>
     感受野的变化
    </h2>
    <p>
     当可变形卷积叠加时，复合变形的影响是深远的。标准卷积中的感受野和采样位置在顶部特征映射上是固定的（左）。它们在可变形卷积中（右）根据目标的尺寸和形状进行自适应调整。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/46f9eef8106a4dc9bdfc7322b542dc56.png"/>
    </p>
    <p>
     标准卷积（a）中的固定感受野和可变形卷积（b）中的自适应感受野的图示，使用两层。顶部：顶部特征映射上的两个激活单元，在两个不同尺度和形状的目标上。激活来自3×3滤波器。中间：前一个特征映射上3×3滤波器的采样位置。另外两个激活单元突出显示。底部：前一个特征映射上两个3×3滤波器级别的采样位置。突出显示两组位置，对应于上面突出显示的单元。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/d34386a6ade9408598405da9ce03769c.png"/>
    </p>
    <p>
     每个图像三元组在三级3×3可变形滤波器中显示了三个激活单元（绿色点）分别在背景（左）、小目标（中）和大目标（右）上的采样位置（每张图像中的93=72993=729个红色点）。
    </p>
    <h2>
     <a id="_99">
     </a>
     结果
    </h2>
    <p>
     四个模型的backbone层都是使用的ResNet-101，且在相同层将标准卷积替换为可形变卷积。@V和@C分别对应VOC 2012和PASCAl VOC数据集。其余三个网络对应的是目标检测任务，使用VOC2007数据集，并使用mAP作为检验标准，@0.5和@0.7分别对应使用0.5和0.7的IoU。
     <br/>
     从图中我们可以看出加入可形变卷积后，每个模型的准确率都得到了提升。DeepLab在加入3层可形变卷积后准确率最高，其余网络在加入6层可形变卷积后准确率最高。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/1d678fe55af44909938dc790749fc44c.png"/>
    </p>
    <h2>
     <a id="_107">
     </a>
     实验
    </h2>
    <p>
     https://github.com/4uiiurz1/pytorch-deform-conv-v2
    </p>
    <p>
     可变形卷积的pytorch模块，modulation=True可以设置为DCNv2版本。
    </p>
    <p>
     偏移量预测卷积层
     <code>
      self.p_conv
     </code>
     ，用于生成偏移量。
    </p>
    <p>
     对调整后的输入特征图进行卷积操作，普通卷积层
     <code>
      self.conv
     </code>
     。
    </p>
    <p>
     使用可变形卷积模块可以很方便的替换原有的CNN模块，直接使用。
    </p>
    <pre><code class="prism language-python"><span class="token keyword">import</span> torch
<span class="token keyword">from</span> torch <span class="token keyword">import</span> nn


<span class="token keyword">class</span> <span class="token class-name">DeformConv2d</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> inc<span class="token punctuation">,</span> outc<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> modulation<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Args:
            modulation (bool, optional): If True, Modulated Defomable Convolution (Deformable ConvNets v2).
        """</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>DeformConv2d<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>kernel_size <span class="token operator">=</span> kernel_size
        self<span class="token punctuation">.</span>padding <span class="token operator">=</span> padding
        self<span class="token punctuation">.</span>stride <span class="token operator">=</span> stride
        self<span class="token punctuation">.</span>zero_padding <span class="token operator">=</span> nn<span class="token punctuation">.</span>ZeroPad2d<span class="token punctuation">(</span>padding<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>inc<span class="token punctuation">,</span> outc<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span>kernel_size<span class="token punctuation">,</span> stride<span class="token operator">=</span>kernel_size<span class="token punctuation">,</span> bias<span class="token operator">=</span>bias<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>p_conv <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>inc<span class="token punctuation">,</span> <span class="token number">2</span><span class="token operator">*</span>kernel_size<span class="token operator">*</span>kernel_size<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> stride<span class="token operator">=</span>stride<span class="token punctuation">)</span>
        nn<span class="token punctuation">.</span>init<span class="token punctuation">.</span>constant_<span class="token punctuation">(</span>self<span class="token punctuation">.</span>p_conv<span class="token punctuation">.</span>weight<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>p_conv<span class="token punctuation">.</span>register_backward_hook<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_set_lr<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>modulation <span class="token operator">=</span> modulation
        <span class="token keyword">if</span> modulation<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>m_conv <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>inc<span class="token punctuation">,</span> kernel_size<span class="token operator">*</span>kernel_size<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> stride<span class="token operator">=</span>stride<span class="token punctuation">)</span>
            nn<span class="token punctuation">.</span>init<span class="token punctuation">.</span>constant_<span class="token punctuation">(</span>self<span class="token punctuation">.</span>m_conv<span class="token punctuation">.</span>weight<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>m_conv<span class="token punctuation">.</span>register_backward_hook<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_set_lr<span class="token punctuation">)</span>

    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">_set_lr</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> grad_input<span class="token punctuation">,</span> grad_output<span class="token punctuation">)</span><span class="token punctuation">:</span>
        grad_input <span class="token operator">=</span> <span class="token punctuation">(</span>grad_input<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">0.1</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>grad_input<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        grad_output <span class="token operator">=</span> <span class="token punctuation">(</span>grad_output<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">0.1</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>grad_output<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        offset <span class="token operator">=</span> self<span class="token punctuation">.</span>p_conv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>modulation<span class="token punctuation">:</span>
            m <span class="token operator">=</span> torch<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>self<span class="token punctuation">.</span>m_conv<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>

        dtype <span class="token operator">=</span> offset<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        ks <span class="token operator">=</span> self<span class="token punctuation">.</span>kernel_size
        N <span class="token operator">=</span> offset<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">//</span> <span class="token number">2</span>

        <span class="token keyword">if</span> self<span class="token punctuation">.</span>padding<span class="token punctuation">:</span>
            x <span class="token operator">=</span> self<span class="token punctuation">.</span>zero_padding<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

        <span class="token comment"># (b, 2N, h, w)</span>
        p <span class="token operator">=</span> self<span class="token punctuation">.</span>_get_p<span class="token punctuation">(</span>offset<span class="token punctuation">,</span> dtype<span class="token punctuation">)</span>

        <span class="token comment"># (b, h, w, 2N)</span>
        p <span class="token operator">=</span> p<span class="token punctuation">.</span>contiguous<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>permute<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        q_lt <span class="token operator">=</span> p<span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>floor<span class="token punctuation">(</span><span class="token punctuation">)</span>
        q_rb <span class="token operator">=</span> q_lt <span class="token operator">+</span> <span class="token number">1</span>

        q_lt <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>torch<span class="token punctuation">.</span>clamp<span class="token punctuation">(</span>q_lt<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token punctuation">:</span>N<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> torch<span class="token punctuation">.</span>clamp<span class="token punctuation">(</span>q_lt<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> N<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        q_rb <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>torch<span class="token punctuation">.</span>clamp<span class="token punctuation">(</span>q_rb<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token punctuation">:</span>N<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> torch<span class="token punctuation">.</span>clamp<span class="token punctuation">(</span>q_rb<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> N<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        q_lb <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>q_lt<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token punctuation">:</span>N<span class="token punctuation">]</span><span class="token punctuation">,</span> q_rb<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> N<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        q_rt <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>q_rb<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token punctuation">:</span>N<span class="token punctuation">]</span><span class="token punctuation">,</span> q_lt<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> N<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>

        <span class="token comment"># clip p</span>
        p <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>torch<span class="token punctuation">.</span>clamp<span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token punctuation">:</span>N<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> torch<span class="token punctuation">.</span>clamp<span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> N<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>

        <span class="token comment"># bilinear kernel (b, h, w, N)</span>
        g_lt <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>q_lt<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token punctuation">:</span>N<span class="token punctuation">]</span><span class="token punctuation">.</span>type_as<span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token operator">-</span> p<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token punctuation">:</span>N<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>q_lt<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> N<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type_as<span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token operator">-</span> p<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> N<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        g_rb <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> <span class="token punctuation">(</span>q_rb<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token punctuation">:</span>N<span class="token punctuation">]</span><span class="token punctuation">.</span>type_as<span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token operator">-</span> p<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token punctuation">:</span>N<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> <span class="token punctuation">(</span>q_rb<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> N<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type_as<span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token operator">-</span> p<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> N<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        g_lb <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>q_lb<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token punctuation">:</span>N<span class="token punctuation">]</span><span class="token punctuation">.</span>type_as<span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token operator">-</span> p<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token punctuation">:</span>N<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> <span class="token punctuation">(</span>q_lb<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> N<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type_as<span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token operator">-</span> p<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> N<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        g_rt <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> <span class="token punctuation">(</span>q_rt<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token punctuation">:</span>N<span class="token punctuation">]</span><span class="token punctuation">.</span>type_as<span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token operator">-</span> p<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token punctuation">:</span>N<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>q_rt<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> N<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type_as<span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token operator">-</span> p<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> N<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment"># (b, c, h, w, N)</span>
        x_q_lt <span class="token operator">=</span> self<span class="token punctuation">.</span>_get_x_q<span class="token punctuation">(</span>x<span class="token punctuation">,</span> q_lt<span class="token punctuation">,</span> N<span class="token punctuation">)</span>
        x_q_rb <span class="token operator">=</span> self<span class="token punctuation">.</span>_get_x_q<span class="token punctuation">(</span>x<span class="token punctuation">,</span> q_rb<span class="token punctuation">,</span> N<span class="token punctuation">)</span>
        x_q_lb <span class="token operator">=</span> self<span class="token punctuation">.</span>_get_x_q<span class="token punctuation">(</span>x<span class="token punctuation">,</span> q_lb<span class="token punctuation">,</span> N<span class="token punctuation">)</span>
        x_q_rt <span class="token operator">=</span> self<span class="token punctuation">.</span>_get_x_q<span class="token punctuation">(</span>x<span class="token punctuation">,</span> q_rt<span class="token punctuation">,</span> N<span class="token punctuation">)</span>

        <span class="token comment"># (b, c, h, w, N)</span>
        x_offset <span class="token operator">=</span> g_lt<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> x_q_lt <span class="token operator">+</span> \
                   g_rb<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> x_q_rb <span class="token operator">+</span> \
                   g_lb<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> x_q_lb <span class="token operator">+</span> \
                   g_rt<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> x_q_rt

        <span class="token comment"># modulation</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>modulation<span class="token punctuation">:</span>
            m <span class="token operator">=</span> m<span class="token punctuation">.</span>contiguous<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>permute<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
            m <span class="token operator">=</span> m<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
            m <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>m <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>x_offset<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
            x_offset <span class="token operator">*=</span> m

        x_offset <span class="token operator">=</span> self<span class="token punctuation">.</span>_reshape_x_offset<span class="token punctuation">(</span>x_offset<span class="token punctuation">,</span> ks<span class="token punctuation">)</span>
        out <span class="token operator">=</span> self<span class="token punctuation">.</span>conv<span class="token punctuation">(</span>x_offset<span class="token punctuation">)</span>

        <span class="token keyword">return</span> out

    <span class="token keyword">def</span> <span class="token function">_get_p_n</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> N<span class="token punctuation">,</span> dtype<span class="token punctuation">)</span><span class="token punctuation">:</span>
        p_n_x<span class="token punctuation">,</span> p_n_y <span class="token operator">=</span> torch<span class="token punctuation">.</span>meshgrid<span class="token punctuation">(</span>
            torch<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token operator">-</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>kernel_size<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">//</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>kernel_size<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">//</span><span class="token number">2</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            torch<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token operator">-</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>kernel_size<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">//</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>kernel_size<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">//</span><span class="token number">2</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># (2N, 1)</span>
        p_n <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>torch<span class="token punctuation">.</span>flatten<span class="token punctuation">(</span>p_n_x<span class="token punctuation">)</span><span class="token punctuation">,</span> torch<span class="token punctuation">.</span>flatten<span class="token punctuation">(</span>p_n_y<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        p_n <span class="token operator">=</span> p_n<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token operator">*</span>N<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">(</span>dtype<span class="token punctuation">)</span>

        <span class="token keyword">return</span> p_n

    <span class="token keyword">def</span> <span class="token function">_get_p_0</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> h<span class="token punctuation">,</span> w<span class="token punctuation">,</span> N<span class="token punctuation">,</span> dtype<span class="token punctuation">)</span><span class="token punctuation">:</span>
        p_0_x<span class="token punctuation">,</span> p_0_y <span class="token operator">=</span> torch<span class="token punctuation">.</span>meshgrid<span class="token punctuation">(</span>
            torch<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> h<span class="token operator">*</span>self<span class="token punctuation">.</span>stride<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>stride<span class="token punctuation">)</span><span class="token punctuation">,</span>
            torch<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> w<span class="token operator">*</span>self<span class="token punctuation">.</span>stride<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>stride<span class="token punctuation">)</span><span class="token punctuation">)</span>
        p_0_x <span class="token operator">=</span> torch<span class="token punctuation">.</span>flatten<span class="token punctuation">(</span>p_0_x<span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> h<span class="token punctuation">,</span> w<span class="token punctuation">)</span><span class="token punctuation">.</span>repeat<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> N<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        p_0_y <span class="token operator">=</span> torch<span class="token punctuation">.</span>flatten<span class="token punctuation">(</span>p_0_y<span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> h<span class="token punctuation">,</span> w<span class="token punctuation">)</span><span class="token punctuation">.</span>repeat<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> N<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        p_0 <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>p_0_x<span class="token punctuation">,</span> p_0_y<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">(</span>dtype<span class="token punctuation">)</span>

        <span class="token keyword">return</span> p_0

    <span class="token keyword">def</span> <span class="token function">_get_p</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> dtype<span class="token punctuation">)</span><span class="token punctuation">:</span>
        N<span class="token punctuation">,</span> h<span class="token punctuation">,</span> w <span class="token operator">=</span> offset<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">//</span><span class="token number">2</span><span class="token punctuation">,</span> offset<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> offset<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>

        <span class="token comment"># (1, 2N, 1, 1)</span>
        p_n <span class="token operator">=</span> self<span class="token punctuation">.</span>_get_p_n<span class="token punctuation">(</span>N<span class="token punctuation">,</span> dtype<span class="token punctuation">)</span>
        <span class="token comment"># (1, 2N, h, w)</span>
        p_0 <span class="token operator">=</span> self<span class="token punctuation">.</span>_get_p_0<span class="token punctuation">(</span>h<span class="token punctuation">,</span> w<span class="token punctuation">,</span> N<span class="token punctuation">,</span> dtype<span class="token punctuation">)</span>
        p <span class="token operator">=</span> p_0 <span class="token operator">+</span> p_n <span class="token operator">+</span> offset
        <span class="token keyword">return</span> p

    <span class="token keyword">def</span> <span class="token function">_get_x_q</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> q<span class="token punctuation">,</span> N<span class="token punctuation">)</span><span class="token punctuation">:</span>
        b<span class="token punctuation">,</span> h<span class="token punctuation">,</span> w<span class="token punctuation">,</span> _ <span class="token operator">=</span> q<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span>
        padded_w <span class="token operator">=</span> x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
        c <span class="token operator">=</span> x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token comment"># (b, c, h*w)</span>
        x <span class="token operator">=</span> x<span class="token punctuation">.</span>contiguous<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span>b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>

        <span class="token comment"># (b, h, w, N)</span>
        index <span class="token operator">=</span> q<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token punctuation">:</span>N<span class="token punctuation">]</span><span class="token operator">*</span>padded_w <span class="token operator">+</span> q<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> N<span class="token punctuation">:</span><span class="token punctuation">]</span>  <span class="token comment"># offset_x*w + offset_y</span>
        <span class="token comment"># (b, c, h*w*N)</span>
        index <span class="token operator">=</span> index<span class="token punctuation">.</span>contiguous<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>expand<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> c<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>contiguous<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span>b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>

        x_offset <span class="token operator">=</span> x<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> index<span class="token operator">=</span>index<span class="token punctuation">)</span><span class="token punctuation">.</span>contiguous<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span>b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> h<span class="token punctuation">,</span> w<span class="token punctuation">,</span> N<span class="token punctuation">)</span>

        <span class="token keyword">return</span> x_offset

    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">_reshape_x_offset</span><span class="token punctuation">(</span>x_offset<span class="token punctuation">,</span> ks<span class="token punctuation">)</span><span class="token punctuation">:</span>
        b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> h<span class="token punctuation">,</span> w<span class="token punctuation">,</span> N <span class="token operator">=</span> x_offset<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span>
        x_offset <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>x_offset<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> s<span class="token punctuation">:</span>s<span class="token operator">+</span>ks<span class="token punctuation">]</span><span class="token punctuation">.</span>contiguous<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span>b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> h<span class="token punctuation">,</span> w<span class="token operator">*</span>ks<span class="token punctuation">)</span> <span class="token keyword">for</span> s <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> N<span class="token punctuation">,</span> ks<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        x_offset <span class="token operator">=</span> x_offset<span class="token punctuation">.</span>contiguous<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span>b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> h<span class="token operator">*</span>ks<span class="token punctuation">,</span> w<span class="token operator">*</span>ks<span class="token punctuation">)</span>

        <span class="token keyword">return</span> x_offset


</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f35333833343234342f:61727469636c652f64657461696c732f313436323835353831" class_="artid" style="display:none">
 </p>
</div>


