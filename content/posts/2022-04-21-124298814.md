---
layout: post
title: "Jest测试框架入门之快照测试附踩坑指南"
date: 2022-04-21 17:57:24 +0800
description: "一、快照测试简介快照测试是用于确保某个组件的UI不会有意外的改变，与UI测试不同，快照测试不会对比样"
keywords: "jest 快照"
categories: ['未分类']
tags: ['单元测试', 'Javascript']
artid: "124298814"
image:
  path: https://api.vvhan.com/api/bing?rand=sj&artid=124298814
  alt: "Jest测试框架入门之快照测试附踩坑指南"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=124298814
featuredImagePreview: https://bing.ee123.net/img/rand?artid=124298814
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Jest测试框架入门之快照测试（附踩坑指南）
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <div class="toc">
     <h4>
      文章目录
     </h4>
     <ul>
      <li>
       <a href="#_1" rel="nofollow">
        一、快照测试简介
       </a>
      </li>
      <li>
       <a href="#Enzyme_146" rel="nofollow">
        二、Enzyme
       </a>
      </li>
      <li>
       <a href="#reacttestinglibrary_205" rel="nofollow">
        三、react-testing-library（推荐）
       </a>
      </li>
      <li>
       <a href="#RTL_260" rel="nofollow">
        四、RTL的最佳实践
       </a>
      </li>
     </ul>
    </div>
    <p>
    </p>
    <h2>
     <a id="_1">
     </a>
     一、快照测试简介
    </h2>
    <p>
     快照测试是用于确保某个组件的UI不会有意外的改变，与UI测试不同，快照测试不会对比样式文件，仅对比dom结构和节点参数。
    </p>
    <p>
     进行快照测试最简单的做法需要引入渲染器
     <strong>
      react-test-renderer
     </strong>
     ：
    </p>
    <pre><code class="prism language-bash"><span class="token function">yarn</span> <span class="token function">add</span> -D react-test-renderer
</code></pre>
    <p>
     接下来我们写一个时间组件，使用的框架为umi3：
    </p>
    <pre><code class="prism language-typescript"><span class="token comment">// MyDate/index.tsx</span>

<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> styles <span class="token keyword">from</span> <span class="token string">'./index.less'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">MyDate</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">const</span> <span class="token punctuation">[</span>time<span class="token punctuation">,</span> setTime<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLocaleTimeString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">updateTime</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
<span class="token function">setTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLocaleTimeString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">return</span> <span class="token punctuation">(</span>
<span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>styles<span class="token punctuation">.</span>root<span class="token punctuation">}</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">'time'</span><span class="token operator">&gt;</span>当前时间为：<span class="token punctuation">{<!-- --></span>time<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>button className<span class="token operator">=</span><span class="token string">'btn'</span> onClick<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>updateTime<span class="token punctuation">}</span><span class="token operator">&gt;</span>更新时间<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> MyDate
</code></pre>
<pre><code class="prism language-css"><span class="token selector">// MyDate/index.less

.root</span> <span class="token punctuation">{<!-- --></span>
<span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span>
<span class="token property">flex-direction</span><span class="token punctuation">:</span> column<span class="token punctuation">;</span>
<span class="token property">align-items</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>

<span class="token selector">:global</span> <span class="token punctuation">{<!-- --></span>
<span class="token selector">.time</span> <span class="token punctuation">{<!-- --></span>
<span class="token property">font-size</span><span class="token punctuation">:</span> 30px<span class="token punctuation">;</span>
<span class="token property">margin-bottom</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>
写一个测试文件
<strong>
MyDate.spec.tsx
</strong>
，注意命名以
<strong>
tsx
</strong>
结尾 ：
</p>
<pre><code class="prism language-typescript"><span class="token keyword">import</span> renderer <span class="token keyword">from</span> <span class="token string">'react-test-renderer'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> MyDate <span class="token keyword">from</span> <span class="token string">'../MyDate'</span><span class="token punctuation">;</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'测试 MyDate 组件'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">const</span> tree <span class="token operator">=</span> renderer<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>MyDate <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">expect</span><span class="token punctuation">(</span>tree<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toMatchSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p>
运行结果：
</p>
<p>
<img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/96fd2cb41732c6382b493937e1c4e51d.jpeg#pic_center">
<br/>
遇到了很常见的错误，解析不了 less 模块。解决办法：
<a href="https://www.jestjs.cn/docs/webpack#mocking-css-modules" rel="nofollow">
官网指路
</a>
</img>
</p>
<p>
根据官网的方法安装并配置 identity-obj-proxy 之后，重新运行：
</p>
<p>
<img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/80c1cd6c1b3be7b6ac4a2b3a68a6763d.png#pic_center">
<br/>
这种 Cannot read property ‘xxx’ of undefined 的错，大部分原因都是安装的 react 版本和 react-test-renderer 版本不匹配导致，我项目里用的 react 版本为 17，而 react-test-renderer 版本为 18，现在降级为 17:
</img>
</p>
<pre><code class="prism language-bash"><span class="token function">yarn</span> upgrade react-test-renderer@17.0.0
</code></pre>
<p>
再次运行，报错消失，用例通过，且**test**目录下生成一个名为**snapshots**的文件夹，该文件夹下有一个快照文件：
</p>
<pre><code class="prism language-typescript"><span class="token comment">// MyDate.spec.tsx.snap</span>

exports<span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">测试 MyDate 组件 1</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
&lt;div
  className="root"
&gt;
  &lt;div
    className="time"
  &gt;
    当前时间为：
    下午5:54:02
  &lt;/div&gt;
  &lt;button
    className="btn"
    onClick={[Function]}
  &gt;
    更新时间
  &lt;/button&gt;
&lt;/div&gt;
</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
</code></pre>
<p>
再次运行：
</p>
<p>
<img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/c211d65a89e2cbc810cc8111b5f859ea.png#pic_center">
<br/>
这次不是报错，是用例失败了，这是由于我们每次运行的时候取得都是当前时间，和之前保存的快照对不上，这个时候我们可以
<strong>
通过 mock useState 来解决
</strong>
，修改测试文件如下：
</img>
</p>
<pre><code class="prism language-typescript"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> renderer <span class="token keyword">from</span> <span class="token string">'react-test-renderer'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> MyDate <span class="token keyword">from</span> <span class="token string">'../MyDate'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> setState <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> useStateSpy <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">spyOn</span><span class="token punctuation">(</span>React<span class="token punctuation">,</span> <span class="token string">'useState'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> useStateMock<span class="token operator">:</span> <span class="token function-variable function">any</span> <span class="token operator">=</span> <span class="token punctuation">(</span>initState<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span><span class="token string">'中午 12:00:00'</span><span class="token punctuation">,</span> setState<span class="token punctuation">]</span><span class="token punctuation">;</span>
useStateSpy<span class="token punctuation">.</span><span class="token function">mockImplementation</span><span class="token punctuation">(</span>useStateMock<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'测试 MyDate 组件'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">const</span> tree <span class="token operator">=</span> renderer<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>MyDate <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">expect</span><span class="token punctuation">(</span>tree<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toMatchSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p>
更新一下 snap 文件：
</p>
<pre><code class="prism language-bash">jest -u --testNamePattern<span class="token operator">=</span><span class="token string">'测试 MyDate 组件'</span>
</code></pre>
<p>
现在运行用例会通过，且 snap 文件变为：
</p>
<pre><code class="prism language-typescript">exports<span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">测试 MyDate 组件 1</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
&lt;div
  className="root"
&gt;
  &lt;div
    className="time"
  &gt;
    当前时间为：
    中午12:00:00
  &lt;/div&gt;
  &lt;button
    className="btn"
    onClick={[Function]}
  &gt;
    更新时间
  &lt;/button&gt;
&lt;/div&gt;
</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
</code></pre>
<h2>
<a id="Enzyme_146">
</a>
二、Enzyme
</h2>
<p>
如果需要进行组件行为监测，当
<strong>
React 版本 &lt;= 16
</strong>
时可以使用 Enzyme 库。首先安装一些依赖：
</p>
<pre><code class="prism language-bash"><span class="token function">yarn</span> <span class="token function">add</span> -D enzyme @types/enzyme @wojtekmaj/enzyme-adapter-react-17
</code></pre>
<p>
上面安装的@wojtekmaj/enzyme-adapter-react-17 是非官方版的适配器，这也是为什么
<strong>
不推荐
</strong>
React 版本 &gt;= 17 时使用 enzyme。
</p>
<p>
我们写一个非常简单的 Counter 组件：
</p>
<pre><code class="prism language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">Counter</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
<span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">handleReset</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
<span class="token function">setCount</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">return</span> <span class="token punctuation">(</span>
<span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>handleClick<span class="token punctuation">}</span><span class="token operator">&gt;</span>该按钮点击了<span class="token punctuation">{<!-- --></span>count<span class="token punctuation">}</span>次<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>handleReset<span class="token punctuation">}</span><span class="token operator">&gt;</span>重置点击次数<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> Counter
</code></pre>
<p>
写一个测试文件：
</p>
<pre><code class="prism language-typescript"><span class="token keyword">import</span> Counter <span class="token keyword">from</span> <span class="token string">'../Counter'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> configure<span class="token punctuation">,</span> shallow <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'enzyme'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Adapter <span class="token keyword">from</span> <span class="token string">'@wojtekmaj/enzyme-adapter-react-17'</span><span class="token punctuation">;</span>

<span class="token function">configure</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> adapter<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Adapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'测试 Counter 组件'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">const</span> c <span class="token operator">=</span> <span class="token function">shallow</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>Counter <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">)</span>

<span class="token function">expect</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">at</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">'该按钮点击了 0 次'</span><span class="token punctuation">)</span>

c<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">at</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">simulate</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">)</span>
c<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">at</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">simulate</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">)</span>

<span class="token function">expect</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">at</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">'该按钮点击了 2 次'</span><span class="token punctuation">)</span>

c<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">at</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">simulate</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">)</span>

<span class="token function">expect</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">at</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">'该按钮点击了 0 次'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p>
运行，通过！
</p>
<h2>
<a id="reacttestinglibrary_205">
</a>
三、react-testing-library（推荐）
</h2>
<p>
React 官网写了这么一句话：
<strong>
我们推荐使用
<a href="https://testing-library.com/docs/react-testing-library/intro/" rel="nofollow">
React Testing Library
</a>
，它使得针对组件编写测试用例就像终端用户在使用它一样方便。
</strong>
</p>
<p>
<strong>
还有一篇文章也值得一看：
<a href="https://www.piotrstaniow.pl/goodbye-enzyme" rel="nofollow">
Time to say goodbye - Enzyme.js
</a>
</strong>
</p>
<p>
从 npm 的周下载量上可以看到 react-testing-library 是 enzyme 的两倍有余，看来 enzyme 的时代确实已经落幕了。下面我们也简单看一下 react-testing-library 的使用：
</p>
<pre><code class="prism language-bash"><span class="token function">yarn</span> <span class="token function">add</span> --dev @testing-library/react
</code></pre>
<p>
我们还是以上面的 Counter 组件为例，重写一下测试文件：
</p>
<pre><code class="prism language-typescript"><span class="token keyword">import</span> Counter <span class="token keyword">from</span> <span class="token string">'../Counter'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> render<span class="token punctuation">,</span> screen <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@testing-library/react'</span><span class="token punctuation">;</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'测试 Counter 组件'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
<span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>Counter <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">)</span>
screen<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p>
运行一下，可能会出现以下报错：
<br/>
1、
<strong>
Cannot find module ‘xxx’ from ‘xxx’
</strong>
</p>
<p>
解决办法：将@testing-library/react 降级到 12.x.x 版本
</p>
<p>
2、
<strong>
The error below may be caused by using the wrong test environment. Consider using the “jsdom” test environment.
</strong>
</p>
<p>
解决办法：将 jest.config.js 中的 testEnvironment 改为 jsdom。
</p>
<p>
解决报错后，运行可看到通过 screen.debug()在控制台打印出了 dom 结构。
</p>
<p>
写一个与上面类似的测试如下：
</p>
<pre><code class="prism language-typescript"><span class="token keyword">import</span> Counter <span class="token keyword">from</span> <span class="token string">'../Counter'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> render<span class="token punctuation">,</span> screen<span class="token punctuation">,</span> fireEvent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@testing-library/react'</span><span class="token punctuation">;</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'测试 Counter 组件'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
<span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>Counter <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">)</span>
<span class="token comment">// screen.debug()</span>

<span class="token function">expect</span><span class="token punctuation">(</span>screen<span class="token punctuation">.</span><span class="token function">getAllByRole</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>textContent<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">'该按钮点击了 0 次'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

fireEvent<span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span>screen<span class="token punctuation">.</span><span class="token function">getAllByRole</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token function">expect</span><span class="token punctuation">(</span>screen<span class="token punctuation">.</span><span class="token function">getAllByRole</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>textContent<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">'该按钮点击了 1 次'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

fireEvent<span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span>screen<span class="token punctuation">.</span><span class="token function">getAllByRole</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token function">expect</span><span class="token punctuation">(</span>screen<span class="token punctuation">.</span><span class="token function">getAllByRole</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>textContent<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">'该按钮点击了 0 次'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p>
运行，通过！
</p>
<h2>
<a id="RTL_260">
</a>
四、RTL 的最佳实践
</h2>
<p>
上面用 RTL 测试框架写了一个简单的测试用例，实际在项目里使用的话建议安装以下几个依赖，以便写出更规范、更高效的测试用例：
</p>
<p>
<strong>
1、
<a href="https://github.com/testing-library/jest-dom">
@testing-library/jest-dom
</a>
，该库拓展了一些 jest 匹配器，可以使测试用例更具声明性且更易于阅读和维护。
</strong>
</p>
<pre><code class="prism language-bash"><span class="token function">yarn</span> <span class="token function">add</span> -D @testing-library/jest-dom
</code></pre>
<p>
<strong>
2、
<a href="https://github.com/testing-library/user-event">
@testing-library/user-event
</a>
，该库是 fireEvent 的替代品，更接近用户的真实交互场景，尽可能用 userEvent 而不是 fireEvent。
</strong>
</p>
<pre><code class="prism language-bash"><span class="token function">yarn</span> <span class="token function">add</span> -D @testing-library/user-event
</code></pre>
<p>
<strong>
3、
<a href="https://github.com/testing-library/eslint-plugin-testing-library">
eslint-plugin-testing-library
</a>
和
<a href="https://github.com/testing-library/eslint-plugin-jest-dom">
eslint-plugin-jest-dom
</a>
，这两个 eslint 插件会帮助我们在使用测试库编写测试时遵循最佳实践并预测常见错误。
</strong>
</p>
<pre><code class="prism language-bash"><span class="token function">yarn</span> <span class="token function">add</span> -D eslint-plugin-testing-library eslint-plugin-jest-dom
</code></pre>
<p>
OK，安装完毕之后，重新写一个测试页面：
</p>
<pre><code class="prism language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> useRef <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token comment">/\*\*

- 这里使用的是 antd-mobile v2.3.1 版本
  \*/</span>
  <span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> Toast <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'antd-mobile'</span><span class="token punctuation">;</span>
  <span class="token keyword">import</span> styles <span class="token keyword">from</span> <span class="token string">'./index.less'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">Page</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">const</span> input <span class="token operator">=</span> <span class="token generic-function"><span class="token function">useRef</span><span class="token generic class-name"><span class="token operator">&lt;</span>HTMLInputElement<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">submit</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">if</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span>current<span class="token operator">?.</span>value<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
Toast<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token string">'提交成功'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
Toast<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token string">'姓名不能为空'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">return</span> <span class="token punctuation">(</span>
<span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>styles<span class="token punctuation">.</span>page<span class="token punctuation">}</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">'container'</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>姓名：<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>input ref<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>input<span class="token punctuation">}</span> type<span class="token operator">=</span><span class="token string">"text"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>submit<span class="token punctuation">}</span><span class="token operator">&gt;</span>确认<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> Page
</code></pre>
<p>
测试文件如下：
</p>
<pre><code class="prism language-typescript"><span class="token keyword">import</span> Page <span class="token keyword">from</span> <span class="token string">'../index'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> render<span class="token punctuation">,</span> screen <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@testing-library/react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> userEvent <span class="token keyword">from</span> <span class="token string">'@testing-library/user-event'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">'@testing-library/jest-dom'</span><span class="token punctuation">;</span>

jest<span class="token punctuation">.</span><span class="token function">useFakeTimers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'测试 Page'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
<span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>Page <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">)</span>
<span class="token comment">// 点击确认</span>
userEvent<span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span>screen<span class="token punctuation">.</span><span class="token function">getByRole</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> name<span class="token operator">:</span> <span class="token string">'确认'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// 弹窗文字为 '姓名不能为空'</span>
<span class="token function">expect</span><span class="token punctuation">(</span>screen<span class="token punctuation">.</span><span class="token function">getByRole</span><span class="token punctuation">(</span><span class="token string">'alert'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>innerHTML<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">'姓名不能为空'</span><span class="token punctuation">)</span>
<span class="token comment">// 将时间快进 3s</span>
jest<span class="token punctuation">.</span><span class="token function">advanceTimersByTime</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 弹窗不存在于文档中</span>
<span class="token function">expect</span><span class="token punctuation">(</span>screen<span class="token punctuation">.</span><span class="token function">queryByRole</span><span class="token punctuation">(</span><span class="token string">'alert'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>not<span class="token punctuation">.</span><span class="token function">toBeInTheDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 输入 '123' 并点击确认</span>
userEvent<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span>screen<span class="token punctuation">.</span><span class="token function">getByRole</span><span class="token punctuation">(</span><span class="token string">'textbox'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'123'</span><span class="token punctuation">)</span>
userEvent<span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span>screen<span class="token punctuation">.</span><span class="token function">getByRole</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> name<span class="token operator">:</span> <span class="token string">'确认'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// 弹窗文字为 '提交成功'</span>
<span class="token function">expect</span><span class="token punctuation">(</span>screen<span class="token punctuation">.</span><span class="token function">getByRole</span><span class="token punctuation">(</span><span class="token string">'alert'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>innerHTML<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">'提交成功'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p>
运行，通过。
</p>
<p>
参考文章：
<a href="https://blog.csdn.net/MonsterException/article/details/123919935">
使用 React Testing LIbrary 的 15 个常见错误
</a>
</p>

   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f34343331383231352f:61727469636c652f64657461696c732f313234323938383134" class_="artid" style="display:none">
 </p>
</div>
