---
layout: post
title: "鸿蒙系统分布式文件概述访问拷贝"
date: 2025-03-03 10:21:53 +0800
description: "分布式文件系统（hmdfs，HarmonyOS Distributed File System）提供跨设备的文件访问能力，适用于如下场景：两台设备组网，用户可以利用一台设备上的编辑软件编辑另外一台设备上的文档。平板保存的音乐，车载系统直接可见并可播放。户外拍摄的照片，回家打开平板直接访问原设备拍摄的照片。hmdfs在分布式软总线动态组网的基础上，为网络上各个设备结点提供一个全局一致的访问视图，支持开发者通过基础文件系统的接口进行读写访问，具有高性能、低延时等优点。"
keywords: "鸿蒙系统分布式文件概述、访问、拷贝"
categories: ['鸿蒙']
tags: ['华为', '分布式', 'Harmonyos']
artid: "145976626"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=145976626
    alt: "鸿蒙系统分布式文件概述访问拷贝"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=145976626
featuredImagePreview: https://bing.ee123.net/img/rand?artid=145976626
cover: https://bing.ee123.net/img/rand?artid=145976626
image: https://bing.ee123.net/img/rand?artid=145976626
img: https://bing.ee123.net/img/rand?artid=145976626
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     鸿蒙系统分布式文件概述、访问、拷贝
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h3>
     <a id="1__0">
     </a>
     1. 分布式文件系统概述
    </h3>
    <p>
     分布式文件系统（hmdfs，HarmonyOS Distributed File System）提供跨设备的文件访问能力，适用于如下场景：
    </p>
    <ul>
     <li>
      <p>
       两台设备组网，用户可以利用一台设备上的编辑软件编辑另外一台设备上的文档。
      </p>
     </li>
     <li>
      <p>
       平板保存的音乐，车载系统直接可见并可播放。
      </p>
     </li>
     <li>
      <p>
       户外拍摄的照片，回家打开平板直接访问原设备拍摄的照片。
      </p>
     </li>
    </ul>
    <p>
     hmdfs在分布式软总线动态组网的基础上，为网络上各个设备结点提供一个全局一致的访问视图，支持开发者通过基础文件系统的接口进行读写访问，具有高性能、低延时等优点。
    </p>
    <h3>
     <a id="2__10">
     </a>
     2. 设置分布式文件等级
    </h3>
    <p>
     不同设备本身的安全能力差异较大，因此，HarmonyOS提供一套完整的数据分级、设备分级标准，并针对不同设备制定不同的数据流转策略。
     <br/>
     官方提供的API：
     <em>
      setSecurityLabel
     </em>
    </p>
    <p>
     使用方式：
    </p>
    <pre><code class="prism language-javascript"><span class="token comment">//打开文件</span>
<span class="token keyword">let</span> file <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">openSync</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> fs<span class="token punctuation">.</span>OpenMode<span class="token punctuation">.</span><span class="token constant">READ_WRITE</span> <span class="token operator">|</span> fs<span class="token punctuation">.</span>OpenMode<span class="token punctuation">.</span><span class="token constant">CREATE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 设置文件的数据等级为s0</span>
securityLabel<span class="token punctuation">.</span><span class="token function">setSecurityLabel</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> <span class="token string">'s0'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'Succeeded in setSecurityLabeling.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  fs<span class="token punctuation">.</span><span class="token function">closeSync</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">err</span><span class="token operator">:</span> BusinessError</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Failed to setSecurityLabel. Code: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>err<span class="token punctuation">.</span>code<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, message: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>err<span class="token punctuation">.</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <h3>
     <a id="3__27">
     </a>
     3. 跨设备文件访问
    </h3>
    <p>
     分布式文件系统为应用提供了跨设备文件访问的能力，开发者在两个设备安装同一应用时，通过基础文件接口，可跨设备读写另一个设备该应用分布式文件路径（/data/storage/el2/distributedfiles/）下的文件。例如：多设备数据流转的场景，设备组网互联之后，设备A上的应用可访问设备B同应用分布式路径下的文件，当期望应用文件被其他设备访问时，只需将文件移动到分布式文件路径即可。
    </p>
    <h4>
     <a id="_29">
     </a>
     使用步骤：
    </h4>
    <h5>
     <a id="1__30">
     </a>
     1. 完成组网
    </h5>
    <p>
     将需要跨设备访问的两个设备登录同一账号，保证设备蓝牙和Wi-Fi功能开启，蓝牙无需互连，Wi-Fi无需接入同一个局域网。
    </p>
    <h5>
     <a id="2__32">
     </a>
     2. 访问跨设备文件
    </h5>
    <p>
     同一应用不同设备之间实现跨设备文件访问，只需要将对应的文件放在应用沙箱的分布式文件路径即可。
    </p>
    <h6>
     <a id="21_A_34">
     </a>
     2.1 设备A在分布式下创建文件：
    </h6>
    <pre><code class="prism language-javascript"><span class="token keyword">async</span> <span class="token function">createDistributedFile</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">uri</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> context <span class="token operator">=</span> <span class="token function">getContext</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token keyword">as</span> common<span class="token punctuation">.</span>UIAbilityContext<span class="token punctuation">;</span> 
    <span class="token keyword">let</span> <span class="token literal-property property">pathDir</span><span class="token operator">:</span> string <span class="token operator">=</span> context<span class="token punctuation">.</span>distributedFilesDir<span class="token punctuation">;</span>
    <span class="token comment">// 获取分布式目录的文件路径</span>
    <span class="token keyword">let</span> <span class="token literal-property property">filePath</span><span class="token operator">:</span> string <span class="token operator">=</span> pathDir <span class="token operator">+</span> <span class="token string">'/test.txt'</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 在分布式目录下创建文件</span>
      <span class="token keyword">let</span> file <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">openSync</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> fs<span class="token punctuation">.</span>OpenMode<span class="token punctuation">.</span><span class="token constant">READ_WRITE</span> <span class="token operator">|</span> fs<span class="token punctuation">.</span>OpenMode<span class="token punctuation">.</span><span class="token constant">CREATE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'Succeeded in createing.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 向文件中写入内容</span>
      fs<span class="token punctuation">.</span><span class="token function">writeSync</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>fd<span class="token punctuation">,</span> <span class="token string">'content'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 关闭文件</span>
      fs<span class="token punctuation">.</span><span class="token function">closeSync</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">let</span> <span class="token literal-property property">err</span><span class="token operator">:</span> BusinessError <span class="token operator">=</span> error <span class="token keyword">as</span> BusinessError<span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Failed to openSync / writeSync / closeSync. Code: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>err<span class="token punctuation">.</span>code<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, message: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>err<span class="token punctuation">.</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre>
    <h6>
     <a id="22_B_58">
     </a>
     2.2 设备B在分布式路径下读取文件，并保存到本地
    </h6>
    <pre><code class="prism language-javascript"><span class="token comment">/**
   * 拉起picker保存文件
   */</span>
  <span class="token keyword">async</span> <span class="token function">saveFile</span><span class="token punctuation">(</span>fileName<span class="token operator">:</span> string<span class="token punctuation">)</span><span class="token operator">:</span>Promise<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span><span class="token punctuation">{<!-- --></span>
    <span class="token comment">// fileName = this.tempFilePath;</span>
    PhLog<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'保存的文件名：'</span> <span class="token operator">+</span> fileName<span class="token punctuation">)</span>
    <span class="token keyword">let</span> saveFileUri <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">let</span> DocumentSaveOptions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">picker<span class="token punctuation">.</span>DocumentSaveOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      DocumentSaveOptions<span class="token punctuation">.</span>newFileNames <span class="token operator">=</span> <span class="token punctuation">[</span>fileName<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> documentPicker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">picker<span class="token punctuation">.</span>DocumentViewPicker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">await</span> documentPicker<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>DocumentSaveOptions<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token parameter">DocumentSaveResult</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        PhLog<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'DocumentViewPicker.save successfully, DocumentSaveResult uri: '</span> <span class="token operator">+</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>DocumentSaveResult<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>DocumentSaveResult <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> DocumentSaveResult <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">let</span> uri <span class="token operator">=</span> DocumentSaveResult<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">as</span> string<span class="token punctuation">;</span>
          PhLog<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'分布式'</span><span class="token punctuation">,</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">save file uri: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>uri<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>realFileUri <span class="token operator">=</span> uri
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">realSaveFile</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span>
          saveFileUri <span class="token operator">=</span> uri
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">err</span><span class="token operator">:</span> BusinessError</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        PhLog<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'saveFile-DocumentViewPicker.save failed with err: '</span> <span class="token operator">+</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      PhLog<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'saveFile-DocumentViewPicker failed with err: '</span> <span class="token operator">+</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> saveFileUri
  <span class="token punctuation">}</span>

  <span class="token literal-property property">realFileUri</span><span class="token operator">:</span> string <span class="token operator">=</span> <span class="token string">''</span>

  <span class="token comment">/**
   * 真正开始保存文件
   */</span>
  <span class="token keyword">async</span> <span class="token function">realSaveFile</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">fileName</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// let fileName = this.tempFilePath;</span>
    <span class="token keyword">let</span> context <span class="token operator">=</span> <span class="token function">getContext</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token keyword">as</span> common<span class="token punctuation">.</span>UIAbilityContext<span class="token punctuation">;</span> <span class="token comment">// 获取设备B的UIAbilityContext信息</span>
    <span class="token keyword">let</span> pathDir <span class="token operator">=</span> context<span class="token punctuation">.</span>distributedFilesDir<span class="token punctuation">;</span>
    <span class="token comment">// 获取分布式目录的文件路径</span>
    <span class="token keyword">let</span> filePath <span class="token operator">=</span> pathDir <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> fileName<span class="token punctuation">;</span>
    PhLog<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'保存文件时候读取的文件路径：'</span> <span class="token operator">+</span> filePath<span class="token punctuation">)</span>

    <span class="token comment">//开始写入内容</span>
    <span class="token keyword">let</span> <span class="token literal-property property">startSaveFileTask</span><span class="token operator">:</span> taskpool<span class="token punctuation">.</span>Task <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">taskpool<span class="token punctuation">.</span>Task</span><span class="token punctuation">(</span>startSaveFile3<span class="token punctuation">,</span> filePath<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">.</span>realFileUri<span class="token punctuation">)</span><span class="token punctuation">;</span>

    taskpool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>startSaveFileTask<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">writtenSize</span><span class="token operator">:</span> number</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>writtenSize <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'分布式'</span><span class="token punctuation">,</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">文件写入成功，写入大小: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>writtenSize<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 字节</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        promptAction<span class="token punctuation">.</span><span class="token function">showToast</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'文件保存成功'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'分布式'</span><span class="token punctuation">,</span><span class="token string">'文件写入失败'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">deleteDistributedFile</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>


@Concurrent
<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">startSaveFile3</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">filePath</span><span class="token operator">:</span> string<span class="token punctuation">,</span> <span class="token literal-property property">realFileUri</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span>number<span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 读取源文件</span>
    <span class="token keyword">const</span> sourceFile <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">openSync</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> fs<span class="token punctuation">.</span>OpenMode<span class="token punctuation">.</span><span class="token constant">READ_ONLY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> stats <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> fileSize <span class="token operator">=</span> stats<span class="token punctuation">.</span>size<span class="token punctuation">;</span>

    PhLog<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'分布式'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">保存的文件: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>filePath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> - 大小：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>fileSize<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 目标文件</span>
    <span class="token keyword">const</span> targetFile <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">openSync</span><span class="token punctuation">(</span>realFileUri<span class="token punctuation">,</span> fs<span class="token punctuation">.</span>OpenMode<span class="token punctuation">.</span><span class="token constant">WRITE_ONLY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 分片大小，可根据实际情况调整</span>
    <span class="token keyword">const</span> chunkSize <span class="token operator">=</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">;</span> <span class="token comment">// 1MB</span>
    <span class="token keyword">let</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> totalWritten <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>offset <span class="token operator">&lt;</span> fileSize<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">const</span> currentChunkSize <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>chunkSize<span class="token punctuation">,</span> fileSize <span class="token operator">-</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBuffer</span><span class="token punctuation">(</span>currentChunkSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
      PhLog<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'分布式'</span><span class="token punctuation">,</span><span class="token string">'01开始读取：'</span><span class="token operator">+</span>s<span class="token punctuation">)</span>
      <span class="token comment">// 读取当前分片的数据</span>
      <span class="token keyword">const</span> readLen <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readSync</span><span class="token punctuation">(</span>sourceFile<span class="token punctuation">.</span>fd<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> offset <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>readLen <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 写入当前分片的数据</span>
      <span class="token keyword">const</span> writeLen <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>targetFile<span class="token punctuation">.</span>fd<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> offset <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      totalWritten <span class="token operator">+=</span> writeLen<span class="token punctuation">;</span>
      offset <span class="token operator">+=</span> writeLen<span class="token punctuation">;</span>
      <span class="token comment">// 计算并调用进度回调</span>
      <span class="token keyword">const</span> progress <span class="token operator">=</span> <span class="token punctuation">(</span>totalWritten <span class="token operator">/</span> fileSize<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">;</span>
      PhLog<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'分布式'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">写入进度: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>progress<span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">%</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 关闭文件</span>
    fs<span class="token punctuation">.</span><span class="token function">closeSync</span><span class="token punctuation">(</span>sourceFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    fs<span class="token punctuation">.</span><span class="token function">closeSync</span><span class="token punctuation">(</span>targetFile<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> totalWritten<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    PhLog<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'分布式'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">保存文件时出错: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>error<span class="token punctuation">.</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h6>
     <a id="_165">
     </a>
     到这里就完成了分布式文件的访问、拷贝，整体流程就是：
    </h6>
    <ul>
     <li>
      A设备创建分布式文件，写入内容
     </li>
     <li>
      B设备从分布式文件系统目录上读取文件内容
     </li>
     <li>
      将文件保存到本地
     </li>
    </ul>
    <p>
     <strong>
      PS:操作文件时候注意添加相关权限
     </strong>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c:6f672e6373646e2e6e65742f7368616f646f6e67313132332f:61727469636c652f64657461696c732f313435393736363236" class_="artid" style="display:none">
 </p>
</div>


