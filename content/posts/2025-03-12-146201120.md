---
layout: post
title: "告别复杂日志解析-用bin2sql轻松实现MySQL数据闪回"
date: 2025-03-12 18:04:10 +0800
description: "此时： 通过命令可以看到所有产出的binlog日志：查看binlog内容按照时间读取按照点位读取。"
keywords: "告别复杂日志解析 用bin2sql轻松实现MySQL数据闪回"
categories: ['Mysql']
tags: ['数据库', 'Mysql']
artid: "146201120"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146201120
    alt: "告别复杂日志解析-用bin2sql轻松实现MySQL数据闪回"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146201120
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146201120
cover: https://bing.ee123.net/img/rand?artid=146201120
image: https://bing.ee123.net/img/rand?artid=146201120
img: https://bing.ee123.net/img/rand?artid=146201120
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     告别复杂日志解析 用bin2sql轻松实现MySQL数据闪回
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <h2>
     mysqlbinlog⼯具使用
    </h2>
    <pre><code class="hljs">use test;
CREATE TABLE `t1` (
    `id` INT(11) NOT NULL AUTO_INCREMENT,
    `name` VARCHAR(20) DEFAULT NULL,
    PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;


INSERT INTO t1(id, name) SELECT 101, 'tome101';
INSERT INTO t1(id, name) SELECT 102, 'tome102';
INSERT INTO t1(id, name) SELECT 103, 'tome103';
INSERT INTO t1(id, name) SELECT 104, 'tome104';
INSERT INTO t1(id, name) SELECT 105, 'tome105';
INSERT INTO t1(id, name) SELECT 106, 'tome106';
INSERT INTO t1(id, name) SELECT 107, 'tome107';
INSERT INTO t1(id, name) SELECT 108, 'tome108';


UPDATE t1 SET name = 'jack101' WHERE id = 101;
UPDATE t1 SET name = 'jack103' WHERE id = 103;
UPDATE t1 SET name = 'jack105' WHERE id = 105;

DELETE FROM t1 WHERE id = 102;
DELETE FROM t1 WHERE id = 104;
DELETE FROM t1 WHERE id = 106;</code></pre>
    <p>
     此时： 通过命令
    </p>
    <pre><code class="hljs">show binlog events in 'binlog.000009' \G</code></pre>
    <p>
     可以看到所有产出的binlog日志：
    </p>
    <p>
     <img alt="" height="709" src="https://i-blog.csdnimg.cn/direct/d259c57f05fb4e0b998065e4161845e8.png" width="686"/>
    </p>
    <p>
     查看binlog内容
    </p>
    <pre><code class="hljs">mysqlbinlog --no-defaults --database=test  --start-datetime='2025-3-12 1
 1:37:00'   mysql-bin.000009 | less
</code></pre>
    <p>
     按照时间读取
    </p>
    <pre><code class="hljs">mysqlbinlog --no-defaults --database=test --base64-output=decode-rows -v    
binlog.000009 --start-datetime='2025-3-12 22:45:00'   --stop-datetime='20
 25-3-12 23:45:00'| less

#加上--base64-output=decode-rows –v 选项解析
##base64-output，可以控制输出语句输出base64编码的BINLOG语句;decode-rows选项将把基于行的事件解码成一个SQL语句</code></pre>
    <p>
     按照点位读取
    </p>
    <pre><code class="hljs">mysqlbinlog --no-defaults --database=test --base64-output=decode-rows -v    
binlog.000009 --start-position=xxxxx   --stop-position=xxxx| less</code></pre>
    <h2 style="background-color:transparent">
     bin2sql⼯具恢复误删除数据
    </h2>
    <h4>
     创建用户并给权限，插入测试数据
    </h4>
    <pre><code class="hljs">create user 'dba'@'%'identified by 'mysql';
GRANT all ON *.* TO 'dba'@'%';
grant super on *.* to 'binlog2sql'@'%';
create table a1(id int,name varchar(10));
insert into a1 values (1,'a');</code></pre>
    <h4>
     安装必要的依赖包
    </h4>
    <pre><code class="hljs">yum -y install epel-release 

安装一个python3.8，这里我直接上传的软件包
1.上传软件包
2.
sudo yum groupinstall -y "Development Tools"
sudo yum install -y gcc gcc-c++ make zlib-devel bzip2 bzip2-devel readline-devel \
    sqlite sqlite-devel openssl-devel tk-devel libffi-devel xz-devel
3.
./configure --enable-optimizations
make -j$(nproc)
sudo make altinstall
</code></pre>
    <h4 style="background-color:transparent">
     安装bin2sql
    </h4>
    <pre><code class="hljs">git clone https://github.com/danfengcao/binlog2sql.git &amp;&amp; cd binlog2sql
pip install -r requirements.txt 
pip3 install  pymysql </code></pre>
    <p>
     说实话安装过程坑极多，给的安装教程又很简单
    </p>
    <p>
     官网给的安装教程：
     <img alt="" height="235" src="https://i-blog.csdnimg.cn/direct/1dafd4e18a5c434dbe316a879a498c11.png" width="1004">
      真心希望能改进一下文档。。。
     </img>
    </p>
    <h4>
     bin2sql 的使用：
    </h4>
    <h5>
     标准用法-解析出执行过的sql
    </h5>
    <pre><code class="hljs">python binlog2sql.py  -h127.0.0.1 -P3306  -udba -pmysql -dtest -ta1 --start-file='binlog.000001'</code></pre>
    <p>
     <img alt="" height="146" src="https://i-blog.csdnimg.cn/direct/1a65ebc705a54e1c9da072d10c25e48b.png" width="1219"/>
    </p>
    <h5>
     解析回滚SQL
    </h5>
    <pre><code class="hljs">python binlog2sql.py --flashback -h127.0.0.1 -P3306  -udba -pmysql -dtest -ta1 --start-file='binlog.000001'</code></pre>
    <p>
     <img alt="" height="207" src="https://i-blog.csdnimg.cn/direct/8325b34b0a05475188ce677faa03ddcf.png" width="1216"/>
    </p>
    <p>
     如上图，我执行了一条insert 语句 ，bin2sql 能解析出它的回滚语句是什么。
    </p>
    <h2>
     实战
     <strong>
      误删整张表数据，需要紧急回滚
     </strong>
    </h2>
    <p>
     <strong>
      表内容如下
     </strong>
    </p>
    <p>
     <img alt="" height="393" src="https://i-blog.csdnimg.cn/direct/5561d52e05304f5f9b067a138d5b62d0.png" width="774"/>
    </p>
    <p>
     <img alt="" height="84" src="https://i-blog.csdnimg.cn/direct/a0073aa9e1b64285893da434655d4530.png" width="501"/>
    </p>
    <h4>
     恢复步骤
    </h4>
    <p>
     1.登录mysql，查看目前的binlog文件
    </p>
    <p>
     <img alt="" height="190" src="https://i-blog.csdnimg.cn/direct/ce7ed12c315342b49fe3411c70adbe3d.png" width="840"/>
    </p>
    <p>
     2.最新的binlog文件是mysql-bin.000001，我们再定位误操作SQL的binlog位置。误操作人只能知道大致的误操作时间，我们根据大致时间过滤数据。
    </p>
    <pre><code class="hljs"> python binlog2sql.py  -h127.0.0.1 -P3306  -udba -pmysql -dtest -tt1 --start-file='binlog.000001' --start-datetime='2025-3-12 17:45:00' --stop-datetime='2025-3-12 17:50:00'</code></pre>
    <p>
     <img alt="" height="210" src="https://i-blog.csdnimg.cn/direct/041b9951d6a04eecacb31dbd444e3307.png" width="1219"/>
    </p>
    <p>
     如图，bin2sql 解析出了所有误操作删除的内容。
    </p>
    <pre><code class="hljs">python binlog2sql.py  -h127.0.0.1 -P3306  -udba -pmysql -dtest -tt1 --start-file='binlog.000001' --start-datetime='2025-3-12 17:45:00' --stop-datetime='2025-3-12 17:50:00' -B &gt;rollback.sql | cat</code></pre>
    <p>
     <img alt="" height="183" src="https://i-blog.csdnimg.cn/direct/ea78efa15dd347978d836e9d2b91e598.png" width="1194"/>
    </p>
    <p>
     执行sql 文件，数据恢复成功。
     <img alt="" height="630" src="https://i-blog.csdnimg.cn/direct/e6a9595b728d44cabecb3050c9a47c6a.png" width="764"/>
    </p>
    <p>
    </p>
    <h2>
     mysqlbinlog VS bin2sql
    </h2>
    <table border="1" cellpadding="1" cellspacing="1" style="width:500px">
     <tbody>
      <tr>
       <th>
        <strong>
         对比维度
        </strong>
       </th>
       <td>
        <strong>
         mysqlbinlog
        </strong>
        (MySQL 官方工具)
       </td>
       <td>
        <strong>
         bin2sql
        </strong>
        (第三方开源工具)
       </td>
      </tr>
      <tr>
       <td>
        <strong>
         核心功能
        </strong>
       </td>
       <td>
        解析二进制日志，生成原始 SQL 或回滚语句
       </td>
       <td>
        从二进制日志中解析出可读 SQL（正向/反向），支持事务拆分
       </td>
      </tr>
      <tr>
       <td>
        <strong>
         优势
        </strong>
       </td>
       <td>
        1.
        <strong>
         官方支持
        </strong>
        ，兼容性高
        <br/>
        2. 直接集成于 MySQL，无需安装
        <br/>
        3. 支持时间范围、数据库过滤等基础过滤
        <br/>
        4. 可生成回滚 SQL（需配合
        <code>
         -v
        </code>
        或第三方脚本）
       </td>
       <td>
        1.
        <strong>
         输出 SQL 可读性更好
        </strong>
        （直接展示 DML）
        <br/>
        2. 支持
        <strong>
         事务拆分
        </strong>
        ，精准定位操作
        <br/>
        3. 提供用户权限解析（可选）
        <br/>
        4. 支持生成反向 SQL（数据回滚）
        <br/>
        5. 部分工具提供 Web 界面（如 Binlog2SQL）
       </td>
      </tr>
      <tr>
       <td>
        <strong>
         劣势
        </strong>
       </td>
       <td>
        1. 输出结果含底层细节（如
        <code>
         @1=...
        </code>
        ），需手动处理可读性
        <br/>
        2.
        <strong>
         复杂事务解析困难
        </strong>
        （如大事务）
        <br/>
        3. 无原生用户权限信息解析
        <br/>
        4. 依赖命令行操作，对新手不友好
       </td>
       <td>
        1.
        <strong>
         依赖 Python 环境
        </strong>
        <br/>
        2. 处理超大 binlog 时性能较低
        <br/>
        3.
        <strong>
         功能局限
        </strong>
        （仅生成 SQL，无直接恢复功能）
        <br/>
        4. 社区支持弱于官方工具
        <br/>
        5. 部分场景需手动处理（如 DDL 语句）
       </td>
      </tr>
      <tr>
       <td>
        <strong>
         典型场景
        </strong>
       </td>
       <td>
        1. 快速查看 binlog 内容
        <br/>
        2. 结合脚本实现数据恢复
       </td>
       <td>
        1.
        <strong>
         误操作数据恢复
        </strong>
        （生成反向 SQL）
        <br/>
        2. 审计日志分析
       </td>
      </tr>
      <tr>
       <td>
        <strong>
         依赖环境
        </strong>
       </td>
       <td>
        仅需 MySQL 客户端
       </td>
       <td>
        需 Python 及依赖库（如
        <code>
         pymysql
        </code>
        ）
       </td>
      </tr>
      <tr>
       <td>
        <strong>
         输出灵活性
        </strong>
       </td>
       <td>
        支持原始 SQL、ROW 格式解析、时间过滤
       </td>
       <td>
        支持正向/反向 SQL、事务级过滤、表级过滤
       </td>
      </tr>
      <tr>
       <td>
        <strong>
         用户友好性
        </strong>
       </td>
       <td>
        低（需熟悉命令行参数）
       </td>
       <td>
        中（提供更直观的 SQL 输出和过滤选项）
       </td>
      </tr>
      <tr>
       <td>
        <strong>
         性能
        </strong>
       </td>
       <td>
        高（C++ 编写，原生工具）
       </td>
       <td>
        中低（Python 解析，大文件处理较慢）
       </td>
      </tr>
     </tbody>
    </table>
    <p>
    </p>
   </div>
  </div>
 </article>
 <p alt="68747470733a:2f2f626c6f672e6373646e2e6e65742f646e75696b696e672f:61727469636c652f64657461696c732f313436323031313230" class_="artid" style="display:none">
 </p>
</div>


