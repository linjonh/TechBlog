---
layout: post
title: "颠覆语言认知的革命神经概率语言模型如何突破人类思维边界"
date: 2025-03-10 20:39:50 +0800
description: "import torch.nn as nn # 导入神经网络模块# 定义神经概率语言模型（NPLM）self.C = nn.Embedding(voc_size, embedding_size) # 定义一个词嵌入层# 第一个线性层，其输入大小为 n_step * embedding_size，输出大小为 n_hidden# 第二个线性层，其输入大小为 n_hidden，输出大小为 voc_size，即词汇表大小def forward(self, X): # 定义前向传播过程。"
keywords: "颠覆语言认知的革命！神经概率语言模型如何突破人类思维边界？"
categories: ['机器学习', '大模型']
tags: ['语言模型', '自然语言处理', '人工智能']
artid: "146163545"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146163545
    alt: "颠覆语言认知的革命神经概率语言模型如何突破人类思维边界"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146163545
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146163545
cover: https://bing.ee123.net/img/rand?artid=146163545
image: https://bing.ee123.net/img/rand?artid=146163545
img: https://bing.ee123.net/img/rand?artid=146163545
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     颠覆语言认知的革命！神经概率语言模型如何突破人类思维边界？
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="_0">
     </a>
     颠覆语言认知的革命！神经概率语言模型如何突破人类思维边界？
    </h2>
    <h3>
     <a id="ngram_2">
     </a>
     一、传统模型的世纪困境：当n-gram遇上"月光族难题"
    </h3>
    <p>
     <strong>
      令人震惊的案例
     </strong>
     ：2012年Google语音识别系统将
    </p>
    <p>
     用户说：“我要还信用卡”
     <br/>
     系统识别：“我要环信用开”
    </p>
    <p>
     <strong>
      三大困境解析
     </strong>
     ：
    </p>
    <ol>
     <li>
      维度灾难：当n=3时，词表大小10万 → 需要存储10^15个组合
     </li>
     <li>
      数据稀疏："量子计算融资"在10亿语料库中出现0次
     </li>
     <li>
      长程依赖：无法捕捉"虽然…但是…"的超距离关联
     </li>
    </ol>
    <h3>
     <a id="NPLM_17">
     </a>
     二、神经概率语言模型：NPLM
    </h3>
    <p>
     NPLM的结构包括3个主要部分：输⼊层、隐藏层和输出层。
    </p>
    <p>
     输⼊层将词汇映射到连续的词向量空间，隐藏层通过⾮线性激活函数学习词与词之间的复杂关系，输出层通过softmax函数产⽣下⼀个单词的概率分布。
    </p>
    <p>
     <img alt="image-20250309184522370" src="https://i-blog.csdnimg.cn/img_convert/2b83035bf79099e9436a586dd0f4d063.png"/>
    </p>
    <p>
     <strong>
      数学之美
     </strong>
     ：
     <br/>
     <span class="katex--display">
      <span class="katex-display">
       <span class="katex">
        <span class="katex-mathml">
         P 
         
        
          ( 
         
        
          w 
         
        
          t 
         
        
          ∣ 
         
        
          w 
         
        
          t 
         
        
          − 
         
        
          1 
         
        
          , 
         
        
          . 
         
        
          . 
         
        
          . 
         
        
          , 
         
        
          w 
         
        
          t 
         
        
          − 
         
        
          n 
         
        
          + 
         
        
          1 
         
        
          ) 
         
        
          = 
         
        
          s 
         
        
          o 
         
        
          f 
         
        
          t 
         
        
          m 
         
        
          a 
         
        
          x 
         
        
          ( 
         
        
          C 
         
        
          ⋅ 
         
        
          t 
         
        
          a 
         
        
          n 
         
        
          h 
         
        
          ⁡ 
         
        
          ( 
         
        
          W 
         
        
          x 
         
        
          + 
         
        
          b 
         
        
          ) 
         
        
          ) 
         
        
          P 
         
        
          ( 
         
         
         
           w 
          
         
           t 
          
         
        
          ∣ 
         
         
         
           w 
          
          
          
            t 
           
          
            − 
           
          
            1 
           
          
         
        
          , 
         
        
          . 
         
        
          . 
         
        
          . 
         
        
          , 
         
         
         
           w 
          
          
          
            t 
           
          
            − 
           
          
            n 
           
          
            + 
           
          
            1 
           
          
         
        
          ) 
         
        
          = 
         
        
          softmax 
         
        
          ( 
         
        
          C 
         
        
          ⋅ 
         
        
          tanh 
         
        
          ⁡ 
         
        
          ( 
         
        
          W 
         
        
          x 
         
        
          + 
         
        
          b 
         
        
          ) 
         
        
          ) 
         
        
       
         P(wt∣wt−1,...,wt−n+1)=softmax(C⋅tanh⁡(Wx+b))P(w_t|w_{t-1},...,w_{t-n+1}) = \text{softmax}(C \cdot \tanh(Wx + b))
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 1em; vertical-align: -0.25em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.1389em;">
           P
          </span>
          <span class="mopen">
           (
          </span>
          <span class="mord mathnormal">
           wt
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           ∣
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 0.6984em; vertical-align: -0.0833em;">
          </span>
          <span class="mord mathnormal">
           wt
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
          <span class="mbin">
           −
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 0.8389em; vertical-align: -0.1944em;">
          </span>
          <span class="mord">
           1
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord">
           ...
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord mathnormal">
           wt
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
          <span class="mbin">
           −
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 0.6667em; vertical-align: -0.0833em;">
          </span>
          <span class="mord mathnormal">
           n
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
          <span class="mbin">
           +
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 1em; vertical-align: -0.25em;">
          </span>
          <span class="mord">
           1
          </span>
          <span class="mclose">
           )
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           =
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 1em; vertical-align: -0.25em;">
          </span>
          <span class="mord mathnormal">
           so
          </span>
          <span class="mord mathnormal" style="margin-right: 0.1076em;">
           f
          </span>
          <span class="mord mathnormal">
           t
          </span>
          <span class="mord mathnormal">
           ma
          </span>
          <span class="mord mathnormal">
           x
          </span>
          <span class="mopen">
           (
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0715em;">
           C
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
          <span class="mbin">
           ⋅
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 1em; vertical-align: -0.25em;">
          </span>
          <span class="mord mathnormal">
           t
          </span>
          <span class="mord mathnormal">
           anh
          </span>
          <span class="mord">
           ⁡
          </span>
          <span class="mopen">
           (
          </span>
          <span class="mord mathnormal" style="margin-right: 0.1389em;">
           W
          </span>
          <span class="mord mathnormal">
           x
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
          <span class="mbin">
           +
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 1em; vertical-align: -0.25em;">
          </span>
          <span class="mord mathnormal">
           b
          </span>
          <span class="mclose">
           ))
          </span>
          <span class="mord mathnormal" style="margin-right: 0.1389em;">
           P
          </span>
          <span class="mopen">
           (
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.0269em;">
            w
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.2806em;">
               <span class="" style="top: -2.55em; margin-left: -0.0269em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight">
                  t
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mord">
           ∣
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.0269em;">
            w
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3011em;">
               <span class="" style="top: -2.55em; margin-left: -0.0269em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mathnormal mtight">
                   t
                  </span>
                  <span class="mbin mtight">
                   −
                  </span>
                  <span class="mord mtight">
                   1
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.2083em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord">
           ...
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.0269em;">
            w
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3011em;">
               <span class="" style="top: -2.55em; margin-left: -0.0269em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mathnormal mtight">
                   t
                  </span>
                  <span class="mbin mtight">
                   −
                  </span>
                  <span class="mord mathnormal mtight">
                   n
                  </span>
                  <span class="mbin mtight">
                   +
                  </span>
                  <span class="mord mtight">
                   1
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.2083em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mclose">
           )
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           =
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 1em; vertical-align: -0.25em;">
          </span>
          <span class="mord text">
           <span class="mord">
            softmax
           </span>
          </span>
          <span class="mopen">
           (
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0715em;">
           C
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
          <span class="mbin">
           ⋅
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 1em; vertical-align: -0.25em;">
          </span>
          <span class="mop">
           tanh
          </span>
          <span class="mopen">
           (
          </span>
          <span class="mord mathnormal" style="margin-right: 0.1389em;">
           W
          </span>
          <span class="mord mathnormal">
           x
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
          <span class="mbin">
           +
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 1em; vertical-align: -0.25em;">
          </span>
          <span class="mord mathnormal">
           b
          </span>
          <span class="mclose">
           ))
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     <br/>
     其中：
    </p>
    <ul>
     <li>
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         C 
         
        
       
         C
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.6833em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0715em;">
           C
          </span>
         </span>
        </span>
       </span>
      </span>
      ：词向量到输出的连接矩阵
     </li>
     <li>
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         W 
         
        
       
         W
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.6833em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.1389em;">
           W
          </span>
         </span>
        </span>
       </span>
      </span>
      ：上下文词向量组合矩阵
     </li>
     <li>
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         x 
         
        
       
         x
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.4306em;">
          </span>
          <span class="mord mathnormal">
           x
          </span>
         </span>
        </span>
       </span>
      </span>
      ：上下文词向量拼接
     </li>
    </ul>
    <h4>
     <a id="21_NPLM_39">
     </a>
     2.1 NPLM的实现
    </h4>
    <p>
     <img alt="image-20250309184711801" src="https://i-blog.csdnimg.cn/img_convert/4aaf0b05ab8321d7e28efc3508d94a34.png"/>
    </p>
    <h5>
     <a id="211__45">
     </a>
     2.1.1 建立语料库
    </h5>
    <pre><code class="prism language-py"><span class="token comment"># 构建一个非常简单的数据集</span>
sentences <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"我 喜欢 玩具"</span><span class="token punctuation">,</span> <span class="token string">"我 爱 爸爸"</span><span class="token punctuation">,</span> <span class="token string">"我 讨厌 挨打"</span><span class="token punctuation">]</span> 
<span class="token comment"># 将所有句子连接在一起，用空格分隔成多个词，再将重复的词去除，构建词汇表</span>
word_list <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>sentences<span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
<span class="token comment"># 创建一个字典，将每个词映射到一个唯一的索引</span>
word_to_idx <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>word<span class="token punctuation">:</span> idx <span class="token keyword">for</span> idx<span class="token punctuation">,</span> word <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>word_list<span class="token punctuation">)</span><span class="token punctuation">}</span> 
<span class="token comment"># 创建一个字典，将每个索引映射到对应的词</span>
idx_to_word <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>idx<span class="token punctuation">:</span> word <span class="token keyword">for</span> idx<span class="token punctuation">,</span> word <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>word_list<span class="token punctuation">)</span><span class="token punctuation">}</span> 
voc_size <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>word_list<span class="token punctuation">)</span> <span class="token comment"># 计算词汇表的大小</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">' 词汇表：'</span><span class="token punctuation">,</span> word_to_idx<span class="token punctuation">)</span> <span class="token comment"># 打印词汇到索引的映射字典</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">' 词汇表大小：'</span><span class="token punctuation">,</span> voc_size<span class="token punctuation">)</span> <span class="token comment"># 打印词汇表大小</span>
</code></pre>
    <pre><code class="prism language-markdown"> 词汇表： {'爸爸': 0, '讨厌': 1, '我': 2, '玩具': 3, '爱': 4, '喜欢': 5, '挨打': 6}
 词汇表大小： 7
</code></pre>
    <h5>
     <a id="212_NPLM_70">
     </a>
     2.1.2 生成NPLM训练数据
    </h5>
    <pre><code class="prism language-py"><span class="token comment"># 构建批处理数据</span>
<span class="token keyword">import</span> torch <span class="token comment"># 导入 PyTorch 库</span>
<span class="token keyword">import</span> random <span class="token comment"># 导入 random 库</span>
batch_size <span class="token operator">=</span> <span class="token number">2</span> <span class="token comment"># 每批数据的大小</span>
<span class="token keyword">def</span> <span class="token function">make_batch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    input_batch <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># 定义输入批处理列表</span>
    target_batch <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># 定义目标批处理列表</span>
    selected_sentences <span class="token operator">=</span> random<span class="token punctuation">.</span>sample<span class="token punctuation">(</span>sentences<span class="token punctuation">,</span> batch_size<span class="token punctuation">)</span> <span class="token comment"># 随机选择句子</span>
    <span class="token keyword">for</span> sen <span class="token keyword">in</span> selected_sentences<span class="token punctuation">:</span>  <span class="token comment"># 遍历每个句子</span>
        word <span class="token operator">=</span> sen<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 用空格将句子分隔成多个词</span>
        <span class="token comment"># 将除最后一个词以外的所有词的索引作为输入</span>
        <span class="token builtin">input</span> <span class="token operator">=</span> <span class="token punctuation">[</span>word_to_idx<span class="token punctuation">[</span>n<span class="token punctuation">]</span> <span class="token keyword">for</span> n <span class="token keyword">in</span> word<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token comment"># 创建输入数据</span>
        <span class="token comment"># 将最后一个词的索引作为目标</span>
        target <span class="token operator">=</span> word_to_idx<span class="token punctuation">[</span>word<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token comment"># 创建目标数据</span>
        input_batch<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">)</span>  <span class="token comment"># 将输入添加到输入批处理列表</span>
        target_batch<span class="token punctuation">.</span>append<span class="token punctuation">(</span>target<span class="token punctuation">)</span>  <span class="token comment"># 将目标添加到目标批处理列表</span>
    input_batch <span class="token operator">=</span> torch<span class="token punctuation">.</span>LongTensor<span class="token punctuation">(</span>input_batch<span class="token punctuation">)</span> <span class="token comment"># 将输入数据转换为张量</span>
    target_batch <span class="token operator">=</span> torch<span class="token punctuation">.</span>LongTensor<span class="token punctuation">(</span>target_batch<span class="token punctuation">)</span> <span class="token comment"># 将目标数据转换为张量</span>
    <span class="token keyword">return</span> input_batch<span class="token punctuation">,</span> target_batch  <span class="token comment"># 返回输入批处理和目标批处理数据</span>
input_batch<span class="token punctuation">,</span> target_batch <span class="token operator">=</span> make_batch<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 生成批处理数据</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">" 输入批处理数据："</span><span class="token punctuation">,</span>input_batch<span class="token punctuation">)</span>  <span class="token comment"># 打印输入批处理数据</span>
<span class="token comment"># 将输入批处理数据中的每个索引值转换为对应的原始词</span>
input_words <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> input_idx <span class="token keyword">in</span> input_batch<span class="token punctuation">:</span>
    input_words<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">[</span>idx_to_word<span class="token punctuation">[</span>idx<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token keyword">for</span> idx <span class="token keyword">in</span> input_idx<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">" 输入批处理数据对应的原始词："</span><span class="token punctuation">,</span>input_words<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">" 目标批处理数据："</span><span class="token punctuation">,</span>target_batch<span class="token punctuation">)</span> <span class="token comment"># 打印目标批处理数据</span>
<span class="token comment"># 将目标批处理数据中的每个索引值转换为对应的原始词</span>
target_words <span class="token operator">=</span> <span class="token punctuation">[</span>idx_to_word<span class="token punctuation">[</span>idx<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token keyword">for</span> idx <span class="token keyword">in</span> target_batch<span class="token punctuation">]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">" 目标批处理数据对应的原始词："</span><span class="token punctuation">,</span>target_words<span class="token punctuation">)</span>
</code></pre>
    <pre><code class="prism language-python"> 输入批处理数据： tensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
 输入批处理数据对应的原始词： <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'我'</span><span class="token punctuation">,</span> <span class="token string">'讨厌'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'我'</span><span class="token punctuation">,</span> <span class="token string">'爱'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
 目标批处理数据： tensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
 目标批处理数据对应的原始词： <span class="token punctuation">[</span><span class="token string">'挨打'</span><span class="token punctuation">,</span> <span class="token string">'爸爸'</span><span class="token punctuation">]</span>
</code></pre>
    <p>
     <code>
      batch_size = 2 # 每批数据的大小
     </code>
    </p>
    <p>
     <img alt="image-20250310194259986" src="https://i-blog.csdnimg.cn/img_convert/4ff5042a1ae6436aeb40ef1319d59f6d.png"/>
    </p>
    <p>
     即为整理好数据集，及其对应的结果，接下来只等构建网络和训练
    </p>
    <h5>
     <a id="213_NPLM_120">
     </a>
     2.1.3 定义NPLM
    </h5>
    <pre><code class="prism language-py"><span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn <span class="token comment"># 导入神经网络模块</span>
<span class="token comment"># 定义神经概率语言模型（NPLM）</span>
<span class="token keyword">class</span> <span class="token class-name">NPLM</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>NPLM<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span> 
        self<span class="token punctuation">.</span>C <span class="token operator">=</span> nn<span class="token punctuation">.</span>Embedding<span class="token punctuation">(</span>voc_size<span class="token punctuation">,</span> embedding_size<span class="token punctuation">)</span> <span class="token comment"># 定义一个词嵌入层</span>
        <span class="token comment"># 第一个线性层，其输入大小为 n_step * embedding_size，输出大小为 n_hidden</span>
        self<span class="token punctuation">.</span>linear1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>n_step <span class="token operator">*</span> embedding_size<span class="token punctuation">,</span> n_hidden<span class="token punctuation">)</span> 
        <span class="token comment"># 第二个线性层，其输入大小为 n_hidden，输出大小为 voc_size，即词汇表大小</span>
        self<span class="token punctuation">.</span>linear2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>n_hidden<span class="token punctuation">,</span> voc_size<span class="token punctuation">)</span> 
    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> X<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 定义前向传播过程</span>
        <span class="token comment"># 输入数据 X 张量的形状为 [batch_size, n_step]</span>
        X <span class="token operator">=</span> self<span class="token punctuation">.</span>C<span class="token punctuation">(</span>X<span class="token punctuation">)</span>  <span class="token comment"># 将 X 通过词嵌入层，形状变为 [batch_size, n_step, embedding_size]        </span>
        X <span class="token operator">=</span> X<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> n_step <span class="token operator">*</span> embedding_size<span class="token punctuation">)</span> <span class="token comment"># 形状变为 [batch_size, n_step * embedding_size]</span>
        <span class="token comment"># 通过第一个线性层并应用 ReLU 激活函数</span>
        hidden <span class="token operator">=</span> torch<span class="token punctuation">.</span>tanh<span class="token punctuation">(</span>self<span class="token punctuation">.</span>linear1<span class="token punctuation">(</span>X<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># hidden 张量形状为 [batch_size, n_hidden]</span>
        <span class="token comment"># 通过第二个线性层得到输出 </span>
        output <span class="token operator">=</span> self<span class="token punctuation">.</span>linear2<span class="token punctuation">(</span>hidden<span class="token punctuation">)</span> <span class="token comment"># output 形状为 [batch_size, voc_size]</span>
        <span class="token keyword">return</span> output <span class="token comment"># 返回输出结果</span>
</code></pre>
    <p>
     <img alt="image-20250310194659088" src="https://i-blog.csdnimg.cn/img_convert/56fdeed4a87213a32b6bb9690bc35dc2.png"/>
    </p>
    <p>
     进一部的说明我们结合以下代码
    </p>
    <h5>
     <a id="214_NPLM_150">
     </a>
     2.1.4 实例化NPLM
    </h5>
    <pre><code class="prism language-py">n_step <span class="token operator">=</span> <span class="token number">2</span> <span class="token comment"># 时间步数，表示每个输入序列的长度，也就是上下文长度 </span>
n_hidden <span class="token operator">=</span> <span class="token number">2</span> <span class="token comment"># 隐藏层大小</span>
embedding_size <span class="token operator">=</span> <span class="token number">2</span> <span class="token comment"># 词嵌入大小</span>
model <span class="token operator">=</span> NPLM<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 创建神经概率语言模型实例</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">' NPLM 模型结构：'</span><span class="token punctuation">,</span> model<span class="token punctuation">)</span> <span class="token comment"># 打印模型的结构</span>
</code></pre>
    <p>
     <strong>
      输入数据
     </strong>
     ：
     <code>
      [[1,3], [1,6]]
     </code>
     （对应句子片段[“我 爱”, “我 讨厌”]）
    </p>
    <p>
     <strong>
      处理流程
     </strong>
     ：
    </p>
    <ol>
     <li>
      嵌入层转为形状
      <code>
       [2,2,2]
      </code>
      的张量
     </li>
     <li>
      展平为
      <code>
       [2,4]
      </code>
     </li>
     <li>
      第一线性层压缩到
      <code>
       [2,2]
      </code>
     </li>
     <li>
      第二线性层扩展到
      <code>
       [2,7]
      </code>
      （每个样本对应7个词的概率）
     </li>
    </ol>
    <p>
     <img alt="image-20250310195024069" src="https://i-blog.csdnimg.cn/img_convert/7753a34f05f24fb06ec9568d3e35f167.png"/>
    </p>
    <h5>
     <a id="215_NPLM_173">
     </a>
     2.1.5 训练NPLM
    </h5>
    <pre><code class="prism language-py"><span class="token keyword">import</span> torch<span class="token punctuation">.</span>optim <span class="token keyword">as</span> optim <span class="token comment"># 导入优化器模块</span>
criterion <span class="token operator">=</span> nn<span class="token punctuation">.</span>CrossEntropyLoss<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 定义损失函数为交叉熵损失</span>
optimizer <span class="token operator">=</span> optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span> <span class="token comment"># 定义优化器为 Adam，学习率为 0.1</span>
<span class="token comment"># 训练模型</span>
<span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># 设置训练迭代次数</span>
   optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 清除优化器的梯度</span>
   input_batch<span class="token punctuation">,</span> target_batch <span class="token operator">=</span> make_batch<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 创建输入和目标批处理数据</span>
   output <span class="token operator">=</span> model<span class="token punctuation">(</span>input_batch<span class="token punctuation">)</span> <span class="token comment"># 将输入数据传入模型，得到输出结果</span>
   loss <span class="token operator">=</span> criterion<span class="token punctuation">(</span>output<span class="token punctuation">,</span> target_batch<span class="token punctuation">)</span> <span class="token comment"># 计算损失值</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>epoch <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">1000</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span> <span class="token comment"># 每 1000 次迭代，打印损失值</span>
     <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Epoch:'</span><span class="token punctuation">,</span> <span class="token string">'%04d'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>epoch <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'cost ='</span><span class="token punctuation">,</span> <span class="token string">'{:.6f}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>loss<span class="token punctuation">)</span><span class="token punctuation">)</span>
   loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 反向传播计算梯度</span>
   optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 更新模型参数</span>
</code></pre>
    <p>
     是不是中一段训练的设定看着挺抽象，接下来举一个简单的栗子：
    </p>
    <pre><code class="prism language-py"><span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>          <span class="token comment"># 清空炒锅残留（重置梯度）</span>
    input_batch<span class="token punctuation">,</span> target <span class="token operator">=</span> make_batch<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 随机选菜谱（数据采样）</span>
    output <span class="token operator">=</span> model<span class="token punctuation">(</span>input_batch<span class="token punctuation">)</span>    <span class="token comment"># 学生试做菜品（前向传播）</span>
    loss <span class="token operator">=</span> criterion<span class="token punctuation">(</span>output<span class="token punctuation">,</span> target<span class="token punctuation">)</span> <span class="token comment"># 老师试吃评分（计算损失）</span>
    loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token comment"># 分析哪里做错了（反向传播）</span>
    optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>               <span class="token comment"># 根据建议改进（参数更新）</span>

</code></pre>
    <img alt="image-20250310195240344" src="https://i-blog.csdnimg.cn/img_convert/a6d0ccdd38c0525685fb5757ae395fa6.png">
     <h5>
      <a id="216_NPLM_212">
      </a>
      2.1.6 用NPLM预测新词
     </h5>
     <pre><code class="prism language-py"><span class="token comment"># 进行预测</span>
input_strs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'我'</span><span class="token punctuation">,</span> <span class="token string">'讨厌'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'我'</span><span class="token punctuation">,</span> <span class="token string">'喜欢'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token comment"># 需要预测的输入序列</span>
<span class="token comment"># 将输入序列转换为对应的索引</span>
input_indices <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>word_to_idx<span class="token punctuation">[</span>word<span class="token punctuation">]</span> <span class="token keyword">for</span> word <span class="token keyword">in</span> seq<span class="token punctuation">]</span> <span class="token keyword">for</span> seq <span class="token keyword">in</span> input_strs<span class="token punctuation">]</span>
<span class="token comment"># 将输入序列的索引转换为张量</span>
input_batch <span class="token operator">=</span> torch<span class="token punctuation">.</span>LongTensor<span class="token punctuation">(</span>input_indices<span class="token punctuation">)</span> 
<span class="token comment"># 对输入序列进行预测，取输出中概率最大的类别</span>
predict <span class="token operator">=</span> model<span class="token punctuation">(</span>input_batch<span class="token punctuation">)</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>  
<span class="token comment"># 将预测结果的索引转换为对应的词</span>
predict_strs <span class="token operator">=</span> <span class="token punctuation">[</span>idx_to_word<span class="token punctuation">[</span>n<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token keyword">for</span> n <span class="token keyword">in</span> predict<span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>  
<span class="token keyword">for</span> input_seq<span class="token punctuation">,</span> pred <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>input_strs<span class="token punctuation">,</span> predict_strs<span class="token punctuation">)</span><span class="token punctuation">:</span>
   <span class="token keyword">print</span><span class="token punctuation">(</span>input_seq<span class="token punctuation">,</span> <span class="token string">'-&gt;'</span><span class="token punctuation">,</span> pred<span class="token punctuation">)</span>  <span class="token comment"># 打印输入序列和预测结果</span>
</code></pre>
     <pre><code class="prism language-markdown">['我', '讨厌'] -&gt; 挨打

['我', '喜欢'] -&gt; 玩具
</code></pre>
     <p>
      <img alt="image-20250310195543613" src="https://i-blog.csdnimg.cn/img_convert/c4e12e65e95524090e5cfbff157556ca.png"/>
     </p>
     <h4>
      <a id="22__237">
      </a>
      2.2 完整手撕
     </h4>
     <p>
      最开始的学习中容易对NPLM建立中纬度的变化中产生疑惑，接下来进行具体得分析。
     </p>
     <p>
      <img alt="image-20250310195740161" src="https://i-blog.csdnimg.cn/img_convert/10fddc32eb41e345bbb6deca7930c72c.png"/>
     </p>
     <p>
      其结构可以拆分为一个三明治结构
     </p>
     <pre><code class="prism language-markdown">输入词索引 → 嵌入层 → 全连接层1+激活 → 全连接层2 → 词汇概率分布
</code></pre>
     <p>
      让我们用具体数值示例（假设参数如下）逐步解析：
     </p>
     <pre><code class="prism language-python">voc_size <span class="token operator">=</span> <span class="token number">7</span>        <span class="token comment"># 词汇表大小（示例数据实际值）</span>
n_step <span class="token operator">=</span> <span class="token number">2</span>          <span class="token comment"># 用前2个词预测第3个词</span>
embedding_size <span class="token operator">=</span> <span class="token number">2</span>  <span class="token comment"># 词向量维度（示例设定）</span>
n_hidden <span class="token operator">=</span> <span class="token number">2</span>        <span class="token comment"># 隐藏层维度（示例设定）</span>
</code></pre>
     <hr/>
     <h5>
      <a id="221__260">
      </a>
      2.2.1 输入数据示例
     </h5>
     <p>
      假设输入批处理数据为：
     </p>
     <pre><code class="prism language-python">input_batch <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token comment"># 对应句子片段："我 爱"、"我 讨厌"</span>
<span class="token comment"># 转换为张量后形状：[batch_size=2, n_step=2]</span>
</code></pre>
     <hr/>
     <h4>
      <a id="222__269">
      </a>
      2.2.2 前向传播逐层分解
     </h4>
     <h5>
      <a id="1_Embedding_Layer_271">
      </a>
      <strong>
       1. 嵌入层（Embedding Layer）
      </strong>
     </h5>
     <pre><code class="prism language-python">self<span class="token punctuation">.</span>C <span class="token operator">=</span> nn<span class="token punctuation">.</span>Embedding<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment"># 参数：7词→2维向量</span>
X <span class="token operator">=</span> self<span class="token punctuation">.</span>C<span class="token punctuation">(</span>input_batch<span class="token punctuation">)</span>      <span class="token comment"># 输入：[2,2] → 输出：[2,2,2]</span>
</code></pre>
     <p>
      相当于把索引中的七个词转化为二维的向量，转化过程如下
     </p>
     <p>
      <strong>
       计算过程
      </strong>
      ：
     </p>
     <ul>
      <li>
       每个词索引查表获取对应向量
      </li>
     </ul>
     <pre><code class="prism language-python"><span class="token comment"># 假设嵌入矩阵（随机初始化示例）：</span>
<span class="token punctuation">[</span>
 <span class="token punctuation">[</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># 索引0：'挨打'</span>
 <span class="token punctuation">[</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">0.4</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># 索引1：'我'</span>
 <span class="token punctuation">[</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.6</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># 索引2：'爸爸' </span>
 <span class="token punctuation">[</span><span class="token number">0.7</span><span class="token punctuation">,</span> <span class="token number">0.8</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># 索引3：'爱'</span>
 <span class="token punctuation">[</span><span class="token number">0.9</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># 索引4：'喜欢'</span>
 <span class="token punctuation">[</span><span class="token number">1.1</span><span class="token punctuation">,</span> <span class="token number">1.2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># 索引5：'玩具'</span>
 <span class="token punctuation">[</span><span class="token number">1.3</span><span class="token punctuation">,</span> <span class="token number">1.4</span><span class="token punctuation">]</span>   <span class="token comment"># 索引6：'讨厌'</span>
<span class="token punctuation">]</span>

<span class="token comment"># 输入[[1,3], [1,6]]的嵌入结果：</span>
<span class="token punctuation">[</span>
 <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0.3</span><span class="token punctuation">,</span><span class="token number">0.4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0.7</span><span class="token punctuation">,</span><span class="token number">0.8</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># "我 爱"</span>
 <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0.3</span><span class="token punctuation">,</span><span class="token number">0.4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1.3</span><span class="token punctuation">,</span><span class="token number">1.4</span><span class="token punctuation">]</span><span class="token punctuation">]</span>   <span class="token comment"># "我 讨厌"</span>
<span class="token punctuation">]</span>
</code></pre>
     <p>
      <strong>
       数学本质
      </strong>
      ：
      <br/>
      将离散的词索引映射为连续可训练的向量空间中的点，公式：
      <br/>
      <span class="katex--display">
       <span class="katex-display">
        <span class="katex">
         <span class="katex-mathml">
          E 
         
        
          = 
         
        
          EmbeddingLookup 
         
        
          ( 
         
        
          X 
         
        
          ) 
         
        
       
         \mathbf{E} = \text{EmbeddingLookup}(\mathbf{X})
         </span>
         <span class="katex-html">
          <span class="base">
           <span class="strut" style="height: 0.6861em;">
           </span>
           <span class="mord mathbf">
            E
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
           <span class="mrel">
            =
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 1em; vertical-align: -0.25em;">
           </span>
           <span class="mord text">
            <span class="mord">
             EmbeddingLookup
            </span>
           </span>
           <span class="mopen">
            (
           </span>
           <span class="mord mathbf">
            X
           </span>
           <span class="mclose">
            )
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      <br/>
      其中
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         X 
        
       
         ∈ 
        
        
        
          Z 
         
         
         
           b 
          
         
           a 
          
         
           t 
          
         
           c 
          
         
           h 
          
         
           × 
          
         
           n 
          
         
           _ 
          
         
           s 
          
         
           t 
          
         
           e 
          
         
           p 
          
         
        
       
      
        \mathbf{X} \in \mathbb{Z}^{batch×n\_step}
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.7252em; vertical-align: -0.0391em;">
          </span>
          <span class="mord mathbf">
           X
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           ∈
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 0.8491em;">
          </span>
          <span class="mord">
           <span class="mord mathbb">
            Z
           </span>
           <span class="msupsub">
            <span class="vlist-t">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.8491em;">
               <span class="" style="top: -3.063em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mathnormal mtight">
                   ba
                  </span>
                  <span class="mord mathnormal mtight">
                   t
                  </span>
                  <span class="mord mathnormal mtight">
                   c
                  </span>
                  <span class="mord mathnormal mtight">
                   h
                  </span>
                  <span class="mbin mtight">
                   ×
                  </span>
                  <span class="mord mathnormal mtight">
                   n
                  </span>
                  <span class="mord mtight" style="margin-right: 0.0278em;">
                   _
                  </span>
                  <span class="mord mathnormal mtight">
                   s
                  </span>
                  <span class="mord mathnormal mtight">
                   t
                  </span>
                  <span class="mord mathnormal mtight">
                   e
                  </span>
                  <span class="mord mathnormal mtight">
                   p
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      ,
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         E 
        
       
         ∈ 
        
        
        
          R 
         
         
         
           b 
          
         
           a 
          
         
           t 
          
         
           c 
          
         
           h 
          
         
           × 
          
         
           n 
          
         
           _ 
          
         
           s 
          
         
           t 
          
         
           e 
          
         
           p 
          
         
           × 
          
         
           e 
          
         
           m 
          
         
           b 
          
         
           e 
          
         
           d 
          
         
           d 
          
         
           i 
          
         
           n 
          
         
           g 
          
         
           _ 
          
         
           s 
          
         
           i 
          
         
           z 
          
         
           e 
          
         
        
       
      
        \mathbf{E} \in \mathbb{R}^{batch×n\_step×embedding\_size}
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.7252em; vertical-align: -0.0391em;">
          </span>
          <span class="mord mathbf">
           E
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           ∈
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 0.8491em;">
          </span>
          <span class="mord">
           <span class="mord mathbb">
            R
           </span>
           <span class="msupsub">
            <span class="vlist-t">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.8491em;">
               <span class="" style="top: -3.063em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mathnormal mtight">
                   ba
                  </span>
                  <span class="mord mathnormal mtight">
                   t
                  </span>
                  <span class="mord mathnormal mtight">
                   c
                  </span>
                  <span class="mord mathnormal mtight">
                   h
                  </span>
                  <span class="mbin mtight">
                   ×
                  </span>
                  <span class="mord mathnormal mtight">
                   n
                  </span>
                  <span class="mord mtight" style="margin-right: 0.0278em;">
                   _
                  </span>
                  <span class="mord mathnormal mtight">
                   s
                  </span>
                  <span class="mord mathnormal mtight">
                   t
                  </span>
                  <span class="mord mathnormal mtight">
                   e
                  </span>
                  <span class="mord mathnormal mtight">
                   p
                  </span>
                  <span class="mbin mtight">
                   ×
                  </span>
                  <span class="mord mathnormal mtight">
                   e
                  </span>
                  <span class="mord mathnormal mtight">
                   mb
                  </span>
                  <span class="mord mathnormal mtight">
                   e
                  </span>
                  <span class="mord mathnormal mtight">
                   dd
                  </span>
                  <span class="mord mathnormal mtight">
                   in
                  </span>
                  <span class="mord mathnormal mtight" style="margin-right: 0.0359em;">
                   g
                  </span>
                  <span class="mord mtight" style="margin-right: 0.0278em;">
                   _
                  </span>
                  <span class="mord mathnormal mtight">
                   s
                  </span>
                  <span class="mord mathnormal mtight">
                   i
                  </span>
                  <span class="mord mathnormal mtight">
                   ze
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </p>
     <hr/>
     <h5>
      <a id="2_Flatten_308">
      </a>
      <strong>
       2. 特征拼接（Flatten）
      </strong>
     </h5>
     <pre><code class="prism language-python">X <span class="token operator">=</span> X<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> n_step<span class="token operator">*</span>embedding_size<span class="token punctuation">)</span>  <span class="token comment"># [2,2,2] → [2,4]</span>
</code></pre>
     <p>
      <strong>
       具体变换
      </strong>
      ：
     </p>
     <pre><code class="prism language-python"><span class="token comment"># 第一个样本："我 爱"  </span>
原始嵌入 → <span class="token punctuation">[</span><span class="token number">0.3</span><span class="token punctuation">,</span><span class="token number">0.4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0.7</span><span class="token punctuation">,</span><span class="token number">0.8</span><span class="token punctuation">]</span>  
拼接后 → <span class="token punctuation">[</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token number">0.7</span><span class="token punctuation">,</span> <span class="token number">0.8</span><span class="token punctuation">]</span>

<span class="token comment"># 第二个样本："我 讨厌"  </span>
原始嵌入 → <span class="token punctuation">[</span><span class="token number">0.3</span><span class="token punctuation">,</span><span class="token number">0.4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1.3</span><span class="token punctuation">,</span><span class="token number">1.4</span><span class="token punctuation">]</span>  
拼接后 → <span class="token punctuation">[</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token number">1.3</span><span class="token punctuation">,</span> <span class="token number">1.4</span><span class="token punctuation">]</span>
</code></pre>
     <p>
      <strong>
       技术意义
      </strong>
      ：
      <br/>
      将序列的时序信息转换为空间特征，为全连接层提供固定长度的输入。
     </p>
     <hr/>
     <h5>
      <a id="3_Feature_Projection_329">
      </a>
      <strong>
       3. 第一全连接层（Feature Projection）
      </strong>
     </h5>
     <pre><code class="prism language-python">self<span class="token punctuation">.</span>linear1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment"># 输入4维 → 输出2维</span>
hidden <span class="token operator">=</span> torch<span class="token punctuation">.</span>tanh<span class="token punctuation">(</span>self<span class="token punctuation">.</span>linear1<span class="token punctuation">(</span>X<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># [2,4] → [2,2]</span>
</code></pre>
     <p>
      <strong>
       参数示例
      </strong>
      ：
      <br/>
      假设权重和偏置为（点乘）：
      <br/>
      <span class="katex--display">
       <span class="katex-display">
        <span class="katex">
         <span class="katex-mathml">
          W 
          
         
           1 
          
         
        
          = 
         
         
         
           [ 
          
          
           
            
             
             
               0.1 
              
             
            
            
             
              
              
                − 
               
              
                0.2 
               
              
             
            
            
             
             
               0.3 
              
             
            
            
             
             
               0.4 
              
             
            
           
           
            
             
              
              
                − 
               
              
                0.5 
               
              
             
            
            
             
             
               0.6 
              
             
            
            
             
             
               0.7 
              
             
            
            
             
              
              
                − 
               
              
                0.8 
               
              
             
            
           
          
         
           ] 
          
         
        
          , 
         
         
         
         
           b 
          
         
           1 
          
         
        
          = 
         
         
         
           [ 
          
          
           
            
             
             
               0.1 
              
             
            
           
           
            
             
              
              
                − 
               
              
                0.2 
               
              
             
            
           
          
         
           ] 
          
         
        
       
         W_1 = \begin{bmatrix} 0.1 &amp; -0.2 &amp; 0.3 &amp; 0.4 \\ -0.5 &amp; 0.6 &amp; 0.7 &amp; -0.8 \end{bmatrix}, \quad b_1 = \begin{bmatrix} 0.1 \\ -0.2 \end{bmatrix}
         </span>
         <span class="katex-html">
          <span class="base">
           <span class="strut" style="height: 0.8333em; vertical-align: -0.15em;">
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.1389em;">
             W
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.3011em;">
                <span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mtight">
                   1
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.15em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
           <span class="mrel">
            =
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 2.4em; vertical-align: -0.95em;">
           </span>
           <span class="minner">
            <span class="mopen delimcenter" style="top: 0em;">
             <span class="delimsizing size3">
              [
             </span>
            </span>
            <span class="mord">
             <span class="mtable">
              <span class="col-align-c">
               <span class="vlist-t vlist-t2">
                <span class="vlist-r">
                 <span class="vlist" style="height: 1.45em;">
                  <span class="" style="top: -3.61em;">
                   <span class="pstrut" style="height: 3em;">
                   </span>
                   <span class="mord">
                    <span class="mord">
                     0.1
                    </span>
                   </span>
                  </span>
                  <span class="" style="top: -2.41em;">
                   <span class="pstrut" style="height: 3em;">
                   </span>
                   <span class="mord">
                    <span class="mord">
                     −
                    </span>
                    <span class="mord">
                     0.5
                    </span>
                   </span>
                  </span>
                 </span>
                 <span class="vlist-s">
                  ​
                 </span>
                </span>
                <span class="vlist-r">
                 <span class="vlist" style="height: 0.95em;">
                  <span class="">
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="arraycolsep" style="width: 0.5em;">
              </span>
              <span class="arraycolsep" style="width: 0.5em;">
              </span>
              <span class="col-align-c">
               <span class="vlist-t vlist-t2">
                <span class="vlist-r">
                 <span class="vlist" style="height: 1.45em;">
                  <span class="" style="top: -3.61em;">
                   <span class="pstrut" style="height: 3em;">
                   </span>
                   <span class="mord">
                    <span class="mord">
                     −
                    </span>
                    <span class="mord">
                     0.2
                    </span>
                   </span>
                  </span>
                  <span class="" style="top: -2.41em;">
                   <span class="pstrut" style="height: 3em;">
                   </span>
                   <span class="mord">
                    <span class="mord">
                     0.6
                    </span>
                   </span>
                  </span>
                 </span>
                 <span class="vlist-s">
                  ​
                 </span>
                </span>
                <span class="vlist-r">
                 <span class="vlist" style="height: 0.95em;">
                  <span class="">
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="arraycolsep" style="width: 0.5em;">
              </span>
              <span class="arraycolsep" style="width: 0.5em;">
              </span>
              <span class="col-align-c">
               <span class="vlist-t vlist-t2">
                <span class="vlist-r">
                 <span class="vlist" style="height: 1.45em;">
                  <span class="" style="top: -3.61em;">
                   <span class="pstrut" style="height: 3em;">
                   </span>
                   <span class="mord">
                    <span class="mord">
                     0.3
                    </span>
                   </span>
                  </span>
                  <span class="" style="top: -2.41em;">
                   <span class="pstrut" style="height: 3em;">
                   </span>
                   <span class="mord">
                    <span class="mord">
                     0.7
                    </span>
                   </span>
                  </span>
                 </span>
                 <span class="vlist-s">
                  ​
                 </span>
                </span>
                <span class="vlist-r">
                 <span class="vlist" style="height: 0.95em;">
                  <span class="">
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="arraycolsep" style="width: 0.5em;">
              </span>
              <span class="arraycolsep" style="width: 0.5em;">
              </span>
              <span class="col-align-c">
               <span class="vlist-t vlist-t2">
                <span class="vlist-r">
                 <span class="vlist" style="height: 1.45em;">
                  <span class="" style="top: -3.61em;">
                   <span class="pstrut" style="height: 3em;">
                   </span>
                   <span class="mord">
                    <span class="mord">
                     0.4
                    </span>
                   </span>
                  </span>
                  <span class="" style="top: -2.41em;">
                   <span class="pstrut" style="height: 3em;">
                   </span>
                   <span class="mord">
                    <span class="mord">
                     −
                    </span>
                    <span class="mord">
                     0.8
                    </span>
                   </span>
                  </span>
                 </span>
                 <span class="vlist-s">
                  ​
                 </span>
                </span>
                <span class="vlist-r">
                 <span class="vlist" style="height: 0.95em;">
                  <span class="">
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
            <span class="mclose delimcenter" style="top: 0em;">
             <span class="delimsizing size3">
              ]
             </span>
            </span>
           </span>
           <span class="mspace" style="margin-right: 0.1667em;">
           </span>
           <span class="mpunct">
            ,
           </span>
           <span class="mspace" style="margin-right: 1em;">
           </span>
           <span class="mspace" style="margin-right: 0.1667em;">
           </span>
           <span class="mord">
            <span class="mord mathnormal">
             b
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.3011em;">
                <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mtight">
                   1
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.15em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
           <span class="mrel">
            =
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 2.4em; vertical-align: -0.95em;">
           </span>
           <span class="minner">
            <span class="mopen delimcenter" style="top: 0em;">
             <span class="delimsizing size3">
              [
             </span>
            </span>
            <span class="mord">
             <span class="mtable">
              <span class="col-align-c">
               <span class="vlist-t vlist-t2">
                <span class="vlist-r">
                 <span class="vlist" style="height: 1.45em;">
                  <span class="" style="top: -3.61em;">
                   <span class="pstrut" style="height: 3em;">
                   </span>
                   <span class="mord">
                    <span class="mord">
                     0.1
                    </span>
                   </span>
                  </span>
                  <span class="" style="top: -2.41em;">
                   <span class="pstrut" style="height: 3em;">
                   </span>
                   <span class="mord">
                    <span class="mord">
                     −
                    </span>
                    <span class="mord">
                     0.2
                    </span>
                   </span>
                  </span>
                 </span>
                 <span class="vlist-s">
                  ​
                 </span>
                </span>
                <span class="vlist-r">
                 <span class="vlist" style="height: 0.95em;">
                  <span class="">
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
            <span class="mclose delimcenter" style="top: 0em;">
             <span class="delimsizing size3">
              ]
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </p>
     <p>
      <strong>
       计算演示
      </strong>
      ：
     </p>
     <pre><code class="prism language-python"><span class="token comment"># 第一个样本计算：</span>
<span class="token punctuation">[</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token number">0.7</span><span class="token punctuation">,</span> <span class="token number">0.8</span><span class="token punctuation">]</span> × W1 <span class="token operator">+</span> b1
<span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0.3</span><span class="token operator">*</span><span class="token number">0.1</span> <span class="token operator">+</span> <span class="token number">0.4</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0.7</span><span class="token operator">*</span><span class="token number">0.3</span> <span class="token operator">+</span> <span class="token number">0.8</span><span class="token operator">*</span><span class="token number">0.4</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0.1</span> <span class="token operator">=</span> <span class="token number">0.54</span> → tanh<span class="token punctuation">(</span><span class="token number">0.54</span><span class="token punctuation">)</span> ≈ <span class="token number">0.49</span>  
<span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0.3</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0.4</span><span class="token operator">*</span><span class="token number">0.6</span> <span class="token operator">+</span> <span class="token number">0.7</span><span class="token operator">*</span><span class="token number">0.7</span> <span class="token operator">+</span> <span class="token number">0.8</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.8</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.2</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">0.56</span> → tanh<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.56</span><span class="token punctuation">)</span> ≈ <span class="token operator">-</span><span class="token number">0.51</span>
输出 → <span class="token punctuation">[</span><span class="token number">0.49</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.51</span><span class="token punctuation">]</span>
</code></pre>
     <p>
      <strong>
       数学表达式
      </strong>
      ：
      <br/>
      <span class="katex--display">
       <span class="katex-display">
        <span class="katex">
         <span class="katex-mathml">
          h 
         
        
          = 
         
        
          tanh 
         
        
          ⁡ 
         
        
          ( 
         
         
         
           X 
          
          
          
            f 
           
          
            l 
           
          
            a 
           
          
            t 
           
          
         
         
         
           W 
          
         
           1 
          
         
           ⊤ 
          
         
        
          + 
         
         
         
           b 
          
         
           1 
          
         
        
          ) 
         
        
       
         \mathbf{h} = \tanh(\mathbf{X}_{flat}W_1^\top + \mathbf{b}_1)
         </span>
         <span class="katex-html">
          <span class="base">
           <span class="strut" style="height: 0.6944em;">
           </span>
           <span class="mord mathbf">
            h
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
           <span class="mrel">
            =
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 1.1852em; vertical-align: -0.2861em;">
           </span>
           <span class="mop">
            tanh
           </span>
           <span class="mopen">
            (
           </span>
           <span class="mord">
            <span class="mord mathbf">
             X
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.3361em;">
                <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mtight">
                   <span class="mord mathnormal mtight" style="margin-right: 0.1076em;">
                    f
                   </span>
                   <span class="mord mathnormal mtight" style="margin-right: 0.0197em;">
                    l
                   </span>
                   <span class="mord mathnormal mtight">
                    a
                   </span>
                   <span class="mord mathnormal mtight">
                    t
                   </span>
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.2861em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.1389em;">
             W
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.8991em;">
                <span class="" style="top: -2.453em; margin-left: -0.1389em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mtight">
                   1
                  </span>
                 </span>
                </span>
                <span class="" style="top: -3.113em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mtight">
                   ⊤
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.247em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mspace" style="margin-right: 0.2222em;">
           </span>
           <span class="mbin">
            +
           </span>
           <span class="mspace" style="margin-right: 0.2222em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 1em; vertical-align: -0.25em;">
           </span>
           <span class="mord">
            <span class="mord mathbf">
             b
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.3011em;">
                <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mtight">
                   1
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.15em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mclose">
            )
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      <br/>
      其中
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         W 
         
        
          1 
         
        
       
         ∈ 
        
        
        
          R 
         
         
         
           n 
          
         
           _ 
          
         
           h 
          
         
           i 
          
         
           d 
          
         
           d 
          
         
           e 
          
         
           n 
          
         
           × 
          
         
           ( 
          
         
           n 
          
         
           _ 
          
         
           s 
          
         
           t 
          
         
           e 
          
         
           p 
          
         
           × 
          
         
           e 
          
         
           m 
          
         
           b 
          
         
           e 
          
         
           d 
          
         
           d 
          
         
           i 
          
         
           n 
          
         
           g 
          
         
           _ 
          
         
           s 
          
         
           i 
          
         
           z 
          
         
           e 
          
         
           ) 
          
         
        
       
      
        W_1 \in \mathbb{R}^{n\_hidden×(n\_step×embedding\_size)}
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.8333em; vertical-align: -0.15em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.1389em;">
            W
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3011em;">
               <span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  1
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           ∈
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 0.888em;">
          </span>
          <span class="mord">
           <span class="mord mathbb">
            R
           </span>
           <span class="msupsub">
            <span class="vlist-t">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.888em;">
               <span class="" style="top: -3.063em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mathnormal mtight">
                   n
                  </span>
                  <span class="mord mtight" style="margin-right: 0.0278em;">
                   _
                  </span>
                  <span class="mord mathnormal mtight">
                   hi
                  </span>
                  <span class="mord mathnormal mtight">
                   dd
                  </span>
                  <span class="mord mathnormal mtight">
                   e
                  </span>
                  <span class="mord mathnormal mtight">
                   n
                  </span>
                  <span class="mbin mtight">
                   ×
                  </span>
                  <span class="mopen mtight">
                   (
                  </span>
                  <span class="mord mathnormal mtight">
                   n
                  </span>
                  <span class="mord mtight" style="margin-right: 0.0278em;">
                   _
                  </span>
                  <span class="mord mathnormal mtight">
                   s
                  </span>
                  <span class="mord mathnormal mtight">
                   t
                  </span>
                  <span class="mord mathnormal mtight">
                   e
                  </span>
                  <span class="mord mathnormal mtight">
                   p
                  </span>
                  <span class="mbin mtight">
                   ×
                  </span>
                  <span class="mord mathnormal mtight">
                   e
                  </span>
                  <span class="mord mathnormal mtight">
                   mb
                  </span>
                  <span class="mord mathnormal mtight">
                   e
                  </span>
                  <span class="mord mathnormal mtight">
                   dd
                  </span>
                  <span class="mord mathnormal mtight">
                   in
                  </span>
                  <span class="mord mathnormal mtight" style="margin-right: 0.0359em;">
                   g
                  </span>
                  <span class="mord mtight" style="margin-right: 0.0278em;">
                   _
                  </span>
                  <span class="mord mathnormal mtight">
                   s
                  </span>
                  <span class="mord mathnormal mtight">
                   i
                  </span>
                  <span class="mord mathnormal mtight">
                   ze
                  </span>
                  <span class="mclose mtight">
                   )
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </p>
     <hr/>
     <h5>
      <a id="4_Output_Projection_362">
      </a>
      <strong>
       4. 第二全连接层（Output Projection）
      </strong>
     </h5>
     <pre><code class="prism language-python">self<span class="token punctuation">.</span>linear2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span>  <span class="token comment"># 2维→7分类</span>
output <span class="token operator">=</span> self<span class="token punctuation">.</span>linear2<span class="token punctuation">(</span>hidden<span class="token punctuation">)</span>  <span class="token comment"># [2,2] → [2,7]</span>
</code></pre>
     <p>
      相当于将第一层的输入进行线性变换后（
      <strong>
       上下文特征的抽象提取
      </strong>
      ），通过激活函数得出的结果分别再与第二层的参数进行线性变换（
      <strong>
       语义到词汇的概率映射
      </strong>
      ），通过结果可以判断出哪一个词语为预测词的概率更大。
     </p>
     <p>
      <strong>
       参数示例
      </strong>
      ：
      <br/>
      假设：
      <br/>
      <span class="katex--display">
       <span class="katex-display">
        <span class="katex">
         <span class="katex-mathml">
          W 
          
         
           2 
          
         
        
          = 
         
         
         
           [ 
          
          
           
            
             
             
               0.2 
              
             
            
            
             
              
              
                − 
               
              
                0.3 
               
              
             
            
           
           
            
             
             
               0.4 
              
             
            
            
             
             
               0.1 
              
             
            
           
           
            
             
              
              
                − 
               
              
                0.5 
               
              
             
            
            
             
             
               0.6 
              
             
            
           
           
            
             
             
               0.7 
              
             
            
            
             
              
              
                − 
               
              
                0.8 
               
              
             
            
           
           
            
             
              
              
                − 
               
              
                0.9 
               
              
             
            
            
             
             
               0.2 
              
             
            
           
           
            
             
             
               1.0 
              
             
            
            
             
             
               0.3 
              
             
            
           
           
            
             
             
               0.1 
              
             
            
            
             
              
              
                − 
               
              
                0.4 
               
              
             
            
           
          
         
           ] 
          
         
        
          , 
         
         
         
         
           b 
          
         
           2 
          
         
        
          = 
         
        
          [ 
         
        
          0.1 
         
        
          , 
         
        
          0.2 
         
        
          , 
         
        
          − 
         
        
          0.3 
         
        
          , 
         
        
          0.4 
         
        
          , 
         
        
          − 
         
        
          0.5 
         
        
          , 
         
        
          0.6 
         
        
          , 
         
        
          − 
         
        
          0.7 
         
        
          ] 
         
        
       
         W_2 = \begin{bmatrix} 0.2 &amp; -0.3 \\ 0.4 &amp; 0.1 \\ -0.5 &amp; 0.6 \\ 0.7 &amp; -0.8 \\ -0.9 &amp; 0.2 \\ 1.0 &amp; 0.3 \\ 0.1 &amp; -0.4 \end{bmatrix}, \quad b_2 = [0.1, 0.2, -0.3, 0.4, -0.5, 0.6, -0.7]
         </span>
         <span class="katex-html">
          <span class="base">
           <span class="strut" style="height: 0.8333em; vertical-align: -0.15em;">
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.1389em;">
             W
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.3011em;">
                <span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mtight">
                   2
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.15em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
           <span class="mrel">
            =
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 8.4001em; vertical-align: -3.9501em;">
           </span>
           <span class="minner">
            <span class="mopen">
             <span class="delimsizing mult">
              <span class="vlist-t vlist-t2">
               <span class="vlist-r">
                <span class="vlist" style="height: 4.4499em;">
                 <span class="" style="top: -6.4499em;">
                  <span class="pstrut" style="height: 10.4em;">
                  </span>
                  <span class="" style="width: 0.667em; height: 8.4em;">
                   <svg height="8.400em" viewbox="0 0 667 8400" width="0.667em">
                    <path d="M403 1759 V84 H666 V0 H319 V1759 v4800 v1759 h347 v-84
H403z M403 1759 V0 H319 V1759 v4800 v1759 h84z">
                    </path>
                   </svg>
                  </span>
                 </span>
                </span>
                <span class="vlist-s">
                 ​
                </span>
               </span>
               <span class="vlist-r">
                <span class="vlist" style="height: 3.9501em;">
                 <span class="">
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
            <span class="mord">
             <span class="mtable">
              <span class="col-align-c">
               <span class="vlist-t vlist-t2">
                <span class="vlist-r">
                 <span class="vlist" style="height: 4.45em;">
                  <span class="" style="top: -6.61em;">
                   <span class="pstrut" style="height: 3em;">
                   </span>
                   <span class="mord">
                    <span class="mord">
                     0.2
                    </span>
                   </span>
                  </span>
                  <span class="" style="top: -5.41em;">
                   <span class="pstrut" style="height: 3em;">
                   </span>
                   <span class="mord">
                    <span class="mord">
                     0.4
                    </span>
                   </span>
                  </span>
                  <span class="" style="top: -4.21em;">
                   <span class="pstrut" style="height: 3em;">
                   </span>
                   <span class="mord">
                    <span class="mord">
                     −
                    </span>
                    <span class="mord">
                     0.5
                    </span>
                   </span>
                  </span>
                  <span class="" style="top: -3.01em;">
                   <span class="pstrut" style="height: 3em;">
                   </span>
                   <span class="mord">
                    <span class="mord">
                     0.7
                    </span>
                   </span>
                  </span>
                  <span class="" style="top: -1.81em;">
                   <span class="pstrut" style="height: 3em;">
                   </span>
                   <span class="mord">
                    <span class="mord">
                     −
                    </span>
                    <span class="mord">
                     0.9
                    </span>
                   </span>
                  </span>
                  <span class="" style="top: -0.61em;">
                   <span class="pstrut" style="height: 3em;">
                   </span>
                   <span class="mord">
                    <span class="mord">
                     1.0
                    </span>
                   </span>
                  </span>
                  <span class="" style="top: 0.59em;">
                   <span class="pstrut" style="height: 3em;">
                   </span>
                   <span class="mord">
                    <span class="mord">
                     0.1
                    </span>
                   </span>
                  </span>
                 </span>
                 <span class="vlist-s">
                  ​
                 </span>
                </span>
                <span class="vlist-r">
                 <span class="vlist" style="height: 3.95em;">
                  <span class="">
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="arraycolsep" style="width: 0.5em;">
              </span>
              <span class="arraycolsep" style="width: 0.5em;">
              </span>
              <span class="col-align-c">
               <span class="vlist-t vlist-t2">
                <span class="vlist-r">
                 <span class="vlist" style="height: 4.45em;">
                  <span class="" style="top: -6.61em;">
                   <span class="pstrut" style="height: 3em;">
                   </span>
                   <span class="mord">
                    <span class="mord">
                     −
                    </span>
                    <span class="mord">
                     0.3
                    </span>
                   </span>
                  </span>
                  <span class="" style="top: -5.41em;">
                   <span class="pstrut" style="height: 3em;">
                   </span>
                   <span class="mord">
                    <span class="mord">
                     0.1
                    </span>
                   </span>
                  </span>
                  <span class="" style="top: -4.21em;">
                   <span class="pstrut" style="height: 3em;">
                   </span>
                   <span class="mord">
                    <span class="mord">
                     0.6
                    </span>
                   </span>
                  </span>
                  <span class="" style="top: -3.01em;">
                   <span class="pstrut" style="height: 3em;">
                   </span>
                   <span class="mord">
                    <span class="mord">
                     −
                    </span>
                    <span class="mord">
                     0.8
                    </span>
                   </span>
                  </span>
                  <span class="" style="top: -1.81em;">
                   <span class="pstrut" style="height: 3em;">
                   </span>
                   <span class="mord">
                    <span class="mord">
                     0.2
                    </span>
                   </span>
                  </span>
                  <span class="" style="top: -0.61em;">
                   <span class="pstrut" style="height: 3em;">
                   </span>
                   <span class="mord">
                    <span class="mord">
                     0.3
                    </span>
                   </span>
                  </span>
                  <span class="" style="top: 0.59em;">
                   <span class="pstrut" style="height: 3em;">
                   </span>
                   <span class="mord">
                    <span class="mord">
                     −
                    </span>
                    <span class="mord">
                     0.4
                    </span>
                   </span>
                  </span>
                 </span>
                 <span class="vlist-s">
                  ​
                 </span>
                </span>
                <span class="vlist-r">
                 <span class="vlist" style="height: 3.95em;">
                  <span class="">
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
            <span class="mclose">
             <span class="delimsizing mult">
              <span class="vlist-t vlist-t2">
               <span class="vlist-r">
                <span class="vlist" style="height: 4.4499em;">
                 <span class="" style="top: -6.4499em;">
                  <span class="pstrut" style="height: 10.4em;">
                  </span>
                  <span class="" style="width: 0.667em; height: 8.4em;">
                   <svg height="8.400em" viewbox="0 0 667 8400" width="0.667em">
                    <path d="M347 1759 V0 H0 V84 H263 V1759 v4800 v1759 H0 v84 H347z
M347 1759 V0 H263 V1759 v4800 v1759 h84z">
                    </path>
                   </svg>
                  </span>
                 </span>
                </span>
                <span class="vlist-s">
                 ​
                </span>
               </span>
               <span class="vlist-r">
                <span class="vlist" style="height: 3.9501em;">
                 <span class="">
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mspace" style="margin-right: 0.1667em;">
           </span>
           <span class="mpunct">
            ,
           </span>
           <span class="mspace" style="margin-right: 1em;">
           </span>
           <span class="mspace" style="margin-right: 0.1667em;">
           </span>
           <span class="mord">
            <span class="mord mathnormal">
             b
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.3011em;">
                <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mtight">
                   2
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.15em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
           <span class="mrel">
            =
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 1em; vertical-align: -0.25em;">
           </span>
           <span class="mopen">
            [
           </span>
           <span class="mord">
            0.1
           </span>
           <span class="mpunct">
            ,
           </span>
           <span class="mspace" style="margin-right: 0.1667em;">
           </span>
           <span class="mord">
            0.2
           </span>
           <span class="mpunct">
            ,
           </span>
           <span class="mspace" style="margin-right: 0.1667em;">
           </span>
           <span class="mord">
            −
           </span>
           <span class="mord">
            0.3
           </span>
           <span class="mpunct">
            ,
           </span>
           <span class="mspace" style="margin-right: 0.1667em;">
           </span>
           <span class="mord">
            0.4
           </span>
           <span class="mpunct">
            ,
           </span>
           <span class="mspace" style="margin-right: 0.1667em;">
           </span>
           <span class="mord">
            −
           </span>
           <span class="mord">
            0.5
           </span>
           <span class="mpunct">
            ,
           </span>
           <span class="mspace" style="margin-right: 0.1667em;">
           </span>
           <span class="mord">
            0.6
           </span>
           <span class="mpunct">
            ,
           </span>
           <span class="mspace" style="margin-right: 0.1667em;">
           </span>
           <span class="mord">
            −
           </span>
           <span class="mord">
            0.7
           </span>
           <span class="mclose">
            ]
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </p>
     <p>
      <strong>
       计算演示
      </strong>
      ：
     </p>
     <pre><code class="prism language-python"><span class="token comment"># 第一个样本隐藏值 [0.49, -0.51]</span>
计算每个输出单元：
<span class="token number">0.49</span><span class="token operator">*</span><span class="token number">0.2</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.51</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0.1</span> ≈ <span class="token number">0.098</span> <span class="token operator">+</span> <span class="token number">0.153</span> <span class="token operator">+</span> <span class="token number">0.1</span> <span class="token operator">=</span> <span class="token number">0.351</span> → 输出单元<span class="token number">0</span>  
<span class="token number">0.49</span><span class="token operator">*</span><span class="token number">0.4</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.51</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">0.1</span> <span class="token operator">+</span> <span class="token number">0.2</span> ≈ <span class="token number">0.196</span> <span class="token operator">-</span> <span class="token number">0.051</span> <span class="token operator">+</span> <span class="token number">0.2</span> <span class="token operator">=</span> <span class="token number">0.345</span> → 输出单元<span class="token number">1</span>  
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>以此类推所有<span class="token number">7</span>个单元
</code></pre>
     <p>
      <strong>
       数学表达式
      </strong>
      ：
      <br/>
      <span class="katex--display">
       <span class="katex-display">
        <span class="katex">
         <span class="katex-mathml">
          o 
         
        
          = 
         
        
          h 
         
         
         
           W 
          
         
           2 
          
         
           ⊤ 
          
         
        
          + 
         
         
         
           b 
          
         
           2 
          
         
        
       
         \mathbf{o} = \mathbf{h}W_2^\top + \mathbf{b}_2
         </span>
         <span class="katex-html">
          <span class="base">
           <span class="strut" style="height: 0.4444em;">
           </span>
           <span class="mord mathbf">
            o
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
           <span class="mrel">
            =
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 1.1461em; vertical-align: -0.247em;">
           </span>
           <span class="mord mathbf">
            h
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.1389em;">
             W
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.8991em;">
                <span class="" style="top: -2.453em; margin-left: -0.1389em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mtight">
                   2
                  </span>
                 </span>
                </span>
                <span class="" style="top: -3.113em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mtight">
                   ⊤
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.247em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mspace" style="margin-right: 0.2222em;">
           </span>
           <span class="mbin">
            +
           </span>
           <span class="mspace" style="margin-right: 0.2222em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 0.8444em; vertical-align: -0.15em;">
           </span>
           <span class="mord">
            <span class="mord mathbf">
             b
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.3011em;">
                <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mtight">
                   2
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.15em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      <br/>
      其中
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         W 
         
        
          2 
         
        
       
         ∈ 
        
        
        
          R 
         
         
         
           v 
          
         
           o 
          
         
           c 
          
         
           _ 
          
         
           s 
          
         
           i 
          
         
           z 
          
         
           e 
          
         
           × 
          
         
           n 
          
         
           _ 
          
         
           h 
          
         
           i 
          
         
           d 
          
         
           d 
          
         
           e 
          
         
           n 
          
         
        
       
      
        W_2 \in \mathbb{R}^{voc\_size×n\_hidden}
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.8333em; vertical-align: -0.15em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.1389em;">
            W
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3011em;">
               <span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  2
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           ∈
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 0.8491em;">
          </span>
          <span class="mord">
           <span class="mord mathbb">
            R
           </span>
           <span class="msupsub">
            <span class="vlist-t">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.8491em;">
               <span class="" style="top: -3.063em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0359em;">
                   v
                  </span>
                  <span class="mord mathnormal mtight">
                   oc
                  </span>
                  <span class="mord mtight" style="margin-right: 0.0278em;">
                   _
                  </span>
                  <span class="mord mathnormal mtight">
                   s
                  </span>
                  <span class="mord mathnormal mtight">
                   i
                  </span>
                  <span class="mord mathnormal mtight">
                   ze
                  </span>
                  <span class="mbin mtight">
                   ×
                  </span>
                  <span class="mord mathnormal mtight">
                   n
                  </span>
                  <span class="mord mtight" style="margin-right: 0.0278em;">
                   _
                  </span>
                  <span class="mord mathnormal mtight">
                   hi
                  </span>
                  <span class="mord mathnormal mtight">
                   dd
                  </span>
                  <span class="mord mathnormal mtight">
                   e
                  </span>
                  <span class="mord mathnormal mtight">
                   n
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </p>
     <hr/>
     <h4>
      <a id="223__400">
      </a>
      2.2.3 输出结果解读
     </h4>
     <p>
      最终得到形状为
      <code>
       [batch_size, voc_size]
      </code>
      的
      <strong>
       未归一化概率（logits）
      </strong>
      ，例如：
     </p>
     <pre><code class="prism language-python">output <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">[</span><span class="token number">0.35</span><span class="token punctuation">,</span> <span class="token number">0.34</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.2</span><span class="token punctuation">,</span> <span class="token number">0.8</span><span class="token punctuation">,</span> <span class="token number">2.1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># 样本1：预测"喜欢"（索引4）概率最高</span>
    <span class="token punctuation">[</span><span class="token number">1.2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.7</span><span class="token punctuation">,</span> <span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.8</span><span class="token punctuation">,</span> <span class="token number">0.9</span><span class="token punctuation">,</span> <span class="token number">2.3</span><span class="token punctuation">]</span>     <span class="token comment"># 样本2：预测"讨厌"（索引6）概率最高</span>
<span class="token punctuation">]</span>
</code></pre>
     <p>
      要得到概率分布，需应用Softmax：
     </p>
     <pre><code class="prism language-python">probs <span class="token operator">=</span> torch<span class="token punctuation">.</span>softmax<span class="token punctuation">(</span>output<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment"># probs ≈ [</span>
<span class="token comment">#   [0.05, 0.05, 0.01, 0.10, 0.60, 0.09, 0.10], </span>
<span class="token comment">#   [0.15, 0.03, 0.08, 0.07, 0.02, 0.10, 0.55]</span>
<span class="token comment"># ]</span>
</code></pre>
     <hr/>
     <h4>
      <a id="224__420">
      </a>
      2.2.4 参数计算详解
     </h4>
     <h5>
      <a id="1__422">
      </a>
      <strong>
       1. 嵌入层参数
      </strong>
     </h5>
     <p>
      <span class="katex--display">
       <span class="katex-display">
        <span class="katex">
         <span class="katex-mathml">
          参数数 
         
        
          = 
         
        
          v 
         
        
          o 
         
        
          c 
         
        
          _ 
         
        
          s 
         
        
          i 
         
        
          z 
         
        
          e 
         
        
          × 
         
        
          e 
         
        
          m 
         
        
          b 
         
        
          e 
         
        
          d 
         
        
          d 
         
        
          i 
         
        
          n 
         
        
          g 
         
        
          _ 
         
        
          s 
         
        
          i 
         
        
          z 
         
        
          e 
         
        
          = 
         
        
          7 
         
        
          × 
         
        
          2 
         
        
          = 
         
        
          14 
         
        
       
         \text{参数数} = voc\_size × embedding\_size = 7×2 = 14
         </span>
         <span class="katex-html">
          <span class="base">
           <span class="strut" style="height: 0.6833em;">
           </span>
           <span class="mord text">
            <span class="mord cjk_fallback">
             参数数
            </span>
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
           <span class="mrel">
            =
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 0.9695em; vertical-align: -0.31em;">
           </span>
           <span class="mord mathnormal" style="margin-right: 0.0359em;">
            v
           </span>
           <span class="mord mathnormal">
            oc
           </span>
           <span class="mord" style="margin-right: 0.0278em;">
            _
           </span>
           <span class="mord mathnormal">
            s
           </span>
           <span class="mord mathnormal">
            i
           </span>
           <span class="mord mathnormal">
            ze
           </span>
           <span class="mspace" style="margin-right: 0.2222em;">
           </span>
           <span class="mbin">
            ×
           </span>
           <span class="mspace" style="margin-right: 0.2222em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 1.0044em; vertical-align: -0.31em;">
           </span>
           <span class="mord mathnormal">
            e
           </span>
           <span class="mord mathnormal">
            mb
           </span>
           <span class="mord mathnormal">
            e
           </span>
           <span class="mord mathnormal">
            dd
           </span>
           <span class="mord mathnormal">
            in
           </span>
           <span class="mord mathnormal" style="margin-right: 0.0359em;">
            g
           </span>
           <span class="mord" style="margin-right: 0.0278em;">
            _
           </span>
           <span class="mord mathnormal">
            s
           </span>
           <span class="mord mathnormal">
            i
           </span>
           <span class="mord mathnormal">
            ze
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
           <span class="mrel">
            =
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 0.7278em; vertical-align: -0.0833em;">
           </span>
           <span class="mord">
            7
           </span>
           <span class="mspace" style="margin-right: 0.2222em;">
           </span>
           <span class="mbin">
            ×
           </span>
           <span class="mspace" style="margin-right: 0.2222em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 0.6444em;">
           </span>
           <span class="mord">
            2
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
           <span class="mrel">
            =
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 0.6444em;">
           </span>
           <span class="mord">
            14
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </p>
     <h5>
      <a id="2__425">
      </a>
      <strong>
       2. 第一全连接层
      </strong>
     </h5>
     <p>
      <span class="katex--display">
       <span class="katex-display">
        <span class="katex">
         <span class="katex-mathml">
          参数数 
         
        
          = 
         
        
          ( 
         
        
          n 
         
        
          _ 
         
        
          s 
         
        
          t 
         
        
          e 
         
        
          p 
         
        
          × 
         
        
          e 
         
        
          m 
         
        
          b 
         
        
          e 
         
        
          d 
         
        
          d 
         
        
          i 
         
        
          n 
         
        
          g 
         
        
          _ 
         
        
          s 
         
        
          i 
         
        
          z 
         
        
          e 
         
        
          ) 
         
        
          × 
         
        
          n 
         
        
          _ 
         
        
          h 
         
        
          i 
         
        
          d 
         
        
          d 
         
        
          e 
         
        
          n 
         
        
          + 
         
        
          n 
         
        
          _ 
         
        
          h 
         
        
          i 
         
        
          d 
         
        
          d 
         
        
          e 
         
        
          n 
         
        
          = 
         
        
          4 
         
        
          × 
         
        
          2 
         
        
          + 
         
        
          2 
         
        
          = 
         
        
          10 
         
        
       
         \text{参数数} = (n\_step×embedding\_size) × n\_hidden + n\_hidden = 4×2 + 2 = 10
         </span>
         <span class="katex-html">
          <span class="base">
           <span class="strut" style="height: 0.6833em;">
           </span>
           <span class="mord text">
            <span class="mord cjk_fallback">
             参数数
            </span>
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
           <span class="mrel">
            =
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 1.06em; vertical-align: -0.31em;">
           </span>
           <span class="mopen">
            (
           </span>
           <span class="mord mathnormal">
            n
           </span>
           <span class="mord" style="margin-right: 0.0278em;">
            _
           </span>
           <span class="mord mathnormal">
            s
           </span>
           <span class="mord mathnormal">
            t
           </span>
           <span class="mord mathnormal">
            e
           </span>
           <span class="mord mathnormal">
            p
           </span>
           <span class="mspace" style="margin-right: 0.2222em;">
           </span>
           <span class="mbin">
            ×
           </span>
           <span class="mspace" style="margin-right: 0.2222em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 1.06em; vertical-align: -0.31em;">
           </span>
           <span class="mord mathnormal">
            e
           </span>
           <span class="mord mathnormal">
            mb
           </span>
           <span class="mord mathnormal">
            e
           </span>
           <span class="mord mathnormal">
            dd
           </span>
           <span class="mord mathnormal">
            in
           </span>
           <span class="mord mathnormal" style="margin-right: 0.0359em;">
            g
           </span>
           <span class="mord" style="margin-right: 0.0278em;">
            _
           </span>
           <span class="mord mathnormal">
            s
           </span>
           <span class="mord mathnormal">
            i
           </span>
           <span class="mord mathnormal">
            ze
           </span>
           <span class="mclose">
            )
           </span>
           <span class="mspace" style="margin-right: 0.2222em;">
           </span>
           <span class="mbin">
            ×
           </span>
           <span class="mspace" style="margin-right: 0.2222em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 1.0044em; vertical-align: -0.31em;">
           </span>
           <span class="mord mathnormal">
            n
           </span>
           <span class="mord" style="margin-right: 0.0278em;">
            _
           </span>
           <span class="mord mathnormal">
            hi
           </span>
           <span class="mord mathnormal">
            dd
           </span>
           <span class="mord mathnormal">
            e
           </span>
           <span class="mord mathnormal">
            n
           </span>
           <span class="mspace" style="margin-right: 0.2222em;">
           </span>
           <span class="mbin">
            +
           </span>
           <span class="mspace" style="margin-right: 0.2222em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 1.0044em; vertical-align: -0.31em;">
           </span>
           <span class="mord mathnormal">
            n
           </span>
           <span class="mord" style="margin-right: 0.0278em;">
            _
           </span>
           <span class="mord mathnormal">
            hi
           </span>
           <span class="mord mathnormal">
            dd
           </span>
           <span class="mord mathnormal">
            e
           </span>
           <span class="mord mathnormal">
            n
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
           <span class="mrel">
            =
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 0.7278em; vertical-align: -0.0833em;">
           </span>
           <span class="mord">
            4
           </span>
           <span class="mspace" style="margin-right: 0.2222em;">
           </span>
           <span class="mbin">
            ×
           </span>
           <span class="mspace" style="margin-right: 0.2222em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 0.7278em; vertical-align: -0.0833em;">
           </span>
           <span class="mord">
            2
           </span>
           <span class="mspace" style="margin-right: 0.2222em;">
           </span>
           <span class="mbin">
            +
           </span>
           <span class="mspace" style="margin-right: 0.2222em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 0.6444em;">
           </span>
           <span class="mord">
            2
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
           <span class="mrel">
            =
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 0.6444em;">
           </span>
           <span class="mord">
            10
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </p>
     <h5>
      <a id="3__428">
      </a>
      <strong>
       3. 第二全连接层
      </strong>
     </h5>
     <p>
      <span class="katex--display">
       <span class="katex-display">
        <span class="katex">
         <span class="katex-mathml">
          参数数 
         
        
          = 
         
        
          n 
         
        
          _ 
         
        
          h 
         
        
          i 
         
        
          d 
         
        
          d 
         
        
          e 
         
        
          n 
         
        
          × 
         
        
          v 
         
        
          o 
         
        
          c 
         
        
          _ 
         
        
          s 
         
        
          i 
         
        
          z 
         
        
          e 
         
        
          + 
         
        
          v 
         
        
          o 
         
        
          c 
         
        
          _ 
         
        
          s 
         
        
          i 
         
        
          z 
         
        
          e 
         
        
          = 
         
        
          2 
         
        
          × 
         
        
          7 
         
        
          + 
         
        
          7 
         
        
          = 
         
        
          21 
         
        
       
         \text{参数数} = n\_hidden × voc\_size + voc\_size = 2×7 + 7 = 21
         </span>
         <span class="katex-html">
          <span class="base">
           <span class="strut" style="height: 0.6833em;">
           </span>
           <span class="mord text">
            <span class="mord cjk_fallback">
             参数数
            </span>
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
           <span class="mrel">
            =
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 1.0044em; vertical-align: -0.31em;">
           </span>
           <span class="mord mathnormal">
            n
           </span>
           <span class="mord" style="margin-right: 0.0278em;">
            _
           </span>
           <span class="mord mathnormal">
            hi
           </span>
           <span class="mord mathnormal">
            dd
           </span>
           <span class="mord mathnormal">
            e
           </span>
           <span class="mord mathnormal">
            n
           </span>
           <span class="mspace" style="margin-right: 0.2222em;">
           </span>
           <span class="mbin">
            ×
           </span>
           <span class="mspace" style="margin-right: 0.2222em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 0.9695em; vertical-align: -0.31em;">
           </span>
           <span class="mord mathnormal" style="margin-right: 0.0359em;">
            v
           </span>
           <span class="mord mathnormal">
            oc
           </span>
           <span class="mord" style="margin-right: 0.0278em;">
            _
           </span>
           <span class="mord mathnormal">
            s
           </span>
           <span class="mord mathnormal">
            i
           </span>
           <span class="mord mathnormal">
            ze
           </span>
           <span class="mspace" style="margin-right: 0.2222em;">
           </span>
           <span class="mbin">
            +
           </span>
           <span class="mspace" style="margin-right: 0.2222em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 0.9695em; vertical-align: -0.31em;">
           </span>
           <span class="mord mathnormal" style="margin-right: 0.0359em;">
            v
           </span>
           <span class="mord mathnormal">
            oc
           </span>
           <span class="mord" style="margin-right: 0.0278em;">
            _
           </span>
           <span class="mord mathnormal">
            s
           </span>
           <span class="mord mathnormal">
            i
           </span>
           <span class="mord mathnormal">
            ze
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
           <span class="mrel">
            =
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 0.7278em; vertical-align: -0.0833em;">
           </span>
           <span class="mord">
            2
           </span>
           <span class="mspace" style="margin-right: 0.2222em;">
           </span>
           <span class="mbin">
            ×
           </span>
           <span class="mspace" style="margin-right: 0.2222em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 0.7278em; vertical-align: -0.0833em;">
           </span>
           <span class="mord">
            7
           </span>
           <span class="mspace" style="margin-right: 0.2222em;">
           </span>
           <span class="mbin">
            +
           </span>
           <span class="mspace" style="margin-right: 0.2222em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 0.6444em;">
           </span>
           <span class="mord">
            7
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
           <span class="mrel">
            =
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 0.6444em;">
           </span>
           <span class="mord">
            21
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </p>
     <p>
      <strong>
       总参数
      </strong>
      ：14 + 10 + 21 =
      <strong>
       45个可训练参数
      </strong>
     </p>
    </img>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f:626c6f672e6373646e2e6e65742f753031313134363230332f:61727469636c652f64657461696c732f313436313633353435" class_="artid" style="display:none">
 </p>
</div>


