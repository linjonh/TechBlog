---
layout: post
title: "MySQL-主主复制与-Redis-环境安装部署"
date: 2025-03-06 10:17:59 +0800
description: "通过本指南，您已成功搭建了一个MySQL 主主复制与Redis缓存的高可用环境。环境准备：确保服务器配置、网络通畅和必要的权限。MySQL 主主复制：安装 MySQL，两台服务器配置不同的server-id和复制参数，确保数据双向同步。Redis 安装与配置：编译安装 Redis，进行必要的安全配置，确保缓存服务稳定运行。高可用与负载均衡：使用 HAProxy 进行 MySQL 负载均衡，配置 Redis Sentinel 实现 Redis 高可用。安全性配置。"
keywords: "MySQL 主主复制与 Redis 环境安装部署"
categories: ['工具安装部署介绍']
tags: ['Redis', 'Mysql', 'Adb']
artid: "146060855"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146060855
    alt: "MySQL-主主复制与-Redis-环境安装部署"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146060855
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146060855
cover: https://bing.ee123.net/img/rand?artid=146060855
image: https://bing.ee123.net/img/rand?artid=146060855
img: https://bing.ee123.net/img/rand?artid=146060855
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     MySQL 主主复制与 Redis 环境安装部署
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="MySQL__Redis__0">
     </a>
     MySQL 主主复制与 Redis 环境安装部署
    </h2>
    <p>
     本指南将详细介绍如何在服务器上部署一个
     <strong>
      MySQL 主主（Master-Master）复制
     </strong>
     环境以及
     <strong>
      Redis
     </strong>
     缓存服务。通过本指南，您将能够搭建一个高可用、高性能的数据库与缓存系统，适用于中大型应用场景。
    </p>
    <hr/>
    <h3>
     <a id="_6">
     </a>
     目录
    </h3>
    <ol>
     <li>
      <a href="#1-%E5%89%8D%E6%8F%90%E6%9D%A1%E4%BB%B6" rel="nofollow">
       前提条件
      </a>
     </li>
     <li>
      <a href="#2-mysql-%E4%B8%BB%E4%B8%BB%E5%A4%8D%E5%88%B6%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE" rel="nofollow">
       MySQL 主主复制环境配置
      </a>
      <ul>
       <li>
        2.1
        <a href="#21-%E5%AE%89%E8%A3%85-mysql" rel="nofollow">
         安装 MySQL
        </a>
       </li>
       <li>
        2.2
        <a href="#22-%E9%85%8D%E7%BD%AE-mysql-%E4%B8%BB%E4%B8%BB%E5%A4%8D%E5%88%B6" rel="nofollow">
         配置 MySQL 主主复制
        </a>
       </li>
       <li>
        2.3
        <a href="#23-%E5%90%AF%E5%8A%A8%E5%A4%8D%E5%88%B6%E5%B9%B6%E9%AA%8C%E8%AF%81" rel="nofollow">
         启动复制并验证
        </a>
       </li>
      </ul>
     </li>
     <li>
      <a href="#3-redis-%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE" rel="nofollow">
       Redis 环境安装与配置
      </a>
      <ul>
       <li>
        3.1
        <a href="#31-%E5%AE%89%E8%A3%85-redis" rel="nofollow">
         安装 Redis
        </a>
       </li>
       <li>
        3.2
        <a href="#32-%E9%85%8D%E7%BD%AE-redis" rel="nofollow">
         配置 Redis
        </a>
       </li>
       <li>
        3.3
        <a href="#33-%E5%90%AF%E5%8A%A8-redis-%E6%9C%8D%E5%8A%A1" rel="nofollow">
         启动 Redis 服务
        </a>
       </li>
      </ul>
     </li>
     <li>
      <a href="#4-%E9%AB%98%E5%8F%AF%E7%94%A8%E4%B8%8E%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E8%AE%BE%E8%AE%A1" rel="nofollow">
       高可用与负载均衡设计
      </a>
      <ul>
       <li>
        4.1
        <a href="#41-mysql-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AD%96%E7%95%A5" rel="nofollow">
         MySQL 负载均衡策略
        </a>
       </li>
       <li>
        4.2
        <a href="#42-redis-%E9%AB%98%E5%8F%AF%E7%94%A8%E6%96%B9%E6%A1%88redis-sentinel" rel="nofollow">
         Redis 高可用方案（Redis Sentinel）
        </a>
       </li>
      </ul>
     </li>
     <li>
      <a href="#5-%E5%AE%89%E5%85%A8%E6%80%A7%E9%85%8D%E7%BD%AE" rel="nofollow">
       安全性配置
      </a>
     </li>
     <li>
      <a href="#6-%E7%9B%91%E6%8E%A7%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AD%96%E7%95%A5" rel="nofollow">
       监控与备份策略
      </a>
     </li>
     <li>
      <a href="#7-%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E4%B8%8E%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88" rel="nofollow">
       常见问题与解决方案
      </a>
     </li>
     <li>
      <a href="#8-%E6%80%BB%E7%BB%93" rel="nofollow">
       总结
      </a>
     </li>
    </ol>
    <hr/>
    <h3>
     <a id="1__27">
     </a>
     1. 前提条件
    </h3>
    <p>
     在开始之前，请确保满足以下前提条件：
    </p>
    <ul>
     <li>
      <strong>
       服务器准备
      </strong>
      ：准备至少两台物理服务器或虚拟机，操作系统建议使用
      <strong>
       CentOS 7/8
      </strong>
      或
      <strong>
       Ubuntu 20.04+
      </strong>
      。
     </li>
     <li>
      <strong>
       网络配置
      </strong>
      ：确保服务器之间网络通畅，能够通过内网 IP 互相访问。
     </li>
     <li>
      <strong>
       权限
      </strong>
      ：需要具备服务器的
      <strong>
       root
      </strong>
      权限或具备
      <strong>
       sudo
      </strong>
      权限的用户。
     </li>
     <li>
      <strong>
       时间同步
      </strong>
      ：确保所有服务器的时间同步，建议使用
      <strong>
       NTP
      </strong>
      服务。
     </li>
    </ul>
    <hr/>
    <h3>
     <a id="2_MySQL__38">
     </a>
     2. MySQL 主主复制环境配置
    </h3>
    <p>
     MySQL 主主复制允许
     <strong>
      两个或多个 MySQL 实例
     </strong>
     相互复制数据，实现数据的高可用性和负载均衡。以下步骤将指导您在两台服务器上配置 MySQL 主主复制。
    </p>
    <h4>
     <a id="21__MySQL_42">
     </a>
     2.1 安装 MySQL
    </h4>
    <p>
     本文以
     <strong>
      MySQL 8.0
     </strong>
     为例，以下步骤适用于
     <strong>
      CentOS 7
     </strong>
     系统。
    </p>
    <h5>
     <a id="211__MySQL__46">
     </a>
     2.1.1 添加 MySQL 仓库
    </h5>
    <p>
     在每台服务器上执行以下命令添加 MySQL 官方仓库：
    </p>
    <pre><code class="prism language-bash"><span class="token function">sudo</span> yum localinstall https://dev.mysql.com/get/mysql80-community-release-el7-3.noarch.rpm <span class="token parameter variable">-y</span>
</code></pre>
    <h5>
     <a id="212__MySQL_54">
     </a>
     2.1.2 安装 MySQL
    </h5>
    <pre><code class="prism language-bash"><span class="token function">sudo</span> yum <span class="token function">install</span> mysql-server <span class="token parameter variable">-y</span>
</code></pre>
    <h5>
     <a id="213__MySQL__60">
     </a>
     2.1.3 启动 MySQL 服务
    </h5>
    <pre><code class="prism language-bash"><span class="token function">sudo</span> systemctl start mysqld
<span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> mysqld
</code></pre>
    <h5>
     <a id="214__root__67">
     </a>
     2.1.4 获取初始 root 密码
    </h5>
    <p>
     初始安装完成后，MySQL 会生成一个临时 root 密码，执行以下命令查看：
    </p>
    <pre><code class="prism language-bash"><span class="token function">sudo</span> <span class="token function">grep</span> <span class="token string">'temporary password'</span> /var/log/mysqld.log
</code></pre>
    <h5>
     <a id="215__root__75">
     </a>
     2.1.5 设置 root 密码
    </h5>
    <p>
     使用临时密码登录 MySQL 并设置新密码：
    </p>
    <pre><code class="prism language-bash">mysql_secure_installation
</code></pre>
    <p>
     按照提示完成安全配置，包括设置新密码、删除匿名用户、禁止远程 root 登录等。
    </p>
    <h4>
     <a id="22__MySQL__85">
     </a>
     2.2 配置 MySQL 主主复制
    </h4>
    <p>
     假设有两台服务器：
    </p>
    <ul>
     <li>
      <strong>
       Server A
      </strong>
      <ul>
       <li>
        IP:
        <code>
         192.168.1.1
        </code>
       </li>
       <li>
        主机名:
        <code>
         mysql-master1
        </code>
       </li>
      </ul>
     </li>
     <li>
      <strong>
       Server B
      </strong>
      <ul>
       <li>
        IP:
        <code>
         192.168.1.2
        </code>
       </li>
       <li>
        主机名:
        <code>
         mysql-master2
        </code>
       </li>
      </ul>
     </li>
    </ul>
    <h5>
     <a id="221__Server_A_96">
     </a>
     2.2.1 配置 Server A
    </h5>
    <p>
     编辑 MySQL 配置文件
     <code>
      /etc/my.cnf
     </code>
     或
     <code>
      /etc/mysql/mysql.conf.d/mysqld.cnf
     </code>
     ，根据实际文件位置调整。
    </p>
    <pre><code class="prism language-ini">[mysqld]
server-id=1
log_bin=mysql-bin
binlog_format=ROW
relay_log=relay-bin
auto_increment_increment=2
auto_increment_offset=1
replicate-same-server-id=0
gtid_mode=ON
enforce_gtid_consistency=ON
master_info_repository=TABLE
relay_log_info_repository=TABLE
binlog_transaction_dependency_history_size=100
</code></pre>
    <h5>
     <a id="222__Server_B_116">
     </a>
     2.2.2 配置 Server B
    </h5>
    <p>
     编辑 MySQL 配置文件，配置与 Server A 不同的
     <code>
      server-id
     </code>
     和
     <code>
      auto_increment_offset
     </code>
     。
    </p>
    <pre><code class="prism language-ini">[mysqld]
server-id=2
log_bin=mysql-bin
binlog_format=ROW
relay_log=relay-bin
auto_increment_increment=2
auto_increment_offset=2
replicate-same-server-id=0
gtid_mode=ON
enforce_gtid_consistency=ON
master_info_repository=TABLE
relay_log_info_repository=TABLE
binlog_transaction_dependency_history_size=100
</code></pre>
    <h5>
     <a id="223__MySQL__136">
     </a>
     2.2.3 重启 MySQL 服务
    </h5>
    <p>
     在两台服务器上执行以下命令重启 MySQL 服务，使配置生效：
    </p>
    <pre><code class="prism language-bash"><span class="token function">sudo</span> systemctl restart mysqld
</code></pre>
    <h5>
     <a id="224__144">
     </a>
     2.2.4 创建复制用户
    </h5>
    <p>
     在 Server A 和 Server B 上分别创建复制用户。
    </p>
    <p>
     <strong>
      在 Server A 执行：
     </strong>
    </p>
    <pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">USER</span> <span class="token string">'replicator'</span><span class="token variable">@'%'</span> IDENTIFIED <span class="token keyword">WITH</span> mysql_native_password <span class="token keyword">BY</span> <span class="token string">'password123'</span><span class="token punctuation">;</span>
<span class="token keyword">GRANT</span> <span class="token keyword">REPLICATION</span> SLAVE <span class="token keyword">ON</span> <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">TO</span> <span class="token string">'replicator'</span><span class="token variable">@'%'</span><span class="token punctuation">;</span>
FLUSH <span class="token keyword">PRIVILEGES</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     <strong>
      在 Server B 执行：
     </strong>
    </p>
    <pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">USER</span> <span class="token string">'replicator'</span><span class="token variable">@'%'</span> IDENTIFIED <span class="token keyword">WITH</span> mysql_native_password <span class="token keyword">BY</span> <span class="token string">'password123'</span><span class="token punctuation">;</span>
<span class="token keyword">GRANT</span> <span class="token keyword">REPLICATION</span> SLAVE <span class="token keyword">ON</span> <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">TO</span> <span class="token string">'replicator'</span><span class="token variable">@'%'</span><span class="token punctuation">;</span>
FLUSH <span class="token keyword">PRIVILEGES</span><span class="token punctuation">;</span>
</code></pre>
    <blockquote>
     <p>
      <strong>
       注意
      </strong>
      ：请将
      <code>
       'password123'
      </code>
      替换为更强的密码，并确保网络防火墙允许两台服务器之间的3306端口通信。
     </p>
    </blockquote>
    <h5>
     <a id="225__Master__166">
     </a>
     2.2.5 获取 Master 状态
    </h5>
    <p>
     在 Server A 和 Server B 上分别执行以下命令获取
     <code>
      MASTER
     </code>
     状态信息。
    </p>
    <p>
     <strong>
      在 Server A 执行：
     </strong>
    </p>
    <pre><code class="prism language-sql"><span class="token keyword">SHOW</span> MASTER <span class="token keyword">STATUS</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     输出示例：
    </p>
    <pre><code>+------------------+----------+--------------+------------------+-------------------+
| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |
+------------------+----------+--------------+------------------+-------------------+
| mysql-bin.000001 | 154      |              |                  | e6d...             |
+------------------+----------+--------------+------------------+-------------------+
</code></pre>
    <p>
     <strong>
      在 Server B 执行：
     </strong>
    </p>
    <pre><code class="prism language-sql"><span class="token keyword">SHOW</span> MASTER <span class="token keyword">STATUS</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     输出示例：
    </p>
    <pre><code>+------------------+----------+--------------+------------------+-------------------+
| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |
+------------------+----------+--------------+------------------+-------------------+
| mysql-bin.000001 | 156      |              |                  | a1b...             |
+------------------+----------+--------------+------------------+-------------------+
</code></pre>
    <p>
     记录下各自的
     <code>
      File
     </code>
     和
     <code>
      Position
     </code>
     或
     <code>
      Executed_Gtid_Set
     </code>
     ，用于配置
     <code>
      CHANGE MASTER TO
     </code>
     。
    </p>
    <h5>
     <a id="226__204">
     </a>
     2.2.6 配置复制
    </h5>
    <p>
     <strong>
      在 Server A 配置复制到 Server B：
     </strong>
    </p>
    <pre><code class="prism language-sql">CHANGE MASTER <span class="token keyword">TO</span>
  MASTER_HOST<span class="token operator">=</span><span class="token string">'192.168.1.2'</span><span class="token punctuation">,</span>
  MASTER_USER<span class="token operator">=</span><span class="token string">'replicator'</span><span class="token punctuation">,</span>
  MASTER_PASSWORD<span class="token operator">=</span><span class="token string">'password123'</span><span class="token punctuation">,</span>
  MASTER_AUTO_POSITION<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>

<span class="token keyword">START</span> SLAVE<span class="token punctuation">;</span>
</code></pre>
    <p>
     <strong>
      在 Server B 配置复制到 Server A：
     </strong>
    </p>
    <pre><code class="prism language-sql">CHANGE MASTER <span class="token keyword">TO</span>
  MASTER_HOST<span class="token operator">=</span><span class="token string">'192.168.1.1'</span><span class="token punctuation">,</span>
  MASTER_USER<span class="token operator">=</span><span class="token string">'replicator'</span><span class="token punctuation">,</span>
  MASTER_PASSWORD<span class="token operator">=</span><span class="token string">'password123'</span><span class="token punctuation">,</span>
  MASTER_AUTO_POSITION<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>

<span class="token keyword">START</span> SLAVE<span class="token punctuation">;</span>
</code></pre>
    <blockquote>
     <p>
      <strong>
       注意
      </strong>
      ：
      <code>
       MASTER_AUTO_POSITION=1
      </code>
      表示使用 GTID 复制模式。
     </p>
    </blockquote>
    <h5>
     <a id="227__232">
     </a>
     2.2.7 验证复制状态
    </h5>
    <p>
     在两台服务器上分别执行以下命令查看复制状态：
    </p>
    <pre><code class="prism language-sql"><span class="token keyword">SHOW</span> SLAVE <span class="token keyword">STATUS</span>\G
</code></pre>
    <p>
     确保以下字段显示为
     <code>
      Yes
     </code>
     或正常状态：
    </p>
    <ul>
     <li>
      <strong>
       Slave_IO_Running
      </strong>
      : Yes
     </li>
     <li>
      <strong>
       Slave_SQL_Running
      </strong>
      : Yes
     </li>
     <li>
      <strong>
       Last_IO_Error
      </strong>
      : (null)
     </li>
     <li>
      <strong>
       Last_SQL_Error
      </strong>
      : (null)
     </li>
    </ul>
    <h4>
     <a id="23__247">
     </a>
     2.3 启动复制并验证
    </h4>
    <p>
     为了验证主主复制是否正常工作，可以在任一服务器上创建测试数据库和表，并插入数据，检查数据是否同步到另一台服务器。
    </p>
    <pre><code class="prism language-sql"><span class="token comment">-- 在 Server A 上执行</span>
<span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> test_db<span class="token punctuation">;</span>
<span class="token keyword">USE</span> test_db<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> users <span class="token punctuation">(</span>
  id <span class="token keyword">INT</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>
  name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  email <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> users <span class="token punctuation">(</span>name<span class="token punctuation">,</span> email<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'Alice'</span><span class="token punctuation">,</span> <span class="token string">'alice@example.com'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 在 Server B 上验证数据</span>
<span class="token keyword">USE</span> test_db<span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> users<span class="token punctuation">;</span>
</code></pre>
    <p>
     应输出插入的
     <code>
      Alice
     </code>
     数据，反之亦然。
    </p>
    <blockquote>
     <p>
      <strong>
       注意事项
      </strong>
      ：
     </p>
     <ul>
      <li>
       避免在主主复制环境下直接操作自增主键，以防止主键冲突。
      </li>
      <li>
       可以通过配置
       <code>
        auto_increment_increment
       </code>
       和
       <code>
        auto_increment_offset
       </code>
       来避免主键冲突。
      </li>
     </ul>
    </blockquote>
    <hr/>
    <h3>
     <a id="3_Redis__275">
     </a>
     3. Redis 环境安装与配置
    </h3>
    <p>
     Redis 是一个高性能的键值存储系统，常用于缓存、消息队列等场景。以下步骤将指导您在服务器上安装和配置 Redis。
    </p>
    <h4>
     <a id="31__Redis_279">
     </a>
     3.1 安装 Redis
    </h4>
    <p>
     本文以
     <strong>
      Redis 6.2
     </strong>
     为例，以下步骤适用于
     <strong>
      CentOS 7
     </strong>
     系统。
    </p>
    <h5>
     <a id="311__283">
     </a>
     3.1.1 安装必要依赖
    </h5>
    <pre><code class="prism language-bash"><span class="token function">sudo</span> yum <span class="token function">install</span> <span class="token parameter variable">-y</span> gcc jemalloc-devel tcl
</code></pre>
    <h5>
     <a id="312__Redis__289">
     </a>
     3.1.2 下载 Redis 源码
    </h5>
    <pre><code class="prism language-bash"><span class="token builtin class-name">cd</span> /usr/local/src
<span class="token function">sudo</span> <span class="token function">wget</span> http://download.redis.io/releases/redis-6.2.6.tar.gz
<span class="token function">sudo</span> <span class="token function">tar</span> xzf redis-6.2.6.tar.gz
<span class="token builtin class-name">cd</span> redis-6.2.6
</code></pre>
    <h5>
     <a id="313__Redis_298">
     </a>
     3.1.3 编译安装 Redis
    </h5>
    <pre><code class="prism language-bash"><span class="token function">sudo</span> <span class="token function">make</span>
<span class="token function">sudo</span> <span class="token function">make</span> <span class="token function">install</span>
</code></pre>
    <h5>
     <a id="314__Redis__305">
     </a>
     3.1.4 创建 Redis 用户和目录
    </h5>
    <pre><code class="prism language-bash"><span class="token function">sudo</span> adduser <span class="token parameter variable">--system</span> <span class="token parameter variable">--group</span> --no-create-home redis
<span class="token function">sudo</span> <span class="token function">mkdir</span> /etc/redis
<span class="token function">sudo</span> <span class="token function">mkdir</span> /var/lib/redis
<span class="token function">sudo</span> <span class="token function">chown</span> redis:redis /var/lib/redis
</code></pre>
    <h4>
     <a id="32__Redis_314">
     </a>
     3.2 配置 Redis
    </h4>
    <p>
     复制默认配置文件到
     <code>
      /etc/redis/
     </code>
     目录，并进行必要的修改。
    </p>
    <pre><code class="prism language-bash"><span class="token function">sudo</span> <span class="token function">cp</span> redis.conf /etc/redis/
</code></pre>
    <p>
     使用编辑器打开配置文件进行修改：
    </p>
    <pre><code class="prism language-bash"><span class="token function">sudo</span> <span class="token function">vi</span> /etc/redis/redis.conf
</code></pre>
    <p>
     修改或确认以下配置项：
    </p>
    <pre><code class="prism language-ini"># 监听所有接口（根据实际需求调整）
bind 0.0.0.0

# 禁用保护模式（确保访问安全）
protected-mode no

# 设置持久化策略
save 900 1
save 300 10
save 60 10000

# 设置数据库文件路径
dir /var/lib/redis

# 设置日志级别
loglevel notice
logfile "/var/log/redis/redis.log"

# 设置后台运行
daemonize yes

# 设置 pid 文件
pidfile /var/run/redis.pid

# 设置最大客户端数量
maxclients 10000

# 开启远程管理（可选，需确保安全）
# requirepass your_redis_password
</code></pre>
    <blockquote>
     <p>
      <strong>
       安全提示
      </strong>
      ：
     </p>
     <ul>
      <li>
       强烈建议启用密码认证，修改
       <code>
        requirepass
       </code>
       并设置复杂密码。
      </li>
      <li>
       如果 Redis 需要对外开放，请确保通过防火墙和安全组限制访问来源。
      </li>
     </ul>
    </blockquote>
    <h4>
     <a id="33__Redis__366">
     </a>
     3.3 启动 Redis 服务
    </h4>
    <h5>
     <a id="331__Redis__368">
     </a>
     3.3.1 创建 Redis 系统服务文件
    </h5>
    <p>
     创建
     <code>
      /etc/systemd/system/redis.service
     </code>
     文件：
    </p>
    <pre><code class="prism language-ini">[Unit]
Description=Redis In-Memory Data Store
After=network.target

[Service]
User=redis
Group=redis
ExecStart=/usr/local/bin/redis-server /etc/redis/redis.conf
ExecStop=/usr/local/bin/redis-cli shutdown
Restart=always

[Install]
WantedBy=multi-user.target
</code></pre>
    <h5>
     <a id="332__Redis__388">
     </a>
     3.3.2 启动并启用 Redis 服务
    </h5>
    <pre><code class="prism language-bash"><span class="token function">sudo</span> systemctl daemon-reload
<span class="token function">sudo</span> systemctl start redis
<span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> redis
</code></pre>
    <h5>
     <a id="333__Redis__396">
     </a>
     3.3.3 验证 Redis 服务状态
    </h5>
    <pre><code class="prism language-bash"><span class="token function">sudo</span> systemctl status redis
</code></pre>
    <p>
     应显示 Redis 正在运行状态。
    </p>
    <h5>
     <a id="334__Redis__404">
     </a>
     3.3.4 测试 Redis 连接
    </h5>
    <pre><code class="prism language-bash">redis-cli <span class="token function">ping</span>
</code></pre>
    <p>
     应返回
     <code>
      PONG
     </code>
     。
    </p>
    <hr/>
    <h3>
     <a id="4__414">
     </a>
     4. 高可用与负载均衡设计
    </h3>
    <p>
     为了确保系统的高可用性和性能，需要为 MySQL 和 Redis 配置相应的负载均衡和高可用方案。
    </p>
    <h4>
     <a id="41_MySQL__418">
     </a>
     4.1 MySQL 负载均衡策略
    </h4>
    <p>
     在主主复制环境中，需考虑以下负载均衡策略：
    </p>
    <h5>
     <a id="411__HAProxy__422">
     </a>
     4.1.1 使用 HAProxy 进行负载均衡
    </h5>
    <p>
     HAProxy 是一个高性能的 TCP/HTTP 负载均衡器，适用于 MySQL 负载均衡。
    </p>
    <h6>
     <a id="_HAProxy_426">
     </a>
     安装 HAProxy
    </h6>
    <pre><code class="prism language-bash"><span class="token function">sudo</span> yum <span class="token function">install</span> haproxy <span class="token parameter variable">-y</span>
</code></pre>
    <h6>
     <a id="_HAProxy_432">
     </a>
     配置 HAProxy
    </h6>
    <p>
     编辑 HAProxy 配置文件
     <code>
      /etc/haproxy/haproxy.cfg
     </code>
     ，添加 MySQL 后端配置：
    </p>
    <pre><code class="prism language-ini">frontend mysql_front
    bind *:3307
    mode tcp
    default_backend mysql_back

backend mysql_back
    mode tcp
    balance roundrobin
    option mysql-check user replicator
    server mysql1 192.168.1.1:3306 check
    server mysql2 192.168.1.2:3306 check
</code></pre>
    <blockquote>
     <p>
      <strong>
       说明
      </strong>
      ：
     </p>
     <ul>
      <li>
       前端监听
       <code>
        3307
       </code>
       端口，应用程序通过该端口连接 MySQL。
      </li>
      <li>
       后端定义两台 MySQL 服务器，使用
       <code>
        roundrobin
       </code>
       负载均衡策略。
      </li>
      <li>
       <code>
        mysql-check
       </code>
       用于健康检查，确保只有可用的后端服务器接收流量。
      </li>
     </ul>
    </blockquote>
    <h6>
     <a id="_HAProxy_455">
     </a>
     启动并启用 HAProxy
    </h6>
    <pre><code class="prism language-bash"><span class="token function">sudo</span> systemctl start haproxy
<span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> haproxy
</code></pre>
    <h6>
     <a id="_HAProxy_462">
     </a>
     测试 HAProxy
    </h6>
    <p>
     应用程序连接字符串示例：
    </p>
    <pre><code>jdbc:mysql://&lt;HAProxy_IP&gt;:3307/test_db?user=&lt;username&gt;&amp;password=&lt;password&gt;
</code></pre>
    <h4>
     <a id="42_Redis_Redis_Sentinel_470">
     </a>
     4.2 Redis 高可用方案（Redis Sentinel）
    </h4>
    <p>
     Redis Sentinel 提供监控、通知、自动故障转移和配置中心功能。以下步骤将配置 Redis Sentinel 以实现 Redis 的高可用性。
    </p>
    <h5>
     <a id="421__Redis_Sentinel_474">
     </a>
     4.2.1 部署 Redis Sentinel
    </h5>
    <p>
     在至少三个节点上部署 Redis Sentinel，以避免单点故障。以下以单个节点示例，实际部署请在多台服务器上进行。
    </p>
    <h6>
     <a id="_Redis_Sentinel_478">
     </a>
     安装 Redis Sentinel
    </h6>
    <p>
     Redis Sentinel 是 Redis 的一部分，无需单独安装。在每台 Redis 服务器上编辑配置文件添加 Sentinel 配置。
    </p>
    <h6>
     <a id="_Sentinel_482">
     </a>
     配置 Sentinel
    </h6>
    <p>
     创建 Sentinel 配置文件
     <code>
      /etc/redis/sentinel.conf
     </code>
     ：
    </p>
    <pre><code class="prism language-ini">port 26379
sentinel monitor mymaster 192.168.1.1 6379 2
sentinel auth-pass mymaster your_redis_password
sentinel down-after-milliseconds mymaster 5000
sentinel failover-timeout mymaster 10000
sentinel parallel-syncs mymaster 1
</code></pre>
    <ul>
     <li>
      <strong>
       mymaster
      </strong>
      ：Master 名称，可自定义。
     </li>
     <li>
      <strong>
       192.168.1.1 6379
      </strong>
      ：Master Redis 实例的 IP 和端口。
     </li>
     <li>
      <strong>
       2
      </strong>
      ：达到多少个 Sentinel 节点确认 master 故障。
     </li>
     <li>
      <strong>
       your_redis_password
      </strong>
      ：如果 Redis 设置了密码，需要配置此项。
     </li>
    </ul>
    <h6>
     <a id="_Sentinel_500">
     </a>
     启动 Sentinel
    </h6>
    <p>
     创建 Sentinel 系统服务文件
     <code>
      /etc/systemd/system/redis-sentinel.service
     </code>
     ：
    </p>
    <pre><code class="prism language-ini">[Unit]
Description=Redis Sentinel
After=network.target

[Service]
User=redis
Group=redis
ExecStart=/usr/local/bin/redis-sentinel /etc/redis/sentinel.conf
Restart=always

[Install]
WantedBy=multi-user.target
</code></pre>
    <p>
     启动并启用 Sentinel 服务：
    </p>
    <pre><code class="prism language-bash"><span class="token function">sudo</span> systemctl daemon-reload
<span class="token function">sudo</span> systemctl start redis-sentinel
<span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> redis-sentinel
</code></pre>
    <h5>
     <a id="422__Sentinel__527">
     </a>
     4.2.2 验证 Sentinel 配置
    </h5>
    <p>
     在任一 Sentinel 节点上执行以下命令查看 Sentinel 状态：
    </p>
    <pre><code class="prism language-bash">redis-cli <span class="token parameter variable">-p</span> <span class="token number">26379</span> sentinel masters
</code></pre>
    <p>
     应显示 Master 的详细信息。
    </p>
    <hr/>
    <h3>
     <a id="5__539">
     </a>
     5. 安全性配置
    </h3>
    <p>
     确保数据库和缓存系统的安全性是至关重要的。以下是一些安全配置建议：
    </p>
    <h4>
     <a id="51__543">
     </a>
     5.1 防火墙配置
    </h4>
    <p>
     使用
     <strong>
      firewalld
     </strong>
     或
     <strong>
      iptables
     </strong>
     限制对 MySQL 和 Redis 服务的访问，仅允许特定 IP 访问。
    </p>
    <h5>
     <a id="_firewalld__547">
     </a>
     示例：使用 firewalld 配置端口
    </h5>
    <pre><code class="prism language-bash"><span class="token function">sudo</span> firewall-cmd <span class="token parameter variable">--permanent</span> --add-port<span class="token operator">=</span><span class="token number">3306</span>/tcp
<span class="token function">sudo</span> firewall-cmd <span class="token parameter variable">--permanent</span> --add-port<span class="token operator">=</span><span class="token number">3307</span>/tcp    <span class="token comment"># HAProxy 端口</span>
<span class="token function">sudo</span> firewall-cmd <span class="token parameter variable">--permanent</span> --add-port<span class="token operator">=</span><span class="token number">6379</span>/tcp
<span class="token function">sudo</span> firewall-cmd <span class="token parameter variable">--permanent</span> --add-port<span class="token operator">=</span><span class="token number">26379</span>/tcp
<span class="token function">sudo</span> firewall-cmd <span class="token parameter variable">--reload</span>
</code></pre>
    <p>
     修改为仅允许特定 IP 地址访问，例如仅允许内网访问：
    </p>
    <pre><code class="prism language-bash"><span class="token function">sudo</span> firewall-cmd <span class="token parameter variable">--permanent</span> --add-rich-rule<span class="token operator">=</span><span class="token string">'rule family="ipv4" source address="192.168.1.0/24" port protocol="tcp" port="3306" accept'</span>
<span class="token comment"># 类似配置其他端口</span>
</code></pre>
    <h4>
     <a id="52__MySQL__Redis__564">
     </a>
     5.2 强化 MySQL 和 Redis 认证
    </h4>
    <ul>
     <li>
      <strong>
       MySQL
      </strong>
      ：确保
      <code>
       root
      </code>
      用户不允许远程登录，使用强密码，并定期更换密码。
     </li>
     <li>
      <strong>
       Redis
      </strong>
      ：启用密码认证，配置
      <code>
       requirepass
      </code>
      ，并在 Sentinel 配置中同步密码。
     </li>
    </ul>
    <h4>
     <a id="53__569">
     </a>
     5.3 加密传输
    </h4>
    <p>
     考虑使用 SSL/TLS 加密 MySQL 和 Redis 的传输，防止数据在传输过程中被窃听。
    </p>
    <ul>
     <li>
      <strong>
       MySQL
      </strong>
      ：配置
      <code>
       ssl
      </code>
      相关参数，启用 SSL 连接。
     </li>
     <li>
      <strong>
       Redis
      </strong>
      ：Redis 6.0 及以上支持 TLS，可在配置文件中启用。
     </li>
    </ul>
    <hr/>
    <h3>
     <a id="6__578">
     </a>
     6. 监控与备份策略
    </h3>
    <h4>
     <a id="61__580">
     </a>
     6.1 监控
    </h4>
    <p>
     使用专业的监控工具实时监控 MySQL 和 Redis 的性能和健康状态。
    </p>
    <ul>
     <li>
      <strong>
       Prometheus + Grafana
      </strong>
      ：采集和可视化监控指标。
     </li>
     <li>
      <strong>
       Percona Monitoring and Management (PMM)
      </strong>
      ：专为 MySQL 设计的监控工具。
     </li>
     <li>
      <strong>
       Redis Exporter
      </strong>
      ：用于 Prometheus 的 Redis 指标收集工具。
     </li>
    </ul>
    <h4>
     <a id="62__588">
     </a>
     6.2 备份
    </h4>
    <p>
     制定定期备份策略，确保数据安全与可恢复性。
    </p>
    <ul>
     <li>
      <strong>
       MySQL 备份
      </strong>
      ：
      <ul>
       <li>
        使用
        <strong>
         mysqldump
        </strong>
        进行逻辑备份。
       </li>
       <li>
        使用
        <strong>
         Percona XtraBackup
        </strong>
        进行物理备份。
       </li>
      </ul>
     </li>
     <li>
      <strong>
       Redis 备份
      </strong>
      ：
      <ul>
       <li>
        配置
        <code>
         SAVE
        </code>
        规则，定期生成 RDB 文件。
       </li>
       <li>
        使用
        <strong>
         Redis Backup Tools
        </strong>
        或
        <strong>
         RDB 拷贝脚本
        </strong>
        进行备份。
       </li>
      </ul>
     </li>
    </ul>
    <h4>
     <a id="63__599">
     </a>
     6.3 自动化脚本
    </h4>
    <p>
     编写自动化脚本，定期执行备份任务，并将备份文件存储在安全的位置，如远程服务器或云存储。
    </p>
    <hr/>
    <h3>
     <a id="7__605">
     </a>
     7. 常见问题与解决方案
    </h3>
    <h4>
     <a id="71_MySQL__607">
     </a>
     7.1 MySQL 复制不工作
    </h4>
    <p>
     <strong>
      问题描述
     </strong>
     ：
     <code>
      SHOW SLAVE STATUS\G
     </code>
     中
     <code>
      Slave_IO_Running
     </code>
     或
     <code>
      Slave_SQL_Running
     </code>
     显示
     <code>
      No
     </code>
     。
    </p>
    <p>
     <strong>
      解决方案
     </strong>
     ：
    </p>
    <ol>
     <li>
      检查复制用户权限是否正确。
     </li>
     <li>
      确认网络连接正常，防火墙未阻挡。
     </li>
     <li>
      检查 MySQL 配置是否正确，尤其是
      <code>
       server-id
      </code>
      、
      <code>
       log_bin
      </code>
      等参数。
     </li>
     <li>
      查看错误日志，定位具体错误信息。
     </li>
    </ol>
    <h4>
     <a id="72_HAProxy__MySQL__618">
     </a>
     7.2 HAProxy 无法连接 MySQL 后端
    </h4>
    <p>
     <strong>
      问题描述
     </strong>
     ：应用程序无法通过 HAProxy 连接 MySQL，或连接异常。
    </p>
    <p>
     <strong>
      解决方案
     </strong>
     ：
    </p>
    <ol>
     <li>
      确认 HAProxy 配置文件是否正确，后端服务器 IP 和端口配置无误。
     </li>
     <li>
      检查后端 MySQL 服务是否正常运行。
     </li>
     <li>
      查看 HAProxy 日志，分析连接失败原因。
     </li>
     <li>
      确认防火墙配置允许 HAProxy 与 MySQL 后端通信。
     </li>
    </ol>
    <h4>
     <a id="73_Redis_Sentinel__629">
     </a>
     7.3 Redis Sentinel 未能自动故障转移
    </h4>
    <p>
     <strong>
      问题描述
     </strong>
     ：当 Master Redis 节点宕机时，Sentinel 未能自动进行故障转移。
    </p>
    <p>
     <strong>
      解决方案
     </strong>
     ：
    </p>
    <ol>
     <li>
      确认 Sentinel 配置文件中的
      <code>
       sentinel monitor
      </code>
      参数正确无误。
     </li>
     <li>
      确保至少有三个 Sentinel 实例在运行。
     </li>
     <li>
      检查 Sentinel 日志，查看故障转移相关错误信息。
     </li>
     <li>
      确认 Sentinel 节点之间的网络通信正常。
     </li>
    </ol>
    <hr/>
    <h3>
     <a id="8__642">
     </a>
     8. 总结
    </h3>
    <p>
     通过本指南，您已成功搭建了一个
     <strong>
      MySQL 主主复制
     </strong>
     与
     <strong>
      Redis
     </strong>
     缓存的高可用环境。以下是关键要点总结：
    </p>
    <ol>
     <li>
      <strong>
       环境准备
      </strong>
      ：确保服务器配置、网络通畅和必要的权限。
     </li>
     <li>
      <strong>
       MySQL 主主复制
      </strong>
      ：安装 MySQL，两台服务器配置不同的
      <code>
       server-id
      </code>
      和复制参数，确保数据双向同步。
     </li>
     <li>
      <strong>
       Redis 安装与配置
      </strong>
      ：编译安装 Redis，进行必要的安全配置，确保缓存服务稳定运行。
     </li>
     <li>
      <strong>
       高可用与负载均衡
      </strong>
      ：使用 HAProxy 进行 MySQL 负载均衡，配置 Redis Sentinel 实现 Redis 高可用。
     </li>
     <li>
      <strong>
       安全性配置
      </strong>
      ：通过防火墙、强密码和加密传输确保系统安全。
     </li>
     <li>
      <strong>
       监控与备份
      </strong>
      ：部署监控工具，制定定期备份策略，确保系统的可见性和数据安全。
     </li>
     <li>
      <strong>
       故障排除
      </strong>
      ：了解常见问题的解决方法，确保系统稳定运行。
     </li>
    </ol>
    <p>
     <strong>
      最终建议
     </strong>
     ：
    </p>
    <ul>
     <li>
      <strong>
       定期维护
      </strong>
      ：定期检查系统状态，更新软件版本，应用安全补丁。
     </li>
     <li>
      <strong>
       性能优化
      </strong>
      ：根据监控数据优化数据库和缓存配置，提升系统性能。
     </li>
     <li>
      <strong>
       扩展性设计
      </strong>
      ：根据业务增长需求，灵活扩展 MySQL 和 Redis 实例，确保系统可伸缩性。
     </li>
     <li>
      <strong>
       文档与培训
      </strong>
      ：记录系统配置与操作流程，定期培训运维团队，提升团队应急响应能力。
     </li>
    </ul>
    <p>
     通过科学的规划和细致的执行，您将拥有一个稳定、高效且安全的数据库与缓存系统，满足业务发展的需要。如遇到复杂问题，可以下方留言。
    </p>
    <p>
     祝您的部署顺利！
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f33383432383837342f:61727469636c652f64657461696c732f313436303630383535" class_="artid" style="display:none">
 </p>
</div>


