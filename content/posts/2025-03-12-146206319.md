---
layout: post
title: "python运行Janus-Pro-1B文生图功能"
date: 2025-03-12 15:44:35 +0800
description: "python运行Janus-Pro-1B文生图功能：导入必要的库# 用于处理文件和目录路径# 用于图像处理# PyTorch库，用于深度学习模型的构建和训练# 用于数值计算# Hugging Face的Transformers库，用于加载预训练的语言模型# 自定义的多模态因果语言模型和处理器import os# 打印PyTorch版本和CUDA可用性# 打印当前使用的PyTorch版本# 检查CUDA是否可用（即是否可以使用GPU）# 打印当前GPU的显存占pip install Pillow用情况。"
keywords: "【python运行Janus-Pro-1B文生图功能】"
categories: ['Python']
tags: ['文生图', 'Python', 'Deepseek']
artid: "146206319"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146206319
    alt: "python运行Janus-Pro-1B文生图功能"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146206319
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146206319
cover: https://bing.ee123.net/img/rand?artid=146206319
image: https://bing.ee123.net/img/rand?artid=146206319
img: https://bing.ee123.net/img/rand?artid=146206319
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     【python运行Janus-Pro-1B文生图功能】
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="_0">
     </a>
     前言
    </h2>
    <p>
     体验了一把本地部署Janus-Pro-1B实现文生图功能。
    </p>
    <h3>
     <a id="1_3">
     </a>
     1、开源项目下载
    </h3>
    <p>
     <a href="https://github.com/deepseek-ai/Janus/tree/main?tab=readme-ov-file">
      官方开源项目代码直接从Github上下载
     </a>
     。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/8e9615238dd54ad89b058a6782878e8c.png"/>
    </p>
    <h3>
     <a id="2_8">
     </a>
     2、模型下载
    </h3>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/1be86c40a1d3437992d4d029e3018a43.png">
      <br/>
      模型官方下载需要魔法
      <br/>
      Janus-Pro-1B模型文件：
      <a href="https://pan.baidu.com/s/16t4H4z-QZe2UDAg4EF5g3w?pwd=6666" rel="nofollow">
       Janus-Pro-1B模型文件
      </a>
      <br/>
      百度网盘：
      <br/>
      https://pan.baidu.com/s/16t4H4z-QZe2UDAg4EF5g3w?pwd=6666
     </img>
    </p>
    <h3>
     <a id="3_16">
     </a>
     3、将项目代码和模型添加到同一个文件
    </h3>
    <h4>
     <a id="1_17">
     </a>
     1）创建目录存放模型文件
    </h4>
    <p>
     将模型及配置权重文件存放在同一目录下，如Janus-Pro-1B
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/9e64aa94128f4bc182b2a969d04e140e.png"/>
    </p>
    <h4>
     <a id="2_20">
     </a>
     2）将模型目录放到官方开源项目中。
    </h4>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/a86e03d248714755bc8e6327d4ba5e01.png"/>
    </p>
    <h4>
     <a id="3_22">
     </a>
     3）创建虚拟环境
    </h4>
    <p>
     使用如下命令创建虚拟环境:
    </p>
    <blockquote>
     <p>
      myenv\Scripts\activate
     </p>
    </blockquote>
    <h4>
     <a id="4_26">
     </a>
     4）安装所需依赖
    </h4>
    <blockquote>
     <p>
      pip install -r requirements.txt
     </p>
    </blockquote>
    <h4>
     <a id="5__29">
     </a>
     5) 项目内容如下
    </h4>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/f85e43c7de2f4dcdacd1ce8cca096b55.png"/>
    </p>
    <h4>
     <a id="6__app_januspropy_32">
     </a>
     6) 最后运行效果：运行 app_januspro.py
    </h4>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/ce8a5d92007a4c658684c811a8e19fb1.png"/>
    </p>
    <h2>
     <a id="_35">
     </a>
     运行代码
    </h2>
    <pre><code class="prism language-python"><span class="token comment"># 导入必要的库</span>
<span class="token comment"># 用于处理文件和目录路径</span>
<span class="token comment"># 用于图像处理</span>
<span class="token comment"># PyTorch库，用于深度学习模型的构建和训练</span>
<span class="token comment"># 用于数值计算</span>
<span class="token comment"># Hugging Face的Transformers库，用于加载预训练的语言模型</span>
<span class="token comment"># 自定义的多模态因果语言模型和处理器</span>
<span class="token keyword">import</span> os  
<span class="token keyword">import</span> PIL<span class="token punctuation">.</span>Image  
<span class="token keyword">import</span> time
<span class="token keyword">import</span> torch  
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np 
<span class="token keyword">from</span> transformers <span class="token keyword">import</span> AutoModelForCausalLM  
<span class="token keyword">from</span> janus<span class="token punctuation">.</span>models <span class="token keyword">import</span> MultiModalityCausalLM<span class="token punctuation">,</span> VLChatProcessor  
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime 

<span class="token comment"># 打印PyTorch版本和CUDA可用性</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>__version__<span class="token punctuation">)</span>  
<span class="token comment"># 打印当前使用的PyTorch版本</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
<span class="token comment"># 检查CUDA是否可用（即是否可以使用GPU）# 打印当前GPU的显存占pip install Pillow用情况</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"初始显存占用:"</span><span class="token punctuation">,</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>memory_allocated<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1024</span><span class="token operator">**</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"GB"</span><span class="token punctuation">)</span>  

<span class="token comment"># 指定模型路径</span>
<span class="token comment"># model_path = "deepseek-ai/Janus-Pro-1B"  # 禁用此远程路径</span>
<span class="token comment"># 使用本地路径</span>
model_path <span class="token operator">=</span> <span class="token string">"./Janus-Pro-1B"</span>  
<span class="token comment"># 检查模型路径是否存在</span>
<span class="token keyword">assert</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>model_path<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"模型路径不存在！"</span>  
<span class="token comment"># 打印模型路径</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"模型路径：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>model_path<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>  

<span class="token comment"># 加载VLChatProcessor和tokenizer # 加载VLChatProcessor</span>
vl_chat_processor<span class="token punctuation">:</span> VLChatProcessor <span class="token operator">=</span> VLChatProcessor<span class="token punctuation">.</span>from_pretrained<span class="token punctuation">(</span>model_path<span class="token punctuation">)</span>  
 <span class="token comment"># 获取tokenizer，用于将文本编码为模型可以理解的输入格式</span>
tokenizer <span class="token operator">=</span> vl_chat_processor<span class="token punctuation">.</span>tokenizer 

<span class="token comment"># 使用AutoModelForCausalLM加载预训练的多模态因果语言模型</span>
vl_gpt<span class="token punctuation">:</span> MultiModalityCausalLM <span class="token operator">=</span> AutoModelForCausalLM<span class="token punctuation">.</span>from_pretrained<span class="token punctuation">(</span>
    model_path<span class="token punctuation">,</span> trust_remote_code<span class="token operator">=</span><span class="token boolean">True</span>
<span class="token punctuation">)</span>  
<span class="token comment"># 将模型转换为float32精度，并将其移动到GPU上，设置为评估模式</span>
vl_gpt <span class="token operator">=</span> vl_gpt<span class="token punctuation">.</span>to<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  
 <span class="token comment"># 打印加载模型后的显存占用情况</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"加载模型后显存占用:"</span><span class="token punctuation">,</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>memory_allocated<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1024</span><span class="token operator">**</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"GB"</span><span class="token punctuation">)</span> 

<span class="token comment"># 定义对话内容</span>
conversation <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span>
         <span class="token comment"># 用户角色</span>
        <span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"&lt;|User|&gt;"</span><span class="token punctuation">,</span> 
        <span class="token comment"># 用户输入的文本描述</span>
        <span class="token comment">#"content": "long hair,pink lace dress, off-shoulder, high-waist, narrow waist", </span>
        <span class="token comment"># "content": "这是一张极简主义的照片，一个橙色的橘子，有绿色的茎和叶，象征着繁荣，在中国新年期间坐在红色的丝绸布上。捕捉一个充满活力的向日葵盛开的特写镜头，一只蜜蜂栖息在它的花瓣上，它精致的翅膀捕捉阳光。",</span>
        <span class="token comment">#"content": "这是一张古风照片，一个疑似少年的人站在山顶悬崖边上眺望远处的群山，负手而立，少年周身好似仙人气息，山下烟雾缭绕，隐隐约约有几座宫殿。"</span>
        <span class="token comment">#"content":"瓜子脸 + 高额头 + 浓眉 + 大眼睛 + 高鼻梁 + 樱桃小嘴 + 尖下巴 + 白皙皮肤"</span>
        <span class="token comment">#"content":"圆脸 + 宽额头 + 细眉 + 小眼睛 + 塌鼻子 + 厚嘴唇 + 圆下巴 + 黝黑皮肤"</span>
        <span class="token comment">#"content":"方脸 + 窄额头 + 剑眉 + 丹凤眼 + 鹰钩鼻 + 薄嘴唇 + 方下巴 + 粗糙皮肤"</span>
        <span class="token string">"content"</span><span class="token punctuation">:</span><span class="token string">"这是一张单独人物的照片、性别男、青年、面无表情、短发刘海、脸部干净、穿着西装、打着领带、脸型圆润、动漫化"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment"># 助手角色，内容为空</span>
    <span class="token punctuation">{<!-- --></span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"&lt;|Assistant|&gt;"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">}</span><span class="token punctuation">,</span>  
<span class="token punctuation">]</span>

<span class="token comment"># 应用SFT模板生成多轮对话的prompt</span>
<span class="token comment"># 使用VLChatProcessor的apply_sft_template_for_multi_turn_prompts方法将对话内容转换为模型可以理解的格式</span>
sft_format <span class="token operator">=</span> vl_chat_processor<span class="token punctuation">.</span>apply_sft_template_for_multi_turn_prompts<span class="token punctuation">(</span>
      <span class="token comment"># 对话内容</span>
    conversations<span class="token operator">=</span>conversation<span class="token punctuation">,</span>
     <span class="token comment"># SFT模板格式</span>
    sft_format<span class="token operator">=</span>vl_chat_processor<span class="token punctuation">.</span>sft_format<span class="token punctuation">,</span> 
     <span class="token comment"># 系统提示，此处为空</span>
    system_prompt<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">,</span> 
<span class="token punctuation">)</span>  
<span class="token comment"># 在生成的prompt后添加图像生成的起始标记</span>
prompt <span class="token operator">=</span> sft_format <span class="token operator">+</span> vl_chat_processor<span class="token punctuation">.</span>image_start_tag  



img_size <span class="token operator">=</span> <span class="token number">384</span>  <span class="token comment"># 修改图片尺寸384: (1B支持生成最好的尺寸，超过这个会出稀奇古怪的东西)</span>
patch_size <span class="token operator">=</span> <span class="token number">16</span>  <span class="token comment"># 假设 patch_size 是 16</span>
image_token_num_per_image <span class="token operator">=</span> <span class="token punctuation">(</span>img_size <span class="token operator">//</span> patch_size<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span>  <span class="token comment"># 计算 token 数量（** 2平方）</span>
<span class="token comment"># 定义生成函数，用于生成图片</span>
<span class="token comment"># 使用torch.inference_mode()装饰器，以减少内存占用并加速推理过程</span>
<span class="token decorator annotation punctuation">@torch<span class="token punctuation">.</span>inference_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  
<span class="token keyword">def</span> <span class="token function">generate</span><span class="token punctuation">(</span>
    mmgpt<span class="token punctuation">:</span> MultiModalityCausalLM<span class="token punctuation">,</span>           <span class="token comment"># 多模态因果语言模型</span>
    vl_chat_processor<span class="token punctuation">:</span> VLChatProcessor<span class="token punctuation">,</span>     <span class="token comment"># 用于处理输入的处理器</span>
    prompt<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>                            <span class="token comment"># 用户输入的文本描述</span>
    temperature<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>                 <span class="token comment"># 控制生成过程的随机性</span>
    parallel_size<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>                 <span class="token comment"># 一次生成的图片数量</span>
    cfg_weight<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span>                  <span class="token comment"># 分类器自由引导（Classifier-Free Guidance）的权重</span>
    image_token_num_per_image<span class="token operator">=</span>image_token_num_per_image<span class="token punctuation">,</span>   <span class="token comment"># 每张图片生成的token数量 576</span>
    img_size<span class="token operator">=</span>img_size<span class="token punctuation">,</span>                    <span class="token comment"># 生成图片的尺寸384</span>
    patch_size<span class="token operator">=</span> patch_size<span class="token punctuation">,</span>                   <span class="token comment"># 图片的patch大小</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 使用tokenizer将prompt编码为input_ids</span>
    input_ids <span class="token operator">=</span> vl_chat_processor<span class="token punctuation">.</span>tokenizer<span class="token punctuation">.</span>encode<span class="token punctuation">(</span>prompt<span class="token punctuation">)</span>  
     <span class="token comment"># 将input_ids转换为LongTensor</span>
    input_ids <span class="token operator">=</span> torch<span class="token punctuation">.</span>LongTensor<span class="token punctuation">(</span>input_ids<span class="token punctuation">)</span> 

    <span class="token comment"># 初始化tokens，用于生成图片</span>
    tokens <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>parallel_size <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>input_ids<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>  
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>parallel_size <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
         <span class="token comment"># 将input_ids复制到tokens中</span>
        tokens<span class="token punctuation">[</span>i<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">=</span> input_ids 
        <span class="token keyword">if</span> i <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token comment"># 对于非条件tokens，填充pad_id</span>
            tokens<span class="token punctuation">[</span>i<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> vl_chat_processor<span class="token punctuation">.</span>pad_id  

    <span class="token comment"># 获取输入的embeddings  # 将tokens转换为embeddings，作为模型的输入</span>
    inputs_embeds <span class="token operator">=</span> mmgpt<span class="token punctuation">.</span>language_model<span class="token punctuation">.</span>get_input_embeddings<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>tokens<span class="token punctuation">)</span>  

    <span class="token comment"># 初始化生成的tokens  # 初始化用于存储生成图片的tokens</span>
    generated_tokens <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>parallel_size<span class="token punctuation">,</span> image_token_num_per_image<span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span> 

    <span class="token comment"># 记录耗时：开始</span>
    start_time <span class="token operator">=</span> time<span class="token punctuation">.</span>perf_counter<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># 逐步生成图片</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>image_token_num_per_image<span class="token punctuation">)</span><span class="token punctuation">:</span>
        outputs <span class="token operator">=</span> mmgpt<span class="token punctuation">.</span>language_model<span class="token punctuation">.</span>model<span class="token punctuation">(</span>
             <span class="token comment"># 输入的embeddings</span>
            inputs_embeds<span class="token operator">=</span>inputs_embeds<span class="token punctuation">,</span> 
             <span class="token comment"># 使用缓存</span>
            use_cache<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> 
            <span class="token comment"># 使用过去的key-values</span>
            past_key_values<span class="token operator">=</span>outputs<span class="token punctuation">.</span>past_key_values <span class="token keyword">if</span> i <span class="token operator">!=</span> <span class="token number">0</span> <span class="token keyword">else</span> <span class="token boolean">None</span><span class="token punctuation">,</span>  
        <span class="token punctuation">)</span>
        hidden_states <span class="token operator">=</span> outputs<span class="token punctuation">.</span>last_hidden_state  <span class="token comment"># 获取隐藏状态</span>

        <span class="token comment"># 计算logits</span>
        logits <span class="token operator">=</span> mmgpt<span class="token punctuation">.</span>gen_head<span class="token punctuation">(</span>hidden_states<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
         <span class="token comment"># 条件logits</span>
        logit_cond <span class="token operator">=</span> logits<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span> 
         <span class="token comment"># 非条件logits</span>
        logit_uncond <span class="token operator">=</span> logits<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span> 
        <span class="token comment">#  # 应用分类器自由引导（CFG）权重</span>
        logits <span class="token operator">=</span> logit_uncond <span class="token operator">+</span> cfg_weight <span class="token operator">*</span> <span class="token punctuation">(</span>logit_cond <span class="token operator">-</span> logit_uncond<span class="token punctuation">)</span> 
        <span class="token comment"># 计算概率分布</span>
        probs <span class="token operator">=</span> torch<span class="token punctuation">.</span>softmax<span class="token punctuation">(</span>logits <span class="token operator">/</span> temperature<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>  
         <span class="token comment"># 使用torch.multinomial采样下一个token</span>
        next_token <span class="token operator">=</span> torch<span class="token punctuation">.</span>multinomial<span class="token punctuation">(</span>probs<span class="token punctuation">,</span> num_samples<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> 
         <span class="token comment"># 将采样的token存储到generated_tokens中</span>
        generated_tokens<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> i<span class="token punctuation">]</span> <span class="token operator">=</span> next_token<span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> 
        <span class="token comment"># 准备下一个输入的embeddings</span>
        next_token <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>next_token<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> next_token<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> 
         <span class="token comment"># 生成图片的embeddings</span>
        img_embeds <span class="token operator">=</span> mmgpt<span class="token punctuation">.</span>prepare_gen_img_embeds<span class="token punctuation">(</span>next_token<span class="token punctuation">)</span> 
         <span class="token comment"># 更新输入的embeddings</span>
        inputs_embeds <span class="token operator">=</span> img_embeds<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> 
         <span class="token comment"># 打印每一步的显存占用情况</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Step </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>i<span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>image_token_num_per_image<span class="token punctuation">}</span></span><span class="token string"> 显存占用:"</span></span><span class="token punctuation">,</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>memory_allocated<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1024</span><span class="token operator">**</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"GB"</span><span class="token punctuation">)</span> 
    <span class="token comment"># 记录循环结束时间</span>
    end_time <span class="token operator">=</span> time<span class="token punctuation">.</span>perf_counter<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># 计算耗时</span>
    elapsed_time <span class="token operator">=</span> end_time <span class="token operator">-</span> start_time
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"循环耗时: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>elapsed_time<span class="token punctuation">:</span><span class="token format-spec">.6f</span><span class="token punctuation">}</span></span><span class="token string"> 秒"</span></span><span class="token punctuation">)</span>

    <span class="token comment"># 解码生成的tokens为图片</span>
    dec <span class="token operator">=</span> mmgpt<span class="token punctuation">.</span>gen_vision_model<span class="token punctuation">.</span>decode_code<span class="token punctuation">(</span>
        <span class="token comment"># 生成的tokens</span>
        generated_tokens<span class="token punctuation">.</span>to<span class="token punctuation">(</span>dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  
         <span class="token comment"># 图片的形状</span>
        shape<span class="token operator">=</span><span class="token punctuation">[</span>parallel_size<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> img_size <span class="token operator">//</span> patch_size<span class="token punctuation">,</span> img_size <span class="token operator">//</span> patch_size<span class="token punctuation">]</span><span class="token punctuation">,</span> 
    <span class="token punctuation">)</span>
    <span class="token comment"># 将生成的图片转换为numpy数组</span>
    dec <span class="token operator">=</span> dec<span class="token punctuation">.</span>to<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>  

    <span class="token comment"># 对图片进行后处理，将其转换为8位无符号整数格式</span>
    dec <span class="token operator">=</span> np<span class="token punctuation">.</span>clip<span class="token punctuation">(</span><span class="token punctuation">(</span>dec <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span>  
    <span class="token comment"># 初始化用于存储最终图片的数组</span>
    visual_img <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>parallel_size<span class="token punctuation">,</span> img_size<span class="token punctuation">,</span> img_size<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>  
    <span class="token comment"># 将生成的图片存储到visual_img中</span>
    visual_img<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">=</span> dec  
     <span class="token comment"># 创建目录generated_samples</span>
    os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span><span class="token string">'generated_samples'</span><span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span> 
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>parallel_size<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 获取当前本地时间</span>
        now <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 格式化输出</span>
        formatted_time <span class="token operator">=</span> now<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">"%Y%m%d%H%M%S%f"</span><span class="token punctuation">)</span>
         <span class="token comment"># 定义保存路径：生成日期格式</span>
        save_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">'generated_samples'</span><span class="token punctuation">,</span> <span class="token string">"img_{}.jpg"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>formatted_time<span class="token punctuation">)</span><span class="token punctuation">)</span> 
        <span class="token comment"># 保存生成的图片</span>
        PIL<span class="token punctuation">.</span>Image<span class="token punctuation">.</span>fromarray<span class="token punctuation">(</span>visual_img<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>save<span class="token punctuation">(</span>save_path<span class="token punctuation">)</span>  

<span class="token comment"># 调用生成函数生成图片</span>
generate<span class="token punctuation">(</span>
     <span class="token comment"># 多模态因果语言模型</span>
    vl_gpt<span class="token punctuation">,</span> 
    <span class="token comment"># 用于处理输入的处理器</span>
    vl_chat_processor<span class="token punctuation">,</span>  
     <span class="token comment"># 用户输入的文本描述</span>
    prompt<span class="token punctuation">,</span> 
<span class="token punctuation">)</span>
</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f34333632363231382f:61727469636c652f64657461696c732f313436323036333139" class_="artid" style="display:none">
 </p>
</div>


