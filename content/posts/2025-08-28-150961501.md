---
layout: post
title: "MapStructç”¨æ³•å’Œå®è·µ"
date: 2025-08-28T20:29:31+0800
description: "MapStructç”¨æ³•å’Œå®è·µ"
keywords: "MapStructç”¨æ³•å’Œå®è·µ"
categories: ['Springboot', 'Java']
tags: ['Java']
artid: "150961501"
arturl: "https://blog.csdn.net/m0_50742275/article/details/150961501"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=150961501
    alt: "MapStructç”¨æ³•å’Œå®è·µ"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=150961501
featuredImagePreview: https://bing.ee123.net/img/rand?artid=150961501
cover: https://bing.ee123.net/img/rand?artid=150961501
image: https://bing.ee123.net/img/rand?artid=150961501
img: https://bing.ee123.net/img/rand?artid=150961501
---



# MapStructç”¨æ³•å’Œå®è·µ



### ä¸€ã€MapStruct ç”¨æ³•

#### 1.Â **åµŒå¥—å¯¹è±¡æ·±åº¦æ˜ å°„ï¼ˆDeep Mappingï¼‰**

```

// æºå¯¹è±¡
public class User {
    private Address address;
    // getter/setter
}

public class Address {
    private String city;
    private String street;
}

// ç›®æ ‡å¯¹è±¡
public class UserDTO {
    private String city;      // ç›´æ¥æ˜ å°„ user.address.city
    private String fullAddr;  // user.address.city + street
}

@Mapper
public interface UserMapper {
    @Mapping(target = "city", source = "address.city")
    @Mapping(target = "fullAddr", source = "address")
    UserDTO toDTO(User user);

    // è‡ªå®šä¹‰ç»„åˆé€»è¾‘
    default String addressToFullAddr(Address address) {
        if (address == null) return null;
        return (address.getCity() != null ? address.getCity() : "") + " " +
               (address.getStreet() != null ? address.getStreet() : "");
    }
}
```

> âœ… è‡ªåŠ¨ç”Ÿæˆï¼š
>
> ```
>
> dto.setCity(user.getAddress().getCity());
> dto.setFullAddr(addressToFullAddr(user.getAddress()));
> ```

---

#### 2.Â **é›†åˆæ˜ å°„ï¼ˆList/Set/Map â†” List/Set/Mapï¼‰**

```

@Mapper
public interface OrderMapper {
    List<OrderDTO> toDTOs(List<Order> orders);
    Set<ProductDTO> toProductDTOs(Set<Product> products);
    Map<String, String> toStringMap(Map<String, Object> map); // éœ€è‡ªå®šä¹‰è½¬æ¢
}
```

> âœ… è‡ªåŠ¨ç”Ÿæˆéå†é€»è¾‘ï¼Œæ— éœ€æ‰‹åŠ¨ `stream().map().collect()`ã€‚

##### è‡ªå®šä¹‰é›†åˆå…ƒç´ è½¬æ¢ï¼š

```

@Mapper(uses = CustomConverters.class)
public interface OrderMapper {
    List<OrderSummaryDTO> toSummaries(List<Order> orders);
}

@Component
public class CustomConverters {
    public String formatAmount(BigDecimal amount) {
        return amount == null ? "0.00" : amount.setScale(2).toString();
    }
}
```

---

#### 3.Â **åŒå‘æ˜ å°„ï¼ˆBidirectional Mappingï¼‰**

```

@Mapper
public interface UserMapper {

    // æ­£å‘
    @Mapping(target = "birthDate", dateFormat = "yyyy-MM-dd")
    UserDTO toDTO(User user);

    // åå‘ï¼ˆè‡ªåŠ¨æ¨æ–­ï¼‰
    @InheritInverseConfiguration
    @Mapping(target = "id", ignore = true) // åˆ›å»ºæ—¶å¿½ç•¥ ID
    User fromDTO(UserDTO dto);
}
```

> ğŸ” `@InheritInverseConfiguration` è‡ªåŠ¨ç»§æ‰¿æ­£å‘é…ç½®ï¼Œåå‘æ˜ å°„ã€‚

---

#### 4.Â **æ›´æ–°ç°æœ‰å¯¹è±¡ï¼ˆUpdate Mappingï¼‰**

å¸¸ç”¨äº `PUT`/`PATCH` æ¥å£æ›´æ–°å®ä½“ã€‚

```

@Mapper
public interface UserMapper {
    @BeanMapping(nullValuePropertyMappingStrategy = NullValuePropertyMappingStrategy.IGNORE)
    void updateUser(@MappingTarget User user, UserDTO dto);
}
```

> âœ… ä»…æ‹·è´é null å­—æ®µï¼Œé¿å…è¦†ç›–åŸæœ‰å€¼ã€‚

---

#### 5.Â **æ¡ä»¶æ˜ å°„ï¼ˆConditional Mappingï¼‰**

```

@Mapper
public interface UserMapper {
    @Mapping(target = "status", source = "status", qualifiedByName = "statusToCode")
    UserDTO toDTO(User user);

    @Named("statusToCode")
    default String mapStatus(UserStatus status) {
        if (status == null) return null;
        return switch (status) {
            case ACTIVE -> "A";
            case INACTIVE -> "I";
            default -> "U";
        };
    }
}
```

> âœ… `qualifiedByName` æŒ‡å®šä½¿ç”¨å“ªä¸ªè‡ªå®šä¹‰æ–¹æ³•ã€‚

---

#### 6.Â **å¤šæºæ˜ å°„ï¼ˆMulti-Source Mappingï¼‰**

```

@Mapper
public interface UserDetailMapper {
    @Mapping(target = "userName", source = "user.name")
    @Mapping(target = "roleName", source = "role.name")
    @Mapping(target = "deptName", source = "dept.title")
    UserDetailDTO toDTO(User user, Role role, Department dept);
}
```

> âœ… é€‚ç”¨äº VO èšåˆå¤šä¸ª Entity çš„åœºæ™¯ã€‚

---

#### 7.Â **Map ä¸ Object æ˜ å°„**

```

@Mapper
public interface ConfigMapper {
    @MapMapping
    Map<String, String> toStringMap(Config config);

    @MapMapping
    Config toConfig(Map<String, String> map);
}
```

> âœ… è‡ªåŠ¨ç”Ÿæˆ `get/set` æ˜ å°„ã€‚

---

#### 8.Â **Builder æ¨¡å¼æ”¯æŒï¼ˆLombok @Builderï¼‰**

```

@Mapper(builder = @Builder(disableBuilder = false))
public interface UserMapper {
    UserDTO toDTO(User user); // è‡ªåŠ¨è°ƒç”¨ UserDTO.builder().name(...).build()
}
```

> âœ… æ”¯æŒä¸å¯å˜å¯¹è±¡æ„å»ºã€‚

---

#### 9.Â **æ³›å‹æ˜ å°„ï¼ˆGeneric Mappingï¼‰**

```

@Mapper
public interface GenericMapper {
    <T, R> List<R> mapList(List<T> source, Class<R> targetClass);
}
```

> âš ï¸ æ³›å‹æ“¦é™¤é—®é¢˜ï¼šéœ€åœ¨è¿è¡Œæ—¶ä¼ å…¥ `Class` å¯¹è±¡ã€‚

---

#### 10.Â **ç”Ÿå‘½å‘¨æœŸå›è°ƒï¼ˆLifecycle Callbacksï¼‰**

```

@Mapper
public abstract class UserMapper {

    @BeforeMapping
    protected void before(User user, @MappingTarget UserDTO dto) {
        System.out.println("å¼€å§‹æ˜ å°„: " + user.getId());
    }

    @AfterMapping
    protected void after(@MappingSource User user, @MappingTarget UserDTO dto) {
        dto.setAgeGroup(calculateAgeGroup(user.getAge()));
    }

    public abstract UserDTO toDTO(User user);

    private String calculateAgeGroup(int age) {
        return age < 18 ? "CHILD" : age < 60 ? "ADULT" : "SENIOR";
    }
}
```

> âœ… é€‚ç”¨äºå®¡è®¡ã€æ—¥å¿—ã€åå¤„ç†é€»è¾‘ã€‚

---

### äºŒã€MapStruct ä¸ DDDï¼ˆé¢†åŸŸé©±åŠ¨è®¾è®¡ï¼‰èåˆå®è·µ

#### 1.Â **å®ä½“ â†” DTO è½¬æ¢åˆ†å±‚è®¾è®¡**

```

Web Layer:     OrderRequest  â†’ OrderDTO
Application:   OrderDTO     â†’ Command
Domain:        Command      â†’ Order (Entity)
Persistence:   Order        â†’ OrderEntity (JPA)
```

##### æ˜ å°„å±‚åˆ’åˆ†ï¼š

* `WebMapper`ï¼šRequest/Response â†” DTO
* `ApplicationMapper`ï¼šDTO â†” Command/Event
* `PersistenceMapper`ï¼šEntity â†” JPA Entity

```

@Mapper(componentModel = "spring")
public interface WebOrderMapper {
    @Mapping(target = "customerId", source = "customer.id")
    OrderDTO toDTO(CreateOrderRequest request);
}
```

---

#### 2.Â **å€¼å¯¹è±¡ï¼ˆValue Objectï¼‰æ˜ å°„**

```

public class Address {
    private String street;
    private String city;
    // ä¸å¯å˜
}

@Mapper
public interface AddressMapper {
    @Mapping(target = "street", source = "street")
    @Mapping(target = "city", source = "city")
    Address createAddress(String street, String city);
}
```

> âœ… ä½¿ç”¨ `@Context` æˆ–å·¥å‚æ–¹æ³•åˆ›å»º VOã€‚

### ä¸‰ã€MapStruct ä¼ä¸šçº§é…ç½®ä¸æœ€ä½³å®è·µ

#### 1.Â **å…¨å±€é…ç½®ï¼ˆ@MapperConfigï¼‰**

```

@MapperConfig(
    componentModel = "spring",
    nullValuePropertyMappingStrategy = NullValuePropertyMappingStrategy.IGNORE,
    nullValueCheckStrategy = NullValueCheckStrategy.ALWAYS,
    unmappedTargetPolicy = ReportingPolicy.WARN,
    uses = { DateMapper.class, CustomConverters.class }
)
public class BaseMappingConfig {}
```

> ç„¶åæ‰€æœ‰ Mapper ç»§æ‰¿ï¼š
>
> ```
>
> @Mapper(config = BaseMappingConfig.class)
> public interface UserMapper { ... }
> ```

---

#### 2.Â **Spring é›†æˆï¼ˆæ¨èæ–¹å¼ï¼‰**

```

@Mapper(componentModel = "spring")
public interface UserMapper {
    UserDTO toDTO(User user);
}
```

> âœ… è‡ªåŠ¨ç”Ÿæˆ Spring Beanï¼Œå¯ç›´æ¥ `@Autowired`ã€‚

---

#### 3.Â **é”™è¯¯ç­–ç•¥é…ç½®**

```

@Mapper(unmappedTargetPolicy = ReportingPolicy.ERROR)
public interface UserMapper { ... }
```

* `IGNORE`ï¼šå¿½ç•¥æœªæ˜ å°„å­—æ®µï¼ˆé»˜è®¤ï¼‰
* `WARN`ï¼šç¼–è¯‘è­¦å‘Š
* `ERROR`ï¼šç¼–è¯‘æŠ¥é”™ï¼ˆæ¨èç”¨äºç”Ÿäº§ï¼‰

---

#### 4.Â **ç©ºå€¼å¤„ç†ç­–ç•¥**

| ç­–ç•¥ | è¯´æ˜ |
| --- | --- |
| `NullValuePropertyMappingStrategy.SET_TO_NULL` | æºä¸º null æ—¶ï¼Œç›®æ ‡ä¹Ÿè®¾ä¸º null |
| `IGNORE` | å¿½ç•¥ null å€¼ï¼ˆå¸¸ç”¨äºæ›´æ–°ï¼‰ |
| `SET_TO_DEFAULT` | è®¾ä¸ºé»˜è®¤å€¼ï¼ˆå¦‚ 0, falseï¼‰ |

---

### å››ã€MapStruct ä¸ä¸»æµæ¡†æ¶é›†æˆ

#### 1.Â **Spring Bootï¼ˆæ¨è starterï¼‰**

```

<dependency>
    <groupId>org.mapstruct</groupId>
    <artifactId>mapstruct-spring-extensions</artifactId>
    <version>1.0.0.CR1</version>
</dependency>
```

æ”¯æŒ `@Mapper SpringBean` è‡ªåŠ¨æ³¨å…¥ã€‚

---

#### 2.Â **Lombok é›†æˆï¼ˆé¿å…å†²çªï¼‰**

##### é—®é¢˜ï¼šLombok å’Œ MapStruct éƒ½æ˜¯ APTï¼Œå¤„ç†é¡ºåºå†²çªã€‚

##### è§£å†³æ–¹æ¡ˆ 1ï¼šMaven é…ç½® processor é¡ºåº

```

<plugin>
    <groupId>org.apache.maven.plugins</groupId>
    <artifactId>maven-compiler-plugin</artifactId>
    <configuration>
        <annotationProcessorPaths>
            <path>
                <groupId>org.projectlombok</groupId>
                <artifactId>lombok</artifactId>
                <version>${lombok.version}</version>
            </path>
            <path>
                <groupId>org.mapstruct</groupId>
                <artifactId>mapstruct-processor</artifactId>
                <version>${mapstruct.version}</version>
            </path>
        </annotationProcessorPaths>
    </configuration>
</plugin>
```

##### è§£å†³æ–¹æ¡ˆ 2ï¼šä½¿ç”¨Â `lombok.config`

```

# lombok.config
lombok.addLombokGeneratedAnnotation = true
```

---

#### 3.Â **Quarkus / GraalVM åŸç”Ÿé•œåƒ**

* MapStruct ç”Ÿæˆçš„ä»£ç æ— åå°„ï¼Œ**å¤©ç„¶æ”¯æŒåŸç”Ÿç¼–è¯‘**ã€‚
* æ— éœ€é¢å¤–é…ç½®åå°„è§„åˆ™ã€‚

---

### äº”ã€MapStruct è°ƒè¯•ä¸é—®é¢˜æ’æŸ¥

#### 1.Â **æŸ¥çœ‹ç”Ÿæˆçš„ä»£ç **

* Maven é¡¹ç›®ï¼š`target/generated-sources/annotations/`
* æ‰‹åŠ¨ç¼–è¯‘ï¼š`-s`Â æŒ‡å®šç”Ÿæˆç›®å½•

#### 2.Â **å¸¸è§ç¼–è¯‘é”™è¯¯**

| é”™è¯¯ | åŸå›  | è§£å†³ |
| --- | --- | --- |
| `Can't map property ...` | å­—æ®µä¸å­˜åœ¨æˆ–ç±»å‹ä¸åŒ¹é… | ä½¿ç”¨Â `@Mapping(ignore=true)`Â æˆ–è‡ªå®šä¹‰è½¬æ¢ |
| `Ambiguous mapping methods` | å¤šä¸ªè½¬æ¢æ–¹æ³•åŒ¹é… | ä½¿ç”¨Â `@Named`Â +Â `qualifiedByName` |
| `No property named ...` | æ‹¼å†™é”™è¯¯ | æ£€æŸ¥ getter/setter |

---

### å…­ã€MapStruct æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **å¤ç”¨ Mapper å®ä¾‹**ï¼ˆSpring Beanï¼‰
2. **é¿å…åœ¨å¾ªç¯ä¸­åˆ›å»º Mapper**ï¼ˆ`Mappers.getMapper()`Â æœ‰åå°„å¼€é”€ï¼‰
3. **ä½¿ç”¨Â `@InheritConfiguration`Â å‡å°‘é‡å¤é…ç½®**
4. **ç¦ç”¨ä¸å¿…è¦çš„ç©ºå€¼æ£€æŸ¥**ï¼ˆå¦‚å·²çŸ¥éç©ºï¼‰

---

### ä¸ƒã€çœŸå®ä¼ä¸šæ¶æ„æ¡ˆä¾‹

#### åœºæ™¯ï¼šç”µå•†å¹³å°è®¢å•è¯¦æƒ…èšåˆ

```

@Mapper(uses = {DateMapper.class, PriceFormatter.class})
public interface OrderDetailMapper {

    @Mapping(target = "customerName", source = "customer.name")
    @Mapping(target = "productName", source = "product.name")
    @Mapping(target = "totalPrice", source = "order.total", qualifiedByName = "formatPrice")
    @Mapping(target = "items", source = "orderItems")
    OrderDetailView toView(Order order, Customer customer, Product product);

    List<OrderItemDTO> toItemDTOs(List<OrderItem> items);
}
```

> âœ… ä¸€è¡Œä»£ç èšåˆä¸‰ä¸ªæœåŠ¡çš„æ•°æ®ã€‚

---

### å…«ã€æ€»ç»“ï¼šMapStruct ä½¿ç”¨ checklist

âœ… æ˜¯å¦ä½¿ç”¨ `@Mapper(componentModel = "spring")`ï¼Ÿ  
âœ… æ˜¯å¦é…ç½® `unmappedTargetPolicy = ERROR`ï¼Ÿ  
âœ… æ˜¯å¦ä½¿ç”¨ `@InheritInverseConfiguration` å‡å°‘é‡å¤ï¼Ÿ  
âœ… æ˜¯å¦é¿å…åœ¨å¾ªç¯ä¸­è°ƒç”¨ `Mappers.getMapper()`ï¼Ÿ  
âœ… æ˜¯å¦ä¸ºæ—¥æœŸã€æšä¸¾ç­‰é…ç½®äº†è‡ªå®šä¹‰è½¬æ¢å™¨ï¼Ÿ  
âœ… æ˜¯å¦åœ¨ `pom.xml` æ­£ç¡®é…ç½®äº† annotationProcessorPathsï¼Ÿ  
âœ… æ˜¯å¦æ£€æŸ¥äº†ç”Ÿæˆçš„ä»£ç æ˜¯å¦ç¬¦åˆé¢„æœŸï¼Ÿ

---

### ä¹ã€é™„å½•ï¼šMapStruct å¸¸ç”¨æ³¨è§£é€ŸæŸ¥è¡¨

| æ³¨è§£ | ç”¨é€” |
| --- | --- |
| `@Mapper` | å®šä¹‰æ˜ å°„æ¥å£ |
| `@Mapping` | å­—æ®µçº§æ˜ å°„é…ç½® |
| `@Mappings` | å¤šä¸ªÂ `@Mapping` |
| `@InheritConfiguration` | ç»§æ‰¿é…ç½® |
| `@InheritInverseConfiguration` | åå‘ç»§æ‰¿ |
| `@BeanMapping` | æ–¹æ³•çº§é…ç½®ï¼ˆå¦‚ null ç­–ç•¥ï¼‰ |
| `@AfterMapping`Â /Â `@BeforeMapping` | ç”Ÿå‘½å‘¨æœŸå›è°ƒ |
| `@Context` | ä¼ é€’ä¸Šä¸‹æ–‡å¯¹è±¡ |
| `@Named` | æ ‡è®°è½¬æ¢æ–¹æ³• |
| `@Qualifier` | è‡ªå®šä¹‰é™å®šç¬¦ |

---



