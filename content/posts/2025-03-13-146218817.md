---
layout: post
title: "django中间件说明"
date: 2025-03-13 00:34:39 +0800
description: "编写中间件类\"\"\"记录请求日志的中间件\"\"\"# 请求处理前。"
keywords: "django中间件说明"
categories: ['Django']
tags: ['中间件', 'Python', 'Django']
artid: "146218817"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146218817
    alt: "django中间件说明"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146218817
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146218817
cover: https://bing.ee123.net/img/rand?artid=146218817
image: https://bing.ee123.net/img/rand?artid=146218817
img: https://bing.ee123.net/img/rand?artid=146218817
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     django中间件说明
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-tomorrow-night" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     Django中间件是一种在请求和响应处理过程中介入的机制，允许你在视图处理请求之前或之后执行自定义代码。中间件适用于处理全局性任务，如身份验证、日志记录、内容修改等。以下是Django中间件的详细说明和使用方法：
    </p>
    <hr/>
    <h4>
     <a id="_6">
     </a>
     一、中间件的核心概念
    </h4>
    <ol>
     <li>
      <p>
       <strong>
        作用阶段
       </strong>
       ：
       <br/>
       •
       <strong>
        请求阶段
       </strong>
       ：在路由到视图之前处理请求（如身份验证）。
       <br/>
       •
       <strong>
        视图阶段
       </strong>
       ：在调用视图前后执行操作（如权限检查）。
       <br/>
       •
       <strong>
        响应阶段
       </strong>
       ：在返回响应前修改内容（如添加HTTP头）。
       <br/>
       •
       <strong>
        异常阶段
       </strong>
       ：处理视图或中间件抛出的异常（如统一错误处理）。
      </p>
     </li>
     <li>
      <p>
       <strong>
        中间件类方法
       </strong>
       ：
       <br/>
       •
       <code>
        process_request(request)
       </code>
       : 在路由到视图前调用。
       <br/>
       •
       <code>
        process_view(request, view_func, view_args, view_kwargs)
       </code>
       : 在视图被调用前执行。
       <br/>
       •
       <code>
        process_response(request, response)
       </code>
       : 在所有响应返回前处理。
       <br/>
       •
       <code>
        process_exception(request, exception)
       </code>
       : 处理视图抛出的异常。
       <br/>
       •
       <code>
        process_template_response(request, response)
       </code>
       : 处理模板响应（如修改上下文）。
      </p>
     </li>
    </ol>
    <hr/>
    <h4>
     <a id="_22">
     </a>
     二、创建自定义中间件
    </h4>
    <h5>
     <a id="1__23">
     </a>
     1.
     <strong>
      编写中间件类
     </strong>
    </h5>
    <pre><code class="prism language-python"><span class="token comment"># myapp/middleware/custom_middleware.py</span>
<span class="token keyword">import</span> logging
<span class="token keyword">from</span> django<span class="token punctuation">.</span>http <span class="token keyword">import</span> HttpResponseForbidden

logger <span class="token operator">=</span> logging<span class="token punctuation">.</span>getLogger<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">SimpleLoggingMiddleware</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""记录请求日志的中间件"""</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> get_response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>get_response <span class="token operator">=</span> get_response

    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 请求处理前</span>
        logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Request started: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>request<span class="token punctuation">.</span>method<span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>request<span class="token punctuation">.</span>path<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

        response <span class="token operator">=</span> self<span class="token punctuation">.</span>get_response<span class="token punctuation">(</span>request<span class="token punctuation">)</span>  <span class="token comment"># 继续处理链</span>

        <span class="token comment"># 响应处理后</span>
        logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Request finished: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>request<span class="token punctuation">.</span>method<span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>request<span class="token punctuation">.</span>path<span class="token punctuation">}</span></span><span class="token string"> → </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>response<span class="token punctuation">.</span>status_code<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> response

<span class="token keyword">class</span> <span class="token class-name">IPFilterMiddleware</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""过滤非法IP的中间件"""</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> get_response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>get_response <span class="token operator">=</span> get_response
        self<span class="token punctuation">.</span>allowed_ips <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span> <span class="token string">'192.168.1.0/24'</span><span class="token punctuation">]</span>  <span class="token comment"># 允许的IP或网段</span>

    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
        client_ip <span class="token operator">=</span> request<span class="token punctuation">.</span>META<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'REMOTE_ADDR'</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>_is_ip_allowed<span class="token punctuation">(</span>client_ip<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> HttpResponseForbidden<span class="token punctuation">(</span><span class="token string">"IP地址被禁止访问"</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>get_response<span class="token punctuation">(</span>request<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">_is_ip_allowed</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ip<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 简单示例：实际可能需要更复杂的IP检查逻辑</span>
        <span class="token keyword">return</span> ip <span class="token keyword">in</span> self<span class="token punctuation">.</span>allowed_ips
</code></pre>
    <h5>
     <a id="2__63">
     </a>
     2.
     <strong>
      配置中间件
     </strong>
    </h5>
    <p>
     在
     <code>
      settings.py
     </code>
     的
     <code>
      MIDDLEWARE
     </code>
     列表中注册中间件：
    </p>
    <pre><code class="prism language-python"><span class="token comment"># settings.py</span>
MIDDLEWARE <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">'django.middleware.security.SecurityMiddleware'</span><span class="token punctuation">,</span>
    <span class="token string">'django.contrib.sessions.middleware.SessionMiddleware'</span><span class="token punctuation">,</span>
    <span class="token string">'django.middleware.common.CommonMiddleware'</span><span class="token punctuation">,</span>
    <span class="token string">'django.middleware.csrf.CsrfViewMiddleware'</span><span class="token punctuation">,</span>
    <span class="token string">'myapp.middleware.custom_middleware.SimpleLoggingMiddleware'</span><span class="token punctuation">,</span>  <span class="token comment"># 自定义中间件</span>
    <span class="token string">'myapp.middleware.custom_middleware.IPFilterMiddleware'</span><span class="token punctuation">,</span>       <span class="token comment"># 另一个中间件</span>
<span class="token punctuation">]</span>
</code></pre>
    <p>
     <strong>
      执行顺序
     </strong>
     ：
     <br/>
     • 中间件按列表顺序从上到下处理请求（
     <code>
      process_request
     </code>
     ）。
     <br/>
     • 响应阶段按从下到上的顺序处理（
     <code>
      process_response
     </code>
     ）。
    </p>
    <hr/>
    <h4>
     <a id="_83">
     </a>
     三、中间件的常见应用场景
    </h4>
    <h5>
     <a id="1__84">
     </a>
     1.
     <strong>
      请求日志记录
     </strong>
    </h5>
    <p>
     记录每个请求的路径、方法、耗时等信息：
    </p>
    <pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">RequestTimingMiddleware</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> get_response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>get_response <span class="token operator">=</span> get_response

    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
        start_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
        response <span class="token operator">=</span> self<span class="token punctuation">.</span>get_response<span class="token punctuation">(</span>request<span class="token punctuation">)</span>
        duration <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start_time
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Request to </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>request<span class="token punctuation">.</span>path<span class="token punctuation">}</span></span><span class="token string"> took </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>duration<span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string"> seconds"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> response
</code></pre>
    <h5>
     <a id="2__99">
     </a>
     2.
     <strong>
      用户认证增强
     </strong>
    </h5>
    <p>
     检查特定Header或Token：
    </p>
    <pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">APITokenMiddleware</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> get_response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>get_response <span class="token operator">=</span> get_response

    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> request<span class="token punctuation">.</span>user<span class="token punctuation">.</span>is_authenticated<span class="token punctuation">:</span>
            token <span class="token operator">=</span> request<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'Authorization'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'Bearer '</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
            <span class="token keyword">if</span> token <span class="token operator">==</span> <span class="token string">'SECRET_API_KEY'</span><span class="token punctuation">:</span>
                <span class="token comment"># 模拟用户登录（示例逻辑）</span>
                request<span class="token punctuation">.</span>user <span class="token operator">=</span> get_user_model<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span>username<span class="token operator">=</span><span class="token string">'api_user'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>get_response<span class="token punctuation">(</span>request<span class="token punctuation">)</span>
</code></pre>
    <h5>
     <a id="3_CORS_115">
     </a>
     3.
     <strong>
      跨域请求处理（CORS）
     </strong>
    </h5>
    <p>
     手动添加CORS头（或使用第三方库如
     <code>
      django-cors-headers
     </code>
     ）：
    </p>
    <pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">CustomCorsMiddleware</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> get_response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>get_response <span class="token operator">=</span> get_response

    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
        response <span class="token operator">=</span> self<span class="token punctuation">.</span>get_response<span class="token punctuation">(</span>request<span class="token punctuation">)</span>
        response<span class="token punctuation">[</span><span class="token string">'Access-Control-Allow-Origin'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'*'</span>
        response<span class="token punctuation">[</span><span class="token string">'Access-Control-Allow-Methods'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'GET, POST, OPTIONS'</span>
        response<span class="token punctuation">[</span><span class="token string">'Access-Control-Allow-Headers'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'Content-Type'</span>
        <span class="token keyword">return</span> response
</code></pre>
    <h5>
     <a id="4__130">
     </a>
     4.
     <strong>
      响应内容修改
     </strong>
    </h5>
    <p>
     压缩响应或替换敏感信息：
    </p>
    <pre><code class="prism language-python"><span class="token keyword">import</span> gzip

<span class="token keyword">class</span> <span class="token class-name">GzipResponseMiddleware</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> get_response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>get_response <span class="token operator">=</span> get_response

    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
        response <span class="token operator">=</span> self<span class="token punctuation">.</span>get_response<span class="token punctuation">(</span>request<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token string">'gzip'</span> <span class="token keyword">in</span> request<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'Accept-Encoding'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            response<span class="token punctuation">.</span>content <span class="token operator">=</span> gzip<span class="token punctuation">.</span>compress<span class="token punctuation">(</span>response<span class="token punctuation">.</span>content<span class="token punctuation">)</span>
            response<span class="token punctuation">[</span><span class="token string">'Content-Encoding'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'gzip'</span>
        <span class="token keyword">return</span> response
</code></pre>
    <hr/>
    <h4>
     <a id="_149">
     </a>
     四、中间件的注意事项
    </h4>
    <ol>
     <li>
      <p>
       <strong>
        性能影响
       </strong>
       ：
       <br/>
       • 避免在中间件中执行耗时操作（如数据库查询），否则会拖慢所有请求。
       <br/>
       • 使用缓存优化频繁访问的数据（如用户权限信息）。
      </p>
     </li>
     <li>
      <p>
       <strong>
        异常处理
       </strong>
       ：
       <br/>
       • 在
       <code>
        process_exception
       </code>
       中捕获异常时，需返回
       <code>
        None
       </code>
       以继续传递异常。
       <br/>
       • 生产环境中应记录错误日志而非暴露堆栈信息。
      </p>
     </li>
     <li>
      <p>
       <strong>
        中间件顺序
       </strong>
       ：
       <br/>
       • 安全中间件（如
       <code>
        SecurityMiddleware
       </code>
       ）通常应放在最前面。
       <br/>
       • 依赖其他中间件的组件（如
       <code>
        SessionMiddleware
       </code>
       需在认证中间件之前）。
      </p>
     </li>
     <li>
      <p>
       <strong>
        测试中间件
       </strong>
       ：
       <br/>
       • 使用Django测试客户端模拟请求，验证中间件行为：
      </p>
      <pre><code class="prism language-python"><span class="token keyword">from</span> django<span class="token punctuation">.</span>test <span class="token keyword">import</span> RequestFactory<span class="token punctuation">,</span> TestCase

<span class="token keyword">class</span> <span class="token class-name">TestMiddleware</span><span class="token punctuation">(</span>TestCase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">test_ip_filter</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        factory <span class="token operator">=</span> RequestFactory<span class="token punctuation">(</span><span class="token punctuation">)</span>
        request <span class="token operator">=</span> factory<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> REMOTE_ADDR<span class="token operator">=</span><span class="token string">'192.168.1.5'</span><span class="token punctuation">)</span>
        middleware <span class="token operator">=</span> IPFilterMiddleware<span class="token punctuation">(</span><span class="token keyword">lambda</span> r<span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
        response <span class="token operator">=</span> middleware<span class="token punctuation">(</span>request<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>response<span class="token punctuation">.</span>status_code<span class="token punctuation">,</span> <span class="token number">403</span><span class="token punctuation">)</span>  <span class="token comment"># 假设该IP被禁止</span>
</code></pre>
     </li>
    </ol>
    <hr/>
    <h4>
     <a id="_178">
     </a>
     五、中间件与其他组件的对比
    </h4>
    <table>
     <thead>
      <tr>
       <th>
        组件
       </th>
       <th>
        用途
       </th>
       <th>
        作用范围
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        <strong>
         中间件
        </strong>
       </td>
       <td>
        全局请求/响应处理（如日志、认证）
       </td>
       <td>
        所有HTTP请求
       </td>
      </tr>
      <tr>
       <td>
        <strong>
         信号（Signal）
        </strong>
       </td>
       <td>
        响应特定事件（如保存模型后触发操作）
       </td>
       <td>
        应用内部事件
       </td>
      </tr>
      <tr>
       <td>
        <strong>
         上下文处理器
        </strong>
       </td>
       <td>
        向模板添加全局变量（如当前用户）
       </td>
       <td>
        模板渲染阶段
       </td>
      </tr>
     </tbody>
    </table>
    <hr/>
    <h4>
     <a id="_187">
     </a>
     六、总结
    </h4>
    <p>
     Django中间件是处理HTTP请求和响应流程的核心机制，适用于以下场景：
     <br/>
     •
     <strong>
      全局功能
     </strong>
     ：如日志、IP过滤、性能监控。
     <br/>
     •
     <strong>
      请求预处理
     </strong>
     ：用户认证、数据解析。
     <br/>
     •
     <strong>
      响应后处理
     </strong>
     ：修改响应头、压缩内容。
     <br/>
     •
     <strong>
      异常统一处理
     </strong>
     ：记录错误、返回友好提示。
    </p>
    <p>
     通过合理设计中间件，可以解耦代码并增强应用的可维护性。但需谨慎设计以避免性能瓶颈和逻辑混乱。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470:733a2f2f626c6f672e6373646e2e6e65742f4c43593133332f:61727469636c652f64657461696c732f313436323138383137" class_="artid" style="display:none">
 </p>
</div>


