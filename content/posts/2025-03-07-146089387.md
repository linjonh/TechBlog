---
layout: post
title: "doris-SQL-Server"
date: 2025-03-07 10:39:20 +0800
description: "doris: sqlserver"
keywords: "doris: SQL Server"
categories: ['大数据']
tags: ['Doris']
artid: "146089387"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146089387
    alt: "doris-SQL-Server"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146089387
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146089387
cover: https://bing.ee123.net/img/rand?artid=146089387
image: https://bing.ee123.net/img/rand?artid=146089387
img: https://bing.ee123.net/img/rand?artid=146089387
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     doris: SQL Server
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="./../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="./../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <p>
     Doris JDBC Catalog 支持通过标准 JDBC 接口连接 SQL Server 数据库。本文档介绍如何配置 SQL Server 数据库连接。
    </p>
    <h3 id="使用须知">
     使用须知
     <a href="https://doris.apache.org/zh-CN/docs/lakehouse/database/sqlserver#%E4%BD%BF%E7%94%A8%E9%A1%BB%E7%9F%A5" rel="nofollow" title="​">
      ​
     </a>
    </h3>
    <p>
     要连接到 SQL Server 数据库，您需要
    </p>
    <ul>
     <li>
      <p>
       SQL Server 2012 或更高版本，或 Azure SQL 数据库。
      </p>
     </li>
     <li>
      <p>
       SQL Server 数据库的 JDBC 驱动程序，您可以从
       <a href="https://mvnrepository.com/artifact/com.microsoft.sqlserver/mssql-jdbc" rel="nofollow" title="Maven 仓库">
        Maven 仓库
       </a>
       下载最新或指定版本的 SQL Server JDBC 驱动程序。
       <strong>
        推荐使用 SQL Server JDBC Driver 11.2.x 及以上版本。
       </strong>
      </p>
     </li>
     <li>
      <p>
       Doris 每个 FE 和 BE 节点和 SQL Server 服务器之间的网络连接，默认端口为 1433。
      </p>
     </li>
    </ul>
    <h3 id="连接-sql-server">
     连接 SQL Server
     <a href="https://doris.apache.org/zh-CN/docs/lakehouse/database/sqlserver#%E8%BF%9E%E6%8E%A5-sql-server" rel="nofollow" title="​">
      ​
     </a>
    </h3>
    <pre><code>CREATE CATALOG sqlserver PROPERTIES (
    "type"="jdbc",
    "user"="root",
    "password"="secret",
    "jdbc_url" = "jdbc:sqlserver://&lt;host&gt;:&lt;port&gt;;databaseName=&lt;databaseName&gt;;encrypt=false",
    "driver_url" = "mssql-jdbc-11.2.3.jre8.jar",
    "driver_class" = "com.microsoft.sqlserver.jdbc.SQLServerDriver"
)
</code></pre>
    <p>
    </p>
    <p>
     备注
    </p>
    <p>
     <code>
      jdbc_url
     </code>
     定义要传递给 SQL Server JDBC 驱动程序的连接信息和参数。
     <a href="https://learn.microsoft.com/zh-cn/sql/connect/jdbc/building-the-connection-url?view=sql-server-ver16" rel="nofollow" title="SQL Server JDBC 驱动程序文档">
      SQL Server JDBC 驱动程序文档
     </a>
     中提供了 URL 支持的参数。
    </p>
    <h4 id="连接安全">
     连接安全
     <a href="https://doris.apache.org/zh-CN/docs/lakehouse/database/sqlserver#%E8%BF%9E%E6%8E%A5%E5%AE%89%E5%85%A8" rel="nofollow" title="​">
      ​
     </a>
    </h4>
    <p>
     JDBC 驱动程序以及连接器自动使用传输层安全性 (TLS) 加密和证书验证。这需要在 SQL Server 数据库主机上配置合适的 TLS 证书。
    </p>
    <p>
     如果您没有建立必要的配置，您可以使用 encrypt 属性禁用连接字符串中的加密：
    </p>
    <pre><code>"jdbc_url"="jdbc:sqlserver://&lt;host&gt;:&lt;port&gt;;databaseName=&lt;databaseName&gt;;encrypt=false"
</code></pre>
    <p>
    </p>
    <p>
     <a href="https://learn.microsoft.com/zh-cn/sql/connect/jdbc/using-ssl-encryption?view=sql-server-ver16" rel="nofollow" title="SQL Server JDBC 驱动程序文档的 TLS 部分">
      SQL Server JDBC 驱动程序文档的 TLS 部分
     </a>
     详细介绍了 trustServerCertificate、hostNameInCertificate、trustStore 和 trustStorePassword 等其他参数。
    </p>
    <h3 id="层级映射">
     层级映射
     <a href="https://doris.apache.org/zh-CN/docs/lakehouse/database/sqlserver#%E5%B1%82%E7%BA%A7%E6%98%A0%E5%B0%84" rel="nofollow" title="​">
      ​
     </a>
    </h3>
    <p>
     映射 SQLServer 时，Doris 的一个 Database 对应于 SQL Server 中指定 Database（
     <code>
      jdbc_url
     </code>
     参数中的
     <code>
      &lt;databaseName&gt;
     </code>
     ）下的一个 Schema。而 Doris 的 Database 下的 Table 则对应于 SQLServer 中，Schema 下的 Tables。即映射关系如下：
    </p>
    <table>
     <thead>
      <tr>
       <th>
        Doris
       </th>
       <th>
        SQLServer
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        Catalog
       </td>
       <td>
        Database
       </td>
      </tr>
      <tr>
       <td>
        Database
       </td>
       <td>
        Schema
       </td>
      </tr>
      <tr>
       <td>
        Table
       </td>
       <td>
        Table
       </td>
      </tr>
     </tbody>
    </table>
    <h3 id="类型映射">
     类型映射
     <a href="https://doris.apache.org/zh-CN/docs/lakehouse/database/sqlserver#%E7%B1%BB%E5%9E%8B%E6%98%A0%E5%B0%84" rel="nofollow" title="​">
      ​
     </a>
    </h3>
    <h4 id="sql-server-到-doris-类型映射">
     SQL Server 到 Doris 类型映射
     <a href="https://doris.apache.org/zh-CN/docs/lakehouse/database/sqlserver#sql-server-%E5%88%B0-doris-%E7%B1%BB%E5%9E%8B%E6%98%A0%E5%B0%84" rel="nofollow" title="​">
      ​
     </a>
    </h4>
    <table>
     <thead>
      <tr>
       <th>
        SQL Server Type
       </th>
       <th>
        Doris Type
       </th>
       <th>
        Comment
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        bit
       </td>
       <td>
        BOOLEAN
       </td>
       <td>
       </td>
      </tr>
      <tr>
       <td>
        tinyint
       </td>
       <td>
        SMALLINT
       </td>
       <td>
        SQLServer 的 tinyint 是无符号数，所以映射为 Doris 的 SMALLINT
       </td>
      </tr>
      <tr>
       <td>
        smallint
       </td>
       <td>
        SMALLINT
       </td>
       <td>
       </td>
      </tr>
      <tr>
       <td>
        int
       </td>
       <td>
        INT
       </td>
       <td>
       </td>
      </tr>
      <tr>
       <td>
        bigint
       </td>
       <td>
        BIGINT
       </td>
       <td>
       </td>
      </tr>
      <tr>
       <td>
        real
       </td>
       <td>
        FLOAT
       </td>
       <td>
       </td>
      </tr>
      <tr>
       <td>
        float
       </td>
       <td>
        DOUBLE
       </td>
       <td>
       </td>
      </tr>
      <tr>
       <td>
        money
       </td>
       <td>
        DECIMAL(19,4)
       </td>
       <td>
       </td>
      </tr>
      <tr>
       <td>
        smallmoney
       </td>
       <td>
        DECIMAL(10,4)
       </td>
       <td>
       </td>
      </tr>
      <tr>
       <td>
        decimal/numeric
       </td>
       <td>
        DECIMAL
       </td>
       <td>
       </td>
      </tr>
      <tr>
       <td>
        date
       </td>
       <td>
        DATE
       </td>
       <td>
       </td>
      </tr>
      <tr>
       <td>
        datetime/datetime2/smalldatetime
       </td>
       <td>
        DATETIMEV2
       </td>
       <td>
       </td>
      </tr>
      <tr>
       <td>
        char/varchar/text/nchar/nvarchar/ntext
       </td>
       <td>
        STRING
       </td>
       <td>
       </td>
      </tr>
      <tr>
       <td>
        time/datetimeoffset
       </td>
       <td>
        STRING
       </td>
       <td>
       </td>
      </tr>
      <tr>
       <td>
        timestamp
       </td>
       <td>
        STRING
       </td>
       <td>
        读取二进制数据的十六进制显示，无实际意义
       </td>
      </tr>
      <tr>
       <td>
        Other
       </td>
       <td>
        UNSUPPORTED
       </td>
       <td>
       </td>
      </tr>
     </tbody>
    </table>
    <h3 id="查询优化">
     查询优化
     <a href="https://doris.apache.org/zh-CN/docs/lakehouse/database/sqlserver#%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96" rel="nofollow" title="​">
      ​
     </a>
    </h3>
    <h4 id="谓词下推">
     谓词下推
     <a href="https://doris.apache.org/zh-CN/docs/lakehouse/database/sqlserver#%E8%B0%93%E8%AF%8D%E4%B8%8B%E6%8E%A8" rel="nofollow" title="​">
      ​
     </a>
    </h4>
    <p>
     当执行类似于
     <code>
      where dt = '2022-01-01'
     </code>
     这样的查询时，Doris 能够将这些过滤条件下推到外部数据源，从而直接在数据源层面排除不符合条件的数据，减少了不必要的数据获取和传输。这大大提高了查询性能，同时也降低了对外部数据源的负载。
    </p>
    <h4 id="行数限制">
     行数限制
     <a href="https://doris.apache.org/zh-CN/docs/lakehouse/database/sqlserver#%E8%A1%8C%E6%95%B0%E9%99%90%E5%88%B6" rel="nofollow" title="​">
      ​
     </a>
    </h4>
    <p>
     如果在查询中带有 limit 关键字，Doris 会将 limit 转义为 SQL Server 的
     <code>
      TOP
     </code>
     语法，以减少数据传输量。
    </p>
    <h4 id="转义字符">
     转义字符
     <a href="https://doris.apache.org/zh-CN/docs/lakehouse/database/sqlserver#%E8%BD%AC%E4%B9%89%E5%AD%97%E7%AC%A6" rel="nofollow" title="​">
      ​
     </a>
    </h4>
    <p>
     Doris 会在下发到 SQL Server 的查询语句中，自动在字段名与表名上加上转义符：([])，以避免字段名与表名与 SQL Server 内部关键字冲突。
    </p>
    <h3 id="常见问题">
     常见问题
     <a href="https://doris.apache.org/zh-CN/docs/lakehouse/database/sqlserver#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98" rel="nofollow" title="​">
      ​
     </a>
    </h3>
    <ol>
     <li>
      <p>
       连接 SQL Server 出现证书认证异常
      </p>
      <pre><code>SQLServerException: The driver could not establish a secure connection to SQL Server by using Secure Sockets Layer (SSL) encryption.
Error: "sun.security.validator.ValidatorException: PKIX path building failed: sun.security.provider.certpath.SunCertPathBuilderException:
unable to find valid certification path to requested target". ClientConnectionId:a92f3817-e8e6-4311-bc21-7c66
</code></pre>
      <p>
      </p>
      <p>
       可在创建 Catalog 的
       <code>
        jdbc_url
       </code>
       把 JDBC 连接串最后增加
       <code>
        encrypt=false
       </code>
       ，如
       <code>
        "jdbc_url" = "jdbc:sqlserver://127.0.0.1:1433;DataBaseName=doris_test;encrypt=false"
       </code>
      </p>
     </li>
     <li>
      <p>
       连接 SQL Server 出现 TLS 异常
      </p>
      <pre><code>The server selected protocol version TLS10 is not accepted by client preferences [TLS13, TLS12]
</code></pre>
      <p>
      </p>
      <p>
       这是因为 SQL Server 与 JDBC 客户端之间的 TLS 协议版本不匹配。连接的 SQL Server 仅支持 TLS 1.0，而 JDBC 客户端所在 JAVA 环境默认禁用了 TLS 1.0。
      </p>
      <p>
       解决方式如下：
      </p>
      <ol>
       <li>
        在 SQL Server 上启用 TLS 1.2。 参考：
        <a href="https://learn.microsoft.com/zh-cn/troubleshoot/sql/database-engine/connect/tls-1-2-support-microsoft-sql-server" rel="nofollow" title="SQL Server TLS 1.2 支持">
         SQL Server TLS 1.2 支持
        </a>
       </li>
       <li>
        启用 JDK 的 TLS 1.0。
        <pre><code>vim ${JAVA_HOME}/lib/security/java.security
#找到这段
jdk.tls.disabledAlgorithms=SSLv3, TLSv1, TLSv1.1, RC4, DES, MD5withRSA, \
DH keySize &lt; 1024, EC keySize &lt; 224, 3DES_EDE_CBC, anon, NULL, \
include jdk.disabled.namedCurves

#删掉其中的 TLSv1, TLSv1.1 , 改成下面这样即可
jdk.tls.disabledAlgorithms=SSLv3, RC4, DES, MD5withRSA, \
DH keySize &lt; 1024, EC keySize &lt; 224, anon, NULL, \
include jdk.disabled.namedCurves
</code></pre>
        <p>
        </p>
       </li>
      </ol>
     </li>
    </ol>
    <p>
    </p>
   </div>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f33363037303130342f:61727469636c652f64657461696c732f313436303839333837" class_="artid" style="display:none">
 </p>
</div>


