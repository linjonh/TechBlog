---
layout: post
title: "win32汇编环境,网络编程入门之四"
date: 2025-03-13 16:37:16 +0800
description: "本教程学一下，怎么把得到的主页的数据变得我们认识"
keywords: "win32汇编环境,网络编程入门之四"
categories: ['Win']
tags: ['汇编']
artid: "146235093"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146235093
    alt: "win32汇编环境,网络编程入门之四"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146235093
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146235093
cover: https://bing.ee123.net/img/rand?artid=146235093
image: https://bing.ee123.net/img/rand?artid=146235093
img: https://bing.ee123.net/img/rand?artid=146235093
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     win32汇编环境,网络编程入门之四
    </h1>
   </div>
   <div class="article-resource-info-box">
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <p>
     ;运行效果
    </p>
    <p style="text-align:center">
     <img alt="" src="https://i-blog.csdnimg.cn/direct/87eb3d5a865b4aeb9d2c4ffac0087164.png"/>
    </p>
    <p>
     ;win32汇编环境,网络编程入门之四
     <br/>
     ;本教程学一下，怎么把得到的主页的数据变得我们认识
     <br/>
     ;在前面的教程里，我们得到某个网站的主页。但是发现里面一堆乱码。
     <br/>
     ;仔细看看，里面有一句：&lt;meta charset="utf-8"&gt;，这句的意思是，该网页使用的是UTF8编码。这就是显示乱码的原因。
     <br/>
     ;这是因为，网页的编码是UTF8，而我们程序的编码是ASCII码的，接收到这些数据，除了里面ASCII码的内容外，其它的不认识，只能显示出乱码一堆。
     <br/>
     ;如果我们尝试换个IP试试，连接其它网站，却发现一发送内容，会导致程序崩溃。
     <br/>
     ;这个原因是因为我们的示例程序，连接的都是小容量数据的网页。而大部分的网页，数据量很大，我们的示例程序并没有处理大数据量的逻辑。所以一运行，直接崩溃。
     <br/>
     ;所以，要改的事很多，一点点来，都是靠积累着变好的。
     <br/>
     ;先来解决编码的问题
     <br/>
     ;这里要先了解一下UTF8编码，它是可变长的编码，简单地说，它的第1个字节内的某个值决定了，这个字符总共有多少个字节。
     <br/>
     ;这个字符或许是2个字节，或许是3个字节，也许4个，最多不超过4个。当然，具体的很复杂，有兴趣可以上网查查这个编码的资料，那也可以写本书了。
     <br/>
     ;单个字符没什么问题，要是一篇长长的文章，这就很要命了。
     <br/>
     ;幸运的是，有函数可以帮我们搞掂这些事儿，把它重新整理出来。我们也只需要最基本的功能就够了，就是让我们能认得那些字符。
     <br/>
     ;我们这一教程，就是想办法把这个问题搞掂它。
     <br/>
     ;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
     <br/>
     .386
     <br/>
     .model flat,stdcall
     <br/>
     option casemap:none
    </p>
    <p>
     ;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
     <br/>
     ; Include 文件定义
     <br/>
     ;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
     <br/>
     include    windows.inc
     <br/>
     include    user32.inc
     <br/>
     include    kernel32.inc
     <br/>
     include       wsock32.inc    ;需要添加的头文件，涉及socket
    </p>
    <p>
     includelib user32.lib
     <br/>
     includelib kernel32.lib
     <br/>
     includelib wsock32.lib
    </p>
    <p>
     ; 自定义函数声明
     <br/>
     ;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
     <br/>
     DlgProc proto :DWORD,:DWORD,:DWORD,:DWORD   ;对话框窗口函数
    </p>
    <p>
     ;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
     <br/>
     ; Equ 等值定义
     <br/>
     ;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
     <br/>
     MAINDIALOG    equ 1
     <br/>
     ICO_MAIN    equ 1000    ;图标
     <br/>
     ID_BUTTON01    equ 41
     <br/>
     ID_BUTTON02    equ 42
     <br/>
     ID_BUTTON03    equ 43
     <br/>
     ID_EDIT01    equ 11
     <br/>
     TCP_PORT    equ 80          ;端口
     <br/>
     ;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
     <br/>
     ; 数据段
     <br/>
     ;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
     <br/>
     .data
     <br/>
     szErrIP           db "无效的服务器IP地址!",0
     <br/>
     szErrConnect   db "无法连接到服务器!",0
     <br/>
     szSucConnect   db "可以连接到服务器!",0
     <br/>
     szIP           db "103.113.93.101",0
     <br/>
     szMsg          db "提示",0
     <br/>
     szFrm          db "%d",0
    </p>
    <p>
     szHello        db    "POST / HTTP/1.1", 13, 10      ;发送给服务器的字符串，其中13是回车，10是换行。这里的字符串是TCP协议报文。其作用是取得网站的主页
     <br/>
     db    "HOST:kepai2023.cn", 13, 10    ;这是简单示例，后面我们会慢慢地研究报文这东西。只要符合规范，你发送什么，服务器就返回什么。
     <br/>
     db    13, 10,0                       ;这样定义字符串，就是让字符紧跟在一起，最后一个是0，就是结束符
     <br/>
    </p>
    <p>
     .data?
     <br/>
     hInstance HINSTANCE          ?
     <br/>
     hMainhwnd       HWND         ?
     <br/>
     hEdithwnd       HWND         ?
    </p>
    <p>
     hW_IP           HWND         ?        ;IP地址控件的句柄
     <br/>
     nGetIP          dd           ?        ;存放从IP地址控件取得的值的指针
     <br/>
     hSocket            dd         ?
    </p>
    <p>
     .const
    </p>
    <p>
     <br/>
     ; 代码段
     <br/>
     ;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
     <br/>
     .code
     <br/>
     start:
     <br/>
     invoke GetModuleHandle, NULL
     <br/>
     mov    hInstance,eax
     <br/>
     invoke DialogBoxParam, hInstance, MAINDIALOG,NULL, addr DlgProc, NULL
     <br/>
     invoke ExitProcess,eax
    </p>
    <p>
     _WorkThread    proc    _lParam
     <br/>
     LOCAL    @stSin:sockaddr_in
     <br/>
     LOCAL    @szBuffer[1500]:byte   ;网络传输的最大单元，1500字节，也就是客户端发过来的数据，一次最大就是1500字节，这是协议规定，
     <br/>
     LOCAL    @Rec_szBuffer[4500]:byte
     <br/>
     LOCAL   @h01:byte,@h02:byte,@h03:byte,@h04:byte
     <br/>
     <br/>
     invoke    RtlZeroMemory,addr @stSin,sizeof @stSin
     <br/>
     <br/>
     invoke    inet_addr,addr szIP      ;将字符串类型的IP地址进行转换，转换成网络字节序
     <br/>
     <br/>
     mov    @stSin.sin_addr,eax
     <br/>
     mov    @stSin.sin_family,AF_INET
     <br/>
     invoke    htons,TCP_PORT
     <br/>
     mov    @stSin.sin_port,ax
    </p>
    <p>
     invoke    socket,AF_INET,SOCK_STREAM,0
     <br/>
     mov    hSocket,eax
     <br/>
     <br/>
     ; 连接到服务器
     <br/>
     invoke    connect,hSocket,addr @stSin,sizeof @stSin
     <br/>
     .if eax == SOCKET_ERROR
     <br/>
     invoke    MessageBox,NULL,addr szErrConnect,NULL,MB_OK or MB_ICONSTOP
     <br/>
     .endif
     <br/>
     invoke RtlZeroMemory, addr @szBuffer, 1500
     <br/>
     invoke recv, hSocket, addr @szBuffer, 1549, 0   ;想要读取到字节个数，一般是参数2的字节数-1，把\0字符串结尾留出来
     <br/>
     invoke MultiByteToWideChar,65001,0,addr @szBuffer,1549,addr @Rec_szBuffer,4500  ;将接收到的utf-8编码的字符串转换为Unicode编码的字符串,CP_UTF8的值是65001
     <br/>
     invoke SendMessageW,hEdithwnd,WM_SETTEXT,0,addr @Rec_szBuffer                   ;因为要显示中文，故而用Unicode编码，只能用SendMessageW发送
     <br/>
     ret
    </p>
    <p>
     _WorkThread endp
     <br/>
     ;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
     <br/>
     DlgProc proc hWnd:HWND, uMsg:UINT, wParam:WPARAM, lParam:LPARAM
     <br/>
     LOCAL    @stWsa:WSADATA
     <br/>
     <br/>
     .if     uMsg == WM_INITDIALOG
     <br/>
     invoke    LoadIcon,hInstance,ICO_MAIN
     <br/>
     invoke    SendMessage,hWnd,WM_SETICON,ICON_BIG,eax
     <br/>
     invoke    WSAStartup,101h,addr @stWsa
     <br/>
     <br/>
     mov eax,hWnd
     <br/>
     mov hMainhwnd,eax
     <br/>
     <br/>
     invoke GetDlgItem,hMainhwnd,ID_EDIT01
     <br/>
     mov hEdithwnd,eax
     <br/>
     .elseif    uMsg ==    WM_COMMAND
     <br/>
     mov    ebx,wParam
     <br/>
     .if    bx ==    ID_BUTTON01
     <br/>
     invoke    CreateThread,NULL,0,offset _WorkThread,0,NULL,0    ;启动连接线程
     <br/>
     <br/>
     .elseif bx ==    ID_BUTTON02
     <br/>
     invoke lstrlen, addr szHello
     <br/>
     invoke send, hSocket, addr szHello, eax, 0
     <br/>
     .endif
     <br/>
     .elseif uMsg == WM_CLOSE     ;退出程序时记得清除套接字
     <br/>
     .if    ! hSocket    ;如果socket创建失败，则清除它，否则先关闭，再清除
     <br/>
     invoke    WSACleanup
     <br/>
     invoke    EndDialog,hWnd,NULL
     <br/>
     .else
     <br/>
     invoke    closesocket,hSocket
     <br/>
     xor    eax,eax
     <br/>
     mov    hSocket,eax
     <br/>
     invoke    WSACleanup
     <br/>
     invoke    EndDialog,hWnd,NULL
     <br/>
     .endif
     <br/>
     .else
     <br/>
     mov eax,FALSE
     <br/>
     ret
     <br/>
     .endif
     <br/>
     mov eax,TRUE
     <br/>
     ret
     <br/>
     DlgProc endp
    </p>
    <p>
     end start
    </p>
    <p>
     ;下面为rc文件内容
     <br/>
     #include "resource.h"                   //提示缺少该文件，可以在资源里下载
     <br/>
     //&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
     <br/>
     #define       MAINDIALOG      1
     <br/>
     #define       ICO_MAIN        1000    //图标
     <br/>
     #define    ID_BUTTON01     41
     <br/>
     #define    ID_BUTTON02     42
    </p>
    <p>
     #define    ID_EDIT01       11         //编辑框标识符
     <br/>
     //&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
     <br/>
     ICO_MAIN    ICON        "Main.ico"
     <br/>
     //&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
     <br/>
     //定义对话框
     <br/>
     MAINDIALOG DIALOG 10, 10, 210, 230
     <br/>
     STYLE  DS_CENTER | WS_CAPTION | WS_MINIMIZEBOX |
     <br/>
     WS_SYSMENU | WS_VISIBLE | WS_OVERLAPPED | DS_MODALFRAME | DS_3DLOOK
     <br/>
     CAPTION "对话框程序模版"
     <br/>
     FONT 11, "方正姚体"
     <br/>
     BEGIN
     <br/>
     PUSHBUTTON      "连接网站", ID_BUTTON01,  140,8,60,12
     <br/>
     PUSHBUTTON      "发送内容", ID_BUTTON02,  140,28,60,12
     <br/>
     <br/>
     CONTROL "这里显示的是服务器返回的信息",ID_EDIT01,"Edit",WS_CHILDWINDOW|WS_VISIBLE|WS_TABSTOP|ES_MULTILINE|ES_WANTRETURN|ES_AUTOVSCROLL|WS_VSCROLL,10, 10, 120, 210,WS_EX_CLIENTEDGE  //设置成多行编辑框，按回车时加回车符
     <br/>
     END
    </p>
    <p>
     <br/>
    </p>
   </div>
  </div>
 </article>
 <p alt="6874747073:3a2f2f626c6f672e6373646e2e6e65742f696c746f6b796f2f:61727469636c652f64657461696c732f313436323335303933" class_="artid" style="display:none">
 </p>
</div>


