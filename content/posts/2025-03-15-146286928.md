---
layout: post
title: "SOMEIP用Python实现协议订阅Offer订阅ACK与报文接收"
date: 2025-03-15 23:20:53 +0800
description: "1、需要pip安装scapy库2、需要修改根据实际情况配置network_define.py3、执行someip_controller.py运行本案例4、本文参考注：最近没啥时间写文章，有兴趣自己研究下<~~>"
keywords: "SOME/IP：用Python实现协议订阅、Offer、订阅ACK与报文接收"
categories: ['通信协议']
tags: ['自动驾驶', '网络协议', 'Udp', 'Tcp', 'Python']
artid: "146286928"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146286928
    alt: "SOMEIP用Python实现协议订阅Offer订阅ACK与报文接收"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146286928
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146286928
cover: https://bing.ee123.net/img/rand?artid=146286928
image: https://bing.ee123.net/img/rand?artid=146286928
img: https://bing.ee123.net/img/rand?artid=146286928
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     SOME/IP：用Python实现协议订阅、Offer、订阅ACK与报文接收
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-dracula" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <p>
    </p>
    <hr/>
    <h2>
     <a id="_6">
     </a>
     前言
    </h2>
    <p>
     1、需要pip安装scapy库
     <br/>
     2、需要修改根据实际情况配置network_define.py
     <br/>
     3、执行someip_controller.py运行本案例
     <br/>
     4、本文参考
     <a href="https://github.com/jamores/eth-scapy-someip">
      github: eth-scapy-someip
     </a>
    </p>
    <p>
     注：最近没啥时间写文章，有兴趣自己研究下&lt;~~&gt;
    </p>
    <hr/>
    <h2>
     <a id="_17">
     </a>
     一、代码层次
    </h2>
    <pre><code class="prism language-markdowm">someip/
└── module/
    ├── eth_scapy_sd.py          # SOME/IP SD服务发现结构体定义
    ├── eth_scapy_someip.py      # SOME/IP标准结构体定义
    ├── network_define.py        # 网络配置（IP/端口/多播组）
    ├── packet_define.py         # 协议字段定义（Offer/Subscribe/ACK）
    ├── unpack_define.py         # 接收报文解析器
    └── someip_controller.py     # 主控制逻辑（订阅/OFFER/ACK流程管理）
</code></pre>
    <h2>
     <a id="_28">
     </a>
     二、详细代码
    </h2>
    <h3>
     <a id="1_eth_scapy_sdpy_29">
     </a>
     1. eth_scapy_sd.py
    </h3>
    <pre><code class="prism language-python"><span class="token keyword">import</span> ctypes
<span class="token keyword">import</span> collections

<span class="token keyword">from</span> eth_scapy_someip <span class="token keyword">import</span> SOMEIP

<span class="token keyword">from</span> scapy<span class="token punctuation">.</span>fields <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> scapy<span class="token punctuation">.</span>packet <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> scapy<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>inet6 <span class="token keyword">import</span> IP6Field



<span class="token keyword">class</span> <span class="token class-name">_SDPacketBase</span><span class="token punctuation">(</span>Packet<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""base class to be used among all SD Packet definitions."""</span>

    <span class="token comment"># use this dictionary to set default values for desired fields (mostly on subclasses</span>
    <span class="token comment"># where not all fields are defined locally)</span>
    <span class="token comment"># - key : field_name, value : desired value</span>
    <span class="token comment"># - it will be used from 'init_fields' function, upon packet initialization</span>
    <span class="token comment">#</span>
    <span class="token comment"># example : _defaults = {'field_1_name':field_1_value,'field_2_name':field_2_value}</span>
    _defaults <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

    <span class="token keyword">def</span> <span class="token function">_set_defaults</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""goes through '_defaults' dict setting field default values (for those that have been defined)."""</span>
        <span class="token keyword">for</span> key <span class="token keyword">in</span> self<span class="token punctuation">.</span>_defaults<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>get_field<span class="token punctuation">(</span>key<span class="token punctuation">)</span>
            <span class="token keyword">except</span> KeyError<span class="token punctuation">:</span>
                <span class="token keyword">pass</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>setfieldval<span class="token punctuation">(</span>key<span class="token punctuation">,</span> self<span class="token punctuation">.</span>_defaults<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">init_fields</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""perform initialization of packet fields with desired values.
        NOTE : this funtion will only be called *once* upon class (or subclass) construction
        """</span>
        Packet<span class="token punctuation">.</span>init_fields<span class="token punctuation">(</span>self<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_set_defaults<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token comment"># SD ENTRY</span>
<span class="token comment">#  - Service</span>
<span class="token comment">#  - EventGroup</span>
<span class="token keyword">class</span> <span class="token class-name">_SDEntry</span><span class="token punctuation">(</span>_SDPacketBase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Base class for SDEntry_* packages."""</span>

    TYPE_FMT <span class="token operator">=</span> <span class="token string">"&gt;B"</span>
    TYPE_PAYLOAD_I <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token comment"># ENTRY TYPES : SERVICE</span>
    TYPE_SRV_FINDSERVICE <span class="token operator">=</span> <span class="token number">0x00</span>
    TYPE_SRV_OFFERSERVICE <span class="token operator">=</span> <span class="token number">0x01</span>
    TYPE_SRV <span class="token operator">=</span> <span class="token punctuation">(</span>TYPE_SRV_FINDSERVICE<span class="token punctuation">,</span> TYPE_SRV_OFFERSERVICE<span class="token punctuation">)</span>
    <span class="token comment"># ENTRY TYPES : EVENGROUP</span>
    TYPE_EVTGRP_SUBSCRIBE <span class="token operator">=</span> <span class="token number">0x06</span>
    TYPE_EVTGRP_SUBSCRIBE_ACK <span class="token operator">=</span> <span class="token number">0x07</span>
    TYPE_EVTGRP <span class="token operator">=</span> <span class="token punctuation">(</span>TYPE_EVTGRP_SUBSCRIBE<span class="token punctuation">,</span> TYPE_EVTGRP_SUBSCRIBE_ACK<span class="token punctuation">)</span>
    <span class="token comment"># overall len (UT usage)</span>
    OVERALL_LEN <span class="token operator">=</span> <span class="token number">16</span>

    <span class="token comment"># 定义Entries Array结构体</span>
    fields_desc <span class="token operator">=</span> <span class="token punctuation">[</span>
        ByteField<span class="token punctuation">(</span><span class="token string">"type"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        ByteField<span class="token punctuation">(</span><span class="token string">"index_1"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        ByteField<span class="token punctuation">(</span><span class="token string">"index_2"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        BitField<span class="token punctuation">(</span><span class="token string">"n_opt_1"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        BitField<span class="token punctuation">(</span><span class="token string">"n_opt_2"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        ShortField<span class="token punctuation">(</span><span class="token string">"srv_id"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        ShortField<span class="token punctuation">(</span><span class="token string">"inst_id"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        ByteField<span class="token punctuation">(</span><span class="token string">"major_ver"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        X3BytesField<span class="token punctuation">(</span><span class="token string">"ttl"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>

    <span class="token keyword">def</span> <span class="token function">guess_payload_class</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> payload<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""decode SDEntry depending on its type."""</span>
        pl_type <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span>
            _SDEntry<span class="token punctuation">.</span>TYPE_FMT<span class="token punctuation">,</span>
            payload<span class="token punctuation">[</span>_SDEntry<span class="token punctuation">.</span>TYPE_PAYLOAD_I <span class="token punctuation">:</span> _SDEntry<span class="token punctuation">.</span>TYPE_PAYLOAD_I <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> pl_type <span class="token keyword">in</span> _SDEntry<span class="token punctuation">.</span>TYPE_SRV<span class="token punctuation">:</span>
            <span class="token keyword">return</span> SDEntry_Service
        <span class="token keyword">elif</span> pl_type <span class="token keyword">in</span> _SDEntry<span class="token punctuation">.</span>TYPE_EVTGRP<span class="token punctuation">:</span>
            <span class="token keyword">return</span> SDEntry_EventGroup


<span class="token keyword">class</span> <span class="token class-name">SDEntry_Service</span><span class="token punctuation">(</span>_SDEntry<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Service Entry."""</span>

    _defaults <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"type"</span><span class="token punctuation">:</span> _SDEntry<span class="token punctuation">.</span>TYPE_SRV_FINDSERVICE<span class="token punctuation">}</span>

    name <span class="token operator">=</span> <span class="token string">"Service Entry"</span>
    fields_desc <span class="token operator">=</span> <span class="token punctuation">[</span>_SDEntry<span class="token punctuation">,</span> IntField<span class="token punctuation">(</span><span class="token string">"minor_ver"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span>


<span class="token keyword">class</span> <span class="token class-name">SDEntry_EventGroup</span><span class="token punctuation">(</span>_SDEntry<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""EventGroup Entry."""</span>

    _defaults <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"type"</span><span class="token punctuation">:</span> _SDEntry<span class="token punctuation">.</span>TYPE_EVTGRP_SUBSCRIBE<span class="token punctuation">}</span>

    name <span class="token operator">=</span> <span class="token string">"Eventgroup Entry"</span>
    fields_desc <span class="token operator">=</span> <span class="token punctuation">[</span>
        _SDEntry<span class="token punctuation">,</span>
        BitField<span class="token punctuation">(</span><span class="token string">"res"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        BitField<span class="token punctuation">(</span><span class="token string">"cnt"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        ShortField<span class="token punctuation">(</span><span class="token string">"eventgroup_id"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>


<span class="token comment"># SD Option</span>
<span class="token comment">#  - Configuration</span>
<span class="token comment">#  - LoadBalancing</span>
<span class="token comment">#  - IPv4 EndPoint</span>
<span class="token comment">#  - IPv6 EndPoint</span>
<span class="token comment">#  - IPv4 MultiCast</span>
<span class="token comment">#  - IPv6 MultiCast</span>
<span class="token comment">#  - IPv4 EndPoint</span>
<span class="token comment">#  - IPv6 EndPoint</span>
<span class="token keyword">class</span> <span class="token class-name">_SDOption</span><span class="token punctuation">(</span>_SDPacketBase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Base class for SDOption_* packages."""</span>

    TYPE_FMT <span class="token operator">=</span> <span class="token string">"&gt;B"</span>
    TYPE_PAYLOAD_I <span class="token operator">=</span> <span class="token number">2</span>

    CFG_TYPE <span class="token operator">=</span> <span class="token number">0x01</span>
    CFG_OVERALL_LEN <span class="token operator">=</span> <span class="token punctuation">(</span>
        <span class="token number">4</span>  <span class="token comment"># overall length of CFG SDOption,empty 'cfg_str' (to be used from UT)</span>
    <span class="token punctuation">)</span>
    LOADBALANCE_TYPE <span class="token operator">=</span> <span class="token number">0x02</span>
    LOADBALANCE_LEN <span class="token operator">=</span> <span class="token number">0x05</span>
    LOADBALANCE_OVERALL_LEN <span class="token operator">=</span> <span class="token number">8</span>  <span class="token comment"># overall length of LB SDOption (to be used from UT)</span>
    IP4_ENDPOINT_TYPE <span class="token operator">=</span> <span class="token number">0x04</span>
    IP4_ENDPOINT_LEN <span class="token operator">=</span> <span class="token number">0x0009</span>
    IP4_MCAST_TYPE <span class="token operator">=</span> <span class="token number">0x14</span>
    IP4_MCAST_LEN <span class="token operator">=</span> <span class="token number">0x0009</span>
    IP4_SDENDPOINT_TYPE <span class="token operator">=</span> <span class="token number">0x24</span>
    IP4_SDENDPOINT_LEN <span class="token operator">=</span> <span class="token number">0x0009</span>
    IP4_OVERALL_LEN <span class="token operator">=</span> <span class="token number">12</span>  <span class="token comment"># overall length of IP4 SDOption (to be used from UT)</span>
    IP6_ENDPOINT_TYPE <span class="token operator">=</span> <span class="token number">0x06</span>
    IP6_ENDPOINT_LEN <span class="token operator">=</span> <span class="token number">0x0015</span>
    IP6_MCAST_TYPE <span class="token operator">=</span> <span class="token number">0x16</span>
    IP6_MCAST_LEN <span class="token operator">=</span> <span class="token number">0x0015</span>
    IP6_SDENDPOINT_TYPE <span class="token operator">=</span> <span class="token number">0x26</span>
    IP6_SDENDPOINT_LEN <span class="token operator">=</span> <span class="token number">0x0015</span>
    IP6_OVERALL_LEN <span class="token operator">=</span> <span class="token number">24</span>  <span class="token comment"># overall length of IP6 SDOption (to be used from UT)</span>

    <span class="token keyword">def</span> <span class="token function">guess_payload_class</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> payload<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""decode SDOption depending on its type."""</span>
        pl_type <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span>
            _SDOption<span class="token punctuation">.</span>TYPE_FMT<span class="token punctuation">,</span>
            payload<span class="token punctuation">[</span>_SDOption<span class="token punctuation">.</span>TYPE_PAYLOAD_I <span class="token punctuation">:</span> _SDOption<span class="token punctuation">.</span>TYPE_PAYLOAD_I <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

        <span class="token keyword">if</span> pl_type <span class="token operator">==</span> _SDOption<span class="token punctuation">.</span>CFG_TYPE<span class="token punctuation">:</span>
            <span class="token keyword">return</span> SDOption_Config
        <span class="token keyword">elif</span> pl_type <span class="token operator">==</span> self<span class="token punctuation">.</span>LOADBALANCE_TYPE<span class="token punctuation">:</span>
            <span class="token keyword">return</span> SDOption_LoadBalance
        <span class="token keyword">elif</span> pl_type <span class="token operator">==</span> self<span class="token punctuation">.</span>IP4_ENDPOINT_TYPE<span class="token punctuation">:</span>
            <span class="token keyword">return</span> SDOption_IP4_EndPoint
        <span class="token keyword">elif</span> pl_type <span class="token operator">==</span> self<span class="token punctuation">.</span>IP4_MCAST_TYPE<span class="token punctuation">:</span>
            <span class="token keyword">return</span> SDOption_IP4_Multicast
        <span class="token keyword">elif</span> pl_type <span class="token operator">==</span> self<span class="token punctuation">.</span>IP4_SDENDPOINT_TYPE<span class="token punctuation">:</span>
            <span class="token keyword">return</span> SDOption_IP4_SD_EndPoint
        <span class="token keyword">elif</span> pl_type <span class="token operator">==</span> self<span class="token punctuation">.</span>IP6_ENDPOINT_TYPE<span class="token punctuation">:</span>
            <span class="token keyword">return</span> SDOption_IP6_EndPoint
        <span class="token keyword">elif</span> pl_type <span class="token operator">==</span> self<span class="token punctuation">.</span>IP6_MCAST_TYPE<span class="token punctuation">:</span>
            <span class="token keyword">return</span> SDOption_IP6_Multicast
        <span class="token keyword">elif</span> pl_type <span class="token operator">==</span> self<span class="token punctuation">.</span>IP6_SDENDPOINT_TYPE<span class="token punctuation">:</span>
            <span class="token keyword">return</span> SDOption_IP6_SD_EndPoint


<span class="token keyword">class</span> <span class="token class-name">_SDOption_Header</span><span class="token punctuation">(</span>_SDOption<span class="token punctuation">)</span><span class="token punctuation">:</span>
    fields_desc <span class="token operator">=</span> <span class="token punctuation">[</span>
        ShortField<span class="token punctuation">(</span><span class="token string">"len"</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        ByteField<span class="token punctuation">(</span><span class="token string">"type"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        ByteField<span class="token punctuation">(</span><span class="token string">"res_hdr"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>


<span class="token keyword">class</span> <span class="token class-name">_SDOption_Tail</span><span class="token punctuation">(</span>_SDOption<span class="token punctuation">)</span><span class="token punctuation">:</span>
    fields_desc <span class="token operator">=</span> <span class="token punctuation">[</span>
        ByteField<span class="token punctuation">(</span><span class="token string">"res_tail"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        ByteEnumField<span class="token punctuation">(</span><span class="token string">"l4_proto"</span><span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token number">0x06</span><span class="token punctuation">:</span> <span class="token string">"TCP"</span><span class="token punctuation">,</span> <span class="token number">0x11</span><span class="token punctuation">:</span> <span class="token string">"UDP"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        ShortField<span class="token punctuation">(</span><span class="token string">"port"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>


<span class="token keyword">class</span> <span class="token class-name">_SDOption_IP4</span><span class="token punctuation">(</span>_SDOption<span class="token punctuation">)</span><span class="token punctuation">:</span>
    fields_desc <span class="token operator">=</span> <span class="token punctuation">[</span>_SDOption_Header<span class="token punctuation">,</span> IPField<span class="token punctuation">(</span><span class="token string">"addr"</span><span class="token punctuation">,</span> <span class="token string">"0.0.0.0"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> _SDOption_Tail<span class="token punctuation">]</span>


<span class="token keyword">class</span> <span class="token class-name">_SDOption_IP6</span><span class="token punctuation">(</span>_SDOption<span class="token punctuation">)</span><span class="token punctuation">:</span>
    fields_desc <span class="token operator">=</span> <span class="token punctuation">[</span>
        _SDOption_Header<span class="token punctuation">,</span>
        IP6Field<span class="token punctuation">(</span><span class="token string">"addr"</span><span class="token punctuation">,</span> <span class="token string">"2001:cdba:0000:0000:0000:0000:3257:9652"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        _SDOption_Tail<span class="token punctuation">,</span>
    <span class="token punctuation">]</span>


<span class="token keyword">class</span> <span class="token class-name">SDOption_Config</span><span class="token punctuation">(</span>_SDOption<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># offset to be added upon length calculation (corresponding to header's "Reserved" field)</span>
    LEN_OFFSET <span class="token operator">=</span> <span class="token number">0x01</span>

    name <span class="token operator">=</span> <span class="token string">"Config Option"</span>
    <span class="token comment"># default values specification</span>
    _defaults <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"type"</span><span class="token punctuation">:</span> _SDOption<span class="token punctuation">.</span>CFG_TYPE<span class="token punctuation">}</span>
    <span class="token comment"># package fields definiton</span>
    fields_desc <span class="token operator">=</span> <span class="token punctuation">[</span>_SDOption_Header<span class="token punctuation">,</span> StrField<span class="token punctuation">(</span><span class="token string">"cfg_str"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

    <span class="token keyword">def</span> <span class="token function">post_build</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> p<span class="token punctuation">,</span> pay<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># length computation excluding 16b_length and 8b_type</span>
        l <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token builtin">len</span>
        <span class="token keyword">if</span> l <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            l <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>cfg_str<span class="token punctuation">)</span> <span class="token operator">+</span> self<span class="token punctuation">.</span>LEN_OFFSET
            p <span class="token operator">=</span> struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">"!H"</span><span class="token punctuation">,</span> l<span class="token punctuation">)</span> <span class="token operator">+</span> p<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
        <span class="token keyword">return</span> p <span class="token operator">+</span> pay


<span class="token keyword">class</span> <span class="token class-name">SDOption_LoadBalance</span><span class="token punctuation">(</span>_SDOption<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> <span class="token string">"LoadBalance Option"</span>
    <span class="token comment"># default values specification</span>
    _defaults <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"type"</span><span class="token punctuation">:</span> _SDOption<span class="token punctuation">.</span>LOADBALANCE_TYPE<span class="token punctuation">,</span> <span class="token string">"len"</span><span class="token punctuation">:</span> _SDOption<span class="token punctuation">.</span>LOADBALANCE_LEN<span class="token punctuation">}</span>
    <span class="token comment"># package fields definiton</span>
    fields_desc <span class="token operator">=</span> <span class="token punctuation">[</span>_SDOption_Header<span class="token punctuation">,</span> ShortField<span class="token punctuation">(</span><span class="token string">"priority"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ShortField<span class="token punctuation">(</span><span class="token string">"weight"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span>


<span class="token comment"># SDOPTIONS : IPv4-specific</span>
<span class="token keyword">class</span> <span class="token class-name">SDOption_IP4_EndPoint</span><span class="token punctuation">(</span>_SDOption_IP4<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> <span class="token string">"IP4 EndPoint Option"</span>
    <span class="token comment"># default values specification</span>
    _defaults <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"type"</span><span class="token punctuation">:</span> _SDOption<span class="token punctuation">.</span>IP4_ENDPOINT_TYPE<span class="token punctuation">,</span> <span class="token string">"len"</span><span class="token punctuation">:</span> _SDOption<span class="token punctuation">.</span>IP4_ENDPOINT_LEN<span class="token punctuation">}</span>


<span class="token keyword">class</span> <span class="token class-name">SDOption_IP4_Multicast</span><span class="token punctuation">(</span>_SDOption_IP4<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> <span class="token string">"IP4 Multicast Option"</span>
    <span class="token comment"># default values specification</span>
    _defaults <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"type"</span><span class="token punctuation">:</span> _SDOption<span class="token punctuation">.</span>IP4_MCAST_TYPE<span class="token punctuation">,</span> <span class="token string">"len"</span><span class="token punctuation">:</span> _SDOption<span class="token punctuation">.</span>IP4_MCAST_LEN<span class="token punctuation">}</span>


<span class="token keyword">class</span> <span class="token class-name">SDOption_IP4_SD_EndPoint</span><span class="token punctuation">(</span>_SDOption_IP4<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> <span class="token string">"IP4 SDEndPoint Option"</span>
    <span class="token comment"># default values specification</span>
    _defaults <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"type"</span><span class="token punctuation">:</span> _SDOption<span class="token punctuation">.</span>IP4_SDENDPOINT_TYPE<span class="token punctuation">,</span>
        <span class="token string">"len"</span><span class="token punctuation">:</span> _SDOption<span class="token punctuation">.</span>IP4_SDENDPOINT_LEN<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>


<span class="token comment"># SDOPTIONS : IPv6-specific</span>
<span class="token keyword">class</span> <span class="token class-name">SDOption_IP6_EndPoint</span><span class="token punctuation">(</span>_SDOption_IP6<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> <span class="token string">"IP6 EndPoint Option"</span>
    <span class="token comment"># default values specification</span>
    _defaults <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"type"</span><span class="token punctuation">:</span> _SDOption<span class="token punctuation">.</span>IP6_ENDPOINT_TYPE<span class="token punctuation">,</span> <span class="token string">"len"</span><span class="token punctuation">:</span> _SDOption<span class="token punctuation">.</span>IP6_ENDPOINT_LEN<span class="token punctuation">}</span>


<span class="token keyword">class</span> <span class="token class-name">SDOption_IP6_Multicast</span><span class="token punctuation">(</span>_SDOption_IP6<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> <span class="token string">"IP6 Multicast Option"</span>
    <span class="token comment"># default values specification</span>
    _defaults <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"type"</span><span class="token punctuation">:</span> _SDOption<span class="token punctuation">.</span>IP6_MCAST_TYPE<span class="token punctuation">,</span> <span class="token string">"len"</span><span class="token punctuation">:</span> _SDOption<span class="token punctuation">.</span>IP6_MCAST_LEN<span class="token punctuation">}</span>


<span class="token keyword">class</span> <span class="token class-name">SDOption_IP6_SD_EndPoint</span><span class="token punctuation">(</span>_SDOption_IP6<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> <span class="token string">"IP6 SDEndPoint Option"</span>
    <span class="token comment"># default values specification</span>
    _defaults <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"type"</span><span class="token punctuation">:</span> _SDOption<span class="token punctuation">.</span>IP6_SDENDPOINT_TYPE<span class="token punctuation">,</span>
        <span class="token string">"len"</span><span class="token punctuation">:</span> _SDOption<span class="token punctuation">.</span>IP6_SDENDPOINT_LEN<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>


<span class="token comment">#</span>
<span class="token comment"># SD PACKAGE DEFINITION</span>
<span class="token comment">#</span>
<span class="token keyword">class</span> <span class="token class-name">SD</span><span class="token punctuation">(</span>_SDPacketBase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    SD Packet

    NOTE :   when adding 'entries' or 'options', do not use list.append() method but create a new list
    e.g. :  p = SD()
            p.option_array = [SDOption_Config(),SDOption_IP6_EndPoint()]
    """</span>

    SOMEIP_MSGID_SRVID <span class="token operator">=</span> <span class="token number">0xFFFF</span>
    SOMEIP_MSGID_SUBID <span class="token operator">=</span> <span class="token number">0x1</span>
    SOMEIP_MSGID_EVENTID <span class="token operator">=</span> <span class="token number">0x100</span>
    SOMEIP_PROTO_VER <span class="token operator">=</span> <span class="token number">0x01</span>
    SOMEIP_IFACE_VER <span class="token operator">=</span> <span class="token number">0x01</span>
    SOMEIP_MSG_TYPE <span class="token operator">=</span> SOMEIP<span class="token punctuation">.</span>TYPE_NOTIFICATION

    name <span class="token operator">=</span> <span class="token string">"SD"</span>
    <span class="token comment"># Flags definition: {"name":(mask,offset)}</span>
    _sdFlag <span class="token operator">=</span> collections<span class="token punctuation">.</span>namedtuple<span class="token punctuation">(</span><span class="token string">"Flag"</span><span class="token punctuation">,</span> <span class="token string">"mask offset"</span><span class="token punctuation">)</span>
    FLAGSDEF <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"REBOOT"</span><span class="token punctuation">:</span> _sdFlag<span class="token punctuation">(</span>mask<span class="token operator">=</span><span class="token number">0x80</span><span class="token punctuation">,</span> offset<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># ReBoot flag</span>
        <span class="token string">"UNICAST"</span><span class="token punctuation">:</span> _sdFlag<span class="token punctuation">(</span>mask<span class="token operator">=</span><span class="token number">0x40</span><span class="token punctuation">,</span> offset<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># UniCast flag</span>
    <span class="token punctuation">}</span>

    fields_desc <span class="token operator">=</span> <span class="token punctuation">[</span>
        ByteField<span class="token punctuation">(</span><span class="token string">"flags"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        X3BytesField<span class="token punctuation">(</span><span class="token string">"res"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        FieldLenField<span class="token punctuation">(</span>
            name<span class="token operator">=</span><span class="token string">"len_entry_array"</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> length_of<span class="token operator">=</span><span class="token string">"entry_array"</span><span class="token punctuation">,</span> fmt<span class="token operator">=</span><span class="token string">"!I"</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        PacketListField<span class="token punctuation">(</span>
            name<span class="token operator">=</span><span class="token string">"entry_array"</span><span class="token punctuation">,</span>
            default<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
            pkt_cls<span class="token operator">=</span>_SDEntry<span class="token punctuation">,</span>
            length_from<span class="token operator">=</span><span class="token keyword">lambda</span> pkt<span class="token punctuation">:</span> pkt<span class="token punctuation">.</span>len_entry_array<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        FieldLenField<span class="token punctuation">(</span>
            name<span class="token operator">=</span><span class="token string">"len_option_array"</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> length_of<span class="token operator">=</span><span class="token string">"option_array"</span><span class="token punctuation">,</span> fmt<span class="token operator">=</span><span class="token string">"!I"</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        PacketListField<span class="token punctuation">(</span>
            name<span class="token operator">=</span><span class="token string">"option_array"</span><span class="token punctuation">,</span>
            default<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
            pkt_cls<span class="token operator">=</span>_SDOption<span class="token punctuation">,</span>
            length_from<span class="token operator">=</span><span class="token keyword">lambda</span> pkt<span class="token punctuation">:</span> pkt<span class="token punctuation">.</span>len_option_array<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>SD<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>explicit <span class="token operator">=</span> <span class="token number">1</span>

    <span class="token keyword">def</span> <span class="token function">getFlag</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""get particular flag from bitfield."""</span>
        name <span class="token operator">=</span> name<span class="token punctuation">.</span>upper<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> name <span class="token keyword">in</span> self<span class="token punctuation">.</span>FLAGSDEF<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> self<span class="token punctuation">.</span>FLAGSDEF<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">.</span>mask<span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> self<span class="token punctuation">.</span>FLAGSDEF<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">.</span>offset
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">None</span>

    <span class="token keyword">def</span> <span class="token function">setFlag</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Set particular flag on bitfield.
         :param str name : name of the flag to set (see SD.FLAGSDEF)
         :param int value : either 0x1 or 0x0 (provided int will be ANDed with 0x01)
        """</span>
        name <span class="token operator">=</span> name<span class="token punctuation">.</span>upper<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> name <span class="token keyword">in</span> self<span class="token punctuation">.</span>FLAGSDEF<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>flags <span class="token operator">=</span> <span class="token punctuation">(</span>
                self<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> ctypes<span class="token punctuation">.</span>c_ubyte<span class="token punctuation">(</span><span class="token operator">~</span>self<span class="token punctuation">.</span>FLAGSDEF<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">.</span>mask<span class="token punctuation">)</span><span class="token punctuation">.</span>value
            <span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>value <span class="token operator">&amp;</span> <span class="token number">0x01</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> self<span class="token punctuation">.</span>FLAGSDEF<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">.</span>offset

    <span class="token keyword">def</span> <span class="token function">setEntryArray</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> entry_list<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Add entries to entry_array.
        :param entry_list: list of entries to be added. Single entry object also accepted
        """</span>
        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>entry_list<span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>entry_array <span class="token operator">=</span> entry_list
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>entry_array <span class="token operator">=</span> <span class="token punctuation">[</span>entry_list<span class="token punctuation">]</span>

    <span class="token keyword">def</span> <span class="token function">setOptionArray</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> option_list<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Add options to option_array.
        :param option_list: list of options to be added. Single option object also accepted
        """</span>
        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>option_list<span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>option_array <span class="token operator">=</span> option_list
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>option_array <span class="token operator">=</span> <span class="token punctuation">[</span>option_list<span class="token punctuation">]</span>

    <span class="token keyword">def</span> <span class="token function">getSomeip</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> stacked<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        return SD-initialized SOME/IP packet
        :param stacked: boolean. Either just SOME/IP packet or stacked over SD-self
        """</span>
        p <span class="token operator">=</span> SOMEIP<span class="token punctuation">(</span><span class="token punctuation">)</span>
        p<span class="token punctuation">.</span>msg_id<span class="token punctuation">.</span>srv_id <span class="token operator">=</span> SD<span class="token punctuation">.</span>SOMEIP_MSGID_SRVID
        p<span class="token punctuation">.</span>msg_id<span class="token punctuation">.</span>sub_id <span class="token operator">=</span> SD<span class="token punctuation">.</span>SOMEIP_MSGID_SUBID
        p<span class="token punctuation">.</span>msg_id<span class="token punctuation">.</span>event_id <span class="token operator">=</span> SD<span class="token punctuation">.</span>SOMEIP_MSGID_EVENTID
        p<span class="token punctuation">.</span>proto_ver <span class="token operator">=</span> SD<span class="token punctuation">.</span>SOMEIP_PROTO_VER
        p<span class="token punctuation">.</span>iface_ver <span class="token operator">=</span> SD<span class="token punctuation">.</span>SOMEIP_IFACE_VER
        p<span class="token punctuation">.</span>msg_type <span class="token operator">=</span> SD<span class="token punctuation">.</span>SOMEIP_MSG_TYPE


        <span class="token keyword">if</span> stacked<span class="token punctuation">:</span>
            <span class="token keyword">return</span> p <span class="token operator">/</span> self
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> p

    <span class="token keyword">def</span> <span class="token function">get_someip_with_session_id</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>session_id<span class="token punctuation">,</span> stacked<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        p <span class="token operator">=</span> SOMEIP<span class="token punctuation">(</span><span class="token punctuation">)</span>
        p<span class="token punctuation">.</span>msg_id<span class="token punctuation">.</span>srv_id <span class="token operator">=</span> SD<span class="token punctuation">.</span>SOMEIP_MSGID_SRVID
        p<span class="token punctuation">.</span>msg_id<span class="token punctuation">.</span>sub_id <span class="token operator">=</span> SD<span class="token punctuation">.</span>SOMEIP_MSGID_SUBID
        p<span class="token punctuation">.</span>msg_id<span class="token punctuation">.</span>event_id <span class="token operator">=</span> SD<span class="token punctuation">.</span>SOMEIP_MSGID_EVENTID
        p<span class="token punctuation">.</span>proto_ver <span class="token operator">=</span> SD<span class="token punctuation">.</span>SOMEIP_PROTO_VER
        p<span class="token punctuation">.</span>iface_ver <span class="token operator">=</span> SD<span class="token punctuation">.</span>SOMEIP_IFACE_VER
        p<span class="token punctuation">.</span>msg_type <span class="token operator">=</span> SD<span class="token punctuation">.</span>SOMEIP_MSG_TYPE
        p<span class="token punctuation">.</span>req_id<span class="token punctuation">.</span>session_id <span class="token operator">=</span> session_id

        <span class="token keyword">if</span> stacked<span class="token punctuation">:</span>
            <span class="token keyword">return</span> p <span class="token operator">/</span> self
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> p
</code></pre>
    <hr/>
    <h3>
     <a id="2eth_scapy_someippy_432">
     </a>
     2、eth_scapy_someip.py
    </h3>
    <pre><code class="prism language-python"><span class="token keyword">from</span> scapy<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>inet <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> scapy<span class="token punctuation">.</span>fields <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> scapy<span class="token punctuation">.</span>packet <span class="token keyword">import</span> <span class="token operator">*</span>

<span class="token triple-quoted-string string">"""SOMEIP PACKAGE DEFINITION"""</span>


<span class="token keyword">class</span> <span class="token class-name">_SOMEIP_MessageId</span><span class="token punctuation">(</span>Packet<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""MessageId subpacket."""</span>
    name <span class="token operator">=</span> <span class="token string">'MessageId'</span>
    fields_desc <span class="token operator">=</span> <span class="token punctuation">[</span>
        ShortField<span class="token punctuation">(</span><span class="token string">'srv_id'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        BitEnumField<span class="token punctuation">(</span><span class="token string">'sub_id'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">:</span> <span class="token string">'METHOD_ID'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span> <span class="token string">'EVENT_ID'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        ConditionalField<span class="token punctuation">(</span>BitField<span class="token punctuation">(</span><span class="token string">'method_id'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">lambda</span> pkt<span class="token punctuation">:</span> pkt<span class="token punctuation">.</span>sub_id <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        ConditionalField<span class="token punctuation">(</span>BitField<span class="token punctuation">(</span><span class="token string">'event_id'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">lambda</span> pkt<span class="token punctuation">:</span> pkt<span class="token punctuation">.</span>sub_id <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>

    <span class="token keyword">def</span> <span class="token function">extract_padding</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">''</span><span class="token punctuation">,</span> p


<span class="token keyword">class</span> <span class="token class-name">_SOMEIP_RequestId</span><span class="token punctuation">(</span>Packet<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">""" RequestId subpacket."""</span>
    name <span class="token operator">=</span> <span class="token string">'RequestId'</span>
    fields_desc <span class="token operator">=</span> <span class="token punctuation">[</span>
        ShortField<span class="token punctuation">(</span><span class="token string">'client_id'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        ShortField<span class="token punctuation">(</span><span class="token string">'session_id'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

    <span class="token keyword">def</span> <span class="token function">extract_padding</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">''</span><span class="token punctuation">,</span> p


<span class="token keyword">class</span> <span class="token class-name">SOMEIP</span><span class="token punctuation">(</span>Packet<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">""" SOME/IP Packet."""</span>
    <span class="token comment"># Default values</span>
    PROTOCOL_VERSION <span class="token operator">=</span> <span class="token number">0x01</span>
    INTERFACE_VERSION <span class="token operator">=</span> <span class="token number">0x01</span>

    <span class="token comment"># Lenght offset (without payload)</span>
    LEN_OFFSET <span class="token operator">=</span> <span class="token number">0x08</span>

    <span class="token comment"># SOME/IP TYPE VALUES</span>
    TYPE_REQUEST <span class="token operator">=</span> <span class="token number">0x00</span>
    TYPE_REQUEST_NO_RET <span class="token operator">=</span> <span class="token number">0x01</span>
    TYPE_NOTIFICATION <span class="token operator">=</span> <span class="token number">0x02</span>
    TYPE_REQUEST_ACK <span class="token operator">=</span> <span class="token number">0x40</span>
    TYPE_REQUEST_NORET_ACK <span class="token operator">=</span> <span class="token number">0x41</span>
    TYPE_NOTIFICATION_ACK <span class="token operator">=</span> <span class="token number">0x42</span>
    TYPE_RESPONSE <span class="token operator">=</span> <span class="token number">0x80</span>
    TYPE_ERROR <span class="token operator">=</span> <span class="token number">0x81</span>
    TYPE_RESPONSE_ACK <span class="token operator">=</span> <span class="token number">0xc0</span>
    TYPE_ERROR_ACK <span class="token operator">=</span> <span class="token number">0xc1</span>

    <span class="token comment"># SOME/IP-TP TYPE VALUES</span>
    TYPE_REQUEST_SEGMENT <span class="token operator">=</span> <span class="token number">0x20</span>
    TYPE_REQUEST_NO_RET_SEGMENT <span class="token operator">=</span> <span class="token number">0x21</span>
    TYPE_NOTIFICATION_SEGMENT <span class="token operator">=</span> <span class="token number">0x22</span>
    TYPE_REQUEST_ACK_SEGMENT <span class="token operator">=</span> <span class="token number">0x60</span>
    TYPE_REQUEST_NORET_ACK_SEGMENT <span class="token operator">=</span> <span class="token number">0x61</span>
    TYPE_NOTIFICATION_ACK_SEGMENT <span class="token operator">=</span> <span class="token number">0x62</span>
    TYPE_RESPONSE_SEGMENT <span class="token operator">=</span> <span class="token number">0xa0</span>
    TYPE_ERROR_SEGMENT <span class="token operator">=</span> <span class="token number">0xa1</span>
    TYPE_RESPONSE_ACK_SEGMENT <span class="token operator">=</span> <span class="token number">0xe0</span>
    TYPE_ERROR_ACK_SEGMENT <span class="token operator">=</span> <span class="token number">0xe1</span>
    SOMEIP_TP_TYPES <span class="token operator">=</span> <span class="token builtin">frozenset</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>TYPE_REQUEST_SEGMENT<span class="token punctuation">,</span> TYPE_REQUEST_NO_RET_SEGMENT<span class="token punctuation">,</span> TYPE_NOTIFICATION_SEGMENT<span class="token punctuation">,</span>
                                 TYPE_REQUEST_ACK_SEGMENT<span class="token punctuation">,</span> TYPE_REQUEST_NORET_ACK_SEGMENT<span class="token punctuation">,</span>
                                 TYPE_NOTIFICATION_ACK_SEGMENT<span class="token punctuation">,</span> TYPE_RESPONSE_SEGMENT<span class="token punctuation">,</span> TYPE_ERROR_SEGMENT<span class="token punctuation">,</span>
                                 TYPE_RESPONSE_ACK_SEGMENT<span class="token punctuation">,</span> TYPE_ERROR_ACK_SEGMENT<span class="token punctuation">}</span><span class="token punctuation">)</span>
    SOMEIP_TP_TYPE_BIT_MASK <span class="token operator">=</span> <span class="token number">0x20</span>

    <span class="token comment"># SOME/IP RETURN CODES</span>
    RET_E_OK <span class="token operator">=</span> <span class="token number">0x00</span>
    RET_E_NOT_OK <span class="token operator">=</span> <span class="token number">0x01</span>
    RET_E_UNKNOWN_SERVICE <span class="token operator">=</span> <span class="token number">0x02</span>
    RET_E_UNKNOWN_METHOD <span class="token operator">=</span> <span class="token number">0x03</span>
    RET_E_NOT_READY <span class="token operator">=</span> <span class="token number">0x04</span>
    RET_E_NOT_REACHABLE <span class="token operator">=</span> <span class="token number">0x05</span>
    RET_E_TIMEOUT <span class="token operator">=</span> <span class="token number">0x06</span>
    RET_E_WRONG_PROTOCOL_V <span class="token operator">=</span> <span class="token number">0x07</span>
    RET_E_WRONG_INTERFACE_V <span class="token operator">=</span> <span class="token number">0x08</span>
    RET_E_MALFORMED_MSG <span class="token operator">=</span> <span class="token number">0x09</span>
    RET_E_WRONG_MESSAGE_TYPE <span class="token operator">=</span> <span class="token number">0x0a</span>

    <span class="token comment"># SOME/IP-TP More Segments Flag</span>
    SOMEIP_TP_LAST_SEGMENT <span class="token operator">=</span> <span class="token number">0</span>
    SOMEIP_TP_MORE_SEGMENTS <span class="token operator">=</span> <span class="token number">1</span>

    _OVERALL_LEN_NOPAYLOAD <span class="token operator">=</span> <span class="token number">16</span>  <span class="token comment"># UT</span>

    name <span class="token operator">=</span> <span class="token string">'SOME/IP'</span>

    fields_desc <span class="token operator">=</span> <span class="token punctuation">[</span>
        PacketField<span class="token punctuation">(</span><span class="token string">'msg_id'</span><span class="token punctuation">,</span> _SOMEIP_MessageId<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> _SOMEIP_MessageId<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># MessageID</span>
        IntField<span class="token punctuation">(</span><span class="token string">'len'</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># Length</span>
        PacketField<span class="token punctuation">(</span><span class="token string">'req_id'</span><span class="token punctuation">,</span> _SOMEIP_RequestId<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> _SOMEIP_RequestId<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># RequestID</span>
        ByteField<span class="token punctuation">(</span><span class="token string">'proto_ver'</span><span class="token punctuation">,</span> PROTOCOL_VERSION<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># Protocol version</span>
        ByteField<span class="token punctuation">(</span><span class="token string">'iface_ver'</span><span class="token punctuation">,</span> INTERFACE_VERSION<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># Interface version</span>
        ByteEnumField<span class="token punctuation">(</span><span class="token string">'msg_type'</span><span class="token punctuation">,</span> TYPE_REQUEST<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>  <span class="token comment"># -- Message type --</span>
            TYPE_REQUEST<span class="token punctuation">:</span> <span class="token string">'REQUEST'</span><span class="token punctuation">,</span>  <span class="token comment"># 0x00</span>
            TYPE_REQUEST_NO_RET<span class="token punctuation">:</span> <span class="token string">'REQUEST_NO_RETURN'</span><span class="token punctuation">,</span>  <span class="token comment"># 0x01</span>
            TYPE_NOTIFICATION<span class="token punctuation">:</span> <span class="token string">'NOTIFICATION'</span><span class="token punctuation">,</span>  <span class="token comment"># 0x02</span>
            TYPE_REQUEST_ACK<span class="token punctuation">:</span> <span class="token string">'REQUEST_ACK'</span><span class="token punctuation">,</span>  <span class="token comment"># 0x40</span>
            TYPE_REQUEST_NORET_ACK<span class="token punctuation">:</span> <span class="token string">'REQUEST_NO_RETURN_ACK'</span><span class="token punctuation">,</span>  <span class="token comment"># 0x41</span>
            TYPE_NOTIFICATION_ACK<span class="token punctuation">:</span> <span class="token string">'NOTIFICATION_ACK'</span><span class="token punctuation">,</span>  <span class="token comment"># 0x42</span>
            TYPE_RESPONSE<span class="token punctuation">:</span> <span class="token string">'RESPONSE'</span><span class="token punctuation">,</span>  <span class="token comment"># 0x80</span>
            TYPE_ERROR<span class="token punctuation">:</span> <span class="token string">'ERROR'</span><span class="token punctuation">,</span>  <span class="token comment"># 0x81</span>
            TYPE_RESPONSE_ACK<span class="token punctuation">:</span> <span class="token string">'RESPONSE_ACK'</span><span class="token punctuation">,</span>  <span class="token comment"># 0xc0</span>
            TYPE_ERROR_ACK<span class="token punctuation">:</span> <span class="token string">'ERROR_ACK'</span><span class="token punctuation">,</span>  <span class="token comment"># 0xc1</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        ByteEnumField<span class="token punctuation">(</span><span class="token string">'retcode'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>  <span class="token comment"># -- Return code --</span>
            RET_E_OK<span class="token punctuation">:</span> <span class="token string">'E_OK'</span><span class="token punctuation">,</span>  <span class="token comment"># 0x00</span>
            RET_E_NOT_OK<span class="token punctuation">:</span> <span class="token string">'E_NOT_OK'</span><span class="token punctuation">,</span>  <span class="token comment"># 0x01</span>
            RET_E_UNKNOWN_SERVICE<span class="token punctuation">:</span> <span class="token string">'E_UNKNOWN_SERVICE'</span><span class="token punctuation">,</span>  <span class="token comment"># 0x02</span>
            RET_E_UNKNOWN_METHOD<span class="token punctuation">:</span> <span class="token string">'E_UNKNOWN_METHOD'</span><span class="token punctuation">,</span>  <span class="token comment"># 0x03</span>
            RET_E_NOT_READY<span class="token punctuation">:</span> <span class="token string">'E_NOT_READY'</span><span class="token punctuation">,</span>  <span class="token comment"># 0x04</span>
            RET_E_NOT_REACHABLE<span class="token punctuation">:</span> <span class="token string">'E_NOT_REACHABLE'</span><span class="token punctuation">,</span>  <span class="token comment"># 0x05</span>
            RET_E_TIMEOUT<span class="token punctuation">:</span> <span class="token string">'E_TIMEOUT'</span><span class="token punctuation">,</span>  <span class="token comment"># 0x06</span>
            RET_E_WRONG_PROTOCOL_V<span class="token punctuation">:</span> <span class="token string">'E_WRONG_PROTOCOL_VERSION'</span><span class="token punctuation">,</span>  <span class="token comment"># 0x07</span>
            RET_E_WRONG_INTERFACE_V<span class="token punctuation">:</span> <span class="token string">'E_WRONG_INTERFACE_VERSION'</span><span class="token punctuation">,</span>  <span class="token comment"># 0x08</span>
            RET_E_MALFORMED_MSG<span class="token punctuation">:</span> <span class="token string">'E_MALFORMED_MESSAGE'</span><span class="token punctuation">,</span>  <span class="token comment"># 0x09</span>
            RET_E_WRONG_MESSAGE_TYPE<span class="token punctuation">:</span> <span class="token string">'E_WRONG_MESSAGE_TYPE'</span><span class="token punctuation">,</span>  <span class="token comment"># 0x0a</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        ConditionalField<span class="token punctuation">(</span>BitField<span class="token punctuation">(</span><span class="token string">'offset'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">lambda</span> pkt<span class="token punctuation">:</span> pkt<span class="token punctuation">.</span>msg_type <span class="token keyword">in</span> SOMEIP<span class="token punctuation">.</span>SOMEIP_TP_TYPES<span class="token punctuation">)</span><span class="token punctuation">,</span>
        ConditionalField<span class="token punctuation">(</span>BitField<span class="token punctuation">(</span><span class="token string">'reserved'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">lambda</span> pkt<span class="token punctuation">:</span> pkt<span class="token punctuation">.</span>msg_type <span class="token keyword">in</span> SOMEIP<span class="token punctuation">.</span>SOMEIP_TP_TYPES<span class="token punctuation">)</span><span class="token punctuation">,</span>
        ConditionalField<span class="token punctuation">(</span>BitEnumField<span class="token punctuation">(</span><span class="token string">'more_segments'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>SOMEIP_TP_LAST_SEGMENT<span class="token punctuation">:</span> <span class="token string">'Last_Segment'</span><span class="token punctuation">,</span>
                                                              SOMEIP_TP_MORE_SEGMENTS<span class="token punctuation">:</span> <span class="token string">'More_Segments'</span>
                                                              <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">lambda</span> pkt<span class="token punctuation">:</span> pkt<span class="token punctuation">.</span>msg_type <span class="token keyword">in</span> SOMEIP<span class="token punctuation">.</span>SOMEIP_TP_TYPES<span class="token punctuation">)</span>
    <span class="token punctuation">]</span>

    <span class="token keyword">def</span> <span class="token function">post_build</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> p<span class="token punctuation">,</span> pay<span class="token punctuation">)</span><span class="token punctuation">:</span>
        length <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token builtin">len</span>
        <span class="token comment"># length computation : RequestID + PROTOVER_IFACEVER_TYPE_RETCODE + PAYLOAD</span>
        <span class="token keyword">if</span> length <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            length <span class="token operator">=</span> self<span class="token punctuation">.</span>LEN_OFFSET <span class="token operator">+</span> <span class="token builtin">len</span><span class="token punctuation">(</span>pay<span class="token punctuation">)</span>
            p <span class="token operator">=</span> p<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">+</span> struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">'!I'</span><span class="token punctuation">,</span> length<span class="token punctuation">)</span> <span class="token operator">+</span> p<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
        <span class="token keyword">return</span> p <span class="token operator">+</span> pay


<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    bind_layers<span class="token punctuation">(</span>UDP<span class="token punctuation">,</span> SOMEIP<span class="token punctuation">,</span> sport<span class="token operator">=</span><span class="token number">30490</span> <span class="token operator">+</span> i<span class="token punctuation">)</span>
    bind_layers<span class="token punctuation">(</span>TCP<span class="token punctuation">,</span> SOMEIP<span class="token punctuation">,</span> sport<span class="token operator">=</span><span class="token number">30490</span> <span class="token operator">+</span> i<span class="token punctuation">)</span>

</code></pre>
    <hr/>
    <h3>
     <a id="3network_definepy_580">
     </a>
     3、network_define.py
    </h3>
    <pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">EthParameter</span><span class="token punctuation">:</span>
    <span class="token comment"># 广播</span>
    sd_network_card <span class="token operator">=</span> <span class="token string">"eth0.62"</span>
    sd_ip <span class="token operator">=</span> <span class="token string">"239.0.0.255"</span>

    <span class="token comment"># 本机</span>
    server_network_card <span class="token operator">=</span> <span class="token string">"Realtek PCIe GbE Family Controller #2"</span>
    server_ip <span class="token operator">=</span> <span class="token string">"192.168.62.31"</span>

    <span class="token comment"># 域控</span>
    client_network_card <span class="token operator">=</span> <span class="token string">"eth0.62"</span>
    client_ip <span class="token operator">=</span> <span class="token string">"192.168.62.11"</span>

    sd_port <span class="token operator">=</span> <span class="token number">30490</span>
    producer_port <span class="token operator">=</span> <span class="token number">30500</span>
    consumer_prot <span class="token operator">=</span> <span class="token number">30501</span>
</code></pre>
    <hr/>
    <h3>
     <a id="4packet_definepy_602">
     </a>
     4、packet_define.py
    </h3>
    <pre><code class="prism language-python"><span class="token keyword">import</span> eth_scapy_sd <span class="token keyword">as</span> sd

<span class="token keyword">from</span> network_define <span class="token keyword">import</span> EthParameter

<span class="token keyword">from</span> scapy<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>l2 <span class="token keyword">import</span> Ether
<span class="token keyword">from</span> scapy<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>inet <span class="token keyword">import</span> IP<span class="token punctuation">,</span> UDP


<span class="token keyword">class</span> <span class="token class-name">SomeipPacker</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>eth_para <span class="token operator">=</span> EthParameter<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>sd_session_id <span class="token operator">=</span> <span class="token number">1</span>
        self<span class="token punctuation">.</span>client_session_id <span class="token operator">=</span> <span class="token number">1</span>

    <span class="token keyword">def</span> <span class="token function">update_sd_session_id</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""更新session_id，从0递增到65535"""</span>
        self<span class="token punctuation">.</span>sd_session_id <span class="token operator">+=</span> <span class="token number">1</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>sd_session_id <span class="token operator">&gt;=</span> <span class="token number">65535</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>sd_session_id <span class="token operator">=</span> <span class="token number">0</span>

    <span class="token keyword">def</span> <span class="token function">update_client_session_id</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>client_session_id <span class="token operator">+=</span> <span class="token number">1</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>client_session_id <span class="token operator">&gt;=</span> <span class="token number">65535</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>client_session_id <span class="token operator">=</span> <span class="token number">0</span>


    <span class="token comment"># ===========================#</span>
    <span class="token comment">#          序列化             #</span>
    <span class="token comment"># ===========================#</span>
    <span class="token keyword">def</span> <span class="token function">packet_subscribe</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> service_id<span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">,</span> ttl<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""组事件订阅包"""</span>
        subscribe_packager <span class="token operator">=</span> sd<span class="token punctuation">.</span>SD<span class="token punctuation">(</span><span class="token punctuation">)</span>
        subscribe_packager<span class="token punctuation">.</span>setFlag<span class="token punctuation">(</span><span class="token string">"REBOOT"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        subscribe_packager<span class="token punctuation">.</span>setFlag<span class="token punctuation">(</span><span class="token string">"UNICAST"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        subscribe_packager<span class="token punctuation">.</span>len_entry_array <span class="token operator">=</span> <span class="token number">16</span> <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>service_id<span class="token punctuation">)</span>
        subscribe_packager<span class="token punctuation">.</span>len_option_array <span class="token operator">=</span> <span class="token number">24</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> service_id<span class="token punctuation">:</span>
            subscribe_packager<span class="token punctuation">.</span>entry_array<span class="token punctuation">.</span>append<span class="token punctuation">(</span>
                sd<span class="token punctuation">.</span>SDEntry_EventGroup<span class="token punctuation">(</span>
                    <span class="token builtin">type</span><span class="token operator">=</span>sd<span class="token punctuation">.</span>SDEntry_EventGroup<span class="token punctuation">.</span>TYPE_EVTGRP_SUBSCRIBE<span class="token punctuation">,</span>
                    srv_id<span class="token operator">=</span>i<span class="token punctuation">,</span>
                    inst_id<span class="token operator">=</span><span class="token number">0x1</span><span class="token punctuation">,</span>
                    n_opt_1<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>
                    major_ver<span class="token operator">=</span><span class="token number">0x1</span><span class="token punctuation">,</span>
                    ttl<span class="token operator">=</span>ttl<span class="token punctuation">,</span>
                    eventgroup_id<span class="token operator">=</span><span class="token number">0x1</span><span class="token punctuation">,</span>
                <span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
        subscribe_packager<span class="token punctuation">.</span>option_array <span class="token operator">=</span> <span class="token punctuation">[</span>
            <span class="token comment"># UDP EndPoint</span>
            sd<span class="token punctuation">.</span>SDOption_IP4_EndPoint<span class="token punctuation">(</span>
                addr<span class="token operator">=</span>self<span class="token punctuation">.</span>eth_para<span class="token punctuation">.</span>server_ip<span class="token punctuation">,</span>
                l4_proto<span class="token operator">=</span><span class="token number">0x11</span><span class="token punctuation">,</span>
                port<span class="token operator">=</span>self<span class="token punctuation">.</span>eth_para<span class="token punctuation">.</span>consumer_prot<span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment"># TCP EndPoint</span>
            sd<span class="token punctuation">.</span>SDOption_IP4_EndPoint<span class="token punctuation">(</span>
                addr<span class="token operator">=</span>self<span class="token punctuation">.</span>eth_para<span class="token punctuation">.</span>server_ip<span class="token punctuation">,</span>
                l4_proto<span class="token operator">=</span><span class="token number">0x06</span><span class="token punctuation">,</span>
                port<span class="token operator">=</span>self<span class="token punctuation">.</span>eth_para<span class="token punctuation">.</span>consumer_prot<span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>subscribe_packager<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        subscribe_package <span class="token operator">=</span> <span class="token punctuation">(</span>
            Ether<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">/</span> IP<span class="token punctuation">(</span>src<span class="token operator">=</span>self<span class="token punctuation">.</span>eth_para<span class="token punctuation">.</span>server_ip<span class="token punctuation">,</span> dst<span class="token operator">=</span>self<span class="token punctuation">.</span>eth_para<span class="token punctuation">.</span>client_ip<span class="token punctuation">)</span>
            <span class="token operator">/</span> UDP<span class="token punctuation">(</span>sport<span class="token operator">=</span>self<span class="token punctuation">.</span>eth_para<span class="token punctuation">.</span>sd_port<span class="token punctuation">,</span> dport<span class="token operator">=</span>self<span class="token punctuation">.</span>eth_para<span class="token punctuation">.</span>sd_port<span class="token punctuation">)</span>
            <span class="token operator">/</span> subscribe_packager<span class="token punctuation">.</span>get_someip_with_session_id<span class="token punctuation">(</span>
                self<span class="token punctuation">.</span>client_session_id<span class="token punctuation">,</span> <span class="token boolean">True</span>
            <span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>update_client_session_id<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> subscribe_package

    <span class="token keyword">def</span> <span class="token function">packet_subscribe_ack</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> service_id<span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">,</span> ttl<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""组ack包"""</span>
        ack_packager <span class="token operator">=</span> sd<span class="token punctuation">.</span>SD<span class="token punctuation">(</span><span class="token punctuation">)</span>
        ack_packager<span class="token punctuation">.</span>setFlag<span class="token punctuation">(</span><span class="token string">"REBOOT"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        ack_packager<span class="token punctuation">.</span>setFlag<span class="token punctuation">(</span><span class="token string">"UNICAST"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        ack_packager<span class="token punctuation">.</span>len_entry_array <span class="token operator">=</span> <span class="token number">16</span> <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>service_id<span class="token punctuation">)</span>
        ack_packager<span class="token punctuation">.</span>len_option_array <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> service_id<span class="token punctuation">:</span>
            ack_packager<span class="token punctuation">.</span>entry_array<span class="token punctuation">.</span>append<span class="token punctuation">(</span>
                sd<span class="token punctuation">.</span>SDEntry_EventGroup<span class="token punctuation">(</span>
                    <span class="token builtin">type</span><span class="token operator">=</span>sd<span class="token punctuation">.</span>SDEntry_EventGroup<span class="token punctuation">.</span>TYPE_EVTGRP_SUBSCRIBE_ACK<span class="token punctuation">,</span>
                    srv_id<span class="token operator">=</span>i<span class="token punctuation">,</span>
                    inst_id<span class="token operator">=</span><span class="token number">0x1</span><span class="token punctuation">,</span>
                    major_ver<span class="token operator">=</span><span class="token number">0x1</span><span class="token punctuation">,</span>
                    ttl<span class="token operator">=</span>ttl<span class="token punctuation">,</span>
                    eventgroup_id<span class="token operator">=</span><span class="token number">0x1</span><span class="token punctuation">,</span>
                <span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>ack_packager<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        ack_package <span class="token operator">=</span> <span class="token punctuation">(</span>
            Ether<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">/</span> IP<span class="token punctuation">(</span>src<span class="token operator">=</span>self<span class="token punctuation">.</span>eth_para<span class="token punctuation">.</span>server_ip<span class="token punctuation">,</span> dst<span class="token operator">=</span>self<span class="token punctuation">.</span>eth_para<span class="token punctuation">.</span>client_ip<span class="token punctuation">)</span>
            <span class="token operator">/</span> UDP<span class="token punctuation">(</span>sport<span class="token operator">=</span>self<span class="token punctuation">.</span>eth_para<span class="token punctuation">.</span>sd_port<span class="token punctuation">,</span> dport<span class="token operator">=</span>self<span class="token punctuation">.</span>eth_para<span class="token punctuation">.</span>sd_port<span class="token punctuation">)</span>
            <span class="token operator">/</span> ack_packager<span class="token punctuation">.</span>get_someip_with_session_id<span class="token punctuation">(</span>self<span class="token punctuation">.</span>client_session_id<span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>update_client_session_id<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> ack_package

    <span class="token keyword">def</span> <span class="token function">packet_offer</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> service_id<span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">,</span> ttl<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""组offer包"""</span>
        offer_packager <span class="token operator">=</span> sd<span class="token punctuation">.</span>SD<span class="token punctuation">(</span><span class="token punctuation">)</span>
        offer_packager<span class="token punctuation">.</span>setFlag<span class="token punctuation">(</span><span class="token string">"REBOOT"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        offer_packager<span class="token punctuation">.</span>setFlag<span class="token punctuation">(</span><span class="token string">"UNICAST"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        offer_packager<span class="token punctuation">.</span>len_entry_array <span class="token operator">=</span> <span class="token number">16</span> <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>service_id<span class="token punctuation">)</span>
        offer_packager<span class="token punctuation">.</span>len_option_array <span class="token operator">=</span> <span class="token number">12</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> service_id<span class="token punctuation">:</span>
            offer_packager<span class="token punctuation">.</span>entry_array<span class="token punctuation">.</span>append<span class="token punctuation">(</span>
                sd<span class="token punctuation">.</span>SDEntry_Service<span class="token punctuation">(</span>
                    <span class="token builtin">type</span><span class="token operator">=</span>sd<span class="token punctuation">.</span>SDEntry_Service<span class="token punctuation">.</span>TYPE_SRV_OFFERSERVICE<span class="token punctuation">,</span>
                    srv_id<span class="token operator">=</span>i<span class="token punctuation">,</span>
                    inst_id<span class="token operator">=</span><span class="token number">0x1</span><span class="token punctuation">,</span>
                    n_opt_1<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
                    major_ver<span class="token operator">=</span><span class="token number">0x1</span><span class="token punctuation">,</span>
                    minor_ver<span class="token operator">=</span><span class="token number">0x01</span><span class="token punctuation">,</span>
                    ttl<span class="token operator">=</span>ttl<span class="token punctuation">,</span>
                <span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
        offer_packager<span class="token punctuation">.</span>option_array <span class="token operator">=</span> <span class="token punctuation">[</span>
            sd<span class="token punctuation">.</span>SDOption_IP4_EndPoint<span class="token punctuation">(</span>
                addr<span class="token operator">=</span>self<span class="token punctuation">.</span>eth_para<span class="token punctuation">.</span>server_ip<span class="token punctuation">,</span>
                l4_proto<span class="token operator">=</span><span class="token number">0x11</span><span class="token punctuation">,</span>
                port<span class="token operator">=</span>self<span class="token punctuation">.</span>eth_para<span class="token punctuation">.</span>producer_port<span class="token punctuation">,</span>
            <span class="token punctuation">)</span>
        <span class="token punctuation">]</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>offer_packager<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        offer_package <span class="token operator">=</span> <span class="token punctuation">(</span>
            Ether<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">/</span> IP<span class="token punctuation">(</span>src<span class="token operator">=</span>self<span class="token punctuation">.</span>eth_para<span class="token punctuation">.</span>server_ip<span class="token punctuation">,</span> dst<span class="token operator">=</span>self<span class="token punctuation">.</span>eth_para<span class="token punctuation">.</span>sd_ip<span class="token punctuation">)</span>
            <span class="token operator">/</span> UDP<span class="token punctuation">(</span>sport<span class="token operator">=</span>self<span class="token punctuation">.</span>eth_para<span class="token punctuation">.</span>sd_port<span class="token punctuation">,</span> dport<span class="token operator">=</span>self<span class="token punctuation">.</span>eth_para<span class="token punctuation">.</span>sd_port<span class="token punctuation">)</span>
            <span class="token operator">/</span> offer_packager<span class="token punctuation">.</span>get_someip_with_session_id<span class="token punctuation">(</span>self<span class="token punctuation">.</span>sd_session_id<span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>update_sd_session_id<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> offer_package

</code></pre>
    <hr/>
    <h3>
     <a id="5unpack_definepy_745">
     </a>
     5、unpack_define.py
    </h3>
    <pre><code class="prism language-python"><span class="token keyword">from</span> scapy<span class="token punctuation">.</span>packet <span class="token keyword">import</span> Raw
<span class="token keyword">from</span> typing <span class="token keyword">import</span> Optional
<span class="token keyword">from</span> dataclasses <span class="token keyword">import</span> dataclass

<span class="token decorator annotation punctuation">@dataclass</span>
<span class="token keyword">class</span> <span class="token class-name">SomeIPHeaderParams</span><span class="token punctuation">:</span>
    service_id<span class="token punctuation">:</span> <span class="token builtin">int</span>
    event_id<span class="token punctuation">:</span> <span class="token builtin">int</span>      <span class="token comment"># 或 event_id，取决于消息类型</span>
    client_id<span class="token punctuation">:</span> <span class="token builtin">int</span>
    session_id<span class="token punctuation">:</span> <span class="token builtin">int</span>
    msg_type<span class="token punctuation">:</span> <span class="token builtin">int</span>
    return_code<span class="token punctuation">:</span> <span class="token builtin">int</span>
    length<span class="token punctuation">:</span> <span class="token builtin">int</span>
    protocol_version<span class="token punctuation">:</span> <span class="token builtin">int</span>
    interface_version<span class="token punctuation">:</span> <span class="token builtin">int</span>


<span class="token keyword">class</span> <span class="token class-name">SomeipUnpacker</span><span class="token punctuation">:</span>
    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">get_someip_header_params</span><span class="token punctuation">(</span>receive_packet<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Optional<span class="token punctuation">[</span>SomeIPHeaderParams<span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""获取someip header"""</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> receive_packet<span class="token punctuation">.</span>haslayer<span class="token punctuation">(</span><span class="token string">"SOME/IP"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                someip_layer <span class="token operator">=</span> receive_packet<span class="token punctuation">[</span><span class="token string">"SOME/IP"</span><span class="token punctuation">]</span>
                <span class="token comment"># 获取someip header值</span>
                service_id <span class="token operator">=</span> someip_layer<span class="token punctuation">.</span>msg_id<span class="token punctuation">.</span>srv_id
                sub_id <span class="token operator">=</span> someip_layer<span class="token punctuation">.</span>msg_id<span class="token punctuation">.</span>sub_id
                event_id <span class="token operator">=</span> sub_id <span class="token operator">&lt;&lt;</span> <span class="token number">15</span> <span class="token operator">|</span> someip_layer<span class="token punctuation">.</span>msg_id<span class="token punctuation">.</span>event_id
                <span class="token comment"># 提取请求 ID（Client ID 和 Session ID）</span>
                req_id <span class="token operator">=</span> someip_layer<span class="token punctuation">.</span>req_id
                client_id <span class="token operator">=</span> req_id<span class="token punctuation">.</span>client_id
                session_id <span class="token operator">=</span> req_id<span class="token punctuation">.</span>session_id

                <span class="token comment"># 构造头部对象</span>
                <span class="token keyword">return</span> SomeIPHeaderParams<span class="token punctuation">(</span>
                    service_id<span class="token operator">=</span>service_id<span class="token punctuation">,</span>
                    event_id<span class="token operator">=</span>event_id<span class="token punctuation">,</span>
                    client_id<span class="token operator">=</span>client_id<span class="token punctuation">,</span>
                    session_id<span class="token operator">=</span>session_id<span class="token punctuation">,</span>
                    msg_type<span class="token operator">=</span>someip_layer<span class="token punctuation">.</span>msg_type<span class="token punctuation">,</span>
                    return_code<span class="token operator">=</span>someip_layer<span class="token punctuation">.</span>retcode<span class="token punctuation">,</span>
                    length<span class="token operator">=</span>someip_layer<span class="token punctuation">.</span><span class="token builtin">len</span><span class="token punctuation">,</span>
                    protocol_version<span class="token operator">=</span>someip_layer<span class="token punctuation">.</span>proto_ver<span class="token punctuation">,</span>
                    interface_version<span class="token operator">=</span>someip_layer<span class="token punctuation">.</span>iface_ver<span class="token punctuation">,</span>
                <span class="token punctuation">)</span>
        <span class="token keyword">except</span> <span class="token punctuation">(</span>AttributeError<span class="token punctuation">,</span> ValueError<span class="token punctuation">)</span> <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"解析失败: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">None</span>


    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">get_someip_payload</span><span class="token punctuation">(</span>receive_packet<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""获取someip payload"""</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            someip_payload <span class="token operator">=</span> receive_packet<span class="token punctuation">[</span>Raw<span class="token punctuation">]</span><span class="token punctuation">.</span>load
            <span class="token comment"># print(f"someip_payload: {someip_payload}")</span>
            <span class="token keyword">return</span> someip_payload
        <span class="token keyword">except</span> AttributeError<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">None</span>
</code></pre>
    <h3>
     <a id="6someip_controllerpy_809">
     </a>
     6、someip_controller.py
    </h3>
    <pre><code class="prism language-python"><span class="token keyword">import</span> threading
<span class="token keyword">import</span> socket
<span class="token keyword">import</span> time
<span class="token keyword">from</span> module<span class="token punctuation">.</span>packet_define <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> module<span class="token punctuation">.</span>unpack_define <span class="token keyword">import</span> <span class="token operator">*</span>

<span class="token keyword">from</span> scapy<span class="token punctuation">.</span>sendrecv <span class="token keyword">import</span> sendp<span class="token punctuation">,</span> sniff

<span class="token keyword">class</span> <span class="token class-name">SomeipController</span><span class="token punctuation">(</span>threading<span class="token punctuation">.</span>Thread<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> someip_packer<span class="token punctuation">:</span> SomeipPacker<span class="token punctuation">,</span> someip_unpacker<span class="token punctuation">:</span> SomeipUnpacker<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>someip_packer <span class="token operator">=</span> someip_packer
        self<span class="token punctuation">.</span>someip_unpacker <span class="token operator">=</span> someip_unpacker
        self<span class="token punctuation">.</span>_stop_event <span class="token operator">=</span> threading<span class="token punctuation">.</span>Event<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>running <span class="token operator">=</span> <span class="token boolean">True</span>

    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 创建并发送offer以及订阅ack报文(这里忽略订阅，直接回复订阅ack)</span>
        service_id_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0xA994</span><span class="token punctuation">,</span> <span class="token number">0xA995</span><span class="token punctuation">]</span>
        _offer <span class="token operator">=</span> self<span class="token punctuation">.</span>someip_packer<span class="token punctuation">.</span>packet_offer<span class="token punctuation">(</span>
            service_id<span class="token operator">=</span>service_id_list<span class="token punctuation">,</span>
            ttl<span class="token operator">=</span><span class="token number">3</span>
        <span class="token punctuation">)</span>
        _offer_sender <span class="token operator">=</span> SomeipSendLoop<span class="token punctuation">(</span>
            network_card<span class="token operator">=</span>EthParameter<span class="token punctuation">.</span>sd_network_card<span class="token punctuation">,</span>
            someip_packer<span class="token operator">=</span>_offer<span class="token punctuation">,</span>
            cycle_time_ms<span class="token operator">=</span><span class="token number">2000</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>

        <span class="token comment"># 回复订阅ACK</span>
        _subscribe_ack <span class="token operator">=</span> self<span class="token punctuation">.</span>someip_packer<span class="token punctuation">.</span>packet_subscribe_ack<span class="token punctuation">(</span>
            service_id<span class="token operator">=</span>service_id_list<span class="token punctuation">,</span>
            ttl<span class="token operator">=</span><span class="token number">3</span>
        <span class="token punctuation">)</span>
        _subscribe_ack_sender <span class="token operator">=</span> SomeipSendLoop<span class="token punctuation">(</span>
            network_card<span class="token operator">=</span>EthParameter<span class="token punctuation">.</span>sd_network_card<span class="token punctuation">,</span>
            someip_packer<span class="token operator">=</span>_subscribe_ack<span class="token punctuation">,</span>
            cycle_time_ms<span class="token operator">=</span><span class="token number">2000</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>

        <span class="token comment"># 创建并发送订阅报文(订阅0xAB03， 0xAB04)</span>
        _subscribe <span class="token operator">=</span> self<span class="token punctuation">.</span>someip_packer<span class="token punctuation">.</span>packet_subscribe<span class="token punctuation">(</span>
            service_id<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0xAB03</span><span class="token punctuation">,</span><span class="token number">0xAB04</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ttl<span class="token operator">=</span><span class="token number">0x03</span>
        <span class="token punctuation">)</span>
        _subscribe_sender <span class="token operator">=</span> SomeipSendLoop<span class="token punctuation">(</span>
            network_card<span class="token operator">=</span>EthParameter<span class="token punctuation">.</span>server_network_card<span class="token punctuation">,</span>
            someip_packer<span class="token operator">=</span>_subscribe<span class="token punctuation">,</span>
            cycle_time_ms<span class="token operator">=</span><span class="token number">2000</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>

        <span class="token comment"># 启动接收模块</span>
        someip_receiver <span class="token operator">=</span> SomeIpReceiver<span class="token punctuation">(</span>EthParameter<span class="token punctuation">.</span>server_network_card<span class="token punctuation">)</span>

        <span class="token keyword">while</span> self<span class="token punctuation">.</span>_stop_event<span class="token punctuation">:</span>
            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.01</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">stop</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>running <span class="token operator">=</span> <span class="token boolean">False</span>  <span class="token comment"># 设置标志位为 False 来停止</span>
        self<span class="token punctuation">.</span>_stop_event<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">SomeipSendLoop</span><span class="token punctuation">(</span>threading<span class="token punctuation">.</span>Thread<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> network_card<span class="token punctuation">,</span> someip_packer<span class="token punctuation">,</span> cycle_time_ms<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>network_card <span class="token operator">=</span> network_card
        self<span class="token punctuation">.</span>someip_packer <span class="token operator">=</span> someip_packer
        self<span class="token punctuation">.</span>cycle_time_ms <span class="token operator">=</span> cycle_time_ms
        self<span class="token punctuation">.</span>_stop_event <span class="token operator">=</span> threading<span class="token punctuation">.</span>Event<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">while</span> self<span class="token punctuation">.</span>_stop_event<span class="token punctuation">:</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>someip_packer<span class="token punctuation">:</span>
                sendp<span class="token punctuation">(</span>self<span class="token punctuation">.</span>someip_packer<span class="token punctuation">,</span> iface<span class="token operator">=</span>self<span class="token punctuation">.</span>network_card<span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
                time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>self<span class="token punctuation">.</span>cycle_time_ms <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">stop</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>_stop_event<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">SomeIpReceiver</span><span class="token punctuation">(</span>threading<span class="token punctuation">.</span>Thread<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>
        self<span class="token punctuation">,</span>
        eth_desc<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
        someip_unpacker
    <span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_eth_desc <span class="token operator">=</span> eth_desc
        self<span class="token punctuation">.</span>_unpacker <span class="token operator">=</span> someip_unpacker
        self<span class="token punctuation">.</span>_terminated <span class="token operator">=</span> <span class="token boolean">False</span>
        self<span class="token punctuation">.</span>_stop_event <span class="token operator">=</span>threading<span class="token punctuation">.</span>Event<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">packet_callback</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> packet<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> packet<span class="token punctuation">:</span>
            header_param <span class="token operator">=</span> self<span class="token punctuation">.</span>_unpacker<span class="token punctuation">.</span>get_someip_header_params<span class="token punctuation">(</span>
                receive_packet<span class="token operator">=</span>packet
            <span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"msg_type: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>header_param<span class="token punctuation">.</span>msg_type<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        sniff<span class="token punctuation">(</span>
            iface<span class="token operator">=</span>self<span class="token punctuation">.</span>_eth_desc<span class="token punctuation">,</span>
            prn<span class="token operator">=</span>self<span class="token punctuation">.</span>packet_callback<span class="token punctuation">,</span>
            <span class="token builtin">filter</span><span class="token operator">=</span><span class="token string">"udp"</span><span class="token punctuation">,</span>
            stop_filter<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> self<span class="token punctuation">.</span>_terminated<span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
        <span class="token keyword">while</span> self<span class="token punctuation">.</span>_stop_event<span class="token punctuation">:</span>
            <span class="token comment"># 保持sniff嗅探不中断</span>
            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">stop</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>_terminated <span class="token operator">=</span> <span class="token boolean">True</span>
        self<span class="token punctuation">.</span>_stop_event<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 如果协议有TCP</span>
<span class="token keyword">class</span> <span class="token class-name">SomeipTcpSocket</span><span class="token punctuation">(</span>threading<span class="token punctuation">.</span>Thread<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>tcp_sock<span class="token punctuation">:</span> socket <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>_stop_event <span class="token operator">=</span> threading<span class="token punctuation">.</span>Event<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">create_tcp_socket</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>tcp_sock <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>tcp_sock<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>SOL_SOCKET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SO_REUSEADDR<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>tcp_sock<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span>EthParameter<span class="token punctuation">.</span>icc_android_ip<span class="token punctuation">,</span> EthParameter<span class="token punctuation">.</span>consumer_prot<span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>tcp_sock<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">(</span>EthParameter<span class="token punctuation">.</span>adcc_ip<span class="token punctuation">,</span> EthParameter<span class="token punctuation">.</span>producer_port<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>create_tcp_socket<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">while</span> self<span class="token punctuation">.</span>_stop_event<span class="token punctuation">:</span>
            <span class="token comment"># 保持TCP通信</span>
            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">stop</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>_stop_event<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    s_socket <span class="token operator">=</span> SomeipTcpSocket<span class="token punctuation">(</span><span class="token punctuation">)</span>
    s_packer <span class="token operator">=</span> SomeipPacker<span class="token punctuation">(</span><span class="token punctuation">)</span>
    s_unpacker <span class="token operator">=</span> SomeipUnpacker<span class="token punctuation">(</span><span class="token punctuation">)</span>
    sim_server <span class="token operator">=</span> SomeipController<span class="token punctuation">(</span>
        s_packer<span class="token punctuation">,</span>
        s_unpacker
    <span class="token punctuation">)</span>
    sim_server<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre>
    <hr/>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470:733a2f2f626c6f672e6373646e2e6e65742f7a6174616a692f:61727469636c652f64657461696c732f313436323836393238" class_="artid" style="display:none">
 </p>
</div>


