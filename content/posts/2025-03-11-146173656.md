---
layout: post
title: "C全栈聊天项目2-单例模式封装Http管理者"
date: 2025-03-11 11:08:52 +0800
description: "我们先实现PostHttpReq请求的函数，也就是发送http的post请求, 发送请求要用到请求的url，请求的数据(json或者protobuf序列化)，以及请求的id，以及哪个模块发出的请求mod，那么一个请求接口应该是这样的。网络请求类要做成一个单例类，这样方便在任何需要发送http请求的时候调用，我们先实现单例类,添加singleton.h实现如下。加下来HttpMgr内实现一个slot_http_finish的槽函数用来接收sig_http_finish信号。好了，这样就完成了。"
keywords: "C++全栈聊天项目(2) 单例模式封装Http管理者"
categories: ['网络编程', '全栈聊天项目实战', 'C']
tags: ['单例模式', 'Http', 'C']
artid: "146173656"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146173656
    alt: "C全栈聊天项目2-单例模式封装Http管理者"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146173656
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146173656
cover: https://bing.ee123.net/img/rand?artid=146173656
image: https://bing.ee123.net/img/rand?artid=146173656
img: https://bing.ee123.net/img/rand?artid=146173656
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     C++全栈聊天项目(2) 单例模式封装Http管理者
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h3>
     <a id="_0">
     </a>
     完善注册类界面
    </h3>
    <p>
     先在注册类构造函数里添加lineEdit的模式为密码模式
    </p>
    <pre><code class="prism language-cpp">ui<span class="token operator">-&gt;</span>lineEdit_Passwd<span class="token operator">-&gt;</span><span class="token function">setEchoMode</span><span class="token punctuation">(</span>QLineEdit<span class="token double-colon punctuation">::</span>Password<span class="token punctuation">)</span><span class="token punctuation">;</span>
ui<span class="token operator">-&gt;</span>lineEdit_Confirm<span class="token operator">-&gt;</span><span class="token function">setEchoMode</span><span class="token punctuation">(</span>QLineEdit<span class="token double-colon punctuation">::</span>Password<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     我们在注册界面的ui里添加一个widget，widget内部包含一个tip居中显示，用来提示错误。设置label的显示为文字居中。
    </p>
    <p>
     <img alt="https://cdn.llfc.club/1709103910427.jpg" src="https://i-blog.csdnimg.cn/img_convert/a543e9ac79da3b0608e3fc66e94d2d21.jpeg"/>
    </p>
    <p>
     我们在qss里添加err_tip样式，根据不同的状态做字体显示
    </p>
    <pre><code class="prism language-qss">#err_tip[state='normal']{
   color: green;
}

#err_tip[state='err']{
   color: red;
}
</code></pre>
    <p>
     接下来项目中添加global.h和global.cpp文件，global.h声明repolish函数，global.cpp用来定义这个函数。
    </p>
    <p>
     .h中的声明
    </p>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">GLOBAL_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GLOBAL_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QWidget&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;functional&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"QStyle"</span></span>
<span class="token keyword">extern</span> std<span class="token double-colon punctuation">::</span>function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span>QWidget<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> repolish<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">// GLOBAL_H</span></span>
</code></pre>
    <p>
     .cpp中的定义
    </p>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"global.h"</span></span>

std<span class="token double-colon punctuation">::</span>function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span>QWidget<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> repolish <span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>QWidget <span class="token operator">*</span>w<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    w<span class="token operator">-&gt;</span><span class="token function">style</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">unpolish</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">;</span>
    w<span class="token operator">-&gt;</span><span class="token function">style</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">polish</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre>
    <p>
     在Register的构造函数中添加样式设置。
    </p>
    <pre><code class="prism language-cpp">ui<span class="token operator">-&gt;</span>err_tip<span class="token operator">-&gt;</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"state"</span><span class="token punctuation">,</span><span class="token string">"normal"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">repolish</span><span class="token punctuation">(</span>ui<span class="token operator">-&gt;</span>err_tip<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     接下来实现获取验证码的逻辑,ui里关联get_code按钮的槽事件，并实现槽函数
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token class-name">RegisterDialog</span><span class="token double-colon punctuation">::</span><span class="token function">on_get_code_clicked</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//验证邮箱的地址正则表达式</span>
    <span class="token keyword">auto</span> email <span class="token operator">=</span> ui<span class="token operator">-&gt;</span>email_edit<span class="token operator">-&gt;</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 邮箱地址的正则表达式</span>
    QRegularExpression <span class="token function">regex</span><span class="token punctuation">(</span><span class="token raw-string string">R"((\w+)(\.|_)?(\w*)@(\w+)(\.(\w+))+)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> match <span class="token operator">=</span> regex<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>email<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasMatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 执行正则表达式匹配</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>match<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">//发送http请求获取验证码</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">//提示邮箱不正确</span>
        <span class="token function">showTip</span><span class="token punctuation">(</span><span class="token function">tr</span><span class="token punctuation">(</span><span class="token string">"邮箱地址不正确"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     在RegisterDialog中添加showTip函数
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token class-name">RegisterDialog</span><span class="token double-colon punctuation">::</span><span class="token function">showTip</span><span class="token punctuation">(</span>QString str<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    ui<span class="token operator">-&gt;</span>err_tip<span class="token operator">-&gt;</span><span class="token function">setText</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ui<span class="token operator">-&gt;</span>err_tip<span class="token operator">-&gt;</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"state"</span><span class="token punctuation">,</span><span class="token string">"err"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">repolish</span><span class="token punctuation">(</span>ui<span class="token operator">-&gt;</span>err_tip<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     好了，这样就完成了。测试提示功能正确，下面要实现判断邮箱正确后发送http请求。
    </p>
    <h3>
     <a id="_77">
     </a>
     单例类封装
    </h3>
    <p>
     网络请求类要做成一个单例类，这样方便在任何需要发送http请求的时候调用，我们先实现单例类,添加singleton.h实现如下
    </p>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;memory&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;mutex&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>
<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword">class</span> <span class="token class-name">Singleton</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">protected</span><span class="token operator">:</span>
    <span class="token function">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>
    <span class="token function">Singleton</span><span class="token punctuation">(</span><span class="token keyword">const</span> Singleton<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>
    Singleton<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> Singleton<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token operator">&amp;</span> st<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>

    <span class="token keyword">static</span> std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> _instance<span class="token punctuation">;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">static</span> std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">static</span> std<span class="token double-colon punctuation">::</span>once_flag s_flag<span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span><span class="token function">call_once</span><span class="token punctuation">(</span>s_flag<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            _instance <span class="token operator">=</span> <span class="token generic-function"><span class="token function">shared_ptr</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> T<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> _instance<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">void</span> <span class="token function">PrintAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> _instance<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token operator">~</span><span class="token function">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"this is singleton destruct"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> Singleton<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span>_instance <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
</code></pre>
    <h3>
     <a id="http_112">
     </a>
     http管理类
    </h3>
    <p>
     http管理类主要用来管理http发送接收等请求得，我们需要在pro中添加网络库
    </p>
    <pre><code class="prism language-cpp">QT       <span class="token operator">+=</span> core gui network
</code></pre>
    <p>
     在pro中添加C++类，命名为HttpMgr，然后头文件如下
    </p>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"singleton.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QString&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QUrl&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QObject&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QNetworkAccessManager&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"global.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;memory&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QJsonObject&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QJsonDocument&gt;</span></span>
<span class="token keyword">class</span> <span class="token class-name">HttpMgr</span><span class="token operator">:</span><span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">QObject</span><span class="token punctuation">,</span> <span class="token keyword">public</span> <span class="token class-name">Singleton</span><span class="token operator">&lt;</span><span class="token class-name">HttpMgr</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
        <span class="token keyword">public</span> std<span class="token double-colon punctuation">::</span><span class="token class-name">enable_shared_from_this</span><span class="token operator">&lt;</span><span class="token class-name">HttpMgr</span><span class="token operator">&gt;</span></span>
<span class="token punctuation">{<!-- --></span>
    Q_OBJECT

<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token operator">~</span><span class="token function">HttpMgr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">friend</span> <span class="token keyword">class</span> <span class="token class-name">Singleton</span><span class="token operator">&lt;</span>HttpMgr<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token function">HttpMgr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    QNetworkAccessManager _manager<span class="token punctuation">;</span>
signals<span class="token operator">:</span>
    <span class="token keyword">void</span> <span class="token function">sig_http_finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     我们先实现PostHttpReq请求的函数，也就是发送http的post请求, 发送请求要用到请求的url，请求的数据(json或者protobuf序列化)，以及请求的id，以及哪个模块发出的请求mod，那么一个请求接口应该是这样的
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token function">PostHttpReq</span><span class="token punctuation">(</span>QUrl url<span class="token punctuation">,</span> QJsonObject json<span class="token punctuation">,</span> ReqId req_id<span class="token punctuation">,</span> Modules mod<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     我们去global.h定义ReqId枚举类型
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">enum</span> <span class="token class-name">ReqId</span><span class="token punctuation">{<!-- --></span>
    ID_GET_VARIFY_CODE <span class="token operator">=</span> <span class="token number">1001</span><span class="token punctuation">,</span> <span class="token comment">//获取验证码</span>
    ID_REG_USER <span class="token operator">=</span> <span class="token number">1002</span><span class="token punctuation">,</span> <span class="token comment">//注册用户</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     在global.h定义ErrorCodes
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">enum</span> <span class="token class-name">ErrorCodes</span><span class="token punctuation">{<!-- --></span>
    SUCCESS <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
    ERR_JSON <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">//Json解析失败</span>
    ERR_NETWORK <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     在global.h中定义模块
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">enum</span> <span class="token class-name">Modules</span><span class="token punctuation">{<!-- --></span>
    REGISTERMOD <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     还需要修改下要发送的信号，在HttpMgr的头文件里，让他携带参数
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token function">sig_http_finish</span><span class="token punctuation">(</span>ReqId id<span class="token punctuation">,</span> QString res<span class="token punctuation">,</span> ErrorCodes err<span class="token punctuation">,</span> Modules mod<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     我们实现PostHttpReq
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token class-name">HttpMgr</span><span class="token double-colon punctuation">::</span><span class="token function">PostHttpReq</span><span class="token punctuation">(</span>QUrl url<span class="token punctuation">,</span> QJsonObject json<span class="token punctuation">,</span> ReqId req_id<span class="token punctuation">,</span> Modules mod<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//创建一个HTTP POST请求，并设置请求头和请求体</span>
    QByteArray data <span class="token operator">=</span> <span class="token function">QJsonDocument</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//通过url构造请求</span>
    QNetworkRequest <span class="token function">request</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    request<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span>QNetworkRequest<span class="token double-colon punctuation">::</span>ContentTypeHeader<span class="token punctuation">,</span> <span class="token string">"application/json"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    request<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span>QNetworkRequest<span class="token double-colon punctuation">::</span>ContentLengthHeader<span class="token punctuation">,</span> <span class="token class-name">QByteArray</span><span class="token double-colon punctuation">::</span><span class="token function">number</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//发送请求，并处理响应, 获取自己的智能指针，构造伪闭包并增加智能指针引用计数</span>
    <span class="token keyword">auto</span> self <span class="token operator">=</span> <span class="token function">shared_from_this</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    QNetworkReply <span class="token operator">*</span> reply <span class="token operator">=</span> _manager<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//设置信号和槽等待发送完成</span>
    <span class="token class-name">QObject</span><span class="token double-colon punctuation">::</span><span class="token function">connect</span><span class="token punctuation">(</span>reply<span class="token punctuation">,</span> <span class="token operator">&amp;</span>QNetworkReply<span class="token double-colon punctuation">::</span>finished<span class="token punctuation">,</span> <span class="token punctuation">[</span>reply<span class="token punctuation">,</span> self<span class="token punctuation">,</span> req_id<span class="token punctuation">,</span> mod<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">//处理错误的情况</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>reply<span class="token operator">-&gt;</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> QNetworkReply<span class="token double-colon punctuation">::</span>NoError<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> reply<span class="token operator">-&gt;</span><span class="token function">errorString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//发送信号通知完成</span>
            emit self<span class="token operator">-&gt;</span><span class="token function">sig_http_finish</span><span class="token punctuation">(</span>req_id<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> ErrorCodes<span class="token double-colon punctuation">::</span>ERR_NETWORK<span class="token punctuation">,</span> mod<span class="token punctuation">)</span><span class="token punctuation">;</span>
            reply<span class="token operator">-&gt;</span><span class="token function">deleteLater</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//无错误则读回请求</span>
        QString res <span class="token operator">=</span> reply<span class="token operator">-&gt;</span><span class="token function">readAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//发送信号通知完成</span>
        emit self<span class="token operator">-&gt;</span><span class="token function">sig_http_finish</span><span class="token punctuation">(</span>req_id<span class="token punctuation">,</span> res<span class="token punctuation">,</span> ErrorCodes<span class="token double-colon punctuation">::</span>SUCCESS<span class="token punctuation">,</span>mod<span class="token punctuation">)</span><span class="token punctuation">;</span>
        reply<span class="token operator">-&gt;</span><span class="token function">deleteLater</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     加下来HttpMgr内实现一个slot_http_finish的槽函数用来接收sig_http_finish信号。
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token class-name">HttpMgr</span><span class="token double-colon punctuation">::</span><span class="token function">slot_http_finish</span><span class="token punctuation">(</span>ReqId id<span class="token punctuation">,</span> QString res<span class="token punctuation">,</span> ErrorCodes err<span class="token punctuation">,</span> Modules mod<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>mod <span class="token operator">==</span> Modules<span class="token double-colon punctuation">::</span>REGISTERMOD<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">//发送信号通知指定模块http响应结束</span>
        emit <span class="token function">sig_reg_mod_finish</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> res<span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     我们在HttpMgr.h中添加信号sig_reg_mod_finish，
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">class</span> <span class="token class-name">HttpMgr</span><span class="token operator">:</span><span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">QObject</span><span class="token punctuation">,</span> <span class="token keyword">public</span> <span class="token class-name">Singleton</span><span class="token operator">&lt;</span><span class="token class-name">HttpMgr</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
        <span class="token keyword">public</span> std<span class="token double-colon punctuation">::</span><span class="token class-name">enable_shared_from_this</span><span class="token operator">&lt;</span><span class="token class-name">HttpMgr</span><span class="token operator">&gt;</span></span>
<span class="token punctuation">{<!-- --></span>
    Q_OBJECT

<span class="token keyword">public</span><span class="token operator">:</span>
   <span class="token comment">//...省略</span>
signals<span class="token operator">:</span>
    <span class="token keyword">void</span> <span class="token function">sig_http_finish</span><span class="token punctuation">(</span>ReqId id<span class="token punctuation">,</span> QString res<span class="token punctuation">,</span> ErrorCodes err<span class="token punctuation">,</span> Modules mod<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">sig_reg_mod_finish</span><span class="token punctuation">(</span>ReqId id<span class="token punctuation">,</span> QString res<span class="token punctuation">,</span> ErrorCodes err<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     并且在cpp文件中连接slot_http_finish和sig_http_finish.
    </p>
    <pre><code class="prism language-cpp"><span class="token class-name">HttpMgr</span><span class="token double-colon punctuation">::</span><span class="token function">HttpMgr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//连接http请求和完成信号，信号槽机制保证队列消费</span>
    <span class="token function">connect</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>HttpMgr<span class="token double-colon punctuation">::</span>sig_http_finish<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>HttpMgr<span class="token double-colon punctuation">::</span>slot_http_finish<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     我们在注册界面连接sig_reg_mod_finish信号
    </p>
    <pre><code class="prism language-cpp"><span class="token class-name">RegisterDialog</span><span class="token double-colon punctuation">::</span><span class="token function">RegisterDialog</span><span class="token punctuation">(</span>QWidget <span class="token operator">*</span>parent<span class="token punctuation">)</span> <span class="token operator">:</span>
    <span class="token function">QDialog</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">ui</span><span class="token punctuation">(</span><span class="token keyword">new</span> Ui<span class="token double-colon punctuation">::</span>RegisterDialog<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//省略...</span>
    <span class="token function">connect</span><span class="token punctuation">(</span><span class="token class-name">HttpMgr</span><span class="token double-colon punctuation">::</span><span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>HttpMgr<span class="token double-colon punctuation">::</span>sig_reg_mod_finish<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>RegisterDialog<span class="token double-colon punctuation">::</span>slot_reg_mod_finish<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     接下俩实现slot_reg_mod_finish函数
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token class-name">RegisterDialog</span><span class="token double-colon punctuation">::</span><span class="token function">slot_reg_mod_finish</span><span class="token punctuation">(</span>ReqId id<span class="token punctuation">,</span> QString res<span class="token punctuation">,</span> ErrorCodes err<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>err <span class="token operator">!=</span> ErrorCodes<span class="token double-colon punctuation">::</span>SUCCESS<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">showTip</span><span class="token punctuation">(</span><span class="token function">tr</span><span class="token punctuation">(</span><span class="token string">"网络请求错误"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 解析 JSON 字符串,res需转化为QByteArray</span>
    QJsonDocument jsonDoc <span class="token operator">=</span> <span class="token class-name">QJsonDocument</span><span class="token double-colon punctuation">::</span><span class="token function">fromJson</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">toUtf8</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//json解析错误</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>jsonDoc<span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">showTip</span><span class="token punctuation">(</span><span class="token function">tr</span><span class="token punctuation">(</span><span class="token string">"json解析错误"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//json解析错误</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>jsonDoc<span class="token punctuation">.</span><span class="token function">isObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">showTip</span><span class="token punctuation">(</span><span class="token function">tr</span><span class="token punctuation">(</span><span class="token string">"json解析错误"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    QJsonObject jsonObj <span class="token operator">=</span> jsonDoc<span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//调用对应的逻辑</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     showTip逻辑稍作修改，增加bool类型参数
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token class-name">RegisterDialog</span><span class="token double-colon punctuation">::</span><span class="token function">showTip</span><span class="token punctuation">(</span>QString str<span class="token punctuation">,</span> <span class="token keyword">bool</span> b_ok<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>b_ok<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
         ui<span class="token operator">-&gt;</span>err_tip<span class="token operator">-&gt;</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"state"</span><span class="token punctuation">,</span><span class="token string">"err"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        ui<span class="token operator">-&gt;</span>err_tip<span class="token operator">-&gt;</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"state"</span><span class="token punctuation">,</span><span class="token string">"normal"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    ui<span class="token operator">-&gt;</span>err_tip<span class="token operator">-&gt;</span><span class="token function">setText</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">repolish</span><span class="token punctuation">(</span>ui<span class="token operator">-&gt;</span>err_tip<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="_297">
     </a>
     注册消息处理
    </h3>
    <p>
     我们需要对RegisterDialog注册消息处理，头文件声明
    </p>
    <pre><code class="prism language-cpp">QMap<span class="token operator">&lt;</span>ReqId<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span><span class="token keyword">const</span> QJsonObject<span class="token operator">&amp;</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span> _handlers<span class="token punctuation">;</span>
</code></pre>
    <p>
     在RegisterDialog中添加注册消息处理的声明和定义
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token class-name">RegisterDialog</span><span class="token double-colon punctuation">::</span><span class="token function">initHttpHandlers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//注册获取验证码回包逻辑</span>
    _handlers<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>ReqId<span class="token double-colon punctuation">::</span>ID_GET_VARIFY_CODE<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">]</span><span class="token punctuation">(</span>QJsonObject jsonObj<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> error <span class="token operator">=</span> jsonObj<span class="token punctuation">[</span><span class="token string">"error"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>error <span class="token operator">!=</span> ErrorCodes<span class="token double-colon punctuation">::</span>SUCCESS<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">showTip</span><span class="token punctuation">(</span><span class="token function">tr</span><span class="token punctuation">(</span><span class="token string">"参数错误"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">auto</span> email <span class="token operator">=</span> jsonObj<span class="token punctuation">[</span><span class="token string">"email"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">showTip</span><span class="token punctuation">(</span><span class="token function">tr</span><span class="token punctuation">(</span><span class="token string">"验证码已发送到邮箱，注意查收"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span> <span class="token string">"email is "</span> <span class="token operator">&lt;&lt;</span> email <span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     回到slot_reg_mod_finish函数添加根据id调用函数处理对应逻辑
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token class-name">RegisterDialog</span><span class="token double-colon punctuation">::</span><span class="token function">slot_reg_mod_finish</span><span class="token punctuation">(</span>ReqId id<span class="token punctuation">,</span> QString res<span class="token punctuation">,</span> ErrorCodes err<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
   <span class="token comment">//前面逻辑省略...</span>
    <span class="token comment">//调用对应的逻辑,根据id回调。</span>
    _handlers<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">(</span>jsonDoc<span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
    <span class="token function">showTip</span><span class="token punctuation">(</span><span class="token function">tr</span><span class="token punctuation">(</span><span class="token string">"验证码已发送到邮箱，注意查收"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span> <span class="token string">"email is "</span> <span class="token operator">&lt;&lt;</span> email <span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     回到slot_reg_mod_finish函数添加根据id调用函数处理对应逻辑
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token class-name">RegisterDialog</span><span class="token double-colon punctuation">::</span><span class="token function">slot_reg_mod_finish</span><span class="token punctuation">(</span>ReqId id<span class="token punctuation">,</span> QString res<span class="token punctuation">,</span> ErrorCodes err<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
   <span class="token comment">//前面逻辑省略...</span>
    <span class="token comment">//调用对应的逻辑,根据id回调。</span>
    _handlers<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">(</span>jsonDoc<span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f:672e6373646e2e6e65742f7365636f6e64746f6e6f6e65312f:61727469636c652f64657461696c732f313436313733363536" class_="artid" style="display:none">
 </p>
</div>


