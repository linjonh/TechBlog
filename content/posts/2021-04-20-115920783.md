---
layout: post
title: "通过LL库初始化STM32的硬件IIC"
date: 2021-04-20 22:48:18 +0800
description: "前言talk is cheap， show me the code,  直接砍初始化代码， 以及读写"
keywords: "stm32 ll i2c"
categories: ['嵌入式软件开发']
tags: ['单片机', 'Stm']
artid: "115920783"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=115920783
    alt: "通过LL库初始化STM32的硬件IIC"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=115920783
featuredImagePreview: https://bing.ee123.net/img/rand?artid=115920783
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     通过LL库初始化STM32的硬件IIC
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h3>
     <a id="_0">
     </a>
     前言
    </h3>
    <p>
     talk is cheap， show me the code, 直接看下列的 初始化代码， 以及读写函数吧。
    </p>
    <pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">Configure_I2Cx_Master</span><span class="token punctuation">(</span>I2C_TypeDef <span class="token operator">*</span>I2Cx<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">/* (1) Enables GPIO clock and configures the I2C3 pins **********************/</span>
  <span class="token comment">/*    (SCL on PC.0, SDA on PC.1)                     **********************/</span>

  <span class="token comment">/* Enable the peripheral clock of GPIOC */</span>
  <span class="token function">LL_IOP_GRP1_EnableClock</span><span class="token punctuation">(</span>LL_IOP_GRP1_PERIPH_GPIOC<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* Configure SCL Pin as : Alternate function, High Speed, Open drain, Pull up */</span>
  <span class="token function">LL_GPIO_SetPinMode</span><span class="token punctuation">(</span>GPIOC<span class="token punctuation">,</span> LL_GPIO_PIN_0<span class="token punctuation">,</span> LL_GPIO_MODE_ALTERNATE<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">LL_GPIO_SetAFPin_0_7</span><span class="token punctuation">(</span>GPIOC<span class="token punctuation">,</span> LL_GPIO_PIN_0<span class="token punctuation">,</span> LL_GPIO_AF_7<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">LL_GPIO_SetPinSpeed</span><span class="token punctuation">(</span>GPIOC<span class="token punctuation">,</span> LL_GPIO_PIN_0<span class="token punctuation">,</span> LL_GPIO_SPEED_FREQ_HIGH<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">LL_GPIO_SetPinOutputType</span><span class="token punctuation">(</span>GPIOC<span class="token punctuation">,</span> LL_GPIO_PIN_0<span class="token punctuation">,</span> LL_GPIO_OUTPUT_OPENDRAIN<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">LL_GPIO_SetPinPull</span><span class="token punctuation">(</span>GPIOC<span class="token punctuation">,</span> LL_GPIO_PIN_0<span class="token punctuation">,</span> LL_GPIO_PULL_UP<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* Configure SDA Pin as : Alternate function, High Speed, Open drain, Pull up */</span>
  <span class="token function">LL_GPIO_SetPinMode</span><span class="token punctuation">(</span>GPIOC<span class="token punctuation">,</span> LL_GPIO_PIN_1<span class="token punctuation">,</span> LL_GPIO_MODE_ALTERNATE<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">LL_GPIO_SetAFPin_0_7</span><span class="token punctuation">(</span>GPIOC<span class="token punctuation">,</span> LL_GPIO_PIN_1<span class="token punctuation">,</span> LL_GPIO_AF_7<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">LL_GPIO_SetPinSpeed</span><span class="token punctuation">(</span>GPIOC<span class="token punctuation">,</span> LL_GPIO_PIN_1<span class="token punctuation">,</span> LL_GPIO_SPEED_FREQ_HIGH<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">LL_GPIO_SetPinOutputType</span><span class="token punctuation">(</span>GPIOC<span class="token punctuation">,</span> LL_GPIO_PIN_1<span class="token punctuation">,</span> LL_GPIO_OUTPUT_OPENDRAIN<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">LL_GPIO_SetPinPull</span><span class="token punctuation">(</span>GPIOC<span class="token punctuation">,</span> LL_GPIO_PIN_1<span class="token punctuation">,</span> LL_GPIO_PULL_UP<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* (2) Enable the I2C3 peripheral clock and I2C3 clock source ***************/</span>

  <span class="token comment">/* Enable the peripheral clock for I2C3 */</span>
  <span class="token function">LL_APB1_GRP1_EnableClock</span><span class="token punctuation">(</span>LL_APB1_GRP1_PERIPH_I2C3<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* Set I2C3 clock source as SYSCLK */</span>
  <span class="token function">LL_RCC_SetI2CClockSource</span><span class="token punctuation">(</span>LL_RCC_I2C3_CLKSOURCE_SYSCLK<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">/* (3) Configure NVIC for I2C3 **********************************************/</span>

  <span class="token comment">/* Configure Event and Error IT:
   *  - Set priority for I2C3_IRQn
   *  - Enable I2C3_IRQn
   */</span>
<span class="token comment">//  NVIC_SetPriority(I2C3_IRQn, 0);</span>
<span class="token comment">//  NVIC_EnableIRQ(I2C3_IRQn);</span>

  <span class="token comment">/* (4) Configure I2C3 functional parameters *********************************/</span>

  <span class="token comment">/* Disable I2C3 prior modifying configuration registers */</span>
  <span class="token function">LL_I2C_Disable</span><span class="token punctuation">(</span>I2C3<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* Configure the SDA setup, hold time and the SCL high, low period */</span>
  <span class="token comment">/* (uint32_t)0x00601B28 = I2C_TIMING*/</span>
	<span class="token class-name">uint32_t</span> timing <span class="token operator">=</span> <span class="token function">__LL_I2C_CONVERT_TIMINGS</span><span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">,</span> <span class="token number">0x6</span><span class="token punctuation">,</span> <span class="token number">0x0</span><span class="token punctuation">,</span> <span class="token number">0x1B</span><span class="token punctuation">,</span> <span class="token number">0x28</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">LL_I2C_SetTiming</span><span class="token punctuation">(</span>I2C3<span class="token punctuation">,</span> timing<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* Configure the Own Address1                   */</span>
  <span class="token comment">/* Reset Values of :
   *     - OwnAddress1 is 0x00
   *     - OwnAddrSize is LL_I2C_OWNADDRESS1_7BIT
   *     - Own Address1 is disabled
   */</span>
  <span class="token comment">//LL_I2C_SetOwnAddress1(I2C3, 0x00, LL_I2C_OWNADDRESS1_7BIT);</span>
  <span class="token comment">//LL_I2C_DisableOwnAddress1(I2C3);</span>

  <span class="token comment">/* Enable Clock stretching */</span>
  <span class="token comment">/* Reset Value is Clock stretching enabled */</span>
  <span class="token comment">//LL_I2C_EnableClockStretching(I2C3);</span>

  <span class="token comment">/* Configure Digital Noise Filter */</span>
  <span class="token comment">/* Reset Value is 0x00            */</span>
  <span class="token comment">//LL_I2C_SetDigitalFilter(I2C3, 0x00);</span>

  <span class="token comment">/* Enable Analog Noise Filter           */</span>
  <span class="token comment">/* Reset Value is Analog Filter enabled */</span>
  <span class="token comment">//LL_I2C_EnableAnalogFilter(I2C3);</span>

  <span class="token comment">/* Enable General Call                  */</span>
  <span class="token comment">/* Reset Value is General Call disabled */</span>
  <span class="token comment">//LL_I2C_EnableGeneralCall(I2C3);</span>

  <span class="token comment">/* Configure the 7bits Own Address2               */</span>
  <span class="token comment">/* Reset Values of :
   *     - OwnAddress2 is 0x00
   *     - OwnAddrMask is LL_I2C_OWNADDRESS2_NOMASK
   *     - Own Address2 is disabled
   */</span>
  <span class="token comment">//LL_I2C_SetOwnAddress2(I2C3, 0x00, LL_I2C_OWNADDRESS2_NOMASK);</span>
  <span class="token comment">//LL_I2C_DisableOwnAddress2(I2C3);</span>

  <span class="token comment">/* Configure the Master to operate in 7-bit or 10-bit addressing mode */</span>
  <span class="token comment">/* Reset Value is LL_I2C_ADDRESSING_MODE_7BIT                         */</span>
  <span class="token comment">//LL_I2C_SetMasterAddressingMode(I2C3, LL_I2C_ADDRESSING_MODE_7BIT);</span>

  <span class="token comment">/* Enable Peripheral in I2C mode */</span>
  <span class="token comment">/* Reset Value is I2C mode */</span>
  <span class="token comment">//LL_I2C_SetMode(I2C3, LL_I2C_MODE_I2C);</span>

  <span class="token comment">/* (5) Enable I2C3 **********************************************************/</span>
  <span class="token function">LL_I2C_Enable</span><span class="token punctuation">(</span>I2C3<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* (6) Enable I2C3 transfer complete/error interrupts:
   *  - Enable Receive Interrupt
   *  - Enable Not acknowledge received interrupt
   *  - Enable Error interrupts
   *  - Enable Stop interrupt
   */</span>
<span class="token comment">//  LL_I2C_EnableIT_RX(I2C3);</span>
<span class="token comment">//  LL_I2C_EnableIT_NACK(I2C3);</span>
<span class="token comment">//  LL_I2C_EnableIT_ERR(I2C3);</span>
<span class="token comment">//  LL_I2C_EnableIT_STOP(I2C3);	</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
  * @brief  This Function handle Master events to perform a transmission process
  * @note  This function is composed in different steps :
  *        -1- Initiate a Start condition to the Slave device
  *        -2- Loop until end of transfer received (STOP flag raised)
  *             -2.1- Transmit data (TXIS flag raised)
  *        -3- Clear pending flags, Data consistency are checking into Slave process
  * @param  None
  * @retval None
  */</span>
<span class="token keyword">void</span> <span class="token function">I2C_Write</span><span class="token punctuation">(</span>I2C_TypeDef <span class="token operator">*</span>I2Cx<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> slave_addr<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> reg_addr<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> reg_data<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> data_size <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token comment">/* Master Generate Start condition for a write request :              */</span>
  <span class="token comment">/*    - to the Slave with a 7-Bit SLAVE_OWN_ADDRESS                   */</span>
  <span class="token comment">/*    - with a auto stop condition generation when transmit all bytes */</span>
  <span class="token function">LL_I2C_HandleTransfer</span><span class="token punctuation">(</span>I2Cx<span class="token punctuation">,</span> slave_addr<span class="token punctuation">,</span> LL_I2C_ADDRSLAVE_7BIT<span class="token punctuation">,</span> data_size<span class="token punctuation">,</span> LL_I2C_MODE_AUTOEND<span class="token punctuation">,</span> LL_I2C_GENERATE_START_WRITE<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* Loop until STOP flag is raised  */</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">LL_I2C_IsActiveFlag_STOP</span><span class="token punctuation">(</span>I2Cx<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/* Check TXIS flag value in ISR register */</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">LL_I2C_IsActiveFlag_TXE</span><span class="token punctuation">(</span>I2Cx<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> data_size <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token comment">/* Write data in Transmit Data register.
      TXIS flag is cleared by writing data in TXDR register */</span>
      <span class="token function">LL_I2C_TransmitData8</span><span class="token punctuation">(</span>I2Cx<span class="token punctuation">,</span> reg_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
			data_size<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
		<span class="token comment">/* Check TXIS flag value in ISR register */</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">LL_I2C_IsActiveFlag_TXE</span><span class="token punctuation">(</span>I2Cx<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> data_size <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token comment">/* Write data in Transmit Data register.
      TXIS flag is cleared by writing data in TXDR register */</span>
      <span class="token function">LL_I2C_TransmitData8</span><span class="token punctuation">(</span>I2Cx<span class="token punctuation">,</span> reg_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
			data_size<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">Loop_Is_Timeout_Xms</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/* (3) Clear pending flags, Data consistency are checking into Slave process */</span>

  <span class="token comment">/* End of I2C_SlaveReceiver_MasterTransmitter Process */</span>
  <span class="token function">LL_I2C_ClearFlag_STOP</span><span class="token punctuation">(</span>I2Cx<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
  * @brief  This Function handle Master events to perform a transmission process
  * @note  This function is composed in different steps :
  *        -1- Initiate a Start condition to the Slave device
  *        -2- Loop until end of transfer received (STOP flag raised)
  *             -2.1- Transmit data (TXIS flag raised)
  *        -3- Clear pending flags, Data consistency are checking into Slave process
  * @param  None
  * @retval None
  */</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token function">I2C_Read</span><span class="token punctuation">(</span>I2C_TypeDef <span class="token operator">*</span>I2Cx<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> slave_addr<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> reg_addr<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> read_byte <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> data_size <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token comment">/* Master Generate Start condition for a write request :              */</span>
  <span class="token comment">/*    - to the Slave with a 7-Bit SLAVE_OWN_ADDRESS                   */</span>
  <span class="token comment">/*    - with a auto stop condition generation when transmit all bytes */</span>
  <span class="token function">LL_I2C_HandleTransfer</span><span class="token punctuation">(</span>I2Cx<span class="token punctuation">,</span> slave_addr<span class="token punctuation">,</span> LL_I2C_ADDRSLAVE_7BIT<span class="token punctuation">,</span> data_size<span class="token punctuation">,</span> LL_I2C_MODE_SOFTEND<span class="token punctuation">,</span> LL_I2C_GENERATE_START_WRITE<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* Loop until STOP flag is raised  */</span>
	<span class="token comment">/* This loop is dangerous when power support is terrrible. */</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">LL_I2C_IsActiveFlag_TC</span><span class="token punctuation">(</span>I2Cx<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
    <span class="token comment">/* Check TXIS flag value in ISR register */</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">LL_I2C_IsActiveFlag_TXE</span><span class="token punctuation">(</span>I2Cx<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> data_size <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token comment">/* Write data in Transmit Data register.
      TXIS flag is cleared by writing data in TXDR register */</span>
      <span class="token function">LL_I2C_TransmitData8</span><span class="token punctuation">(</span>I2Cx<span class="token punctuation">,</span> reg_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
			data_size<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">Loop_Is_Timeout_Xms</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
	
	data_size <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token function">LL_I2C_HandleTransfer</span><span class="token punctuation">(</span>I2Cx<span class="token punctuation">,</span> slave_addr<span class="token punctuation">,</span> LL_I2C_ADDRSLAVE_7BIT<span class="token punctuation">,</span> data_size<span class="token punctuation">,</span> LL_I2C_MODE_AUTOEND<span class="token punctuation">,</span> LL_I2C_GENERATE_START_READ<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* Loop until STOP flag is raised  */</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">LL_I2C_IsActiveFlag_STOP</span><span class="token punctuation">(</span>I2Cx<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">Loop_Is_Timeout_Xms</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">LL_I2C_IsActiveFlag_RXNE</span><span class="token punctuation">(</span>I2Cx<span class="token punctuation">)</span><span class="token punctuation">)</span>
			read_byte <span class="token operator">=</span> <span class="token function">LL_I2C_ReceiveData8</span><span class="token punctuation">(</span>I2Cx<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* (3) Clear pending flags, Data consistency are checking into Slave process */</span>
  <span class="token function">LL_I2C_ClearFlag_STOP</span><span class="token punctuation">(</span>I2Cx<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> read_byte<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="_208">
     </a>
     问题
    </h3>
    <h4>
     <a id="Q1_LL_I2C_HandleTransferI2Cx_slave_addr_LL_I2C_ADDRSLAVE_7BIT_data_size_LL_I2C_MODE_AUTOEND_LL_I2C_GENERATE_START_READ__209">
     </a>
     Q1: 该
     <code>
      LL_I2C_HandleTransfer(I2Cx, slave_addr, LL_I2C_ADDRSLAVE_7BIT, data_size, LL_I2C_MODE_AUTOEND, LL_I2C_GENERATE_START_READ)
     </code>
     函数，非常容易造成使用上的误解问题，如果不借助逻辑分析仪的话。
    </h4>
    <p>
     A1: 关于这个问题，有几点需要了解。
    </p>
    <ol>
     <li>
      如果设置了stm32中硬件iic为 7bit地址模式，要注意slave_addr的值其实要配置为写地址的值
      <code>
       （slave_addr&lt;&lt;2）
      </code>
      。 因为在stm32的硬件iic中， 会将传入函数的地址值的最后一位改成读写状态的值, 而不是将传入函数的地址之后再附加一位读写状态值。 比如说， 传入为7位的slave_addr地址值得话， 那么会改变了7位slave_addr地址的最后一位bit的值。
      <br/>
      众所周知， 在IIC器件中， 一般有三个地址， 比如hmcl5883设备器件地址为 0x1E, 写地址为0x3c，读地址为0x3d， 那么我们在使用stm32的硬件iic的时候， 要将slave_addr的地址值填写为
      <code>
       ( 0x1e&lt;&lt;1)
      </code>
      , 也就是要设置为
      <code>
       写地址0x3c
      </code>
      （不是设备地址0x1e），因为在配置了
      <strong>
       LL_I2C_GENERATE_START_READ
      </strong>
      之后，芯片会在最后一位自动改变读写位的电平状态， 在读的时候，自动产生高位电平， 也就是产生读地址0x3d的电平出去，而如果配置了
      <strong>
       LL_I2C_GENERATE_START_WRITE
      </strong>
      之后， 在传输完
      <code>
       ( 0x1e&lt;&lt;1)
      </code>
      的地址之后， 最后的地址位为低电平， 也就是写地址为0x3c。
     </li>
     <li>
      设置了data_size以及LL_I2C_MODE_AUTOEND之后， I2C会在发送完所有数据或者读取完所有数据之后，自动发送终止信号。
      <code>
       写的过程中， 硬件iic自动会读取从机的ack信号； 而读的过程后，如果需要后续继续操作， 需要产生ack信号给从机， 而如果已经读完，那么会自动产生nack信号给从机，有些从机一定要接收到主机的nack信号， 然后才能正常接收主机的stop信号， 否则会导致后续一连串读取异常
      </code>
      。
     </li>
     <li>
      接收器在收到数据之后， 应该拉低引脚来产生应答信号（正常来说， 引脚都是开漏上拉，所以，下拉为有效电平），以此通知对方已完整收到相关的数据。
      <code>
       而在主机作为接收器的时候，当接收完从设备的最后一个字节数据之后， 需要不应答， 以此告诉从设备传输即将结束， 准备接收结束信号。
      </code>
     </li>
    </ol>
    <h4>
     <a id="Q2__IIC___iiciic__IIC_L0iic_iic_215">
     </a>
     Q2: 硬件IIC在信号出现抖动（频率过快的话或者供电不足的情况下）， 主机发出的时序会完全错乱， 比如说， 当频率过高或者数据线接触不良，此时我们通过重新初始化从机，且重置硬件iic的错误标志，iic硬件接收到的数据虽然会有变化， 但是，读到的值完全不对， 这时候只能通过重新初始化IIC硬件才能解决，
     <code>
      但是，在L0系列上，利用外部中断不断地打断硬件iic时， 未发现iic数据读取出现任何较大的异常。
     </code>
    </h4>
    <p>
     A2：当信号抖动之后， 根据逻辑分析仪，会发现主机在发送从机设备地址的时候，会多发一个字节的数据时序，但是，这个字节数据的值不知从何而来，这便会导致后面读到的值各种异常，
     <mark>
      怀疑是不是移位寄存器在发送的时候，也发送了之前发生总线错误的时候，移位寄存器缓存部分字节信息
     </mark>
     。 因为调试时，相关的接收， 发送寄存器的值都是正常。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f:2f626c6f672e6373646e2e6e65742f77616c6c65766139362f:61727469636c652f64657461696c732f313135393230373833" class_="artid" style="display:none">
 </p>
</div>


