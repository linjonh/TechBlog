---
layout: post
title: "ç”µæ³¢ä¹‹å¤–socketå¥—æ¥å­—,Linuxä¸‹UDPé€šä¿¡çš„å­¤ç‹¬è¯—ç¯‡"
date: 2025-09-11T21:06:38+0800
description: "æœ¬æ–‡æ·±å…¥æ¢è®¨äº†ç½‘ç»œç¼–ç¨‹ä¸­çš„UDPåè®®ä¸socketå¥—æ¥å­—ç¼–ç¨‹ã€‚æ–‡ç« ä»IPåœ°å€ä¸ç«¯å£å·çš„åŸºç¡€æ¦‚å¿µå…¥æ‰‹ï¼Œè§£é‡Šäº†å¦‚ä½•é€šè¿‡IP+Portå”¯ä¸€æ ‡è¯†ç½‘ç»œè¿›ç¨‹ã€‚é‡ç‚¹å¯¹æ¯”äº†TCPä¸UDPåè®®çš„ç‰¹æ€§å·®å¼‚ï¼ŒTCPæä¾›å¯é ä¼ è¾“è€ŒUDPè¿½æ±‚é«˜æ•ˆé€šä¿¡ã€‚åœ¨ç½‘ç»œå­—èŠ‚åºéƒ¨åˆ†ï¼Œé˜è¿°äº†ç»Ÿä¸€ä½¿ç”¨å¤§ç«¯å­˜å‚¨çš„å¿…è¦æ€§åŠè½¬æ¢æ–¹æ³•ã€‚æœ€åä»‹ç»äº†socketç¼–ç¨‹ä¸­çš„æ ¸å¿ƒAPIå’Œsockaddrç»“æ„ä½“ï¼Œä¸ºåç»­ç½‘ç»œç¼–ç¨‹å®è·µå¥ å®šç†è®ºåŸºç¡€ã€‚é€šè¿‡æœ¬æ–‡ï¼Œè¯»è€…å¯ä»¥æŒæ¡ç½‘ç»œé€šä¿¡çš„åŸºæœ¬åŸç†å’Œå…³é”®æ¦‚å¿µã€‚"
keywords: "ç”µæ³¢ä¹‹å¤–ï¼šsocketå¥—æ¥å­—ï¼ŒLinuxä¸‹UDPé€šä¿¡çš„å­¤ç‹¬è¯—ç¯‡"
categories: ['æœªåˆ†ç±»']
tags: ['è¿ç»´', 'Udp', 'Linux']
artid: "151588653"
arturl: "https://blog.csdn.net/2303_81060385/article/details/151588653"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=151588653
    alt: "ç”µæ³¢ä¹‹å¤–socketå¥—æ¥å­—,Linuxä¸‹UDPé€šä¿¡çš„å­¤ç‹¬è¯—ç¯‡"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=151588653
featuredImagePreview: https://bing.ee123.net/img/rand?artid=151588653
cover: https://bing.ee123.net/img/rand?artid=151588653
image: https://bing.ee123.net/img/rand?artid=151588653
img: https://bing.ee123.net/img/rand?artid=151588653
---



# ç”µæ³¢ä¹‹å¤–ï¼šsocketå¥—æ¥å­—ï¼ŒLinuxä¸‹UDPé€šä¿¡çš„å­¤ç‹¬è¯—ç¯‡


[![](https://csdnimg.cn/release/blogv2/dist/pc/img/activeVector.png)
ç‹è€…æ¯Â·14å¤©åˆ›ä½œæŒ‘æˆ˜è¥Â·ç¬¬5æœŸ
10w+äººæµè§ˆ
1.1käººå‚ä¸

![](https://csdnimg.cn/release/blogv2/dist/pc/img/arrowright-line-White.png)](https://activity.csdn.net/writing?id=10949)

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/1135cadbbf26443688deed8ea7bba64e.gif#pic_center)

## ğŸŒ¤ï¸åºç« ï¼šè™šç©ºä¸­å›å“çš„å£°éŸ³

åœ¨å–§åš£çš„æ•°å­—å®‡å®™é‡Œï¼Œè¿›ç¨‹å¦‚åŒå­¤å²›ï¼Œå½¼æ­¤éš”ç¦»ã€‚ç„¶è€Œæ€»æœ‰ä¸€ç§æ¸´æœ›â€”â€”è¿æ¥ã€‚äºæ˜¯ä¾¿æœ‰äº†ç½‘ç»œç¼–ç¨‹ï¼Œä¾¿æœ‰äº†`socket`è¿™æŠŠé’¥åŒ™ï¼Œ**å®ƒæ‰“å¼€äº†ä»å­¤å²›åˆ°å¤§é™†çš„èˆªé“ï¼Œè®©ä¿¡æ¯ä»¥ç”µæ³¢ä¹‹å§¿ï¼Œåœ¨è™šç©ºä¸­å¥”è…¾ä¼ é€’ã€‚**

åœ¨ä¼—å¤šåè®®ä¸­ï¼Œ`UDPï¼ˆUser Datagram Protocolï¼‰`å®›å¦‚è¯—äººä¸€èˆ¬ï¼Œè½»ç›ˆã€ä¸ç¾ã€è¿…æ·ï¼Œå‘é€å‡ºå»çš„ä¿¡æ¯ä¸æ±‚å›æŠ¥ï¼Œä¸è®¡å›åº”ï¼Œåªä¸ºä¸€æ¬¡å€¾è¯‰ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†æ¢è®¿UDPè¿™ä½æµæµªè€…çš„å†…å¿ƒä¸–ç•Œã€‚

**æœ¬åšå®¢å°†æ·±å…¥è®¨è®ºå¥—æ¥å­—ç¼–ç¨‹ä¸­çš„åŸºæœ¬æ¦‚å¿µã€å¸¸è§APIä»¥åŠå®é™…åº”ç”¨ï¼Œé€šè¿‡ä¸€æ­¥æ­¥çš„å­¦ä¹ ï¼Œå¸®åŠ©è¯»è€…é€æ¸æŒæ¡ç½‘ç»œç¼–ç¨‹çš„ç²¾é«“ã€‚**

## ğŸŒ¦ï¸æ­£æ–‡

## 1.é¢„å¤‡çŸ¥è¯†

### 1.1.IPåœ°å€

åœ¨ ã€Šç½‘ç»œåŸºç¡€å››é‡å¥ã€‹ä¸€æ–‡ä¸­æˆ‘ä»¬æåˆ°è¿‡: **IP æ˜¯å…¨çƒç½‘ç»œçš„åŸºç¡€**ï¼Œä½¿ç”¨ IP åœ°å€æ¥æ ‡è¯†å…¬ç½‘ç¯å¢ƒä¸‹ä¸»æœºçš„å”¯ä¸€æ€§ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ® **ç›®çš„IPåœ°å€ è¿›è¡Œè·¨è·¯ç”±å™¨çš„è¿œç«¯é€šä¿¡ï¼ˆå°†ä¿¡æ¯ä»ä¸»æœº A å‘é€è‡³ä¸»æœº Z ï¼‰**

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/5cfb566d9e8f4f7bb6c6f64fc8c579fc.png)

> **ç›®æ ‡ä¸»æœºä¸­å­˜åœ¨å¾ˆå¤šè¿›ç¨‹ï¼Œç½‘ç»œé€šä¿¡å®é™…æ˜¯ä¸åŒä¸»æœºä¸­çš„è¿›ç¨‹åœ¨è¿›è¡Œé€šä¿¡ï¼Œå¹¶éä¸»æœºä¸ä¸»æœºç›´æ¥é€šä¿¡**

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/7c8a970c407a4313a70b6572d35189db.png)

### 1.2.ç«¯å£å·

`ç«¯å£å·` æ˜¯ä¸€ä¸ªç”¨äºæ ‡è¯†ç½‘ç»œè¿›ç¨‹å”¯ä¸€æ€§çš„æ ‡è¯†ç¬¦ï¼Œæ˜¯ä¸€ä¸ª 2 å­—èŠ‚çš„æ•´æ•°ï¼Œå–å€¼èŒƒå›´ä¸º [0, 65535]ï¼Œå¯ä»¥é€šè¿‡`ç«¯å£å·`å®šä½ä¸»æœºä¸­çš„ç›®æ ‡è¿›ç¨‹

æŠ›å¼€ç½‘ç»œå…¶ä»–çŸ¥è¯†ï¼Œå°†ä¿¡æ¯ä»ä¸»æœº A ä¸­çš„è¿›ç¨‹ A å‘é€è‡³ä¸»æœº B ä¸­çš„ è¿›ç¨‹ Bï¼Œè¿™ä¸å°±æ˜¯ `è¿›ç¨‹é—´é€šä¿¡ å—`ï¼Ÿä¹‹å‰å­¦ä¹ çš„ `è¿›ç¨‹é—´é€šä¿¡` æ˜¯é€šè¿‡ `åŒ¿åç®¡é“ã€å‘½åç®¡é“ã€å…±äº«å†…å­˜` ç­‰æ–¹å¼å®ç°ï¼Œè€Œå¦‚ä»Šçš„ `è¿›ç¨‹é—´é€šä¿¡` åˆ™æ˜¯é€šè¿‡ `ç½‘ç»œä¼ è¾“` çš„æ–¹å¼å®ç°

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/106faa8dc0294564801ba31e190a5773.png)

> **æœåŠ¡å™¨ä¸­çš„é˜²ç«å¢™å…¶å®å°±æ˜¯ç«¯å£å·é™åˆ¶ï¼Œåªæœ‰å¼€æ”¾çš„ç«¯å£å·ï¼Œæ‰å…è®¸è¿›ç¨‹ç”¨äº `ç½‘ç»œé€šä¿¡`**

### 1.3.ç«¯å£å·ä¸è¿›ç¨‹PID

**`ç«¯å£å·` ç”¨äºæ ‡è¯†è¿›ç¨‹ï¼Œè¿›ç¨‹ PID ä¹Ÿæ˜¯ç”¨äºæ ‡è¯†è¿›ç¨‹ï¼Œä¸ºä»€ä¹ˆåœ¨ç½‘ç»œä¸­ï¼Œä¸ç›´æ¥ä½¿ç”¨è¿›ç¨‹ PID å‘¢ï¼Ÿ**

* è¿›ç¨‹ PID éš¶å±äºæ“ä½œç³»ç»Ÿä¸­çš„è¿›ç¨‹ç®¡ç†ï¼Œå¦‚æœåœ¨ç½‘ç»œä¸­ä½¿ç”¨ PIDï¼Œä¼šå¯¼è‡´ç½‘ç»œæ ‡å‡†ä¸­è¢«è¿«ä¸­å¼•å…¥è¿›ç¨‹ç®¡ç†ç›¸å…³æ¦‚å¿µï¼ˆè¿›ç¨‹ç®¡ç†ä¸ç½‘ç»œå¼ºè€¦åˆï¼‰
* è¿›ç¨‹ç®¡ç† å±äº OS å†…éƒ¨ä¸­çš„åŠŸèƒ½ï¼ŒOS å¯ä»¥æœ‰å¾ˆå¤šæ ‡å‡†ï¼Œä½†ç½‘ç»œæ ‡å‡†åªèƒ½æœ‰ä¸€å¥—ï¼Œåœ¨ç½‘ç»œä¸­ç›´æ¥ä½¿ç”¨ PID æ— æ³•ç¡®ä¿ç½‘ç»œæ ‡å‡†çš„ç»Ÿä¸€æ€§
* å¹¶ä¸æ˜¯æ‰€æœ‰çš„è¿›ç¨‹éƒ½éœ€è¦è¿›è¡Œç½‘ç»œé€šä¿¡ï¼Œå¦‚æœç«¯å£å·ã€PID éƒ½ä½¿ç”¨åŒä¸€ä¸ªè§£å†³æ–¹æ¡ˆï¼Œæ— ç–‘ä¼šå½±å“ç½‘ç»œç®¡ç†çš„æ•ˆç‡

æ‰€ä»¥ç»¼ä¸Šæ‰€è¿°ï¼Œç½‘ç»œä¸­çš„ `ç«¯å£å·` éœ€è¦é€šè¿‡ä¸€ç§å…¨æ–°çš„æ–¹å¼å®ç°ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ª 2 å­—èŠ‚çš„æ•´æ•°`port`ï¼Œè¿›ç¨‹ A è¿è¡Œåï¼Œå¯ä»¥ç»™å®ƒç»‘å®š `ç«¯å£å· N`ï¼Œ**åœ¨è¿›è¡Œç½‘ç»œé€šä¿¡æ—¶ï¼Œæ ¹æ® ç«¯å£å· N æ¥ç¡®å®šä¿¡æ¯æ˜¯äº¤ç»™è¿›ç¨‹ A çš„**

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/c5918af670ce43c591ad76340ea345ff.png)

ç½‘ç»œä¼ è¾“ä¸­çš„å¿…å¤‡ä¿¡æ¯ç»„ [ç›®çš„`IP` æº `IP` || ç›®çš„ `Port` æº `Port`]

> * ç›®çš„ IPï¼šéœ€è¦æŠŠä¿¡æ¯å‘é€åˆ°å“ªä¸€å°ä¸»æœº
> * æº IPï¼šä¿¡æ¯ä»å“ªå°ä¸»æœºä¸­å‘å‡º
> * ç›®çš„ Portï¼šå°†ä¿¡æ¯äº¤ç»™å“ªä¸€ä¸ªè¿›ç¨‹
> * æº Portï¼šä¿¡æ¯ä»å“ªä¸€ä¸ªè¿›ç¨‹ä¸­å‘å‡º

æ³¨æ„ï¼š **ç«¯å£å·ä¸è¿›ç¨‹ PID å¹¶ä¸æ˜¯åŒä¸€ä¸ªæ¦‚å¿µ**

`è¿›ç¨‹ PID` å°±å¥½æ¯”ä½ çš„èº«ä»½è¯å·ï¼Œ`ç«¯å£å·` ç›¸å½“äºå­¦å·ï¼Œè¿™ä¸¤ä¸ªä¿¡æ¯éƒ½å¯ä»¥æ ‡è¯†å”¯ä¸€çš„ä½ ï¼Œä½†å¯¹äºå­¦æ ¡æ¥è¯´ï¼Œä½¿ç”¨å­¦å·æ›´æ–¹ä¾¿è¿›è¡Œç®¡ç†

**ä¸€ä¸ªè¿›ç¨‹å¯ä»¥ç»‘å®šå¤šä¸ª `ç«¯å£å·` å—ï¼Ÿä¸€ä¸ª `ç«¯å£å·` å¯ä»¥è¢«å¤šä¸ªè¿›ç¨‹ç»‘å®šå—ï¼Ÿ**

* `ç«¯å£å·` çš„ä½œç”¨æ˜¯é…åˆ`IP`åœ°å€æ ‡è¯†ç½‘ç»œä¸–ç•Œä¸­è¿›ç¨‹çš„å”¯ä¸€æ€§ï¼Œå¦‚æœä¸€ä¸ªè¿›ç¨‹ç»‘å®šå¤šä¸ª `ç«¯å£å·`ï¼Œä¾ç„¶å¯ä»¥ä¿è¯å”¯ä¸€æ€§ï¼ˆå› ä¸ºæ— è®ºä½¿ç”¨å“ªä¸ª ç«¯å£å·ï¼Œä¿¡æ¯å§‹ç»ˆåªä¼šäº¤ç»™ä¸€ä¸ªè¿›ç¨‹ï¼‰ï¼›ä½†å¦‚æœä¸€ä¸ª `ç«¯å£å·` è¢«å¤šä¸ªè¿›ç¨‹ç»‘å®šäº†ï¼Œåœ¨ä¿¡æ¯é€’è¾¾æ—¶ï¼Œæ˜¯æ— æ³•åˆ†è¾¨è¯¥ä¿¡æ¯çš„æœ€ç»ˆç›®çš„è¿›ç¨‹çš„ï¼Œå­˜åœ¨äºŒä¹‰æ€§
* æ‰€ä»¥**ä¸€ä¸ªè¿›ç¨‹å¯ä»¥ç»‘å®šå¤šä¸ªç«¯å£å·ï¼Œä¸€ä¸ª`ç«¯å£å·` ä¸å…è®¸è¢«å¤šä¸ªè¿›ç¨‹ç»‘å®š**ï¼Œå¦‚æœè¢«ç»‘å®šäº†ï¼Œå¯ä»¥é€šè¿‡ `ç«¯å£å·` é¡ºè—¤æ‘¸ç“œï¼Œæ‰¾åˆ°å ç”¨è¯¥`ç«¯å£å·`çš„è¿›ç¨‹
* å¦‚æœæŸä¸ªç«¯å£å·è¢«ä½¿ç”¨äº†ï¼Œå…¶ä»–è¿›ç¨‹å†ç»§ç»­ç»‘å®šæ˜¯ä¼šæŠ¥é”™çš„ï¼Œæç¤º **è¯¥ç«¯å£å·²è¢«å ç”¨**

**ä¸»æœºï¼ˆæ“ä½œç³»ç»Ÿï¼‰æ˜¯å¦‚ä½•æ ¹æ® `ç«¯å£å·` å®šä½å…·ä½“è¿›ç¨‹çš„ï¼Ÿ**

* è¿™ä¸ªå®ç°èµ·æ¥æ¯”è¾ƒç®€å•ï¼Œåˆ›å»ºä¸€å¼ å“ˆå¸Œè¡¨ï¼Œç»´æŠ¤ <ç«¯å£å·, è¿›ç¨‹ PID> ä¹‹é—´çš„æ˜ å°„å…³ç³»ï¼Œå½“ä¿¡æ¯é€šè¿‡ç½‘ç»œä¼ è¾“åˆ°ç›®æ ‡ä¸»æœºæ—¶ï¼Œæ“ä½œç³»ç»Ÿå¯ä»¥æ ¹æ®å…¶ä¸­çš„ [ç›®çš„ Port]ï¼Œç›´æ¥å®šä½åˆ°å…·ä½“çš„è¿›ç¨‹ PIDï¼Œç„¶åè¿›è¡Œé€šä¿¡

### 1.4.ä¼ è¾“å±‚åè®®

ä¸»æµçš„ä¼ è¾“å±‚åè®®æœ‰ä¸¤ä¸ªï¼š`TCP` å’Œ `UDP`

ä¸¤ä¸ªåè®®å„æœ‰ä¼˜ç¼ºç‚¹ï¼Œå¯ä»¥é‡‡ç”¨ä¸åŒçš„åè®®ï¼Œå®ç°æˆªç„¶ä¸åŒçš„ç½‘ç»œç¨‹åºï¼Œå…³äº `TCP` å’Œ `UDP` çš„è¯¦ç»†ä¿¡æ¯å°†ä¼šæ”¾åˆ°åé¢çš„åšå®¢ä¸­è¯¦è°ˆï¼Œå…ˆæ¥çœ‹çœ‹ç®€å•è¿™ä¸¤ç§åè®®çš„ç‰¹ç‚¹

> **TCP åè®®ï¼šä¼ è¾“æ§åˆ¶åè®®**

* ä¼ è¾“å±‚åè®®
* æœ‰è¿æ¥
* å¯é ä¼ è¾“
* é¢å‘å­—èŠ‚æµ
* å­—èŠ‚æµå°±åƒæ°´é¾™å¤´ï¼Œç”¨æˆ·å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚è·å–æ°´æµé‡

> **UDP åè®®ï¼šç”¨æˆ·æ•°æ®åè®®**

* ä¼ è¾“å±‚åè®®
* æ— è¿æ¥
* ä¸å¯é ä¼ è¾“
* é¢å‘æ•°æ®æŠ¥
* æ•°æ®æŠ¥åˆ™æ˜¯ç›¸å½“äºåŒ…è£¹ï¼Œç”¨æˆ·æ¯æ¬¡è·å–çš„éƒ½æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªå®Œæ•´çš„åŒ…è£¹

**æ•°æ®æŠ¥åˆ™æ˜¯ç›¸å½“äºåŒ…è£¹ï¼Œç”¨æˆ·æ¯æ¬¡è·å–çš„éƒ½æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªå®Œæ•´çš„åŒ…è£¹**

> **å…³äº `å¯é æ€§`**
>
> * TCP çš„å¯é ä¼ è¾“å¹¶ä¸æ„å‘³ç€å®ƒå¯ä»¥å°†æ•°æ®ç™¾åˆ†ç™¾é€’è¾¾ï¼Œè€Œæ˜¯è¯´å®ƒåœ¨æ•°æ®ä¼ è¾“è¿‡ç¨‹ä¸­ï¼Œå¦‚æœå‘ç”Ÿäº†ä¼ è¾“å¤±è´¥çš„æƒ…å†µï¼Œå®ƒä¼šé€šè¿‡è‡ªå·±ç‹¬ç‰¹çš„æœºåˆ¶ï¼Œé‡æ–°å‘é€æ•°æ®ï¼Œ**ç¡®ä¿å¯¹ç«¯ç™¾åˆ†ç™¾èƒ½æ”¶åˆ°æ•°æ®**ï¼›  
>    è‡³äºUDP å°±ä¸ä¸€æ ·ï¼Œæ•°æ®å‘å‡ºåï¼Œ**å¦‚æœå¤±è´¥äº†ï¼Œä¹Ÿä¸ä¼šè¿›è¡Œé‡ä¼ ï¼Œå¥½åœ¨ UDP é¢å‘æ•°æ®æŠ¥ï¼Œå¹¶ä¸”æ²¡æœ‰å¾ˆå¤šå¤æ‚çš„æœºåˆ¶ï¼Œæ‰€ä»¥ä¼ è¾“é€Ÿåº¦å¾ˆå¿«**

æ€»ç»“èµ·æ¥å°±æ˜¯ï¼š

* `TCP` ç”¨äºå¯¹æ•°æ®ä¼ è¾“è¦æ±‚è¾ƒé«˜çš„é¢†åŸŸï¼Œæ¯”å¦‚é‡‘èäº¤æ˜“ã€ç½‘é¡µè¯·æ±‚ã€æ–‡ä»¶ä¼ è¾“ç­‰ï¼Œè‡³äº `UDP` å¯ä»¥ç”¨äºçŸ­è§†é¢‘ã€ç›´æ’­ã€å³æ—¶é€šè®¯ç­‰å¯¹ä¼ è¾“é€Ÿåº¦è¦æ±‚è¾ƒé«˜çš„é¢†åŸŸ
* å¦‚æœä¸çŸ¥é“è¯¥ä½¿ç”¨å“ªç§åè®®ï¼Œä¼˜å…ˆè€ƒè™‘ `TCP`ï¼Œå¦‚æœå¯¹ä¼ è¾“é€Ÿåº¦åˆè¦æ±‚ï¼Œå¯ä»¥é€‰æ‹© `UDP`

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/c4819eced8374920b4b65acf73040c89.png)

### 1.5.ç½‘ç»œå­—èŠ‚åº

åœ¨å­¦ä¹ ç½‘ç»œå­—èŠ‚åºç›¸å…³çŸ¥è¯†å‰ï¼Œå…ˆå›é¡¾ä¸€ä¸‹å¤§å°ç«¯å­—èŠ‚åº

é¢„å¤‡çŸ¥è¯†

* æ•°æ®æ‹¥æœ‰é«˜æƒå€¼ä½å’Œä½æƒå€¼ä½ï¼Œæ¯”å¦‚åœ¨ 32 ä½æ“ä½œç³»ç»Ÿä¸­ï¼Œåå…­è¿›åˆ¶æ•° 0x11223344ï¼Œå…¶ä¸­çš„ 11 ç§°ä¸º `æœ€é«˜æƒå€¼ä½`ï¼Œ44 ç§°ä¸º `æœ€ä½æƒå€¼ä½`
* å†…å­˜æœ‰é«˜åœ°å€å’Œä½åœ°å€ä¹‹åˆ†
* å¦‚æœå°†æ•°æ®çš„é«˜æƒå€¼å­˜æ”¾åœ¨å†…å­˜çš„ä½åœ°å€å¤„ï¼Œä½æƒå€¼å­˜æ”¾åœ¨é«˜åœ°å€å¤„ï¼Œæ­¤æ—¶å°±ç§°ä¸º `å¤§ç«¯å­—èŠ‚åº`ï¼Œåä¹‹åˆ™ç§°ä¸º `å°ç«¯å­—èŠ‚åº`
* è¿™ä¸¤ç§å­—èŠ‚åºæ²¡æœ‰å¥½åä¹‹åˆ†ï¼Œåªæ˜¯ç³»ç»Ÿè®¾è®¡è€…çš„ä½¿ç”¨ä¹ æƒ¯é—®é¢˜ï¼Œæ¯”å¦‚æˆ‘å½“å‰çš„ç”µè„‘åœ¨å­˜å‚¨æ•°æ®æ—¶ï¼Œé‡‡ç”¨çš„å°±æ˜¯ `å°ç«¯å­—èŠ‚åº` æ–¹æ¡ˆ

**ä½¿ç”¨ `å°ç«¯å­—èŠ‚åº` æ—¶æ•°æ®æ˜¯å€’ç€æ”¾çš„ï¼Œ`å¤§ç«¯å­—èŠ‚åº` å°±æ˜¯æ­£ç€å­˜æ”¾äº†**

åœ¨ç½‘ç»œå‡ºç°ä¹‹å‰ï¼Œä½¿ç”¨å¤§ç«¯æˆ–å°ç«¯å­˜å‚¨éƒ½æ²¡æœ‰é—®é¢˜ï¼Œç½‘ç»œå‡ºç°ä¹‹åï¼Œå°±éœ€è¦è€ƒè™‘ä½¿ç”¨åŒä¸€ç§å­˜å‚¨æ–¹æ¡ˆäº†ï¼Œå› ä¸º**ç½‘ç»œé€šä¿¡æ—¶ï¼Œä¸¤å°ä¸»æœºå­˜å‚¨æ–¹æ¡ˆå¯èƒ½ä¸åŒï¼Œä¼šå‡ºç°æ— æ³•è§£è¯»å¯¹æ–¹æ•°æ®çš„é—®é¢˜**

**å¦‚æœä½ æ˜¯ç½‘ç»œæ ‡å‡†çš„è®¾è®¡è€…ï¼Œä½ ä¼šå¦‚ä½•è§£å†³ï¼Ÿ**

* è§£å†³æ–¹æ¡ˆ1ï¼šæ•°æ®å‘é€å‰ï¼Œç»™æŠ¥æ–‡ä¸­æ·»åŠ å¤§å°ç«¯çš„æ ‡è®°å­—æ®µï¼Œå¾…æ•°æ®é€’è¾¾åï¼Œå¯¹ç«¯åœ¨æ ¹æ®æ ‡å¿—ä½è¿›è¡Œè§£è¯»ï¼Œå†è¿›è¡Œè½¬æ¢ã€‚ è¿™ä¸ªæ–¹æ¡ˆå®ç°èµ·æ¥ä¸å¤ªæ–¹ä¾¿ï¼Œå¹¶ä¸”ç»™æ¯ä¸€ä¸ªæŠ¥æ–‡éƒ½æ·»åŠ æ ‡è®°å­—æ®µè¿™ä¸ªè¡Œä¸ºæ¯”è¾ƒæµªè´¹
* è§£å†³æ–¹æ¡ˆ2ï¼šä¹¦åŒæ–‡ï¼Œè½¦åŒè½¨ï¼Œç›´æ¥ç»Ÿä¸€æ ‡å‡†ã€‚ è¿™ç§è§£å†³æ–¹æ¡ˆå°±å¾ˆå½»åº•äº†ï¼Œç›´æ¥ä»æ ¹æºä¸Šè§£å†³é—®é¢˜ï¼Œä¹Ÿæ›´æ–¹ä¾¿

é¡¶å±‚è®¾è®¡è€…é‡‡ç”¨äº†è§£å†³æ–¹æ¡ˆ2ï¼ŒT**CP/IP åè®®è§„å®šï¼šç½‘ç»œä¸­ä¼ è¾“çš„æ•°æ®ï¼Œç»Ÿä¸€é‡‡ç”¨å¤§ç«¯å­˜å‚¨æ–¹æ¡ˆï¼Œä¹Ÿå°±æ˜¯ç½‘ç»œå­—èŠ‚åºï¼Œ ç°åœ¨å¤§ç«¯/å°ç«¯ç§°ä¸º `ä¸»æœºå­—èŠ‚åº`**

å‘é€æ•°æ®æ—¶ï¼Œå°† `ä¸»æœºå­—èŠ‚åº` è½¬åŒ–ä¸º `ç½‘ç»œå­—èŠ‚åº`ï¼Œæ¥æ”¶åˆ°æ•°æ®åï¼Œå†è½¬å› `ä¸»æœºå­—èŠ‚åº` å°±å¥½äº†ï¼Œå®Œç¾è§£å†³ä¸åŒæœºå™¨ä¸­çš„å¤§å°ç«¯å·®å¼‚ï¼Œå¯ä»¥ç”¨ä¸‹é¢è¿™æ‰¹åº“å‡½æ•°è¿›è¡Œè½¬æ¢ï¼Œåœ¨å‘é€/æ¥æ”¶æ—¶ï¼Œè°ƒç”¨åº“å‡½æ•°è¿›è¡Œè½¬æ¢å³å¯

```cpp
#include <arpa/inet.h>

// ä¸»æœºå­—èŠ‚åºè½¬ç½‘ç»œå­—èŠ‚åº
uint32_t htonl(uint32_t hostlong); // l è¡¨ç¤º32ä½é•¿æ•´æ•°
uint32_t htons(uint32_t hostshort); // s è¡¨ç¤º16ä½çŸ­æ•´æ•°

// ç½‘ç»œå­—èŠ‚åºè½¬ä¸»æœºå­—èŠ‚åº
uint32_t ntohl(uint32_t netlong); // l è¡¨ç¤º32ä½é•¿æ•´æ•°
uint32_t ntohs(uint32_t netshort); // s è¡¨ç¤º16ä½çŸ­æ•´æ•°


```

## 2.socket å¥—æ¥å­—

### 2.1.socket å¸¸è§API

`socket` å¥—æ¥å­—æä¾›äº†ä¸‹é¢è¿™ä¸€æ‰¹å¸¸ç”¨æ¥å£ï¼Œç”¨äºå®ç°ç½‘ç»œé€šä¿¡

```cpp
#include <sys/types.h>
#include <sys/socket.h>

// åˆ›å»ºsocketæ–‡ä»¶æè¿°ç¬¦ï¼ˆTCP/UDP	æœåŠ¡å™¨/å®¢æˆ·ç«¯ï¼‰
int socket(int domain, int type, int protocol);

// ç»‘å®šç«¯å£å·ï¼ˆTCP/UDP	æœåŠ¡å™¨ï¼‰
int bind(int socket, const struct sockaddr* address, socklen_t address_len);

// å¼€å§‹ç›‘å¬socket (TCP	æœåŠ¡å™¨)
int listen(int socket, int backlog);

// æ¥æ”¶è¿æ¥è¯·æ±‚ (TCP	æœåŠ¡å™¨)
int accept(int socket, struct sockaddr* address, socklen_t* address_len);

// å»ºç«‹è¿æ¥ (TCP	å®¢æˆ·ç«¯)
int connect(int sockfd, const struct sockaddr* addr, socklen_t addrlen);


```

å¯ä»¥çœ‹åˆ°åœ¨è¿™ä¸€æ‰¹ API ä¸­ï¼Œé¢‘ç¹å‡ºç°äº†ä¸€ä¸ªç»“æ„ä½“ç±»å‹ `sockaddr`ï¼Œè¯¥ç»“æ„ä½“æ”¯æŒç½‘ç»œé€šä¿¡ï¼Œä¹Ÿæ”¯æŒæœ¬åœ°é€šä¿¡

`socket` å¥—æ¥å­—å°±æ˜¯ç”¨äºæè¿° `sockaddr` ç»“æ„ä½“çš„å­—æ®µï¼Œå¤ç”¨äº†æ–‡ä»¶æè¿°ç¬¦çš„è§£å†³æ–¹æ¡ˆ

### 2.2.sockaddr ç»“æ„ä½“

`socket` è¿™å¥—ç½‘ç»œé€šä¿¡æ ‡å‡†éš¶å±äº `POSIX` é€šä¿¡æ ‡å‡†ï¼Œè¯¥æ ‡å‡†çš„è®¾è®¡åˆè¡·å°±æ˜¯ä¸ºäº†å®ç° `å¯ç§»æ¤æ€§`ï¼Œç¨‹åºå¯ä»¥ç›´æ¥åœ¨ä½¿ç”¨è¯¥æ ‡å‡†çš„ä¸åŒæœºå™¨ä¸­è¿è¡Œï¼Œä½†æœ‰çš„æœºå™¨ä½¿ç”¨çš„æ˜¯ç½‘ç»œé€šä¿¡ï¼Œæœ‰çš„åˆ™æ˜¯ä½¿ç”¨æœ¬åœ°é€šä¿¡ï¼Œ**socket å¥—æ¥å­—ä¸ºäº†èƒ½åŒæ—¶å…¼é¡¾è¿™ä¸¤ç§é€šä¿¡æ–¹å¼ï¼Œæä¾›äº† sockaddr ç»“æ„ä½“**

ç”± sockaddr ç»“æ„ä½“è¡ç”Ÿå‡ºäº†ä¸¤ä¸ªä¸åŒçš„ç»“æ„ä½“ï¼š

* `sockaddr_in` ç½‘ç»œå¥—æ¥å­—ã€`sockaddr_un` åŸŸé—´å¥—æ¥å­—
* å‰è€…ç”¨äºç½‘ç»œé€šä¿¡ï¼Œåè€…ç”¨äºæœ¬åœ°é€šä¿¡
* å¯ä»¥æ ¹æ® 16 ä½åœ°å€ç±»å‹ï¼Œåˆ¤æ–­æ˜¯ç½‘ç»œé€šä¿¡ï¼Œè¿˜æ˜¯æœ¬åœ°é€šä¿¡
* åœ¨è¿›è¡Œç½‘ç»œé€šä¿¡æ—¶ï¼Œéœ€è¦æä¾› `IP åœ°å€ã€ç«¯å£å·` ç­‰ç½‘ç»œé€šä¿¡å¿…å¤‡é¡¹ï¼Œæœ¬åœ°é€šä¿¡åªéœ€è¦æä¾›ä¸€ä¸ªè·¯å¾„åï¼Œé€šè¿‡æ–‡ä»¶è¯»å†™çš„æ–¹å¼è¿›è¡Œé€šä¿¡ï¼ˆç±»ä¼¼äºå‘½åç®¡é“ï¼‰

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/8569c940517246e1acc120f151f307d5.png)

> **ä¸ºä»€ä¹ˆä¸å°†å‚æ•°è®¾ç½®ä¸º void*** ï¼Ÿ
>
> * å› ä¸ºåœ¨è¯¥æ ‡å‡†è®¾è®¡æ—¶ï¼ŒCè¯­è¨€è¿˜ä¸æ”¯æŒ `void*` è¿™ç§ç±»å‹ï¼Œä¸ºäº†ç¡®ä¿å‘å‰å…¼å®¹æ€§ï¼Œå³ä¾¿åç»­æ”¯æŒåä¹Ÿä¸èƒ½è¿›è¡Œä¿®æ”¹äº†

å…³äº socketaddr_in ç»“æ„çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯æ”¾åˆ°åé¢å†™ä»£ç æ—¶å†ç»†è°ˆ

## UDP ç½‘ç»œç¨‹åº

æ¥ä¸‹æ¥å®ç°ä¸€æ‰¹åŸºäº `UDP` åè®®çš„ç½‘ç»œç¨‹åº

## 3.å­—ç¬¦ä¸²å›å“

### 3.1.æ ¸å¿ƒåŠŸèƒ½

åˆ†åˆ«å®ç°å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ï¼Œå®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€æ¶ˆæ¯ï¼ŒæœåŠ¡å™¨æ”¶åˆ°æ¶ˆæ¯åï¼Œå›å“ç»™å®¢æˆ·ç«¯ï¼Œæœ‰ç‚¹ç±»ä¼¼äº `echo` æŒ‡ä»¤

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/d3e9920887924e3583a54fc85cd1a868.png)  
 è¯¥ç¨‹åºçš„æ ¸å¿ƒåœ¨äº ä½¿ç”¨ `socket` å¥—æ¥å­—æ¥å£ï¼Œä»¥ `UDP` åè®®çš„æ–¹å¼å®ç°ç®€å•ç½‘ç»œé€šä¿¡

### 3.2.ç¨‹åºç»“æ„

ç¨‹åºç”± `server.hppã€server.ccã€client.hppã€client.cc` ç»„æˆï¼Œå¤§ä½“æ¡†æ¶å¦‚ä¸‹

> **åˆ›å»º`server.hpp`æœåŠ¡å™¨å¤´æ–‡ä»¶**

```cpp
#pragma once

#include <iostream>

namespace nt_server
{
    class UdpServer
    {
    public:
        // æ„é€ 
        UdpServer()
        {} 
        // ææ„
        ~UdpServer()
        {} 

        // åˆå§‹åŒ–æœåŠ¡å™¨
        void InitServer()
        {}

        // å¯åŠ¨æœåŠ¡å™¨
        void StartServer()
        {}

    private:
        // å­—æ®µ
    };
}


```

> **åˆ›å»º `server.cc` æœåŠ¡å™¨æºæ–‡ä»¶**

```cpp
#include <memory> // æ™ºèƒ½æŒ‡é’ˆç›¸å…³å¤´æ–‡ä»¶
#include "server.hpp"

using namespace std;
using namespace nt_server;

int main()
{
    unique_ptr<UdpServer> usvr(new UdpServer());

    // åˆå§‹åŒ–æœåŠ¡å™¨
    usvr->InitServer();

    // å¯åŠ¨æœåŠ¡å™¨
    usvr->StartServer();

    return 0;
}


```

> **åˆ›å»º `client.hpp` å®¢æˆ·ç«¯å¤´æ–‡ä»¶**

```cpp
#pragma once

#include <iostream>

namespace nt_client
{
    class UdpClient
    {
    public:
        // æ„é€ 
        UdpClient() 
        {} 
        // ææ„
        ~UdpClient() 
        {} 

        // åˆå§‹åŒ–å®¢æˆ·ç«¯
        void InitClient() 
        {}

        // å¯åŠ¨å®¢æˆ·ç«¯
        void StartClient() 
        {}

    private:
        // å­—æ®µ
    };
}


```

> **åˆ›å»º`client.cc`å®¢æˆ·ç«¯æºæ–‡ä»¶**

```cpp
#include <memory>
#include "client.hpp"

using namespace std;
using namespace nt_client;

int main()
{
  unique_ptr<UdpClient> usvr(new UdpClient());

  // åˆå§‹åŒ–å®¢æˆ·ç«¯
  usvr->InitClient();
  
  // å¯åŠ¨å®¢æˆ·ç«¯
  usvr->StartClient();

  return 0;
}


```

ä¸ºäº†æ–¹ä¾¿åç»­æµ‹è¯•ï¼Œå†æ·»åŠ ä¸€ä¸ª`Makefile`æ–‡ä»¶

> **åˆ›å»º `Makefile` æ–‡ä»¶**

```cpp
.PHONY:all
all:server client

server:server.cc
	g++ -o $@ $^ -std=c++11

	
client:client.cc
	g++ -o $@ $^ -std=c++11

.PHONY:clean
clean:
	rm -rf server client


```

å‡†å¤‡å·¥ä½œå®Œæˆåï¼Œæ¥ä¸‹æ¥ç€æ‰‹å¡«å……ä»£ç å†…å®¹

### æœåŠ¡å™¨è®¾è®¡

### 3.3.åˆ›å»ºå¥—æ¥å­—

åˆ›å»ºå¥—æ¥å­—ä½¿ç”¨`socket` å‡½æ•°

```cpp
#include <sys/types.h>
#include <sys/socket.h>

// åˆ›å»ºå¥—æ¥å­—ï¼ˆTCP/UDP	æœåŠ¡å™¨/å®¢æˆ·ç«¯ï¼‰
int socket(int domain, int type, int protocol);


```

å‚æ•°è§£è¯»

* `domain` åˆ›å»ºå¥—æ¥å­—ç”¨äºå“ªç§é€šä¿¡ï¼ˆç½‘ç»œ/æœ¬åœ°ï¼‰
* `type` é€‰æ‹©æ•°æ®ä¼ è¾“ç±»å‹ï¼ˆæµå¼/æ•°æ®æŠ¥ï¼‰
* `protocol` é€‰æ‹©åè®®ç±»å‹ï¼ˆæ”¯æŒæ ¹æ®å‚æ•°2è‡ªåŠ¨æ¨å¯¼ï¼‰
* `è¿”å›å€¼`ï¼šåˆ›å»ºæˆåŠŸåï¼Œè¿”å›å¥—æ¥å­—ï¼ˆæ–‡ä»¶æè¿°ç¬¦ï¼‰ï¼Œå¤±è´¥è¿”å› -1

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/293861bd52f04dc5ace49e04e68631bd.png)  
 å› ä¸ºè¿™é‡Œæ˜¯ä½¿ç”¨`UDP`åè®®å®ç°çš„ ç½‘ç»œé€šä¿¡

* å‚æ•°1 `domain` é€‰æ‹© `AF_INET`ï¼ˆåŸºäº IPv4 æ ‡å‡†ï¼‰
* å‚æ•°2`type` é€‰æ‹© `SOCK_DGRAM`ï¼ˆæ•°æ®æŠ¥ä¼ è¾“ï¼‰
* å‚æ•°3è®¾ç½®ä¸º 0ï¼Œå¯ä»¥æ ¹æ® `SOCK_DGRAM` è‡ªåŠ¨æ¨å¯¼å‡ºä½¿ç”¨ `UDP` åè®®

> **AF_INET6 åŸºäº IPv6 æ ‡å‡†**

æ¥ä¸‹æ¥åœ¨ `server.hpp` çš„`InitServer()`å‡½æ•°ä¸­åˆ›å»ºå¥—æ¥å­—ï¼Œå¹¶å¯¹åˆ›å»ºæˆåŠŸ/å¤±è´¥åçš„ç»“æœåšæ‰“å°

> `server.hpp` æœåŠ¡å™¨å¤´æ–‡ä»¶

```cpp
#pragma once

#include <iostream>
#include <cstring>
#include <cerrno>
#include <cstdlib>
#include <sys/types.h>
#include <sys/socket.h>

namespace nt_server
{
    // é”™è¯¯ç 
    enum
    {
        SOCKET_ERR = 1
    };

    class UdpServer
    {
    public:
        // æ„é€ 
        UdpServer()
        {} 
        // ææ„
        ~UdpServer()
        {} 

        // åˆå§‹åŒ–æœåŠ¡å™¨
        void InitServer()
        {
            // 1.åˆ›å»ºå¥—æ¥å­—
            sock_ = socket(AF_INET, SOCK_DGRAM, 0);

            if(sock_ == -1)
            {
                std::cout << "Create Socket Fail: " << strerror(errno) << std::endl;
                exit(SOCKET_ERR);
            }

            // åˆ›å»ºæˆåŠŸ
            std::cout << "Create Success Socket: " << sock_ << std::endl;
        }

        // å¯åŠ¨æœåŠ¡å™¨
        void StartServer()
        {}

    private:
        int sock_; // å¥—æ¥å­—
    };
}


```

æ–‡ä»¶æè¿°ç¬¦é»˜è®¤ `0ã€1ã€2` éƒ½å·²ç»è¢«å ç”¨äº†ï¼Œå¦‚æœå†åˆ›å»ºæ–‡ä»¶æè¿°ç¬¦ï¼Œä¼šä» `3` å¼€å§‹ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œç¨‹åºè¿è¡Œåï¼Œåˆ›å»ºçš„å¥—æ¥å­—æ­£æ˜¯ `3`ï¼Œ**è¯æ˜å¥—æ¥å­—æœ¬è´¨ä¸Šå°±æ˜¯æ–‡ä»¶æè¿°ç¬¦ï¼Œä¸è¿‡å®ƒç”¨äºæè¿°ç½‘ç»œèµ„æº**

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/67f805c4393a4952b9ac8c2444ec0c50.png)

### 3.4.ç»‘å®šIPåœ°å€å’Œç«¯å£å·

æ³¨æ„ï¼š æˆ‘è¿™é‡Œçš„æœåŠ¡å™¨æ˜¯äº‘æœåŠ¡å™¨ï¼Œç»‘å®š IP åœ°å€è¿™ä¸ªæ“ä½œåé¢éœ€è¦ä¿®æ”¹

ä½¿ç”¨`bind`å‡½æ•°è¿›è¡Œç»‘å®šæ“ä½œ

```cpp
#include <sys/types.h>
#include <sys/socket.h>

// ç»‘å®šIPåœ°å€å’Œç«¯å£å·ï¼ˆTCP/UDP	æœåŠ¡å™¨ï¼‰
int bind(int sockfd, const struct sockaddr* addr, socklen_t addrlen);


```

**å‚æ•°è§£è¯»**

* sockfd åˆ›å»ºæˆåŠŸçš„å¥—æ¥å­—
* addr åŒ…å«é€šä¿¡ä¿¡æ¯çš„ sockaddr ç»“æ„ä½“åœ°å€
* addrlen ç»“æ„ä½“çš„å¤§å°
* è¿”å›å€¼ï¼šæˆåŠŸè¿”å› 0ï¼Œå¤±è´¥è¿”å› -1

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/52cbcf20a0804ca884b974d0f7eb18b2.png)  
 å‚æ•°1æ²¡å•¥å¥½è¯´çš„ï¼Œé‡ç‚¹åœ¨äºå‚æ•°2ï¼Œå› ä¸ºæˆ‘ä»¬è¿™é‡Œæ˜¯ `ç½‘ç»œé€šä¿¡`ï¼Œæ‰€ä»¥ä½¿ç”¨çš„æ˜¯`sockaddr_in`ç»“æ„ä½“ï¼Œè¦æƒ³ä½¿ç”¨è¯¥ç»“æ„ä½“ï¼Œè¿˜å¾—åŒ…å«ä¸‹é¢è¿™ä¸¤ä¸ªå¤´æ–‡ä»¶

```cpp
#include <netinet/in.h>
#include <arpa/inet.h>


```

`sockaddr_in` ç»“æ„ä½“çš„æ„æˆå¦‚ä¸‹

```cpp
/* Structure describing an Internet socket address.  */
struct sockaddr_in
{
  __SOCKADDR_COMMON (sin_);
  in_port_t sin_port;			/* Port number.  */
  struct in_addr sin_addr;		/* Internet address.  */

  /* Pad to size of `struct sockaddr'.  */
  unsigned char sin_zero[sizeof (struct sockaddr) -
	   __SOCKADDR_COMMON_SIZE -
	   sizeof (in_port_t) -
	   sizeof (struct in_addr)];
};


```

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/88406efd6594427186c4cc102fd51715.png)  
 é¦–å…ˆæ¥çœ‹çœ‹ 16 ä½åœ°å€ç±»å‹ï¼Œè½¬åˆ°å®šä¹‰å¯ä»¥å‘ç°å®ƒæ˜¯ä¸€ä¸ªå®å‡½æ•°ï¼Œå¹¶ä¸”ä½¿ç”¨äº† `Cè¯­è¨€` ä¸­ä¸€ä¸ªéå¸¸å°‘ç”¨çš„è¯­æ³• `##`ï¼ˆå°†ä¸¤ä¸ªå­—ç¬¦ä¸²æ‹¼æ¥ï¼‰

```cpp
/* POSIX.1g specifies this type name for the `sa_family' member.  */
typedef unsigned short int sa_family_t;

/* This macro is used to declare the initial common members
   of the data types used for socket addresses, `struct sockaddr',
   `struct sockaddr_in', `struct sockaddr_un', etc.  */

#define	__SOCKADDR_COMMON(sa_prefix) \
  sa_family_t sa_prefix##family


```

å½“ç»™ `__SOCKADDR_COMMON` ä¼ å…¥`sin_`å‚æ•°åï¼Œç»è¿‡ ## å­—ç¬¦ä¸²æ‹¼æ¥ã€å®æ›¿æ¢ç­‰æ“ä½œåï¼Œä¼šå¾—åˆ°è¿™æ ·ä¸€ä¸ªç±»å‹

```cpp
sa_family_t sin_family;


```

`sa_family_t` æ˜¯ä¸€ä¸ªæ— ç¬¦å·çŸ­æ•´æ•°ï¼Œå  16 ä½`ï¼Œsin_family` å­—æ®µå°±æ˜¯ 16 ä½åœ°å€ç±»å‹ äº†

æ¥ä¸‹æ¥çœ‹çœ‹ `ç«¯å£å·`ï¼Œè½¬åˆ°å®šä¹‰ï¼Œå‘ç°`in_port_t`ç±»å‹æ˜¯ä¸€ä¸ª 16 ä½æ— ç¬¦å·æ•´æ•°ï¼ŒåŒæ ·å  2 å­—èŠ‚ï¼Œæ­£å¥½ç¬¦åˆ`ç«¯å£å·`çš„å–å€¼èŒƒå›´ [0, 65535]

```cpp
/* Type to represent a port.  */
typedef uint16_t in_port_t;


```

æœ€åå†æ¥çœ‹çœ‹`IP`åœ°å€ï¼ŒåŒæ ·è½¬åˆ°å®šä¹‰ï¼Œå‘ç° `in_addr` ä¸­åŒ…å«äº†ä¸€ä¸ª `32 ä½æ— ç¬¦å·æ•´æ•°`ï¼Œå  4 å­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯ `IP` åœ°å€ çš„å¤§å°

```cpp
/* Internet address.  */
typedef uint32_t in_addr_t;
struct in_addr
{
  in_addr_t s_addr;
};


```

äº†è§£å®Œ`sockaddr_in`ç»“æ„ä½“ä¸­çš„å†…å®¹åï¼Œå°±å¯ä»¥åˆ›å»ºè¯¥ç»“æ„ä½“äº†ï¼Œå†å®šä¹‰è¯¥ç»“æ„ä½“åï¼Œéœ€è¦æ¸…ç©ºï¼Œç¡®ä¿å…¶ä¸­çš„å­—æ®µå¹²å‡€å¯ç”¨

> å°†å˜é‡ç½®ä¸º`0`å¯ç”¨ä½¿ç”¨ `bzero` å‡½æ•°

```cpp
#include <cstrins> // bzero å‡½æ•°çš„å¤´æ–‡ä»¶

struct sockaddr_in local;
bzero(&local, sizeof(local));


```

è·å¾—ä¸€ä¸ªå¹²å‡€å¯ç”¨çš„`sockaddr_in`ç»“æ„ä½“åï¼Œå¯ä»¥æ­£å¼ç»‘å®š `IP åœ°å€` å’Œ `ç«¯å£å·` äº†

æ³¨ï¼šä½œä¸ºæœåŠ¡å™¨ï¼Œéœ€è¦ç¡®å®šè‡ªå·±çš„ç«¯å£å·ï¼Œæˆ‘è¿™é‡Œè®¾ç½®çš„æ˜¯ `8888`

> `server.hpp` æœåŠ¡å™¨å¤´æ–‡ä»¶

```cpp
#pragma once

#include <iostream>
#include <string>
#include <cstring>
#include <cerrno>
#include <cstdlib>
#include <strings.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <arpa/inet.h>

namespace nt_server
{
    // é€€å‡ºç 
    enum
    {
        SOCKET_ERR = 1,
        BIND_ERR
    };

    // ç«¯å£å·é»˜è®¤å€¼
    const uint16_t default_port = 8888;

    class UdpServer
    {
    public:
        // æ„é€ 
        UdpServer(const std::string ip, const uint16_t port = default_port)
            :port_(port), ip_(ip)
        {} 
        // ææ„
        ~UdpServer()
        {} 

        // åˆå§‹åŒ–æœåŠ¡å™¨
        void InitServer()
        {
            // 1.åˆ›å»ºå¥—æ¥å­—
            sock_ = socket(AF_INET, SOCK_DGRAM, 0);

            if(sock_ == -1)
            {
                std::cout << "Create Socket Fail: " << strerror(errno) << std::endl;
                exit(SOCKET_ERR);
            }

            // åˆ›å»ºæˆåŠŸ
            std::cout << "Create Success Socket: " << sock_ << std::endl;

            // 2.ç»‘å®šIPåœ°å€å’Œç«¯å£å·
            struct sockaddr_in local;
            bzero(&local, sizeof(local)); // ç½®0

            // å¡«å……å­—æ®µ
            local.sin_family = AF_INET; // è®¾ç½®ä¸ºç½‘ç»œé€šä¿¡ï¼ˆPF_INET ä¹Ÿè¡Œï¼‰
            local.sin_port = htons(port_); // ä¸»æœºåºåˆ—è½¬ä¸ºç½‘ç»œåºåˆ—
            local.sin_addr.s_addr = inet_addr(ip_.c_str()); // ç‚¹åˆ†åè¿›åˆ¶è½¬ä¸ºçŸ­æ•´æ•°ï¼Œå†å°†ä¸»æœºåºåˆ—è½¬ä¸ºç½‘ç»œåºåˆ—

            // ç»‘å®šIPåœ°å€å’Œç«¯å£å·
            if(bind(sock_, (const sockaddr*)&local, sizeof(local)))
            {
                std::cout << "Bind IP&&Port Fail: " << strerror(errno) << std::endl;
                exit(BIND_ERR);
            }

            // ç»‘å®šæˆåŠŸ
            std::cout << "Bind IP&&Port Success" << std::endl;
        }

        // å¯åŠ¨æœåŠ¡å™¨
        void StartServer()
        {}

    private:
        int sock_; // å¥—æ¥å­—
        uint16_t port_; // ç«¯å£å·
        std::string ip_; // IPåœ°å€ï¼ˆåé¢éœ€è¦åˆ é™¤ï¼‰
    };
}


```

æ³¨æ„ï¼š

* éœ€è¦æŠŠä¸»æœºåºåˆ—è½¬æ¢ä¸ºç½‘ç»œåºåˆ—ï¼Œå¯ä»¥ä½¿ç”¨ `htons` å‡½æ•°
* éœ€è¦æŠŠç‚¹åˆ†åè¿›åˆ¶çš„å­—ç¬¦ä¸²ï¼Œè½¬æ¢ä¸ºæ— ç¬¦å·çŸ­æ•´æ•°ï¼Œå¯ä»¥ä½¿ç”¨ `inet_addr` å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°åœ¨è¿›è¡Œè½¬æ¢çš„åŒæ—¶ï¼Œä¼šå°†ä¸»æœºåºåˆ—è½¬æ¢ä¸ºç½‘ç»œåºåˆ—
* ç»‘å®šIPåœ°å€å’Œç«¯å£å·è¿™ä¸ªè¡Œä¸ºå¹¶éç›´æ¥ç»‘å®šåˆ°å½“å‰ä¸»æœºä¸­ï¼Œè€Œæ˜¯åœ¨å½“å‰ç¨‹åºä¸­ï¼Œå°†åˆ›å»ºçš„ `socket` å¥—æ¥å­—ï¼Œä¸ç›®æ ‡IPåœ°å€ä¸ç«¯å£å·è¿›è¡Œç»‘å®šï¼Œ**å½“ç¨‹åºç»ˆæ­¢åï¼Œè¿™ä¸ªç»‘å®šå…³ç³»ä¹Ÿä¼šéšä¹‹æ¶ˆå¤±**

> `server.cc` æœåŠ¡å™¨æºæ–‡ä»¶

```cpp
#include <memory> // æ™ºèƒ½æŒ‡é’ˆç›¸å…³å¤´æ–‡ä»¶
#include "server.hpp"

using namespace std;
using namespace nt_server;

int main()
{
    unique_ptr<UdpServer> usvr(new UdpServer("8.134.110.68"));

    // åˆå§‹åŒ–æœåŠ¡å™¨
    usvr->InitServer();

    // å¯åŠ¨æœåŠ¡å™¨
    usvr->StartServer();

    return 0;
}


```

æ¥ä¸‹æ¥ç¼–è¯‘å¹¶è¿è¡Œç¨‹åºï¼Œå¯ä»¥å‘ç°ç»‘å®šå¤±è´¥äº†ï¼Œè¿™æ˜¯å› ä¸ºå½“å‰æˆ‘ä½¿ç”¨çš„æ˜¯äº‘æœåŠ¡å™¨ï¼Œ**äº‘æœåŠ¡å™¨æ˜¯ä¸å…è®¸ç›´æ¥ç»‘å®šå…¬ç½‘ `IP` çš„ï¼Œè§£å†³æ–¹æ¡ˆæ˜¯åœ¨ç»‘å®š IP åœ°å€æ—¶ï¼Œè®©å…¶é€‰æ‹©ç»‘å®šä»»æ„å¯ç”¨ IP åœ°å€**

ä¿®æ”¹ä»£ç 

* äº‘æœåŠ¡å™¨ä¸­ä¸éœ€è¦æ˜ç¡® IP åœ°å€
* æ„é€ æ—¶ä¹Ÿæ— éœ€ä¼ å…¥ IP åœ°å€
* ç»‘å®š IP åœ°å€æ—¶é€‰æ‹© INADDR_ANYï¼Œè¡¨ç¤ºç»‘å®šä»»ä½•å¯ç”¨çš„ IP åœ°å€

> `server.hpp` æœåŠ¡å™¨å¤´æ–‡ä»¶

```cpp
class UdpServer
{
public:
	// æ„é€ 
	UdpServer(const uint16_t port = default_port)
	    :port_(port)
	{} 

// åˆå§‹åŒ–æœåŠ¡å™¨
void InitServer()
{
    // ...
    
    // å¡«å……å­—æ®µ
    local.sin_family = AF_INET; // è®¾ç½®ä¸ºç½‘ç»œé€šä¿¡ï¼ˆPF_INET ä¹Ÿè¡Œï¼‰
    local.sin_port = htons(port_); // ä¸»æœºåºåˆ—è½¬ä¸ºç½‘ç»œåºåˆ—
    // local.sin_addr.s_addr = inet_addr(ip_.c_str()); // ç‚¹åˆ†åè¿›åˆ¶è½¬ä¸ºçŸ­æ•´æ•°ï¼Œå†å°†ä¸»æœºåºåˆ—è½¬ä¸ºç½‘ç»œåºåˆ—
    local.sin_addr.s_addr = INADDR_ANY; // ç»‘å®šä»»ä½•å¯ç”¨IPåœ°å€

	// ...
}

private:
	int sock_; // å¥—æ¥å­—
	uint16_t port_; // ç«¯å£å·
	// std::string ip_; // åˆ é™¤
};


```

> `server.cc` æœåŠ¡å™¨æºæ–‡ä»¶

```cpp
#include <memory> // æ™ºèƒ½æŒ‡é’ˆç›¸å…³å¤´æ–‡ä»¶
#include "server.hpp"

using namespace std;
using namespace nt_server;

int main()
{
    unique_ptr<UdpServer> usvr(new UdpServer());

    // åˆå§‹åŒ–æœåŠ¡å™¨
    usvr->InitServer();

    // å¯åŠ¨æœåŠ¡å™¨
    usvr->StartServer();

    return 0;
}


```

å†æ¬¡ç¼–è¯‘å¹¶è¿è¡Œç¨‹åºï¼Œå¯ä»¥çœ‹åˆ°æ­£å¸¸è¿è¡Œ  
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/38111d3ee1774ff99041238f812258ef.png)  
 æœåŠ¡å™¨è®¾ç½®çš„ç«¯å£ï¼Œéœ€è¦è®¾ç½®ä¸ºå¼€æ”¾çŠ¶æ€

* å¦‚æœæ˜¯æœ¬åœ°æœåŠ¡å™¨ï¼Œå¯ä»¥ä½¿ç”¨ `systemctl start firewalld.service` æŒ‡ä»¤å¼€å¯é˜²ç«å¢™ï¼Œå†ä½¿ç”¨`firewall-cmd --zone=public --add-port=Port/tcp --permanent`å¼€å¯æŒ‡å®šçš„ç«¯å£å·
* å¦‚æœæ˜¯äº‘æœåŠ¡å™¨ï¼Œå°±éœ€è¦é€šè¿‡ `æ§åˆ¶å°`ï¼Œå¼€æ”¾å¯¹åº”çš„ç«¯å£

### 3.5.å¯åŠ¨æœåŠ¡å™¨

å½“å‰ç¼–å†™çš„ `å›å“æœåŠ¡å™¨` éœ€è¦æœåŠ¡å™¨æ‹¥æœ‰è¯»å–ä¿¡æ¯ï¼Œç„¶åå›å“ç»™å®¢æˆ·ç«¯çš„èƒ½åŠ›

è¯»å–ä¿¡æ¯ä½¿ç”¨ `recvfrom` å‡½æ•°

```cpp
#include <sys/types.h>
#include <sys/socket.h>

// è¯»å–ä¿¡æ¯ï¼ˆTCP/UDP	æœåŠ¡å™¨/å®¢æˆ·ç«¯ï¼‰
ssize_t recvfrom(int sockfd, void *buf, size_t len, int flags, struct sockaddr *src_addr, socklen_t *addrlen);


```

è¿™ä¸ªå‡½æ•°å‚æ•°æ¯”è¾ƒå¤šï¼Œé¦–å…ˆæ¥çœ‹çœ‹å‰åŠéƒ¨åˆ†

* `sockfd` ä½¿ç”¨å“ªä¸ªå¥—æ¥å­—è¿›è¡Œè¯»å–
* `buf` è¯»å–æ•°æ®å­˜æ”¾ç¼“å†²åŒº
* `len` ç¼“å†²åŒºçš„å¤§å°
* `flags` è¯»å–æ–¹å¼ï¼ˆé˜»å¡/éé˜»å¡ï¼‰

å‰åŠéƒ¨åˆ†ä¸»è¦ç”¨äºè¯»å–æ•°æ®ï¼Œå¹¶è¿›è¡Œå­˜æ”¾ï¼Œæ¥ä¸‹æ¥çœ‹çœ‹ååŠéƒ¨åˆ†

* `src_addr` è¾“å…¥è¾“å‡ºå‹å‚æ•°ï¼Œå¯¹ç«¯ä¸»æœºçš„`sockaddr`ç»“æ„ä½“ï¼ŒåŒ…å«äº†å¯¹ç«¯çš„ `IPåœ°å€` å’Œ `ç«¯å£å·`
* `addrlen` è¾“å…¥è¾“å‡ºå‹å‚æ•°ï¼Œå¯¹ç«¯ä¸»æœºçš„ `sockaddr` ç»“æ„ä½“å¤§å°

è¿™ä¸ªè¾“å…¥è¾“å‡ºå‹å‚æ•°å°±ç±»ä¼¼äºé€ç¤¼æ—¶ç•™ä¸‹è‡ªå·±çš„ä¿¡æ¯ï¼Œå¾…å¯¹æ–¹è¿˜ç¤¼æ—¶å¯ä»¥çŸ¥é“è¿˜ç»™è°ï¼Œæ¥æ”¶ä¿¡æ¯ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œå½“æœåŠ¡å™¨è·å–å®¢æˆ·ç«¯çš„`sockaddr`ç»“æ„ä½“ä¿¡æ¯åï¼ŒåŒæ ·å¯ä»¥ç»™å®¢æˆ·ç«¯å‘é€ä¿¡æ¯ï¼ŒåŒæ–¹å°±å¯ä»¥æ„‰å¿«çš„è¿›è¡Œé€šä¿¡äº†

* è¿”å›å€¼ï¼šæˆåŠŸè¿”å›å®é™…è¯»å–çš„å­—èŠ‚æ•°ï¼Œå¤±è´¥è¿”å› `-1`

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/c64a50773d784493bd5041e6d47224bb.png)  
 **æ¥æ”¶æ¶ˆæ¯æ­¥éª¤ï¼š**

* åˆ›å»ºç¼“å†²åŒºã€å¯¹ç«¯ `sockaddr_in` ç»“æ„ä½“
* æ¥æ”¶ä¿¡æ¯ï¼Œåˆ¤æ–­æ˜¯å¦æ¥æ”¶æˆåŠŸ
* å¤„ç†ä¿¡æ¯

æ‰€ä»¥æ¥ä¸‹æ¥ç¼–å†™æ¥æ”¶æ¶ˆæ¯çš„é€»è¾‘

æ³¨æ„ï¼š å› ä¸º`recvfrom`å‡½æ•°çš„å‚æ•°`src_addr`ç±»å‹ä¸º `sockaddr`ï¼Œéœ€è¦å°†`sockaddr_in`ç±»å‹å¼ºè½¬åï¼Œå†è¿›è¡Œä¼ é€’

> `StartServer()` å‡½æ•° â€” ä½äº`server.hpp`æœåŠ¡å™¨æºæ–‡ä»¶ä¸­çš„ `UdpServer` ç±»

```cpp
// å¯åŠ¨æœåŠ¡å™¨
void StartServer()
{
    // æœåŠ¡å™¨æ˜¯ä¸æ–­è¿è¡Œçš„ï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨ä¸€ä¸ª while(true) æ­»å¾ªç¯
    char buff[1024]; // ç¼“å†²åŒº
    while(true)
    {
        // 1. æ¥æ”¶æ¶ˆæ¯
        struct sockaddr_in peer; // å®¢æˆ·ç«¯ç»“æ„ä½“
        socklen_t len = sizeof(peer); // å®¢æˆ·ç«¯ç»“æ„ä½“å¤§å°

        // ä¼ å…¥ sizeof(buff) - 1 è¡¨ç¤ºå½“å‰ä¼ è¾“çš„æ˜¯å­—ç¬¦ä¸²ï¼Œé¢„ç•™ä¸€ä¸ªä½ç½®å­˜å‚¨ '\0'
        // ä¼ å…¥ 0 è¡¨ç¤ºå½“å‰æ˜¯é˜»å¡å¼è¯»å–
        ssize_t n = recvfrom(sock_, buff, sizeof(buff) - 1, 0, (struct sockaddr*)&peer, &len);

        if(n > 0)
            buff[n] = '\0';
        else
            continue; // ç»§ç»­è¯»å–

        // 2.å¤„ç†æ•°æ®
        std::string clientIp = inet_ntoa(peer.sin_addr); // è·å–IPåœ°å€
        uint16_t clientPort = ntohs(peer.sin_port); // è·å–ç«¯å£å·
        printf("Server get message from [%c:%d]$ %s\n",clientIp.c_str(), clientPort, buff);

        // 3.å›å“ç»™å®¢æˆ·ç«¯
        // ...
    }
}


```

å‘é€ä¿¡æ¯ä½¿ç”¨ `sendto` å‡½æ•°

```cpp
#include <sys/types.h>
#include <sys/socket.h>

// è¯»å–ä¿¡æ¯ï¼ˆTCP/UDP	æœåŠ¡å™¨/å®¢æˆ·ç«¯ï¼‰
ssize_t sendto(int sockfd, const void *buf, size_t len, int flags, const struct sockaddr *dest_addr, socklen_t addrlen);


```

è¿™ä¸ªå‡½æ•°çš„å‚æ•°ä¹Ÿæ˜¯å¾ˆå¤šï¼Œå‡ ä¹ä¸ `recvfrom` çš„ä¸€æ¨¡ä¸€æ ·

* `sockfd` ä½¿ç”¨å“ªä¸ªå¥—æ¥å­—è¿›è¡Œå‘é€
* `buf` å‘é€æ•°æ®å­˜æ”¾ç¼“å†²åŒº
* `len` ç¼“å†²åŒºçš„å¤§å°
* `flags` å‘é€æ–¹å¼ï¼ˆé˜»å¡/éé˜»å¡ï¼‰
* `src_addr` å¯¹ç«¯ä¸»æœºçš„ `sockaddr` ç»“æ„ä½“ï¼ŒåŒ…å«äº†å¯¹ç«¯çš„ `IPåœ°å€` å’Œ `ç«¯å£å·`
* `addrlen` å¯¹ç«¯ä¸»æœºçš„ sockaddr ç»“æ„ä½“å¤§å°
* `è¿”å›å€¼`ï¼šæˆåŠŸè¿”å›å®é™…å‘é€çš„å­—èŠ‚æ•°ï¼Œå¤±è´¥è¿”å› -1

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/257ad4aeed6247e1bf50f89c68cd3f94.png)  
 å‘é€æ¶ˆæ¯æ—¶ï¼Œç›´æ¥è°ƒç”¨ `sendto` å‡½æ•°æŠŠè¯»å–åˆ°çš„ä¿¡æ¯ï¼Œå›å“ç»™å®¢æˆ·ç«¯å³å¯ï¼Œå¦‚æœå‘é€å¤±è´¥äº†ï¼Œå°±ç®€å•æŠ¥ä¸ªé”™ï¼Œä¸ºäº†æ–¹ä¾¿é”™è¯¯ç è°ƒæ•´ï¼Œè¿™é‡Œé¡ºä¾¿æŠŠé”™è¯¯ç å°è£…æˆä¸€ä¸ªå•ç‹¬çš„ err.hpp æºæ–‡ä»¶ï¼ˆæ³¨æ„åŒ…å«å¤´æ–‡ä»¶ï¼‰

> `StartServer()` å‡½æ•° â€” ä½äº `server.hpp` æœåŠ¡å™¨æºæ–‡ä»¶ä¸­çš„ `UdpServer` ç±»

```cpp
// ...
#include "err.hpp"

// ...

// å¯åŠ¨æœåŠ¡å™¨
void StartServer()
{
    // æœåŠ¡å™¨æ˜¯ä¸æ–­è¿è¡Œçš„ï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨ä¸€ä¸ª while(true) æ­»å¾ªç¯
    char buff[1024]; // ç¼“å†²åŒº
    while(true)
    {
    	// ...

        // 3.å›å“ç»™å®¢æˆ·ç«¯
        n = sendto(sock_, buff, strlen(buff), 0, (const struct sockaddr*)&peer, sizeof(peer));

        if(n == -1)
            std::cout << "Send Message Fail: " << strerror(errno) << std::endl;
    }
}


```

> `err.hpp` å¤´æ–‡ä»¶

```cpp
#pragma once

// é”™è¯¯ç 
enum
{
    SOCKET_ERR = 1,
    BIND_ERR
};

```

ä¸‡äº‹å…·å¤‡åï¼Œå°±å¯ä»¥å¯åŠ¨æœåŠ¡å™¨äº†ï¼Œå¯ä»¥çœ‹åˆ°æœåŠ¡å™¨å¯åŠ¨åï¼Œå¤„äºé˜»å¡ç­‰å¾…çŠ¶æ€ï¼Œè¿™æ˜¯å› ä¸ºè¿˜æ²¡æœ‰å®¢æˆ·ç«¯ç»™æˆ‘çš„æœåŠ¡å™¨å‘ä¿¡æ¯ï¼Œæ‰€ä»¥å®ƒå°±ä¼šæš‚æ—¶é˜»å¡

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/47040a9377d04c4aba3541a6c4be77e0.png)

**å¦‚ä½•è¯æ˜æœåŠ¡å™¨æ­£åœ¨è¿è¡Œï¼Ÿ**

å¯ä»¥é€šè¿‡ `Linux` ä¸­æŸ¥çœ‹ç½‘ç»œçŠ¶æ€çš„æŒ‡ä»¤ï¼Œå› ä¸ºæˆ‘ä»¬è¿™é‡Œä½¿ç”¨çš„æ˜¯ `UDP` åè®®ï¼Œæ‰€ä»¥åªéœ€è¦è¾“å…¥ä¸‹é¢è¿™æ¡æŒ‡ä»¤ï¼Œå°±å¯ä»¥æŸ¥çœ‹æœ‰å“ªäº›ç¨‹åºæ­£åœ¨è¿è¡Œ

```cpp
netstat -nlup


```

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/7cb93aa6faad4711b6ded37ebd327c01.png)  
 ç°åœ¨æœåŠ¡å·²ç»è·‘èµ·æ¥äº†ï¼Œå¹¶ä¸”å¦‚æœŸå ç”¨äº†`8888`ç«¯å£ï¼Œæ¥ä¸‹æ¥å°±æ˜¯ç¼–å†™å®¢æˆ·ç«¯ç›¸å…³ä»£ç 

> `0.0.0.0` è¡¨ç¤ºä»»æ„IPåœ°å€

### å®¢æˆ·ç«¯è®¾è®¡

### 3.6.æŒ‡å®šIPåœ°å€å’Œç«¯å£å·

å®¢æˆ·ç«¯åœ¨è¿è¡Œæ—¶ï¼Œå¿…é¡»çŸ¥é“æœåŠ¡å™¨çš„ `IP åœ°å€` å’Œ `ç«¯å£å·`ï¼Œå¦åˆ™ä¸çŸ¥é“è‡ªå·±è¯¥ä¸è°è¿›è¡Œé€šä¿¡ï¼Œæ‰€ä»¥å¯¹äº `UdpClient` ç±»æ¥è¯´ï¼Œ`ip` å’Œ `port` è€…ä¸¤ä¸ªå­—æ®µæ˜¯è‚¯å®šå°‘ä¸äº†çš„

> `client.hpp` å®¢æˆ·ç«¯å¤´æ–‡ä»¶

```cpp
#pragma once

#include <iostream>
#include <string>
#include "err.hpp"

namespace nt_client
{
    class UdpClient
    {
    public:
        // æ„é€ 
        UdpClient(const std::string& ip, uint16_t port)
            :server_ip_(ip), server_port_(port)
        {} 
        
        // ææ„
        ~UdpClient() 
        {} 

        // åˆå§‹åŒ–å®¢æˆ·ç«¯
        void InitClient() 
        {}

        // å¯åŠ¨å®¢æˆ·ç«¯
        void StartClient() 
        {}

    private:
        std::string server_ip_; // æœåŠ¡å™¨IPåœ°å€
        uint16_t server_port_; // æœåŠ¡å™¨ç«¯å£å·
    };
}


```

è¿™ä¸¤ä¸ªå‚æ•°ç”±ç”¨æˆ·ä¸»åŠ¨ä¼ è¾“ï¼Œè¿™é‡Œå°±éœ€è¦ `å‘½ä»¤è¡Œ` å‚æ•°ç›¸å…³çŸ¥è¯†äº†ï¼Œåœ¨å¯åŠ¨å®¢æˆ·ç«¯æ—¶ï¼Œéœ€è¦ä»¥ **./client serverIp serverPort çš„æ–¹å¼**è¿è¡Œï¼Œå¦åˆ™å°±æŠ¥é”™ï¼Œå¹¶æç¤ºç›¸å…³é”™è¯¯ä¿¡æ¯ï¼ˆæ›´æ–° `err.hpp` çš„é”™è¯¯ç ï¼‰

> `client.cc` å®¢æˆ·ç«¯æºæ–‡ä»¶

```cpp
#include <iostream>
#include <memory>
#include "client.hpp"

using namespace std;
using namespace nt_client;

void Usage(const char* program)
{
  cout << "Usage:" << endl;
  cout << "\t" << program << " ServerIP ServerPort" << endl;
}

int main(int argc, char* argv[])
{
  if (argc != 3)
  {
    // é”™è¯¯çš„å¯åŠ¨æ–¹å¼ï¼Œæç¤ºé”™è¯¯ä¿¡æ¯
    Usage(argv[0]);
    return USAGE_ERR;
  }

  std::string ip = argv[1];
  uint16_t port = stoi(argv[2]);

  unique_ptr<UdpClient> usvr(new UdpClient(ip, port));

  // åˆå§‹åŒ–å®¢æˆ·ç«¯
  usvr->InitClient();

  // å¯åŠ¨å®¢æˆ·ç«¯
  usvr->StartClient();

  return 0;
}


```

> `err.hpp` é”™è¯¯ç å¤´æ–‡ä»¶

```cpp
#pragma once

enum
{
    USAGE_ERR = 1,
    SOCKET_ERR,
    BIND_ERR
};


```

å¦‚æ­¤ä¸€æ¥ï¼Œåªæœ‰æ­£ç¡®çš„è¾“å…¥`[./client ServerIP ServerPort]`æ‰èƒ½å¯åŠ¨ç¨‹åºï¼Œå¦åˆ™ä¸è®©ç¨‹åºè¿è¡Œï¼Œå€’é€¼å®¢æˆ·ç«¯å¯åŠ¨æ—¶ï¼Œæä¾›æœåŠ¡å™¨çš„ `IP åœ°å€` å’Œ `ç«¯å£å·`

### 3.7.åˆå§‹åŒ–å®¢æˆ·ç«¯

åˆå§‹åŒ–å®¢æˆ·ç«¯æ—¶ï¼ŒåŒæ ·éœ€è¦åˆ›å»º `socket` å¥—æ¥å­—ï¼Œä¸åŒäºæœåŠ¡å™¨çš„æ˜¯ **å®¢æˆ·ç«¯ä¸éœ€è¦è‡ªå·±æ‰‹åŠ¨ç»‘å®š IP åœ°å€ä¸ç«¯å£å·**

è¿™æ˜¯å› ä¸ºå®¢æˆ·ç«¯æ‰‹åŠ¨æŒ‡æ˜ `ç«¯å£å·` å­˜åœ¨éšæ‚£ï¼š

* å¦‚æœæ°å¥½æœ‰ä¸¤ä¸ªç¨‹åºä½¿ç”¨äº†åŒä¸€ä¸ªç«¯å£ï¼Œä¼šå¯¼è‡´å…¶ä¸­ä¸€æ–¹çš„å®¢æˆ·ç«¯ç›´æ¥ç»‘å®šå¤±è´¥ï¼Œæ— æ³•è¿è¡Œ
* å°†ç»‘å®š `ç«¯å£å·` è¿™ä¸ªè¡Œä¸ºäº¤ç»™ `OS` è‡ªåŠ¨æ‰§è¡Œï¼ˆé¦–æ¬¡ä¼ è¾“æ•°æ®æ—¶è‡ªåŠ¨ `bind`ï¼‰ï¼Œå¯ä»¥é¿å…è¿™ç§å†²çªçš„å‡ºç°

**ä¸ºä»€ä¹ˆæœåŠ¡å™¨è¦è‡ªå·±æ‰‹åŠ¨æŒ‡å®šç«¯å£å·ï¼Œå¹¶è¿›è¡Œç»‘å®šï¼Ÿ**

* è¿™æ˜¯å› ä¸ºæœåŠ¡å™¨çš„ç«¯å£ä¸èƒ½éšæ„æ”¹å˜ï¼Œå¹¶ä¸”è¿™æ˜¯è¦å…¬å¸ƒç»™å¹¿å¤§å®¢æˆ·ç«¯çœ‹çš„ï¼ŒåŒä¸€å®¶å…¬å¸åœ¨éƒ¨ç½²æœåŠ¡æ—¶ï¼Œä¼šå¯¹ç«¯å£å·çš„ä½¿ç”¨æƒ…å†µè¿›è¡Œç®¡ç†ï¼Œå¯ä»¥ç›´æ¥é¿å…ç«¯å£å·å†²çª
* å®¢æˆ·ç«¯åœ¨å¯åŠ¨å‰ï¼Œéœ€è¦å…ˆçŸ¥æ™“æœåŠ¡å™¨çš„ `sockaddr_in` ç»“æ„ä½“ä¿¡æ¯ï¼Œå¯ä»¥åˆ©ç”¨å·²çŸ¥çš„`IP`åœ°å€ å’Œ `ç«¯å£å·` æ„å»º

**ç»¼ä¸Šæ‰€è¿°ï¼Œåœ¨åˆå§‹åŒ–å®¢æˆ·ç«¯æ—¶ï¼Œéœ€è¦åˆ›å»ºå¥½å¥—æ¥å­—å’Œåˆå§‹åŒ–æœåŠ¡å™¨çš„ `sockaddr_in` ç»“æ„ä½“ä¿¡æ¯**

> `client.hpp` å®¢æˆ·ç«¯å¤´æ–‡ä»¶

```cpp
#pragma once

#include <iostream>
#include <string>
#include <cstring>
#include <cerrno>
#include <cstdlib>
#include <strings.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <arpa/inet.h>
#include "err.hpp"

namespace nt_client
{
    class UdpClient
    {
    public:
        // æ„é€ 
        UdpClient(const std::string& ip, uint16_t port)
            :server_ip_(ip), server_port_(port)
        {} 

        // ææ„
        ~UdpClient() 
        {} 

        // åˆå§‹åŒ–å®¢æˆ·ç«¯
        void InitClient() 
        {
            // 1.åˆ›å»ºå¥—æ¥å­—
            sock_ = socket(AF_INET, SOCK_DGRAM, 0);

            if(sock_ == -1)
            {
                std::cout << "Create Socket Fail: " << strerror(errno) << std::endl;
                exit(SOCKET_ERR);
            }

            std::cout << "Create Success Socket: " << sock_ << std::endl;

            // 2.æ„å»ºæœåŠ¡å™¨çš„ sockaddr_in ç»“æ„ä½“ä¿¡æ¯
            bzero(&svr_, sizeof(svr_));
            svr_.sin_family = AF_INET; // è®¾ç½®ä¸ºç½‘ç»œé€šä¿¡ï¼ˆPF_INET ä¹Ÿè¡Œï¼‰
            svr_.sin_addr.s_addr = inet_addr(server_ip_.c_str()); // ç»‘å®šæœåŠ¡å™¨IPåœ°å€
            svr_.sin_port = htons(server_port_); // ç»‘å®šæœåŠ¡å™¨ç«¯å£å·
        }

        // å¯åŠ¨å®¢æˆ·ç«¯
        void StartClient() 
        {}

    private:
        std::string server_ip_; // æœåŠ¡å™¨IPåœ°å€
        uint16_t server_port_; // æœåŠ¡å™¨ç«¯å£å·
        int sock_;
        struct sockaddr_in svr_; // æœåŠ¡å™¨çš„sockadder_inç»“æ„ä½“ä¿¡æ¯
    };
}


```

å¦‚æ­¤ä¸€æ¥ï¼Œå®¢æˆ·ç«¯å°±å¯ä»¥åˆ©ç”¨è¯¥ `sockaddr_in` ç»“æ„ä½“ï¼Œä¸ç›®æ ‡ä¸»æœºè¿›è¡Œé€šä¿¡äº†

### 3.8.å¯åŠ¨å®¢æˆ·ç«¯

æ¥ä¸‹æ¥å°±æ˜¯å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€æ¶ˆæ¯ï¼Œæ¶ˆæ¯ç”±ç”¨æˆ·ä¸»åŠ¨è¾“å…¥ï¼Œä½¿ç”¨çš„æ˜¯ `sendto` å‡½æ•°

**å‘é€æ¶ˆæ¯æ­¥éª¤**

* ç”¨æˆ·è¾“å…¥æ¶ˆæ¯
* ä¼ å…¥ç¼“å†²åŒºã€æœåŠ¡å™¨ç›¸å…³å‚æ•°ï¼Œä½¿ç”¨ `sendto` å‡½æ•°å‘é€æ¶ˆæ¯
* æ¶ˆæ¯å‘é€åï¼Œå®¢æˆ·ç«¯ç­‰å¾…æœåŠ¡å™¨å›å“æ¶ˆæ¯

**æ¥æ”¶æ¶ˆæ¯æ­¥éª¤ï¼š**

* åˆ›å»ºç¼“å†²åŒº
* æ¥æ”¶ä¿¡æ¯ï¼Œåˆ¤æ–­æ˜¯å¦æ¥æ”¶æˆåŠŸ
* å¤„ç†ä¿¡æ¯  
   æ³¨ï¼šåŒæœåŠ¡å™¨ä¸€æ ·ï¼Œå®¢æˆ·ç«¯ä¹Ÿéœ€è¦ä¸æ–­è¿è¡Œ

`StartClient()` å‡½æ•° â€” ä½äº `client.hpp` ä¸­çš„`UdpClient`ç±»

ç°åœ¨å·¦æ‰‹ `æœåŠ¡å™¨`ï¼Œå³æ‰‹ `å®¢æˆ·ç«¯`ï¼Œç›´æ¥ç¼–è¯‘è¿è¡Œï¼Œçœ‹çœ‹æ•ˆæœï¼š

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/4e25fcc3ebf24e6aaefc05ad6e539de8.png)  
 æ³¨ï¼š`127.0.0.1` è¡¨ç¤ºæœ¬åœ°ç¯å›ï¼ˆé€šå¸¸ç”¨äºæµ‹è¯•ç½‘ç»œç¨‹åºï¼‰ï¼Œå› ä¸ºæˆ‘å½“å‰çš„æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯éƒ½æ˜¯åœ¨åŒä¸€æœºå™¨ä¸Šè¿è¡Œçš„ï¼Œæ‰€ä»¥å°±å¯ä»¥ä½¿ç”¨è¯¥ IP åœ°å€ï¼Œå½“ç„¶ç›´æ¥ä½¿ç”¨æœåŠ¡å™¨çš„å…¬ç½‘ IP åœ°å€ä¹Ÿæ˜¯å¯ä»¥çš„

é€šè¿‡ `netstat -nlup` æŒ‡ä»¤æŸ¥çœ‹ç«¯å£ä½¿ç”¨æƒ…å†µ

å¯ä»¥çœ‹åˆ°ï¼ŒæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯éƒ½æˆåŠŸè¿è¡Œäº†ï¼ŒOS ç»™å®¢æˆ·ç«¯åˆ†é…çš„ ç«¯å£å· æ˜¯ 58749ï¼Œè¿™æ˜¯éšæœºåˆ†é…çš„ï¼Œæ¯æ¬¡é‡æ–°è¿è¡Œåï¼Œå¤§æ¦‚ç‡éƒ½ä¸ç›¸åŒ

è‡³æ­¤åŸºäº `UDP` åè®®ç¼–å†™çš„ç¬¬ä¸€ä¸ªç½‘ç»œç¨‹åº å­—ç¬¦ä¸²å›å“ å°±å®Œæˆäº†ï¼Œæ¥ä¸‹æ¥å¯¹å…¶è¿›è¡Œæ”¹é€ ï¼Œç¼–å†™ç¬¬äºŒä¸ªç½‘ç»œç¨‹åº

## 4.å¤§å†™è½¬å°å†™ã€è¿œç¨‹bash

### 4.1.ä¸šåŠ¡å¤„ç†å‡½æ•°è§£è€¦

åŸºäºæ¨¡å—åŒ–å¤„ç†çš„æ€æƒ³ï¼Œå°†æœåŠ¡å™¨ä¸­å¤„ç†æ¶ˆæ¯çš„å‡½æ•°ä¸å¯åŠ¨æœåŠ¡çš„å‡½æ•°è§£è€¦ï¼Œç”±ç¨‹åºå‘˜ä¼ å…¥æŒ‡å®šçš„å›è°ƒå‡½æ•°

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/71c85b681ade486cadf432ee4458c4a7.png)  
 æ­¤æ—¶ä¸šåŠ¡å¤„ç†å‡½æ•°å·²ç»å˜æˆä¸€ä¸ªæ¨¡å—äº†ï¼Œå¯ä»¥è‡ªç”±å˜æ¢

* ä¸šåŠ¡å¤„ç†å‡½æ•°Aï¼šå®ç°å¤§å†™è½¬å°å†™
* ä¸šåŠ¡å¤„ç†å‡½æ•°Bï¼šå®ç°è¿œç¨‹ bash
* ä¸šåŠ¡å¤„ç†å‡½æ•°Cï¼šå®ç° xxx

æœåŠ¡å™¨åœ¨å¯åŠ¨æ—¶ï¼Œåªéœ€è¦ä¼ å…¥å¯¹åº”çš„ä¸šåŠ¡å¤„ç†å‡½æ•°ï¼ˆå›è°ƒå‡½æ•°ï¼‰å³å¯

ä¿®æ”¹`server.hpp`çš„ä»£ç å¦‚ä¸‹

ä½¿ç”¨ C++11 ä¸­çš„ function åŒ…è£…å™¨è¯­æ³•ï¼ŒåŒ…è£…å‡ºä¸€ä¸ªç¬¦åˆæˆ‘ä»¬ä¸šåŠ¡å¤„ç†éœ€æ±‚çš„å‡½æ•°ç±»å‹

> `server.hpp` æœåŠ¡å™¨å¤´æ–‡ä»¶

```cpp
#pragma once

#include <iostream>
#include <string>
#include <functional>
#include <cstring>
#include <cerrno>
#include <cstdlib>
#include <strings.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <arpa/inet.h>
#include "err.hpp"

namespace nt_server
{
    // ç«¯å£å·é»˜è®¤å€¼
    const uint16_t default_port = 8888;
    using func_t = std::function<std::string(std::string)>; // å‚æ•°ä¸ºstringï¼Œè¿”å›å€¼åŒæ ·ä¸ºstring

    class UdpServer
    {
    public:
        // æ„é€ 
        UdpServer(const func_t& func, uint16_t port = default_port)
            :port_(port)
            ,serverHandle_(func)
        {}
        // ææ„
        ~UdpServer()
        {} 

        // åˆå§‹åŒ–æœåŠ¡å™¨
        void InitServer()
        {
            // 1.åˆ›å»ºå¥—æ¥å­—
            sock_ = socket(AF_INET, SOCK_DGRAM, 0);

            if(sock_ == -1)
            {
                std::cout << "Create Socket Fail: " << strerror(errno) << std::endl;
                exit(SOCKET_ERR);
            }

            // åˆ›å»ºæˆåŠŸ
            std::cout << "Create Success Socket: " << sock_ << std::endl;

            // 2.ç»‘å®šIPåœ°å€å’Œç«¯å£å·
            struct sockaddr_in local;
            bzero(&local, sizeof(local)); // ç½®0

            // å¡«å……å­—æ®µ
            local.sin_family = AF_INET; // è®¾ç½®ä¸ºç½‘ç»œé€šä¿¡ï¼ˆPF_INET ä¹Ÿè¡Œï¼‰
            local.sin_port = htons(port_); // ä¸»æœºåºåˆ—è½¬ä¸ºç½‘ç»œåºåˆ—
            // local.sin_addr.s_addr = inet_addr(ip_.c_str()); // ç‚¹åˆ†åè¿›åˆ¶è½¬ä¸ºçŸ­æ•´æ•°ï¼Œå†å°†ä¸»æœºåºåˆ—è½¬ä¸ºç½‘ç»œåºåˆ—
            local.sin_addr.s_addr = INADDR_ANY; // ç»‘å®šä»»ä½•å¯ç”¨IPåœ°å€

            // ç»‘å®šIPåœ°å€å’Œç«¯å£å·
            if(bind(sock_, (const sockaddr*)&local, sizeof(local)))
            {
                std::cout << "Bind IP&&Port Fail: " << strerror(errno) << std::endl;
                exit(BIND_ERR);
            }

            // ç»‘å®šæˆåŠŸ
            std::cout << "Bind IP&&Port Success" << std::endl;
        }

        // å¯åŠ¨æœåŠ¡å™¨
        void StartServer()
        {
            // æœåŠ¡å™¨æ˜¯ä¸æ–­è¿è¡Œçš„ï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨ä¸€ä¸ª while(true) æ­»å¾ªç¯
            char buff[1024]; // ç¼“å†²åŒº
            while(true)
            {
                // 1. æ¥æ”¶æ¶ˆæ¯
                struct sockaddr_in peer; // å®¢æˆ·ç«¯ç»“æ„ä½“
                socklen_t len = sizeof(peer); // å®¢æˆ·ç«¯ç»“æ„ä½“å¤§å°

                // ä¼ å…¥ sizeof(buff) - 1 è¡¨ç¤ºå½“å‰ä¼ è¾“çš„æ˜¯å­—ç¬¦ä¸²ï¼Œé¢„ç•™ä¸€ä¸ªä½ç½®å­˜å‚¨ '\0'
                // ä¼ å…¥ 0 è¡¨ç¤ºå½“å‰æ˜¯é˜»å¡å¼è¯»å–
                ssize_t n = recvfrom(sock_, buff, sizeof(buff) - 1, 0, (struct sockaddr*)&peer, &len);

                if(n > 0)
                    buff[n] = '\0';
                else
                    continue; // ç»§ç»­è¯»å–

                // 2.å¤„ç†æ•°æ®
                std::string clientIp = inet_ntoa(peer.sin_addr); // è·å–IPåœ°å€
                uint16_t clientPort = ntohs(peer.sin_port); // è·å–ç«¯å£å·
                printf("Server get message from [%s:%d]$ %s\n",clientIp.c_str(), clientPort, buff);

                // è·å–ä¸šåŠ¡å¤„ç†åçš„ç»“æœ
                std::string respond = serverHandle_(buff);

                // 3.å›å“ç»™å®¢æˆ·ç«¯
                n = sendto(sock_, respond.c_str(), respond.size(), 0, (const struct sockaddr*)&peer, sizeof(peer));

                if(n == -1)
                    std::cout << "Send Message Fail: " << strerror(errno) << std::endl;
            }
        }

    private:
        int sock_; // å¥—æ¥å­—
        uint16_t port_; // ç«¯å£å·
        func_t serverHandle_; // ä¸šåŠ¡å¤„ç†å‡½æ•°ï¼ˆå›è°ƒå‡½æ•°ï¼‰
    };
}


```

ç°åœ¨åªéœ€è¦å…³æ³¨ä¸šåŠ¡å¤„ç†å¦‚ä½•å®ç°ï¼Œæ— éœ€è€ƒè™‘å…·ä½“çš„ç½‘ç»œä¼ è¾“å¦‚ä½•å®ç°

### 4.2.å¤§å†™è½¬å°å†™

ç°é˜¶æ®µå®ç°ä¸€ä¸ªå°†å¤§å†™å­—ç¬¦è½¬æ¢ä¸ºå°å†™å­—ç¬¦çš„å‡½æ•°æ˜“å¦‚åæŒï¼Œåªéœ€æ³¨æ„ä¸€ç‚¹å°±å¥½äº†ï¼š**å¯¹äºéå¤§å†™çš„å­—ç¬¦ï¼Œä¸éœ€è¦è¿›è¡Œæ”¹åŠ¨**

å‡½æ•°å®ç°å®Œæˆåï¼Œå°†å…¶ä½œä¸ºå‚æ•°ä¼ é€’ç»™ `UdpServer` ç±»å‹ï¼Œæ„é€ å‡ºç›¸åº”çš„å¯¹è±¡

```cpp
#include <memory> // æ™ºèƒ½æŒ‡é’ˆç›¸å…³å¤´æ–‡ä»¶
#include "server.hpp"

using namespace std;
using namespace nt_server;

// å¤§å†™è½¬å°å†™ï¼ˆè‹±æ–‡å­—æ¯ï¼‰
std::string UpToLow(const std::string& resquest)
{
    std::string ret(resquest);

    for(auto &rc : ret)
    {
        if(isupper(rc))
            rc += 32;
    }

    return ret;
}

int main()
{
    unique_ptr<UdpServer> usvr(new UdpServer(UpToLow));

    // åˆå§‹åŒ–æœåŠ¡å™¨
    usvr->InitServer();

    // å¯åŠ¨æœåŠ¡å™¨
    usvr->StartServer();

    return 0;
}


```

è‡³æ­¤åªéœ€è¦å®¢æˆ·ç«¯ä¼ å…¥ä¸€æ®µæ¶ˆæ¯ï¼Œå¦‚æœæ¶ˆæ¯ä¸­åŒ…å«äº†å¤§å†™å­—ç¬¦ï¼Œæˆ‘ä»¬çš„æœåŠ¡å™¨å°±ä¼šå°†å…¶è½¬ä¸ºå°å†™å­—ç¬¦ï¼Œç„¶åå°†æ¶ˆæ¯å‘é€ç»™å®¢æˆ·ç«¯ï¼Œç›¸å½“äºä¹‹å‰å•çº¯å›å“å­—ç¬¦ä¸²çš„åŠ å¼ºç‰ˆ

å®¢æˆ·ç«¯ä»ç„¶åªéœ€å‘é€æ¶ˆæ¯ã€æ¥æ”¶æ¶ˆæ¯ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ä¹‹å‰çš„å®¢æˆ·ç«¯

é‡æ–°ç¼–è¯‘å¹¶è¿è¡ŒæœåŠ¡å™¨ï¼Œé€šè¿‡å®¢æˆ·ç«¯å‘é€ä¿¡æ¯ï¼Œå¯ä»¥çœ‹åˆ°å¤§å†™å­—ç¬¦ç¡®å®éƒ½è¢«è½¬ä¸ºå°å†™å­—ç¬¦äº†

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/24677dd8d86a48ad8b07e64614f9750b.png)  
 å¦‚æœæƒ³å®ç°å°å†™è½¬å¤§å†™ï¼Œæˆ–å…¶ä»–è½¬æ¢éœ€æ±‚ï¼Œåªéœ€è¦é‡æ–°ç¼–å†™ä¸šåŠ¡å¤„ç†å‡½æ•°ï¼Œå°†å…¶ä½œä¸ºå‚æ•°ä¼ é€’ç»™ UdpServer ç±»å³å¯

æ³¨æ„ï¼š **ä¼ é€’çš„ä¸šåŠ¡å¤„ç†å‡½æ•°ï¼Œåœ¨è¿”å›å€¼ã€å‚æ•°æ–¹é¢ï¼Œå¿…é¡»ä¸ç±»ä¸­çš„å›è°ƒå‡½æ•°ç±»å‹ä¸€è‡´**

### 4.3.è¿œç¨‹bash

**`bash` æŒ‡ä»¤æ˜¯å¦‚ä½•æ‰§è¡Œçš„ï¼Ÿ**

* æ¥æ”¶æŒ‡ä»¤ï¼ˆå­—ç¬¦ä¸²ï¼‰
* å¯¹æŒ‡ä»¤è¿›è¡Œåˆ†å‰²ï¼Œæ„æˆæœ‰æ•ˆä¿¡æ¯
* åˆ›å»ºå­è¿›ç¨‹ï¼Œæ‰§è¡Œè¿›ç¨‹æ›¿æ¢
* å­è¿›ç¨‹è¿è¡Œç»“æŸåï¼Œçˆ¶è¿›ç¨‹å›æ”¶åƒµå°¸è¿›ç¨‹

**è¾“å…¥ç‰¹æ®ŠæŒ‡ä»¤æ—¶çš„å¤„ç†**

* å¯ä»¥è‡ªå·± æ¨¡æ‹Ÿå®ç°ç®€æ˜“ç‰ˆ bashï¼Œä¸è¿‡è¿™æ ·åšå¤ªéº»çƒ¦äº†
* ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ç³»ç»Ÿæä¾›çš„ `popen` å‡½æ•°

```cpp
#include <stdio.h>

FILE *popen(const char *command, const char *type);

int pclose(FILE *stream);


```

**å‚æ•°è§£è¯»**

* `command` æƒ³è¦æ‰§è¡Œçš„æŒ‡ä»¤
* `type` æ‰“å¼€æ–‡ä»¶çš„æ–¹å¼ï¼ˆr / w / aï¼‰
* è¿”å›å€¼ï¼šæ‰§è¡ŒæˆåŠŸè¿”å›æœ€ç»ˆæ‰§è¡Œç»“æœçš„æ–‡ä»¶æµå¥æŸ„ï¼Œå¤±è´¥è¿”å› NULL

è¿™ä¸ªå‡½æ•°åšäº†è¿™äº›äº‹ï¼š**åˆ›å»ºç®¡é“ã€åˆ›å»ºå­è¿›ç¨‹ã€æ‰§è¡ŒæŒ‡ä»¤ã€å°†æ‰§è¡Œç»“æœä»¥`FILE*`çš„å½¢å¼è¿”å›**

å‡½æ•°æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå¯èƒ½é‡åˆ° `fork` åˆ›å»ºå­è¿›ç¨‹å¤±è´¥ï¼Œæˆ–è€… `pipe` åˆ›å»ºç®¡é“å¤±è´¥ï¼Œæ— è®ºé‡åˆ°å“ªç§é—®é¢˜ï¼Œæœ€ç»ˆå‡½æ•°éƒ½ä¼šæ‰§è¡Œå¤±è´¥ï¼Œå¹¶è¿”å› `NULL`

å› ä¸ºè¿™é‡Œè¿”å›çš„æ˜¯ FILE*ï¼Œè¯æ˜å…¶æ¶‰åŠäº†æ–‡ä»¶æµç›¸å…³æ“ä½œï¼Œåœ¨ä½¿ç”¨ç»“æŸåï¼Œéœ€è¦ä½¿ç”¨`pclose`æ‰‹åŠ¨å…³é—­æ–‡ä»¶æµ

ç¼–å†™è¿œç¨‹ `bash` çš„ä¸šåŠ¡å¤„ç†å‡½æ•°å¦‚ä¸‹

`ExecCommand()` ä¸šåŠ¡å¤„ç†å‡½æ•° â€” ä½äº `server.cc` æœåŠ¡å™¨æºæ–‡ä»¶

```cpp
// è¿œç¨‹ bash
std::string ExecCommand(const std::string& request)
{
    // 1.å®‰å…¨æ£€æŸ¥
    // ...

    // 2.è·å–æ‰§è¡Œç»“æœ
    FILE* fp = popen(request.c_str(), "r");
    if(fp == NULL)
        return "Can't execute command!";

    // 3.å°†ç»“æœè¯»å–è‡³å­—ç¬¦ä¸²ä¸­
    std::string ret;
    char buffline[1024]; // è¡Œç¼“å†²åŒº
    while (fgets(buffline, sizeof(buffline), fp) != NULL)
    {
        // å°†æ¯ä¸€è¡Œç»“æœï¼Œæ·»åŠ è‡³ ret ä¸­
        ret += buffline;
    }

    // 4.å…³é—­æ–‡ä»¶æµ
    fclose(fp);

    // 5.è¿”å›æœ€ç»ˆæ‰§è¡Œç»“æœ
    return ret;
}


```

**æ­¤æ—¶éœ€è¦è€ƒè™‘ä¸€ä¸ªé—®é¢˜ï¼šå¦‚æœåˆ«äººè¾“å…¥çš„æ˜¯æ•æ„ŸæŒ‡ä»¤ï¼ˆæ¯”å¦‚ rm -rf *ï¼‰æ€ä¹ˆåŠï¼Ÿ**

* ç­”æ¡ˆå½“ç„¶æ˜¯`ç›´æ¥æ‹¦æˆª`ï¼Œä¸è®©åˆ«äººæ‰§è¡Œæ•æ„Ÿæ“ä½œï¼Œæ¯•ç«Ÿ `Linux` é»˜è®¤å¯æ²¡æœ‰å›æ”¶ç«™ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦è€ƒè™‘å®‰å…¨æ£€æŸ¥
* æ•æ„Ÿæ“ä½œåŒ…å«è¿™äº›ï¼škill å‘é€ä¿¡å·ç»ˆæ­¢è¿›ç¨‹ã€mv ç§»åŠ¨æ–‡ä»¶ã€rm åˆ é™¤æ–‡ä»¶ã€while :; do æ­»å¾ªç¯ã€shutdown å…³æœºç­‰ç­‰
* åœ¨æ‰§è¡Œç”¨æˆ·ä¼ å…¥çš„æŒ‡ä»¤å‰ï¼Œå…ˆå¯¹æŒ‡ä»¤ä¸­çš„å­ä¸²è¿›è¡Œæ‰«æï¼Œå¦‚æœå‘ç°æ•æ„Ÿæ“ä½œï¼Œå°±ç›´æ¥è¿”å›ï¼Œä¸å†æ‰§è¡Œåç»­æ“ä½œ

> `checkSafe()` å®‰å…¨æ£€æŸ¥å‡½æ•° â€” ä½äº `server.cc` æœåŠ¡å™¨æºæ–‡ä»¶

```cpp
// å®‰å…¨æ£€æŸ¥
bool checkSafe(const std::string& comm)
{
    // æ„å»ºå®‰å…¨æ£€æŸ¥ç»„
    std::vector<std::string> unsafeComms{"kill", "mv", "rm", "while :; do", "shutdown"};

    // æŸ¥æ‰¾ comm ä¸­æ˜¯å¦åŒ…å«å®‰å…¨æ£€æŸ¥ç»„ä¸­çš„å­—æ®µ
    for(auto &str : unsafeComms)
    {
        // å¦‚æœæ‰¾åˆ°äº†ï¼Œå°±è¯´æ˜å­˜åœ¨ä¸å®‰å…¨çš„æ“ä½œ
        if(comm.find(str) != std::string::npos)
            return false;
    }

    return true;
}


```

å°† `checkSafe` å®‰å…¨æ£€æŸ¥å‡½æ•°æ•´åˆè¿› `ExecCommand` ä¸šåŠ¡å¤„ç†å‡½æ•°ä¸­ï¼ŒåŒæ—¶åœ¨æ„å»º`UdpServer`å¯¹è±¡æ—¶ï¼Œä¼ å…¥è¯¥ä¸šåŠ¡å¤„ç†å‡½æ•°å¯¹è±¡ï¼Œç¼–è¯‘å¹¶è¿è¡Œç¨‹åº

```cpp
#include <string>
#include <vector>
#include <memory> // æ™ºèƒ½æŒ‡é’ˆç›¸å…³å¤´æ–‡ä»¶
#include <cstdio>
#include "server.hpp"

using namespace std;
using namespace nt_server;

// å®‰å…¨æ£€æŸ¥
bool checkSafe(const std::string& comm)
{
    // æ„å»ºå®‰å…¨æ£€æŸ¥ç»„
    std::vector<std::string> unsafeComms{"kill", "mv", "rm", "while :; do", "shutdown"};

    // æŸ¥æ‰¾ comm ä¸­æ˜¯å¦åŒ…å«å®‰å…¨æ£€æŸ¥ç»„ä¸­çš„å­—æ®µ
    for(auto &str : unsafeComms)
    {
        // å¦‚æœæ‰¾åˆ°äº†ï¼Œå°±è¯´æ˜å­˜åœ¨ä¸å®‰å…¨çš„æ“ä½œ
        if(comm.find(str) != std::string::npos)
            return false;
    }

    return true;
}

// è¿œç¨‹ bash
std::string ExecCommand(const std::string& request)
{
    // 1.å®‰å…¨æ£€æŸ¥
    if(!checkSafe(request))
        return "Non-safety instructions, refusal to execute!";

    // 2.è·å–æ‰§è¡Œç»“æœ
    FILE* fp = popen(request.c_str(), "r");
    if(fp == NULL)
        return "Can't execute command!";

    // 3.å°†ç»“æœè¯»å–è‡³å­—ç¬¦ä¸²ä¸­
    std::string ret;
    char buffline[1024]; // è¡Œç¼“å†²åŒº
    while (fgets(buffline, sizeof(buffline), fp) != NULL)
    {
        // å°†æ¯ä¸€è¡Œç»“æœï¼Œæ·»åŠ è‡³ ret ä¸­
        ret += buffline;
    }

    // 4.å…³é—­æ–‡ä»¶æµ
    fclose(fp);

    // 5.è¿”å›æœ€ç»ˆæ‰§è¡Œç»“æœ
    return ret;
}

int main()
{
    unique_ptr<UdpServer> usvr(new UdpServer(ExecCommand));

    // åˆå§‹åŒ–æœåŠ¡å™¨
    usvr->InitServer();

    // å¯åŠ¨æœåŠ¡å™¨
    usvr->StartServer();

    return 0;
}


```

å¯ä»¥çœ‹åˆ°ï¼Œè¾“å…¥`å®‰å…¨æŒ‡ä»¤`æ—¶ï¼Œå¯ä»¥æ­£å¸¸è·å–ç»“æœï¼Œå¦‚æœè¾“å…¥çš„æ˜¯éå®‰å…¨æŒ‡ä»¤ï¼Œä¼šç›´æ¥æ‹’ç»æ‰§è¡Œ

å¹³æ—¶ä½¿ç”¨çš„`Xshell`æœ¬è´¨ä¸Šå°±æ˜¯è¿™æ ·ä¸€æ¬¾ç½‘ç»œç¨‹åºï¼Œæˆ‘ä»¬å°†æŒ‡ä»¤å‘ç»™ `Xshell` æœåŠ¡å™¨ï¼Œå®ƒå†ä»¥ç±»ä¼¼äº `fopen` çš„æ–¹å¼è½¬å‘ç»™æœåŠ¡å™¨ï¼Œè·å–æ‰§è¡Œç»“æœåå±•ç¤ºç»™ç”¨æˆ·

## 5.å¤šäººèŠå¤©å®¤

### 5.1.æ ¸å¿ƒåŠŸèƒ½

è¿™æ˜¯åŸºäº `UDP` åè®®å®ç°çš„æœ€åä¸€ä¸ªç½‘ç»œç¨‹åºï¼Œä¸»è¦åŠŸèƒ½æ˜¯ **æ„å»ºä¸€ä¸ªå¤šäººèŠå¤©å®¤ï¼Œå½“æŸä¸ªç”¨æˆ·å‘é€æ¶ˆæ¯æ—¶ï¼Œå…¶ä»–ç”¨æˆ·å¯ä»¥ç«‹å³æ”¶åˆ°ï¼Œå½¢æˆä¸€ä¸ªç¾¤èŠ**

åœ¨è¿™ä¸ªç¨‹åºä¸­ï¼ŒæœåŠ¡å™¨æ‰®æ¼”äº†ä¸€ä¸ªæ¥æ”¶æ¶ˆæ¯å’Œåˆ†å‘æ¶ˆæ¯çš„è§’è‰²ï¼Œå°†æ¶ˆæ¯å‘é€ç»™å·²çŸ¥çš„ç”¨æˆ·ä¸»æœº

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/a633bb696f5e4adeb4a87b8ae9bb393b.png)

### 5.2.ç¨‹åºç»“æ„

å°†æœåŠ¡å™¨æ¥æ”¶æ¶ˆæ¯çœ‹ä½œç”Ÿäº§å•†å“ã€åˆ†å‘æ¶ˆæ¯çœ‹ä½œæ¶ˆè´¹å•†å“ï¼Œè¿™ä¸å°±æ˜¯ä¸€ä¸ªç”ŸåŠ¨å½¢è±¡çš„ ã€Œç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ã€ å—ï¼Ÿ

**ã€Œç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ã€ å¿…å¤‡ 321**

* 3ï¼šä¸‰ç»„å…³ç³»
* 2ï¼šä¸¤ä¸ªè§’è‰²
* 1ï¼šä¸€ä¸ªäº¤æ˜“åœºæ‰€

å…¶ä¸­ä¸¤ä¸ªè§’è‰²å¯ä»¥åˆ†åˆ«åˆ›å»ºä¸¤ä¸ªçº¿ç¨‹ï¼Œä¸€ä¸ªè´Ÿè´£æ¥æ”¶æ¶ˆæ¯ï¼Œæ”¾å…¥ ã€Œç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ã€ï¼Œå¦ä¸€ä¸ªåˆ™æ˜¯è´Ÿè´£ä» ã€Œç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ã€ ä¸­æ‹¿å»æ¶ˆæ¯ï¼Œåˆ†å‘ç»™ç”¨æˆ·ä¸»æœº

è¿™é‡Œçš„äº¤æ˜“åœºæ‰€å¯ä»¥é€‰åˆ™ `é˜»å¡é˜Ÿåˆ—`ï¼Œä¹Ÿå¯ä»¥é€‰æ‹© `ç¯å½¢é˜Ÿåˆ—`

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/e27c3677de474d8db724d4210fbf042f.png)  
 æ³¨æ„ï¼š å¹¶éåªæœ‰å®¢æˆ·ç«¯ A å¯ä»¥å‘ç¯å½¢é˜Ÿåˆ—ä¸­æ”¾æ¶ˆæ¯ï¼Œæ‰€æœ‰å®¢æˆ·ç«¯ä¸»æœºçš„åœ°ä½éƒ½æ˜¯å¹³ç­‰çš„ï¼Œå…è®¸å­˜æ”¾æ¶ˆæ¯ï¼Œä¹Ÿå…è®¸æ¥æ”¶åˆ«äººå‘çš„æ¶ˆæ¯

### æœåŠ¡å™¨

### 5.3.å¼•å…¥ç¯å½¢é˜Ÿåˆ—

**åœ¨å¼•å…¥ ã€Œç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ã€ åï¼ŒæœåŠ¡å™¨å¤´æ–‡ä»¶ç»“æ„å°†ä¼šå˜æˆä¸‹é¢è¿™ä¸ªæ ·å­**

* å¯åŠ¨æœåŠ¡å™¨ï¼ŒåŸåˆå§‹åŒ–æœåŠ¡å™¨ã€å¯åŠ¨çº¿ç¨‹
* æ¥æ”¶æ¶ˆæ¯ï¼Œå°†æ”¶åˆ°çš„æ¶ˆæ¯å­˜å…¥ç¯å½¢é˜Ÿåˆ—
* å‘é€æ¶ˆæ¯ï¼Œä»ç¯å½¢é˜Ÿåˆ—ä¸­è·å–æ¶ˆæ¯ï¼Œå¹¶æ´¾å‘ç»™çº¿ç¨‹
* æ¥ä¸‹æ¥åŒ…å«ç¯å½¢é˜Ÿåˆ— RingQueue.hpp ç›¸å…³å¤´æ–‡ä»¶

è¿™é‡Œå®ç°çš„æ˜¯å¤šäººèŠå¤©å®¤ï¼Œä¹Ÿå°±ä¸å†éœ€è¦ä¼ å…¥å›è°ƒå‡½æ•°äº†

> `server.hpp` æœåŠ¡å™¨å¤´æ–‡ä»¶

```cpp
#pragma once
#include <iostream>
#include <string>
#include <functional>
#include <cstring>
#include <cerrno>
#include <string.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <arpa/inet.h>
#include "err.hpp"
#include "RingQueue.hpp"

namespace nt_server
{
    // ç«¯å£å·é»˜è®¤å€¼
    const uint16_t default_port = 8888;

    class UdpServer
    {
    public:
        // æ„é€ 
        UdpServer(uint16_t port = default_port)
            : port_(port)
        {
        }

        // ææ„
        ~UdpServer()
        {
        }

        // åˆå§‹åŒ–æœåŠ¡å™¨
        void InitServer()
        {
            // 1.åˆ›å»ºå¥—æ¥å­—
            sock_ = socket(AF_INET, SOCK_DGRAM, 0);

            if (sock_ == -1)
            {
                std::cout << "Create Socket Fail: " << strerror(errno) << std::endl;
                exit(SOCKET_ERR);
            }

            std::cout << "Create Socket Fail: " << strerror(errno) << std::endl;
            exit(SOCKET_ERR);

            // 2. ç»‘å®šipåœ°å€å’Œç«¯å£å·
            struct sockaddr_in local;
            bzero(&local, sizeof(local));

            // å¡«å……å­—æ®µ
            local.sin_family = AF_INET;
            local.sin_port = htons(port_);
            local.sin_addr.s_addr = INADDR_ANY; // ç»‘å®šä»»ä½•å¯ç”¨ipåœ°å€

            // ç»‘å®šipåœ°å€å’Œç«¯å£å·
            if (bind(sock_, (const struct sockaddr *)&local, sizeof(local)))
            {
                std::cout << "Bind IP&&Port Fail: " << strerror(errno) << std::endl;
                exit(BIND_ERR);
            }

            // ç»‘å®šæˆåŠŸ
            std::cout << "Bind IP&&Port Success" << std::endl;
        }

        // æ¥æ”¶æ¶ˆæ¯
        void RecvMessage()
        {
            // æœåŠ¡å™¨æ˜¯ä¸æ–­è¿è¡Œçš„ï¼Œå› æ­¤éœ€è¦ä½¿ç”¨whileæ­»å¾ªç¯
            char buff[1024]; // ç¼“å†²åŒº
            while (true)
            {
                // 1. æ¥æ”¶æ¶ˆæ¯
                struct sockaddr_in peer; // å®¢æˆ·ç«¯ç»“æ„ä½“
                socklen_t len = sizeof(peer);

                ssize_t n = recvfrom(sock_, buff, sizeof(buff) - 1, 0, (struct sockaddr *)&peer, &len);

                if (n > 0)
                    buff[n] = '\0';
                else
                    continue; // ç»§ç»­è¯»å–

                // 2. å¤„ç†æ•°æ®
                std::string clientIp = inet_ntoa(peer.sin_addr); // è·å–IPåœ°å€
                uint16_t clientPort = ntohs(peer.sin_port);      // è·å–ç«¯å£å·
                printf("Server get message from [%s:%d]$ %s\n", clientIp.c_str(), clientPort, buff);

                // 3.åˆ¤æ–­æ˜¯å¦è¯¥æ·»åŠ ç”¨æˆ·
                // TODO

                // 4.å°†æ¶ˆæ¯æ·»åŠ è‡³ç¯å½¢é˜Ÿåˆ—
                std::string msg = "[" + clientIp + ":" + std::to_string(clientPort) + "] say# " + buff;
                rq_.Push(msg);
            }
        }

        // å¹¿æ’­æ¶ˆæ¯
        void BroadcastMessage()
        {
            while (true)
            {
                // 1.ä»ç¯å½¢é˜Ÿåˆ—ä¸­è·å–æ¶ˆæ¯
                std::string msg;
                rq_.Pop(&msg);

                // 2.å°†æ¶ˆæ¯å‘ç»™ç”¨æˆ·
                // TODO
            }
        }

    private:
        int sock_;      // å¥—æ¥å­—
        uint16_t port_; // ç«¯å£å·
        ccc::RingQueue<std::string> rq_;
    };
}

```

### 5.4.å¼•å…¥ç”¨æˆ·ä¿¡æ¯

åœ¨é¦–æ¬¡æ¥æ”¶åˆ°æŸä¸ªç”¨æˆ·çš„ä¿¡æ¯æ—¶ï¼Œéœ€è¦å°†å…¶è¿›è¡Œæ ‡è¯†ï¼Œä»¥ä¾¿åç»­åœ¨è¿›è¡Œæ¶ˆæ¯å¹¿æ’­æ—¶åˆ†å‘ç»™ä»–

æœ‰ç‚¹ç±»ä¼¼äºç”¨æˆ·é¦–æ¬¡å‘é€æ¶ˆæ¯ï¼Œå°±è¢«æ‹‰å…¥äº† â€œç¾¤èŠâ€

ç›®å‰å¯ä»¥ä½¿ç”¨ `IP + Port` çš„æ–¹å¼æ ‡è¯†ç”¨æˆ·ï¼Œç¡®ä¿ç”¨æˆ·çš„å”¯ä¸€æ€§ï¼Œ**è¿™é‡Œé€‰å–`unordered_map`è¿™ç§å“ˆå¸Œè¡¨ç»“æ„ï¼Œæ–¹ä¾¿å¿«é€Ÿåˆ¤æ–­ç”¨æˆ·æ˜¯å¦å·²å­˜åœ¨**

* `key`ï¼šç”¨æˆ·æ ‡è¯†ç¬¦
* `value`ï¼šç”¨æˆ·å®¢æˆ·ç«¯çš„ `sockaddr_in` ç»“æ„ä½“

æ³¨æ„ï¼š **è¿™é‡Œçš„å“ˆå¸Œè¡¨åé¢ä¼šæ¶‰åŠå¤šçº¿ç¨‹çš„è®¿é—®ï¼Œéœ€è¦åŠ é”ä¿æŠ¤**

ä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œç›´æ¥ä½¿ç”¨äº†ä¹‹å‰ç¼–å†™çš„ LockGuard.hpp å°ç»„ä»¶ï¼ˆå…·ä½“å®ç°è¯¦è§ã€ŠLinuxå¤šçº¿ç¨‹ã€çº¿ç¨‹äº’æ–¥ä¸åŒæ­¥ã€‘ã€‹ï¼‰

> `server.hpp` æœåŠ¡å™¨å¤´æ–‡ä»¶

```cpp
#pragma once
#include <iostream>
#include <string>
#include <functional>
#include <cstring>
#include <cerrno>
#include <string.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <arpa/inet.h>
#include<unordered_map>
#include "err.hpp"
#include "RingQueue.hpp"
#include"LockGuard.hpp"

namespace nt_server
{
    // ç«¯å£å·é»˜è®¤å€¼
    const uint16_t default_port = 8888;

    class UdpServer
    {
    public:
        // æ„é€ 
        UdpServer(uint16_t port = default_port)
            : port_(port)
        {
        }

        // ææ„
        ~UdpServer()
        {
        }

        // åˆå§‹åŒ–æœåŠ¡å™¨
        void InitServer()
        {
            // 1.åˆ›å»ºå¥—æ¥å­—
            sock_ = socket(AF_INET, SOCK_DGRAM, 0);

            if (sock_ == -1)
            {
                std::cout << "Create Socket Fail: " << strerror(errno) << std::endl;
                exit(SOCKET_ERR);
            }

            std::cout << "Create Socket Fail: " << strerror(errno) << std::endl;
            exit(SOCKET_ERR);

            // 2. ç»‘å®šipåœ°å€å’Œç«¯å£å·
            struct sockaddr_in local;
            bzero(&local, sizeof(local));

            // å¡«å……å­—æ®µ
            local.sin_family = AF_INET;
            local.sin_port = htons(port_);
            local.sin_addr.s_addr = INADDR_ANY; // ç»‘å®šä»»ä½•å¯ç”¨ipåœ°å€

            // ç»‘å®šipåœ°å€å’Œç«¯å£å·
            if (bind(sock_, (const struct sockaddr *)&local, sizeof(local)))
            {
                std::cout << "Bind IP&&Port Fail: " << strerror(errno) << std::endl;
                exit(BIND_ERR);
            }

            // ç»‘å®šæˆåŠŸ
            std::cout << "Bind IP&&Port Success" << std::endl;
        }

        // æ¥æ”¶æ¶ˆæ¯
        void RecvMessage()
        {
            // æœåŠ¡å™¨æ˜¯ä¸æ–­è¿è¡Œçš„ï¼Œå› æ­¤éœ€è¦ä½¿ç”¨whileæ­»å¾ªç¯
            char buff[1024]; // ç¼“å†²åŒº
            while (true)
            {
                // 1. æ¥æ”¶æ¶ˆæ¯
                struct sockaddr_in peer; // å®¢æˆ·ç«¯ç»“æ„ä½“
                socklen_t len = sizeof(peer);

                ssize_t n = recvfrom(sock_, buff, sizeof(buff) - 1, 0, (struct sockaddr *)&peer, &len);

                if (n > 0)
                    buff[n] = '\0';
                else
                    continue; // ç»§ç»­è¯»å–

                // 2. å¤„ç†æ•°æ®
                std::string clientIp = inet_ntoa(peer.sin_addr); // è·å–IPåœ°å€
                uint16_t clientPort = ntohs(peer.sin_port);      // è·å–ç«¯å£å·
                printf("Server get message from [%s:%d]$ %s\n", clientIp.c_str(), clientPort, buff);

                // 3.åˆ¤æ–­æ˜¯å¦è¯¥æ·»åŠ ç”¨æˆ·
                std::string user = clientIp + ":" + std::to_string(clientPort);
                {
                    // éœ€è¦æ·é”ä¿æŠ¤
                    LockGuard lockguard(&mtx_);
                    if(userTable_.count(user) == 0)
                    userTable_[user] = peer; //é¦–æ¬¡å‡ºç°ï¼Œéœ€è¦æ·»åŠ 
                }

                // 4.å°†æ¶ˆæ¯æ·»åŠ è‡³ç¯å½¢é˜Ÿåˆ—
                std::string msg = "[" + clientIp + ":" + std::to_string(clientPort) + "] say# " + buff;
                rq_.Push(msg);
            }
        }

        // å¹¿æ’­æ¶ˆæ¯
        void BroadcastMessage()
        {
            while (true)
            {
                // 1.ä»ç¯å½¢é˜Ÿåˆ—ä¸­è·å–æ¶ˆæ¯
                std::string msg;
                rq_.Pop(&msg);

                // 2.å°†æ¶ˆæ¯å‘ç»™ç”¨æˆ·
               std::vector<sockaddr_in> arr;
               {
                 // ä»å“ˆå¸Œè¡¨ä¸­è¯»å–ä¿¡æ¯æ—¶ï¼Œéœ€è¦ä¿æŠ¤
                 LockGuard lockguard(&mtx_);
                 for(auto &user :userTable_)
                 {
                     arr.push_back(user.second);

                 }

                 for(auto &addr :arr)
                 {
                    // å‘é€æ¶ˆæ¯
                    sendto(sock_,msg.c_str(),msg.size(),0,(const sockaddr*)&addr,sizeof(addr));

                 }
                 

               }
            }
        }

    private:
        int sock_;      // å¥—æ¥å­—
        uint16_t port_; // ç«¯å£å·
        ccc::RingQueue<std::string> rq_;
        std::unordered_map<std::string,struct sockaddr_in> userTable_;
        pthread_mutex_t mtx_; //äº’æ–¥é”ï¼Œä¿æŠ¤å“ˆå¸Œè¡¨
    };
}

```

è¿™é‡Œçš„å®ç°æœ‰ä¸€ä¸ªå°ç»†èŠ‚ï¼šåœ¨è¿›è¡Œå¹¿æ’­æ¶ˆæ¯æ—¶ï¼Œå…ˆåœ¨åŠ é”çš„æƒ…å†µä¸‹ï¼Œå°†ç”¨æˆ·çš„`sockaddr_in`ç»“æ„ä½“å­˜å‚¨ï¼Œåœ¨éå†å‘é€æ¶ˆæ¯

è¿™æ ·åšçš„å¥½å¤„åœ¨äºå¯ä»¥åœ¨ä¸€å®šç¨‹åº¦ä¸Šæé«˜é€šä¿¡æ•ˆç‡ï¼Œå› ä¸º`sendto`å‡½æ•°æ¶‰åŠ IO æ“ä½œï¼ŒIO æœ¬æ¥å°±å¾ˆæ…¢ï¼ŒåŠ é”åå°±ä¼šæ›´æ…¢äº†ï¼Œ**å…ˆåœ¨åŠ é”æƒ…å†µä¸‹å°†ç”¨æˆ·`sockaddr_in`ç»“æ„ä½“ä¿å­˜åï¼Œå†éå†å‘é€æ¶ˆæ¯å°±æ— éœ€åŠ é”äº†ï¼ˆå› ä¸ºæ­¤æ—¶æ²¡æœ‰æ¶‰åŠä¸´ç•Œèµ„æºçš„æ“ä½œï¼‰**

### 5.5.å¼•å…¥å¤šçº¿ç¨‹

æœ€åå¼•å…¥ ã€Œç”Ÿäº§è€…æ¶ˆè´¹è€…ã€ æ¨¡å‹ä¸­çš„ä¸¤ç§è§’è‰²ï¼šç”Ÿäº§è€…ã€æ¶ˆè´¹è€…ï¼Œä¹Ÿå°±æ˜¯ä¸¤ä¸ªçº¿ç¨‹ï¼ŒåŸç”Ÿçº¿ç¨‹åº“çš„æ“ä½œæœ‰ç‚¹éº»çƒ¦äº†ï¼Œæˆ‘ä»¬åŒæ ·å¯ä»¥æ¬å‡ºä¹‹å‰å®ç°çš„å°ç»„ä»¶ `Thread.hpp`ï¼Œæ›´åŠ è½»æ¾çš„å®ç°çº¿ç¨‹æ“ä½œï¼ˆå…·ä½“å®ç°è¯¦è§ã€ŠLinuxå¤šçº¿ç¨‹ã€çº¿ç¨‹äº’æ–¥ä¸åŒæ­¥ã€‘ã€‹ï¼‰

**å¦‚ä½•å¼•å…¥å¤šçº¿ç¨‹ï¼Ÿ**

* åˆ›å»ºä¸¤ä¸ªçº¿ç¨‹ Aã€Bï¼Œå°†æ¥æ”¶æ¶ˆæ¯ä½œä¸ºçº¿ç¨‹ A çš„å›è°ƒå‡½æ•°ï¼Œå¹¿æ’­æ¶ˆæ¯ä½œä¸ºçº¿ç¨‹ B çš„å›è°ƒå‡½æ•°ï¼Œå½“ä¸¤ä¸ªçº¿ç¨‹éƒ½è¿è¡Œåï¼Œæ•´ä¸ªæ¨¡å‹ä¹Ÿå°±åŠ¨èµ·æ¥äº†

ä¸ºäº†ä½¿æˆ‘ä»¬å½“å‰æœåŠ¡å™¨çš„å‡½æ•°å¯¹è±¡èƒ½æˆåŠŸç»‘å®šè‡³ Thread å¯¹è±¡ï¼Œéœ€è¦ä¿®æ”¹ `Thread ç±»`ï¼ˆä½¿ç”¨ function åŒ…è£…å™¨ï¼‰

> `Thread.hpp` çº¿ç¨‹åº“ç±»

```cpp
#pragma once

#include <iostream>
#include <string>
#include <pthread.h>
#include <functional>

enum class Status
{
    NEW = 0, // æ–°å»º
    RUNNING, // è¿è¡Œä¸­
    EXIT // å·²é€€å‡º
};

// å‚æ•°ã€è¿”å›å€¼ä¸º void çš„å‡½æ•°ç±»å‹
typedef void (*func_t)(void*);
using func_t = std::function<void(void*)>; 

class Thread
{
public:
    Thread(int num = 0, func_t func = nullptr, void* args = nullptr)
        :_tid(0), _status(Status::NEW), _func(func), _args(args)
    {
        // æ ¹æ®ç¼–å·å†™å…¥åå­—
        char name[128];
        snprintf(name, sizeof name, "thread-%d", num);
        _name = name;
    }

    ~Thread()
    {}

    // è·å– ID
    pthread_t getTID() const
    {
        return _tid;
    }

    // è·å–çº¿ç¨‹å
    std::string getName() const
    {
        return _name;
    }

    // è·å–çŠ¶æ€
    Status getStatus() const
    {
        return _status;
    }

    // å›è°ƒæ–¹æ³•
    static void* runHelper(void* args)
    {
        Thread* myThis = static_cast<Thread*>(args);

        // å¾ˆç®€å•ï¼Œå›è°ƒç”¨æˆ·ä¼ è¿›æ¥çš„ func å‡½æ•°å³å¯
        myThis->_func(myThis->_args);
        return nullptr;
    }

    // å¯åŠ¨çº¿ç¨‹
    void run()
    {
        int ret = pthread_create(&_tid, nullptr, runHelper, this);
        if(ret != 0)
        {
            std::cerr << "create thread fail!" << std::endl;
            exit(1); // åˆ›å»ºçº¿ç¨‹å¤±è´¥ï¼Œç›´æ¥é€€å‡º
        }
        _status =  Status::RUNNING; // æ›´æ”¹çŠ¶æ€ä¸º è¿è¡Œä¸­
    }

    // çº¿ç¨‹ç­‰å¾…
    void join()
    {
        int ret = pthread_join(_tid, nullptr);
        if(ret != 0)
        {
            std::cerr << "thread join fail!" << std::endl;
            exit(1); // ç­‰å¾…å¤±è´¥ï¼Œç›´æ¥é€€å‡º
        }
        _status = Status::EXIT; // æ›´æ”¹çŠ¶æ€ä¸º é€€å‡º
    }

private:
    pthread_t _tid; // çº¿ç¨‹ ID
    std::string _name; // çº¿ç¨‹å
    Status _status; // çº¿ç¨‹çŠ¶æ€
    func_t _func; // çº¿ç¨‹å›è°ƒå‡½æ•°
    void* _args; // ä¼ é€’ç»™å›è°ƒå‡½æ•°çš„å‚æ•°
    int _num;
};

// ...


```

å› ä¸ºå½“å‰æ¶‰åŠäº†å¤šçº¿ç¨‹ç›¸å…³æ“ä½œï¼Œåœ¨ç¼–è¯‘ä»£ç æ—¶ï¼Œéœ€è¦æŒ‡æ˜ä½¿ç”¨ `pthread` åº“ï¼Œå°†`Makefile`å†…å®¹æ›´æ–°å¦‚ä¸‹

```cpp
.PHONY:all
all:server client

server:server.cc
	g++ -o $@ $^ -std=c++11 -lpthread

	
client:client.cc
	g++ -o $@ $^ -std=c++11 -lpthread

.PHONY:clean
clean:
	rm -rf server client


```

> `server.hpp` æœåŠ¡å™¨å¤´æ–‡ä»¶

```cpp
#pragma once

#include <iostream>
#include <string>
#include <unordered_map>
#include <functional>
#include <cstring>
#include <cerrno>
#include <cstdlib>
#include <strings.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <arpa/inet.h>
#include "err.hpp"
#include "RingQueue.hpp"
#include "LockGuard.hpp"
#include "Thread.hpp"

namespace nt_server
{
    // ç«¯å£å·é»˜è®¤å€¼
    const uint16_t default_port = 8888;

    class UdpServer
    {
    public:
        // æ„é€ 
        UdpServer(uint16_t port = default_port)
            :port_(port)
        {
            // åˆå§‹åŒ–äº’æ–¥é”
            pthread_mutex_init(&mtx_, nullptr);

            // åˆ›å»ºçº¿ç¨‹
            // æ³¨æ„ï¼šå› ä¸ºç±»å†…æˆå‘˜æœ‰éšå«çš„ this æŒ‡é’ˆï¼Œéœ€è¦å€ŸåŠ© bind å›ºå®šè¯¥å‚æ•°
            producer_ = new Thread(1, std::bind(&UdpServer::RecvMessage, this));
            consumer_ = new Thread(2, std::bind(&UdpServer::BroadcastMessage, this));
        }
        // ææ„
        ~UdpServer()
        {
            // ç­‰å¾…çº¿ç¨‹è¿è¡Œç»“æŸ
            producer_->join();
            consumer_->join();

            // é”€æ¯äº’æ–¥é”
            pthread_mutex_destroy(&mtx_);

            // é‡Šæ”¾å¯¹è±¡
            delete producer_;
            delete consumer_;
        } 

        // åˆå§‹åŒ–æœåŠ¡å™¨
        void StartServer()
        {
            // 1.åˆ›å»ºå¥—æ¥å­—
            sock_ = socket(AF_INET, SOCK_DGRAM, 0);

            if(sock_ == -1)
            {
                std::cout << "Create Socket Fail: " << strerror(errno) << std::endl;
                exit(SOCKET_ERR);
            }

            // åˆ›å»ºæˆåŠŸ
            std::cout << "Create Success Socket: " << sock_ << std::endl;

            // 2.ç»‘å®šIPåœ°å€å’Œç«¯å£å·
            struct sockaddr_in local;
            bzero(&local, sizeof(local)); // ç½®0

            // å¡«å……å­—æ®µ
            local.sin_family = AF_INET; // è®¾ç½®ä¸ºç½‘ç»œé€šä¿¡ï¼ˆPF_INET ä¹Ÿè¡Œï¼‰
            local.sin_port = htons(port_); // ä¸»æœºåºåˆ—è½¬ä¸ºç½‘ç»œåºåˆ—
            // local.sin_addr.s_addr = inet_addr(ip_.c_str()); // ç‚¹åˆ†åè¿›åˆ¶è½¬ä¸ºçŸ­æ•´æ•°ï¼Œå†å°†ä¸»æœºåºåˆ—è½¬ä¸ºç½‘ç»œåºåˆ—
            local.sin_addr.s_addr = INADDR_ANY; // ç»‘å®šä»»ä½•å¯ç”¨IPåœ°å€

            // ç»‘å®šIPåœ°å€å’Œç«¯å£å·
            if(bind(sock_, (const sockaddr*)&local, sizeof(local)))
            {
                std::cout << "Bind IP&&Port Fail: " << strerror(errno) << std::endl;
                exit(BIND_ERR);
            }

            // ç»‘å®šæˆåŠŸ
            std::cout << "Bind IP&&Port Success" << std::endl;

            // å¯åŠ¨çº¿ç¨‹
            producer_->run();
            consumer_->run();
        }

        // æ¥æ”¶æ¶ˆæ¯
        void RecvMessage()
        {
            // æœåŠ¡å™¨æ˜¯ä¸æ–­è¿è¡Œçš„ï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨ä¸€ä¸ª while(true) æ­»å¾ªç¯
            char buff[1024]; // ç¼“å†²åŒº
            while(true)
            {
                // 1. æ¥æ”¶æ¶ˆæ¯
                struct sockaddr_in peer; // å®¢æˆ·ç«¯ç»“æ„ä½“
                socklen_t len = sizeof(peer); // å®¢æˆ·ç«¯ç»“æ„ä½“å¤§å°

                // ä¼ å…¥ sizeof(buff) - 1 è¡¨ç¤ºå½“å‰ä¼ è¾“çš„æ˜¯å­—ç¬¦ä¸²ï¼Œé¢„ç•™ä¸€ä¸ªä½ç½®å­˜å‚¨ '\0'
                // ä¼ å…¥ 0 è¡¨ç¤ºå½“å‰æ˜¯é˜»å¡å¼è¯»å–
                ssize_t n = recvfrom(sock_, buff, sizeof(buff) - 1, 0, (struct sockaddr*)&peer, &len);

                if(n > 0)
                    buff[n] = '\0';
                else
                    continue; // ç»§ç»­è¯»å–

                // 2.å¤„ç†æ•°æ®
                std::string clientIp = inet_ntoa(peer.sin_addr); // è·å–IPåœ°å€
                uint16_t clientPort = ntohs(peer.sin_port); // è·å–ç«¯å£å·
                printf("Server get message from [%s:%d]$ %s\n",clientIp.c_str(), clientPort, buff);

                // 3.åˆ¤æ–­æ˜¯å¦è¯¥æ·»åŠ ç”¨æˆ·
                std::string user = clientIp + "-" + std::to_string(clientPort);

                {
                    // éœ€è¦åŠ é”ä¿æŠ¤
                    LockGuard lockguard(&mtx_);
                    if(userTable_.count(user) == 0)
                        userTable_[user] = peer; // é¦–æ¬¡å‡ºç°ï¼Œéœ€è¦æ·»åŠ 
                }

                // 4.å°†æ¶ˆæ¯æ·»åŠ è‡³ç¯å½¢é˜Ÿåˆ—
                std::string msg = "[" + clientIp + ":" + std::to_string(clientPort) + "] say# " + buff;
                rq_.Push(msg);
            }
        }

        // å¹¿æ’­æ¶ˆæ¯
        void BroadcastMessage()
        {
            while(true)
            {
                // 1.ä»ç¯å½¢é˜Ÿåˆ—ä¸­è·å–æ¶ˆæ¯
                std::string msg;
                rq_.Pop(&msg);

                // 2.å°†æ¶ˆæ¯å‘ç»™ç”¨æˆ·
                std::vector<sockaddr_in> arr;

                {
                    // ä»å“ˆå¸Œè¡¨ä¸­è¯»å–ä¿¡æ¯æ—¶ï¼Œéœ€è¦ä¿æŠ¤
                    LockGuard lockguard(&mtx_);
                    for(auto &user : userTable_)
                        arr.push_back(user.second);
                }

                for(auto &addr : arr)
                {
                    // å‘é€æ¶ˆæ¯
                    sendto(sock_, msg.c_str(), msg.size(), 0, (const sockaddr*)&addr, sizeof(addr));
                }
            }
        }

    private:
        int sock_; // å¥—æ¥å­—
        uint16_t port_; // ç«¯å£å·
        ccc::RingQueue<std::string> rq_; // ç¯å½¢é˜Ÿåˆ—
        std::unordered_map<std::string, struct sockaddr_in> userTable_; // <ç”¨æˆ·æ ‡è¯†ç¬¦, sockaddr_in ç»“æ„ä½“>
        pthread_mutex_t mtx_; // äº’æ–¥é”ï¼Œä¿æŠ¤å“ˆå¸Œè¡¨
        Thread* producer_; // ç”Ÿäº§è€…
        Thread* consumer_; // æ¶ˆè´¹è€…
    };
}


```

ä»¥ä¸Šå°±æ˜¯ `å¤šäººèŠå¤©å®¤` ä¸­ `server.hpp` æœåŠ¡å™¨å¤´æ–‡ä»¶çš„å…¨éƒ¨è®¾è®¡äº†ï¼Œè‡³äº `server.cc` æœåŠ¡å™¨æºæ–‡ä»¶ï¼Œå‡ ä¹ä¸ç”¨ä¿®æ”¹

> `server.cc` æœåŠ¡å™¨æºæ–‡ä»¶

```cpp
#include <string>
#include <vector>
#include <memory> // æ™ºèƒ½æŒ‡é’ˆç›¸å…³å¤´æ–‡ä»¶
#include <cstdio>
#include "server.hpp"

using namespace std;
using namespace nt_server;

int main()
{
    unique_ptr<UdpServer> usvr(new UdpServer());

    // å¯åŠ¨æœåŠ¡å™¨
    usvr->StartServer();

    return 0;
}


```

æ¥ä¸‹æ¥ç¼–è¯‘å¹¶è¿è¡Œç¨‹åºï¼Œå¯ä»¥çœ‹åˆ°æ­¤æ—¶æœ‰ä¸‰ä¸ªçº¿ç¨‹åœ¨è¿è¡Œï¼ˆä¸€ä¸ª server ä¸»çº¿ç¨‹ï¼Œä¸€ä¸ªç”Ÿäº§è€…çº¿ç¨‹ï¼Œä¸€ä¸ªæ¶ˆè´¹è€…çº¿ç¨‹ï¼‰  
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/b313c8279bfb4a04ac0c0fc1b266b285.png)  
 åˆ†åˆ«ä½¿ç”¨ä¸¤å°ä¸»æœºè¿è¡Œå®¢æˆ·ç«¯ï¼Œå¯ä»¥çœ‹åˆ°ä¸»æœº A ç¡®å®å¯ä»¥çœ‹åˆ°ä¸»æœº B å‘é€çš„ä¿¡æ¯ï¼Œä¸è¿‡é—®é¢˜åœ¨äº **æ— æ³•å®æ—¶æ›´æ–°æ¶ˆæ¯ï¼Œéœ€è¦è‡ªå·±å‘é€æ¶ˆæ¯åï¼Œæ‰èƒ½çœ‹åˆ°åˆ«äººå‘çš„æ¶ˆæ¯**

å‡ºç°è¿™ç§æƒ…å†µçš„åŸå› æ˜¯ `å®¢æˆ·ç«¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹`ï¼Œå‘é€æ¶ˆæ¯çš„åï¼Œæ‰èƒ½æ¥æ”¶æ¶ˆæ¯ï¼Œ è¿™å°±å¾ˆå°´å°¬äº†ï¼Œå‡è®¾è¿™ä¸ªç¾¤èŠé‡Œæœ‰åä¸ªç”¨æˆ·ï¼Œé‚£ç”¨æˆ· A å²‚ä¸æ˜¯è‡ªå·±è‡³å°‘å¾—å‘é€ 9 æ¡æ¶ˆæ¯ï¼Œæ‰èƒ½çœ‹åˆ°å…¶ä»–ä¹ä½ç”¨æˆ·ä¹‹å‰å‘é€çš„æ¶ˆæ¯

æ‰€ä»¥å®¢æˆ·ç«¯ä¹Ÿéœ€è¦å¤šçº¿ç¨‹åŒ–ï¼Œæ¥ä¸‹æ¥å°±æ˜¯å¯¹å®¢æˆ·ç«¯çš„æ”¹é€ 

### å®¢æˆ·ç«¯

### 5.6.å¤šçº¿ç¨‹åŒ–

æœ‰äº†ä¹‹å‰ `server.hpp` æœåŠ¡å™¨å¤´æ–‡ä»¶å¤šçº¿ç¨‹åŒ–çš„ç»éªŒåï¼Œæ”¹é€  `client.hpp` å®¢æˆ·ç«¯å¤´æ–‡ä»¶å°±å¾ˆç®€å•äº†ï¼ŒåŒæ ·æ˜¯**åˆ›å»ºä¸¤ä¸ªçº¿ç¨‹ï¼Œä¸€ä¸ªè´Ÿè´£å‘é€æ¶ˆæ¯ï¼Œä¸€ä¸ªè´Ÿè´£æ¥æ”¶æ¶ˆæ¯**

è¿™é‡ŒåŒæ ·ä½¿ç”¨ `Thread.hpp` çº¿ç¨‹ç±»

> `client.hpp` å®¢æˆ·ç«¯å¤´æ–‡ä»¶

```cpp
#pragma once

#include <iostream>
#include <string>
#include <functional>
#include <cstring>
#include <cerrno>
#include <cstdlib>
#include <strings.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <arpa/inet.h>
#include "err.hpp"
#include "Thread.hpp"
#include "LockGuard.hpp"

namespace nt_client
{
    class UdpClient
    {
    public:
        // æ„é€ 
        UdpClient(const std::string& ip, uint16_t port)
            :server_ip_(ip), server_port_(port)
        {
            // åˆ›å»ºçº¿ç¨‹
            recv_ = new Thread(1, std::bind(&UdpClient::RecvMessage, this));
            send_ = new Thread(2, std::bind(&UdpClient::SendMessage, this));
        }

        // ææ„
        ~UdpClient() 
        {
            // ç­‰å¾…çº¿ç¨‹é€€å‡º
            recv_->join();
            send_->join();

            delete (recv_);
            delete (send_);
        } 

        // å¯åŠ¨å®¢æˆ·ç«¯
        void StartClient() 
        {
            // 1.åˆ›å»ºå¥—æ¥å­—
            sock_ = socket(AF_INET, SOCK_DGRAM, 0);

            if(sock_ == -1)
            {
                std::cout << "Create Socket Fail: " << strerror(errno) << std::endl;
                exit(SOCKET_ERR);
            }

            std::cout << "Create Success Socket: " << sock_ << std::endl;

            // 2.æ„å»ºæœåŠ¡å™¨çš„ sockaddr_in ç»“æ„ä½“ä¿¡æ¯
            bzero(&svr_, sizeof(svr_));
            svr_.sin_family = AF_INET; // è®¾ç½®ä¸ºç½‘ç»œé€šä¿¡ï¼ˆPF_INET ä¹Ÿè¡Œï¼‰
            svr_.sin_addr.s_addr = inet_addr(server_ip_.c_str()); // ç»‘å®šæœåŠ¡å™¨IPåœ°å€
            svr_.sin_port = htons(server_port_); // ç»‘å®šæœåŠ¡å™¨ç«¯å£å·

            // å¯åŠ¨çº¿ç¨‹
            recv_->run();
            send_->run();
        }

        // å‘é€æ¶ˆæ¯
        void RecvMessage() 
        {
            while(true)
            {
                // å‘é€æ¶ˆæ¯
                std::string msg;
                std::cout << "Input Message# ";
                std::getline(std::cin, msg);

                ssize_t n = sendto(sock_, msg.c_str(), msg.size(), 0, (const struct sockaddr*)&svr_, sizeof(svr_));

                if(n == -1)
                {
                    std::cout << "Send Message Fail: " << strerror(errno) << std::endl;
                    continue; // é‡æ–°è¾“å…¥æ¶ˆæ¯å¹¶å‘é€
                }
            }
        }

        // æ¥æ”¶æ¶ˆæ¯
        void SendMessage()
        {
            char buff[1024];
            while(true)
            {
                // 2.æ¥æ”¶æ¶ˆæ¯
                socklen_t len = sizeof(svr_); // åˆ›å»ºä¸€ä¸ªå˜é‡ï¼Œå› ä¸ºæ¥ä¸‹æ¥çš„å‚æ•°éœ€è¦ä¼ å·¦å€¼
                ssize_t n = recvfrom(sock_, buff, sizeof(buff) - 1, 0, (struct sockaddr*)&svr_, &len);

                if(n > 0)
                    buff[n] = '\0';
                else
                    continue;

                std::cout << "Client get message " << buff << std::endl;
            }
        }

    private:
        std::string server_ip_; // æœåŠ¡å™¨IPåœ°å€
        uint16_t server_port_; // æœåŠ¡å™¨ç«¯å£å·
        int sock_;
        struct sockaddr_in svr_; // æœåŠ¡å™¨çš„sockadder_inç»“æ„ä½“ä¿¡æ¯
        Thread* recv_; // å‘é€æ¶ˆæ¯
        Thread* send_; // æ¥æ”¶æ¶ˆæ¯
    };
}


```

> `client.cc` å®¢æˆ·ç«¯æºæ–‡ä»¶

```cpp
#include <iostream>
#include <memory>
#include <memory>
#include "client.hpp"

using namespace std;
using namespace nt_client;

void Usage(const char* program)
{
  cout << "Usage:" << endl;
  cout << "\t" << program << " ServerIP ServerPort" << endl;
}

int main(int argc, char* argv[])
{
  if (argc != 3)
  {
    // é”™è¯¯çš„å¯åŠ¨æ–¹å¼ï¼Œæç¤ºé”™è¯¯ä¿¡æ¯
    Usage(argv[0]);
    return USAGE_ERR;
  }

  std::string ip = argv[1];
  uint16_t port = stoi(argv[2]);

  unique_ptr<UdpClient> usvr(new UdpClient(ip, port));

  // å¯åŠ¨å®¢æˆ·ç«¯
  usvr->StartClient();

  return 0;
}



```

å®¢æˆ·ç«¯æ”¹é€ å®Œæˆåï¼Œå†æ¬¡æœåŠ¡å™¨ä¸å®¢æˆ·ç«¯ï¼Œå¯ä»¥çœ‹åˆ°ç°åœ¨å·²ç»æ­£å¸¸äº†ï¼Œ`å¤šäººèŠå¤©å®¤` æ„å»ºå®Œæ¯•

æ³¨ï¼šå› ä¸ºå®¢æˆ·ç«¯å‘é€æ¶ˆæ¯ã€æ¥æ”¶æ¶ˆæ¯ä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œå±äºä¸´ç•Œèµ„æºï¼Œæ‰€ä»¥æ˜¾ç¤ºæ—¶å‡ºç°é—®é¢˜å¾ˆæ­£å¸¸

å…³äºè¾“å…¥ã€è¾“å‡ºæ¶ˆæ¯å‰¥ç¦»çš„é—®é¢˜ï¼Œå¯ä»¥åˆ©ç”¨æ ‡å‡†è¾“å‡ºã€æ ‡å‡†é”™è¯¯ + ç®¡é“çš„æ–¹å¼è¿›è¡ŒåŒºåˆ†ï¼Œé™äºç¯‡å¹…åŸå› ï¼Œè¿™é‡Œä¸å†é˜è¿°

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/00ac324b0f6c4fe28aa22b9722a5fae1.png)  
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/c277790f78b54a009fddc8a0a549948a.png)

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/b7a553fd71114dddb4814fd400980965.gif#pic_center)



