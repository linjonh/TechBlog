---
layout: post
title: "20250306-笔记-精读class-CVRPEnvstepself,-selected"
date: 2025-03-07 16:13:18 +0800
description: "函数是强化学习代码实现中的核心。熟悉每一个参数的shape。熟悉每个参数之间的关系（剪切，扩展，等）。"
keywords: "20250306-笔记-精读class CVRPEnv:step(self, selected)"
categories: ['代码学习笔记']
tags: ['笔记']
artid: "146080108"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146080108
    alt: "20250306-笔记-精读class-CVRPEnvstepself,-selected"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146080108
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146080108
cover: https://bing.ee123.net/img/rand?artid=146080108
image: https://bing.ee123.net/img/rand?artid=146080108
img: https://bing.ee123.net/img/rand?artid=146080108
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     20250306-笔记-精读class CVRPEnv:step(self, selected)
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="./../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="./../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <p>
    </p>
    <hr/>
    <h2>
     <a id="_6">
     </a>
     前言
    </h2>
    <p>
     <code>
      class CVRPEnv:step(self, selected)
     </code>
     函数是强化学习代码实现中的核心。
     <br/>
     精读该代码的目标：
    </p>
    <ol>
     <li>
      熟悉每一个参数的shape。
     </li>
     <li>
      熟悉每个参数之间的关系（剪切，扩展，等）。
     </li>
    </ol>
    <hr/>
    <h2>
     <a id="_4_15">
     </a>
     一、时间步小于 4
    </h2>
    <h3>
     <a id="11__16">
     </a>
     1.1 控制时间步的递增
    </h3>
    <pre><code class="prism language-python">            <span class="token comment"># 控制时间步的递增</span>
            self<span class="token punctuation">.</span>time_step<span class="token operator">=</span>self<span class="token punctuation">.</span>time_step<span class="token operator">+</span><span class="token number">1</span>
            self<span class="token punctuation">.</span>selectex_count <span class="token operator">=</span> self<span class="token punctuation">.</span>selected_count<span class="token operator">+</span><span class="token number">1</span>
</code></pre>
    <table>
     <thead>
      <tr>
       <th>
        参数
       </th>
       <th align="center">
        Shape
       </th>
       <th align="left">
        含义
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        self.time_step
       </td>
       <td align="center">
        标量
       </td>
       <td align="left">
        用来控制时间步数
       </td>
      </tr>
      <tr>
       <td>
        self.selectex_count
       </td>
       <td align="center">
        (batch, pomo)
       </td>
       <td align="left">
        表示每个批次、每个智能体已选择的节点数量。
       </td>
      </tr>
     </tbody>
    </table>
    <blockquote>
     <p>
      self.time_step=self.time_step+1
     </p>
    </blockquote>
    <p>
     增加
     <code>
      self.time_step
     </code>
     的值，用来控制时间步数。
    </p>
    <ul>
     <li>
      <code>
       self.time_step
      </code>
      是一个标量（单个整数），表示当前的时间步数。
     </li>
    </ul>
    <blockquote>
     <p>
      self.selected_count = self.selected_count + 1
     </p>
    </blockquote>
    <p>
     这一行代码的目的是增加
     <code>
      self.selected_count
     </code>
     的值，表示在当前时间步中，智能体已经选择的节点数量增加了。
    </p>
    <ul>
     <li>
      <code>
       self.selected_count
      </code>
      是一个形状为
      <code>
       (batch_size, pomo_size)
      </code>
      的张量，表示每个批次、每个智能体已选择的节点数量。
     </li>
    </ul>
    <h3>
     <a id="12__37">
     </a>
     1.2 判断是否在配送中心
    </h3>
    <pre><code class="prism language-python">            <span class="token comment">#判断是否在配送中心</span>
            self<span class="token punctuation">.</span>at_the_depot <span class="token operator">=</span> <span class="token punctuation">(</span>selected <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
</code></pre>
    <table>
     <thead>
      <tr>
       <th>
        参数
       </th>
       <th align="center">
        Shape
       </th>
       <th align="left">
        含义
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        self.at_the_depot
       </td>
       <td align="center">
        (batch, pomo)
       </td>
       <td align="left">
        布尔张量,表示每个智能体是否位于配送中心
       </td>
      </tr>
      <tr>
       <td>
        selected
       </td>
       <td align="center">
        (batch, pomo)
       </td>
       <td align="left">
        表示每个批次和每个智能体选择的节点编号
       </td>
      </tr>
     </tbody>
    </table>
    <p>
     这行代码的目的是更新
     <code>
      self.at_the_depot
     </code>
     张量，用来表示每个智能体是否位于配送中心（通常是节点 0）。如果智能体选择的节点编号是 0（配送中心节点），则
     <code>
      self.at_the_depot
     </code>
     对应的位置为
     <code>
      True
     </code>
     ，否则为
     <code>
      False
     </code>
     。
    </p>
    <h3>
     <a id="13__49">
     </a>
     1.3 特定时间步的操作
    </h3>
    <pre><code class="prism language-python">            <span class="token keyword">if</span> self<span class="token punctuation">.</span>time_step<span class="token operator">==</span><span class="token number">3</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>last_current_node <span class="token operator">=</span> self<span class="token punctuation">.</span>current_node<span class="token punctuation">.</span>clone<span class="token punctuation">(</span><span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>last_load <span class="token operator">=</span> self<span class="token punctuation">.</span>load<span class="token punctuation">.</span>clone<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>time_step <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>last_current_node <span class="token operator">=</span> self<span class="token punctuation">.</span>current_node<span class="token punctuation">.</span>clone<span class="token punctuation">(</span><span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>last_load <span class="token operator">=</span> self<span class="token punctuation">.</span>load<span class="token punctuation">.</span>clone<span class="token punctuation">(</span><span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>visited_ninf_flag<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>problem_size<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token operator">~</span>self<span class="token punctuation">.</span>at_the_depot<span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>last_current_node<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>
</code></pre>
    <table>
     <thead>
      <tr>
       <th>
        参数
       </th>
       <th align="center">
        Shape
       </th>
       <th>
        含义
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        self.time_step
       </td>
       <td align="center">
        标量
       </td>
       <td>
        用来控制时间步数
       </td>
      </tr>
      <tr>
       <td>
        self.current_node
       </td>
       <td align="center">
        (batch, pomo)
       </td>
       <td>
        示每个批次、每个智能体当前访问的节点。
       </td>
      </tr>
      <tr>
       <td>
        self.last_current_node
       </td>
       <td align="center">
        (batch, pomo)
       </td>
       <td>
        self.current_node.clone()
       </td>
      </tr>
      <tr>
       <td>
        self.load
       </td>
       <td align="center">
        (batch, pomo)
       </td>
       <td>
        表示每个智能体当前的负载状态。
       </td>
      </tr>
      <tr>
       <td>
        self.last_load
       </td>
       <td align="center">
        (batch, pomo)
       </td>
       <td>
        self.load.clone()
       </td>
      </tr>
      <tr>
       <td>
        self.visited_ninf_flag
       </td>
       <td align="center">
        (batch, pomo, problem + 1)
       </td>
       <td>
        记录每个智能体对每个节点的访问标志。
       </td>
      </tr>
      <tr>
       <td>
        self.at_the_depot
       </td>
       <td align="center">
        (batch, pomo)
       </td>
       <td>
        布尔张量,表示每个智能体是否位于配送中心
       </td>
      </tr>
     </tbody>
    </table>
    <blockquote>
     <p>
      if self.time_step == 3:
      <br/>
      self.last_current_node = self.current_node.clone()
      <br/>
      self.last_load = self.load.clone()
     </p>
    </blockquote>
    <p>
     在时间步为 3 时，保存当前节点（
     <code>
      self.current_node
     </code>
     ）和负载（
     <code>
      self.load
     </code>
     ）的状态。
    </p>
    <ul>
     <li>
      <code>
       self.current_node
      </code>
      和
      <code>
       self.load
      </code>
      在时间步 3 时被保存为
      <code>
       self.last_current_node
      </code>
      和
      <code>
       self.last_load
      </code>
      。它们的形状仍然是
      <code>
       (batch_size, pomo_size)
      </code>
     </li>
    </ul>
    <blockquote>
     <p>
      if self.time_step == 4:
      <br/>
      self.last_current_node = self.current_node.clone()
      <br/>
      self.last_load = self.load.clone()
     </p>
    </blockquote>
    <p>
     在时间步为 4 时，再次保存当前节点和负载状态，并更新
     <code>
      self.visited_ninf_flag
     </code>
     ，修改智能体在配送中心以外的访问状态。
    </p>
    <ul>
     <li>
      <code>
       self.current_node
      </code>
      和
      <code>
       self.load
      </code>
      在时间步 4 时被保存为
      <code>
       self.last_current_node
      </code>
      和
      <code>
       self.last_load
      </code>
      。它们的形状仍然是
      <code>
       (batch_size, pomo_size)
      </code>
     </li>
    </ul>
    <blockquote>
     <p>
      self.visited_ninf_flag[:, :, self.problem_size + 1][(~self.at_the_depot) &amp; (self.last_current_node != 0)] = 0
     </p>
    </blockquote>
    <ul>
     <li>
      <p>
       <code>
        self.visited_ninf_flag
       </code>
       ：这是一个形状为
       <code>
        (batch_size, pomo_size, problem_size + 1)
       </code>
       的张量，记录每个智能体对每个节点的访问标志。
      </p>
     </li>
     <li>
      <p>
       <code>
        self.visited_ninf_flag[:, :, self.problem_size + 1]
       </code>
       ：表示对
       <code>
        visited_ninf_flag
       </code>
       张量的切片操作，选取所有批次、所有智能体，并指定第
       <code>
        problem_size + 1
       </code>
       个节点的位置。
      </p>
      <ul>
       <li>
        <code>
         self.problem_size + 1
        </code>
        指定的是配送中心。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <code>
        (~self.at_the_depot) &amp; (self.last_current_node != 0)
       </code>
       ：这部分是一个布尔索引，用来筛选符合特定条件的位置。
      </p>
      <ul>
       <li>
        <code>
         self.at_the_depot
        </code>
        是一个布尔张量，表示每个智能体是否在配送中心（
        <code>
         True
        </code>
        表示在配送中心，
        <code>
         False
        </code>
        表示不在）。
       </li>
       <li>
        <code>
         ~self.at_the_depot
        </code>
        对
        <code>
         self.at_the_depot
        </code>
        进行布尔取反，表示哪些智能体不在配送中心。
       </li>
       <li>
        <code>
         self.last_current_node != 0
        </code>
        判断哪些智能体在时间步 3 时没有选择
        <mark>
         配送中心（节点 0）
        </mark>
        。
       </li>
       <li>
        <code>
         (~self.at_the_depot) &amp; (self.last_current_node != 0)
        </code>
        综合起来表示，选择那些不在配送中心并且在时间步 3 时没有选择配送中心的智能体。
       </li>
      </ul>
     </li>
    </ul>
    <h3>
     <a id="14_95">
     </a>
     1.4更新
    </h3>
    <h4>
     <a id="141__97">
     </a>
     1.4.1 更新当前节点和已选择节点列表
    </h4>
    <pre><code class="prism language-python">            <span class="token comment">#更新当前节点和已选择节点列表</span>
            self<span class="token punctuation">.</span>current_node <span class="token operator">=</span> selected
            self<span class="token punctuation">.</span>selected_node_list <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>selected_node_list<span class="token punctuation">,</span> self<span class="token punctuation">.</span>current_node<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
</code></pre>
    <table>
     <thead>
      <tr>
       <th>
        参数
       </th>
       <th align="center">
        Shape
       </th>
       <th align="left">
        含义
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        self.current_node
       </td>
       <td align="center">
        (batch, pomo)
       </td>
       <td align="left">
       </td>
      </tr>
      <tr>
       <td>
        self.selected_node_list
       </td>
       <td align="center">
        (batch, pomo,0~)
       </td>
       <td align="left">
       </td>
      </tr>
     </tbody>
    </table>
    <p>
     <strong>
      注：
      <code>
       0~
      </code>
      表示第三维度逐渐增加
     </strong>
    </p>
    <p>
     <code>
      self.selected_node_list
     </code>
     的shape:
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/8efd0138756b49c7b9cbdbb5b0940f3c.png">
      <br/>
      <code>
       self.current_node
      </code>
      的shape:
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/4cda4b4a612a4e7ba2787e12fa63ead1.jpeg">
       <br/>
       <code>
        self.selected_node_list = torch.cat((self.selected_node_list, self.current_node[:, :, None]), dim=2)
       </code>
       ,表示先将
       <code>
        self.current_node
       </code>
       扩展为三维数据，再将
       <code>
        self.current_node
       </code>
       沿着
       <code>
        self.selected_node_list
       </code>
       的第三维度（
       <code>
        dim=2
       </code>
       ）进行依次剪切进去。
      </img>
     </img>
    </p>
    <h4>
     <a id="142__118">
     </a>
     1.4.2 更新需求和负载
    </h4>
    <pre><code class="prism language-python">            <span class="token comment">#更新需求和负载</span>
            demand_list <span class="token operator">=</span> self<span class="token punctuation">.</span>depot_node_demand<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>expand<span class="token punctuation">(</span>self<span class="token punctuation">.</span>batch_size<span class="token punctuation">,</span> self<span class="token punctuation">.</span>pomo_size<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
            gathering_index <span class="token operator">=</span> selected<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span>
            selected_demand <span class="token operator">=</span> demand_list<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> index<span class="token operator">=</span>gathering_index<span class="token punctuation">)</span><span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>load <span class="token operator">-=</span> selected_demand
            self<span class="token punctuation">.</span>load<span class="token punctuation">[</span>self<span class="token punctuation">.</span>at_the_depot<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>  <span class="token comment"># refill loaded at the depot</span>
</code></pre>
    <table>
     <thead>
      <tr>
       <th>
        参数
       </th>
       <th align="center">
        Shape
       </th>
       <th align="left">
        含义g
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        self.depot_node_demand
       </td>
       <td align="center">
        (batch, problem + 1)
       </td>
       <td align="left">
        表示每个批次中，每个问题（包括配送中心）对应的节点需求
       </td>
      </tr>
      <tr>
       <td>
        demand_list
       </td>
       <td align="center">
        (batch, pomo, problem + 1)
       </td>
       <td align="left">
        包含每个节点需求的张量
       </td>
      </tr>
      <tr>
       <td>
        selected
       </td>
       <td align="center">
        (batch, pomo)
       </td>
       <td align="left">
        表示每个批次中的每个智能体所选择的节点编号（这些节点是从节点集合中选择的）
       </td>
      </tr>
      <tr>
       <td>
        selected_demand
       </td>
       <td align="center">
        (batch, pomo)
       </td>
       <td align="left">
        示每个智能体所选择节点的需求。
       </td>
      </tr>
     </tbody>
    </table>
    <blockquote>
     <p>
      demand_list = self.depot_node_demand[:, None,:].expand(self.batch_size, self.pomo_size, -1)
     </p>
    </blockquote>
    <ul>
     <li>
      <code>
       [:, None, :]
      </code>
      ：先在
      <code>
       self.depot_node_demand
      </code>
      的第二维（即问题维度）上增加一个新的维度，使其变为
      <code>
       (batch_size, 1, problem_size + 1)
      </code>
      。
     </li>
     <li>
      <code>
       .expand(self.batch_size, self.pomo_size, -1)
      </code>
      ：将数据self.depot_node_demand扩展为
      <code>
       (batch_size, pomo_size, problem_size + 1)
      </code>
      ，表示每个批次中的每个 POMO 智能体都有一份相同的需求数据。
     </li>
    </ul>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/a069d22632754fca824e946b40feb5ea.png"/>
    </p>
    <blockquote>
     <p>
      gathering_index = selected[:, :, None]
     </p>
    </blockquote>
    <ul>
     <li>
      将
      <code>
       selected
      </code>
      进行维度扩展
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/5b2b1d4a3a724e02ae1f900acccc5a8d.png"/>
     </li>
    </ul>
    <hr/>
    <blockquote>
     <p>
      selected_demand = demand_list.gather(dim=2,index=gathering_index).squeeze(dim=2)
     </p>
    </blockquote>
    <ul>
     <li>
      <code>
       demand_list
      </code>
      的 shape 是
      <code>
       (batch_size, pomo_size, problem_size + 1)
      </code>
      ，包含了所有节点的需求数据。
     </li>
     <li>
      <code>
       gather(dim=2, index=gathering_index)
      </code>
      会按照
      <code>
       gathering_index
      </code>
      （即
      <code>
       selected
      </code>
      中存储的节点编号）从
      <code>
       demand_list
      </code>
      中选择出对应的节点需求。
      <code>
       dim=2
      </code>
      表示沿着第三维（即问题维度）进行选择。
     </li>
     <li>
      <code>
       gather
      </code>
      的结果是一个 shape 为
      <code>
       (batch_size, pomo_size, 1)
      </code>
      的张量。
     </li>
     <li>
      <code>
       .squeeze(dim=2)
      </code>
      去掉了多余的第三维，最终得到
      <code>
       selected_demand
      </code>
      ，其 shape 是
      <code>
       (batch_size, pomo_size)
      </code>
      ，表示每个智能体所选择节点的需求。
     </li>
    </ul>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/01c045d769b242fcb90c3f71c936bf10.png"/>
    </p>
    <h4>
     <a id="143__161">
     </a>
     1.4.3 更新访问标记
    </h4>
    <pre><code class="prism language-python">            <span class="token comment">#更新访问标记(防止重复选择已访问的节点)</span>
            self<span class="token punctuation">.</span>visited_ninf_flag<span class="token punctuation">[</span>self<span class="token punctuation">.</span>BATCH_IDX<span class="token punctuation">,</span> self<span class="token punctuation">.</span>POMO_IDX<span class="token punctuation">,</span> selected<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">'-inf'</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>visited_ninf_flag<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token operator">~</span>self<span class="token punctuation">.</span>at_the_depot<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>  <span class="token comment"># depot is considered unvisited, unless you are AT the depot</span>
</code></pre>
    <table>
     <thead>
      <tr>
       <th>
        参数
       </th>
       <th align="center">
        Shape
       </th>
       <th align="left">
        含义
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        self.visited_ninf_flag
       </td>
       <td align="center">
        (batch, pomo, problem+ 1)
       </td>
       <td align="left">
        记录了每 个智能体（POMO）在每个批次中已访问的节点的信息，标记某些节点是否已经被访问（用负无穷表示）。
       </td>
      </tr>
      <tr>
       <td>
        self.BATCH_IDX
       </td>
       <td align="center">
        (batch, pomo)
       </td>
       <td align="left">
        批次索引的张量
       </td>
      </tr>
      <tr>
       <td>
        self.POMO_IDX
       </td>
       <td align="center">
        (batch, pomo)
       </td>
       <td align="left">
        智能体（POMO）索引的张量
       </td>
      </tr>
      <tr>
       <td>
        selected
       </td>
       <td align="center">
        (batch, pomo)
       </td>
       <td align="left">
        表示每个批次中的每个智能体所选择的节点编号（这些节点是从节点集合中选择的）
       </td>
      </tr>
      <tr>
       <td>
        self.at_the_depot
       </td>
       <td align="center">
        (batch, pomo)
       </td>
       <td align="left">
        一个布尔型张量，表示每个智能体是否处于配送中心（即该智能体是否在节点 0，通常是配送中心）。
       </td>
      </tr>
     </tbody>
    </table>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/4fc977549e8f4c21961ce3556316c0e4.png"/>
    </p>
    <hr/>
    <blockquote>
     <p>
      self.visited_ninf_flag[self.BATCH_IDX, self.POMO_IDX, selected] =float(‘-inf’)
     </p>
    </blockquote>
    <p>
     <code>
      self.visited_ninf_flag[self.BATCH_IDX, self.POMO_IDX, selected]
     </code>
     表示从
     <code>
      visited_ninf_flag
     </code>
     张量中选择出对应批次和智能体的对应位置，并设置为
     <code>
      float('-inf')
     </code>
     ，表示这些节点已经被访问过。
    </p>
    <p>
     举例：
     <br/>
     假设我们有以下参数：
    </p>
    <ul>
     <li>
      batch_size = 2，即有 2 个批次。
     </li>
     <li>
      pomo_size = 3，即每个批次有 3 个智能体（POMO）。
     </li>
     <li>
      problem_size = 4，即有 4 个节点（包含配送中心）。
     </li>
    </ul>
    <pre><code class="prism language-python">self<span class="token punctuation">.</span>visited_ninf_flag <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">[</span><span class="token punctuation">[</span>  <span class="token number">0.</span><span class="token punctuation">,</span>   <span class="token number">0.</span><span class="token punctuation">,</span>   <span class="token number">0.</span><span class="token punctuation">,</span>   <span class="token number">0.</span><span class="token punctuation">,</span>   <span class="token number">0.</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># 第一个批次（batch 0）</span>
     <span class="token punctuation">[</span>  <span class="token number">0.</span><span class="token punctuation">,</span>   <span class="token number">0.</span><span class="token punctuation">,</span>   <span class="token number">0.</span><span class="token punctuation">,</span>   <span class="token number">0.</span><span class="token punctuation">,</span>   <span class="token number">0.</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># POMO 0, POMO 1, POMO 2 各自对节点的访问标志</span>
     <span class="token punctuation">[</span>  <span class="token number">0.</span><span class="token punctuation">,</span>   <span class="token number">0.</span><span class="token punctuation">,</span>   <span class="token number">0.</span><span class="token punctuation">,</span>   <span class="token number">0.</span><span class="token punctuation">,</span>   <span class="token number">0.</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    
    <span class="token punctuation">[</span><span class="token punctuation">[</span>  <span class="token number">0.</span><span class="token punctuation">,</span>   <span class="token number">0.</span><span class="token punctuation">,</span>   <span class="token number">0.</span><span class="token punctuation">,</span>   <span class="token number">0.</span><span class="token punctuation">,</span>   <span class="token number">0.</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># 第二个批次（batch 1）</span>
     <span class="token punctuation">[</span>  <span class="token number">0.</span><span class="token punctuation">,</span>   <span class="token number">0.</span><span class="token punctuation">,</span>   <span class="token number">0.</span><span class="token punctuation">,</span>   <span class="token number">0.</span><span class="token punctuation">,</span>   <span class="token number">0.</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
     <span class="token punctuation">[</span>  <span class="token number">0.</span><span class="token punctuation">,</span>   <span class="token number">0.</span><span class="token punctuation">,</span>   <span class="token number">0.</span><span class="token punctuation">,</span>   <span class="token number">0.</span><span class="token punctuation">,</span>   <span class="token number">0.</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
<span class="token punctuation">]</span>
</code></pre>
    <p>
     self.BATCH_IDX（批次索引）：
    </p>
    <pre><code class="prism language-python">self<span class="token punctuation">.</span>BATCH_IDX <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># 第一个批次</span>
    <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>   <span class="token comment"># 第二个批次</span>
<span class="token punctuation">]</span>
</code></pre>
    <p>
     self.POMO_IDX（POMO 索引）：
    </p>
    <pre><code class="prism language-python">self<span class="token punctuation">.</span>POMO_IDX <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># 每个批次中三个智能体的索引</span>
    <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>
<span class="token punctuation">]</span>
</code></pre>
    <p>
     selected（每个智能体选择的节点）：
    </p>
    <pre><code class="prism language-python">selected <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># 第一个批次中，智能体选择的节点：POMO 0 选择节点 1，POMO 1 选择节点 2，POMO 2 选择节点 0</span>
    <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>   <span class="token comment"># 第二个批次中，智能体选择的节点：POMO 0 选择节点 3，POMO 1 选择节点 1，POMO 2 选择节点 2</span>
<span class="token punctuation">]</span>
</code></pre>
    <p>
     执行这一行代码
     <code>
      self.visited_ninf_flag[self.BATCH_IDX, self.POMO_IDX, selected] = float('-inf')
     </code>
     。
     <br/>
     对于第一个批次（
     <code>
      BATCH_IDX[0]
     </code>
     ），我们有三个智能体（
     <code>
      POMO_IDX[0]
     </code>
     ），选择了节点
     <code>
      [1, 2, 0]
     </code>
     ，分别是：
    </p>
    <ul>
     <li>
      <code>
       selected[0][0] = 1
      </code>
      表示 POMO 0 选择了节点 1。
     </li>
     <li>
      <code>
       selected[0][1] = 2
      </code>
      表示 POMO 1 选择了节点 2。
     </li>
     <li>
      <code>
       selected[0][2] = 0
      </code>
      表示 POMO 2 选择了节点 0。
      <br/>
      对于第二个批次（
      <code>
       BATCH_IDX[1]
      </code>
      ），我们同样有三个智能体（
      <code>
       POMO_IDX[1]
      </code>
      ），选择了节点
      <code>
       [3, 1, 2]
      </code>
      ，分别是：
     </li>
     <li>
      <code>
       selected[1][0] = 3
      </code>
      表示 POMO 0 选择了节点 3。
     </li>
     <li>
      <code>
       selected[1][1] = 1
      </code>
      表示 POMO 1 选择了节点 1。
     </li>
     <li>
      <code>
       selected[1][2] = 2
      </code>
      表示 POMO 2 选择了节点 2。
     </li>
    </ul>
    <p>
     更新
     <code>
      visited_ninf_flag
     </code>
     ： 根据批次索引和 POMO 索引，我们更新了对应位置的值为负无穷
     <code>
      -inf
     </code>
     ：
    </p>
    <ul>
     <li>
      对于
      <code>
       BATCH_IDX[0]
      </code>
      和
      <code>
       POMO_IDX[0, 1, 2]
      </code>
      ，我们将
      <code>
       selected[0][0] = 1
      </code>
      ，
      <code>
       selected[0][1] = 2
      </code>
      ，
      <code>
       selected[0][2] = 0
      </code>
      位置标记为
      <code>
       -inf
      </code>
      。
     </li>
     <li>
      对于
      <code>
       BATCH_IDX[1]
      </code>
      和
      <code>
       POMO_IDX[0, 1, 2]
      </code>
      ，我们将
      <code>
       selected[1][0] = 3
      </code>
      ，
      <code>
       selected[1][1] = 1
      </code>
      ，
      <code>
       selected[1][2] = 2
      </code>
      位置标记为
      <code>
       -inf
      </code>
      。
     </li>
    </ul>
    <hr/>
    <blockquote>
     <p>
      self.visited_ninf_flag[:, :, 0][~self.at_the_depot] = 0
     </p>
    </blockquote>
    <p>
     <code>
      self.visited_ninf_flag[:, :, 0][~self.at_the_depot] = 0
     </code>
     ,我们将所有不在配送中心的智能体的配送中心访问标志设置为
     <code>
      0
     </code>
     。
     <br/>
     -
     <code>
      [:, :, 0]
     </code>
     是一个切片操作，表示我们提取张量中的第一个节点（通常是配送中心节点）。
    </p>
    <ul>
     <li>
      <code>
       ~self.at_the_depot
      </code>
      是对
      <code>
       self.at_the_depot
      </code>
      张量的布尔取反操作，将
      <code>
       True
      </code>
      变为
      <code>
       False
      </code>
      ，将
      <code>
       False
      </code>
      变为
      <code>
       True
      </code>
      。
     </li>
    </ul>
    <h4>
     <a id="144__250">
     </a>
     1.4.4 更新负无穷掩码
    </h4>
    <pre><code class="prism language-python">            <span class="token comment">#更新负无穷掩码(屏蔽需求量超过当前负载的节点)</span>
            self<span class="token punctuation">.</span>ninf_mask <span class="token operator">=</span> self<span class="token punctuation">.</span>visited_ninf_flag<span class="token punctuation">.</span>clone<span class="token punctuation">(</span><span class="token punctuation">)</span>
            round_error_epsilon <span class="token operator">=</span> <span class="token number">0.00001</span>
            demand_too_large <span class="token operator">=</span> self<span class="token punctuation">.</span>load<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">+</span> round_error_epsilon <span class="token operator">&lt;</span> demand_list
            _2<span class="token operator">=</span>torch<span class="token punctuation">.</span>full<span class="token punctuation">(</span><span class="token punctuation">(</span>demand_too_large<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>demand_too_large<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token boolean">False</span><span class="token punctuation">)</span>
            demand_too_large <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>demand_too_large<span class="token punctuation">,</span> _2<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>ninf_mask<span class="token punctuation">[</span>demand_too_large<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">'-inf'</span><span class="token punctuation">)</span>
</code></pre>
    <table>
     <thead>
      <tr>
       <th>
        参数
       </th>
       <th align="center">
        Shape
       </th>
       <th align="left">
        含义
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        self.visited_ninf_flag
       </td>
       <td align="center">
        (batch, pomo, problem+ 1)
       </td>
       <td align="left">
        记录了每 个智能体（POMO）在每个批次中已访问的节点的信息，标记某些节点是否已经被访问（用负无穷表示）。
       </td>
      </tr>
      <tr>
       <td>
        self.ninf_mask
       </td>
       <td align="center">
        (batch, pomo, problem+ 1)
       </td>
       <td align="left">
        self.visited_ninf_flag.clone()
       </td>
      </tr>
      <tr>
       <td>
        demand_too_large
       </td>
       <td align="center">
        (batch, pomo, problem + 1)
       </td>
       <td align="left">
        每个智能体负载与节点需求的比较结果
       </td>
      </tr>
      <tr>
       <td>
        _2
       </td>
       <td align="center">
        (batch, pomo, 1)
       </td>
       <td align="left">
        张量 _2 用于扩展 demand_too_large 张量的形状。
       </td>
      </tr>
     </tbody>
    </table>
    <blockquote>
     <p>
      self.ninf_mask = self.visited_ninf_flag.clone()
     </p>
    </blockquote>
    <p>
     复制
     <code>
      visited_ninf_flag
     </code>
     张量的内容，初始化
     <code>
      ninf_mask
     </code>
     。
     <code>
      self.visited_ninf_flag
     </code>
     是一个形状为
     <code>
      (batch_size, pomo_size, problem_size + 1)
     </code>
     的张量，记录了每个智能体对每个节点的访问状态。
    </p>
    <blockquote>
     <p>
      round_error_epsilon = 0.00001
      <br/>
      demand_too_large = self.load[:, :, None]+ round_error_epsilon &lt; demand_list
     </p>
    </blockquote>
    <p>
     定义一个小的数值误差
     <code>
      round_error_epsilon
     </code>
     ，用来避免浮点数运算时的小数误差。
    </p>
    <p>
     检查每个智能体的负载是否小于当前节点的需求量。
    </p>
    <ul>
     <li>
      <code>
       self.load[:, :, None]
      </code>
      的形状为
      <code>
       (batch_size, pomo_size, 1)
      </code>
      ，是
      <mark>
       每个批次中每个智能体的负载
      </mark>
      。通过
      <code>
       [:, :, None]
      </code>
      进行扩展，将其转换为三维张量，第三维用于后续与
      <code>
       demand_list
      </code>
      对比。
     </li>
     <li>
      <code>
       demand_list
      </code>
      是一个形状为
      <code>
       (batch_size, pomo_size, problem_size + 1)
      </code>
      的张量，表示每个智能体选择的节点的需求量。
     </li>
     <li>
      <code>
       round_error_epsilon
      </code>
      是用于避免计算中的浮动误差。
     </li>
     <li>
      <code>
       demand_too_large
      </code>
      是一个布尔张量，形状为
      <code>
       (batch_size, pomo_size, problem_size + 1)
      </code>
      ，其值为
      <code>
       True
      </code>
      表示该节点的需求量大于当前负载（包括误差修正），为
      <code>
       False
      </code>
      表示需求量不大于负载。
     </li>
    </ul>
    <p>
     <strong>
      注
     </strong>
     ：
     <code>
      demand_too_large
     </code>
     的形状继承于
     <code>
      demand_list
     </code>
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/22651a2965c140d2b102abf11838e917.jpeg"/>
    </p>
    <blockquote>
     <p>
      _2=torch.full((demand_too_large.shape[0],demand_too_large.shape[1],1),False)
      <br/>
      demand_too_large = torch.cat((demand_too_large, _2), dim=2)
     </p>
    </blockquote>
    <p>
     创建一个形状为
     <code>
      (batch_size, pomo_size, 1)
     </code>
     的张量
     <code>
      _2
     </code>
     ，其值为
     <code>
      False
     </code>
     。
    </p>
    <ul>
     <li>
      <code>
       torch.full()
      </code>
      创建一个所有元素都为
      <code>
       False
      </code>
      的张量，形状为
      <code>
       (batch_size, pomo_size, 1)
      </code>
      ，确保将其连接到
      <code>
       demand_too_large
      </code>
      上时，可以对其进行扩展。
     </li>
    </ul>
    <p>
     将
     <code>
      _2
     </code>
     连接到
     <code>
      demand_too_large
     </code>
     张量的最后一维。
    </p>
    <ul>
     <li>
      <code>
       demand_too_large
      </code>
      的形状为
      <code>
       (batch_size, pomo_size, problem_size + 1)
      </code>
      ，表示每个智能体负载与节点需求的比较结果。
     </li>
     <li>
      <code>
       _2
      </code>
      的形状为
      <code>
       (batch_size, pomo_size, 1)
      </code>
      ，用于将布尔值
      <code>
       False
      </code>
      填充到
      <code>
       demand_too_large
      </code>
      的最后一维。
     </li>
     <li>
      通过
      <code>
       torch.cat()
      </code>
      将
      <code>
       _2
      </code>
      拼接到
      <code>
       demand_too_large
      </code>
      后面，得到新的形状
      <code>
       (batch_size, pomo_size, problem_size + 2)
      </code>
      ，扩展了一个额外的维度。
     </li>
    </ul>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/e8b2527675fa413490689eb199de20d9.png"/>
    </p>
    <blockquote>
     <p>
      self.ninf_mask[demand_too_large] = float(‘-inf’)
     </p>
    </blockquote>
    <p>
     将
     <code>
      demand_too_large
     </code>
     为
     <code>
      True
     </code>
     的位置，更新
     <code>
      ninf_mask
     </code>
     为负无穷
     <code>
      -inf
     </code>
     ，表示这些节点的需求量超过当前负载。
    </p>
    <h4>
     <a id="145__selfstep_state_305">
     </a>
     1.4.5 更新步骤状态，将更新后的状态同步到 self.step_state
    </h4>
    <pre><code class="prism language-python">            <span class="token comment">#更新步骤状态，将更新后的状态同步到 self.step_state</span>
            self<span class="token punctuation">.</span>step_state<span class="token punctuation">.</span>selected_count <span class="token operator">=</span> self<span class="token punctuation">.</span>time_step
            self<span class="token punctuation">.</span>step_state<span class="token punctuation">.</span>load <span class="token operator">=</span> self<span class="token punctuation">.</span>load
            self<span class="token punctuation">.</span>step_state<span class="token punctuation">.</span>current_node <span class="token operator">=</span> self<span class="token punctuation">.</span>current_node
            self<span class="token punctuation">.</span>step_state<span class="token punctuation">.</span>ninf_mask <span class="token operator">=</span> self<span class="token punctuation">.</span>ninf_mask
</code></pre>
    <table>
     <thead>
      <tr>
       <th>
        参数
       </th>
       <th align="center">
        Shape
       </th>
       <th align="left">
        含义
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        self.time_step
       </td>
       <td align="center">
        一个整数
       </td>
       <td align="left">
        时间步数
       </td>
      </tr>
      <tr>
       <td>
        self.load
       </td>
       <td align="center">
        (batch, pomo)
       </td>
       <td align="left">
        每个批次所有POMO智能体的负载
       </td>
      </tr>
      <tr>
       <td>
        self.current_node
       </td>
       <td align="center">
        (batch, pomo)
       </td>
       <td align="left">
        每个批次所有POMO智能体选择的节点
       </td>
      </tr>
      <tr>
       <td>
        self.ninf_mask
       </td>
       <td align="center">
        (batch, pomo, problem+ 1)
       </td>
       <td align="left">
        记录了每 个智能体（POMO）在每个批次中已访问的节点的信息，标记某些节点是否已经被访问（用负无穷表示）。
       </td>
      </tr>
     </tbody>
    </table>
    <hr/>
    <h2>
     <a id="_4_322">
     </a>
     二、时间步大于等于 4
    </h2>
    <h3>
     <a id="21__action_classification_323">
     </a>
     2.1 动作模式分类 (action classification)：
    </h3>
    <pre><code class="prism language-python"><span class="token comment"># 动作模式分类</span>
action0_bool_index <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>mode <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>selected <span class="token operator">!=</span> self<span class="token punctuation">.</span>problem_size <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
action1_bool_index <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>mode <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>selected <span class="token operator">==</span> self<span class="token punctuation">.</span>problem_size <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># regret</span>
action2_bool_index <span class="token operator">=</span> self<span class="token punctuation">.</span>mode <span class="token operator">==</span> <span class="token number">1</span>
action3_bool_index <span class="token operator">=</span> self<span class="token punctuation">.</span>mode <span class="token operator">==</span> <span class="token number">2</span>
</code></pre>
    <table>
     <thead>
      <tr>
       <th>
        参数
       </th>
       <th align="center">
        Shape
       </th>
       <th align="left">
        含义
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        self.mode
       </td>
       <td align="center">
        (batch_size, pomo_size)
       </td>
       <td align="left">
        表示每个批次中每个智能体的当前状态模式（mode）。
       </td>
      </tr>
      <tr>
       <td>
        selected
       </td>
       <td align="center">
        (batch_size, pomo_size)
       </td>
       <td align="left">
        表示每个批次中每个智能体选择的节点编号。
       </td>
      </tr>
      <tr>
       <td>
        action0_bool_index
       </td>
       <td align="center">
        (batch_size, pomo_size)
       </td>
       <td align="left">
        表示哪些智能体当前处于模式 0 且选择的节点不是 self.problem_size + 1。
       </td>
      </tr>
      <tr>
       <td>
        action1_bool_index
       </td>
       <td align="center">
        (batch_size, pomo_size)
       </td>
       <td align="left">
        表示哪些智能体当前处于模式 0 且选择了 self.problem_size + 1（即“后悔”模式）。
       </td>
      </tr>
      <tr>
       <td>
        action2_bool_index
       </td>
       <td align="center">
        (batch_size, pomo_size)
       </td>
       <td align="left">
        表示哪些智能体当前处于模式 1。
       </td>
      </tr>
      <tr>
       <td>
        action3_bool_index
       </td>
       <td align="center">
        (batch_size, pomo_size)
       </td>
       <td align="left">
        表示哪些智能体当前处于模式 2。
       </td>
      </tr>
     </tbody>
    </table>
    <blockquote>
     <p>
      action0_bool_index = ((self.mode == 0) &amp; (selected != self.problem_size + 1))
     </p>
    </blockquote>
    <ul>
     <li>
      <code>
       selected
      </code>
      是一个形状为
      <code>
       (batch_size, pomo_size)
      </code>
      的张量，表示每个批次中每个智能体选择的节点编号。
      <ul>
       <li>
        <code>
         selected != self.problem_size + 1
        </code>
        会生成一个布尔张量，表示哪些智能体没有选择
        <code>
         self.problem_size + 1
        </code>
        这个特殊的节点（假设
        <code>
         self.problem_size + 1
        </code>
        是表示一个特定的节点，如“后悔”节点）。
       </li>
      </ul>
     </li>
    </ul>
    <h3>
     <a id="22__345">
     </a>
     2.2 动作索引与选择计数更新：
    </h3>
    <pre><code class="prism language-python">action1_index <span class="token operator">=</span> torch<span class="token punctuation">.</span>nonzero<span class="token punctuation">(</span>action1_bool_index<span class="token punctuation">)</span>
action2_index <span class="token operator">=</span> torch<span class="token punctuation">.</span>nonzero<span class="token punctuation">(</span>action2_bool_index<span class="token punctuation">)</span>

action4_index <span class="token operator">=</span> torch<span class="token punctuation">.</span>nonzero<span class="token punctuation">(</span><span class="token punctuation">(</span>action3_bool_index <span class="token operator">&amp;</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>current_node <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 更新选择计数</span>
self<span class="token punctuation">.</span>selected_count <span class="token operator">=</span> self<span class="token punctuation">.</span>selected_count <span class="token operator">+</span> <span class="token number">1</span>
<span class="token comment"># 后悔模式</span>
self<span class="token punctuation">.</span>selected_count<span class="token punctuation">[</span>action1_bool_index<span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>selected_count<span class="token punctuation">[</span>action1_bool_index<span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">2</span>
</code></pre>
    <table>
     <thead>
      <tr>
       <th>
        参数
       </th>
       <th align="center">
        Shape
       </th>
       <th align="left">
        含义
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        action1_bool_index
       </td>
       <td align="center">
        <code>
         (N, 2)
        </code>
        ，其中
        <code>
         N
        </code>
        是符合条件的元素个数，
        <code>
         2
        </code>
        表示
        <code>
         [batch_idx, pomo_idx]
        </code>
        两个维度
       </td>
       <td align="left">
        所有满足“后悔模式”条件的智能体的批次和智能体索引
       </td>
      </tr>
      <tr>
       <td>
        action1_bool_index
       </td>
       <td align="center">
        (batch_size, pomo_size)
       </td>
       <td align="left">
        表示每个批次、每个智能体是否符合 action1 条件
       </td>
      </tr>
      <tr>
       <td>
        action2_index
       </td>
       <td align="center">
        <code>
         (N, 2)
        </code>
        ，其中
        <code>
         N
        </code>
        是符合条件的元素个数，
        <code>
         2
        </code>
        表示
        <code>
         [batch_idx, pomo_idx]
        </code>
        两个维度
       </td>
       <td align="left">
        所有处于模式 1 的智能体的批次和智能体索引
       </td>
      </tr>
      <tr>
       <td>
        action2_bool_index
       </td>
       <td align="center">
        (batch_size, pomo_size)
       </td>
       <td align="left">
        表示每个批次、每个智能体是否符合 action2 条件
       </td>
      </tr>
      <tr>
       <td>
        action4_index
       </td>
       <td align="center">
        <code>
         (N, 2)
        </code>
        ，其中
        <code>
         N
        </code>
        是符合条件的元素个数，
        <code>
         2
        </code>
        表示
        <code>
         [batch_idx, pomo_idx]
        </code>
        两个维度
       </td>
       <td align="left">
        所有处于模式 2 且当前节点不为配送中心的智能体的批次和智能体索引
       </td>
      </tr>
      <tr>
       <td>
        action3_bool_index
       </td>
       <td align="center">
        (batch_size, pomo_size)
       </td>
       <td align="left">
        表示每个批次、每个智能体是否符合 action3 条件
       </td>
      </tr>
      <tr>
       <td>
        self.selected_count
       </td>
       <td align="center">
        (batch_size, pomo_size)
       </td>
       <td align="left">
        表示每个批次、每个智能体选择的节点数量。
       </td>
      </tr>
     </tbody>
    </table>
    <blockquote>
     <p>
      action1_index = torch.nonzero(action1_bool_index)
     </p>
    </blockquote>
    <p>
     这行代码通过
     <code>
      torch.nonzero
     </code>
     获取所有满足
     <code>
      action1_bool_index
     </code>
     条件的位置索引，表示那些处于模式 0 且选择了
     <code>
      self.problem_size + 1
     </code>
     （可能是“后悔模式”）的智能体。
    </p>
    <ul>
     <li>
      <code>
       torch.nonzero(action1_bool_index)
      </code>
      会返回一个张量，包含所有为
      <code>
       True
      </code>
      的位置的索引。返回的索引张量的形状为
      <code>
       (N, 2)
      </code>
      ，其中
      <code>
       N
      </code>
      是
      <code>
       True
      </code>
      的数量，第一列是批次索引，第二列是智能体索引。
     </li>
    </ul>
    <blockquote>
     <p>
      action4_index = torch.nonzero((action3_bool_index &amp; (self.current_node != 0)))
     </p>
    </blockquote>
    <ul>
     <li>
      <code>
       action3_bool_index
      </code>
      是一个布尔张量，形状为
      <code>
       (batch_size, pomo_size)
      </code>
      ，表示每个批次、每个智能体是否符合
      <code>
       action3
      </code>
      条件（即处于模式 2）。
     </li>
     <li>
      <code>
       self.current_node != 0
      </code>
      生成一个布尔张量，表示当前选择的节点不为配送中心（节点编号 0）。
     </li>
    </ul>
    <blockquote>
     <p>
      self.selected_count[action1_bool_index] = self.selected_count[action1_bool_index] - 2
     </p>
    </blockquote>
    <p>
     这行代码针对处于后悔模式
     <code>
      （action1_bool_index）
     </code>
     的智能体，将它们的选择计数减去 2。
    </p>
    <ul>
     <li>
      <code>
       action1_bool_index
      </code>
      是一个形状为
      <code>
       (batch_size, pomo_size)
      </code>
      的布尔张量，表示哪些智能体处于后悔模式。
     </li>
     <li>
      <code>
       self.selected_count[action1_bool_index]
      </code>
      会提取所有处于后悔模式的智能体的选择计数。
     </li>
     <li>
      将这些智能体的选择计数减去 2，表示它们在当前步骤的选择无效，可能需要补偿或调整。
     </li>
    </ul>
    <h3>
     <a id="23__385">
     </a>
     2.3 节点更新：
    </h3>
    <pre><code class="prism language-python"><span class="token comment"># 节点更新</span>
self<span class="token punctuation">.</span>last_is_depot <span class="token operator">=</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>last_current_node <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>

_ <span class="token operator">=</span> self<span class="token punctuation">.</span>last_current_node<span class="token punctuation">[</span>action1_index<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> action1_index<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>clone<span class="token punctuation">(</span><span class="token punctuation">)</span>
temp_last_current_node_action2 <span class="token operator">=</span> self<span class="token punctuation">.</span>last_current_node<span class="token punctuation">[</span>action2_index<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> action2_index<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>clone<span class="token punctuation">(</span><span class="token punctuation">)</span>
self<span class="token punctuation">.</span>last_current_node <span class="token operator">=</span> self<span class="token punctuation">.</span>current_node<span class="token punctuation">.</span>clone<span class="token punctuation">(</span><span class="token punctuation">)</span>
self<span class="token punctuation">.</span>current_node <span class="token operator">=</span> selected<span class="token punctuation">.</span>clone<span class="token punctuation">(</span><span class="token punctuation">)</span>
self<span class="token punctuation">.</span>current_node<span class="token punctuation">[</span>action1_index<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> action1_index<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> _<span class="token punctuation">.</span>clone<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 更新已选择节点列表</span>
self<span class="token punctuation">.</span>selected_node_list <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>selected_node_list<span class="token punctuation">,</span> selected<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
</code></pre>
    <table>
     <thead>
      <tr>
       <th>
        参数
       </th>
       <th align="center">
        Shape
       </th>
       <th align="left">
        含义
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        self.last_current_node
       </td>
       <td align="center">
        (batch_size, pomo_size)
       </td>
       <td align="left">
        表示每个批次中每个智能体在上一个时间步选择的节点。
       </td>
      </tr>
      <tr>
       <td>
        self.last_is_depot
       </td>
       <td align="center">
        (batch_size, pomo_size)
       </td>
       <td align="left">
        表示每个智能体是否选择了节点 0（配送中心）。
       </td>
      </tr>
      <tr>
       <td>
        action1_index
       </td>
       <td align="center">
        (N, 2)
       </td>
       <td align="left">
        表示处于“后悔模式”（mode == 0 且选择了特殊节点 self.problem_size + 1）的智能体的索引。
       </td>
      </tr>
      <tr>
       <td>
        _
       </td>
       <td align="center">
        <code>
         (N,)
        </code>
        ，其中
        <code>
         N
        </code>
        是处于“后悔模式”下的智能体数量
       </td>
       <td align="left">
        每个位置的值是上一个时间步智能体选择的节点编号。
       </td>
      </tr>
      <tr>
       <td>
        temp_last_current_node_action2
       </td>
       <td align="center">
        <code>
         (N,)
        </code>
        ，其中
        <code>
         N
        </code>
        是处于模式 1 下的智能体数量
       </td>
       <td align="left">
        每个位置的值是上一个时间步智能体选择的节点编号。是一个
        <strong>
         一维向量
        </strong>
        ，其具体元素的个数是
        <strong>
         不定
        </strong>
        的，取决于符合 动作 2 条件的智能体数量。
       </td>
      </tr>
      <tr>
       <td>
        selected
       </td>
       <td align="center">
        (batch_size, pomo_size)
       </td>
       <td align="left">
        表示当前时间步每个智能体选择的节点。
       </td>
      </tr>
      <tr>
       <td>
        self.current_node
       </td>
       <td align="center">
        (batch_size, pomo_size)
       </td>
       <td align="left">
        表示当前时间步每个智能体选择的节点。
       </td>
      </tr>
      <tr>
       <td>
        self.selected_node_list
       </td>
       <td align="center">
        (batch_size, pomo_size, num_selected_nodes)
       </td>
       <td align="left">
        表示每个批次中每个智能体已经选择的节点列表。
       </td>
      </tr>
     </tbody>
    </table>
    <blockquote>
     <p>
      _ = self.last_current_node[action1_index[:, 0], action1_index[:, 1]].clone()
     </p>
    </blockquote>
    <ul>
     <li>
      <code>
       self.last_current_node[action1_index[:, 0], action1_index[:, 1]]
      </code>
      提取了那些处于“后悔模式”下的智能体在上一个时间步选择的节点。
     </li>
     <li>
      <code>
       _
      </code>
      的形状是
      <code>
       (N,)
      </code>
      ，其中
      <code>
       N
      </code>
      是处于“后悔模式”下的智能体数量。每个位置的值是上一个时间步智能体选择的节点编号。
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/d5099075484f4ab1a2eb49e864962027.png"/>
     </li>
    </ul>
    <blockquote>
     <p>
      temp_last_current_node_action2 = self.last_current_node[action2_index[:, 0], action2_index[:, 1]].clone()
     </p>
    </blockquote>
    <ul>
     <li>
      <code>
       self.last_current_node[action2_index[:, 0], action2_index[:, 1]]
      </code>
      提取了那些处于模式 1 下的智能体在上一个时间步选择的节点。
     </li>
    </ul>
    <blockquote>
     <p>
      self.current_node = selected.clone()
      <br/>
      self.current_node[action1_index[:, 0], action1_index[:, 1]] = _.clone()
     </p>
    </blockquote>
    <ul>
     <li>
      <code>
       self.current_node[action1_index[:, 0], action1_index[:, 1]]
      </code>
      获取这些智能体在当前时间步的节点位置。
     </li>
     <li>
      <code>
       _.clone()
      </code>
      将之前保存的智能体在上一个时间步选择的节点（即
      <code>
       _
      </code>
      ）赋值给这些智能体在当前时间步的节点。
     </li>
    </ul>
    <blockquote>
     <p>
      self.selected_node_list = torch.cat((self.selected_node_list, selected[:, :, None]), dim=2)
     </p>
    </blockquote>
    <ul>
     <li>
      更新
      <code>
       self.selected_node_list
      </code>
      ，将当前时间步的节点选择添加到已选择的节点列表中。
     </li>
     <li>
      <code>
       torch.cat((self.selected_node_list, selected[:, :, None]), dim=2)
      </code>
      将当前时间步选择的节点添加到
      <code>
       self.selected_node_list
      </code>
      中，使得
      <code>
       selected_node_list
      </code>
      更新为包含当前时间步节点的列表。
     </li>
    </ul>
    <h4>
     <a id="231_430">
     </a>
     2.3.1节点更新(后悔操作)
    </h4>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/a56a4b3b3a124f65a51a15fba4d6be5a.png"/>
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/ea37c4a331ac437f8b5d6136c889c69a.png"/>
     <br/>
     上图是
     <strong>
      后悔模式
     </strong>
     的节点更新的示意图，需要注意代码中三个变量在传递信息中的顺序问题。具体代码如下：
    </p>
    <blockquote>
     <p>
      _ = self.last_current_node[action1_index[:, 0], action1_index[:, 1]].clone()
      <br/>
      self.last_current_node = self.current_node.clone()
      <br/>
      self.current_node = selected.clone()
      <br/>
      self.current_node[action1_index[:, 0], action1_index[:, 1]] = _.clone()
     </p>
    </blockquote>
    <p>
     <code>
      self.last_current_node
     </code>
     ，
     <code>
      self.current_node
     </code>
     ，
     <code>
      selected
     </code>
     三者是信息传递关系。
     <code>
      selected
     </code>
     是最新的信息
     <code>
      self.current_node
     </code>
     次之
     <code>
      self.last_current_node
     </code>
     最后。
     <br/>
     若为
     <strong>
      后悔操作的节点更新
     </strong>
     则
     <code>
      self.current_node
     </code>
     为
     <code>
      self.current_node[action1_index[:, 0], action1_index[:, 1]] = _.clone()
     </code>
     ，若为
     <strong>
      正常节点更新
     </strong>
     则
     <code>
      self.current_node
     </code>
     为
     <code>
      selected.clone()
     </code>
     。
    </p>
    <hr/>
    <h3>
     <a id="24__444">
     </a>
     2.4 负载更新：
    </h3>
    <pre><code class="prism language-python"><span class="token comment"># 更新负载</span>
self<span class="token punctuation">.</span>at_the_depot <span class="token operator">=</span> <span class="token punctuation">(</span>selected <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
demand_list <span class="token operator">=</span> self<span class="token punctuation">.</span>depot_node_demand<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>expand<span class="token punctuation">(</span>self<span class="token punctuation">.</span>batch_size<span class="token punctuation">,</span> self<span class="token punctuation">.</span>pomo_size<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
_3 <span class="token operator">=</span> torch<span class="token punctuation">.</span>full<span class="token punctuation">(</span><span class="token punctuation">(</span>demand_list<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> demand_list<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
demand_list <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>demand_list<span class="token punctuation">,</span> _3<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
gathering_index <span class="token operator">=</span> selected<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span>
selected_demand <span class="token operator">=</span> demand_list<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> index<span class="token operator">=</span>gathering_index<span class="token punctuation">)</span><span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
_1 <span class="token operator">=</span> self<span class="token punctuation">.</span>last_load<span class="token punctuation">[</span>action1_index<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> action1_index<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>clone<span class="token punctuation">(</span><span class="token punctuation">)</span>
self<span class="token punctuation">.</span>last_load <span class="token operator">=</span> self<span class="token punctuation">.</span>load<span class="token punctuation">.</span>clone<span class="token punctuation">(</span><span class="token punctuation">)</span>
self<span class="token punctuation">.</span>load <span class="token operator">-=</span> selected_demand
self<span class="token punctuation">.</span>load<span class="token punctuation">[</span>action1_index<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> action1_index<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> _1<span class="token punctuation">.</span>clone<span class="token punctuation">(</span><span class="token punctuation">)</span>
self<span class="token punctuation">.</span>load<span class="token punctuation">[</span>self<span class="token punctuation">.</span>at_the_depot<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>  <span class="token comment"># refill loaded at the depot</span>
</code></pre>
    <table>
     <thead>
      <tr>
       <th>
        参数
       </th>
       <th align="center">
        Shape
       </th>
       <th align="left">
        含义
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        self.at_the_depot
       </td>
       <td align="center">
        (batch, pomo)
       </td>
       <td align="left">
        标记每个智能体是否在配送中心。
       </td>
      </tr>
      <tr>
       <td>
        depot_node_demand
       </td>
       <td align="center">
        (batch, problem + 1)
       </td>
       <td align="left">
        表示每个节点的需求，包括配送中心。
       </td>
      </tr>
      <tr>
       <td>
        demand_list
       </td>
       <td align="center">
        (batch, pomo_size, problem+1)
       </td>
       <td align="left">
        每个智能体所对应的所有节点的需求。
       </td>
      </tr>
      <tr>
       <td>
        selected
       </td>
       <td align="center">
        (batch, pomo)
       </td>
       <td align="left">
        表示当前批次和 POMO（多智能体）中选择的节点。
       </td>
      </tr>
      <tr>
       <td>
        _3
       </td>
       <td align="center">
        (batch, pomo_size, 1)
       </td>
       <td align="left">
        一个临时张量，用于后续扩展 demand_list。
       </td>
      </tr>
      <tr>
       <td>
        gathering_index
       </td>
       <td align="center">
        (batch, pomo_size, 1)
       </td>
       <td align="left">
        用于指定要从 demand_list 中收集哪些需求。
       </td>
      </tr>
      <tr>
       <td>
        selected_demand
       </td>
       <td align="center">
        (batch, pomo_size)
       </td>
       <td align="left">
        表示每个智能体选择的节点的需求。
       </td>
      </tr>
      <tr>
       <td>
        action1_index
       </td>
       <td align="center">
        (N, 2)
       </td>
       <td align="left">
        表示处于“后悔模式”（mode == 0 且选择了特殊节点 self.problem_size + 1）的智能体的索引。
       </td>
      </tr>
      <tr>
       <td>
        self.load
       </td>
       <td align="center">
        (batch, pomo_size)
       </td>
       <td align="left">
        每个智能体（POMO agent）当前的负载状态。
       </td>
      </tr>
      <tr>
       <td>
        self.last_load
       </td>
       <td align="center">
        (batch, pomo)
       </td>
       <td align="left">
        存储上一次决策时，每个智能体的载重情况。
       </td>
      </tr>
     </tbody>
    </table>
    <blockquote>
     <p>
      self.at_the_depot = (selected == 0)
     </p>
    </blockquote>
    <ul>
     <li>
      该行代码根据
      <code>
       selected
      </code>
      来判断是否选择了配送中心。
      <ul>
       <li>
        如果选择的节点是配送中心（节点编号为 0），则
        <code>
         self.at_the_depot
        </code>
        为
        <code>
         True
        </code>
        ，否则为
        <code>
         False
        </code>
        。
       </li>
      </ul>
     </li>
    </ul>
    <blockquote>
     <p>
      demand_list = self.depot_node_demand[:, None, :].expand(self.batch_size, self.pomo_size, -1)
     </p>
    </blockquote>
    <ul>
     <li>
      这行代码扩展了
      <code>
       self.depot_node_demand
      </code>
      ，使其能够适应批量和多个智能体的需求。
      <ul>
       <li>
        <code>
         self.depot_node_demand[:, None, :]
        </code>
        将
        <code>
         self.depot_node_demand
        </code>
        的维度从
        <code>
         (batch, problem+1)
        </code>
        扩展到
        <code>
         (batch, 1, problem+1)
        </code>
        ，在第二维上添加一个新维度。
       </li>
       <li>
        <code>
         .expand(self.batch_size, self.pomo_size, -1)
        </code>
        将该 tensor 扩展到
        <code>
         (batch, pomo_size, problem+1)
        </code>
        ，复制需求数据，使每个智能体都能访问这些数据。
        <ul>
         <li>
          <code>
           -1
          </code>
          在
          <code>
           expand()
          </code>
          方法中的作用是 保持该维度的大小不变，让 PyTorch 自动推导最后一个维度的大小。
         </li>
        </ul>
       </li>
      </ul>
     </li>
    </ul>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/a069d22632754fca824e946b40feb5ea.png"/>
    </p>
    <blockquote>
     <p>
      _3 = torch.full((demand_list.shape[0], demand_list.shape[1], 1), 0)
     </p>
    </blockquote>
    <ul>
     <li>
      创建一个全为
      <code>
       0
      </code>
      的张量
      <code>
       _3
      </code>
      ，它的形状与
      <code>
       demand_list
      </code>
      相同，但在最后一维有一个额外的维度。
     </li>
    </ul>
    <blockquote>
     <p>
      demand_list = torch.cat((demand_list, _3), dim=2)
     </p>
    </blockquote>
    <ul>
     <li>
      这行代码将
      <code>
       _3
      </code>
      张量连接到
      <code>
       demand_list
      </code>
      的最后一维（
      <code>
       dim=2
      </code>
      ）。
      <ul>
       <li>
        <code>
         demand_list
        </code>
        的原始形状是
        <code>
         (batch, pomo_size, problem+1)
        </code>
        ，它表示每个智能体的需求。
       </li>
       <li>
        <code>
         _3
        </code>
        的形状是
        <code>
         (batch, pomo_size, 1)
        </code>
        ，它会被附加到
        <code>
         demand_list
        </code>
        的最后一维，使其形状变为
        <code>
         (batch, pomo_size, problem+2)
        </code>
        。
       </li>
      </ul>
     </li>
    </ul>
    <blockquote>
     <p>
      gathering_index = selected[:, :, None]
     </p>
    </blockquote>
    <ul>
     <li>
      <code>
       gathering_index
      </code>
      用于指定要从
      <code>
       demand_list
      </code>
      中收集哪些需求。
      <ul>
       <li>
        <code>
         selected
        </code>
        的形状为
        <code>
         (batch, pomo_size)
        </code>
        ，表示每个智能体选择的节点。
       </li>
       <li>
        <code>
         [:, :, None]
        </code>
        会将
        <code>
         selected
        </code>
        的形状从
        <code>
         (batch, pomo_size)
        </code>
        转换为
        <code>
         (batch, pomo_size, 1)
        </code>
        ，增加一个新的维度，使其可以用作
        <code>
         gather
        </code>
        的索引。
       </li>
      </ul>
     </li>
    </ul>
    <blockquote>
     <p>
      selected_demand = demand_list.gather(dim=2, index=gathering_index).squeeze(dim=2)
     </p>
    </blockquote>
    <ul>
     <li>
      该行代码根据
      <code>
       gathering_index
      </code>
      从
      <code>
       demand_list
      </code>
      中提取所选节点的需求，并移除不必要的维度。
      <ul>
       <li>
        <code>
         demand_list.gather(dim=2, index=gathering_index)
        </code>
        会根据
        <code>
         gathering_index
        </code>
        提取每个智能体选择节点的需求。
        <code>
         dim=2
        </code>
        表示从最后一维（需求）中选取。
       </li>
       <li>
        <code>
         .squeeze(dim=2)
        </code>
        去除 gather 后产生的单一维度，使
        <code>
         selected_demand
        </code>
        的形状从
        <code>
         (batch, pomo_size, 1)
        </code>
        转变为
        <code>
         (batch, pomo_size)
        </code>
        。
       </li>
      </ul>
     </li>
    </ul>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/12adb3c35fb148f48148e99e654b63a4.png"/>
    </p>
    <blockquote>
     <p>
      _1 = self.last_load[action1_index[:, 0], action1_index[:, 1]].clone()
      <br/>
      self.last_load = self.load.clone()
      <br/>
      self.load -= selected_demand
     </p>
    </blockquote>
    <ul>
     <li>
      该段代码先将
      <code>
       _1
      </code>
      更新为之前的
      <code>
       self.last_load
      </code>
      ，在此之后
      <code>
       self.last_load
      </code>
      已更新为当前的
      <code>
       self.load
      </code>
      <ul>
       <li>
        将
        <code>
         self.last_load
        </code>
        中，指定位置的负载克隆到
        <code>
         _1
        </code>
        。
        <ul>
         <li>
          <code>
           action1_index
          </code>
          是一个包含批次和 POMO 索引的 tensor。
         </li>
         <li>
          <code>
           self.last_load
          </code>
          是一个形状为
          <code>
           (batch, pomo_size)
          </code>
          的 tensor，表示每个智能体的负载。
         </li>
         <li>
          <code>
           action1_index
          </code>
          提供了批次和智能体的索引，所以通过这些索引来获取
          <code>
           self.last_load
          </code>
          中的值。
         </li>
        </ul>
       </li>
       <li>
        将当前负载
        <code>
         self.load
        </code>
        的值克隆到
        <code>
         self.last_load
        </code>
        中，以便后续使用。
       </li>
       <li>
        根据
        <code>
         selected_demand
        </code>
        更新负载。
        <ul>
         <li>
          <code>
           selected_demand
          </code>
          是每个智能体选择的节点需求，形状为
          <code>
           (batch, pomo_size)
          </code>
          。
         </li>
        </ul>
       </li>
      </ul>
     </li>
    </ul>
    <blockquote>
     <p>
      self.load[action1_index[:, 0], action1_index[:, 1]] = _1.clone()
     </p>
    </blockquote>
    <ul>
     <li>
      这行代码将
      <code>
       action1_index
      </code>
      索引位置的负载值恢复为
      <code>
       _1
      </code>
      （即之前的负载值）。
      <ul>
       <li>
        <code>
         action1_index
        </code>
        是一个 tensor，表示在某些情况下需要恢复负载的智能体的索引。
       </li>
       <li>
        通过该索引，
        <mark>
         将
         <code>
          self.load
         </code>
         中的负载恢复为之前保存的
         <code>
          _1
         </code>
        </mark>
        。
       </li>
      </ul>
     </li>
    </ul>
    <blockquote>
     <p>
      self.load[self.at_the_depot] = 1
     </p>
    </blockquote>
    <ul>
     <li>
      这行代码将位于配送中心的智能体的负载设置为 1，表示它们已被重新加载。
      <ul>
       <li>
        <code>
         self.at_the_depot
        </code>
        是一个形状为
        <code>
         (batch, pomo_size)
        </code>
        的布尔值 tensor，表示哪些智能体在配送中心。
       </li>
       <li>
        <code>
         self.load[self.at_the_depot] = 1
        </code>
        将这些智能体的负载恢复为
        <code>
         1
        </code>
        ，表示它们重新装载。
       </li>
      </ul>
     </li>
    </ul>
    <hr/>
    <h4>
     <a id="241__537">
     </a>
     2.4.1 后悔操作的负载信息传递：
    </h4>
    <blockquote>
     <p>
      selected_demand = demand_list.gather(dim=2, index=gathering_index).squeeze(dim=2)
      <br/>
      _1 = self.last_load[action1_index[:, 0], action1_index[:, 1]].clone()
      <br/>
      self.last_load= self.load.clone() # shape: (batch, pomo)
      <br/>
      self.load -= selected_demand
      <br/>
      self.load[action1_index[:, 0], action1_index[:, 1]] = _1.clone()
     </p>
    </blockquote>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/1631d62ac5664ef39a386b1c84d2beda.png"/>
     <br/>
     若是后悔操作则
     <code>
      self.load
     </code>
     为
     <code>
      _1.clone()
     </code>
     ，若为正常负载信息更新则为数据
     <code>
      self.load -= selected_demand
     </code>
     。
    </p>
    <hr/>
    <h3>
     <a id="25__548">
     </a>
     2.5 访问标记更新：
    </h3>
    <pre><code class="prism language-python"><span class="token comment"># 更新访问标记</span>
self<span class="token punctuation">.</span>visited_ninf_flag<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>problem_size <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>self<span class="token punctuation">.</span>last_is_depot<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>
self<span class="token punctuation">.</span>visited_ninf_flag<span class="token punctuation">[</span>self<span class="token punctuation">.</span>BATCH_IDX<span class="token punctuation">,</span> self<span class="token punctuation">.</span>POMO_IDX<span class="token punctuation">,</span> selected<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">'-inf'</span><span class="token punctuation">)</span>
self<span class="token punctuation">.</span>visited_ninf_flag<span class="token punctuation">[</span>action2_index<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> action2_index<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> temp_last_current_node_action2<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
self<span class="token punctuation">.</span>visited_ninf_flag<span class="token punctuation">[</span>action4_index<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> action4_index<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>problem_size <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
self<span class="token punctuation">.</span>visited_ninf_flag<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>problem_size <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>self<span class="token punctuation">.</span>at_the_depot<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">'-inf'</span><span class="token punctuation">)</span>
self<span class="token punctuation">.</span>visited_ninf_flag<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token operator">~</span>self<span class="token punctuation">.</span>at_the_depot<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>
</code></pre>
    <table>
     <thead>
      <tr>
       <th>
        参数
       </th>
       <th align="center">
        Shape
       </th>
       <th align="left">
        含义
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        self.visited_ninf_flag
       </td>
       <td align="center">
        (batch, pomo_size, problem+2)
       </td>
       <td align="left">
        用于存储每个节点的访问状态。
       </td>
      </tr>
      <tr>
       <td>
        self.last_is_depot
       </td>
       <td align="center">
        (batch, pomo_size)
       </td>
       <td align="left">
        表示上一步的节点是否是配送中心（True 表示在配送中心，False 表示不在）。
       </td>
      </tr>
      <tr>
       <td>
        self.BATCH_IDX
       </td>
       <td align="center">
        (batch, pomo_size)
       </td>
       <td align="left">
        批次的索引。
       </td>
      </tr>
      <tr>
       <td>
        self.POMO_IDX
       </td>
       <td align="center">
        (batch, pomo_size)
       </td>
       <td align="left">
        POMO智能体的索引。
       </td>
      </tr>
      <tr>
       <td>
        selected
       </td>
       <td align="center">
        (batch, pomo_size)
       </td>
       <td align="left">
        表示当前每个智能体选择的节点编号。
       </td>
      </tr>
      <tr>
       <td>
        action2_index
       </td>
       <td align="center">
        (N, 2)
       </td>
       <td align="left">
        其中
        <code>
         N
        </code>
        是符合
        <code>
         mode=1
        </code>
        条件的智能体数量，每一行
        <code>
         (batch_idx, pomo_idx)
        </code>
        指定了具体的智能体索引。
       </td>
      </tr>
      <tr>
       <td>
        temp_last_current_node_action2
       </td>
       <td align="center">
        (N,)
       </td>
       <td align="left">
        表示
        <code>
         action2_index
        </code>
        对应的智能体在上一步访问的节点编号。是一个
        <strong>
         一维向量
        </strong>
        ，其具体元素的个数是
        <strong>
         不定
        </strong>
        的，取决于符合 动作 2 条件的智能体数量。
       </td>
      </tr>
      <tr>
       <td>
        action4_index
       </td>
       <td align="center">
        (M, 2)
       </td>
       <td align="left">
        其中
        <code>
         M
        </code>
        是满足
        <code>
         mode=2
        </code>
        （表示特定的选择模式）并且
        <code>
         current_node ≠ 0
        </code>
        的智能体数量，每一行
        <code>
         (batch_idx, pomo_idx)
        </code>
        指定了具体的智能体索引。
       </td>
      </tr>
      <tr>
       <td>
        self.at_the_depot
       </td>
       <td align="center">
        (batch, pomo_size)
       </td>
       <td align="left">
        表示哪些智能体位于配送中心。
       </td>
      </tr>
     </tbody>
    </table>
    <blockquote>
     <p>
      self.visited_ninf_flag[:, :, self.problem_size + 1][self.last_is_depot] = 0
     </p>
    </blockquote>
    <ul>
     <li>
      重置
      <code>
       self.problem_size + 1
      </code>
      位置的
      <code>
       visited_ninf_flag
      </code>
      ，以允许节点（
      <code>
       problem_size+1
      </code>
      ）重新被访问。
      <ul>
       <li>
        将
        <code>
         self.visited_ninf_flag
        </code>
        的
        <strong>
         倒数第二个索引
        </strong>
        <code>
         self.problem_size + 1
        </code>
        位置的值设为
        <code>
         0
        </code>
        ，但仅限于
        <strong>
         上一步在配送中心的智能体
        </strong>
        <code>
         （self.last_is_depot）
        </code>
        。
       </li>
       <li>
        <code>
         self.problem_size + 1
        </code>
        这个索引通常用于表示一个特殊状态（例如 “后悔” 或 “未选择” 状态）。
       </li>
      </ul>
     </li>
    </ul>
    <blockquote>
     <p>
      self.visited_ninf_flag[self.BATCH_IDX, self.POMO_IDX, selected] = float(‘-inf’)
     </p>
    </blockquote>
    <ul>
     <li>
      将
      <strong>
       当前选择的节点
      </strong>
      的访问标记设为
      <code>
       -inf
      </code>
      ，表示这些节点已经被访问，防止它们被重复选择。
     </li>
    </ul>
    <blockquote>
     <p>
      self.visited_ninf_flag[action2_index[:, 0], action2_index[:, 1], temp_last_current_node_action2] = float(0)
     </p>
    </blockquote>
    <ul>
     <li>
      <strong>
       恢复某些节点的访问权限
      </strong>
      ，即：对于
      <code>
       mode=1
      </code>
      （表示后悔操作）的智能体，重新允许访问它们
      <strong>
       上次的节点
      </strong>
      。
      <ul>
       <li>
        <code>
         action2_index
        </code>
        的形状是
        <code>
         (N, 2)
        </code>
        ，其中
        <code>
         N
        </code>
        是符合
        <code>
         mode=1
        </code>
        条件的智能体数量，每一行
        <code>
         (batch_idx, pomo_idx)
        </code>
        指定了具体的智能体索引。
       </li>
       <li>
        <code>
         temp_last_current_node_action2
        </code>
        的形状是
        <code>
         (N,)
        </code>
        ，表示
        <code>
         action2_index
        </code>
        对应的智能体在上一步访问的节点编号。是一个
        <strong>
         一维向量
        </strong>
        ，其具体元素的个数是
        <strong>
         不定
        </strong>
        的，取决于符合 动作 2 条件的智能体数量。
       </li>
       <li>
        <code>
         self.visited_ninf_flag
        </code>
        的形状是
        <code>
         (batch, pomo_size, problem+2)
        </code>
        。
       </li>
      </ul>
     </li>
    </ul>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/ed40d3a5e625452498d33cba3cad9536.png"/>
    </p>
    <blockquote>
     <p>
      self.visited_ninf_flag[action4_index[:, 0], action4_index[:, 1], self.problem_size + 1] = float(0)
     </p>
    </blockquote>
    <ul>
     <li>
      针对
      <code>
       action3_bool_index &amp; (self.current_node != 0)
      </code>
      的情况，重新启用
      <code>
       self.problem_size + 1
      </code>
      位置的访问权限。
      <ul>
       <li>
        <code>
         action4_index
        </code>
        的形状是
        <code>
         (M, 2)
        </code>
        ，其中
        <code>
         M
        </code>
        是满足
        <code>
         mode=2
        </code>
        （表示特定的选择模式）并且
        <code>
         current_node ≠ 0
        </code>
        的智能体数量，每一行
        <code>
         (batch_idx, pomo_idx)
        </code>
        指定了具体的智能体索引。
       </li>
       <li>
        <code>
         self.problem_size + 1
        </code>
        表示
        <strong>
         后悔操作
        </strong>
        。
       </li>
      </ul>
     </li>
    </ul>
    <blockquote>
     <p>
      self.visited_ninf_flag[:, :, self.problem_size + 1][self.at_the_depot] = float(‘-inf’)
     </p>
    </blockquote>
    <ul>
     <li>
      在配送中心的智能体，不允许选择
      <code>
       problem_size + 1
      </code>
      这个特殊状态。
      <ul>
       <li>
        <code>
         self.problem_size + 1
        </code>
        表示
        <strong>
         后悔操作
        </strong>
        。
       </li>
       <li>
        <code>
         self.visited_ninf_flag[:, :, self.problem_size + 1]
        </code>
        选取
        <code>
         visited_ninf_flag
        </code>
        的
        <code>
         problem_size + 1
        </code>
        位置，得到形状
        <code>
         (batch, pomo_size)
        </code>
        。
       </li>
       <li>
        <code>
         [self.at_the_depot]
        </code>
        选择所有位于配送中心的智能体，并把它们的
        <code>
         problem_size+1
        </code>
        位置设置为
        <code>
         -inf
        </code>
        ，防止它们选择这个状态。
       </li>
      </ul>
     </li>
    </ul>
    <blockquote>
     <p>
      self.visited_ninf_flag[:, :, 0][~self.at_the_depot] = 0
     </p>
    </blockquote>
    <ul>
     <li>
      如果不在配送中心，则允许访问配送中心（节点 0）。
      <ul>
       <li>
        <code>
         self.visited_ninf_flag[:, :, 0]
        </code>
        选取
        <code>
         visited_ninf_flag
        </code>
        的第 0 个索引（即配送中心的访问状态），形状为
        <code>
         (batch, pomo_size)
        </code>
        。
       </li>
       <li>
        <code>
         [~self.at_the_depot]
        </code>
        选取所有不在配送中心的智能体，并将它们的
        <code>
         visited_ninf_flag
        </code>
        设为
        <code>
         0
        </code>
        ，允许它们
        <strong>
         重新访问配送中心
        </strong>
        。
       </li>
      </ul>
     </li>
    </ul>
    <h3>
     <a id="26__607">
     </a>
     2.6 负无穷掩码更新：
    </h3>
    <pre><code class="prism language-python"><span class="token comment"># 更新负无穷掩码</span>
self<span class="token punctuation">.</span>ninf_mask <span class="token operator">=</span> self<span class="token punctuation">.</span>visited_ninf_flag<span class="token punctuation">.</span>clone<span class="token punctuation">(</span><span class="token punctuation">)</span>
round_error_epsilon <span class="token operator">=</span> <span class="token number">0.00001</span>
demand_too_large <span class="token operator">=</span> self<span class="token punctuation">.</span>load<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">+</span> round_error_epsilon <span class="token operator">&lt;</span> demand_list
self<span class="token punctuation">.</span>ninf_mask<span class="token punctuation">[</span>demand_too_large<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">'-inf'</span><span class="token punctuation">)</span>
</code></pre>
    <table>
     <thead>
      <tr>
       <th>
        参数
       </th>
       <th align="center">
        Shape
       </th>
       <th align="left">
        含义
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        self.ninf_mask
       </td>
       <td align="center">
        (batch, pomo_size, problem+2)
       </td>
       <td align="left">
        visited_ninf_flag 包含已访问节点的屏蔽信息和需求超过当前负载的节点的屏蔽信息。
       </td>
      </tr>
      <tr>
       <td>
        self.visited_ninf_flag
       </td>
       <td align="center">
        (batch, pomo_size, problem+2)
       </td>
       <td align="left">
        存储每个智能体对每个节点的访问状态。
       </td>
      </tr>
      <tr>
       <td>
        demand_too_large
       </td>
       <td align="center">
        (batch, pomo_size, problem+2)
       </td>
       <td align="left">
        标记哪些节点的需求大于当前负载。
       </td>
      </tr>
      <tr>
       <td>
        demand_list
       </td>
       <td align="center">
        (batch, pomo_size, problem+2)
       </td>
       <td align="left">
        表示每个智能体对每个节点的需求。
       </td>
      </tr>
      <tr>
       <td>
        self.load
       </td>
       <td align="center">
        (batch, pomo_size)
       </td>
       <td align="left">
        表示当前每个智能体的负载。
       </td>
      </tr>
     </tbody>
    </table>
    <blockquote>
     <p>
      self.ninf_mask = self.visited_ninf_flag.clone()
     </p>
    </blockquote>
    <ul>
     <li>
      <code>
       self.visited_ninf_flag
      </code>
      的形状是
      <code>
       (batch, pomo_size, problem+2)
      </code>
      ，用于存储每个智能体对每个节点的访问状态。
     </li>
    </ul>
    <blockquote>
     <p>
      round_error_epsilon = 0.00001
      <br/>
      demand_too_large = self.load[:, :, None] + round_error_epsilon &lt; demand_list
     </p>
    </blockquote>
    <ul>
     <li>
      定义一个极小的正数
      <code>
       round_error_epsilon
      </code>
      ，用于浮点数计算中的舍入误差处理。避免 load 与 demand_list 直接比较时因为精度问题导致错误。
     </li>
     <li>
      计算一个布尔掩码
      <code>
       demand_too_large
      </code>
      ，标记哪些节点的需求大于当前负载，这些节点应该被屏蔽。
      <ul>
       <li>
        <code>
         self.load[:, :, None]
        </code>
        通过 None扩展维度，这样就可以与
        <code>
         demand_list
        </code>
        进行逐元素比较。
       </li>
       <li>
        <code>
         demand_list.shape == (batch, pomo_size, problem+2)
        </code>
        ，表示每个智能体对每个节点的需求。
       </li>
       <li>
        生成
        <code>
         demand_too_large
        </code>
        ，形状为
        <code>
         (batch, pomo_size, problem+2)
        </code>
        ：
        <ul>
         <li>
          <code>
           True
          </code>
          表示该节点的需求大于当前负载（不能被选择）。
         </li>
         <li>
          <code>
           False
          </code>
          表示该节点的需求在当前负载允许范围内。
         </li>
        </ul>
       </li>
      </ul>
     </li>
    </ul>
    <blockquote>
     <p>
      self.ninf_mask[demand_too_large] = float(‘-inf’)
     </p>
    </blockquote>
    <p>
     <strong>
      屏蔽负载不足的节点
     </strong>
     ，确保它们不会被智能体选择。
    </p>
    <ul>
     <li>
      <code>
       self.ninf_mask[demand_too_large] = float('-inf')
      </code>
      <ul>
       <li>
        找到
        <code>
         demand_too_large
        </code>
        为
        <code>
         True
        </code>
        的位置（即负载不足的节点）。
       </li>
       <li>
        在
        <code>
         self.ninf_mask
        </code>
        中，将这些位置的值设为
        <code>
         -inf
        </code>
        ，防止它们被选中。
       </li>
      </ul>
     </li>
    </ul>
    <h3>
     <a id="27__645">
     </a>
     2.7 完成状态更新：
    </h3>
    <pre><code class="prism language-python"><span class="token comment"># 更新完成状态</span>
newly_finished <span class="token operator">=</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>visited_ninf_flag <span class="token operator">==</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">'-inf'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span>self<span class="token punctuation">.</span>problem_size<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
self<span class="token punctuation">.</span>finished <span class="token operator">=</span> self<span class="token punctuation">.</span>finished <span class="token operator">+</span> newly_finished
</code></pre>
    <table>
     <thead>
      <tr>
       <th>
        参数
       </th>
       <th align="center">
        Shape
       </th>
       <th align="left">
        含义
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        newly_finished
       </td>
       <td align="center">
        (batch, pomo_size)
       </td>
       <td align="left">
        标记哪些智能体已经访问了所有节点，即它们的路径已经完成。
       </td>
      </tr>
      <tr>
       <td>
        self.visited_ninf_flag
       </td>
       <td align="center">
        (batch, pomo_size, problem+2)
       </td>
       <td align="left">
        记录每个智能体对各个节点的访问状态 (-inf 代表已访问)
       </td>
      </tr>
      <tr>
       <td>
        self.finished
       </td>
       <td align="center">
        (batch, pomo_size)
       </td>
       <td align="left">
        表示智能体是否完成任务
       </td>
      </tr>
     </tbody>
    </table>
    <blockquote>
     <p>
      newly_finished = (self.visited_ninf_flag == float(‘-inf’))[:,:,:self.problem_size+1].all(dim=2)
     </p>
    </blockquote>
    <p>
     计算一个布尔掩码
     <code>
      newly_finished
     </code>
     ，标记哪些智能体已经访问了所有节点，即它们的路径已经完成。
    </p>
    <ul>
     <li>
      <code>
       newly_finished
      </code>
      形状为
      <code>
       (batch, pomo_size)
      </code>
      ，其中：
      <ul>
       <li>
        <code>
         True
        </code>
        表示该智能体已经访问了所有任务点，旅行完成。
        <br/>
        -
        <code>
         False
        </code>
        表示该智能体仍有未访问的节点。
       </li>
      </ul>
     </li>
    </ul>
    <p>
     <strong>
      逻辑
     </strong>
    </p>
    <ul>
     <li>
      <code>
       self.visited_ninf_flag == float('-inf')
      </code>
      <ul>
       <li>
        生成一个布尔张量，表示每个节点是否已访问：
        <ul>
         <li>
          <code>
           True
          </code>
          （已访问）
         </li>
         <li>
          <code>
           False
          </code>
          （未访问）
         </li>
        </ul>
       </li>
      </ul>
     </li>
     <li>
      <code>
       [:, :, :self.problem_size+1]
      </code>
      <ul>
       <li>
        仅保留任务节点部分，不包括
        <code>
         problem+2
        </code>
        的特殊状态。
       </li>
       <li>
        形状变为
        <code>
         (batch, pomo_size, problem+1)
        </code>
        。
       </li>
      </ul>
     </li>
     <li>
      <code>
       .all(dim=2)
      </code>
      <ul>
       <li>
        在
        <code>
         dim=2
        </code>
        （节点维度）上执行 all()：
        <ul>
         <li>
          若智能体已访问所有
          <code>
           problem+1
          </code>
          个节点，则返回
          <code>
           True
          </code>
          。
         </li>
         <li>
          若有未访问的节点，则返回
          <code>
           False
          </code>
          。
         </li>
        </ul>
       </li>
       <li>
        形状变为
        <code>
         (batch, pomo_size)
        </code>
        ，每个智能体对应一个布尔值。
       </li>
      </ul>
     </li>
    </ul>
    <blockquote>
     <p>
      self.finished = self.finished + newly_finished
     </p>
    </blockquote>
    <p>
     更新
     <code>
      self.finished
     </code>
     ，标记哪些智能体已经完成任务。
    </p>
    <h3>
     <a id="28__682">
     </a>
     2.8 模式更新与掩码调整：
    </h3>
    <pre><code class="prism language-python"><span class="token comment"># 更新模式</span>
self<span class="token punctuation">.</span>mode<span class="token punctuation">[</span>action1_bool_index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>
self<span class="token punctuation">.</span>mode<span class="token punctuation">[</span>action2_bool_index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2</span>
self<span class="token punctuation">.</span>mode<span class="token punctuation">[</span>action3_bool_index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>
self<span class="token punctuation">.</span>mode<span class="token punctuation">[</span>self<span class="token punctuation">.</span>finished<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">4</span>

<span class="token comment"># 更新完成后的掩码调整</span>
self<span class="token punctuation">.</span>ninf_mask<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span>self<span class="token punctuation">.</span>finished<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>
self<span class="token punctuation">.</span>ninf_mask<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>problem_size <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>self<span class="token punctuation">.</span>finished<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">'-inf'</span><span class="token punctuation">)</span>
</code></pre>
    <table>
     <thead>
      <tr>
       <th>
        参数
       </th>
       <th align="center">
        Shape
       </th>
       <th align="left">
        含义
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        self.mode
       </td>
       <td align="center">
        (batch, pomo_size)
       </td>
       <td align="left">
        智能体的行为模式
       </td>
      </tr>
      <tr>
       <td>
        action1_bool_index
       </td>
       <td align="center">
        (batch, pomo_size)
       </td>
       <td align="left">
        选中的智能体执行模式 1
       </td>
      </tr>
      <tr>
       <td>
        action2_bool_index
       </td>
       <td align="center">
        (batch, pomo_size)
       </td>
       <td align="left">
        选中的智能体执行模式 2
       </td>
      </tr>
      <tr>
       <td>
        action3_bool_index
       </td>
       <td align="center">
        (batch, pomo_size)
       </td>
       <td align="left">
        选中的智能体执行模式 0
       </td>
      </tr>
      <tr>
       <td>
        self.finished
       </td>
       <td align="center">
        (batch, pomo_size)
       </td>
       <td align="left">
        选中的智能体进入模式 4
       </td>
      </tr>
      <tr>
       <td>
        self.ninf_mask
       </td>
       <td align="center">
        (batch, pomo_size, problem+2)
       </td>
       <td align="left">
        用于屏蔽不可选择的节点
       </td>
      </tr>
     </tbody>
    </table>
    <blockquote>
     <p>
      self.mode[action1_bool_index] = 1
      <br/>
      self.mode[action2_bool_index] = 2
      <br/>
      self.mode[action3_bool_index] = 0
      <br/>
      self.mode[self.finished] = 4
     </p>
    </blockquote>
    <ul>
     <li>
      更新
      <code>
       self.mode
      </code>
      ，决定智能体在下一步的行为模式。
     </li>
     <li>
      <code>
       self.mode
      </code>
      形状为
      <code>
       (batch, pomo_size)
      </code>
      ，每个智能体都有自己的模式。
     </li>
     <li>
      模式的作用：
      <ul>
       <li>
        <code>
         0
        </code>
        ：正常选择下一步节点
       </li>
       <li>
        <code>
         1
        </code>
        ：执行“后悔”操作（回溯上一步）
       </li>
       <li>
        <code>
         2
        </code>
        ：某种特殊选择状态（如重新选择）
       </li>
       <li>
        <code>
         4
        </code>
        ：表示智能体已完成任务，不再进行选择
       </li>
      </ul>
     </li>
    </ul>
    <blockquote>
     <p>
      self.ninf_mask[:, :, 0][self.finished] = 0
      <br/>
      self.ninf_mask[:, :, self.problem_size + 1][self.finished] = float(‘-inf’)
     </p>
    </blockquote>
    <ul>
     <li>
      调整
      <code>
       self.ninf_mask
      </code>
      ，确保已完成任务的智能体不会继续选择新节点。
     </li>
     <li>
      <code>
       self.ninf_mask
      </code>
      用于屏蔽不可选择的节点，形状为
      <code>
       (batch, pomo_size, problem+2)
      </code>
      ：
      <ul>
       <li>
        <code>
         -inf
        </code>
        ：表示该节点不能被选择。
       </li>
       <li>
        <code>
         0
        </code>
        ：表示该节点可以被选择。
       </li>
      </ul>
     </li>
    </ul>
    <p>
     <strong>
      逻辑
     </strong>
    </p>
    <ul>
     <li>
      <code>
       self.ninf_mask[:, :, 0][self.finished] = 0
      </code>
      <ul>
       <li>
        允许已完成的智能体访问配送中心（节点 0）。
       </li>
       <li>
        <code>
         self.finished
        </code>
        为
        <code>
         True
        </code>
        的智能体，其
        <code>
         ninf_mask
        </code>
        对应的 0 号索引会被设为
        <code>
         0
        </code>
        ，表示它们可以回到配送中心。
       </li>
      </ul>
     </li>
     <li>
      <code>
       self.ninf_mask[:, :, self.problem_size + 1][self.finished] = float('-inf')
      </code>
      <ul>
       <li>
        禁止已完成的智能体选择
        <code>
         problem_size+1
        </code>
        （特殊状态）。
       </li>
       <li>
        <code>
         self.finished
        </code>
        为
        <code>
         True
        </code>
        的智能体，其
        <code>
         ninf_mask
        </code>
        对应的
        <code>
         problem_size+1
        </code>
        号索引会被设为
        <code>
         -inf
        </code>
        ，表示它们不能选择该状态。
       </li>
      </ul>
     </li>
    </ul>
    <h3>
     <a id="29__732">
     </a>
     2.9 步骤状态更新：
    </h3>
    <pre><code class="prism language-python"><span class="token comment"># 更新步骤状态</span>
self<span class="token punctuation">.</span>step_state<span class="token punctuation">.</span>selected_count <span class="token operator">=</span> self<span class="token punctuation">.</span>time_step
self<span class="token punctuation">.</span>step_state<span class="token punctuation">.</span>load <span class="token operator">=</span> self<span class="token punctuation">.</span>load
self<span class="token punctuation">.</span>step_state<span class="token punctuation">.</span>current_node <span class="token operator">=</span> self<span class="token punctuation">.</span>current_node
self<span class="token punctuation">.</span>step_state<span class="token punctuation">.</span>ninf_mask <span class="token operator">=</span> self<span class="token punctuation">.</span>ninf_mask
</code></pre>
    <table>
     <thead>
      <tr>
       <th>
        参数
       </th>
       <th align="center">
        Shape
       </th>
       <th align="left">
        含义
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        self.time_step
       </td>
       <td align="center">
        标量（int）
       </td>
       <td align="left">
        记录当前时间步（迭代次数）
       </td>
      </tr>
      <tr>
       <td>
        self.step_state.selected_count
       </td>
       <td align="center">
        标量（int）
       </td>
       <td align="left">
        记录当前的时间步数
       </td>
      </tr>
      <tr>
       <td>
        self.load
       </td>
       <td align="center">
        (batch, pomo_size)
       </td>
       <td align="left">
        当前智能体的负载
       </td>
      </tr>
      <tr>
       <td>
        self.step_state.load
       </td>
       <td align="center">
        (batch, pomo_size)
       </td>
       <td align="left">
        存储当前负载状态
       </td>
      </tr>
      <tr>
       <td>
        self.current_node
       </td>
       <td align="center">
        (batch, pomo_size)
       </td>
       <td align="left">
        记录当前每个智能体所处的节点
       </td>
      </tr>
      <tr>
       <td>
        self.step_state.current_node
       </td>
       <td align="center">
        (batch, pomo_size)
       </td>
       <td align="left">
        存储当前智能体的位置信息
       </td>
      </tr>
      <tr>
       <td>
        self.ninf_mask
       </td>
       <td align="center">
        (batch, pomo_size, problem+2)
       </td>
       <td align="left">
        记录哪些节点不能被选择
       </td>
      </tr>
      <tr>
       <td>
        self.step_state.ninf_mask
       </td>
       <td align="center">
        (batch, pomo_size, problem+2)
       </td>
       <td align="left">
        存储当前的掩码信息
       </td>
      </tr>
     </tbody>
    </table>
    <hr/>
    <h2>
     <a id="_755">
     </a>
     附录
    </h2>
    <p>
     <strong>
      代码：
     </strong>
    </p>
    <pre><code class="prism language-python">    <span class="token keyword">def</span> <span class="token function">step</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> selected<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># selected.shape: (batch, pomo)</span>

        <span class="token comment">#时间步数控制</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>time_step<span class="token operator">&lt;</span><span class="token number">4</span><span class="token punctuation">:</span>

            <span class="token comment"># 控制时间步的递增</span>
            self<span class="token punctuation">.</span>time_step<span class="token operator">=</span>self<span class="token punctuation">.</span>time_step<span class="token operator">+</span><span class="token number">1</span>
            self<span class="token punctuation">.</span>selectex_count <span class="token operator">=</span> self<span class="token punctuation">.</span>selected_count<span class="token operator">+</span><span class="token number">1</span>

            <span class="token comment">#判断是否在配送中心</span>
            self<span class="token punctuation">.</span>at_the_depot <span class="token operator">=</span> <span class="token punctuation">(</span>selected <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>

            <span class="token comment">#特定时间步的操作</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>time_step<span class="token operator">==</span><span class="token number">3</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>last_current_node <span class="token operator">=</span> self<span class="token punctuation">.</span>current_node<span class="token punctuation">.</span>clone<span class="token punctuation">(</span><span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>last_load <span class="token operator">=</span> self<span class="token punctuation">.</span>load<span class="token punctuation">.</span>clone<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>time_step <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>last_current_node <span class="token operator">=</span> self<span class="token punctuation">.</span>current_node<span class="token punctuation">.</span>clone<span class="token punctuation">(</span><span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>last_load <span class="token operator">=</span> self<span class="token punctuation">.</span>load<span class="token punctuation">.</span>clone<span class="token punctuation">(</span><span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>visited_ninf_flag<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>problem_size<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token operator">~</span>self<span class="token punctuation">.</span>at_the_depot<span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>last_current_node<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>
            
            <span class="token comment">#更新当前节点和已选择节点列表</span>
            self<span class="token punctuation">.</span>current_node <span class="token operator">=</span> selected
            self<span class="token punctuation">.</span>selected_node_list <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>selected_node_list<span class="token punctuation">,</span> self<span class="token punctuation">.</span>current_node<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>

            <span class="token comment">#更新需求和负载</span>
            demand_list <span class="token operator">=</span> self<span class="token punctuation">.</span>depot_node_demand<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>expand<span class="token punctuation">(</span>self<span class="token punctuation">.</span>batch_size<span class="token punctuation">,</span> self<span class="token punctuation">.</span>pomo_size<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
            gathering_index <span class="token operator">=</span> selected<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span>
            selected_demand <span class="token operator">=</span> demand_list<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> index<span class="token operator">=</span>gathering_index<span class="token punctuation">)</span><span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>load <span class="token operator">-=</span> selected_demand
            self<span class="token punctuation">.</span>load<span class="token punctuation">[</span>self<span class="token punctuation">.</span>at_the_depot<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>  <span class="token comment"># refill loaded at the depot</span>

            <span class="token comment">#更新访问标记(防止重复选择已访问的节点)</span>
            self<span class="token punctuation">.</span>visited_ninf_flag<span class="token punctuation">[</span>self<span class="token punctuation">.</span>BATCH_IDX<span class="token punctuation">,</span> self<span class="token punctuation">.</span>POMO_IDX<span class="token punctuation">,</span> selected<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">'-inf'</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>visited_ninf_flag<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token operator">~</span>self<span class="token punctuation">.</span>at_the_depot<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>  <span class="token comment"># depot is considered unvisited, unless you are AT the depot</span>

            <span class="token comment">#更新负无穷掩码(屏蔽需求量超过当前负载的节点)</span>
            self<span class="token punctuation">.</span>ninf_mask <span class="token operator">=</span> self<span class="token punctuation">.</span>visited_ninf_flag<span class="token punctuation">.</span>clone<span class="token punctuation">(</span><span class="token punctuation">)</span>
            round_error_epsilon <span class="token operator">=</span> <span class="token number">0.00001</span>
            demand_too_large <span class="token operator">=</span> self<span class="token punctuation">.</span>load<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">+</span> round_error_epsilon <span class="token operator">&lt;</span> demand_list
            _2<span class="token operator">=</span>torch<span class="token punctuation">.</span>full<span class="token punctuation">(</span><span class="token punctuation">(</span>demand_too_large<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>demand_too_large<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token boolean">False</span><span class="token punctuation">)</span>
            demand_too_large <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>demand_too_large<span class="token punctuation">,</span> _2<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>ninf_mask<span class="token punctuation">[</span>demand_too_large<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">'-inf'</span><span class="token punctuation">)</span>

            <span class="token comment">#更新步骤状态，将更新后的状态同步到 self.step_state</span>
            self<span class="token punctuation">.</span>step_state<span class="token punctuation">.</span>selected_count <span class="token operator">=</span> self<span class="token punctuation">.</span>time_step
            self<span class="token punctuation">.</span>step_state<span class="token punctuation">.</span>load <span class="token operator">=</span> self<span class="token punctuation">.</span>load
            self<span class="token punctuation">.</span>step_state<span class="token punctuation">.</span>current_node <span class="token operator">=</span> self<span class="token punctuation">.</span>current_node
            self<span class="token punctuation">.</span>step_state<span class="token punctuation">.</span>ninf_mask <span class="token operator">=</span> self<span class="token punctuation">.</span>ninf_mask


        <span class="token comment">#时间步大于等于 4 的复杂操作</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token comment">#动作模式分类</span>
            action0_bool_index <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>mode <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>selected <span class="token operator">!=</span> self<span class="token punctuation">.</span>problem_size <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            action1_bool_index <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>mode <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>selected <span class="token operator">==</span> self<span class="token punctuation">.</span>problem_size <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># regret</span>
            action2_bool_index <span class="token operator">=</span> self<span class="token punctuation">.</span>mode <span class="token operator">==</span> <span class="token number">1</span>
            action3_bool_index <span class="token operator">=</span> self<span class="token punctuation">.</span>mode <span class="token operator">==</span> <span class="token number">2</span>
            
            action1_index <span class="token operator">=</span> torch<span class="token punctuation">.</span>nonzero<span class="token punctuation">(</span>action1_bool_index<span class="token punctuation">)</span>
            action2_index <span class="token operator">=</span> torch<span class="token punctuation">.</span>nonzero<span class="token punctuation">(</span>action2_bool_index<span class="token punctuation">)</span>

            action4_index <span class="token operator">=</span> torch<span class="token punctuation">.</span>nonzero<span class="token punctuation">(</span><span class="token punctuation">(</span>action3_bool_index <span class="token operator">&amp;</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>current_node <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

            <span class="token comment">#更新选择计数</span>
            self<span class="token punctuation">.</span>selected_count <span class="token operator">=</span> self<span class="token punctuation">.</span>selected_count<span class="token operator">+</span><span class="token number">1</span>
            <span class="token comment">#后悔模式</span>
            self<span class="token punctuation">.</span>selected_count<span class="token punctuation">[</span>action1_bool_index<span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>selected_count<span class="token punctuation">[</span>action1_bool_index<span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">2</span>

            <span class="token comment">#节点更新</span>
            self<span class="token punctuation">.</span>last_is_depot <span class="token operator">=</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>last_current_node <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>

            _ <span class="token operator">=</span> self<span class="token punctuation">.</span>last_current_node<span class="token punctuation">[</span>action1_index<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> action1_index<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>clone<span class="token punctuation">(</span><span class="token punctuation">)</span>
            temp_last_current_node_action2 <span class="token operator">=</span> self<span class="token punctuation">.</span>last_current_node<span class="token punctuation">[</span>action2_index<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> action2_index<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>clone<span class="token punctuation">(</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>last_current_node <span class="token operator">=</span> self<span class="token punctuation">.</span>current_node<span class="token punctuation">.</span>clone<span class="token punctuation">(</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>current_node <span class="token operator">=</span> selected<span class="token punctuation">.</span>clone<span class="token punctuation">(</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>current_node<span class="token punctuation">[</span>action1_index<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> action1_index<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> _<span class="token punctuation">.</span>clone<span class="token punctuation">(</span><span class="token punctuation">)</span>

            <span class="token comment">#更新已选择节点列表</span>
            self<span class="token punctuation">.</span>selected_node_list <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>selected_node_list<span class="token punctuation">,</span> selected<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>

            <span class="token comment">#更新负载</span>
            self<span class="token punctuation">.</span>at_the_depot <span class="token operator">=</span> <span class="token punctuation">(</span>selected <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            demand_list <span class="token operator">=</span> self<span class="token punctuation">.</span>depot_node_demand<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>expand<span class="token punctuation">(</span>self<span class="token punctuation">.</span>batch_size<span class="token punctuation">,</span> self<span class="token punctuation">.</span>pomo_size<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token comment"># shape: (batch, pomo, problem+1)</span>
            _3 <span class="token operator">=</span> torch<span class="token punctuation">.</span>full<span class="token punctuation">(</span><span class="token punctuation">(</span>demand_list<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> demand_list<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token comment">#扩展需求列表 demand_list </span>
            demand_list <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>demand_list<span class="token punctuation">,</span> _3<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
            gathering_index <span class="token operator">=</span> selected<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span>
            <span class="token comment"># shape: (batch, pomo, 1)</span>
            selected_demand <span class="token operator">=</span> demand_list<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> index<span class="token operator">=</span>gathering_index<span class="token punctuation">)</span><span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
            _1 <span class="token operator">=</span> self<span class="token punctuation">.</span>last_load<span class="token punctuation">[</span>action1_index<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> action1_index<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>clone<span class="token punctuation">(</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>last_load<span class="token operator">=</span> self<span class="token punctuation">.</span>load<span class="token punctuation">.</span>clone<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment"># shape: (batch, pomo)</span>
            self<span class="token punctuation">.</span>load <span class="token operator">-=</span> selected_demand
            self<span class="token punctuation">.</span>load<span class="token punctuation">[</span>action1_index<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> action1_index<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> _1<span class="token punctuation">.</span>clone<span class="token punctuation">(</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>load<span class="token punctuation">[</span>self<span class="token punctuation">.</span>at_the_depot<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>  <span class="token comment"># refill loaded at the depot</span>

            <span class="token comment">#更新访问标记</span>
            self<span class="token punctuation">.</span>visited_ninf_flag<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>problem_size<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>self<span class="token punctuation">.</span>last_is_depot<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>
            self<span class="token punctuation">.</span>visited_ninf_flag<span class="token punctuation">[</span>self<span class="token punctuation">.</span>BATCH_IDX<span class="token punctuation">,</span> self<span class="token punctuation">.</span>POMO_IDX<span class="token punctuation">,</span> selected<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">'-inf'</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>visited_ninf_flag<span class="token punctuation">[</span>action2_index<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> action2_index<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> temp_last_current_node_action2<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>visited_ninf_flag<span class="token punctuation">[</span>action4_index<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> action4_index<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>problem_size <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>visited_ninf_flag<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>problem_size<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>self<span class="token punctuation">.</span>at_the_depot<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">'-inf'</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>visited_ninf_flag<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token operator">~</span>self<span class="token punctuation">.</span>at_the_depot<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>


            <span class="token comment"># 更新负无穷掩码</span>
            self<span class="token punctuation">.</span>ninf_mask <span class="token operator">=</span> self<span class="token punctuation">.</span>visited_ninf_flag<span class="token punctuation">.</span>clone<span class="token punctuation">(</span><span class="token punctuation">)</span>
            round_error_epsilon <span class="token operator">=</span> <span class="token number">0.00001</span>
            demand_too_large <span class="token operator">=</span> self<span class="token punctuation">.</span>load<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">+</span> round_error_epsilon <span class="token operator">&lt;</span> demand_list
            <span class="token comment"># shape: (batch, pomo, problem+1)</span>
            self<span class="token punctuation">.</span>ninf_mask<span class="token punctuation">[</span>demand_too_large<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">'-inf'</span><span class="token punctuation">)</span>

            <span class="token comment"># 更新完成状态</span>
            <span class="token comment"># 检查哪些智能体已经完成所有节点的访问。</span>
            <span class="token comment"># 更新完成标记 self.finished。</span>
            newly_finished <span class="token operator">=</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>visited_ninf_flag <span class="token operator">==</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">'-inf'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span>self<span class="token punctuation">.</span>problem_size<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
            <span class="token comment"># shape: (batch, pomo)</span>
            self<span class="token punctuation">.</span>finished <span class="token operator">=</span> self<span class="token punctuation">.</span>finished <span class="token operator">+</span> newly_finished
            <span class="token comment"># shape: (batch, pomo)</span>

            <span class="token comment">#更新模式</span>
            self<span class="token punctuation">.</span>mode<span class="token punctuation">[</span>action1_bool_index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>
            self<span class="token punctuation">.</span>mode<span class="token punctuation">[</span>action2_bool_index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2</span>
            self<span class="token punctuation">.</span>mode<span class="token punctuation">[</span>action3_bool_index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>
            self<span class="token punctuation">.</span>mode<span class="token punctuation">[</span>self<span class="token punctuation">.</span>finished<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">4</span>

            <span class="token comment"># 更新完成后的掩码调整</span>
            self<span class="token punctuation">.</span>ninf_mask<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span>self<span class="token punctuation">.</span>finished<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>
            self<span class="token punctuation">.</span>ninf_mask<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>problem_size<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>self<span class="token punctuation">.</span>finished<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">'-inf'</span><span class="token punctuation">)</span>

            <span class="token comment"># 更新步骤状态</span>
            self<span class="token punctuation">.</span>step_state<span class="token punctuation">.</span>selected_count <span class="token operator">=</span> self<span class="token punctuation">.</span>time_step
            self<span class="token punctuation">.</span>step_state<span class="token punctuation">.</span>load <span class="token operator">=</span> self<span class="token punctuation">.</span>load
            self<span class="token punctuation">.</span>step_state<span class="token punctuation">.</span>current_node <span class="token operator">=</span> self<span class="token punctuation">.</span>current_node
            self<span class="token punctuation">.</span>step_state<span class="token punctuation">.</span>ninf_mask <span class="token operator">=</span> self<span class="token punctuation">.</span>ninf_mask



        <span class="token comment"># returning valuesa</span>
        done <span class="token operator">=</span> self<span class="token punctuation">.</span>finished<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> done<span class="token punctuation">:</span>
            reward <span class="token operator">=</span> <span class="token operator">-</span>self<span class="token punctuation">.</span>_get_travel_distance<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># note the minus sign!</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            reward <span class="token operator">=</span> <span class="token boolean">None</span>

        <span class="token keyword">return</span> self<span class="token punctuation">.</span>step_state<span class="token punctuation">,</span> reward<span class="token punctuation">,</span> done

</code></pre>
   </div>
   <link href="./../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="./../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f34343235333233372f:61727469636c652f64657461696c732f313436303830313038" class_="artid" style="display:none">
 </p>
</div>


