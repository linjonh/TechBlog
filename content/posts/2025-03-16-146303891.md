---
layout: post
title: "AgentOpenManus-Agent-Memory详细设计"
date: 2025-03-16 23:34:12 +0800
description: "openManus agent组件内 Memory 的详细设计"
keywords: "【Agent】OpenManus-Agent-Memory详细设计"
categories: ['Ai']
tags: ['架构', 'Openmanus', 'Manus', 'Ai', 'Agi', 'Agent']
artid: "146303891"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146303891
    alt: "AgentOpenManus-Agent-Memory详细设计"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146303891
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146303891
cover: https://bing.ee123.net/img/rand?artid=146303891
image: https://bing.ee123.net/img/rand?artid=146303891
img: https://bing.ee123.net/img/rand?artid=146303891
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     【Agent】OpenManus-Agent-Memory详细设计
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-tomorrow-night" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h3>
     <a id="_0">
     </a>
     概述
    </h3>
    <p>
     Memory 是一个用于存储和管理对话消息的数据结构，它是 Agent 的核心组件，负责维护对话历史和上下文信息。Memory 基于 Pydantic 的 BaseModel 实现，提供了类型安全和数据验证功能。
    </p>
    <p>
     Memory 数据结构是 Agent 系统的核心组件，它提供了存储和管理对话历史的功能，为代理提供了必要的上下文信息，使代理能够进行连贯的对话和决策。
    </p>
    <h3>
     <a id="_6">
     </a>
     数据结构
    </h3>
    <h4>
     <a id="Memory__8">
     </a>
     Memory 类
    </h4>
    <pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">Memory</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    messages<span class="token punctuation">:</span> List<span class="token punctuation">[</span>Message<span class="token punctuation">]</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>default_factory<span class="token operator">=</span><span class="token builtin">list</span><span class="token punctuation">)</span>
    max_messages<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">)</span>
</code></pre>
    <table>
     <thead>
      <tr>
       <th align="left">
        参数名称
       </th>
       <th>
        类型
       </th>
       <th>
        默认值
       </th>
       <th>
        描述
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td align="left">
        messages
       </td>
       <td>
        List[Message]
       </td>
       <td>
        []
       </td>
       <td>
        存储消息的列表
       </td>
      </tr>
      <tr>
       <td align="left">
        max_messages
       </td>
       <td>
        int
       </td>
       <td>
        100
       </td>
       <td>
        内存中保存的最大消息数量
       </td>
      </tr>
     </tbody>
    </table>
    <h4>
     <a id="_21">
     </a>
     依赖的数据结构
    </h4>
    <h5>
     <a id="Message__23">
     </a>
     Message 类
    </h5>
    <pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">Message</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    role<span class="token punctuation">:</span> ROLE_TYPE <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
    content<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>
    tool_calls<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>List<span class="token punctuation">[</span>ToolCall<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>
    name<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>
    tool_call_id<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>
</code></pre>
    <table>
     <thead>
      <tr>
       <th>
        参数名称
       </th>
       <th>
        类型
       </th>
       <th>
        默认值
       </th>
       <th>
        描述
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        role
       </td>
       <td>
        ROLE_TYPE
       </td>
       <td>
        必填
       </td>
       <td>
        消息发送者的角色
       </td>
      </tr>
      <tr>
       <td>
        content
       </td>
       <td>
        Optional[str]
       </td>
       <td>
        None
       </td>
       <td>
        消息内容
       </td>
      </tr>
      <tr>
       <td>
        tool_calls
       </td>
       <td>
        Optional[List[ToolCall]]
       </td>
       <td>
        None
       </td>
       <td>
        工具调用列表
       </td>
      </tr>
      <tr>
       <td>
        name
       </td>
       <td>
        Optional[str]
       </td>
       <td>
        None
       </td>
       <td>
        工具名称（用于工具消息）
       </td>
      </tr>
      <tr>
       <td>
        tool_call_id
       </td>
       <td>
        Optional[str]
       </td>
       <td>
        None
       </td>
       <td>
        工具调用ID（用于工具消息）
       </td>
      </tr>
     </tbody>
    </table>
    <h5>
     <a id="Role__42">
     </a>
     Role 枚举
    </h5>
    <pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">Role</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">,</span> Enum<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Message role options"""</span>
    SYSTEM <span class="token operator">=</span> <span class="token string">"system"</span>
    USER <span class="token operator">=</span> <span class="token string">"user"</span>
    ASSISTANT <span class="token operator">=</span> <span class="token string">"assistant"</span>
    TOOL <span class="token operator">=</span> <span class="token string">"tool"</span>
</code></pre>
    <table>
     <thead>
      <tr>
       <th>
        值
       </th>
       <th>
        描述
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        SYSTEM
       </td>
       <td>
        系统消息，通常用于设置指令或上下文
       </td>
      </tr>
      <tr>
       <td>
        USER
       </td>
       <td>
        用户消息，表示用户输入
       </td>
      </tr>
      <tr>
       <td>
        ASSISTANT
       </td>
       <td>
        助手消息，表示AI助手的响应，一般是询问 LLM 调用什么 tool call
       </td>
      </tr>
      <tr>
       <td>
        TOOL
       </td>
       <td>
        工具消息，表示工具执行的结果
       </td>
      </tr>
     </tbody>
    </table>
    <h5>
     <a id="ToolCall__60">
     </a>
     ToolCall 类
    </h5>
    <pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">ToolCall</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Represents a tool/function call in a message"""</span>
    <span class="token builtin">id</span><span class="token punctuation">:</span> <span class="token builtin">str</span>
    <span class="token builtin">type</span><span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">"function"</span>
    function<span class="token punctuation">:</span> Function
</code></pre>
    <table>
     <thead>
      <tr>
       <th>
        属性名
       </th>
       <th>
        类型
       </th>
       <th>
        默认值
       </th>
       <th>
        描述
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        id
       </td>
       <td>
        str
       </td>
       <td>
        必填
       </td>
       <td>
        工具调用的唯一标识符
       </td>
      </tr>
      <tr>
       <td>
        type
       </td>
       <td>
        str
       </td>
       <td>
        “function”
       </td>
       <td>
        工具调用类型
       </td>
      </tr>
      <tr>
       <td>
        function
       </td>
       <td>
        Function
       </td>
       <td>
        必填
       </td>
       <td>
        函数信息
       </td>
      </tr>
     </tbody>
    </table>
    <h5>
     <a id="Function__76">
     </a>
     Function 类
    </h5>
    <pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">Function</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name<span class="token punctuation">:</span> <span class="token builtin">str</span>
    arguments<span class="token punctuation">:</span> <span class="token builtin">str</span>
</code></pre>
    <table>
     <thead>
      <tr>
       <th>
        属性名
       </th>
       <th>
        类型
       </th>
       <th>
        默认值
       </th>
       <th>
        描述
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        name
       </td>
       <td>
        str
       </td>
       <td>
        必填
       </td>
       <td>
        函数名称
       </td>
      </tr>
      <tr>
       <td>
        arguments
       </td>
       <td>
        str
       </td>
       <td>
        必填
       </td>
       <td>
        函数参数（JSON格式字符串）
       </td>
      </tr>
     </tbody>
    </table>
    <h3>
     <a id="_89">
     </a>
     方法分析
    </h3>
    <h4>
     <a id="Memory__91">
     </a>
     Memory 类方法
    </h4>
    <h5>
     <a id="add_message_93">
     </a>
     <code>
      add_message
     </code>
    </h5>
    <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">add_message</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> message<span class="token punctuation">:</span> Message<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Add a message to memory"""</span>
    self<span class="token punctuation">.</span>messages<span class="token punctuation">.</span>append<span class="token punctuation">(</span>message<span class="token punctuation">)</span>
    <span class="token comment"># Optional: Implement message limit</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>messages<span class="token punctuation">)</span> <span class="token operator">&gt;</span> self<span class="token punctuation">.</span>max_messages<span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>messages <span class="token operator">=</span> self<span class="token punctuation">.</span>messages<span class="token punctuation">[</span><span class="token operator">-</span>self<span class="token punctuation">.</span>max_messages <span class="token punctuation">:</span><span class="token punctuation">]</span>
</code></pre>
    <p>
     <strong>
      功能
     </strong>
     ：向 Memory 中添加单个消息。
     <br/>
     <strong>
      参数
     </strong>
     ：
    </p>
    <ul>
     <li>
      <code>
       message
      </code>
      : Message - 要添加的消息对象
     </li>
    </ul>
    <p>
     <strong>
      实现细节
     </strong>
     ：
    </p>
    <ul>
     <li>
      将消息追加到消息列表末尾
     </li>
     <li>
      检查消息数量是否超过最大限制
     </li>
     <li>
      如果超过限制，保留最近的
      <code>
       max_messages
      </code>
      条消息
     </li>
    </ul>
    <p>
     <strong>
      设计理念
     </strong>
     ：
    </p>
    <ul>
     <li>
      实现滑动窗口机制，防止内存无限增长
     </li>
     <li>
      保留最近的消息，确保最相关的上下文信息被保留
     </li>
    </ul>
    <h5>
     <a id="add_messages_118">
     </a>
     <code>
      add_messages
     </code>
    </h5>
    <blockquote>
     <p>
      在 planning agent 里面使用的
     </p>
    </blockquote>
    <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">add_messages</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> messages<span class="token punctuation">:</span> List<span class="token punctuation">[</span>Message<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Add multiple messages to memory"""</span>
    self<span class="token punctuation">.</span>messages<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>messages<span class="token punctuation">)</span>
</code></pre>
    <p>
     <strong>
      功能
     </strong>
     ：向内存中批量添加多个消息。
     <br/>
     <strong>
      参数
     </strong>
     ：
    </p>
    <ul>
     <li>
      <code>
       messages
      </code>
      : List[Message] - 要添加的消息列表
     </li>
    </ul>
    <p>
     <strong>
      实现细节
     </strong>
     ：
    </p>
    <ul>
     <li>
      使用
      <code>
       extend
      </code>
      方法将消息列表追加到现有消息列表
     </li>
     <li>
      <strong>
       注意：此方法不检查最大消息限制
      </strong>
     </li>
    </ul>
    <p>
     <strong>
      设计理念
     </strong>
     ：
    </p>
    <ul>
     <li>
      提供批量添加消息的便捷方法
     </li>
     <li>
      优化性能，避免多次调用
      <code>
       add_message
      </code>
     </li>
    </ul>
    <h5>
     <a id="clear_141">
     </a>
     <code>
      clear
     </code>
    </h5>
    <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">clear</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Clear all messages"""</span>
    self<span class="token punctuation">.</span>messages<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     <strong>
      功能
     </strong>
     ：清空内存中的所有消息。
    </p>
    <p>
     <strong>
      实现细节
     </strong>
     ：
    </p>
    <ul>
     <li>
      使用 Python 列表的
      <code>
       clear
      </code>
      方法清空消息列表
     </li>
    </ul>
    <p>
     <strong>
      设计理念
     </strong>
     ：
    </p>
    <ul>
     <li>
      提供重置对话历史的能力
     </li>
     <li>
      在需要开始新对话时使用
     </li>
    </ul>
    <h5>
     <a id="get_recent_messages_158">
     </a>
     <code>
      get_recent_messages
     </code>
    </h5>
    <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">get_recent_messages</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> n<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span>Message<span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Get n most recent messages"""</span>
    <span class="token keyword">return</span> self<span class="token punctuation">.</span>messages<span class="token punctuation">[</span><span class="token operator">-</span>n<span class="token punctuation">:</span><span class="token punctuation">]</span>
</code></pre>
    <p>
     <strong>
      功能
     </strong>
     ：获取最近的 n 条消息。
     <br/>
     <strong>
      参数
     </strong>
     ：
    </p>
    <ul>
     <li>
      <code>
       n
      </code>
      : int - 要获取的消息数量
     </li>
    </ul>
    <p>
     <strong>
      返回值
     </strong>
     ：
    </p>
    <ul>
     <li>
      List[Message] - 最近的 n 条消息列表
     </li>
    </ul>
    <p>
     <strong>
      实现细节
     </strong>
     ：
    </p>
    <ul>
     <li>
      使用 Python 列表切片获取最后 n 个元素
     </li>
    </ul>
    <p>
     <strong>
      设计理念
     </strong>
     ：
    </p>
    <ul>
     <li>
      允许获取有限数量的最近消息
     </li>
     <li>
      用于构建有限上下文窗口
     </li>
    </ul>
    <h5>
     <a id="to_dict_list_180">
     </a>
     <code>
      to_dict_list
     </code>
    </h5>
    <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">to_dict_list</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span><span class="token builtin">dict</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Convert messages to list of dicts"""</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>msg<span class="token punctuation">.</span>to_dict<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> msg <span class="token keyword">in</span> self<span class="token punctuation">.</span>messages<span class="token punctuation">]</span>
</code></pre>
    <p>
     <strong>
      功能
     </strong>
     ：将消息列表转换为字典列表。
    </p>
    <p>
     <strong>
      返回值
     </strong>
     ：
    </p>
    <ul>
     <li>
      List[dict] - 消息字典列表
     </li>
    </ul>
    <p>
     <strong>
      实现细节
     </strong>
     ：
    </p>
    <ul>
     <li>
      使用列表推导式对每个消息调用
      <code>
       to_dict
      </code>
      方法
     </li>
     <li>
      依赖 Message 类的
      <code>
       to_dict
      </code>
      方法
     </li>
    </ul>
    <p>
     <strong>
      设计理念
     </strong>
     ：
    </p>
    <ul>
     <li>
      提供序列化功能，便于与外部系统交互
     </li>
     <li>
      将复杂对象转换为简单数据结构
     </li>
    </ul>
    <h4>
     <a id="Message__201">
     </a>
     Message 类相关方法
    </h4>
    <h5>
     <a id="to_dict_203">
     </a>
     <code>
      to_dict
     </code>
    </h5>
    <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">to_dict</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">dict</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Convert message to dictionary format"""</span>
    message <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"role"</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>role<span class="token punctuation">}</span>
    <span class="token keyword">if</span> self<span class="token punctuation">.</span>content <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        message<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>content
    <span class="token keyword">if</span> self<span class="token punctuation">.</span>tool_calls <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        message<span class="token punctuation">[</span><span class="token string">"tool_calls"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>tool_call<span class="token punctuation">.</span><span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> tool_call <span class="token keyword">in</span> self<span class="token punctuation">.</span>tool_calls<span class="token punctuation">]</span>
    <span class="token keyword">if</span> self<span class="token punctuation">.</span>name <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        message<span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>name
    <span class="token keyword">if</span> self<span class="token punctuation">.</span>tool_call_id <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        message<span class="token punctuation">[</span><span class="token string">"tool_call_id"</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>tool_call_id
    <span class="token keyword">return</span> message
</code></pre>
    <p>
     <strong>
      功能
     </strong>
     ：将消息对象转换为字典格式。
    </p>
    <p>
     <strong>
      返回值
     </strong>
     ：
    </p>
    <ul>
     <li>
      dict - 消息的字典表示
     </li>
    </ul>
    <h5>
     <a id="_225">
     </a>
     工厂方法
    </h5>
    <p>
     Message 类提供了多个工厂方法，用于创建不同类型的消息：
    </p>
    <pre><code class="prism language-python"><span class="token decorator annotation punctuation">@classmethod</span>
<span class="token keyword">def</span> <span class="token function">user_message</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> content<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token string">"Message"</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Create a user message"""</span>
    <span class="token keyword">return</span> cls<span class="token punctuation">(</span>role<span class="token operator">=</span>Role<span class="token punctuation">.</span>USER<span class="token punctuation">,</span> content<span class="token operator">=</span>content<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@classmethod</span>
<span class="token keyword">def</span> <span class="token function">system_message</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> content<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token string">"Message"</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Create a system message"""</span>
    <span class="token keyword">return</span> cls<span class="token punctuation">(</span>role<span class="token operator">=</span>Role<span class="token punctuation">.</span>SYSTEM<span class="token punctuation">,</span> content<span class="token operator">=</span>content<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@classmethod</span>
<span class="token keyword">def</span> <span class="token function">assistant_message</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> content<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token string">"Message"</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Create an assistant message"""</span>
    <span class="token keyword">return</span> cls<span class="token punctuation">(</span>role<span class="token operator">=</span>Role<span class="token punctuation">.</span>ASSISTANT<span class="token punctuation">,</span> content<span class="token operator">=</span>content<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@classmethod</span>
<span class="token keyword">def</span> <span class="token function">tool_message</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> content<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> tool_call_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token string">"Message"</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Create a tool message"""</span>
    <span class="token keyword">return</span> cls<span class="token punctuation">(</span>
        role<span class="token operator">=</span>Role<span class="token punctuation">.</span>TOOL<span class="token punctuation">,</span> content<span class="token operator">=</span>content<span class="token punctuation">,</span> name<span class="token operator">=</span>name<span class="token punctuation">,</span> tool_call_id<span class="token operator">=</span>tool_call_id
    <span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@classmethod</span>
<span class="token keyword">def</span> <span class="token function">from_tool_calls</span><span class="token punctuation">(</span>
    cls<span class="token punctuation">,</span> tool_calls<span class="token punctuation">:</span> List<span class="token punctuation">[</span>Any<span class="token punctuation">]</span><span class="token punctuation">,</span> content<span class="token punctuation">:</span> Union<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Create ToolCallsMessage from raw tool calls."""</span>
    formatted_calls <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span><span class="token string">"id"</span><span class="token punctuation">:</span> call<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span> <span class="token string">"function"</span><span class="token punctuation">:</span> call<span class="token punctuation">.</span>function<span class="token punctuation">.</span>model_dump<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"function"</span><span class="token punctuation">}</span>
        <span class="token keyword">for</span> call <span class="token keyword">in</span> tool_calls
    <span class="token punctuation">]</span>
    <span class="token keyword">return</span> cls<span class="token punctuation">(</span>
        role<span class="token operator">=</span>Role<span class="token punctuation">.</span>ASSISTANT<span class="token punctuation">,</span> content<span class="token operator">=</span>content<span class="token punctuation">,</span> tool_calls<span class="token operator">=</span>formatted_calls<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs
    <span class="token punctuation">)</span>
</code></pre>
    <p>
     <strong>
      功能
     </strong>
     ：提供创建各种类型消息的便捷方法。
    </p>
    <h5>
     <a id="_268">
     </a>
     运算符重载
    </h5>
    <p>
     Message 类重载了
     <code>
      +
     </code>
     运算符，支持消息与列表或其他消息的组合：
    </p>
    <p>
     <strong>
      注意：这个重载是不校验 memory中messages的长度的，也就是不受 max_messages 参数限制。一般用在添加 user msg 的时候，可见 ToolAgent 中 think 方法
     </strong>
    </p>
    <p>
     如果是为了保证 user msg 一定被加到 memory messages 里面，感觉用一个特别的方法名称来标识会更好一点。
    </p>
    <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">__add__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> other<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span><span class="token string">"Message"</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""支持 Message + list 或 Message + Message 的操作"""</span>
    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>other<span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span>self<span class="token punctuation">]</span> <span class="token operator">+</span> other
    <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>other<span class="token punctuation">,</span> Message<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span>self<span class="token punctuation">,</span> other<span class="token punctuation">]</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> TypeError<span class="token punctuation">(</span>
            <span class="token string-interpolation"><span class="token string">f"unsupported operand type(s) for +: '</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">type</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">.</span>__name__<span class="token punctuation">}</span></span><span class="token string">' and '</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">type</span><span class="token punctuation">(</span>other<span class="token punctuation">)</span><span class="token punctuation">.</span>__name__<span class="token punctuation">}</span></span><span class="token string">'"</span></span>
        <span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">__radd__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> other<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span><span class="token string">"Message"</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""支持 list + Message 的操作"""</span>
    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>other<span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> other <span class="token operator">+</span> <span class="token punctuation">[</span>self<span class="token punctuation">]</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> TypeError<span class="token punctuation">(</span>
            <span class="token string-interpolation"><span class="token string">f"unsupported operand type(s) for +: '</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">type</span><span class="token punctuation">(</span>other<span class="token punctuation">)</span><span class="token punctuation">.</span>__name__<span class="token punctuation">}</span></span><span class="token string">' and '</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">type</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">.</span>__name__<span class="token punctuation">}</span></span><span class="token string">'"</span></span>
        <span class="token punctuation">)</span>
</code></pre>
    <p>
     <strong>
      功能
     </strong>
     ：允许使用
     <code>
      +
     </code>
     运算符组合消息和消息列表。
    </p>
    <p>
     <strong>
      设计理念
     </strong>
     ：
    </p>
    <ul>
     <li>
      提供直观的语法糖，简化消息列表操作
     </li>
     <li>
      支持多种组合方式，增强灵活性
     </li>
    </ul>
    <h3>
     <a id="_305">
     </a>
     使用示例
    </h3>
    <pre><code class="prism language-python"><span class="token comment"># 创建内存实例</span>
memory <span class="token operator">=</span> Memory<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 添加不同类型的消息</span>
memory<span class="token punctuation">.</span>add_message<span class="token punctuation">(</span>Message<span class="token punctuation">.</span>system_message<span class="token punctuation">(</span><span class="token string">"你是一个有用的助手"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
memory<span class="token punctuation">.</span>add_message<span class="token punctuation">(</span>Message<span class="token punctuation">.</span>user_message<span class="token punctuation">(</span><span class="token string">"你好，请帮我写一首诗"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
memory<span class="token punctuation">.</span>add_message<span class="token punctuation">(</span>Message<span class="token punctuation">.</span>assistant_message<span class="token punctuation">(</span><span class="token string">"好的，这是一首关于春天的诗：..."</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 获取最近的消息</span>
recent_msgs <span class="token operator">=</span> memory<span class="token punctuation">.</span>get_recent_messages<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>

<span class="token comment"># 转换为字典列表（用于API调用）</span>
dict_msgs <span class="token operator">=</span> memory<span class="token punctuation">.</span>to_dict_list<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 清空内存</span>
memory<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
    <h3>
     <a id="_326">
     </a>
     设计理念总结
    </h3>
    <ol>
     <li>
      <p>
       <strong>
        类型安全
       </strong>
       ：
      </p>
      <ul>
       <li>
        使用 Pydantic 模型确保数据类型正确
       </li>
       <li>
        使用枚举类型限制可能的值（如角色）
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        内存管理
       </strong>
       ：
      </p>
      <ul>
       <li>
        实现最大消息限制，防止内存无限增长
       </li>
       <li>
        保留最近的消息，确保相关上下文
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        灵活性
       </strong>
       ：
      </p>
      <ul>
       <li>
        支持多种消息类型（用户、系统、助手、工具）
       </li>
       <li>
        提供工厂方法简化消息创建
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        序列化
       </strong>
       ：
      </p>
      <ul>
       <li>
        提供转换为字典的方法，便于与API交互
       </li>
       <li>
        只包含非空字段，减少数据大小
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        便捷操作
       </strong>
       ：
      </p>
      <ul>
       <li>
        重载运算符，简化消息组合
       </li>
       <li>
        提供批量操作方法，提高效率
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        模块化
       </strong>
       ：
      </p>
      <ul>
       <li>
        将消息和内存分离为独立类
       </li>
       <li>
        清晰的职责分离，遵循单一职责原则
       </li>
      </ul>
     </li>
    </ol>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f34303234323834352f:61727469636c652f64657461696c732f313436333033383931" class_="artid" style="display:none">
 </p>
</div>


