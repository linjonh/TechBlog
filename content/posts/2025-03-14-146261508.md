---
layout: post
title: "Spring-Cloud-Eureka-高可用服务注册与发现解决方案"
date: 2025-03-14 17:20:38 +0800
description: "Spring Cloud Eureka - 高可用服务注册与发现解决方案"
keywords: "Spring Cloud Eureka - 高可用服务注册与发现解决方案"
categories: ['Springcloud']
tags: ['服务注册与发现', 'Eureka']
artid: "146261508"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146261508
    alt: "Spring-Cloud-Eureka-高可用服务注册与发现解决方案"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146261508
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146261508
cover: https://bing.ee123.net/img/rand?artid=146261508
image: https://bing.ee123.net/img/rand?artid=146261508
img: https://bing.ee123.net/img/rand?artid=146261508
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Spring Cloud Eureka - 高可用服务注册与发现解决方案
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     在微服务架构中，服务注册与发现是确保系统动态扩展和高效通信的关键。Eureka 作为 Spring Cloud 生态的核心组件，不仅提供去中心化的服务治理能力，还通过自我保护、健康检查等机制提升系统的稳定性，使其成为微服务架构中的重要支撑。
    </p>
    <p>
     解析 Eureka 的核心原理，并通过实战演示高可用集群搭建、元数据定制及跨区域部署策略，确保系统具备更强的容错性和稳定性。
    </p>
    <h3>
     <a id="Eureka__4">
     </a>
     一、Eureka 介绍
    </h3>
    <p>
     Eureka：是一个服务发现框架，提供了一个 RESTful API 来帮助微服务注册并发现其他服务。它是由 Netflix 开发的，作为一个微服务架构的核心组成部分，通常用来实现服务间的自动化发现和负载均衡。
    </p>
    <p>
     <strong>
      1.1 Eureka 组件
     </strong>
    </p>
    <p>
     Eureka 的核心组件
    </p>
    <p>
     <em>
      1. Eureka Server（服务注册中心）
     </em>
    </p>
    <p>
     • 负责维护所有微服务的注册信息，相当于服务的“电话簿”。
    </p>
    <p>
     • 允许微服务注册（REGISTER）和发现（GET 服务列表）其他服务。
    </p>
    <p>
     • 支持自我保护机制，避免因网络波动误删除健康的服务。
    </p>
    <p>
     <em>
      2. Eureka Client（微服务实例）
     </em>
    </p>
    <p>
     • 集成于微服务中，负责向 Eureka Server 注册自身信息。
    </p>
    <p>
     • 定期发送心跳（默认30秒）以维持服务存活。
    </p>
    <p>
     • 从 Eureka Server 拉取服务列表实现动态发现，支撑负载均衡调用。
    </p>
    <p>
     <strong>
      1.2 Eureka 运行机制
     </strong>
    </p>
    <p>
     Eureka Client 与 Eureka Server 交互流程图，包括服务注册、续约、获取和剔除：
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/b5ad6a9e9f614df1b8fe149b0cc96b84.png"/>
    </p>
    <p>
     流程说明：
    </p>
    <p>
     服务注册：微服务启动后，Eureka Client 向 Eureka Server 发送 REGISTER请求，将自身信息注册到服务中心。
    </p>
    <p>
     服务续约：Eureka Client定期（如每 30 秒）向 Eureka Server 发送心跳（RENEW 请求），表明自己是存活状态。
    </p>
    <p>
     服务获取：微服务需要调用其他服务时，Eureka Client会向 Server 发送GET请求，以获取可用服务列表。
    </p>
    <p>
     服务剔除：如果 Server 90 秒未收到Eureka Client的 RENEW， Eureka Server 默认Eureka Client 已失效并将其移除（除非Eureka Server启用了自我保护模式）。
    </p>
    <h3>
     <a id="Eureka__45">
     </a>
     二、Eureka 高可用集群：告别单点故障
    </h3>
    <p>
     <strong>
      2.1 集群架构设计原理
     </strong>
    </p>
    <p>
     Eureka1[Eureka Server 节点1] --&gt;|相互注册| Eureka2[Eureka Server 节点2]
     <br/>
     Eureka2 --&gt;|相互注册| Eureka3[Eureka Server 节点3]
     <br/>
     Eureka3 --&gt;|相互注册| Eureka1
    </p>
    <p>
     核心机制：
    </p>
    <p>
     • 去中心化架构（Peer Awareness）：
    </p>
    <p>
     每个 Eureka Server既是服务端也是客户端，它们相互注册并同步服务信息，避免单点故障。
    </p>
    <p>
     • 最终一致性（Eventual Consistency）：
    </p>
    <p>
     注册信息通过HTTP 复制机制进行同步，虽然不会强制保证实时一致性，但能在短时间内达到最终一致性，确保高可用。
    </p>
    <p>
     • 容错与自我保护：
    </p>
    <p>
     当网络故障或部分节点失联时，Eureka 采用自我保护模式，避免误剔除健康服务，增强系统稳定性。
    </p>
    <p>
     <strong>
      2.2 三节点集群搭建实战
     </strong>
    </p>
    <p>
     <em>
      1.集群配置完整步骤
     </em>
    </p>
    <p>
     步骤1：配置集群
    </p>
    <p>
     Eureka Server 1 配置：
    </p>
    <p>
     在eureka1实例的application.yml文件中，配置 Eureka Server 的服务名称、端口及相互注册的 Eureka Server 地址。
    </p>
    <pre><code class="prism language-yaml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8761</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> eureka<span class="token punctuation">-</span>server  <span class="token comment"># 集群统一名称</span>

<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> eureka1  <span class="token comment"># 必须配置 DNS 或 hosts 解析</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">register-with-eureka</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token comment"># 允许自身注册到 Eureka</span>
    <span class="token key atrule">fetch-registry</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token comment"># 允许从 Eureka 拉取注册信息</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//eureka2<span class="token punctuation">:</span>8762/eureka<span class="token punctuation">,</span>http<span class="token punctuation">:</span>//eureka3<span class="token punctuation">:</span>8763/eureka  <span class="token comment"># 另2个 Eureka Server 的地址</span>
</code></pre>
    <p>
     其他节点配置
    </p>
    <p>
     • eureka2（端口8762）和eureka3（端口8763）的service-url需要指向除自身以外的两个 Eureka Server。
    </p>
    <p>
     • 例如eureka2的service-url配置应为：
    </p>
    <pre><code class="prism language-yaml"><span class="token key atrule">service-url</span><span class="token punctuation">:</span>
  <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//eureka1<span class="token punctuation">:</span>8761/eureka<span class="token punctuation">,</span>http<span class="token punctuation">:</span>//eureka3<span class="token punctuation">:</span>8763/eureka
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/d9dd022d8c4b445eb42412eaa19ca64f.png"/>
    </p>
    <p>
     步骤2：配置 Eureka Client 连接集群
     <br/>
     在微服务的application.yml文件中，配置多个 Eureka Server 的地址：
    </p>
    <pre><code class="prism language-yaml"><span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//eureka1<span class="token punctuation">:</span>8761/eureka<span class="token punctuation">,</span>http<span class="token punctuation">:</span>//eureka2<span class="token punctuation">:</span>8762/eureka<span class="token punctuation">,</span>http<span class="token punctuation">:</span>//eureka3<span class="token punctuation">:</span>8763/eureka
</code></pre>
    <p>
     预期结果：在所有三个 Eureka 控制台均能看到该服务实例。
    </p>
    <p>
     步骤3：启动集群
    </p>
    <pre><code class="prism language-bash"><span class="token function">java</span> <span class="token parameter variable">-jar</span> eureka-server.jar <span class="token parameter variable">--server.port</span><span class="token operator">=</span><span class="token number">8761</span> <span class="token parameter variable">--eureka.instance.hostname</span><span class="token operator">=</span>eureka1
<span class="token function">java</span> <span class="token parameter variable">-jar</span> eureka-server.jar <span class="token parameter variable">--server.port</span><span class="token operator">=</span><span class="token number">8762</span> <span class="token parameter variable">--eureka.instance.hostname</span><span class="token operator">=</span>eureka2
<span class="token function">java</span> <span class="token parameter variable">-jar</span> eureka-server.jar <span class="token parameter variable">--server.port</span><span class="token operator">=</span><span class="token number">8763</span> <span class="token parameter variable">--eureka.instance.hostname</span><span class="token operator">=</span>eureka3
</code></pre>
    <p>
     启动后，eureka1、eureka2和eureka3会互相注册，互相发现对方的存在，形成一个高可用的 Eureka 集群。
    </p>
    <p>
     步骤4：访问控制台验证集群
    </p>
    <p>
     打开浏览器访问：
    </p>
    <p>
     • http://eureka1:8761
    </p>
    <p>
     • http://eureka2:8762
    </p>
    <p>
     • http://eureka3:8763
    </p>
    <p>
     预期效果：每个节点的控制台应显示另外两个节点为已注册状态。
    </p>
    <p>
     eureka1:8761 控制台展示：（其他2个节点控制台展示类似）
    </p>
    <pre><code class="prism language-bash">Eureka Server 控制台 - eureka1:8761
-------------------------------------------------------
集群节点信息：
-----------------------------------------
<span class="token number">1</span>. eureka1:8761 <span class="token punctuation">(</span>状态: UP<span class="token punctuation">)</span>
<span class="token number">2</span>. eureka2:8762 <span class="token punctuation">(</span>状态: UP<span class="token punctuation">)</span>
<span class="token number">3</span>. eureka3:8763 <span class="token punctuation">(</span>状态: UP<span class="token punctuation">)</span>
-----------------------------------------

集群节点分布：
-----------------------------------------
<span class="token string">"eureka1:8761"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>
<span class="token string">"eureka2:8762"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>
<span class="token string">"eureka3:8763"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>
-----------------------------------------

已注册的微服务实例：
-----------------------------------------
client1:8080
状态: UP
注册时间: <span class="token number">2025</span>-03-02 <span class="token number">12</span>:30:45
应用类型: Microservice
可用区域: defaultZone
端口: <span class="token number">8080</span>
主机: localhost
-----------------------------------------

应用信息：
-----------------------------------------
<span class="token number">1</span>. 微服务实例： client1
<span class="token number">2</span>. 应用状态： UP
<span class="token number">3</span>. 主机名： localhost
<span class="token number">4</span>. 服务端口： <span class="token number">8080</span>
-----------------------------------------
</code></pre>
    <p>
     这样微服务可以同时连接多个 Eureka Server 进行服务注册与发现。当一个 Eureka Server 不可用时，能够自动切换到另一个 Eureka Server。从而实现高可用，避免单点故障。
    </p>
    <p>
     <strong>
      2.3 常见集群配置错误排查
     </strong>
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/7ff06506874a44ecb608283c489a2ac3.png"/>
    </p>
    <p>
     <strong>
      2.4 安全加固
     </strong>
    </p>
    <p>
     在生产环境中，为了确保Eureka Server和Eureka Client之间的通信安全，建议进行以下安全加固措施：
    </p>
    <p>
     <em>
      1. 基本认证 (Basic Authentication)
     </em>
    </p>
    <p>
     • 作用：确保Eureka Server和Eureka Client间的通信只能由授权用户访问，防止未授权的访问。这是保护敏感信息、控制接口访问权限的一个基本措施。
    </p>
    <p>
     • 配置：涉及Eureka Server和Eureka Client的配置，在application.yml中设置用户凭证（如user:password），从而对访问接口（如注册、查询等）进行身份验证。
    </p>
    <p>
     基本认证配置示例：
    </p>
    <p>
     步骤1：Eureka Server 配置
    </p>
    <pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">security</span><span class="token punctuation">:</span>
    <span class="token key atrule">user</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> user  <span class="token comment"># 设置基本认证的用户名</span>
      <span class="token key atrule">password</span><span class="token punctuation">:</span> password  <span class="token comment"># 设置基本认证的密码</span>
</code></pre>
    <p>
     集群配置：
    </p>
    <p>
     <em>
      <strong>
       单一认证信息
      </strong>
     </em>
    </p>
    <p>
     • 集群中所有Eureka Server节点都配置相同的基本认证信息。
    </p>
    <p>
     • 适用于安全要求较低的环境。
    </p>
    <p>
     <em>
      <strong>
       多套认证信息
      </strong>
     </em>
    </p>
    <p>
     • 集群中每个节点使用不同的认证信息。每个节点配置独立的用户名和密码。
    </p>
    <p>
     • 适用于对安全性要求较高的环境。
    </p>
    <p>
     步骤2：Eureka Client 配置
    </p>
    <p>
     在Eureka Client的application.yml中，配置 Eureka Server 的地址，并加入基本认证信息以进行连接认证。
    </p>
    <pre><code class="prism language-yaml"><span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//user<span class="token punctuation">:</span>password@eureka1<span class="token punctuation">:</span>8761/eureka<span class="token punctuation">,</span>https<span class="token punctuation">:</span>//user<span class="token punctuation">:</span>password@eureka2<span class="token punctuation">:</span>8762/eureka<span class="token punctuation">,</span>https<span class="token punctuation">:</span>//user<span class="token punctuation">:</span>password@eureka3<span class="token punctuation">:</span>8763/eureka  
      <span class="token comment"># 配置多个 Eureka Server 地址，并添加基本认证信息</span>

</code></pre>
    <p>
     完成如上基本认证配置后，只有被授权的Eureka Client 才能访问Eureka Server，有效保护了 Eureka Server 接口，防止未授权访问。
    </p>
    <p>
     <em>
      2. 启用 HTTPS 通信
     </em>
    </p>
    <p>
     为了确保Eureka Server和Eureka Client之间的数据传输安全，启用HTTPS通信是一个关键步骤。
    </p>
    <p>
     作用：启用 HTTPS 通信可以确保Eureka Server和Eureka Client之间的数据传输加密，防止数据在传输过程中被窃听或篡改，增强通信的安全性。
    </p>
    <p>
     配置： 配置 SSL/TLS 证书以启用 HTTPS，确保所有通信过程都经过加密。
    </p>
    <p>
     启用 HTTPS 通信示例：
    </p>
    <p>
     在Eureka Server的application.yml中，配置 SSL 证书和 HTTPS 通信：
    </p>
    <pre><code class="prism language-yaml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8761</span>  <span class="token comment"># 监听端口为 8761</span>
  <span class="token key atrule">ssl</span><span class="token punctuation">:</span>
    <span class="token key atrule">key-store</span><span class="token punctuation">:</span> classpath<span class="token punctuation">:</span>keystore.jks  <span class="token comment"># SSL 证书的存储路径</span>
    <span class="token key atrule">key-store-password</span><span class="token punctuation">:</span> your<span class="token punctuation">-</span>password  <span class="token comment"># 密钥库密码</span>
    <span class="token key atrule">key-store-type</span><span class="token punctuation">:</span> JKS  <span class="token comment"># 证书类型</span>
    <span class="token key atrule">key-alias</span><span class="token punctuation">:</span> your<span class="token punctuation">-</span>alias  <span class="token comment"># 证书别名</span>

<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> eureka1  <span class="token comment"># 当前服务器的 hostname</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">register-with-eureka</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token comment"># 允许自己注册到 Eureka</span>
    <span class="token key atrule">fetch-registry</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token comment"># 允许从 Eureka 拉取注册信息</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//eureka2<span class="token punctuation">:</span>8762/eureka<span class="token punctuation">,</span>https<span class="token punctuation">:</span>//eureka3<span class="token punctuation">:</span>8763/eureka  <span class="token comment"># 配置其他 Eureka Server 的 HTTPS 地址</span>
</code></pre>
    <p>
     集群中，其他节点(如eureka2 )的配置，类似于eureka1节点， 主要是端口和hostname发生变化，还有 defaultZone 配置 需要同其他节点实现互相注册。
    </p>
    <p>
     步骤2：Eureka Client 配置
    </p>
    <p>
     在Eureka Client的application.yml中，配置 Eureka Server 的 HTTPS 地址。客户端可以连接到多个 Eureka Server 节点，增加系统的容错能力和高可用性：
    </p>
    <pre><code class="prism language-yaml"><span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//eureka1<span class="token punctuation">:</span>8761/eureka<span class="token punctuation">,</span>https<span class="token punctuation">:</span>//eureka2<span class="token punctuation">:</span>8762/eureka<span class="token punctuation">,</span>https<span class="token punctuation">:</span>//eureka3<span class="token punctuation">:</span>8763/eureka  <span class="token comment"># 配置多个 Eureka Server 地址</span>
</code></pre>
    <p>
     完成如上配置后， HTTPS 通信被启动，可以有效保障数据传输安全。
    </p>
    <p>
     <strong>
      2.5 生产环境建议
     </strong>
    </p>
    <p>
     • 跨机房部署：将 Eureka 节点部署在不同物理机房或可用区，确保故障隔离和容灾能力。
    </p>
    <p>
     • 健康检查：集成 Spring Boot Actuator 的/health端点，实时监控 Eureka Server 节点的健康状态，确保快速响应故障。
    </p>
    <p>
     • 安全加固：启用 HTTPS 通信保障数据传输安全，启用基本认证）保护 Eureka Server 接口，防止未授权访问。
    </p>
    <h3>
     <a id="_289">
     </a>
     三、健康检查与自我保护：构建服务稳定性的双保险
    </h3>
    <p>
     <strong>
      3.1 健康检查机制：精准剔除故障节点
     </strong>
    </p>
    <p>
     核心原理：
    </p>
    <p>
     Eureka 通过健康检查机制，确保仅存活的服务能够被发现。Spring Boot Actuator 提供了/actuator/health端点（默认暴露），Eureka Server 可以定期访问该端点检查服务状态。
    </p>
    <p>
     实现步骤：
    </p>
    <p>
     1.启用健康检查
    </p>
    <p>
     在Eureka Client的application.yml中配置：
    </p>
    <pre><code class="prism language-yaml"><span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">healthcheck</span><span class="token punctuation">:</span>
      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token comment"># 开启健康检查</span>
</code></pre>
    <p>
     2.健康端点响应
    </p>
    <p>
     Spring Boot Actuator 默认暴露/actuator/health端点：
    </p>
    <pre><code class="prism language-bash">// 健康检查响应示例
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"status"</span><span class="token builtin class-name">:</span> <span class="token string">"UP"</span>,
  <span class="token string">"components"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"diskSpace"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"status"</span><span class="token builtin class-name">:</span> <span class="token string">"UP"</span><span class="token punctuation">}</span>,
    <span class="token string">"ping"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"status"</span><span class="token builtin class-name">:</span> <span class="token string">"UP"</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     <em>
      3. 关键参数调优
     </em>
    </p>
    <p>
     在Eureka Client和Eureka Server的application.yml 文件中设置相关的参数进行调优：
    </p>
    <p>
     Eureka Client 端调优参数
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/9c3cb2403fc24c1eb853f04d4cb73ee2.png"/>
    </p>
    <p>
     Eureka Server 端调优参数
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/cb6f22db35c8486084b648f7262bce2c.png"/>
    </p>
    <p>
     <strong>
      3.2 自我保护模式：突发故障的容错机制
     </strong>
    </p>
    <p>
     触发机制详解：
    </p>
    <p>
     Eureka 的自我保护模式旨在防止在网络不稳定或短期故障期间，服务被错误地标记为不可用。该模式会在接收到的心跳数低于预期值时自动触发，从而保留现有服务实例，避免系统不稳定。
    </p>
    <p>
     工作流程：
    </p>
    <p>
     1.每分钟心跳总数会与最近 15 分钟的心跳丢失率进行对比。
    </p>
    <p>
     2.如果丢失率超过15%，触发自我保护模式，保留所有实例并发出警告。
    </p>
    <p>
     3.如果丢失率低于15%，维持正常模式，并定期清理失效实例。
    </p>
    <pre><code class="prism language-bash">A<span class="token punctuation">[</span>每分钟心跳总数<span class="token punctuation">]</span> --<span class="token operator">&gt;</span> B<span class="token punctuation">{<!-- --></span>统计最近15分钟<span class="token operator">&lt;</span>br<span class="token operator">&gt;</span>心跳丢失率<span class="token punctuation">}</span>
B --<span class="token operator">&gt;|</span>丢失率 <span class="token operator">&gt;</span><span class="token number">15</span>%<span class="token operator">|</span> C<span class="token punctuation">[</span>触发保护模式<span class="token punctuation">]</span>
B --<span class="token operator">&gt;|</span>丢失率 ≤15%<span class="token operator">|</span> D<span class="token punctuation">[</span>正常模式<span class="token punctuation">]</span>
C --<span class="token operator">&gt;</span> E<span class="token punctuation">[</span>保留所有实例<span class="token punctuation">]</span>
C --<span class="token operator">&gt;</span> F<span class="token punctuation">[</span>控制台警告提示<span class="token punctuation">]</span>
D --<span class="token operator">&gt;</span> G<span class="token punctuation">[</span>定期清理失效实例<span class="token punctuation">]</span>
</code></pre>
    <p>
     配置与优化：
    </p>
    <p>
     <em>
      1.基础配置：
     </em>
    </p>
    <p>
     在Eureka Server的application.yml配置文件中启用自我保护模式：
    </p>
    <pre><code class="prism language-yaml"><span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">server</span><span class="token punctuation">:</span>
    <span class="token key atrule">enable-self-preservation</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token comment"># 开启保护模式</span>
    <span class="token key atrule">renewal-percent-threshold</span><span class="token punctuation">:</span> <span class="token number">0.85</span>   <span class="token comment"># 触发阈值（85%心跳正常）</span>
    <span class="token key atrule">eviction-interval-timer-in-ms</span><span class="token punctuation">:</span> <span class="token number">60000</span>  <span class="token comment"># 清理周期</span>
</code></pre>
    <p>
     <em>
      2.阈值计算公式：
     </em>
    </p>
    <p>
     触发条件 = (当前心跳总数 / 预期心跳数) &lt;renewal-percent-threshold
    </p>
    <p>
     预期心跳数 = 服务实例数 × (900秒 /lease-renewal-interval)
    </p>
    <p>
     <em>
      3.生产环境建议：
     </em>
    </p>
    <p>
     • 阈值调整：网络不稳定环境可降低至 0.75。
    </p>
    <p>
     • 告警集成：通过/actuator/metrics监控eureka.server.isSelfPreservationModeActive指标。
    </p>
    <p>
     • 紧急处理：保护模式下可手动调用/pause端点临时停止服务注册。
    </p>
    <p>
     <strong>
      3.3 健康检查与保护模式的联动机制
     </strong>
    </p>
    <p>
     综合工作流：
    </p>
    <pre><code class="prism language-bash">journey
    title 健康状态全生命周期管理
    section 正常状态
        心跳正常 --<span class="token operator">&gt;</span> 健康检查通过 --<span class="token operator">&gt;</span> 服务可用
    section 异常状态
        心跳丢失 --<span class="token operator">&gt;</span> 触发健康检查 --<span class="token operator">&gt;</span> 检查失败 --<span class="token operator">&gt;</span> 标记为DOWN
    section 网络抖动
        批量心跳丢失 --<span class="token operator">&gt;</span> 触发保护模式 --<span class="token operator">&gt;</span> 保留所有实例 --<span class="token operator">&gt;</span> 网络恢复后自动恢复
</code></pre>
    <p>
     最佳实践：
    </p>
    <p>
     <em>
      1.分级健康检查：
     </em>
    </p>
    <p>
     在application.yml中配置：
    </p>
    <pre><code class="prism language-yaml"><span class="token key atrule">management</span><span class="token punctuation">:</span>
  <span class="token key atrule">endpoint</span><span class="token punctuation">:</span>
    <span class="token key atrule">health</span><span class="token punctuation">:</span>
      <span class="token key atrule">group</span><span class="token punctuation">:</span>
        <span class="token key atrule">readiness</span><span class="token punctuation">:</span>
          <span class="token key atrule">include</span><span class="token punctuation">:</span> <span class="token string">"db,redis"</span>   <span class="token comment"># 就绪检查：检查依赖服务状态（启动时检查）</span>
        <span class="token key atrule">liveness</span><span class="token punctuation">:</span>
          <span class="token key atrule">include</span><span class="token punctuation">:</span> <span class="token string">"diskSpace,ping"</span>   <span class="token comment"># 存活检查：基础资源监控（每30秒）</span>
</code></pre>
    <p>
     • 存活检查（Liveness）：基础资源监控（每30秒）
    </p>
    <p>
     • 就绪检查（Readiness）：依赖服务状态（启动时检查）
    </p>
    <p>
     <em>
      2.保护模式优化策略：
     </em>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/506ee26202e547aba1f3ba7cff41ec09.png"/>
    </p>
    <p>
     通过健康检查与自我保护机制的协同工作，Eureka 能够实现：
    </p>
    <p>
     • 分钟级故障检测（通过 90秒心跳超时 + 健康检查）
    </p>
    <p>
     • 秒级异常隔离（保护模式即时触发）
    </p>
    <p>
     • 智能恢复机制（网络恢复后自动同步状态）
    </p>
    <h3>
     <a id="_437">
     </a>
     四、元数据定制：解锁高级治理能力
    </h3>
    <p>
     Eureka 支持向服务注册信息中附加元数据（Metadata ），如版本号、环境标识等。
    </p>
    <p>
     <strong>
      4.1 配置元数据 （Eureka Metadata）
     </strong>
    </p>
    <p>
     在 Eureka Client（微服务）的 application.yml中定义元数据：
    </p>
    <pre><code class="prism language-yaml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8081</span>  <span class="token comment"># 订单服务的端口</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> order<span class="token punctuation">-</span>service  <span class="token comment"># 微服务名称</span>

<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">register-with-eureka</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>   
    <span class="token key atrule">fetch-registry</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>         
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//eureka1<span class="token punctuation">:</span>8761/eureka/<span class="token punctuation">,</span>http<span class="token punctuation">:</span>//eureka2<span class="token punctuation">:</span>8762/eureka/

  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata-map</span><span class="token punctuation">:</span>  <span class="token comment"># 定义元数据</span>
      <span class="token key atrule">version</span><span class="token punctuation">:</span> v1.0.0   <span class="token comment"># 版本号</span>
      <span class="token key atrule">zone</span><span class="token punctuation">:</span> cn<span class="token punctuation">-</span>east<span class="token punctuation">-</span><span class="token number">1</span>   <span class="token comment"># 所在区域</span>
      <span class="token key atrule">priority</span><span class="token punctuation">:</span> high      <span class="token comment"># 路由优先级</span>
</code></pre>
    <p>
     <strong>
      4.2 读取元数据
     </strong>
    </p>
    <p>
     Eureka Client 可通过 InstanceInfo读取元数据：
    </p>
    <pre><code class="prism language-java"><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">DiscoveryClient</span> discoveryClient<span class="token punctuation">;</span> <span class="token comment">// 注入 Eureka 发现客户端，用于获取注册的服务信息</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">getServiceMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 获取指定服务 ("my-service") 的所有实例</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">&gt;</span></span> instances <span class="token operator">=</span> discoveryClient<span class="token punctuation">.</span><span class="token function">getInstances</span><span class="token punctuation">(</span><span class="token string">"my-service"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 遍历实例，打印每个实例的元数据</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ServiceInstance</span> instance <span class="token operator">:</span> instances<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Service Metadata: "</span> <span class="token operator">+</span> instance<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     解析：
    </p>
    <p>
     • @Autowired：自动注入DiscoveryClient，用于与 Eureka Server 交互。
    </p>
    <p>
     <strong>
      4.3 使用场景
     </strong>
    </p>
    <p>
     • 灰度发布：网关根据version路由流量。
    </p>
    <p>
     • 区域亲和：优先调用同region的实例，即分区（Zone）策略。
    </p>
    <p>
     • 负载策略：Ribbon负载均衡 按priority分配流量权重。
    </p>
    <h3>
     <a id="_498">
     </a>
     五、多区域部署：构建跨地域容灾体系
    </h3>
    <p>
     <strong>
      5.1 Zone 概念
     </strong>
    </p>
    <p>
     在跨区域部署的微服务架构中，不同区域（Zone）的服务需要相互发现。Eureka 允许微服务按区域注册，并优先发现同区域的实例。减少跨区域通信，降低延迟。
    </p>
    <p>
     Zone 表示服务所在的物理区域或数据中心。
    </p>
    <p>
     <strong>
      5.2 多区域配置
     </strong>
    </p>
    <p>
     <em>
      1.配置 Eureka Server
     </em>
    </p>
    <p>
     亚洲区域 Eureka Server 配置：
    </p>
    <pre><code class="prism language-yaml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8761</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> eureka<span class="token punctuation">-</span>server

<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> eureka<span class="token punctuation">-</span>asia1
    <span class="token key atrule">metadata-map</span><span class="token punctuation">:</span>
      <span class="token key atrule">zone</span><span class="token punctuation">:</span> zone<span class="token punctuation">-</span>asia  <span class="token comment"># 声明本 Eureka Server 处于 "zone-asia"</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">register-with-eureka</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token comment"># Eureka Server 不注册到自己</span>
    <span class="token key atrule">fetch-registry</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token comment"># Eureka Server 不拉取服务列表</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//eureka<span class="token punctuation">-</span>europe1<span class="token punctuation">:</span>8762/eureka  <span class="token comment"># 互相注册</span>
</code></pre>
    <p>
     欧洲区域 Eureka Server 配置：
    </p>
    <pre><code class="prism language-yaml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8762</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> eureka<span class="token punctuation">-</span>server

<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> eureka<span class="token punctuation">-</span>europe1
    <span class="token key atrule">metadata-map</span><span class="token punctuation">:</span>
      <span class="token key atrule">zone</span><span class="token punctuation">:</span> zone<span class="token punctuation">-</span>europe  <span class="token comment"># 声明本 Eureka Server 处于 "zone-europe"</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">register-with-eureka</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token key atrule">fetch-registry</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//eureka<span class="token punctuation">-</span>asia1<span class="token punctuation">:</span>8761/eureka  <span class="token comment"># 互相注册</span>
</code></pre>
    <p>
     关键点：
    </p>
    <p>
     • Eureka Server 声明自己的 Zone（metadata-map.zone），让 Eureka Client 能够感知区域信息。
    </p>
    <p>
     • 区域间 Eureka Server 互相注册构成集群，实现同步服务实例信息，实现高可用。
    </p>
    <p>
     <em>
      2.配置Eureka Client
     </em>
    </p>
    <p>
     Eureka Client（微服务）的application.yml配置：
    </p>
    <p>
     • 指定自身 Zone
    </p>
    <p>
     • 正确配置 Eureka Server 地址
    </p>
    <p>
     • 启用 prefer-same-zone-eureka 以优先访问本区域
    </p>
    <p>
     亚洲区域的服务配置：
    </p>
    <pre><code class="prism language-yaml"><span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata-map</span><span class="token punctuation">:</span>
      <span class="token key atrule">zone</span><span class="token punctuation">:</span> zone<span class="token punctuation">-</span>asia  <span class="token comment"># 声明当前微服务属于 "zone-asia"</span>

  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//eureka<span class="token punctuation">-</span>asia1<span class="token punctuation">:</span>8761/eureka<span class="token punctuation">,</span> http<span class="token punctuation">:</span>//eureka<span class="token punctuation">-</span>europe1<span class="token punctuation">:</span>8762/eureka
    <span class="token key atrule">prefer-same-zone-eureka</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token comment"># 优先访问同区域的 Eureka Server</span>
</code></pre>
    <p>
     欧洲区域的服务配置：
    </p>
    <pre><code class="prism language-yaml"><span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata-map</span><span class="token punctuation">:</span>
      <span class="token key atrule">zone</span><span class="token punctuation">:</span> zone<span class="token punctuation">-</span>europe  <span class="token comment"># 声明当前微服务属于 "zone-europe"</span>

  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//eureka<span class="token punctuation">-</span>europe1<span class="token punctuation">:</span>8762/eureka<span class="token punctuation">,</span> http<span class="token punctuation">:</span>//eureka<span class="token punctuation">-</span>asia1<span class="token punctuation">:</span>8761/eureka
    <span class="token key atrule">prefer-same-zone-eureka</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre>
    <p>
     关键点：
    </p>
    <p>
     1.Eureka Client 通过 metadata-map.zone 声明自身所在区域。
    </p>
    <p>
     2.service-url 配置了多个 Eureka Server 地址，确保跨区域发现。
    </p>
    <p>
     3.prefer-same-zone-eureka: true，Eureka Client优先注册和发现本区域的 Eureka Server，仅在同区域不可用时才会跨区域访问。
    </p>
    <p>
     <strong>
      5.3 跨区域故障转移
     </strong>
    </p>
    <pre><code class="prism language-bash">graph LR
    User<span class="token punctuation">[</span>Asia 客户端<span class="token punctuation">]</span> --<span class="token operator">&gt;|</span>首选<span class="token operator">|</span> Asia<span class="token punctuation">[</span>亚洲区服务<span class="token punctuation">]</span>
    Asia<span class="token operator">|</span>故障<span class="token operator">|</span>  --<span class="token operator">&gt;</span> Europe<span class="token punctuation">[</span>欧洲区服务<span class="token punctuation">]</span>
</code></pre>
    <p>
     <em>
      <strong>
       容灾策略
      </strong>
     </em>
    </p>
    <p>
     自动切换：当同区域实例不可用时，系统自动切换至其他区域。
    </p>
    <p>
     故障告警：当响应时间异常增加时，触发区域切换告警。
    </p>
    <h3>
     <a id="_621">
     </a>
     六、总结
    </h3>
    <p>
     6.1 核心要点总结
    </p>
    <p>
     服务治理核心：
    </p>
    <p>
     • 基于注册、心跳、动态发现机制，支撑微服务自动化通信与负载均衡。
    </p>
    <p>
     高可用与容错：
    </p>
    <p>
     • 去中心化集群（Peer Awareness）避免单点故障。
    </p>
    <p>
     • 健康检查精准剔除异常实例，自我保护模式防止误删健康节点。
    </p>
    <p>
     高级能力扩展：
    </p>
    <p>
     • 元数据定制（版本/区域）支持灰度发布与区域亲和路由。
    </p>
    <p>
     • 多 Zone 部署实现跨机房容灾与低延迟调度。
    </p>
    <p>
     生产级实践：
    </p>
    <p>
     • HTTPS 加密、Basic 认证、跨区域健康监控，确保安全与稳定性。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f34363631393630352f:61727469636c652f64657461696c732f313436323631353038" class_="artid" style="display:none">
 </p>
</div>


