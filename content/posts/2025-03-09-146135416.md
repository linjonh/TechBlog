---
layout: post
title: "量化交易笔记15.因子的来源和生成"
date: 2025-03-09 21:24:42 +0800
description: "现在市场上很多基金，特别是量化的基金，多带有“多因子”配置，策略等，这些基金策略实际上与之前《13.实盘交易策略制定与实施》是一致的，在量化交易，因子作为交易的基础（数据源），起着重要作用。从本文开始，从最简单的一个因子开始，讲解产生、使用、作用和检验，本文就这些因子是如何产生的，来做一个详细说明。"
keywords: "【量化交易笔记】15.因子的来源和生成"
categories: ['量化交易']
tags: ['笔记', '机器学习']
artid: "146135416"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146135416
    alt: "量化交易笔记15.因子的来源和生成"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146135416
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146135416
cover: https://bing.ee123.net/img/rand?artid=146135416
image: https://bing.ee123.net/img/rand?artid=146135416
img: https://bing.ee123.net/img/rand?artid=146135416
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     【量化交易笔记】15.因子的来源和生成
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="./../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="./../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h3>
     <a id="_0">
     </a>
     前言
    </h3>
    <p>
     现在市场上很多基金，特别是量化的基金，多带有“多因子”配置，策略等，这些基金策略实际上与之前《
     <a href="https://blog.csdn.net/cndrip/article/details/135179262">
      13.实盘交易策略制定与实施
     </a>
     》是一致的，在量化交易，因子作为交易的基础（数据源），起着重要作用。从本文开始，从最简单的一个因子开始，讲解产生、使用、作用和检验，本文就这些因子是如何产生的，来做一个详细说明。
    </p>
    <h3>
     <a id="_3">
     </a>
     获取数据
    </h3>
    <p>
     为了获取数据方便，直接使用量化平台的数据，国内开放的量化平台有聚宽、果仁、‌米筐、‌优矿等，我这里有使用的是“聚宽”平台。
    </p>
    <p>
     小伙伴们有这样的一个认知：“某日该股票价格上涨，且主力资金净流入的话，次日股价，可能上涨；否则下跌”，因此暂以资金流入/流出数据做为因子，进行实验验证，现以招商银行（600036）为例。
    </p>
    <pre><code class="prism language-python"><span class="token comment">#导入jqdata的全部函数</span>
<span class="token keyword">from</span> jqdata <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment">#使用get_money_flow函数获取</span>
df <span class="token operator">=</span> get_money_flow<span class="token punctuation">(</span><span class="token string">'600036.XSHG'</span><span class="token punctuation">,</span>
                    fields <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'date'</span><span class="token punctuation">,</span>
                             <span class="token comment">#股票代码</span>
                           <span class="token string">'sec_code'</span><span class="token punctuation">,</span>
                             <span class="token comment">#涨跌幅</span>
                           <span class="token string">'change_pct'</span><span class="token punctuation">,</span>
                             <span class="token comment">#主力金额，包括超大单和大单</span>
                           <span class="token string">'net_amount_main'</span><span class="token punctuation">,</span>
                             <span class="token comment">#主力成交额占总成交额的比例</span>
                           <span class="token string">'net_pct_main'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token comment">#设置好起止日期</span>
                    start_date <span class="token operator">=</span> <span class="token string">'2023-03-09'</span><span class="token punctuation">,</span>
                    end_date <span class="token operator">=</span> <span class="token string">'2025-03-09'</span><span class="token punctuation">)</span>
<span class="token comment">#查看数据</span>
df<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
    <table>
     <thead>
      <tr>
       <th>
        -
       </th>
       <th>
        date
       </th>
       <th>
        sec_code
       </th>
       <th>
        change_pct
       </th>
       <th>
        net_amount_main
       </th>
       <th>
        net_pct_main
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        0
       </td>
       <td>
        2023-03-09
       </td>
       <td>
        600036.XSHG
       </td>
       <td>
        -1.17
       </td>
       <td>
        -18056.3680
       </td>
       <td>
        -9.3621
       </td>
      </tr>
      <tr>
       <td>
        1
       </td>
       <td>
        2023-03-10
       </td>
       <td>
        600036.XSHG
       </td>
       <td>
        -1.55
       </td>
       <td>
        -30406.6513
       </td>
       <td>
        -15.4844
       </td>
      </tr>
      <tr>
       <td>
        2
       </td>
       <td>
        2023-03-13
       </td>
       <td>
        600036.XSHG
       </td>
       <td>
        0.06
       </td>
       <td>
        -6289.9216
       </td>
       <td>
        -3.0741
       </td>
      </tr>
      <tr>
       <td>
        3
       </td>
       <td>
        2023-03-14
       </td>
       <td>
        600036.XSHG
       </td>
       <td>
        -1.34
       </td>
       <td>
        -28301.3136
       </td>
       <td>
        -13.0485
       </td>
      </tr>
      <tr>
       <td>
        4
       </td>
       <td>
        2023-03-15
       </td>
       <td>
        600036.XSHG
       </td>
       <td>
        0.87
       </td>
       <td>
        -21240.4128
       </td>
       <td>
        -8.9221
       </td>
      </tr>
     </tbody>
    </table>
    <h3>
     <a id="_37">
     </a>
     特征工程
    </h3>
    <p>
     给这个的数据增加两个新的字段，其中一个是up_or_down，用来表示当日股价是上涨还是下跌。如果change_pct(涨幅)这个字段为正数，说明股价上涨，则up_or_down用1来表示，反之，用0表示，代表当日股价下跌。
     <br/>
     类似地，我们用money_in_out字段表示主力资金净流入还是净流出。如果net_amount_main大于0，说明主力资金净流入，则在money_in_out字段用1表示:反之说明主力资金净流出，money_in_out字段用0表示。示例代码如下:
    </p>
    <pre><code class="prism language-python"><span class="token comment">#增加一个字段，记录股价上涨还是下跌</span>
<span class="token comment">#如果股价上涨，则以1标记，否则以0标记</span>
df<span class="token punctuation">[</span><span class="token string">'up_or_down'</span><span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>where<span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'change_pct'</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token comment">#在增加一个字段，记录主力资金净流入还是流出</span>
<span class="token comment">#如果净流入，标记为1，否则标记为0</span>
df<span class="token punctuation">[</span><span class="token string">'money_in_out'</span><span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>where<span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'net_amount_main'</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token comment">#检查是否成功</span>
df<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
    <table>
     <thead>
      <tr>
       <th>
        -
       </th>
       <th>
        date
       </th>
       <th>
        sec_code
       </th>
       <th>
        change_pct
       </th>
       <th>
        net_amount_main
       </th>
       <th>
        net_pct_main
       </th>
       <th>
        up_or_down
       </th>
       <th>
        money_in_out
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        0
       </td>
       <td>
        2023-03-09
       </td>
       <td>
        600036.XSHG
       </td>
       <td>
        -1.17
       </td>
       <td>
        -18056.3680
       </td>
       <td>
        -9.3621
       </td>
       <td>
        0
       </td>
       <td>
        0
       </td>
      </tr>
      <tr>
       <td>
        1
       </td>
       <td>
        2023-03-10
       </td>
       <td>
        600036.XSHG
       </td>
       <td>
        -1.55
       </td>
       <td>
        -30406.6513
       </td>
       <td>
        -15.4844
       </td>
       <td>
        0
       </td>
       <td>
        0
       </td>
      </tr>
      <tr>
       <td>
        2
       </td>
       <td>
        2023-03-13
       </td>
       <td>
        600036.XSHG
       </td>
       <td>
        0.06
       </td>
       <td>
        -6289.9216
       </td>
       <td>
        -3.0741
       </td>
       <td>
        1
       </td>
       <td>
        0
       </td>
      </tr>
      <tr>
       <td>
        3
       </td>
       <td>
        2023-03-14
       </td>
       <td>
        600036.XSHG
       </td>
       <td>
        -1.34
       </td>
       <td>
        -28301.3136
       </td>
       <td>
        -13.0485
       </td>
       <td>
        0
       </td>
       <td>
        0
       </td>
      </tr>
      <tr>
       <td>
        4
       </td>
       <td>
        2023-03-15
       </td>
       <td>
        600036.XSHG
       </td>
       <td>
        0.87
       </td>
       <td>
        -21240.4128
       </td>
       <td>
        -8.9221
       </td>
       <td>
        1
       </td>
       <td>
        0
       </td>
      </tr>
     </tbody>
    </table>
    <h3>
     <a id="_59">
     </a>
     计算
    </h3>
    <p>
     现在我们有了两个新的特征，能够体现股价的涨跌和主力资金的流入/流出情况，下面就可以用这两个新的特征来计算“瓦氏因子”了，咱们先说说思路，如果我们把两个特征相乘，则当股价上涨，且主力资金净流入时，因子值就是up_or_down 乘以 money_in_ out，也就是1X1，结果是1；而其他情况，“瓦氏因子”的数值都为0。例如，股价下跌但主力资金净流入，“瓦氏因子”为0x1，结果为0。同时，为了后面便于模型训练，我们还要做一个标签(即次日股票上涨还是下跌)，存储在next_day 字段中。代码如下:
    </p>
    <pre><code class="prism language-python"><span class="token comment">#瓦氏因子来了，用两个自增的字段相乘，得出因子值</span>
df<span class="token punctuation">[</span><span class="token string">'factor_wa'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'up_or_down'</span><span class="token punctuation">]</span> <span class="token operator">*</span> df<span class="token punctuation">[</span><span class="token string">'money_in_out'</span><span class="token punctuation">]</span>
<span class="token comment">#再把次日涨跌作为预测标签存储到‘next_day’字段</span>
df<span class="token punctuation">[</span><span class="token string">'next_day'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'up_or_down'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>shift<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment">#检查是否成功</span>
df<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
    <table>
     <thead>
      <tr>
       <th>
        -
       </th>
       <th>
        date
       </th>
       <th>
        sec_code
       </th>
       <th>
        change_pct
       </th>
       <th>
        net_amount_main
       </th>
       <th>
        net_pct_main
       </th>
       <th>
        up_or_down
       </th>
       <th>
        money_in_out
       </th>
       <th>
        factor_wa
       </th>
       <th>
        next_day
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        0
       </td>
       <td>
        2023-03-09
       </td>
       <td>
        600036.XSHG
       </td>
       <td>
        -1.17
       </td>
       <td>
        -18056.3680
       </td>
       <td>
        -9.3621
       </td>
       <td>
        0
       </td>
       <td>
        0
       </td>
       <td>
        0
       </td>
       <td>
        0.0
       </td>
      </tr>
      <tr>
       <td>
        1
       </td>
       <td>
        2023-03-10
       </td>
       <td>
        600036.XSHG
       </td>
       <td>
        -1.55
       </td>
       <td>
        -30406.6513
       </td>
       <td>
        -15.4844
       </td>
       <td>
        0
       </td>
       <td>
        0
       </td>
       <td>
        0
       </td>
       <td>
        1.0
       </td>
      </tr>
      <tr>
       <td>
        2
       </td>
       <td>
        2023-03-13
       </td>
       <td>
        600036.XSHG
       </td>
       <td>
        0.06
       </td>
       <td>
        -6289.9216
       </td>
       <td>
        -3.0741
       </td>
       <td>
        1
       </td>
       <td>
        0
       </td>
       <td>
        0
       </td>
       <td>
        0.0
       </td>
      </tr>
      <tr>
       <td>
        3
       </td>
       <td>
        2023-03-14
       </td>
       <td>
        600036.XSHG
       </td>
       <td>
        -1.34
       </td>
       <td>
        -28301.3136
       </td>
       <td>
        -13.0485
       </td>
       <td>
        0
       </td>
       <td>
        0
       </td>
       <td>
        0
       </td>
       <td>
        1.0
       </td>
      </tr>
      <tr>
       <td>
        4
       </td>
       <td>
        2023-03-15
       </td>
       <td>
        600036.XSHG
       </td>
       <td>
        0.87
       </td>
       <td>
        -21240.4128
       </td>
       <td>
        -8.9221
       </td>
       <td>
        1
       </td>
       <td>
        0
       </td>
       <td>
        0
       </td>
       <td>
        0.0
       </td>
      </tr>
     </tbody>
    </table>
    <h3>
     <a id="_79">
     </a>
     准备训练
    </h3>
    <pre><code class="prism language-python"><span class="token comment">#还是请出已经熟悉的KNN算法</span>
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>neighbors <span class="token keyword">import</span> KNeighborsClassifier
<span class="token comment">#导入数据集拆分工具</span>
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>model_selection <span class="token keyword">import</span> train_test_split
<span class="token comment">#当然还需要有pandas</span>
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token comment">#数据集中把日期、股票代码，以及我们添加的特征去掉</span>
dataset <span class="token operator">=</span> df<span class="token punctuation">.</span>drop<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'date'</span><span class="token punctuation">,</span> 
                   <span class="token string">'sec_code'</span><span class="token punctuation">,</span>
                   <span class="token string">'up_or_down'</span><span class="token punctuation">,</span>
                   <span class="token string">'money_in_out'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                  axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment">#检查是否成功</span>
dataset<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
    <table>
     <thead>
      <tr>
       <th>
        -
       </th>
       <th>
        change_pct
       </th>
       <th>
        net_amount_main
       </th>
       <th>
        net_pct_main
       </th>
       <th>
        factor_wa
       </th>
       <th>
        next_day
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        0
       </td>
       <td>
        -1.17
       </td>
       <td>
        -18056.3680
       </td>
       <td>
        -9.3621
       </td>
       <td>
        0
       </td>
       <td>
        0.0
       </td>
      </tr>
      <tr>
       <td>
        1
       </td>
       <td>
        -1.55
       </td>
       <td>
        -30406.6513
       </td>
       <td>
        -15.4844
       </td>
       <td>
        0
       </td>
       <td>
        1.0
       </td>
      </tr>
      <tr>
       <td>
        2
       </td>
       <td>
        0.06
       </td>
       <td>
        -6289.9216
       </td>
       <td>
        -3.0741
       </td>
       <td>
        0
       </td>
       <td>
        0.0
       </td>
      </tr>
      <tr>
       <td>
        3
       </td>
       <td>
        -1.34
       </td>
       <td>
        -28301.3136
       </td>
       <td>
        -13.0485
       </td>
       <td>
        0
       </td>
       <td>
        1.0
       </td>
      </tr>
      <tr>
       <td>
        4
       </td>
       <td>
        0.87
       </td>
       <td>
        -21240.4128
       </td>
       <td>
        -8.9221
       </td>
       <td>
        0
       </td>
       <td>
        0.0
       </td>
      </tr>
     </tbody>
    </table>
    <pre><code class="prism language-python"><span class="token comment">#将‘next_day’以外的字段，作为数据集的特征</span>
X <span class="token operator">=</span> dataset<span class="token punctuation">.</span>drop<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'next_day'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token comment">#将‘next_day’作为数据集的标签</span>
y <span class="token operator">=</span> dataset<span class="token punctuation">[</span><span class="token string">'next_day'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token comment">#将数据集拆分为训练集与验证集</span>
X_train<span class="token punctuation">,</span> X_test<span class="token punctuation">,</span> y_train<span class="token punctuation">,</span> y_test <span class="token operator">=</span>\
train_test_split<span class="token punctuation">(</span>X<span class="token punctuation">,</span> y<span class="token punctuation">,</span> random_state <span class="token operator">=</span> <span class="token number">574</span><span class="token punctuation">)</span>
</code></pre>
    <pre><code class="prism language-python"><span class="token comment">#创建KNN分类器，n_neighbors参数依然取95</span>
knn <span class="token operator">=</span> KNeighborsClassifier<span class="token punctuation">(</span>n_neighbors<span class="token operator">=</span><span class="token number">95</span><span class="token punctuation">)</span>
<span class="token comment">#使用训练集训练模型</span>
knn<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>X_train<span class="token punctuation">,</span> y_train<span class="token punctuation">)</span>
<span class="token comment">#打印训练集中模型准确率</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>knn<span class="token punctuation">.</span>score<span class="token punctuation">(</span>X_train<span class="token punctuation">,</span> y_train<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">#打印验证集中模型准确率</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>knn<span class="token punctuation">.</span>score<span class="token punctuation">(</span>X_test<span class="token punctuation">,</span>y_test<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     0.5429362880886427
     <br/>
     0.49586776859504134
    </p>
    <h3>
     <a id="_128">
     </a>
     小结
    </h3>
    <p>
     这里的结果并不是很理想，准确率只有0.4958% 与盲猜并不多，不过没关系，咱简单的用了几个因子，进行了建模，而实际因子有上百个，甚至上千个，这些因子怎么来帮助我们的选择股票呢，这个需要选择标的问题，而不是上面的仅仅对一支股票进行分析，而对一类股票进行分析，选择分数高的，或排名前的股票进行投资。
    </p>
    <p>
     在聚宽平台上有专用的因子库，来获取相应的因子值。
    </p>
    <h3>
     <a id="_133">
     </a>
     选择标的
    </h3>
    <p>
     思路是选超大盘股，净利润率高，且高速成长的
     <br/>
     <code>
      get_all_securities
     </code>
     查询到全部指数
    </p>
    <pre><code class="prism language-python"><span class="token comment">#指定get_all_securities的types参数为index</span>
<span class="token comment">#即可查询全部指数</span>
indices <span class="token operator">=</span> get_all_securities<span class="token punctuation">(</span>types<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'index'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment">#查看前二十条结果</span>
indices<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
</code></pre>
    <table>
     <thead>
      <tr>
       <th>
        -
       </th>
       <th>
        display_name
       </th>
       <th>
        name
       </th>
       <th>
        start_date
       </th>
       <th>
        end_date
       </th>
       <th>
        type
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        000001.XSHG
       </td>
       <td>
        上证指数
       </td>
       <td>
        SZZS
       </td>
       <td>
        1991-07-15
       </td>
       <td>
        2200-01-01
       </td>
       <td>
        index
       </td>
      </tr>
      <tr>
       <td>
        000002.XSHG
       </td>
       <td>
        A股指数
       </td>
       <td>
        AGZS
       </td>
       <td>
        1992-02-21
       </td>
       <td>
        2200-01-01
       </td>
       <td>
        index
       </td>
      </tr>
      <tr>
       <td>
        000003.XSHG
       </td>
       <td>
        B股指数
       </td>
       <td>
        BGZS
       </td>
       <td>
        1992-02-21
       </td>
       <td>
        2200-01-01
       </td>
       <td>
        index
       </td>
      </tr>
      <tr>
       <td>
        000004.XSHG
       </td>
       <td>
        工业指数
       </td>
       <td>
        GYZS
       </td>
       <td>
        1993-05-03
       </td>
       <td>
        2200-01-01
       </td>
       <td>
        index
       </td>
      </tr>
      <tr>
       <td>
        000005.XSHG
       </td>
       <td>
        商业指数
       </td>
       <td>
        SYZS
       </td>
       <td>
        1993-05-03
       </td>
       <td>
        2200-01-01
       </td>
       <td>
        index
       </td>
      </tr>
      <tr>
       <td>
        000006.XSHG
       </td>
       <td>
        地产指数
       </td>
       <td>
        DCZS
       </td>
       <td>
        1993-05-03
       </td>
       <td>
        2200-01-01
       </td>
       <td>
        index
       </td>
      </tr>
      <tr>
       <td>
        000007.XSHG
       </td>
       <td>
        公用指数
       </td>
       <td>
        GYZS
       </td>
       <td>
        1993-05-03
       </td>
       <td>
        2200-01-01
       </td>
       <td>
        index
       </td>
      </tr>
      <tr>
       <td>
        000008.XSHG
       </td>
       <td>
        综合指数
       </td>
       <td>
        ZHZS
       </td>
       <td>
        1993-05-03
       </td>
       <td>
        2200-01-01
       </td>
       <td>
        index
       </td>
      </tr>
      <tr>
       <td>
        000009.XSHG
       </td>
       <td>
        上证380
       </td>
       <td>
        SZ380
       </td>
       <td>
        2010-11-29
       </td>
       <td>
        2200-01-01
       </td>
       <td>
        index
       </td>
      </tr>
      <tr>
       <td>
        000010.XSHG
       </td>
       <td>
        上证180
       </td>
       <td>
        SZ180
       </td>
       <td>
        2002-07-01
       </td>
       <td>
        2200-01-01
       </td>
       <td>
        index
       </td>
      </tr>
      <tr>
       <td>
        000011.XSHG
       </td>
       <td>
        基金指数
       </td>
       <td>
        JJZS
       </td>
       <td>
        2000-06-09
       </td>
       <td>
        2200-01-01
       </td>
       <td>
        index
       </td>
      </tr>
      <tr>
       <td>
        000012.XSHG
       </td>
       <td>
        国债指数
       </td>
       <td>
        GZZS
       </td>
       <td>
        2003-01-02
       </td>
       <td>
        2200-01-01
       </td>
       <td>
        index
       </td>
      </tr>
      <tr>
       <td>
        000013.XSHG
       </td>
       <td>
        上证企业债指数
       </td>
       <td>
        QZZS
       </td>
       <td>
        2003-06-09
       </td>
       <td>
        2200-01-01
       </td>
       <td>
        index
       </td>
      </tr>
      <tr>
       <td>
        000015.XSHG
       </td>
       <td>
        红利指数
       </td>
       <td>
        HLZS
       </td>
       <td>
        2005-01-04
       </td>
       <td>
        2200-01-01
       </td>
       <td>
        index
       </td>
      </tr>
      <tr>
       <td>
        000016.XSHG
       </td>
       <td>
        上证50
       </td>
       <td>
        SZ50
       </td>
       <td>
        2004-01-02
       </td>
       <td>
        2200-01-01
       </td>
       <td>
        index
       </td>
      </tr>
      <tr>
       <td>
        000017.XSHG
       </td>
       <td>
        新综指
       </td>
       <td>
        XZZ
       </td>
       <td>
        2006-01-04
       </td>
       <td>
        2200-01-01
       </td>
       <td>
        index
       </td>
      </tr>
      <tr>
       <td>
        000018.XSHG
       </td>
       <td>
        180金融
       </td>
       <td>
        180JR
       </td>
       <td>
        2007-12-10
       </td>
       <td>
        2200-01-01
       </td>
       <td>
        index
       </td>
      </tr>
      <tr>
       <td>
        000019.XSHG
       </td>
       <td>
        治理指数
       </td>
       <td>
        ZLZS
       </td>
       <td>
        2008-01-02
       </td>
       <td>
        2200-01-01
       </td>
       <td>
        index
       </td>
      </tr>
      <tr>
       <td>
        000020.XSHG
       </td>
       <td>
        中型综指
       </td>
       <td>
        ZXZZ
       </td>
       <td>
        2008-05-12
       </td>
       <td>
        2200-01-01
       </td>
       <td>
        index
       </td>
      </tr>
      <tr>
       <td>
        000021.XSHG
       </td>
       <td>
        180治理
       </td>
       <td>
        180ZL
       </td>
       <td>
        2008-09-10
       </td>
       <td>
        2200-01-01
       </td>
       <td>
        index
       </td>
      </tr>
     </tbody>
    </table>
    <ul>
     <li>
      获取市值因子
     </li>
    </ul>
    <pre><code class="prism language-python"><span class="token comment">#这里需要导入聚宽因子库的get_factor_values函数</span>
<span class="token keyword">from</span> jqfactor <span class="token keyword">import</span> get_factor_values
<span class="token comment">#导入聚宽的因子分析库</span>
<span class="token keyword">from</span> jqfactor <span class="token keyword">import</span> analyze_factor
<span class="token comment">#使用get_factor_values函数获取沪深300成分股的市值</span>
factor_mc<span class="token operator">=</span>get_factor_values<span class="token punctuation">(</span>securities<span class="token operator">=</span>get_index_stocks<span class="token punctuation">(</span><span class="token string">'000300.XSHG'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> factors<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'market_cap'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                  end_date<span class="token operator">=</span><span class="token string">'2025-03-09'</span><span class="token punctuation">,</span>count<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'market_cap'</span><span class="token punctuation">]</span>
<span class="token comment">#检查结果</span>
factor_mc<span class="token punctuation">.</span>T<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
    <table>
     <thead>
      <tr>
       <th>
        code
       </th>
       <th>
        2025-03-07 00:00:00
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        000001.XSHE
       </td>
       <td>
        2.264671e+11
       </td>
      </tr>
      <tr>
       <td>
        000002.XSHE
       </td>
       <td>
        8.983824e+10
       </td>
      </tr>
      <tr>
       <td>
        000063.XSHE
       </td>
       <td>
        1.783780e+11
       </td>
      </tr>
      <tr>
       <td>
        000100.XSHE
       </td>
       <td>
        8.957622e+10
       </td>
      </tr>
      <tr>
       <td>
        000157.XSHE
       </td>
       <td>
        7.185378e+10
       </td>
      </tr>
     </tbody>
    </table>
    <ul>
     <li>
      获取现金流因子
     </li>
     <li>
      获取净利率因子
     </li>
     <li>
      获取净利润增长因子
     </li>
    </ul>
    <pre><code class="prism language-python"><span class="token comment">#get_factor_values中</span>
<span class="token comment">#factors参数传入cash_flow_to_price_ratio</span>
<span class="token comment">#即可获得市现率的倒数</span>
factor_cfp <span class="token operator">=</span> get_factor_values<span class="token punctuation">(</span>securities <span class="token operator">=</span> get_index_stocks<span class="token punctuation">(</span><span class="token string">'000300.XSHG'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                           factors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'cash_flow_to_price_ratio'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                              end_date <span class="token operator">=</span> <span class="token string">'2025-03-09'</span><span class="token punctuation">,</span>
                              count <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'cash_flow_to_price_ratio'</span><span class="token punctuation">]</span>
<span class="token comment">#使用net_profit_ratio作为factors参数</span>
<span class="token comment">#即可查询到企业的净利润率</span>
factor_npr <span class="token operator">=</span> get_factor_values<span class="token punctuation">(</span>securities <span class="token operator">=</span> get_index_stocks<span class="token punctuation">(</span><span class="token string">'000300.XSHG'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                              factors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'net_profit_ratio'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                              end_date <span class="token operator">=</span> <span class="token string">'2025-03-09'</span><span class="token punctuation">,</span>
                              count <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'net_profit_ratio'</span><span class="token punctuation">]</span>
<span class="token comment">#使用net_profit_growth_rate作为factors参数</span>
<span class="token comment">#即可查询到企业的净利润增长率</span>
factor_npgr <span class="token operator">=</span> get_factor_values<span class="token punctuation">(</span>securities <span class="token operator">=</span> get_index_stocks<span class="token punctuation">(</span><span class="token string">'000300.XSHG'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                               factors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'net_profit_growth_rate'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                               end_date <span class="token operator">=</span> <span class="token string">'2025-03-09'</span><span class="token punctuation">,</span>
                               count <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'net_profit_growth_rate'</span><span class="token punctuation">]</span>
</code></pre>
    <h3>
     <a id="_214">
     </a>
     因子打包
    </h3>
    <p>
     将获取的因子打包成一个dataframe
    </p>
    <pre><code class="prism language-python"><span class="token comment">#新建一个DataFrame，和前面市值数据保持同样的序号</span>
factors <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>index <span class="token operator">=</span> factor_mc<span class="token punctuation">.</span>T<span class="token punctuation">.</span>index<span class="token punctuation">)</span>
<span class="token comment">#在新的DataFrame中创建4个字段</span>
<span class="token comment">#分别把市值、市现率倒数、净利润率、净利润增长率存储到其中</span>
factors<span class="token punctuation">[</span><span class="token string">'mc'</span><span class="token punctuation">]</span> <span class="token operator">=</span> factor_mc<span class="token punctuation">.</span>T<span class="token punctuation">[</span><span class="token string">'2025-03-07 00:00:00'</span><span class="token punctuation">]</span>
factors<span class="token punctuation">[</span><span class="token string">'cfp'</span><span class="token punctuation">]</span> <span class="token operator">=</span> factor_cfp<span class="token punctuation">.</span>T<span class="token punctuation">[</span><span class="token string">'2025-03-07 00:00:00'</span><span class="token punctuation">]</span>
factors<span class="token punctuation">[</span><span class="token string">'npr'</span><span class="token punctuation">]</span> <span class="token operator">=</span> factor_npr<span class="token punctuation">.</span>T<span class="token punctuation">[</span><span class="token string">'2025-03-07 00:00:00'</span><span class="token punctuation">]</span>
factors<span class="token punctuation">[</span><span class="token string">'npgr'</span><span class="token punctuation">]</span> <span class="token operator">=</span> factor_npgr<span class="token punctuation">.</span>T<span class="token punctuation">[</span><span class="token string">'2025-03-07 00:00:00'</span><span class="token punctuation">]</span>
<span class="token comment">#检查结果</span>
factors<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
    <table>
     <thead>
      <tr>
       <th>
        code
       </th>
       <th>
        mc
       </th>
       <th>
        cfp
       </th>
       <th>
        npr
       </th>
       <th>
        npgr
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        000001.XSHE
       </td>
       <td>
        2.264671e+11
       </td>
       <td>
        -0.097157
       </td>
       <td>
        0.313151
       </td>
       <td>
        -0.040068
       </td>
      </tr>
      <tr>
       <td>
        000002.XSHE
       </td>
       <td>
        8.983824e+10
       </td>
       <td>
        -0.266219
       </td>
       <td>
        -0.042926
       </td>
       <td>
        -1.541587
       </td>
      </tr>
      <tr>
       <td>
        000063.XSHE
       </td>
       <td>
        1.783780e+11
       </td>
       <td>
        -0.128866
       </td>
       <td>
        0.068885
       </td>
       <td>
        -0.095796
       </td>
      </tr>
      <tr>
       <td>
        000100.XSHE
       </td>
       <td>
        8.957622e+10
       </td>
       <td>
        -0.065272
       </td>
       <td>
        -0.015927
       </td>
       <td>
        -1.484159
       </td>
      </tr>
      <tr>
       <td>
        000157.XSHE
       </td>
       <td>
        7.185378e+10
       </td>
       <td>
        -0.009582
       </td>
       <td>
        0.091424
       </td>
       <td>
        0.299958
       </td>
      </tr>
     </tbody>
    </table>
    <h3>
     <a id="_236">
     </a>
     处理缺失值
    </h3>
    <pre><code class="prism language-python"><span class="token comment">#为了计算，先把数据中的空值去掉</span>
factors <span class="token operator">=</span> factors<span class="token punctuation">.</span>dropna<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">#检查下是否还有空值</span>
factors<span class="token punctuation">.</span>isnull<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
    <h3>
     <a id="_243">
     </a>
     标准化、降维
    </h3>
    <p>
     由于市值数据值特别大，会直接影响结果，因此需要进行标准化
    </p>
    <pre><code class="prism language-python"><span class="token comment">#因为各因子数值的量纲差异较大</span>
<span class="token comment">#需要做一点简单的缩放处理</span>
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>preprocessing <span class="token keyword">import</span> StandardScaler
<span class="token comment">#导入scikit-learn中的PCA主成分分析工具</span>
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>decomposition <span class="token keyword">import</span> PCA
<span class="token comment">#创建StandardScaler实例，会将数据量纲压缩到同一个区间中</span>
scaler <span class="token operator">=</span> StandardScaler<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">#使用StandardScaler缩放原始的因子值</span>
factors_scl <span class="token operator">=</span> scaler<span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>factors<span class="token punctuation">)</span>
<span class="token comment">#接下来使用PCA，提取主成分数量指定为1</span>
pca <span class="token operator">=</span> PCA<span class="token punctuation">(</span>n_components <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment">#使用缩放后的数据进行拟合</span>
pca<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>factors_scl<span class="token punctuation">)</span>
<span class="token comment">#查看pca给各因子分配的权重</span>
pca<span class="token punctuation">.</span>components_
</code></pre>
    <p>
     array([[0.17034834509272317, 0.6941037872659619, 0.6899014299868211,
     <br/>
     0.11505386012367508]])
     <br/>
     最后生成的pca降成一维的值，简单的说，这一列就代表前面4列因子的值
    </p>
    <pre><code class="prism language-python"><span class="token comment">#在factors数据表中添加一个pca字段</span>
<span class="token comment">#存储提取出来的主成分</span>
factors<span class="token punctuation">[</span><span class="token string">'pca'</span><span class="token punctuation">]</span> <span class="token operator">=</span> pca<span class="token punctuation">.</span>transform<span class="token punctuation">(</span>factors_scl<span class="token punctuation">)</span>
<span class="token comment">#看一下主成分数值最高的5只股票</span>
factors<span class="token punctuation">.</span>sort_values<span class="token punctuation">(</span>by<span class="token operator">=</span><span class="token string">'pca'</span><span class="token punctuation">,</span> ascending <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
</code></pre>
    <table>
     <thead>
      <tr>
       <th>
        code
       </th>
       <th>
        mc
       </th>
       <th>
        cfp
       </th>
       <th>
        npr
       </th>
       <th>
        npgr
       </th>
       <th>
        pca
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        000617.XSHE
       </td>
       <td>
        8.204709e+10
       </td>
       <td>
        0.566187
       </td>
       <td>
        12.261549
       </td>
       <td>
        -0.081553
       </td>
       <td>
        13.831990
       </td>
      </tr>
      <tr>
       <td>
        600000.XSHG
       </td>
       <td>
        2.976311e+11
       </td>
       <td>
        0.819269
       </td>
       <td>
        0.261202
       </td>
       <td>
        0.128075
       </td>
       <td>
        4.400846
       </td>
      </tr>
      <tr>
       <td>
        601916.XSHG
       </td>
       <td>
        7.827421e+10
       </td>
       <td>
        0.839137
       </td>
       <td>
        0.236163
       </td>
       <td>
        0.028149
       </td>
       <td>
        4.366769
       </td>
      </tr>
      <tr>
       <td>
        000166.XSHE
       </td>
       <td>
        1.272029e+11
       </td>
       <td>
        0.607792
       </td>
       <td>
        0.228119
       </td>
       <td>
        0.431598
       </td>
       <td>
        3.164233
       </td>
      </tr>
      <tr>
       <td>
        600015.XSHG
       </td>
       <td>
        1.142692e+11
       </td>
       <td>
        0.588408
       </td>
       <td>
        0.293962
       </td>
       <td>
        0.038419
       </td>
       <td>
        3.094389
       </td>
      </tr>
      <tr>
       <td>
        300059.XSHE
       </td>
       <td>
        3.695396e+11
       </td>
       <td>
        0.169345
       </td>
       <td>
        2.618757
       </td>
       <td>
        -0.012045
       </td>
       <td>
        3.090468
       </td>
      </tr>
      <tr>
       <td>
        601169.XSHG
       </td>
       <td>
        1.241093e+11
       </td>
       <td>
        0.563349
       </td>
       <td>
        0.379436
       </td>
       <td>
        0.012187
       </td>
       <td>
        3.041558
       </td>
      </tr>
      <tr>
       <td>
        600674.XSHG
       </td>
       <td>
        7.316785e+10
       </td>
       <td>
        -0.015945
       </td>
       <td>
        3.294503
       </td>
       <td>
        0.126183
       </td>
       <td>
        2.565690
       </td>
      </tr>
      <tr>
       <td>
        601939.XSHG
       </td>
       <td>
        2.125093e+12
       </td>
       <td>
        0.256305
       </td>
       <td>
        0.445321
       </td>
       <td>
        0.006780
       </td>
       <td>
        2.485684
       </td>
      </tr>
      <tr>
       <td>
        600036.XSHG
       </td>
       <td>
        1.098829e+12
       </td>
       <td>
        0.338387
       </td>
       <td>
        0.443594
       </td>
       <td>
        0.005400
       </td>
       <td>
        2.395596
       </td>
      </tr>
     </tbody>
    </table>
    <h3>
     <a id="_285">
     </a>
     结论
    </h3>
    <ol>
     <li>
      最终我们将前面的4个因子，降维【“浓缩”】成一个新的列pca，来代表前面4个因子。
     </li>
     <li>
      因此，pca 值最大，可以认为其代码股票就越好，所以选择pca最大的股票作为我们的标的，完成了选股策略。
     </li>
     <li>
      上述只是一个简单的思路，在实际的实践中，有很多的思路和方法，使用不同的因子或算法，找到最适合自己的投资组合。
     </li>
    </ol>
   </div>
   <link href="./../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="./../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470:733a2f2f626c6f672e6373646e2e6e65742f636e647269702f:61727469636c652f64657461696c732f313436313335343136" class_="artid" style="display:none">
 </p>
</div>


