---
layout: post
title: "Flask-数据库"
date: 2024-10-09 14:30:29 +0800
description: "Flask使用数据库的简单介绍"
keywords: "Flask-数据库"
categories: ['框架', 'Web', 'Flask']
tags: ['数据库', '后端', 'Web', 'Python', 'Flask']
artid: "124586205"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=124586205
    alt: "Flask-数据库"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=124586205
featuredImagePreview: https://bing.ee123.net/img/rand?artid=124586205
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Flask-数据库
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <div class="toc">
     <h4>
      Flask数据库
     </h4>
     <ul>
      <li>
       <ul>
        <li>
         <ul>
          <li>
           <a href="#_1" rel="nofollow">
            数据库的使用
           </a>
          </li>
          <li>
           <ul>
            <li>
             <a href="#SQLALchemy_6" rel="nofollow">
              SQLALchemy常用配置参数
             </a>
            </li>
            <li>
             <a href="#_22" rel="nofollow">
              定义模型类和生成表
             </a>
            </li>
            <li>
             <a href="#_100" rel="nofollow">
              添加数据
             </a>
            </li>
            <li>
             <a href="#_118" rel="nofollow">
              查询数据
             </a>
            </li>
            <li>
             <a href="#_174" rel="nofollow">
              修改和删除数据
             </a>
            </li>
           </ul>
          </li>
          <li>
           <a href="#_193" rel="nofollow">
            数据库迁移
           </a>
          </li>
          <li>
           <ul>
            <li>
             <a href="#_201" rel="nofollow">
              文件代码
             </a>
            </li>
            <li>
             <a href="#_243" rel="nofollow">
              迁移命令
             </a>
            </li>
           </ul>
          </li>
          <li>
           <a href="#_267" rel="nofollow">
            发送邮件
           </a>
          </li>
         </ul>
        </li>
       </ul>
      </li>
     </ul>
    </div>
    <p>
    </p>
    <h4>
     <a id="_1">
     </a>
     数据库的使用
    </h4>
    <p>
     Flask本身不限定数据库的选择，可以选择SQL或NOSQL的任何一种，也可以选择更方便的SQLALchemy，类似于Django的ORM。SQLALchemy实际上是对数据库的抽象，让开发者不用直接和SQL语句打交道，而是通过Python对象来操作数据库，在舍弃一些性能开销的同时，换来的是开发效率的较大提升
     <br/>
     SQLAlchemy是一个关系型数据库框架，它提供了高层的ORM和底层的原生数据库的操作
     <br/>
     flask-sqlalchemy是一个简化了SQLAlchemy操作的flask扩展
     <br/>
     <strong>
      安装
     </strong>
     ：
     <code>
      pip install flask-sqlalchemy
     </code>
    </p>
    <h5>
     <a id="SQLALchemy_6">
     </a>
     SQLALchemy常用配置参数
    </h5>
    <pre><code class="prism language-python"><span class="token comment"># 连接数据库的URL，格式为：&lt;数据库方式&gt;://&lt;用户名&gt;:&lt;密码&gt;@&lt;IP地址&gt;:&lt;端口号&gt;/&lt;数据库&gt;</span>
app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'SQLALCHEMY_DATABASE_URI'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'mysql://root:mysql@127.0.0.1:3306/test'</span>
<span class="token comment"># Python3中连接MySQL需要使用pymysql，连接格式如下：</span>
app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'SQLALCHEMY_DATABASE_URI'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'mysql+pymysql://root:mysql@127.0.0.1:3306/db'</span>

<span class="token comment"># 数据跟踪，数据库中的表格式修改后，模型类会跟着自动修改</span>
app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'SQLALCHEMY_TRACK_MODIFICATIONS'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">True</span>

<span class="token comment"># 查询时显示原始SQL语句</span>
app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'SQLALCHEMY_ECHO'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">True</span>

<span class="token comment"># 每次请求结束后自动提交数据库中的改动，不推荐使用</span>
app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'SQLALCHEMY_COMMIT_ON_TEARDOWN'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">True</span>
</code></pre>
    <h5>
     <a id="_22">
     </a>
     定义模型类和生成表
    </h5>
    <ul>
     <li>
      <strong>
       常用的SQLAlchemy字段类型
      </strong>
      <table>
       <thead>
        <tr>
         <th align="left">
          <strong>
           类型名
          </strong>
         </th>
         <th align="left">
          <strong>
           python中类型
          </strong>
         </th>
         <th align="left">
          <strong>
           说明
          </strong>
         </th>
        </tr>
       </thead>
       <tbody>
        <tr>
         <td align="left">
          Integer
         </td>
         <td align="left">
          int
         </td>
         <td align="left">
          普通整数，一般是32位
         </td>
        </tr>
        <tr>
         <td align="left">
          SmallInteger
         </td>
         <td align="left">
          int
         </td>
         <td align="left">
          取值范围小的整数，一般是16位
         </td>
        </tr>
        <tr>
         <td align="left">
          BigInteger
         </td>
         <td align="left">
          int或long
         </td>
         <td align="left">
          不限制精度的整数
         </td>
        </tr>
        <tr>
         <td align="left">
          Float
         </td>
         <td align="left">
          float
         </td>
         <td align="left">
          浮点数
         </td>
        </tr>
        <tr>
         <td align="left">
          Numeric
         </td>
         <td align="left">
          decimal.Decimal
         </td>
         <td align="left">
          普通整数，一般是32位
         </td>
        </tr>
        <tr>
         <td align="left">
          String
         </td>
         <td align="left">
          str
         </td>
         <td align="left">
          变长字符串
         </td>
        </tr>
        <tr>
         <td align="left">
          Text
         </td>
         <td align="left">
          str
         </td>
         <td align="left">
          变长字符串，对较长或不限长度的字符串做了优化
         </td>
        </tr>
        <tr>
         <td align="left">
          Unicode
         </td>
         <td align="left">
          unicode
         </td>
         <td align="left">
          变长Unicode字符串
         </td>
        </tr>
        <tr>
         <td align="left">
          UnicodeText
         </td>
         <td align="left">
          unicode
         </td>
         <td align="left">
          变长Unicode字符串，对较长或不限长度的字符串做了优化
         </td>
        </tr>
        <tr>
         <td align="left">
          Boolean
         </td>
         <td align="left">
          bool
         </td>
         <td align="left">
          布尔值
         </td>
        </tr>
        <tr>
         <td align="left">
          Date
         </td>
         <td align="left">
          datetime.date
         </td>
         <td align="left">
          时间
         </td>
        </tr>
        <tr>
         <td align="left">
          Time
         </td>
         <td align="left">
          datetime.datetime
         </td>
         <td align="left">
          日期和时间
         </td>
        </tr>
        <tr>
         <td align="left">
          LargeBinary
         </td>
         <td align="left">
          str
         </td>
         <td align="left">
          二进制文件
         </td>
        </tr>
       </tbody>
      </table>
     </li>
     <li>
      <strong>
       常用的SQLAlchemy列选项
      </strong>
      <table>
       <thead>
        <tr>
         <th align="left">
          <strong>
           选项名
          </strong>
         </th>
         <th align="left">
          <strong>
           说明
          </strong>
         </th>
        </tr>
       </thead>
       <tbody>
        <tr>
         <td align="left">
          primary_key
         </td>
         <td align="left">
          如果为True，代表表的主键
         </td>
        </tr>
        <tr>
         <td align="left">
          unique
         </td>
         <td align="left">
          如果为True，代表这列不允许出现重复的值
         </td>
        </tr>
        <tr>
         <td align="left">
          index
         </td>
         <td align="left">
          如果为True，为这列创建索引，提高查询效率
         </td>
        </tr>
        <tr>
         <td align="left">
          nullable
         </td>
         <td align="left">
          如果为True，允许有空值，如果为False，不允许有空值
         </td>
        </tr>
        <tr>
         <td align="left">
          default
         </td>
         <td align="left">
          为这列定义默认值
         </td>
        </tr>
       </tbody>
      </table>
     </li>
     <li>
      <strong>
       常用的SQLAlchemy关系选项
      </strong>
      <table>
       <thead>
        <tr>
         <th align="left">
          <strong>
           选项名
          </strong>
         </th>
         <th align="left">
          <strong>
           说明
          </strong>
         </th>
        </tr>
       </thead>
       <tbody>
        <tr>
         <td align="left">
          backref
         </td>
         <td align="left">
          在关系的另一模型中添加反向引用
         </td>
        </tr>
        <tr>
         <td align="left">
          primary join
         </td>
         <td align="left">
          明确指定两个模型之间使用的联结条件
         </td>
        </tr>
        <tr>
         <td align="left">
          uselist
         </td>
         <td align="left">
          如果为False，不使用列表，而使用标量值
         </td>
        </tr>
        <tr>
         <td align="left">
          order_by
         </td>
         <td align="left">
          指定关系中记录的排序方式
         </td>
        </tr>
        <tr>
         <td align="left">
          secondary
         </td>
         <td align="left">
          指定多对多中记录的排序方式
         </td>
        </tr>
        <tr>
         <td align="left">
          secondary join
         </td>
         <td align="left">
          在SQLAlchemy中无法自行决定时，指定多对多关系中的二级联结条件
         </td>
        </tr>
       </tbody>
      </table>
     </li>
    </ul>
    <p>
     示例代码：
    </p>
    <pre><code class="prism language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask
<span class="token keyword">from</span> flask_sqlalchemy <span class="token keyword">import</span> SQLAlchemy

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Config</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># SQLALchemy的配置参数，Python3中需要使用pymysql</span>
    SQLALCHEMY_DATABASE_URI <span class="token operator">=</span> <span class="token string">'mysql+pymysql://root:mysql@127.0.0.1:3306/db_flask'</span>
    <span class="token comment"># 数据跟踪，数据库中的表格式修改后，模型类会跟着自动修改</span>
    SQLALCHEMY_TRACK_MODIFICATIONS <span class="token operator">=</span> <span class="token boolean">True</span>

app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>from_object<span class="token punctuation">(</span>Config<span class="token punctuation">)</span>
<span class="token comment"># 创建数据库SQLAlchemy的工具对象</span>
db <span class="token operator">=</span> SQLAlchemy<span class="token punctuation">(</span>app<span class="token punctuation">)</span>

<span class="token comment"># 创建数据库模型类</span>
<span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'tbl_users'</span>  <span class="token comment"># 指定表名</span>
    <span class="token builtin">id</span> <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  <span class="token comment"># 整型的主键，默认会自动增长</span>
    name <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span> unique<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    email <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">,</span> unique<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    password <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">,</span> unique<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    role_id <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>Integer<span class="token punctuation">,</span> db<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span><span class="token string">'tbl_roles.id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 设置外键</span>
    
    <span class="token comment"># 定义显示信息，定义之后，查询时显示对象的时候更直观</span>
    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">'User object: name=%s'</span> <span class="token operator">%</span> self<span class="token punctuation">.</span>name

<span class="token keyword">class</span> <span class="token class-name">Role</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'tbl_roles'</span>
    <span class="token builtin">id</span> <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    name <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> unique<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    users <span class="token operator">=</span> db<span class="token punctuation">.</span>relationship<span class="token punctuation">(</span><span class="token string">'User'</span><span class="token punctuation">,</span> backref<span class="token operator">=</span><span class="token string">'role'</span><span class="token punctuation">)</span>  <span class="token comment"># 建立表之间的关系</span>
    
    <span class="token comment"># 定义显示信息，定义之后，查询时显示对象的时候更直观</span>
    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">'Role object: name=%s'</span> <span class="token operator">%</span> self<span class="token punctuation">.</span>name

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    db<span class="token punctuation">.</span>drop_all<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 清除数据库中的所有数据</span>
    db<span class="token punctuation">.</span>create_all<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 创建所有的表</span>
</code></pre>
    <h5>
     <a id="_100">
     </a>
     添加数据
    </h5>
    <pre><code class="prism language-python"><span class="token comment"># 向数据库中添加数据</span>
role1 <span class="token operator">=</span> Role<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'admin'</span><span class="token punctuation">)</span>  <span class="token comment"># 创建对象</span>
db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>role1<span class="token punctuation">)</span>  <span class="token comment"># 用session记录对象任务，一次添加一条数据</span>
db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 提交任务到数据库中</span>

role2 <span class="token operator">=</span> Role<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'stuff'</span><span class="token punctuation">)</span>
db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>role2<span class="token punctuation">)</span>
db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>

user1 <span class="token operator">=</span> User<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'wang'</span><span class="token punctuation">,</span> email<span class="token operator">=</span><span class="token string">'wang@163.com'</span><span class="token punctuation">,</span> password<span class="token operator">=</span><span class="token string">'123456'</span><span class="token punctuation">,</span> role_id<span class="token operator">=</span>role1<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span>
user2 <span class="token operator">=</span> User<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'zhang'</span><span class="token punctuation">,</span> email<span class="token operator">=</span><span class="token string">'zhang@189.com'</span><span class="token punctuation">,</span> password<span class="token operator">=</span><span class="token string">'201512'</span><span class="token punctuation">,</span> role_id<span class="token operator">=</span>role2<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span>
user3 <span class="token operator">=</span> User<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'chen'</span><span class="token punctuation">,</span> email<span class="token operator">=</span><span class="token string">'chen@126.com'</span><span class="token punctuation">,</span> password<span class="token operator">=</span><span class="token string">'987654'</span><span class="token punctuation">,</span> role_id<span class="token operator">=</span>role2<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span>
user4 <span class="token operator">=</span> User<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'zhou'</span><span class="token punctuation">,</span> email<span class="token operator">=</span><span class="token string">'zhou@163.com'</span><span class="token punctuation">,</span> password<span class="token operator">=</span><span class="token string">'456789'</span><span class="token punctuation">,</span> role_id<span class="token operator">=</span>role1<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span>
db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>add_all<span class="token punctuation">(</span><span class="token punctuation">[</span>user1<span class="token punctuation">,</span> user2<span class="token punctuation">,</span> user3<span class="token punctuation">,</span> user4<span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 一次添加多条数据</span>
db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
    <h5>
     <a id="_118">
     </a>
     查询数据
    </h5>
    <ul>
     <li>
      <strong>
       常用的SQLAlchemy查询过滤器
      </strong>
      <table>
       <thead>
        <tr>
         <th align="left">
          <strong>
           过滤器
          </strong>
         </th>
         <th align="left">
          <strong>
           说明
          </strong>
         </th>
        </tr>
       </thead>
       <tbody>
        <tr>
         <td align="left">
          filter()
         </td>
         <td align="left">
          把过滤器添加到原查询上，返回一个新查询
         </td>
        </tr>
        <tr>
         <td align="left">
          filter_by()
         </td>
         <td align="left">
          把等值过滤器添加到原查询上，返回一个新查询
         </td>
        </tr>
        <tr>
         <td align="left">
          limit
         </td>
         <td align="left">
          使用指定的值限定原查询返回的结果
         </td>
        </tr>
        <tr>
         <td align="left">
          offset()
         </td>
         <td align="left">
          偏移原查询返回的结果，返回一个新查询，相当于跳过几条
         </td>
        </tr>
        <tr>
         <td align="left">
          order_by()
         </td>
         <td align="left">
          根据指定条件对原查询结果进行排序，返回一个新查询
         </td>
        </tr>
        <tr>
         <td align="left">
          group_by()
         </td>
         <td align="left">
          根据指定条件对原查询结果进行分组，返回一个新查询
         </td>
        </tr>
       </tbody>
      </table>
     </li>
     <li>
      <strong>
       常用的SQLAlchemy查询执行器
      </strong>
      <table>
       <thead>
        <tr>
         <th align="left">
          <strong>
           方法
          </strong>
         </th>
         <th align="left">
          <strong>
           说明
          </strong>
         </th>
        </tr>
       </thead>
       <tbody>
        <tr>
         <td align="left">
          all()
         </td>
         <td align="left">
          以列表形式返回查询的所有结果
         </td>
        </tr>
        <tr>
         <td align="left">
          first()
         </td>
         <td align="left">
          返回查询的第一个结果，如果未查到，返回None
         </td>
        </tr>
        <tr>
         <td align="left">
          first_or_404()
         </td>
         <td align="left">
          返回查询的第一个结果，如果未查到，返回404
         </td>
        </tr>
        <tr>
         <td align="left">
          get()
         </td>
         <td align="left">
          返回指定主键对应的行，如不存在，返回None
         </td>
        </tr>
        <tr>
         <td align="left">
          get_or_404()
         </td>
         <td align="left">
          返回指定主键对应的行，如不存在，返回404
         </td>
        </tr>
        <tr>
         <td align="left">
          count()
         </td>
         <td align="left">
          返回查询结果的数量
         </td>
        </tr>
        <tr>
         <td align="left">
          paginate()
         </td>
         <td align="left">
          返回一个Paginate对象，它包含指定范围内的结果
         </td>
        </tr>
       </tbody>
      </table>
     </li>
     <li>
      <strong>
       查询的使用
      </strong>
      <br/>
      <code>
       Role.query.all()
      </code>
      ：查询表中的所有数据，返回一个列表
      <br/>
      <code>
       Role.query.first()
      </code>
      ：返回查询到的第一条数据
      <br/>
      <code>
       Role.query.get(2)
      </code>
      ：返回指定主键对应的数据
      <br/>
      <code>
       db.session.query(Role).all()
      </code>
      ：使用
      <code>
       session
      </code>
      进行查询，方法都相同
      <br/>
      <code>
       User.query.filter_by(name='wang').all()
      </code>
      ：返回
      <code>
       name
      </code>
      是
      <code>
       wang
      </code>
      的结果
      <br/>
      <code>
       User.query.filter_by(name='wang', role_id=1).all()
      </code>
      ：使用多个条件进行查询
      <br/>
      <code>
       User.query.filter(User.name=='wang', User.role_id==1).all()
      </code>
      ：使用
      <code>
       filter()
      </code>
      进行多个条件查询
      <br/>
      <code>
       User.query.filter().offset().limit().order_by().all()
      </code>
      ：链式调用
      <br/>
      <code>
       User.query.offset(2).all()
      </code>
      ：
      <code>
       offset()
      </code>
      相当于跳过几条数据
      <br/>
      <code>
       User.query.limit(2).all()
      </code>
      ：
      <code>
       limit()
      </code>
      表示取出几条数据
      <br/>
      <code>
       User.query.order_by(User.id.desc()).all()
      </code>
      ：通过
      <code>
       id
      </code>
      降序排列
      <br/>
      或者条件进行查询：
      <pre><code class="prism language-python"><span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> or_<span class="token punctuation">,</span> and_<span class="token punctuation">,</span> not_
li <span class="token operator">=</span> User<span class="token punctuation">.</span>query<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>or_<span class="token punctuation">(</span>User<span class="token punctuation">.</span>name<span class="token operator">==</span><span class="token string">'wang'</span><span class="token punctuation">,</span> User<span class="token punctuation">.</span>email<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">'163.com'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># and_和not_的使用方法和or_相同</span>
</code></pre>
      分组并统计数量：
      <pre><code class="prism language-python"><span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> func
db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>User<span class="token punctuation">.</span>role_id<span class="token punctuation">,</span> func<span class="token punctuation">.</span>count<span class="token punctuation">(</span>User<span class="token punctuation">.</span>role_id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>group_by<span class="token punctuation">(</span>User<span class="token punctuation">.</span>role_id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># query()中表示的是在结果中显示的内容</span>
<span class="token comment"># func.count()表示统计每组的数量</span>
</code></pre>
     </li>
     <li>
      <strong>
       分页的使用
      </strong>
      <pre><code class="prism language-python"><span class="token comment"># 查询数据</span>
user_query <span class="token operator">=</span> User<span class="token punctuation">.</span>query<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
<span class="token comment"># 处理分页，page：当前显示的页数，per_page：每页显示的数量，error_out：自动的错误输出</span>
page_obj <span class="token operator">=</span> user_query<span class="token punctuation">.</span>paginate<span class="token punctuation">(</span>page<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> per_page<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> error_out<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
<span class="token comment"># 获取当前页面数据，</span>
user_li <span class="token operator">=</span> page_obj<span class="token punctuation">.</span>items
<span class="token comment"># 获取总页数</span>
total_page <span class="token operator">=</span> page_obj<span class="token punctuation">.</span>pages
</code></pre>
     </li>
    </ul>
    <h5>
     <a id="_174">
     </a>
     修改和删除数据
    </h5>
    <ul>
     <li>
      <strong>
       修改数据
      </strong>
      <pre><code class="prism language-python">user <span class="token operator">=</span> User<span class="token punctuation">.</span>query<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> 
user<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'python'</span>
db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>user<span class="token punctuation">)</span> 
db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
     </li>
     <li>
      <strong>
       使用update()修改数据
      </strong>
      <pre><code class="prism language-python">User<span class="token punctuation">.</span>query<span class="token punctuation">.</span>filter_by<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'zhou'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'html'</span><span class="token punctuation">,</span> <span class="token string">'email'</span><span class="token punctuation">:</span> <span class="token string">'html@python.com'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>  
db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
     </li>
     <li>
      <strong>
       删除数据
      </strong>
      <pre><code class="prism language-python">user <span class="token operator">=</span> User<span class="token punctuation">.</span>query<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> 
db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>delete<span class="token punctuation">(</span>user<span class="token punctuation">)</span> 
db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
     </li>
    </ul>
    <h4>
     <a id="_193">
     </a>
     数据库迁移
    </h4>
    <p>
     在开发过程中，需要修改数据库模型，而且还要在修改之后更新数据库。最直接的方式就是删除旧表，但这样会丢失数据。更好的解决办法是使用数据库迁移框架，它可以追踪数据库模式的变化，然后把变动应用到数据库中
    </p>
    <p>
     在Flask中可以使用Flask-Migrate扩展来实现数据迁移，并且可以集成到Flask-Script中，所有操作通过命令就能完成
    </p>
    <p>
     为了导出数据库迁移命令，Flask-Migrate提供了一个MigrateCommand类，可以附加到flask-script的manager对象上
     <br/>
     <strong>
      安装
     </strong>
     ：
     <code>
      pip install flask-migrate
     </code>
     <br/>
     <code>
      pip install Flask-Script
     </code>
    </p>
    <h5>
     <a id="_201">
     </a>
     文件代码
    </h5>
    <pre><code class="prism language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask
<span class="token keyword">from</span> flask_sqlalchemy <span class="token keyword">import</span> SQLAlchemy
<span class="token keyword">from</span> flask_script <span class="token keyword">import</span> Manager
<span class="token keyword">from</span> flask_migrate <span class="token keyword">import</span> Migrate<span class="token punctuation">,</span> MigrateCommand

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>

<span class="token comment"># 配置参数</span>
<span class="token keyword">class</span> <span class="token class-name">Config</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    SQLALCHEMY_DATABASE_URI <span class="token operator">=</span> <span class="token string">'mysql+pymysql://root:mysql@127.0.0.1:3306/db_flask'</span>
    SQLALCHEMY_TRACK_MODIFICATIONS <span class="token operator">=</span> <span class="token boolean">True</span>

app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>from_object<span class="token punctuation">(</span>Config<span class="token punctuation">)</span>
db <span class="token operator">=</span> SQLAlchemy<span class="token punctuation">(</span>app<span class="token punctuation">)</span>

<span class="token comment"># 创建Flask脚本管理对象</span>
manager <span class="token operator">=</span> Manager<span class="token punctuation">(</span>app<span class="token punctuation">)</span>

<span class="token comment"># 创建数据库迁移工具对象</span>
Migrate<span class="token punctuation">(</span>app<span class="token punctuation">,</span> db<span class="token punctuation">)</span>

<span class="token comment"># 向manager对象中添加数据库的操作命令</span>
manager<span class="token punctuation">.</span>add_command<span class="token punctuation">(</span><span class="token string">'db'</span><span class="token punctuation">,</span> MigrateCommand<span class="token punctuation">)</span>

<span class="token comment"># 定义数据库的模型类</span>
<span class="token keyword">class</span> <span class="token class-name">Author</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'tbl_authors'</span>
    <span class="token builtin">id</span> <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    name <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> unique<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    books <span class="token operator">=</span> db<span class="token punctuation">.</span>relationship<span class="token punctuation">(</span><span class="token string">'Book'</span><span class="token punctuation">,</span> backref<span class="token operator">=</span><span class="token string">'author'</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Book</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'tbl_books'</span>
    <span class="token builtin">id</span> <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    name <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span> unique<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    author_id <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>Integer<span class="token punctuation">,</span> db<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span><span class="token string">'tbl_authors.id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    manager<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 通过manager对象启动程序</span>
</code></pre>
    <h5>
     <a id="_243">
     </a>
     迁移命令
    </h5>
    <p>
     <em>
      <strong>
       1&gt;
      </strong>
     </em>
     创建迁移仓库：
    </p>
    <pre><code># 这个命令会自动创建migrations文件夹，所有迁移文件都放在里面
python database.py db init
</code></pre>
    <p>
     <em>
      <strong>
       2&gt;
      </strong>
     </em>
     创建迁移脚本：
    </p>
    <pre><code># -m的作用是添加备注信息，可不写
python database.py db migrate -m 'this is a remark'
</code></pre>
    <p>
     <em>
      <strong>
       3&gt;
      </strong>
     </em>
     更新数据库：
    </p>
    <pre><code>python database.py db upgrade
</code></pre>
    <p>
     <em>
      <strong>
       4&gt;
      </strong>
     </em>
     查看迁移记录：
    </p>
    <pre><code>python database.py db history
</code></pre>
    <p>
     <em>
      <strong>
       5&gt;
      </strong>
     </em>
     回退数据库：
    </p>
    <pre><code>python database.py db downgrade 版本号
python database.py db downgrade base  # 回退到最初的版本
</code></pre>
    <h4>
     <a id="_267">
     </a>
     发送邮件
    </h4>
    <p>
     <strong>
      安装
     </strong>
     ：
     <code>
      pip install Flask-Mail
     </code>
     <br/>
     参考文档：
     <a href="http://www.pythondoc.com/flask-mail/" rel="nofollow">
      http://www.pythondoc.com/flask-mail/
     </a>
    </p>
    <pre><code class="prism language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask
<span class="token keyword">from</span> flask_mail <span class="token keyword">import</span> Mail<span class="token punctuation">,</span> Message

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>

<span class="token comment"># 添加邮件配置：服务器、端口、传输层安全协议、邮箱名、密码/授权码</span>
app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>update<span class="token punctuation">(</span>
    MAIL_SERVER<span class="token operator">=</span><span class="token string">'smtp.qq.com'</span><span class="token punctuation">,</span>
    MAIL_PROT<span class="token operator">=</span><span class="token number">465</span><span class="token punctuation">,</span>
    MAIL_USE_TLS<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    MAIL_USERNAME<span class="token operator">=</span><span class="token string">'aaaa@qq.com'</span><span class="token punctuation">,</span>
    MAIL_PASSWORD<span class="token operator">=</span><span class="token string">'xxxxxxxxxx'</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>

<span class="token comment"># 创建mail对象</span>
mail <span class="token operator">=</span> Mail<span class="token punctuation">(</span>app<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># sender：发送方；recipients：接收方列表</span>
    msg <span class="token operator">=</span> Message<span class="token punctuation">(</span><span class="token string">"This is a test "</span><span class="token punctuation">,</span> sender<span class="token operator">=</span><span class="token string">'aaaa@qq.com'</span><span class="token punctuation">,</span> recipients<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'bbbb@qq.com'</span><span class="token punctuation">,</span> <span class="token string">'cccc@qq.com'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token comment"># 邮件正文内容</span>
    msg<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">"Flask test mail"</span>
    <span class="token comment"># 发送邮件</span>
    mail<span class="token punctuation">.</span>send<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">"Send Succeed"</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>debug<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470:733a2f2f626c6f672e6373646e2e6e65742f62616d626b6b2f:61727469636c652f64657461696c732f313234353836323035" class_="artid" style="display:none">
 </p>
</div>


