---
arturl_encode: "68747470:733a2f2f626c6f672e6373646e2e6e65742f776c735f676b2f:61727469636c652f64657461696c732f313436303839343134"
layout: post
title: "ç”¨äº†ä¸»é”®ç´¢å¼•åè€ŒæŸ¥è¯¢æ…¢æ·±åº¦è§£æSQLæ€§èƒ½åå¸¸è¯†ç°è±¡"
date: 2025-03-07 10:40:07 +08:00
description: "ğŸ” æ‰§è¡Œè®¡åˆ’åˆ†æğŸ“ˆ ç³»ç»Ÿç›‘æ§æ•°æ®ğŸ§© å­˜å‚¨å¼•æ“ç‰¹æ€§âš™ï¸ ç¡¬ä»¶èµ„æºé…ç½®è°ƒä¼˜ç®´è¨€â€œä¼˜ç§€çš„DBAä¸æ˜¯ä¼šä½¿ç”¨å·¥å…·ï¼Œè€Œæ˜¯æ‡‚å¾—æ•°æ®ç”Ÿå‘½çš„å‘¼å¸èŠ‚å¥ï¼"
keywords: "ç”¨äº†ä¸»é”®ç´¢å¼•åè€ŒæŸ¥è¯¢æ…¢ï¼Ÿæ·±åº¦è§£æSQLæ€§èƒ½åå¸¸è¯†ç°è±¡"
categories: ['ç³»ç»Ÿæ¶æ„', 'æ•°æ®åº“', 'Java']
tags: ['æ•°æ®åº“', 'Sql', 'Java']
artid: "146089414"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146089414
    alt: "ç”¨äº†ä¸»é”®ç´¢å¼•åè€ŒæŸ¥è¯¢æ…¢æ·±åº¦è§£æSQLæ€§èƒ½åå¸¸è¯†ç°è±¡"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146089414
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146089414
cover: https://bing.ee123.net/img/rand?artid=146089414
image: https://bing.ee123.net/img/rand?artid=146089414
img: https://bing.ee123.net/img/rand?artid=146089414
---

# ç”¨äº†ä¸»é”®ç´¢å¼•åè€ŒæŸ¥è¯¢æ…¢ï¼Ÿæ·±åº¦è§£æSQLæ€§èƒ½åå¸¸è¯†ç°è±¡

## ğŸ¢ ç”¨äº†ä¸»é”®ç´¢å¼•åè€ŒæŸ¥è¯¢æ…¢ï¼Ÿæ·±åº¦è§£æSQLæ€§èƒ½åå¸¸è¯†ç°è±¡

![](https://img-blog.csdnimg.cn/direct/8f6c9d3a3d7c4c6b9c0e3d3e3b3e3e3e.png)

> **ä½œè€…æ³¨**
> ï¼šæœ¬æ–‡é€šè¿‡çœŸå®æ¡ˆä¾‹+åŸç†å‰–æï¼Œæ­ç§˜ä¸»é”®ç´¢å¼•å¤±æ•ˆçš„6å¤§å¹•åé»‘æ‰‹ï¼Œé™„èµ ã€ŠSQLè°ƒä¼˜é€ŸæŸ¥è¡¨ã€‹ï¼

### ä¸€ã€è¯¡å¼‚ç°è±¡ï¼šä¸»é”®ç´¢å¼•æŸ¥è¯¢ç«Ÿæ¯”å…¨è¡¨æ‰«ææ…¢ï¼Ÿ

```sql
-- ç¤ºä¾‹è¡¨ç»“æ„
CREATE TABLE user_orders (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,  -- è‡ªå¢ä¸»é”®
  user_id INT,
  amount DECIMAL(10,2),
  created_at DATETIME
) ENGINE=InnoDB;

-- æŸ¥è¯¢è¯­å¥ï¼ˆé€šè¿‡ä¸»é”®æ£€ç´¢ï¼‰
SELECT * FROM user_orders WHERE id BETWEEN 1000000 AND 1000100;

```

**æ‰§è¡Œç»“æœ**
ï¼š

* ä¸»é”®æŸ¥è¯¢è€—æ—¶ï¼š
  **1200ms**
* å…¨è¡¨æ‰«æè€—æ—¶ï¼š
  **800ms**

### äºŒã€å…­å¤§ç½ªé­ç¥¸é¦–æ·±åº¦å‰–æ

#### 1. ğŸ§© ç´¢å¼•ç¢ç‰‡åŒ–ï¼ˆIndex Fragmentationï¼‰

```sql
-- æŸ¥çœ‹ç´¢å¼•ç¢ç‰‡ç‡
SHOW TABLE STATUS LIKE 'user_orders';

```

**å…³é”®æŒ‡æ ‡**
ï¼š

* Data_free > 10% è¯´æ˜å­˜åœ¨ä¸¥é‡ç¢ç‰‡
* ä¿®å¤æ–¹æ³•ï¼š
  `OPTIMIZE TABLE user_orders;`

![](https://img-blog.csdnimg.cn/img_convert/9b8c4a5b5d5b5e5c5d5b5e5c5d5b5e5c.png)

#### 2. ğŸ”„ å›è¡¨æŸ¥è¯¢é™·é˜±ï¼ˆBookmark Lookupï¼‰

```sql
-- æ¡ˆä¾‹ï¼šçœ‹ä¼¼ç”¨ä¸»é”®ï¼Œå®åˆ™å…¨æ‰«æ
EXPLAIN 
SELECT user_id FROM user_orders 
WHERE id + 1 = 1000001;  -- å¯¹ç´¢å¼•åˆ—è¿›è¡Œè¿ç®—

```

**æ‰§è¡Œè®¡åˆ’å…³é”®å­—æ®µ**
ï¼š

* type:
  **ALL**
* Extra:
  **Using where**

#### 3. ğŸ“Š æ•°æ®åˆ†å¸ƒä¸å‡ï¼ˆSkewed Data Distributionï¼‰

```sql
-- æ£€æŸ¥æ•°æ®åˆ†å¸ƒ
SELECT 
  COUNT(*) AS total,
  MAX(id) - MIN(id) AS range_diff
FROM user_orders;

```

**å±é™©ä¿¡å·**
ï¼š

* range_diff / total < 10 æ—¶å­˜åœ¨çƒ­ç‚¹
* è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨é›ªèŠ±ç®—æ³•ç”ŸæˆID

#### 4. ğŸ”’ é”ç«äº‰é£æš´ï¼ˆLock Contentionï¼‰

```sql
-- æŸ¥çœ‹å½“å‰é”çŠ¶æ€
SHOW ENGINE INNODB STATUS\G

```

**é‡ç‚¹å…³æ³¨**
ï¼š

* **LOCK WAIT**
  å­—æ®µ
* ä¼˜åŒ–æ–¹æ¡ˆï¼šé™ä½äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼ˆå¦‚RCï¼‰

#### 5. ğŸ“‚ å­˜å‚¨å¼•æ“ç‰¹æ€§ï¼ˆStorage Engine Secretsï¼‰

```sql
-- ä¿®æ”¹ç´¢å¼•å‹ç¼©ç­–ç•¥
ALTER TABLE user_orders 
ROW_FORMAT=COMPRESSED  
KEY_BLOCK_SIZE=8;

```

**InnoDBè°ƒä¼˜å‚æ•°**
ï¼š

* innodb_buffer_pool_size = 70%å†…å­˜
* innodb_flush_log_at_trx_commit = 2

#### 6. ğŸ’¾ ç¡¬ä»¶æ€§èƒ½ç“¶é¢ˆï¼ˆHardware Limitationsï¼‰

```sql
-- æ£€æŸ¥ç£ç›˜æ€§èƒ½
iostat -x 1  # Linuxç³»ç»Ÿ

```

**å…³é”®æŒ‡æ ‡**
ï¼š

* %util > 90%
* await > 10ms

### ä¸‰ã€å››æ­¥è¯Šæ–­æ³•å¿«é€Ÿå®šä½é—®é¢˜

#### æ­¥éª¤1ï¼šæŸ¥çœ‹æ‰§è¡Œè®¡åˆ’

```sql
EXPLAIN FORMAT=JSON
SELECT * FROM user_orders WHERE id = 1000000;

```

**æ ¸å¿ƒå…³æ³¨ç‚¹**
ï¼š

```json
"query_cost": "1.00"  -- æˆæœ¬å€¼å¼‚å¸¸åé«˜
"rows_examined_per_scan": 1

```

#### æ­¥éª¤2ï¼šåˆ†ææ…¢æŸ¥è¯¢æ—¥å¿—

```ini
# my.cnfé…ç½®
slow_query_log = 1
long_query_time = 1
log_slow_extra = 1

```

#### æ­¥éª¤3ï¼šæ£€æŸ¥ç³»ç»ŸæŒ‡æ ‡

```bash
# å®æ—¶ç›‘æ§å·¥å…·
mysqladmin -u root -p ext | grep -E 'Queries|Threads_running'

```

#### æ­¥éª¤4ï¼šæ€§èƒ½å¯¹æ¯”æµ‹è¯•

```sql
-- å…³é—­ç´¢å¼•å¼ºåˆ¶å…¨è¡¨æ‰«æ
SELECT * FROM user_orders 
IGNORE INDEX(PRIMARY)
WHERE id = 1000000;

```

### å››ã€å…­å¤§ä¼˜åŒ–æ–¹æ¡ˆç»ˆææŒ‡å—

#### æ–¹æ¡ˆ1ï¼šç´¢å¼•ç»´æŠ¤ç­–ç•¥

```sql
-- è‡ªåŠ¨é‡å»ºç¢ç‰‡ç´¢å¼•
ALTER TABLE user_orders 
ALTER INDEX PRIMARY REBUILD;

```

#### æ–¹æ¡ˆ2ï¼šæŸ¥è¯¢é‡å†™æŠ€å·§

```sql
-- åŸå§‹ä½æ•ˆæŸ¥è¯¢
SELECT * FROM user_orders WHERE YEAR(created_at) = 2023;

-- ä¼˜åŒ–åç‰ˆæœ¬
SELECT * FROM user_orders 
WHERE created_at BETWEEN '2023-01-01' AND '2023-12-31';

```

#### æ–¹æ¡ˆ3ï¼šæ•°æ®å†·çƒ­åˆ†ç¦»

```sql
-- åˆ›å»ºå†å²æ•°æ®å½’æ¡£è¡¨
CREATE TABLE user_orders_archive (
  CHECK (created_at < '2020-01-01')
) INHERITS (user_orders);

```

#### æ–¹æ¡ˆ4ï¼šå‚æ•°è°ƒä¼˜æ¨¡æ¿

```ini
# InnoDBä¼˜åŒ–å‚æ•°
innodb_io_capacity = 2000
innodb_lru_scan_depth = 100

```

#### æ–¹æ¡ˆ5ï¼šç¡¬ä»¶å‡çº§æŒ‡å—

```
NVMe SSD > SAS SSD > SATA SSD
RAID 10 > RAID 5

```

#### æ–¹æ¡ˆ6ï¼šæ¶æ„æ”¹é€ æ–¹æ¡ˆ

![](https://img-blog.csdnimg.cn/img_convert/8f6c9d3a3d7c4c6b9c0e3d3e3b3e3e3e.png)

### äº”ã€å®æˆ˜æ¡ˆä¾‹ï¼šç”µå•†è®¢å•æŸ¥è¯¢ä¼˜åŒ–

#### é—®é¢˜æè¿°ï¼š

* ä¸»é”®æŸ¥è¯¢500msä»¥ä¸Š
* è¡¨æ•°æ®é‡1.2äº¿æ¡

#### æ’æŸ¥è¿‡ç¨‹ï¼š

1. å‘ç°ä¸»é”®ä¸ºUUIDå¯¼è‡´é¡µåˆ†è£‚
2. ç´¢å¼•ç¢ç‰‡ç‡é«˜è¾¾35%
3. Buffer poolå‘½ä¸­ç‡ä»…60%

#### è§£å†³æ–¹æ¡ˆï¼š

1. æ”¹ç”¨è‡ªå¢ä¸»é”®
2. å¯ç”¨é¡µå‹ç¼©
3. è°ƒæ•´buffer_pool_sizeåˆ°32G

#### ä¼˜åŒ–ç»“æœï¼š

![](https://img-blog.csdnimg.cn/img_convert/9b8c4a5b5d5b5e5c5d5b5e5c5d5b5e5c.png)

### å…­ã€è°ƒä¼˜é€ŸæŸ¥è¡¨ï¼ˆæ”¶è—ç‰ˆï¼‰

| ç°è±¡ | å¯èƒ½åŸå›  | æ£€æŸ¥å‘½ä»¤ | è§£å†³æ–¹æ¡ˆ |
| --- | --- | --- | --- |
| ä¸»é”®æŸ¥è¯¢å¿½å¿«å¿½æ…¢ | çƒ­ç‚¹æ•°æ® | SHOW GLOBAL STATUS | åˆ†åº“åˆ†è¡¨ |
| ç®€å•æŸ¥è¯¢éšæœºå˜æ…¢ | ç£ç›˜IOç“¶é¢ˆ | iostat -x 1 | å‡çº§SSD |
| ç´¢å¼•æ‰«æè¡Œæ•°å¼‚å¸¸ | ç»Ÿè®¡ä¿¡æ¯è¿‡æœŸ | ANALYZE TABLE | é‡å»ºç»Ÿè®¡ä¿¡æ¯ |
| æŸ¥è¯¢å¶å°”è¶…æ—¶ | é”ç­‰å¾… | SHOW ENGINE INNODB STATUS | é™ä½éš”ç¦»çº§åˆ« |

### ä¸ƒã€ç»“è¯­ï¼šé€è¿‡ç°è±¡çœ‹æœ¬è´¨

ä¸»é”®ç´¢å¼•ä¸æ˜¯é“¶å¼¹ï¼Œéœ€ç»“åˆï¼š

* ğŸ” æ‰§è¡Œè®¡åˆ’åˆ†æ
* ğŸ“ˆ ç³»ç»Ÿç›‘æ§æ•°æ®
* ğŸ§© å­˜å‚¨å¼•æ“ç‰¹æ€§
* âš™ï¸ ç¡¬ä»¶èµ„æºé…ç½®

**è°ƒä¼˜ç®´è¨€**
ï¼š
  
â€œä¼˜ç§€çš„DBAä¸æ˜¯ä¼šä½¿ç”¨å·¥å…·ï¼Œè€Œæ˜¯æ‡‚å¾—æ•°æ®ç”Ÿå‘½çš„å‘¼å¸èŠ‚å¥ï¼â€

> **æŠ€æœ¯é›·è¾¾**
> ï¼šæ ¹æ®Perconaæœ€æ–°æŠ¥å‘Šï¼Œ85%çš„ç´¢å¼•æ€§èƒ½é—®é¢˜å¯é€šè¿‡å®šæœŸç»´æŠ¤é¿å…ï¼