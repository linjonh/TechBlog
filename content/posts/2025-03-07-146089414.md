---
layout: post
title: "用了主键索引反而查询慢深度解析SQL性能反常识现象"
date: 2025-03-07 10:40:07 +0800
description: "🔍 执行计划分析📈 系统监控数据🧩 存储引擎特性⚙️ 硬件资源配置调优箴言“优秀的DBA不是会使用工具，而是懂得数据生命的呼吸节奏！"
keywords: "用了主键索引反而查询慢？深度解析SQL性能反常识现象"
categories: ['系统架构', '数据库', 'Java']
tags: ['数据库', 'Sql', 'Java']
artid: "146089414"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146089414
    alt: "用了主键索引反而查询慢深度解析SQL性能反常识现象"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146089414
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146089414
cover: https://bing.ee123.net/img/rand?artid=146089414
image: https://bing.ee123.net/img/rand?artid=146089414
img: https://bing.ee123.net/img/rand?artid=146089414
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     用了主键索引反而查询慢？深度解析SQL性能反常识现象
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="_SQL_1">
     </a>
     🐢 用了主键索引反而查询慢？深度解析SQL性能反常识现象
    </h2>
    <p>
     <img alt="" src="https://img-blog.csdnimg.cn/direct/8f6c9d3a3d7c4c6b9c0e3d3e3b3e3e3e.png"/>
    </p>
    <blockquote>
     <p>
      <strong>
       作者注
      </strong>
      ：本文通过真实案例+原理剖析，揭秘主键索引失效的6大幕后黑手，附赠《SQL调优速查表》！
     </p>
    </blockquote>
    <h3>
     <a id="_7">
     </a>
     一、诡异现象：主键索引查询竟比全表扫描慢？
    </h3>
    <pre><code class="prism language-sql"><span class="token comment">-- 示例表结构</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> user_orders <span class="token punctuation">(</span>
  id <span class="token keyword">BIGINT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>  <span class="token comment">-- 自增主键</span>
  user_id <span class="token keyword">INT</span><span class="token punctuation">,</span>
  amount <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  created_at <span class="token keyword">DATETIME</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span><span class="token punctuation">;</span>

<span class="token comment">-- 查询语句（通过主键检索）</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> user_orders <span class="token keyword">WHERE</span> id <span class="token operator">BETWEEN</span> <span class="token number">1000000</span> <span class="token operator">AND</span> <span class="token number">1000100</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     <strong>
      执行结果
     </strong>
     ：
    </p>
    <ul>
     <li>
      主键查询耗时：
      <strong>
       1200ms
      </strong>
     </li>
     <li>
      全表扫描耗时：
      <strong>
       800ms
      </strong>
     </li>
    </ul>
    <h3>
     <a id="_25">
     </a>
     二、六大罪魁祸首深度剖析
    </h3>
    <h4>
     <a id="1__Index_Fragmentation_27">
     </a>
     1. 🧩 索引碎片化（Index Fragmentation）
    </h4>
    <pre><code class="prism language-sql"><span class="token comment">-- 查看索引碎片率</span>
<span class="token keyword">SHOW</span> <span class="token keyword">TABLE</span> <span class="token keyword">STATUS</span> <span class="token operator">LIKE</span> <span class="token string">'user_orders'</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     <strong>
      关键指标
     </strong>
     ：
    </p>
    <ul>
     <li>
      Data_free &gt; 10% 说明存在严重碎片
     </li>
     <li>
      修复方法：
      <code>
       OPTIMIZE TABLE user_orders;
      </code>
     </li>
    </ul>
    <p>
     <img alt="" src="https://img-blog.csdnimg.cn/img_convert/9b8c4a5b5d5b5e5c5d5b5e5c5d5b5e5c.png"/>
    </p>
    <h4>
     <a id="2__Bookmark_Lookup_38">
     </a>
     2. 🔄 回表查询陷阱（Bookmark Lookup）
    </h4>
    <pre><code class="prism language-sql"><span class="token comment">-- 案例：看似用主键，实则全扫描</span>
<span class="token keyword">EXPLAIN</span> 
<span class="token keyword">SELECT</span> user_id <span class="token keyword">FROM</span> user_orders 
<span class="token keyword">WHERE</span> id <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">=</span> <span class="token number">1000001</span><span class="token punctuation">;</span>  <span class="token comment">-- 对索引列进行运算</span>
</code></pre>
    <p>
     <strong>
      执行计划关键字段
     </strong>
     ：
    </p>
    <ul>
     <li>
      type:
      <strong>
       ALL
      </strong>
     </li>
     <li>
      Extra:
      <strong>
       Using where
      </strong>
     </li>
    </ul>
    <h4>
     <a id="3__Skewed_Data_Distribution_49">
     </a>
     3. 📊 数据分布不均（Skewed Data Distribution）
    </h4>
    <pre><code class="prism language-sql"><span class="token comment">-- 检查数据分布</span>
<span class="token keyword">SELECT</span> 
  <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> total<span class="token punctuation">,</span>
  <span class="token function">MAX</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">MIN</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token keyword">AS</span> range_diff
<span class="token keyword">FROM</span> user_orders<span class="token punctuation">;</span>
</code></pre>
    <p>
     <strong>
      危险信号
     </strong>
     ：
    </p>
    <ul>
     <li>
      range_diff / total &lt; 10 时存在热点
     </li>
     <li>
      解决方案：使用雪花算法生成ID
     </li>
    </ul>
    <h4>
     <a id="4__Lock_Contention_61">
     </a>
     4. 🔒 锁竞争风暴（Lock Contention）
    </h4>
    <pre><code class="prism language-sql"><span class="token comment">-- 查看当前锁状态</span>
<span class="token keyword">SHOW</span> <span class="token keyword">ENGINE</span> <span class="token keyword">INNODB</span> <span class="token keyword">STATUS</span>\G
</code></pre>
    <p>
     <strong>
      重点关注
     </strong>
     ：
    </p>
    <ul>
     <li>
      <strong>
       LOCK WAIT
      </strong>
      字段
     </li>
     <li>
      优化方案：降低事务隔离级别（如RC）
     </li>
    </ul>
    <h4>
     <a id="5__Storage_Engine_Secrets_70">
     </a>
     5. 📂 存储引擎特性（Storage Engine Secrets）
    </h4>
    <pre><code class="prism language-sql"><span class="token comment">-- 修改索引压缩策略</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> user_orders 
ROW_FORMAT<span class="token operator">=</span>COMPRESSED  
KEY_BLOCK_SIZE<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     <strong>
      InnoDB调优参数
     </strong>
     ：
    </p>
    <ul>
     <li>
      innodb_buffer_pool_size = 70%内存
     </li>
     <li>
      innodb_flush_log_at_trx_commit = 2
     </li>
    </ul>
    <h4>
     <a id="6__Hardware_Limitations_81">
     </a>
     6. 💾 硬件性能瓶颈（Hardware Limitations）
    </h4>
    <pre><code class="prism language-sql"><span class="token comment">-- 检查磁盘性能</span>
iostat <span class="token operator">-</span>x <span class="token number">1</span>  <span class="token comment"># Linux系统</span>
</code></pre>
    <p>
     <strong>
      关键指标
     </strong>
     ：
    </p>
    <ul>
     <li>
      %util &gt; 90%
     </li>
     <li>
      await &gt; 10ms
     </li>
    </ul>
    <h3>
     <a id="_90">
     </a>
     三、四步诊断法快速定位问题
    </h3>
    <h4>
     <a id="1_92">
     </a>
     步骤1：查看执行计划
    </h4>
    <pre><code class="prism language-sql"><span class="token keyword">EXPLAIN</span> FORMAT<span class="token operator">=</span>JSON
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> user_orders <span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">1000000</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     <strong>
      核心关注点
     </strong>
     ：
    </p>
    <pre><code class="prism language-json"><span class="token string-property property">"query_cost"</span><span class="token operator">:</span> <span class="token string">"1.00"</span>  <span class="token operator">--</span> 成本值异常偏高
<span class="token string-property property">"rows_examined_per_scan"</span><span class="token operator">:</span> <span class="token number">1</span>
</code></pre>
    <h4>
     <a id="2_103">
     </a>
     步骤2：分析慢查询日志
    </h4>
    <pre><code class="prism language-ini"># my.cnf配置
slow_query_log = 1
long_query_time = 1
log_slow_extra = 1
</code></pre>
    <h4>
     <a id="3_111">
     </a>
     步骤3：检查系统指标
    </h4>
    <pre><code class="prism language-bash"><span class="token comment"># 实时监控工具</span>
mysqladmin <span class="token parameter variable">-u</span> root <span class="token parameter variable">-p</span> ext <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-E</span> <span class="token string">'Queries|Threads_running'</span>
</code></pre>
    <h4>
     <a id="4_117">
     </a>
     步骤4：性能对比测试
    </h4>
    <pre><code class="prism language-sql"><span class="token comment">-- 关闭索引强制全表扫描</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> user_orders 
<span class="token keyword">IGNORE</span> <span class="token keyword">INDEX</span><span class="token punctuation">(</span><span class="token keyword">PRIMARY</span><span class="token punctuation">)</span>
<span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">1000000</span><span class="token punctuation">;</span>
</code></pre>
    <h3>
     <a id="_125">
     </a>
     四、六大优化方案终极指南
    </h3>
    <h4>
     <a id="1_127">
     </a>
     方案1：索引维护策略
    </h4>
    <pre><code class="prism language-sql"><span class="token comment">-- 自动重建碎片索引</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> user_orders 
<span class="token keyword">ALTER</span> <span class="token keyword">INDEX</span> <span class="token keyword">PRIMARY</span> REBUILD<span class="token punctuation">;</span>
</code></pre>
    <h4>
     <a id="2_134">
     </a>
     方案2：查询重写技巧
    </h4>
    <pre><code class="prism language-sql"><span class="token comment">-- 原始低效查询</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> user_orders <span class="token keyword">WHERE</span> <span class="token keyword">YEAR</span><span class="token punctuation">(</span>created_at<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">2023</span><span class="token punctuation">;</span>

<span class="token comment">-- 优化后版本</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> user_orders 
<span class="token keyword">WHERE</span> created_at <span class="token operator">BETWEEN</span> <span class="token string">'2023-01-01'</span> <span class="token operator">AND</span> <span class="token string">'2023-12-31'</span><span class="token punctuation">;</span>
</code></pre>
    <h4>
     <a id="3_144">
     </a>
     方案3：数据冷热分离
    </h4>
    <pre><code class="prism language-sql"><span class="token comment">-- 创建历史数据归档表</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> user_orders_archive <span class="token punctuation">(</span>
  <span class="token keyword">CHECK</span> <span class="token punctuation">(</span>created_at <span class="token operator">&lt;</span> <span class="token string">'2020-01-01'</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> INHERITS <span class="token punctuation">(</span>user_orders<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <h4>
     <a id="4_152">
     </a>
     方案4：参数调优模板
    </h4>
    <pre><code class="prism language-ini"># InnoDB优化参数
innodb_io_capacity = 2000
innodb_lru_scan_depth = 100
</code></pre>
    <h4>
     <a id="5_159">
     </a>
     方案5：硬件升级指南
    </h4>
    <pre><code>NVMe SSD &gt; SAS SSD &gt; SATA SSD
RAID 10 &gt; RAID 5
</code></pre>
    <h4>
     <a id="6_165">
     </a>
     方案6：架构改造方案
    </h4>
    <p>
     <img alt="" src="https://img-blog.csdnimg.cn/img_convert/8f6c9d3a3d7c4c6b9c0e3d3e3b3e3e3e.png"/>
    </p>
    <h3>
     <a id="_168">
     </a>
     五、实战案例：电商订单查询优化
    </h3>
    <h4>
     <a id="_170">
     </a>
     问题描述：
    </h4>
    <ul>
     <li>
      主键查询500ms以上
     </li>
     <li>
      表数据量1.2亿条
     </li>
    </ul>
    <h4>
     <a id="_174">
     </a>
     排查过程：
    </h4>
    <ol>
     <li>
      发现主键为UUID导致页分裂
     </li>
     <li>
      索引碎片率高达35%
     </li>
     <li>
      Buffer pool命中率仅60%
     </li>
    </ol>
    <h4>
     <a id="_179">
     </a>
     解决方案：
    </h4>
    <ol>
     <li>
      改用自增主键
     </li>
     <li>
      启用页压缩
     </li>
     <li>
      调整buffer_pool_size到32G
     </li>
    </ol>
    <h4>
     <a id="_184">
     </a>
     优化结果：
    </h4>
    <p>
     <img alt="" src="https://img-blog.csdnimg.cn/img_convert/9b8c4a5b5d5b5e5c5d5b5e5c5d5b5e5c.png"/>
    </p>
    <h3>
     <a id="_187">
     </a>
     六、调优速查表（收藏版）
    </h3>
    <table>
     <thead>
      <tr>
       <th>
        现象
       </th>
       <th>
        可能原因
       </th>
       <th>
        检查命令
       </th>
       <th>
        解决方案
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        主键查询忽快忽慢
       </td>
       <td>
        热点数据
       </td>
       <td>
        SHOW GLOBAL STATUS
       </td>
       <td>
        分库分表
       </td>
      </tr>
      <tr>
       <td>
        简单查询随机变慢
       </td>
       <td>
        磁盘IO瓶颈
       </td>
       <td>
        iostat -x 1
       </td>
       <td>
        升级SSD
       </td>
      </tr>
      <tr>
       <td>
        索引扫描行数异常
       </td>
       <td>
        统计信息过期
       </td>
       <td>
        ANALYZE TABLE
       </td>
       <td>
        重建统计信息
       </td>
      </tr>
      <tr>
       <td>
        查询偶尔超时
       </td>
       <td>
        锁等待
       </td>
       <td>
        SHOW ENGINE INNODB STATUS
       </td>
       <td>
        降低隔离级别
       </td>
      </tr>
     </tbody>
    </table>
    <h3>
     <a id="_196">
     </a>
     七、结语：透过现象看本质
    </h3>
    <p>
     主键索引不是银弹，需结合：
    </p>
    <ul>
     <li>
      🔍 执行计划分析
     </li>
     <li>
      📈 系统监控数据
     </li>
     <li>
      🧩 存储引擎特性
     </li>
     <li>
      ⚙️ 硬件资源配置
     </li>
    </ul>
    <p>
     <strong>
      调优箴言
     </strong>
     ：
     <br/>
     “优秀的DBA不是会使用工具，而是懂得数据生命的呼吸节奏！”
    </p>
    <blockquote>
     <p>
      <strong>
       技术雷达
      </strong>
      ：根据Percona最新报告，85%的索引性能问题可通过定期维护避免！
     </p>
    </blockquote>
    <pre><code></code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470:733a2f2f626c6f672e6373646e2e6e65742f776c735f676b2f:61727469636c652f64657461696c732f313436303839343134" class_="artid" style="display:none">
 </p>
</div>


