---
layout: post
title: å‰ç«¯é¡¹ç›®éƒ¨ç½²è‡ªåŠ¨æ£€æµ‹æ›´æ–°åé€šçŸ¥ç”¨æˆ·åˆ·æ–°é¡µé¢å‰ç«¯å®ç°,æŠ€æœ¯æ¡†æ¶vuejswebpackæ–¹æ¡ˆä¸€ç¼–è¯‘é¡¹ç›®æ—¶åŠ¨æ€ç”Ÿæˆä¸€ä¸ªè®°å½•ç‰ˆæœ¬å·çš„æ–‡ä»¶
date: 2023-11-27 10:09:07 +0800
categories: ['å‰ç«¯']
tags: ['å‰ç«¯', 'Vue', 'Javascript']
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=134576123
    alt: å‰ç«¯é¡¹ç›®éƒ¨ç½²è‡ªåŠ¨æ£€æµ‹æ›´æ–°åé€šçŸ¥ç”¨æˆ·åˆ·æ–°é¡µé¢å‰ç«¯å®ç°,æŠ€æœ¯æ¡†æ¶vuejswebpackæ–¹æ¡ˆä¸€ç¼–è¯‘é¡¹ç›®æ—¶åŠ¨æ€ç”Ÿæˆä¸€ä¸ªè®°å½•ç‰ˆæœ¬å·çš„æ–‡ä»¶
artid: 134576123
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=134576123
featuredImagePreview: https://bing.ee123.net/img/rand?artid=134576123
---
<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     å‰ç«¯é¡¹ç›®éƒ¨ç½²è‡ªåŠ¨æ£€æµ‹æ›´æ–°åé€šçŸ¥ç”¨æˆ·åˆ·æ–°é¡µé¢ï¼ˆå‰ç«¯å®ç°ï¼ŒæŠ€æœ¯æ¡†æ¶vueã€jsã€webpackï¼‰â€”â€”æ–¹æ¡ˆä¸€ï¼šç¼–è¯‘é¡¹ç›®æ—¶åŠ¨æ€ç”Ÿæˆä¸€ä¸ªè®°å½•ç‰ˆæœ¬å·çš„æ–‡ä»¶
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <h2>
     å‰è¨€
    </h2>
    <p>
     å½“æˆ‘ä»¬é‡æ–°éƒ¨ç½²å‰ç«¯é¡¹ç›®çš„æ—¶å€™ï¼Œå¦‚æœç”¨æˆ·ä¸€ç›´åœç•™åœ¨é¡µé¢ä¸Šå¹¶æœªåˆ·æ–°ä½¿ç”¨ï¼Œä¼šå­˜åœ¨åŠŸèƒ½ä½¿ç”¨å·®å¼‚æ€§çš„é—®é¢˜ï¼Œå› æ­¤ï¼Œå½“å‰ç«¯éƒ¨ç½²é¡¹ç›®åï¼Œéœ€è¦æé†’ç”¨æˆ·æœ‰å»é‡æ–°åŠ è½½é¡µé¢ã€‚
    </p>
    <p>
    </p>
    <h2>
     æŠ€æœ¯æ¡†æ¶
    </h2>
    <p>
     vueã€jsã€webpack
    </p>
    <p>
    </p>
    <h2>
     è§£å†³æ–¹æ¡ˆ
    </h2>
    <ul>
     <li>
      ç¼–è¯‘é¡¹ç›®æ—¶åŠ¨æ€ç”Ÿæˆä¸€ä¸ªè®°å½•ç‰ˆæœ¬å·çš„æ–‡ä»¶
     </li>
     <li>
      è½®è¯¢ï¼ˆ20sã€è‡ªå·±è®¾å®šæ—¶é—´ï¼‰è¿™ä¸ªæ–‡ä»¶ï¼Œåˆ¤æ–­ç‰ˆæœ¬å·ï¼Œæœ‰æ–°ç‰ˆæœ¬åˆ™é€šçŸ¥ç”¨æˆ·åˆ·æ–°é¡µé¢
     </li>
     <li>
      é€šè¿‡ç›‘å¬visibilitychangeäº‹ä»¶ï¼Œåœ¨é¡µé¢éšè—æ—¶åœæ­¢è½®è¯¢ï¼Œé¡µé¢æ˜¾ç¤ºç«‹é©¬æ£€æµ‹ä¸€æ¬¡æ›´æ–°
     </li>
     <li>
      æ£€æµ‹åˆ°æ›´æ–°åï¼Œåœæ­¢è½®è¯¢
     </li>
    </ul>
    <p>
     <img alt="" height="764" src="https://i-blog.csdnimg.cn/blog_migrate/87e2d417d044355b78c9e8636e207f9e.png" width="658"/>
    </p>
    <p>
     ï¼ˆæ„Ÿå…´è¶£çš„å¯å»çœ‹æ–¹æ¡ˆäºŒï¼šæ ¹æ®æ‰“å®ŒåŒ…ä¹‹åç”Ÿæˆçš„
     <code>
      script src çš„hashå€¼å»åˆ¤æ–­
     </code>
     ï¼Œæ¯æ¬¡æ‰“åŒ…éƒ½ä¼šç”Ÿæˆå”¯ä¸€çš„hashå€¼ï¼Œåªè¦è½®è¯¢å»åˆ¤æ–­ä¸ä¸€æ ·äº†ï¼Œé‚£ä¸€å®šæ˜¯é‡æ–°éƒ¨ç½²äº†ã€‚
     <a href="https://blog.csdn.net/qq_44170108/article/details/134577814" title="å‰ç«¯é¡¹ç›®éƒ¨ç½²è‡ªåŠ¨æ£€æµ‹æ›´æ–°åé€šçŸ¥ç”¨æˆ·åˆ·æ–°é¡µé¢ï¼ˆå‰ç«¯å®ç°ï¼ŒæŠ€æœ¯æ¡†æ¶vueã€jsã€webpackï¼‰â€”â€”æ–¹æ¡ˆäºŒï¼šè½®è¯¢å»åˆ¤æ–­æœåŠ¡ç«¯çš„index.htmlæ˜¯å¦è·Ÿå½“å‰çš„index.htmlçš„è„šæœ¬hashå€¼ä¸€æ ·_å‰ç«¯æ›´æ–°åˆ·æ–°é¡µé¢-CSDNåšå®¢">
      å‰ç«¯é¡¹ç›®éƒ¨ç½²è‡ªåŠ¨æ£€æµ‹æ›´æ–°åé€šçŸ¥ç”¨æˆ·åˆ·æ–°é¡µé¢ï¼ˆå‰ç«¯å®ç°ï¼ŒæŠ€æœ¯æ¡†æ¶vueã€jsã€webpackï¼‰â€”â€”æ–¹æ¡ˆäºŒï¼šè½®è¯¢å»åˆ¤æ–­æœåŠ¡ç«¯çš„index.htmlæ˜¯å¦è·Ÿå½“å‰çš„index.htmlçš„è„šæœ¬hashå€¼ä¸€æ ·_å‰ç«¯æ›´æ–°åˆ·æ–°é¡µé¢-CSDNåšå®¢
     </a>
     ï¼‰
    </p>
    <p>
    </p>
    <h2>
     æ•ˆæœ
    </h2>
    <p>
     é¡µé¢å³ä¸‹è§’æç¤ºæ›´æ–°ï¼š
    </p>
    <p>
     <img alt="" height="197" src="https://i-blog.csdnimg.cn/blog_migrate/6ad04288eb5ce668aaf360e8aef1482b.png" width="386"/>
    </p>
    <p>
    </p>
    <h2>
     ä»£ç å®ç°
    </h2>
    <blockquote>
     <p>
      Step1ï¼šåœ¨ vue.config.js å®ç°åŠ¨æ€åˆ›å»ºç‰ˆæœ¬å·æ–‡ä»¶
     </p>
    </blockquote>
    <pre><code class="language-javascript">if (process.env.VUE_APP_ENV !== "production") {
// è¿™é‡Œæˆ‘è®¾ç½®çš„æ˜¯åªåœ¨éç”Ÿäº§ç¯å¢ƒè‡ªåŠ¨æ£€æµ‹æ›´æ–°ï¼ˆç”Ÿæˆversionï¼‰ï¼›
// æƒ³è¦æ‰€æœ‰ç¯å¢ƒéƒ½è‡ªåŠ¨æ£€æµ‹æ›´æ–°ï¼Œåªè¦å†™if(process.env.VUE_APP_ENV !== "production")å†…çš„å†…å®¹å°±å¥½
  const { writeFile, existsSync } = require('fs')
  // åŠ¨æ€ç”Ÿæˆç‰ˆæœ¬å·
  const createVersion = () =&gt; {
    //æ£€æµ‹ç›®å½•æ˜¯å¦å­˜åœ¨
    if (existsSync('./public')) {
      writeFile(`./public/version.json`, `{"version":"${Date.now()}"}`, (err) =&gt; {
        if (err) {
          console.log('å†™å…¥version.jsonå¤±è´¥')
          console.log(err)
        } else {
          console.log('å†™å…¥version.jsonæˆåŠŸ')
        }
      })
    } else {
      setTimeout(createVersion, 1000)
    }
  }
  setTimeout(createVersion, 10000)
}</code></pre>
    <p>
     <img alt="" height="199" src="https://i-blog.csdnimg.cn/blog_migrate/64e40623bd767246edbe033f2d2bb220.png" width="314"/>
    </p>
    <p>
    </p>
    <blockquote>
     <p>
      Step2ï¼šåœ¨srcç›®å½•ä¸‹å°è£… auto-update.js
     </p>
    </blockquote>
    <pre><code class="language-javascript">/*
 * @Description: è‡ªåŠ¨æ›´æ–°
 */

let currentVersion // å½“å‰ç‰ˆæœ¬
let version // æ–°ç‰ˆæœ¬
// const timeData = 60 * 1000 // æ£€æŸ¥é—´éš”æ—¶é—´
const timeData = 20 * 1000 // æ£€æŸ¥é—´éš”æ—¶é—´
let hidden = false // é¡µé¢æ˜¯å¦éšè—
let setTimeoutId
let needTip = true // é»˜è®¤å¼€å¯æç¤º

// è·å–ç‰ˆæœ¬å·
const getVersion = async () =&gt; {
  return fetch('/version.json?timestep=' + Date.now()).then((res) =&gt; res.json())
}

// æ£€æŸ¥æ›´æ–°
const checkUpdate = async () =&gt; {
  console.log('***************checkUpdate**************')
  const currentVersion = sessionStorage.getItem("version")
  version = (await getVersion()).version
  // æœ¬åœ°æ²¡æœ‰ versionï¼Œè¡¨ç¤ºåˆšè¿›å…¥ç³»ç»Ÿï¼Œç›´æ¥å¡å€¼
  if (!currentVersion) return sessionStorage.setItem("version", version)

  console.log("ğŸš€ ~ file: auto-update.js:19 ~ version:", version)
  console.log("ğŸš€ ~ file: auto-update.js:21 ~ currentVersion:", currentVersion)
  console.log("ğŸš€ ~ file: auto-update.js:23 ~ Number(version) !== Number(currentVersion):", Number(version) !== Number(currentVersion))
  let needRefresh = false
  if (Number(version) !== Number(currentVersion)) {
    console.log('%c å‘ç°æ–°ç‰ˆæœ¬~~~~~~', 'color: red')
    needRefresh = true
  }
  return needRefresh
}

// è‡ªåŠ¨æ›´æ–°
const autoUpdate = async () =&gt; {
  setTimeoutId = setTimeout(async () =&gt; {
    // é¡µé¢éšè—äº†å°±ä¸æ£€æŸ¥æ›´æ–°
    if (!hidden) {
      const willUpdate = await checkUpdate()
      console.log("ğŸš€ ~ file: auto-update.js:71 ~ setTimeoutId=setTimeout ~ willUpdate, version:", willUpdate, version)

      if (willUpdate &amp;&amp; needTip) {
        // å»¶æ—¶æ›´æ–°ï¼Œé˜²æ­¢éƒ¨ç½²æœªå®Œæˆç”¨æˆ·å°±åˆ·æ–°ç©ºç™½
        setTimeout(()=&gt;{

          // ----å¼¹æ¡†ç¡®è®¤---å…ˆç®€å•ç‚¹å¼¹æ¡†ç¡®è®¤ï¼Œå¯ä»¥ç”¨æ³¨é‡Šå†…çš„ï¼Œè·³è¿‡å³ä¸‹è§’é€šçŸ¥çš„å†…å®¹ï¼ˆStep3ã€4ï¼‰
          // const result = confirm('å‘ç°æ–°ç‰ˆæœ¬ï¼Œç‚¹å‡»ç¡®å®šæ›´æ–°')
          // if (result) {
          //   sessionStorage.setItem('version', version)
          //   location.reload() // åˆ·æ–°å½“å‰é¡µ
          // }
          // --------------
          
          //*****å³ä¸‹è§’é€šçŸ¥æç¤º */
          window.dispatchEvent(
            new CustomEvent("onmessageUpdate", {
              detail: {
                msg: "å‘ç°ç³»ç»Ÿç‰ˆæœ¬æ›´æ–°ï¼Œè¯·åˆ·æ–°é¡µé¢~",
                version: version
              },
            })
          )
          //******************* */

        }, 10000)
        needTip = false // å…³é—­æ›´æ–°æç¤ºï¼Œé˜²æ­¢é‡å¤æé†’
      }
    }
    console.log("ğŸš€ ~ file: auto-update.js:90 ~ autoUpdate ~ needTip: ", needTip)
    if (needTip) {
      console.warn('needTip autoUpdate');
      autoUpdate()
    }
  }, timeData)
}

// åœæ­¢æ£€æµ‹æ›´æ–°
const stop = () =&gt; {
  if (setTimeoutId) {
    clearTimeout(setTimeoutId)
    setTimeoutId = ''
  }
}

// å¼€å§‹æ£€æŸ¥æ›´æ–°
const start = async () =&gt; {
  // currentVersion = (await getVersion()).version
  autoUpdate()
  // ç›‘å¬é¡µé¢æ˜¯å¦éšè—
  document.addEventListener('visibilitychange', () =&gt; {
    hidden = document.hidden
    console.log("ğŸš€ ~ file: auto-update.js:64 ~ document.addEventListener ~ hidden, needTip:", hidden, needTip)
    // é¡µé¢éšè—äº†å°±ä¸æ£€æŸ¥æ›´æ–°ã€‚æˆ–è€…å·²ç»æœ‰ä¸€ä¸ªæç¤ºæ¡†äº†ï¼Œé˜²æ­¢é‡å¤æç¤ºã€‚
    if (!hidden &amp;&amp; needTip) {
      autoUpdate()
    } else {
      stop()
    }
  })
}

export default { start }

</code></pre>
    <p>
    </p>
    <blockquote>
     <p>
      Step3ï¼šç¼–å†™æ¨¡æ¿ CnNotify.vue æ–‡ä»¶
     </p>
    </blockquote>
    <pre><code class="language-html">&lt;template&gt;
  &lt;div class="cn_notify"&gt;
    &lt;div class="content"&gt;
      &lt;i class="el-icon-message-solid"&gt;&lt;/i&gt;
      {<!-- -->{ msg }}
    &lt;/div&gt;
    &lt;div class="footer"&gt;
      &lt;el-row class="btnBox"&gt;
        &lt;el-button type="primary" @click="onSubmit"&gt;ç¡®è®¤åˆ·æ–°&lt;/el-button&gt;
        &lt;el-button @click="cancle"&gt;æˆ‘çŸ¥é“äº†&lt;/el-button&gt;
      &lt;/el-row&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;
&lt;script&gt;
export default {
  props: {
    msg: {
      type: String,
      default: '',
    },
    version: {
      type: String,
      default: '',
    },
  },
  data() {
    return {};
  },
  created() {},
  methods: {
    // ç‚¹å‡»ç¡®å®šæ›´æ–°
    onSubmit() {
      sessionStorage.setItem('version', this.version) // å­˜å…¥ç‰ˆæœ¬version
      location.reload() // åˆ·æ–°
    },
    // å…³é—­
    cancle() {
      this.$parent.close();
    },
  },
};
&lt;/script&gt;
&lt;style lang='scss' scoped&gt;
.cn_notify {
  .content {
    padding: 20px 0;
  }
  .footer {
    display: flex;
    justify-content: center;
  }
}
&lt;/style&gt;
&lt;style lang='scss'&gt;
.versionNotifyStyle {
  .el-notification__content {
    width: 280px !important;
  }
}
&lt;/style&gt;
</code></pre>
    <p>
    </p>
    <blockquote>
     <p>
      Step4ï¼šapp.vue ä½¿ç”¨ç»„ä»¶CnNotify
     </p>
    </blockquote>
    <pre><code class="language-html">&lt;template&gt;
  &lt;div id="app"&gt;
    &lt;router-view /&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script&gt;
// å¼•å…¥CnNotifyç»„ä»¶
import CnNotify from "@/components/common/CnNotify/index.vue"
export default  {
  name:  'App',
  components: {
    CnNotify, // æ³¨å†Œç»„ä»¶
  },
  mounted() {
    this.watchUpdate()
  },
  methods: {
      watchUpdate() {
        window.addEventListener("onmessageUpdate", (res) =&gt; {
          console.log("ğŸš€ ~ file: App.vue:20 ~ window.addEventListener ~ res:", res)
          let msg = res.detail.msg,
          version = res.detail.version
          this.$notify({
            title: "ç‰ˆæœ¬æ›´æ–°æç¤º",
            duration: 0,
            position: "bottom-right",
            dangerouslyUseHTMLString: true,
            message: this.$createElement("CnNotify", {
              // ä½¿ç”¨è‡ªå®šä¹‰ç»„ä»¶
              ref: "CnNotify",
              props: {
                msg: msg,
                version: version
              },
            }),
            customClass:'versionNotifyStyle', //è‡ªå®šä¹‰ç±»å
          })
        })
      },
  },
}
&lt;/script&gt;
</code></pre>
    <p>
    </p>
    <blockquote>
     <p>
      Step5ï¼šåœ¨ main.js å†…ä½¿ç”¨
     </p>
    </blockquote>
    <pre><code class="language-javascript">// å¼•å…¥è‡ªåŠ¨æ›´æ–°æé†’
import autoUpdate from './auto-update'
// éç”Ÿäº§ç¯å¢ƒä½¿ç”¨
process.env.VUE_APP_ENV !== 'production' &amp;&amp; autoUpdate.start()

</code></pre>
    <p>
    </p>
   </div>
  </div>
 </article>
</div>


