---
title: 2023-01-10-计算机网络与通信之网络互联及通信
date: 2023-01-10 13:36:01 +0800
categories: ['计算机网络与通信']
tags: ['路由器', '网络', '子网掩码', 'Acl']
image:
  path: https://api.vvhan.com/api/bing?rand=sj&artid=106455169
  alt: 计算机网络与通信之网络互联及通信
artid: 106455169
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=106455169
featuredImagePreview: https://bing.ee123.net/img/rand?artid=106455169
---

# 计算机网络与通信之网络互联及通信

这部分的内容主要围绕网络层来展开:

1. [网络层概述](#1)
2. [网际协议IPv4](#2)
3. [地址解析协议ARP](#3)
4. [网际控制报文协议ICMP](#4)
5. [互联网路由协议](#5)

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/234670ad6528d1310b25fa46bb761a43.png)

## 1. 网络层概述

### 网络的互联问题

大规模的计算机网络一般采用分层组网技术，即网络互联。原因：

* 避免大规模网络交换机寻址的复杂性；
* 解决不同物理网络（异构网络）的兼容性。

Internet网络层采用IP协议，其核心就是如何解决现有计算机网络的互联。

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/6a0927e813b366a9966762c8241ed9e8.png)
  
![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/fd03e3dd81a764458a6999f82f2e6e70.png)

#### 网际层的 IP 协议及配套协议

网际协议 IP 是 TCP/IP 体系中两个最主要的协议之一。

与之配套的还有三个协议：

* 地址解析协议 ARP
* 网际控制报文协议 ICMP
* 网际组管理协议 IGMP

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/1fc1c5a00b92ff42347409252e67581f.png)

### 网络层的功能

网络层是为传输层提供服务的，传送的协议数据单元称为数据包或分组。该层的主要作用是解决如何使数据包通过各结点传送的问题，即通过路径选择算法（路由）将数据包送到目的地。另外，为避免通信子网中出现过多的数据包而造成网络阻塞，需要对流入的数据包数量进行控制（拥塞控制）。当数据包要跨越多个通信子网才能到达目的地时，还要解决网络互联的问题。

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/dbf9f7542cf41b95fdaa0de67f4a9fc3.png)

* 定义了基于IP协议的逻辑地址
* 连接不同的媒介类型
* 选择数据通过网络的最佳路径

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/5ef16003fb0e8a7388ac372061e21110.png)
  
互联网可以由多种异构网络互连组成

### 服务模型

网络层提供的两种服务 ：

1. 面向无连接的数据报服务；
2. 面向连接的虚电路服务。

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/713ad1bd91b2ef4e70ae379446c220cb.png)

#### 虚电路是逻辑连接

虚电路表示这只是一条逻辑上的连接，分组都沿着这条逻辑连接按照存储转发方式传送，而并不是真正建立了一条物理连接。

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/334ceb3cdbf73362c7b91753c2e02a7c.png)

#### 数据报---因特网采用的设计思路

Internet网络层向上提供简单灵活的、无连接的、尽最大努力交付的数据报服务。

网络在发送分组时不需要先建立连接。每一个分组（即 IP 数据报）独立发送，与其前后的分组无关（不进行编号）。

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/85f5317431e77d0c3d03cc74f8612de9.png)

#### 尽最大努力交付的好处

网络层不提供服务质量的承诺。即所传送的分组可能出错、丢失、重复和失序（不按序到达终点），当然也不保证分组传送的时限。 因此，网络中的路由器可以做得比较简单且价格低廉（与电信网的交换机相比较）。

如果主机（即端系统）中的进程之间的通信需要是可靠的，由网络的主机中的运输层负责（包括差错处理、流量控制等）。

采用这种设计思路的好处是：网络的造价大大降低，运行方式灵活，能够适应多种应用。

因特网能够发展到今日的规模，充分证明了当初采用这种设计思路的正确性。

#### 虚电路服务与数据报服务的对比

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/aa3075ace06211e5e46761e98df8d8de.png)

## 2. 网际协议IPv4

### IPv4协议概述

IP是英文Internet Protocol（网际互连协议）的缩写，是TCP/IP体系中的网络层协议，IP /将不同网络技术在TCP/IP的网络层统一起来，提供对异构网络互连的支持。目前常用的版本是IPv4。

IP提供一种
**无连接、不可靠的、尽力而为的**
数据报传输服务。为了能适应异构网络，IP强调适应性、简洁和可操作性，并在可靠性做了一定的牺牲。IP不保证分组的交付时限，所传送分组有可能出现丢失、重复、延迟或乱序等问题。

IP协议的主要内容包含三方面：

* IP编址规范
* 分组封装格式
* 分组转发规则

1. IP协议：
     
   不可靠、无连接、数据报交付协议
2. IP分组格式：
     
   数据报：首部 + 数据
     
   首部：各字段的含义、作用、取值
     
   （长度、TTL、协议、片标志、片偏移、校验和）
     
   封装：直接封装在数据帧中
3. IP分组处理：
     
   TTL、校验和计算、分片和重组、选项处理

### IPv4地址的编址方案

#### 一、IP地址的含义、结构与表示方法

我们把整个因特网看成为一个单一的、抽象的网络。IP 地址就是给每个连接在因特网上的主机（或路由器）分配一个在全世界范围是唯一的 32 位的标识符。

IP 地址现在由因特网名字与号码指派公司ICANN (Internet Corporation for Assigned Names and Numbers)进行分配。

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/2b4300f233bbfc5d1c6617bd8b224110.png)

##### IP地址的结构

IP地址是分层的。每一个IP地址都由两个固定长度的字段组成，其中一个字段是网络号 net-id，它标志主机（或路由器接口）所连接到的网络，而另一个字段则是主机号 host-id，它标志该主机（或路由器接口）。

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/0c252c543f620258c9b918a77a5478b2.png)

主机号在它前面的网络号所指明的网络范围内必须是唯一的。

由此可见，一个 IP 地址在整个互联网范围内是唯一的。

##### 点分十进制表示法

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/21b7594ac970b1cc6665f5f9e9f6064f.png)
  
![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/025c83b6a02c9da9459469f547c294d5.png)
  
![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/f443da116b001794fff10a3f68bba8d0.png)
  
![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/c52e71dc33af4318b4d3369605ba24b3.png)

#### 二、分类的IP地址

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/74fced60b3197102f368b06f9cf21684.png)
  
1个字节是8位

##### 常用的三种类别的 IP 地址

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/67972d892c2e543d9991d35f08db6a53.png)

##### 一般不使用的特殊的 IP 地址

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/da8b893024bef82e21011e91ca526285.png)

##### IP地址分类练习1

一个B类的IP网络172.17.0.0，如果将这个B类的网络划分4个子网，请问：
  
1）每个子网的网络掩码是什么？
  
2）每个子网的网络地址是什么？
  
3）每个子网的IP主机范围是什么？

子网掩码：255.255.192（11000000）.0

子网一的网络地址：172.17.0（00000000）.0
  
主机范围：172.17.0.1-172.17.255.254

子网二的网络地址：172.17.64（01000000）.0
  
主机范围：172.17.64.1-172.17.127（011111111）.254

子网三的网络地址：172.17.128（10000000）.0
  
主机范围：172.17.128.1-172.17.191（10111111）.254

子网四的网络地址：172.17.192（11000000）.0
  
主机范围：172.17.192.1-172.17.255.254

##### IP地址分类练习2

已知地址块中的一个地址是190.87.140.202/29。试求这个地址块中的最小地址和最大地址。地址掩码是什么？地址块中共有多少个地址？相当于多少个C类地址？

答:
  
![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/54237e2e8e3ddb4020ae0f104f78ab83.png)

#### 三、可划分子网的IP地址

##### 1. 从两级 IP 地址到三级 IP 地址

在 ARPANET 的早期，IP 地址的设计确实不够合理：

1. 两级的 IP 地址不够灵活，使得 IP 地址空间的利用率有时很低（如B类）。
2. 给每一个物理网络分配一个网络号会使路由表变得太大因而使网络性能变坏。

从 1985 年起在 IP 地址中又增加了一个“子网号字段”，使两级的 IP 地址变成为三级的 IP 地址。这种做法叫做划分子网 (subnetting) 。
  
划分子网已成为互联网的正式标准协议。

###### 划分子网的基本思路

划分子网纯属一个单位内部的事情。单位对外仍然表现为没有划分子网的网络。

从主机号借用若干个位作为子网号 subnet-id，而主机号 host-id 也就相应减少了若干个位。

凡是从其他网络发送给本单位某个主机的 IP 数据报，仍然是根据 IP 数据报的目的网络号 net-id，先找到连接在本单位网络上的路由器。

然后此路由器在收到 IP 数据报后，再按目的网络号 net-id 和子网号 subnet-id 找到目的子网。

最后就将 IP 数据报直接交付目的主机。

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/3b4c5b1778045e58ae7242152f41618f.png)

###### 一个未划分子网的 B 类网络145.13.0.0

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/9a9df42dbabf28d8ba73a68f2fd84102.png)

###### 划分为三个子网后对外仍是一个网络

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/717155858341173f611e4e9ce14f8576.png)

##### 2. 子网掩码

从一个 IP 数据报的首部并无法判断源主机或目的主机所连接的网络是否进行了子网划分。

使用子网掩码 (subnet mask) 可以找出 IP 地址中的子网部分。

规则：

* 子网掩码长度 ＝ 32 位
* 某位 ＝ 1：IP地址中的对应位为网络号和子网号
* 某位 ＝ 0：IP地址中的对应位为主机号

###### IP 地址的各字段和子网掩码

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/95ad08dc89b95ba97a97e75ed9bcedff.png)
  
(IP 地址) AND (子网掩码) =网络地址:
  
![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/1cc73ad1dba99e75203dfa581943d112.png)

###### 分类IP地址的默认子网掩码

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/6af32d47653c313dfb3bcd6762db705a.png)

###### 子网掩码是一个重要属性

子网掩码是一个网络或一个子网的重要属性。

路由器在和相邻路由器交换路由信息时，必须把自己所在网络（或子网）的子网掩码告诉相邻路由器。

路由器的路由表中的每一个项目，除了要给出目的网络地址外，还必须同时给出该网络的子网掩码。

若一个路由器连接在两个子网上就拥有两个网络地址和两个子网掩码。

###### B 类地址的子网划分选择（使用固定长度子网）

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/aa8d1da5fea34415dda0f3b597df7a38.png)
  
表中的“子网号的位数”中没有 0, 1, 15 和 16 这四种情况，因为这没有意义。

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/0738c28814ac9487e41df6dc24013b08.png)
  
![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/bb25d107a69000eb5ce028ceea58735d.png)

#### 四、无分类编址方法CIDR

划分子网在一定程度上缓解了互联网在发展中遇到的困难。然而在 1992 年互联网仍然面临三个必须尽早解决的问题：

1. B 类地址在 1992 年已分配了近一半，眼看就要在 1994 年 3 月全部分配完毕！
2. 互联网主干网上的路由表中的项目数急剧增长（从几千个增长到几万个）。
3. 整个 IPv4 的地址空间最终将全部耗尽。

所以，又进一步研究出无分类编址方法，它的正式名字是无分类域间路由选择 CIDR (Classless Inter-Domain Routing)。

##### CIDR 最主要的特点

CIDR 消除了传统的 A 类、B 类和 C 类地址以及划分子网的概念，因而可以更加有效地分配 IPv4 的地址空间。

CIDR使用各种长度的“网络前缀”(network-prefix)来代替分类地址中的网络号和子网号。

IP 地址从三级编址（使用子网掩码）又回到了两级编址:
  
![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/af4da9d19dccad203eb8bb9aaeaa917f.png)

##### 无分类的两级编址

无分类的两级编址的记法是： “斜线记法”(slash notation)，它又称为 CIDR 记法，即在 IP 地址后面加上一个斜线“/”，然后写上网络前缀所占的位数（这个数值对应于三级编址中子网掩码中 1 的个数）。例如： 220.78.168.0/24

##### CIDR 地址块

CIDR 把网络前缀都相同的连续的 IP 地址组成“CIDR 地址块”。

128.14.32.0/20 表示的地址块共有 212 个地址（因为斜线后面的 20 是网络前缀的位数，所以这个地址的主机号是 12 位）。

这个地址块的起始地址是 128.14.32.0。

在不需要指出地址块的起始地址时，也可将这样的地址块简称为“/20 地址块”。

128.14.32.0/20 地址块的最小地址：128.14.32.0
  
128.14.32.0/20 地址块的最大地址：128.14.47.255

**全 0 和全 1 的主机号地址一般不使用**
。
  
![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/c9fffe9083bc092d6ea2e5a414a94079.png)

##### 路由聚合 (route aggregation)

一个 CIDR 地址块可以表示很多地址，这种地址的聚合常称为路由聚合，它使得路由表中的一个项目可以表示很多个（例如上千个）原来传统分类地址的路由。

路由聚合有利于减少路由器之间的路由选择信息的交换，从而提高了整个互联网的性能。

路由聚合也称为构成超网 (Supernetting)。

CIDR 虽然不使用子网了，但仍然使用“掩码”这一名词（但不叫子网掩码）。

对于 /20 地址块，它的掩码是 20 个连续的 1。 斜线记法中的数字就是掩码中1的个数。

##### 常用的 CIDR 地址块

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/7a9ff35f0e7ab605d8b360cecd16d030.png)

#### 五、NAT技术

随着移动设备和家庭网络的的增多，IP地址愈来愈少。IETF于1994年提出新的IP编址方案：网络地址转换 NAT (Network Address Translation) 方法。

从三类地址中指定一些内部寻址地址（私有地址或本地地址）:

* 1个A类地址段 10.0.0.0 --10.255.255.255
* 16个B类地址段 172.16.0.0–172.31.255.255
* 256个C类地址段 192.168.0.0–192.168.255.255

这些地址属于非注册地址，它不需要申请，其特点是只能在一个机构内部使用，不能和因特网上的主机通信，因为路由器默认对于目的地址是私有地址的IP数据报一律不转发。

##### NAT 路由器的工作原理

装有 NAT 软件的路由器叫做 NAT路由器，它至少有一个有效的外部全球IP地址。

所有使用本地地址的主机在和外界通信时，都要在 NAT 路由器上将其本地地址转换成全球 IP 地址，才能和互联网连接。

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/8d2f3913e70c3151165ff9c9ed85622b.png)

##### 网络地址转换的过程

在内部主机与外部主机通信时，在NAT路由器上发生了两次地址转换：

* 离开专用网时：替换源地址，将内部地址替换为全球地址；
* 进入专用网时：替换目的地址，将全球地址替换为内部地址；

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/d65d3c5059ad233b57638de09e87fa4f.png)

##### 网络地址与端口号转换 NAPT

为了更加有效地利用 NAT 路由器上的全球IP地址，现在常用的 NAT 转换表把运输层的端口号也利用上。这样，就可以使多个拥有本地地址的主机，共用一个 NAT 路由器上的全球 IP 地址，因而可以同时和互联网上的不同主机进行通信。

使用端口号的 NAT 叫做网络地址与端口号转换NAPT (Network Address and Port Translation)，而不使用端口号的 NAT 就叫做传统的 NAT (traditional NAT)。

##### NAPT 地址转换表举例

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/6c601f7502596574c175167b2aab4969.png)
  
NAPT把专用网内不同的源 IP 地址，都转换为同样的全球 IP 地址。但对源主机所采用的 TCP 端口号（不管相同或不同），则转换为不同的新的端口号。

因此，当 NAPT 路由器收到从互联网发来的应答时，就可以从 IP 数据报的数据部分找出运输层的端口号，然后根据不同的目的端口号，从 NAPT 转换表中找到正确的目的主机。

### IPv4分组的封装格式

一个 IP 数据报由首部和数据两部分组成。

首部的前一部分是固定长度，共 20 字节，是所有 IP 数据报必须具有的。

在首部的固定部分的后面是一些可选字段，其长度是可变的。

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/ebbb7b10cc3a2b56cc160c3fceba1dee.png)

* **版本**
  ——占 4 位，指 IP 协议的版本。目前的 IP 协议版本号为 4 (即 IPv4)。
* **首部长度**
  ——占 4 位，可表示的最大数值是 15 个单位(一个单位为 4 字节)，因此 IP 的首部长度的最大值是 60 字节。
* **区分服务**
  ——占 8 位，用来获得更好的服务。在旧标准中叫做服务类型，但实际上一直未被使用过。1998 年这个字段改名为区分服务。
* **总长度**
  ——占 16 位，指首部和数据之和的长度，单位为字节，因此数据报的最大长度为 65535 字节。总长度必须不超过最大传送单元 MTU。
* **标识**
  (identification) ——占 16 位，它是一个计数器，用来产生 IP 数据报的标识。它和后边的字段：标志和片偏移一起用于IP分片。
* **标志**
  (flag) ——占 3 位，目前只有前两位有意义。标志字段的最低位是 MF (More Fragment)。MF = 1 表示后面“还有分片”。MF =0 表示最后一个分片。标志字段中间的一位是 DF (Don’t Fragment) 。只有当 DF = 0 时才允许分片。
* **片偏移**
  ——占13 位，指出：较长的分组在分片后某片在原分组中的相对位置。片偏移以 8 个字节为偏移单位。
* **生存时间**
  ——占8 位，记为 TTL (Time To Live)，指示数据报在网络中可通过的路由器数的最大值。
* **协议**
  ——占8 位，指出此数据报携带的数据使用何种协议，以便目的主机的 IP 层将数据部分上交给那个处理过程
* **首部检验和**
  ——占16 位，只检验数据报的首部，不检验数据部分。这里不采用 CRC 检验码而采用简单的计算方法。
    
  源地址和目的地址都各占 4 字节

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/d87edd15f6d70d47e10c74a8b02d1914.png)

#### 【例】 IP 数据报分片

一数据报的总长度为 3820 字节，其数据部分的长度为 3800 字节（使用固定首部），需要分片为长度不超过 1420 字节的数据报片。

因固定首部长度为 20 字节，因此每个数据报片的数据部分长度不能超过 1400 字节。

于是分为 3 个数据报片，其数据部分的长度分别为 1400、1400 和 1000 字节。

原始数据报首部被复制为各数据报片的首部，但必须修改有关字段的值。

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/4b0b1fb912596e303c7d7e344b256be9.png)
  
IP 数据报首部中与分片有关的字段中的数值:

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/5f1cf71ffd60d4f71f9e8820a56d0074.png)

### IP层分组的转发方法

路由器转发一个分组需要处理的工作：

* 首部校验，并丢弃无效的分组；
* 首部中的TTL减一，并丢弃到期的分组；
* 分片处理；
* 路由选择；
* 转发–路由器
  **仅根据网络地址进行转发**
  。

当IP数据包经由路由器转发时，如果目标网络与本路由器直接相连，则直接将数据包交付给目标主机，这称为直接交付；

否则，路由器通过路由表查找路由信息，并将数据包转交给指明的下一跳路由器，这称为间接交付。

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/f75158f500ae3eda475b042e14f4b2c2.png)
  
假设有四个 A 类网络通过三个路由器连接在一起。每一个网络上都可能有成千上万个主机。可以想像，若按目的主机号来制作路由表，每一个路由表就有 4 万个项目，即 4 万行（每一行对应于一台主机），则所得出的路由表就会过于庞大。但若按主机所在的网络地址来制作路由表，那么每一个路由器中的路由表就只包含 4 个项目（每一行对应于一个网络），这样就可使路由表大大简化。

#### 特定主机路由和默认路由

虽然互联网所有的分组转发都是基于目的主机所在的网络，但在大多数情况下都允许有这样的特例，即为特定的目的主机指明一个路由。

采用特定主机路由可使网络管理人员能更方便地控制网络和测试网络，同时也可在需要考虑某种安全问题时采用这种特定主机路由。

路由器还可采用默认路由以减少路由表所占用的空间和搜索路由表所用的时间。

这种转发方式在一个网络只有很少的对外连接时是很有用的。

默认路由是指当路由表中找不到匹配的出口表项时，路由器采取的路由选择。

#### 默认路由举例

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/c201d6d470833cfb3e3a10588b3a41c2.png)

#### IP层分组的转发规则总结

(1) 从数据报的首部提取目的主机的 IP 地址 D, 得出目的网络地址为 N。
  
(2) 若网络 N 与此路由器直接相连，则把数据报直接交付目的主机 D；否则是间接交付，执行 (3)。
  
(3) 若路由表中有目的地址为 D 的特定主机路由，则把数据报传送给路由表中所指明的下一跳路由器；否则，执行 (4)。
  
(4) 若路由表中有到达网络 N 的路由，则把数据报传送给路由表指明的下一跳路由器；否则，执行 (5)。
  
(5) 若路由表中有一个默认路由，则把数据报传送给路由表中所指明的默认路由器；否则，执行 (6)。
  
(6) 报告转发分组出错。

#### 使用子网时分组的转发

在不划分子网的两级 IP 地址下，从 IP 地址得出网络地址是个很简单的事。
  
但在划分子网的情况下，从 IP 地址却不能唯一地得出网络地址来，这是因为网络地址取决于那个网络所采用的子网掩码，但数据报的首部并没有提供子网掩码的信息。

因此分组转发的算法也必须做相应的改动。

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/8e790c1c8661c9bfd007a452b5840d7d.png)
  
要发送的分组的目的 IP 地址：128.30.33.138

因此 H1 首先检查主机 128.30.33.138 是否连接在本网络上
  
如果是，则直接交付；否则，就送交路由器 R1，并逐项查找路由表。

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/314fc683fb9805eb834b30564c461c0b.png)

因此 H1 必须把分组传送到路由器 R1然后逐项查找路由表:
  
![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/4a2ccd6ee89c97bbaed8806c5cf6be53.png)
  
![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/a56c1a6519db951710500ca0f29495e0.png)

#### 在划分子网情况下路由器转发分组的算法

(1) 从收到的分组的首部提取目的 IP 地址 D。
  
(2) 先用各网络的子网掩码和 D 逐位相“与”，看是否和相应的网络地址匹配。若匹配，则将分组直接交付。否则就是间接交付，执行 (3)。
  
(3) 若路由表中有目的地址为 D 的特定主机路由，则将分组传送给指明的下一跳路由器；否则，执行 (4)。
  
(4) 对路由表中的每一行，将子网掩码和 D 逐位相“与”。若结果与该行的目的网络地址匹配，则将分组传送给该行指明的下一跳路由器；否则，执行 (5)。
  
(5) 若路由表中有一个默认路由，则将分组传送给路由表中所指明的默认路由器；否则，执行 (6)。
  
(6) 报告转发分组出错。

必须强调指出 :
  
IP 数据报的首部中没有地方可以用来指明“下一跳路由器的 IP 地址”。

当路由器收到待转发的数据报，不是将下一跳路由器的 IP 地址填入 IP 数据报，而是送交下层的网络接口软件。

网络接口软件使用 ARP 负责将下一跳路由器的 IP 地址转换成硬件地址，并将此硬件地址放在链路层的 MAC 帧的首部，然后根据这个硬件地址找到下一跳路由器。

## 3. 地址解析协议ARP

通信时使用了两个地址：

* IP 地址（网络层地址）
* MAC 地址（数据链路层地址）

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/9bfb2ce9bdfbf5b9f96a80f0a3cbadad.png)

### 地址解析协议 ARP 的作用

已经知道了一个机器（主机或路由器）的IP地址，如何找出其相应的硬件地址？

地址解析协议 ARP 就是用来解决这样的问题的。

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/edb13ba15a2cc3e73224325dfcd01e8f.png)

ARP 作用：
  
从网络层使用的 IP 地址，解析出在数据链路层使用的硬件地址。

### 地址解析协议 ARP 要点

不管网络层使用的是什么协议，在实际网络的链路上传送数据帧时，最终还是必须使用硬件地址。

当主机 A 欲向本局域网上的某个主机 B 发送 IP 数据报时，就先在其 ARP 高速缓存中查看有无主机 B 的 IP 地址:

* 如有，就可查出其对应的硬件地址，再将此硬件地址写入 MAC 帧，然后通过局域网将该 MAC 帧发往此硬件地址。
* 如没有， ARP 进程在本局域网上广播发送一个 ARP 请求分组。收到 ARP 响应分组后，将得到的 IP 地址到硬件地址的映射写入 ARP 高速缓存。

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/7ce041c7a053fb14cf0051b93ff5192a.png)

### ARP 高速缓存的作用

每一个主机都设有一个 ARP 高速缓存 (ARP cache)，里面有所在的局域网上的各主机和路由器的 IP 地址到硬件地址的映射表。里面存放最近获得的 IP 地址到 MAC 地址的绑定，以减少 ARP 广播的数量。

为了减少网络上的通信量，主机 A 在发送其 ARP 请求分组时，就将自己的 IP 地址到硬件地址的映射写入 ARP 请求分组。

当主机 B 收到 A 的 ARP 请求分组时，就将主机 A 的这一地址映射写入主机 B 自己的 ARP 高速缓存中。这对主机 B 以后向 A 发送数据报时就更方便了。

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/82a9bf811594d040cc571cc9d26fcfdf.png)

### 应当注意的问题

ARP 是解决同一个局域网上的主机或路由器的 IP 地址和硬件地址的映射问题。

如果所要找的主机和源主机不在同一个局域网上，那么就要通过 ARP 找到一个位于本局域网上的某个路由器的硬件地址，然后把分组发送给这个路由器，让这个路由器把分组转发给下一个网络。剩下的工作就由下一个网络来做。

从 IP 地址到硬件地址的解析是自动进行的，主机的用户对这种地址解析过程是不知道的。

只要主机或路由器要和本网络上的另一个已知 IP 地址的主机或路由器进行通信，ARP 协议就会自动地将该 IP 地址解析为链路层所需要的硬件地址。

## 4. 网际控制报文协议ICMP

为了更有效地转发 IP 数据报和提高交付成功的机会，在网际层使用了网际控制报文协议 ICMP (Internet Control Message Protocol)。ICMP 允许主机或路由器报告差错情况和提供有关异常情况的报告。

ICMP 报文的种类有两种，即 ICMP 差错报告报文和 ICMP 询问报文。

ICMP 报文的前 4 个字节是统一的格式，共有三个字段：即类型、代码和检验和。接着的 4 个字节的内容与 ICMP 的类型有关。

### ICMP 报文的格式

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/b5a7126b8250a601a88249d02fa666fc.png)

### 常见的ICMP报文类型

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/759c905272213cfea6e546d9bb116de0.png)
  
![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/b8ba39ec5ae321cbef08baaf6a48b70f.png)

### ICMP 差错报告报文的数据字段的内容

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/d76742c9d88a6236334ca55bb2aeed29.png)

### PING (Packet InterNet Groper) 的应用举例

PING 用来测试两个主机之间的连通性。

PING 使用了 ICMP 回送请求与回送回答报文。

PING 是应用层直接使用网络层 ICMP 的例子，它没有通过运输层的 TCP 或UDP。

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/4e976aa8f91434b066a8d676c7f5a4d8.png)

### Traceroute 的应用举例

在 Windows 操作系统中这个命令是 tracert。用来跟踪一个分组从源点到终点的路径。

它利用 IP 数据报中的 TTL 字段和 ICMP 时间超过差错报告报文实现对从源点到终点的路径的跟踪。

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/f5d9868d34f8bcbc9575bd58ab6962d8.png)

## 5. 互联网路由协议

### 路由的几个基本概念

#### 一、路由选择是个非常复杂的问题。

全局性：它是网络中的所有结点共同协调工作的结果。
  
动态性：路由选择的环境往往是不断变化的，而这种变化有时无法事先知道。

#### 二、关于“最佳路由”

不存在一种绝对的最佳路由算法。
  
所谓“最佳”只能是相对于某一种特定要求下得出的较为合理的选择而已。

#### 三、静态路由和动态路由

静态路由—即非自适应路由选择，其特点是简单和开销较小，但不能及时适应网络状态的变化。
  
动态路由—即自适应路由选择，其特点是能较好地适应网络状态的变化，但实现起来较为复杂，开销也比较大。

#### 四、分层次的路由选择协议

**自治系统**
：在单一的技术管理下的一组路由器，而这些路由器使用一种 AS 内部的路由选择协议和共同的度量以确定分组在该 AS 内的路由，同时还使用一种 AS 之间的路由选择协议用以确定分组在 AS之间的路由。

**内部网关协议 IGP**
：具体的协议有多种，如 RIP 和 OSPF 等。

**外部网关协议 EGP**
：目前使用的协议就是 BGP。

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/4a66e62ebc6b89dc9d850190c3b1a10c.png)

### 内部网关协议 RIP

路由信息协议 RIP (Routing Information Protocol) 是内部网关协议 IGP 中最先得到广泛使用的协议。

RIP 是一种分布式的、基于距离向量的路由选择协议。

RIP 认为一个好的路由就是它通过的路由器的数目少，即“距离短”。

RIP 协议要求网络中的每一个路由器都要维护从它自己到其他每一个目的网络的距离记录。

#### “距离”的定义

从一个路由器到直接连接的网络的距离定义为 1。

RIP 协议中的“距离”也称为“跳数”(hop count)，因为每经过一个路由器，跳数就加 1。

RIP 允许一条路径最多只能包含 15 个路由器。

“距离”的最大值为 16 时即相当于不可达。可见 RIP 只适用于小型互联网。
  
RIP 不能在两个网络之间同时使用多条路由。RIP 选择一个具有最少路由器的路由（即最短路由），哪怕还存在另一条高速(低时延)但路由器较多的路由。

#### RIP 协议的三个特点

1. 仅和相邻路由器交换信息。
2. 交换的信息是当前本路由器所知道的全部信息，即自己的路由表。
3. 按固定的时间间隔交换路由信息，例如，每隔 30 秒。当网络拓扑发生变化时，路由器也及时向相邻路由器通告拓扑变化后的路由信息。经过若干次更新后，所有的路由器最终都会知道到达本自治系统中任何一个网络的最短距离和下一跳路由器的地址。

RIP 协议的收敛 (convergence) 过程较快。“收敛”就是在自治系统中所有的结点都得到正确的路由选择信息的过程。

#### 举例：一开始，各路由表只有直接相连网络的信息

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/4e0b70cda1c10961e4bea1265fd5c1db.png)

##### 路由器B收到相邻路由器A和C的路由表

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/9871800819c98f3a94c93941967c4df3.png)

##### 最终所有的路由器的路由表都更新了

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/675751d7cfac2623c866ea0afcc7a2f7.png)

#### 路由表更新过程

路由器收到相邻路由器（其地址为 X）的一个 RIP 报文：
  
(1) 先修改此 RIP 报文中的所有项目：把“下一跳”字段中的地址都改为 X，并把所有的“距离”字段的值加 1。

(2) 对修改后的 RIP 报文中的每一个项目，重复以下步骤：
  
若项目中的目的网络不在路由表中，则把该项目加到路由表中。

否则：
  
若下一跳字段给出的路由器地址是同样的，则把收到的项目替换原路由表中的项目。

否则 ：
  
若收到项目中的距离小于路由表中的距离，则进行更新

否则，什么也不做。

(3) 若 3 分钟还没有收到相邻路由器的更新路由表，则把此相邻路由器记为不可达路由器，即将距离置为 16（表示不可达）。

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/3e022e5bbaf3c77d80bca2487b8adf0c.png)

#### RIP 协议的优缺点

* 优点：
    
  实现简单，开销较小。
* 缺点：
    
  RIP 限制了网络的规模，它能使用的最大距离为 15（16 表示不可达）。
    
  路由器之间交换的路由信息是路由器中的完整路由表，因而随着网络规模的扩大，开销也就增加。
    
  “坏消息传播得慢”，使更新过程的收敛时间过长。

##### 好消息传播得快，坏消息传播得慢

RIP 协议特点：好消息传播得快，坏消息传播得慢。

RIP 存在的一个问题：当网络出现故障时，要经过比较长的时间 (例如数分钟) 才能将此信息传送到所有的路由器。

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/8fa362d760b0e3c7724aad760ca04530.png)
  
![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/a4f45010b5cab65c45c5248bc71494f9.png)
  
![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/f8ce76b6fdc5779273dc18d539d04a23.png)
  
R1 收到 R2 的更新报文后，误认为可经过 R2 到达网 1，于是更新自己的路由表，说：“我到网 1 的距离是 3，下一跳经过 R2”。然后将此更新信息发送给 R2。

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/9ce3ba39cd2f24b4366f5a2ed55356c9.png)
  
这样不断更新下去，直到 R1 和 R2 到网 1 的距离都增大到 16 时，R1 和 R2 才知道网 1 是不可达的。

这就是好消息传播得快，而坏消息传播得慢。网络出故障的传播时间往往需要较长的时间(例如数分钟)。这是 RIP 的一个主要缺点。

### 内部网关协议 OSPF

开放最短路径优先 OSPF (Open Shortest Path First)是为克服 RIP 的缺点在 1989 年开发出来的。相比RIP而言，OSPF更适合用于大型网络。

RIP协议是距离矢量路由选择协议，它选择路由的度量标准（metric)是跳数，最大跳数是15跳，如果大于15跳，它就会丢弃数据包。而ospf协议是链路状态路由选择协议，它选择路由的度量标准是带宽，延迟。

OSPF 没有“坏消息传播得慢”的问题，据统计，其响应网络变化的时间小于 100 ms。即收敛速度快。

缺点是由于网络区域划分（分层次）和网络属性的复杂性，配置相对复杂。

#### 1. OSPF 协议的基本特点

“开放”表明 OSPF 协议不是受某一家厂商控制，而是公开发表的。

“最短路径优先”是因为使用了 Dijkstra 提出的最短路径算法 SPF采用分布式的链路状态协议 (link state protocol)。

注意：OSPF 只是一个协议的名字，它并不表示其他的路由选择协议不是“最短路径优先”。

##### 三个要点

向本自治系统中所有路由器发送信息，这里使用的方法是洪泛法。

发送的信息就是与本路由器相邻的所有路由器的链路状态，但这只是路由器所知道的部分信息。

“链路状态”就是说明本路由器都和哪些路由器相邻，以及该链路的“度量”(metric)。

只有当链路状态发生变化时，路由器才用洪泛法向所有路由器发送此信息。

##### 链路状态数据库 (link-state database)

由于各路由器之间频繁地交换链路状态信息，因此所有的路由器最终都能建立一个链路状态数据库。

这个数据库实际上就是全网的拓扑结构图，它在全网范围内是一致的（这称为链路状态数据库的同步）。

OSPF 的链路状态数据库能较快地进行更新，使各个路由器能及时更新其路由表。

OSPF 的更新过程收敛得快是其重要优点。

##### OSPF 直接用 IP 数据报传送

OSPF 不用 UDP 而是直接用 IP 数据报传送。

OSPF 构成的数据报很短。这样做可减少路由信息的通信量。

数据报很短的另一好处是可以不必将长的数据报分片传送。

但分片传送的数据报只要丢失一个，就无法组装成原来的数据报，而整个数据报就必须重传。

##### OSPF 的其他特点

OSPF 对不同的链路可根据 IP 分组的不同服务类型 TOS 而设置成不同的代价。因此，OSPF 对于不同类型的业务可计算出不同的路由。

如果到同一个目的网络有多条相同代价的路径，那么可以将通信量分配给这几条路径。这叫做多路径间的负载平衡。

所有在 OSPF 路由器之间交换的分组都具有鉴别的功能。

支持可变长度的子网划分和无分类编址 CIDR。

每一个链路状态都带上一个 32 位的序号，序号越大状态
  
就越新。

##### OSPF 分组

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/6f89e0faac5c4108e287eb2754382987.png)

#### 2. OSPF 的五种分组类型

* 类型1，问候 (Hello) 分组。
* 类型2，数据库描述 (Database Description) 分组。
* 类型3，链路状态请求 (Link State Request) 分组。
* 类型4，链路状态更新 (Link State Update) 分组，用洪泛法对全网更新链路状态。
* 类型5，链路状态确认 (Link State Acknowledgment)分组。

##### OSPF 的基本操作

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/4e3b0f3b7e7120450519b14a85133ae0.png)

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/ae227d4e6ba076728abbb61b3fa82ff9.png)

##### OSPF 的其他特点

OSPF 还规定每隔一段时间，如 30 分钟，要刷新一次数据库中的链路状态。
  
由于一个路由器的链路状态只涉及到与相邻路由器的连通状态，因而与整个互联网的规模并无直接关系。因此当互联网规模很大时，OSPF 协议要比距离向量协议 RIP 好得多。

OSPF 没有“坏消息传播得慢”的问题，据统计，其响应网络变化的时间小于 100 ms。

### 外部网关协议 BGP

BGP 是不同自治系统的路由器之间交换路由信息的协议。

BGP 较新版本是 2006 年 1 月发表的 BGP-4（BGP 第 4 个版本），即 RFC 4271 ~ 4278。

可以将 BGP-4 简写为 BGP。

#### BGP 使用环境不同

互联网的规模太大，使得自治系统之间路由选择非常困难。对于自治系统之间的路由选择，要寻找最佳路由是很不现实的。

当一条路径通过几个不同 AS 时，要想对这样的路径计算出有意义的代价是不太可能的。

比较合理的做法是在 AS 之间交换“可达性”信息。

自治系统之间的路由选择必须考虑有关策略。

因此，边界网关协议 BGP 只能是力求寻找一条能够到达目的网络且比较好的路由（不能兜圈子），而并非要寻找一条最佳路由。

#### BGP 发言人

每一个自治系统的管理员要选择至少一个路由器作为该自治系统的“ BGP 发言人” (BGP speaker) 。

一般说来，两个 BGP 发言人都是通过一个共享网络连接在一起的，而 BGP 发言人往往就是 BGP 边界路由器，但也可以不是 BGP 边界路由器。

#### BGP 交换路由信息

一个 BGP 发言人与其他自治系统中的 BGP 发言人要交换路由信息，就要先建立 TCP 连接，然后在此连接上交换 BGP 报文以建立 BGP 会话(session)，利用 BGP 会话交换路由信息。

使用 TCP 连接能提供可靠的服务，也简化了路由选择协议。

使用 TCP 连接交换路由信息的两个 BGP 发言人，彼此成为对方的邻站(neighbor)或对等站(peer) 。

#### BGP 发言人和自治系统 AS 的关系

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/c13bb0cb14adf4c9eb58f9edc4d10a36.png)

#### AS 的连通图举例

BGP 所交换的网络可达性的信息就是要到达某个网络所要经过的一系列 AS。

当 BGP 发言人互相交换了网络可达性的信息后，各 BGP 发言人就根据所采用的策略从收到的路由信息中找出到达各 AS 的较好路由。

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/ed4bcd931770edf466d08e9512c24acb.png)

#### BGP 协议的特点

BGP 协议交换路由信息的结点数量级是自治系统数的量级，这要比这些自治系统中的网络数少很多。

每一个自治系统中 BGP 发言人（或边界路由器）的数目是很少的。这样就使得自治系统之间的路由选择不致过分复杂。

BGP 支持 CIDR，因此 BGP 的路由表也就应当包括目的网络前缀、下一跳路由器，以及到达该目的网络所要经过的各个自治系统序列。

在 BGP 刚刚运行时，BGP 的邻站是交换整个的 BGP 路由表。但以后只需要在发生变化时更新有变化的部分。这样做对节省网络带宽和减少路由器的处理开销都有好处。

68747470733a2f:2f626c6f672e6373646e2e6e65742f7a62705f31323133382f:61727469636c652f64657461696c732f313036343535313639