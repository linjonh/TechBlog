---
layout: post
title: "点云数据处理-splat转3dtiles"
date: 2025-03-07 10:49:25 +0800
description: "splat转3dtiles"
keywords: "点云数据处理--splat转3dtiles"
categories: ['未分类']
tags: ['算法', '数据结构', 'Python', '3D']
artid: "145984612"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=145984612
    alt: "点云数据处理-splat转3dtiles"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=145984612
featuredImagePreview: https://bing.ee123.net/img/rand?artid=145984612
cover: https://bing.ee123.net/img/rand?artid=145984612
image: https://bing.ee123.net/img/rand?artid=145984612
img: https://bing.ee123.net/img/rand?artid=145984612
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     点云数据处理--splat转3dtiles
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <br/>
    源码地址：
    <a href="https://github.com/gaohualan/splat-3dtiles">
     github
    </a>
    <p>
    </p>
    <h2>
     <a id="_2">
     </a>
     处理流程简介
    </h2>
    <p>
     基本流程：
    </p>
    <ul>
     <li>
      读取点云数据。
     </li>
     <li>
      制作tile
      <ul>
       <li>
        构建四叉树
       </li>
       <li>
        分割点云
       </li>
       <li>
        将点云转换为glTF格式。
       </li>
      </ul>
     </li>
     <li>
      生成配置文件tileset.json。
     </li>
    </ul>
    <p>
     前置知识：
    </p>
    <ul>
     <li>
      <a href="https://github.com/KhronosGroup/glTF-Tutorials/tree/main/gltfTutorial">
       glTF教程
      </a>
     </li>
     <li>
      <a href="https://github.com/CesiumGS/glTF/tree/proposal-KHR_gaussian_splatting/extensions/2.0/Khronos/KHR_gaussian_splatting">
       glTF2.0 高斯扩展
      </a>
     </li>
     <li>
      <a href="https://github.com/CesiumGS/3d-tiles">
       3dtiles 1.1 规范
      </a>
     </li>
    </ul>
    <h2>
     <a id="_15">
     </a>
     核心功能实现
    </h2>
    <h3>
     <a id="_16">
     </a>
     数据读取与格式转换
    </h3>
    <h4>
     <a id="Point_17">
     </a>
     定义Point类
    </h4>
    <pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">Point</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> position<span class="token punctuation">:</span> Tuple<span class="token punctuation">[</span><span class="token builtin">float</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">]</span><span class="token punctuation">,</span> color<span class="token punctuation">:</span> Tuple<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                 scale<span class="token punctuation">:</span> Tuple<span class="token punctuation">[</span><span class="token builtin">float</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">]</span><span class="token punctuation">,</span> rotation<span class="token punctuation">:</span> Tuple<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>position <span class="token operator">=</span> position
        self<span class="token punctuation">.</span>color <span class="token operator">=</span> color
        self<span class="token punctuation">.</span>scale <span class="token operator">=</span> scale
        self<span class="token punctuation">.</span>rotation <span class="token operator">=</span> rotation

    <span class="token keyword">def</span> <span class="token function">to_bytes</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bytes</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""将点数据打包为二进制格式"""</span>
        <span class="token keyword">return</span> struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">'3f4B3f4B'</span><span class="token punctuation">,</span> <span class="token operator">*</span>self<span class="token punctuation">.</span>position<span class="token punctuation">,</span> <span class="token operator">*</span>self<span class="token punctuation">.</span>color<span class="token punctuation">,</span> <span class="token operator">*</span>self<span class="token punctuation">.</span>scale<span class="token punctuation">,</span> <span class="token operator">*</span>self<span class="token punctuation">.</span>rotation<span class="token punctuation">)</span>

    <span class="token decorator annotation punctuation">@classmethod</span>
    <span class="token keyword">def</span> <span class="token function">from_bytes</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token builtin">bytes</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""从二进制数据解析为点"""</span>
        unpacked <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span><span class="token string">'3f4B3f4B'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
        position <span class="token operator">=</span> unpacked<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span>
        color <span class="token operator">=</span> unpacked<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token number">7</span><span class="token punctuation">]</span>
        scale <span class="token operator">=</span> unpacked<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">]</span>
        rotation <span class="token operator">=</span> unpacked<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
        <span class="token keyword">return</span> cls<span class="token punctuation">(</span>position<span class="token punctuation">,</span> color<span class="token punctuation">,</span> scale<span class="token punctuation">,</span> rotation<span class="token punctuation">)</span>
</code></pre>
    <h4>
     <a id="_43">
     </a>
     数据读取
    </h4>
    <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">read_splat_file</span><span class="token punctuation">(</span>file_path<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span>Point<span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    读取二进制格式的 Splat 文件
    :param file_path: Splat 文件路径
    :return: 包含位置、缩放、颜色、旋转数据的 Point 对象列表
    """</span>
    points <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            position_data <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span>  <span class="token comment"># 3个 Float32，每个4字节</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> position_data<span class="token punctuation">:</span>
                <span class="token keyword">break</span>
            position <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span><span class="token string">'3f'</span><span class="token punctuation">,</span> position_data<span class="token punctuation">)</span>
            scale <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span><span class="token string">'3f'</span><span class="token punctuation">,</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            color <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span><span class="token string">'4B'</span><span class="token punctuation">,</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">*</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            rotation <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span><span class="token string">'4B'</span><span class="token punctuation">,</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">*</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            points<span class="token punctuation">.</span>append<span class="token punctuation">(</span>Point<span class="token punctuation">(</span>position<span class="token punctuation">,</span> color<span class="token punctuation">,</span> scale<span class="token punctuation">,</span> rotation<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> points
</code></pre>
    <h4>
     <a id="splatgltf_67">
     </a>
     splat转gltf
    </h4>
    <p>
     遵循3dtiles 1.1 规范，在glTF 2.0 基础上，增加高斯扩展。
    </p>
    <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">splat_to_gltf_with_gaussian_extension</span><span class="token punctuation">(</span>points<span class="token punctuation">:</span> List<span class="token punctuation">[</span>Point<span class="token punctuation">]</span><span class="token punctuation">,</span> output_path<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    将 Splat 数据转换为支持 KHR_gaussian_splatting 扩展的 glTF 文件
    :param points: Point 对象列表
    :param output_path: 输出的 glTF 文件路径
    """</span>
    <span class="token comment"># 提取数据</span>
    positions <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>
        <span class="token punctuation">[</span>point<span class="token punctuation">.</span>position <span class="token keyword">for</span> point <span class="token keyword">in</span> points<span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
    colors <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span>point<span class="token punctuation">.</span>color <span class="token keyword">for</span> point <span class="token keyword">in</span> points<span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>
    scales <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span>point<span class="token punctuation">.</span>scale <span class="token keyword">for</span> point <span class="token keyword">in</span> points<span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
    rotations <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span>point<span class="token punctuation">.</span>rotation <span class="token keyword">for</span> point <span class="token keyword">in</span> points<span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>
    normalized_rotations <span class="token operator">=</span> rotations <span class="token operator">/</span> <span class="token number">255.0</span>

    <span class="token comment"># 创建 GLTF 对象</span>
    gltf <span class="token operator">=</span> GLTF2<span class="token punctuation">(</span><span class="token punctuation">)</span>
    gltf<span class="token punctuation">.</span>extensionsUsed <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"KHR_gaussian_splatting"</span><span class="token punctuation">]</span>

    <span class="token comment"># 创建 Buffer</span>
    <span class="token builtin">buffer</span> <span class="token operator">=</span> Buffer<span class="token punctuation">(</span><span class="token punctuation">)</span>
    gltf<span class="token punctuation">.</span>buffers<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token builtin">buffer</span><span class="token punctuation">)</span>

    <span class="token comment"># 将数据转换为二进制</span>
    positions_binary <span class="token operator">=</span> positions<span class="token punctuation">.</span>tobytes<span class="token punctuation">(</span><span class="token punctuation">)</span>
    colors_binary <span class="token operator">=</span> colors<span class="token punctuation">.</span>tobytes<span class="token punctuation">(</span><span class="token punctuation">)</span>
    scales_binary <span class="token operator">=</span> scales<span class="token punctuation">.</span>tobytes<span class="token punctuation">(</span><span class="token punctuation">)</span>
    rotations_binary <span class="token operator">=</span> normalized_rotations<span class="token punctuation">.</span>tobytes<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># 创建 BufferView 和 Accessor</span>
    <span class="token keyword">def</span> <span class="token function">create_buffer_view</span><span class="token punctuation">(</span>byte_offset<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token builtin">bytes</span><span class="token punctuation">,</span> target<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">34962</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> BufferView<span class="token punctuation">:</span>
        <span class="token keyword">return</span> BufferView<span class="token punctuation">(</span><span class="token builtin">buffer</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> byteOffset<span class="token operator">=</span>byte_offset<span class="token punctuation">,</span> byteLength<span class="token operator">=</span><span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> target<span class="token operator">=</span>target<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">create_accessor</span><span class="token punctuation">(</span>buffer_view<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> component_type<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> count<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">max</span><span class="token punctuation">:</span> List<span class="token punctuation">[</span><span class="token builtin">float</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token builtin">min</span><span class="token punctuation">:</span> List<span class="token punctuation">[</span><span class="token builtin">float</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Accessor<span class="token punctuation">:</span>
        <span class="token keyword">return</span> Accessor<span class="token punctuation">(</span>bufferView<span class="token operator">=</span>buffer_view<span class="token punctuation">,</span> componentType<span class="token operator">=</span>component_type<span class="token punctuation">,</span> count<span class="token operator">=</span>count<span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">type</span><span class="token punctuation">,</span> <span class="token builtin">max</span><span class="token operator">=</span><span class="token builtin">max</span><span class="token punctuation">,</span> <span class="token builtin">min</span><span class="token operator">=</span><span class="token builtin">min</span><span class="token punctuation">)</span>

    buffer_views <span class="token operator">=</span> <span class="token punctuation">[</span>
        create_buffer_view<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> positions_binary<span class="token punctuation">)</span><span class="token punctuation">,</span>
        create_buffer_view<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>positions_binary<span class="token punctuation">)</span><span class="token punctuation">,</span> colors_binary<span class="token punctuation">)</span><span class="token punctuation">,</span>
        create_buffer_view<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>positions_binary<span class="token punctuation">)</span> <span class="token operator">+</span>
                           <span class="token builtin">len</span><span class="token punctuation">(</span>colors_binary<span class="token punctuation">)</span><span class="token punctuation">,</span> rotations_binary<span class="token punctuation">)</span><span class="token punctuation">,</span>
        create_buffer_view<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>positions_binary<span class="token punctuation">)</span> <span class="token operator">+</span>
                           <span class="token builtin">len</span><span class="token punctuation">(</span>colors_binary<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token builtin">len</span><span class="token punctuation">(</span>rotations_binary<span class="token punctuation">)</span><span class="token punctuation">,</span> scales_binary<span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
    accessors <span class="token operator">=</span> <span class="token punctuation">[</span>
        create_accessor<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5126</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>positions<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"VEC3"</span><span class="token punctuation">,</span> positions<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>
            axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> positions<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        create_accessor<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5121</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>colors<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"VEC4"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        create_accessor<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5126</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>normalized_rotations<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"VEC4"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        create_accessor<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5126</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>scales<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"VEC3"</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
    gltf<span class="token punctuation">.</span>bufferViews<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>buffer_views<span class="token punctuation">)</span>
    gltf<span class="token punctuation">.</span>accessors<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>accessors<span class="token punctuation">)</span>

    <span class="token comment"># 创建 Mesh 和 Primitive</span>
    primitive <span class="token operator">=</span> Primitive<span class="token punctuation">(</span>
        attributes<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">"POSITION"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"COLOR_0"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"_ROTATION"</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"_SCALE"</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        mode<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
        extensions<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">"KHR_gaussian_splatting"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"positions"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"colors"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"scales"</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"rotations"</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
    mesh <span class="token operator">=</span> Mesh<span class="token punctuation">(</span>primitives<span class="token operator">=</span><span class="token punctuation">[</span>primitive<span class="token punctuation">]</span><span class="token punctuation">)</span>
    gltf<span class="token punctuation">.</span>meshes<span class="token punctuation">.</span>append<span class="token punctuation">(</span>mesh<span class="token punctuation">)</span>

    <span class="token comment"># 创建 Node 和 Scene</span>
    node <span class="token operator">=</span> Node<span class="token punctuation">(</span>mesh<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    gltf<span class="token punctuation">.</span>nodes<span class="token punctuation">.</span>append<span class="token punctuation">(</span>node<span class="token punctuation">)</span>
    scene <span class="token operator">=</span> Scene<span class="token punctuation">(</span>nodes<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    gltf<span class="token punctuation">.</span>scenes<span class="token punctuation">.</span>append<span class="token punctuation">(</span>scene<span class="token punctuation">)</span>
    gltf<span class="token punctuation">.</span>scene <span class="token operator">=</span> <span class="token number">0</span>

    <span class="token comment"># 将二进制数据写入 Buffer</span>
    gltf<span class="token punctuation">.</span>buffers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>uri <span class="token operator">=</span> <span class="token string">"data:application/octet-stream;base64,"</span> <span class="token operator">+</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>
        positions_binary <span class="token operator">+</span> colors_binary <span class="token operator">+</span> rotations_binary <span class="token operator">+</span> scales_binary<span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span>
    gltf<span class="token punctuation">.</span>save<span class="token punctuation">(</span>output_path<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"glTF 文件已保存到: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>output_path<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</code></pre>
    <h3>
     <a id="_146">
     </a>
     点云数据分割
    </h3>
    <h4>
     <a id="_147">
     </a>
     定义四叉树
    </h4>
    <p>
     定义四叉树类，包含基本方法，初始化、插入、分割、判断点是否在边界范围内等等。
    </p>
    <pre><code class="prism language-python"><span class="token comment">#四叉树</span>
<span class="token keyword">class</span> <span class="token class-name">QuadTreeNode</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> bounds<span class="token punctuation">:</span> Tuple<span class="token punctuation">[</span><span class="token builtin">float</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">]</span><span class="token punctuation">,</span> capacity<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">100000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        初始化四叉树节点。
        :param bounds: 节点的边界 (min_x, min_y, max_x, max_y)
        :param capacity: 节点容量（每个节点最多存储的点数）
        """</span>
        self<span class="token punctuation">.</span>bounds <span class="token operator">=</span> bounds
        self<span class="token punctuation">.</span>capacity <span class="token operator">=</span> capacity
        self<span class="token punctuation">.</span>points<span class="token punctuation">:</span> List<span class="token punctuation">[</span>Point<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># 存储点数据</span>
        self<span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token boolean">None</span>

    <span class="token keyword">def</span> <span class="token function">insert</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> point<span class="token punctuation">:</span> Point<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        将点插入四叉树。
        :param point: 要插入的点
        :return: 是否插入成功
        """</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>_contains<span class="token punctuation">(</span>point<span class="token punctuation">.</span>position<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">False</span>

        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>points<span class="token punctuation">)</span> <span class="token operator">&lt;</span> self<span class="token punctuation">.</span>capacity<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>points<span class="token punctuation">.</span>append<span class="token punctuation">(</span>point<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">True</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>children <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>_subdivide<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token builtin">any</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span>insert<span class="token punctuation">(</span>point<span class="token punctuation">)</span> <span class="token keyword">for</span> child <span class="token keyword">in</span> self<span class="token punctuation">.</span>children<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">_contains</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> position<span class="token punctuation">:</span> Tuple<span class="token punctuation">[</span><span class="token builtin">float</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        检查点是否在节点边界内。
        :param position: 点的位置 (x, y, z)
        :return: 是否在边界内
        """</span>
        x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> _ <span class="token operator">=</span> position
        min_x<span class="token punctuation">,</span> min_y<span class="token punctuation">,</span> max_x<span class="token punctuation">,</span> max_y <span class="token operator">=</span> self<span class="token punctuation">.</span>bounds
        <span class="token keyword">return</span> min_x <span class="token operator">&lt;=</span> x <span class="token operator">&lt;</span> max_x <span class="token keyword">and</span> min_y <span class="token operator">&lt;=</span> y <span class="token operator">&lt;</span> max_y

    <span class="token keyword">def</span> <span class="token function">_subdivide</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        将节点划分为四个子节点。
        """</span>
        min_x<span class="token punctuation">,</span> min_y<span class="token punctuation">,</span> max_x<span class="token punctuation">,</span> max_y <span class="token operator">=</span> self<span class="token punctuation">.</span>bounds
        mid_x <span class="token operator">=</span> <span class="token punctuation">(</span>min_x <span class="token operator">+</span> max_x<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>
        mid_y <span class="token operator">=</span> <span class="token punctuation">(</span>min_y <span class="token operator">+</span> max_y<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>

        self<span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token punctuation">[</span>
            QuadTreeNode<span class="token punctuation">(</span><span class="token punctuation">(</span>min_x<span class="token punctuation">,</span> min_y<span class="token punctuation">,</span> mid_x<span class="token punctuation">,</span> mid_y<span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>capacity<span class="token punctuation">)</span><span class="token punctuation">,</span>
            QuadTreeNode<span class="token punctuation">(</span><span class="token punctuation">(</span>mid_x<span class="token punctuation">,</span> min_y<span class="token punctuation">,</span> max_x<span class="token punctuation">,</span> mid_y<span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>capacity<span class="token punctuation">)</span><span class="token punctuation">,</span>
            QuadTreeNode<span class="token punctuation">(</span><span class="token punctuation">(</span>min_x<span class="token punctuation">,</span> mid_y<span class="token punctuation">,</span> mid_x<span class="token punctuation">,</span> max_y<span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>capacity<span class="token punctuation">)</span><span class="token punctuation">,</span>
            QuadTreeNode<span class="token punctuation">(</span><span class="token punctuation">(</span>mid_x<span class="token punctuation">,</span> mid_y<span class="token punctuation">,</span> max_x<span class="token punctuation">,</span> max_y<span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>capacity<span class="token punctuation">)</span>
        <span class="token punctuation">]</span>

        <span class="token keyword">for</span> point <span class="token keyword">in</span> self<span class="token punctuation">.</span>points<span class="token punctuation">:</span>
            <span class="token keyword">for</span> child <span class="token keyword">in</span> self<span class="token punctuation">.</span>children<span class="token punctuation">:</span>
                <span class="token keyword">if</span> child<span class="token punctuation">.</span>insert<span class="token punctuation">(</span>point<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    <span class="token keyword">break</span>

        self<span class="token punctuation">.</span>points <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># 清空当前节点的点数据</span>

    <span class="token keyword">def</span> <span class="token function">get_all_points</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span>Point<span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        获取当前节点及其子节点中的所有点。
        :return: 所有点的列表
        """</span>
        points <span class="token operator">=</span> self<span class="token punctuation">.</span>points<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>children <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">for</span> child <span class="token keyword">in</span> self<span class="token punctuation">.</span>children<span class="token punctuation">:</span>
                points<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>child<span class="token punctuation">.</span>get_all_points<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> points
</code></pre>
    <h4>
     <a id="3dtiles_227">
     </a>
     递归生成3dtiles瓦片
    </h4>
    <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">generate_3dtiles</span><span class="token punctuation">(</span>node<span class="token punctuation">:</span> QuadTreeNode<span class="token punctuation">,</span> output_dir<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> tile_name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> node<span class="token punctuation">.</span>children <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> i<span class="token punctuation">,</span> child <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">:</span>
            generate_3dtiles<span class="token punctuation">(</span>child<span class="token punctuation">,</span> output_dir<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>tile_name<span class="token punctuation">}</span></span><span class="token string">_</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>i<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> <span class="token builtin">len</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>points<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
        points <span class="token operator">=</span> node<span class="token punctuation">.</span>get_all_points<span class="token punctuation">(</span><span class="token punctuation">)</span>
        splat_to_gltf_with_gaussian_extension<span class="token punctuation">(</span>
            points<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>output_dir<span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>tile_name<span class="token punctuation">}</span></span><span class="token string">.gltf"</span></span><span class="token punctuation">)</span>
</code></pre>
    <h3>
     <a id="tilesetjson_240">
     </a>
     生成tileset.json
    </h3>
    <h4>
     <a id="tilesetjson_241">
     </a>
     递归生成tileset.json
    </h4>
    <p>
     generate_tileset_json
    </p>
    <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">generate_tileset_json</span><span class="token punctuation">(</span>output_dir<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> root_node<span class="token punctuation">:</span> QuadTreeNode<span class="token punctuation">,</span> bounds<span class="token punctuation">:</span> List<span class="token punctuation">[</span><span class="token builtin">float</span><span class="token punctuation">]</span><span class="token punctuation">,</span> geometric_error<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">build_tile_structure</span><span class="token punctuation">(</span>node<span class="token punctuation">:</span> QuadTreeNode<span class="token punctuation">,</span> tile_name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> current_geometric_error<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">:</span>
        bounding_volume <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"region"</span><span class="token punctuation">:</span> compute_region<span class="token punctuation">(</span><span class="token punctuation">[</span>point<span class="token punctuation">.</span>position <span class="token keyword">for</span> point <span class="token keyword">in</span> node<span class="token punctuation">.</span>get_all_points<span class="token punctuation">(</span>
        <span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token keyword">if</span> is_geographic_coordinate <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span><span class="token string">"box"</span><span class="token punctuation">:</span> compute_box<span class="token punctuation">(</span><span class="token punctuation">[</span>point<span class="token punctuation">.</span>position <span class="token keyword">for</span> point <span class="token keyword">in</span> node<span class="token punctuation">.</span>get_all_points<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
        content <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"uri"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>tile_name<span class="token punctuation">}</span></span><span class="token string">.gltf"</span></span><span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token keyword">not</span> node<span class="token punctuation">.</span>children <span class="token keyword">else</span> <span class="token boolean">None</span>
        children <span class="token operator">=</span> <span class="token punctuation">[</span>build_tile_structure<span class="token punctuation">(</span>child<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>tile_name<span class="token punctuation">}</span></span><span class="token string">_</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>i<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span> current_geometric_error <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span>
                    <span class="token keyword">for</span> i<span class="token punctuation">,</span> child <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token keyword">if</span> node<span class="token punctuation">.</span>children <span class="token keyword">else</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        tile_structure <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"boundingVolume"</span><span class="token punctuation">:</span> bounding_volume<span class="token punctuation">,</span>
            <span class="token string">"geometricError"</span><span class="token punctuation">:</span> current_geometric_error<span class="token punctuation">,</span>
            <span class="token string">"refine"</span><span class="token punctuation">:</span> <span class="token string">"ADD"</span><span class="token punctuation">,</span>
            <span class="token string">"content"</span><span class="token punctuation">:</span> content
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> children<span class="token punctuation">:</span>
            tile_structure<span class="token punctuation">[</span><span class="token string">"children"</span><span class="token punctuation">]</span> <span class="token operator">=</span> children
            <span class="token keyword">del</span> tile_structure<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span>
        <span class="token keyword">return</span> tile_structure

    tileset <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"asset"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"version"</span><span class="token punctuation">:</span> <span class="token string">"1.1"</span><span class="token punctuation">,</span> <span class="token string">"gltfUpAxis"</span><span class="token punctuation">:</span> <span class="token string">"Z"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">"geometricError"</span><span class="token punctuation">:</span> geometric_error<span class="token punctuation">,</span>
        <span class="token string">"root"</span><span class="token punctuation">:</span> build_tile_structure<span class="token punctuation">(</span>root_node<span class="token punctuation">,</span> <span class="token string">"tile_0"</span><span class="token punctuation">,</span> geometric_error<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>output_dir<span class="token punctuation">}</span></span><span class="token string">/tileset.json"</span></span><span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        json<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>tileset<span class="token punctuation">,</span> f<span class="token punctuation">,</span> cls<span class="token operator">=</span>NumpyEncoder<span class="token punctuation">,</span> indent<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     数据格式转换
    </p>
    <pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">NumpyEncoder</span><span class="token punctuation">(</span>json<span class="token punctuation">.</span>JSONEncoder<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">default</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token punctuation">(</span>np<span class="token punctuation">.</span>int_<span class="token punctuation">,</span> np<span class="token punctuation">.</span>intc<span class="token punctuation">,</span> np<span class="token punctuation">.</span>intp<span class="token punctuation">,</span> np<span class="token punctuation">.</span>int8<span class="token punctuation">,</span> np<span class="token punctuation">.</span>int16<span class="token punctuation">,</span> np<span class="token punctuation">.</span>int32<span class="token punctuation">,</span> np<span class="token punctuation">.</span>int64<span class="token punctuation">,</span> np<span class="token punctuation">.</span>uint8<span class="token punctuation">,</span> np<span class="token punctuation">.</span>uint16<span class="token punctuation">,</span> np<span class="token punctuation">.</span>uint32<span class="token punctuation">,</span> np<span class="token punctuation">.</span>uint64<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token builtin">int</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
        <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token punctuation">(</span>np<span class="token punctuation">.</span>float_<span class="token punctuation">,</span> np<span class="token punctuation">.</span>float16<span class="token punctuation">,</span> np<span class="token punctuation">.</span>float32<span class="token punctuation">,</span> np<span class="token punctuation">.</span>float64<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token builtin">float</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
        <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> np<span class="token punctuation">.</span>ndarray<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> obj<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> json<span class="token punctuation">.</span>JSONEncoder<span class="token punctuation">.</span>default<span class="token punctuation">(</span>self<span class="token punctuation">,</span> obj<span class="token punctuation">)</span>
</code></pre>
    <h4>
     <a id="box_283">
     </a>
     计算box
    </h4>
    <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">compute_box</span><span class="token punctuation">(</span>points<span class="token punctuation">:</span> np<span class="token punctuation">.</span>ndarray<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span><span class="token builtin">float</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    center <span class="token operator">=</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>points<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    half_size <span class="token operator">=</span> <span class="token punctuation">(</span>np<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>points<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">-</span> np<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span>points<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>center<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> center<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> center<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> half_size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> half_size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> half_size<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
</code></pre>
    <h3>
     <a id="_291">
     </a>
     主函数调用
    </h3>
    <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span>input_path<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> output_dir<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token comment"># 读取 .splat 文件</span>
    points <span class="token operator">=</span> read_splat_file<span class="token punctuation">(</span>input_path<span class="token punctuation">)</span>

    <span class="token comment"># 创建四叉树根节点</span>
    positions <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span>point<span class="token punctuation">.</span>position <span class="token keyword">for</span> point <span class="token keyword">in</span> points<span class="token punctuation">]</span><span class="token punctuation">)</span>
    min_x<span class="token punctuation">,</span> min_y <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span>positions<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    max_x<span class="token punctuation">,</span> max_y <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>positions<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    root <span class="token operator">=</span> QuadTreeNode<span class="token punctuation">(</span><span class="token punctuation">(</span>min_x<span class="token punctuation">,</span> min_y<span class="token punctuation">,</span> max_x<span class="token punctuation">,</span> max_y<span class="token punctuation">)</span><span class="token punctuation">,</span> capacity<span class="token operator">=</span><span class="token number">100000</span><span class="token punctuation">)</span>

    <span class="token comment"># 将点插入四叉树</span>
    <span class="token keyword">for</span> point <span class="token keyword">in</span> points<span class="token punctuation">:</span>
        root<span class="token punctuation">.</span>insert<span class="token punctuation">(</span>point<span class="token punctuation">)</span>

    <span class="token comment"># 生成 3D Tiles</span>
    generate_3dtiles<span class="token punctuation">(</span>root<span class="token punctuation">,</span> output_dir<span class="token punctuation">,</span> <span class="token string">"tile_0"</span><span class="token punctuation">)</span>

    <span class="token comment"># 生成 tileset.json</span>
    bounds <span class="token operator">=</span> <span class="token punctuation">[</span>min_x<span class="token punctuation">,</span> min_y<span class="token punctuation">,</span> np<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span>
        positions<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> max_x<span class="token punctuation">,</span> max_y<span class="token punctuation">,</span> np<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>positions<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    generate_tileset_json<span class="token punctuation">(</span>output_dir<span class="token punctuation">,</span> root<span class="token punctuation">,</span> bounds<span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    <span class="token comment"># 解析命令行参数</span>
    parser <span class="token operator">=</span> argparse<span class="token punctuation">.</span>ArgumentParser<span class="token punctuation">(</span>description<span class="token operator">=</span><span class="token string">"将 Splat 文件转换为 3D Tiles。"</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"input_path"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"输入的 .splat 文件路径"</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"output_dir"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"输出的 3D Tiles 目录路径"</span><span class="token punctuation">)</span>
    args <span class="token operator">=</span> parser<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># 调用主函数</span>
    main<span class="token punctuation">(</span>args<span class="token punctuation">.</span>input_path<span class="token punctuation">,</span> args<span class="token punctuation">.</span>output_dir<span class="token punctuation">)</span>
</code></pre>
    <h3>
     <a id="_328">
     </a>
     渲染
    </h3>
    <p>
     编译cesium的splat-shader版本，参考示例代码3D Tiles Gaussian Splatting.html实现。
    </p>
    <pre><code class="prism language-python"><span class="token keyword">async</span> function loadTileset<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
    const tileset <span class="token operator">=</span> <span class="token keyword">await</span> Cesium<span class="token punctuation">.</span>Cesium3DTileset<span class="token punctuation">.</span>fromUrl<span class="token punctuation">(</span>
      <span class="token string">"http://localhost:8081/data/outputs/model/tileset.json"</span><span class="token punctuation">,</span>
      <span class="token punctuation">{<!-- --></span>
        modelMatrix<span class="token punctuation">:</span>computeModelMatrix<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        maximumScreenSpaceError<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">.</span>then<span class="token punctuation">(</span><span class="token punctuation">(</span>tileset<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
      CesiumViewer<span class="token punctuation">.</span>scene<span class="token punctuation">.</span>primitives<span class="token punctuation">.</span>add<span class="token punctuation">(</span>tileset<span class="token punctuation">)</span><span class="token punctuation">;</span>
      setupCamera<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> catch <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span>error<span class="token punctuation">(</span>`Error creating tileset<span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>error<span class="token punctuation">}</span>`<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h2>
     <a id="_350">
     </a>
     下一步工作
    </h2>
    <h3>
     <a id="_351">
     </a>
     性能优化
    </h3>
    <ul>
     <li>
      支持LOD 。
     </li>
     <li>
      支持多线程、多任务，分批处理 。
     </li>
     <li>
      切片方案优化，尝试构建其他空间索引，例如八叉树 。
     </li>
    </ul>
    <h3>
     <a id="_355">
     </a>
     渲染效果调优
    </h3>
    <p>
     目前渲染效果不理想，椭圆的某个轴长过大，问题排查中。
    </p>
    <h3>
     <a id="_357">
     </a>
     其他
    </h3>
    <p>
     其他待优化项。本文输出的是一个简易版的splat转3dtiles工具，供学习和交流使用，待优化的地方，若有精力后续会持续完善。
    </p>
    <p>
     参考资料：
     <br/>
     [1] https://github.com/KhronosGroup/glTF-Tutorials/tree/main/gltfTutorial
     <br/>
     [2] https://github.com/CesiumGS/3d-tiles
     <br/>
     [3] https://github.com/CesiumGS/glTF/tree/proposal-KHR_gaussian_splatting/extensions/2.0/Khronos/KHR_gaussian_splatting
     <br/>
     [4] https://github.com/CesiumGS/cesium/tree/splat-shader
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f:2f626c6f672e6373646e2e6e65742f78696e6572303131342f:61727469636c652f64657461696c732f313435393834363132" class_="artid" style="display:none">
 </p>
</div>


