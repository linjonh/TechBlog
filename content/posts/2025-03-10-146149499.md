---
layout: post
title: "Elasticsearch-Java-API-Client-8.17-使用"
date: 2025-03-10 20:59:43 +0800
description: "下面是按照了城市维度分组，统计了每个城市下面业务类型数量、网络类型数量、sdk版本数量、平台数量、手机型号数量，以及最后一个是带条件过滤在统计的数据平均值。es8出了个新的JavaClient，相较于HighLevelClient少了对es源代码的引用，更加的轻便了，这里记录下使用方式。建议使用模版的方式创建索引，比如我下面的dsl语句规定了索引内字段的类型。有单个新增和批量新增，使用批量时最好把索引的更新频率设置一下。聚合没有太多的通用性，按照自己业务的需求写就可以。本地运行的是es 8.6.2版本。"
keywords: "Elasticsearch Java API Client [8.17] 使用"
categories: ['未分类']
tags: ['大数据', 'Java', 'Elasticsearch']
artid: "146149499"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146149499
    alt: "Elasticsearch-Java-API-Client-8.17-使用"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146149499
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146149499
cover: https://bing.ee123.net/img/rand?artid=146149499
image: https://bing.ee123.net/img/rand?artid=146149499
img: https://bing.ee123.net/img/rand?artid=146149499
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Elasticsearch Java API Client [8.17] 使用
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <p>
     es8出了个新的JavaClient，相较于HighLevelClient少了对es源代码的引用，更加的轻便了，这里记录下使用方式。
    </p>
    <p>
     文档地址：
     <a href="https://www.elastic.co/guide/en/elasticsearch/client/java-api-client/current/introduction.html" rel="nofollow" title="Introduction | Elasticsearch Java API Client [8.17] | Elastic">
      Introduction | Elasticsearch Java API Client [8.17] | Elastic
     </a>
    </p>
    <p>
     本地运行的是es 8.6.2版本
    </p>
    <p>
     JavaClient使用的是8.17
    </p>
    <p>
    </p>
    <p>
     1、首先创建个java springboot项目
    </p>
    <p>
     源码地址：
     <a href="https://github.com/a66245753/es-8-java-client.git" title="https://github.com/a66245753/es-8-java-client.git">
      https://github.com/a66245753/es-8-java-client.git
     </a>
    </p>
    <p>
     pom依赖文件如下
    </p>
    <pre><code class="hljs">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
    &lt;parent&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;
        &lt;version&gt;3.4.3&lt;/version&gt;
        &lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt;
    &lt;/parent&gt;
    &lt;groupId&gt;com.david&lt;/groupId&gt;
    &lt;artifactId&gt;es8-java-client&lt;/artifactId&gt;
    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;
    &lt;name&gt;es8-java-client&lt;/name&gt;
    &lt;description&gt;es8-java-client&lt;/description&gt;
    &lt;url/&gt;
    &lt;licenses&gt;
        &lt;license/&gt;
    &lt;/licenses&gt;
    &lt;developers&gt;
        &lt;developer/&gt;
    &lt;/developers&gt;
    &lt;scm&gt;
        &lt;connection/&gt;
        &lt;developerConnection/&gt;
        &lt;tag/&gt;
        &lt;url/&gt;
    &lt;/scm&gt;
    &lt;properties&gt;
        &lt;java.version&gt;17&lt;/java.version&gt;
    &lt;/properties&gt;
    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;com.mysql&lt;/groupId&gt;
            &lt;artifactId&gt;mysql-connector-j&lt;/artifactId&gt;
            &lt;scope&gt;runtime&lt;/scope&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;co.elastic.clients&lt;/groupId&gt;
            &lt;artifactId&gt;elasticsearch-java&lt;/artifactId&gt;
            &lt;version&gt;8.17.3&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt;
            &lt;artifactId&gt;jackson-databind&lt;/artifactId&gt;
            &lt;version&gt;2.17.0&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;!-- Lombok 依赖 --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;
            &lt;artifactId&gt;lombok&lt;/artifactId&gt;
            &lt;version&gt;1.18.22&lt;/version&gt;
            &lt;scope&gt;provided&lt;/scope&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;com.baomidou&lt;/groupId&gt;
            &lt;artifactId&gt;mybatis-plus-spring-boot3-starter&lt;/artifactId&gt;
            &lt;version&gt;3.5.8&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;mysql&lt;/groupId&gt;
            &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;
            &lt;scope&gt;runtime&lt;/scope&gt;
            &lt;version&gt;8&lt;/version&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;

    &lt;build&gt;
        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;
            &lt;/plugin&gt;
        &lt;/plugins&gt;
    &lt;/build&gt;

&lt;/project&gt;
</code></pre>
    <p>
     application.yml
    </p>
    <p>
     数据库需要改为自己的
    </p>
    <pre><code class="hljs">spring:
  application:
    name: es8-java-client


  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://127.0.0.1:3306/david?charset=utf8mb4&amp;parseTime=True&amp;loc=Local
    username: david
    password: david


mybatis-plus:
  configuration:
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl
</code></pre>
    <p>
     按照官网上声明EsClient 为spring bean
    </p>
    <pre><code class="hljs">@Configuration
public class EsClientConfig {

    @Bean
    public ElasticsearchClient elasticsearchClient() {
        // URL and API key
        String serverUrl = "http://localhost:9200";
        //        String apiKey = "VnVhQ2ZHY0JDZGJrU...";

        // Create the low-level client
        RestClient restClient = RestClient
                .builder(HttpHost.create(serverUrl))
//                .setDefaultHeaders(new Header[]{
//                        new BasicHeader("Authorization", "ApiKey " + apiKey)
//                })
                .build();

        // Create the transport with a Jackson mapper
        ElasticsearchTransport transport = new RestClientTransport(
                restClient, new JacksonJsonpMapper());

        // And create the API client
        return new ElasticsearchClient(transport);
    }
}</code></pre>
    <p>
    </p>
    <p>
     2、es client使用
    </p>
    <p>
     class：com.david.coltroller.EsDocController
    </p>
    <p>
     2.1 新增数据
    </p>
    <p>
     有单个新增和批量新增，使用批量时最好把索引的更新频率设置一下
    </p>
    <pre><code class="hljs">/**
     * https://www.elastic.co/guide/en/elasticsearch/client/java-api-client/current/indexing.html
     *
     * @param add
     * @return
     * @throws IOException
     */
    @PostMapping("/add")
    public ResponseEntity&lt;EsResponseBody&gt; add(@RequestBody EsDocAdd add) throws IOException {
        try {
            IndexResponse response = elasticsearchClient.index(i -&gt; i
                    .index(add.getIndex())
                    // 不设置id，默认使用es生成的
                    // .id(product.getSku())
                    .document(add.getDoc())
            );
            EsResponseBody responseBody = new EsResponseBody(0, response.id(), null);
            return new ResponseEntity&lt;&gt;(responseBody, HttpStatus.OK);
        } catch (ElasticsearchException e) {
            EsResponseBody responseBody = new EsResponseBody(-1, null, e.error().toString());
            return new ResponseEntity&lt;&gt;(responseBody, HttpStatus.OK);
        }
    }

    /**
     * https://www.elastic.co/guide/en/elasticsearch/client/java-api-client/current/indexing-bulk.html
     *
     * @param add
     * @return
     * @throws IOException
     */
    @PostMapping("/addBatch")
    public ResponseEntity&lt;EsResponseBody&gt; addBatch(@RequestBody EsDocAddBatch add) throws IOException {

        BulkRequest.Builder br = new BulkRequest.Builder();
        for (ObjectNode doc : add.getDocs()) {
            br.operations(op -&gt; op
                    .index(idx -&gt; idx
                            .index(add.getIndex())
                            .document(doc)
                    )
            );
        }
        try {
            BulkResponse result = elasticsearchClient.bulk(br.build());
            if (result.errors()) {
                List&lt;EsDocBucketError&gt; list = new ArrayList&lt;&gt;();
                int i = 0;
                for (BulkResponseItem item : result.items()) {
                    if (item.error() != null) {
                        list.add(new EsDocBucketError(item.error().reason(), add.getDocs().get(i)));
                    }
                    i++;
                }
                EsResponseBody responseBody = new EsResponseBody(-1, list, "失败");
                return new ResponseEntity&lt;&gt;(responseBody, HttpStatus.OK);
            }
            EsResponseBody responseBody = new EsResponseBody(0, null, null);
            return new ResponseEntity&lt;&gt;(responseBody, HttpStatus.OK);
        } catch (ElasticsearchException e) {
            EsResponseBody responseBody = new EsResponseBody(-1, null, e.error().toString());
            return new ResponseEntity&lt;&gt;(responseBody, HttpStatus.OK);
        }
    }</code></pre>
    <p>
     建议使用模版的方式创建索引，比如我下面的dsl语句规定了索引内字段的类型。
    </p>
    <pre><code class="hljs">
PUT _index_template/ssp_ad_union_log_template
{
  // 匹配的索引模式
  "index_patterns": ["ssp_ad_union_log_*"], 
  "template": {
    "settings": {
      "number_of_shards": 1,       
      "number_of_replicas": 1,
      "refresh_interval":"1s"      
    },
    "mappings": {
      "dynamic": "strict",
      "properties": {
        "id": { "type": "long" },   
        "reqId": { "type": "keyword" },   
        "device": { "type": "keyword" },
        "platform": { "type": "byte" },
        "platformName":{"type":"keyword"},
        "clientType": { "type": "byte" },
        "myAppId":{"type":"keyword"},
        "deviceId":{"type":"keyword"},
        "adSiteGroupId": { "type": "long" },
        "adSiteId":{"type":"keyword"},
        "packagePath":{"type":"keyword"},
        "ecpm": { "type": "long" },
        "location":{"type":"geo_point"},
        "ip":{"type":"ip"},
        "cityId":{"type":"integer"},
        "cityName":{"type":"keyword"},
        "areaId":{"type":"integer"},
        "areaName":{"type":"keyword"},
        "provinceId":{"type":"integer"},
        "provinceName":{"type":"keyword"},
        "phoneBrand":{"type":"keyword"},
        "phoneBrandName":{"type":"keyword"},
        "phoneModel":{"type":"keyword"},
        "idfa":{"type":"keyword"},
        "bizType":{"type":"byte"},
        "sdkVersion":{"type":"keyword"},
        "network":{"type":"keyword"},
        "logTime":{"type":"date","format":"yyyy-MM-dd HH:mm:ss"},
        "createdAt":{"type":"date","format":"yyyy-MM-dd HH:mm:ss"}
      }
    },
    "aliases":{
      "ssp_ad_union_log":{}
    }
  }
}</code></pre>
    <p>
     2.2 根据es的objectId获取数据
    </p>
    <pre><code class="hljs">
    /**
     * 根据es的objectId获取数据
     * @param index
     * @param id
     * @return
     * @throws IOException
     */
    @GetMapping("/get")
    public ResponseEntity&lt;EsResponseBody&gt; get(@RequestParam("index") String index, @RequestParam("id") String id) throws IOException {

        GetResponse&lt;ObjectNode&gt; response = elasticsearchClient.get(g -&gt; g
                        .index(index)
                        .id(id),
                ObjectNode.class
        );
        if (response.found()) {
            EsResponseBody responseBody = new EsResponseBody(0, response.source(), null);
            return new ResponseEntity&lt;&gt;(responseBody, HttpStatus.OK);
        }
        EsResponseBody responseBody = new EsResponseBody(-1, null, "not found");
        return new ResponseEntity&lt;&gt;(responseBody, HttpStatus.OK);
    }

    /**
     * 根据es的多个objectId获取数据
     * @param params
     * @return
     * @throws IOException
     */
    @PostMapping("/getBatch")
    public ResponseEntity&lt;EsResponseBody&gt; getBatch(@RequestBody EsGetBatchParams params) throws IOException {

        MgetResponse&lt;ObjectNode&gt; response = elasticsearchClient.mget(g -&gt; g
                        .index(params.getIndex())
                        .ids(params.getIdList()),
                ObjectNode.class
        );
        List&lt;ObjectNode&gt; list = new ArrayList&lt;&gt;();
        for (MultiGetResponseItem&lt;ObjectNode&gt; doc : response.docs()) {
            if (doc.isResult()) {
                list.add(doc.result().source());
            }
            if (doc.isFailure()) {
                System.out.println("isFailure doc" + doc.toString());
            }
        }
        EsResponseBody responseBody = new EsResponseBody(0, list, null);
        return new ResponseEntity&lt;&gt;(responseBody, HttpStatus.OK);
    }</code></pre>
    <p>
     2.3 查询分页
    </p>
    <p>
     这里写了个通用查询
    </p>
    <pre><code class="hljs">/**
     * 查询分页
     * @param request
     * @return
     * @throws IOException
     */
    @PostMapping("/search")
    public ResponseEntity&lt;EsResponseBody&gt; search(@RequestBody EsSearchRequest request) throws IOException {
        // 构造查询过滤条件
        List&lt;Query&gt; list = buildQueryList(request);
        Query query = null;
        if (request.getLikeParams() != null &amp;&amp; !request.getLikeParams().isEmpty()) {
            // 使用分值查询，分高的排前面
            query = new BoolQuery.Builder().must(list).build()._toQuery();
        } else {
            // 使用filter不算分查询
            query = new BoolQuery.Builder().filter(list).build()._toQuery();
        }
        // 创建 SearchRequest 并指定索引名称
        SearchRequest searchRequest = new SearchRequest.Builder()
                .index(request.getIndexList())
                .query(query)
                .trackTotalHits(tth -&gt; tth.enabled(true))
                .from((request.getPageIndex() - 1) * request.getPageSize())
                .size(request.getPageSize())
                .build();

        // 打印查询语句，方便排查问题
        System.out.println("search query: " + searchRequest.toString());

        // 执行搜索请求， 第二个参数可以换成自己的返回值对象
        SearchResponse&lt;ObjectNode&gt; response = elasticsearchClient.search(searchRequest, ObjectNode.class);
        List&lt;ObjectNode&gt; collect = response.hits().hits().stream().map(Hit::source).toList();
        EsSearchResult result = new EsSearchResult();
        result.setPageIndex(request.getPageIndex());
        result.setPageSize(request.getPageSize());
        result.setTotal(response.hits().total().value());
        result.setList(collect);
        EsResponseBody responseBody = new EsResponseBody(0, result, null);

        return new ResponseEntity&lt;&gt;(responseBody, HttpStatus.OK);
    }

/**
     * 组装请求参数
     *
     * @param request
     * @return
     */
    private List&lt;Query&gt; buildQueryList(EsSearchRequest request) {
        List&lt;Query&gt; list = new ArrayList&lt;&gt;();
        if (request.getEqualsParams() != null &amp;&amp; !request.getEqualsParams().isEmpty()) {
            for (Map.Entry&lt;String, Object&gt; entry : request.getEqualsParams().entrySet()) {
                // 构建 TermQuery 对象
                Query query = new TermQuery.Builder()
                        .field(entry.getKey())
                        .value(entry.getValue().toString())
                        .build()._toQuery();
                list.add(query);
            }
        }
        if (request.getInParams() != null &amp;&amp; !request.getInParams().isEmpty()) {
            for (EsInParams params : request.getInParams()) {
                // 构建 TermsQuery 对象
                Query query = new TermsQuery.Builder()
                        .field(params.getField())
                        .terms(t -&gt; t.value(params.getValueList().stream().map(FieldValue::of).toList()))
                        .build()._toQuery();
                list.add(query);
            }
        }
        if (request.getLikeParams() != null &amp;&amp; !request.getLikeParams().isEmpty()) {
            for (Map.Entry&lt;String, String&gt; entry : request.getLikeParams().entrySet()) {
                // 构建 MatchQuery 对象
                Query query = new MatchQuery.Builder()
                        .field(entry.getKey())
                        .query(entry.getValue())
                        .build()._toQuery();
                list.add(query);
            }
        }
        if (request.getRangeParams() != null &amp;&amp; !request.getRangeParams().isEmpty()) {
            for (EsRangeParams rangeParam : request.getRangeParams()) {
                if (rangeParam.getFieldType() == 1) {
                    Query query = new NumberRangeQuery.Builder()
                            .field(rangeParam.getField())
                            .gte(Double.valueOf(rangeParam.getGte()))
                            .lte(Double.valueOf(rangeParam.getLte()))
                            .build()._toRangeQuery()._toQuery();
                    list.add(query);
                } else {
                    Query query = new DateRangeQuery.Builder()
                            .field(rangeParam.getField())
                            .gte(rangeParam.getGte())
                            .lte(rangeParam.getLte())
                            .build()._toRangeQuery()._toQuery();
                    list.add(query);
                }
            }
        }
        return list;
    }</code></pre>
    <p>
     2.4 聚合数据（分组统计）
    </p>
    <p>
     聚合没有太多的通用性，按照自己业务的需求写就可以。
    </p>
    <p>
     下面是按照了城市维度分组，统计了每个城市下面业务类型数量、网络类型数量、sdk版本数量、平台数量、手机型号数量，以及最后一个是带条件过滤在统计的数据平均值。
    </p>
    <pre><code class="hljs">
    @PostMapping("/aggs")
    public ResponseEntity&lt;EsResponseBody&gt; aggs(@RequestBody EsSearchRequest request) throws IOException {

        // 构造查询过滤条件
        List&lt;Query&gt; list = buildQueryList(request);

        Query query = new BoolQuery.Builder().filter(list).build()._toQuery();

        // 创建 SearchRequest 并指定索引名称和其他参数
        SearchRequest searchRequest = new SearchRequest.Builder()
                .index("ssp_ad_union_log")
                .trackTotalHits(tth -&gt; tth.enabled(true))
                .from(0)
                .size(1)
                .query(query)
                .aggregations("cityName_bucket",
                        // 一级聚合
                        a -&gt; a.terms(t -&gt; t.field("cityName").size(10))
                                // 二级聚合
                                .aggregations("bizType_bucket", aa -&gt; aa.terms(ts -&gt; ts.field("bizType").size(10)))
                                .aggregations("network_bucket", aa -&gt; aa.terms(ts -&gt; ts.field("network").size(10)))
                                .aggregations("sdkVersion_bucket", aa -&gt; aa.terms(t3 -&gt; t3.field("sdkVersion").size(10)))
                                .aggregations("platformName_bucket", aa -&gt; aa.terms(t4 -&gt; t4.field("platformName").size(10)))
                                .aggregations("phoneBrandName_bucket", aa -&gt; aa.terms(t5 -&gt; t5.field("phoneBrandName").size(10)))
                                // 带条件二级聚合
                                .aggregations("ecpmAvg_bucket", aa -&gt; aa.filter(f6 -&gt; f6.term(c -&gt; c.field("bizType").value(2))).aggregations("ecpmAvg_bucket", ss -&gt; ss.avg(avg -&gt; avg.field("ecpm"))))
                )
                .build();

        // 打印查询语句，方便排查问题
        System.out.println("search query: " + searchRequest.toString());

        // 执行搜索请求
        SearchResponse&lt;ObjectNode&gt; response = elasticsearchClient.search(searchRequest, ObjectNode.class);
        // 处理结果
        System.out.println(response.aggregations().toString());
        List&lt;StringTermsBucket&gt; buckets = response.aggregations()
                .get("cityName_bucket")
                .sterms()
                .buckets()
                .array();
        EsResponseBody responseBody = new EsResponseBody(0, response.aggregations().toString(), null);
        return new ResponseEntity&lt;&gt;(responseBody, HttpStatus.OK);
    }</code></pre>
    <p>
    </p>
   </div>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f4461766964536f436f6f6c2f:61727469636c652f64657461696c732f313436313439343939" class_="artid" style="display:none">
 </p>
</div>


