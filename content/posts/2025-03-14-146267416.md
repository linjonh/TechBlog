---
layout: post
title: "ORM操作flask"
date: 2025-03-14 21:40:26 +0800
description: "当删除作品时，能自动将作品-类别表里对应的数据删除。作品类下面加一个删除功能的实例方法。定义类别表，以及作品-类别中间表。"
keywords: "ORM操作（flask）"
categories: ['Python']
tags: ['Python', 'Flask']
artid: "146267416"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146267416
    alt: "ORM操作flask"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146267416
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146267416
cover: https://bing.ee123.net/img/rand?artid=146267416
image: https://bing.ee123.net/img/rand?artid=146267416
img: https://bing.ee123.net/img/rand?artid=146267416
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     ORM操作（flask）
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <p>
    </p>
    <h3>
     <a id="ORM_1">
     </a>
     ORM操作
    </h3>
    <h4>
     <a id="_3">
     </a>
     增
    </h4>
    <pre><code class="prism language-python"><span class="token comment"># 1. 创建ORM对象  </span>
user <span class="token operator">=</span> User<span class="token punctuation">(</span>username<span class="token operator">=</span><span class="token string">"test"</span><span class="token punctuation">,</span> password<span class="token operator">=</span><span class="token string">"123456"</span><span class="token punctuation">,</span> email<span class="token operator">=</span><span class="token string">"123@qq.com"</span><span class="token punctuation">)</span>  
<span class="token comment"># 2. 将ORM对象添加到db.session数据库会话中  </span>
db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>user<span class="token punctuation">)</span>  
<span class="token comment"># 提交会话，将db.session中的改变同步到数据库  </span>
db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     封装成类方法：
    </p>
    <pre><code class="prism language-python"><span class="token decorator annotation punctuation">@classmethod</span>  
<span class="token keyword">def</span> <span class="token function">create_comm</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> content<span class="token punctuation">,</span> user_id<span class="token punctuation">,</span> work_id<span class="token punctuation">)</span><span class="token punctuation">:</span>  
    comm <span class="token operator">=</span> Comment<span class="token punctuation">(</span>content<span class="token operator">=</span>content<span class="token punctuation">,</span> user_id<span class="token operator">=</span>user_id<span class="token punctuation">,</span> work_id<span class="token operator">=</span>work_id<span class="token punctuation">)</span>  
    db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>comm<span class="token punctuation">)</span>  
    db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>  
    <span class="token keyword">return</span> comm

comm <span class="token operator">=</span> Comment<span class="token punctuation">.</span>create_comm<span class="token punctuation">(</span>content<span class="token punctuation">,</span> user_id<span class="token punctuation">,</span> work_id<span class="token punctuation">)</span>
</code></pre>
    <h4>
     <a id="_23">
     </a>
     删
    </h4>
    <pre><code class="prism language-python">db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>delete<span class="token punctuation">(</span>user<span class="token punctuation">)</span>
db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     封装成实例方法：
    </p>
    <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">del_work</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>  
    db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>delete<span class="token punctuation">(</span>self<span class="token punctuation">)</span>  
    db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>

work <span class="token operator">=</span> db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>Work<span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span>work_id<span class="token punctuation">)</span>  
<span class="token keyword">if</span> <span class="token keyword">not</span> work<span class="token punctuation">:</span>  
    <span class="token keyword">return</span> error_response<span class="token punctuation">(</span><span class="token string">"作品不存在！"</span><span class="token punctuation">)</span>  
work<span class="token punctuation">.</span>del_work<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
    <h4>
     <a id="_40">
     </a>
     改
    </h4>
    <pre><code class="prism language-python">user<span class="token punctuation">.</span>name <span class="token operator">=</span> new_name
db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     封装成实例方法：
    </p>
    <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">update_username</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> new_name<span class="token punctuation">)</span><span class="token punctuation">:</span>  
    self<span class="token punctuation">.</span>username <span class="token operator">=</span> new_name  
    db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>  
    <span class="token keyword">return</span> self

user<span class="token punctuation">.</span>update_username<span class="token punctuation">(</span>new_name<span class="token punctuation">)</span>
</code></pre>
    <h4>
     <a id="_55">
     </a>
     查
    </h4>
    <pre><code class="prism language-python"><span class="token comment"># 根据主键查询，返回一个对象</span>
user <span class="token operator">=</span> User<span class="token punctuation">.</span>query<span class="token punctuation">.</span>get<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span>
user <span class="token operator">=</span> db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span>

<span class="token comment"># 根据某一字段查询，返回一个对象</span>
user <span class="token operator">=</span> db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span>filter_by<span class="token punctuation">(</span>username<span class="token operator">=</span><span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 列出表里所有数据，返回一个列表</span>
works <span class="token operator">=</span> db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>Work<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 查询符合条件的数据数量</span>
total_count <span class="token operator">=</span> db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>Work<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>Work<span class="token punctuation">.</span>title<span class="token punctuation">.</span>contains<span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     封装成类方法：
    </p>
    <pre><code class="prism language-python"><span class="token comment"># 类方法</span>
<span class="token decorator annotation punctuation">@classmethod</span>  
<span class="token keyword">def</span> <span class="token function">get_work_by_title</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> title<span class="token punctuation">)</span><span class="token punctuation">:</span>  
    <span class="token keyword">return</span> cls<span class="token punctuation">.</span>query<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>cls<span class="token punctuation">.</span>title<span class="token punctuation">.</span>contains<span class="token punctuation">(</span>title<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

works <span class="token operator">=</span> Work<span class="token punctuation">.</span>get_work_by_title<span class="token punctuation">(</span>title<span class="token punctuation">)</span>
</code></pre>
    <h4>
     <a id="_81">
     </a>
     连表操作
    </h4>
    <p>
     定义作品表
    </p>
    <pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">Work</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>  
    <span class="token comment"># 定义表名  </span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"work"</span>  
    <span class="token comment"># 定义关键字  </span>
    <span class="token comment"># 关键字=db.Column(数据类型(长度)，primary_key是否主键，autoincrement是否自增，nullable是否可以为空)  </span>
    work_id <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> autoincrement<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  
    title <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>  
    content <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>Text<span class="token punctuation">)</span>  
  
    <span class="token comment"># 添加作者的外键  </span>
    author_id <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>Integer<span class="token punctuation">,</span> db<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span><span class="token string">"user.user_id"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
    <span class="token comment"># backref会自动给User模型添加一个works的属性，用来获取文章列表，另一张表就不需要写此配置  </span>
    author <span class="token operator">=</span> db<span class="token punctuation">.</span>relationship<span class="token punctuation">(</span><span class="token string">"User"</span><span class="token punctuation">,</span> backref<span class="token operator">=</span><span class="token string">"works"</span><span class="token punctuation">)</span>  
  
    <span class="token comment"># 设置发布时间  </span>
    pub_date <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>DateTime<span class="token punctuation">,</span> default<span class="token operator">=</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">)</span>
</code></pre>
    <p>
     定义类别表，以及作品-类别中间表
    </p>
    <pre><code class="prism language-python">work_category <span class="token operator">=</span> db<span class="token punctuation">.</span>Table<span class="token punctuation">(</span><span class="token string">'work_category'</span><span class="token punctuation">,</span>  
    db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span><span class="token string">'cate_id'</span><span class="token punctuation">,</span> db<span class="token punctuation">.</span>Integer<span class="token punctuation">,</span> db<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span><span class="token string">'category.cate_id'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  
    db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span><span class="token string">'work_id'</span><span class="token punctuation">,</span> db<span class="token punctuation">.</span>Integer<span class="token punctuation">,</span> db<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span><span class="token string">'work.work_id'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  
<span class="token punctuation">)</span>  
  
<span class="token keyword">class</span> <span class="token class-name">Category</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>  
    __tablename__ <span class="token operator">=</span> <span class="token string">"category"</span>  
    cate_id <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> autoincrement<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  
    cate_name <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> unique<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  
    <span class="token comment"># 关联work表，删除work时会将work_category表里的对应数据删除  </span>
    works <span class="token operator">=</span> db<span class="token punctuation">.</span>relationship<span class="token punctuation">(</span><span class="token string">'Work'</span><span class="token punctuation">,</span> secondary<span class="token operator">=</span>work_category<span class="token punctuation">,</span> backref<span class="token operator">=</span><span class="token string">'categories'</span><span class="token punctuation">)</span>  
  
    <span class="token keyword">def</span> <span class="token function">get_works_by_category_id</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>  
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>works  
  
    <span class="token keyword">def</span> <span class="token function">get_work_count</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>  
        <span class="token keyword">return</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>works<span class="token punctuation">)</span>
</code></pre>
    <p>
     根据类别查询作品
    </p>
    <pre><code class="prism language-python">category <span class="token operator">=</span> db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>Category<span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span>category_id<span class="token punctuation">)</span>
works <span class="token operator">=</span> category<span class="token punctuation">.</span>get_works_by_category_id<span class="token punctuation">(</span><span class="token punctuation">)</span>
total <span class="token operator">=</span> category<span class="token punctuation">.</span>get_work_count<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     作品类下面加一个删除功能的实例方法
    </p>
    <pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">Work</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>  
    <span class="token comment"># 定义表名  </span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"work"</span>  
    <span class="token comment"># 定义关键字  </span>
    <span class="token comment"># 关键字=db.Column(数据类型(长度)，primary_key是否主键，autoincrement是否自增，nullable是否可以为空)  </span>
    work_id <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> autoincrement<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  
    title <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>  
    content <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>Text<span class="token punctuation">)</span>  
  
    <span class="token comment"># 添加作者的外键  </span>
    author_id <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>Integer<span class="token punctuation">,</span> db<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span><span class="token string">"user.user_id"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
    <span class="token comment"># backref会自动给User模型添加一个works的属性，用来获取文章列表，另一张表就不需要写此配置  </span>
    author <span class="token operator">=</span> db<span class="token punctuation">.</span>relationship<span class="token punctuation">(</span><span class="token string">"User"</span><span class="token punctuation">,</span> backref<span class="token operator">=</span><span class="token string">"works"</span><span class="token punctuation">)</span>  
  
    <span class="token comment"># 设置发布时间  </span>
    pub_date <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>DateTime<span class="token punctuation">,</span> default<span class="token operator">=</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">)</span>

	<span class="token keyword">def</span> <span class="token function">del_work</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>  
	    db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>delete<span class="token punctuation">(</span>self<span class="token punctuation">)</span>  
	    db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     删除接口
    </p>
    <pre><code class="prism language-python"><span class="token decorator annotation punctuation">@work_bp<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/del/&lt;int:work_id&gt;"</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'DELETE'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  
<span class="token decorator annotation punctuation">@login_reqired</span>  
<span class="token keyword">def</span> <span class="token function">work_del</span><span class="token punctuation">(</span>work_id<span class="token punctuation">)</span><span class="token punctuation">:</span>  
    work <span class="token operator">=</span> db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>Work<span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span>work_id<span class="token punctuation">)</span>  
    <span class="token keyword">if</span> <span class="token keyword">not</span> work<span class="token punctuation">:</span>  
        <span class="token keyword">return</span> error_response<span class="token punctuation">(</span><span class="token string">"作品不存在！"</span><span class="token punctuation">)</span> 
    work<span class="token punctuation">.</span>del_work<span class="token punctuation">(</span><span class="token punctuation">)</span>  
    data <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"work_id"</span><span class="token punctuation">:</span> work_id<span class="token punctuation">}</span>  
    <span class="token keyword">return</span> generate_response<span class="token punctuation">(</span>data<span class="token operator">=</span>data<span class="token punctuation">,</span> message<span class="token operator">=</span><span class="token string">"作品删除成功！"</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     当删除作品时，能自动将作品-类别表里对应的数据删除
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/3e005de2343a409a98814953ee9a0a0e.png">
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/df4570cf8dfa487e8d16d8580e415379.png"/>
     </img>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/4ce9ea65df9542d3a613dbcab042a21a.png"/>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f34353734323937362f:61727469636c652f64657461696c732f313436323637343136" class_="artid" style="display:none">
 </p>
</div>


