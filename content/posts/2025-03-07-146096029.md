---
layout: post
title: "Golang学习笔记_45备忘录模式"
date: 2025-03-07 20:00:00 +0800
description: "备忘录模式是一种行为型设计模式，通过在不破坏对象封装性的前提下捕获和存储对象内部状态，实现状态的可追溯恢复机制。其核心特点包括：•状态封装：将对象状态隔离在专用备忘录对象中•历史回溯：支持任意时间点的状态版本恢复•权限隔离：状态存储与恢复操作限定在特定对象间。"
keywords: "golang 备忘录模式"
categories: ['Golang']
tags: ['设计模式', '笔记', '学习', '备忘录模式', 'Golang']
artid: "146096029"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146096029
    alt: "Golang学习笔记_45备忘录模式"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146096029
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146096029
cover: https://bing.ee123.net/img/rand?artid=146096029
image: https://bing.ee123.net/img/rand?artid=146096029
img: https://bing.ee123.net/img/rand?artid=146096029
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Golang学习笔记_45——备忘录模式
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     <a href="https://blog.csdn.net/LuckyLay/article/details/145993904">
      Golang学习笔记_42——迭代器模式
     </a>
     <br/>
     <a href="https://blog.csdn.net/LuckyLay/article/details/146062560">
      Golang学习笔记_43——责任链模式
     </a>
     <br/>
     <a href="https://blog.csdn.net/LuckyLay/article/details/146063032">
      Golang学习笔记_44——命令模式
     </a>
    </p>
    <hr/>
    <p>
    </p>
    <p>
    </p>
    <hr/>
    <h3>
     <a id="_12">
     </a>
     一、核心概念
    </h3>
    <h4>
     <a id="1__13">
     </a>
     1. 定义
    </h4>
    <p>
     <strong>
      备忘录模式
     </strong>
     是一种
     <strong>
      行为型设计模式
     </strong>
     ，通过在不破坏对象封装性的前提下捕获和存储对象内部状态，实现状态的可追溯恢复机制。其核心特点包括：
     <br/>
     •
     <strong>
      状态封装
     </strong>
     ：将对象状态隔离在专用备忘录对象中
     <br/>
     •
     <strong>
      历史回溯
     </strong>
     ：支持任意时间点的状态版本恢复
     <br/>
     •
     <strong>
      权限隔离
     </strong>
     ：状态存储与恢复操作限定在特定对象间
    </p>
    <h4>
     <a id="2__19">
     </a>
     2. 解决的问题
    </h4>
    <p>
     •
     <strong>
      状态不可逆
     </strong>
     ：缺乏标准化的撤销/恢复机制
     <br/>
     •
     <strong>
      数据暴露风险
     </strong>
     ：直接访问对象内部状态破坏封装性
     <br/>
     •
     <strong>
      版本管理复杂
     </strong>
     ：多版本状态存储与检索困难
    </p>
    <h4>
     <a id="3__24">
     </a>
     3. 核心角色
    </h4>
    <table>
     <thead>
      <tr>
       <th>
        角色
       </th>
       <th>
        作用
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        Originator
       </td>
       <td>
        创建并管理备忘录的生命周期，维护内部状态
       </td>
      </tr>
      <tr>
       <td>
        Memento
       </td>
       <td>
        存储Originator内部状态的安全容器
       </td>
      </tr>
      <tr>
       <td>
        Caretaker
       </td>
       <td>
        备忘录的存储管理者，维护历史状态记录栈
       </td>
      </tr>
     </tbody>
    </table>
    <h4>
     <a id="4__31">
     </a>
     4. 类图
    </h4>
    <p>
     <img alt="备忘录模式类图" src="https://i-blog.csdnimg.cn/direct/b4ab8791034d45d1befb5a2458dc35cb.png"/>
    </p>
    <pre><code class="prism language-plantuml">@startuml
class Originator {
    - state: string
    + CreateMemento(): Memento
    + Restore(m: Memento)
}

class Memento {
    - state: string
    + GetState(): string
    + SetState(s: string)
}

class Caretaker {
    - history: []Memento
    + Save(m: Memento)
    + Retrieve(index int): Memento
}

Originator --&gt; Memento
Caretaker --&gt; Memento

note right of Originator::CreateMemento
    创建包含当前状态的备忘录
    仅Originator可访问完整数据
end note
@enduml
</code></pre>
    <h3>
     <a id="_64">
     </a>
     二、特点分析
    </h3>
    <p>
     <strong>
      优点
     </strong>
    </p>
    <ol>
     <li>
      <strong>
       封装保护
      </strong>
      ：严格限制状态访问权限
     </li>
     <li>
      <strong>
       简化恢复
      </strong>
      ：标准化状态回滚操作流程
     </li>
     <li>
      <strong>
       版本控制
      </strong>
      ：支持多时间点状态快照管理
     </li>
    </ol>
    <p>
     <strong>
      缺点
     </strong>
    </p>
    <ol>
     <li>
      <strong>
       内存消耗
      </strong>
      ：大对象频繁快照导致资源占用
     </li>
     <li>
      <strong>
       性能损耗
      </strong>
      ：深拷贝复杂对象时效率下降
     </li>
     <li>
      <strong>
       版本冲突
      </strong>
      ：多版本管理可能引发状态不一致
     </li>
    </ol>
    <h3>
     <a id="_75">
     </a>
     三、适用场景
    </h3>
    <h4>
     <a id="1__76">
     </a>
     1. 文档编辑器
    </h4>
    <pre><code class="prism language-go"><span class="token keyword">type</span> EditorMemento <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
    content <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> TextEditor <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
    content <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>e <span class="token operator">*</span>TextEditor<span class="token punctuation">)</span> <span class="token function">Save</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>EditorMemento <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>EditorMemento<span class="token punctuation">{<!-- --></span>content<span class="token punctuation">:</span> e<span class="token punctuation">.</span>content<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>e <span class="token operator">*</span>TextEditor<span class="token punctuation">)</span> <span class="token function">Restore</span><span class="token punctuation">(</span>m <span class="token operator">*</span>EditorMemento<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    e<span class="token punctuation">.</span>content <span class="token operator">=</span> m<span class="token punctuation">.</span>content
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="2__95">
     </a>
     2. 游戏存档系统
    </h4>
    <pre><code class="prism language-go"><span class="token keyword">type</span> GameSave <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
    level   <span class="token builtin">int</span>
    weapons <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> PlayerState <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
    current <span class="token operator">*</span>GameSave
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>PlayerState<span class="token punctuation">)</span> <span class="token function">QuickSave</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>GameSave <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>GameSave<span class="token punctuation">{<!-- --></span>
        level<span class="token punctuation">:</span>   p<span class="token punctuation">.</span>current<span class="token punctuation">.</span>level<span class="token punctuation">,</span>
        weapons<span class="token punctuation">:</span> <span class="token function">append</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>current<span class="token punctuation">.</span>weapons<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="3__114">
     </a>
     3. 配置管理系统
    </h4>
    <pre><code class="prism language-go"><span class="token keyword">type</span> ConfigSnapshot <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
    version <span class="token builtin">string</span>
    config  <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">RollbackConfig</span><span class="token punctuation">(</span>snapshots <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>ConfigSnapshot<span class="token punctuation">,</span> targetVer <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 实现版本检索与配置回滚</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="Go_126">
     </a>
     四、Go语言实现示例
    </h3>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/2d41498fae4c401c8770cf4e5caa4f9b.png">
      <br/>
      <strong>
       完整实现代码
      </strong>
     </img>
    </p>
    <pre><code class="prism language-go"><span class="token keyword">package</span> memento_demo

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token comment">// Memento 备忘录</span>
<span class="token keyword">type</span> EditorMemento <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	content <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>EditorMemento<span class="token punctuation">)</span> <span class="token function">Content</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> m<span class="token punctuation">.</span>content
<span class="token punctuation">}</span>

<span class="token comment">// Originator 原发器</span>
<span class="token keyword">type</span> TextEditor <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	content <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>e <span class="token operator">*</span>TextEditor<span class="token punctuation">)</span> <span class="token function">Write</span><span class="token punctuation">(</span>input <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	e<span class="token punctuation">.</span>content <span class="token operator">+=</span> input
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>e <span class="token operator">*</span>TextEditor<span class="token punctuation">)</span> <span class="token function">Save</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>EditorMemento <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>EditorMemento<span class="token punctuation">{<!-- --></span>content<span class="token punctuation">:</span> e<span class="token punctuation">.</span>content<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>e <span class="token operator">*</span>TextEditor<span class="token punctuation">)</span> <span class="token function">Restore</span><span class="token punctuation">(</span>m <span class="token operator">*</span>EditorMemento<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	e<span class="token punctuation">.</span>content <span class="token operator">=</span> m<span class="token punctuation">.</span><span class="token function">Content</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// Caretaker 管理者</span>
<span class="token keyword">type</span> HistoryKeeper <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	saves <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>EditorMemento
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>HistoryKeeper<span class="token punctuation">)</span> <span class="token function">Push</span><span class="token punctuation">(</span>m <span class="token operator">*</span>EditorMemento<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	h<span class="token punctuation">.</span>saves <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>saves<span class="token punctuation">,</span> m<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>HistoryKeeper<span class="token punctuation">)</span> <span class="token function">Pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>EditorMemento <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>saves<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>
	last <span class="token operator">:=</span> h<span class="token punctuation">.</span>saves<span class="token punctuation">[</span><span class="token function">len</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>saves<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
	h<span class="token punctuation">.</span>saves <span class="token operator">=</span> h<span class="token punctuation">.</span>saves<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token function">len</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>saves<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
	<span class="token keyword">return</span> last
<span class="token punctuation">}</span>

<span class="token comment">// 客户端使用示例</span>
<span class="token keyword">func</span> <span class="token function">ExampleUsage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	editor <span class="token operator">:=</span> <span class="token operator">&amp;</span>TextEditor<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
	history <span class="token operator">:=</span> <span class="token operator">&amp;</span>HistoryKeeper<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

	<span class="token comment">// 编辑操作</span>
	editor<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"Hello"</span><span class="token punctuation">)</span>
	history<span class="token punctuation">.</span><span class="token function">Push</span><span class="token punctuation">(</span>editor<span class="token punctuation">.</span><span class="token function">Save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	editor<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">" World"</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Current:"</span><span class="token punctuation">,</span> editor<span class="token punctuation">.</span>content<span class="token punctuation">)</span>

	<span class="token comment">// 撤销操作</span>
	<span class="token keyword">if</span> m <span class="token operator">:=</span> history<span class="token punctuation">.</span><span class="token function">Pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> m <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		editor<span class="token punctuation">.</span><span class="token function">Restore</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"After Undo:"</span><span class="token punctuation">,</span> editor<span class="token punctuation">.</span>content<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     <strong>
      执行结果
     </strong>
    </p>
    <pre><code class="prism language-text">=== RUN   TestExampleUsage
Current: Hello World
After Undo: Hello
--- PASS: TestExampleUsage (0.00s)
PASS

</code></pre>
    <h3>
     <a id="_208">
     </a>
     五、高级应用
    </h3>
    <h4>
     <a id="1__209">
     </a>
     1. 增量快照系统
    </h4>
    <pre><code class="prism language-go"><span class="token keyword">type</span> DeltaMemento <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
    timestamp time<span class="token punctuation">.</span>Time
    delta     <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">CreateDeltaSnapshot</span><span class="token punctuation">(</span>prev<span class="token punctuation">,</span> current <span class="token operator">*</span>DocumentState<span class="token punctuation">)</span> <span class="token operator">*</span>DeltaMemento <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 计算差异生成增量快照</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="2__221">
     </a>
     2. 分布式状态同步
    </h4>
    <pre><code class="prism language-go"><span class="token keyword">type</span> StateSyncService <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
    snapshots <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>NodeState
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>StateSyncService<span class="token punctuation">)</span> <span class="token function">RollbackCluster</span><span class="token punctuation">(</span>targetVer <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 集群级状态回滚实现</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="_232">
     </a>
     六、与其他模式对比
    </h3>
    <table>
     <thead>
      <tr>
       <th>
        模式
       </th>
       <th>
        核心区别
       </th>
       <th>
        典型应用场景
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        <strong>
         命令模式
        </strong>
       </td>
       <td>
        操作封装 vs 状态存储
       </td>
       <td>
        事务回滚系统
       </td>
      </tr>
      <tr>
       <td>
        <strong>
         原型模式
        </strong>
       </td>
       <td>
        对象克隆 vs 状态保存
       </td>
       <td>
        复杂对象复制
       </td>
      </tr>
      <tr>
       <td>
        <strong>
         状态模式
        </strong>
       </td>
       <td>
        状态转移 vs 状态存档
       </td>
       <td>
        工作流引擎
       </td>
      </tr>
     </tbody>
    </table>
    <h3>
     <a id="_239">
     </a>
     七、实现建议
    </h3>
    <ol>
     <li>
      <strong>
       状态序列化
      </strong>
      ：使用JSON/gob实现快照持久化
      <pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>Memento<span class="token punctuation">)</span> <span class="token function">Serialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> json<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
     </li>
     <li>
      <strong>
       内存优化
      </strong>
      ：采用写时复制技术减少内存占用
     </li>
     <li>
      <strong>
       版本压缩
      </strong>
      ：定期合并历史快照减少存储量
     </li>
     <li>
      <strong>
       访问控制
      </strong>
      ：严格限制Memento的字段可见性
     </li>
    </ol>
    <h3>
     <a id="_250">
     </a>
     八、典型应用
    </h3>
    <ol>
     <li>
      <strong>
       IDE开发环境
      </strong>
      ：代码修改历史追溯
     </li>
     <li>
      <strong>
       区块链系统
      </strong>
      ：区块状态回滚机制
     </li>
     <li>
      <strong>
       机器学习
      </strong>
      ：模型训练检查点
     </li>
     <li>
      <strong>
       CI/CD管道
      </strong>
      ：部署失败快速回退
     </li>
    </ol>
    <p>
     通过备忘录模式，可以构建具备完善历史管理能力的系统架构。在Go语言中，建议：
    </p>
    <ul>
     <li>
      使用结构体嵌套实现宽接口/窄接口
     </li>
     <li>
      结合channel实现异步快照存储
     </li>
     <li>
      使用sync.Pool优化频繁创建的备忘录对象
     </li>
    </ul>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a:2f2f626c6f672e6373646e2e6e65742f4c75636b794c61792f:61727469636c652f64657461696c732f313436303936303239" class_="artid" style="display:none">
 </p>
</div>


