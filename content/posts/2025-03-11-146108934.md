---
layout: post
title: "Linux线程池单例模式死锁"
date: 2025-03-11 22:28:00 +0800
description: "线程池、单例模式、死锁"
keywords: "【Linux】线程池、单例模式、死锁"
categories: ['Linux']
tags: ['服务器', '数据库', 'Linux']
artid: "146108934"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146108934
    alt: "Linux线程池单例模式死锁"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146108934
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146108934
cover: https://bing.ee123.net/img/rand?artid=146108934
image: https://bing.ee123.net/img/rand?artid=146108934
img: https://bing.ee123.net/img/rand?artid=146108934
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     【Linux】线程池、单例模式、死锁
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-github-gist" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <br/>
    本节重点：
    <p>
    </p>
    <ul>
     <li>
      设计日志和线程池。
     </li>
     <li>
      理解线程安全和可重入，掌握锁相关概念。
     </li>
    </ul>
    <h2>
     <a id="_5">
     </a>
     一.线程池
    </h2>
    <p>
     在写线程池之前，我们要做如下准备：
    </p>
    <ul>
     <li>
      准备线程的封装。
     </li>
     <li>
      准备锁和条件变量的封装。
     </li>
     <li>
      引入日志，对线程进行封装。
     </li>
    </ul>
    <h3>
     <a id="1_10">
     </a>
     1.日志和策略模式
    </h3>
    <ul>
     <li>
      日志：记录系统和软件运行中发生事件的文件，主要作用是监控运行状态、记录异常信息，帮助快速定位问题并支持程序员进行问题修复。它是系统维护、故障排查和安全管理的重要工具。
     </li>
     <li>
      日志格式中的某些指标是必须有：
      <strong>
       时间戳、日志等级、日志内容
      </strong>
      。存在几个指标是可选的：文件名行号、进程，线程相关id信息等。
     </li>
     <li>
      日志有现成的解决方案：spdlog、glog、Boost.Log、Log4cxx等。日志位于
      <em>
       /var/log/
      </em>
      路径下
     </li>
     <li>
      设计模式：在软件开发过程中，针对反复出现的问题所总结归纳出的通用解决方案。
     </li>
    </ul>
    <p>
     策略模式：
    </p>
    <ul>
     <li>
      抽象策略类(基类)：包含一个或多个纯虚函数，用于声明具体策略类需要实现的接口。
     </li>
     <li>
      具体策略类(派生类)：重写了抽象策略类中定义的接口，每个具体策略类代表一个具体的接口。
     </li>
     <li>
      上下文类：持有一个抽象策略类的指针/引用，负责根据需要选择和使用具体的策略类。
     </li>
    </ul>
    <p>
     抽象策略类的作用：定义统一接口，运行时多态，提高代码的可维护性和可扩展性。
    </p>
    <p>
     这里采用
     <strong>
      设计模式 - 策略模式
     </strong>
     来进行日志的设计，我们想要的日志格式如下：
    </p>
    <pre><code class="prism language-cpp"><span class="token punctuation">[</span>可读性很好的时间<span class="token punctuation">]</span> <span class="token punctuation">[</span>日志等级<span class="token punctuation">]</span> <span class="token punctuation">[</span>进程pid<span class="token punctuation">]</span> <span class="token punctuation">[</span>打印对应日志的文件名<span class="token punctuation">]</span><span class="token punctuation">[</span>行号<span class="token punctuation">]</span> <span class="token operator">-</span> 消息内容<span class="token punctuation">,</span> 支持可变参数

<span class="token punctuation">[</span><span class="token number">2025</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">08</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">43</span><span class="token operator">:</span><span class="token number">30</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">882217</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>Main<span class="token punctuation">.</span>cc<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token operator">-</span> hello world
<span class="token punctuation">[</span><span class="token number">2025</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">08</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">43</span><span class="token operator">:</span><span class="token number">30</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">882217</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>Main<span class="token punctuation">.</span>cc<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">-</span> hello world
<span class="token punctuation">[</span><span class="token number">2025</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">08</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">43</span><span class="token operator">:</span><span class="token number">30</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">882217</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>Main<span class="token punctuation">.</span>cc<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span> <span class="token operator">-</span> hello world
<span class="token punctuation">[</span><span class="token number">2025</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">08</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">43</span><span class="token operator">:</span><span class="token number">30</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">882217</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>Main<span class="token punctuation">.</span>cc<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span> <span class="token operator">-</span> hello world
</code></pre>
    <pre><code class="prism language-cpp"><span class="token comment">// Log.hpp</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">once</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstdio&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;filesystem&gt;</span> <span class="token comment">// C++17文件系统</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fstream&gt;</span>    <span class="token comment">// 文件流</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sstream&gt;</span>    <span class="token comment">// 字符串流</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;memory&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;time.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Mutex.hpp"</span></span>

<span class="token keyword">namespace</span> LogModule
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">using</span> <span class="token keyword">namespace</span> MutexModule<span class="token punctuation">;</span>

    <span class="token comment">// 获取系统时间</span>
    std<span class="token double-colon punctuation">::</span>string <span class="token function">CurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        time_t time_stamp <span class="token operator">=</span> <span class="token double-colon punctuation">::</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取时间戳</span>
        <span class="token keyword">struct</span> <span class="token class-name">tm</span> curr<span class="token punctuation">;</span>
        <span class="token function">localtime_r</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>time_stamp<span class="token punctuation">,</span> <span class="token operator">&amp;</span>curr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将时间戳转化为可读性强的信息</span>

        <span class="token keyword">char</span> buffer<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">snprintf</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"%4d-%02d-%02d %02d:%02d:%02d"</span><span class="token punctuation">,</span>
                 curr<span class="token punctuation">.</span>tm_year <span class="token operator">+</span> <span class="token number">1900</span><span class="token punctuation">,</span>
                 curr<span class="token punctuation">.</span>tm_mon <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>
                 curr<span class="token punctuation">.</span>tm_mday<span class="token punctuation">,</span>
                 curr<span class="token punctuation">.</span>tm_hour<span class="token punctuation">,</span>
                 curr<span class="token punctuation">.</span>tm_min<span class="token punctuation">,</span>
                 curr<span class="token punctuation">.</span>tm_sec<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> buffer<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 日志文件: 默认路径和默认文件名</span>
    <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string defaultlogpath <span class="token operator">=</span> <span class="token string">"./log/"</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string defaultlogname <span class="token operator">=</span> <span class="token string">"log.txt"</span><span class="token punctuation">;</span>

    <span class="token comment">// 日志等级</span>
    <span class="token keyword">enum</span> <span class="token keyword">class</span> <span class="token class-name">LogLevel</span>
    <span class="token punctuation">{<!-- --></span>
        DEBUG <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
        INFO<span class="token punctuation">,</span>
        WARNING<span class="token punctuation">,</span>
        ERROR<span class="token punctuation">,</span>
        FATAL
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    std<span class="token double-colon punctuation">::</span>string <span class="token function">Level2String</span><span class="token punctuation">(</span>LogLevel level<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>level<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">case</span> LogLevel<span class="token double-colon punctuation">::</span>DEBUG<span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token string">"DEBUG"</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> LogLevel<span class="token double-colon punctuation">::</span>INFO<span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token string">"INFO"</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> LogLevel<span class="token double-colon punctuation">::</span>WARNING<span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token string">"WARNING"</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> LogLevel<span class="token double-colon punctuation">::</span>ERROR<span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token string">"ERROR"</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> LogLevel<span class="token double-colon punctuation">::</span>FATAL<span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token string">"FATAL"</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token string">"NONE"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 3. 策略模式: 刷新策略</span>
    <span class="token keyword">class</span> <span class="token class-name">LogStrategy</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">LogStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span> <span class="token comment">//???</span>
        <span class="token comment">// 纯虚函数: 无法实例化对象, 派生类可以重载该函数, 实现不同的刷新方式</span>
        <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">SyncLog</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>message<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// 3.1 控制台策略</span>
    <span class="token keyword">class</span> <span class="token class-name">ConsoleLogStrategy</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">LogStrategy</span></span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">ConsoleLogStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
        <span class="token operator">~</span><span class="token function">ConsoleLogStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

        <span class="token keyword">void</span> <span class="token function">SyncLog</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>message<span class="token punctuation">)</span> <span class="token keyword">override</span>
        <span class="token punctuation">{<!-- --></span>
            LockGuard <span class="token function">lockguard</span><span class="token punctuation">(</span>_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> message <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token keyword">private</span><span class="token operator">:</span>
        Mutex _mutex<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// 3.2 文件级(磁盘)策略</span>
    <span class="token keyword">class</span> <span class="token class-name">FileLogStrategy</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">LogStrategy</span></span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">FileLogStrategy</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>logpath <span class="token operator">=</span> defaultlogpath<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>logname <span class="token operator">=</span> defaultlogname<span class="token punctuation">)</span>
            <span class="token operator">:</span> <span class="token function">_logpath</span><span class="token punctuation">(</span>logpath<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_logname</span><span class="token punctuation">(</span>logname<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 判断_logpath目录是否存在</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>filesystem<span class="token double-colon punctuation">::</span><span class="token function">exists</span><span class="token punctuation">(</span>_logpath<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">try</span>
            <span class="token punctuation">{<!-- --></span>
                std<span class="token double-colon punctuation">::</span>filesystem<span class="token double-colon punctuation">::</span><span class="token function">create_directories</span><span class="token punctuation">(</span>_logpath<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">catch</span> <span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>filesystem<span class="token double-colon punctuation">::</span>filesystem_error <span class="token operator">&amp;</span>e<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                std<span class="token double-colon punctuation">::</span>cerr <span class="token operator">&lt;&lt;</span> e<span class="token punctuation">.</span><span class="token function">what</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token operator">~</span><span class="token function">FileLogStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

        <span class="token keyword">void</span> <span class="token function">SyncLog</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>message<span class="token punctuation">)</span> <span class="token keyword">override</span>
        <span class="token punctuation">{<!-- --></span>
            LockGuard <span class="token function">lockguard</span><span class="token punctuation">(</span>_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            std<span class="token double-colon punctuation">::</span>string log <span class="token operator">=</span> _logpath <span class="token operator">+</span> _logname<span class="token punctuation">;</span>
            std<span class="token double-colon punctuation">::</span>ofstream <span class="token function">out</span><span class="token punctuation">(</span>log<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>ios<span class="token double-colon punctuation">::</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 以追加的方式打开文件</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>out<span class="token punctuation">.</span><span class="token function">is_open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            out <span class="token operator">&lt;&lt;</span> message <span class="token operator">&lt;&lt;</span> <span class="token string">"\n"</span><span class="token punctuation">;</span> <span class="token comment">// 将信息刷新到out流中</span>
            out<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token keyword">private</span><span class="token operator">:</span>
        std<span class="token double-colon punctuation">::</span>string _logpath<span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>string _logname<span class="token punctuation">;</span>
        Mutex _mutex<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// 4. 日志类: 构建日志字符串, 根据策略进行刷新</span>
    <span class="token keyword">class</span> <span class="token class-name">Logger</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">Logger</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 默认往控制台上刷新</span>
            _strategy <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>ConsoleLogStrategy<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token operator">~</span><span class="token function">Logger</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

        <span class="token keyword">void</span> <span class="token function">EnableConsoleLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _strategy <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>ConsoleLogStrategy<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">void</span> <span class="token function">EnableFileLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _strategy <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>FileLogStrategy<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 内部类: 记录完整的日志信息</span>
        <span class="token keyword">class</span> <span class="token class-name">LogMessage</span>
        <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">public</span><span class="token operator">:</span>
            <span class="token function">LogMessage</span><span class="token punctuation">(</span>LogLevel level<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>filename<span class="token punctuation">,</span> <span class="token keyword">int</span> line<span class="token punctuation">,</span> Logger <span class="token operator">&amp;</span>logger<span class="token punctuation">)</span>
                <span class="token operator">:</span> <span class="token function">_currtime</span><span class="token punctuation">(</span><span class="token function">CurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_level</span><span class="token punctuation">(</span>level<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_pid</span><span class="token punctuation">(</span><span class="token double-colon punctuation">::</span><span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">,</span> <span class="token function">_filename</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_line</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_logger</span><span class="token punctuation">(</span>logger<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                std<span class="token double-colon punctuation">::</span>stringstream ssbuffer<span class="token punctuation">;</span>
                ssbuffer <span class="token operator">&lt;&lt;</span> <span class="token string">"["</span> <span class="token operator">&lt;&lt;</span> _currtime <span class="token operator">&lt;&lt;</span> <span class="token string">"] "</span>
                         <span class="token operator">&lt;&lt;</span> <span class="token string">"["</span> <span class="token operator">&lt;&lt;</span> <span class="token function">Level2String</span><span class="token punctuation">(</span>_level<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"] "</span>
                         <span class="token operator">&lt;&lt;</span> <span class="token string">"["</span> <span class="token operator">&lt;&lt;</span> _pid <span class="token operator">&lt;&lt;</span> <span class="token string">"] "</span>
                         <span class="token operator">&lt;&lt;</span> <span class="token string">"["</span> <span class="token operator">&lt;&lt;</span> _filename <span class="token operator">&lt;&lt;</span> <span class="token string">"] "</span>
                         <span class="token operator">&lt;&lt;</span> <span class="token string">"["</span> <span class="token operator">&lt;&lt;</span> _line <span class="token operator">&lt;&lt;</span> <span class="token string">"] - "</span><span class="token punctuation">;</span>

                _loginfo <span class="token operator">=</span> ssbuffer<span class="token punctuation">.</span><span class="token function">str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token operator">~</span><span class="token function">LogMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>_logger<span class="token punctuation">.</span>_strategy<span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    _logger<span class="token punctuation">.</span>_strategy<span class="token operator">-&gt;</span><span class="token function">SyncLog</span><span class="token punctuation">(</span>_loginfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
            LogMessage <span class="token operator">&amp;</span><span class="token keyword">operator</span><span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span><span class="token keyword">const</span> T <span class="token operator">&amp;</span>info<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                std<span class="token double-colon punctuation">::</span>stringstream ssbuffer<span class="token punctuation">;</span>
                ssbuffer <span class="token operator">&lt;&lt;</span> info<span class="token punctuation">;</span>
                _loginfo <span class="token operator">+=</span> ssbuffer<span class="token punctuation">.</span><span class="token function">str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token keyword">private</span><span class="token operator">:</span>
            std<span class="token double-colon punctuation">::</span>string _currtime<span class="token punctuation">;</span>  <span class="token comment">// 当前日志时间</span>
            LogLevel _level<span class="token punctuation">;</span>       <span class="token comment">// 日志水平</span>
            pid_t _pid<span class="token punctuation">;</span>            <span class="token comment">// 进程pid</span>
            std<span class="token double-colon punctuation">::</span>string _filename<span class="token punctuation">;</span> <span class="token comment">// 文件名</span>
            <span class="token keyword">uint32_t</span> _line<span class="token punctuation">;</span>        <span class="token comment">// 日志行号</span>
            Logger <span class="token operator">&amp;</span>_logger<span class="token punctuation">;</span>       <span class="token comment">// 负责根据不同的策略进行刷新</span>
            std<span class="token double-colon punctuation">::</span>string _loginfo<span class="token punctuation">;</span>  <span class="token comment">// 日志信息</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token comment">// 故意拷贝, 形成LogMessage临时对象, 后续在被&lt;&lt;时，会被持续引用,</span>
        <span class="token comment">// 直到完成输入，才会自动析构临时LogMessage, 至此完成了日志的刷新,</span>
        <span class="token comment">// 同时形成的临时对象内包含独立日志数据, 未来采用宏替换, 获取文件名和代码行数</span>
        LogMessage <span class="token keyword">operator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>LogLevel level<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>filename<span class="token punctuation">,</span> <span class="token keyword">int</span> line<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token function">LogMessage</span><span class="token punctuation">(</span>level<span class="token punctuation">,</span> filename<span class="token punctuation">,</span> line<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token keyword">private</span><span class="token operator">:</span>
        <span class="token comment">// 纯虚类不能实例化对象, 但是可以定义指针</span>
        std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>LogStrategy<span class="token operator">&gt;</span> _strategy<span class="token punctuation">;</span> <span class="token comment">// 日志刷新策略方案</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// 定义全局logger对象</span>
    Logger logger<span class="token punctuation">;</span>

<span class="token comment">// 编译时进行宏替换: 方便随时获取行号和文件名</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LOG</span><span class="token expression"><span class="token punctuation">(</span>level<span class="token punctuation">)</span> <span class="token function">logger</span><span class="token punctuation">(</span>level<span class="token punctuation">,</span> <span class="token constant">__FILE__</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">)</span></span></span>

<span class="token comment">// 提供选择使用何种日志策略的方法</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">ENABLE_CONSOLE_LOG</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span> logger<span class="token punctuation">.</span><span class="token function">EnableConsoleLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">ENABLE_FILE_LOG</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span> logger<span class="token punctuation">.</span><span class="token function">EnableFileLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span>
<span class="token punctuation">}</span>

<span class="token comment">// Main.cc</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Log.hpp"</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> LogModule<span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 往显示器中写入</span>
    <span class="token function">ENABLE_CONSOLE_LOG</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOG</span><span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>DEBUG<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"hello world"</span><span class="token punctuation">;</span>
    <span class="token function">LOG</span><span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>DEBUG<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"hello world"</span><span class="token punctuation">;</span>
    <span class="token function">LOG</span><span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>DEBUG<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"hello world"</span><span class="token punctuation">;</span>
    <span class="token function">LOG</span><span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>DEBUG<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"hello world"</span><span class="token punctuation">;</span>

    <span class="token comment">// 往文件中写入</span>
    <span class="token function">ENABLE_FILE_LOG</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOG</span><span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>DEBUG<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"hello world"</span><span class="token punctuation">;</span>
    <span class="token function">LOG</span><span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>DEBUG<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"hello world"</span><span class="token punctuation">;</span>
    <span class="token function">LOG</span><span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>DEBUG<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"hello world"</span><span class="token punctuation">;</span>
    <span class="token function">LOG</span><span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>DEBUG<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"hello world"</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <pre><code class="prism language-bash">xzy@hcss-ecs-b3aa:~$ ./testLog 
<span class="token punctuation">[</span><span class="token number">2025</span>-03-08 00:43:30<span class="token punctuation">]</span> <span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">882217</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>Main.cc<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span> - hello world
<span class="token punctuation">[</span><span class="token number">2025</span>-03-08 00:43:30<span class="token punctuation">]</span> <span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">882217</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>Main.cc<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> - hello world
<span class="token punctuation">[</span><span class="token number">2025</span>-03-08 00:43:30<span class="token punctuation">]</span> <span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">882217</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>Main.cc<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span> - hello world
<span class="token punctuation">[</span><span class="token number">2025</span>-03-08 00:43:30<span class="token punctuation">]</span> <span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">882217</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>Main.cc<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span> - hello world
</code></pre>
    <h3>
     <a id="2_298">
     </a>
     2.线程池
    </h3>
    <ul>
     <li>
      线程池：创建一定数量线程，这些线程处于等待任务的状态。如果没有任务，线程在条件变量下等待，直到有任务到来。当有新的任务到来时，线程池会唤醒一个线程执行任务。当任务执行完毕后，线程不会被销毁，而是返回到线程池中等待下一个任务，从而实现线程的复用。
     </li>
    </ul>
    <p>
     线程池使用场景：
    </p>
    <ul>
     <li>
      高并发场景：在处理大量并发请求的场景中，如 Web 服务器、数据库服务器等，使用线程池可以有效地处理并发请求，提高系统的吞吐量。
     </li>
     <li>
      任务执行频繁的场景：当程序中需要频繁地执行一些小任务时，使用线程池可以避免频繁地创建和销毁线程，提高程序的效率。
     </li>
     <li>
      需要控制线程数量的场景：在一些对系统资源有限制的场景中，如嵌入式系统、移动设备等，使用线程池可以控制线程的数量，避免系统资源耗尽。
     </li>
    </ul>
    <p>
     这里我们实现：创建固定数量线程池，循环从任务队列中获取任务对象，获取到任务对象后，执行任务对象中的任务接口。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/0ffb29903eb14374884d6657581edea2.png"/>
    </p>
    <h4>
     <a id="1Taskhpp_312">
     </a>
     1.Task.hpp
    </h4>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">once</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;functional&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Log.hpp"</span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> LogModule<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">MySql</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>string name<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">LOG</span><span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>DEBUG<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"我是一个数据任务, 我正在被执行"</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"["</span> <span class="token operator">&lt;&lt;</span> name <span class="token operator">&lt;&lt;</span> <span class="token string">"]"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">UpLoad</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>string name<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">LOG</span><span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>DEBUG<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"我是一个上传任务, 我正在被执行"</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"["</span> <span class="token operator">&lt;&lt;</span> name <span class="token operator">&lt;&lt;</span> <span class="token string">"]"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">DownLoad</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>string name<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">LOG</span><span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>DEBUG<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"我是一个下载任务, 我正在被执行"</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"["</span> <span class="token operator">&lt;&lt;</span> name <span class="token operator">&lt;&lt;</span> <span class="token string">"]"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">using</span> task_t <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>string name<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>task_t<span class="token operator">&gt;</span> tasks<span class="token punctuation">;</span>
</code></pre>
    <h4>
     <a id="2Threadhpp_343">
     </a>
     2.Thread.hpp
    </h4>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">once</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;functional&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">namespace</span> ThreadModule
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">using</span> func_t <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>string<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">int</span> number <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token comment">// 强类型枚举: 枚举的成员名称被限定在枚举类型的作用域内</span>
    <span class="token keyword">enum</span> <span class="token keyword">class</span> <span class="token class-name">TSTATUS</span>
    <span class="token punctuation">{<!-- --></span>
        NEW<span class="token punctuation">,</span>
        RUNNING<span class="token punctuation">,</span>
        STOP
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">class</span> <span class="token class-name">Thread</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span><span class="token operator">:</span>
        <span class="token comment">// 成员方法: 需要加上static表示不需要this指针, 否则回调函数报错</span>
        <span class="token comment">// 而要执行_func()函数又需要由this指针, 所以Routine函数传this指针</span>
        <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">Routine</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>args<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            Thread <span class="token operator">*</span>t <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>Thread <span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
            t<span class="token operator">-&gt;</span><span class="token function">_func</span><span class="token punctuation">(</span>t<span class="token operator">-&gt;</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">void</span> <span class="token function">EnableDetach</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> _joinable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">Thread</span><span class="token punctuation">(</span>func_t func<span class="token punctuation">)</span>
            <span class="token operator">:</span> <span class="token function">_func</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_status</span><span class="token punctuation">(</span>TSTATUS<span class="token double-colon punctuation">::</span>NEW<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_joinable</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _name <span class="token operator">=</span> <span class="token string">"Thread-"</span> <span class="token operator">+</span> std<span class="token double-colon punctuation">::</span><span class="token function">to_string</span><span class="token punctuation">(</span>number<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            _pid <span class="token operator">=</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token operator">~</span><span class="token function">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

        <span class="token comment">// 线程创建</span>
        <span class="token keyword">bool</span> <span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_status <span class="token operator">!=</span> TSTATUS<span class="token double-colon punctuation">::</span>RUNNING<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_tid<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> Routine<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                _status <span class="token operator">=</span> TSTATUS<span class="token double-colon punctuation">::</span>RUNNING<span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 线程退出</span>
        <span class="token keyword">bool</span> <span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_status <span class="token operator">==</span> TSTATUS<span class="token double-colon punctuation">::</span>RUNNING<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token double-colon punctuation">::</span><span class="token function">pthread_cancel</span><span class="token punctuation">(</span>_tid<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                _status <span class="token operator">=</span> TSTATUS<span class="token double-colon punctuation">::</span>STOP<span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 线程等待</span>
        <span class="token keyword">bool</span> <span class="token function">Join</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_joinable<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token double-colon punctuation">::</span><span class="token function">pthread_join</span><span class="token punctuation">(</span>_tid<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                _status <span class="token operator">=</span> TSTATUS<span class="token double-colon punctuation">::</span>STOP<span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 线程分离</span>
        <span class="token keyword">bool</span> <span class="token function">Detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">EnableDetach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token double-colon punctuation">::</span><span class="token function">pthread_detach</span><span class="token punctuation">(</span>_tid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 线程是否分离</span>
        <span class="token keyword">bool</span> <span class="token function">IsJoinable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  <span class="token keyword">return</span> _joinable<span class="token punctuation">;</span> <span class="token punctuation">}</span>
        std<span class="token double-colon punctuation">::</span>string <span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> _name<span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">private</span><span class="token operator">:</span>
        std<span class="token double-colon punctuation">::</span>string _name<span class="token punctuation">;</span>
        pthread_t _tid<span class="token punctuation">;</span>
        pid_t _pid<span class="token punctuation">;</span>
        <span class="token keyword">bool</span> _joinable<span class="token punctuation">;</span> <span class="token comment">// 线程是否是分离的, 默认不是</span>
        func_t _func<span class="token punctuation">;</span>
        TSTATUS _status<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="3ThreadPoolhpp_459">
     </a>
     3.ThreadPool.hpp
    </h4>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">once</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;vector&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;queue&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;memory&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Mutex.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Cond.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Thread.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Log.hpp"</span></span>

<span class="token keyword">namespace</span> ThreadPoolModule
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">using</span> <span class="token keyword">namespace</span> MutexModule<span class="token punctuation">;</span>
    <span class="token keyword">using</span> <span class="token keyword">namespace</span> CondModule<span class="token punctuation">;</span>
    <span class="token keyword">using</span> <span class="token keyword">namespace</span> ThreadModule<span class="token punctuation">;</span>
    <span class="token keyword">using</span> <span class="token keyword">namespace</span> LogModule<span class="token punctuation">;</span>

    <span class="token keyword">using</span> thread_t <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>Thread<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">static</span> <span class="token keyword">int</span> defaultnum <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>

    <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
    <span class="token keyword">class</span> <span class="token class-name">ThreadPool</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span><span class="token operator">:</span>
        <span class="token keyword">bool</span> <span class="token function">IsEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> _taskq<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

        <span class="token keyword">void</span> <span class="token function">HandlerTask</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>string name<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">LOG</span><span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"线程: "</span> <span class="token operator">&lt;&lt;</span> name <span class="token operator">&lt;&lt;</span> <span class="token string">", 进入HandlerTask执行逻辑"</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 1. 拿任务: 访问共享资源, 需要加锁</span>
                T task<span class="token punctuation">;</span>
                <span class="token punctuation">{<!-- --></span>
                    LockGuard <span class="token function">lockguard</span><span class="token punctuation">(</span>_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">IsEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> _isrunning<span class="token punctuation">)</span> <span class="token comment">// while替代if: 防止伪唤醒</span>
                    <span class="token punctuation">{<!-- --></span>
                        _wait_num<span class="token operator">++</span><span class="token punctuation">;</span>
                        _cond<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span>_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 没任务时: 线程在条件变量上阻塞等待</span>
                        _wait_num<span class="token operator">--</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">// 2. 任务队列不为空 &amp;&amp; 线程池退出</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IsEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>_isrunning<span class="token punctuation">)</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>

                    task <span class="token operator">=</span> _taskq<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    _taskq<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// 3. 处理任务: 并发处理, 不需要持有锁</span>
                <span class="token function">task</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">LOG</span><span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"线程: "</span> <span class="token operator">&lt;&lt;</span> name <span class="token operator">&lt;&lt;</span> <span class="token string">", 退出"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">ThreadPool</span><span class="token punctuation">(</span><span class="token keyword">int</span> num <span class="token operator">=</span> defaultnum<span class="token punctuation">)</span>
            <span class="token operator">:</span> <span class="token function">_num</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_wait_num</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_isrunning</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> _num<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 在类中: bind类的公有方法, 需要取地址 + 传入this指针</span>
                <span class="token comment">// 在类外: bind类的公有方法, 需要取地址 + 传入类的匿名对象</span>
                _threads<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>Thread<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ThreadPool<span class="token double-colon punctuation">::</span>HandlerTask<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>placeholders<span class="token double-colon punctuation">::</span>_1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// push_back()会调用移动构造</span>
                <span class="token function">LOG</span><span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"构建线程"</span> <span class="token operator">&lt;&lt;</span> _threads<span class="token punctuation">.</span><span class="token function">back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"对象...成功"</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token operator">~</span><span class="token function">ThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

        <span class="token keyword">void</span> <span class="token function">Equeue</span><span class="token punctuation">(</span><span class="token keyword">const</span> T <span class="token operator">&amp;</span>in<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            LockGuard <span class="token function">lockguard</span><span class="token punctuation">(</span>_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_isrunning<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
            _taskq<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_wait_num <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                _cond<span class="token punctuation">.</span><span class="token function">Signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 唤醒线程</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">void</span> <span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_isrunning<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
            _isrunning <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> <span class="token operator">&amp;</span>thread_ptr <span class="token operator">:</span> _threads<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                thread_ptr<span class="token operator">-&gt;</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">LOG</span><span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"启动线程"</span> <span class="token operator">&lt;&lt;</span> thread_ptr<span class="token operator">-&gt;</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"...成功"</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">void</span> <span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            LockGuard <span class="token function">lockguard</span><span class="token punctuation">(</span>_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_isrunning<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 1. 不能再新增任务了</span>
                _isrunning <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

                <span class="token comment">// 2. 让线程自己退出(唤醒所有的线程) &amp;&amp; 历史任务被执行完</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>_wait_num <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    _cond<span class="token punctuation">.</span><span class="token function">Broadcast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">void</span> <span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> <span class="token operator">&amp;</span>thread_ptr <span class="token operator">:</span> _threads<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                thread_ptr<span class="token operator">-&gt;</span><span class="token function">Join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">LOG</span><span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"回收线程"</span> <span class="token operator">&lt;&lt;</span> thread_ptr<span class="token operator">-&gt;</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"...成功"</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

    <span class="token keyword">private</span><span class="token operator">:</span>
        <span class="token keyword">int</span> _num<span class="token punctuation">;</span>                       <span class="token comment">// 线程的个数</span>
        std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>thread_t<span class="token operator">&gt;</span> _threads<span class="token punctuation">;</span> <span class="token comment">// 线程池</span>
        std<span class="token double-colon punctuation">::</span>queue<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> _taskq<span class="token punctuation">;</span>           <span class="token comment">// 共享资源: 任务队列</span>
        <span class="token keyword">int</span> _wait_num<span class="token punctuation">;</span>                  <span class="token comment">// 等待的线程数目</span>
        <span class="token keyword">bool</span> _isrunning<span class="token punctuation">;</span>                <span class="token comment">// 线程池是否运行</span>

        Mutex _mutex<span class="token punctuation">;</span> <span class="token comment">// 锁</span>
        Cond _cond<span class="token punctuation">;</span>   <span class="token comment">// 条件变量</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="4ThreadPoolcc_593">
     </a>
     4.ThreadPool.cc
    </h4>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;memory&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"ThreadPool.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Task.hpp"</span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> ThreadPoolModule<span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">ENABLE_CONSOLE_LOG</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    tasks<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>MySql<span class="token punctuation">)</span><span class="token punctuation">;</span>
    tasks<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>UpLoad<span class="token punctuation">)</span><span class="token punctuation">;</span>
    tasks<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>DownLoad<span class="token punctuation">)</span><span class="token punctuation">;</span>

    std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>ThreadPool<span class="token operator">&lt;</span>task_t<span class="token operator">&gt;&gt;</span> tp <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>ThreadPool<span class="token operator">&lt;</span>task_t<span class="token operator">&gt;&gt;</span></span></span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    tp<span class="token operator">-&gt;</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>cnt <span class="token operator">&lt;</span> <span class="token number">6</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        tp<span class="token operator">-&gt;</span><span class="token function">Equeue</span><span class="token punctuation">(</span>tasks<span class="token punctuation">[</span>cnt <span class="token operator">%</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cnt<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    tp<span class="token operator">-&gt;</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    tp<span class="token operator">-&gt;</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <pre><code class="prism language-bash">xzy@hcss-ecs-b3aa:~$ ./thread_pool 
<span class="token punctuation">[</span><span class="token number">2025</span>-03-11 <span class="token number">17</span>:32:01<span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1030242</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>ThreadPool.hpp<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">67</span><span class="token punctuation">]</span> - 构建线程Thread-1对象<span class="token punctuation">..</span>.成功
<span class="token punctuation">[</span><span class="token number">2025</span>-03-11 <span class="token number">17</span>:32:01<span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1030242</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>ThreadPool.hpp<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">67</span><span class="token punctuation">]</span> - 构建线程Thread-2对象<span class="token punctuation">..</span>.成功
<span class="token punctuation">[</span><span class="token number">2025</span>-03-11 <span class="token number">17</span>:32:01<span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1030242</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>ThreadPool.hpp<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">67</span><span class="token punctuation">]</span> - 构建线程Thread-3对象<span class="token punctuation">..</span>.成功
<span class="token punctuation">[</span><span class="token number">2025</span>-03-11 <span class="token number">17</span>:32:01<span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1030242</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>ThreadPool.hpp<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">91</span><span class="token punctuation">]</span> - 启动线程Thread-1<span class="token punctuation">..</span>.成功
<span class="token punctuation">[</span><span class="token number">2025</span>-03-11 <span class="token number">17</span>:32:01<span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1030242</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>ThreadPool.hpp<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">91</span><span class="token punctuation">]</span> - 启动线程Thread-2<span class="token punctuation">..</span>.成功
<span class="token punctuation">[</span><span class="token number">2025</span>-03-11 <span class="token number">17</span>:32:01<span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1030242</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>ThreadPool.hpp<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">91</span><span class="token punctuation">]</span> - 启动线程Thread-3<span class="token punctuation">..</span>.成功
<span class="token punctuation">[</span><span class="token number">2025</span>-03-11 <span class="token number">17</span>:32:01<span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1030242</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>ThreadPool.hpp<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">]</span> - 线程: Thread-1, 进入HandlerTask执行逻辑
<span class="token punctuation">[</span><span class="token number">2025</span>-03-11 <span class="token number">17</span>:32:01<span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1030242</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>ThreadPool.hpp<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">]</span> - 线程: Thread-2, 进入HandlerTask执行逻辑
<span class="token punctuation">[</span><span class="token number">2025</span>-03-11 <span class="token number">17</span>:32:01<span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1030242</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>ThreadPool.hpp<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">]</span> - 线程: Thread-3, 进入HandlerTask执行逻辑
<span class="token punctuation">[</span><span class="token number">2025</span>-03-11 <span class="token number">17</span>:32:01<span class="token punctuation">]</span> <span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1030242</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>Task.hpp<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span> - 我是一个数据任务, 我正在被执行<span class="token punctuation">[</span>Thread-1<span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token number">2025</span>-03-11 <span class="token number">17</span>:32:02<span class="token punctuation">]</span> <span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1030242</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>Task.hpp<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">17</span><span class="token punctuation">]</span> - 我是一个上传任务, 我正在被执行<span class="token punctuation">[</span>Thread-2<span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token number">2025</span>-03-11 <span class="token number">17</span>:32:03<span class="token punctuation">]</span> <span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1030242</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>Task.hpp<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">22</span><span class="token punctuation">]</span> - 我是一个下载任务, 我正在被执行<span class="token punctuation">[</span>Thread-3<span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token number">2025</span>-03-11 <span class="token number">17</span>:32:04<span class="token punctuation">]</span> <span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1030242</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>Task.hpp<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span> - 我是一个数据任务, 我正在被执行<span class="token punctuation">[</span>Thread-1<span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token number">2025</span>-03-11 <span class="token number">17</span>:32:05<span class="token punctuation">]</span> <span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1030242</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>Task.hpp<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">17</span><span class="token punctuation">]</span> - 我是一个上传任务, 我正在被执行<span class="token punctuation">[</span>Thread-2<span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token number">2025</span>-03-11 <span class="token number">17</span>:32:06<span class="token punctuation">]</span> <span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1030242</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>Task.hpp<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">22</span><span class="token punctuation">]</span> - 我是一个下载任务, 我正在被执行<span class="token punctuation">[</span>Thread-3<span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token number">2025</span>-03-11 <span class="token number">17</span>:32:07<span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1030242</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>ThreadPool.hpp<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">55</span><span class="token punctuation">]</span> - 线程: Thread-2, 退出
<span class="token punctuation">[</span><span class="token number">2025</span>-03-11 <span class="token number">17</span>:32:07<span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1030242</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>ThreadPool.hpp<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">55</span><span class="token punctuation">]</span> - 线程: Thread-3, 退出
<span class="token punctuation">[</span><span class="token number">2025</span>-03-11 <span class="token number">17</span>:32:07<span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1030242</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>ThreadPool.hpp<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">55</span><span class="token punctuation">]</span> - 线程: Thread-1, 退出
<span class="token punctuation">[</span><span class="token number">2025</span>-03-11 <span class="token number">17</span>:32:10<span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1030242</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>ThreadPool.hpp<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">116</span><span class="token punctuation">]</span> - 回收线程Thread-1<span class="token punctuation">..</span>.成功
<span class="token punctuation">[</span><span class="token number">2025</span>-03-11 <span class="token number">17</span>:32:10<span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1030242</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>ThreadPool.hpp<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">116</span><span class="token punctuation">]</span> - 回收线程Thread-2<span class="token punctuation">..</span>.成功
<span class="token punctuation">[</span><span class="token number">2025</span>-03-11 <span class="token number">17</span>:32:10<span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1030242</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>ThreadPool.hpp<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">116</span><span class="token punctuation">]</span> - 回收线程Thread-3<span class="token punctuation">..</span>.成功
</code></pre>
    <h2>
     <a id="_657">
     </a>
     二.线程安全与重入问题
    </h2>
    <ul>
     <li>
      线程安全：就是多个线程在访问共享资源时，能够正确地执行，不会相互干扰或破坏彼此的执行结果。一般而言，多个线程并发同一段只有局部变量的代码时，不会出现不同的结果。但是对全局变量或者静态变量进行操作，并且没有锁保护的情况下，容易出现该问题。
     </li>
     <li>
      重入：同一个函数被不同的执行流调用，当前一个流程还没有执行完，就有其他的执行流再次进入，我们称之为重入。一个函数在重入的情况下，运行结果不会出现任何不同或者任何问题，则该函数被称为可重入函数，否则，是不可入函数。
     </li>
    </ul>
    <p>
     重入的两种情况：
    </p>
    <ul>
     <li>
      多线程重入函数。
     </li>
     <li>
      信号导致一个执行流重复进入函数。
     </li>
    </ul>
    <p>
     注意：在多进程中，可能会发生重入，但是访问共享资源会发生写时拷贝，不会出现问题！
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/75036e22a79e4c8f8d876475cb8c1a12.png"/>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/026c6ac70abb4dd9a11834546fcdf4a7.png">
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/93c345e8cbc24767a1f9ee760a8bd741.png">
       <br/>
       <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/e5d69c725cdc4ed59a4ba0cb0ea939ce.png"/>
      </img>
     </img>
    </p>
    <h2>
     <a id="_675">
     </a>
     三.线程安全的单例模式
    </h2>
    <ul>
     <li>
      单例模式：只能创建一个对象！
     </li>
     <li>
      在很多服务器开发场景中，经常需要让服务器加载很多的数据(上百G)到内存中。此时往往要用一个单例的类来管理这些数据。
     </li>
    </ul>
    <h3>
     <a id="1_678">
     </a>
     1.饿汉模式
    </h3>
    <ul>
     <li>
      初始化时机：在程序启动时，类被加载到内存后就立即初始化单例对象，无论后续是否会使用到该对象。
     </li>
     <li>
      线程安全性：由于是在程序启动时就完成初始化，在多线程环境下，不存在多个线程同时创建单例对象的问题，所以通常是线程安全的。
     </li>
    </ul>
    <pre><code class="prism language-cpp"><span class="token comment">// 饿汉模式存在问题</span>
<span class="token comment">// 1. 多个饿汉模式的单例，某个对象初始化内容较多(读文件)，会导致程序启动慢</span>
<span class="token comment">// 2. A和B两个饿汉，对象初始化存在依赖关系，要求A先初始化，B再初始化，无法保证</span>
<span class="token keyword">class</span> <span class="token class-name">InfoMar</span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
	<span class="token keyword">static</span> InfoMar<span class="token operator">*</span> <span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token operator">&amp;</span>_ins<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
	<span class="token function">InfoMar</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		cout <span class="token operator">&lt;&lt;</span> <span class="token string">"ip:"</span> <span class="token operator">&lt;&lt;</span> _ip <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
		cout <span class="token operator">&lt;&lt;</span> <span class="token string">"port: "</span> <span class="token operator">&lt;&lt;</span> _port <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 禁用: 拷贝构造和拷贝赋值</span>
	<span class="token function">InfoMar</span><span class="token punctuation">(</span><span class="token keyword">const</span> InfoMar<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>
	InfoMar<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> InfoMar<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>

<span class="token keyword">private</span><span class="token operator">:</span>
	string _ip <span class="token operator">=</span> <span class="token string">"127.0.0.1"</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> _port <span class="token operator">=</span> <span class="token number">8080</span><span class="token punctuation">;</span>
	
	<span class="token comment">// 静态对象与普通对象不同: 不在类中, 而是在静态区, 类域的限制</span>
	<span class="token keyword">static</span> InfoMar _ins<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 静态成员: 类内声明, 类外定义</span>
InfoMar InfoMar<span class="token double-colon punctuation">::</span>_ins<span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 程序运行在该行: 静态对象就被创建好了</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="2_725">
     </a>
     2.懒汉模式
    </h3>
    <ul>
     <li>
      初始化时机：单例对象在第一次被使用时才进行初始化，在未被使用之前，不会创建对象。
     </li>
     <li>
      线程安全性：如果不做额外的线程安全处理，在多线程环境下，当多个线程同时访问获取单例对象的方法，且此时单例对象尚未初始化时，就可能会导致多个线程同时创建单例对象，破坏单例模式的唯一性。因此，懒汉模式需要通过加锁等机制来保证线程安全。
     </li>
    </ul>
    <pre><code class="prism language-cpp"><span class="token comment">// 懒汉模式: 解决饿汉模式的两个问题</span>
<span class="token keyword">class</span> <span class="token class-name">InfoMar</span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
	<span class="token keyword">static</span> InfoMar<span class="token operator">*</span> <span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 若单例为空: 需要加锁创建单例对象</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>_pins <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
			<span class="token keyword">if</span> <span class="token punctuation">(</span>_pins <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				_pins <span class="token operator">=</span> <span class="token keyword">new</span> InfoMar<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// 若单例不为空: 直接返回单例对象</span>
		<span class="token keyword">return</span> _pins<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">DelInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">delete</span> _pins<span class="token punctuation">;</span>
		_pins <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
	<span class="token function">InfoMar</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		cout <span class="token operator">&lt;&lt;</span> <span class="token string">"ip:"</span> <span class="token operator">&lt;&lt;</span> _ip <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
		cout <span class="token operator">&lt;&lt;</span> <span class="token string">"port: "</span> <span class="token operator">&lt;&lt;</span> _port <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 禁用: 拷贝构造和拷贝赋值</span>
	<span class="token function">InfoMar</span><span class="token punctuation">(</span><span class="token keyword">const</span> InfoMar<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>
	InfoMar<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> InfoMar<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>

<span class="token keyword">private</span><span class="token operator">:</span>
	string _ip <span class="token operator">=</span> <span class="token string">"127.0.0.1"</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> _port <span class="token operator">=</span> <span class="token number">8080</span><span class="token punctuation">;</span>

	<span class="token keyword">static</span> InfoMar<span class="token operator">*</span> _pins<span class="token punctuation">;</span> <span class="token comment">// 单例对象</span>
	<span class="token keyword">static</span> Mutex mutex<span class="token punctuation">;</span>    <span class="token comment">// 保护单例对象</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

InfoMar<span class="token operator">*</span> InfoMar<span class="token double-colon punctuation">::</span>_pins <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
Mutex InfoMar<span class="token double-colon punctuation">::</span>mutex<span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token class-name">InfoMar</span><span class="token double-colon punctuation">::</span><span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="3_787">
     </a>
     3.懒汉模式线程池
    </h3>
    <h4>
     <a id="1ThreadPoolhpp_788">
     </a>
     1.ThreadPool.hpp
    </h4>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">once</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;vector&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;queue&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;memory&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Mutex.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Cond.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Thread.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Log.hpp"</span></span>

<span class="token keyword">namespace</span> ThreadPoolModule
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">using</span> <span class="token keyword">namespace</span> MutexModule<span class="token punctuation">;</span>
    <span class="token keyword">using</span> <span class="token keyword">namespace</span> CondModule<span class="token punctuation">;</span>
    <span class="token keyword">using</span> <span class="token keyword">namespace</span> ThreadModule<span class="token punctuation">;</span>
    <span class="token keyword">using</span> <span class="token keyword">namespace</span> LogModule<span class="token punctuation">;</span>

    <span class="token keyword">using</span> thread_t <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>Thread<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">static</span> <span class="token keyword">int</span> defaultnum <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>

    <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
    <span class="token keyword">class</span> <span class="token class-name">ThreadPool</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span><span class="token operator">:</span>
        <span class="token keyword">bool</span> <span class="token function">IsEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> _taskq<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

        <span class="token keyword">void</span> <span class="token function">HandlerTask</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>string name<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">LOG</span><span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"线程: "</span> <span class="token operator">&lt;&lt;</span> name <span class="token operator">&lt;&lt;</span> <span class="token string">", 进入HandlerTask执行逻辑"</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 1. 拿任务: 访问共享资源, 需要加锁</span>
                T task<span class="token punctuation">;</span>
                <span class="token punctuation">{<!-- --></span>
                    LockGuard <span class="token function">lockguard</span><span class="token punctuation">(</span>_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">IsEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> _isrunning<span class="token punctuation">)</span> <span class="token comment">// while替代if: 防止伪唤醒</span>
                    <span class="token punctuation">{<!-- --></span>
                        _wait_num<span class="token operator">++</span><span class="token punctuation">;</span>
                        _cond<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span>_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 没任务时: 线程在条件变量上阻塞等待</span>
                        _wait_num<span class="token operator">--</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">// 2. 任务队列不为空 &amp;&amp; 线程池退出</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IsEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>_isrunning<span class="token punctuation">)</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>

                    task <span class="token operator">=</span> _taskq<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    _taskq<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// 3. 处理任务: 并发处理, 不需要持有锁</span>
                <span class="token function">task</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">LOG</span><span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"线程: "</span> <span class="token operator">&lt;&lt;</span> name <span class="token operator">&lt;&lt;</span> <span class="token string">", 退出"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">ThreadPool</span><span class="token punctuation">(</span><span class="token keyword">int</span> num <span class="token operator">=</span> defaultnum<span class="token punctuation">)</span>
            <span class="token operator">:</span> <span class="token function">_num</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_wait_num</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_isrunning</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> _num<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 在类中: bind类的公有方法, 需要取地址 + 传入this指针</span>
                <span class="token comment">// 在类外: bind类的公有方法, 需要取地址 + 传入类的匿名对象</span>
                _threads<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>Thread<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ThreadPool<span class="token double-colon punctuation">::</span>HandlerTask<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>placeholders<span class="token double-colon punctuation">::</span>_1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// push_back()会调用移动构造</span>
                <span class="token function">LOG</span><span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"构建线程"</span> <span class="token operator">&lt;&lt;</span> _threads<span class="token punctuation">.</span><span class="token function">back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"对象...成功"</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token generic-function"><span class="token function">ThreadPool</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">const</span> ThreadPool<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>
        ThreadPool<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token operator">&amp;</span><span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> ThreadPool<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token operator">~</span><span class="token function">ThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

        <span class="token comment">// 获取单例对象</span>
        <span class="token keyword">static</span> ThreadPool<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token operator">*</span><span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 若单例为空: 需要加锁创建单例对象</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>instance <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                LockGuard <span class="token function">lockguard</span><span class="token punctuation">(</span>_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>instance <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token function">LOG</span><span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"单例首次被执行, 需要加载对象..."</span><span class="token punctuation">;</span>
                    instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token generic-function"><span class="token function">ThreadPool</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 若单例不为空: 直接返回单例对象</span>
            <span class="token keyword">return</span> instance<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">void</span> <span class="token function">Equeue</span><span class="token punctuation">(</span><span class="token keyword">const</span> T <span class="token operator">&amp;</span>in<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            LockGuard <span class="token function">lockguard</span><span class="token punctuation">(</span>_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_isrunning<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
            _taskq<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_wait_num <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                _cond<span class="token punctuation">.</span><span class="token function">Signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 唤醒线程</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">void</span> <span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_isrunning<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
            _isrunning <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> <span class="token operator">&amp;</span>thread_ptr <span class="token operator">:</span> _threads<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                thread_ptr<span class="token operator">-&gt;</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">LOG</span><span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"启动线程"</span> <span class="token operator">&lt;&lt;</span> thread_ptr<span class="token operator">-&gt;</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"...成功"</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">void</span> <span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            LockGuard <span class="token function">lockguard</span><span class="token punctuation">(</span>_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_isrunning<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 1. 不能再新增任务了</span>
                _isrunning <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

                <span class="token comment">// 2. 让线程自己退出(唤醒所有的线程) &amp;&amp; 历史任务被执行完</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>_wait_num <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    _cond<span class="token punctuation">.</span><span class="token function">Broadcast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">void</span> <span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> <span class="token operator">&amp;</span>thread_ptr <span class="token operator">:</span> _threads<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                thread_ptr<span class="token operator">-&gt;</span><span class="token function">Join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">LOG</span><span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"回收线程"</span> <span class="token operator">&lt;&lt;</span> thread_ptr<span class="token operator">-&gt;</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"...成功"</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

    <span class="token keyword">private</span><span class="token operator">:</span>
        <span class="token keyword">int</span> _num<span class="token punctuation">;</span>                       <span class="token comment">// 线程的个数</span>
        std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>thread_t<span class="token operator">&gt;</span> _threads<span class="token punctuation">;</span> <span class="token comment">// 线程池</span>
        std<span class="token double-colon punctuation">::</span>queue<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> _taskq<span class="token punctuation">;</span>           <span class="token comment">// 共享资源: 任务队列</span>
        <span class="token keyword">int</span> _wait_num<span class="token punctuation">;</span>                  <span class="token comment">// 等待的线程数目</span>
        <span class="token keyword">bool</span> _isrunning<span class="token punctuation">;</span>                <span class="token comment">// 线程池是否运行</span>

        Mutex _mutex<span class="token punctuation">;</span> <span class="token comment">// 锁</span>
        Cond _cond<span class="token punctuation">;</span>   <span class="token comment">// 条件变量</span>

        <span class="token keyword">static</span> ThreadPool<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token operator">*</span>instance<span class="token punctuation">;</span> <span class="token comment">// 单例对象</span>
        <span class="token keyword">static</span> Mutex _lock<span class="token punctuation">;</span>             <span class="token comment">// 用来保护单例</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// 静态成员: 类内声明, 类外定义</span>
    <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
    ThreadPool<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token operator">*</span>ThreadPool<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span>instance <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    
    <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
    Mutex ThreadPool<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span>_lock<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="2ThreadPoolcc_953">
     </a>
     2.ThreadPool.cc
    </h4>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;memory&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"ThreadPool.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Task.hpp"</span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> ThreadPoolModule<span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">ENABLE_CONSOLE_LOG</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    tasks<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>MySql<span class="token punctuation">)</span><span class="token punctuation">;</span>
    tasks<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>UpLoad<span class="token punctuation">)</span><span class="token punctuation">;</span>
    tasks<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>DownLoad<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">ThreadPool</span><span class="token operator">&lt;</span>task_t<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>cnt <span class="token operator">&lt;</span> <span class="token number">6</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ThreadPool</span><span class="token operator">&lt;</span>task_t<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">Equeue</span><span class="token punctuation">(</span>tasks<span class="token punctuation">[</span>cnt <span class="token operator">%</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cnt<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">ThreadPool</span><span class="token operator">&lt;</span>task_t<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">ThreadPool</span><span class="token operator">&lt;</span>task_t<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <pre><code class="prism language-bash">xzy@hcss-ecs-b3aa:~$ ./thread_pool 
<span class="token punctuation">[</span><span class="token number">2025</span>-03-12 <span class="token number">20</span>:46:40<span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1077712</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>ThreadPool.hpp<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">85</span><span class="token punctuation">]</span> - 单例首次被执行, 需要加载对象<span class="token punctuation">..</span>.
<span class="token punctuation">[</span><span class="token number">2025</span>-03-12 <span class="token number">20</span>:46:40<span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1077712</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>ThreadPool.hpp<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">66</span><span class="token punctuation">]</span> - 构建线程Thread-1对象<span class="token punctuation">..</span>.成功
<span class="token punctuation">[</span><span class="token number">2025</span>-03-12 <span class="token number">20</span>:46:40<span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1077712</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>ThreadPool.hpp<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">66</span><span class="token punctuation">]</span> - 构建线程Thread-2对象<span class="token punctuation">..</span>.成功
<span class="token punctuation">[</span><span class="token number">2025</span>-03-12 <span class="token number">20</span>:46:40<span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1077712</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>ThreadPool.hpp<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">66</span><span class="token punctuation">]</span> - 构建线程Thread-3对象<span class="token punctuation">..</span>.成功
<span class="token punctuation">[</span><span class="token number">2025</span>-03-12 <span class="token number">20</span>:46:40<span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1077712</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>ThreadPool.hpp<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">111</span><span class="token punctuation">]</span> - 启动线程Thread-1<span class="token punctuation">..</span>.成功
<span class="token punctuation">[</span><span class="token number">2025</span>-03-12 <span class="token number">20</span>:46:40<span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1077712</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>ThreadPool.hpp<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">111</span><span class="token punctuation">]</span> - 启动线程Thread-2<span class="token punctuation">..</span>.成功
<span class="token punctuation">[</span><span class="token number">2025</span>-03-12 <span class="token number">20</span>:46:40<span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1077712</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>ThreadPool.hpp<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">111</span><span class="token punctuation">]</span> - 启动线程Thread-3<span class="token punctuation">..</span>.成功
<span class="token punctuation">[</span><span class="token number">2025</span>-03-12 <span class="token number">20</span>:46:40<span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1077712</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>ThreadPool.hpp<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">]</span> - 线程: Thread-3, 进入HandlerTask执行逻辑
<span class="token punctuation">[</span><span class="token number">2025</span>-03-12 <span class="token number">20</span>:46:40<span class="token punctuation">]</span> <span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1077712</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>Task.hpp<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span> - 我是一个数据任务, 我正在被执行<span class="token punctuation">[</span>Thread-3<span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token number">2025</span>-03-12 <span class="token number">20</span>:46:40<span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1077712</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>ThreadPool.hpp<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">]</span> - 线程: Thread-2, 进入HandlerTask执行逻辑
<span class="token punctuation">[</span><span class="token number">2025</span>-03-12 <span class="token number">20</span>:46:40<span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1077712</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>ThreadPool.hpp<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">]</span> - 线程: Thread-1, 进入HandlerTask执行逻辑
<span class="token punctuation">[</span><span class="token number">2025</span>-03-12 <span class="token number">20</span>:46:41<span class="token punctuation">]</span> <span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1077712</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>Task.hpp<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">17</span><span class="token punctuation">]</span> - 我是一个上传任务, 我正在被执行<span class="token punctuation">[</span>Thread-3<span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token number">2025</span>-03-12 <span class="token number">20</span>:46:42<span class="token punctuation">]</span> <span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1077712</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>Task.hpp<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">22</span><span class="token punctuation">]</span> - 我是一个下载任务, 我正在被执行<span class="token punctuation">[</span>Thread-2<span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token number">2025</span>-03-12 <span class="token number">20</span>:46:43<span class="token punctuation">]</span> <span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1077712</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>Task.hpp<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span> - 我是一个数据任务, 我正在被执行<span class="token punctuation">[</span>Thread-1<span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token number">2025</span>-03-12 <span class="token number">20</span>:46:44<span class="token punctuation">]</span> <span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1077712</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>Task.hpp<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">17</span><span class="token punctuation">]</span> - 我是一个上传任务, 我正在被执行<span class="token punctuation">[</span>Thread-3<span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token number">2025</span>-03-12 <span class="token number">20</span>:46:45<span class="token punctuation">]</span> <span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1077712</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>Task.hpp<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">22</span><span class="token punctuation">]</span> - 我是一个下载任务, 我正在被执行<span class="token punctuation">[</span>Thread-2<span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token number">2025</span>-03-12 <span class="token number">20</span>:46:46<span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1077712</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>ThreadPool.hpp<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">55</span><span class="token punctuation">]</span> - 线程: Thread-1, 退出
<span class="token punctuation">[</span><span class="token number">2025</span>-03-12 <span class="token number">20</span>:46:46<span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1077712</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>ThreadPool.hpp<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">55</span><span class="token punctuation">]</span> - 线程: Thread-3, 退出
<span class="token punctuation">[</span><span class="token number">2025</span>-03-12 <span class="token number">20</span>:46:46<span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1077712</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>ThreadPool.hpp<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">55</span><span class="token punctuation">]</span> - 线程: Thread-2, 退出
<span class="token punctuation">[</span><span class="token number">2025</span>-03-12 <span class="token number">20</span>:46:49<span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1077712</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>ThreadPool.hpp<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">136</span><span class="token punctuation">]</span> - 回收线程Thread-1<span class="token punctuation">..</span>.成功
<span class="token punctuation">[</span><span class="token number">2025</span>-03-12 <span class="token number">20</span>:46:49<span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1077712</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>ThreadPool.hpp<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">136</span><span class="token punctuation">]</span> - 回收线程Thread-2<span class="token punctuation">..</span>.成功
<span class="token punctuation">[</span><span class="token number">2025</span>-03-12 <span class="token number">20</span>:46:49<span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1077712</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>ThreadPool.hpp<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">136</span><span class="token punctuation">]</span> - 回收线程Thread-3<span class="token punctuation">..</span>.成功
</code></pre>
    <h2>
     <a id="_1018">
     </a>
     四.死锁的概念
    </h2>
    <h3>
     <a id="1_1020">
     </a>
     1.死锁
    </h3>
    <ul>
     <li>
      死锁是指在一组进程中的各个进程均占有不会释放的资源，但因互相申请被其他进程所站用不会释放的资源而处于的一种永久等待状态。
     </li>
     <li>
      为了发便表述，假设现在线程A，线程B必须同时持有锁1和锁2，才能进行后续资源的访问。
     </li>
    </ul>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/d4096804da744dfa9bf66c0a2987a039.png"/>
    </p>
    <p>
     申请一把锁是原子的，但是申请两把锁就不一定了：
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/f65d070015204708b49d3587ba12e5f6.png"/>
    </p>
    <p>
     造成的结果是：
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/98867a1249a54913bb6dc387edc485bf.png"/>
    </p>
    <h3>
     <a id="2_1035">
     </a>
     2.死锁的四个必要条件
    </h3>
    <ul>
     <li>
      互斥条件：一个资源每次只能被一个执行流使用。
     </li>
     <li>
      请求与保持条件：一个执行流因请求资源而阻塞时，对已获得的资源保持不放。
     </li>
    </ul>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/25ee162a76e641a790f6c61322747e88.png"/>
    </p>
    <ul>
     <li>
      不剥夺条件：一个执行流已获得的资源，在末使用完之前，不能强行剥夺。
     </li>
    </ul>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/ae916c88f95d44558f7edfc7a567b05c.png"/>
    </p>
    <ul>
     <li>
      循环等待条件：若干执行流之间形成一种头尾相接的循环等待资源的关系。
     </li>
    </ul>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/94cbe576b7a6419b9dbb605a5c1ba6bf.png"/>
    </p>
    <h3>
     <a id="3_1050">
     </a>
     3.避免死锁
    </h3>
    <p>
     破坏死锁的四个必要条件
     <br/>
     ◦ 破坏循环等待条件问题：资源⼀次性分配，使⽤超时机制、加锁顺序⼀致
    </p>
    <h2>
     <a id="STL_1055">
     </a>
     五.STL、智能指针和线程安全？
    </h2>
    <ul>
     <li>
      STL 的设计初衷是将性能挖掘到极致，而一旦涉及到加锁保证线程安全，会对性能造成巨大的影响。而且对于不同的容器，加锁方式的不同，性能可能也不同(例如hash表的锁表和锁桶)，因此 STL 默认不是线程安全。如果需要在多线程环境下使用，往往需要调用者自行保证线程安全。
     </li>
    </ul>
    <p>
     智能指针是否是线程安全的：
    </p>
    <ul>
     <li>
      对于 unique_ptr，不支持拷贝，只支持移动，所以它不会在多个线程之间共享，也就不存在多个线程同时访问导致数据竞争等线程安全问题。
     </li>
     <li>
      对于 shared_ptr，多个对象需要共用一个引用计数变量，所以会存在线程安全问题。但是标准库实现的时候考虑到了这个问题，基于原子操作(CAS)的方式保证 shared_ptr 能够高效，原子的操作引用计数。
     </li>
     <li>
      注意：这里的线程安全是指智能指针的接口是线程安全的，但是智能指针指向的对象未必是线程安全的！
     </li>
    </ul>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f:672e6373646e2e6e65742f323230335f37363030333632362f:61727469636c652f64657461696c732f313436313038393334" class_="artid" style="display:none">
 </p>
</div>


