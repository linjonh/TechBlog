---
layout: post
title: "python-在进程中动态加载模块"
date: 2025-03-09 00:26:17 +0800
description: "在web 运维平台， 我们有时候希望创建部署一个运维脚本， 此时，传统方式： 新建脚本 》部署脚本》重启服务很多时刻我们不想重启服务， 那么有没有不重启服务依旧可以加载新建的脚本呢？"
keywords: "python 在进程中动态加载模块"
categories: ['未分类']
tags: ['Python']
artid: "146125614"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146125614
    alt: "python-在进程中动态加载模块"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146125614
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146125614
cover: https://bing.ee123.net/img/rand?artid=146125614
image: https://bing.ee123.net/img/rand?artid=146125614
img: https://bing.ee123.net/img/rand?artid=146125614
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     python 在进程中动态加载模块
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="_0">
     </a>
     背景
    </h2>
    <blockquote>
     <p>
      在web 运维平台， 我们有时候希望创建部署一个运维脚本， 此时，传统方式： 新建脚本 》部署脚本》重启服务
      <br/>
      很多时刻我们不想重启服务， 那么有没有不重启服务依旧可以加载新建的脚本呢？ 接下来就是解决方案：
     </p>
    </blockquote>
    <h3>
     <a id="_5">
     </a>
     原理
    </h3>
    <ol>
     <li>
      获取脚本code
     </li>
     <li>
      通过compile 加载code 到进程中
     </li>
     <li>
      通过python 的反射机制获取脚本中的方法并执行
     </li>
    </ol>
    <h3>
     <a id="_11">
     </a>
     结构
    </h3>
    <ul>
     <li>
      base_handler.py – 通过反射获取function
     </li>
     <li>
      schedul.py – 加载code 并调度
     </li>
     <li>
      tese.py – 测试脚本
     </li>
    </ul>
    <p>
     <strong>
      base_handler.py
     </strong>
    </p>
    <pre><code class="prism language-python"><span class="token keyword">import</span> inspect
<span class="token keyword">import</span> sys


<span class="token keyword">class</span> <span class="token class-name">BaseHandler</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    所有脚本的基类BaseHandler
    """</span>

    <span class="token comment"># 继承类必须实现的方法</span>
    callbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'execute'</span><span class="token punctuation">,</span> <span class="token string">'callback'</span><span class="token punctuation">]</span>

    <span class="token decorator annotation punctuation">@classmethod</span>
    <span class="token keyword">def</span> <span class="token function">_run_func</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> function<span class="token punctuation">,</span> <span class="token operator">*</span>arguments<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        执行指定函数
        """</span>
        args<span class="token punctuation">,</span> varargs<span class="token punctuation">,</span> keywords<span class="token punctuation">,</span> defaults <span class="token operator">=</span> inspect<span class="token punctuation">.</span>getargspec<span class="token punctuation">(</span>function<span class="token punctuation">)</span>
        ret <span class="token operator">=</span> function<span class="token punctuation">(</span><span class="token operator">*</span>arguments<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token builtin">len</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> ret

    <span class="token decorator annotation punctuation">@classmethod</span>
    <span class="token keyword">def</span> <span class="token function">_run_task</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> task<span class="token punctuation">,</span> response<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        找对对应函数
        """</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> NotImplementedError<span class="token punctuation">(</span><span class="token string">"self.%s() not implemented!"</span> <span class="token operator">%</span> callback<span class="token punctuation">)</span>

        function <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> callback<span class="token punctuation">)</span>
        <span class="token keyword">return</span> cls<span class="token punctuation">.</span>_run_func<span class="token punctuation">(</span>function<span class="token punctuation">,</span> task<span class="token punctuation">,</span> response<span class="token punctuation">)</span>

    <span class="token decorator annotation punctuation">@classmethod</span>
    <span class="token keyword">def</span> <span class="token function">run_task</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> module<span class="token punctuation">,</span> task<span class="token punctuation">,</span> response<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        舆情脚本运行当前任务,获取异常日志,返回ProcessorResult对象
        """</span>
        exception <span class="token operator">=</span> <span class="token boolean">None</span>
        stdout <span class="token operator">=</span> sys<span class="token punctuation">.</span>stdout
        results <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        sub_tasks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            results<span class="token punctuation">,</span> sub_tasks <span class="token operator">=</span> cls<span class="token punctuation">.</span>_run_task<span class="token punctuation">(</span>task<span class="token punctuation">,</span> response<span class="token punctuation">,</span> callback<span class="token punctuation">)</span>

        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            exception <span class="token operator">=</span> e
        <span class="token keyword">finally</span><span class="token punctuation">:</span>
            sys<span class="token punctuation">.</span>stdout <span class="token operator">=</span> stdout
            <span class="token comment"># logs = list(module.log_buffer)</span>
            <span class="token comment"># module.log_buffer[:] = []</span>
        <span class="token keyword">return</span> results<span class="token punctuation">,</span> sub_tasks
</code></pre>
    <p>
     <strong>
      schedul.py
     </strong>
    </p>
    <pre><code class="prism language-python"><span class="token comment"># coding: utf-8</span>

<span class="token keyword">import</span> imp
<span class="token keyword">import</span> inspect
<span class="token keyword">import</span> linecache
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> six


<span class="token keyword">class</span> <span class="token class-name">ProjectLoader</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    加载并执行字符串类型的python 代码
    project is dict
        示例:
        project = { 'script_name': 'xxx', 'code': code}
    m = ProjectLoader(project)
    """</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> project<span class="token punctuation">,</span> mod<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>project <span class="token operator">=</span> project
        self<span class="token punctuation">.</span>name <span class="token operator">=</span> project<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'script_name'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>mod <span class="token operator">=</span> mod

    <span class="token keyword">def</span> <span class="token function">load_module</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>mod <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>mod <span class="token operator">=</span> mod <span class="token operator">=</span> imp<span class="token punctuation">.</span>new_module<span class="token punctuation">(</span>self<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            mod <span class="token operator">=</span> self<span class="token punctuation">.</span>mod
        mod<span class="token punctuation">.</span>__file__ <span class="token operator">=</span> <span class="token string">'&lt;%s&gt;'</span> <span class="token operator">%</span> self<span class="token punctuation">.</span>name
        mod<span class="token punctuation">.</span>__loader__ <span class="token operator">=</span> self
        mod<span class="token punctuation">.</span>__project__ <span class="token operator">=</span> self<span class="token punctuation">.</span>project
        mod<span class="token punctuation">.</span>__package__ <span class="token operator">=</span> <span class="token string">''</span>
        <span class="token comment"># 获取code</span>
        code <span class="token operator">=</span> self<span class="token punctuation">.</span>get_code<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 执行</span>
        six<span class="token punctuation">.</span>exec_<span class="token punctuation">(</span>code<span class="token punctuation">,</span> mod<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>
        <span class="token comment"># 清除缓存</span>
        linecache<span class="token punctuation">.</span>clearcache<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> sys<span class="token punctuation">.</span>version_info<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            sys<span class="token punctuation">.</span>modules<span class="token punctuation">[</span>self<span class="token punctuation">.</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> mod
        <span class="token keyword">return</span> mod

    <span class="token keyword">def</span> <span class="token function">get_code</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token builtin">compile</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>get_source<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'&lt;%s&gt;'</span> <span class="token operator">%</span> self<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token string">'exec'</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">get_source</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        script <span class="token operator">=</span> self<span class="token punctuation">.</span>project<span class="token punctuation">[</span><span class="token string">'code'</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>script<span class="token punctuation">,</span> six<span class="token punctuation">.</span>text_type<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> script<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> script


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token keyword">from</span> celery_app <span class="token keyword">import</span> base_handler
    
    <span class="token comment"># 这里测试， 我直接从文件中读, 你可以试着通过API 从数据库中获取脚本code</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'test.py'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        code <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># 测试code info</span>
    obj <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">'script_name'</span><span class="token punctuation">:</span> <span class="token string">'test'</span><span class="token punctuation">,</span>
        <span class="token string">'code'</span><span class="token punctuation">:</span> code
    <span class="token punctuation">}</span>
    <span class="token comment"># 加载code 到进程</span>
    instance <span class="token operator">=</span> ProjectLoader<span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
    module <span class="token operator">=</span> instance<span class="token punctuation">.</span>load_module<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># 获取脚本类</span>
    <span class="token keyword">if</span> <span class="token string">'__handler_cls__'</span> <span class="token keyword">not</span> <span class="token keyword">in</span> module<span class="token punctuation">.</span>__dict__<span class="token punctuation">:</span>
        BaseHandler <span class="token operator">=</span> module<span class="token punctuation">.</span>__dict__<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'BaseHandler'</span><span class="token punctuation">,</span>
                                          base_handler<span class="token punctuation">.</span>BaseHandler<span class="token punctuation">)</span>
        <span class="token keyword">for</span> each <span class="token keyword">in</span> <span class="token builtin">list</span><span class="token punctuation">(</span>six<span class="token punctuation">.</span>itervalues<span class="token punctuation">(</span>module<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> inspect<span class="token punctuation">.</span>isclass<span class="token punctuation">(</span>each<span class="token punctuation">)</span> <span class="token keyword">and</span> each <span class="token keyword">is</span> <span class="token keyword">not</span> BaseHandler \
                    <span class="token keyword">and</span> <span class="token builtin">issubclass</span><span class="token punctuation">(</span>each<span class="token punctuation">,</span> BaseHandler<span class="token punctuation">)</span><span class="token punctuation">:</span>
                module<span class="token punctuation">.</span>__dict__<span class="token punctuation">[</span><span class="token string">'__handler_cls__'</span><span class="token punctuation">]</span> <span class="token operator">=</span> each
    instance <span class="token operator">=</span> module<span class="token punctuation">.</span>__dict__<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'__handler_cls__'</span><span class="token punctuation">)</span>
    <span class="token comment"># 把meta 信息放到脚本实例中</span>
    instance<span class="token punctuation">.</span>project_name <span class="token operator">=</span> obj<span class="token punctuation">[</span><span class="token string">'script_name'</span><span class="token punctuation">]</span>
    instance<span class="token punctuation">.</span>project <span class="token operator">=</span> obj
    <span class="token keyword">assert</span> instance <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token string">"need BaseHandler in project module"</span>

    <span class="token comment"># 开始调用脚本中的方法</span>
    instance<span class="token punctuation">.</span>run_task<span class="token punctuation">(</span>module<span class="token punctuation">,</span> <span class="token number">456</span><span class="token punctuation">,</span> <span class="token number">123456</span><span class="token punctuation">,</span> <span class="token string">'callback'</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span>
</code></pre>
    <p>
     <strong>
      test.py
     </strong>
    </p>
    <pre><code class="prism language-python"><span class="token comment"># coding: utf-8</span>

<span class="token keyword">from</span> base_handler <span class="token keyword">import</span> BaseHandler


<span class="token keyword">class</span> <span class="token class-name">TestC</span><span class="token punctuation">(</span>BaseHandler<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>config <span class="token operator">=</span> config

    <span class="token decorator annotation punctuation">@classmethod</span>
    <span class="token keyword">def</span> <span class="token function">execute</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> v<span class="token punctuation">,</span> v2<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> v2<span class="token punctuation">)</span>

    <span class="token decorator annotation punctuation">@classmethod</span>
    <span class="token keyword">def</span> <span class="token function">callback</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> v<span class="token punctuation">,</span> v2<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> v2<span class="token punctuation">)</span>
</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f34343739313633312f:61727469636c652f64657461696c732f313436313235363134" class_="artid" style="display:none">
 </p>
</div>


