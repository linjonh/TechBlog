---
arturl_encode: "68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f34303534383138322f:61727469636c652f64657461696c732f313436323535323939"
layout: post
title: "rsync-å¤‡ä»½-clickhouse"
date: 2025-03-14 13:33:33 +08:00
description: "å¤‡ä»½å®Œæˆåï¼Œå¦‚æœæƒ³ç”¨è¿™ä¸ªå¤‡ä»½æ•°æ®ç›´æ¥å¯åŠ¨æ–°çš„ clickhouse éœ€è¦åˆ é™¤ store ç›®å½•ä¸‹çš„ç©ºç›®å½•ï¼ˆå› ä¸ºåœ¨å¤‡ä»½è¿‡ç¨‹ä¸­æº clickhouse å¦‚æœæ˜¯å¯åŠ¨çŠ¶æ€å°±ä¼šæœ‰ç©ºç›®å½•è¢«å¤‡ä»½ï¼‰ClickHouse çš„æ•°æ®é€šå¸¸å­˜å‚¨åœ¨ /var/lib/clickhouse/ ç›®å½•ä¸‹ï¼Œå¦‚æœä½ æƒ³å°† ClickHouse æ•°æ®å¤‡ä»½åˆ°è¿œç¨‹ä¸»æœºï¼Œå¯ä»¥ä½¿ç”¨ rsyncã€‚/var/lib/clickhouse/ï¼šæœ¬æœº ClickHouse æ•°æ®ç›®å½•ã€‚ğŸ“Œ ä½¿ç”¨ rsync å¤‡ä»½ ClickHouse æ•°æ®åˆ°è¿œç¨‹ä¸»æœºã€‚"
keywords: "rsync å¤‡ä»½ clickhouse"
categories: ['Clickhouse']
tags: ['Clickhouse']
artid: "146255299"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146255299
    alt: "rsync-å¤‡ä»½-clickhouse"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146255299
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146255299
cover: https://bing.ee123.net/img/rand?artid=146255299
image: https://bing.ee123.net/img/rand?artid=146255299
img: https://bing.ee123.net/img/rand?artid=146255299
---

# rsync å¤‡ä»½ clickhouse

raync å¤‡ä»½ clickhouse åˆ°è¿œç¨‹ä¸»æœº
  
ğŸ“Œ ä½¿ç”¨ rsync å¤‡ä»½ ClickHouse æ•°æ®åˆ°è¿œç¨‹ä¸»æœº
  
ClickHouse çš„æ•°æ®é€šå¸¸å­˜å‚¨åœ¨ /var/lib/clickhouse/ ç›®å½•ä¸‹ï¼Œå¦‚æœä½ æƒ³å°† ClickHouse æ•°æ®å¤‡ä»½åˆ°è¿œç¨‹ä¸»æœºï¼Œå¯ä»¥ä½¿ç”¨ rsyncã€‚
  
âœ… 1. rsync å¤‡ä»½ ClickHouse æ•°æ®

```bash
rsync -avz --progress --delete /var/lib/clickhouse/ user@remote_host:/backup/clickhouse/

```

ğŸ”¹ å‚æ•°è§£é‡Šï¼š

-aï¼šå½’æ¡£æ¨¡å¼ï¼Œä¿ç•™æƒé™ã€æ—¶é—´æˆ³ã€ç¬¦å·é“¾æ¥ç­‰ï¼ˆç›¸å½“äº -rlptgoDï¼‰ã€‚
  
-vï¼šæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯ã€‚
  
-zï¼šå‹ç¼©æ•°æ®ï¼Œæé«˜ä¼ è¾“æ•ˆç‡ã€‚
  
â€“progressï¼šæ˜¾ç¤ºè¿›åº¦ã€‚
  
â€“deleteï¼šåŒæ­¥åˆ é™¤è¿œç¨‹å·²åˆ é™¤çš„æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰ã€‚
  
/var/lib/clickhouse/ï¼šæœ¬æœº ClickHouse æ•°æ®ç›®å½•ã€‚
  
user@remote\_host:/backup/clickhouse/ï¼šè¿œç¨‹ä¸»æœºçš„å¤‡ä»½ç›®å½•ã€‚
  
ğŸš€ ç¤ºä¾‹ï¼ˆè¿œç¨‹ä¸»æœº IP ä¸º 192.168.1.100ï¼Œç”¨æˆ·åä¸º backupï¼‰ï¼š

```bash
rsync -avz --progress /var/lib/clickhouse/ backup@192.168.1.100:/backup/clickhouse/

```

âœ… 2. ä»…å¤‡ä»½ store/ ç›®å½•ï¼ˆæ•°æ®è¡¨ï¼‰
  
ClickHouse ä¸»è¦çš„è¡¨æ•°æ®å­˜å‚¨åœ¨ store/ ç›®å½•ï¼Œä½ ä¹Ÿå¯ä»¥ä»…å¤‡ä»½è¯¥ç›®å½•ï¼š

```bash
rsync -avz --progress /var/lib/clickhouse/store/ backup@192.168.1.100:/backup/clickhouse/store/

```

âœ… 3. ä»…å¤‡ä»½ metadata/ï¼ˆè¡¨ç»“æ„ï¼‰
  
ClickHouse è¡¨ç»“æ„ å­˜å‚¨åœ¨ /var/lib/clickhouse/metadata/ ç›®å½•ï¼š

```bash
rsync -avz --progress /var/lib/clickhouse/metadata/ backup@192.168.1.100:/backup/clickhouse/metadata/

```

âœ… 4. è®¡åˆ’ä»»åŠ¡å®šæœŸå¤‡ä»½
  
å¦‚æœä½ å¸Œæœ›æ¯å¤©å‡Œæ™¨ 2 ç‚¹è‡ªåŠ¨å¤‡ä»½ ClickHouse æ•°æ®åˆ°è¿œç¨‹ä¸»æœºï¼Œå¯ä»¥æ·»åŠ  crontab ä»»åŠ¡ï¼š

```bash
crontab -e

```

```bash
0 2 * * * rsync -avz --progress /var/lib/clickhouse/ backup@192.168.1.100:/backup/clickhouse/

```

âœ… 5. ä½¿ç”¨ rsync å¢é‡å¤‡ä»½
  
å¦‚æœä½ æƒ³ä½¿ç”¨ å¢é‡å¤‡ä»½ï¼ˆä»…ä¼ è¾“æ–°æ•°æ®ï¼‰ï¼Œå¯ä»¥åŠ ä¸Š --link-dest é€‰é¡¹ï¼š

```bash
rsync -avz --progress --delete --link-dest=/backup/clickhouse/latest /var/lib/clickhouse/ backup@192.168.1.100:/backup/clickhouse/$(date +\%F)/
ln -sfn /backup/clickhouse/$(date +\%F) /backup/clickhouse/latest

```

è¿™æ ·æ¯æ¬¡å¤‡ä»½åªä¼šå­˜å‚¨å¢é‡æ•°æ®ï¼Œä½†å¯ä»¥æ¢å¤å®Œæ•´çš„æ•°æ®ã€‚
  
âœ… 6. å¤‡ä»½ ClickHouse å¹¶å‹ç¼©

```bash
rsync -avz /var/lib/clickhouse/ backup@192.168.1.100:/backup/clickhouse/ && tar -czvf /backup/clickhouse.tar.gz /backup/clickhouse/

```

è¿™å°†ï¼š
  
å…ˆ rsync å¤‡ä»½æ•°æ®åˆ°è¿œç¨‹ä¸»æœº
  
å†ä½¿ç”¨ tar æ‰“åŒ… gzip å‹ç¼©å¤‡ä»½æ–‡ä»¶
  
ğŸ“Œ æ€»ç»“
  
æ“ä½œ å‘½ä»¤
  
å®Œæ•´å¤‡ä»½ ClickHouse

```bash
rsync -avz --progress /var/lib/clickhouse/ backup@remote_host:/backup/clickhouse/

```

ä»…å¤‡ä»½ store/ï¼ˆæ•°æ®è¡¨ï¼‰

```bash
rsync -avz --progress /var/lib/clickhouse/store/ backup@remote_host:/backup/clickhouse/store/

```

ä»…å¤‡ä»½ metadata/ï¼ˆè¡¨ç»“æ„ï¼‰

```bash
rsync -avz --progress /var/lib/clickhouse/metadata/ backup@remote_host:/backup/clickhouse/metadata/

```

å¢é‡å¤‡ä»½

```bash
rsync -avz --progress --link-dest=/backup/clickhouse/latest /var/lib/clickhouse/ backup@remote_host:/backup/clickhouse/$(date +\%F)/

```

è‡ªåŠ¨å®šæ—¶å¤‡ä»½ crontab -e æ·»åŠ 

```bash
0 2 * * * rsync -avz --progress /var/lib/clickhouse/ backup@remote_host:/backup/clickhouse/

```

ğŸš€ æ¨èä½¿ç”¨ rsync è¿›è¡Œå¢é‡å¤‡ä»½ï¼Œå¹¶ç»“åˆ crontab å®ç°è‡ªåŠ¨å®šæœŸå¤‡ä»½ï¼ ğŸ¯
  
è­¦å‘Š
  
å¤‡ä»½å®Œæˆåï¼Œå¦‚æœæƒ³ç”¨è¿™ä¸ªå¤‡ä»½æ•°æ®ç›´æ¥å¯åŠ¨æ–°çš„ clickhouse éœ€è¦åˆ é™¤ store ç›®å½•ä¸‹çš„ç©ºç›®å½•ï¼ˆå› ä¸ºåœ¨å¤‡ä»½è¿‡ç¨‹ä¸­æº clickhouse å¦‚æœæ˜¯å¯åŠ¨çŠ¶æ€å°±ä¼šæœ‰ç©ºç›®å½•è¢«å¤‡ä»½ï¼‰

```bash
find /tmp/test -type d -empty -delete

```