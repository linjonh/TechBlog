---
layout: post
title: "程序代码篇-STM舵机控制"
date: 2025-03-12 09:55:21 +0800
description: "本次代码实现了基于STM32的舵机控制功能，主要包括舵机的GPIO初始化、PWM信号生成、舵机角度设置、停止运动以及偏差设置等功能。下面我将逐部分详细解释这段代码。这段代码实现了基于STM32的舵机控制功能，通过TIM7定时器生成PWM信号，控制舵机的角度和运动。代码结构清晰，功能模块化，便于维护和扩展。"
keywords: "程序代码篇---STM舵机控制"
categories: ['程序代码篇', '嵌入式硬件篇']
tags: ['舵机', '嵌入式硬件', '单片机']
artid: "146196419"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146196419
    alt: "程序代码篇-STM舵机控制"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146196419
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146196419
cover: https://bing.ee123.net/img/rand?artid=146196419
image: https://bing.ee123.net/img/rand?artid=146196419
img: https://bing.ee123.net/img/rand?artid=146196419
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     程序代码篇---STM舵机控制
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="./../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="./../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <hr/>
    <p>
    </p>
    <p>
    </p>
    <hr/>
    <h2>
     <a id="_10">
     </a>
     前言
    </h2>
    <p>
     本次代码实现了基于
     <strong>
      STM32的舵机控制功能
     </strong>
     ，主要包括
     <strong>
      舵机的GPIO初始化、PWM信号生成、舵机角度设置、停止运动以及偏差设置
     </strong>
     等功能。下面我将逐部分详细解释这段代码。
    </p>
    <hr/>
    <h2>
     <a id="1__18">
     </a>
     1. 头文件和全局变量
    </h2>
    <pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"y_servo/y_servo.h"</span></span>

<span class="token class-name">pwmServo_t</span> pwmServo_angle<span class="token punctuation">[</span>SERVO_NUM<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre>
    <blockquote>
     <p>
      #include “y_servo/y_servo.h”：包含了
      <strong>
       舵机相关的头文件，可能定义了舵机的配置和函数声明。
      </strong>
      <br/>
      pwmServo_t pwmServo_angle[SERVO_NUM]：定义了一个
      <strong>
       全局数组
      </strong>
      ，用于存储每个舵机的控制参数（
      <strong>
       目标角度、当前角度、增量、时间等
      </strong>
      ）。
     </p>
    </blockquote>
    <h2>
     <a id="2_GPIO_29">
     </a>
     2. 舵机GPIO初始化函数
    </h2>
    <pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">servo_gpio_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    u8 i<span class="token punctuation">;</span>
    GPIO_InitTypeDef GPIO_InitStructure<span class="token punctuation">;</span>

    <span class="token function">RCC_APB2PeriphClockCmd</span><span class="token punctuation">(</span>SERVO0_GPIO_CLK <span class="token operator">|</span> SERVO1_GPIO_CLK <span class="token operator">|</span> SERVO2_GPIO_CLK <span class="token operator">|</span> SERVO3_GPIO_CLK <span class="token operator">|</span> SERVO4_GPIO_CLK <span class="token operator">|</span> SERVO5_GPIO_CLK<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 使能 舵机 端口时钟 */</span>

    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> SERVO0_PIN<span class="token punctuation">;</span>         <span class="token comment">/* 配置引脚 */</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Speed <span class="token operator">=</span> GPIO_Speed_50MHz<span class="token punctuation">;</span> <span class="token comment">/* IO翻转50MHZ */</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_Out_PP<span class="token punctuation">;</span>  <span class="token comment">/* 推挽输出 */</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>SERVO0_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> SERVO1_PIN<span class="token punctuation">;</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>SERVO1_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> SERVO2_PIN<span class="token punctuation">;</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>SERVO2_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> SERVO3_PIN<span class="token punctuation">;</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>SERVO3_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> SERVO4_PIN<span class="token punctuation">;</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>SERVO4_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> SERVO5_PIN<span class="token punctuation">;</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>SERVO5_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> SERVO_NUM<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        pwmServo_angle<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>aim <span class="token operator">=</span> <span class="token number">1500</span><span class="token punctuation">;</span>
        pwmServo_angle<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token number">1500</span><span class="token punctuation">;</span>
        pwmServo_angle<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>increment <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        pwmServo_angle<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>time <span class="token operator">=</span> <span class="token number">5000</span><span class="token punctuation">;</span>
        pwmServo_angle<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>bias <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <blockquote>
     <p>
      功能：
      <strong>
       初始化舵机的GPIO引脚
      </strong>
      ，配置为
      <strong>
       推挽输出模式
      </strong>
      ，并初始化舵机控制参数。
      <br/>
      关键点：
      <br/>
      RCC_APB2PeriphClockCmd：
      <strong>
       使能舵机GPIO端口的时钟。
      </strong>
      <br/>
      GPIO_InitStructure：配置GPIO引脚为
      <strong>
       推挽输出模式
      </strong>
      ，速度为50MHz。
      <br/>
      for循环：初始化每个舵机的控制参数，
      <strong>
       默认角度为1500（舵机中位）
      </strong>
      ，时间5000ms，偏差为0。
     </p>
    </blockquote>
    <h2>
     <a id="3_TIM7_76">
     </a>
     3. TIM7初始化函数
    </h2>
    <pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">TIM7_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    TIM_TimeBaseInitTypeDef TIM_TimeBaseStructure<span class="token punctuation">;</span>
    NVIC_InitTypeDef NVIC_InitStructure<span class="token punctuation">;</span>
    <span class="token function">RCC_APB1PeriphClockCmd</span><span class="token punctuation">(</span>RCC_APB1Periph_TIM7<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//使能定时器的时钟</span>
    TIM_TimeBaseStructure<span class="token punctuation">.</span>TIM_Prescaler <span class="token operator">=</span> <span class="token number">71</span><span class="token punctuation">;</span>            <span class="token comment">// 预分频器</span>
    TIM_TimeBaseStructure<span class="token punctuation">.</span>TIM_Period <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">;</span>                <span class="token comment">//设定计数器自动重装值</span>
    <span class="token function">TIM_TimeBaseInit</span><span class="token punctuation">(</span>TIM7<span class="token punctuation">,</span> <span class="token operator">&amp;</span>TIM_TimeBaseStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">TIM_ClearFlag</span><span class="token punctuation">(</span>TIM7<span class="token punctuation">,</span> TIM_FLAG_Update<span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">//清除TIM的更新标志位</span>
    <span class="token function">TIM_ITConfig</span><span class="token punctuation">(</span>TIM7<span class="token punctuation">,</span> TIM_IT_Update<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//中断优先级NVIC设置</span>
    NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannel <span class="token operator">=</span> TIM7_IRQn<span class="token punctuation">;</span>              <span class="token comment">//TIM中断</span>
    NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannelPreemptionPriority <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token comment">//先占优先级0级</span>
    NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannelSubPriority <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>           <span class="token comment">//从优先级1级</span>
    NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannelCmd <span class="token operator">=</span> ENABLE<span class="token punctuation">;</span>              <span class="token comment">//IRQ通道被使能</span>
    <span class="token function">NVIC_Init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>NVIC_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>                              <span class="token comment">//初始化NVIC寄存器</span>

    <span class="token function">TIM_Cmd</span><span class="token punctuation">(</span>TIM7<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <blockquote>
     <p>
      功能：初始化TIM7定时器，用于生成
      <strong>
       PWM信号控制舵机。
      </strong>
      <br/>
      关键点：
      <br/>
      TIM_TimeBaseStructure.TIM_Prescaler = 71：
      <strong>
       设置预分频器，将系统时钟分频
      </strong>
      。
      <br/>
      TIM_TimeBaseStructure.TIM_Period = 9：设置
      <strong>
       定时器自动重装值，控制PWM周期。
      </strong>
      <br/>
      TIM_ITConfig(TIM7, TIM_IT_Update, ENABLE)：
      <strong>
       使能定时器更新中断。
      </strong>
      <br/>
      NVIC_Init：配置
      <strong>
       TIM7中断优先级
      </strong>
      。
     </p>
    </blockquote>
    <h2>
     <a id="4__108">
     </a>
     4. 舵机增量偏移计算函数
    </h2>
    <pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">servo_increment_offset</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> index<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> aim_temp<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>pwmServo_angle<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>increment <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        aim_temp <span class="token operator">=</span> pwmServo_angle<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>aim <span class="token operator">+</span> pwmServo_angle<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>bias<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>aim_temp <span class="token operator">&gt;</span> <span class="token number">2490</span><span class="token punctuation">)</span>
            aim_temp <span class="token operator">=</span> <span class="token number">2490</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>aim_temp <span class="token operator">&lt;</span> <span class="token number">500</span><span class="token punctuation">)</span>
            aim_temp <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">abs</span><span class="token punctuation">(</span>aim_temp <span class="token operator">-</span> pwmServo_angle<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>current<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token function">fabs</span><span class="token punctuation">(</span>pwmServo_angle<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>increment <span class="token operator">+</span> pwmServo_angle<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>increment<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            pwmServo_angle<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>current <span class="token operator">=</span> aim_temp<span class="token punctuation">;</span>
            pwmServo_angle<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>increment <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{<!-- --></span>
            pwmServo_angle<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>current <span class="token operator">+=</span> pwmServo_angle<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>increment<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <blockquote>
     <p>
      功能：根据
      <strong>
       目标角度和当前角度
      </strong>
      计算舵机的
      <strong>
       增量偏移
      </strong>
      ，逐步调整舵机角度。
      <br/>
      关键点：
      <br/>
      aim_temp：计算目标角度加上偏差后的值。
      <br/>
      if (aim_temp &gt; 2490)：限制舵机角度在500到2490之间。
      <br/>
      pwmServo_angle[index].current += pwmServo_angle[index].increment;：逐步调整当前角度。
     </p>
    </blockquote>
    <h2>
     <a id="5__142">
     </a>
     5. 舵机引脚电平设置函数
    </h2>
    <pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">servo_pin_set</span><span class="token punctuation">(</span>u8 index<span class="token punctuation">,</span> BitAction level<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>index<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>
        <span class="token function">SERVO0_PIN_SET</span><span class="token punctuation">(</span>level<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
        <span class="token function">SERVO1_PIN_SET</span><span class="token punctuation">(</span>level<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
        <span class="token function">SERVO2_PIN_SET</span><span class="token punctuation">(</span>level<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span>
        <span class="token function">SERVO3_PIN_SET</span><span class="token punctuation">(</span>level<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span>
        <span class="token function">SERVO4_PIN_SET</span><span class="token punctuation">(</span>level<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">5</span><span class="token operator">:</span>
        <span class="token function">SERVO5_PIN_SET</span><span class="token punctuation">(</span>level<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <blockquote>
     <p>
      功能：根据
      <strong>
       舵机索引设置对应引脚的电平
      </strong>
      。
      <br/>
      关键点：
      <br/>
      SERVO0_PIN_SET(level)：设置
      <strong>
       舵机引脚电平
      </strong>
      （高或低）。
     </p>
    </blockquote>
    <h2>
     <a id="6_TIM7_177">
     </a>
     6. TIM7中断服务函数
    </h2>
    <pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">TIM7_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">static</span> u8 flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> u8 duoji_index1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> temp<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">TIM_GetITStatus</span><span class="token punctuation">(</span>TIM7<span class="token punctuation">,</span> TIM_IT_Update<span class="token punctuation">)</span> <span class="token operator">!=</span> RESET<span class="token punctuation">)</span> <span class="token comment">//检查TIM更新中断发生与否</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* 通过改变重装载值和舵机下标索引，每个舵机定时2500（2.5ms），执行8个舵机后完成一个周期20000（20ms） */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>duoji_index1 <span class="token operator">==</span> <span class="token number">8</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            duoji_index1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>flag <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            TIM7<span class="token operator">-&gt;</span>ARR <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>pwmServo_angle<span class="token punctuation">[</span>duoji_index1<span class="token punctuation">]</span><span class="token punctuation">.</span>current<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">servo_pin_set</span><span class="token punctuation">(</span>duoji_index1<span class="token punctuation">,</span> Bit_SET<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">servo_increment_offset</span><span class="token punctuation">(</span>duoji_index1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{<!-- --></span>
            temp <span class="token operator">=</span> <span class="token number">2500</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>pwmServo_angle<span class="token punctuation">[</span>duoji_index1<span class="token punctuation">]</span><span class="token punctuation">.</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
            TIM7<span class="token operator">-&gt;</span>ARR <span class="token operator">=</span> temp<span class="token punctuation">;</span>
            <span class="token function">servo_pin_set</span><span class="token punctuation">(</span>duoji_index1<span class="token punctuation">,</span> Bit_RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>
            duoji_index1<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        flag <span class="token operator">=</span> <span class="token operator">!</span>flag<span class="token punctuation">;</span>

        <span class="token function">TIM_ClearITPendingBit</span><span class="token punctuation">(</span>TIM7<span class="token punctuation">,</span> TIM_IT_Update<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//清除TIMx更新中断标志</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <blockquote>
     <p>
      功能：TIM7中断服务函数，用于
      <strong>
       生成PWM信号控制舵机。
       <br/>
       关键点：
      </strong>
      <br/>
      TIM7-&gt;ARR：设置定时器自动重装值，控制PWM占空比。
      <br/>
      servo_pin_set：设置舵机引脚电平。
      <br/>
      servo_increment_offset：逐步调整舵机角度。
     </p>
    </blockquote>
    <h2>
     <a id="7__220">
     </a>
     7. 舵机初始化函数
    </h2>
    <pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">pwmServo_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">servo_gpio_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">TIM7_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <blockquote>
     <p>
      功能：初始化舵机GPIO和TIM7定时器。
     </p>
    </blockquote>
    <h2>
     <a id="8__232">
     </a>
     8. 舵机角度设置函数
    </h2>
    <pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">pwmServo_angle_set</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> index<span class="token punctuation">,</span> <span class="token keyword">int</span> aim<span class="token punctuation">,</span> <span class="token keyword">int</span> time<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint8_t</span> i<span class="token punctuation">;</span>

    <span class="token comment">//角度数据超出范围，退出</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>aim <span class="token operator">&gt;</span> <span class="token number">2500</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>aim <span class="token operator">&lt;</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">==</span> <span class="token number">255</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> SERVO_NUM<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            pwmServo_angle<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>aim <span class="token operator">=</span> aim<span class="token punctuation">;</span>
            pwmServo_angle<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>increment <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>pwmServo_angle<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>aim <span class="token operator">-</span> pwmServo_angle<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>current<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>pwmServo_angle<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>time <span class="token operator">/</span> <span class="token number">20.000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            pwmServo_angle<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>time <span class="token operator">=</span> time<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* 限制输入值大小 */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&gt;=</span> SERVO_NUM<span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>time <span class="token operator">&gt;</span> <span class="token number">10000</span><span class="token punctuation">)</span>
        time <span class="token operator">=</span> <span class="token number">10000</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>time <span class="token operator">&lt;</span> <span class="token number">20</span><span class="token punctuation">)</span> <span class="token comment">/* 执行时间太短，舵机直接以最快速度运动 */</span>
    <span class="token punctuation">{<!-- --></span>
        pwmServo_angle<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>aim <span class="token operator">=</span> aim<span class="token punctuation">;</span>
        pwmServo_angle<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>current <span class="token operator">=</span> aim<span class="token punctuation">;</span>
        pwmServo_angle<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>increment <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
        pwmServo_angle<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>aim <span class="token operator">=</span> aim<span class="token punctuation">;</span>
        pwmServo_angle<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>time <span class="token operator">=</span> time<span class="token punctuation">;</span>
        pwmServo_angle<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>increment <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>pwmServo_angle<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>aim <span class="token operator">-</span> pwmServo_angle<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>current<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>pwmServo_angle<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>time <span class="token operator">/</span> <span class="token number">20.000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <blockquote>
     <p>
      功能：设置舵机的目标角度和执行时间。
      <br/>
      关键点：
      <br/>
      if (index == 255)：如果索引为255，设置所有舵机的角度。
      <br/>
      pwmServo_angle[index].increment：计算舵机角度的增量。
     </p>
    </blockquote>
    <h2>
     <a id="9__281">
     </a>
     9. 舵机停止运动函数
    </h2>
    <pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">pwmServo_stop_motion</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> index<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint8_t</span> i<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">==</span> <span class="token number">255</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> SERVO_NUM<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            pwmServo_angle<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>aim <span class="token operator">=</span> pwmServo_angle<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>current<span class="token punctuation">;</span>
            pwmServo_angle<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>increment <span class="token operator">=</span> <span class="token number">0.001</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* 限制输入值大小 */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&gt;=</span> SERVO_NUM<span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>

    pwmServo_angle<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>aim <span class="token operator">=</span> pwmServo_angle<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>current<span class="token punctuation">;</span>
    pwmServo_angle<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>increment <span class="token operator">=</span> <span class="token number">0.001</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <blockquote>
     <p>
      功能：停止舵机运动。
     </p>
    </blockquote>
    <h2>
     <a id="10__309">
     </a>
     10. 舵机偏差设置函数
    </h2>
    <pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">pwmServo_bias_set</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> index<span class="token punctuation">,</span> <span class="token keyword">int</span> bias<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">/* 限制输入值大小 */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&gt;=</span> SERVO_NUM<span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>

    pwmServo_angle<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>bias <span class="token operator">=</span> bias<span class="token punctuation">;</span>
    pwmServo_angle<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>increment <span class="token operator">=</span> <span class="token number">0.001</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <blockquote>
     <p>
      功能：设置舵机的偏差值。
     </p>
    </blockquote>
    <h2>
     <a id="_325">
     </a>
     总结
    </h2>
    <p>
     这段代码实现了基于
     <strong>
      STM32的舵机控制功能
     </strong>
     ，通过TIM7定时器生成PWM信号，
     <strong>
      控制舵机的角度和运动
     </strong>
     。代码结构清晰，功能模块化，便于维护和扩展。
    </p>
    <hr/>
   </div>
   <link href="./../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="./../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f:672e6373646e2e6e65742f323330315f37393535363430322f:61727469636c652f64657461696c732f313436313936343139" class_="artid" style="display:none">
 </p>
</div>


