---
layout: post
title: "NexLM-开源系列让-AI-聊天更丝滑SSE-实现流式对话"
date: 2025-03-11 20:50:01 +0800
description: "在本篇我们成功实现了基于的流式对话，让 AI 的回复能够逐步呈现，极大地提升了用户的交互体验。SSE 方案简单易用，特别适用于单向推送的场景，比如 AI 回复、系统日志推送等。然而，SSE 也存在一定的局限性，比如它是单向通信的，仅支持服务器向客户端推送数据，无法处理客户端的主动交互需求。那么，如果我们希望实现更复杂的实时双向通信（比如 AI 生成过程中用户可以中断对话、发送指令调整回复内容等），WebSocket就是一个更优的选择！在下一篇文章中，我们将深入探讨WebSocket。"
keywords: "【NexLM 开源系列】让 AI 聊天更丝滑：SSE 实现流式对话！"
categories: ['未分类']
tags: ['大模型集成', 'Deepseek', 'Chatgpt']
artid: "146185831"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146185831
    alt: "NexLM-开源系列让-AI-聊天更丝滑SSE-实现流式对话"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146185831
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146185831
cover: https://bing.ee123.net/img/rand?artid=146185831
image: https://bing.ee123.net/img/rand?artid=146185831
img: https://bing.ee123.net/img/rand?artid=146185831
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     【NexLM 开源系列】让 AI 聊天更丝滑：SSE 实现流式对话！
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     🌟 在这系列文章中，我们将一起探索如何搭建一个支持大模型集成项目
     <strong>
      NexLM
     </strong>
     的开发过程，从
     <strong>
      架构设计
     </strong>
     到
     <strong>
      代码实战
     </strong>
     ，逐步搭建一个支持
     <strong>
      多种大模型（GPT-4、DeepSeek 等）
     </strong>
     的
     <strong>
      一站式大模型集成与管理平台
     </strong>
     ，并集成
     <strong>
      认证中心、微服务、流式对话
     </strong>
     等核心功能。
    </p>
    <p>
     <strong>
      系列目录规划：
     </strong>
    </p>
    <ol>
     <li>
      <strong>
       NexLM：从零开始打造你的专属大模型集成平台
      </strong>
      ✅
     </li>
     <li>
      <strong>
       Spring Boot + OpenAI/DeepSeek：如何封装多个大模型 API 调用
      </strong>
      ✅
     </li>
     <li>
      <strong>
       支持流式对话 SSE &amp; WebSocket：让 AI 互动更丝滑
      </strong>
      ✅
     </li>
     <li>
      <strong>
       微服务 + 认证中心：如何保障大模型 API 的安全调用
      </strong>
     </li>
     <li>
      <strong>
       缓存与性能优化：提高 LLM API 响应速度
      </strong>
     </li>
     <li>
      <strong>
       NexLM 开源部署指南（Docker）
      </strong>
     </li>
    </ol>
    <hr/>
    <h2>
     <a id="_AI_SSE__14">
     </a>
     <strong>
      第三篇：让 AI 聊天更丝滑：SSE 实现流式对话！
     </strong>
    </h2>
    <p>
     <em>
      上一篇中，我们探讨了如何封装多个大模型 API 调用。
     </em>
    </p>
    <p>
     然而，传统的请求-响应模式在与 AI 模型交互时，往往需要等待模型生成完整的回复后才能返回给用户，这可能导致用户体验不佳。为提升交互的实时性，我们可以引入流式对话技术，使 AI 的回复能够逐步呈现，带来更流畅的用户体验。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/bdad9cba78c4458291cd65b57929c34e.gif"/>
    </p>
    <h3>
     <a id="_23">
     </a>
     为什么选择流式对话？
    </h3>
    <p>
     在传统的同步通信中，客户端发送请求，服务器处理后返回完整的响应。然而，对于大型语言模型（LLM），生成完整的回复可能需要一定时间。如果用户需要等待整个回复生成完毕，可能会感到延迟，影响体验。
     <strong>
      通过流式对话，服务器可以在生成回复的过程中，逐步将内容发送给客户端，客户端也能实时呈现这些内容，提升交互的即时性。
     </strong>
    </p>
    <h3>
     <a id="SSE__27">
     </a>
     SSE 实现流式对话的方式
    </h3>
    <h4>
     <a id="ServerSent_EventsSSE_29">
     </a>
     Server-Sent Events（SSE）
    </h4>
    <p>
     <strong>
      SSE 是一种基于 HTTP 协议的服务器向客户端推送数据的技术
     </strong>
     。它使用简单，适合服务器向客户端发送实时更新的场景。在 SSE 中，客户端通过建立一个持久的 HTTP 连接，服务器可以持续地向客户端发送数据。
    </p>
    <p>
     <strong>
      优点：
     </strong>
    </p>
    <ul>
     <li>
      实现简单，使用标准的 HTTP 协议。
     </li>
     <li>
      浏览器兼容性好，支持自动重连。
     </li>
    </ul>
    <p>
     <strong>
      缺点：
     </strong>
    </p>
    <ul>
     <li>
      仅支持服务器向客户端的单向通信。
     </li>
    </ul>
    <h3>
     <a id="_Spring_Boot__42">
     </a>
     实战：在 Spring Boot 中实现流式对话
    </h3>
    <p>
     接下来，我们将展示如何在 Spring Boot 项目中，使用 SSE 和 WebSocket 实现与 AI 模型的流式对话。代码仓库地址：
     <a href="https://github.com/pitt1997/NexLM">
      https://github.com/pitt1997/NexLM
     </a>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/aef022efe9f04eeda3ca4b9635bce03b.png"/>
    </p>
    <h4>
     <a id="_SSE__49">
     </a>
     使用 SSE 实现流式对话
    </h4>
    <p>
     <strong>
      1. Controller 层：
     </strong>
    </p>
    <p>
     我们需要在控制器中定义一个使用 SSE 的端点。
    </p>
    <pre><code class="prism language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/api/ai"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ChatApiController</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">ChatService</span> chatService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/chat/stream"</span><span class="token punctuation">,</span> produces <span class="token operator">=</span> <span class="token class-name">MediaType</span><span class="token punctuation">.</span><span class="token constant">TEXT_EVENT_STREAM_VALUE</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">SseEmitter</span> <span class="token function">streamChat</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> <span class="token class-name">String</span> prompt<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">SseEmitter</span> emitter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SseEmitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        executor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                deepSeekClient<span class="token punctuation">.</span><span class="token function">streamChat</span><span class="token punctuation">(</span>prompt<span class="token punctuation">,</span> emitter<span class="token punctuation">)</span><span class="token punctuation">;</span>
                emitter<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                emitter<span class="token punctuation">.</span><span class="token function">completeWithError</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> emitter<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     <strong>
      2. Service 层：
     </strong>
    </p>
    <p>
     在服务层，我们需要实现
     <code>
      callAIModel
     </code>
     方法，根据不同的模型类型，调用对应的客户端进行流式对话。
    </p>
    <pre><code class="prism language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ChatService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">OpenAIClient</span> openAIClient<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">DeepSeekClient</span> deepSeekClient<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">LocalLLMClient</span> localLLMClient<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">callAIModel</span><span class="token punctuation">(</span><span class="token class-name">String</span> prompt<span class="token punctuation">,</span> <span class="token class-name">String</span> modelType<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"chatgpt"</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>modelType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> openAIClient<span class="token punctuation">.</span><span class="token function">chat</span><span class="token punctuation">(</span>prompt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"deepseek"</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>modelType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> deepSeekClient<span class="token punctuation">.</span><span class="token function">chat</span><span class="token punctuation">(</span>prompt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"local"</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>modelType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> localLLMClient<span class="token punctuation">.</span><span class="token function">chat</span><span class="token punctuation">(</span>prompt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token string">"Invalid Model Type"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     <strong>
      3. 调用大模型接口 API：
     </strong>
    </p>
    <p>
     以 DeepSeek 为例，我们需要实现
     <code>
      streamChat
     </code>
     方法，逐步将 AI 模型的回复发送给客户端。
    </p>
    <pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DeepSeekClient</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">API_URL</span> <span class="token operator">=</span> <span class="token string">"https://api.deepseek.com/chat/completions"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">API_KEY</span> <span class="token operator">=</span> <span class="token string">"你的 DeepSeek API Key"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">MODEL</span> <span class="token operator">=</span> <span class="token string">"deepseek-chat"</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">streamChat</span><span class="token punctuation">(</span><span class="token class-name">String</span> prompt<span class="token punctuation">,</span> <span class="token class-name">SseEmitter</span> emitter<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">RestTemplate</span> restTemplate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HttpHeaders</span> headers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        headers<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token class-name">MediaType</span><span class="token punctuation">.</span><span class="token constant">APPLICATION_JSON</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        headers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"Authorization"</span><span class="token punctuation">,</span> <span class="token string">"Bearer "</span> <span class="token operator">+</span> <span class="token constant">API_KEY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> body <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        body<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"model"</span><span class="token punctuation">,</span> <span class="token constant">MODEL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// deepseek-v3 / deepseek-r1</span>
        body<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"temperature"</span><span class="token punctuation">,</span> <span class="token number">0.7</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 可调整温度</span>
        body<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"max_tokens"</span><span class="token punctuation">,</span> <span class="token number">2048</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 控制回复长度</span>
        body<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"stream"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 启用流式响应</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> messages <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>
                <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>
                    <span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"role"</span><span class="token punctuation">,</span> <span class="token string">"user"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"content"</span><span class="token punctuation">,</span> prompt<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">}</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        body<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"messages"</span><span class="token punctuation">,</span> messages<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">HttpEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> headers<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 使用 RequestCallback 处理请求</span>
        <span class="token class-name">RequestCallback</span> requestCallback <span class="token operator">=</span> clientHttpRequest <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">ObjectMapper</span> objectMapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            objectMapper<span class="token punctuation">.</span><span class="token function">writeValue</span><span class="token punctuation">(</span>clientHttpRequest<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> body<span class="token punctuation">)</span><span class="token punctuation">;</span>
            clientHttpRequest<span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>headers<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token comment">// 使用 ResponseExtractor 处理响应</span>
        restTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token constant">API_URL</span><span class="token punctuation">,</span> <span class="token class-name">HttpMethod</span><span class="token punctuation">.</span><span class="token constant">POST</span><span class="token punctuation">,</span> requestCallback<span class="token punctuation">,</span> response <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">BufferedReader</span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> line<span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>line <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>line<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"data: "</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">String</span> json <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>json<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"[DONE]"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token class-name">String</span> content <span class="token operator">=</span> <span class="token function">extractContentStream</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>content<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 检查 content 是否为空</span>
                            <span class="token comment">// 发送数据到客户端</span>
                            emitter<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">SseEmitter</span><span class="token punctuation">.</span><span class="token function">event</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">extractContentStream</span><span class="token punctuation">(</span><span class="token class-name">String</span> json<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">ObjectMapper</span> objectMapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">JsonNode</span> root <span class="token operator">=</span> objectMapper<span class="token punctuation">.</span><span class="token function">readTree</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">JsonNode</span> deltaNode <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span><span class="token string">"choices"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span><span class="token string">"delta"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>deltaNode<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span><span class="token string">"content"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> deltaNode<span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span><span class="token string">"content"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">;</span> <span class="token comment">// 如果 delta 中没有 content 字段，返回空字符串</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token string">"Error parsing response"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre>
    <p>
     <strong>
      4. 前面通过 SSE 方式获取流式返回结果
     </strong>
    </p>
    <pre><code class="prism language-javascript"><span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
    <span class="token keyword">function</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">let</span> input <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"userInput"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> message <span class="token operator">=</span> input<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>message <span class="token operator">===</span> <span class="token string">""</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> modelType <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"modelType"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>
        <span class="token keyword">let</span> chatBox <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"chatBox"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 显示用户消息</span>
        <span class="token keyword">let</span> userMessage <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"div"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        userMessage<span class="token punctuation">.</span>className <span class="token operator">=</span> <span class="token string">"message user-message"</span><span class="token punctuation">;</span>
        userMessage<span class="token punctuation">.</span>innerText <span class="token operator">=</span> message<span class="token punctuation">;</span>
        chatBox<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>userMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 显示 AI "正在输入..." 和加载动画</span>
        <span class="token keyword">let</span> botMessage <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"div"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        botMessage<span class="token punctuation">.</span>className <span class="token operator">=</span> <span class="token string">"message bot-message"</span><span class="token punctuation">;</span>
        botMessage<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">"AI 正在输入... &lt;span class='loader'&gt;&lt;/span&gt;"</span><span class="token punctuation">;</span>
        chatBox<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>botMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        input<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>

        <span class="token comment">// 滚动到最新消息</span>
        chatBox<span class="token punctuation">.</span>scrollTop <span class="token operator">=</span> chatBox<span class="token punctuation">.</span>scrollHeight<span class="token punctuation">;</span>

        <span class="token comment">// 编码用户输入</span>
        <span class="token keyword">var</span> encodedMessage <span class="token operator">=</span> <span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"URL Encoded message:"</span><span class="token punctuation">,</span> encodedMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 通过 SSE 方式获取流式返回的 AI 结果</span>
        <span class="token keyword">let</span> eventSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventSource</span><span class="token punctuation">(</span><span class="token string">"/web/api/ai/chat/stream?modelType="</span> <span class="token operator">+</span> modelType <span class="token operator">+</span> <span class="token string">"&amp;prompt="</span> <span class="token operator">+</span> encodedMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> isFirstChunk <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// 标记是否是第一条消息</span>

        eventSource<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>isFirstChunk<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 如果是第一条消息，替换初始文案</span>
                botMessage<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> event<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
                isFirstChunk <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 否则，追加内容</span>
                botMessage<span class="token punctuation">.</span>innerHTML <span class="token operator">+=</span> event<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 滚动到最新消息</span>
            chatBox<span class="token punctuation">.</span>scrollTop <span class="token operator">=</span> chatBox<span class="token punctuation">.</span>scrollHeight<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        eventSource<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            eventSource<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>isFirstChunk<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 如果流式请求出错，且没有收到任何数据，显示错误信息</span>
                botMessage<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">"AI 响应失败，请重试。"</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre>
    <h4>
     <a id="SSE__247">
     </a>
     SSE 实现流式对话效果演示
    </h4>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/cbbc5e3b99ce4031b11e8d3a45df92f2.gif"/>
    </p>
    <h3>
     <a id="_250">
     </a>
     结语
    </h3>
    <p>
     在本篇我们成功实现了基于
     <strong>
      SSE（Server-Sent Events）
     </strong>
     的流式对话，让 AI 的回复能够逐步呈现，极大地提升了用户的交互体验。SSE 方案简单易用，特别适用于单向推送的场景，比如 AI 回复、系统日志推送等。然而，SSE 也存在一定的局限性，比如它是
     <strong>
      单向通信
     </strong>
     的，仅支持服务器向客户端推送数据，无法处理客户端的主动交互需求。
    </p>
    <p>
     那么，如果我们希望实现
     <strong>
      更复杂的实时双向通信
     </strong>
     （比如 AI 生成过程中用户可以中断对话、发送指令调整回复内容等），
     <strong>
      WebSocket
     </strong>
     就是一个更优的选择！
    </p>
    <p>
     在下一篇文章中，我们将深入探讨
     <strong>
      WebSocket
     </strong>
     如何实现流式对话，并对比 SSE 和 WebSocket 的适用场景，帮助你在实际应用中做出最佳选择。
    </p>
    <p>
     📌
     <strong>
      下一章预告：让 AI 聊天更丝滑：WebSocket 实现流式对话！
     </strong>
    </p>
    <hr/>
    <p>
     📢
     <strong>
      你对这个项目感兴趣吗？欢迎 Star &amp; 关注！
     </strong>
     📌
     <strong>
      <a href="https://github.com/pitt1997/NexLM">
       GitHub 项目地址
      </a>
     </strong>
     <strong>
      🌟 你的支持是我持续创作的动力，欢迎点赞、收藏、分享！
     </strong>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f:626c6f672e6373646e2e6e65742f427261645f50695474372f:61727469636c652f64657461696c732f313436313835383331" class_="artid" style="display:none">
 </p>
</div>


