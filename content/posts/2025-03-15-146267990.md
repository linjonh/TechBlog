---
layout: post
title: "JAVA-EE10线程安全synchronized-JUCjava.util.concurrent-的常见类-线程安全的集合类"
date: 2025-03-15 20:40:57 +0800
description: "上篇博文介绍了各种锁策略，那么在此基础上我再对常用的synchronized的优化策略进行讲解当我们使用synchronized对某一代码块加锁的时候，synchronized并不会在第一时间加锁，而是经历了（）这样的锁升级过程。当一个线程第一次访问同步块时，JVM会尝试，并标记为。之后，当该线程再次进入同步块时，直接进入同步块如果有其他线程尝试获取该锁，偏向锁会被撤销，升级为轻量级锁当thread1等待了很久(自旋了很多次)lock依然没有释放，或者此时又来了很多线程。"
keywords: "JAVA EE(10)——线程安全——synchronized & JUC(java.util.concurrent) 的常见类 & 线程安全的集合类"
categories: ['未分类']
tags: ['数据结构', '安全', 'Ee']
artid: "146267990"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146267990
    alt: "JAVA-EE10线程安全synchronized-JUCjava.util.concurrent-的常见类-线程安全的集合类"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146267990
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146267990
cover: https://bing.ee123.net/img/rand?artid=146267990
image: https://bing.ee123.net/img/rand?artid=146267990
img: https://bing.ee123.net/img/rand?artid=146267990
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     JAVA EE(10)——线程安全——synchronized &amp; JUC(java.util.concurrent) 的常见类 &amp; 线程安全的集合类
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="synchronized_0">
     </a>
     一.synchronized锁升级
    </h2>
    <p>
     上篇博文介绍了各种锁策略，那么在此基础上我再对常用的synchronized的优化策略进行讲解
    </p>
    <pre><code class="prism language-java"><span class="token keyword">synchronized</span> <span class="token punctuation">(</span>锁对象<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">//其他代码</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     当我们使用synchronized对某一代码块加锁的时候，synchronized并不会在第一时间加锁，而是经历了（
     <strong>
      偏向锁——&gt;轻量级锁——&gt;重量级锁
     </strong>
     ）这样的锁升级过程。
     <br/>
     <strong>
      偏向锁
     </strong>
     <br/>
     当一个线程第一次访问同步块时，JVM会尝试
     <strong>
      将该线程的ID记录在锁对象的对象头中
     </strong>
     ，并标记为
     <strong>
      偏向锁
     </strong>
     。之后，当该线程再次进入同步块时，直接进入同步块
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/0d1501f31840408880ae0c287061513f.png#pic_center">
      <br/>
      <strong>
       偏向锁——&gt;轻量级锁
      </strong>
      <br/>
      如果有其他线程尝试获取该锁，偏向锁会被撤销，升级为轻量级锁
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/435d534f9125413196b1c4656e1f5608.png#pic_center">
       <br/>
       <strong>
        轻量级锁——&gt;重量级锁
       </strong>
       <br/>
       当thread1等待了很久(自旋了很多次)lock依然没有释放，或者此时又来了很多线程。JVM看到这里的竞争太大，会考虑把lock升级为重量级锁
      </img>
     </img>
    </p>
    <h2>
     <a id="JUCjavautilconcurrent__17">
     </a>
     二.JUC(java.util.concurrent) 的常见类
    </h2>
    <h3>
     <a id="21ReentrantLock_18">
     </a>
     2.1ReentrantLock
    </h3>
    <p>
     可重入互斥锁，和synchronized定位类似，都是用来实现互斥效果，保证线程安全。ReentrantLock需要
     <strong>
      手动上锁和解锁
     </strong>
     ，而synchronized是自动加锁和解锁。
     <br/>
     <strong>
      (1)更加灵活
     </strong>
    </p>
    <pre><code class="prism language-java"><span class="token comment">//拿不到锁就死等</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	sync<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//尝试获取锁，获取失败后立即返回false，不会阻塞当前线程</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> sync<span class="token punctuation">.</span><span class="token function">nonfairTryAcquire</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//尝试在指定的时间内获取锁，如果在超时之前成功获取到锁，则返回true，否则返回false</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeout<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> sync<span class="token punctuation">.</span><span class="token function">tryAcquireNanos</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> unit<span class="token punctuation">.</span><span class="token function">toNanos</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     因为需要手动释放锁，为了避免忘记释放锁，一般搭配finally使用
    </p>
    <pre><code class="prism language-java"><span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>    
 <span class="token comment">//其他代码</span>
<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>    
 lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    
<span class="token punctuation">}</span>  
</code></pre>
    <p>
     <strong>
      (2)可实现公平锁
     </strong>
    </p>
    <pre><code class="prism language-java"><span class="token comment">//通过构造方法可以选择实例化非公平锁还是公平锁</span>
<span class="token keyword">public</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> fair<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	sync <span class="token operator">=</span> fair <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">FairSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">NonfairSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     <strong>
      (3)更强大的唤醒机制
     </strong>
     <br/>
     synchronized是通过Object的wait/notify实现等待-唤醒，每次唤醒的是一个
     <strong>
      随机等待
     </strong>
     的线程ReentrantLock 搭配 Condition 类实现等待-唤醒, 可以
     <strong>
      更精确控制唤醒某个指定的线程
     </strong>
    </p>
    <h3>
     <a id="22_57">
     </a>
     2.2原子类
    </h3>
    <p>
     原子类内部用的是CAS实现，所以性能要比加锁实现 i++高很多，原子类有以下几个
    </p>
    <p>
     AtomicBoolean
     <br/>
     AtomicInteger
     <br/>
     AtomicIntegerArray
     <br/>
     AtomicLong
     <br/>
     AtomicReference
     <br/>
     AtomicStampedReference
    </p>
    <p>
     以AtomicInteger为例，常用方法有：
     <br/>
     <strong>
      add
     </strong>
     And
     <strong>
      Get
     </strong>
     (int delta); i += delta;
     <br/>
     <strong>
      decrement
     </strong>
     And
     <strong>
      Get
     </strong>
     (); --i;
     <br/>
     <strong>
      get
     </strong>
     And
     <strong>
      Decrement
     </strong>
     (); i–;
     <br/>
     <strong>
      increment
     </strong>
     And
     <strong>
      Get
     </strong>
     (); ++i;
     <br/>
     <strong>
      get
     </strong>
     And
     <strong>
      Increment
     </strong>
     (); i++;
    </p>
    <h3>
     <a id="23_Semaphore_73">
     </a>
     2.3 Semaphore
    </h3>
    <p>
     信号量，用来表示 “可用资源的个数”，本质上就是一个计数器
     <br/>
     可以用它来代替阻塞队列，来实现生产者——消费者模式
    </p>
    <pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ArrayBlockingQueue</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">Semaphore</span></span><span class="token punctuation">;</span>

<span class="token keyword">class</span> producer_consumer_semaphore_Test<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> capacity <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token comment">//未占用资源5个</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Semaphore</span> empty <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Semaphore</span><span class="token punctuation">(</span>capacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//已占用资源0个</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Semaphore</span> fill <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Semaphore</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//实现互斥锁，非0即1</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Semaphore</span> mutex <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Semaphore</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> producer <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{<!-- --></span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"producer:"</span> <span class="token operator">+</span> <span class="token operator">++</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    empty<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mutex<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    queue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mutex<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    fill<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> consumer <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">{<!-- --></span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    fill<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mutex<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"consumer:"</span> <span class="token operator">+</span> queue<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mutex<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    empty<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Thread</span> <span class="token class-name">ThreadProducer</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">producer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> <span class="token class-name">ThreadConsumer</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">consumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ThreadProducer</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ThreadConsumer</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Producer_Consumer_Semaphore</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        producer_consumer_semaphore_Test producerConsumerSemaphore <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">producer_consumer_semaphore_Test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        producerConsumerSemaphore<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="24_CountDownLatch_143">
     </a>
     2.4 CountDownLatch
    </h3>
    <p>
     同时等待 N 个任务执行结束
    </p>
    <pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Random</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">CountDownLatch</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
        <span class="token comment">//一共十个任务</span>
        <span class="token class-name">CountDownLatch</span> latch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> n <span class="token operator">=</span> i<span class="token punctuation">;</span>
            <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Random</span> random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> time <span class="token operator">=</span> <span class="token punctuation">(</span>random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"线程："</span> <span class="token operator">+</span> n <span class="token operator">+</span> <span class="token string">"开始执行"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"线程："</span> <span class="token operator">+</span> n <span class="token operator">+</span> <span class="token string">"执行完毕"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//相当于count--</span>
                latch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//等待count减为0</span>
        <span class="token comment">//await方法无参数就是死等</span>
        <span class="token comment">//有参数可以传入时间</span>
        latch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"所有线程执行完毕"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h2>
     <a id="_180">
     </a>
     三.线程安全的集合类
    </h2>
    <p>
     我们学过的大多数集合类时=是线程不安全的，线程安全的只有Stack，Vector，Hashtable这三个。但是这三个缺点很明显，一旦实例出对象，无论在单线程还是多线程环境下，所进行的操作都需要加锁和解锁，这就严重降低了性能。那么，如何保证线程安全的同时又保证性能不受到严重影响，我总结出以下几点。
    </p>
    <h3>
     <a id="31ArrayList_182">
     </a>
     3.1多线程环境使用ArrayList
    </h3>
    <p>
     (1)使用ArrayList进行增删查改的时候手动加锁(synchronized)，这个方式很好理解，这里就不过多赘述。
    </p>
    <pre><code class="prism language-java"><span class="token keyword">synchronized</span><span class="token punctuation">(</span>锁对象<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	arrayList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>元素<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     (2)Collections.synchronizedList(new ArrayList)
     <br/>
     该方法可以将List接口的实现类从线程不安全转换为线程安全，例如下面的代码：
    </p>
    <pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//实例化普通的顺序表</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> array <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//将array转换为线程安全的safeArray</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> safeArray <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">synchronizedList</span><span class="token punctuation">(</span>array<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     因为读写操作都进行了加锁，所以
     <strong>
      适用于读和写操作频率相对均衡的场景
     </strong>
     <br/>
     (3)CopyOnWriteArrayList
     <br/>
     CopyOnWrite的意思是：写时拷贝
     <br/>
     学到现在，我们知道触发线程安全问题需要多线程对同一个共享变量进行"写"操作，而并发"读"操作是线程安全的
     <br/>
     通过CopyOnWriteArrayList实例化出来的对象在进行读操作时不会加锁，当进行增删查改等写操作时会在原数组基础上拷贝一个副本，在副本上进行写操作，执行完毕后修改引用指向副本
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/c8ba224d1e174ed799945a826dc36a13.png#pic_center">
      <br/>
      读操作没有额外开销，但频繁地写操作会频繁地拷贝数组，不加锁的本意是节省加锁和解锁的开销，但如果拷贝的开销都大于加锁解锁那就得不偿失了，所以CopyOnWriteArrayList
      <strong>
       适用于读多写少的环境
      </strong>
     </img>
    </p>
    <h3>
     <a id="32_210">
     </a>
     3.2多线程环境使用队列
    </h3>
    <p>
     1.使用队列进行增删查改的时候手动加锁(synchronized)
     <br/>
     2.BlockingQueue阻塞队列
    </p>
    <h3>
     <a id="33_213">
     </a>
     3.3多线程环境使用哈希表
    </h3>
    <p>
     HashMap线程不安全，Hashtable性能不行，Java标准库就引入ConcurrentHashMap，下面来讲讲ConcurrentHashMap到底做出了哪些优化
     <br/>
     <strong>
      (1)缩小锁的粒度
     </strong>
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/4eb02bf9f25d461d8f4ae58fc29846b8.png#pic_center">
      <br/>
      基于以上的问题，ConcurrentHashMap缩小了锁的粒度
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/24b6c9b419fb49bd9a575902ade69037.png#pic_center">
       <br/>
       <strong>
        (2)合理使用CAS
       </strong>
       <br/>
       哈希表的增加/删除元素的操作会让useSize++/–，这个自增/自减操作就可以使用CAS来代替
       <br/>
       <strong>
        (3)针对扩容进行优化
       </strong>
       <br/>
       当负载因子&gt;0.75(默认情况下)时，会把哈希表扩容为原来的2倍，这涉及到两个操作。第一步，创建一个2倍大的哈希表；第二部，将原哈希表上面的元素重新哈希到新的表上，当元素过多时，这一步会非常耗时。
       <br/>
       因为哈希表的
       <strong>
        增删查改操作的时间复杂度理论上是O(1)
       </strong>
       ，这样的速度是十分快的，假如此时一共有一千万个元素，如果插入某一元素时触发扩容操作，那么这一次插入操作就非常耗时。站在用户层面，大部分时间运行流程，但时不时就非常卡顿，这不利于用户的体验。
      </img>
     </img>
    </p>
    <p>
     所以，针对扩容操作，ConcurrentHashMap采用的是
     <strong>
      分布扩容
     </strong>
     的方式。(这里的数据都是假设而已，理解思想即可)
     <br/>
     例如，要对拥有一千万元素的哈希表进行扩容，每一次增删查改操作都只重新哈希一万个元素，进行一千次操作就扩容完毕了。
    </p>
    <p>
     那么这会不会导致哈希表一直在扩容的路上？
     <br/>
     答案是：不会，因为分布扩容总共进行一千次就完毕了，而触发一次扩容操作则需要百万数量级的数据，这显然是低频的。
     <br/>
     当进行分布扩容时，此时存在旧/新两张哈希表，那么这个时候的增删查改操作就怎么进行的？
     <br/>
     增加：直接添加到新表
     <br/>
     删除：将旧/新表的目标元素都删除
     <br/>
     修改：通常发生在旧表
     <br/>
     查询：旧/新表的进行查询
    </p>
    <h2>
     <a id="_235">
     </a>
     四.小结
    </h2>
    <p>
     线程安全问题介绍到这里就差不多了，从下节开始进入文件IO的学习
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f:672e6373646e2e6e65742f323430315f38393136373938352f:61727469636c652f64657461696c732f313436323637393930" class_="artid" style="display:none">
 </p>
</div>


