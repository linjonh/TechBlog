---
layout: post
title: "FreeSWITCH-简单图形化界面40-使用mod_curl模块进行http请求"
date: 2025-03-07 23:47:51 +0800
description: "mod_curl是 FreeSWITCH 的一个强大模块，它允许用户通过 HTTP 请求与外部服务进行交互，从而实现数据的获取和提交。无论是简单的 GET 请求，还是复杂的 POST 请求和文件传输，mod_curl都能轻松应对。"
keywords: "FreeSWITCH 简单图形化界面40 - 使用mod_curl模块进行http请求"
categories: ['Ippbx', 'Freeswitch', 'Freeswitch']
tags: ['Voip', 'Sip', 'Python', 'Http', 'Freeswitch']
artid: "146107608"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146107608
    alt: "FreeSWITCH-简单图形化界面40-使用mod_curl模块进行http请求"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146107608
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146107608
cover: https://bing.ee123.net/img/rand?artid=146107608
image: https://bing.ee123.net/img/rand?artid=146107608
img: https://bing.ee123.net/img/rand?artid=146107608
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     FreeSWITCH 简单图形化界面40 - 使用mod_curl模块进行http请求
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="./../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="./../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <p>
    </p>
    <hr/>
    <h2>
     <a id="0_3">
     </a>
     0、界面预览
    </h2>
    <p>
     <a href="http://210.51.10.231:8020/" rel="nofollow">
      http://myfs.f3322.net:8020/
     </a>
     <br/>
     用户名：admin，密码：admin
    </p>
    <p>
     FreeSWITCH界面安装参考：
     <a href="https://blog.csdn.net/jia198810/article/details/137820796">
      https://blog.csdn.net/jia198810/article/details/137820796
     </a>
    </p>
    <h2>
     <a id="00_10">
     </a>
     00、简介
    </h2>
    <p>
     <code>
      mod_curl
     </code>
     是 FreeSWITCH 的一个强大模块，它允许用户通过 HTTP 请求与外部服务进行交互，从而实现数据的获取和提交。无论是简单的 GET 请求，还是复杂的 POST 请求和文件传输，
     <code>
      mod_curl
     </code>
     都能轻松应对。
    </p>
    <h2>
     <a id="1_14">
     </a>
     1、编译安装
    </h2>
    <p>
     在使用
     <code>
      mod_curl
     </code>
     之前，需要确保该模块已正确编译并加载到 FreeSWITCH 中。以下是详细的编译和安装步骤：
    </p>
    <h3>
     <a id="11__18">
     </a>
     1.1 编辑模块配置文件
    </h3>
    <ol>
     <li>
      打开 FreeSWITCH 源代码目录下的
      <code>
       modules.conf
      </code>
      文件，找到以下行并取消注释：
     </li>
    </ol>
    <pre><code class="prism language-bash">   <span class="token comment">#applications/mod_curl</span>
</code></pre>
    <p>
     保存文件并退出。
    </p>
    <ol start="2">
     <li>
      重新编译 FreeSWITCH
     </li>
    </ol>
    <p>
     在终端中执行以下命令，重新编译 FreeSWITCH：
    </p>
    <pre><code class="prism language-bash">   <span class="token function">make</span>
   <span class="token function">make</span> <span class="token function">install</span>
</code></pre>
    <ol start="3">
     <li>
      加载模块
     </li>
    </ol>
    <p>
     编辑 FreeSWITCH 的模块加载配置文件
     <code>
      modules.conf.xml
     </code>
     （路劲为
     <code>
      /usr/local/freeswitch/conf/autoload_configs
     </code>
     ），添加以下内容：
    </p>
    <pre><code class="prism language-xml">   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>load</span> <span class="token attr-name">module</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mod_curl<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre>
    <p>
     保存文件后，重新加载 FreeSWITCH 以使模块生效。
    </p>
    <ol start="4">
     <li>
      验证模块加载
     </li>
    </ol>
    <p>
     启动 FreeSWITCH 并进入 CLI，执行以下命令以验证
     <code>
      mod_curl
     </code>
     是否已正确加载：
    </p>
    <pre><code class="prism language-bash">   module_exists mod_curl
</code></pre>
    <p>
     如果返回
     <code>
      true
     </code>
     ，则表示模块加载成功。
    </p>
    <h2>
     <a id="2_57">
     </a>
     2、使用
    </h2>
    <h3>
     <a id="21__58">
     </a>
     2.1 拨号规则
    </h3>
    <p>
     <code>
      mod_curl
     </code>
     提供了两种主要的应用方式：
     <code>
      curl
     </code>
     和
     <code>
      curl_sendfile
     </code>
     （不常用）。
     <br/>
     在拨号规则中，可以通过以下方式调用
     <code>
      curl
     </code>
     应用：
    </p>
    <pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>curl<span class="token punctuation">"</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://example.com/api?param=value<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre>
    <p>
     curl应用的请求，会生成两个通道变量 curl_response_data 和curl_response_code，可以使用${}获取。
    </p>
    <h4>
     <a id="GET__67">
     </a>
     GET 请求
    </h4>
    <p>
     通过 URL 参数发送 GET 请求：
    </p>
    <pre><code class="prism language-xml">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>curl<span class="token punctuation">"</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://example.com/api?param=value<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre>
    <h4>
     <a id="POST__75">
     </a>
     POST 请求
    </h4>
    <p>
     发送 POST 请求并携带数据：
    </p>
    <pre><code class="prism language-xml">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>curl<span class="token punctuation">"</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://example.com/api post param=value<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre>
    <h4>
     <a id="JSON__85">
     </a>
     JSON 数据
    </h4>
    <p>
     发送 JSON 格式的数据：
    </p>
    <pre><code class="prism language-xml">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">application</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>curl<span class="token punctuation">"</span></span> <span class="token attr-name">data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://example.com/api content-type application/json post {\<span class="token punctuation">"</span></span><span class="token attr-name"><span class="token namespace">key\":</span>\"value\"}"</span><span class="token punctuation">/&gt;</span></span>
</code></pre>
    <h3>
     <a id="22_Lua__93">
     </a>
     2.2 Lua 脚本
    </h3>
    <p>
     <code>
      mod_curl
     </code>
     也可以在 Lua 脚本中使用，通过 FreeSWITCH 的 API 接口调用 HTTP 请求。
    </p>
    <h4>
     <a id="GET__97">
     </a>
     GET 请求
    </h4>
    <p>
     在 Lua 脚本中发起 GET 请求的示例如下：
    </p>
    <pre><code class="prism language-lua"><span class="token keyword">local</span> api <span class="token operator">=</span> freeswitch<span class="token punctuation">.</span><span class="token function">API</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">local</span> url <span class="token operator">=</span> <span class="token string">"http://example.com/api?param=value"</span>
<span class="token keyword">local</span> response <span class="token operator">=</span> api<span class="token punctuation">:</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token string">"curl"</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span>

freeswitch<span class="token punctuation">.</span><span class="token function">consoleLog</span><span class="token punctuation">(</span><span class="token string">"INFO"</span><span class="token punctuation">,</span> <span class="token string">"Response: "</span> <span class="token operator">..</span> response <span class="token operator">..</span> <span class="token string">"\n"</span><span class="token punctuation">)</span>
</code></pre>
    <h4>
     <a id="POST__111">
     </a>
     POST 请求
    </h4>
    <p>
     发送 POST 请求的示例如下：
    </p>
    <pre><code class="prism language-lua"><span class="token keyword">local</span> api <span class="token operator">=</span> freeswitch<span class="token punctuation">.</span><span class="token function">API</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">local</span> url <span class="token operator">=</span> <span class="token string">"http://example.com/api"</span>
<span class="token keyword">local</span> data <span class="token operator">=</span> <span class="token string">"param=value"</span>
<span class="token keyword">local</span> response <span class="token operator">=</span> api<span class="token punctuation">:</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token string">"curl"</span><span class="token punctuation">,</span> url <span class="token operator">..</span> <span class="token string">" post "</span> <span class="token operator">..</span> data<span class="token punctuation">)</span>

freeswitch<span class="token punctuation">.</span><span class="token function">consoleLog</span><span class="token punctuation">(</span><span class="token string">"INFO"</span><span class="token punctuation">,</span> <span class="token string">"Response: "</span> <span class="token operator">..</span> response <span class="token operator">..</span> <span class="token string">"\n"</span><span class="token punctuation">)</span>
</code></pre>
    <h4>
     <a id="JSON__124">
     </a>
     JSON 数据
    </h4>
    <p>
     发送 JSON 格式数据的示例如下：
    </p>
    <pre><code class="prism language-lua"><span class="token keyword">local</span> api <span class="token operator">=</span> freeswitch<span class="token punctuation">.</span><span class="token function">API</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">local</span> url <span class="token operator">=</span> <span class="token string">"http://example.com/api"</span>
<span class="token keyword">local</span> json_data <span class="token operator">=</span> <span class="token string">"{ \"key\": \"value\" }"</span>
<span class="token keyword">local</span> response <span class="token operator">=</span> api<span class="token punctuation">:</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token string">"curl"</span><span class="token punctuation">,</span> url <span class="token operator">..</span> <span class="token string">" content-type application/json post "</span> <span class="token operator">..</span> json_data<span class="token punctuation">)</span>

freeswitch<span class="token punctuation">.</span><span class="token function">consoleLog</span><span class="token punctuation">(</span><span class="token string">"INFO"</span><span class="token punctuation">,</span> <span class="token string">"Response: "</span> <span class="token operator">..</span> response <span class="token operator">..</span> <span class="token string">"\n"</span><span class="token punctuation">)</span>
</code></pre>
    <h2>
     <a id="3__138">
     </a>
     3 、示例
    </h2>
    <h3>
     <a id="31__1_CDR__140">
     </a>
     3.1 示例 1：提交 CDR 到第三方接口
    </h3>
    <p>
     在呼叫结束后，将通话详情记录（CDR）提交到第三方接口。以下是 Lua 脚本的实现示例：
    </p>
    <pre><code class="prism language-lua"><span class="token comment">#!/usr/bin/env lua</span>
<span class="token comment">-- upload_cdr.lua</span>
<span class="token comment">-- 2024年6月29日</span>
<span class="token comment">-- 提交话单信息到第三方接口</span>
<span class="token comment">-- 拨号规则，提前设置挂机回调</span>
<span class="token comment">-- session:execute("set", string.format("api_hangup_hook=lua upload_cdr.lua")</span>

<span class="token comment">-- 序列化并打印env对象的所有通话信息,调试专用</span>
<span class="token comment">-- local call_info = env:serialize()</span>
<span class="token comment">-- freeswitch.consoleLog("INFO", "所有通话信息:\n" .. call_info)</span>
<span class="token keyword">local</span> mobile <span class="token operator">=</span> env<span class="token punctuation">:</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">"destination_number"</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token string">""</span>
<span class="token keyword">local</span> caller_ani <span class="token operator">=</span> env<span class="token punctuation">:</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">"Caller-ANI"</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token string">""</span>
<span class="token keyword">local</span> sip_account <span class="token operator">=</span> env<span class="token punctuation">:</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">"sip_from_user"</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token string">""</span>
<span class="token keyword">local</span> start_time <span class="token operator">=</span> env<span class="token punctuation">:</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">"start_stamp"</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token string">""</span>
<span class="token comment">-- local start_time = env:getHeader("answer_stamp") or ""</span>
<span class="token keyword">local</span> end_time <span class="token operator">=</span> env<span class="token punctuation">:</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">"end_stamp"</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token string">""</span>
<span class="token keyword">local</span> use_time_length <span class="token operator">=</span> env<span class="token punctuation">:</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">"billsec"</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token string">"0"</span>
<span class="token keyword">local</span> order_no <span class="token operator">=</span> string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"freeSWITCH%s%s"</span><span class="token punctuation">,</span> sip_account<span class="token punctuation">,</span> mobile<span class="token punctuation">)</span>
<span class="token keyword">local</span> mobile_hangup_api <span class="token operator">=</span> env<span class="token punctuation">:</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">"mobile_hangup_api"</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token string">""</span>
<span class="token keyword">local</span> api_timeout <span class="token operator">=</span> env<span class="token punctuation">:</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">"api_timeout"</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token string">"3"</span>

<span class="token comment">-- 打印详细信息，确保变量不为空</span>
<span class="token keyword">if</span> sip_account <span class="token operator">==</span> mobile <span class="token keyword">then</span>
    freeswitch<span class="token punctuation">.</span><span class="token function">consoleLog</span><span class="token punctuation">(</span><span class="token string">"INFO"</span><span class="token punctuation">,</span> <span class="token string">"异常呼叫主叫=被叫,再次获取SIP账号为 : "</span> <span class="token operator">..</span> caller_ani <span class="token operator">..</span> <span class="token string">"\n"</span><span class="token punctuation">)</span>
    sip_account <span class="token operator">=</span> caller_ani
<span class="token keyword">end</span>
freeswitch<span class="token punctuation">.</span><span class="token function">consoleLog</span><span class="token punctuation">(</span><span class="token string">"INFO"</span><span class="token punctuation">,</span> <span class="token string">"CallerANI    : "</span> <span class="token operator">..</span> caller_ani <span class="token operator">..</span> <span class="token string">"\n"</span><span class="token punctuation">)</span>
freeswitch<span class="token punctuation">.</span><span class="token function">consoleLog</span><span class="token punctuation">(</span><span class="token string">"INFO"</span><span class="token punctuation">,</span> <span class="token string">"SIP账号      : "</span> <span class="token operator">..</span> sip_account <span class="token operator">..</span> <span class="token string">"\n"</span><span class="token punctuation">)</span>
freeswitch<span class="token punctuation">.</span><span class="token function">consoleLog</span><span class="token punctuation">(</span><span class="token string">"INFO"</span><span class="token punctuation">,</span> <span class="token string">"被叫号码     : "</span> <span class="token operator">..</span> mobile <span class="token operator">..</span> <span class="token string">"\n"</span><span class="token punctuation">)</span>
freeswitch<span class="token punctuation">.</span><span class="token function">consoleLog</span><span class="token punctuation">(</span><span class="token string">"INFO"</span><span class="token punctuation">,</span> <span class="token string">"开始时间     : "</span> <span class="token operator">..</span> start_time <span class="token operator">..</span> <span class="token string">"\n"</span><span class="token punctuation">)</span>
freeswitch<span class="token punctuation">.</span><span class="token function">consoleLog</span><span class="token punctuation">(</span><span class="token string">"INFO"</span><span class="token punctuation">,</span> <span class="token string">"结束时间     : "</span> <span class="token operator">..</span> end_time <span class="token operator">..</span> <span class="token string">"\n"</span><span class="token punctuation">)</span>
freeswitch<span class="token punctuation">.</span><span class="token function">consoleLog</span><span class="token punctuation">(</span><span class="token string">"INFO"</span><span class="token punctuation">,</span> <span class="token string">"通话时长     : "</span> <span class="token operator">..</span> use_time_length <span class="token operator">..</span> <span class="token string">"\n"</span><span class="token punctuation">)</span>
freeswitch<span class="token punctuation">.</span><span class="token function">consoleLog</span><span class="token punctuation">(</span><span class="token string">"INFO"</span><span class="token punctuation">,</span> <span class="token string">"订单号       : "</span> <span class="token operator">..</span> order_no <span class="token operator">..</span> <span class="token string">"\n"</span><span class="token punctuation">)</span>
freeswitch<span class="token punctuation">.</span><span class="token function">consoleLog</span><span class="token punctuation">(</span><span class="token string">"INFO"</span><span class="token punctuation">,</span> <span class="token string">"CDR推送接口  : "</span> <span class="token operator">..</span> mobile_hangup_api <span class="token operator">..</span> <span class="token string">"\n"</span><span class="token punctuation">)</span>
freeswitch<span class="token punctuation">.</span><span class="token function">consoleLog</span><span class="token punctuation">(</span><span class="token string">"INFO"</span><span class="token punctuation">,</span> <span class="token string">"接口超时时间  : "</span> <span class="token operator">..</span> api_timeout <span class="token operator">..</span> <span class="token string">"\n"</span><span class="token punctuation">)</span>

<span class="token comment">-- 准备执行命令</span>
<span class="token keyword">local</span> api <span class="token operator">=</span> freeswitch<span class="token punctuation">.</span><span class="token function">API</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">--[[
-- 使用python提交
local cmd = string.format(
    "/usr/local/python310/bin/python /usr/local/freeswitch/scripts/upload_cdr.py '%s' '%s' '%s' '%s' '%s' '%s' '%s'",
    mobile, sip_account, start_time, end_time, use_time_length, order_no, mobile_hangup_api)
local response = api:execute("bg_system", cmd)
]]</span>

<span class="token comment">-- 使用curl提交</span>
<span class="token keyword">local</span> cmd <span class="token operator">=</span> string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>
    <span class="token string">"%s connect-timeout %s timeout %s post mobile=%s&amp;sip_account=%s&amp;start_time='%s'&amp;end_time='%s'&amp;use_time_length=%s&amp;order_no=%s"</span><span class="token punctuation">,</span>
    mobile_hangup_api<span class="token punctuation">,</span> api_timeout<span class="token punctuation">,</span> api_timeout<span class="token punctuation">,</span> mobile<span class="token punctuation">,</span> sip_account<span class="token punctuation">,</span> start_time<span class="token punctuation">,</span> end_time<span class="token punctuation">,</span> use_time_length<span class="token punctuation">,</span> order_no<span class="token punctuation">)</span>
freeswitch<span class="token punctuation">.</span><span class="token function">consoleLog</span><span class="token punctuation">(</span><span class="token string">"INFO"</span><span class="token punctuation">,</span> <span class="token string">"推送命令: "</span> <span class="token operator">..</span> cmd <span class="token operator">..</span> <span class="token string">"\n"</span><span class="token punctuation">)</span>
<span class="token keyword">local</span> response <span class="token operator">=</span> api<span class="token punctuation">:</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token string">"curl"</span><span class="token punctuation">,</span> cmd<span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>response <span class="token operator">==</span> <span class="token string">""</span><span class="token punctuation">)</span> <span class="token keyword">then</span>
    freeswitch<span class="token punctuation">.</span><span class="token function">consoleLog</span><span class="token punctuation">(</span><span class="token string">"INFO"</span><span class="token punctuation">,</span> <span class="token string">"推送结果: 无响应,可能连接接口失败!"</span><span class="token punctuation">)</span>
<span class="token keyword">else</span>
    freeswitch<span class="token punctuation">.</span><span class="token function">consoleLog</span><span class="token punctuation">(</span><span class="token string">"INFO"</span><span class="token punctuation">,</span> <span class="token string">"推送结果: "</span> <span class="token operator">..</span> response <span class="token operator">..</span> <span class="token string">"\n"</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>

</code></pre>
    <h3>
     <a id="32__2_206">
     </a>
     3.2 示例 2：提交外呼状态到第三方接口
    </h3>
    <p>
     在外呼结束后，将外呼状态提交到第三方接口。以下是 Lua 脚本的实现示例：
    </p>
    <pre><code class="prism language-lua"><span class="token comment">#!/usr/bin/env lua</span>
<span class="token comment">-- handle-callout-result.lua</span>
<span class="token comment">-- 2025年2月26日</span>
<span class="token comment">-- 处理外呼结果 </span>
<span class="token comment">-- 外呼api设置挂机回调。originate {origination_caller_id_number=300,orgination_caller_id_name=outcall,api_hangup_hook='lua handle-callout-result.lua'}sofia/gateway/gw01/172xxxx2122 401 xml Local-Extensions </span>

<span class="token comment">-- local env</span>
<span class="token comment">-- local freeswitch</span>

<span class="token keyword">local</span> call_info <span class="token operator">=</span> env<span class="token punctuation">:</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">-- -- 序列化并打印env对象的所有通话信息,调试专用</span>
<span class="token comment">-- freeswitch.consoleLog("INFO", "所有通话信息:\n" .. call_info)</span>

<span class="token comment">-- 开始时间</span>
<span class="token keyword">local</span> start_time <span class="token operator">=</span> env<span class="token punctuation">:</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">"start_stamp"</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token string">""</span>

<span class="token comment">-- 结束时间</span>
<span class="token keyword">local</span> end_time <span class="token operator">=</span> env<span class="token punctuation">:</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">"end_stamp"</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token string">""</span>

<span class="token comment">-- 通话时间</span>
<span class="token keyword">local</span> duration <span class="token operator">=</span> env<span class="token punctuation">:</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">"billsec"</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token string">"0"</span>

<span class="token comment">-- SIP中继名称</span>
<span class="token keyword">local</span> trunk_name <span class="token operator">=</span> env<span class="token punctuation">:</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">"trunk_name"</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token string">""</span>

<span class="token comment">-- 被叫号码</span>
<span class="token keyword">local</span> destination_number <span class="token operator">=</span> env<span class="token punctuation">:</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">"destination_number"</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token string">""</span>

<span class="token comment">-- 本地号码</span>
<span class="token keyword">local</span> local_number <span class="token operator">=</span> env<span class="token punctuation">:</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">"rdnis"</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token string">""</span>

<span class="token comment">-- 备用被叫号码</span>
<span class="token keyword">local</span> sip_to_user <span class="token operator">=</span> env<span class="token punctuation">:</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">"sip_to_user"</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token string">""</span>

<span class="token comment">-- 呼出主叫号码</span>
<span class="token keyword">local</span> outgoing_caller_id_number <span class="token operator">=</span> env<span class="token punctuation">:</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">"origination_caller_id_number"</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token string">""</span>

<span class="token comment">-- answer api</span>
<span class="token keyword">local</span> answer_api <span class="token operator">=</span> env<span class="token punctuation">:</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">"answer_api"</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token string">""</span>

<span class="token comment">-- no_answer api</span>
<span class="token keyword">local</span> no_answer_api <span class="token operator">=</span> env<span class="token punctuation">:</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">"no_answer_api"</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token string">""</span>

<span class="token comment">-- api 超时时间</span>
<span class="token keyword">local</span> api_timeout <span class="token operator">=</span> <span class="token number">3</span>

<span class="token comment">-- 通话结果</span>
<span class="token keyword">local</span> hangup_cause <span class="token operator">=</span> env<span class="token punctuation">:</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">"hangup_cause"</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token string">""</span>

<span class="token comment">-- 是否检查主叫号码被占用</span>
<span class="token keyword">local</span> check_number_in_use <span class="token operator">=</span> env<span class="token punctuation">:</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">"check_number_in_use"</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token string">"false"</span>

<span class="token keyword">local</span> response
<span class="token keyword">local</span> result
<span class="token keyword">local</span> temp_string

<span class="token comment">-- 打印详细信息，确保变量不为空</span>
<span class="token keyword">if</span> destination_number <span class="token operator">==</span> <span class="token string">""</span> <span class="token keyword">then</span>
    freeswitch<span class="token punctuation">.</span><span class="token function">consoleLog</span><span class="token punctuation">(</span><span class="token string">"INFO"</span><span class="token punctuation">,</span> string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"# destination_number未空,使用sip_to_user的值%s\n"</span><span class="token punctuation">,</span>sip_to_user<span class="token punctuation">)</span><span class="token punctuation">)</span>
    destination_number <span class="token operator">=</span> sip_to_user
<span class="token keyword">end</span>
freeswitch<span class="token punctuation">.</span><span class="token function">consoleLog</span><span class="token punctuation">(</span><span class="token string">"INFO"</span><span class="token punctuation">,</span> <span class="token string">"# ==============API接口外呼挂机处理============= \n"</span><span class="token punctuation">)</span>

freeswitch<span class="token punctuation">.</span><span class="token function">consoleLog</span><span class="token punctuation">(</span><span class="token string">"INFO"</span><span class="token punctuation">,</span> <span class="token string">"# ------------------外呼呼叫信息---------------- \n"</span><span class="token punctuation">)</span>
freeswitch<span class="token punctuation">.</span><span class="token function">consoleLog</span><span class="token punctuation">(</span><span class="token string">"INFO"</span><span class="token punctuation">,</span> <span class="token string">"# 开始时间  : "</span> <span class="token operator">..</span> start_time <span class="token operator">..</span> <span class="token string">"\n"</span><span class="token punctuation">)</span>
freeswitch<span class="token punctuation">.</span><span class="token function">consoleLog</span><span class="token punctuation">(</span><span class="token string">"INFO"</span><span class="token punctuation">,</span> <span class="token string">"# 结束时间  : "</span> <span class="token operator">..</span> end_time <span class="token operator">..</span> <span class="token string">"\n"</span><span class="token punctuation">)</span>
freeswitch<span class="token punctuation">.</span><span class="token function">consoleLog</span><span class="token punctuation">(</span><span class="token string">"INFO"</span><span class="token punctuation">,</span> <span class="token string">"# 通话时长  : "</span> <span class="token operator">..</span> duration <span class="token operator">..</span> <span class="token string">"\n"</span><span class="token punctuation">)</span>
freeswitch<span class="token punctuation">.</span><span class="token function">consoleLog</span><span class="token punctuation">(</span><span class="token string">"INFO"</span><span class="token punctuation">,</span> <span class="token string">"# 外呼号码  : "</span> <span class="token operator">..</span> destination_number <span class="token operator">..</span> <span class="token string">"\n"</span><span class="token punctuation">)</span>
freeswitch<span class="token punctuation">.</span><span class="token function">consoleLog</span><span class="token punctuation">(</span><span class="token string">"INFO"</span><span class="token punctuation">,</span> <span class="token string">"# 本地号码  : "</span> <span class="token operator">..</span> local_number <span class="token operator">..</span> <span class="token string">"\n"</span><span class="token punctuation">)</span>
freeswitch<span class="token punctuation">.</span><span class="token function">consoleLog</span><span class="token punctuation">(</span><span class="token string">"INFO"</span><span class="token punctuation">,</span> <span class="token string">"# 呼出主叫  : "</span> <span class="token operator">..</span> outgoing_caller_id_number <span class="token operator">..</span> <span class="token string">"\n"</span><span class="token punctuation">)</span>
freeswitch<span class="token punctuation">.</span><span class="token function">consoleLog</span><span class="token punctuation">(</span><span class="token string">"INFO"</span><span class="token punctuation">,</span> <span class="token string">"# 挂机接口  : "</span> <span class="token operator">..</span> no_answer_api <span class="token operator">..</span> <span class="token string">"\n"</span><span class="token punctuation">)</span>
freeswitch<span class="token punctuation">.</span><span class="token function">consoleLog</span><span class="token punctuation">(</span><span class="token string">"INFO"</span><span class="token punctuation">,</span> <span class="token string">"# ---------------------------------------------\n\n"</span><span class="token punctuation">)</span>

<span class="token comment">-- 执行fs api命令</span>
<span class="token keyword">local</span> api <span class="token operator">=</span> freeswitch<span class="token punctuation">.</span><span class="token function">API</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 应答提交api，在401 xml Local-Extensions中。</span>
<span class="token comment">-- if (hangup_cause == "ANSWER" or hangup_cause == "NORMAL_CLEARING") then</span>
<span class="token comment">--     -- 呼叫应答提交</span>
<span class="token comment">--     freeswitch.consoleLog("INFO", "# 呼叫结果  : 呼叫已经应答,推送应答接口\n")</span>
<span class="token comment">--     if (answer_api == "") then</span>
<span class="token comment">--         freeswitch.consoleLog("INFO", "# 推送结果  : 应答接口为空,不提交!\n")</span>
<span class="token comment">--         return</span>
<span class="token comment">--     else</span>
<span class="token comment">--         -- 提交无应答结果</span>
<span class="token comment">--         temp_string = string.format(</span>
<span class="token comment">--             "%s connect-timeout %s timeout %s post destination_number=%s",</span>
<span class="token comment">--             no_answer_api, api_timeout, api_timeout, destination_number)</span>
<span class="token comment">--         freeswitch.consoleLog("INFO", string.format("# 推送结果  : 请求地址:%s\n",temp_string))</span>

<span class="token comment">--         -- 执行推送</span>
<span class="token comment">--         response = api:execute("curl",temp_string)</span>
<span class="token comment">--         if (response == "") then</span>
<span class="token comment">--             freeswitch.consoleLog("INFO", "# 推送结果  : 接口无响应,可能连接接口失败!\n")</span>
<span class="token comment">--         else</span>
<span class="token comment">--             freeswitch.consoleLog("INFO", "# 推送结果  : " .. response .. "\n")</span>
<span class="token comment">--         end</span>
<span class="token comment">--     end</span>

freeswitch<span class="token punctuation">.</span><span class="token function">consoleLog</span><span class="token punctuation">(</span><span class="token string">"INFO"</span><span class="token punctuation">,</span> <span class="token string">"# ----------------外呼挂机处理-----------------\n"</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>hangup_cause  <span class="token operator">==</span> <span class="token string">"BUSY"</span> <span class="token keyword">or</span> hangup_cause <span class="token operator">==</span> <span class="token string">"USER_BUSY"</span> <span class="token keyword">or</span> hangup_cause <span class="token operator">==</span> <span class="token string">"NO_USER_RESPONSE"</span> <span class="token keyword">or</span> hangup_cause <span class="token operator">==</span> <span class="token string">"NO_ROUTE_DESTINATION"</span> <span class="token keyword">or</span>  hangup_cause <span class="token operator">==</span> <span class="token string">"CALL_REJECTED"</span> <span class="token keyword">or</span> hangup_cause <span class="token operator">==</span> <span class="token string">"NO_ANSWER"</span><span class="token punctuation">)</span> <span class="token keyword">then</span>
    freeswitch<span class="token punctuation">.</span><span class="token function">consoleLog</span><span class="token punctuation">(</span><span class="token string">"INFO"</span><span class="token punctuation">,</span> <span class="token string">"# 挂机结果  : "</span> <span class="token operator">..</span> hangup_cause <span class="token operator">..</span> <span class="token string">"\n"</span><span class="token punctuation">)</span>
    <span class="token comment">-- 呼叫未应答提交</span>
    freeswitch<span class="token punctuation">.</span><span class="token function">consoleLog</span><span class="token punctuation">(</span><span class="token string">"INFO"</span><span class="token punctuation">,</span> <span class="token string">"# 呼叫结果  : 呼叫未应答,推送未应答接口\n"</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>no_answer_api <span class="token operator">==</span> <span class="token string">""</span><span class="token punctuation">)</span> <span class="token keyword">then</span>
        freeswitch<span class="token punctuation">.</span><span class="token function">consoleLog</span><span class="token punctuation">(</span><span class="token string">"INFO"</span><span class="token punctuation">,</span> <span class="token string">"# 推送结果  : 未应答接口为空,不提交!\n"</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token keyword">else</span>
        <span class="token comment">-- 提交无应答结果</span>
        temp_string <span class="token operator">=</span> string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>
            <span class="token string">"%s content-type application/json connect-timeout %s timeout %s post {\"destination_number\":\"%s\"}"</span><span class="token punctuation">,</span>
            no_answer_api<span class="token punctuation">,</span> api_timeout<span class="token punctuation">,</span> api_timeout<span class="token punctuation">,</span> destination_number<span class="token punctuation">)</span>
        freeswitch<span class="token punctuation">.</span><span class="token function">consoleLog</span><span class="token punctuation">(</span><span class="token string">"INFO"</span><span class="token punctuation">,</span> string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"# 推送结果  : 请求地址:%s\n"</span><span class="token punctuation">,</span>temp_string<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment">-- 执行推送</span>
        response <span class="token operator">=</span> api<span class="token punctuation">:</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token string">"curl"</span><span class="token punctuation">,</span> temp_string<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>response <span class="token operator">==</span> <span class="token string">""</span><span class="token punctuation">)</span> <span class="token keyword">then</span>
            freeswitch<span class="token punctuation">.</span><span class="token function">consoleLog</span><span class="token punctuation">(</span><span class="token string">"INFO"</span><span class="token punctuation">,</span> <span class="token string">"# 推送结果  : 接口无响应,可能连接接口失败!\n"</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span>
            freeswitch<span class="token punctuation">.</span><span class="token function">consoleLog</span><span class="token punctuation">(</span><span class="token string">"INFO"</span><span class="token punctuation">,</span> <span class="token string">"# 推送结果  : "</span><span class="token operator">..</span> response<span class="token operator">..</span> <span class="token string">"\n"</span><span class="token punctuation">)</span>
        <span class="token keyword">end</span>
    <span class="token keyword">end</span>
<span class="token keyword">elseif</span> <span class="token punctuation">(</span>hangup_cause  <span class="token operator">==</span> <span class="token string">"NORMAL_CLEARING"</span><span class="token punctuation">)</span> <span class="token keyword">then</span>
    freeswitch<span class="token punctuation">.</span><span class="token function">consoleLog</span><span class="token punctuation">(</span><span class="token string">"INFO"</span><span class="token punctuation">,</span> <span class="token string">"# 挂机结果   : "</span> <span class="token operator">..</span> hangup_cause <span class="token operator">..</span> <span class="token string">"\n"</span><span class="token punctuation">)</span>
    freeswitch<span class="token punctuation">.</span><span class="token function">consoleLog</span><span class="token punctuation">(</span><span class="token string">"INFO"</span><span class="token punctuation">,</span> <span class="token string">"# 挂机结果   : 通话正常挂断\n"</span><span class="token punctuation">)</span>
<span class="token keyword">else</span>
    freeswitch<span class="token punctuation">.</span><span class="token function">consoleLog</span><span class="token punctuation">(</span><span class="token string">"INFO"</span><span class="token punctuation">,</span> <span class="token string">"# 挂机结果   : "</span> <span class="token operator">..</span> hangup_cause <span class="token operator">..</span> <span class="token string">"\n"</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>
freeswitch<span class="token punctuation">.</span><span class="token function">consoleLog</span><span class="token punctuation">(</span><span class="token string">"INFO"</span><span class="token punctuation">,</span> <span class="token string">"# ----------------------------------------------\n"</span><span class="token punctuation">)</span>

<span class="token comment">-- 如果要检查主叫号码是否被占用,则呼叫结束后,删除正在使用的主叫号码</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>check_number_in_use <span class="token operator">==</span> <span class="token string">"true"</span><span class="token punctuation">)</span> <span class="token keyword">then</span>
    freeswitch<span class="token punctuation">.</span><span class="token function">consoleLog</span><span class="token punctuation">(</span><span class="token string">"INFO"</span><span class="token punctuation">,</span> string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"# 通话已结束 : 开启了检查主叫号码占用,将释放主叫%s\n"</span><span class="token punctuation">,</span>outgoing_caller_id_number<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">-- 检查号码是否被占用</span>
    temp_string <span class="token operator">=</span> string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>
        <span class="token string">"delete/%s/number_in_use_%s"</span><span class="token punctuation">,</span>
        trunk_name<span class="token punctuation">,</span> outgoing_caller_id_number<span class="token punctuation">)</span>
    freeswitch<span class="token punctuation">.</span><span class="token function">consoleLog</span><span class="token punctuation">(</span><span class="token string">"INFO"</span><span class="token punctuation">,</span> string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"# 通话已结束 : 释放正在使用的主叫号码:%s\n"</span><span class="token punctuation">,</span>temp_string<span class="token punctuation">)</span><span class="token punctuation">)</span>
    result <span class="token operator">=</span> api<span class="token punctuation">:</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token string">"hash"</span><span class="token punctuation">,</span>temp_string<span class="token punctuation">)</span>
    freeswitch<span class="token punctuation">.</span><span class="token function">consoleLog</span><span class="token punctuation">(</span><span class="token string">"INFO"</span><span class="token punctuation">,</span> string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"# 通话已结束 : 释放正在使用的主叫号码:%s\n"</span><span class="token punctuation">,</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>
freeswitch<span class="token punctuation">.</span><span class="token function">consoleLog</span><span class="token punctuation">(</span><span class="token string">"INFO"</span><span class="token punctuation">,</span> <span class="token string">"# ===============================================\n\n"</span><span class="token punctuation">)</span>
<span class="token keyword">return</span>
</code></pre>
    <blockquote>
     <p>
      祝君好运
     </p>
    </blockquote>
   </div>
   <link href="./../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="./../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f:2f626c6f672e6373646e2e6e65742f6a69613139383831302f:61727469636c652f64657461696c732f313436313037363038" class_="artid" style="display:none">
 </p>
</div>


