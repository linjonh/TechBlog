---
layout: post
title: "经验分享SpringBoot集成WebSocket开发-03-使用WebSocketSession为每个对话存储独立信息"
date: 2025-03-13 15:53:11 +0800
description: "如果你希望向所有连接的客户端广播消息，而不仅仅是某个单独的客户端，你需要维护一个所有WebSocket会话的列表。我们可以将用户信息、会话ID等存储在这个属性中，确保每个会话都有独立的数据。这样，每个WebSocket会话就能够独立地存储和访问用户信息、对话ID等数据，同时能够根据不同的会话做出不同的响应。：这个集合存储了所有活跃的WebSocket会话，每个客户端的连接都会被保存到这个集合中。：在WebSocket连接关闭时，移除对应的会话对象，确保集合中只保留当前活跃的会话。"
keywords: "【经验分享】SpringBoot集成WebSocket开发-03 使用WebSocketSession为每个对话存储独立信息"
categories: ['学习笔记']
tags: ['经验分享', 'Websocket', 'Spring', 'Boot']
artid: "146233517"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146233517
    alt: "经验分享SpringBoot集成WebSocket开发-03-使用WebSocketSession为每个对话存储独立信息"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146233517
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146233517
cover: https://bing.ee123.net/img/rand?artid=146233517
image: https://bing.ee123.net/img/rand?artid=146233517
img: https://bing.ee123.net/img/rand?artid=146233517
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     【经验分享】SpringBoot集成WebSocket开发-03 使用WebSocketSession为每个对话存储独立信息
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h3>
     <a id="WebSocketSession_0">
     </a>
     WebSocketSession为每个对话存储独立信息
    </h3>
    <p>
     要在每个WebSocket会话中存储独立的信息，比如用户信息、对话唯一ID等，可以通过以下几种方式来实现：
    </p>
    <h4>
     <a id="1_WebSocketSession_4">
     </a>
     1. 使用
     <code>
      WebSocketSession
     </code>
     存储会话级别的属性
    </h4>
    <p>
     <code>
      WebSocketSession
     </code>
     对象提供了一个
     <code>
      getAttributes()
     </code>
     方法，可以用来为每个WebSocket会话存储自定义信息。我们可以将用户信息、会话ID等存储在这个属性中，确保每个会话都有独立的数据。
    </p>
    <h4>
     <a id="2_WebSocket_8">
     </a>
     2. 管理WebSocket会话
    </h4>
    <p>
     我们可以在WebSocket处理器中跟踪每个WebSocket会话，并在会话关闭时清理数据。
    </p>
    <h4>
     <a id="_12">
     </a>
     示例实现
    </h4>
    <p>
     下面是一个完整的示例，展示如何为每个WebSocket会话存储独立的信息：
    </p>
    <h5>
     <a id="1__MyWebSocketHandler_WebSocketSession__16">
     </a>
     1. 修改
     <code>
      MyWebSocketHandler
     </code>
     ，使用
     <code>
      WebSocketSession
     </code>
     存储会话信息
    </h5>
    <pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>socket<span class="token punctuation">.</span></span><span class="token class-name">WebSocketSession</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>socket<span class="token punctuation">.</span>handler<span class="token punctuation">.</span></span><span class="token class-name">TextWebSocketHandler</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>socket<span class="token punctuation">.</span></span><span class="token class-name">TextMessage</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">UUID</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyWebSocketHandler</span> <span class="token keyword">extends</span> <span class="token class-name">TextWebSocketHandler</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">MyService</span> myService<span class="token punctuation">;</span>

    <span class="token comment">// 构造器注入MyService</span>
    <span class="token keyword">public</span> <span class="token class-name">MyWebSocketHandler</span><span class="token punctuation">(</span><span class="token class-name">MyService</span> myService<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>myService <span class="token operator">=</span> myService<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 处理消息</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleTextMessage</span><span class="token punctuation">(</span><span class="token class-name">WebSocketSession</span> session<span class="token punctuation">,</span> <span class="token class-name">TextMessage</span> message<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 从session获取对话唯一ID和用户信息</span>
        <span class="token class-name">String</span> conversationId <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> session<span class="token punctuation">.</span><span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"conversationId"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> userName <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> session<span class="token punctuation">.</span><span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"userName"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 可以将这些信息传给service进行处理</span>
        <span class="token class-name">String</span> response <span class="token operator">=</span> myService<span class="token punctuation">.</span><span class="token function">processMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getPayload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> conversationId<span class="token punctuation">,</span> userName<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 发送处理后的消息</span>
            session<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TextMessage</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 在会话建立时设置会话信息</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterConnectionEstablished</span><span class="token punctuation">(</span><span class="token class-name">WebSocketSession</span> session<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 设置对话唯一ID和用户信息</span>
        <span class="token class-name">String</span> conversationId <span class="token operator">=</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 生成唯一的对话ID</span>
        <span class="token class-name">String</span> userName <span class="token operator">=</span> <span class="token string">"Guest-"</span> <span class="token operator">+</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 假设用户名是随机生成的，实际中可以通过认证来获取</span>

        <span class="token comment">// 将对话ID和用户名存入会话属性</span>
        session<span class="token punctuation">.</span><span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"conversationId"</span><span class="token punctuation">,</span> conversationId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        session<span class="token punctuation">.</span><span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"userName"</span><span class="token punctuation">,</span> userName<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Connection established for user: "</span> <span class="token operator">+</span> userName <span class="token operator">+</span> <span class="token string">" with conversation ID: "</span> <span class="token operator">+</span> conversationId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 在会话关闭时清理资源</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterConnectionClosed</span><span class="token punctuation">(</span><span class="token class-name">WebSocketSession</span> session<span class="token punctuation">,</span> <span class="token class-name">CloseStatus</span> status<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 清理资源</span>
        session<span class="token punctuation">.</span><span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Connection closed for session: "</span> <span class="token operator">+</span> session<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h5>
     <a id="2__MyServiceID_79">
     </a>
     2. 修改
     <code>
      MyService
     </code>
     ，接受对话ID和用户名参数
    </h5>
    <p>
     <code>
      MyService
     </code>
     类需要处理来自不同会话的消息，并根据不同的对话ID和用户信息来做出响应。
    </p>
    <pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">processMessage</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">,</span> <span class="token class-name">String</span> conversationId<span class="token punctuation">,</span> <span class="token class-name">String</span> userName<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 这里根据对话ID和用户名处理消息</span>
        <span class="token comment">// 你可以通过conversationId来查找历史对话记录，或者根据用户名做不同的响应</span>
        <span class="token keyword">return</span> <span class="token string">"用户: "</span> <span class="token operator">+</span> userName <span class="token operator">+</span> <span class="token string">" 在对话: "</span> <span class="token operator">+</span> conversationId <span class="token operator">+</span> <span class="token string">" 中发送的消息: "</span> <span class="token operator">+</span> message<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h5>
     <a id="3_WebSocket__97">
     </a>
     3. WebSocket 配置类
    </h5>
    <p>
     <code>
      WebSocketConfig
     </code>
     类不需要做修改，只需要保持WebSocket的基本配置即可。
    </p>
    <pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>socket<span class="token punctuation">.</span></span><span class="token class-name">WebSocketHandler</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>socket<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">EnableWebSocket</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>socket<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">WebSocketConfigurer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>socket<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">WebSocketHandlerRegistry</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableWebSocket</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebSocketConfig</span> <span class="token keyword">implements</span> <span class="token class-name">WebSocketConfigurer</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">MyWebSocketHandler</span> myWebSocketHandler<span class="token punctuation">;</span>

    <span class="token comment">// 注入自定义的 WebSocketHandler</span>
    <span class="token keyword">public</span> <span class="token class-name">WebSocketConfig</span><span class="token punctuation">(</span><span class="token class-name">MyWebSocketHandler</span> myWebSocketHandler<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>myWebSocketHandler <span class="token operator">=</span> myWebSocketHandler<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerWebSocketHandlers</span><span class="token punctuation">(</span><span class="token class-name">WebSocketHandlerRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        registry<span class="token punctuation">.</span><span class="token function">addHandler</span><span class="token punctuation">(</span>myWebSocketHandler<span class="token punctuation">,</span> <span class="token string">"/ws"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAllowedOrigins</span><span class="token punctuation">(</span><span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h5>
     <a id="4__126">
     </a>
     4. 启动类
    </h5>
    <p>
     与之前一样，我们创建一个Spring Boot启动类来启动应用。
    </p>
    <pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span></span><span class="token class-name">SpringApplication</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span></span><span class="token class-name">SpringBootApplication</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebSocketApplication</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">WebSocketApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="5__142">
     </a>
     5. 说明
    </h4>
    <ul>
     <li>
      在
      <code>
       MyWebSocketHandler
      </code>
      中，使用了
      <code>
       WebSocketSession
      </code>
      对象的
      <code>
       getAttributes()
      </code>
      来存储会话级别的属性，如对话ID和用户名等。这些信息在WebSocket会话建立时被初始化，并且在后续的消息处理中被引用。
     </li>
     <li>
      使用
      <code>
       UUID.randomUUID().toString()
      </code>
      来生成一个唯一的对话ID，每个连接会有一个独立的对话ID。实际应用中，你可以通过身份认证来为用户生成一个真实的用户名。
     </li>
     <li>
      每个WebSocket连接都是独立的，
      <code>
       WebSocketSession
      </code>
      会自动维护各自独立的状态，所以每个连接可以保存自己的对话ID和用户信息。
     </li>
     <li>
      在会话关闭时，通过
      <code>
       afterConnectionClosed()
      </code>
      方法清理会话信息，确保没有残留的数据。
     </li>
    </ul>
    <h4>
     <a id="6__149">
     </a>
     6. 进一步扩展
    </h4>
    <ul>
     <li>
      <strong>
       认证
      </strong>
      : 如果你需要根据用户身份来设置用户信息，可以在
      <code>
       afterConnectionEstablished()
      </code>
      方法中进行认证（比如使用JWT令牌来识别用户）。
     </li>
     <li>
      <strong>
       历史消息
      </strong>
      : 你可以在
      <code>
       MyService
      </code>
      中扩展，利用
      <code>
       conversationId
      </code>
      来查找并返回该对话的历史消息。
     </li>
     <li>
      <strong>
       广播消息
      </strong>
      : 如果你需要广播消息给所有用户，可以使用一个全局的WebSocket会话管理器来存储每个会话，并根据需求发送消息。
     </li>
    </ul>
    <p>
     这样，每个WebSocket会话就能够独立地存储和访问用户信息、对话ID等数据，同时能够根据不同的会话做出不同的响应。
    </p>
    <h3>
     <a id="_161">
     </a>
     客户端主动发送消息
    </h3>
    <h4>
     <a id="_163">
     </a>
     向多个客户端广播消息
    </h4>
    <p>
     如果你希望向所有连接的客户端广播消息，而不仅仅是某个单独的客户端，你需要维护一个所有WebSocket会话的列表。这通常可以通过一个简单的集合来实现，比如使用
     <code>
      Set&lt;WebSocketSession&gt;
     </code>
     来存储所有活跃的WebSocket会话。
    </p>
    <h5>
     <a id="_167">
     </a>
     示例：广播消息给所有连接的客户端
    </h5>
    <pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>socket<span class="token punctuation">.</span></span><span class="token class-name">WebSocketSession</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>socket<span class="token punctuation">.</span></span><span class="token class-name">TextMessage</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>socket<span class="token punctuation">.</span>handler<span class="token punctuation">.</span></span><span class="token class-name">TextWebSocketHandler</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Set</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">CopyOnWriteArraySet</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyWebSocketHandler</span> <span class="token keyword">extends</span> <span class="token class-name">TextWebSocketHandler</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WebSocketSession</span><span class="token punctuation">&gt;</span></span> sessions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CopyOnWriteArraySet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 线程安全的集合，保存所有会话</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterConnectionEstablished</span><span class="token punctuation">(</span><span class="token class-name">WebSocketSession</span> session<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 将新的会话添加到集合中</span>
        sessions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> userId <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> session<span class="token punctuation">.</span><span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"userId"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sendMessageToClient</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span> <span class="token string">"Hello, "</span> <span class="token operator">+</span> userId <span class="token operator">+</span> <span class="token string">"! You are connected."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleTextMessage</span><span class="token punctuation">(</span><span class="token class-name">WebSocketSession</span> session<span class="token punctuation">,</span> <span class="token class-name">TextMessage</span> message<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 处理接收到的消息后，可以向所有客户端广播</span>
        <span class="token function">broadcastMessage</span><span class="token punctuation">(</span><span class="token string">"Broadcast message: "</span> <span class="token operator">+</span> message<span class="token punctuation">.</span><span class="token function">getPayload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterConnectionClosed</span><span class="token punctuation">(</span><span class="token class-name">WebSocketSession</span> session<span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>socket<span class="token punctuation">.</span></span>CloseStatus</span> status<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 移除关闭的会话</span>
        sessions<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 向所有连接的客户端广播消息</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">broadcastMessage</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">TextMessage</span> textMessage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TextMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建TextMessage对象</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">WebSocketSession</span> session <span class="token operator">:</span> sessions<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            session<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>textMessage<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 向所有客户端发送消息</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 向单个客户端发送消息</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">sendMessageToClient</span><span class="token punctuation">(</span><span class="token class-name">WebSocketSession</span> session<span class="token punctuation">,</span> <span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">TextMessage</span> textMessage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TextMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        session<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>textMessage<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 发送消息</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="_218">
     </a>
     关键点：
    </h4>
    <ul>
     <li>
      <p>
       <strong>
        <code>
         sessions
        </code>
       </strong>
       ：这个集合存储了所有活跃的WebSocket会话，每个客户端的连接都会被保存到这个集合中。
      </p>
     </li>
     <li>
      <p>
       <strong>
        <code>
         broadcastMessage
        </code>
       </strong>
       ：这个方法遍历所有活跃的会话，并向每个会话发送消息，实现了广播消息功能。
      </p>
     </li>
     <li>
      <p>
       <strong>
        <code>
         afterConnectionEstablished
        </code>
       </strong>
       ：在每个客户端连接时，将其WebSocket会话对象添加到
       <code>
        sessions
       </code>
       集合中。
      </p>
     </li>
     <li>
      <p>
       <strong>
        <code>
         afterConnectionClosed
        </code>
       </strong>
       ：在WebSocket连接关闭时，移除对应的会话对象，确保集合中只保留当前活跃的会话。
      </p>
     </li>
     <li>
      <p>
       可以进一步优化为线程安全的map进行存储session信息例如
      </p>
      <pre><code class="prism language-java">   <span class="token comment">/**
     * 使用ConcurrentHashMap来存储WebSocket会话
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">WebSocketSession</span><span class="token punctuation">&gt;</span></span> sessionMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
     </li>
    </ul>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f:2f626c6f672e6373646e2e6e65742f58636f6e675f5a68752f:61727469636c652f64657461696c732f313436323333353137" class_="artid" style="display:none">
 </p>
</div>


