---
layout: post
title: "无人机避障XTDrone中运行VINS-FusionEgo-planner进行路径规划"
date: 2025-03-07 15:35:46 +0800
description: "本文聚焦于无人机避障技术领域的经典方案，重点探讨视觉双目VINS-Fusion建图与Ego-planner路径规划的组合应用。通过视觉双目VINS-Fusion实现精准的环境建图与自身定位，结合Ego-planner的高效路径规划能力，使无人机在复杂环境中实现自主避障飞行。基于XTDrone平台，采用PX4固件和Mavros协议进行仿真测试，验证了该技术方案的可行性和有效性，展示了其在实际应用中的潜力和优势。"
keywords: "无人机避障——XTDrone中运行VINS-Fusion+Ego-planner进行路径规划"
categories: ['无人机规控算法', 'Xtdrone', 'Px']
tags: ['规划控制', '无人机', 'Xtdrone', 'Planner', 'Fusion']
artid: "146062138"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146062138
    alt: "无人机避障XTDrone中运行VINS-FusionEgo-planner进行路径规划"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146062138
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146062138
cover: https://bing.ee123.net/img/rand?artid=146062138
image: https://bing.ee123.net/img/rand?artid=146062138
img: https://bing.ee123.net/img/rand?artid=146062138
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     无人机避障——XTDrone中运行VINS-Fusion+Ego-planner进行路径规划
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <p>
     本文聚焦于无人机避障技术领域的经典方案，重点探讨视觉双目VINS-Fusion建图与Ego-planner路径规划的组合应用。通过视觉双目VINS-Fusion实现精准的环境建图与自身定位，结合Ego-planner的高效路径规划能力，使无人机在复杂环境中实现自主避障飞行。基于XTDrone平台，采用PX4固件和Mavros协议进行仿真测试，验证了该技术方案的可行性和有效性，展示了其在实际应用中的潜力和优势。
    </p>
    <p>
     参考链接：
    </p>
    <p>
     <a class="has-card" href="https://www.yuque.com/xtdrone/manual_cn/vio#luwyy" rel="nofollow" title="视觉惯性里程计（VIO） · 语雀">
      <span class="link-card-box" contenteditable="false">
       <span class="link-title">
        视觉惯性里程计（VIO） · 语雀
       </span>
       <span class="link-desc">
        VINS-Mono编译首先参考这里配置依赖，然后编译c...
       </span>
       <span class="link-link">
        <img class="link-link-icon" src="https://csdnimg.cn/release/blog_editor_html/release2.3.8/ckeditor/plugins/CsdnLink/icons/icon-default.png?t=P1C7">
         https://www.yuque.com/xtdrone/manual_cn/vio#luwyy
        </img>
       </span>
      </span>
     </a>
    </p>
    <h2>
     VINS-Fusion仿真
    </h2>
    <h3>
     遇到报错问题：
    </h3>
    <p>
     <img alt="" height="1055" src="https://i-blog.csdnimg.cn/direct/f143425db9ba4b64999400f4da0804c9.png" width="1850"/>
    </p>
    <h4 style="background-color:transparent">
     基本报错参考链接：
    </h4>
    <p>
     <a href="https://blog.csdn.net/xiaojinger_123/article/details/121517771?utm_source=app&amp;app_version=4.20.0" title="Ubuntu20.04运行Vins-fusion_ubuntu20.04 vins-fussion-CSDN博客">
      Ubuntu20.04运行Vins-fusion_ubuntu20.04 vins-fussion-CSDN博客
     </a>
    </p>
    <h5>
     原文中：
    </h5>
    <p>
     在报错的项目的CMakeList里的
     <br/>
     set(CMAKE_CXX_FLAGS “-std=c++11”)
     <br/>
     改成
     <br/>
     set(CMAKE_CXX_STANDARD 14)
    </p>
    <h5>
     实际上：
    </h5>
    <p>
     Vins-fusion中的文件夹下的功能包的CMake.list都需要进行以上修改。
    </p>
    <h5>
     原文中：
    </h5>
    <p>
     但在Opencv4中，CV_LOAD_IMAGE_GRAYSCALE找不到，经过查看Opencv的API可知，CV_LOAD_IMAGE_GRAYSCALE已改为 IMREAD_GRAYSCALE，修改即可。
    </p>
    <h5>
     实际上：
    </h5>
    <p>
     将CV_LOAD_IMAGE_GRAYSCALE改为cv::IMREAD_GRAYSCALE
    </p>
    <h4>
     其他报错：
    </h4>
    <p>
     <img alt="" height="1055" src="https://i-blog.csdnimg.cn/direct/1e8717ec95d74a2b8618d14789652dc1.png" width="1850"/>
    </p>
    <p>
     /usr/bin/ld: /usr/local/lib/libgflags.a(gflags.cc.o): relocation R_AARCH64_ADR_PREL_PG_HI21 against symbol `_ZN3fLS20StringFlagDestructorD1Ev' which may bind externally can not be used when making a shared object; recompile with -fPIC
     <br/>
     /usr/local/lib/libgflags.a(gflags.cc.o): in function `_GLOBAL__sub_I__ZN3fLS14FLAGS_flagfileB5cxx11E':
     <br/>
     gflags.cc:(.text.startup+0x60): 危险的重寻址: unsupported relocation
     <br/>
     /usr/bin/ld: /usr/local/lib/libgflags.a(gflags.cc.o): relocation R_AARCH64_ADR_PREL_PG_HI21 against symbol `_ZN22gflags_mutex_namespace5MutexD1Ev' which may bind externally can not be used when making a shared object; recompile with -fPIC
     <br/>
     gflags.cc:(.text.startup+0x280): 危险的重寻址: unsupported relocation
     <br/>
     /usr/bin/ld: /usr/local/lib/libgflags.a(gflags.cc.o): relocation R_AARCH64_ADR_PREL_PG_HI21 against symbol `_ZNSt6vectorINSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEESaIS5_EED1Ev' which may bind externally can not be used when making a shared object; recompile with -fPIC
     <br/>
     gflags.cc:(.text.startup+0x2fc): 危险的重寻址: unsupported relocation
     <br/>
     /usr/bin/ld: /usr/local/lib/libgflags.a(gflags_reporting.cc.o): relocation R_AARCH64_ADR_PREL_PG_HI21 against symbol `_ZN3fLS20StringFlagDestructorD1Ev' which may bind externally can not be used when making a shared object; recompile with -fPIC
     <br/>
     /usr/local/lib/libgflags.a(gflags_reporting.cc.o): in function `_GLOBAL__sub_I__ZN3fLB10FLAGS_helpE':
     <br/>
     gflags_reporting.cc:(.text.startup+0x60): 危险的重寻址: unsupported relocation
     <br/>
     /usr/bin/ld: /usr/local/lib/libgflags.a(gflags_completions.cc.o): relocation R_AARCH64_ADR_PREL_PG_HI21 against symbol `_ZN3fLS20StringFlagDestructorD1Ev' which may bind externally can not be used when making a shared object; recompile with -fPIC
     <br/>
     /usr/local/lib/libgflags.a(gflags_completions.cc.o): in function `_GLOBAL__sub_I__ZN3fLS25FLAGS_tab_completion_wordB5cxx11E':
     <br/>
     gflags_completions.cc:(.text.startup+0xa0): 危险的重寻址: unsupported relocation
     <br/>
     collect2: error: ld returned 1 exit status
     <br/>
     [ 43%] Generating EusLisp code from gazebo_msgs/SetLinkProperties.srv
     <br/>
     make[2]: *** [VINS-Fusion/camera_models/CMakeFiles/camera_models.dir/build.make:352：/home/nvidia/catkin_ws/devel/lib/libcamera_models.so] 错误 1
     <br/>
     make[1]: *** [CMakeFiles/Makefile2:916：VINS-Fusion/camera_models/CMakeFiles/camera_models.dir/all] 错误 2
     <br/>
     make[1]: *** 正在等待未完成的任务....
    </p>
    <h4>
     解决：
    </h4>
    <h5>
     <strong>
      根本原因：
     </strong>
    </h5>
    <p>
     错误信息中的
     <code>
      relocation R_AARCH64_ADR_PREL_PG_HI21
     </code>
     表明在生成动态库（
     <code>
      .so
     </code>
     ）时，链接了未启用
     <code>
      -fPIC
     </code>
     的静态库
     <code>
      libgflags.a
     </code>
    </p>
    <p>
     ARM架构（如AArch64）要求动态库的所有依赖库必须编译为位置无关代码（PIC），否则无法正确处理地址重定位
    </p>
    <p>
     <code>
      libgflags.a
     </code>
     是静态库且未启用
     <code>
      -fPIC
     </code>
     ，导致其代码段包含绝对地址，无法被动态库共享使用
    </p>
    <hr/>
    <h5 style="background-color:transparent">
     ​
     <strong>
      解决方案
     </strong>
    </h5>
    <h6>
     1. ​
     <strong>
      重新编译gflags并强制启用-fPIC
     </strong>
    </h6>
    <p>
     <strong>
      步骤：​
     </strong>
    </p>
    <pre><code class="language-bash"># 卸载旧版本gflags
sudo rm -rf /usr/local/lib/libgflags* /usr/local/include/gflags

# 下载源码并编译
git clone https://github.com/gflags/gflags.git
cd gflags
mkdir build &amp;&amp; cd build

# 通过CMake启用位置无关代码并生成动态库
cmake -DCMAKE_POSITION_INDEPENDENT_CODE=ON \  # 强制启用-fPIC[2,3](@ref)
      -DBUILD_SHARED_LIBS=ON \                # 生成动态库（.so）而非静态库[6](@ref)
      -DCMAKE_INSTALL_PREFIX=/usr/local ..    # 指定安装路径
make -j$(nproc)
sudo make install</code></pre>
    <h6>
     2. ​
     <strong>
      验证gflags安装
     </strong>
    </h6>
    <p>
     检查新生成的库文件是否为动态库：
    </p>
    <pre><code class="language-bash">ls /usr/local/lib | grep libgflags
# 正确输出应包含 libgflags.so，而非 libgflags.a</code></pre>
    <h6>
     3. ​
     <strong>
      更新动态库缓存
     </strong>
    </h6>
    <pre><code class="language-bash">sudo ldconfig  # 刷新动态库路径</code></pre>
    <h6>
     4. ​
     <strong>
      修改项目CMake配置
     </strong>
    </h6>
    <p>
     在
     <code>
      camera_models
     </code>
     的
     <code>
      CMakeLists.txt
     </code>
     中，确保链接到动态库：
    </p>
    <pre><code class="language-bash"># 添加以下内容以强制链接动态库
find_package(gflags REQUIRED)
target_link_libraries(camera_models PRIVATE gflags_shared)  # 使用动态库目标名</code></pre>
    <h6>
     5. 以下是更改的
     <code>
      CMakeLists.txt文件：
     </code>
    </h6>
    <pre><code class="language-bash">cmake_minimum_required(VERSION 2.8.3)
project(camera_models)

set(CMAKE_BUILD_TYPE "Release")
set(CMAKE_CXX_STANDARD 14)
set(CMAKE_CXX_FLAGS_RELEASE "-O3 -fPIC")

find_package(catkin REQUIRED COMPONENTS
    roscpp
    std_msgs
    )

find_package(Boost REQUIRED COMPONENTS filesystem program_options system)
include_directories(${Boost_INCLUDE_DIRS})

find_package(OpenCV REQUIRED)

# set(EIGEN_INCLUDE_DIR "/usr/local/include/eigen3")
find_package(Ceres REQUIRED)
include_directories(${CERES_INCLUDE_DIRS})
find_package(gflags REQUIRED) # 第一条加在这里

catkin_package(
    INCLUDE_DIRS include
    LIBRARIES camera_models
    CATKIN_DEPENDS roscpp std_msgs
#    DEPENDS system_lib
    )

include_directories(
    ${catkin_INCLUDE_DIRS}
    )

include_directories("include")

add_executable(Calibrations 
    src/intrinsic_calib.cc
    src/chessboard/Chessboard.cc
    src/calib/CameraCalibration.cc
    src/camera_models/Camera.cc
    src/camera_models/CameraFactory.cc
    src/camera_models/CostFunctionFactory.cc
    src/camera_models/PinholeCamera.cc
    src/camera_models/PinholeFullCamera.cc
    src/camera_models/CataCamera.cc
    src/camera_models/EquidistantCamera.cc
    src/camera_models/ScaramuzzaCamera.cc
    src/sparse_graph/Transform.cc
    src/gpl/gpl.cc
    src/gpl/EigenQuaternionParameterization.cc)

add_library(camera_models
    src/chessboard/Chessboard.cc
    src/calib/CameraCalibration.cc
    src/camera_models/Camera.cc
    src/camera_models/CameraFactory.cc
    src/camera_models/CostFunctionFactory.cc
    src/camera_models/PinholeCamera.cc
    src/camera_models/PinholeFullCamera.cc
    src/camera_models/CataCamera.cc
    src/camera_models/EquidistantCamera.cc
    src/camera_models/ScaramuzzaCamera.cc
    src/sparse_graph/Transform.cc
    src/gpl/gpl.cc
    src/gpl/EigenQuaternionParameterization.cc)

target_link_libraries(Calibrations ${Boost_LIBRARIES} ${OpenCV_LIBS} ${CERES_LIBRARIES})
target_link_libraries(camera_models ${Boost_LIBRARIES} ${OpenCV_LIBS} ${CERES_LIBRARIES})
target_link_libraries(camera_models PRIVATE gflags_shared)# 第二条加在这里</code></pre>
    <h3>
     编译成功：
    </h3>
    <p>
     <img alt="" height="1055" src="https://i-blog.csdnimg.cn/direct/dad6edca2c1349d9b6d50fb6bc1bf9d6.png" width="1850"/>
    </p>
    <h3 id="article-title">
     PX4飞控EKF配置：
    </h3>
    <h4>
     修改定位方式：
    </h4>
    <p>
     打开文件：
    </p>
    <pre><code class="language-bash">gedit ~/PX4_Firmware/ROMFS/px4fmu_common/init.d-posix/rcS</code></pre>
    <p>
     找到GPS、气压计、视觉选择的部分，我们用的是VINS-Fusion双目视觉所以需要修改
    </p>
    <h4>
     修改前：
    </h4>
    <pre><code class="language-bash"># GPS used
param set EKF2_AID_MASK 1
# Vision used and GPS denied
#param set EKF2_AID_MASK 24

# Barometer used for hight measurement
param set EKF2_HGT_MODE 0
# Barometer denied and vision used for hight measurement
#param set EKF2_HGT_MODE 3</code></pre>
    <h4>
     修改后：
    </h4>
    <pre><code class="language-bash"># GPS used
#param set EKF2_AID_MASK 1
# Vision used and GPS denied
param set EKF2_AID_MASK 24
# Barometer used for hight measurement
#param set EKF2_HGT_MODE 0
# Barometer denied and vision used for hight measurement
param set EKF2_HGT_MODE 3
</code></pre>
    <h4>
     使修改生效：
    </h4>
    <pre><code class="language-bash">rm ~/.ros/eeprom/parameters*
rm -rf ~/.ros/sitl*</code></pre>
    <h4>
     运行Vins-Fusion：
    </h4>
    <pre><code class="language-bash">roslaunch px4 indoor1.launch

cd ~/catkin_ws
bash scripts/xtdrone_run_vio.sh

cd ~/XTDrone/sensing/slam/vio
python vins_transfer.py iris 0

cd ~/XTDrone/communication
python multirotor_communication.py iris 0 

cd ~/XTDrone/control/keyboard
python multirotor_keyboard_control.py iris 1 vel

</code></pre>
    <p>
     <img alt="" height="1055" src="https://i-blog.csdnimg.cn/direct/97917179bc7a48c3a9e37d4355f0f64c.png" width="1850">
      <img alt="" height="1055" src="https://i-blog.csdnimg.cn/direct/97059bd01c0146a9bbf682ccfeaf9539.png" width="1850"/>
     </img>
    </p>
    <h3>
     运行视频：
    </h3>
    <div class="video">
     <iframe allowfullscreen="true" data-mediaembed="csdn" frameborder="0" id="5lkU775r-1741329979829" src="https://live.csdn.net/v/embed/467439" style="width:100%;height:100%;">
     </iframe>
     <p>
      Vins_Fusion
     </p>
    </div>
    <h2>
     Ego-planner三维路径规划仿真
    </h2>
    <h3 style="background-color:transparent">
     编译Ego-planner报错：
    </h3>
    <h4>
     报错1：
    </h4>
    <p>
     <img alt="" height="614" src="https://i-blog.csdnimg.cn/direct/2b5bbaa8e02d4b5396de5b78313d1394.png" width="1165"/>
    </p>
    <h4>
     解决1：
    </h4>
    <p>
     <span style="color:#fe2c24">
      <strong>
       问题核心是 ​CMake无法找到PCL（Point Cloud Library）的配置文件。
      </strong>
     </span>
    </p>
    <p>
     安装PCL核心开发组件:
    </p>
    <pre><code class="language-bash">sudo apt-get install libpcl-dev pcl-tools</code></pre>
    <h4>
     报错2：
    </h4>
    <p>
     <img alt="" height="784" src="https://i-blog.csdnimg.cn/direct/9f15f0fa4c8948728f99d1f6f303bea9.png" width="1177"/>
    </p>
    <h4>
     解决2：
    </h4>
    <p>
     <code>
      pcl_conversions.h
     </code>
     属于ROS的
     <code>
      pcl_conversions
     </code>
     包，需单独安装：
    </p>
    <pre><code># 安装ROS版本的PCL转换工具包
sudo apt-get install ros-noetic-pcl-conversions ros-noetic-pcl-ros</code></pre>
    <p>
     编译成功
     <br/>
     <img alt="" height="779" src="https://i-blog.csdnimg.cn/direct/726ca285466a4fd4acf4ddb939e6e5be.png" width="1136"/>
    </p>
    <h3>
     代码运行整合：
    </h3>
    <pre><code class="language-bash">#整理的运行代码
#启动仿真程序
roslaunch px4 indoor1.launch

#启动Vins-Fusion
cd ~/catkin_ws
bash scripts/xtdrone_run_vio.sh

#由于VINS-Fusion发布的是Odometry类型的话题，要将其对应转为PX4所需的话题
cd ~/XTDrone/sensing/slam/vio
python vins_transfer.py iris 0

#然后建立通信，键盘控制起飞即可
cd ~/XTDrone/communication
python multirotor_communication.py iris 0 

cd ~/XTDrone/control/keyboard
python multirotor_keyboard_control.py iris 1 vel

#转换相机位姿的坐标系方向
cd ~/XTDrone/motion_planning/3d
python ego_transfer.py iris 0

#启动rviz
cd ~/XTDrone/motion_planning/3d
rviz -d ego_rviz.rviz

#启动ego_planner
roslaunch ego_planner single_uav.launch </code></pre>
    <h3>
     按顺序运行代码：
    </h3>
    <p>
     <img alt="" height="1055" src="https://i-blog.csdnimg.cn/direct/60fd7d588a95415f93eb5fd9eb0514d3.png" width="1850"/>
    </p>
    <h3>
     运行结果：
    </h3>
    <p>
     <img alt="" height="879" src="https://i-blog.csdnimg.cn/direct/6a400b415e324596b6f02db63fb61025.png" width="1842">
     </img>
    </p>
    <p>
    </p>
   </div>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f34353339303637302f:61727469636c652f64657461696c732f313436303632313338" class_="artid" style="display:none">
 </p>
</div>


