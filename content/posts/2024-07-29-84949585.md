---
layout: post
title: "阿里云物联网平台体验树莓派Nodejs篇"
date: 2024-07-29 16:39:31 +0800
description: " 我们在《阿里云物联网平台体验（树莓派+python篇）》里，写了通过Python语言开发云到端的物"
keywords: "nodejs tdengine 物联网平台"
categories: ['物联网', '〖硬件〗']
tags: ['无标签']
artid: "84949585"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=84949585
    alt: "阿里云物联网平台体验树莓派Nodejs篇"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=84949585
featuredImagePreview: https://bing.ee123.net/img/rand?artid=84949585
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     阿里云物联网平台体验(树莓派+Nodejs篇)
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <p style="margin-left:0px;">
    </p>
    <p style="margin-left:0px;">
     <span style="color:#000000;">
      我们在《阿里云物联网平台体验（树莓派
     </span>
     <span style="color:#000000;">
      +python
     </span>
     <span style="color:#000000;">
      篇）》里，写了通过
     </span>
     <span style="color:#000000;">
      Python
     </span>
     <span style="color:#000000;">
      语言开发云到端的物联网程序，本篇文章将介绍通过
     </span>
     <span style="color:#000000;">
      nodejs
     </span>
     <span style="color:#000000;">
      来实现类似功能。
     </span>
    </p>
    <p style="margin-left:0px;">
     <span style="color:#000000;">
      同样在阿里云官方文档里已经有了一个
     </span>
     <span style="color:#000000;">
      Nodejs
     </span>
     <span style="color:#000000;">
      设备接入说明：
     </span>
     <a href="https://www.yuque.com/cloud-dev/iot-tech/gvttbm" rel="nofollow">
      <u>
       <span style="color:#0563c1;">
        https://www.yuque.com/cloud-dev/iot-tech/gvttbm
       </span>
      </u>
     </a>
    </p>
    <p style="margin-left:0px;">
     <span style="color:#000000;">
      文中的代码也是把模拟的温湿度数据上传到物联网云平台的，我们依然对这个代码进行扩展，实现接入实际的温湿度传感器，把数据上传到云端，同时云端下发控制指令，控制
     </span>
     <span style="color:#000000;">
      LED
     </span>
     <span style="color:#000000;">
      的开和闭。
     </span>
    </p>
    <p style="margin-left:0px;">
     <span style="color:#000000;">
      相关硬件平台的搭建由于在
     </span>
     <span style="color:#000000;">
      python
     </span>
     <span style="color:#000000;">
      篇里已有描述，我们这里就不在赘言了。
     </span>
    </p>
    <p style="margin-left:0px;">
     <span style="color:#000000;">
      目前用
     </span>
     <span style="color:#000000;">
      nodejs
     </span>
     <span style="color:#000000;">
      直接操作
     </span>
     <span style="color:#000000;">
      GPIO
     </span>
     <span style="color:#000000;">
      ，根据网上的资源，有两种常见方式，一种是采用是操作
     </span>
     <span style="color:#000000;">
      rpio
     </span>
     <span style="color:#000000;">
      库（目前最新版本是
     </span>
     <span style="color:#000000;">
      rpio2 0.4.1
     </span>
     <span style="color:#000000;">
      ），一种是
     </span>
     <span style="color:#000000;">
      quick2wire-gpio-admin
     </span>
     <span style="color:#000000;">
      。（其他更好的方案，也希望网友推荐）。根据使用习惯，我这次选用的是
     </span>
     <span style="color:#000000;">
      rpio2
     </span>
     <span style="color:#000000;">
      。
     </span>
    </p>
    <p style="margin-left:0px;">
     <span style="color:#000000;">
      需要注意的是，
     </span>
     <span style="color:#000000;">
      rpio2
     </span>
     <span style="color:#000000;">
      里面的
     </span>
     <span style="color:#000000;">
      pin
     </span>
     <span style="color:#000000;">
      和
     </span>
     <span style="color:#000000;">
      python
     </span>
     <span style="color:#000000;">
      操作的有些不一样，它指定的
     </span>
     <span style="color:#000000;">
      pin
     </span>
     <span style="color:#000000;">
      是物理排针的
     </span>
     <span style="color:#000000;">
      pin
     </span>
     <span style="color:#000000;">
      脚位置。比如我们的
     </span>
     <span style="color:#000000;">
      LED
     </span>
     <span style="color:#000000;">
      模块控制脚接入的是
     </span>
     <span style="color:#000000;">
      GPIO4
     </span>
     <span style="color:#000000;">
      ，在
     </span>
     <span style="color:#000000;">
      python
     </span>
     <span style="color:#000000;">
      中我们定义
     </span>
     <span style="color:#000000;">
      pin=4
     </span>
     <span style="color:#000000;">
      ，在
     </span>
     <span style="color:#000000;">
      rpio2
     </span>
     <span style="color:#000000;">
      中，我们需要定义
     </span>
     <span style="color:#000000;">
      pin=7
     </span>
     <span style="color:#000000;">
      了。
     </span>
    </p>
    <figure class="image">
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/b0781192cc2bc8d4e4e2602e56a19206.jpeg">
      <figcaption>
       标题
      </figcaption>
     </img>
    </figure>
    <p style="margin-left:0px;">
     <span style="color:#000000;">
      使用
     </span>
     <span style="color:#000000;">
      rpio2
     </span>
     <span style="color:#000000;">
      库之前需要安装一下，输入如下命令：
     </span>
    </p>
    <p style="margin-left:0px;">
     <span style="color:#000000;">
      npm install rpio2 –production
     </span>
    </p>
    <p style="margin-left:0px;">
     <span style="color:#000000;">
      操作
     </span>
     <span style="color:#000000;">
      GPIO
     </span>
     <span style="color:#000000;">
      的代码也比较简单，如下面的示例代码：
     </span>
    </p>
    <pre class="has" style="margin-left:21pt;"><code class="language-html">const Gpio = require('/home/pi/node_modules/rpio2/lib/index.js').Gpio;</code></pre>
    <pre class="has" style="margin-left:21pt;"><code class="language-html">var led = new Gpio(7);  //创建 Pin7 引脚</code></pre>
    <pre class="has" style="margin-left:21pt;"><code class="language-html"> </code></pre>
    <pre class="has" style="margin-left:21pt;"><code class="language-html">led.open(Gpio.OUTPUT, Gpio.LOW); //设置为 OUTPUT、默认低电平</code></pre>
    <pre class="has" style="margin-left:21pt;"><code class="language-html">for(var i = 0; i &lt; 20; i++){<!-- --></code></pre>
    <pre class="has" style="margin-left:21pt;"><code class="language-html">    led.toggle();    //切换 led 的电平状态</code></pre>
    <pre class="has" style="margin-left:21pt;"><code class="language-html">    led.sleep(300);  //等待 500ms</code></pre>
    <pre class="has" style="margin-left:21pt;"><code class="language-html">}</code></pre>
    <pre class="has" style="margin-left:21pt;"><code class="language-html">led.close();</code></pre>
    <pre class="has" style="margin-left:21pt;"><code class="language-html"> </code></pre>
    <pre class="has" style="margin-left:21pt;"><code class="language-html">获取DHT11的值相对麻烦一些，参考国外一篇文章：https://www.instructables.com/id/Raspberry-Pi-Nodejs-Blynk-App-DHT11DHT22AM2302/ </code></pre>
    <pre class="has" style="margin-left:21pt;"><code class="language-html"> </code></pre>
    <pre class="has" style="margin-left:21pt;"><code class="language-html">安装bcm2835-1.46没有出现什么问题，不过安装node-dht-sensor，如果直接输入 sudo npm install -g node-dht-sensor 命令进行安装会出现如下错误：</code></pre>
    <figure class="image">
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/90d3a1bc04c84b5e51746ccebcce0811.jpeg">
      <figcaption>
       标题
      </figcaption>
     </img>
    </figure>
    <pre class="has" style="margin-left:21pt;"><code class="language-html">我们必须要这样执行命令才行：</code></pre>
    <ol>
     <li>
      先运行：sudo chmod -R 777 /var/root
     </li>
     <li>
      后运行：sudo npm install -g --unsafe-perm node-dht-sensor则可以正确安装，如下图所示：
     </li>
    </ol>
    <figure class="image">
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/8b6bf96fe0e3018b3f33cb11ab0985d8.jpeg">
      <figcaption>
       标题
      </figcaption>
     </img>
    </figure>
    <pre class="has" style="margin-left:39pt;"><code class="language-html">获取温湿度的代码比较简单，如下：</code></pre>
    <pre class="has" style="margin-left:42pt;"><code class="language-html">var sensorLib = require('node-dht-sensor');</code></pre>
    <pre class="has" style="margin-left:42pt;"><code class="language-html">// Setup sensor, exit if failed</code></pre>
    <pre class="has" style="margin-left:42pt;"><code class="language-html">var sensorType = 11; // 11 for DHT11, 22 for DHT22 and AM2302</code></pre>
    <pre class="has" style="margin-left:42pt;"><code class="language-html">var sensorPin  = 16;  // The GPIO pin number for sensor signal</code></pre>
    <pre class="has" style="margin-left:42pt;"><code class="language-html">if (!sensorLib.initialize(sensorType, sensorPin)) {<!-- --></code></pre>
    <pre class="has" style="margin-left:42pt;"><code class="language-html">    console.warn('Failed to initialize sensor');</code></pre>
    <pre class="has" style="margin-left:42pt;"><code class="language-html">    process.exit(1);</code></pre>
    <pre class="has" style="margin-left:42pt;"><code class="language-html">}</code></pre>
    <pre class="has" style="margin-left:42pt;"><code class="language-html">// Automatically update sensor value every 2 seconds</code></pre>
    <pre class="has" style="margin-left:42pt;"><code class="language-html">setInterval(function() {<!-- --></code></pre>
    <pre class="has" style="margin-left:42pt;"><code class="language-html">    var readout = sensorLib.read();</code></pre>
    <pre class="has" style="margin-left:42pt;"><code class="language-html">    console.log('Temperature:', readout.temperature.toFixed(1) + 'C');</code></pre>
    <pre class="has" style="margin-left:42pt;"><code class="language-html">    console.log('Humidity:   ', readout.humidity.toFixed(1)    + '%');</code></pre>
    <pre class="has" style="margin-left:42pt;"><code class="language-html">}, 2000);</code></pre>
    <pre class="has" style="margin-left:42pt;"><code class="language-html"> </code></pre>
    <pre class="has" style="margin-left:42pt;"><code class="language-html">执行sudo NODE_PATH=/usr/local/lib/node_modules node ./nodejs_dht11.js 命令，则运行结果如下：</code></pre>
    <pre class="has" style="margin-left:21pt;"><code class="language-html"> </code></pre>
    <p style="margin-left:0px;">
     <img alt="" class="has" height="152" src="https://i-blog.csdnimg.cn/blog_migrate/6f3e59dd782d60db40430dbaee54681b.jpeg" width="751"/>
    </p>
    <p style="margin-left:0px;">
     <span style="color:#000000;">
     </span>
     <span style="color:#000000;">
     </span>
     <span style="color:#000000;">
      有了以上的操作，那么我们把上面的代码糅合进阿里云官方的示例，实现阿里云的双向通信。
     </span>
    </p>
    <p style="margin-left:0px;">
     <span style="color:#000000;">
      增加
     </span>
     <span style="color:#000000;">
      message
     </span>
     <span style="color:#000000;">
      函数，获取云端发送的数据：
     </span>
    </p>
    <p style="margin-left:0px;">
     <span style="color:#000000;">
     </span>
     <span style="color:#000000;">
      client.on(
     </span>
     <span style="color:#800000;">
      'message'
     </span>
     <span style="color:#000000;">
      ,
     </span>
     <span style="color:#0000ff;">
      function
     </span>
     <span style="color:#000000;">
      (topic, message) {
      <!-- -->
     </span>
    </p>
    <p style="margin-left:0px;">
     <span style="color:#000000;">
     </span>
     <span style="color:#0000ff;">
      var
     </span>
     <span style="color:#000000;">
     </span>
     <span style="color:#000000;">
      json = JSON.parse(message.toString());
     </span>
    </p>
    <p style="margin-left:0px;">
     <span style="color:#000000;">
     </span>
     <span style="color:#000000;">
      console.log(
     </span>
     <span style="color:#800000;">
      "LED="
     </span>
     <span style="color:#000000;">
      + json.params.LED.toString());
     </span>
    </p>
    <p style="margin-left:0px;">
     <span style="color:#000000;">
     </span>
     <span style="color:#000000;">
      led.write( json.params.LED);
     </span>
     <span style="color:#000000;">
     </span>
     <span style="color:#000000;">
     </span>
    </p>
    <p style="margin-left:0px;">
     <span style="color:#000000;">
      });
     </span>
    </p>
    <p style="margin-left:0px;">
     <span style="color:#000000;">
      getPostData
     </span>
     <span style="color:#000000;">
      函数需要改造一下，把温湿度函数增加进去：
     </span>
    </p>
    <p style="margin-left:0px;">
     <span style="color:#0000ff;">
      function
     </span>
     <span style="color:#000000;">
      getPostData(){
      <!-- -->
     </span>
     <span style="color:#000000;">
     </span>
    </p>
    <p style="margin-left:0px;">
     <span style="color:#000000;">
     </span>
     <span style="color:#0000ff;">
      var
     </span>
     <span style="color:#000000;">
      readout = sensorLib.read();
     </span>
    </p>
    <p style="margin-left:0px;">
     <span style="color:#000000;">
     </span>
     <span style="color:#0000ff;">
      const
     </span>
     <span style="color:#000000;">
      payloadJson = {
      <!-- -->
     </span>
    </p>
    <p style="margin-left:0px;">
     <span style="color:#000000;">
     </span>
     <span style="color:#000000;">
      id: Date.now(),
     </span>
    </p>
    <p style="margin-left:0px;">
     <span style="color:#000000;">
     </span>
     <span style="color:#000000;">
      params: {
      <!-- -->
     </span>
    </p>
    <p style="margin-left:0px;">
     <span style="color:#000000;">
     </span>
     <span style="color:#000000;">
      temperature: readout.temperature.toFixed(1),
     </span>
    </p>
    <p style="margin-left:0px;">
     <span style="color:#000000;">
     </span>
     <span style="color:#000000;">
      humidity: readout.humidity.toFixed(1)
     </span>
    </p>
    <p style="margin-left:0px;">
     <span style="color:#000000;">
     </span>
     <span style="color:#000000;">
      },
     </span>
    </p>
    <p style="margin-left:0px;">
     <span style="color:#000000;">
     </span>
     <span style="color:#000000;">
      method:
     </span>
     <span style="color:#800000;">
      "thing.event.property.post"
     </span>
    </p>
    <p style="margin-left:0px;">
     <span style="color:#000000;">
     </span>
     <span style="color:#000000;">
      }
     </span>
    </p>
    <p style="margin-left:0px;">
     <span style="color:#000000;">
      阿里云物联网平台上我们所创建的设备保持不变（参见
     </span>
     <span style="color:#000000;">
      Python
     </span>
     <span style="color:#000000;">
      篇），我们去对接云端的这个设备。
     </span>
    </p>
    <p style="margin-left:0px;">
     <span style="color:#000000;">
      执行代码需要前面加
     </span>
     <span style="color:#000000;">
      sudo
     </span>
     <span style="color:#000000;">
      ，否则会出错。执行结果如下：
     </span>
    </p>
    <p style="margin-left:0px;">
     <img alt="" class="has" src="https://i-blog.csdnimg.cn/blog_migrate/82dc76351dfa423d8e6e9087f0b98748.jpeg"/>
    </p>
    <p style="margin-left:0px;">
     <span style="color:#000000;">
      本文相关的代码文件：
     </span>
     <a href="https://pan.baidu.com/s/1lmZN0fJbtKgxVxIuO9tVpw" rel="nofollow">
      nodejs_dht11_led.js
     </a>
    </p>
    <h3 style="margin-left:0px;">
     <span style="color:#000000;">
      阿里云物联网平台链接：
     </span>
     <span style="color:#000000;">
      https://dev.iot.aliyun.com/sale?source=deveco_partner_yefan
     </span>
    </h3>
    <p style="margin-left:0px;">
     <span style="color:#000000;">
     </span>
    </p>
   </div>
  </div>
 </article>
 <p alt="6874747073:3a2f2f626c6f672e6373646e2e6e65742f796566616e716975:2f61727469636c652f64657461696c732f3834393439353835" class_="artid" style="display:none">
 </p>
</div>


