---
layout: post
title: "linux下文件读写操作"
date: 2025-03-10 20:33:31 +0800
description: "Linux下，文件I/O是操作系统与文件系统之间进行数据传输的关键部分。文件I/O操作允许程序读取和写入文件，管理文件的打开、关闭、创建和删除等操作。"
keywords: "linux下文件读写操作"
categories: ['Linux']
tags: ['Spring', 'Linux', 'Java']
artid: "146163414"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146163414
    alt: "linux下文件读写操作"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146163414
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146163414
cover: https://bing.ee123.net/img/rand?artid=146163414
image: https://bing.ee123.net/img/rand?artid=146163414
img: https://bing.ee123.net/img/rand?artid=146163414
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     linux下文件读写操作
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     Linux下，文件I/O是操作系统与文件系统之间进行数据传输的关键部分。文件I/O操作允许程序读取和写入文件，管理文件的打开、关闭、创建和删除等操作。
    </p>
    <h4>
     <a id="1__2">
     </a>
     1. 文件描述符
    </h4>
    <p>
     在Linux中，每个打开的文件都由一个文件描述符来表示。文件描述符是一个非负整数，通常从0开始，分别表示标准输入stdin、标准输出stdout和标准错误stderr。用户程序打开文件后，操作系统会为其分配一个文件描述符。
    </p>
    <h4>
     <a id="2__6">
     </a>
     2. 文件操作函数
    </h4>
    <p>
     Linux提供了一系列的系统调用和库函数来进行文件操作，主要包括：
    </p>
    <ul>
     <li>
      <p>
       <strong>
        打开文件
       </strong>
      </p>
      <ul>
       <li>
        <pre><code>open()
</code></pre>
        <p>
         打开文件并返回文件描述符。文件描述符是进程访问文件的句柄，后续的
         <code>
          read()
         </code>
         和
         <code>
          write()
         </code>
         操作都需要通过它进行。
        </p>
        <pre><code class="prism language-c"><span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"filename"</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        读取文件
       </strong>
      </p>
      <ul>
       <li>
        <pre><code>read()
</code></pre>
        <p>
         从文件中读取数据。
        </p>
        <pre><code class="prism language-c"><span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token class-name">ssize_t</span> bytes_read <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
        <ul>
         <li>
          流程
          <ol>
           <li>
            进程调用
            <code>
             read()
            </code>
            ，请求从文件中读取数据。
           </li>
           <li>
            内核检查页缓存中是否存在请求的数据
            <ul>
             <li>
              如果数据在页缓存中，内核将数据从页缓存复制到用户空间的缓冲区。
             </li>
             <li>
              如果数据不在页缓存中，内核会从磁盘读取数据到页缓存，然后再复制到用户空间。
             </li>
            </ul>
           </li>
           <li>
            <strong>
             返回实际读取的字节数。
            </strong>
           </li>
          </ol>
         </li>
        </ul>
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        写入文件
       </strong>
      </p>
      <ul>
       <li>
        <pre><code>write()
</code></pre>
        <p>
         向文件中写入数据。
        </p>
        <pre><code class="prism language-c"><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>text <span class="token operator">=</span> <span class="token string">"Hello, world!"</span><span class="token punctuation">;</span>
<span class="token class-name">ssize_t</span> bytes_written <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> text<span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
        <ul>
         <li>
          流程
          <ol>
           <li>
            进程调用
            <code>
             write()
            </code>
            ，请求将数据写入文件。
           </li>
           <li>
            内核将数据从用户空间复制到页缓存中。
           </li>
           <li>
            数据被标记为“脏页”，表示需要写回磁盘。
           </li>
           <li>
            内核的
            <strong>
             页回写机制
            </strong>
            会在适当的时候将脏页写回磁盘。
           </li>
          </ol>
         </li>
        </ul>
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        页缓存的作用
       </strong>
      </p>
      <ul>
       <li>
        页缓存是内核维护的一块内存区域，用于缓存文件数据。
       </li>
       <li>
        作用
        <ol>
         <li>
          <strong>
           减少磁盘I/O
          </strong>
          ：通过缓存文件数据，减少对磁盘的直接访问，提高性能。
         </li>
         <li>
          <strong>
           延迟写入
          </strong>
          ：
          <code>
           write()
          </code>
          操作不会立即将数据写入磁盘，而是先写入页缓存，由内核在后续的某个时间点写回磁盘。
         </li>
         <li>
          <strong>
           预读机制
          </strong>
          ：内核会提前读取文件数据到页缓存中，优化后续的
          <code>
           read()
          </code>
          操作。
         </li>
        </ol>
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        关闭文件
       </strong>
      </p>
      <ul>
       <li>
        <pre><code>close()
</code></pre>
        <p>
         使用
         <code>
          close()
         </code>
         系统调用关闭文件，释放文件描述符。
        </p>
        <pre><code class="prism language-c"><span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        文件状态信息
       </strong>
      </p>
      <ul>
       <li>
        <code>
         fstat()
        </code>
        : 获取文件的状态信息。
       </li>
       <li>
        <code>
         stat()
        </code>
        : 获取文件的状态信息（用于路径名）。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        页回写机制
       </strong>
      </p>
      <ul>
       <li>
        内核会在以下情况下将脏页写回磁盘
        <ol>
         <li>
          页缓存中的脏页达到一定比例。
         </li>
         <li>
          进程调用
          <code>
           fsync()
          </code>
          或
          <code>
           fdatasync()
          </code>
          强制刷新页缓存。
         </li>
         <li>
          系统内存不足时，内核会回收脏页。
         </li>
        </ol>
       </li>
      </ul>
     </li>
    </ul>
    <h4>
     <a id="3__93">
     </a>
     3. 文件打开模式
    </h4>
    <p>
     在使用
     <code>
      open()
     </code>
     函数时，可以指定不同的文件打开模式
    </p>
    <ul>
     <li>
      <code>
       O_RDONLY
      </code>
      : 只读模式。
     </li>
     <li>
      <code>
       O_WRONLY
      </code>
      : 只写模式。
     </li>
     <li>
      <code>
       O_RDWR
      </code>
      : 读写模式。
     </li>
     <li>
      <code>
       O_CREAT
      </code>
      : 如果文件不存在则创建文件。
     </li>
     <li>
      <code>
       O_TRUNC
      </code>
      : 如果文件存在并以写入模式打开，则将其截断为零长度。
     </li>
     <li>
      <code>
       O_APPEND
      </code>
      : 以追加模式打开文件。
     </li>
    </ul>
    <h4>
     <a id="4_IO_104">
     </a>
     4. 文件I/O缓冲
    </h4>
    <p>
     Linux使用缓冲区来提高文件I/O的效率。标准库函数如
     <code>
      fread()
     </code>
     、
     <code>
      fwrite()
     </code>
     通常会使用缓冲I/O，而系统调用如
     <code>
      read()
     </code>
     、
     <code>
      write()
     </code>
     则直接与内核进行交互。缓冲区的使用可以减少系统调用的次数，从而提高性能。
    </p>
    <h4>
     <a id="5__108">
     </a>
     5. 文件锁定
    </h4>
    <p>
     在多进程或多线程环境中，文件锁定机制可以防止多个进程同时写入同一个文件，导致数据不一致。常用的文件锁定方法包括
    </p>
    <ul>
     <li>
      <strong>
       共享锁（read lock）
      </strong>
      ：允许多个进程同时读取文件。
     </li>
     <li>
      <strong>
       独占锁（write lock）
      </strong>
      ：只允许一个进程写入文件。
     </li>
    </ul>
    <p>
     可以使用
     <code>
      flock()
     </code>
     或
     <code>
      fcntl()
     </code>
     进行文件锁定。
    </p>
    <h4>
     <a id="6__117">
     </a>
     6. 目录操作
    </h4>
    <p>
     除了普通文件，Linux还支持目录操作。常用的目录操作函数包括：
    </p>
    <ul>
     <li>
      <code>
       opendir()
      </code>
      : 打开目录。
     </li>
     <li>
      <code>
       readdir()
      </code>
      : 读取目录中的条目。
     </li>
     <li>
      <code>
       closedir()
      </code>
      : 关闭目录。
     </li>
    </ul>
    <h4>
     <a id="7__125">
     </a>
     7. 文件权限与所有权
    </h4>
    <p>
     Linux文件系统具有严格的权限控制。每个文件都有所有者、组和其他用户的权限，可以通过
     <code>
      chmod
     </code>
     、
     <code>
      chown
     </code>
     等命令进行管理。
    </p>
    <h4>
     <a id="8__129">
     </a>
     8. 文件系统
    </h4>
    <p>
     Linux支持多种文件系统，如ext4、XFS、Btrfs等。每种文件系统都有其特定的特点和优缺点，适合不同的使用场景。
    </p>
    <h4>
     <a id="9_IO_133">
     </a>
     9. 异步I/O
    </h4>
    <p>
     Linux还支持异步I/O（AIO），允许程序在进行I/O操作时继续执行其他任务，而不必等待I/O操作完成。可以使用
     <code>
      aio_read()
     </code>
     和
     <code>
      aio_write()
     </code>
     函数实现异步I/O。
    </p>
    <h4>
     <a id="1__137">
     </a>
     例子1. 文件的创建与写入
    </h4>
    <pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> fd<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>text <span class="token operator">=</span> <span class="token string">"Hello, Linux File I/O!\n"</span><span class="token punctuation">;</span>

    <span class="token comment">// 创建并打开文件</span>
    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"example.txt"</span><span class="token punctuation">,</span> O_WRONLY <span class="token operator">|</span> O_CREAT <span class="token operator">|</span> O_TRUNC<span class="token punctuation">,</span> S_IRUSR <span class="token operator">|</span> S_IWUSR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Error opening file"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 写入数据</span>
    <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> text<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 关闭文件</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="2__165">
     </a>
     例子2. 文件的读取
    </h4>
    <pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> fd<span class="token punctuation">;</span>
    <span class="token keyword">char</span> buffer<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token class-name">ssize_t</span> bytesRead<span class="token punctuation">;</span>

    <span class="token comment">// 打开文件</span>
    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"example.txt"</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Error opening file"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 读取数据</span>
    bytesRead <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bytesRead <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Error reading file"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 添加字符串结束符</span>
    buffer<span class="token punctuation">[</span>bytesRead<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>

    <span class="token comment">// 打印读取的数据</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Read from file: %s"</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 关闭文件</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="3__204">
     </a>
     例子3. 追加写入文件
    </h4>
    <pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> fd<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>text <span class="token operator">=</span> <span class="token string">"Appending this line.\n"</span><span class="token punctuation">;</span>

    <span class="token comment">// 以追加模式打开文件</span>
    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"example.txt"</span><span class="token punctuation">,</span> O_WRONLY <span class="token operator">|</span> O_APPEND<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Error opening file"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 追加写入数据</span>
    <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> text<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 关闭文件</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="4__232">
     </a>
     例子4. 目录操作示例
    </h4>
    <pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;dirent.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    DIR <span class="token operator">*</span>dir<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">dirent</span> <span class="token operator">*</span>entry<span class="token punctuation">;</span>

    <span class="token comment">// 打开当前目录</span>
    dir <span class="token operator">=</span> <span class="token function">opendir</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dir <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Error opening directory"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 读取目录项</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>entry <span class="token operator">=</span> <span class="token function">readdir</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Found file: %s\n"</span><span class="token punctuation">,</span> entry<span class="token operator">-&gt;</span>d_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 关闭目录</span>
    <span class="token function">closedir</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="5__260">
     </a>
     例子5. 文件锁定示例
    </h4>
    <pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> fd<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">flock</span> lock<span class="token punctuation">;</span>

    <span class="token comment">// 打开文件</span>
    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"example.txt"</span><span class="token punctuation">,</span> O_WRONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Error opening file"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 初始化锁</span>
    lock<span class="token punctuation">.</span>l_type <span class="token operator">=</span> F_WRLCK<span class="token punctuation">;</span> <span class="token comment">// 写锁</span>
    lock<span class="token punctuation">.</span>l_whence <span class="token operator">=</span> <span class="token constant">SEEK_SET</span><span class="token punctuation">;</span>
    lock<span class="token punctuation">.</span>l_start <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    lock<span class="token punctuation">.</span>l_len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 锁定整个文件</span>

    <span class="token comment">// 加锁</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fcntl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> F_SETLK<span class="token punctuation">,</span> <span class="token operator">&amp;</span>lock<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Error locking file"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 写入数据</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>text <span class="token operator">=</span> <span class="token string">"This is a locked write.\n"</span><span class="token punctuation">;</span>
    <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> text<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 解锁</span>
    lock<span class="token punctuation">.</span>l_type <span class="token operator">=</span> F_UNLCK<span class="token punctuation">;</span>
    <span class="token function">fcntl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> F_SETLK<span class="token punctuation">,</span> <span class="token operator">&amp;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 关闭文件</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     在Linux中，如果要对其他目录中的文件进行I/O操作，只需在文件路径中指定完整的路径名。
    </p>
    <h4>
     <a id="1__308">
     </a>
     1. 在其他目录中创建和写入文件
    </h4>
    <p>
     假设你想在
     <code>
      /tmp
     </code>
     目录下创建一个文件并写入数据，可以这样做：
    </p>
    <pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> fd<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>text <span class="token operator">=</span> <span class="token string">"Hello, Linux File I/O in /tmp!\n"</span><span class="token punctuation">;</span>

    <span class="token comment">// 创建并打开/tmp目录下的文件</span>
    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/tmp/example.txt"</span><span class="token punctuation">,</span> O_WRONLY <span class="token operator">|</span> O_CREAT <span class="token operator">|</span> O_TRUNC<span class="token punctuation">,</span> S_IRUSR <span class="token operator">|</span> S_IWUSR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Error opening file"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 写入数据</span>
    <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> text<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 关闭文件</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="2__338">
     </a>
     2. 从其他目录读取文件
    </h4>
    <p>
     如果要从
     <code>
      /tmp
     </code>
     目录读取文件，可以使用类似的方式：
    </p>
    <pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> fd<span class="token punctuation">;</span>
    <span class="token keyword">char</span> buffer<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token class-name">ssize_t</span> bytesRead<span class="token punctuation">;</span>

    <span class="token comment">// 打开/tmp目录下的文件</span>
    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/tmp/example.txt"</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Error opening file"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 读取数据</span>
    bytesRead <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bytesRead <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Error reading file"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 添加字符串结束符</span>
    buffer<span class="token punctuation">[</span>bytesRead<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>

    <span class="token comment">// 打印读取的数据</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Read from file: %s"</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 关闭文件</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="3__379">
     </a>
     3. 追加写入其他目录的文件
    </h4>
    <p>
     如果需要在
     <code>
      /tmp/example.txt
     </code>
     中追加数据，可以这样操作：
    </p>
    <pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> fd<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>text <span class="token operator">=</span> <span class="token string">"Appending this line to /tmp/example.txt.\n"</span><span class="token punctuation">;</span>

    <span class="token comment">// 以追加模式打开/tmp目录下的文件</span>
    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/tmp/example.txt"</span><span class="token punctuation">,</span> O_WRONLY <span class="token operator">|</span> O_APPEND<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Error opening file"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 追加写入数据</span>
    <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> text<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 关闭文件</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="4__409">
     </a>
     4. 处理文件路径中的空格和特殊字符
    </h4>
    <p>
     如果文件路径中包含空格或特殊字符，可以使用转义字符或用引号括起来。例如：
    </p>
    <pre><code class="prism language-c"><span class="token comment">// 假设文件路径为 "/tmp/my file.txt"</span>
fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/tmp/my\\ file.txt"</span><span class="token punctuation">,</span> O_WRONLY <span class="token operator">|</span> O_CREAT <span class="token operator">|</span> O_TRUNC<span class="token punctuation">,</span> S_IRUSR <span class="token operator">|</span> S_IWUSR<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     或者：
    </p>
    <pre><code class="prism language-c">fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"\"/tmp/my file.txt\""</span><span class="token punctuation">,</span> O_WRONLY <span class="token operator">|</span> O_CREAT <span class="token operator">|</span> O_TRUNC<span class="token punctuation">,</span> S_IRUSR <span class="token operator">|</span> S_IWUSR<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f36343733363230342f:61727469636c652f64657461696c732f313436313633343134" class_="artid" style="display:none">
 </p>
</div>


