---
layout: post
title: "OKHttp3-源码阅读-Kotlin版本"
date: 2025-03-10 19:58:30 +0800
description: "OKHttp 是由 Square 公司开源的，广泛应用于 Android 开发中，并且是 Retrofit 的底层实现。它是一个高效的 HTTP 客户端，适用于 Android 和 Java 应用程序。它支持 HTTP/2、连接池、GZIP 压缩、缓存等功能，能够帮助开发者更高效地处理网络请求。从 Android 4.4 开始 HttpURLConnection 的底层实现采用的是OKHttp。OkHttp是一个功能强大且灵活的HTTP客户端库，适用于各种网络请求场景。"
keywords: "OKHttp3 源码阅读 - Kotlin版本"
categories: ['开源框架']
tags: ['开源', 'Android']
artid: "146137995"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146137995
    alt: "OKHttp3-源码阅读-Kotlin版本"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146137995
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146137995
cover: https://bing.ee123.net/img/rand?artid=146137995
image: https://bing.ee123.net/img/rand?artid=146137995
img: https://bing.ee123.net/img/rand?artid=146137995
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     OKHttp3 源码阅读 - Kotlin版本
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     <em>
      本篇文章基于 OKHttp 4.11.0 版本阅读的。
     </em>
    </p>
    <h2>
     <a id="1__2">
     </a>
     1. 介绍
    </h2>
    <p>
     OKHttp 是由 Square 公司开源的，广泛应用于 Android 开发中，并且是 Retrofit 的底层实现。它是一个高效的 HTTP 客户端，适用于 Android 和 Java 应用程序。它支持 HTTP/2、连接池、GZIP 压缩、缓存等功能，能够帮助开发者更高效地处理网络请求。
    </p>
    <p>
     从 Android 4.4 开始 HttpURLConnection 的底层实现采用的是OKHttp。
    </p>
    <h2>
     <a id="2__6">
     </a>
     2. 基本使用
    </h2>
    <p>
     （1）基本使用
    </p>
    <ul>
     <li>
      添加依赖
     </li>
    </ul>
    <pre><code class="prism language-java">implementation <span class="token string">"com.squareup.okhttp3.okhttp:$version"</span>
</code></pre>
    <ul>
     <li>
      使用OkHttp发送一个GET请求
     </li>
    </ul>
    <pre><code class="prism language-java"><span class="token keyword">var</span> client <span class="token operator">=</span> <span class="token class-name">OkHttpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> request<span class="token operator">:</span> <span class="token class-name">Request</span> <span class="token operator">=</span> <span class="token class-name">Request<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token string">"https://api.example.com/data"</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> response<span class="token operator">:</span> <span class="token class-name">Response</span> <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">newCall</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> responseData<span class="token operator">:</span> <span class="token class-name">String</span> <span class="token operator">=</span> response<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
    <ul>
     <li>
      使用OkHttp发送一个POST请求
     </li>
    </ul>
    <pre><code class="prism language-java"><span class="token class-name">OkHttpClient</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OkHttpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">RequestBody</span> body <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormBody<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"key1"</span><span class="token punctuation">,</span> <span class="token string">"value1"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"key2"</span><span class="token punctuation">,</span> <span class="token string">"value2"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Request</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Request<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token string">"https://api.example.com/submit"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Response</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">newCall</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> responseData <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     （2）调用流程
    </p>
    <p>
     OkHttp 的工作流程可以概括为以下几个步骤：
    </p>
    <ol>
     <li>
      创建请求：先创建一个OKHttpClient对象，然后通过 Request.Builder 构建一个 Request 对象。
     </li>
     <li>
      执行请求：通过 OkHttpClient.newCall(request) 创建一个 Call 对象，调用 execute() （同步）或 enqueue() （异步）方法执行请求。
     </li>
     <li>
      分发器：Dispatcher 分发任务，它内部维护队列与线程池，完成请求调配。
     </li>
     <li>
      拦截器链：请求会经过一系列的拦截器（如重试、缓存、网络拦截器等），最终发送到服务器。
     </li>
     <li>
      获取响应：服务器返回的响应会经过拦截器链处理，最终返回给调用者。
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/33174447e7ef4a18837d4972f25703b8.png"/>
     </li>
    </ol>
    <h2>
     <a id="3__51">
     </a>
     3. 源码阅读
    </h2>
    <h3>
     <a id="31___52">
     </a>
     3.1 创建请求
    </h3>
    <p>
     （1）首先在 OkHttpClient 构造方法中，通过 Builder 模式构建了 OkHttpClient 对象。作为全局的客户端对象，负责管理请求的配置（如超时、缓存、拦截器等）。
    </p>
    <pre><code class="prism language-kotlin"><span class="token comment">// OkHttpClient.kt</span>
<span class="token operator">..</span><span class="token punctuation">.</span>
<span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token function">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> Builder <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">internal</span> <span class="token keyword">var</span> dispatcher<span class="token operator">:</span> Dispatcher <span class="token operator">=</span> <span class="token function">Dispatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">internal</span> <span class="token keyword">var</span> connectionPool<span class="token operator">:</span> ConnectionPool <span class="token operator">=</span> <span class="token function">ConnectionPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">internal</span> <span class="token keyword">val</span> interceptors<span class="token operator">:</span> MutableList<span class="token operator">&lt;</span>Interceptor<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">mutableListOf</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">internal</span> <span class="token keyword">val</span> networkInterceptors<span class="token operator">:</span> MutableList<span class="token operator">&lt;</span>Interceptor<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">mutableListOf</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">internal</span> <span class="token keyword">var</span> eventListenerFactory<span class="token operator">:</span> EventListener<span class="token punctuation">.</span>Factory <span class="token operator">=</span> EventListener<span class="token punctuation">.</span>NONE<span class="token punctuation">.</span><span class="token function">asFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">internal</span> <span class="token keyword">var</span> retryOnConnectionFailure <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token keyword">internal</span> <span class="token keyword">var</span> authenticator<span class="token operator">:</span> Authenticator <span class="token operator">=</span> Authenticator<span class="token punctuation">.</span>NONE
    <span class="token keyword">internal</span> <span class="token keyword">var</span> followRedirects <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token keyword">internal</span> <span class="token keyword">var</span> followSslRedirects <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token operator">..</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
<span class="token operator">..</span><span class="token punctuation">.</span>
</code></pre>
    <p>
     （2）然后通过 Request.Builder 构建一个 Request 对象，也是用了 build 建造者模式。封装了 HTTP 请求到 URL、方法（GET/POST）、请求头、请求体等信息。
    </p>
    <pre><code class="prism language-kotlin"><span class="token comment">// Request.kt</span>
<span class="token operator">..</span><span class="token punctuation">.</span>
<span class="token keyword">open</span> <span class="token keyword">class</span> Builder <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">internal</span> <span class="token keyword">var</span> url<span class="token operator">:</span> HttpUrl<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token keyword">internal</span> <span class="token keyword">var</span> method<span class="token operator">:</span> String
    <span class="token keyword">internal</span> <span class="token keyword">var</span> headers<span class="token operator">:</span> Headers<span class="token punctuation">.</span>Builder
    <span class="token keyword">internal</span> <span class="token keyword">var</span> body<span class="token operator">:</span> RequestBody<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>

    <span class="token comment">/** A mutable map of tags, or an immutable empty map if we don't have any. */</span>
    <span class="token keyword">internal</span> <span class="token keyword">var</span> tags<span class="token operator">:</span> MutableMap<span class="token operator">&lt;</span>Class<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> Any<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">mutableMapOf</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>method <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"GET"</span></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>headers <span class="token operator">=</span> Headers<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">internal</span> <span class="token keyword">constructor</span><span class="token punctuation">(</span>request<span class="token operator">:</span> Request<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>url <span class="token operator">=</span> request<span class="token punctuation">.</span>url
      <span class="token keyword">this</span><span class="token punctuation">.</span>method <span class="token operator">=</span> request<span class="token punctuation">.</span>method
      <span class="token keyword">this</span><span class="token punctuation">.</span>body <span class="token operator">=</span> request<span class="token punctuation">.</span>body
      <span class="token keyword">this</span><span class="token punctuation">.</span>tags <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>tags<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">mutableMapOf</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        request<span class="token punctuation">.</span>tags<span class="token punctuation">.</span><span class="token function">toMutableMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>headers <span class="token operator">=</span> request<span class="token punctuation">.</span>headers<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token operator">..</span><span class="token punctuation">.</span>
 <span class="token punctuation">}</span>
 <span class="token operator">..</span><span class="token punctuation">.</span>
</code></pre>
    <h3>
     <a id="32____108">
     </a>
     3.2 执行请求 和 分发器分发请求
    </h3>
    <p>
     （1）首先通过 OkHttpClient.newCall(request) 创建一个 Call 对象，Call 是一个接口，真正的实现是在 RealCall 中。
    </p>
    <pre><code class="prism language-kotlin"><span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">newCall</span><span class="token punctuation">(</span>request<span class="token operator">:</span> Request<span class="token punctuation">)</span><span class="token operator">:</span> Call <span class="token operator">=</span> <span class="token function">RealCall</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> request<span class="token punctuation">,</span> forWebSocket <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     （2）然后再通过 RealCall 去执行异步请求或同步请求。
    </p>
    <ul>
     <li>
      <strong>
       异步请求 enqueue()
      </strong>
     </li>
    </ul>
    <pre><code class="prism language-kotlin"><span class="token comment">// RealCall.kt</span>
<span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">enqueue</span><span class="token punctuation">(</span>responseCallback<span class="token operator">:</span> Callback<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 代码1 用 AtomicBoolean 检查 realcall 是否被用过了</span>
    <span class="token function">check</span><span class="token punctuation">(</span>executed<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token string-literal singleline"><span class="token string">"Already Executed"</span></span> <span class="token punctuation">}</span>

    <span class="token function">callStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 代码2 调用分发器执行异步请求</span>
    client<span class="token punctuation">.</span>dispatcher<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span><span class="token function">AsyncCall</span><span class="token punctuation">(</span>responseCallback<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre>
    <p>
     代码1，用 AtomicBoolean 检查 realcall 是否被用过了。
     <br/>
     代码2，调用分发器执行异步请求。这里传的是 AsyncCall，一个 runnable。
    </p>
    <p>
     下面我们就看一下 Dispatcher 的 enqueue() 方法，
    </p>
    <pre><code class="prism language-kotlin"><span class="token comment">// Dispatcher.kt</span>
<span class="token operator">..</span><span class="token punctuation">.</span>
  <span class="token comment">// 代码1 异步等待队列</span>
  <span class="token keyword">private</span> <span class="token keyword">val</span> readyAsyncCalls <span class="token operator">=</span> ArrayDeque<span class="token operator">&lt;</span>AsyncCall<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token comment">// 代码2 异步运行队列</span>
  <span class="token keyword">private</span> <span class="token keyword">val</span> runningAsyncCalls <span class="token operator">=</span> ArrayDeque<span class="token operator">&lt;</span>AsyncCall<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">internal</span> <span class="token keyword">fun</span> <span class="token function">enqueue</span><span class="token punctuation">(</span>call<span class="token operator">:</span> AsyncCall<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 代码3 将Call 加入到异步等待队列</span>
      readyAsyncCalls<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>call<span class="token punctuation">)</span>

      <span class="token comment">// 代码4 判断请求是不是 websocket</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>call<span class="token punctuation">.</span>call<span class="token punctuation">.</span>forWebSocket<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">val</span> existingCall <span class="token operator">=</span> <span class="token function">findExistingCallWithHost</span><span class="token punctuation">(</span>call<span class="token punctuation">.</span>host<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>existingCall <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> call<span class="token punctuation">.</span><span class="token function">reuseCallsPerHostFrom</span><span class="token punctuation">(</span>existingCall<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 代码5</span>
    <span class="token function">promoteAndExecute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  
   <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">promoteAndExecute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">assertThreadDoesntHoldLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">val</span> executableCalls <span class="token operator">=</span> mutableListOf<span class="token operator">&lt;</span>AsyncCall<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> isRunning<span class="token operator">:</span> Boolean
    <span class="token function">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">val</span> i <span class="token operator">=</span> readyAsyncCalls<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">// 代码6 迭代异步等待队列</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">val</span> asyncCall <span class="token operator">=</span> i<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">//代码7 所有同时请求数不能大于64</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>runningAsyncCalls<span class="token punctuation">.</span>size <span class="token operator">&gt;=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>maxRequests<span class="token punctuation">)</span> <span class="token keyword">break</span> <span class="token comment">// Max capacity.</span>
        <span class="token comment">// 代码8 同一个host同时请求数不能大于5。</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>asyncCall<span class="token punctuation">.</span>callsPerHost<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>maxRequestsPerHost<span class="token punctuation">)</span> <span class="token keyword">continue</span> <span class="token comment">// Host max capacity.</span>

		<span class="token comment">// 代码9 将 call 从异步等待队列移除</span>
        i<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        asyncCall<span class="token punctuation">.</span>callsPerHost<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        executableCalls<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>asyncCall<span class="token punctuation">)</span>
        <span class="token comment">// 代码10 将 call 加入到异步正在执行队列中</span>
        runningAsyncCalls<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>asyncCall<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      isRunning <span class="token operator">=</span> <span class="token function">runningCallsCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">in</span> <span class="token number">0</span> until executableCalls<span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">val</span> asyncCall <span class="token operator">=</span> executableCalls<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
      <span class="token comment">// 代码11 开始执行</span>
      asyncCall<span class="token punctuation">.</span><span class="token function">executeOn</span><span class="token punctuation">(</span>executorService<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> isRunning
  <span class="token punctuation">}</span>
  <span class="token operator">..</span><span class="token punctuation">.</span>
</code></pre>
    <p>
     在 enqueue() 中，先将我们的 Call 加入到异步等待队列，然后判断请求是不是 websocket，如果不是的，调用 findExistingCallWithHost() 查找有没有已经存在的 host。如果不存在调用 promoteAndExecute()，迭代异步等待队列。这里有两个限制，所有同时请求数不能大于64。同一个host同时请求数不能大于5。如果两个限制条件都满足，将 call 从异步等待队列移除，并加入到异步正在执行队列中，然后将请求任务交给线程池去执行请求。
    </p>
    <p>
     接着，我们再看一下 AsyncCall 的 run() 方法，这里是分发器异步请求分发流程，
    </p>
    <pre><code class="prism language-kotlin"><span class="token comment">// RealCall.kt</span>
<span class="token operator">..</span><span class="token punctuation">.</span>
<span class="token keyword">internal</span> <span class="token keyword">inner</span> <span class="token keyword">class</span> <span class="token function">AsyncCall</span><span class="token punctuation">(</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> responseCallback<span class="token operator">:</span> Callback
  <span class="token punctuation">)</span> <span class="token operator">:</span> Runnable <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 代码1</span>
    <span class="token annotation builtin">@Volatile</span> <span class="token keyword">var</span> callsPerHost <span class="token operator">=</span> <span class="token function">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token keyword">private</span> <span class="token keyword">set</span>

    <span class="token keyword">fun</span> <span class="token function">reuseCallsPerHostFrom</span><span class="token punctuation">(</span>other<span class="token operator">:</span> AsyncCall<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>callsPerHost <span class="token operator">=</span> other<span class="token punctuation">.</span>callsPerHost
    <span class="token punctuation">}</span>

    <span class="token keyword">val</span> host<span class="token operator">:</span> String
      <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> originalRequest<span class="token punctuation">.</span>url<span class="token punctuation">.</span>host

    <span class="token keyword">val</span> request<span class="token operator">:</span> Request
        <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> originalRequest

    <span class="token keyword">val</span> call<span class="token operator">:</span> RealCall
        <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token label symbol">@RealCall</span>

    <span class="token comment">/**
     * Attempt to enqueue this async call on [executorService]. This will attempt to clean up
     * if the executor has been shut down by reporting the call as failed.
     */</span>
    <span class="token keyword">fun</span> <span class="token function">executeOn</span><span class="token punctuation">(</span>executorService<span class="token operator">:</span> ExecutorService<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      client<span class="token punctuation">.</span>dispatcher<span class="token punctuation">.</span><span class="token function">assertThreadDoesntHoldLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

      <span class="token keyword">var</span> success <span class="token operator">=</span> <span class="token boolean">false</span>
      <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 代码2 将异步任务放到线程池中</span>
        executorService<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
        success <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> RejectedExecutionException<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">val</span> ioException <span class="token operator">=</span> <span class="token function">InterruptedIOException</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"executor rejected"</span></span><span class="token punctuation">)</span>
        ioException<span class="token punctuation">.</span><span class="token function">initCause</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
        <span class="token function">noMoreExchanges</span><span class="token punctuation">(</span>ioException<span class="token punctuation">)</span>
        responseCallback<span class="token punctuation">.</span><span class="token function">onFailure</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token label symbol">@RealCall</span><span class="token punctuation">,</span> ioException<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          client<span class="token punctuation">.</span>dispatcher<span class="token punctuation">.</span><span class="token function">finished</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token comment">// This call is no longer running!</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">threadName</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"OkHttp </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token expression"><span class="token function">redactedUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">var</span> signalledCallback <span class="token operator">=</span> <span class="token boolean">false</span>
        timeout<span class="token punctuation">.</span><span class="token function">enter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 代码3 调用责任分发请求</span>
          <span class="token keyword">val</span> response <span class="token operator">=</span> <span class="token function">getResponseWithInterceptorChain</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          signalledCallback <span class="token operator">=</span> <span class="token boolean">true</span>
          responseCallback<span class="token punctuation">.</span><span class="token function">onResponse</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token label symbol">@RealCall</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> IOException<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>signalledCallback<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// Do not signal the callback twice!</span>
            Platform<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Callback failure for </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token expression"><span class="token function">toLoggableString</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span> Platform<span class="token punctuation">.</span>INFO<span class="token punctuation">,</span> e<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            responseCallback<span class="token punctuation">.</span><span class="token function">onFailure</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token label symbol">@RealCall</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>t<span class="token operator">:</span> Throwable<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>signalledCallback<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">val</span> canceledException <span class="token operator">=</span> <span class="token function">IOException</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"canceled due to </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">t</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            canceledException<span class="token punctuation">.</span><span class="token function">addSuppressed</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
            responseCallback<span class="token punctuation">.</span><span class="token function">onFailure</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token label symbol">@RealCall</span><span class="token punctuation">,</span> canceledException<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">throw</span> t
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 代码4 请求结束回调</span>
          client<span class="token punctuation">.</span>dispatcher<span class="token punctuation">.</span><span class="token function">finished</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre>
    <p>
     将异步任务放到线程池中后，通过 getResponseWithInterceptorChain() 执行请求，请求完成之后调用分发器 dispatch 的 finished() 方法
    </p>
    <pre><code class="prism language-kotlin"><span class="token keyword">internal</span> <span class="token keyword">fun</span> <span class="token function">finished</span><span class="token punctuation">(</span>call<span class="token operator">:</span> AsyncCall<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    call<span class="token punctuation">.</span>callsPerHost<span class="token punctuation">.</span><span class="token function">decrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">finished</span><span class="token punctuation">(</span>runningAsyncCalls<span class="token punctuation">,</span> call<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token function">finished</span><span class="token punctuation">(</span>calls<span class="token operator">:</span> Deque<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token punctuation">,</span> call<span class="token operator">:</span> T<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">val</span> idleCallback<span class="token operator">:</span> Runnable<span class="token operator">?</span>
    <span class="token function">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>calls<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>call<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token function">AssertionError</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Call wasn't in-flight!"</span></span><span class="token punctuation">)</span>
      idleCallback <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>idleCallback
    <span class="token punctuation">}</span>

    <span class="token keyword">val</span> isRunning <span class="token operator">=</span> <span class="token function">promoteAndExecute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isRunning <span class="token operator">&amp;&amp;</span> idleCallback <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      idleCallback<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre>
    <p>
     在 finish() 方法中，对请求对 host 数减1，并去启动执行任务的方法。
    </p>
    <p>
     我们再看一下异步请求中的线程池，
    </p>
    <pre><code class="prism language-kotlin"><span class="token comment">// Dispatcher.kt</span>
  <span class="token keyword">private</span> <span class="token keyword">var</span> executorServiceOrNull<span class="token operator">:</span> ExecutorService<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>

  <span class="token annotation builtin">@get:Synchronized</span>
  <span class="token annotation builtin">@get:JvmName</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"executorService"</span></span><span class="token punctuation">)</span> <span class="token keyword">val</span> executorService<span class="token operator">:</span> ExecutorService
    <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>executorServiceOrNull <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        executorServiceOrNull <span class="token operator">=</span> <span class="token function">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> Int<span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">,</span>
            <span class="token function">SynchronousQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">threadFactory</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">okHttpName</span></span><span class="token string"> Dispatcher"</span></span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> executorServiceOrNull<span class="token operator">!!</span>
    <span class="token punctuation">}</span>
</code></pre>
    <p>
     Dispatcher 中的线程池是一个核心线程数为 0，最大线程数没有上限，当有任务加入都有新建线程，这是为了能让新来的任务及时执行，而不是等待。
    </p>
    <ul>
     <li>
      <strong>
       同步请求 executed()
      </strong>
     </li>
    </ul>
    <pre><code class="prism language-kotlin"><span class="token comment">// RealCall.kt</span>
 <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Response <span class="token punctuation">{<!-- --></span>
 	<span class="token comment">// 代码1 同 enqueue() 用 AtomicBoolean 检查 realcall 是否被用过了</span>
    <span class="token function">check</span><span class="token punctuation">(</span>executed<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token string-literal singleline"><span class="token string">"Already Executed"</span></span> <span class="token punctuation">}</span>

    timeout<span class="token punctuation">.</span><span class="token function">enter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">callStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token comment">// 代码2 调用分发器执行同步请求</span>
      client<span class="token punctuation">.</span>dispatcher<span class="token punctuation">.</span><span class="token function">executed</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
      <span class="token comment">// 代码3 通过拦截器执行请求</span>
      <span class="token keyword">return</span> <span class="token function">getResponseWithInterceptorChain</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 代码4 请求完执行同步队列的finished。</span>
      client<span class="token punctuation">.</span>dispatcher<span class="token punctuation">.</span><span class="token function">finished</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre>
    <p>
     代码1，同异步请求。
     <br/>
     代码2，调用分发器执行同步请求，这里传入的是 RealCall。
     <br/>
     代码3，调用 getResponseWithInterceptorChain() 方法，通过拦截器执行请求，后面再看。先看分发器的逻辑。
     <br/>
     代码4，请求完执行同步队列的finished。
    </p>
    <p>
     接着看分发器的 executed() 实现，
    </p>
    <pre><code class="prism language-kotlin"><span class="token comment">// Dispatcher.kt</span>
<span class="token comment">// 代码1 同步正在运行队列</span>
<span class="token keyword">private</span> <span class="token keyword">val</span> runningSyncCalls <span class="token operator">=</span> ArrayDeque<span class="token operator">&lt;</span>RealCall<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token comment">/** Used by [Call.execute] to signal it is in-flight. */</span>
  <span class="token annotation builtin">@Synchronized</span> <span class="token keyword">internal</span> <span class="token keyword">fun</span> <span class="token function">executed</span><span class="token punctuation">(</span>call<span class="token operator">:</span> RealCall<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  	<span class="token comment">// 代码2 将 Call 添加到同步正在运行队列中</span>
    runningSyncCalls<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>call<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
 <span class="token comment">/** Used by [Call.execute] to signal completion. */</span>
  <span class="token keyword">internal</span> <span class="token keyword">fun</span> <span class="token function">finished</span><span class="token punctuation">(</span>call<span class="token operator">:</span> RealCall<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">finished</span><span class="token punctuation">(</span>runningSyncCalls<span class="token punctuation">,</span> call<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token function">finished</span><span class="token punctuation">(</span>calls<span class="token operator">:</span> Deque<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token punctuation">,</span> call<span class="token operator">:</span> T<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">val</span> idleCallback<span class="token operator">:</span> Runnable<span class="token operator">?</span>
    <span class="token function">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>calls<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>call<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token function">AssertionError</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Call wasn't in-flight!"</span></span><span class="token punctuation">)</span>
      idleCallback <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>idleCallback
    <span class="token punctuation">}</span>

	<span class="token comment">// 代码3 执行一次异步等待队列到异步正在执行队列的检查</span>
    <span class="token keyword">val</span> isRunning <span class="token operator">=</span> <span class="token function">promoteAndExecute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isRunning <span class="token operator">&amp;&amp;</span> idleCallback <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      idleCallback<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre>
    <p>
     在 Dispatcher 的 executed() 中逻辑很简单，就是将 Call 添加到同步正在运行队列中。同时在同步请求的 finish() 方法中也会执行一次异步等待队列到异步正在执行队列的检查。
    </p>
    <h3>
     <a id="33_OkHttp__375">
     </a>
     3.3 OkHttp 拦截器责任链设计模式
    </h3>
    <ul>
     <li>
      先复习一下责任链模式：
      <br/>
      它是对象行为型模式，为请求创建了一个接收者对象的链，在处理请求的时候执行过滤（各司其职）。
      <br/>
      责任链上的处理者负责处理请求，客户只需要将请求发送到责任链即可，无须关心请求到处理细节和请求到传递，所以职责链将请求的发送者和请求的处理者解耦了。
     </li>
     <li>
      接着看 RealCall 的 getResponseWithInterceptorChain() 方法，在请求需要执行时，通过 getResponseWithInterceptorChain() 获得请求的结果：Response。
     </li>
    </ul>
    <pre><code class="prism language-kotlin"><span class="token comment">// RealCall.kt</span>
<span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token keyword">internal</span> <span class="token keyword">fun</span> <span class="token function">getResponseWithInterceptorChain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Response <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// Build a full stack of interceptors.</span>
    <span class="token keyword">val</span> interceptors <span class="token operator">=</span> mutableListOf<span class="token operator">&lt;</span>Interceptor<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    interceptors <span class="token operator">+=</span> client<span class="token punctuation">.</span>interceptors
    interceptors <span class="token operator">+=</span> <span class="token function">RetryAndFollowUpInterceptor</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span>
    interceptors <span class="token operator">+=</span> <span class="token function">BridgeInterceptor</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span>cookieJar<span class="token punctuation">)</span>
    interceptors <span class="token operator">+=</span> <span class="token function">CacheInterceptor</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span>cache<span class="token punctuation">)</span>
    interceptors <span class="token operator">+=</span> ConnectInterceptor
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>forWebSocket<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      interceptors <span class="token operator">+=</span> client<span class="token punctuation">.</span>networkInterceptors
    <span class="token punctuation">}</span>
    interceptors <span class="token operator">+=</span> <span class="token function">CallServerInterceptor</span><span class="token punctuation">(</span>forWebSocket<span class="token punctuation">)</span>

    <span class="token keyword">val</span> chain <span class="token operator">=</span> <span class="token function">RealInterceptorChain</span><span class="token punctuation">(</span>
        call <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">,</span>
        interceptors <span class="token operator">=</span> interceptors<span class="token punctuation">,</span>
        index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
        exchange <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        request <span class="token operator">=</span> originalRequest<span class="token punctuation">,</span>
        connectTimeoutMillis <span class="token operator">=</span> client<span class="token punctuation">.</span>connectTimeoutMillis<span class="token punctuation">,</span>
        readTimeoutMillis <span class="token operator">=</span> client<span class="token punctuation">.</span>readTimeoutMillis<span class="token punctuation">,</span>
        writeTimeoutMillis <span class="token operator">=</span> client<span class="token punctuation">.</span>writeTimeoutMillis
    <span class="token punctuation">)</span>

    <span class="token keyword">var</span> calledNoMoreExchanges <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">val</span> response <span class="token operator">=</span> chain<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span>originalRequest<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isCanceled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        response<span class="token punctuation">.</span><span class="token function">closeQuietly</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token function">IOException</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Canceled"</span></span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> response
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> IOException<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      calledNoMoreExchanges <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token keyword">throw</span> <span class="token function">noMoreExchanges</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token keyword">as</span> Throwable
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>calledNoMoreExchanges<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">noMoreExchanges</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre>
    <p>
     在 getResponseWithInterceptorChain() 方法中，默认有五大拦截器，也可以自定义拦截器，在 OkHttpClient 中 addInterceptor() 自定义应用拦截器（在请求发送前和响应返回后执行）或addNetworkInterceptor() 自定义网络拦截器（在请求发送到网络之前执行）。
     <br/>
     将一系列拦截器生成 RealInterceptorChain 拦截器链，通过 proceed(request) 方法将请求传递给下一个拦截器。
    </p>
    <ul>
     <li>
      <p>
       addInterceptor() 和 addNetworkInterceptor() 的区别：
       <br/>
       getResponseWithInterceptorChain() 中先去创建一个集合对象，addInterceptor() 自定义拦截器在第一个添加到集合中的，addNetworkInterceptor() 自定义网络拦截器是在倒数第二添加的。并且 networkInterceptor 拦截器只能在 http 请求中添加，如果socket 请求中不会添加。
       <br/>
       比如：添加自定义日志拦截器，
       <br/>
       如果是自定义拦截器，那打印的是用户提交的请求；
       <br/>
       如果是自定义网络拦截器，打印的是真正的网络请求的日志；
      </p>
     </li>
     <li>
      <p>
       默认的五大拦截器：
      </p>
      <ul>
       <li>
        重试重定向拦截器 RetryAndFollowUpInterceptor：在交给下一个拦截器之前，负责判断用户是否取消了请求；在获得了结果之后，会根据响应码判断是否需要重定向，如果满足条件那么就会重启执行所有拦截器。
       </li>
       <li>
        桥接拦截器 BridgeInterceptor：在交给下一个拦截器之前，负责将 HTTP 协议必备的请求头加入其中（如：Host）并添加一些默认的行为（如：GZIP 压缩）；在获得了结果后，调用保存 cookie 接口并解析 GZIP 数据。
       </li>
       <li>
        缓存拦截器 CacheInterceptor：在交给下一个拦截器之前，读取并判断是否使用缓存；获得结果后判断是否缓存。
       </li>
       <li>
        连接拦截器 ConnectInterceptor：在交给下一个拦截器之前，负责找到或者新建一个连接，并获得对应的 socket 流；在获得结果后不进行额外的处理。
       </li>
       <li>
        请求服务器拦截器 CallServerInterceptor：进行真正的与服务器的通信，向服务器发送数据；解析读取的响应数据。
       </li>
      </ul>
     </li>
    </ul>
    <h3>
     <a id="34__442">
     </a>
     3.4 五大拦截器
    </h3>
    <p>
     <strong>
      （1）重试重定向拦截器 RetryAndFollowUpInterceptor
     </strong>
    </p>
    <pre><code class="prism language-kotlin"><span class="token keyword">class</span> <span class="token function">RetryAndFollowUpInterceptor</span><span class="token punctuation">(</span><span class="token keyword">private</span> <span class="token keyword">val</span> client<span class="token operator">:</span> OkHttpClient<span class="token punctuation">)</span> <span class="token operator">:</span> Interceptor <span class="token punctuation">{<!-- --></span>

  <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">intercept</span><span class="token punctuation">(</span>chain<span class="token operator">:</span> Interceptor<span class="token punctuation">.</span>Chain<span class="token punctuation">)</span><span class="token operator">:</span> Response <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">val</span> realChain <span class="token operator">=</span> chain <span class="token keyword">as</span> RealInterceptorChain
    <span class="token keyword">var</span> request <span class="token operator">=</span> chain<span class="token punctuation">.</span>request
    <span class="token keyword">val</span> call <span class="token operator">=</span> realChain<span class="token punctuation">.</span>call
    <span class="token keyword">var</span> followUpCount <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">var</span> priorResponse<span class="token operator">:</span> Response<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token keyword">var</span> newExchangeFinder <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token keyword">var</span> recoveredFailures <span class="token operator">=</span> listOf<span class="token operator">&lt;</span>IOException<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 代码1</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token comment">// 代码2 创建一个ExchangeFinder对象，获取连接（ConnectInterceptor中使用）。</span>
      call<span class="token punctuation">.</span><span class="token function">enterNetworkInterceptorExchange</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> newExchangeFinder<span class="token punctuation">)</span>

      <span class="token keyword">var</span> response<span class="token operator">:</span> Response
      <span class="token keyword">var</span> closeActiveExchange <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token comment">// 是否进行重试逻辑开始</span>
      <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
      	<span class="token comment">// 如果请求取消了 抛出异常</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>call<span class="token punctuation">.</span><span class="token function">isCanceled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">throw</span> <span class="token function">IOException</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Canceled"</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        	<span class="token comment">// 代码3 将请求交给了下一个拦截器</span>
          response <span class="token operator">=</span> realChain<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>
          newExchangeFinder <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> RouteException<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// The attempt to connect via a route failed. The request will not have been sent.</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">recover</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>lastConnectException<span class="token punctuation">,</span> call<span class="token punctuation">,</span> request<span class="token punctuation">,</span> requestSendStarted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> e<span class="token punctuation">.</span>firstConnectException<span class="token punctuation">.</span><span class="token function">withSuppressed</span><span class="token punctuation">(</span>recoveredFailures<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            recoveredFailures <span class="token operator">+=</span> e<span class="token punctuation">.</span>firstConnectException
          <span class="token punctuation">}</span>
          newExchangeFinder <span class="token operator">=</span> <span class="token boolean">false</span>
          <span class="token keyword">continue</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> IOException<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// An attempt to communicate with a server failed. The request may have been sent.</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">recover</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> call<span class="token punctuation">,</span> request<span class="token punctuation">,</span> requestSendStarted <span class="token operator">=</span> e <span class="token operator">!</span><span class="token keyword">is</span> ConnectionShutdownException<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> e<span class="token punctuation">.</span><span class="token function">withSuppressed</span><span class="token punctuation">(</span>recoveredFailures<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            recoveredFailures <span class="token operator">+=</span> e
          <span class="token punctuation">}</span>
          newExchangeFinder <span class="token operator">=</span> <span class="token boolean">false</span>
          <span class="token keyword">continue</span>
        <span class="token punctuation">}</span>
		<span class="token comment">// --------是否进行重试逻辑结束</span>
		
        <span class="token comment">// Attach the prior response if it exists. Such responses never have a body.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>priorResponse <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          response <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">priorResponse</span><span class="token punctuation">(</span>priorResponse<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
		<span class="token comment">// 是否进行重定向逻辑开始</span>
        <span class="token keyword">val</span> exchange <span class="token operator">=</span> call<span class="token punctuation">.</span>interceptorScopedExchange
        <span class="token comment">// 代码4</span>
        <span class="token keyword">val</span> followUp <span class="token operator">=</span> <span class="token function">followUpRequest</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> exchange<span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>followUp <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>exchange <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> exchange<span class="token punctuation">.</span>isDuplex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            call<span class="token punctuation">.</span><span class="token function">timeoutEarlyExit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
          closeActiveExchange <span class="token operator">=</span> <span class="token boolean">false</span>
          <span class="token keyword">return</span> response
        <span class="token punctuation">}</span>

        <span class="token keyword">val</span> followUpBody <span class="token operator">=</span> followUp<span class="token punctuation">.</span>body
        <span class="token keyword">if</span> <span class="token punctuation">(</span>followUpBody <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> followUpBody<span class="token punctuation">.</span><span class="token function">isOneShot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          closeActiveExchange <span class="token operator">=</span> <span class="token boolean">false</span>
          <span class="token keyword">return</span> response
        <span class="token punctuation">}</span>

        response<span class="token punctuation">.</span>body<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">closeQuietly</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>followUpCount <span class="token operator">&gt;</span> MAX_FOLLOW_UPS<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">throw</span> <span class="token function">ProtocolException</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Too many follow-up requests: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">followUpCount</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        request <span class="token operator">=</span> followUp
        priorResponse <span class="token operator">=</span> response
        <span class="token comment">// ------------是否进行重定向逻辑结束</span>
      <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
        call<span class="token punctuation">.</span><span class="token function">exitNetworkInterceptorExchange</span><span class="token punctuation">(</span>closeActiveExchange<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 是否重试</span>
  <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">recover</span><span class="token punctuation">(</span>
    e<span class="token operator">:</span> IOException<span class="token punctuation">,</span>
    call<span class="token operator">:</span> RealCall<span class="token punctuation">,</span>
    userRequest<span class="token operator">:</span> Request<span class="token punctuation">,</span>
    requestSendStarted<span class="token operator">:</span> Boolean
  <span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// okhttpclient配置不重试</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>client<span class="token punctuation">.</span>retryOnConnectionFailure<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span>

    <span class="token comment">// 不重试：</span>
    <span class="token comment">// 1. 如果是 IO 异常（非http2中断异常）表示请求可能发出</span>
    <span class="token comment">// 2. 如果请求体只能被使用一次（默认是false）</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>requestSendStarted <span class="token operator">&amp;&amp;</span> <span class="token function">requestIsOneShot</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> userRequest<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span>

    <span class="token comment">// 异常不重试：协议异常、IO中断异常（除Socket读写超时之外），ssl认证异常</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isRecoverable</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> requestSendStarted<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span>

    <span class="token comment">// 是否有更多的路线</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>call<span class="token punctuation">.</span><span class="token function">retryAfterFailure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span>

    <span class="token comment">// For failure recovery, use the same route selector with a new connection.</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">requestIsOneShot</span><span class="token punctuation">(</span>e<span class="token operator">:</span> IOException<span class="token punctuation">,</span> userRequest<span class="token operator">:</span> Request<span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">val</span> requestBody <span class="token operator">=</span> userRequest<span class="token punctuation">.</span>body
    <span class="token keyword">return</span> <span class="token punctuation">(</span>requestBody <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> requestBody<span class="token punctuation">.</span><span class="token function">isOneShot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span>
        e <span class="token keyword">is</span> FileNotFoundException
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">isRecoverable</span><span class="token punctuation">(</span>e<span class="token operator">:</span> IOException<span class="token punctuation">,</span> requestSendStarted<span class="token operator">:</span> Boolean<span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// If there was a protocol problem, don't recover.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token keyword">is</span> ProtocolException<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// If there was an interruption don't recover, but if there was a timeout connecting to a route</span>
    <span class="token comment">// we should try the next route (if there is one).</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token keyword">is</span> InterruptedIOException<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> e <span class="token keyword">is</span> SocketTimeoutException <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>requestSendStarted
    <span class="token punctuation">}</span>

    <span class="token comment">// Look for known client-side or negotiation errors that are unlikely to be fixed by trying</span>
    <span class="token comment">// again with a different route.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token keyword">is</span> SSLHandshakeException<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// If the problem was a CertificateException from the X509TrustManager,</span>
      <span class="token comment">// do not retry.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>cause <span class="token keyword">is</span> CertificateException<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token keyword">is</span> SSLPeerUnverifiedException<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// e.g. a certificate pinning error.</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// An example of one we might want to retry with a different route is a problem connecting to a</span>
    <span class="token comment">// proxy and would manifest as a standard IOException. Unless it is one we know we should not</span>
    <span class="token comment">// retry, we return true and try a new route.</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>

 
  <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">followUpRequest</span><span class="token punctuation">(</span>userResponse<span class="token operator">:</span> Response<span class="token punctuation">,</span> exchange<span class="token operator">:</span> Exchange<span class="token operator">?</span><span class="token punctuation">)</span><span class="token operator">:</span> Request<span class="token operator">?</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">val</span> route <span class="token operator">=</span> exchange<span class="token operator">?</span><span class="token punctuation">.</span>connection<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> responseCode <span class="token operator">=</span> userResponse<span class="token punctuation">.</span>code

    <span class="token keyword">val</span> method <span class="token operator">=</span> userResponse<span class="token punctuation">.</span>request<span class="token punctuation">.</span>method
    <span class="token keyword">when</span> <span class="token punctuation">(</span>responseCode<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 响应码 407，代理需要授权，如付费代理，需要验证身份</span>
      HTTP_PROXY_AUTH <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">val</span> selectedProxy <span class="token operator">=</span> route<span class="token operator">!!</span><span class="token punctuation">.</span>proxy
        <span class="token comment">// 需要是HTTP请求</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>selectedProxy<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> Proxy<span class="token punctuation">.</span>Type<span class="token punctuation">.</span>HTTP<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">throw</span> <span class="token function">ProtocolException</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Received HTTP_PROXY_AUTH (407) code while not using proxy"</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> client<span class="token punctuation">.</span>proxyAuthenticator<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> userResponse<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
	<span class="token comment">// 响应码 401，服务器需要授权，如某些接口需要登陆才能使用（不安全，基本上没用了）</span>
      HTTP_UNAUTHORIZED <span class="token operator">-&gt;</span> <span class="token keyword">return</span> client<span class="token punctuation">.</span>authenticator<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> userResponse<span class="token punctuation">)</span>

	<span class="token comment">// 响应码 3XX 重定向响应</span>
      HTTP_PERM_REDIRECT<span class="token punctuation">,</span> HTTP_TEMP_REDIRECT<span class="token punctuation">,</span> HTTP_MULT_CHOICE<span class="token punctuation">,</span> HTTP_MOVED_PERM<span class="token punctuation">,</span> HTTP_MOVED_TEMP<span class="token punctuation">,</span> HTTP_SEE_OTHER <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">buildRedirectRequest</span><span class="token punctuation">(</span>userResponse<span class="token punctuation">,</span> method<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

	<span class="token comment">// 响应码 408 请求超时</span>
      HTTP_CLIENT_TIMEOUT <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
      
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>client<span class="token punctuation">.</span>retryOnConnectionFailure<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 如果应用层指示我们不要重试请求，则直接返回null</span>
          <span class="token keyword">return</span> <span class="token keyword">null</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">val</span> requestBody <span class="token operator">=</span> userResponse<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body
        <span class="token comment">// 如果请求体是一次性的，则不能重试</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>requestBody <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> requestBody<span class="token punctuation">.</span><span class="token function">isOneShot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">return</span> <span class="token keyword">null</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">val</span> priorResponse <span class="token operator">=</span> userResponse<span class="token punctuation">.</span>priorResponse
        <span class="token keyword">if</span> <span class="token punctuation">(</span>priorResponse <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> priorResponse<span class="token punctuation">.</span>code <span class="token operator">==</span> HTTP_CLIENT_TIMEOUT<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
           <span class="token comment">// 如果之前已经尝试过重试并且再次超时，则放弃重试</span>
          <span class="token keyword">return</span> <span class="token keyword">null</span>
        <span class="token punctuation">}</span>

		 <span class="token comment">// 如果服务器指定了非零的重试等待时间，则不进行重试</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">retryAfter</span><span class="token punctuation">(</span>userResponse<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">return</span> <span class="token keyword">null</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> userResponse<span class="token punctuation">.</span>request
      <span class="token punctuation">}</span>
		<span class="token comment">// 响应码 503 服务不可用</span>
      HTTP_UNAVAILABLE <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">val</span> priorResponse <span class="token operator">=</span> userResponse<span class="token punctuation">.</span>priorResponse
        <span class="token keyword">if</span> <span class="token punctuation">(</span>priorResponse <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> priorResponse<span class="token punctuation">.</span>code <span class="token operator">==</span> HTTP_UNAVAILABLE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// We attempted to retry and got another timeout. Give up.</span>
          <span class="token keyword">return</span> <span class="token keyword">null</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">retryAfter</span><span class="token punctuation">(</span>userResponse<span class="token punctuation">,</span> Integer<span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// specifically received an instruction to retry without delay</span>
          <span class="token keyword">return</span> userResponse<span class="token punctuation">.</span>request
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token keyword">null</span>
      <span class="token punctuation">}</span>
		<span class="token comment">// 响应码 421 从当前客户端所在的 IP 地址到服务器的连接数超过了服务器许可的最大范围</span>
      HTTP_MISDIRECTED_REQUEST <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// OkHttp can coalesce HTTP/2 connections even if the domain names are different. See</span>
        <span class="token comment">// RealConnection.isEligible(). If we attempted this and the server returned HTTP 421, then</span>
        <span class="token comment">// we can retry on a different connection.</span>
        <span class="token keyword">val</span> requestBody <span class="token operator">=</span> userResponse<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body
        <span class="token keyword">if</span> <span class="token punctuation">(</span>requestBody <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> requestBody<span class="token punctuation">.</span><span class="token function">isOneShot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">return</span> <span class="token keyword">null</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>exchange <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>exchange<span class="token punctuation">.</span>isCoalescedConnection<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">return</span> <span class="token keyword">null</span>
        <span class="token punctuation">}</span>

        exchange<span class="token punctuation">.</span>connection<span class="token punctuation">.</span><span class="token function">noCoalescedConnections</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> userResponse<span class="token punctuation">.</span>request
      <span class="token punctuation">}</span>

      <span class="token keyword">else</span> <span class="token operator">-&gt;</span> <span class="token keyword">return</span> <span class="token keyword">null</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

<span class="token comment">/**
 * 构建基于用户响应的重定向请求。
 * 
 * 该函数用于处理重定向逻辑，根据客户端配置和响应的具体信息判断是否需要跟随重定向。如果条件满足，它将构建一个新的请求对象用于重定向。
 * 
 * @param userResponse 原始请求的响应对象，包含重定向所需的信息，例如重定向URL。
 * @param method 原始请求的HTTP方法，可能会影响重定向请求的构造方式。
 * @return 如果条件满足，返回一个新的重定向请求对象；否则返回null。
 */</span>
  <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">buildRedirectRequest</span><span class="token punctuation">(</span>userResponse<span class="token operator">:</span> Response<span class="token punctuation">,</span> method<span class="token operator">:</span> String<span class="token punctuation">)</span><span class="token operator">:</span> Request<span class="token operator">?</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 检查客户端是否允许重定向</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>client<span class="token punctuation">.</span>followRedirects<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">null</span>

 <span class="token comment">// 从响应头中获取重定向位置</span>
    <span class="token keyword">val</span> location <span class="token operator">=</span> userResponse<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Location"</span></span><span class="token punctuation">)</span> <span class="token operator">?:</span> <span class="token keyword">return</span> <span class="token keyword">null</span>
    <span class="token comment">// 不支持重定向到无效协议的情况</span>
    <span class="token keyword">val</span> url <span class="token operator">=</span> userResponse<span class="token punctuation">.</span>request<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>location<span class="token punctuation">)</span> <span class="token operator">?:</span> <span class="token keyword">return</span> <span class="token keyword">null</span>

    <span class="token comment">// 如果配置禁止跨SSL和非SSL重定向，则检查协议一致性</span>
    <span class="token keyword">val</span> sameScheme <span class="token operator">=</span> url<span class="token punctuation">.</span>scheme <span class="token operator">==</span> userResponse<span class="token punctuation">.</span>request<span class="token punctuation">.</span>url<span class="token punctuation">.</span>scheme
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sameScheme <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>client<span class="token punctuation">.</span>followSslRedirects<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">null</span>

    <span class="token comment">// 大多数重定向不需要请求体，根据方法判断是否保留或修改请求体</span>
    <span class="token keyword">val</span> requestBuilder <span class="token operator">=</span> userResponse<span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>HttpMethod<span class="token punctuation">.</span><span class="token function">permitsRequestBody</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">val</span> responseCode <span class="token operator">=</span> userResponse<span class="token punctuation">.</span>code
      <span class="token keyword">val</span> maintainBody <span class="token operator">=</span> HttpMethod<span class="token punctuation">.</span><span class="token function">redirectsWithBody</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span> <span class="token operator">||</span>
          responseCode <span class="token operator">==</span> HTTP_PERM_REDIRECT <span class="token operator">||</span>
          responseCode <span class="token operator">==</span> HTTP_TEMP_REDIRECT
      <span class="token keyword">if</span> <span class="token punctuation">(</span>HttpMethod<span class="token punctuation">.</span><span class="token function">redirectsToGet</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> responseCode <span class="token operator">!=</span> HTTP_PERM_REDIRECT <span class="token operator">&amp;&amp;</span> responseCode <span class="token operator">!=</span> HTTP_TEMP_REDIRECT<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        requestBuilder<span class="token punctuation">.</span><span class="token function">method</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"GET"</span></span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">val</span> requestBody <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>maintainBody<span class="token punctuation">)</span> userResponse<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body <span class="token keyword">else</span> <span class="token keyword">null</span>
        requestBuilder<span class="token punctuation">.</span><span class="token function">method</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> requestBody<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>maintainBody<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        requestBuilder<span class="token punctuation">.</span><span class="token function">removeHeader</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Transfer-Encoding"</span></span><span class="token punctuation">)</span>
        requestBuilder<span class="token punctuation">.</span><span class="token function">removeHeader</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Content-Length"</span></span><span class="token punctuation">)</span>
        requestBuilder<span class="token punctuation">.</span><span class="token function">removeHeader</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Content-Type"</span></span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 跨主机重定向时，移除所有身份验证头信息</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>userResponse<span class="token punctuation">.</span>request<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">canReuseConnectionFor</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      requestBuilder<span class="token punctuation">.</span><span class="token function">removeHeader</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Authorization"</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> requestBuilder<span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">retryAfter</span><span class="token punctuation">(</span>userResponse<span class="token operator">:</span> Response<span class="token punctuation">,</span> defaultDelay<span class="token operator">:</span> Int<span class="token punctuation">)</span><span class="token operator">:</span> Int <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">val</span> header <span class="token operator">=</span> userResponse<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Retry-After"</span></span><span class="token punctuation">)</span> <span class="token operator">?:</span> <span class="token keyword">return</span> defaultDelay

    <span class="token comment">// https://tools.ietf.org/html/rfc7231#section-7.1.3</span>
    <span class="token comment">// currently ignores a HTTP-date, and assumes any non int 0 is a delay</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>header<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"\\d+"</span></span><span class="token punctuation">.</span><span class="token function">toRegex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> Integer<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>header<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> Integer<span class="token punctuation">.</span>MAX_VALUE
  <span class="token punctuation">}</span>

  <span class="token keyword">companion</span> <span class="token keyword">object</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 重定向最大次数限制</span>
    <span class="token keyword">private</span> <span class="token keyword">const</span> <span class="token keyword">val</span> MAX_FOLLOW_UPS <span class="token operator">=</span> <span class="token number">20</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre>
    <ul>
     <li>
      重试限制（请求）
     </li>
    </ul>
    <p>
     代码1，用了一个 while(true) 死循环。
     <br/>
     代码2，创建一个ExchangeFinder对象，获取连接（ConnectInterceptor中使用）。
     <br/>
     代码3，调用 realChain.proceed(request)，将请求交给了下一个拦截器。如果这里出现了异常就会判断是否需要重试。
    </p>
    <p>
     具体可以看 recover() 方法，有4种情况不重试：
     <br/>
     1.okhttpclient配置不重试
     <br/>
     2.如果请求体只能被使用一次
     <br/>
     3.异常不重试：协议异常、IO中断异常（除Socket读写超时之外），ssl认证异常
     <br/>
     4.是否有更多的路线
    </p>
    <ul>
     <li>
      重定向规则（响应）
     </li>
    </ul>
    <p>
     根据得到的 response 判断要不要重定向，判断 followUpRequest() 返回的是否为空，如果是空，不需要重定向，直接返回 response；否则需要重定向。
    </p>
    <p>
     如果重定向次数超过 20 次，也不会重定向。否则执行 while 中下一次。
    </p>
    <p>
     followUpRequest() 中主要是根据响应码判断是否要重定向。
    </p>
    <table>
     <thead>
      <tr>
       <th>
        响应码
       </th>
       <th>
        说明
       </th>
       <th>
        重定向条件
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        407
       </td>
       <td>
        代理需要授权,如付费代理,需要验证身份
       </td>
       <td>
        通过proxyAuthenticator获得到了Request。例:添加Proxy-Authorization请求头
       </td>
      </tr>
      <tr>
       <td>
        401
       </td>
       <td>
        服务器需要授权,如某些接口需要登陆
       </td>
       <td>
        通过authenticator获得到了Request。例:添加Authorization请求头
       </td>
      </tr>
      <tr>
       <td>
        3XX
       </td>
       <td>
        重定向响应
       </td>
       <td>
        OkHttpClient配置允许重定向
       </td>
      </tr>
      <tr>
       <td>
        408
       </td>
       <td>
        请求超时。
       </td>
       <td>
        1、用户允许自动重试(默认允许) 2、本次请求的结果不是响应408的重试结果 3、服务器未响应Retry-After(稍后重试),或者响应Retry-After:0。
       </td>
      </tr>
      <tr>
       <td>
        503
       </td>
       <td>
        服务不可用
       </td>
       <td>
        1、本次请求的结果不是响应503的重试结果 2、服务器明确响应Retry-After:0,立即重试
       </td>
      </tr>
      <tr>
       <td>
        421
       </td>
       <td>
        从当前客户端所在的IP地址到服务器的连接数超过了服务器许可的最大范围
       </td>
       <td>
        自动再次使用另一个连接对象发起请求
       </td>
      </tr>
     </tbody>
    </table>
    <p>
     <strong>
      （2）桥接拦截器
     </strong>
     <br/>
     桥接拦截器的作用是补全请求头和响应后的处理。
    </p>
    <ul>
     <li>
      补全请求头
     </li>
    </ul>
    <table>
     <thead>
      <tr>
       <th align="center">
        请求头
       </th>
       <th align="center">
        说明
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td align="center">
        Content-Type
       </td>
       <td align="center">
        请求体类型,如:application/x-www-form-urlencoded
       </td>
      </tr>
      <tr>
       <td align="center">
        Content-Length/Transfer-Encoding
       </td>
       <td align="center">
        请求体解析方式
       </td>
      </tr>
      <tr>
       <td align="center">
        Host
       </td>
       <td align="center">
        请求的主机站点
       </td>
      </tr>
      <tr>
       <td align="center">
        Connection: Keep-Alive
       </td>
       <td align="center">
        默认保持长连接
       </td>
      </tr>
      <tr>
       <td align="center">
        Accept-Encoding: gzip
       </td>
       <td align="center">
        接收响应体使用gzip压缩
       </td>
      </tr>
      <tr>
       <td align="center">
        Cookie
       </td>
       <td align="center">
        Cookie身份识别
       </td>
      </tr>
      <tr>
       <td align="center">
        User-Agent
       </td>
       <td align="center">
        用户信息,如:操作系统、浏览器等
       </td>
      </tr>
     </tbody>
    </table>
    <ul>
     <li>
      响应后处理
      <br/>
      得到响应：
      <ol>
       <li>
        读取 Set-Cookie 响应头并调用接口告知用户，在下次请求则会读取对应的数据设置进入请求头，默认 CookieJar 无实现；
       </li>
       <li>
        响应头 Content-Encoding 为 gzip，使用 GzipSource 包装解析。
       </li>
      </ol>
     </li>
    </ul>
    <p>
     <strong>
      （3）缓存拦截器
     </strong>
    </p>
    <p>
     作用：缓存 HTTP 响应，减少重复请求。
    </p>
    <ul>
     <li>
      缓存规则：
      <br/>
      Http 的缓存我们可以按照行为将他们分为：强缓存和协商缓存。
      <ul>
       <li>
        命中强缓存时，浏览器并不会将请求发送给服务器。强缓存是利用 Http 的返回头中的 Expires 或者 Cache-Control 两个字段来控制的，用来表示资源的缓存时间；
       </li>
       <li>
        若未命中强缓存，则浏览器会将请求发送至服务器。服务器根据 http 头信息中的 Last-Modify/If-Modify-Since或Etag/If-None-Match 来判断是否命中了协商缓存。如果命中，则 http 返回码为 304，客户端从缓存中加载资源。
       </li>
      </ul>
     </li>
     <li>
      缓存策略
      <br/>
      拦截器通过 CacheStrategy 判断使用缓存或发起网络请求。此对象中的 networkRequest 与 cacheResponse 分别代表需要发起请求或者直接使用缓存。
     </li>
    </ul>
    <table>
     <thead>
      <tr>
       <th align="center">
        networkRequest
       </th>
       <th align="center">
        cacheResponse
       </th>
       <th align="center">
        说明
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td align="center">
        Null
       </td>
       <td align="center">
        Not Null
       </td>
       <td align="center">
        直接使用缓存
       </td>
      </tr>
      <tr>
       <td align="center">
        Not Null
       </td>
       <td align="center">
        Null
       </td>
       <td align="center">
        向服务器发起请求
       </td>
      </tr>
      <tr>
       <td align="center">
        Null
       </td>
       <td align="center">
        Null
       </td>
       <td align="center">
        要求使用缓存，但是没有缓存，okHttp直接返回504
       </td>
      </tr>
      <tr>
       <td align="center">
        Not Null
       </td>
       <td align="center">
        Not Null
       </td>
       <td align="center">
        发起请求，若得到响应为304，则更新缓存响应并返回
       </td>
      </tr>
     </tbody>
    </table>
    <p>
     即：networkRequest 存在则优先发起网络请求，否则使用 cacheResponse 缓存，若都不存在则请求失败。
    </p>
    <p>
     <strong>
      （4）连接拦截器
     </strong>
    </p>
    <pre><code class="prism language-kotlin"><span class="token keyword">object</span> ConnectInterceptor <span class="token operator">:</span> Interceptor <span class="token punctuation">{<!-- --></span>
  <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">intercept</span><span class="token punctuation">(</span>chain<span class="token operator">:</span> Interceptor<span class="token punctuation">.</span>Chain<span class="token punctuation">)</span><span class="token operator">:</span> Response <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">val</span> realChain <span class="token operator">=</span> chain <span class="token keyword">as</span> RealInterceptorChain
    <span class="token comment">// 代码1</span>
    <span class="token keyword">val</span> exchange <span class="token operator">=</span> realChain<span class="token punctuation">.</span>call<span class="token punctuation">.</span><span class="token function">initExchange</span><span class="token punctuation">(</span>chain<span class="token punctuation">)</span>
    <span class="token keyword">val</span> connectedChain <span class="token operator">=</span> realChain<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>exchange <span class="token operator">=</span> exchange<span class="token punctuation">)</span>
    <span class="token keyword">return</span> connectedChain<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span>realChain<span class="token punctuation">.</span>request<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <ul>
     <li>
      新建连接 realChain.call.initExchange(chain)
      <br/>
      在 ConnectInterceptor 中调用了 initExchange() 方法，
     </li>
    </ul>
    <pre><code class="prism language-kotlin"><span class="token comment">// RealCall.kt</span>
<span class="token keyword">internal</span> <span class="token keyword">fun</span> <span class="token function">initExchange</span><span class="token punctuation">(</span>chain<span class="token operator">:</span> RealInterceptorChain<span class="token punctuation">)</span><span class="token operator">:</span> Exchange <span class="token punctuation">{<!-- --></span>
    <span class="token function">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">check</span><span class="token punctuation">(</span>expectMoreExchanges<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token string-literal singleline"><span class="token string">"released"</span></span> <span class="token punctuation">}</span>
      <span class="token function">check</span><span class="token punctuation">(</span><span class="token operator">!</span>responseBodyOpen<span class="token punctuation">)</span>
      <span class="token function">check</span><span class="token punctuation">(</span><span class="token operator">!</span>requestBodyOpen<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">val</span> exchangeFinder <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>exchangeFinder<span class="token operator">!!</span>
    <span class="token comment">// 代码2</span>
    <span class="token keyword">val</span> codec <span class="token operator">=</span> exchangeFinder<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> chain<span class="token punctuation">)</span>
    <span class="token keyword">val</span> result <span class="token operator">=</span> <span class="token function">Exchange</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> eventListener<span class="token punctuation">,</span> exchangeFinder<span class="token punctuation">,</span> codec<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>interceptorScopedExchange <span class="token operator">=</span> result
    <span class="token keyword">this</span><span class="token punctuation">.</span>exchange <span class="token operator">=</span> result
    <span class="token function">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>requestBodyOpen <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>responseBodyOpen <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>canceled<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token function">IOException</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Canceled"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> result
  <span class="token punctuation">}</span>
</code></pre>
    <p>
     initExchange() 方法又调用了 exchangeFinder.find() 方法，返回 ExchangeCodec 对象。
    </p>
    <pre><code class="prism language-kotlin"><span class="token comment">// ExchangeFinder.kt</span>
  <span class="token keyword">fun</span> <span class="token function">find</span><span class="token punctuation">(</span>
    client<span class="token operator">:</span> OkHttpClient<span class="token punctuation">,</span>
    chain<span class="token operator">:</span> RealInterceptorChain
  <span class="token punctuation">)</span><span class="token operator">:</span> ExchangeCodec <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 代码3 生成 RealConnection 对象，是对 Socket 的封装</span>
      <span class="token keyword">val</span> resultConnection <span class="token operator">=</span> <span class="token function">findHealthyConnection</span><span class="token punctuation">(</span>
          connectTimeout <span class="token operator">=</span> chain<span class="token punctuation">.</span>connectTimeoutMillis<span class="token punctuation">,</span>
          readTimeout <span class="token operator">=</span> chain<span class="token punctuation">.</span>readTimeoutMillis<span class="token punctuation">,</span>
          writeTimeout <span class="token operator">=</span> chain<span class="token punctuation">.</span>writeTimeoutMillis<span class="token punctuation">,</span>
          pingIntervalMillis <span class="token operator">=</span> client<span class="token punctuation">.</span>pingIntervalMillis<span class="token punctuation">,</span>
          connectionRetryEnabled <span class="token operator">=</span> client<span class="token punctuation">.</span>retryOnConnectionFailure<span class="token punctuation">,</span>
          doExtensiveHealthChecks <span class="token operator">=</span> chain<span class="token punctuation">.</span>request<span class="token punctuation">.</span>method <span class="token operator">!=</span> <span class="token string-literal singleline"><span class="token string">"GET"</span></span>
      <span class="token punctuation">)</span>
      <span class="token comment">// 代码4</span>
      <span class="token keyword">return</span> resultConnection<span class="token punctuation">.</span><span class="token function">newCodec</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> chain<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> RouteException<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">trackFailure</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>lastConnectException<span class="token punctuation">)</span>
      <span class="token keyword">throw</span> e
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> IOException<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">trackFailure</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
      <span class="token keyword">throw</span> <span class="token function">RouteException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre>
    <p>
     代码3，生成 RealConnection 对象，是对 Socket 的封装。
     <br/>
     代码4，调用 newCodec() 方法，生成 ExchangeCodec 对象。
    </p>
    <pre><code class="prism language-kotlin"><span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>SocketException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token keyword">internal</span> <span class="token keyword">fun</span> <span class="token function">newCodec</span><span class="token punctuation">(</span>client<span class="token operator">:</span> OkHttpClient<span class="token punctuation">,</span> chain<span class="token operator">:</span> RealInterceptorChain<span class="token punctuation">)</span><span class="token operator">:</span> ExchangeCodec <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">val</span> socket <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>socket<span class="token operator">!!</span>
    <span class="token keyword">val</span> source <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>source<span class="token operator">!!</span>
    <span class="token keyword">val</span> sink <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sink<span class="token operator">!!</span>
    <span class="token keyword">val</span> http2Connection <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>http2Connection
	<span class="token comment">// 代码5 判断使用Http2还是Http1</span>
    <span class="token keyword">return</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>http2Connection <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">Http2ExchangeCodec</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> chain<span class="token punctuation">,</span> http2Connection<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      socket<span class="token punctuation">.</span>soTimeout <span class="token operator">=</span> chain<span class="token punctuation">.</span><span class="token function">readTimeoutMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      source<span class="token punctuation">.</span><span class="token function">timeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">timeout</span><span class="token punctuation">(</span>chain<span class="token punctuation">.</span>readTimeoutMillis<span class="token punctuation">.</span><span class="token function">toLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> MILLISECONDS<span class="token punctuation">)</span>
      sink<span class="token punctuation">.</span><span class="token function">timeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">timeout</span><span class="token punctuation">(</span>chain<span class="token punctuation">.</span>writeTimeoutMillis<span class="token punctuation">.</span><span class="token function">toLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> MILLISECONDS<span class="token punctuation">)</span>
      <span class="token function">Http1ExchangeCodec</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> source<span class="token punctuation">,</span> sink<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre>
    <p>
     在 newCodec() 中，代码5 判断使用Http2还是Http1。
    </p>
    <p>
     因为Http是基于TCP/IP协议，最终还是调用connect()方法通过socket建立连接
    </p>
    <ul>
     <li>
      连接池
      <br/>
      在 ExchangeFinder 中，生成 RealConnection 对象之前，会先判断能不能拿到连接对象复用
     </li>
    </ul>
    <pre><code class="prism language-kotlin"><span class="token comment">// ExchangeFinder.kt</span>
 <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">findHealthyConnection</span><span class="token punctuation">(</span>
    connectTimeout<span class="token operator">:</span> Int<span class="token punctuation">,</span>
    readTimeout<span class="token operator">:</span> Int<span class="token punctuation">,</span>
    writeTimeout<span class="token operator">:</span> Int<span class="token punctuation">,</span>
    pingIntervalMillis<span class="token operator">:</span> Int<span class="token punctuation">,</span>
    connectionRetryEnabled<span class="token operator">:</span> Boolean<span class="token punctuation">,</span>
    doExtensiveHealthChecks<span class="token operator">:</span> Boolean
  <span class="token punctuation">)</span><span class="token operator">:</span> RealConnection <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">val</span> candidate <span class="token operator">=</span> <span class="token function">findConnection</span><span class="token punctuation">(</span>
          connectTimeout <span class="token operator">=</span> connectTimeout<span class="token punctuation">,</span>
          readTimeout <span class="token operator">=</span> readTimeout<span class="token punctuation">,</span>
          writeTimeout <span class="token operator">=</span> writeTimeout<span class="token punctuation">,</span>
          pingIntervalMillis <span class="token operator">=</span> pingIntervalMillis<span class="token punctuation">,</span>
          connectionRetryEnabled <span class="token operator">=</span> connectionRetryEnabled
      <span class="token punctuation">)</span>

      <span class="token comment">// Confirm that the connection is good.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>candidate<span class="token punctuation">.</span><span class="token function">isHealthy</span><span class="token punctuation">(</span>doExtensiveHealthChecks<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> candidate
      <span class="token punctuation">}</span>

      <span class="token comment">// If it isn't, take it out of the pool.</span>
      candidate<span class="token punctuation">.</span><span class="token function">noNewExchanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

      <span class="token comment">// Make sure we have some routes left to try. One example where we may exhaust all the routes</span>
      <span class="token comment">// would happen if we made a new connection and it immediately is detected as unhealthy.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>nextRouteToTry <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">continue</span>

      <span class="token keyword">val</span> routesLeft <span class="token operator">=</span> routeSelection<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?:</span> <span class="token boolean">true</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>routesLeft<span class="token punctuation">)</span> <span class="token keyword">continue</span>

      <span class="token keyword">val</span> routesSelectionLeft <span class="token operator">=</span> routeSelector<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?:</span> <span class="token boolean">true</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>routesSelectionLeft<span class="token punctuation">)</span> <span class="token keyword">continue</span>

      <span class="token keyword">throw</span> <span class="token function">IOException</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"exhausted all routes"</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">findConnection</span><span class="token punctuation">(</span>
    connectTimeout<span class="token operator">:</span> Int<span class="token punctuation">,</span>
    readTimeout<span class="token operator">:</span> Int<span class="token punctuation">,</span>
    writeTimeout<span class="token operator">:</span> Int<span class="token punctuation">,</span>
    pingIntervalMillis<span class="token operator">:</span> Int<span class="token punctuation">,</span>
    connectionRetryEnabled<span class="token operator">:</span> Boolean
  <span class="token punctuation">)</span><span class="token operator">:</span> RealConnection <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>call<span class="token punctuation">.</span><span class="token function">isCanceled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token function">IOException</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Canceled"</span></span><span class="token punctuation">)</span>

    <span class="token comment">// Attempt to reuse the connection from the call.</span>
    <span class="token keyword">val</span> callConnection <span class="token operator">=</span> call<span class="token punctuation">.</span>connection <span class="token comment">// This may be mutated by releaseConnectionNoEvents()!</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>callConnection <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> toClose<span class="token operator">:</span> Socket<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>
      <span class="token function">synchronized</span><span class="token punctuation">(</span>callConnection<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>callConnection<span class="token punctuation">.</span>noNewExchanges <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">sameHostAndPort</span><span class="token punctuation">(</span>callConnection<span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>address<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          toClose <span class="token operator">=</span> call<span class="token punctuation">.</span><span class="token function">releaseConnectionNoEvents</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// If the call's connection wasn't released, reuse it. We don't call connectionAcquired() here</span>
      <span class="token comment">// because we already acquired it.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>call<span class="token punctuation">.</span>connection <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">check</span><span class="token punctuation">(</span>toClose <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> callConnection
      <span class="token punctuation">}</span>

      <span class="token comment">// The call's connection was released.</span>
      toClose<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">closeQuietly</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      eventListener<span class="token punctuation">.</span><span class="token function">connectionReleased</span><span class="token punctuation">(</span>call<span class="token punctuation">,</span> callConnection<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// We need a new connection. Give it fresh stats.</span>
    refusedStreamCount <span class="token operator">=</span> <span class="token number">0</span>
    connectionShutdownCount <span class="token operator">=</span> <span class="token number">0</span>
    otherFailureCount <span class="token operator">=</span> <span class="token number">0</span>

    <span class="token comment">// Attempt to get a connection from the pool.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>connectionPool<span class="token punctuation">.</span><span class="token function">callAcquirePooledConnection</span><span class="token punctuation">(</span>address<span class="token punctuation">,</span> call<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">val</span> result <span class="token operator">=</span> call<span class="token punctuation">.</span>connection<span class="token operator">!!</span>
      eventListener<span class="token punctuation">.</span><span class="token function">connectionAcquired</span><span class="token punctuation">(</span>call<span class="token punctuation">,</span> result<span class="token punctuation">)</span>
      <span class="token keyword">return</span> result
    <span class="token punctuation">}</span>

    <span class="token comment">// Nothing in the pool. Figure out what route we'll try next.</span>
    <span class="token keyword">val</span> routes<span class="token operator">:</span> List<span class="token operator">&lt;</span>Route<span class="token operator">&gt;</span><span class="token operator">?</span>
    <span class="token keyword">val</span> route<span class="token operator">:</span> Route
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nextRouteToTry <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// Use a route from a preceding coalesced connection.</span>
      routes <span class="token operator">=</span> <span class="token keyword">null</span>
      route <span class="token operator">=</span> nextRouteToTry<span class="token operator">!!</span>
      nextRouteToTry <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>routeSelection <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> routeSelection<span class="token operator">!!</span><span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// Use a route from an existing route selection.</span>
      routes <span class="token operator">=</span> <span class="token keyword">null</span>
      route <span class="token operator">=</span> routeSelection<span class="token operator">!!</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// Compute a new route selection. This is a blocking operation!</span>
      <span class="token keyword">var</span> localRouteSelector <span class="token operator">=</span> routeSelector
      <span class="token keyword">if</span> <span class="token punctuation">(</span>localRouteSelector <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        localRouteSelector <span class="token operator">=</span> <span class="token function">RouteSelector</span><span class="token punctuation">(</span>address<span class="token punctuation">,</span> call<span class="token punctuation">.</span>client<span class="token punctuation">.</span>routeDatabase<span class="token punctuation">,</span> call<span class="token punctuation">,</span> eventListener<span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>routeSelector <span class="token operator">=</span> localRouteSelector
      <span class="token punctuation">}</span>
      <span class="token keyword">val</span> localRouteSelection <span class="token operator">=</span> localRouteSelector<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      routeSelection <span class="token operator">=</span> localRouteSelection
      routes <span class="token operator">=</span> localRouteSelection<span class="token punctuation">.</span>routes

      <span class="token keyword">if</span> <span class="token punctuation">(</span>call<span class="token punctuation">.</span><span class="token function">isCanceled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token function">IOException</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Canceled"</span></span><span class="token punctuation">)</span>

      <span class="token comment">// Now that we have a set of IP addresses, make another attempt at getting a connection from</span>
      <span class="token comment">// the pool. We have a better chance of matching thanks to connection coalescing.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>connectionPool<span class="token punctuation">.</span><span class="token function">callAcquirePooledConnection</span><span class="token punctuation">(</span>address<span class="token punctuation">,</span> call<span class="token punctuation">,</span> routes<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">val</span> result <span class="token operator">=</span> call<span class="token punctuation">.</span>connection<span class="token operator">!!</span>
        eventListener<span class="token punctuation">.</span><span class="token function">connectionAcquired</span><span class="token punctuation">(</span>call<span class="token punctuation">,</span> result<span class="token punctuation">)</span>
        <span class="token keyword">return</span> result
      <span class="token punctuation">}</span>

      route <span class="token operator">=</span> localRouteSelection<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Connect. Tell the call about the connecting call so async cancels work.</span>
    <span class="token keyword">val</span> newConnection <span class="token operator">=</span> <span class="token function">RealConnection</span><span class="token punctuation">(</span>connectionPool<span class="token punctuation">,</span> route<span class="token punctuation">)</span>
    call<span class="token punctuation">.</span>connectionToCancel <span class="token operator">=</span> newConnection
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
      newConnection<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>
          connectTimeout<span class="token punctuation">,</span>
          readTimeout<span class="token punctuation">,</span>
          writeTimeout<span class="token punctuation">,</span>
          pingIntervalMillis<span class="token punctuation">,</span>
          connectionRetryEnabled<span class="token punctuation">,</span>
          call<span class="token punctuation">,</span>
          eventListener
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
      call<span class="token punctuation">.</span>connectionToCancel <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token punctuation">}</span>
    call<span class="token punctuation">.</span>client<span class="token punctuation">.</span>routeDatabase<span class="token punctuation">.</span><span class="token function">connected</span><span class="token punctuation">(</span>newConnection<span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment">// If we raced another call connecting to this host, coalesce the connections. This makes for 3</span>
    <span class="token comment">// different lookups in the connection pool!</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>connectionPool<span class="token punctuation">.</span><span class="token function">callAcquirePooledConnection</span><span class="token punctuation">(</span>address<span class="token punctuation">,</span> call<span class="token punctuation">,</span> routes<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">val</span> result <span class="token operator">=</span> call<span class="token punctuation">.</span>connection<span class="token operator">!!</span>
      nextRouteToTry <span class="token operator">=</span> route
      newConnection<span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">closeQuietly</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      eventListener<span class="token punctuation">.</span><span class="token function">connectionAcquired</span><span class="token punctuation">(</span>call<span class="token punctuation">,</span> result<span class="token punctuation">)</span>
      <span class="token keyword">return</span> result
    <span class="token punctuation">}</span>

    <span class="token function">synchronized</span><span class="token punctuation">(</span>newConnection<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      connectionPool<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>newConnection<span class="token punctuation">)</span>
      call<span class="token punctuation">.</span><span class="token function">acquireConnectionNoEvents</span><span class="token punctuation">(</span>newConnection<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    eventListener<span class="token punctuation">.</span><span class="token function">connectionAcquired</span><span class="token punctuation">(</span>call<span class="token punctuation">,</span> newConnection<span class="token punctuation">)</span>
    <span class="token keyword">return</span> newConnection
  <span class="token punctuation">}</span>
</code></pre>
    <p>
     connectionPool: RealConnectionPool 就是连接池，其实就是一个对象池。
    </p>
    <pre><code class="prism language-kotlin"><span class="token keyword">class</span> <span class="token function">RealConnectionPool</span><span class="token punctuation">(</span>
  taskRunner<span class="token operator">:</span> TaskRunner<span class="token punctuation">,</span>
  <span class="token comment">/** The maximum number of idle connections for each address. */</span>
  <span class="token keyword">private</span> <span class="token keyword">val</span> maxIdleConnections<span class="token operator">:</span> Int<span class="token punctuation">,</span>
  keepAliveDuration<span class="token operator">:</span> Long<span class="token punctuation">,</span>
  timeUnit<span class="token operator">:</span> TimeUnit
<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token operator">..</span><span class="token punctuation">.</span>
<span class="token keyword">private</span> <span class="token keyword">val</span> cleanupTask <span class="token operator">=</span> <span class="token keyword">object</span> <span class="token operator">:</span> <span class="token function">Task</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">okHttpName</span></span><span class="token string"> ConnectionPool"</span></span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">runOnce</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">cleanup</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">private</span> <span class="token keyword">val</span> connections <span class="token operator">=</span> ConcurrentLinkedQueue<span class="token operator">&lt;</span>RealConnection<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token operator">..</span><span class="token punctuation">.</span>
   <span class="token keyword">fun</span> <span class="token function">put</span><span class="token punctuation">(</span>connection<span class="token operator">:</span> RealConnection<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    connection<span class="token punctuation">.</span><span class="token function">assertThreadHoldsLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    connections<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span>
    cleanupQueue<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span>cleanupTask<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre>
    <pre><code class="prism language-kotlin"><span class="token comment">// ConnectionPool.kt</span>
<span class="token keyword">class</span> ConnectionPool <span class="token keyword">internal</span> <span class="token keyword">constructor</span><span class="token punctuation">(</span>
  <span class="token keyword">internal</span> <span class="token keyword">val</span> delegate<span class="token operator">:</span> RealConnectionPool
<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">constructor</span><span class="token punctuation">(</span>
    maxIdleConnections<span class="token operator">:</span> Int<span class="token punctuation">,</span>
    keepAliveDuration<span class="token operator">:</span> Long<span class="token punctuation">,</span>
    timeUnit<span class="token operator">:</span> TimeUnit
  <span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token function">RealConnectionPool</span><span class="token punctuation">(</span>
      taskRunner <span class="token operator">=</span> TaskRunner<span class="token punctuation">.</span>INSTANCE<span class="token punctuation">,</span>
      maxIdleConnections <span class="token operator">=</span> maxIdleConnections<span class="token punctuation">,</span>
      keepAliveDuration <span class="token operator">=</span> keepAliveDuration<span class="token punctuation">,</span>
      timeUnit <span class="token operator">=</span> timeUnit
  <span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>MINUTES<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre>
    <p>
     连接池就是一个装载 RealConnection 的ConcurrentLinkedQueue 队列。
    </p>
    <p>
     在put方法中，除了往队列中添加 connection，还启动了一个周期性任务 cleanupTask，在任务中调用cleanup()，清除无效连接。
     <br/>
     在默认连接池中，最大允许的空闲连接数是 5，连接最大允许的空闲时间 5 分钟。
     <br/>
     1、连接池中 连接对象 闲置了多久 超过了 5 分钟没用的连接，就清理掉
     <br/>
     2、连接池中 存放了 大量的 空闲连接对象，超过 5个空闲连接，如何清理？
     <br/>
     把空闲时间最长的连接一个个清理掉，至少不超过 5 个（LRU思想）
     <br/>
     connection：keep-alive
    </p>
    <p>
     <strong>
      （5）请求服务拦截器 CallServerInterceptor
     </strong>
    </p>
    <pre><code class="prism language-kotlin"><span class="token comment">/**
 * 此拦截器是拦截链中的最后一个拦截器。它负责向服务器发起网络请求。
 *
 * @param forWebSocket 指示此拦截器是否用于 WebSocket 连接
 */</span>
<span class="token keyword">class</span> <span class="token function">CallServerInterceptor</span><span class="token punctuation">(</span><span class="token keyword">private</span> <span class="token keyword">val</span> forWebSocket<span class="token operator">:</span> Boolean<span class="token punctuation">)</span> <span class="token operator">:</span> Interceptor <span class="token punctuation">{<!-- --></span>

  <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">intercept</span><span class="token punctuation">(</span>chain<span class="token operator">:</span> Interceptor<span class="token punctuation">.</span>Chain<span class="token punctuation">)</span><span class="token operator">:</span> Response <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 将传入的 Chain 转换为 RealInterceptorChain，以获取更详细的上下文信息</span>
    <span class="token keyword">val</span> realChain <span class="token operator">=</span> chain <span class="token keyword">as</span> RealInterceptorChain
    <span class="token keyword">val</span> exchange <span class="token operator">=</span> realChain<span class="token punctuation">.</span>exchange<span class="token operator">!!</span>
    <span class="token keyword">val</span> request <span class="token operator">=</span> realChain<span class="token punctuation">.</span>request
    <span class="token keyword">val</span> requestBody <span class="token operator">=</span> request<span class="token punctuation">.</span>body
    <span class="token keyword">val</span> sentRequestMillis <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">var</span> invokeStartEvent <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token keyword">var</span> responseBuilder<span class="token operator">:</span> Response<span class="token punctuation">.</span>Builder<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token keyword">var</span> sendRequestException<span class="token operator">:</span> IOException<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 写入请求头到服务器</span>
      exchange<span class="token punctuation">.</span><span class="token function">writeRequestHeaders</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>HttpMethod<span class="token punctuation">.</span><span class="token function">permitsRequestBody</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>method<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> requestBody <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 如果请求方法允许带有请求体，并且请求体不为空，则处理请求体</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"100-continue"</span></span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Expect"</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> ignoreCase <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 如果请求头中包含 "Expect: 100-continue"，则等待服务器返回 "HTTP/1.1 100 Continue"</span>
          exchange<span class="token punctuation">.</span><span class="token function">flushRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          responseBuilder <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">readResponseHeaders</span><span class="token punctuation">(</span>expectContinue <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
          exchange<span class="token punctuation">.</span><span class="token function">responseHeadersStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          invokeStartEvent <span class="token operator">=</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>responseBuilder <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>requestBody<span class="token punctuation">.</span><span class="token function">isDuplex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 准备一个双工请求体，以便应用程序稍后发送请求体</span>
            exchange<span class="token punctuation">.</span><span class="token function">flushRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">val</span> bufferedRequestBody <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">createRequestBody</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            requestBody<span class="token punctuation">.</span><span class="token function">writeTo</span><span class="token punctuation">(</span>bufferedRequestBody<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 如果 "Expect: 100-continue" 的期望已满足，则写入请求体</span>
            <span class="token keyword">val</span> bufferedRequestBody <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">createRequestBody</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            requestBody<span class="token punctuation">.</span><span class="token function">writeTo</span><span class="token punctuation">(</span>bufferedRequestBody<span class="token punctuation">)</span>
            bufferedRequestBody<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 如果没有收到 "HTTP/1.1 100 Continue" 响应，则不发送请求体</span>
          exchange<span class="token punctuation">.</span><span class="token function">noRequestBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>exchange<span class="token punctuation">.</span>connection<span class="token punctuation">.</span>isMultiplexed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 如果 "Expect: 100-continue" 的期望未满足，防止 HTTP/1 连接被重用</span>
            exchange<span class="token punctuation">.</span><span class="token function">noNewExchangesOnConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 如果请求方法不允许带有请求体或请求体为空，则不发送请求体</span>
        exchange<span class="token punctuation">.</span><span class="token function">noRequestBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>requestBody <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>requestBody<span class="token punctuation">.</span><span class="token function">isDuplex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 完成请求发送</span>
        exchange<span class="token punctuation">.</span><span class="token function">finishRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> IOException<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token keyword">is</span> ConnectionShutdownException<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> e <span class="token comment">// 请求未发送，因此没有响应可读取</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>exchange<span class="token punctuation">.</span>hasFailure<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> e <span class="token comment">// 请求发送失败，不要尝试读取响应</span>
      <span class="token punctuation">}</span>
      sendRequestException <span class="token operator">=</span> e
    <span class="token punctuation">}</span>

    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>responseBuilder <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 读取响应头</span>
        responseBuilder <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">readResponseHeaders</span><span class="token punctuation">(</span>expectContinue <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token operator">!!</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>invokeStartEvent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          exchange<span class="token punctuation">.</span><span class="token function">responseHeadersStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          invokeStartEvent <span class="token operator">=</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">var</span> response <span class="token operator">=</span> responseBuilder
          <span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">handshake</span><span class="token punctuation">(</span>exchange<span class="token punctuation">.</span>connection<span class="token punctuation">.</span><span class="token function">handshake</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">sentRequestAtMillis</span><span class="token punctuation">(</span>sentRequestMillis<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">receivedResponseAtMillis</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">var</span> code <span class="token operator">=</span> response<span class="token punctuation">.</span>code

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldIgnoreAndWaitForRealResponse</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 如果响应码为 100 或者在 102 到 199 之间，则忽略并等待实际响应</span>
        responseBuilder <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">readResponseHeaders</span><span class="token punctuation">(</span>expectContinue <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token operator">!!</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>invokeStartEvent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          exchange<span class="token punctuation">.</span><span class="token function">responseHeadersStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        response <span class="token operator">=</span> responseBuilder
            <span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">handshake</span><span class="token punctuation">(</span>exchange<span class="token punctuation">.</span>connection<span class="token punctuation">.</span><span class="token function">handshake</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">sentRequestAtMillis</span><span class="token punctuation">(</span>sentRequestMillis<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">receivedResponseAtMillis</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        code <span class="token operator">=</span> response<span class="token punctuation">.</span>code
      <span class="token punctuation">}</span>

      <span class="token comment">// 结束响应头读取</span>
      exchange<span class="token punctuation">.</span><span class="token function">responseHeadersEnd</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>

      response <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>forWebSocket <span class="token operator">&amp;&amp;</span> code <span class="token operator">==</span> <span class="token number">101</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 如果是 WebSocket 升级连接，确保拦截器看到非空响应体</span>
        response<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span>EMPTY_RESPONSE<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        response<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span>exchange<span class="token punctuation">.</span><span class="token function">openResponseBody</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"close"</span></span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Connection"</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> ignoreCase <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token operator">||</span>
          <span class="token string-literal singleline"><span class="token string">"close"</span></span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Connection"</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> ignoreCase <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 如果请求或响应头中包含 "Connection: close"，则关闭连接</span>
        exchange<span class="token punctuation">.</span><span class="token function">noNewExchangesOnConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>code <span class="token operator">==</span> <span class="token number">204</span> <span class="token operator">||</span> code <span class="token operator">==</span> <span class="token number">205</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> response<span class="token punctuation">.</span>body<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">contentLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?:</span> <span class="token operator">-</span><span class="token number">1L</span> <span class="token operator">&gt;</span> <span class="token number">0L</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 如果响应码为 204 或 205，但响应体长度不为零，则抛出异常</span>
        <span class="token keyword">throw</span> <span class="token function">ProtocolException</span><span class="token punctuation">(</span>
            <span class="token string-literal singleline"><span class="token string">"HTTP </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">code</span></span><span class="token string"> had non-zero Content-Length: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token expression">response<span class="token punctuation">.</span>body<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">contentLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> response
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> IOException<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>sendRequestException <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        sendRequestException<span class="token punctuation">.</span><span class="token function">addSuppressed</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
        <span class="token keyword">throw</span> sendRequestException
      <span class="token punctuation">}</span>
      <span class="token keyword">throw</span> e
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 判断是否应忽略当前响应并等待实际响应。
   *
   * @param code HTTP 响应码
   * @return 如果应忽略当前响应并等待实际响应，则返回 true；否则返回 false
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">shouldIgnoreAndWaitForRealResponse</span><span class="token punctuation">(</span>code<span class="token operator">:</span> Int<span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token operator">=</span> <span class="token keyword">when</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 如果服务器发送了 100-continue，即使我们没有请求它，也应再次尝试读取实际响应状态</span>
    code <span class="token operator">==</span> <span class="token number">100</span> <span class="token operator">-&gt;</span> <span class="token boolean">true</span>

    <span class="token comment">// 处理 Processing (102) 和 Early Hints (103)，以及任何新的 1xx 状态码，但不包括 100 和 101</span>
    code <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token number">102</span> until <span class="token number">200</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token boolean">true</span>

    <span class="token keyword">else</span> <span class="token operator">-&gt;</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     请求头中 Expect 为 100-continue：
    </p>
    <ul>
     <li>
      使用场景：一般出现于上传大容量请求体或者需要验证。代表了先询问服务器是否愿意接收发送请求体数据。
     </li>
     <li>
      OkHttp 的做法：
      <ul>
       <li>
        如果服务器允许则返回100， 客户端继续发送请求体。
       </li>
       <li>
        如果服务器不允许则直接返回给用户。
       </li>
       <li>
        同时服务器也可能会忽略此请求头，一致无法读取应答，此时抛出超时异常。
       </li>
      </ul>
     </li>
    </ul>
    <h2>
     <a id="4__1296">
     </a>
     4. 其它
    </h2>
    <h3>
     <a id="41_OKHttp__1297">
     </a>
     4.1 OKHttp 如何处理大文件上传和下载？
    </h3>
    <ul>
     <li>
      大文件上传：可以通过 RequestBody 的 create 方法创建流式请求体，避免一次性加载大文件到内存中。
      <br/>
      实现步骤：
      <ul>
       <li>
        创建 RequestBody，使用 File 或 InputStream 作为数据源，避免一次性加载大文件到内存中。
       </li>
       <li>
        将 RequestBody 封装到 MultipartBody 中，支持文件上传。
       </li>
       <li>
        构建 Request 并执行上传。
       </li>
      </ul>
     </li>
    </ul>
    <pre><code class="prism language-java"><span class="token comment">// 1. 创建文件</span>
<span class="token class-name">File</span> file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"path/to/large/file.zip"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 2. 创建 RequestBody</span>
<span class="token class-name">RequestBody</span> requestBody <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MultipartBody<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span><span class="token class-name">MultipartBody</span><span class="token punctuation">.</span><span class="token constant">FORM</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">addFormDataPart</span><span class="token punctuation">(</span><span class="token string">"file"</span><span class="token punctuation">,</span> file<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">RequestBody</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> <span class="token class-name">MediaType</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">"application/octet-stream"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 3. 构建 Request</span>
<span class="token class-name">Request</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Request<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token string">"https://example.com/upload"</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>requestBody<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 4. 执行上传</span>
<span class="token class-name">OkHttpClient</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OkHttpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">Response</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">newCall</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">isSuccessful</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Upload successful!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Upload failed: "</span> <span class="token operator">+</span> response<span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <ul>
     <li>
      大文件下载：可以通过 ResponseBody 的 source 方法获取输入流，逐步写入文件，避免内存溢出。
      <br/>
      实现步骤：
      <ul>
       <li>
        构建 Request，设置下载 URL。
       </li>
       <li>
        执行请求并获取 ResponseBody。
       </li>
       <li>
        使用 BufferedSink 将响应体写入文件。
       </li>
      </ul>
     </li>
    </ul>
    <pre><code class="prism language-java"><span class="token comment">// 1. 构建 Request</span>
<span class="token class-name">Request</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Request<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token string">"https://example.com/largefile.zip"</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 2. 执行下载</span>
<span class="token class-name">OkHttpClient</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OkHttpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">Response</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">newCall</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">isSuccessful</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 3. 获取 ResponseBody</span>
        <span class="token class-name">ResponseBody</span> body <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>body <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 4. 创建文件输出流</span>
            <span class="token class-name">File</span> file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"path/to/save/largefile.zip"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">BufferedSink</span> sink <span class="token operator">=</span> <span class="token class-name">Okio</span><span class="token punctuation">.</span><span class="token function">buffer</span><span class="token punctuation">(</span><span class="token class-name">Okio</span><span class="token punctuation">.</span><span class="token function">sink</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 5. 将响应体写入文件</span>
                sink<span class="token punctuation">.</span><span class="token function">writeAll</span><span class="token punctuation">(</span>body<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Download successful!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Download failed: "</span> <span class="token operator">+</span> response<span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <ul>
     <li>
      断点续传：通过设置 Range 请求头，下载文件的指定部分。记录已下载的文件大小，从断点处继续下载。
      <br/>
      实现步骤：
      <ul>
       <li>
        检查本地已下载的文件大小。
       </li>
       <li>
        设置 Range 请求头，从断点处开始下载。
       </li>
       <li>
        将下载的数据追加到本地文件中。
       </li>
      </ul>
     </li>
    </ul>
    <pre><code class="prism language-java"><span class="token comment">// 1. 检查本地文件大小</span>
<span class="token class-name">File</span> file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"path/to/save/largefile.zip"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">long</span> fileSize <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> file<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token comment">// 2. 构建 Request，设置 Range 请求头</span>
<span class="token class-name">Request</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Request<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token string">"https://example.com/largefile.zip"</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Range"</span><span class="token punctuation">,</span> <span class="token string">"bytes="</span> <span class="token operator">+</span> fileSize <span class="token operator">+</span> <span class="token string">"-"</span><span class="token punctuation">)</span> <span class="token comment">// 从断点处开始下载</span>
    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 3. 执行下载</span>
<span class="token class-name">OkHttpClient</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OkHttpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">Response</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">newCall</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">isSuccessful</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ResponseBody</span> body <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>body <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 4. 将下载的数据追加到本地文件</span>
            <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">BufferedSink</span> sink <span class="token operator">=</span> <span class="token class-name">Okio</span><span class="token punctuation">.</span><span class="token function">buffer</span><span class="token punctuation">(</span><span class="token class-name">Okio</span><span class="token punctuation">.</span><span class="token function">appendingSink</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                sink<span class="token punctuation">.</span><span class="token function">writeAll</span><span class="token punctuation">(</span>body<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Download successful!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Download failed: "</span> <span class="token operator">+</span> response<span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <ul>
     <li>
      扩展：可以提到 OKHttp 的 ProgressListener 可以用于监控上传和下载的进度。
     </li>
    </ul>
    <h3>
     <a id="42_OKHttp__SSLTLS_1399">
     </a>
     4.2 OKHttp 如何处理 SSL/TLS？
    </h3>
    <ul>
     <li>
      <p>
       OKHttp 默认支持 SSL/TLS，并且会自动处理证书验证。开发者可以通过 OkHttpClient.Builder 自定义 SSL 配置，例如设置自定义的信任管理器（TrustManager）或证书（X509Certificate）。
      </p>
     </li>
     <li>
      <p>
       扩展: 可以提到 OKHttp 支持 HTTP/2 的 ALPN（应用层协议协商），能够自动选择最佳的协议进行通信。
      </p>
     </li>
    </ul>
    <h3>
     <a id="43_OKHttpTCP_1404">
     </a>
     4.3 OKHttp如何复用TCP连接
    </h3>
    <ul>
     <li>
      OKHttp中有一个连接池，连接池就是一个对象池，用了一个 ConcurrentLinkedQueue 缓存所有的有效连接对象，当我们需要一个连接发起请求时，我们先去连接池中查找。
     </li>
     <li>
      能够满足复用连接的对象，一定是和本次请求的域名、端口、设置的代理、设置的DNS解析等参数一定是相同的，才能复用。
     </li>
     <li>
      连接池也会去清理垃圾连接。如超过了5分钟没用过的连接，还有超过了5个闲置连接后，从最久闲置的连接开始执行清理
     </li>
    </ul>
    <h2>
     <a id="5__1408">
     </a>
     5. 总结
    </h2>
    <p>
     OkHttp是一个功能强大且灵活的HTTP客户端库，适用于各种网络请求场景。
    </p>
    <p>
     核心设计思想是链式处理，通过拦截器机制将请求和响应的处理过程分解为多个独立的步骤。它主要由OkHttpClient、Request、Response、Call和Interceptor等组件组成。工作流程包括创建请求、执行请求、经过拦截器链处理、获取响应等。拦截器链是OkHttp的核心机制，内置了重试、缓存、连接、网络等拦截器。此外，OkHttp通过连接池复用连接，通过调度器管理异步请求的并发数量。它的性能优化措施包括HTTP/2支持、GZIP压缩和缓存等。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f:626c6f672e6373646e2e6e65742f426f6e6e69655f6361742f:61727469636c652f64657461696c732f313436313337393935" class_="artid" style="display:none">
 </p>
</div>


