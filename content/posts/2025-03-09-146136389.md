---
layout: post
title: "Unity-DOTS从入门到精通之EntityCommandBufferSystem"
date: 2025-03-09 22:08:23 +0800
description: "DOTS（面向数据的技术堆栈）是一套由 Unity 提供支持的技术，用于提供高性能游戏开发解决方案，特别适合需要处理大量数据的游戏，例如大型开放世界游戏。本文讲解了如何使用“ ECB ”来执行Job处理过程中无法执行的命令，例如“创建实体”。"
keywords: "Unity DOTS从入门到精通之EntityCommandBufferSystem"
categories: ['Unity', 'Dots']
tags: ['Unity', 'Jobsystem', 'Entities', 'Ecs', 'Ecb', 'Dots', 'Burst']
artid: "146136389"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146136389
    alt: "Unity-DOTS从入门到精通之EntityCommandBufferSystem"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146136389
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146136389
cover: https://bing.ee123.net/img/rand?artid=146136389
image: https://bing.ee123.net/img/rand?artid=146136389
img: https://bing.ee123.net/img/rand?artid=146136389
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Unity DOTS从入门到精通之EntityCommandBufferSystem
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <p>
    </p>
    <h3>
     <a id="_1">
     </a>
     前言
    </h3>
    <p>
     DOTS（面向数据的技术堆栈）是一套由 Unity 提供支持的技术，用于提供高性能游戏开发解决方案，特别适合需要处理大量数据的游戏，例如大型开放世界游戏。
     <br/>
     本文讲解了如何使用“ ECB ”来执行Job处理过程中无法执行的命令，例如“创建实体”。
    </p>
    <ul>
     <li>
      Unity 2022.3.52f1
     </li>
     <li>
      Entities 1.3.10
     </li>
    </ul>
    <h3>
     <a id="_DOTS__7">
     </a>
     安装 DOTS 包
    </h3>
    <p>
     要安装 DOTS 包，请按照以下步骤操作：
    </p>
    <p>
     （1）从菜单“窗口 → 包管理器”打开包管理器。
     <br/>
     （2）搜索“ Entities” 并安装 Entities和Entities Graphics。
     <br/>
     （3）搜索“ Universal RP” 并安装 Universal RP，并设置Graphics/Scriptable Render Pipeline Settings。
    </p>
    <p>
     这会添加“实体”作为依赖项，并递归添加它所依赖的关联包（ Burst、Collections、Jobs、Mathematics等）。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/2a076017e0c04b73a80fd45c8a7931c5.png"/>
    </p>
    <h3>
     <a id="ECB_17">
     </a>
     ECB
    </h3>
    <p>
     “ ECB ” (Entity Command Buffer) 是一个缓冲区，在 Unity DOTS 中用于管理和执行 EntityCommandBuffer 命令队列的重要系统。它确保了跨线程和跨帧操作的安全性
     <br/>
     默认提供了以下几种 EntityCommandBufferSystem 实现：
     <br/>
     BeginInitializationEntityCommandBufferSystem
     <br/>
     EndInitializationEntityCommandBufferSystem
     <br/>
     BeginSimulationEntityCommandBufferSystem
     <br/>
     EndSimulationEntityCommandBufferSystem
     <br/>
     BeginPresentationEntityCommandBufferSystem
     <br/>
     EndPresentationEntityCommandBufferSystem
     <br/>
     FixedStepSimulationEntityCommandBufferSystem
     <br/>
     这些系统的名称中包含了它们所属的阶段（Initialization、Simulation、Presentation）以及它们在这些阶段中的执行时机（Begin 和 End）。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/ba2a16d5ce28423690c888f715fba740.png"/>
    </p>
    <h3>
     <a id="ECB_32">
     </a>
     ECB可以执行的指令
    </h3>
    <p>
     ECB 可以执行的命令在 EntityCommandBuffer 方法中定义。
     <br/>
     ・AddBuffer(Entity)：添加一个缓冲区。
     <br/>
     ・AddComponent(Entity, T)：添加一个组件。
     <br/>
     ・AddComponent（EntityQuery，ComponentType）：添加一个组件。
     <br/>
     ・AddSharedComponent(Entity, T):添加一个共享组件。
     <br/>
     ・AddSharedComponent(EntityQuery, T)：添加一个共享组件。
     <br/>
     ・CreateEntity（EntityArchetype）：创建一个实体。
     <br/>
     ・DestroyEntity（Entity）：摧毁一个实体。
     <br/>
     ・DestroyEntity（EntityQuery）：销毁一个实体。
     <br/>
     ・RemoveComponent(Entity):删除一个组件。
     <br/>
     ・RemoveComponent（Entity，ComponentType）：删除一个组件。
     <br/>
     ・RemoveComponent（EntityQuery，ComponentType）：删除一个组件。
     <br/>
     ・SetBuffer(Entity)：更新缓冲区。
     <br/>
     ・SetComponent(Entity, T)：更新一个组件。
     <br/>
     ・SetSharedComponent(Entity, T)：更新共享组件。
     <br/>
     ・实例化（实体）：创建一个实例。
     <br/>
     ・ToConcurrent（）：转换为并行ECB。
     <br/>
     ・Playback（EntityManager）：执行命令。
     <br/>
     ・Dispose()：处理。
    </p>
    <p>
     各类 EntityCommandBufferSystem 的区别与用途
    </p>
    <p>
     2.1 BeginInitializationEntityCommandBufferSystem
     <br/>
     所属阶段: Initialization（初始化阶段）
     <br/>
     执行时机: 在 InitializationSystemGroup 的最开始执行。
     <br/>
     用途: 适用于在所有初始化系统运行之前提交命令，例如在初始化前预加载资源或设置初始状态。
     <br/>
     示例使用场景: 预加载游戏资源，初始化全局状态。
    </p>
    <p>
     2.2 EndInitializationEntityCommandBufferSystem
     <br/>
     所属阶段: Initialization（初始化阶段）
     <br/>
     执行时机: 在 InitializationSystemGroup 的最后执行。
     <br/>
     用途: 适用于在所有初始化系统运行之后提交命令，例如生成初始实体或设置初始组件。
     <br/>
     示例使用场景: 创建游戏中的初始实体，设置初始组件数据。
    </p>
    <p>
     2.3 BeginSimulationEntityCommandBufferSystem
     <br/>
     所属阶段: Simulation（模拟阶段）
     <br/>
     执行时机: 在 SimulationSystemGroup 的最开始执行。
     <br/>
     用途: 适用于在模拟逻辑运行之前提交命令，例如重置状态或准备模拟所需的实体和组件。
     <br/>
     示例使用场景: 重置游戏逻辑状态，准备模拟所需的实体。
    </p>
    <p>
     2.4 EndSimulationEntityCommandBufferSystem
     <br/>
     所属阶段: Simulation（模拟阶段）
     <br/>
     执行时机: 在 SimulationSystemGroup 的最后执行。
     <br/>
     用途: 适用于在模拟逻辑运行之后提交命令，例如销毁实体或更新组件数据。
     <br/>
     示例使用场景: 销毁不再需要的实体，更新组件数据以反映模拟结果。
    </p>
    <p>
     2.5 BeginPresentationEntityCommandBufferSystem
     <br/>
     所属阶段: Presentation（呈现阶段）
     <br/>
     执行时机: 在 PresentationSystemGroup 的最开始执行。
     <br/>
     用途: 适用于在渲染之前提交命令，例如更新与渲染相关的组件或准备渲染所需的实体。
     <br/>
     示例使用场景: 更新渲染相关的组件，准备渲染所需的实体。
    </p>
    <p>
     2.6 EndPresentationEntityCommandBufferSystem
     <br/>
     所属阶段: Presentation（呈现阶段）
     <br/>
     执行时机: 在 PresentationSystemGroup 的最后执行。
     <br/>
     用途: 适用于在渲染之后提交命令，例如清理渲染相关的资源或处理后处理效果。
     <br/>
     示例使用场景: 清理渲染资源，处理后处理效果。
    </p>
    <p>
     2.7 FixedStepSimulationEntityCommandBufferSystem
     <br/>
     所属阶段: Simulation（模拟阶段），专为固定时间步长设计。
     <br/>
     执行时机: 在固定时间步长的模拟阶段执行。
     <br/>
     用途: 适用于需要与物理引擎等固定时间步长系统配合的操作，例如处理碰撞事件或物理模拟后的操作。
     <br/>
     示例使用场景: 处理物理引擎的碰撞事件，更新与物理模拟相关的组件。
    </p>
    <h3>
     <a id="_98">
     </a>
     示例：
    </h3>
    <p>
     从System 往Job层传递
    </p>
    <pre><code class="prism language-csharp"><span class="token keyword">partial</span> <span class="token keyword">struct</span> <span class="token class-name">BulletMoverSystem</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ISystem</span></span>
<span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">BurstCompile</span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnCreate</span><span class="token punctuation">(</span><span class="token keyword">ref</span> <span class="token class-name">SystemState</span> state<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        state<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">RequireForUpdate</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>EndSimulationEntityCommandBufferSystem<span class="token punctuation">.</span>Singleton<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">BurstCompile</span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnUpdate</span><span class="token punctuation">(</span><span class="token keyword">ref</span> <span class="token class-name">SystemState</span> state<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token class-name"><span class="token keyword">var</span></span> ecb <span class="token operator">=</span> SystemAPI<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetSingleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>EndSimulationEntityCommandBufferSystem<span class="token punctuation">.</span>Singleton<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">CreateCommandBuffer</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>WorldUnmanaged<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AsParallelWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name"><span class="token keyword">var</span></span> job <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">BulletMoverJob</span>
        <span class="token punctuation">{<!-- --></span>
            deltaTime <span class="token operator">=</span> SystemAPI<span class="token punctuation">.</span>Time<span class="token punctuation">.</span>DeltaTime<span class="token punctuation">,</span>
            ECB <span class="token operator">=</span> ecb<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token class-name"><span class="token keyword">var</span></span> jobHandle <span class="token operator">=</span> job<span class="token punctuation">.</span><span class="token function">ScheduleParallel</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>Dependency<span class="token punctuation">)</span><span class="token punctuation">;</span>
        jobHandle<span class="token punctuation">.</span><span class="token function">Complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre>
    <p>
     Job中的ECB使用
    </p>
    <pre><code class="prism language-csharp">
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">BurstCompile</span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">partial</span> <span class="token keyword">struct</span> <span class="token class-name">ShootAttackJob</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IJobEntity</span></span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token class-name">EntitiesReferences</span> EntitiesReferences<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">float</span></span> DeltaTime<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">EntityCommandBuffer<span class="token punctuation">.</span>ParallelWriter</span> ECB<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">EntityIndexInQuery</span></span><span class="token punctuation">]</span> <span class="token class-name"><span class="token keyword">int</span></span> index<span class="token punctuation">,</span>
        <span class="token keyword">ref</span> <span class="token class-name">LocalTransform</span> localTransform<span class="token punctuation">,</span>
        <span class="token keyword">ref</span> <span class="token class-name">FindTarget</span> findTarget<span class="token punctuation">,</span>
        <span class="token keyword">ref</span> <span class="token class-name">ShootAttack</span> shootAttack<span class="token punctuation">,</span>
        <span class="token keyword">ref</span> <span class="token class-name">UnitMover</span> unitMover<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        shootAttack<span class="token punctuation">.</span>timer <span class="token operator">-=</span> DeltaTime<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>shootAttack<span class="token punctuation">.</span>timer <span class="token operator">&gt;</span> <span class="token number">0f</span><span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">;</span>
        shootAttack<span class="token punctuation">.</span>timer <span class="token operator">=</span> shootAttack<span class="token punctuation">.</span>timerMax<span class="token punctuation">;</span>
		
		<span class="token comment">//克隆实体</span>
        <span class="token class-name">Entity</span> bulletEntity <span class="token operator">=</span> ECB<span class="token punctuation">.</span><span class="token function">Instantiate</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> EntitiesReferences<span class="token punctuation">.</span>bulletPrefabEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">float3</span> bulletSpawnWorldPosition <span class="token operator">=</span> localTransform<span class="token punctuation">.</span><span class="token function">TransformPoint</span><span class="token punctuation">(</span>shootAttack<span class="token punctuation">.</span>bulletSpawnLocalPosition<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//修改实体组件</span>
        ECB<span class="token punctuation">.</span><span class="token function">SetComponent</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> bulletEntity<span class="token punctuation">,</span> LocalTransform<span class="token punctuation">.</span><span class="token function">FromPosition</span><span class="token punctuation">(</span>bulletSpawnWorldPosition<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ECB<span class="token punctuation">.</span><span class="token function">SetComponent</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> bulletEntity<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Bullet</span>
        <span class="token punctuation">{<!-- --></span>
            speed <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span>
            damageAmount <span class="token operator">=</span> shootAttack<span class="token punctuation">.</span>damageAmount
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//销毁实体</span>
		ECB<span class="token punctuation">.</span><span class="token function">DestroyEntity</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
  <div class="blog-extension-box" id="blogExtensionBox" style="width:400px;margin:auto;margin-top:12px">
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71713536333132393538322f:61727469636c652f64657461696c732f313436313336333839" class_="artid" style="display:none">
 </p>
</div>


