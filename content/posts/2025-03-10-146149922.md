---
layout: post
title: "PostgreSQL异常An-IO-error-occurred-while-sending-to-the-backend"
date: 2025-03-10 11:59:24 +0800
description: "在使用PostgreSQL。"
keywords: "PostgreSQL异常：An IO error occurred while sending to the backend"
categories: ['面试', '阿里巴巴', '学习路线']
tags: ['数据库', 'Postgresql']
artid: "146149922"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146149922
    alt: "PostgreSQL异常An-IO-error-occurred-while-sending-to-the-backend"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146149922
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146149922
cover: https://bing.ee123.net/img/rand?artid=146149922
image: https://bing.ee123.net/img/rand?artid=146149922
img: https://bing.ee123.net/img/rand?artid=146149922
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     PostgreSQL异常：An IO error occurred while sending to the backend
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/4ecc402008e44288a37cc6ea2eef4aef.png"/>
    </p>
    <p>
     在使用
     <code>
      PostgreSQL
     </code>
     数据库批量写入数据的时候，遇到了一个问题，异常内容如下：
    </p>
    <pre><code>Cause: org.postgresql.util.PSQLException: An I/O error occurred while sending to the backend.
</code></pre>
    <h5>
     <a id="_11">
     </a>
     报错内容
    </h5>
    <h6>
     <a id="1_13">
     </a>
     报错提示1
    </h6>
    <pre><code>Caused by: org.postgresql.util.PSQLException: An I/O error occurred while sending to the backend.
	at org.postgresql.core.v3.QueryExecutorImpl.execute(QueryExecutorImpl.java:336)
	at org.postgresql.jdbc.PgStatement.executeInternal(PgStatement.java:446)
	at org.postgresql.jdbc.PgStatement.execute(PgStatement.java:370)
	at org.postgresql.jdbc.PgPreparedStatement.executeWithFlags(PgPreparedStatement.java:149)
	at org.postgresql.jdbc.PgPreparedStatement.execute(PgPreparedStatement.java:138)
</code></pre>
    <h6>
     <a id="2_23">
     </a>
     报错提示2
    </h6>
    <pre><code>Caused by: java.io.IOException: Tried to send an out-of-range integer as a 2-byte value: 1847252
	at org.postgresql.core.PGStream.sendInteger2(PGStream.java:252)
	at org.postgresql.core.v3.QueryExecutorImpl.sendParse(QueryExecutorImpl.java:1470)
	at org.postgresql.core.v3.QueryExecutorImpl.sendOneQuery(QueryExecutorImpl.java:1793)
	at org.postgresql.core.v3.QueryExecutorImpl.sendQuery(QueryExecutorImpl.java:1356)
	at org.postgresql.core.v3.QueryExecutorImpl.execute(QueryExecutorImpl.java:301)
	... 117 common frames omitted
</code></pre>
    <h5>
     <a id="_34">
     </a>
     问题分析
    </h5>
    <p>
     从首个错误信息中可以看出，在PostgreSQL运行SQL语句时遭遇了输入/输出（I/O）异常，这意味着所执行的SQL语句存在某种问题或数据库文件系统有潜在故障。
    </p>
    <p>
     而第二条错误信息则揭示，PostgreSQL在向客户端传输数据时，数据量超过了预设的限制。这通常表明，执行中的SQL查询结果过于庞大，超出了系统默认的传输容量，可能是因为查询返回了过多的数据行或单行数据包含大量信息所致。
    </p>
    <h6>
     <a id="_40">
     </a>
     查看源码
    </h6>
    <pre><code>  /**
   * Sends a 2-byte integer (short) to the back end.
   *
   * @param val the integer to be sent
   * @throws IOException if an I/O error occurs or {@code val} cannot be encoded in 2 bytes
   */
  public void sendInteger2(int val) throws IOException {
    if (val &lt; Short.MIN_VALUE || val &gt; Short.MAX_VALUE) {
      throw new IOException("Tried to send an out-of-range integer as a 2-byte value: " + val);
    }

    int2Buf[0] = (byte) (val &gt;&gt;&gt; 8);
    int2Buf[1] = (byte) val;
    pgOutput.write(int2Buf);
  }
</code></pre>
    <p>
     <code>
      sendInteger2
     </code>
     方法的作用是将一个整型值转换成短整型的二进制表示，并通过输出流发送给后端。如果输入的值超出短整型的范围，或者在写入过程中出现I/O错误，则会抛出
     <code>
      IOException
     </code>
     。
    </p>
    <p>
     在方法内部，首先进行了一次范围检查，确保传入的整数值在短整型（
     <code>
      short
     </code>
     ）的表示范围内，即介于
     <code>
      Short.MIN_VALUE
     </code>
     和
     <code>
      Short.MAX_VALUE
     </code>
     之间。如果超出范围，会抛出一个
     <code>
      IOException
     </code>
     ，指明试图发送的值过大或过小，无法用两个字节表示。
    </p>
    <p>
     上面的错误提示，能确定就是在这块抛出的了，接下来重点查看代码中批量写入数据的代码。
    </p>
    <h6>
     <a id="_65">
     </a>
     问题发现
    </h6>
    <p>
     拿到接口执行的
     <code>
      SQL
     </code>
     以后，发现是一个批量写入的
     <code>
      SQL
     </code>
     ，执行语句特别长，在
     <code>
      Navicat
     </code>
     中执行就直接报错了；修改批量写入的数据条数，发现是可以正常执行的；
    </p>
    <p>
     伪代码如下：
    </p>
    <pre><code>// 从一个响应中获取一个名为"list"的数据集合
List&lt;CustomEntity&gt; entityList = ExtractListFromResponse(response, "list");

// 使用一个数据访问层组件，将数据插入到数据库中的指定表中
DataMapper.persistResponseData(entityList, targetTableName);
</code></pre>
    <h5>
     <a id="_78">
     </a>
     问题解决
    </h5>
    <h6>
     <a id="_80">
     </a>
     将大集合进行拆分
    </h6>
    <pre><code>// 使用org.apache.commons.collections4提供的ListUtils工具类，将大集合按照每组1000条进行拆分
List&lt;List&lt;CustomEntity&gt;&gt; partition = ListUtils.partition(entityList,1000);
// 循环遍历拆分之后的集合，分批写入数据
for (List&lt;CustomEntity&gt; customEntityList : partition){
    // 使用一个数据访问层组件，将数据插入到数据库中的指定表中
    DataMapper.persistResponseData(customEntityList, targetTableName);
}
</code></pre>
    <h6>
     <a id="MybatisPlus_91">
     </a>
     使用MybatisPlus的批量写入
    </h6>
    <blockquote>
     <p>
      请确保自己的项目当中使用了MybatisPlus
     </p>
    </blockquote>
    <pre><code>// 从一个响应中获取一个名为"list"的数据集合
List&lt;CustomEntity&gt; entityList = ExtractListFromResponse(response, "list");
// 使用MybatisPlus的批量写入，指定每批写入条数
customService.saveBatch(entityList,1000);
</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f6d305f37343832343030322f:61727469636c652f64657461696c732f313436313439393232" class_="artid" style="display:none">
 </p>
</div>


