---
layout: post
title: "聊一聊binder传递文件fd原理及新版本性能优化"
date: 2025-03-13 15:45:19 +0800
description: "上面可以看出与老版本巨大差别在于，新版本根本没有直接在binder_translate_fd中获取target_fd和install target_fd到file，只是构造了binder_txn_fd_fixup对象，赋值file后，然后加入到事物t的fd_fixups列表中。‌收集阶段‌：在源进程的 Binder 线程中，通过 binder_translate_fd 收集所有待映射的 fd，形成 fd_fixups 链表。下面看看真正干活的binder_apply_fd_fixups。"
keywords: "聊一聊binder传递文件fd原理及新版本性能优化"
categories: ['Binder']
tags: ['系统开发', '开发语言', 'Java', 'Framework', 'Binder', 'Android']
artid: "146224227"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146224227
    alt: "聊一聊binder传递文件fd原理及新版本性能优化"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146224227
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146224227
cover: https://bing.ee123.net/img/rand?artid=146224227
image: https://bing.ee123.net/img/rand?artid=146224227
img: https://bing.ee123.net/img/rand?artid=146224227
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     聊一聊binder传递文件fd原理及新版本性能优化
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h3>
     <a id="_0">
     </a>
     背景：
    </h3>
    <p>
     近期有vip学员朋友，问道了一个问题，那就是关于binder跨进程传递fd具体是怎么做到的呢？这块其实binder跨进程传递文件fd，本质的原理的实现在binder驱动中，所以给这个同学找一下相关的binder驱动中的代码，但是发现这块代码还和我以前看过的跨进程传递fd代码有较大的差别了，这个差别还不是简单改变一下方法，而是设计思路上就有变化，所以这里整理一下给大家分享出来。
    </p>
    <h3>
     <a id="binderfd_4">
     </a>
     老版本binder驱动代码传递fd
    </h3>
    <p>
     安卓kernel内核版本：
    </p>
    <pre><code class="prism language-cpp">VERSION <span class="token operator">=</span> <span class="token number">4</span>
PATCHLEVEL <span class="token operator">=</span> <span class="token number">4</span>
SUBLEVEL <span class="token operator">=</span> <span class="token number">302</span>
EXTRAVERSION <span class="token operator">=</span>
</code></pre>
    <p>
     一般在client端调用调用了Parcel.writeFileDescriptor(fd)进行fd传递，接下来跨进程通信会一路调用到binder内核的binder_transaction代码：
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">binder_transaction</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_proc</span> <span class="token operator">*</span>proc<span class="token punctuation">,</span>
			       <span class="token keyword">struct</span> <span class="token class-name">binder_thread</span> <span class="token operator">*</span>thread<span class="token punctuation">,</span>
			       <span class="token keyword">struct</span> <span class="token class-name">binder_transaction_data</span> <span class="token operator">*</span>tr<span class="token punctuation">,</span> <span class="token keyword">int</span> reply<span class="token punctuation">,</span>
			       binder_size_t extra_buffers_size<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//省略</span>

		hdr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_object_header</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>t<span class="token operator">-&gt;</span>buffer<span class="token operator">-&gt;</span>data <span class="token operator">+</span> <span class="token operator">*</span>offp<span class="token punctuation">)</span><span class="token punctuation">;</span>
		off_min <span class="token operator">=</span> <span class="token operator">*</span>offp <span class="token operator">+</span> object_size<span class="token punctuation">;</span>
		<span class="token keyword">switch</span> <span class="token punctuation">(</span>hdr<span class="token operator">-&gt;</span>type<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">//省略</span>

<span class="token comment">//针对binder传递的是fd类型</span>
		<span class="token keyword">case</span> BINDER_TYPE_FD<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">struct</span> <span class="token class-name">binder_fd_object</span> <span class="token operator">*</span>fp <span class="token operator">=</span> <span class="token function">to_binder_fd_object</span><span class="token punctuation">(</span>hdr<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">int</span> target_fd <span class="token operator">=</span> <span class="token function">binder_translate_fd</span><span class="token punctuation">(</span>fp<span class="token operator">-&gt;</span>fd<span class="token punctuation">,</span> t<span class="token punctuation">,</span> thread<span class="token punctuation">,</span>
							    in_reply_to<span class="token punctuation">)</span><span class="token punctuation">;</span>

			fp<span class="token operator">-&gt;</span>pad_binder <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			fp<span class="token operator">-&gt;</span>fd <span class="token operator">=</span> target_fd<span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     老版本内核处理fd转换：
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">binder_translate_fd</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span>
			       <span class="token keyword">struct</span> <span class="token class-name">binder_transaction</span> <span class="token operator">*</span>t<span class="token punctuation">,</span>
			       <span class="token keyword">struct</span> <span class="token class-name">binder_thread</span> <span class="token operator">*</span>thread<span class="token punctuation">,</span>
			       <span class="token keyword">struct</span> <span class="token class-name">binder_transaction</span> <span class="token operator">*</span>in_reply_to<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">binder_proc</span> <span class="token operator">*</span>proc <span class="token operator">=</span> thread<span class="token operator">-&gt;</span>proc<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">binder_proc</span> <span class="token operator">*</span>target_proc <span class="token operator">=</span> t<span class="token operator">-&gt;</span>to_proc<span class="token punctuation">;</span>
	<span class="token keyword">int</span> target_fd<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">;</span>
	<span class="token keyword">int</span> ret<span class="token punctuation">;</span>

<span class="token comment">//这个fd的是源进程的，通过fd获取到对应的file结构</span>
	file <span class="token operator">=</span> <span class="token function">fget</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//这里只是安全坚持，file是否可以传递过去</span>
	ret <span class="token operator">=</span> <span class="token function">security_binder_transfer_file</span><span class="token punctuation">(</span>proc<span class="token operator">-&gt;</span>cred<span class="token punctuation">,</span> target_proc<span class="token operator">-&gt;</span>cred<span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//这里会从目标进程中获取没有使用的fd，赋值给target_fd</span>
	target_fd <span class="token operator">=</span> <span class="token function">task_get_unused_fd_flags</span><span class="token punctuation">(</span>target_proc<span class="token punctuation">,</span> O_CLOEXEC<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//直接把从目标进程获取的空闲target_fd与file进行绑定</span>
	<span class="token function">task_fd_install</span><span class="token punctuation">(</span>target_proc<span class="token punctuation">,</span> target_fd<span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> target_fd<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre>
    <p>
     也看看fget和task_fd_install这两个核心方法：
     <br/>
     fget其实是调用到__fget
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token function">__fget</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> fmode_t mask<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> refs<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">files_struct</span> <span class="token operator">*</span>files <span class="token operator">=</span> current<span class="token operator">-&gt;</span>files<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">;</span>

	<span class="token function">rcu_read_lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
loop<span class="token operator">:</span>
	file <span class="token operator">=</span> <span class="token function">fcheck_files</span><span class="token punctuation">(</span>files<span class="token punctuation">,</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//省略</span>
	<span class="token function">rcu_read_unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> file<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     再看看task_fd_install方法：
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token function">__fd_install</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">files_struct</span> <span class="token operator">*</span>files<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span>
		<span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">fdtable</span> <span class="token operator">*</span>fdt<span class="token punctuation">;</span>

	<span class="token function">might_sleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">rcu_read_lock_sched</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span>files<span class="token operator">-&gt;</span>resize_in_progress<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">rcu_read_unlock_sched</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">wait_event</span><span class="token punctuation">(</span>files<span class="token operator">-&gt;</span>resize_wait<span class="token punctuation">,</span> <span class="token operator">!</span>files<span class="token operator">-&gt;</span>resize_in_progress<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">rcu_read_lock_sched</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">/* coupled with smp_wmb() in expand_fdtable() */</span>
	<span class="token function">smp_rmb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	fdt <span class="token operator">=</span> <span class="token function">rcu_dereference_sched</span><span class="token punctuation">(</span>files<span class="token operator">-&gt;</span>fdt<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">BUG_ON</span><span class="token punctuation">(</span>fdt<span class="token operator">-&gt;</span>fd<span class="token punctuation">[</span>fd<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">rcu_assign_pointer</span><span class="token punctuation">(</span>fdt<span class="token operator">-&gt;</span>fd<span class="token punctuation">[</span>fd<span class="token punctuation">]</span><span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//这里就是源进程file与新进程fd进行了绑定</span>
	<span class="token function">rcu_read_unlock_sched</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     其实老版本的binder传递fd还是比较好理解的，主要就以下几个步骤：
     <br/>
     1、根据源进程fd获取内核中对应的file
     <br/>
     2、在目标进程中获取空闲没有使用的fd值
     <br/>
     3、把第1步获取的file对象与第2步获取的fd值进行绑定既可以
    </p>
    <p>
     老版本binder驱动的fd传递基本工作都直接在binder_translate_fd这个方法中完成，但是新版本binder驱动这块就有了较大的差异。
     <br/>
     总结一个简单图给大家更容易理解：
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/9d7996a71ebd43e9b47e3a242a3c310e.png"/>
    </p>
    <h3>
     <a id="binderfd_122">
     </a>
     新版本binder驱动代码传递fd
    </h3>
    <p>
     安卓kernel内核版本：
    </p>
    <pre><code class="prism language-bash">VERSION <span class="token operator">=</span> <span class="token number">6</span>
PATCHLEVEL <span class="token operator">=</span> <span class="token number">1</span>
SUBLEVEL <span class="token operator">=</span> <span class="token number">90</span>
EXTRAVERSION <span class="token operator">=</span>
NAME <span class="token operator">=</span> Curry Ramen
</code></pre>
    <p>
     下面来看看这个6.1对应的源码是怎么传递fd的
    </p>
    <pre><code class="prism language-cpp">
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">binder_translate_fd</span><span class="token punctuation">(</span>u32 fd<span class="token punctuation">,</span> binder_size_t fd_offset<span class="token punctuation">,</span>
			       <span class="token keyword">struct</span> <span class="token class-name">binder_transaction</span> <span class="token operator">*</span>t<span class="token punctuation">,</span>
			       <span class="token keyword">struct</span> <span class="token class-name">binder_thread</span> <span class="token operator">*</span>thread<span class="token punctuation">,</span>
			       <span class="token keyword">struct</span> <span class="token class-name">binder_transaction</span> <span class="token operator">*</span>in_reply_to<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">binder_proc</span> <span class="token operator">*</span>proc <span class="token operator">=</span> thread<span class="token operator">-&gt;</span>proc<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">binder_proc</span> <span class="token operator">*</span>target_proc <span class="token operator">=</span> t<span class="token operator">-&gt;</span>to_proc<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">binder_txn_fd_fixup</span> <span class="token operator">*</span>fixup<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">;</span>

 <span class="token comment">//这里也是通过源进程fd获取对应的file结构</span>
	file <span class="token operator">=</span> <span class="token function">fget</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//检验传递安全性</span>
	ret <span class="token operator">=</span> <span class="token function">security_binder_transfer_file</span><span class="token punctuation">(</span>proc<span class="token operator">-&gt;</span>cred<span class="token punctuation">,</span> target_proc<span class="token operator">-&gt;</span>cred<span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>
	

	<span class="token comment">/*
	 * Add fixup record for this transaction. The allocation
	 * of the fd in the target needs to be done from a
	 * target thread.
	 */</span>
	 
	 <span class="token comment">//以下是差异部分</span>
	<span class="token comment">//构造出一个binder_txn_fd_fixup结构</span>
	fixup <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>fixup<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//检验传递安全性</span>
	fixup<span class="token operator">-&gt;</span>file <span class="token operator">=</span> file<span class="token punctuation">;</span><span class="token comment">//获取file</span>
	fixup<span class="token operator">-&gt;</span>offset <span class="token operator">=</span> fd_offset<span class="token punctuation">;</span>
	fixup<span class="token operator">-&gt;</span>target_fd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//注意这里开始构造时候没有值</span>
	
	<span class="token comment">//该代码将 fixup 结构体（类型为 binder_txn_fd_fixup）的成员 fixup_entry </span>
	<span class="token comment">//添加到事务 t的 fd_fixups 链表尾部，用于‌延迟处理文件描述符（fd）的跨进程映射‌。</span>
	<span class="token function">list_add_tail</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fixup<span class="token operator">-&gt;</span>fixup_entry<span class="token punctuation">,</span> <span class="token operator">&amp;</span>t<span class="token operator">-&gt;</span>fd_fixups<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     上面可以看出与老版本巨大差别在于，新版本根本没有直接在binder_translate_fd中获取target_fd和install target_fd到file，只是构造了binder_txn_fd_fixup对象，赋值file后，然后加入到事物t的fd_fixups列表中。
    </p>
    <p>
     下面来看看‌binder_txn_fd_fixup 结构体‌
     <br/>
     表示一个待处理的 fd 映射修正项，包含以下关键字段：
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">struct</span> <span class="token class-name">binder_txn_fd_fixup</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">;</span>       <span class="token comment">// 源进程的 file 对象</span>
    binder_size_t offset<span class="token punctuation">;</span>    <span class="token comment">// fd 在事务数据缓冲区中的偏移</span>
    <span class="token keyword">int</span> target_fd<span class="token punctuation">;</span>           <span class="token comment">// 目标进程的 fd（初始为 -1）</span>
    <span class="token keyword">struct</span> <span class="token class-name">list_head</span> fixup_entry<span class="token punctuation">;</span> <span class="token comment">// 链表节点（通过 list_add_tail 链接）</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     上面看完后最大疑问肯定是：
     <br/>
     1、没有看到有target_fd在目标进行进行获取啊？
     <br/>
     2、也没有看到file与target_fd进行映射？
    </p>
    <p>
     那么新版本到底是如何通过binder_txn_fd_fixup就可以实现的fd的跨进程传递呢？又为什么要这样做呢？
    </p>
    <p>
     按照上面源码分析可以看到最后的binder_txn_fd_fixup被放到了传递事物binder_transaction中去了，那么什么时候执行处理这个呢？
    </p>
    <p>
     目标进程处理事务‌，这里处理事物肯定在目标进程的binder_thread_read时候：
    </p>
    <p>
     在 binder_thread_read 或事务处理函数中，遍历 t-&gt;fd_fixups 链表：
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">binder_thread_read</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_proc</span> <span class="token operator">*</span>proc<span class="token punctuation">,</span>
			      <span class="token keyword">struct</span> <span class="token class-name">binder_thread</span> <span class="token operator">*</span>thread<span class="token punctuation">,</span>
			      binder_uintptr_t binder_buffer<span class="token punctuation">,</span> size_t size<span class="token punctuation">,</span>
			      binder_size_t <span class="token operator">*</span>consumed<span class="token punctuation">,</span> <span class="token keyword">int</span> non_block<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
		<span class="token comment">//省略</span>
		<span class="token comment">//使用binder_apply_fd_fixups方法来专门处理fd相关</span>
		ret <span class="token operator">=</span> <span class="token function">binder_apply_fd_fixups</span><span class="token punctuation">(</span>proc<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//省略</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     下面看看真正干活的binder_apply_fd_fixups
    </p>
    <pre><code class="prism language-cpp">   <span class="token comment">/**
 * binder_apply_fd_fixups() - finish fd translation
 * @proc:         binder_proc associated @t-&gt;buffer
 * @t:	binder transaction with list of fd fixups
 *
 * Now that we are in the context of the transaction target
 * process, we can allocate and install fds. Process the
 * list of fds to translate and fixup the buffer with the
 * new fds first and only then install the files.
 *
 * If we fail to allocate an fd, skip the install and release
 * any fds that have already been allocated.
 */</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">binder_apply_fd_fixups</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_proc</span> <span class="token operator">*</span>proc<span class="token punctuation">,</span>
				  <span class="token keyword">struct</span> <span class="token class-name">binder_transaction</span> <span class="token operator">*</span>t<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">binder_txn_fd_fixup</span> <span class="token operator">*</span>fixup<span class="token punctuation">,</span> <span class="token operator">*</span>tmp<span class="token punctuation">;</span>
	<span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

	<span class="token function">list_for_each_entry</span><span class="token punctuation">(</span>fixup<span class="token punctuation">,</span> <span class="token operator">&amp;</span>t<span class="token operator">-&gt;</span>fd_fixups<span class="token punctuation">,</span> fixup_entry<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">//获取目标进程的空闲fd</span>
		<span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">get_unused_fd_flags</span><span class="token punctuation">(</span>O_CLOEXEC<span class="token punctuation">)</span><span class="token punctuation">;</span>
		fixup<span class="token operator">-&gt;</span>target_fd <span class="token operator">=</span> fd<span class="token punctuation">;</span><span class="token comment">//赋值给target_fd</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">binder_alloc_copy_to_buffer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>proc<span class="token operator">-&gt;</span>alloc<span class="token punctuation">,</span> t<span class="token operator">-&gt;</span>buffer<span class="token punctuation">,</span>
						fixup<span class="token operator">-&gt;</span>offset<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fd<span class="token punctuation">,</span>
						<span class="token keyword">sizeof</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token function">list_for_each_entry_safe</span><span class="token punctuation">(</span>fixup<span class="token punctuation">,</span> tmp<span class="token punctuation">,</span> <span class="token operator">&amp;</span>t<span class="token operator">-&gt;</span>fd_fixups<span class="token punctuation">,</span> fixup_entry<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">//把源file与上面赋值的fixup-&gt;target_fd进行关联</span>
		<span class="token function">fd_install</span><span class="token punctuation">(</span>fixup<span class="token operator">-&gt;</span>target_fd<span class="token punctuation">,</span> fixup<span class="token operator">-&gt;</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">list_del</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fixup<span class="token operator">-&gt;</span>fixup_entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">kfree</span><span class="token punctuation">(</span>fixup<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     上面源码就很清楚看出来，fd的获取和关联file结构都是在目标进程进行read的时候才操作的，而不是和老版本那样在源进程进行binder_transaction时候做的，那么这样做是基于什么考虑呢？
     <br/>
     个人认为有以下几个部分：
    </p>
    <p>
     <strong>
      ‌延迟处理设计‌
     </strong>
    </p>
    <p>
     原因‌：目标进程的 fd 分配必须在其自身上下文中执行（涉及进程的 fd 表），避免竞态或权限问题。
     <br/>
     ‌流程‌：
     <br/>
     ‌收集阶段‌：在源进程的 Binder 线程中，通过 binder_translate_fd 收集所有待映射的 fd，形成 fd_fixups 链表。
     <br/>
     ‌处理阶段‌：当目标进程的线程处理该事务时，遍历 fd_fixups 链表，为每个 fixup 分配 target_fd，并修改事务数据缓冲区中的 fd 值。
    </p>
    <p>
     有以下几个优势：
     <br/>
     安全性‌
     <br/>
     ‌权限隔离‌：目标进程自行分配 fd，避免源进程直接操作目标资源。
     <br/>
     ‌策略检查‌：在 binder_translate_fd 阶段已通过 SELinux 检查（security_binder_transfer_file）。
    </p>
    <p>
     原子性‌
     <br/>
     所有 fd 修正项集中处理，确保事务数据的一致性。
    </p>
    <p>
     性能优化‌
     <br/>
     延迟分配减少上下文切换，结合 Binder 的 mmap 机制实现零拷贝。
    </p>
    <p>
     文章参考来源：
     <a href="https://mp.weixin.qq.com/s/PabuIBgrX1EPcY0FLWSgGg" rel="nofollow">
      https://mp.weixin.qq.com/s/PabuIBgrX1EPcY0FLWSgGg
     </a>
    </p>
    <p>
     更多framework实战开发，关注下面“千里马学框架”
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
  <div class="blog-extension-box" id="blogExtensionBox" style="width:400px;margin:auto;margin-top:12px">
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f67:2e6373646e2e6e65742f6c6561726e6672616d65776f726b2f:61727469636c652f64657461696c732f313436323234323237" class_="artid" style="display:none">
 </p>
</div>


