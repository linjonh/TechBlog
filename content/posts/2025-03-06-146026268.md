---
layout: post
title: "C第二十一讲智能指针"
date: 2025-03-06 17:13:39 +0800
description: "C++第二十一讲：智能指针"
keywords: "C++第二十一讲：智能指针"
categories: ['C']
tags: ['开发语言', 'Java', 'C']
artid: "146026268"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146026268
    alt: "C第二十一讲智能指针"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146026268
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146026268
cover: https://bing.ee123.net/img/rand?artid=146026268
image: https://bing.ee123.net/img/rand?artid=146026268
img: https://bing.ee123.net/img/rand?artid=146026268
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     C++第二十一讲：智能指针
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <p>
    </p>
    <h2>
     <a id="1_1">
     </a>
     1.智能指针使用场景分析
    </h2>
    <blockquote>
     <p>
      智能指针的使用大多发生在容易出现内存泄漏的地方，因为对于某些场景，稍微的操作不当就容易造成内存泄漏，而智能指针的实现，让我们不再需要担心内存泄漏的问题，它能够帮助我们进行内存的释放：
     </p>
    </blockquote>
    <pre><code class="prism language-cpp"><span class="token keyword">double</span> <span class="token function">divided</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>b <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>	<span class="token keyword">throw</span><span class="token punctuation">(</span><span class="token string">"Divided by zero condition！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">else</span> <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>a <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>b<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">Func</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span><span class="token operator">*</span> array1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span><span class="token operator">*</span> array2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

	<span class="token keyword">try</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">int</span> len<span class="token punctuation">,</span> time<span class="token punctuation">;</span>
		cin <span class="token operator">&gt;&gt;</span> len <span class="token operator">&gt;&gt;</span> time<span class="token punctuation">;</span>
		cout <span class="token operator">&lt;&lt;</span> <span class="token function">divided</span><span class="token punctuation">(</span>len<span class="token punctuation">,</span> time<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token comment">//1.如果在这里捕获到异常，需要进行delete释放资源</span>
		<span class="token keyword">delete</span><span class="token punctuation">[</span><span class="token punctuation">]</span> array1<span class="token punctuation">;</span>
		<span class="token keyword">delete</span><span class="token punctuation">[</span><span class="token punctuation">]</span> array2<span class="token punctuation">;</span>
		<span class="token keyword">throw</span><span class="token punctuation">;</span> <span class="token comment">//异常重新抛出，捕获到什么抛出什么 </span>
	<span class="token punctuation">}</span>
	<span class="token comment">//2.如果没有抛出异常，那么这里也要进行空间的释放</span>
	<span class="token keyword">delete</span><span class="token punctuation">[</span><span class="token punctuation">]</span> array1<span class="token punctuation">;</span>
	<span class="token keyword">delete</span><span class="token punctuation">[</span><span class="token punctuation">]</span> array2<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">try</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">Func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> errmsg<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		cout <span class="token operator">&lt;&lt;</span> errmsg <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token keyword">const</span> exception<span class="token operator">&amp;</span> e<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		cout <span class="token operator">&lt;&lt;</span> e<span class="token punctuation">.</span><span class="token function">what</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		cout <span class="token operator">&lt;&lt;</span> <span class="token string">"未知异常"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     上面1、2位置的delete是必不可少的，如果少一个就会导致内存泄漏的问题，而且如果需要释放多个资源，那么还需要手动写出多个delete，这样是很麻烦的，下面我们使用智能指针的知识来解决上面的问题
    </p>
    <h2>
     <a id="2RAII_57">
     </a>
     2.RAII和智能指针的设计思路
    </h2>
    <p>
     什么是RAII：RAII是和资源管理有关的一种编程技术，本质是通过对象的生命周期自动化资源管理，比如智能指针的自动释放资源、文件操作的自动关闭文件、锁管理的自动解锁，防止死锁问题
     <br/>
     智能指针除了满足RAII的设计思路外，还要方便资源的访问，所以指针指针还像迭代器一样，重载了operator*/operator-&gt;/operator[]等运算符，方便访问资源
    </p>
    <blockquote>
     <p>
      下面我们看一下RAII思想的智能指针的简单实现：
     </p>
    </blockquote>
    <pre><code class="prism language-cpp"><span class="token keyword">namespace</span> YWL
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
	<span class="token keyword">class</span> <span class="token class-name">Smart_ptr</span>
	<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">public</span><span class="token operator">:</span>
		<span class="token function">Smart_ptr</span><span class="token punctuation">(</span>T<span class="token operator">*</span> ptr<span class="token punctuation">)</span>
			<span class="token operator">:</span><span class="token function">_ptr</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

		<span class="token operator">~</span><span class="token function">Smart_ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">delete</span><span class="token punctuation">[</span><span class="token punctuation">]</span> _ptr<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		T<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> <span class="token operator">*</span>_ptr<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		T<span class="token operator">*</span> <span class="token keyword">operator</span><span class="token operator">-&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> _ptr<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		T<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>size_t i<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> _ptr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

	<span class="token keyword">private</span><span class="token operator">:</span>
		T<span class="token operator">*</span> _ptr<span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     此时就不需要再进行析构了，因为当smart_ptr初始化的对象生命周期一到，就会自动执行析构：
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">double</span> <span class="token function">divided</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>b <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>	<span class="token keyword">throw</span><span class="token punctuation">(</span><span class="token string">"Divided by zero condition！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">else</span> <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>a <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>b<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">Func</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	YWL<span class="token double-colon punctuation">::</span>Smart_ptr<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> <span class="token function">array1</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	YWL<span class="token double-colon punctuation">::</span>Smart_ptr<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> <span class="token function">array2</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">try</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">int</span> len<span class="token punctuation">,</span> time<span class="token punctuation">;</span>
		cin <span class="token operator">&gt;&gt;</span> len <span class="token operator">&gt;&gt;</span> time<span class="token punctuation">;</span>
		cout <span class="token operator">&lt;&lt;</span> <span class="token function">divided</span><span class="token punctuation">(</span>len<span class="token punctuation">,</span> time<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">throw</span><span class="token punctuation">;</span> <span class="token comment">//异常重新抛出，捕获到什么抛出什么 </span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">try</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">Func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> errmsg<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		cout <span class="token operator">&lt;&lt;</span> errmsg <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token keyword">const</span> exception<span class="token operator">&amp;</span> e<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		cout <span class="token operator">&lt;&lt;</span> e<span class="token punctuation">.</span><span class="token function">what</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		cout <span class="token operator">&lt;&lt;</span> <span class="token string">"未知异常"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h2>
     <a id="3C_147">
     </a>
     3.C++标准库智能指针的使用
    </h2>
    <blockquote>
     <p>
      C++标准库中实现的智能指针都被保存在这个头文件中，智能指针有好几种，它们的主要区别在于底层实现的不同
     </p>
    </blockquote>
    <h3>
     <a id="31auto_ptr_149">
     </a>
     3.1auto_ptr
    </h3>
    <p>
     auto_ptr是C++98实现的智能指针，它的特点是拷贝时将被拷贝对象的资源的管理权交给拷贝对象，这个设计非常糟糕，因为它会导致被拷贝对象悬空，访问报错的问题，所以强烈不建议使用auto_ptr：
    </p>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;memory&gt;</span></span>

<span class="token keyword">struct</span> <span class="token class-name">Date</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">Date</span><span class="token punctuation">(</span><span class="token keyword">int</span> year <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">int</span> month <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">int</span> day <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token operator">:</span><span class="token function">_year</span><span class="token punctuation">(</span>year<span class="token punctuation">)</span>
		<span class="token punctuation">,</span> <span class="token function">_month</span><span class="token punctuation">(</span>month<span class="token punctuation">)</span>
		<span class="token punctuation">,</span> <span class="token function">_day</span><span class="token punctuation">(</span>day<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

	<span class="token operator">~</span><span class="token function">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		cout <span class="token operator">&lt;&lt;</span> <span class="token string">"~Date()"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">int</span> _year<span class="token punctuation">;</span>
	<span class="token keyword">int</span> _month<span class="token punctuation">;</span>
	<span class="token keyword">int</span> _day<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	auto_ptr<span class="token operator">&lt;</span>Date<span class="token operator">&gt;</span> <span class="token function">ptr1</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	auto_ptr<span class="token operator">&lt;</span>Date<span class="token operator">&gt;</span> <span class="token function">ptr2</span><span class="token punctuation">(</span>ptr1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//auto_ptr拷贝时会将ptr1置空，从而造成问题</span>

	<span class="token comment">//ptr1-&gt;_day++;//进程直接终止</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     我们可以查看auto_ptr的模拟实现来观察它的设计：
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword">class</span> <span class="token class-name">auto_ptr</span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
	<span class="token function">auto_ptr</span><span class="token punctuation">(</span>T<span class="token operator">*</span> ptr<span class="token punctuation">)</span>
		<span class="token operator">:</span><span class="token function">_ptr</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

	<span class="token operator">~</span><span class="token function">auto_ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>_ptr<span class="token punctuation">)</span> <span class="token keyword">delete</span> _ptr<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">auto_ptr</span><span class="token punctuation">(</span>auto_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token operator">&amp;</span> autoptr<span class="token punctuation">)</span>
		<span class="token operator">:</span><span class="token function">_ptr</span><span class="token punctuation">(</span>autoptr<span class="token punctuation">.</span>_ptr<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		autoptr<span class="token punctuation">.</span>_ptr <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span><span class="token comment">//转移管理权</span>
	<span class="token punctuation">}</span>

	auto_ptr<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span>auto_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token operator">&amp;</span> ap<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token comment">//检测是否为⾃⼰给⾃⼰赋值 </span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">!=</span> <span class="token operator">&amp;</span>ap<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token comment">//释放当前对象中资源 </span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>_ptr<span class="token punctuation">)</span>
				<span class="token keyword">delete</span> _ptr<span class="token punctuation">;</span>
			<span class="token comment">//转移ap中资源到当前对象中 </span>
			_ptr <span class="token operator">=</span> ap<span class="token punctuation">.</span>_ptr<span class="token punctuation">;</span>
			ap<span class="token punctuation">.</span>_ptr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	T<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token operator">*</span>_ptr<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	T<span class="token operator">*</span> <span class="token keyword">operator</span><span class="token operator">-&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> _ptr<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
	T<span class="token operator">*</span> _ptr<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <h3>
     <a id="32unique_ptr_234">
     </a>
     3.2unique_ptr
    </h3>
    <p>
     unique_ptr是C++11设计出来的智能指针，它的特点是不支持拷贝，只支持移动
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">struct</span> <span class="token class-name">Date</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">Date</span><span class="token punctuation">(</span><span class="token keyword">int</span> year <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">int</span> month <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">int</span> day <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token operator">:</span><span class="token function">_year</span><span class="token punctuation">(</span>year<span class="token punctuation">)</span>
		<span class="token punctuation">,</span> <span class="token function">_month</span><span class="token punctuation">(</span>month<span class="token punctuation">)</span>
		<span class="token punctuation">,</span> <span class="token function">_day</span><span class="token punctuation">(</span>day<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

	<span class="token operator">~</span><span class="token function">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		cout <span class="token operator">&lt;&lt;</span> <span class="token string">"~Date()"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">int</span> _year<span class="token punctuation">;</span>
	<span class="token keyword">int</span> _month<span class="token punctuation">;</span>
	<span class="token keyword">int</span> _day<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	unique_ptr<span class="token operator">&lt;</span>Date<span class="token operator">&gt;</span> <span class="token function">ptr1</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//不支持拷贝</span>
	<span class="token comment">//unique_ptr&lt;Date&gt; ptr2(ptr1);</span>
	<span class="token comment">//只支持移动，但是移动后ptr1也会悬空</span>
	unique_ptr<span class="token operator">&lt;</span>Date<span class="token operator">&gt;</span> <span class="token function">ptr2</span><span class="token punctuation">(</span><span class="token function">move</span><span class="token punctuation">(</span>ptr1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//ptr1-&gt;_day++;</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     它的实现也是相对来说比较简单的：
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword">class</span> <span class="token class-name">unique_ptr</span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
	<span class="token comment">//explicit的作用为防止不必要的类型转换unique_ptr&lt;Date&gt; ptr3 = new Date();</span>
	<span class="token comment">//可以避免上面代码情况的发生，也就是不支持隐式类型转换，new Date并不是unique_ptr&lt;Date&gt;类型的</span>
	<span class="token keyword">explicit</span> <span class="token function">unique_ptr</span><span class="token punctuation">(</span>T<span class="token operator">*</span> ptr<span class="token punctuation">)</span>
		<span class="token operator">:</span><span class="token function">_ptr</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

	<span class="token operator">~</span><span class="token function">unique_ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>_ptr<span class="token punctuation">)</span> <span class="token keyword">delete</span> _ptr<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//不支持拷贝，只支持移动</span>
	<span class="token function">unique_ptr</span><span class="token punctuation">(</span><span class="token keyword">const</span> unique_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token operator">&amp;</span> up<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>
	<span class="token function">unique_ptr</span><span class="token punctuation">(</span>unique_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token operator">&amp;&amp;</span> up<span class="token punctuation">)</span>
		<span class="token operator">:</span><span class="token function">_ptr</span><span class="token punctuation">(</span>up<span class="token punctuation">.</span>_ptr<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		up<span class="token punctuation">.</span>_ptr <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//不支持拷贝，只支持移动</span>
	unique_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> unique_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token operator">&amp;</span> sp<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>
	unique_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span>unique_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token operator">&amp;&amp;</span> sp<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">delete</span> _ptr<span class="token punctuation">;</span>
		_ptr <span class="token operator">=</span> sp<span class="token punctuation">.</span>_ptr<span class="token punctuation">;</span>
		sp<span class="token punctuation">.</span>_ptr <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
		
		<span class="token keyword">return</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	T<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token operator">*</span>_ptr<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	T<span class="token operator">*</span> <span class="token keyword">operator</span><span class="token operator">-&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> _ptr<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
	T<span class="token operator">*</span> _ptr<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <h3>
     <a id="33shared_ptr_320">
     </a>
     3.3shared_ptr
    </h3>
    <p>
     shared_ptr是C++11设计设计出来的智能指针，它的特点是既支持拷贝，又支持移动，使用智能指针时，建议使用shared_ptr，而它的拷贝不是像auto_ptr那样的资源管理权的转移，而是采用了引用计数的方法：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/7520547d7b7f4949b1be26917a354991.png"/>
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">struct</span> <span class="token class-name">Date</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">Date</span><span class="token punctuation">(</span><span class="token keyword">int</span> year <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">int</span> month <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">int</span> day <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token operator">:</span><span class="token function">_year</span><span class="token punctuation">(</span>year<span class="token punctuation">)</span>
		<span class="token punctuation">,</span> <span class="token function">_month</span><span class="token punctuation">(</span>month<span class="token punctuation">)</span>
		<span class="token punctuation">,</span> <span class="token function">_day</span><span class="token punctuation">(</span>day<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

	<span class="token operator">~</span><span class="token function">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		cout <span class="token operator">&lt;&lt;</span> <span class="token string">"~Date()"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">int</span> _year<span class="token punctuation">;</span>
	<span class="token keyword">int</span> _month<span class="token punctuation">;</span>
	<span class="token keyword">int</span> _day<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	shared_ptr<span class="token operator">&lt;</span>Date<span class="token operator">&gt;</span> <span class="token function">ptr1</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	shared_ptr<span class="token operator">&lt;</span>Date<span class="token operator">&gt;</span> <span class="token function">ptr2</span><span class="token punctuation">(</span>ptr1<span class="token punctuation">)</span><span class="token punctuation">;</span>

	cout <span class="token operator">&lt;&lt;</span> ptr1<span class="token operator">-&gt;</span>_day <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span><span class="token comment">//1</span>
	ptr1<span class="token operator">-&gt;</span>_day<span class="token operator">++</span><span class="token punctuation">;</span>
	cout <span class="token operator">&lt;&lt;</span> ptr2<span class="token operator">-&gt;</span>_day <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span><span class="token comment">//2</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="331_355">
     </a>
     3.3.1删除器
    </h4>
    <blockquote>
     <p>
      在实现shared_ptr之前，我们需要先强调一下删除器的概念：
     </p>
    </blockquote>
    <p>
     智能指针析构默认是delete释放资源，如果不是new出来的资源，交给智能指针管理，析构时就会崩溃，而且对于数组类型的对象，delete释放资源也会造成报错：
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">struct</span> <span class="token class-name">Date</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">Date</span><span class="token punctuation">(</span><span class="token keyword">int</span> year <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">int</span> month <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">int</span> day <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token operator">:</span><span class="token function">_year</span><span class="token punctuation">(</span>year<span class="token punctuation">)</span>
		<span class="token punctuation">,</span> <span class="token function">_month</span><span class="token punctuation">(</span>month<span class="token punctuation">)</span>
		<span class="token punctuation">,</span> <span class="token function">_day</span><span class="token punctuation">(</span>day<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

	<span class="token operator">~</span><span class="token function">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		cout <span class="token operator">&lt;&lt;</span> <span class="token string">"~Date()"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">int</span> _year<span class="token punctuation">;</span>
	<span class="token keyword">int</span> _month<span class="token punctuation">;</span>
	<span class="token keyword">int</span> _day<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword">class</span> <span class="token class-name">DeleteArray</span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
	<span class="token keyword">void</span> <span class="token keyword">operator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>T<span class="token operator">*</span> ptr<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">delete</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ptr<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token function">DeleteArrayFunc</span><span class="token punctuation">(</span>T<span class="token operator">*</span> ptr<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">delete</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ptr<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//1.对于数组类型的对象，这样写会导致程序崩溃</span>
	<span class="token comment">//shared_ptr&lt;Date&gt; ptr1(new Date[10]);</span>
	<span class="token comment">//解决方案一：因为new[]经常使用，所以C++11对于unique_ptr和shared_ptr</span>
	<span class="token comment">//			  都特化了一份[]的版本</span>
	shared_ptr<span class="token operator">&lt;</span>Date<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token function">ptr2</span><span class="token punctuation">(</span><span class="token keyword">new</span> Date<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	unique_ptr<span class="token operator">&lt;</span>Date<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token function">ptr3</span><span class="token punctuation">(</span><span class="token keyword">new</span> Date<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//解决方案二：使用删除器</span>
	<span class="token comment">//unique_ptr和shared_ptr使用删除器的方法不同，这点设计的很麻烦，总而言之：</span>
	<span class="token comment">//unique_ptr需要指定删除器的类型，还需要指定删除器的指针</span>
	<span class="token comment">//shared_ptr只需要指定删除其的指针即可</span>
	<span class="token comment">//1.使用函数指针作删除器</span>
	unique_ptr<span class="token operator">&lt;</span>Date<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>Date<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token function">ptr4</span><span class="token punctuation">(</span><span class="token keyword">new</span> Date<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span> DeleteArrayFunc<span class="token operator">&lt;</span>Date<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	shared_ptr<span class="token operator">&lt;</span>Date<span class="token operator">&gt;</span> <span class="token function">ptr5</span><span class="token punctuation">(</span><span class="token keyword">new</span> Date<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span> DeleteArrayFunc<span class="token operator">&lt;</span>Date<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//2.仿函数对象作删除器</span>
	unique_ptr<span class="token operator">&lt;</span>Date<span class="token punctuation">,</span> DeleteArray<span class="token operator">&lt;</span>Date<span class="token operator">&gt;&gt;</span> <span class="token function">ptr6</span> <span class="token punctuation">(</span><span class="token keyword">new</span> Date<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	shared_ptr<span class="token operator">&lt;</span>Date<span class="token operator">&gt;</span> <span class="token function">ptr7</span><span class="token punctuation">(</span><span class="token keyword">new</span> Date<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token generic-function"><span class="token function">DeleteArray</span><span class="token generic class-name"><span class="token operator">&lt;</span>Date<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//3.lambda表达式作删除器</span>
	<span class="token keyword">auto</span> DeleteArray1 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>Date<span class="token operator">*</span> ptr<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token keyword">delete</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ptr<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
	unique_ptr<span class="token operator">&lt;</span>Date<span class="token punctuation">,</span> <span class="token keyword">decltype</span><span class="token punctuation">(</span>DeleteArray1<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token function">ptr8</span><span class="token punctuation">(</span><span class="token keyword">new</span> Date<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span> DeleteArray1<span class="token punctuation">)</span><span class="token punctuation">;</span>
	shared_ptr<span class="token operator">&lt;</span>Date<span class="token operator">&gt;</span> <span class="token function">ptr9</span><span class="token punctuation">(</span><span class="token keyword">new</span> Date<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>Date<span class="token operator">*</span> ptr<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">delete</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ptr<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//4.实现其他资源管理的删除器 </span>
	shared_ptr<span class="token operator">&lt;</span>FILE<span class="token operator">&gt;</span> <span class="token function">sp6</span><span class="token punctuation">(</span><span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">"Test.cpp"</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>FILE<span class="token operator">*</span> ptr<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		cout <span class="token operator">&lt;&lt;</span> <span class="token string">"fclose:"</span> <span class="token operator">&lt;&lt;</span> ptr <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
		<span class="token function">fclose</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <blockquote>
     <p>
      下面我们再来实现一下shared_ptr：
     </p>
    </blockquote>
    <pre><code class="prism language-cpp"><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword">class</span> <span class="token class-name">shared_ptr</span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
	<span class="token keyword">explicit</span> <span class="token function">shared_ptr</span><span class="token punctuation">(</span>T<span class="token operator">*</span> ptr<span class="token punctuation">)</span>
		<span class="token operator">:</span><span class="token function">_ptr</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span>
		<span class="token punctuation">,</span><span class="token function">_pcount</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

	<span class="token function">shared_ptr</span><span class="token punctuation">(</span><span class="token keyword">const</span> shared_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token operator">&amp;</span> sp<span class="token punctuation">)</span>
		<span class="token operator">:</span><span class="token function">_ptr</span><span class="token punctuation">(</span>sp<span class="token punctuation">.</span>_ptr<span class="token punctuation">)</span>
		<span class="token punctuation">,</span><span class="token function">_pcount</span><span class="token punctuation">(</span>sp<span class="token punctuation">.</span>_pcount<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token operator">++</span><span class="token punctuation">(</span><span class="token operator">*</span>_pcount<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	shared_ptr<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> shared_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token operator">&amp;</span> sp<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>_ptr <span class="token operator">!=</span> sp<span class="token punctuation">.</span>_ptr<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token comment">//当需要析构时，再进行析构</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">--</span><span class="token punctuation">(</span><span class="token operator">*</span>_pcount<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token keyword">delete</span> _ptr<span class="token punctuation">;</span>
				<span class="token keyword">delete</span> _pcount<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			_ptr <span class="token operator">=</span> sp<span class="token punctuation">.</span>_ptr<span class="token punctuation">;</span>
			_pcount <span class="token operator">=</span> sp<span class="token punctuation">.</span>_pcount<span class="token punctuation">;</span>
			<span class="token operator">++</span><span class="token punctuation">(</span><span class="token operator">*</span>_pcount<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">return</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	T<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token operator">*</span>_ptr<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	T<span class="token operator">*</span> <span class="token keyword">operator</span><span class="token operator">-&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> _ptr<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token operator">~</span><span class="token function">shared_ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>_ptr <span class="token operator">&amp;&amp;</span> _pcount <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">delete</span> _ptr<span class="token punctuation">;</span>
			<span class="token keyword">delete</span> _pcount<span class="token punctuation">;</span>
			cout <span class="token operator">&lt;&lt;</span> <span class="token string">"~shared_ptr"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
	T<span class="token operator">*</span> _ptr<span class="token punctuation">;</span>
	<span class="token keyword">int</span><span class="token operator">*</span> _pcount<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     带删除器的shared_ptr的实现：
    </p>
    <blockquote>
     <p>
      对于删除器需要修改的点在于：
      <br/>
      1.默认构造需要通过传入的删除器进行初始化
      <br/>
      2.如果没有传入删除器，那么应该使用什么进行删除
      <br/>
      3.析构函数里需要使用到删除器
     </p>
    </blockquote>
    <pre><code class="prism language-cpp"><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword">class</span> <span class="token class-name">shared_ptr</span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
	<span class="token keyword">explicit</span> <span class="token function">shared_ptr</span><span class="token punctuation">(</span>T<span class="token operator">*</span> ptr<span class="token punctuation">)</span>
		<span class="token operator">:</span><span class="token function">_ptr</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span>
		<span class="token punctuation">,</span><span class="token function">_pcount</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

	<span class="token comment">//删除器需要一个类型，那么我们就使用函数模板</span>
	<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">D</span><span class="token operator">&gt;</span>
	<span class="token function">shared_ptr</span><span class="token punctuation">(</span>T<span class="token operator">*</span> ptr<span class="token punctuation">,</span> D del<span class="token punctuation">)</span>
		<span class="token operator">:</span><span class="token function">_ptr</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span>
		<span class="token punctuation">,</span><span class="token function">_pcount</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">,</span><span class="token function">_del</span><span class="token punctuation">(</span>del<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

	<span class="token function">shared_ptr</span><span class="token punctuation">(</span><span class="token keyword">const</span> shared_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token operator">&amp;</span> sp<span class="token punctuation">)</span>
		<span class="token operator">:</span><span class="token function">_ptr</span><span class="token punctuation">(</span>sp<span class="token punctuation">.</span>_ptr<span class="token punctuation">)</span>
		<span class="token punctuation">,</span><span class="token function">_pcount</span><span class="token punctuation">(</span>sp<span class="token punctuation">.</span>_pcount<span class="token punctuation">)</span>
		<span class="token punctuation">,</span><span class="token function">_del</span><span class="token punctuation">(</span>sp<span class="token punctuation">.</span>_del<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token operator">++</span><span class="token punctuation">(</span><span class="token operator">*</span>_pcount<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">void</span> <span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span><span class="token operator">*</span><span class="token punctuation">(</span>_pcount<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">_del</span><span class="token punctuation">(</span>_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">delete</span> _pcount<span class="token punctuation">;</span>
			_ptr <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
			_pcount <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	shared_ptr<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> shared_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token operator">&amp;</span> sp<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>_ptr <span class="token operator">!=</span> sp<span class="token punctuation">.</span>_ptr<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			_ptr <span class="token operator">=</span> sp<span class="token punctuation">.</span>_ptr<span class="token punctuation">;</span>
			_pcount <span class="token operator">=</span> sp<span class="token punctuation">.</span>_pcount<span class="token punctuation">;</span>
			<span class="token operator">++</span><span class="token punctuation">(</span><span class="token operator">*</span>_pcount<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">return</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	T<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token operator">*</span>_ptr<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	T<span class="token operator">*</span> <span class="token keyword">operator</span><span class="token operator">-&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> _ptr<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token operator">~</span><span class="token function">shared_ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
	T<span class="token operator">*</span> _ptr<span class="token punctuation">;</span>
	<span class="token keyword">int</span><span class="token operator">*</span> _pcount<span class="token punctuation">;</span>

	function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span>T<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> _del <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>T<span class="token operator">*</span> ptr<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token keyword">delete</span> ptr<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <h3>
     <a id="34_570">
     </a>
     3.4标准库中的智能指针问题
    </h3>
    <h4>
     <a id="341operator_boolshared_ptr__unique_ptr_571">
     </a>
     3.4.1operator bool（shared_ptr &amp;&amp; unique_ptr）
    </h4>
    <p>
     C++标准库中支持直接使用if(ptr1)的方式来判断ptr是否为空，也就是是否指向了一块有效的空间，其实应该的使用方法为：ptr1.operator bool()，但是简化为可以直接使用了
    </p>
    <h4>
     <a id="342make_sharedshared_ptr_573">
     </a>
     3.4.2make_shared（shared_ptr）
    </h4>
    <p>
     我们可以使用shared_ptr sp2 = make_shared(2024, 9, 11);来直接构造一个智能指针，效果和shared_ptr sp1(new Date(2024, 9, 11));是相同的
    </p>
    <h4>
     <a id="343use_cout_575">
     </a>
     3.4.3use_cout
    </h4>
    <p>
     支持ptr1.use_cout()来获取ptr中有多少个指针指向这块资源
    </p>
    <h2>
     <a id="4weak_ptr_577">
     </a>
     4.weak_ptr
    </h2>
    <h3>
     <a id="41shared_ptr_578">
     </a>
     4.1shared_ptr的循环引用问题
    </h3>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/5ebf72d582d847358e81eb4320365731.png"/>
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">struct</span> <span class="token class-name">ListNode</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> _data<span class="token punctuation">;</span>
	std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>ListNode<span class="token operator">&gt;</span> _next<span class="token punctuation">;</span>
	std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>ListNode<span class="token operator">&gt;</span> _prev<span class="token punctuation">;</span>

	<span class="token operator">~</span><span class="token function">ListNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		cout <span class="token operator">&lt;&lt;</span> <span class="token string">"~ListNode()"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	shared_ptr<span class="token operator">&lt;</span>ListNode<span class="token operator">&gt;</span> <span class="token function">ptr1</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">ListNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	shared_ptr<span class="token operator">&lt;</span>ListNode<span class="token operator">&gt;</span> <span class="token function">ptr2</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">ListNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	cout <span class="token operator">&lt;&lt;</span> ptr1<span class="token punctuation">.</span><span class="token function">use_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span><span class="token comment">//1</span>
	cout <span class="token operator">&lt;&lt;</span> ptr2<span class="token punctuation">.</span><span class="token function">use_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span><span class="token comment">//1</span>

	ptr1<span class="token operator">-&gt;</span>_next <span class="token operator">=</span> ptr2<span class="token punctuation">;</span>
	ptr2<span class="token operator">-&gt;</span>_prev <span class="token operator">=</span> ptr1<span class="token punctuation">;</span>

	cout <span class="token operator">&lt;&lt;</span> ptr1<span class="token punctuation">.</span><span class="token function">use_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span><span class="token comment">//2</span>
	cout <span class="token operator">&lt;&lt;</span> ptr2<span class="token punctuation">.</span><span class="token function">use_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span><span class="token comment">//2</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="42weak_ptr_610">
     </a>
     4.2weak_ptr
    </h3>
    <p>
     使用weak_ptr可以解决循环引用的问题：
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">struct</span> <span class="token class-name">ListNode</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> _data<span class="token punctuation">;</span>
	std<span class="token double-colon punctuation">::</span>weak_ptr<span class="token operator">&lt;</span>ListNode<span class="token operator">&gt;</span> _next<span class="token punctuation">;</span>
	std<span class="token double-colon punctuation">::</span>weak_ptr<span class="token operator">&lt;</span>ListNode<span class="token operator">&gt;</span> _prev<span class="token punctuation">;</span>

	<span class="token operator">~</span><span class="token function">ListNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		cout <span class="token operator">&lt;&lt;</span> <span class="token string">"~ListNode()"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	shared_ptr<span class="token operator">&lt;</span>ListNode<span class="token operator">&gt;</span> <span class="token function">ptr1</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">ListNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	shared_ptr<span class="token operator">&lt;</span>ListNode<span class="token operator">&gt;</span> <span class="token function">ptr2</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">ListNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	cout <span class="token operator">&lt;&lt;</span> ptr1<span class="token punctuation">.</span><span class="token function">use_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span><span class="token comment">//1</span>
	cout <span class="token operator">&lt;&lt;</span> ptr2<span class="token punctuation">.</span><span class="token function">use_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span><span class="token comment">//1</span>

	ptr1<span class="token operator">-&gt;</span>_next <span class="token operator">=</span> ptr2<span class="token punctuation">;</span>
	ptr2<span class="token operator">-&gt;</span>_prev <span class="token operator">=</span> ptr1<span class="token punctuation">;</span>

	cout <span class="token operator">&lt;&lt;</span> ptr1<span class="token punctuation">.</span><span class="token function">use_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span><span class="token comment">//1</span>
	cout <span class="token operator">&lt;&lt;</span> ptr2<span class="token punctuation">.</span><span class="token function">use_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span><span class="token comment">//1</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     weak_ptr的解决原理为：weak_ptr初始化的指针能够指向shared_ptr指向的那一块空间，而且不增加shared_ptr的引用计数，也就是说，此时shared_ptr的next和prev指针的使用不会增加引用计数了，所以就可以顺利进行析构了
    </p>
    <h4>
     <a id="421weak_ptr_643">
     </a>
     4.2.1weak_ptr的使用
    </h4>
    <p>
     weak_ptr并没有重载operator* 和 operator-&gt;，所以它并不能够进行资源的访问，但是它支持调用lock返回一个管理资源的shared_ptr，如果资源已经释放，那么shared_ptr返回空对象，否则就可以正常进行资源的访问：
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token function">sp1</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">string</span><span class="token punctuation">(</span><span class="token string">"111111"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token function">sp2</span><span class="token punctuation">(</span>sp1<span class="token punctuation">)</span><span class="token punctuation">;</span>
	std<span class="token double-colon punctuation">::</span>weak_ptr<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> wp <span class="token operator">=</span> sp1<span class="token punctuation">;</span>

	<span class="token comment">//1.expired可以检查资源是否过期，过期返回1，否则返回0</span>
	cout <span class="token operator">&lt;&lt;</span> wp<span class="token punctuation">.</span><span class="token function">expired</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span><span class="token comment">//0</span>
	cout <span class="token operator">&lt;&lt;</span> wp<span class="token punctuation">.</span><span class="token function">use_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span><span class="token comment">//2，wp的指向不增加引用计数</span>

	<span class="token comment">//2.使用lock函数可以进行资源的访问</span>
	<span class="token comment">//std::shared_ptr&lt;string&gt; sp3 = wp.lock();</span>
	<span class="token keyword">auto</span> sp3 <span class="token operator">=</span> wp<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	cout <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>sp3 <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span><span class="token comment">//111111</span>
	cout <span class="token operator">&lt;&lt;</span> wp<span class="token punctuation">.</span><span class="token function">use_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span><span class="token comment">//3，新增了一个指向</span>
	<span class="token operator">*</span>sp3 <span class="token operator">+=</span> <span class="token string">"###"</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     weak_ptr的实现：
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword">class</span> <span class="token class-name">weak_ptr</span>

<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
	<span class="token function">weak_ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

	<span class="token function">weak_ptr</span><span class="token punctuation">(</span><span class="token keyword">const</span> shared_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token operator">&amp;</span> sp<span class="token punctuation">)</span>
		<span class="token operator">:</span><span class="token function">_ptr</span><span class="token punctuation">(</span>sp<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//get函数可以获取sp指向的那一块空间的地址</span>
	<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

	weak_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> shared_ptr<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token operator">&amp;</span> sp<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		_ptr <span class="token operator">=</span> sp<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
	T<span class="token operator">*</span> _ptr <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <h2>
     <a id="5shared_ptr_692">
     </a>
     5.shared_ptr的线程安全问题
    </h2>
    <p>
     这个在后面会讲到，后面再说
    </p>
    <h2>
     <a id="6C11boost_694">
     </a>
     6.C++11和boost中智能指针的关系
    </h2>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/9a2fa6a70e614214b0b3206dd4f27fd0.png"/>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f:672e6373646e2e6e65742f323330315f37393736313833342f:61727469636c652f64657461696c732f313436303236323638" class_="artid" style="display:none">
 </p>
</div>


