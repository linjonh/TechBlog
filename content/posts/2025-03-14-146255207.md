---
layout: post
title: "CEFSqlServer性能优化笔记"
date: 2025-03-14 14:41:44 +0800
description: "数据库和服务器降配之后，系统开始了各种超时，查询超时，保存超时，本身系统逻辑也很复杂，开发了五六年了，各种shi代码，慢sql，以下是一些经验的记录，便于以后忘了可以看看，也希望能帮到你！"
keywords: "C#+EF+SqlServer性能优化笔记"
categories: ['未分类']
tags: ['性能优化', 'Sqlserver', 'C']
artid: "146255207"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146255207
    alt: "CEFSqlServer性能优化笔记"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146255207
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146255207
cover: https://bing.ee123.net/img/rand?artid=146255207
image: https://bing.ee123.net/img/rand?artid=146255207
img: https://bing.ee123.net/img/rand?artid=146255207
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     C#+EF+SqlServer性能优化笔记
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-kimbie-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <p>
    </p>
    <hr/>
    <h2>
     <a id="_8">
     </a>
     前言
    </h2>
    <p>
     数据库和服务器降配之后，系统开始了各种超时，查询超时，保存超时，本身系统逻辑也很复杂，开发了五六年了，各种shi代码，慢sql，以下是一些经验的记录，便于以后忘了可以看看，也希望能帮到你！
    </p>
    <hr/>
    <h2>
     <a id="CEF__16">
     </a>
     一、C#EF 代码优化
    </h2>
    <h3>
     <a id="1_17">
     </a>
     1.接口代码改异步
    </h3>
    <blockquote>
     <p>
      代码（示例）：
     </p>
    </blockquote>
    <pre><code class="prism language-csharp"><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ResponseType</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name"><span class="token keyword">object</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><span class="token punctuation">,</span> <span class="token class-name">Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"api/OpenApi/AddDataApi"</span><span class="token punctuation">)</span></span><span class="token punctuation">,</span> <span class="token class-name">HttpPost</span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>IHttpActionResult<span class="token punctuation">&gt;</span></span> <span class="token function">AddDataApi</span><span class="token punctuation">(</span><span class="token class-name">RuqestModel</span> model<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>model <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token function">BadRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token class-name"><span class="token keyword">var</span></span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">AddDataAsync</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//增加await，调用异步方法</span>
	
	<span class="token keyword">return</span> <span class="token function">OK</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">&gt;</span></span> <span class="token function">AddDataAsync</span><span class="token punctuation">(</span><span class="token class-name">DbContext</span> db<span class="token punctuation">,</span> <span class="token class-name">Tables</span> model<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">long</span></span> currentId<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    db<span class="token punctuation">.</span>Tables<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">await</span> db<span class="token punctuation">.</span><span class="token function">SaveChangesAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//增加await，调用异步保存方法</span>
	<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
    <h3>
     <a id="2_40">
     </a>
     2.查询异步，只查询需要的数据
    </h3>
    <blockquote>
     <p>
      代码（示例）：
     </p>
    </blockquote>
    <pre><code class="prism language-csharp"><span class="token comment">//1、异步方法可以提示效率</span>
<span class="token comment">//2、通过select方法只查询Value字段，在大数据量的情况下，减少了传输的数据，可以提示效率</span>
<span class="token class-name"><span class="token keyword">var</span></span> Config <span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span>MdmConfigs<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>IsDeleted <span class="token operator">==</span> <span class="token boolean">false</span> <span class="token operator">&amp;&amp;</span> x<span class="token punctuation">.</span>Code <span class="token operator">==</span> <span class="token string">"Code1"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token punctuation">{<!-- --></span> x<span class="token punctuation">.</span>Value <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">FirstOrDefaultAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <h3>
     <a id="3_48">
     </a>
     3.查询数据判断时
    </h3>
    <blockquote>
     <p>
      代码（示例）：
     </p>
    </blockquote>
    <pre><code class="prism language-csharp"><span class="token comment">//1、判断数据是否存在时</span>
<span class="token class-name"><span class="token keyword">var</span></span> Config <span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span>MdmConfigs<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>IsDeleted <span class="token operator">==</span> <span class="token boolean">false</span> <span class="token operator">&amp;&amp;</span> x<span class="token punctuation">.</span>Code <span class="token operator">==</span> <span class="token string">"Code1"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">FirstOrDefaultAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span>Config <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token function">BadRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//可以优化为：</span>
<span class="token class-name"><span class="token keyword">var</span></span> IsExist<span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span>MdmConfigs<span class="token punctuation">.</span><span class="token function">AnyAsync</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>IsDeleted <span class="token operator">==</span> <span class="token boolean">false</span> <span class="token operator">&amp;&amp;</span> x<span class="token punctuation">.</span>Code <span class="token operator">==</span> <span class="token string">"Code1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>IsExist<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token function">BadRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="4sql_66">
     </a>
     4.直接使用sql查询
    </h3>
    <blockquote>
     <p>
      代码（示例）：
     </p>
    </blockquote>
    <pre><code class="prism language-csharp"><span class="token comment">//复杂查询可以直接使用sql查询，下面的sql是简写</span>
<span class="token class-name"><span class="token keyword">var</span></span> config <span class="token operator">=</span> db<span class="token punctuation">.</span>Database<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">SqlQuery</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>MdmConfig<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">"SELECT * FROM MdmConfig WHERE IsDeleted = 0 and Code = 'Code1'"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">FirstOrDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <h2>
     <a id="_72">
     </a>
     二、数据库优化
    </h2>
    <h3>
     <a id="1redis_73">
     </a>
     1.减少关联表，一些基础数据，字典表可以考虑放到redis中，在代码中映射
    </h3>
    <h3>
     <a id="2_74">
     </a>
     2.增加索引，删除无效索引，查看索引碎片率，重建索引
    </h3>
    <blockquote>
     <p>
      代码（示例）：
     </p>
    </blockquote>
    <pre><code class="prism language-sql">
<span class="token comment">--查看表索引详情</span>
<span class="token keyword">EXEC</span> sp_helpindex <span class="token string">'YourSchema.YourTableName'</span><span class="token punctuation">;</span>

<span class="token comment">--查看数据库缺失索引</span>
<span class="token keyword">USE</span> DbName
GO
<span class="token keyword">SELECT</span> 
    mid<span class="token punctuation">.</span>statement <span class="token keyword">AS</span> TableName<span class="token punctuation">,</span>
    mid<span class="token punctuation">.</span>equality_columns <span class="token keyword">AS</span> EqualityColumns<span class="token punctuation">,</span>
    mid<span class="token punctuation">.</span>inequality_columns <span class="token keyword">AS</span> InequalityColumns<span class="token punctuation">,</span>
    mid<span class="token punctuation">.</span>included_columns <span class="token keyword">AS</span> IncludedColumns<span class="token punctuation">,</span>
    migs<span class="token punctuation">.</span>user_seeks <span class="token keyword">AS</span> UserSeeks<span class="token punctuation">,</span>
    migs<span class="token punctuation">.</span>user_scans <span class="token keyword">AS</span> UserScans<span class="token punctuation">,</span>
    migs<span class="token punctuation">.</span>avg_user_impact <span class="token keyword">AS</span> AvgUserImpact<span class="token punctuation">,</span>
    migs<span class="token punctuation">.</span>avg_total_user_cost <span class="token keyword">AS</span> AvgTotalUserCost<span class="token punctuation">,</span>
    <span class="token string">'CREATE INDEX IX_'</span> <span class="token operator">+</span> OBJECT_NAME<span class="token punctuation">(</span>mid<span class="token punctuation">.</span>OBJECT_ID<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'_'</span> <span class="token operator">+</span> CAST<span class="token punctuation">(</span>mid<span class="token punctuation">.</span>index_handle <span class="token keyword">AS</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> 
    <span class="token string">' ON '</span> <span class="token operator">+</span> mid<span class="token punctuation">.</span>statement <span class="token operator">+</span> 
    <span class="token string">' ('</span> <span class="token operator">+</span> ISNULL<span class="token punctuation">(</span>mid<span class="token punctuation">.</span>equality_columns<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token operator">+</span> 
    <span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> mid<span class="token punctuation">.</span>equality_columns <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token operator">AND</span> mid<span class="token punctuation">.</span>inequality_columns <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">THEN</span> <span class="token string">','</span> <span class="token keyword">ELSE</span> <span class="token string">''</span> <span class="token keyword">END</span> <span class="token operator">+</span> 
    ISNULL<span class="token punctuation">(</span>mid<span class="token punctuation">.</span>inequality_columns<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">')'</span> <span class="token operator">+</span> 
    ISNULL<span class="token punctuation">(</span><span class="token string">' INCLUDE ('</span> <span class="token operator">+</span> mid<span class="token punctuation">.</span>included_columns <span class="token operator">+</span> <span class="token string">')'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> CreateIndexStatement
<span class="token keyword">FROM</span> 
    sys<span class="token punctuation">.</span>dm_db_missing_index_details <span class="token keyword">AS</span> mid
<span class="token keyword">JOIN</span> 
    sys<span class="token punctuation">.</span>dm_db_missing_index_groups <span class="token keyword">AS</span> mig <span class="token keyword">ON</span> mid<span class="token punctuation">.</span>index_handle <span class="token operator">=</span> mig<span class="token punctuation">.</span>index_handle
<span class="token keyword">JOIN</span> 
    sys<span class="token punctuation">.</span>dm_db_missing_index_group_stats <span class="token keyword">AS</span> migs <span class="token keyword">ON</span> mig<span class="token punctuation">.</span>index_group_handle <span class="token operator">=</span> migs<span class="token punctuation">.</span>group_handle
<span class="token keyword">WHERE</span> 
  mid<span class="token punctuation">.</span> statement  <span class="token operator">LIKE</span> <span class="token string">'%DbName%'</span> <span class="token comment">-- 确保只针对当前数据库运行</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> 
    migs<span class="token punctuation">.</span>avg_user_impact <span class="token keyword">DESC</span><span class="token punctuation">;</span>
    

<span class="token comment">--查看数据库无效索引</span>
<span class="token keyword">SELECT</span>
	ind<span class="token punctuation">.</span>index_id<span class="token punctuation">,</span>
	obj<span class="token punctuation">.</span>name <span class="token keyword">AS</span> TableName<span class="token punctuation">,</span>
	ind<span class="token punctuation">.</span>name <span class="token keyword">AS</span> IndexName<span class="token punctuation">,</span>
	ind<span class="token punctuation">.</span>type_desc<span class="token punctuation">,</span>
	indUsage<span class="token punctuation">.</span>user_seeks<span class="token punctuation">,</span>
	indUsage<span class="token punctuation">.</span>user_scans<span class="token punctuation">,</span>
	indUsage<span class="token punctuation">.</span>user_lookups<span class="token punctuation">,</span>
	indUsage<span class="token punctuation">.</span>user_updates<span class="token punctuation">,</span>
	indUsage<span class="token punctuation">.</span>last_system_seek<span class="token punctuation">,</span>
	indUsage<span class="token punctuation">.</span>last_user_scan<span class="token punctuation">,</span>
	<span class="token string">'drop index ['</span> <span class="token operator">+</span> ind<span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">'] ON ['</span> <span class="token operator">+</span> obj<span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">']'</span> <span class="token keyword">AS</span> DropIndexCommand
<span class="token keyword">FROM</span>
	sys<span class="token punctuation">.</span>indexes <span class="token keyword">AS</span> ind
<span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> sys<span class="token punctuation">.</span>objects <span class="token keyword">AS</span> obj <span class="token keyword">ON</span> ind<span class="token punctuation">.</span>object_id <span class="token operator">=</span> obj<span class="token punctuation">.</span>object_id
<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> sys<span class="token punctuation">.</span>dm_db_index_usage_stats indUsage <span class="token keyword">ON</span> ind<span class="token punctuation">.</span>object_id <span class="token operator">=</span> indUsage<span class="token punctuation">.</span>object_id
<span class="token operator">AND</span> ind<span class="token punctuation">.</span>index_id <span class="token operator">=</span> indUsage<span class="token punctuation">.</span>index_id
<span class="token keyword">WHERE</span>
	ind<span class="token punctuation">.</span>type_desc <span class="token operator">&lt;&gt;</span> <span class="token string">'HEAP'</span>
<span class="token operator">AND</span> obj<span class="token punctuation">.</span><span class="token keyword">type</span> <span class="token operator">&lt;&gt;</span> <span class="token string">'S'</span>
<span class="token operator">AND</span> OBJECTPROPERTY<span class="token punctuation">(</span>
	obj<span class="token punctuation">.</span>object_id<span class="token punctuation">,</span>
	<span class="token string">'isusertable'</span>
<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span>
<span class="token operator">AND</span> <span class="token punctuation">(</span>
	ISNULL<span class="token punctuation">(</span>indUsage<span class="token punctuation">.</span>user_seeks<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span>
	<span class="token operator">AND</span> ISNULL<span class="token punctuation">(</span>indUsage<span class="token punctuation">.</span>user_scans<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span>
	<span class="token operator">AND</span> ISNULL<span class="token punctuation">(</span>indUsage<span class="token punctuation">.</span>user_lookups<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span>
<span class="token punctuation">)</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span>
	obj<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
	ind<span class="token punctuation">.</span>name


<span class="token comment">------------查看索引碎片率并大于30%</span>
<span class="token keyword">SELECT</span> OBJECT_NAME<span class="token punctuation">(</span>ind<span class="token punctuation">.</span>OBJECT_ID<span class="token punctuation">)</span> <span class="token keyword">AS</span> TableName<span class="token punctuation">,</span>
    ind<span class="token punctuation">.</span>name <span class="token keyword">AS</span> IndexName<span class="token punctuation">,</span>
    indexstats<span class="token punctuation">.</span>index_type_desc <span class="token keyword">AS</span> IndexType<span class="token punctuation">,</span>
    indexstats<span class="token punctuation">.</span>avg_fragmentation_in_percent 
<span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>dm_db_index_physical_stats<span class="token punctuation">(</span>DB_ID<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">)</span> indexstats 
    <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> sys<span class="token punctuation">.</span>indexes ind <span class="token keyword">ON</span> ind<span class="token punctuation">.</span>object_id <span class="token operator">=</span> indexstats<span class="token punctuation">.</span>object_id <span class="token operator">AND</span> ind<span class="token punctuation">.</span>index_id <span class="token operator">=</span> indexstats<span class="token punctuation">.</span>index_id 
<span class="token keyword">WHERE</span> indexstats<span class="token punctuation">.</span>avg_fragmentation_in_percent <span class="token operator">&gt;</span><span class="token number">30</span> <span class="token comment">------------碎片率</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> indexstats<span class="token punctuation">.</span>avg_fragmentation_in_percent <span class="token keyword">DESC</span>


<span class="token comment">--重新组织索引（把第1步里的表名TableName复制进来，并调整阈值）</span>
<span class="token keyword">ALTER</span> <span class="token keyword">INDEX</span> <span class="token keyword">ALL</span> <span class="token keyword">ON</span> <span class="token punctuation">[</span>TableName<span class="token punctuation">]</span> 
REBUILD <span class="token keyword">WITH</span> <span class="token punctuation">(</span><span class="token keyword">FILLFACTOR</span> <span class="token operator">=</span> <span class="token number">90</span><span class="token punctuation">,</span> SORT_IN_TEMPDB <span class="token operator">=</span> <span class="token keyword">ON</span><span class="token punctuation">,</span>STATISTICS_NORECOMPUTE <span class="token operator">=</span> <span class="token keyword">ON</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token comment">--查看索引碎片率并大于30%并进行整理</span>
<span class="token keyword">DECLARE</span> <span class="token variable">@SQL</span> NVARCHAR<span class="token punctuation">(</span>MAX<span class="token punctuation">)</span> <span class="token operator">=</span> N<span class="token string">''</span><span class="token punctuation">;</span>

<span class="token keyword">SELECT</span> 
    <span class="token variable">@SQL</span> <span class="token operator">+</span><span class="token operator">=</span> <span class="token string">'ALTER INDEX ['</span> <span class="token operator">+</span> ind<span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">'] ON ['</span> <span class="token operator">+</span> OBJECT_NAME<span class="token punctuation">(</span>ind<span class="token punctuation">.</span>OBJECT_ID<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'] REBUILD WITH (ONLINE=ON, FILLFACTOR=90);'</span> <span class="token operator">+</span> <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">)</span>
<span class="token keyword">FROM</span> 
    sys<span class="token punctuation">.</span>dm_db_index_physical_stats<span class="token punctuation">(</span>DB_ID<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> indexstats
<span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> 
    sys<span class="token punctuation">.</span>indexes <span class="token keyword">AS</span> ind <span class="token keyword">ON</span> ind<span class="token punctuation">.</span>object_id <span class="token operator">=</span> indexstats<span class="token punctuation">.</span>object_id <span class="token operator">AND</span> ind<span class="token punctuation">.</span>index_id <span class="token operator">=</span> indexstats<span class="token punctuation">.</span>index_id
<span class="token keyword">WHERE</span> 
    indexstats<span class="token punctuation">.</span>avg_fragmentation_in_percent <span class="token operator">&gt;</span> <span class="token number">30</span>
    <span class="token operator">AND</span> ind<span class="token punctuation">.</span>name <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span>

<span class="token keyword">PRINT</span> <span class="token variable">@SQL</span><span class="token punctuation">;</span>
<span class="token comment">-- 如果需要执行，取消以下注释</span>
<span class="token comment">-- EXEC sp_executesql @SQL;</span>

</code></pre>
    <h3>
     <a id="3_180">
     </a>
     3.更深层可以参考这篇文章：
    </h3>
    <p>
     <a href="https://blog.csdn.net/EacthDel/article/details/146048604?fromshare=blogdetail&amp;sharetype=blogdetail&amp;sharerId=146048604&amp;sharerefer=PC&amp;sharesource=qq_45195669&amp;sharefrom=from_link">
      数据库优化 ——关于tempdb系统库影响IO和数据库性能的一些问题
     </a>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f34353139353636392f:61727469636c652f64657461696c732f313436323535323037" class_="artid" style="display:none">
 </p>
</div>


