---
layout: post
title: "SQLAlchemy系列教程如何执行原生SQL"
date: 2025-03-10 19:59:59 +0800
description: "本指南重点介绍了使用SQLAlchemy执行原始SQL的各种方法，从简单查询到复杂事务，甚至直接访问DB API功能。负责任地使用这些方法，始终将查询参数化以防止SQL注入，并记住尽可能利用SQLAlchemy健壮的ORM特性。"
keywords: "SQLAlchemy系列教程：如何执行原生SQL"
categories: ['Python']
tags: ['数据库', 'Sqlalchemy', 'Python']
artid: "146162626"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146162626
    alt: "SQLAlchemy系列教程如何执行原生SQL"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146162626
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146162626
cover: https://bing.ee123.net/img/rand?artid=146162626
image: https://bing.ee123.net/img/rand?artid=146162626
img: https://bing.ee123.net/img/rand?artid=146162626
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     SQLAlchemy系列教程：如何执行原生SQL
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <blockquote>
     <p>
      Python中的数据库交互提供了高级API。但是，有时您可能需要执行原始SQL以提高效率或利用数据库特定的特性。本指南介绍在SQLAlchemy框架内执行原始SQL。
     </p>
    </blockquote>
    <h3>
     <a id="SQLAlchemySQL_4">
     </a>
     在SQLAlchemy中执行原生SQL
    </h3>
    <p>
     SQLAlchemy虽然以其对象-关系映射（ORM）功能而闻名，但也允许直接执行原始SQL语句。当您有复杂的查询、需要优化性能或利用数据库引擎特有的特性时，这可能是有益的。执行原始SQL为您提供了这样做的能力和灵活性。
    </p>
    <p>
     要执行原始SQL，必须使用SQLAlchemy的Connection对象，该对象可以从Engine或Session上下文中获得。让我们通过渐进式示例探索在SQLAlchemy中执行原始SQL的一些常见模式。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/dbbfdb5c11584f81bacae1056e1499dc.png"/>
    </p>
    <h3>
     <a id="SQL_11">
     </a>
     执行简单SQL
    </h3>
    <p>
     要执行原始SQL，需要从引擎获得一个连接：
    </p>
    <pre><code class="prism language-python"><span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> create_engine
<span class="token comment"># Replace 'dialect+driver://username:password@host/dbname' with your actual database URI</span>
db_engine <span class="token operator">=</span> create_engine<span class="token punctuation">(</span><span class="token string">'dialect+driver://username:password@host/dbname'</span><span class="token punctuation">)</span>

<span class="token keyword">with</span> db_engine<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> connection<span class="token punctuation">:</span>
    result <span class="token operator">=</span> connection<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">"SELECT * FROM my_table"</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> row <span class="token keyword">in</span> result<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>row<span class="token punctuation">)</span>
</code></pre>
    <p>
     这将打印出‘ my_table ’表结果集中的每一行。
    </p>
    <h3>
     <a id="_28">
     </a>
     参数化查询
    </h3>
    <p>
     出于安全原因和防止SQL注入攻击，永远不要简单地将变量直接插入到SQL字符串中。相反，使用命名参数或位置占位符：
    </p>
    <pre><code class="prism language-python"><span class="token keyword">with</span> db_engine<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> connection<span class="token punctuation">:</span>
    result <span class="token operator">=</span> connection<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>
        <span class="token string">"SELECT * FROM users WHERE username = :username"</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token string">'username'</span><span class="token punctuation">:</span> <span class="token string">'example_user'</span><span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
    user <span class="token operator">=</span> result<span class="token punctuation">.</span>fetchone<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>
</code></pre>
    <p>
     在上面的示例中，“:username ”是一个占位符，可以被“ example_user ”安全地替换。
    </p>
    <h3>
     <a id="SQL_43">
     </a>
     使用文本SQL
    </h3>
    <p>
     SQLAlchemy的text函数可以用来创建带有占位符的SQL表达式：
    </p>
    <pre><code class="prism language-python"><span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>sql <span class="token keyword">import</span> text

sql <span class="token operator">=</span> text<span class="token punctuation">(</span><span class="token string">"SELECT * FROM users WHERE username = :username"</span><span class="token punctuation">)</span>

<span class="token keyword">with</span> db_engine<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> connection<span class="token punctuation">:</span>
    result <span class="token operator">=</span> connection<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>sql<span class="token punctuation">,</span> username<span class="token operator">=</span><span class="token string">'example_user'</span><span class="token punctuation">)</span>
    user <span class="token operator">=</span> result<span class="token punctuation">.</span>fetchone<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>
</code></pre>
    <p>
     这里，文本函数用命名参数包装SQL，提供灵活性和注入预防。
    </p>
    <h3>
     <a id="_60">
     </a>
     执行插入、更新、删除
    </h3>
    <p>
     INSERT、UPDATE、DELETE等修改操作也可以用类似的方式执行：
    </p>
    <pre><code class="prism language-python"><span class="token comment"># Inserting a new user</span>
insert_sql <span class="token operator">=</span> text<span class="token punctuation">(</span><span class="token string">"INSERT INTO users (username, email) VALUES (:username, :email)"</span><span class="token punctuation">)</span>

<span class="token keyword">with</span> db_engine<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> connection<span class="token punctuation">:</span>
    connection<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>insert_sql<span class="token punctuation">,</span> username<span class="token operator">=</span><span class="token string">'new_user'</span><span class="token punctuation">,</span> email<span class="token operator">=</span><span class="token string">'new_user@example.com'</span><span class="token punctuation">)</span>

<span class="token comment"># Updating a user's email</span>
update_sql <span class="token operator">=</span> text<span class="token punctuation">(</span><span class="token string">"UPDATE users SET email = :email WHERE username = :username"</span><span class="token punctuation">)</span>

<span class="token keyword">with</span> db_engine<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> connection<span class="token punctuation">:</span>
    connection<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>update_sql<span class="token punctuation">,</span> email<span class="token operator">=</span><span class="token string">'updated_user@example.com'</span><span class="token punctuation">,</span> username<span class="token operator">=</span><span class="token string">'existing_user'</span><span class="token punctuation">)</span>

<span class="token comment"># Deleting a user</span>
delete_sql <span class="token operator">=</span> text<span class="token punctuation">(</span><span class="token string">"DELETE FROM users WHERE username = :username"</span><span class="token punctuation">)</span>

<span class="token keyword">with</span> db_engine<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> connection<span class="token punctuation">:</span>
    connection<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>delete_sql<span class="token punctuation">,</span> username<span class="token operator">=</span><span class="token string">'obsolete_user'</span><span class="token punctuation">)</span>
</code></pre>
    <h3>
     <a id="_84">
     </a>
     处理事务
    </h3>
    <p>
     事务处理使用连接对象，在执行SQL语句之前首先开始一个事务。这确保了原子性：
    </p>
    <pre><code class="prism language-python"><span class="token keyword">with</span> db_engine<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> connection<span class="token punctuation">:</span>
    transaction <span class="token operator">=</span> connection<span class="token punctuation">.</span>begin<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        connection<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>insert_sql<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        connection<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>update_sql<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        transaction<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        transaction<span class="token punctuation">.</span>rollback<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">raise</span>
</code></pre>
    <p>
     这将插入和更新操作包装在一个事务中，该事务可以在失败时回滚。
    </p>
    <h3>
     <a id="_102">
     </a>
     执行存储过程
    </h3>
    <p>
     存储过程也可以通过原始SQL调用：
    </p>
    <pre><code class="prism language-python">call_procedure_sql <span class="token operator">=</span> text<span class="token punctuation">(</span><span class="token string">"CALL my_stored_procedure(:param)"</span><span class="token punctuation">)</span>

<span class="token keyword">with</span> db_engine<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> connection<span class="token punctuation">:</span>
    result <span class="token operator">=</span> connection<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>call_procedure_sql<span class="token punctuation">,</span> param<span class="token operator">=</span><span class="token string">'value'</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> row <span class="token keyword">in</span> result<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>row<span class="token punctuation">)</span>
</code></pre>
    <h3>
     <a id="SQLAlchemy_Core_115">
     </a>
     使用SQLAlchemy Core进行复杂查询
    </h3>
    <p>
     除了简单的文本语句，SQLAlchemy的核心语言还可以将文本SQL与Python逻辑相结合：
    </p>
    <pre><code class="prism language-python"><span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>sql <span class="token keyword">import</span> select<span class="token punctuation">,</span> table<span class="token punctuation">,</span> column

t_user <span class="token operator">=</span> table<span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">,</span> column<span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> column<span class="token punctuation">(</span><span class="token string">'email'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
stmt <span class="token operator">=</span> select<span class="token punctuation">(</span><span class="token punctuation">[</span>t_user<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>t_user<span class="token punctuation">.</span>c<span class="token punctuation">.</span>username <span class="token operator">==</span> <span class="token string">'example_user'</span><span class="token punctuation">)</span>

<span class="token keyword">with</span> db_engine<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> connection<span class="token punctuation">:</span>
    <span class="token keyword">for</span> row <span class="token keyword">in</span> connection<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>stmt<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>row<span class="token punctuation">)</span>
</code></pre>
    <p>
     这个示例演示了如何使用SQLAlchemy Core构造从用户名匹配“example_user”的“users”表中进行选择。
    </p>
    <h3>
     <a id="_132">
     </a>
     访问本地数据库功能
    </h3>
    <p>
     最后，使用SQLAlchemy，在需要特定于数据库功能的情况下，您可以将原始SQL直接传递给底层DBAPI连接：
    </p>
    <pre><code class="prism language-python"><span class="token keyword">with</span> db_engine<span class="token punctuation">.</span>raw_connection<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> raw_conn<span class="token punctuation">:</span>
    cursor <span class="token operator">=</span> raw_conn<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span>
    cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">"YOUR_VENDOR_SPECIFIC_SQL_HERE"</span><span class="token punctuation">)</span>
    results <span class="token operator">=</span> cursor<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> result <span class="token keyword">in</span> results<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
    cursor<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
    <h3>
     <a id="_146">
     </a>
     最后总结
    </h3>
    <p>
     本指南重点介绍了使用SQLAlchemy执行原始SQL的各种方法，从简单查询到复杂事务，甚至直接访问DB API功能。负责任地使用这些方法，始终将查询参数化以防止SQL注入，并记住尽可能利用SQLAlchemy健壮的ORM特性。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f:626c6f672e6373646e2e6e65742f6e65776561737473756e2f:61727469636c652f64657461696c732f313436313632363236" class_="artid" style="display:none">
 </p>
</div>


