---
layout: post
title: "Unity-Dots从入门到精通-Mono和Dots通讯"
date: 2025-03-09 22:52:49 +0800
description: "DOTS（面向数据的技术堆栈）是一套由 Unity 提供支持的技术，用于提供高性能游戏开发解决方案，特别适合需要处理大量数据的游戏，例如大型开放世界游戏。本文讲解我们的Mono代码部分，如何与Dots的System部分进行通讯。比如：交换数据，发送事件等。"
keywords: "Unity Dots从入门到精通 Mono和Dots通讯"
categories: ['Unity', 'Dots']
tags: ['Unity', 'Jobsystem', 'Entities', 'Ecs', 'Dynamicbuffer', 'Dots', 'Burst']
artid: "146140078"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146140078
    alt: "Unity-Dots从入门到精通-Mono和Dots通讯"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146140078
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146140078
cover: https://bing.ee123.net/img/rand?artid=146140078
image: https://bing.ee123.net/img/rand?artid=146140078
img: https://bing.ee123.net/img/rand?artid=146140078
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Unity Dots从入门到精通 Mono和Dots通讯
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="./../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="./../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <p>
    </p>
    <h3>
     <a id="_1">
     </a>
     前言
    </h3>
    <p>
     DOTS（面向数据的技术堆栈）是一套由 Unity 提供支持的技术，用于提供高性能游戏开发解决方案，特别适合需要处理大量数据的游戏，例如大型开放世界游戏。
     <br/>
     本文讲解我们的Mono代码部分，如何与Dots的System部分进行通讯。比如：交换数据，发送事件等。
    </p>
    <ul>
     <li>
      Unity 2022.3.52f1
     </li>
     <li>
      Entities 1.3.10
     </li>
    </ul>
    <h3>
     <a id="_DOTS__7">
     </a>
     安装 DOTS 包
    </h3>
    <p>
     要安装 DOTS 包，请按照以下步骤操作：
    </p>
    <p>
     （1）从菜单“窗口 → 包管理器”打开包管理器。
     <br/>
     （2）搜索“ Entities” 并安装 Entities和Entities Graphics。
     <br/>
     （3）搜索“ Universal RP” 并安装 Universal RP，并设置Graphics/Scriptable Render Pipeline Settings。
    </p>
    <p>
     这会添加“实体”作为依赖项，并递归添加它所依赖的关联包（ Burst、Collections、Jobs、Mathematics等）。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/2a076017e0c04b73a80fd45c8a7931c5.png"/>
    </p>
    <h3>
     <a id="Mono_To_Dots_17">
     </a>
     Mono To Dots
    </h3>
    <p>
     如何从Mono发送控制指令，比如创建士兵的命令到Dots中，让Dots创建指定的实体呢？
     <br/>
     我们需要使用到DynamicBuffer，一个Dots中的消息Buffer队列，我们在Mono中可以通过World.EntityManager，获取这个共享的消息队列，并往里面添加消息数据，Dots只需要在System下接受数据并解析即可。
    </p>
    <pre><code class="prism language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GameManager</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">MonoBehaviour</span></span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">GameManager</span> Instance <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token class-name">EntityManager</span> _entityManager<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Entity</span> _commandEntity<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        Instance <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        _entityManager <span class="token operator">=</span> World<span class="token punctuation">.</span>DefaultGameObjectInjectionWorld<span class="token punctuation">.</span>EntityManager<span class="token punctuation">;</span>
        <span class="token comment">//创建一个专门用于存储游戏命令的"信箱实体"，相当于在 ECS 世界中创建了一个命令接收站</span>
        _commandEntity <span class="token operator">=</span> _entityManager<span class="token punctuation">.</span><span class="token function">CreateEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 为该实体附加一个可动态增长的缓冲区，用于存储多个 GameCommand 命令</span>
        _entityManager<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddBuffer</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>GameCommand<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>_commandEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Input<span class="token punctuation">.</span><span class="token function">GetKeyDown</span><span class="token punctuation">(</span>KeyCode<span class="token punctuation">.</span>Alpha1<span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token function">AddSpawnCommand</span><span class="token punctuation">(</span>Faction<span class="token punctuation">.</span>Red<span class="token punctuation">,</span> SolderType<span class="token punctuation">.</span>Melee<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">AddSpawnCommand</span><span class="token punctuation">(</span><span class="token class-name">Faction</span> faction<span class="token punctuation">,</span> <span class="token class-name">SolderType</span> solder<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> num <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">DynamicBuffer<span class="token punctuation">&lt;</span>GameCommand<span class="token punctuation">&gt;</span></span> buffer <span class="token operator">=</span> _entityManager<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetBuffer</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>GameCommand<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>_commandEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 解析网络数据为命令（示例）</span>
        <span class="token class-name"><span class="token keyword">var</span></span> command <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">GameCommand</span>
        <span class="token punctuation">{<!-- --></span>
            CMD <span class="token operator">=</span> CommandType<span class="token punctuation">.</span>SpawnUnit<span class="token punctuation">,</span>
            Faction <span class="token operator">=</span> faction<span class="token punctuation">,</span>
            Solder <span class="token operator">=</span> solder<span class="token punctuation">,</span>
            Number <span class="token operator">=</span> num
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        buffer<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
    <pre><code class="prism language-csharp"><span class="token comment">//UnitSpanerSystem系统类</span>
<span class="token keyword">public</span> <span class="token keyword">partial</span> <span class="token keyword">struct</span> <span class="token class-name">UnitSpawnerSystem</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ISystem</span></span>
<span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">BurstCompile</span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnCreate</span><span class="token punctuation">(</span><span class="token keyword">ref</span> <span class="token class-name">SystemState</span> state<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        state<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">RequireForUpdate</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>EndSimulationEntityCommandBufferSystem<span class="token punctuation">.</span>Singleton<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        state<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">RequireForUpdate</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>EntitiesReferences<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">BurstCompile</span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnUpdate</span><span class="token punctuation">(</span><span class="token keyword">ref</span> <span class="token class-name">SystemState</span> state<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token class-name"><span class="token keyword">var</span></span> ecbSingleton <span class="token operator">=</span> SystemAPI<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetSingleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>EndSimulationEntityCommandBufferSystem<span class="token punctuation">.</span>Singleton<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> ecb <span class="token operator">=</span> ecbSingleton<span class="token punctuation">.</span><span class="token function">CreateCommandBuffer</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>WorldUnmanaged<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AsParallelWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> entitiesReferences <span class="token operator">=</span> SystemAPI<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetSingleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>EntitiesReferences<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> job <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">UnitSpawnerJob</span>
        <span class="token punctuation">{<!-- --></span>
            EntitiesReferences <span class="token operator">=</span> entitiesReferences<span class="token punctuation">,</span>
            ECB <span class="token operator">=</span> ecb
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token class-name"><span class="token keyword">var</span></span> jobHandle <span class="token operator">=</span> job<span class="token punctuation">.</span><span class="token function">ScheduleParallel</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>Dependency<span class="token punctuation">)</span><span class="token punctuation">;</span>
        jobHandle<span class="token punctuation">.</span><span class="token function">Complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//UnitSpawnerJob类，用来实现多线程执行任务</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">BurstCompile</span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">partial</span> <span class="token keyword">struct</span> <span class="token class-name">UnitSpawnerJob</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IJobEntity</span></span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token class-name">EntityCommandBuffer<span class="token punctuation">.</span>ParallelWriter</span> ECB<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">EntitiesReferences</span> EntitiesReferences<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">EntityIndexInQuery</span></span><span class="token punctuation">]</span> <span class="token class-name"><span class="token keyword">int</span></span> index<span class="token punctuation">,</span> <span class="token keyword">ref</span> <span class="token class-name">DynamicBuffer<span class="token punctuation">&lt;</span>GameCommand<span class="token punctuation">&gt;</span></span> buffer<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
    	<span class="token comment">//buffer中会接收到来自Mono端的消息</span>
        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name">GameCommand</span> cmd <span class="token keyword">in</span> buffer<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">ProcessCommand</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        buffer<span class="token punctuation">.</span><span class="token function">Clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token comment">//解析命令</span>
    <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ProcessCommand</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> index<span class="token punctuation">,</span> <span class="token class-name">GameCommand</span> cmd<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>cmd<span class="token punctuation">.</span>CMD<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">case</span> CommandType<span class="token punctuation">.</span>SpawnUnit<span class="token punctuation">:</span>
                <span class="token class-name"><span class="token keyword">var</span></span> prefabEntity <span class="token operator">=</span> <span class="token function">GetPrefab</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">float3</span> startPosition <span class="token operator">=</span> <span class="token function">GetBornPos</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">float3</span> targetPosition <span class="token operator">=</span> <span class="token function">GetTargetPos</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token class-name">Entity</span> zombieEntity <span class="token operator">=</span> ECB<span class="token punctuation">.</span><span class="token function">Instantiate</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> prefabEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
                ECB<span class="token punctuation">.</span><span class="token function">SetComponent</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> zombieEntity<span class="token punctuation">,</span> LocalTransform<span class="token punctuation">.</span><span class="token function">FromPosition</span><span class="token punctuation">(</span>startPosition<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                ECB<span class="token punctuation">.</span><span class="token function">SetComponent</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> zombieEntity<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">UnitMover</span>
                <span class="token punctuation">{<!-- --></span>
                    moveSpeed <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>
                    rotationSpeed <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>
                    targetPosition <span class="token operator">=</span> targetPosition
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> CommandType<span class="token punctuation">.</span>DestroyUnit<span class="token punctuation">:</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> CommandType<span class="token punctuation">.</span>ChangeTeam<span class="token punctuation">:</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token punctuation">:</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentOutOfRangeException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="Dots_To_Mono_135">
     </a>
     Dots To Mono
    </h3>
    <p>
     从Dots把消息发送给Mono层，比如我们的Dots系统中，有士兵死亡，或者游戏的成功/失败，我们需要通知Mono层的主UI更新界面显示等。我们需要用到从Dots往Mono层发送事件。
    </p>
    <p>
     新建一个数据结构，用来从Dots往Mono发送的消息结构体
    </p>
    <pre><code class="prism language-csharp"><span class="token keyword">public</span> <span class="token keyword">struct</span> <span class="token class-name">RcvData</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token class-name">Faction</span> faction<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">int</span></span> type<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">float</span></span> <span class="token keyword">value</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">RcvData</span><span class="token punctuation">(</span><span class="token class-name">Faction</span> faction<span class="token punctuation">,</span><span class="token class-name"><span class="token keyword">int</span></span> type<span class="token punctuation">,</span><span class="token class-name"><span class="token keyword">float</span></span> <span class="token keyword">value</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>faction <span class="token operator">=</span> faction<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> type<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token keyword">value</span> <span class="token operator">=</span> <span class="token keyword">value</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     新建一个全局的共性数据队列静态类Facade
     <br/>
     它主要维护了一个NativeQueue 的共享队列
    </p>
    <pre><code class="prism language-csharp"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Facade</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">NativeQueue<span class="token punctuation">&lt;</span>RcvData<span class="token punctuation">&gt;</span></span> SharedQueue <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">(</span>Allocator<span class="token punctuation">.</span>Persistent<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>SharedQueue<span class="token punctuation">.</span>IsCreated<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            SharedQueue<span class="token punctuation">.</span><span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     比如我们的阵营有一个血量，血量 变化会通知Mono端的UGUI更新界面
    </p>
    <pre><code class="prism language-csharp"><span class="token keyword">public</span> <span class="token keyword">partial</span> <span class="token keyword">struct</span> <span class="token class-name">HealthSystem</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ISystem</span></span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token class-name">NativeQueue<span class="token punctuation">&lt;</span>RcvData<span class="token punctuation">&gt;</span><span class="token punctuation">.</span>ParallelWriter</span> _writer<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">EntityCommandBuffer<span class="token punctuation">.</span>ParallelWriter</span> _ecb<span class="token punctuation">;</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">BurstCompile</span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnCreate</span><span class="token punctuation">(</span><span class="token keyword">ref</span> <span class="token class-name">SystemState</span> state<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        state<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">RequireForUpdate</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>EndSimulationEntityCommandBufferSystem<span class="token punctuation">.</span>Singleton<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        _writer <span class="token operator">=</span> Facade<span class="token punctuation">.</span>SharedQueue<span class="token punctuation">.</span><span class="token function">AsParallelWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">BurstCompile</span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnUpdate</span><span class="token punctuation">(</span><span class="token keyword">ref</span> <span class="token class-name">SystemState</span> state<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        _ecb <span class="token operator">=</span> SystemAPI<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetSingleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>EndSimulationEntityCommandBufferSystem<span class="token punctuation">.</span>Singleton<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">CreateCommandBuffer</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>WorldUnmanaged<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AsParallelWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> job <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">HealthJob</span>
        <span class="token punctuation">{<!-- --></span>
            Writer <span class="token operator">=</span> _writer<span class="token punctuation">,</span>
            ECB <span class="token operator">=</span> _ecb<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> jobHandle <span class="token operator">=</span> job<span class="token punctuation">.</span><span class="token function">ScheduleParallel</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>Dependency<span class="token punctuation">)</span><span class="token punctuation">;</span>
        jobHandle<span class="token punctuation">.</span><span class="token function">Complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 确保Job执行完成</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">BurstCompile</span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">partial</span> <span class="token keyword">struct</span> <span class="token class-name">HealthJob</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IJobEntity</span></span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token class-name">NativeQueue<span class="token punctuation">&lt;</span>RcvData<span class="token punctuation">&gt;</span><span class="token punctuation">.</span>ParallelWriter</span> Writer<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">EntityCommandBuffer<span class="token punctuation">.</span>ParallelWriter</span> ECB<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">EntityIndexInQuery</span></span><span class="token punctuation">]</span> <span class="token class-name"><span class="token keyword">int</span></span> index<span class="token punctuation">,</span><span class="token keyword">ref</span> <span class="token class-name">Health</span> health<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token class-name"><span class="token keyword">float</span></span> healthNormalized <span class="token operator">=</span> health<span class="token punctuation">.</span>healthAmount <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>health<span class="token punctuation">.</span>healthAmountMax<span class="token punctuation">;</span>
        <span class="token comment">//发送数据到UI层</span>
        Writer<span class="token punctuation">.</span><span class="token function">Enqueue</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">RcvData</span><span class="token punctuation">(</span>health<span class="token punctuation">.</span>faction<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> healthNormalized<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     Mono端，我们如何接受这个数据呢？
    </p>
    <pre><code class="prism language-csharp">	<span class="token comment">//Update 检测Dots事件</span>
	<span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">QueryDotsEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">QueryDotsEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>Facade<span class="token punctuation">.</span>SharedQueue<span class="token punctuation">.</span><span class="token function">TryDequeue</span><span class="token punctuation">(</span><span class="token keyword">out</span> <span class="token class-name">RcvData</span> <span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 主线程安全读取</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token keyword">value</span><span class="token punctuation">.</span>type<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">case</span> <span class="token number">1</span><span class="token punctuation">:</span>
                    UIManager<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span><span class="token function">SetHP</span><span class="token punctuation">(</span><span class="token keyword">value</span><span class="token punctuation">.</span>faction<span class="token punctuation">,</span> <span class="token keyword">value</span><span class="token punctuation">.</span><span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> <span class="token number">2</span><span class="token punctuation">:</span>
                    Money <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token keyword">value</span><span class="token punctuation">.</span><span class="token keyword">value</span><span class="token punctuation">;</span>
                    UIManager<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span><span class="token function">SetMoney</span><span class="token punctuation">(</span><span class="token keyword">value</span><span class="token punctuation">.</span>faction<span class="token punctuation">,</span> Money<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
	<span class="token comment">//销毁时，注意释放共享队列</span>
    <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        Facade<span class="token punctuation">.</span><span class="token function">Cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
    <p>
     好了，这样我们就实现了Mono和Dots的双向数据通讯
     <br/>
     应该还有别的更好的方法，欢迎大家的留言交流
    </p>
   </div>
   <link href="./../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="./../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
  <div class="blog-extension-box" id="blogExtensionBox" style="width:400px;margin:auto;margin-top:12px">
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71713536333132393538322f:61727469636c652f64657461696c732f313436313430303738" class_="artid" style="display:none">
 </p>
</div>


