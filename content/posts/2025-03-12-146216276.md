---
layout: post
title: "SpringBoot-自动配置原理"
date: 2025-03-12 23:19:37 +0800
description: "定义自己的 Bean：Spring Boot 优先使用用户定义的 Bean（会失效）。@Bean// 自定义 DataSource，覆盖自动配置创建自动配置类:@Bean注册配置类到 META-INF/xxx.imports在主启动类上添加了SpringBootApplication注解，这个注解组合了EnableAutoConfiguration注解。"
keywords: "SpringBoot 自动配置原理"
categories: ['未分类']
tags: ['Spring', 'Spring', 'Java', 'Boot']
artid: "146216276"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146216276
    alt: "SpringBoot-自动配置原理"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146216276
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146216276
cover: https://bing.ee123.net/img/rand?artid=146216276
image: https://bing.ee123.net/img/rand?artid=146216276
img: https://bing.ee123.net/img/rand?artid=146216276
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     SpringBoot 自动配置原理
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <p>
     自动配置是Spring Boot的关键特性之一，它简化了传统Spring应用繁琐的配置，通过智能推断和条件化配置简化了Spring应用的开发。
    </p>
    <p>
    </p>
    <h2>
     1. 自动配置的核心思想
    </h2>
    <p>
     <strong>
      目标
     </strong>
     ：根据项目的依赖（如类路径中的 JAR 包）和已有的配置，自动创建和配置 Spring Bean，避免手动编写 XML 或 Java 配置。
    </p>
    <p>
     <strong>
      关键特点
     </strong>
     ：
    </p>
    <ul>
     <li>
      <p>
       <strong>
        条件化配置（@Conditional）
       </strong>
       ：根据条件（如类是否存在、Bean 是否缺失等）决定是否启用配置。
      </p>
     </li>
     <li>
      <p>
       <strong>
        默认优先
       </strong>
       ：提供合理的默认值，同时允许开发者覆盖配置。
      </p>
     </li>
     <li>
      <p>
       <strong>
        模块化
       </strong>
       ：通过
       <code>
        starter
       </code>
       依赖按需引入配置。
      </p>
     </li>
    </ul>
    <p>
    </p>
    <h2>
     2. 自动配置的核心原理
    </h2>
    <p>
     <span style="color:#fe2c24">
      <strong>
       （1）核心注解：@SpringBootApplication
      </strong>
     </span>
    </p>
    <ul>
     <li>
      <strong>
       @SpringBootApplication
      </strong>
      注解组合了
      <strong>
       @Configuation（标记为配置类）、@ComponentScan（包扫描）、@EnableAutoConfiguration（启用自动配置）
      </strong>
      。
     </li>
     <li>
      作用：启用自动配置，扫描 META-INF/spring.factories文件，加载其中定义的自动配置类。
     </li>
     <li>
      关键点：@EnableAutoConfiguration 是激活自动配置的入口。
     </li>
    </ul>
    <p>
     <span style="color:#fe2c24">
      <strong>
       （2）自动配置类注册：xxx.imports
      </strong>
     </span>
    </p>
    <ul>
     <li>
      <strong>
       <span style="color:#0d0016">
        文件路径：
       </span>
      </strong>
      <span style="color:#0d0016">
       <strong>
        META-INF/xxx.imports
       </strong>
       （位于
       <strong>
        spring-boot-autoconfigure
       </strong>
       JAR包）
      </span>
     </li>
     <li>
      <img alt="" height="426" src="https://i-blog.csdnimg.cn/direct/61ae4d814c834ca093c748e2432968d9.png" width="707"/>
     </li>
     <li>
      <strong>
       内容：
      </strong>
      键为
      <strong>
       org.springframework.boot.autoconfigure.EnableAutoConfiguration ，
      </strong>
      值为多个自动配置类的全限定名。
     </li>
     <li>
      <strong>
       示例：
      </strong>
      <pre><code class="hljs">org.springframework.boot.autoconfigure.EnableAutoConfiguration=\
  org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration,\
  org.springframework.boot.autoconfigure.web.servlet.WebMvcAutoConfiguration</code></pre>
     </li>
    </ul>
    <p>
     <strong>
      <span style="color:#fe2c24">
       （3）条件注解（Conditional Annotations）
      </span>
     </strong>
    </p>
    <p>
     <span style="color:#0d0016">
      SpringBoot使用条件注解控制配置类的生效条件：
     </span>
    </p>
    <ul>
     <li>
      <strong>
       @ConditionalOnClass
      </strong>
      ：类路径中存在指定类时生效
     </li>
     <li>
      <strong>
       @ConditionalOnMissingBean
      </strong>
      ：容器中不存在指定 Bean 时生效
     </li>
     <li>
      <strong>
       @ConditionalOnProperty
      </strong>
      ：配置文件中存在指定属性时生效
     </li>
     <li>
      <strong>
       @ConditionalOnWebApplication
      </strong>
      ：当前应用是Web应用时生效
     </li>
    </ul>
    <p>
     <strong>
      示例(
      <code>
       DataSourceAutoConfiguration
      </code>
      ）：
     </strong>
    </p>
    <pre><code class="language-java">@Configuration
@ConditionalOnClass({ DataSource.class, EmbeddedDatabaseType.class })
@EnableConfigurationProperties(DataSourceProperties.class)
public class DataSourceAutoConfiguration {
    // 当容器中没有 DataSource Bean 时，自动配置嵌入式数据库
    @Bean
    @ConditionalOnMissingBean
    public DataSource dataSource() {
        // 创建默认的 DataSource（如 H2、HikariCP）
    }
}</code></pre>
    <p>
     <span style="color:#fe2c24">
      <strong>
       （4）配置属性绑定：@EnableConfigurationProperties
      </strong>
     </span>
    </p>
    <ul>
     <li>
      通过
      <strong>
       application.properties
      </strong>
      或
      <strong>
       application.yml
      </strong>
      文件中的属性动态配置Bean。
     </li>
    </ul>
    <p>
    </p>
    <h2>
     3. 自动配置的执行流程
    </h2>
    <ol>
     <li>
      <p>
       <strong>
        启动应用
       </strong>
       ：调用
       <strong>
        <code>
         SpringApplication.run()，初始化应用上下文。
        </code>
       </strong>
      </p>
     </li>
     <li>
      <p>
       <strong>
        加载自动配置类
       </strong>
       ：
      </p>
      <ul>
       <li>
        <p>
         扫描所有
         <strong>
          <code>
           META-INF/xxx.imports
          </code>
         </strong>
         文件，获取
         <strong>
          <code>
           EnableAutoConfiguration
          </code>
         </strong>
         对应的配置类列表。
        </p>
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        过滤配置类
       </strong>
       ：
      </p>
      <ul>
       <li>
        <p>
         根据条件注解（如
         <strong>
          <code>
           @ConditionalOnClass
          </code>
         </strong>
         ）排除不满足条件的配置类。（如缺少依赖，Bean已存在等）。
        </p>
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        应用配置（注册Bean）
       </strong>
       ：
      </p>
      <ul>
       <li>
        <p>
         将符合条件的配置类加载到Spring容器，创建所需的Bean。
        </p>
       </li>
      </ul>
     </li>
    </ol>
    <p>
    </p>
    <h2>
     4. 自动配置示例：Web MVC
    </h2>
    <p>
     当引入
     <code>
      spring-boot-starter-web
     </code>
     依赖时：
    </p>
    <ol>
     <li>
      <p>
       <strong>
        依赖触发
       </strong>
       ：类路径中存在
       <code>
        Servlet
       </code>
       、
       <code>
        Spring MVC
       </code>
       相关类。
      </p>
     </li>
     <li>
      <p>
       <strong>
        自动配置生效
       </strong>
       ：
      </p>
      <ul>
       <li>
        <p>
         <code>
          WebMvcAutoConfiguration
         </code>
         自动配置
         <code>
          DispatcherServlet
         </code>
         、视图解析器等。
        </p>
       </li>
       <li>
        <p>
         默认静态资源路径（
         <code>
          /static
         </code>
         ,
         <code>
          /public
         </code>
         ）生效。
        </p>
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        自定义覆盖
       </strong>
       ：
      </p>
      <ul>
       <li>
        <p>
         开发者可通过
         <code>
          @Bean
         </code>
         自定义
         <code>
          ViewResolver
         </code>
         覆盖默认配置。
        </p>
       </li>
      </ul>
     </li>
    </ol>
    <p>
    </p>
    <h2>
     5.自定义自动配置
    </h2>
    <ol>
     <li>
      <strong>
       覆盖默认配置：
      </strong>
      <ol>
       <li>
        <p>
         定义自己的 Bean：Spring Boot 优先使用用户定义的 Bean（
         <code>
          @ConditionalOnMissingBean
         </code>
         会失效）。
        </p>
        <pre><code class="language-java">@Bean
public DataSource myDataSource() {
    // 自定义 DataSource，覆盖自动配置
}</code></pre>
       </li>
      </ol>
     </li>
     <li>
      <strong>
       创建自定义starter：
      </strong>
      <ol>
       <li>
        创建自动配置类:
        <pre><code class="language-java">@Configuration
@ConditionalOnClass(MyService.class)
public class MyServiceAutoConfiguration {
    @Bean
    public MyService myService() {
        return new MyService();
    }
}</code></pre>
       </li>
       <li>
        注册配置类到
        <strong>
         <code>
          META-INF/xxx.imports
         </code>
        </strong>
        ：
        <pre><code class="language-java">org.springframework.boot.autoconfigure.EnableAutoConfiguration=com.example.MyServiceAutoConfiguration</code></pre>
       </li>
      </ol>
     </li>
    </ol>
    <p>
    </p>
    <h2>
     总结：SpringBoot自动配置原理
    </h2>
    <ul>
     <li>
      <span style="color:#fe2c24">
       <strong>
        在主启动类上添加了SpringBootApplication注解，这个注解组合了EnableAutoConfiguration注解
       </strong>
      </span>
     </li>
     <li>
      <span style="color:#fe2c24">
       <strong>
        EnableAutoConfiguration注解又组合了Import注解，导入了AutoConfigurationImportSelector类
       </strong>
      </span>
     </li>
     <li>
      <span style="color:#fe2c24">
       <strong>
        实现selectImports方法，这个方法经过层层调用，最终会读取META-INF目录下的后缀名为imports的文件，boot 2.7以前的版本读取的是spring.factories文件
       </strong>
      </span>
     </li>
     <li>
      <span style="color:#fe2c24">
       <strong>
        读取到全类名之后，会解析注册条件，也就是@Conditional及其衍生注解，把满足注册条件的Bean对象自动注入到IOC容器中
       </strong>
      </span>
     </li>
    </ul>
   </div>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f:672e6373646e2e6e65742f323330315f37373032313931332f:61727469636c652f64657461696c732f313436323136323736" class_="artid" style="display:none">
 </p>
</div>


