---
layout: post
title: "Android-FFMPEG-开发FFMPEG-初始化-网络初始化-打开音视频-查找音视频流-"
date: 2024-07-02 14:43:33 +0800
description: "【Android FFMPEG 开发】FFMPEG 初始化 ( 网络初始化 | 打开音视频 | 查找"
keywords: "ffmpeg avopen network"
categories: ['开发', 'Ffmpeg', 'Android']
tags: ['Open', 'Network', 'Find', 'Ffmpeg']
artid: "104636151"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=104636151
    alt: "Android-FFMPEG-开发FFMPEG-初始化-网络初始化-打开音视频-查找音视频流-"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=104636151
featuredImagePreview: https://bing.ee123.net/img/rand?artid=104636151
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     【Android FFMPEG 开发】FFMPEG 初始化 ( 网络初始化 | 打开音视频 | 查找音视频流 )
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="./../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="./../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-tomorrow-night-eighties" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <div class="toc">
     <h4>
      文章目录
     </h4>
     <ul>
      <li>
       <ul>
        <li>
         <ul>
          <li>
           <ul>
            <li>
             <a href="#I__FFMPEG__13" rel="nofollow">
              I . FFMPEG 初始化流程
             </a>
            </li>
            <li>
             <a href="#II__FFMPEG__avformat_network_init_58" rel="nofollow">
              II . FFMPEG 网络初始化 avformat_network_init()
             </a>
            </li>
            <li>
             <a href="#III__FFMPEG__avformat_open_input_111" rel="nofollow">
              III . FFMPEG 打开媒体地址 avformat_open_input()
             </a>
            </li>
            <li>
             <a href="#IV__FFMPEG____avformat_find_stream_info_189" rel="nofollow">
              IV . FFMPEG 获取音 / 视频流信息 avformat_find_stream_info()
             </a>
            </li>
            <li>
             <a href="#V__FFMPEG__261" rel="nofollow">
              V . FFMPEG 初始化部分代码示例
             </a>
            </li>
           </ul>
          </li>
         </ul>
        </li>
       </ul>
      </li>
     </ul>
    </div>
    <p>
    </p>
    <br/>
    <br/>
    <h5>
     <a id="I__FFMPEG__13">
     </a>
     I . FFMPEG 初始化流程
    </h5>
    <hr/>
    <br/>
    <p>
     <strong>
      FFMPEG 初始化流程 :
     </strong>
     <font color="blue">
      FFMPEG 执行任何操作前 , 都需要初始化一些环境 , 及相关数据参数 ;
     </font>
    </p>
    <br/>
    <p>
     <strong>
      ① 网络初始化 :
     </strong>
     <font color="red">
      <strong>
       avformat_network_init()
      </strong>
     </font>
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">avformat_network_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <br/>
    <p>
     <strong>
      ② 打开媒体 ( 音视频 ) 地址 :
     </strong>
     <font color="red">
      <strong>
       avformat_open_input()
      </strong>
     </font>
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">avformat_open_input</span><span class="token punctuation">(</span>AVFormatContext <span class="token operator">*</span><span class="token operator">*</span>ps<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>url<span class="token punctuation">,</span> AVInputFormat <span class="token operator">*</span>fmt<span class="token punctuation">,</span> AVDictionary <span class="token operator">*</span><span class="token operator">*</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <br/>
    <p>
     <strong>
      ③ 查找 ( 音 / 视频 ) 流 :
     </strong>
     <font color="red">
      <strong>
       avformat_find_stream_info()
      </strong>
     </font>
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">avformat_find_stream_info</span><span class="token punctuation">(</span>AVFormatContext <span class="token operator">*</span>ic<span class="token punctuation">,</span> AVDictionary <span class="token operator">*</span><span class="token operator">*</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <br/>
    <p>
     <strong>
      ④ 正式操作 :
     </strong>
     <font color="purple">
      对上述查找到的 音 / 视频 流进行操作 ;
     </font>
    </p>
    <br/>
    <br/>
    <h5>
     <a id="II__FFMPEG__avformat_network_init_58">
     </a>
     II . FFMPEG 网络初始化 avformat_network_init()
    </h5>
    <hr/>
    <br/>
    <p>
     <strong>
      调用 avformat_network_init() 函数进行网络初始化
     </strong>
    </p>
    <br/>
    <p>
     <strong>
      1 . avformat_network_init() 函数作用 :
     </strong>
     <font color="blue">
      初始化网络 , 默认状态下 , FFMPEG 是不允许联网的 , 必须调用该函数 , 初始化网络后 FFMPEG 才能进行联网 ;
     </font>
    </p>
    <br/>
    <p>
     <strong>
      2 . avformat_network_init() 函数原型 :
     </strong>
    </p>
    <pre><code class="prism language-cpp"><span class="token comment">/**
 * Do global initialization of network libraries. This is optional,
 * and not recommended anymore.
 *
 * This functions only exists to work around thread-safety issues
 * with older GnuTLS or OpenSSL libraries. If libavformat is linked
 * to newer versions of those libraries, or if you do not use them,
 * calling this function is unnecessary. Otherwise, you need to call
 * this function before any other threads using them are started.
 *
 * This function will be deprecated once support for older GnuTLS and
 * OpenSSL libraries is removed, and this function has no purpose
 * anymore.
 */</span>
<span class="token keyword">int</span> <span class="token function">avformat_network_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <br/>
    <p>
     <strong>
      3 . 使用示例 :
     </strong>
    </p>
    <pre><code class="prism language-cpp">    <span class="token comment">/*
     * 初始化网络 :
     *      默认状态下 , FFMPEG 是不允许联网的
     *      必须调用该函数 , 初始化网络后 FFMPEG 才能进行联网
     */</span>
    <span class="token function">avformat_network_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <br/>
    <br/>
    <h5>
     <a id="III__FFMPEG__avformat_open_input_111">
     </a>
     III . FFMPEG 打开媒体地址 avformat_open_input()
    </h5>
    <hr/>
    <br/>
    <p>
     <strong>
      调用 avformat_open_input() 函数打开音视频地址 ( 文件地址 / 网络地址 )
     </strong>
    </p>
    <br/>
    <p>
     <strong>
      1 . avformat_open_input() 函数作用 :
     </strong>
     <font color="blue">
      播放一个音视频多媒体文件之前 , 首先要打开该文件 ; 文件的地址类型可以是文件路径地址 , 也可以是网络地址 ;
     </font>
    </p>
    <br/>
    <p>
     <strong>
      2 . avformat_open_input() 函数原型 :
     </strong>
    </p>
    <br/>
    <p>
     <strong>
      ① AVFormatContext **ps 参数 :
     </strong>
     <font color="red">
      封装了文件格式相关信息的结构体 , 如视频宽高 , 音频采样率等信息 ; 该参数是 二级指针 , 意味着在方法中会修改该指针的指向 , 该参数的实际作用是当做返回值用的 ;
     </font>
    </p>
    <p>
     <strong>
      ② const char *url 参数 :
     </strong>
     <font color="green">
      视频资源地址, 文件地址 / 网络链接 ;
     </font>
    </p>
    <p>
     <strong>
      ③ int 返回值 :
     </strong>
     <font color="purple">
      返回 0 , 代表打开成功 , 否则失败 ; 失败的情况列举 , 文件路径错误 , 网络错误 ;
     </font>
    </p>
    <pre><code class="prism language-cpp"><span class="token comment">/**
 * Open an input stream and read the header. The codecs are not opened.
 * The stream must be closed with avformat_close_input().
 *
 * @param ps Pointer to user-supplied AVFormatContext (allocated by avformat_alloc_context).
 *           May be a pointer to NULL, in which case an AVFormatContext is allocated by this
 *           function and written into ps.
 *           Note that a user-supplied AVFormatContext will be freed on failure.
 * @param url URL of the stream to open.
 * @param fmt If non-NULL, this parameter forces a specific input format.
 *            Otherwise the format is autodetected.
 * @param options  A dictionary filled with AVFormatContext and demuxer-private options.
 *                 On return this parameter will be destroyed and replaced with a dict containing
 *                 options that were not found. May be NULL.
 *
 * @return 0 on success, a negative AVERROR on failure.
 *
 * @note If you want to use custom IO, preallocate the format context and set its pb field.
 */</span>
<span class="token keyword">int</span> <span class="token function">avformat_open_input</span><span class="token punctuation">(</span>AVFormatContext <span class="token operator">*</span><span class="token operator">*</span>ps<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>url<span class="token punctuation">,</span> AVInputFormat <span class="token operator">*</span>fmt<span class="token punctuation">,</span> AVDictionary <span class="token operator">*</span><span class="token operator">*</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <br/>
    <p>
     <strong>
      3 . 使用示例 :
     </strong>
    </p>
    <pre><code class="prism language-cpp">    <span class="token comment">//1 . 打开音视频地址 ( 播放文件前 , 需要先将文件打开 )</span>
    <span class="token comment">//      地址类型 : ① 文件类型 , ② 音视频流</span>
    <span class="token comment">//  参数解析 :</span>
    <span class="token comment">//      AVFormatContext **ps :  封装了文件格式相关信息的结构体 , 如视频宽高 , 音频采样率等信息 ;</span>
    <span class="token comment">//                              该参数是 二级指针 , 意味着在方法中会修改该指针的指向 ,</span>
    <span class="token comment">//                              该参数的实际作用是当做返回值用的</span>
    <span class="token comment">//      const char *url :   视频资源地址, 文件地址 / 网络链接</span>
    <span class="token comment">//  返回值说明 : 返回 0 , 代表打开成功 , 否则失败</span>
    <span class="token comment">//              失败的情况 : 文件路径错误 , 网络错误</span>
    <span class="token comment">//int avformat_open_input(AVFormatContext **ps, const char *url,</span>
    <span class="token comment">//                          AVInputFormat *fmt, AVDictionary **options);</span>
    formatContext <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> open_result <span class="token operator">=</span> <span class="token function">avformat_open_input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>formatContext<span class="token punctuation">,</span> dataSource<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//如果返回值不是 0 , 说明打开视频文件失败 , 需要将错误信息在 Java 层进行提示</span>
    <span class="token comment">//  这里将错误码返回到 Java 层显示即可</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>open_result <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">__android_log_print</span><span class="token punctuation">(</span>ANDROID_LOG_ERROR <span class="token punctuation">,</span> <span class="token string">"FFMPEG"</span> <span class="token punctuation">,</span> <span class="token string">"打开媒体失败 : %s"</span><span class="token punctuation">,</span> <span class="token function">av_err2str</span><span class="token punctuation">(</span>open_result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        callHelper<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">onError</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
    <br/>
    <br/>
    <h5>
     <a id="IV__FFMPEG____avformat_find_stream_info_189">
     </a>
     IV . FFMPEG 获取音 / 视频流信息 avformat_find_stream_info()
    </h5>
    <hr/>
    <br/>
    <p>
     <strong>
      调用 avformat_find_stream_info() 函数获取音视频流信息
     </strong>
    </p>
    <br/>
    <p>
     <strong>
      1 . avformat_find_stream_info() 函数作用 :
     </strong>
     <font color="blue">
      打开音视频文件成功后 , 从该地址中获取对应的音视频流 , 获取的流赋值给了 AVFormatContext* 结构体的 nb_streams 成员 ;
     </font>
    </p>
    <br/>
    <p>
     <strong>
      2 . avformat_find_stream_info() 函数原型 :
     </strong>
    </p>
    <br/>
    <p>
     <strong>
      ① AVFormatContext **ps 参数 :
     </strong>
     <font color="red">
      封装了文件格式相关信息的结构体 , 如视频宽高 , 音频采样率等信息 ; 该参数是 二级指针 , 意味着在方法中会修改该指针的指向 , 该参数的实际作用是当做返回值用的 ;
     </font>
    </p>
    <p>
     <font color="magenta">
      <strong>
       调用该方法后 , AVFormatContext 结构体的 nb_streams 元素就有值了 ;
      </strong>
     </font>
    </p>
    <p>
     <strong>
      ③ int 返回值 :
     </strong>
     <font color="green">
      返回值 &gt;= 0 , 代表打开成功 , 否则失败 ;
     </font>
    </p>
    <pre><code class="prism language-cpp"><span class="token comment">/**
 * Read packets of a media file to get stream information. This
 * is useful for file formats with no headers such as MPEG. This
 * function also computes the real framerate in case of MPEG-2 repeat
 * frame mode.
 * The logical file position is not changed by this function;
 * examined packets may be buffered for later processing.
 *
 * @param ic media file handle
 * @param options  If non-NULL, an ic.nb_streams long array of pointers to
 *                 dictionaries, where i-th member contains options for
 *                 codec corresponding to i-th stream.
 *                 On return each dictionary will be filled with options that were not found.
 * @return &gt;=0 if OK, AVERROR_xxx on error
 *
 * @note this function isn't guaranteed to open all the codecs, so
 *       options being non-empty at return is a perfectly normal behavior.
 *
 * @todo Let the user decide somehow what information is needed so that
 *       we do not waste time getting stuff the user does not need.
 */</span>
<span class="token keyword">int</span> <span class="token function">avformat_find_stream_info</span><span class="token punctuation">(</span>AVFormatContext <span class="token operator">*</span>ic<span class="token punctuation">,</span> AVDictionary <span class="token operator">*</span><span class="token operator">*</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <br/>
    <p>
     <strong>
      3 . 使用示例 :
     </strong>
    </p>
    <pre><code class="prism language-cpp">    <span class="token comment">//2 . 查找媒体 地址 对应的音视频流 ( 给 AVFormatContext* 成员赋值 )</span>
    <span class="token comment">//      方法原型 : int avformat_find_stream_info(AVFormatContext *ic, AVDictionary **options);</span>
    <span class="token comment">//      调用该方法后 , AVFormatContext 结构体的 nb_streams 元素就有值了 ,</span>
    <span class="token comment">//      该值代表了音视频流 AVStream 个数</span>
    <span class="token keyword">int</span> find_result <span class="token operator">=</span> <span class="token function">avformat_find_stream_info</span><span class="token punctuation">(</span>formatContext<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//如果返回值 &lt; 0 , 说明查找音视频流失败 , 需要将错误信息在 Java 层进行提示</span>
    <span class="token comment">//  这里将错误码返回到 Java 层显示即可</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>find_result <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">__android_log_print</span><span class="token punctuation">(</span>ANDROID_LOG_ERROR <span class="token punctuation">,</span> <span class="token string">"FFMPEG"</span> <span class="token punctuation">,</span> <span class="token string">"查找媒体流失败 : %s"</span><span class="token punctuation">,</span> <span class="token function">av_err2str</span><span class="token punctuation">(</span>find_result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        callHelper<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">onError</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
    <br/>
    <br/>
    <h5>
     <a id="V__FFMPEG__261">
     </a>
     V . FFMPEG 初始化部分代码示例
    </h5>
    <hr/>
    <br/>
    <pre><code class="prism language-cpp">    <span class="token comment">/*
     * 初始化网络 :
     *      默认状态下 , FFMPEG 是不允许联网的
     *      必须调用该函数 , 初始化网络后 FFMPEG 才能进行联网
     */</span>
    <span class="token function">avformat_network_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">//0 . 注册组件</span>
    <span class="token comment">//      如果是 4.x 之前的版本需要执行该步骤</span>
    <span class="token comment">//      4.x 及之后的版本 , 就没有该步骤了</span>
    <span class="token comment">//av_register_all();</span>

    <span class="token comment">//1 . 打开音视频地址 ( 播放文件前 , 需要先将文件打开 )</span>
    <span class="token comment">//      地址类型 : ① 文件类型 , ② 音视频流</span>
    <span class="token comment">//  参数解析 :</span>
    <span class="token comment">//      AVFormatContext **ps :  封装了文件格式相关信息的结构体 , 如视频宽高 , 音频采样率等信息 ;</span>
    <span class="token comment">//                              该参数是 二级指针 , 意味着在方法中会修改该指针的指向 ,</span>
    <span class="token comment">//                              该参数的实际作用是当做返回值用的</span>
    <span class="token comment">//      const char *url :   视频资源地址, 文件地址 / 网络链接</span>
    <span class="token comment">//  返回值说明 : 返回 0 , 代表打开成功 , 否则失败</span>
    <span class="token comment">//              失败的情况 : 文件路径错误 , 网络错误</span>
    <span class="token comment">//int avformat_open_input(AVFormatContext **ps, const char *url,</span>
    <span class="token comment">//                          AVInputFormat *fmt, AVDictionary **options);</span>
    formatContext <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> open_result <span class="token operator">=</span> <span class="token function">avformat_open_input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>formatContext<span class="token punctuation">,</span> dataSource<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//如果返回值不是 0 , 说明打开视频文件失败 , 需要将错误信息在 Java 层进行提示</span>
    <span class="token comment">//  这里将错误码返回到 Java 层显示即可</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>open_result <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">__android_log_print</span><span class="token punctuation">(</span>ANDROID_LOG_ERROR <span class="token punctuation">,</span> <span class="token string">"FFMPEG"</span> <span class="token punctuation">,</span> <span class="token string">"打开媒体失败 : %s"</span><span class="token punctuation">,</span> <span class="token function">av_err2str</span><span class="token punctuation">(</span>open_result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        callHelper<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">onError</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>



    <span class="token comment">//2 . 查找媒体 地址 对应的音视频流 ( 给 AVFormatContext* 成员赋值 )</span>
    <span class="token comment">//      方法原型 : int avformat_find_stream_info(AVFormatContext *ic, AVDictionary **options);</span>
    <span class="token comment">//      调用该方法后 , AVFormatContext 结构体的 nb_streams 元素就有值了 ,</span>
    <span class="token comment">//      该值代表了音视频流 AVStream 个数</span>
    <span class="token keyword">int</span> find_result <span class="token operator">=</span> <span class="token function">avformat_find_stream_info</span><span class="token punctuation">(</span>formatContext<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//如果返回值 &lt; 0 , 说明查找音视频流失败 , 需要将错误信息在 Java 层进行提示</span>
    <span class="token comment">//  这里将错误码返回到 Java 层显示即可</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>find_result <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">__android_log_print</span><span class="token punctuation">(</span>ANDROID_LOG_ERROR <span class="token punctuation">,</span> <span class="token string">"FFMPEG"</span> <span class="token punctuation">,</span> <span class="token string">"查找媒体流失败 : %s"</span><span class="token punctuation">,</span> <span class="token function">av_err2str</span><span class="token punctuation">(</span>find_result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        callHelper<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">onError</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
   </div>
   <link href="./../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="./../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f:626c6f672e6373646e2e6e65742f68616e313230323031322f:61727469636c652f64657461696c732f313034363336313531" class_="artid" style="display:none">
 </p>
</div>


