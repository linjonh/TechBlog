---
layout: post
title: "阿里千问大模型Qwen2.5-VL-7B-Instruct部署"
date: 2025-03-11 19:50:56 +0800
description: "然后通过huggingface-cli下载模型，首先安装huggingface_hub。如果希望下载到指定的目录，可以往。"
keywords: "阿里千问大模型(Qwen2.5-VL-7B-Instruct)部署"
categories: ['未分类']
tags: ['缓存']
artid: "146186788"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146186788
    alt: "阿里千问大模型Qwen2.5-VL-7B-Instruct部署"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146186788
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146186788
cover: https://bing.ee123.net/img/rand?artid=146186788
image: https://bing.ee123.net/img/rand?artid=146186788
img: https://bing.ee123.net/img/rand?artid=146186788
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     阿里千问大模型(Qwen2.5-VL-7B-Instruct)部署
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="_0">
     </a>
     参考链接
    </h2>
    <p>
     <a href="https://zhuanlan.zhihu.com/p/23296553864" rel="nofollow">
      知乎帖子
     </a>
     <br/>
     <a href="https://www.bilibili.com/video/BV1BZF5e8E6z?vd_source=1f4ba5f54bc4487201631722421f40b5&amp;spm_id_from=333.788.player.switch" rel="nofollow">
      B站视频
     </a>
     <br/>
     <a href="https://aliendao.cn/models/Qwen/models/Qwen/models/Qwen/models/Qwen/models/Qwen/Qwen2.5-VL-7B-Instruct" rel="nofollow">
      huggingface 镜像网站（不太全，比如 Qwen/Qwen2.5-VL-7B-Instruct就没有）
     </a>
     <br/>
     <a href="https://zhuanlan.zhihu.com/p/663712983?s_r=0#:~:text=%E5%A6%82%E4%BD%95%E5%BF%AB%E9%80%9F%E4%B8%8B%E8%BD%BDhuggingface%E6%A8%A1%E5%9E%8B%E2%80%94%E2%80%94%E5%85%A8%E6%96%B9%E6%B3%95%E6%80%BB%E7%BB%93%201%201.%20%E6%B5%8F%E8%A7%88%E5%99%A8%E7%BD%91%E9%A1%B5%E4%B8%8B%E8%BD%BD%20%E6%A8%A1%E5%9E%8B%E9%A1%B9%E7%9B%AE%E9%A1%B5%E7%9A%84%20Files%20%E6%A0%8F%E4%B8%AD%E5%8F%AF%E4%BB%A5%E8%8E%B7%E5%8F%96%E6%96%87%E4%BB%B6%E7%9A%84%E4%B8%8B%E8%BD%BD%E9%93%BE%E6%8E%A5%E3%80%82%20%E6%97%A0%E9%9C%80%E7%99%BB%E5%BD%95,from_pretrained%20%E4%B8%8D%E8%BF%87%E5%A4%9A%E4%BB%8B%E7%BB%8D%E4%BA%86%E3%80%82%20...%207%207.%20hf_hub_download%20%E4%B8%8D%E8%BF%87%E5%A4%9A%E4%BB%8B%E7%BB%8D%E4%BA%86%E3%80%82%20" rel="nofollow">
      huggingface 5种下载方式汇总
     </a>
     <br/>
     <a href="https://zhuanlan.zhihu.com/p/21054168099" rel="nofollow">
      通过huggingface-cli下载模型
     </a>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/55f6bcf06e3e412db772f56115f2c0bb.png"/>
    </p>
    <h2>
     <a id="demo_9">
     </a>
     不一样的部分是预训练权重的下载和demo
    </h2>
    <p>
     首先安装huggingface_hub
    </p>
    <pre><code class="prism language-csharp">pip install <span class="token operator">-</span>U huggingface_hub
</code></pre>
    <p>
     设置镜像
    </p>
    <pre><code class="prism language-csharp"><span class="token class-name">export</span> HF_ENDPOINT<span class="token operator">=</span>https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>hf<span class="token operator">-</span>mirror<span class="token punctuation">.</span>com
</code></pre>
    <p>
     windows端需要添加系统变量。
    </p>
    <pre><code class="prism language-csharp">名称：HF_ENDPOINT，值： <span class="token string">"https://hf-mirror.com"</span>
</code></pre>
    <p>
     然后通过huggingface-cli下载模型，
    </p>
    <pre><code class="prism language-csharp">huggingface<span class="token operator">-</span>cli download <span class="token operator">--</span>resume<span class="token operator">-</span>download  Qwen<span class="token operator">/</span>Qwen2<span class="token punctuation">.</span><span class="token number">5</span><span class="token operator">-</span>VL<span class="token operator">-</span>7B<span class="token operator">-</span>Instruct <span class="token operator">--</span>local<span class="token operator">-</span>dir <span class="token punctuation">.</span><span class="token operator">/</span> <span class="token operator">--</span>local<span class="token operator">-</span>dir<span class="token operator">-</span>use<span class="token operator">-</span>symlinks False <span class="token operator">--</span>resume<span class="token operator">-</span>download
</code></pre>
    <p>
     参考：
     <a href="https://zhuanlan.zhihu.com/p/21054168099" rel="nofollow">
      通过huggingface-cli下载模型
     </a>
    </p>
    <h2>
     <a id="DEMO_35">
     </a>
     运行DEMO
    </h2>
    <h3>
     <a id="_36">
     </a>
     加载模型方式
    </h3>
    <p>
     如果希望下载到指定的目录，可以往
     <code>
      from_pretrained方法
     </code>
     传入
     <code>
      cache_dir
     </code>
     参数，如下所示：
    </p>
    <pre><code class="prism language-csharp">import torch
<span class="token keyword">from</span> transformers <span class="token class-name">import</span> AutoTokenizer<span class="token punctuation">,</span> <span class="token class-name">AutoModelForCausalLM</span>
model <span class="token operator">=</span> AutoModelForCausalLM<span class="token punctuation">.</span><span class="token function">from_pretrained</span><span class="token punctuation">(</span><span class="token string">"internlm/internlm2-chat-7b"</span><span class="token punctuation">,</span> torch_dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float16<span class="token punctuation">,</span> trust_remote_code<span class="token operator">=</span>True<span class="token punctuation">,</span> cache_dir<span class="token operator">=</span>'<span class="token operator">/</span>home<span class="token operator">/</span><span class="token punctuation">{<!-- --></span>username<span class="token punctuation">}</span><span class="token operator">/</span>huggingface'<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cuda</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
    <h3>
     <a id="_46">
     </a>
     运行以下代码
    </h3>
    <pre><code class="prism language-python"><span class="token keyword">import</span> gradio <span class="token keyword">as</span> gr
<span class="token keyword">from</span> transformers <span class="token keyword">import</span> Qwen2_5_VLForConditionalGeneration<span class="token punctuation">,</span> AutoProcessor
<span class="token keyword">from</span> qwen_vl_utils <span class="token keyword">import</span> process_vision_info
<span class="token keyword">import</span> torch

<span class="token comment"># 加载模型和处理器</span>
model <span class="token operator">=</span> Qwen2_5_VLForConditionalGeneration<span class="token punctuation">.</span>from_pretrained<span class="token punctuation">(</span>
    <span class="token string">"Qwen/Qwen2.5-VL-7B-Instruct"</span><span class="token punctuation">,</span> 
    torch_dtype<span class="token operator">=</span><span class="token string">"auto"</span><span class="token punctuation">,</span> 
    device_map<span class="token operator">=</span><span class="token string">"auto"</span>
<span class="token punctuation">)</span>
processor <span class="token operator">=</span> AutoProcessor<span class="token punctuation">.</span>from_pretrained<span class="token punctuation">(</span><span class="token string">"Qwen/Qwen2.5-VL-7B-Instruct"</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">process_image_and_text</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> text_prompt<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> image <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">"请上传一张图片。"</span>
    
    <span class="token comment"># 构建消息格式</span>
    messages <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span>
            <span class="token string">"content"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"image"</span><span class="token punctuation">,</span>
                    <span class="token string">"image"</span><span class="token punctuation">:</span> image<span class="token punctuation">,</span>  <span class="token comment"># Gradio将自动处理图片路径</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{<!-- --></span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span> <span class="token string">"text"</span><span class="token punctuation">:</span> text_prompt <span class="token keyword">if</span> text_prompt <span class="token keyword">else</span> <span class="token string">"Describe this image."</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
    
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token comment"># 准备推理输入</span>
        text <span class="token operator">=</span> processor<span class="token punctuation">.</span>apply_chat_template<span class="token punctuation">(</span>
            messages<span class="token punctuation">,</span> tokenize<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> add_generation_prompt<span class="token operator">=</span><span class="token boolean">True</span>
        <span class="token punctuation">)</span>
        image_inputs<span class="token punctuation">,</span> video_inputs <span class="token operator">=</span> process_vision_info<span class="token punctuation">(</span>messages<span class="token punctuation">)</span>
        inputs <span class="token operator">=</span> processor<span class="token punctuation">(</span>
            text<span class="token operator">=</span><span class="token punctuation">[</span>text<span class="token punctuation">]</span><span class="token punctuation">,</span>
            images<span class="token operator">=</span>image_inputs<span class="token punctuation">,</span>
            videos<span class="token operator">=</span>video_inputs<span class="token punctuation">,</span>
            padding<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
            return_tensors<span class="token operator">=</span><span class="token string">"pt"</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
        inputs <span class="token operator">=</span> inputs<span class="token punctuation">.</span>to<span class="token punctuation">(</span>model<span class="token punctuation">.</span>device<span class="token punctuation">)</span>

        <span class="token comment"># 生成输出</span>
        <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            generated_ids <span class="token operator">=</span> model<span class="token punctuation">.</span>generate<span class="token punctuation">(</span><span class="token operator">**</span>inputs<span class="token punctuation">,</span> max_new_tokens<span class="token operator">=</span><span class="token number">128</span><span class="token punctuation">)</span>
            generated_ids_trimmed <span class="token operator">=</span> <span class="token punctuation">[</span>
                out_ids<span class="token punctuation">[</span><span class="token builtin">len</span><span class="token punctuation">(</span>in_ids<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token keyword">for</span> in_ids<span class="token punctuation">,</span> out_ids <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>inputs<span class="token punctuation">.</span>input_ids<span class="token punctuation">,</span> generated_ids<span class="token punctuation">)</span>
            <span class="token punctuation">]</span>
            output_text <span class="token operator">=</span> processor<span class="token punctuation">.</span>batch_decode<span class="token punctuation">(</span>
                generated_ids_trimmed<span class="token punctuation">,</span> 
                skip_special_tokens<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> 
                clean_up_tokenization_spaces<span class="token operator">=</span><span class="token boolean">False</span>
            <span class="token punctuation">)</span>
        
        <span class="token keyword">return</span> output_text<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"处理过程中出现错误: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>

<span class="token comment"># 创建Gradio界面</span>
<span class="token keyword">with</span> gr<span class="token punctuation">.</span>Blocks<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> demo<span class="token punctuation">:</span>
    gr<span class="token punctuation">.</span>Markdown<span class="token punctuation">(</span><span class="token string">"# Qwen2.5-VL 图像理解演示"</span><span class="token punctuation">)</span>
    
    <span class="token keyword">with</span> gr<span class="token punctuation">.</span>Row<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">with</span> gr<span class="token punctuation">.</span>Column<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            image_input <span class="token operator">=</span> gr<span class="token punctuation">.</span>Image<span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">"filepath"</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"上传图片"</span><span class="token punctuation">)</span>
            text_input <span class="token operator">=</span> gr<span class="token punctuation">.</span>Textbox<span class="token punctuation">(</span>
                placeholder<span class="token operator">=</span><span class="token string">"请输入提示语（如不输入，默认描述图片）"</span><span class="token punctuation">,</span> 
                label<span class="token operator">=</span><span class="token string">"提示语"</span>
            <span class="token punctuation">)</span>
            submit_btn <span class="token operator">=</span> gr<span class="token punctuation">.</span>Button<span class="token punctuation">(</span><span class="token string">"提交"</span><span class="token punctuation">)</span>
        
        <span class="token keyword">with</span> gr<span class="token punctuation">.</span>Column<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            output <span class="token operator">=</span> gr<span class="token punctuation">.</span>Textbox<span class="token punctuation">(</span>label<span class="token operator">=</span><span class="token string">"输出结果"</span><span class="token punctuation">)</span>
    
    submit_btn<span class="token punctuation">.</span>click<span class="token punctuation">(</span>
        fn<span class="token operator">=</span>process_image_and_text<span class="token punctuation">,</span>
        inputs<span class="token operator">=</span><span class="token punctuation">[</span>image_input<span class="token punctuation">,</span> text_input<span class="token punctuation">]</span><span class="token punctuation">,</span>
        outputs<span class="token operator">=</span>output
    <span class="token punctuation">)</span>

    gr<span class="token punctuation">.</span>Examples<span class="token punctuation">(</span>
        examples<span class="token operator">=</span><span class="token punctuation">[</span>
            <span class="token punctuation">[</span><span class="token string">"path/to/example1.jpg"</span><span class="token punctuation">,</span> <span class="token string">"这张图片里有什么？"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">[</span><span class="token string">"path/to/example2.jpg"</span><span class="token punctuation">,</span> <span class="token string">"描述图中的场景"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        inputs<span class="token operator">=</span><span class="token punctuation">[</span>image_input<span class="token punctuation">,</span> text_input<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

<span class="token comment"># 启动应用</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    demo<span class="token punctuation">.</span>launch<span class="token punctuation">(</span>share<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f636f6e646f6d31303031302f:61727469636c652f64657461696c732f313436313836373838" class_="artid" style="display:none">
 </p>
</div>


