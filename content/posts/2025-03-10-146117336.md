---
layout: post
title: "nginx反向代理应用"
date: 2025-03-10 11:51:46 +0800
description: "upstream        组名称 {[调度算法]；backup作用是其他的服务器全部故障，客户端会显示backup服务器，如若web服务器正常，则backup服务器不会显示不要写在server{ }location{proxy_pass http://upstream组名称;"
keywords: "nginx反向代理应用"
categories: ['Nginx']
tags: ['运维', 'Nginx']
artid: "146117336"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146117336
    alt: "nginx反向代理应用"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146117336
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146117336
cover: https://bing.ee123.net/img/rand?artid=146117336
image: https://bing.ee123.net/img/rand?artid=146117336
img: https://bing.ee123.net/img/rand?artid=146117336
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     nginx反向代理应用
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <h2>
     一、location的写法
    </h2>
    <blockquote>
     <p>
      语法：
     </p>
     <p>
      location[=|~|~*|^~] uri地址 {
      <!-- -->
     </p>
     <p>
      ........
     </p>
     <p>
      ........
     </p>
     <p>
      }
     </p>
     <p>
      1、=        精确匹配
     </p>
     <p>
      2、~        通过正则表达式匹配请求，区分大小写
     </p>
     <p>
      3、~*        通过正则表达式请求，不区分大小写
     </p>
     <p>
      4、^~        不以正则表达式匹配请求
     </p>
    </blockquote>
    <p>
     非常关键：
    </p>
    <blockquote>
     <p>
      优先级：从高到低
     </p>
     <p>
      =，^~，~，~*
     </p>
    </blockquote>
    <h2>
     案例：配置错误页面
    </h2>
    <p>
     <img alt="" height="63" src="https://i-blog.csdnimg.cn/direct/72f4fda925664fb99cf5162129d94a9e.png" width="723"/>
    </p>
    <p>
     <img alt="" height="342" src="https://i-blog.csdnimg.cn/direct/5088bd06f41e4a0c9d2a9008934a19f2.png" width="609"/>
    </p>
    <p>
     <img alt="" height="96" src="https://i-blog.csdnimg.cn/direct/3ceb897df42b4dad802865f6c627d330.png" width="1077"/>
    </p>
    <h2>
     <img alt="" height="582" src="https://i-blog.csdnimg.cn/direct/201c12a10fa644b3a780d0ea921ad3b5.png" width="990"/>
    </h2>
    <h2>
     二、http的反向代理
    </h2>
    <blockquote>
     <p>
      location {
      <!-- -->
     </p>
     <p>
      proxy_pass        后端服务器：
     </p>
     <p>
      }
     </p>
     <p>
      1、定义location如果明确的写了uri地址，反向代理时也要写具体的uri地址
     </p>
     <p>
      2、定义location如果使用正则表达式，反向代理时只能写到后端服务器地址结束
     </p>
    </blockquote>
    <h4>
     案例1：配置nginx将所有请求转交给后端服务器
    </h4>
    <p>
     做反向代理，后端必须有真实的网站服务器存在，将一台机器装上httpd作为网站服务器使用
    </p>
    <p>
     <img alt="" height="321" src="https://i-blog.csdnimg.cn/direct/d38935fd14c64ea288c30083dac7dafe.png" width="953"/>
    </p>
    <p>
     删除默认的欢迎页面，重新写页面
    </p>
    <p>
     <img alt="" height="195" src="https://i-blog.csdnimg.cn/direct/8d16a789a49247a9a03242975dabe930.png" width="1151"/>
    </p>
    <p>
     确保httpd本身可以访问
    </p>
    <p>
     <img alt="" height="258" src="https://i-blog.csdnimg.cn/direct/9ea52a5ef72e47748598c439bcd055b5.png" width="620"/>
    </p>
    <p>
     在shell的虚拟主机做配置
    </p>
    <p>
     <img alt="" height="70" src="https://i-blog.csdnimg.cn/direct/1fe1ba5452d34ccb8dc484a83652092b.png" width="1014"/>
    </p>
    <p>
     <img alt="" height="378" src="https://i-blog.csdnimg.cn/direct/0f6f3bceab0441d4a0867ff48f130060.png" width="1026"/>
    </p>
    <p>
     <img alt="" height="270" src="https://i-blog.csdnimg.cn/direct/59feb829a86c469683d255f5ec988ffe.png" width="726"/>
    </p>
    <h4>
     案例2：将/test1请求转交给后端服务器
    </h4>
    <p>
     现在httpd（后端服务器）上做一个网页，进行访问测试
    </p>
    <p>
     <img alt="" height="150" src="https://i-blog.csdnimg.cn/direct/9cd3092ccd724b4c8578fa64b3c2600d.png" width="1329"/>
    </p>
    <p>
     <img alt="" height="200" src="https://i-blog.csdnimg.cn/direct/5120c683ab12459884f9faf5ecac4015.png" width="756"/>
    </p>
    <p>
     <img alt="" height="522" src="https://i-blog.csdnimg.cn/direct/688c0c07d8fe466daadd778f6dc27b91.png" width="923"/>
     <img alt="" height="207" src="https://i-blog.csdnimg.cn/direct/58270bbe970b40cf8fe536652afd17a6.png" width="591"/>
    </p>
    <p>
     <img alt="" height="269" src="https://i-blog.csdnimg.cn/direct/f535b582ba66493e82f44f4ad3964c32.png" width="735"/>
    </p>
    <h4>
     配置后端服务器记录真实客户端地址
    </h4>
    <p>
     1）在请求中添加真实客户端地址的字段
    </p>
    <p>
     有反向代理的位置一般都需要添加，这里只演示最下方的一个
    </p>
    <p>
     <img alt="" height="1043" src="https://i-blog.csdnimg.cn/direct/1b381684355e4ad4a3b86d5a3834be0b.png" width="930"/>
    </p>
    <p>
     还需要修改httpd配置文件，来获取windows的访问IP
    </p>
    <p>
     2）修改httpd访问日志格式
    </p>
    <p>
     <img alt="" height="186" src="https://i-blog.csdnimg.cn/direct/f751b0e6e72647dab9355ba3e9550553.png" width="909"/>
    </p>
    <p>
     <img alt="" height="476" src="https://i-blog.csdnimg.cn/direct/7db12b074c2c47cd9dcb0351ffb54e7a.png" width="1533"/>
    </p>
    <p>
    </p>
    <p>
     <img alt="" height="546" src="https://i-blog.csdnimg.cn/direct/1c764af91ab347058fcf70a0f71111d0.png" width="737"/>
    </p>
    <p>
     获取的IP就变为了客户端IP
    </p>
    <h2>
     三、upstream模块
    </h2>
    <blockquote>
     <p>
      作用：
     </p>
     <p>
      1、将多台web服务器定义为一个upstream组，实现web服务的负载均衡
     </p>
     <p>
      2、提供对后端服务器健康状态检查
     </p>
    </blockquote>
    <h4>
     1、调度算法
    </h4>
    <blockquote>
     <p>
      1、rr        轮询        默认算法
     </p>
     <p>
      优势：后端的每个服务处理的请求最大数相同，负载均衡效果好
     </p>
     <p>
      支持为后端服务器设置不同的权重值，避免资源浪费
     </p>
     <p>
      解决会话session保持/持久的方案：
     </p>
     <p>
      1）使用noSQL数据库作为会话的共享存储
     </p>
     <p>
      2）换调度算法
     </p>
     <p>
      2、ip_hash
     </p>
     <p>
      一段时间内，可以将同一个客户端的请求转发到后端的同一个服务器上
     </p>
    </blockquote>
    <h4>
     2、定义upstream组
    </h4>
    <blockquote>
     <p>
      upstream        组名称 {
      <!-- -->
     </p>
     <p>
      [调度算法]；
     </p>
     <p>
      server IP:port        [weight=number] [max_fails=number] [fail_timeout=number]
     </p>
     <p>
      server IP:port        [weight=number] [max_fails=number] [fail_timeout=number]
     </p>
     <p>
      server IP:port        [weight=number] [max_fails=number] [fail_timeout=number]
     </p>
     <p>
      server IP:port        [weight=number] [max_fails=number] [fail_timeout=number] backup
     </p>
     <p>
      }
     </p>
     <p>
     </p>
     <p>
      backup作用是其他的服务器全部故障，客户端会显示backup服务器，如若web服务器正常，则backup服务器不会显示
     </p>
     <p>
     </p>
     <p>
      不要写在server{ }
     </p>
     <p>
     </p>
     <p>
      location{
      <!-- -->
     </p>
     <p>
      proxy_pass http://upstream组名称;
     </p>
     <p>
      }
     </p>
    </blockquote>
    <h4>
     案例：基于upstream模块实现web服务器的负载均衡
    </h4>
    <p>
     演示此案例后端至少需要有两个网站服务器
    </p>
    <p>
     配置shell虚拟主机配置文件
    </p>
    <p>
     <img alt="" height="93" src="https://i-blog.csdnimg.cn/direct/a987b9b0ffe44f4d8c46db395db99c30.png" width="1025"/>
    </p>
    <p>
     <img alt="" height="560" src="https://i-blog.csdnimg.cn/direct/ba9b47d8b9df4eb48af05952cf9271d6.png" width="1050"/>
    </p>
    <p>
     <img alt="" height="259" src="https://i-blog.csdnimg.cn/direct/bd3a49e7b4d04ff3b5ef5182b19449c9.png" width="1161"/>
    </p>
    <p>
     进行访问点击刷新后端服务器会轮流响应
    </p>
    <p>
     <img alt="" height="195" src="https://i-blog.csdnimg.cn/direct/4306e1eb396d44118fddd8e776d2918b.png" width="506"/>
    </p>
    <p>
     <img alt="" height="221" src="https://i-blog.csdnimg.cn/direct/db740fde49bb4d05a06c5d16e9f200ab.png" width="606"/>
    </p>
    <p>
     停止一个web服务器，不会影响客户端的正常访问，web01正常访问
    </p>
    <p>
     <img alt="" height="112" src="https://i-blog.csdnimg.cn/direct/f0014d3a521347d9b6230b70e24fa3c1.png" width="840"/>
     <img alt="" height="215" src="https://i-blog.csdnimg.cn/direct/6588f23b229c4df6b552de390e91adb7.png" width="561"/>
    </p>
    <p>
     全部停止会出现502错误
    </p>
    <h4>
     添加backup服务器
    </h4>
    <p>
     <img alt="" height="148" src="https://i-blog.csdnimg.cn/direct/774129f4921548b589c3ee18c5ae1f67.png" width="755"/>
    </p>
    <p>
     <img alt="" height="88" src="https://i-blog.csdnimg.cn/direct/34838cf6aa05474593425717c764aaba.png" width="810"/>
     backup服务器没有使用虚拟主机直接在主配置文件中配置的，可以使用虚拟主机
    </p>
    <p>
     <img alt="" height="52" src="https://i-blog.csdnimg.cn/direct/82824c486a2d47b7b2f6e58eeadcfba0.png" width="855"/>
    </p>
    <p>
     <img alt="" height="344" src="https://i-blog.csdnimg.cn/direct/736016460f0a4127943739a2754a2735.png" width="729"/>
    </p>
    <p>
     <img alt="" height="81" src="https://i-blog.csdnimg.cn/direct/7862a97f3d3d4617becb078e4f5cd8c9.png" width="1050"/>
     <img alt="" height="580" src="https://i-blog.csdnimg.cn/direct/6eead27ffe024fa7a6c712dfab97f52e.png" width="1040"/>
    </p>
    <p>
     <img alt="" height="237" src="https://i-blog.csdnimg.cn/direct/290e6ebd1c0b4bd5b7e3ca22d0b40423.png" width="1239"/>
    </p>
    <p>
    </p>
   </div>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f:672e6373646e2e6e65742f323430325f38373331393237312f:61727469636c652f64657461696c732f313436313137333336" class_="artid" style="display:none">
 </p>
</div>


