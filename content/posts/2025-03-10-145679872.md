---
layout: post
title: "STM32G4高级定时器的应用计数模式的原理"
date: 2025-03-10 10:15:40 +0800
description: "本文主要介绍STM32高级定时器的计数模式下的应用原理，STM32微控制器的高级定时器模块通常指的是TIM1-TIM8定时器模块，这些定时器模块具有更高级的功能和灵活性，可用于各种应用场景。"
keywords: "STM32（G4）高级定时器的应用（计数模式）的原理"
categories: ['Stm']
tags: ['嵌入式硬件', '单片机', 'Stm']
artid: "145679872"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=145679872
    alt: "STM32G4高级定时器的应用计数模式的原理"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=145679872
featuredImagePreview: https://bing.ee123.net/img/rand?artid=145679872
cover: https://bing.ee123.net/img/rand?artid=145679872
image: https://bing.ee123.net/img/rand?artid=145679872
img: https://bing.ee123.net/img/rand?artid=145679872
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     STM32（G4）高级定时器的应用（计数模式）的原理
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <hr id="hr-toc" name="tableOfContents"/>
    <p>
    </p>
    <h2 id="%E6%A6%82%E8%BF%B0" name="%E6%A6%82%E8%BF%B0">
     概述
    </h2>
    <p>
     本文主要介绍STM32高级定时器的计数模式下的应用原理，STM32微控制器的高级定时器模块通常指的是TIM1-TIM8定时器模块，这些定时器模块具有更高级的功能和灵活性，可用于各种应用场景。以下是一些常见的高级定时器应用：
    </p>
    <ol>
     <li>
      <p>
       <strong>
        PWM输出
       </strong>
       ：高级定时器可以用于生成PWM信号，控制电机速度、LED亮度等。通过配置定时器的各种参数，如计数值、分频系数、占空比等，可以实现不同频率和占空比的PWM输出。
      </p>
     </li>
     <li>
      <p>
       <strong>
        编码器接口
       </strong>
       ：高级定时器可以用于实现编码器接口功能，用于读取旋转编码器的脉冲信号，从而实现位置和速度的测量。
      </p>
     </li>
     <li>
      <p>
       <strong>
        输入捕获
       </strong>
       ：高级定时器可以用于捕获外部信号的上升沿或下降沿，用于测量脉冲的宽度、计数频率等应用。
      </p>
     </li>
     <li>
      <p>
       <strong>
        输出比较
       </strong>
       ：高级定时器可以用于设置比较值，当定时器计数达到比较值时产生中断或触发输出比较事件。
      </p>
     </li>
     <li>
      <p>
       <strong>
        定时器中断
       </strong>
       ：通过配置定时器的中断使能和中断优先级，可以实现定时器定时中断功能，用于定时执行特定任务。
      </p>
     </li>
    </ol>
    <h2 id="1%20%E8%AE%A1%E6%95%B0%E6%A8%A1%E5%BC%8F%E4%BB%8B%E7%BB%8D" name="1%20%E8%AE%A1%E6%95%B0%E6%A8%A1%E5%BC%8F%E4%BB%8B%E7%BB%8D">
     1
     <span style="color:#000000">
      <strong>
       计数模式介绍
      </strong>
     </span>
    </h2>
    <h3 id="1.1%20%E5%A2%9E%E8%AE%A1%E6%95%B0%E6%A8%A1%E5%BC%8F" name="1.1%20%E5%A2%9E%E8%AE%A1%E6%95%B0%E6%A8%A1%E5%BC%8F">
     <span style="color:#000000">
      <strong>
       1.1 增计数模式
      </strong>
     </span>
    </h3>
    <h4 id="1.1.1%20%E5%8A%9F%E8%83%BD%E4%BB%8B%E7%BB%8D" name="1.1.1%20%E5%8A%9F%E8%83%BD%E4%BB%8B%E7%BB%8D">
     <span style="color:#000000">
      <strong>
       1.1.1 功能介绍
      </strong>
     </span>
    </h4>
    <p>
     在向上计数模式下， 其执行流程如下：
    </p>
    <blockquote>
     <p>
      1) 计数器从0计数到
      <strong>
       <span style="background-color:#a2e043">
        自动重新加载值
       </span>
      </strong>
      （对象的内容
      <strong>
       TIMx_ARR
      </strong>
      寄存器)
     </p>
     <p>
      2) 从0重新启动并生成计数器溢出事件。
     </p>
     <p>
      3) 如果使用重复计数器，则在重复计数器寄存器中编程的次数重复计数后生成更新事件（UEV）（TIMx_RCR） + 1。否则在每次计数器溢出时生成更新事件。
     </p>
    </blockquote>
    <p>
     在TIMx_EGR寄存器中设置UG位（通过软件或使用从模式控制器）也会生成一个更新事件。
    </p>
    <p>
     通过在TIMx_CR1寄存器中设置UDIS位，软件可以禁用UEV事件。这是为了避免在预加载寄存器中写入新值时更新影子寄存器。然后，在将UDIS位写入0之前不会发生更新事件。然而，计数器从0开始重新启动，以及预分频器的计数器（但预分频率不改变）。另外，如果URS位（更新请求选择）在设置了TIMx_CR1寄存器，设置UG位生成一个更新事件UEV，但没有设置UIF标志（因此不会发送中断或DMA请求）。
    </p>
    <p>
     当发生更新事件时，所有寄存器都被更新，更新标志（UIF位在TIMx_SR寄存器)被设置（取决于URS位）：
    </p>
    <blockquote>
     <p>
      •用TIMx_RCR寄存器的内容重新加载重复计数器；
      <br/>
      •自动加载阴影寄存器更新为预加载值（TIMx_ARR），
      <br/>
      •用预加载值（TIMx_PSC寄存器的内容）重新加载预缩放器的缓冲区。
     </p>
    </blockquote>
    <h4 id="1.1.2%20%E6%B3%A2%E5%BD%A2%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90" name="1.1.2%20%E6%B3%A2%E5%BD%A2%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90">
     1.1.2 波形案例分析
    </h4>
    <p>
     下图显示了
     <strong>
      <span style="background-color:#a2e043">
       TIMx_ARR = 0x36（十进制： 54 ）
      </span>
     </strong>
     时不同时钟频率下计数器行为的一些示例。
    </p>
    <p>
     <strong>
      1）系统时钟1分频的时钟波形图
     </strong>
    </p>
    <p>
     <img alt="" height="564" src="https://i-blog.csdnimg.cn/direct/8032da317e824c3f9ae4a7aaa8f1029a.png" width="910"/>
    </p>
    <p>
     <strong>
      2） 系统时钟2分频的时钟波形图
     </strong>
    </p>
    <p>
     <img alt="" height="540" src="https://i-blog.csdnimg.cn/direct/ce09b2ed530a4a6d9264568278c0335b.png" width="899"/>
    </p>
    <p>
     <strong>
      3） 系统时钟4分频的时钟波形图
     </strong>
    </p>
    <p>
     <img alt="" height="558" src="https://i-blog.csdnimg.cn/direct/7435dbafd4df473b9dfcbf03fa911962.png" width="909"/>
    </p>
    <h3 id="1.2%20%E5%87%8F%E8%AE%A1%E6%95%B0%E6%A8%A1%E5%BC%8F" name="1.2%20%E5%87%8F%E8%AE%A1%E6%95%B0%E6%A8%A1%E5%BC%8F">
     1.2 减计数模式
    </h3>
    <h4 id="1.2.1%20%E5%8A%9F%E8%83%BD%E4%BB%8B%E7%BB%8D" name="1.2.1%20%E5%8A%9F%E8%83%BD%E4%BB%8B%E7%BB%8D">
     1.2.1 功能介绍
    </h4>
    <p>
     <strong>
      在下降计数模式下，其执行步骤如下：
     </strong>
    </p>
    <blockquote>
     <p>
      1）计数器从自动重新加载值（对象的内容）开始计数TIMx_ARR寄存器)降为0，然后从自动重新加载值重新启动，并生成计数器下溢事件。
     </p>
     <p>
      2）如果使用重复计数器，则在重复计数器寄存器中编程的次数重复计数后生成更新事件（UEV）（TIMx_RCR） + 1。否则，在每个计数器下流处生成更新事件。
     </p>
     <p>
      3）在TIMx_EGR寄存器中设置UG位（通过软件或使用从模式控制器）也会生成一个更新事件。
     </p>
     <p>
      4） 通过设置TIMx_CR1寄存器中的UDIS位，软件可以禁用UEV更新事件。这是为了避免在预加载寄存器中写入新值时更新影子寄存器。然后，在将UDIS位写入0之前不会发生更新事件。然而，计数器从当前的自动重新加载值重新启动，而预分频器的计数器从0重新启动（但预分频率不会改变）。
     </p>
     <p>
      5）如果设置了TIMx_CR1寄存器中的URS位（更新请求选择），则设置UG位生成一个更新事件UEV，但没有设置UIF标志(因此没有中断或发送DMA请求)。这是为了避免在清除捕获事件上的计数器时同时生成更新和捕获中断。
     </p>
    </blockquote>
    <p>
     <strong>
      当发生更新事件时，所有寄存器都被更新，更新标志（UIF位在TIMx_SR寄存器)被设置（取决于URS位））：
     </strong>
    </p>
    <blockquote>
     <p>
      • 用TIMx_RCR寄存器的内容重新加载重复计数器。
      <br/>
      • 用预加载值（TIMx_PSC寄存器的内容）重新加载预缩放器的缓冲区。
      <br/>
      • 自动加载活动寄存器更新为预加载值（内容）TIMx_ARR注册)。请注意，自动重新加载是在重新加载计数器之前更新的，因此下一个周期是预期的。
     </p>
    </blockquote>
    <h4 id="1.2.2%20%E6%B3%A2%E5%BD%A2%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90" name="1.2.2%20%E6%B3%A2%E5%BD%A2%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90">
     1.2.2 波形案例分析
    </h4>
    <p>
     下图显示了TIMx_ARR = 0x36时不同时钟频率下计数器行为的一些示例。
    </p>
    <p>
     <strong>
      1）系统时钟1分频
     </strong>
    </p>
    <p>
     <img alt="" height="545" src="https://i-blog.csdnimg.cn/direct/868c0f58dd8f4eb9be0383956e4870a3.png" width="926"/>
    </p>
    <p>
     <strong>
      2）系统时钟2分频
     </strong>
    </p>
    <p>
     <img alt="" height="557" src="https://i-blog.csdnimg.cn/direct/950a8744a89d43d09dea436d451c0b26.png" width="913"/>
    </p>
    <p>
     <strong>
      3） 系统时钟4分频
     </strong>
    </p>
    <p>
     <img alt="" height="569" src="https://i-blog.csdnimg.cn/direct/e50c6f728fa24d22b87dd54b15fca7af.png" width="921"/>
    </p>
    <h3 id="1.3%C2%A0%20%E4%B8%AD%E5%AF%B9%E9%BD%90%E6%A8%A1%E5%BC%8F%EF%BC%88%E4%B8%8A%2F%E4%B8%8B%E8%AE%A1%E6%95%B0%EF%BC%89" name="1.3%C2%A0%20%E4%B8%AD%E5%AF%B9%E9%BD%90%E6%A8%A1%E5%BC%8F%EF%BC%88%E4%B8%8A%2F%E4%B8%8B%E8%AE%A1%E6%95%B0%EF%BC%89">
     1.3  中对齐模式（上/下计数）
    </h3>
    <h4 id="1.3.1%20%E5%8A%9F%E8%83%BD%E4%BB%8B%E7%BB%8D" name="1.3.1%20%E5%8A%9F%E8%83%BD%E4%BB%8B%E7%BB%8D">
     1.3.1 功能介绍
    </h4>
    <p>
     在居中对齐模式下，计数器从0计数到自动重新加载值（TIMx_ARR寄存器的内容）—1，生成计数器溢出事件，然后从自动重新加载值计数到1并生成计数器下溢事件。然后重新从0开始计数。
    </p>
    <p>
     当TIMx_CR1寄存器中的CMS位不等于00时，中心对齐模式激活。输出中配置的通道输出比较中断标志设置为：
    </p>
    <blockquote>
     <p>
      1）计数器向下计数（居中对齐模式1，CMS = 01），
     </p>
     <p>
      2）计数器向上计数（居中对齐模式2，CMS = 10），
     </p>
     <p>
      3）计数器向上计数和向下计数（居中对齐模式3，CMS = 11）。
     </p>
    </blockquote>
    <p>
     在这种模式下，不能写TIMx_CR1寄存器中的DIR方向位。它由硬件更新并给出计数器的当前方向。更新事件可以在每个计数器溢出和计数器下溢时生成，也可以通过在TIMx_EGR寄存器中设置
     <strong>
      UG
     </strong>
     位（通过软件或使用从模式控制器）生成更新事件。在这种情况下，计数器重新开始计数0，以及预分器的计数器。
    </p>
    <blockquote>
     <p>
      <img alt="" height="126" src="https://i-blog.csdnimg.cn/direct/913df94a4ae4493ab0e4a96723d40f31.png" width="597"/>
     </p>
     <p>
      <img alt="" height="112" src="https://i-blog.csdnimg.cn/direct/beff0e4122b24c3fbb8cd537ee69f455.png" width="958"/>
     </p>
     <p>
     </p>
    </blockquote>
    <p>
     通过在TIMx_CR1寄存器中设置UDIS位，软件可以禁用UEV更新事件。这是为了避免在预加载寄存器中写入新值时更新影子寄存器。然后，在将UDIS位写入0之前不会发生更新事件。但是，计数器根据当前的自动重新加载值继续向上和向下计数。
    </p>
    <p>
     此外，如果设置了TIMx_CR1寄存器中的URS位（更新请求选择），则设置UG位生成UEV更新事件，但不设置UIF标志（因此没有中断或中断发送DMA请求)。这是为了避免在清除捕获事件上的计数器时同时生成更新和捕获中断。
    </p>
    <p>
     当发生更新事件时，所有寄存器都被更新，更新标志（UIF位在TIMx_SR寄存器)被设置（取决于URS位）：
    </p>
    <blockquote>
     <p>
      <br/>
      •用TIMx_RCR寄存器的内容重新加载重复计数器
      <br/>
      •用预加载值（TIMx_PSC寄存器的内容）重新加载预缩放器的缓冲区
      <br/>
      •自动加载活动寄存器更新为预加载值（内容TIMx_ARR注册)。请注意，如果更新源是计数器溢出，则在重新加载计数器之前更新自动加载，以便下一个周期是预期的（计数）
     </p>
    </blockquote>
    <h4 id="1.3.2%20%E6%B3%A2%E5%BD%A2%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90" name="1.3.2%20%E6%B3%A2%E5%BD%A2%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90">
     1.3.2 波形案例分析
    </h4>
    <p>
     下图显示了不同时钟频率下计数器行为的一些示例。
    </p>
    <p>
     1）系统时钟1分频，
     <span style="color:#000000">
      <strong>
       TIMx_ARR = 0x6
      </strong>
     </span>
    </p>
    <p>
     <img alt="" height="500" src="https://i-blog.csdnimg.cn/direct/57de56490b1d469583d2d0ca2c9b4c85.png" width="796"/>
    </p>
    <p>
     2）系统时钟4分频，
     <span style="color:#000000">
      <strong>
       TIMx_ARR = 0x36
      </strong>
     </span>
    </p>
    <p>
     <img alt="" height="470" src="https://i-blog.csdnimg.cn/direct/3e950af1f8b4463fbc9874ff076d3f33.png" width="795"/>
    </p>
    <h2 id="2%C2%A0%20%E9%87%8D%E5%A4%8D%E8%AE%A1%E6%95%B0%E5%99%A8%E5%80%BC" name="2%C2%A0%20%E9%87%8D%E5%A4%8D%E8%AE%A1%E6%95%B0%E5%99%A8%E5%80%BC">
     2  重复计数器值
    </h2>
    <p>
     通过更新事件（UEV）是如何根据计数器溢出/下溢生成的。它实际上只在重复计数器达到零时生成。这在产生PWM信号时很有用。这意味着数据从预加载寄存器传输到影子寄存器（TIMx_ARR自动重新加载寄存器，TIMx_PSC预调量寄存器，但也TIMx_CCRx捕获/比较寄存器在比较模式）每N+1计数器溢出或下溢，其中N是TIMx_RCR重复计数器寄存器中的值。
    </p>
    <blockquote>
     <p>
      <strong>
       重复计数器递减：
      </strong>
      <br/>
      •在计数模式下，每个计数器溢出时，
      <br/>
      •在计数模式下，每个计数器下流量
      <br/>
      •在每个计数器溢出和每个计数器下溢在中心对齐模式。
     </p>
     <hr/>
     <p>
      <br/>
      虽然这将最大重复次数限制在32768个PWM周期，但它使得每个PWM周期可以更新两次占空比。在居中对齐模式下，每个PWM周期只刷新比较寄存器一次，最大分辨率为由于图案的对称性。
     </p>
    </blockquote>
    <p>
     重复计数器是自动加载类型；重复率由TIMx_RCR寄存器值定义。当更新事件由软件（通过在TIMx_EGR寄存器中设置UG位）或硬件通过从模式控制器生成时，无论重复计数器的值是多少，它都会立即发生，并且重复计数器会用TIMx_RCR寄存器的内容重新加载。
    </p>
    <p>
     在居中对齐模式下，对于RCR的奇数值，更新事件发生在溢出或下溢，这取决于何时写入RCR寄存器以及何时启动计数器：如果在启动计数器之前写入RCR，则UEV发生在下溢。如果RCR是在启动计数器后写入的，则UEV发生在溢出上。
    </p>
    <p>
     例如，对于RCR = 3，根据何时写入RCR，每4次溢出或下溢事件生成UEV。
    </p>
    <p>
     <img alt="" height="609" src="https://i-blog.csdnimg.cn/direct/d6a69d3db25d49f3add1b8daddb46ee2.png" width="902"/>
    </p>
    <p>
    </p>
   </div>
  </div>
 </article>
 <p alt="68747470:733a2f2f626c6f672e6373646e2e6e65742f6d6674616e672f:61727469636c652f64657461696c732f313435363739383732" class_="artid" style="display:none">
 </p>
</div>


