---
layout: post
title: "OpenEuler-22.03-LTS上利用Ansible轻松部署MySQL-5.7"
date: 2025-03-14 20:47:09 +0800
description: "创建group_vars目录编写all.yml变量文件，定义mysql 的安装地址，mysql的root 及jdbc用户的账户密码，授权地址---#mysql#授权root@'localhost'#jdbc数据库授权#授权jdbc登录地址,授权子网定义inventory 主机清单需要注意，因为用户的不同，需要修改main.yml 入口文件中，以指定提权用户执行ansible剧本任务。"
keywords: "OpenEuler-22.03-LTS上利用Ansible轻松部署MySQL 5.7"
categories: ['Openeuler', 'Lts']
tags: ['Openeuler', 'Mysql', 'Ansible', 'Ansible']
artid: "146267020"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146267020
    alt: "OpenEuler-22.03-LTS上利用Ansible轻松部署MySQL-5.7"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146267020
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146267020
cover: https://bing.ee123.net/img/rand?artid=146267020
image: https://bing.ee123.net/img/rand?artid=146267020
img: https://bing.ee123.net/img/rand?artid=146267020
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     OpenEuler-22.03-LTS上利用Ansible轻松部署MySQL 5.7
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <h2 id="一-需求">
     一、需求
    </h2>
    <ul>
     <li>
      使用ansible自动化部署mysql
     </li>
     <li>
      二进制部署mysql
     </li>
     <li>
      部署mysql并创建JDBC用户
     </li>
    </ul>
    <h2 id="二-环境信息">
     二、环境信息
    </h2>
    <blockquote>
     <p>
      本文涉及的代码，配置文件地址： 链接：
      <a href="https://pan.baidu.com/s/1bvEgx5oxLUKjcMh7dxpZlA?pwd=1g6y" rel="nofollow" title="百度网盘 请输入提取码">
       百度网盘 请输入提取码
      </a>
      提取码：1g6y
     </p>
    </blockquote>
    <table>
     <thead>
      <tr>
       <th>
        软件名称
       </th>
       <th>
        版本
       </th>
       <th>
        备注
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        Ansible
       </td>
       <td>
        2.9.27
       </td>
       <td>
        <a href="https://docs.ansible.com/ansible/2.9/modules/list_of_all_modules.html#" rel="nofollow" title="All modules — Ansible Documentation">
         All modules — Ansible Documentation
        </a>
       </td>
      </tr>
      <tr>
       <td>
        Mysql
       </td>
       <td>
        5.7.44
       </td>
       <td>
        <a href="https://cdn.mysql.com//Downloads/MySQL-5.7/mysql-5.7.44-linux-glibc2.12-x86_64.tar" rel="nofollow" title="https://cdn.mysql.com//Downloads/MySQL-5.7/mysql-5.7.44-linux-glibc2.12-x86_64.tar">
         https://cdn.mysql.com//Downloads/MySQL-5.7/mysql-5.7.44-linux-glibc2.12-x86_64.tar
        </a>
       </td>
      </tr>
      <tr>
       <td>
        openEuler
       </td>
       <td>
        22.03 (LTS-SP3)
       </td>
       <td>
       </td>
      </tr>
     </tbody>
    </table>
    <h2 id="三-部署ansible">
     三、部署ansible
    </h2>
    <h3 id="h-31-安装ansible">
     3.1 安装ansible
    </h3>
    <pre><code>yum install ansible -y</code></pre>
    <p>
    </p>
    <h3 id="h-32-配置ansiblecfg-配置文件">
     3.2 配置ansible.cfg 配置文件
    </h3>
    <pre><code>vim /etc/ansible/ansible.cfg 【一般只要修改下面的几行内容】

...........
inventory  = /etc/ansible/hosts                #打开注释
host_key_checking = False                     # ssh连接时，不需要输入yes; 如果为True, 就需要输入yes
log_path=/var/log/ansible.log                  #日志文件，默认是不开启的
...........</code></pre>
    <p>
    </p>
    <h2 id="四-编写mysql-roles">
     四、编写mysql-roles
    </h2>
    <h3 id="h-41-目录结构">
     4.1 目录结构
    </h3>
    <pre><code>[root@openeuler ansible]# tree -L 5
├── group_vars
│   └── all.yml
├── hosts
├── main.yml
└── roles
    └── mysql
        ├── files
        │   └── mysqld.service
        ├── tasks
        │   └── main.yml
        └── templates
            └── my.cnf-master.j2

6 directories, 6 files</code></pre>
    <p>
    </p>
    <ul>
     <li>
      group_vars/all.yml 定义全局变量，里面定义了mysql部署时root 的账户密码，以及JDBC的账户密码
     </li>
     <li>
      hosts 文件，定义inventory 主机清单，定义了ansible 在哪台服务器上部署mysql
     </li>
     <li>
      main.yml ，ansible-playbook 的入口文件，根据这个文件执行部署mysql roles
     </li>
     <li>
      roles/mysql 里定义了mysql剧本的具体内容
     </li>
    </ul>
    <h3 id="h-42-编写剧本">
     4.2 编写剧本
    </h3>
    <h4 id="h-421-定义全局变量编写group_varsallyml-文件">
     4.2.1 定义全局变量，编写group_vars/all.yml 文件
    </h4>
    <p>
     <code>
      创建group_vars目录
     </code>
    </p>
    <pre><code>mkdir -p /root/ansible/group_vars</code></pre>
    <p>
    </p>
    <p>
     <code>
      编写all.yml变量文件
     </code>
     ，定义mysql 的安装地址，mysql的root 及jdbc用户的账户密码，授权地址
    </p>
    <pre><code>vim /root/ansible/group_vars/all.yml

---
#mysql
#授权root@'localhost'
mysql_ip: 172.16.10.180
mysql_password: srebro.cn

#jdbc数据库授权
jdbc_user: srebro.cn
jdbc_user_password: xxxxxxx
#授权jdbc登录地址,授权子网
jdbc_ip: "172.16.10.%"</code></pre>
    <p>
    </p>
    <h4 id="h-422-定义inventory-主机清单">
     4.2.2 定义inventory 主机清单
    </h4>
    <blockquote>
     <p>
      定义inventory 主机清单
     </p>
    </blockquote>
    <h5 id="h-4221-使用root-用户的身份">
     4.2.2.1 使用root 用户的身份
    </h5>
    <pre><code>vim /root/ansible/hosts

###MYSQL服务器
[mysql]
172.16.10.180 ansible_ssh_host=172.16.10.180 ansible_ssh_user=root ansible_ssh_pass="srebro.cn"</code></pre>
    <p>
    </p>
    <p>
     <code>
      ps: openeuler 22.03 默认不允许root 用户远程登录，如果需要使用root 用户进行部署，需要修改 /etc/ssh/sshd_config
     </code>
     文件，修改成
     <code>
      PermitRootLogin yes
     </code>
     ，再重启sshd服务，
     <code>
      systemctl restart sshd
     </code>
    </p>
    <h5 id="h-4222-使用sudo-用户的身份">
     4.2.2.2 使用sudo 用户的身份
    </h5>
    <ul>
     <li>
      需要定义inventory 主机清单，手动指定提权用户，以及root 用户密码；
     </li>
    </ul>
    <pre><code>vim /root/ansible/hosts

###MYSQL服务器
[mysql]
172.16.10.180  ansible_ssh_host=172.16.10.180  ansible_ssh_user=srebro ansible_ssh_pass="srebro.cn" ansible_become_pass="srebro.cn"</code></pre>
    <p>
    </p>
    <h4 id="h-423-定义入口文件mainyml">
     4.2.3 定义入口文件main.yml
    </h4>
    <blockquote>
     <p>
      需要注意，因为用户的不同，需要修改main.yml 入口文件中，以指定提权用户执行ansible剧本任务
     </p>
    </blockquote>
    <h5 id="h-4231-使用root-用户的身份">
     4.2.3.1 使用root 用户的身份
    </h5>
    <pre><code>vim /root/ansible/main.yml

---
- name: deploy-mysql
  remote_user: root
  roles:
    - mysql
  hosts:
    - mysql
  gather_facts: false
  tags: mysql</code></pre>
    <p>
    </p>
    <h5 id="h-4232-使用sudo-用户的身份">
     4.2.3.2 使用sudo 用户的身份
    </h5>
    <pre><code>vim /root/ansible/main.yml

---
- name: deploy-mysql
  remote_user: srebro
  roles:
    - mysql
  hosts:
    - mysql
  gather_facts: false
  tags: mysql</code></pre>
    <p>
    </p>
    <h4 id="h-424-编写roles">
     4.2.4 编写roles
    </h4>
    <h5 id="h-4241-创建roles-工作目录">
     4.2.4.1 创建roles 工作目录
    </h5>
    <pre><code>mkdir -p /root/ansible/roles/mysql{files,tasks,templates}</code></pre>
    <p>
    </p>
    <ul>
     <li>
      files 目录，用于存放tasks 任务中，一些文件的下发到客户端，比如使用到copy模块
     </li>
     <li>
      tasks 目录，定义剧本的具体内容
     </li>
     <li>
      templates 目录，用于存放一些模板文件，通常是.j2 的文件格式结尾，可以根据全局的一些变量，动态的生成模板配置文件，比如我们在tasks 任务中，定义的
      <code>
       SERVER_ID
      </code>
      这个变量的值 就可以赋予给j2 文件去渲染出my.cnf 中server_id的值
     </li>
    </ul>
    <h5 id="h-4242-编写tasksmainyml-文件">
     4.2.4.2 编写tasks/main.yml 文件
    </h5>
    <blockquote>
     <p>
      ps:
     </p>
    </blockquote>
    <ul>
     <li>
      在openeuler 系统上，二进制部署mysql的时候需要安装
      <code>
       libaio
      </code>
      和
      <code>
       ncurses-compat-libs
      </code>
      依赖包
     </li>
     <li>
      mysql 的工作目录，我定义在了
      <code>
       /home/application/mysql
      </code>
      目录下 , 需要提前把这个
      <code>
       /home/application/
      </code>
      目录单独挂载，保证有充足的存储空间
     </li>
     <li>
      在部署mysql最后，有一个创建jdbc用户的步骤，这个时候需要用到
      <code>
       PyMySQL
      </code>
      这个组件，pip安装写即可
     </li>
    </ul>
    <pre><code>vim /root/ansible/roles/mysql/tasks/main.yml


---
  - name: install package
    yum:
      name:
        - libaio
        - ncurses-compat-libs
      state: present
    tags: install-package

  - name: install PyMySQL
    shell: python3 -m pip install PyMySQL -i https://mirrors.aliyun.com/pypi/simple/
    tags: install PyMySQL

  - name: useradd mysql
    user:
      name: mysql
      shell: /sbin/nologin
      createhome: no
      system: no

  - name: mkdir workspace
    file:
      path: /home/application/mysql
      state: directory
      mode: '0755'
      owner: mysql
      group: mysql

  - name: download mysql-5.7.44-linux-glibc2.12-x86_64.tar.gz
    unarchive: "src=https://cdn.mysql.com//Downloads/MySQL-5.7/mysql-5.7.44-linux-glibc2.12-x86_64.tar dest=/home/application/mysql/ remote_src=yes"
    tags: download

  - name: rename workspace
    shell: mv /home/application/mysql/mysql-5.7.44-linux-glibc2.12-x86_64 /home/application/mysql/app;

  - name: mkdir mysql data &amp; chown
    file:
      path: /home/application/mysql/data
      state: directory
      mode: '0775'
      owner: mysql
      group: mysql
      recurse: yes

  - name: mkdir mysql app &amp; chown
    file:
      path: /home/application/mysql/app
      state: directory
      mode: '0775'
      owner: mysql
      group: mysql
      recurse: yes

  - name: add mysql enviroment
    blockinfile:
      path: "{<!-- -->{ bashrc_file }}"
      backup: yes
      create: yes
      marker: "# {mark} ansible add mysql enviroment"
      block: |
        export PATH=$PATH:/home/application/mysql/app/bin
    tags: enviroment


  - name: get host last ip
    shell: "/usr/sbin/ip a | grep glo | awk '{print $2}' | head -1 |  cut -f1 -d/ | awk -F '.' '{print $4}'"
    register: shell_result
    tags: my.cnf

  - name: set last_ip variable
    set_fact:
      SERVER_ID: "{<!-- -->{ shell_result.stdout }}"
    tags: my.cnf

  - name: copy my.cnf-master
    template: "src=my.cnf-master.j2 dest=/etc/my.cnf"
    tags: my.cnf

  - name: init mysql
    shell: /home/application/mysql/app/bin/mysqld --initialize-insecure  --user=mysql --basedir=/home/application/mysql/app --datadir=/home/application/mysql/data
    tags: init

  - name: copy mysqld.service
    copy: "src={<!-- -->{ item.src }} dest={<!-- -->{ item.dest }} owner=root group=root mode=0775"
    with_items:
      - { src: "mysqld.service", dest: "/etc/systemd/system/mysqld.service" }
    tags: mysqld.service


  - name: add mysqld systemd
    shell: systemctl daemon-reload;systemctl enable mysqld;systemctl start mysqld
    tags: systemd


  - name: set mysql passwd
    shell: /home/application/mysql/app/bin/mysql -e "alter user 'root'@'localhost' identified by '{<!-- -->{ mysql_password }}';"
    tags: mysql_passwd


  - name: create  jdbc user
    mysql_user:
      login_user: "root"
      login_password: "{<!-- -->{ mysql_password }}"
      login_unix_socket: /tmp/mysql.sock
      name: "{<!-- -->{ jdbc_user }}"
      password: "{<!-- -->{ jdbc_user_password }}"
      host: "{<!-- -->{ jdbc_ip }}"
      priv: "*.*:all"
      state: "present"</code></pre>
    <p>
    </p>
    <h5 id="h-4243-编写filesmysqldservice-文件">
     4.2.4.3 编写files/mysqld.service 文件
    </h5>
    <blockquote>
     <p>
      使用systemd 管理mysqld，需要注意配置文件中
      <code>
       LimitNOFILE
      </code>
      的值
     </p>
    </blockquote>
    <pre><code>vim root/ansible/roles/mysql/files/mysqld.service

[Unit]
Description=MySQL Server
Documentation=man:mysqld
Documentation=http://dev.mysql.com/doc/refman/en/using-systemd.html
After=network.target
After=syslog.target

[Install]
WantedBy=multi-user.target
[Service]
User=mysql
Group=mysql
ExecStart=/home/application/mysql/app/bin/mysqld --defaults-file=/etc/my.cnf
LimitNOFILE = 65535</code></pre>
    <h5 id="h-4244-编写templatesmycnf-masterj2-模板文件">
     4.2.4.4 编写templates/my.cnf-master.j2 模板文件
    </h5>
    <blockquote>
     <p>
      my.cnf 配置文件，因人而异，仅供参考，默认我这里开启了binlog
     </p>
    </blockquote>
    <pre><code>[mysql]
socket=/tmp/mysql.sock
default-character-set=utf8

[mysqld]
user=mysql
basedir=/home/application/mysql/app
datadir=/home/application/mysql/data
character_set_server=utf8
collation-server=utf8_general_ci

#日志时间
log_timestamps=SYSTEM

port=3306
socket=/tmp/mysql.sock

max_connections=1000
max_allowed_packet=500M
sql_mode=STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION


#binlog配置
server_id={<!-- -->{ SERVER_ID }}
log-bin=mysql-bin
max_binlog_size = 100M
binlog_format=row
log_slave_updates
expire_logs_days=7

#只能用IP地址检查客户端的登录，不用主机名
skip-name-resolve=1
innodb_adaptive_hash_index=0</code></pre>
    <p>
    </p>
    <h2 id="五-执行ansible-playbook">
     五、执行ansible-playbook
    </h2>
    <h3 id="h-51-检测配置文件是否正确">
     5.1 检测配置文件是否正确
    </h3>
    <pre><code>#检测指定role, 使用 -t  指定role 的tag
ansible-playbook -i hosts main.yml -C -t  mysql</code></pre>
    <p>
    </p>
    <h3 id="h-52-安装部署">
     5.2 安装部署
    </h3>
    <pre><code>#检测指定role, 使用 -t  指定role 的tag
ansible-playbook -i hosts main.yml -t  mysql</code></pre>
    <p>
    </p>
    <h2 id="六-常见问题">
     六、常见问题
    </h2>
    <h3 id="h-61-libncursesso-问题">
     6.1
     <a href="http://libncurses.so/" rel="nofollow" title="libncurses.so">
      libncurses.so
     </a>
     问题
    </h3>
    <pre><code>mysql: error while loading shared libraries: libncurses.so.5: cannot open shared object file: No such file or directory</code></pre>
    <p>
    </p>
    <p>
    </p>
    <p class="img-center">
     <img alt="image-20240117161008954" height="108" src="https://i-blog.csdnimg.cn/img_convert/db394ecc69c605d4c95c14f7eee4ed05.png" width="1076"/>
    </p>
    <pre><code>报错原因: Linux系统中缺少libaio软件包

解决:
yum install libaio
yum install ncurses-compat-libs</code></pre>
    <p>
    </p>
   </div>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f6c69756775697a686f6e672f:61727469636c652f64657461696c732f313436323637303230" class_="artid" style="display:none">
 </p>
</div>


