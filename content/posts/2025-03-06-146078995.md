---
layout: post
title: "react中的fiber和初次渲染"
date: 2025-03-06 20:14:09 +0800
description: "fiber是指组件上将要完成或者已经完成的任务，每个组件可以一个或者多个。"
keywords: "react中的fiber和初次渲染"
categories: ['未分类']
tags: ['前端', 'React', 'Javascript']
artid: "146078995"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146078995
    alt: "react中的fiber和初次渲染"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146078995
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146078995
cover: https://bing.ee123.net/img/rand?artid=146078995
image: https://bing.ee123.net/img/rand?artid=146078995
img: https://bing.ee123.net/img/rand?artid=146078995
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     react中的fiber和初次渲染
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     源码中定义了不同类型节点的枚举值
    </p>
    <h3>
     <a id="_1">
     </a>
     组件类型
    </h3>
    <ul>
     <li>
      文本节点
     </li>
     <li>
      HTML标签节点
     </li>
     <li>
      函数组件
     </li>
     <li>
      类组件
     </li>
     <li>
      等等
     </li>
    </ul>
    <p>
     src/react/packages/react-reconciler/src/ReactWorkTags.js
    </p>
    <pre><code class="prism language-javascript"><span class="token keyword">export</span> <span class="token keyword">const</span> FunctionComponent <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> ClassComponent <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> IndeterminateComponent <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// Before we know whether it is function or class</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> HostRoot <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment">// Root of a host tree. Could be nested inside another node.</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> HostPortal <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token comment">// A subtree. Could be an entry point to a different renderer.</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> HostComponent <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> HostText <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> Fragment <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> Mode <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> ContextConsumer <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> ContextProvider <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> ForwardRef <span class="token operator">=</span> <span class="token number">11</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> Profiler <span class="token operator">=</span> <span class="token number">12</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> SuspenseComponent <span class="token operator">=</span> <span class="token number">13</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> MemoComponent <span class="token operator">=</span> <span class="token number">14</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> SimpleMemoComponent <span class="token operator">=</span> <span class="token number">15</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> LazyComponent <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> IncompleteClassComponent <span class="token operator">=</span> <span class="token number">17</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> DehydratedFragment <span class="token operator">=</span> <span class="token number">18</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> SuspenseListComponent <span class="token operator">=</span> <span class="token number">19</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> ScopeComponent <span class="token operator">=</span> <span class="token number">21</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> OffscreenComponent <span class="token operator">=</span> <span class="token number">22</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> LegacyHiddenComponent <span class="token operator">=</span> <span class="token number">23</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> CacheComponent <span class="token operator">=</span> <span class="token number">24</span><span class="token punctuation">;</span>
</code></pre>
    <h3>
     <a id="fiber_35">
     </a>
     什么是fiber
    </h3>
    <p>
     A Fiber is work on a Component that needs to be done or was done. There can be more than one per component.
    </p>
    <p>
     fiber是指组件上将要完成或者已经完成的任务，每个组件可以一个或者多个。
    </p>
    <pre><code class="prism language-javascript"><span class="token comment">// 比如一个函数组件FunctionComponent 里面是</span>
<span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">"border"</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>段落<span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>button<span class="token operator">&gt;</span>按钮<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token comment">// 那最后的fiber结构</span>
<span class="token keyword">const</span> fiber_ <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">"div"</span><span class="token punctuation">,</span>
  <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">className</span><span class="token operator">:</span> <span class="token string">"border"</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">child</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 第一个子节点</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">"p"</span><span class="token punctuation">,</span>
    <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token string">"段落"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">sibling</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 下一个兄弟节点</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">"button"</span><span class="token punctuation">,</span>
      <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token string">"按钮"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <h3>
     <a id="fiber_66">
     </a>
     fiber结构
    </h3>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/edcb624293a340d1acedad68e6499df5.png"/>
    </p>
    <h3>
     <a id="fiber_69">
     </a>
     为什么需要fiber
    </h3>
    <ol>
     <li>
      <p>
       为什么需要fiber
      </p>
      <p>
       对于大型项目，组件树会很大，这个时候递归遍历的成本就会很高，会造成主线程被持续占用，结果就是主线程上的布局、动画等周期性任务就无法立即得到处理，造成视觉上的卡顿，影响用户体验。
      </p>
     </li>
     <li>
      <p>
       任务分解的意义
      </p>
      <p>
       解决上面的问题
      </p>
     </li>
     <li>
      <p>
       增量渲染（把渲染任务拆分成块，匀到多帧）
      </p>
     </li>
     <li>
      <p>
       更新时能够暂停，终止，复用渲染任务
      </p>
     </li>
     <li>
      <p>
       给不同类型的更新赋予
       <strong>
        优先级
       </strong>
      </p>
     </li>
     <li>
      <p>
       并发方面新的基础能力
      </p>
     </li>
     <li>
      <p>
       <strong>
        更流畅
       </strong>
      </p>
     </li>
    </ol>
    <h3>
     <a id="fiber_82">
     </a>
     创建fiber结构
    </h3>
    <p>
     fiber就是一个js对象来抽象vnode
    </p>
    <pre><code class="prism language-javascript"><span class="token keyword">function</span> <span class="token function">createFiber</span><span class="token punctuation">(</span><span class="token parameter">vnode<span class="token punctuation">,</span> returnFiber</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> fiber <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> vnode<span class="token punctuation">.</span>type<span class="token punctuation">,</span>
    <span class="token literal-property property">key</span><span class="token operator">:</span> vnode<span class="token punctuation">.</span>key<span class="token punctuation">,</span>
    <span class="token literal-property property">stateNode</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// 原生标签时候指dom节点，类组件时候指的是实例</span>
    <span class="token literal-property property">props</span><span class="token operator">:</span> vnode<span class="token punctuation">.</span>props<span class="token punctuation">,</span>
    <span class="token literal-property property">child</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// 第一个子fiber</span>
    <span class="token literal-property property">sibling</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// 下一个兄弟fiber</span>
    <span class="token keyword">return</span><span class="token operator">:</span> returnFiber<span class="token punctuation">,</span> <span class="token comment">// 父节点</span>
    <span class="token comment">// 标记节点是什么类型的</span>
    <span class="token literal-property property">flags</span><span class="token operator">:</span> Placement<span class="token punctuation">,</span>
    <span class="token literal-property property">deletions</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// 要删除子节点 null或者[]</span>
    <span class="token literal-property property">index</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">//当前层级下的下标，从0开始</span>
    <span class="token comment">// 记录上一次的状态 函数组件和类组件不一样</span>
    <span class="token literal-property property">memorizedState</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token comment">// old fiber</span>
    <span class="token literal-property property">alternate</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> type <span class="token punctuation">}</span> <span class="token operator">=</span> vnode<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isStr</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 原生标签</span>
    fiber<span class="token punctuation">.</span>tag <span class="token operator">=</span> HostComponent<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFn</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 函数组件或者是类组件</span>
    fiber<span class="token punctuation">.</span>tag <span class="token operator">=</span> type<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>isComponent <span class="token operator">?</span> ClassComponent <span class="token operator">:</span> FunctionComponent<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndefined</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    fiber<span class="token punctuation">.</span>tag <span class="token operator">=</span> HostText<span class="token punctuation">;</span>
    fiber<span class="token punctuation">.</span>props <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">children</span><span class="token operator">:</span> vnode <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    fiber<span class="token punctuation">.</span>tag <span class="token operator">=</span> Fragment<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> fiber<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="fiber_121">
     </a>
     深度优先遍历每个fiber
    </h3>
    <p>
     对不同的类型节点tag，都有对应的处理方法
    </p>
    <pre><code class="prism language-javascript"><span class="token keyword">function</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> tag <span class="token punctuation">}</span> <span class="token operator">=</span> wip<span class="token punctuation">;</span>

  <span class="token keyword">switch</span> <span class="token punctuation">(</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 原生标签 比如div span button p a</span>
    <span class="token keyword">case</span> <span class="token literal-property property">HostComponent</span><span class="token operator">:</span>
      <span class="token function">updateHostComponent</span><span class="token punctuation">(</span>wip<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token literal-property property">FunctionComponent</span><span class="token operator">:</span>
      <span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span>wip<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token literal-property property">ClassComponent</span><span class="token operator">:</span>
      <span class="token function">updateClassComponent</span><span class="token punctuation">(</span>wip<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token literal-property property">Fragment</span><span class="token operator">:</span>
      <span class="token function">updateFragmentComponent</span><span class="token punctuation">(</span>wip<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token literal-property property">HostText</span><span class="token operator">:</span>
      <span class="token function">updateHostTextComponent</span><span class="token punctuation">(</span>wip<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>wip<span class="token punctuation">.</span>child<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    wip <span class="token operator">=</span> wip<span class="token punctuation">.</span>child<span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">let</span> next <span class="token operator">=</span> wip<span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>next<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>next<span class="token punctuation">.</span>sibling<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      wip <span class="token operator">=</span> next<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    next <span class="token operator">=</span> next<span class="token punctuation">.</span>return<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  wip <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="_163">
     </a>
     初次渲染
    </h3>
    <p>
     在react项目中我们都是通过以下方法来初始化组件
    </p>
    <pre><code class="prism language-javascript">ReactDOM<span class="token punctuation">.</span><span class="token function">createRoot</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>jsx<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     那我们就来实现一下该createRoot和render方法
    </p>
    <p>
     <strong>
      源码中的render是挂载到了原型对象上
     </strong>
    </p>
    <pre><code class="prism language-javascript"><span class="token comment">// react-dom</span>
<span class="token keyword">import</span> createFiber <span class="token keyword">from</span> <span class="token string">"./ReactFiber"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> scheduleUpdateOnFiber <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./ReactFiberWorkLoop"</span><span class="token punctuation">;</span>

<span class="token comment">// 构造函数</span>
<span class="token keyword">function</span> <span class="token function">ReactDOMRoot</span><span class="token punctuation">(</span><span class="token parameter">internalRoot</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_internalRoot <span class="token operator">=</span> internalRoot<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">ReactDOMRoot</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">render</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">children</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 最原始的vnode节点（jsx） 我们需要的是fiber结构的vnode</span>
  <span class="token keyword">const</span> root <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_internalRoot<span class="token punctuation">;</span>
  <span class="token comment">// 原生dom节点</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">updateContainer</span><span class="token punctuation">(</span>children<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 初次渲染 组件到g根dom节点上</span>
<span class="token keyword">function</span> <span class="token function">updateContainer</span><span class="token punctuation">(</span><span class="token parameter">element<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> containerInfo <span class="token punctuation">}</span> <span class="token operator">=</span> container<span class="token punctuation">;</span>
  <span class="token keyword">const</span> fiber <span class="token operator">=</span> <span class="token function">createFiber</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> containerInfo<span class="token punctuation">.</span>nodeName<span class="token punctuation">.</span><span class="token function">toLocaleLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">stateNode</span><span class="token operator">:</span> containerInfo<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 组件初次渲染</span>
  <span class="token function">scheduleUpdateOnFiber</span><span class="token punctuation">(</span>fiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">createRoot</span><span class="token punctuation">(</span><span class="token parameter">container</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> root <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">containerInfo</span><span class="token operator">:</span> container <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ReactDOMRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 一整个文件是ReactDOM, createRoot是ReactDOM上的一个方法</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{<!-- --></span> createRoot <span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre>
    <h3>
     <a id="scheduleUpdateOnFiber_211">
     </a>
     scheduleUpdateOnFiber方法实现
    </h3>
    <p>
     触发任务调度方法，来执行fiber的生成performUnitOfWork和commit提交两个步骤
    </p>
    <p>
     <em>
      <strong>
       scheduleCallback是借助了MessageChannel方法来从最小堆中取优先级最高的任务来执行，此处暂时表示执行workLoop方法
      </strong>
     </em>
    </p>
    <pre><code class="prism language-javascript"><span class="token comment">// import scheduleCallback from '...todo'</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">scheduleUpdateOnFiber</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  wip <span class="token operator">=</span> fiber<span class="token punctuation">;</span>
  wipRoot <span class="token operator">=</span> fiber<span class="token punctuation">;</span>
  <span class="token function">scheduleCallback</span><span class="token punctuation">(</span>workLoop<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// scheduleCallback(() =&gt; {<!-- --></span>
  <span class="token comment">//   console.log("scheduleCallback1");</span>
  <span class="token comment">// });</span>
  <span class="token comment">// scheduleCallback(() =&gt; {<!-- --></span>
  <span class="token comment">//   console.log("scheduleCallback2");</span>
  <span class="token comment">// });</span>
  <span class="token comment">// scheduleCallback(() =&gt; {<!-- --></span>
  <span class="token comment">//   console.log("scheduleCallback3");</span>
  <span class="token comment">// });</span>
  <span class="token comment">// scheduleCallback(() =&gt; {<!-- --></span>
  <span class="token comment">//   console.log("scheduleCallbac4");</span>
  <span class="token comment">// });</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">workLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">//协调</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>wip<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//提交</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>wip <span class="token operator">&amp;&amp;</span> wipRoot<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">commitWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <ol>
     <li>
      根据最原始的 vnode 节点（jsx） 调用 createFiber 方法生成我们需要的 fiber 结构的 vnode
      <br/>
      这一块已经实现了
     </li>
    </ol>
    <pre><code class="prism language-javascript"><span class="token keyword">const</span> fiber <span class="token operator">=</span> <span class="token function">createFiber</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> containerInfo<span class="token punctuation">.</span>nodeName<span class="token punctuation">.</span><span class="token function">toLocaleLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">stateNode</span><span class="token operator">:</span> containerInfo<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <ol start="2">
     <li>
      根据 fiber 上不同 tag 属性调用不同的 fiber 渲染方法 该方法里面调用了 reconcileChildren 方法（协调 children 生成 fiber 链表） 递归生成 fiber 单链表结构
     </li>
    </ol>
    <p>
     以函数组件为例：
    </p>
    <pre><code class="prism language-javascript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span><span class="token parameter">wip</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token function">renderWithHooks</span><span class="token punctuation">(</span>wip<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 函数组件的type是个函数 直接执行拿到children</span>
  <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> type<span class="token punctuation">,</span> props <span class="token punctuation">}</span> <span class="token operator">=</span> wip<span class="token punctuation">;</span>
  <span class="token comment">// 子节点</span>
  <span class="token keyword">const</span> children <span class="token operator">=</span> <span class="token function">type</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">reconcileChildren</span><span class="token punctuation">(</span>wip<span class="token punctuation">,</span> children<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     reconcileChildren方法就是协调，协调所有后代节点生成fiber单链表结构
    </p>
    <pre><code class="prism language-javascript"><span class="token comment">// 协调children生成fiber链表</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">reconcileChildren</span><span class="token punctuation">(</span><span class="token parameter">returnFiber<span class="token punctuation">,</span> children</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> newChildren <span class="token operator">=</span> <span class="token function">isArray</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span> <span class="token operator">?</span> children <span class="token operator">:</span> <span class="token punctuation">[</span>children<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// old fiber头节点</span>
  <span class="token keyword">let</span> oldFiber <span class="token operator">=</span> returnFiber<span class="token punctuation">.</span>alternate<span class="token operator">?.</span>child<span class="token punctuation">;</span>
  <span class="token comment">//   为啥去掉这句就不能渲染了 todo ...？ 现在不会了 但是会出现两个相同的元素</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isStringOrNumber</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 实现fiber的链表结构</span>
  <span class="token keyword">let</span> previousNewFiber <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> newIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>newIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> newIndex <span class="token operator">&lt;</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> newIndex<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> newChild <span class="token operator">=</span> newChildren<span class="token punctuation">[</span>newIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// 如果newChil为null,会在createFiber中报错</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newChild <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> newFiber <span class="token operator">=</span> <span class="token function">createFiber</span><span class="token punctuation">(</span>newChild<span class="token punctuation">,</span> returnFiber<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> same <span class="token operator">=</span> <span class="token function">sameNode</span><span class="token punctuation">(</span>newFiber<span class="token punctuation">,</span> oldFiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 更新复用</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>same<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>newFiber<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
        <span class="token literal-property property">stateNode</span><span class="token operator">:</span> oldFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">,</span>
        <span class="token literal-property property">alternate</span><span class="token operator">:</span> oldFiber<span class="token punctuation">,</span>
        <span class="token literal-property property">flags</span><span class="token operator">:</span> Update<span class="token punctuation">,</span> <span class="token comment">// 默认是Placement 新增</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>same <span class="token operator">&amp;&amp;</span> oldFiber<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 删除节点</span>
      <span class="token function">deleteChild</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> oldFiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ?? todo...</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldFiber<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      oldFiber <span class="token operator">=</span> oldFiber<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 第一个子fiber 好比nexIndex===0</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>previousNewFiber <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      returnFiber<span class="token punctuation">.</span>child <span class="token operator">=</span> newFiber<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      previousNewFiber<span class="token punctuation">.</span>sibling <span class="token operator">=</span> newFiber<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 记录一下上次的fiber</span>
    previousNewFiber <span class="token operator">=</span> newFiber<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>newIndex <span class="token operator">===</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">deleteRemainingChildren</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> oldFiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <ol start="4">
     <li>
      <p>
       处理完所有 fiber 和 子 fiber 后，开始往 root 节点里面进行递归提交，包括提交自己，第一个子节点，第一个子节点的兄弟节点（增删改查）的操作 调用了 commitRoot（commitWork）方法
      </p>
     </li>
     <li>
      <p>
       根据 flags 属性来判断是新增 还是更新 还是删除
      </p>
      <ol>
       <li>
        新增则调用 dom 元素的 appendChild 方法
       </li>
       <li>
        更新则根据新老节点对比 调用 updateNode 方法
       </li>
       <li>
        删除则调用 commitDeletion 通过 removeChild（父 dom 和子 dom）来删除
       </li>
      </ol>
     </li>
    </ol>
    <pre><code class="prism language-javascript"><span class="token keyword">function</span> <span class="token function">commitWork</span><span class="token punctuation">(</span><span class="token parameter">wip</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>wip<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 1.更新自己</span>
  <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> flags<span class="token punctuation">,</span> stateNode<span class="token punctuation">,</span> type <span class="token punctuation">}</span> <span class="token operator">=</span> wip<span class="token punctuation">;</span>
  <span class="token comment">// 追加</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> Placement <span class="token operator">&amp;&amp;</span> stateNode<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 函数组件prop.children的父级是函数组件名 再往上就是root根节点</span>
    <span class="token comment">// const parentNode = wip.return.stateNode;</span>
    <span class="token keyword">const</span> parentNode <span class="token operator">=</span> <span class="token function">getParentNode</span><span class="token punctuation">(</span>wip<span class="token punctuation">.</span>return<span class="token punctuation">)</span><span class="token punctuation">;</span>
    parentNode<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>stateNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 更新</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> Update <span class="token operator">&amp;&amp;</span> stateNode<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">updateNode</span><span class="token punctuation">(</span>stateNode<span class="token punctuation">,</span> wip<span class="token punctuation">.</span>alternate<span class="token punctuation">.</span>props<span class="token punctuation">,</span> wip<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 删除</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>wip<span class="token punctuation">.</span>deletions<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 通过父节点来删除</span>
    <span class="token function">commitDeletion</span><span class="token punctuation">(</span>wip<span class="token punctuation">.</span>deletions<span class="token punctuation">,</span> stateNode <span class="token operator">||</span> parentNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 2.更新子节点</span>
  <span class="token function">commitWork</span><span class="token punctuation">(</span>wip<span class="token punctuation">.</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 3.更新兄弟节点</span>
  <span class="token function">commitWork</span><span class="token punctuation">(</span>wip<span class="token punctuation">.</span>sibling<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <ol start="6">
     <li>
      初始化结束
     </li>
    </ol>
    <h4>
     <a id="_useStateuseReducer__370">
     </a>
     更新（更新操作无非就是 useState,useReducer 等改变了组件状态而导致更新）
    </h4>
    <p>
     所以在 hook 函数里 我们需要去调用 scheduleUpdateOnFiber 方法来出触发组件更新
     <br/>
     然后回到了上面初次渲染一样的逻辑
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c:6f672e6373646e2e6e65742f6c776c31323334353637385f2f:61727469636c652f64657461696c732f313436303738393935" class_="artid" style="display:none">
 </p>
</div>


