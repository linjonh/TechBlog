---
layout: post
title: "关于小程序网络数据请求延迟导致页面渲染失败问题"
date: 2023-02-23 11:59:03 +0800
description: "关于小程序网络数据请求延迟导致页面渲染失败问题解决方法： 定义回调函数示例代码app.js 文件in"
keywords: "promise未解决js请求返回不渲染问题"
categories: ['小程序', 'Javascript']
tags: ['无标签']
artid: "106219823"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=106219823
    alt: "关于小程序网络数据请求延迟导致页面渲染失败问题"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=106219823
featuredImagePreview: https://bing.ee123.net/img/rand?artid=106219823
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     关于小程序网络数据请求延迟导致页面渲染失败问题
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="./../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="./../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-kimbie-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <div class="toc">
     <h4>
      关于小程序网络数据请求延迟导致页面渲染失败问题
     </h4>
     <ul>
      <li>
       <a href="#_1" rel="nofollow">
        问题
       </a>
      </li>
      <li>
       <a href="#1__6" rel="nofollow">
        解决方法1： 定义回调函数
       </a>
      </li>
      <li>
       <ul>
        <li>
         <a href="#_10" rel="nofollow">
          示例代码
         </a>
        </li>
        <li>
         <ul>
          <li>
           <a href="#appjs__14" rel="nofollow">
            app.js 全局脚本文件
           </a>
          </li>
          <li>
           <a href="#indexjs__44" rel="nofollow">
            index.js 页面脚本文件
           </a>
          </li>
          <li>
           <a href="#indexwxml__82" rel="nofollow">
            index.wxml 页面渲染结构
           </a>
          </li>
          <li>
           <a href="#indexcss__96" rel="nofollow">
            index.css 页面样式文件
           </a>
          </li>
         </ul>
        </li>
       </ul>
      </li>
      <li>
       <a href="#2_promise__121" rel="nofollow">
        解决方法2：使用 promise 对象
       </a>
      </li>
     </ul>
    </div>
    <p>
    </p>
    <h2>
     <a id="_1">
     </a>
     问题
    </h2>
    <p>
     微信小程序 wx.request（ajax）网络请求默认为异步，当 wx.request 发出请求后，程序流程将继续向下执行，此时 wxml 页面若有服务器返回的数据绑定，将输出一个空白。当异步请求完毕数据返回后，wxml 页面已经渲染完毕，返回的数据并不会显示在页面。
    </p>
    <p>
     还有一种情况，在以 tabBar 结构的小程序里，当第一个页面正在执行 wx.request 数据请求，在外部数据返回页面前，用户快速切换到了其它 tabBar 页面，此时容易造成第一个页面数据返回中断。
    </p>
    <h2>
     <a id="1__6">
     </a>
     解决方法1： 定义回调函数
    </h2>
    <p>
     回调函数的运行逻辑是这样的，有 A → B 两个按顺序运行的过程，A 开始执行异步数据请求，B 需要 A 返回的数据渲染页面，可以在 B 中定义一个 A.callback 回调函数。当过程 A 成功返回数据后判断 this.callback 是否被定义，如果回调被定义，就说明 B 正需要这个数据，别犹豫了赶紧执行吧；如果数据返回后 A 没发现 this.callback 被定义，说明数据返回的太快了，B 还没开始产生需要呢，于是 A 把返回的数据存入手机缓存或全局变量里，等 B 需要的时候自己取。而 B 发现全局变量后，就无需再定义 A.callback 函数，当然即使定义了 A 也不会执行，因为 A 已经运行结束。
    </p>
    <h3>
     <a id="_10">
     </a>
     示例代码
    </h3>
    <p>
     用小程序开发工具默认的代码，优化后运行如下：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/02388e804d5154e0b39230db0e6bbd3a.png#pic_center"/>
    </p>
    <h4>
     <a id="appjs__14">
     </a>
     app.js 全局脚本文件
    </h4>
    <pre><code class="prism language-javascript"><span class="token comment">//app.js</span>
<span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
  onLaunch<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 获取用户头像和昵称信息，需要用户授权</span>
    wx<span class="token punctuation">.</span><span class="token function">getSetting</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      success<span class="token punctuation">:</span> res <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>authSetting<span class="token punctuation">[</span><span class="token string">'scope.userInfo'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 已经授权，可以直接调用 getUserInfo 获取头像昵称，不会弹框</span>
          wx<span class="token punctuation">.</span><span class="token function">getUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
            success<span class="token punctuation">:</span> res <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
              <span class="token comment">// 此处更新全局变量，但 index.onLoad 可能已经执行完毕</span>
              <span class="token keyword">this</span><span class="token punctuation">.</span>gbData<span class="token punctuation">.</span>userInfo <span class="token operator">=</span> res<span class="token punctuation">.</span>userInfo<span class="token punctuation">;</span>
              <span class="token comment">// 由于 getUserInfo 是网络请求，可能会在 index.onLoad 完成之后返回</span>
              <span class="token comment">// 所以此处判断回调函数是否被 index.onLoad 定义，如果定义则执行之</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>userInfoCallback<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">userInfoCallback</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  gbData<span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
    userInfo<span class="token punctuation">:</span> <span class="token keyword">null</span> <span class="token comment">// 存储用户的头像路径和昵称信息的全局变量</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
    <h4>
     <a id="indexjs__44">
     </a>
     index.js 页面脚本文件
    </h4>
    <pre><code class="prism language-javascript"><span class="token comment">//index.js</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">getApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">Page</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
  data<span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
    motto<span class="token punctuation">:</span> <span class="token string">'欢迎登录'</span><span class="token punctuation">,</span>
    userInfo<span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    hasUserInfo<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token comment">//如果用户未授权，则不能获取用户信息</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  onLoad<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 由于 app.js 中的 getUserInfo 是异步网络请求， 全局变量 userInfo</span>
    <span class="token comment">// 可能没有被返回的数据填充，所以必须在 else 中给 app 定义一个回调函数</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>app<span class="token punctuation">.</span>gbData<span class="token punctuation">.</span>userInfo<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
        userInfo<span class="token punctuation">:</span> app<span class="token punctuation">.</span>gbData<span class="token punctuation">.</span>userInfo<span class="token punctuation">,</span>
        hasUserInfo<span class="token punctuation">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 给 app 定义回调函数并在 app 中执行，接收 res 参数进行页面数据渲染</span>
      app<span class="token punctuation">.</span><span class="token function-variable function">userInfoCallback</span> <span class="token operator">=</span> res <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
          userInfo<span class="token punctuation">:</span> res<span class="token punctuation">.</span>userInfo<span class="token punctuation">,</span>
          hasUserInfo<span class="token punctuation">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 用户点击授权时响应函数，进行全局变量更新及页面数据渲染</span>
  <span class="token function">f0</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    app<span class="token punctuation">.</span>gbData<span class="token punctuation">.</span>userInfo <span class="token operator">=</span> e<span class="token punctuation">.</span>detail<span class="token punctuation">.</span>userInfo<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      userInfo<span class="token punctuation">:</span> app<span class="token punctuation">.</span>gbData<span class="token punctuation">.</span>userInfo<span class="token punctuation">,</span>
      hasUserInfo<span class="token punctuation">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
    <h4>
     <a id="indexwxml__82">
     </a>
     index.wxml 页面渲染结构
    </h4>
    <pre><code class="prism language-html"><span class="token comment">&lt;!--index.wxml--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>container<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>userinfo<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name"><span class="token namespace">wx:</span>if</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>{<!-- -->{!hasUserInfo}}<span class="token punctuation">"</span></span> <span class="token attr-name">open-type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>getUserInfo<span class="token punctuation">"</span></span> <span class="token attr-name">bindgetuserinfo</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>f0<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>获取头像昵称<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>block</span> <span class="token attr-name"><span class="token namespace">wx:</span>else</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>image</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>avatar<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>{<!-- -->{userInfo.avatarUrl}}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>image</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>text</span><span class="token punctuation">&gt;</span></span>{<!-- -->{userInfo.nickName}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>text</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>block</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span><span class="token punctuation">&gt;</span></span>{<!-- -->{motto}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
</code></pre>
    <h4>
     <a id="indexcss__96">
     </a>
     index.css 页面样式文件
    </h4>
    <pre><code class="prism language-css"><span class="token comment">/**index.wxss**/</span>
<span class="token selector">.container, .userinfo</span> <span class="token punctuation">{<!-- --></span>
  <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span>
  <span class="token property">flex-direction</span><span class="token punctuation">:</span> column<span class="token punctuation">;</span>
  <span class="token property">align-items</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.container</span> <span class="token punctuation">{<!-- --></span>
  <span class="token property">height</span><span class="token punctuation">:</span> 100vh<span class="token punctuation">;</span>
  <span class="token property">justify-content</span><span class="token punctuation">:</span> space-around<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.avatar</span> <span class="token punctuation">{<!-- --></span>
  <span class="token property">width</span><span class="token punctuation">:</span> 128rpx<span class="token punctuation">;</span>
  <span class="token property">height</span><span class="token punctuation">:</span> 128rpx<span class="token punctuation">;</span>
  <span class="token property">margin</span><span class="token punctuation">:</span> 20rpx<span class="token punctuation">;</span>
  <span class="token property">border-radius</span><span class="token punctuation">:</span> 50%<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     index.json 文件保留空对象 {} 即可。
     <br/>
     <strong>
      还有一种情况
     </strong>
     ，如果同时存在 C 过程也需要返回数据，并且在 C 定义了一个 A.callback，此时在 A 中执行 this.callback 将会产生一个线程错误。因此这种回调方法可以用在程序结构简单的地方。
    </p>
    <h2>
     <a id="2_promise__121">
     </a>
     解决方法2：使用 promise 对象
    </h2>
    <p>
     promise 是 ES6 的新增功能，小程序内核支持，功能强大，详见阮一峰大神的教程： https://es6.ruanyifeng.com/#docs/promise
    </p>
   </div>
   <link href="./../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="./../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470:733a2f2f626c6f672e6373646e2e6e65742f7978705f78612f:61727469636c652f64657461696c732f313036323139383233" class_="artid" style="display:none">
 </p>
</div>


