---
layout: post
title: "达梦数据库的备份还原"
date: 2024-12-03 21:48:50 +0800
description: "文章目录一、前言二、联机备份恢复（热备）（一）备份1.\t操作步骤-图形化方式2.\t操作步骤-SQL3"
keywords: "达梦覆盖导入"
categories: ['数据库']
tags: ['达梦', '数据库']
artid: "116331787"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=116331787
    alt: "达梦数据库的备份还原"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=116331787
featuredImagePreview: https://bing.ee123.net/img/rand?artid=116331787
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     达梦数据库的备份还原
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-dracula" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <div class="toc">
     <h4>
      文章目录
     </h4>
     <ul>
      <li>
       <ul>
        <li>
         <a href="#_1" rel="nofollow">
          一、前言
         </a>
        </li>
        <li>
         <a href="#_7" rel="nofollow">
          二、联机备份恢复（热备）
         </a>
        </li>
        <li>
         <ul>
          <li>
           <a href="#_9" rel="nofollow">
            （一）备份
           </a>
          </li>
          <li>
           <ul>
            <li>
             <ul>
              <li>
               <a href="#1%09_10" rel="nofollow">
                1. 操作步骤-图形化方式
               </a>
              </li>
              <li>
               <a href="#2%09SQL_25" rel="nofollow">
                2. 操作步骤-SQL
               </a>
              </li>
              <li>
               <a href="#3%09_35" rel="nofollow">
                3. 检查归档设置
               </a>
              </li>
              <li>
               <a href="#4%09_44" rel="nofollow">
                4. 数据备份
               </a>
              </li>
             </ul>
            </li>
           </ul>
          </li>
          <li>
           <a href="#_57" rel="nofollow">
            （二）恢复
           </a>
          </li>
         </ul>
        </li>
        <li>
         <a href="#dimpdexp_70" rel="nofollow">
          三、dimp/dexp备份
         </a>
        </li>
        <li>
         <ul>
          <li>
           <a href="#_81" rel="nofollow">
            （一）备份
           </a>
          </li>
          <li>
           <a href="#_85" rel="nofollow">
            （二）数据恢复
           </a>
          </li>
         </ul>
        </li>
       </ul>
      </li>
     </ul>
    </div>
    <p>
    </p>
    <h3>
     <a id="_1">
     </a>
     一、前言
    </h3>
    <p>
     数据备份是数据安全的重要保障，是数据库管理员必须进行的日常工作之一，拥有良好的备份习惯才能在数据库发生状况时确保数据不会发生遗失和进行后续的恢复还原工作。
     <br/>
     脱机备份使用的室DM的dmrman工具，在进行备份之前，先启动dmap服务以及确保实例是关闭的。这里不再叙述脱机备份，因为在日常项目工作中很少会去关闭数据库实例，而且备份是周期性的事项，经常关闭重启数据库实例肯定是不适合的，下面重点说下热备份，热备份主要分为俩种方式：
     <br/>
     1：达梦数据库提供的联机备份方式
     <br/>
     2：dmp文件备份
    </p>
    <h3>
     <a id="_7">
     </a>
     二、联机备份恢复（热备）
    </h3>
    <p>
     联机备份需要数据库实例启动，且数据库实例需要处于open状态，还要打开归档
    </p>
    <h4>
     <a id="_9">
     </a>
     （一）备份
    </h4>
    <h6>
     <a id="1%09_10">
     </a>
     1. 操作步骤-图形化方式
    </h6>
    <p>
     【1】打开数据库实例服务
    </p>
    <pre><code class="prism language-bash"><span class="token function">cd</span>  /home/dmdba/dmdms/bin
./DmServiceDMSERVER  start
</code></pre>
    <p>
     【2】状态转换为配置（mount）状态，并设值归档路径，直接手动填写Linux路径即可
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/8d0007f3cece26f514d9d51328a332d3.png"/>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/32c6e67d52b06483d55fbcd350308e49.png">
      <br/>
      【3】配置完成以后再将数据库切换为打开（open）状态
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/501cf60fbf3c924a3ef86ab789d421da.png"/>
     </img>
    </p>
    <h6>
     <a id="2%09SQL_25">
     </a>
     2. 操作步骤-SQL
    </h6>
    <pre><code class="prism language-sql"> <span class="token keyword">alter</span> <span class="token keyword">database</span> mount<span class="token punctuation">;</span>
 <span class="token keyword">alter</span> <span class="token keyword">database</span> <span class="token keyword">add</span> archivelog ‘<span class="token keyword">type</span><span class="token operator">=</span><span class="token keyword">local</span><span class="token punctuation">,</span>dest<span class="token operator">=</span><span class="token operator">/</span>home<span class="token operator">/</span>dmdba<span class="token operator">/</span>dmarch<span class="token punctuation">,</span>file_size<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span>space_limit<span class="token operator">=</span><span class="token number">0</span>’<span class="token punctuation">;</span>

 <span class="token keyword">alter</span> <span class="token keyword">database</span> archivelog<span class="token punctuation">;</span>

 <span class="token keyword">alter</span> <span class="token keyword">database</span> <span class="token keyword">open</span><span class="token punctuation">;</span>
</code></pre>
    <h6>
     <a id="3%09_35">
     </a>
     3. 检查归档设置
    </h6>
    <pre><code class="prism language-sql"><span class="token comment">--查看归档是否打开</span>
<span class="token keyword">select</span> arch_mode <span class="token keyword">from</span> v$<span class="token keyword">database</span><span class="token punctuation">;</span>
<span class="token comment">--查看归档日志信息</span>
<span class="token keyword">select</span> arch_name<span class="token punctuation">,</span>arch_type<span class="token punctuation">,</span>arch_dest <span class="token keyword">from</span> v$dm_arch_ini<span class="token punctuation">;</span>
</code></pre>
    <h6>
     <a id="4%09_44">
     </a>
     4. 数据备份
    </h6>
    <p>
     【数据库备份】
    </p>
    <pre><code class="prism language-sql"><span class="token keyword">BACKUP</span> <span class="token keyword">DATABASE</span> <span class="token keyword">FULL</span> BACKUPSET  <span class="token string">'/home/dmdbms/dmdata'</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     【表空间备份】
    </p>
    <pre><code class="prism language-sql"><span class="token keyword">backup</span> <span class="token keyword">tablespace</span> <span class="token string">"MAIN"</span> <span class="token keyword">full</span> <span class="token keyword">to</span> <span class="token string">"TS_MAIN_FULL_2021_05_01_17_03_22"</span> backupset <span class="token string">'/home/dmdba/dmdms/data/DAMENG/bak'</span><span class="token punctuation">;</span>
</code></pre>
    <h4>
     <a id="_57">
     </a>
     （二）恢复
    </h4>
    <p>
     【恢复表空间】
    </p>
    <pre><code class="prism language-sql"><span class="token keyword">restore</span> <span class="token keyword">tablespace</span> MAIN <span class="token keyword">from</span> backupset <span class="token string">'/home/dmdba/dmdms/data/DAMENG/bak'</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     【重启数据库实例】
    </p>
    <pre><code class="prism language-sql">cd  <span class="token operator">/</span>home<span class="token operator">/</span>dmdba<span class="token operator">/</span>dmdms<span class="token operator">/</span>bin
<span class="token punctuation">.</span><span class="token operator">/</span>DmServiceDMSERVER  restart
</code></pre>
    <h3>
     <a id="dimpdexp_70">
     </a>
     三、dimp/dexp备份
    </h3>
    <p>
     逻辑导出（dexp）
    </p>
    <p>
     逻辑导入（dimp）
    </p>
    <p>
     DM 数据库的两个命令行工具，分别用来实现对DM数据库的逻辑备份和逻辑还原。逻辑备份和逻辑还原都是在联机方式下完成，联机方式是指数据库服务器正常运行过程中进行的备份和还原。dexp和dimp 是DM数据库自带的工具，只要安装了 DM 数据库，就可以在安装目录的bin目录中找到
    </p>
    <p>
     逻辑导出和逻辑导入数据库对象分为四种级别：数据库级、用户级、模式级和表级。四种级别独立互斥，不能同时存在。
    </p>
    <p>
     一般的话在使用达梦数据库的时候，我们备份某个模式即可，既可以选择达梦管理工具导出也可以通过bin下的dimp脚本导出
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/15200f091bde0ac8c25b662ccdb5690f.png"/>
    </p>
    <h4>
     <a id="_81">
     </a>
     （一）备份
    </h4>
    <pre><code class="prism language-sql"><span class="token operator">/</span>home<span class="token operator">/</span>dmdba<span class="token operator">/</span>dmdms<span class="token operator">/</span>bin<span class="token operator">/</span>dexp <span class="token string">""</span><span class="token string">"SYSDBA"</span><span class="token string">""</span><span class="token operator">/</span><span class="token string">""</span><span class="token string">"SYSDBA"</span><span class="token string">""</span><span class="token variable">@192.168.100.1</span>:<span class="token number">5236</span> DIRECTORY<span class="token operator">=</span><span class="token operator">/</span>home<span class="token operator">/</span>dmdba<span class="token operator">/</span>dmp <span class="token keyword">FILE</span><span class="token operator">=</span>imp_exp<span class="token punctuation">.</span>dmp SCHEMAS<span class="token operator">=</span><span class="token string">"TEST"</span> <span class="token keyword">TABLESPACE</span><span class="token operator">=</span>Y <span class="token keyword">DROP</span><span class="token operator">=</span>N LOG<span class="token operator">=</span>exp_2021_05_01_17_16_34<span class="token punctuation">.</span>log LOG_WRITE<span class="token operator">=</span>N
</code></pre>
    <h4>
     <a id="_85">
     </a>
     （二）数据恢复
    </h4>
    <p>
     数据恢复可以通过dimp导入，其中DIRECTORY指向的是dmp备份文件位置，这里设置了恢复中如果表存在则覆盖TABLE_EXISTS_ACTION
    </p>
    <pre><code class="prism language-sql"><span class="token operator">/</span>home<span class="token operator">/</span>dmdba<span class="token operator">/</span>dmdms<span class="token operator">/</span>bin<span class="token operator">/</span>dimp <span class="token string">""</span><span class="token string">"SYSDBA"</span><span class="token string">""</span><span class="token operator">/</span><span class="token string">""</span><span class="token string">"SYSDBA"</span><span class="token string">""</span><span class="token variable">@192.168.220.247</span>:<span class="token number">5236</span> DIRECTORY<span class="token operator">=</span><span class="token operator">/</span>home<span class="token operator">/</span>dmdba<span class="token operator">/</span>dmp<span class="token operator">/</span><span class="token number">20210430</span> <span class="token keyword">FILE</span><span class="token operator">=</span>imp_exp<span class="token punctuation">.</span>dmp <span class="token keyword">FULL</span><span class="token operator">=</span>Y <span class="token keyword">IGNORE</span><span class="token operator">=</span>N COMPILE<span class="token operator">=</span>Y INDEXFIRST<span class="token operator">=</span>N TABLE_FIRST<span class="token operator">=</span>N COMMIT_ROWS<span class="token operator">=</span><span class="token number">5000</span> FAST_LOAD<span class="token operator">=</span>N TABLE_EXISTS_ACTION<span class="token operator">=</span><span class="token keyword">REPLACE</span> LOG<span class="token operator">=</span><span class="token operator">/</span>home<span class="token operator">/</span>dmdba<span class="token operator">/</span>dmp<span class="token operator">/</span><span class="token number">20210430</span> <span class="token operator">/</span>inport<span class="token punctuation">.</span>log LOG_WRITE<span class="token operator">=</span>N
</code></pre>
    <p>
     相对于使用联机备份，这一种也更为简单便捷，这也是我在项目中所使用的方式：
     <br/>
     【我的案例参考】
     <br/>
     1：通过SHELL脚本的方式执行数据备份，每天一次，每次的数据都保存，每次备份大约耗时20s
     <br/>
     2：定时通过Linux的crontab构建的
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f:2f626c6f672e6373646e2e6e65742f4f63746f70757332312f:61727469636c652f64657461696c732f313136333331373837" class_="artid" style="display:none">
 </p>
</div>


