---
layout: post
title: "go注册rpc接口"
date: 2025-03-11 14:31:11 +0800
description: "makeGRPCEndpoint 函数的目的是将一个 gRPC 服务方法封装为一个 endpoint.Endpoint 类型的函数。这个函数主要用于将 gRPC 请求转换为内部的服务调用，并处理相关的上下文和错误。这将生成两个文件：my.pb.go 和 my_grpc.pb.go。生成 gRPC 代码。"
keywords: "go注册rpc接口"
categories: ['Go']
tags: ['Rpc', 'Qt', 'Golang']
artid: "146178077"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146178077
    alt: "go注册rpc接口"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146178077
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146178077
cover: https://bing.ee123.net/img/rand?artid=146178077
image: https://bing.ee123.net/img/rand?artid=146178077
img: https://bing.ee123.net/img/rand?artid=146178077
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     go注册rpc接口
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     1.定义proto文件：
    </p>
    <pre><code>syntax = "proto3";

package pb;

service Service {
rpc RPC (Request) returns (Reply) {}
}

message Request {
	string Action  = 1;
	int64  TraceID = 2;
	string Payload = 3;
}

message Reply {
	int32  Code    = 1;
	int64  TraceID = 2;
	string Payload = 3;
}
</code></pre>
    <p>
     生成 gRPC 代码
     <br/>
     使用 protoc 编译器生成 Go 代码：
    </p>
    <p>
     protoc --go_out=. --go-grpc_out=. my.proto
     <br/>
     这将生成两个文件：my.pb.go 和 my_grpc.pb.go
    </p>
    <p>
     2.定义server:
     <br/>
     makeGRPCEndpoint 函数的目的是将一个 gRPC 服务方法封装为一个 endpoint.Endpoint 类型的函数。这个函数主要用于将 gRPC 请求转换为内部的服务调用，并处理相关的上下文和错误。
    </p>
    <pre><code class="prism language-go"><span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"context"</span>
	<span class="token string">"github.com/go-kit/kit/endpoint"</span>
	grpctransport <span class="token string">"github.com/go-kit/kit/transport/grpc"</span>
	<span class="token string">"sync"</span>
<span class="token punctuation">)</span>
<span class="token keyword">type</span> GRPCServer <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	RPC         <span class="token operator">*</span>grpctransport<span class="token punctuation">.</span>Server
	Mutex       <span class="token operator">*</span>sync<span class="token punctuation">.</span>Mutex
	Controllers <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>Controller
<span class="token punctuation">}</span>

<span class="token keyword">type</span> GRPCService <span class="token keyword">interface</span> <span class="token punctuation">{<!-- --></span>
	<span class="token function">GRPC</span><span class="token punctuation">(</span><span class="token operator">*</span>Request<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Reply<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">decodeRequest</span><span class="token punctuation">(</span><span class="token boolean">_</span> context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> req <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	greq <span class="token operator">:=</span> req<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>pb<span class="token punctuation">.</span>Request<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>Request<span class="token punctuation">{<!-- --></span>Action<span class="token punctuation">:</span> greq<span class="token punctuation">.</span>Action<span class="token punctuation">,</span> TraceID<span class="token punctuation">:</span> greq<span class="token punctuation">.</span>TraceID<span class="token punctuation">,</span> Payload<span class="token punctuation">:</span> greq<span class="token punctuation">.</span>Payload<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
<span class="token comment">//makeGRPCEndpoint 函数的主要作用是将 gRPC 请求转换为内部的服务调用，并处理相关的上下文和错误。它使用 defer 和 recover 机制来捕获和处理异常。这个函数通常用于将 gRPC 请求处理逻辑封装为一个 endpoint.Endpoint，以便在服务中统一处理</span>
<span class="token keyword">func</span> <span class="token function">makeGRPCEndpoint</span><span class="token punctuation">(</span>srv GRPCService<span class="token punctuation">)</span> endpoint<span class="token punctuation">.</span>Endpoint <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token boolean">_</span> context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> request <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>rep <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> utils<span class="token punctuation">.</span><span class="token function">ExceptionHandler</span><span class="token punctuation">(</span><span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Transport::makeGRPCEndpoint"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				rep <span class="token operator">=</span> <span class="token function">makeSystemErrorReply</span><span class="token punctuation">(</span>FAIL<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
				err <span class="token operator">=</span> <span class="token boolean">nil</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		req <span class="token operator">:=</span> request<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>Request<span class="token punctuation">)</span>
		rep<span class="token punctuation">,</span> err <span class="token operator">=</span> srv<span class="token punctuation">.</span><span class="token function">GRPC</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> <span class="token function">makeSystemErrorReply</span><span class="token punctuation">(</span>FAIL<span class="token punctuation">,</span> req<span class="token punctuation">.</span>TraceID<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> rep<span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">encodeReply</span><span class="token punctuation">(</span><span class="token boolean">_</span> context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> grep <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	rep <span class="token operator">:=</span> grep<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>Reply<span class="token punctuation">)</span>
	rp <span class="token operator">:=</span> <span class="token punctuation">(</span>rep<span class="token punctuation">.</span>Payload<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>pb<span class="token punctuation">.</span>Reply<span class="token punctuation">{<!-- --></span>Code<span class="token punctuation">:</span> rep<span class="token punctuation">.</span>Code<span class="token punctuation">,</span> TraceID<span class="token punctuation">:</span> rep<span class="token punctuation">.</span>TraceID<span class="token punctuation">,</span> Payload<span class="token punctuation">:</span> rp<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

</code></pre>
    <p>
     对注册controller的方法：
    </p>
    <pre><code class="prism language-go"><span class="token keyword">type</span> Request <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	Action    <span class="token builtin">string</span>      <span class="token string">`json:"Action"`</span>
	RequestId <span class="token builtin">string</span>      <span class="token string">`json:"RequestId,omitempty"`</span>
	TraceID   <span class="token builtin">int64</span>       <span class="token string">`json:"TraceID,omitempty"`</span>
	Payload   <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span> <span class="token string">`json:"Payload,omitempty"`</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Reply <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	Code    <span class="token builtin">int32</span>       <span class="token string">`json:"Code"`</span>
	TraceID <span class="token builtin">int64</span>       <span class="token string">`json:"TraceID,omitempty"`</span>
	Payload <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span> <span class="token string">`json:"Payload,omitempty"`</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Transport <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	HTTPServer  <span class="token operator">*</span>HTTPServer
	GRPCServer  <span class="token operator">*</span>GRPCServer
	HTTPAddress <span class="token builtin">string</span>
	GRPCAddress <span class="token builtin">string</span>
	EnableHTTP  <span class="token builtin">bool</span>
	EnableGRPC  <span class="token builtin">bool</span>
	Debug       <span class="token operator">*</span>Debug
	Otel        <span class="token operator">*</span>module<span class="token punctuation">.</span>OtelModule
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>this <span class="token operator">*</span>Request<span class="token punctuation">)</span> <span class="token function">GetLoggerFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>traceId <span class="token builtin">int64</span><span class="token punctuation">,</span> requestId <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> this<span class="token punctuation">.</span>TraceID<span class="token punctuation">,</span> this<span class="token punctuation">.</span>RequestId
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>this <span class="token operator">*</span>Reply<span class="token punctuation">)</span> <span class="token function">GetLoggerFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>traceId <span class="token builtin">int64</span><span class="token punctuation">,</span> requestId <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	traceId <span class="token operator">=</span> this<span class="token punctuation">.</span>TraceID

	<span class="token keyword">if</span> v3response<span class="token punctuation">,</span> ok <span class="token operator">:=</span> this<span class="token punctuation">.</span>Payload<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>V3ResponseWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">switch</span> res <span class="token operator">:=</span> v3response<span class="token punctuation">.</span>Response<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">case</span> <span class="token operator">*</span>V3ResponseSuc<span class="token punctuation">:</span>
			requestId <span class="token operator">=</span> res<span class="token punctuation">.</span>RequestId
		<span class="token keyword">case</span> <span class="token operator">*</span>V3ResponseERR<span class="token punctuation">:</span>
			requestId <span class="token operator">=</span> res<span class="token punctuation">.</span>RequestId
		<span class="token keyword">default</span><span class="token punctuation">:</span>
			<span class="token comment">//	Do nothing</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> traceId<span class="token punctuation">,</span> requestId
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NewTransport</span><span class="token punctuation">(</span>
	HTTPEnable <span class="token builtin">bool</span><span class="token punctuation">,</span>
	HTTPAddress <span class="token builtin">string</span><span class="token punctuation">,</span>
	GRPCEnable <span class="token builtin">bool</span><span class="token punctuation">,</span>
	GRPCAddress <span class="token builtin">string</span><span class="token punctuation">,</span>
	Exec <span class="token operator">*</span>common_service<span class="token punctuation">.</span>ConcurrentExecutorService<span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">*</span>Transport <span class="token punctuation">{<!-- --></span>
	Trans <span class="token operator">:=</span> <span class="token operator">&amp;</span>Transport<span class="token punctuation">{<!-- --></span>
		HTTPAddress<span class="token punctuation">:</span> HTTPAddress<span class="token punctuation">,</span>
		GRPCAddress<span class="token punctuation">:</span> GRPCAddress<span class="token punctuation">,</span>
		EnableHTTP<span class="token punctuation">:</span>  HTTPEnable<span class="token punctuation">,</span>
		EnableGRPC<span class="token punctuation">:</span>  GRPCEnable<span class="token punctuation">,</span>
		Debug<span class="token punctuation">:</span>       <span class="token boolean">nil</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> Trans<span class="token punctuation">.</span>EnableHTTP <span class="token punctuation">{<!-- --></span>
		Trans<span class="token punctuation">.</span>Debug <span class="token operator">=</span> <span class="token operator">&amp;</span>Debug<span class="token punctuation">{<!-- --></span>ExecService<span class="token punctuation">:</span> Exec<span class="token punctuation">}</span>
		Trans<span class="token punctuation">.</span>Debug<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		Trans<span class="token punctuation">.</span><span class="token function">registerHTTP</span><span class="token punctuation">(</span>
			TRANSPORT_DEFAULT_HTTP_PATH<span class="token punctuation">,</span>
			<span class="token function">makeHTTPEndpoint</span><span class="token punctuation">(</span>Trans<span class="token punctuation">)</span><span class="token punctuation">,</span>
			decodeHTTPRequest<span class="token punctuation">,</span>
			defaultEncodeHTTPReply<span class="token punctuation">,</span>
		<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> Trans<span class="token punctuation">.</span>EnableGRPC <span class="token punctuation">{<!-- --></span>
		Trans<span class="token punctuation">.</span><span class="token function">registerGRPC</span><span class="token punctuation">(</span>
			TRANSPORT_DEFAULT_GRPC_NAME<span class="token punctuation">,</span>
			<span class="token function">makeGRPCEndpoint</span><span class="token punctuation">(</span>Trans<span class="token punctuation">)</span><span class="token punctuation">,</span>
			decodeRequest<span class="token punctuation">,</span>
			encodeReply<span class="token punctuation">,</span>
		<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> Trans
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>o <span class="token operator">*</span>Transport<span class="token punctuation">)</span> <span class="token function">GetOtelModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>module<span class="token punctuation">.</span>OtelModule <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> o<span class="token punctuation">.</span>Otel <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		om<span class="token punctuation">,</span> err <span class="token operator">:=</span> module<span class="token punctuation">.</span><span class="token function">GetModuleManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetModule</span><span class="token punctuation">(</span><span class="token string">"module_otel"</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span>
		<span class="token punctuation">}</span>
		o<span class="token punctuation">.</span>Otel <span class="token operator">=</span> om<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>module<span class="token punctuation">.</span>OtelModule<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> o<span class="token punctuation">.</span>Otel
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>o <span class="token operator">*</span>Transport<span class="token punctuation">)</span> <span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> o<span class="token punctuation">.</span>EnableHTTP <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> utils<span class="token punctuation">.</span><span class="token function">ExceptionHandler</span><span class="token punctuation">(</span><span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Transport::Run::HTTPListener"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			listener<span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">Listen</span><span class="token punctuation">(</span><span class="token string">"tcp4"</span><span class="token punctuation">,</span> o<span class="token punctuation">.</span>HTTPAddress<span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
				log<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"Transport::Start::Listen(HTTP) %s fail"</span><span class="token punctuation">,</span> o<span class="token punctuation">.</span>HTTPAddress<span class="token punctuation">)</span>
				os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			log<span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">"HTTPRPC serve on %s successful"</span><span class="token punctuation">,</span> o<span class="token punctuation">.</span>HTTPAddress<span class="token punctuation">)</span>
			http<span class="token punctuation">.</span><span class="token function">Serve</span><span class="token punctuation">(</span>listener<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
			<span class="token keyword">defer</span> listener<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> o<span class="token punctuation">.</span>EnableGRPC <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> utils<span class="token punctuation">.</span><span class="token function">ExceptionHandler</span><span class="token punctuation">(</span><span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Transport::Run::GRPCListener"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			listener<span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">Listen</span><span class="token punctuation">(</span><span class="token string">"tcp"</span><span class="token punctuation">,</span> o<span class="token punctuation">.</span>GRPCAddress<span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
				log<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"Transport::Start::Listen(GRPC) %s fail"</span><span class="token punctuation">,</span> o<span class="token punctuation">.</span>GRPCAddress<span class="token punctuation">)</span>
				os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			s <span class="token operator">:=</span> grpc<span class="token punctuation">.</span><span class="token function">NewServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			reflection<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
			pb<span class="token punctuation">.</span><span class="token function">RegisterEMSServiceServer</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> o<span class="token punctuation">)</span>
			log<span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">"GRPC serve on %s successful"</span><span class="token punctuation">,</span> o<span class="token punctuation">.</span>GRPCAddress<span class="token punctuation">)</span>
			s<span class="token punctuation">.</span><span class="token function">Serve</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span>
			<span class="token keyword">defer</span> listener<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>o <span class="token operator">*</span>Transport<span class="token punctuation">)</span> <span class="token function">registerHTTP</span><span class="token punctuation">(</span>
	Name <span class="token builtin">string</span><span class="token punctuation">,</span>
	MakeEndpoint endpoint<span class="token punctuation">.</span>Endpoint<span class="token punctuation">,</span>
	DecodeRequest <span class="token keyword">func</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	EncodeReply <span class="token keyword">func</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		utils<span class="token punctuation">.</span><span class="token function">ExceptionHandler</span><span class="token punctuation">(</span><span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Transport::registerHTTP"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	Encoder <span class="token operator">:=</span> EncodeReply
	<span class="token keyword">if</span> Encoder <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		Encoder <span class="token operator">=</span> defaultEncodeHTTPReply
	<span class="token punctuation">}</span>
	o<span class="token punctuation">.</span>HTTPServer <span class="token operator">=</span> <span class="token operator">&amp;</span>HTTPServer<span class="token punctuation">{<!-- --></span>
		RPC<span class="token punctuation">:</span> httptransport<span class="token punctuation">.</span><span class="token function">NewServer</span><span class="token punctuation">(</span>
			MakeEndpoint<span class="token punctuation">,</span>
			DecodeRequest<span class="token punctuation">,</span>
			Encoder<span class="token punctuation">,</span>
		<span class="token punctuation">)</span><span class="token punctuation">,</span>
		Controllers<span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>Controller<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		Mutex<span class="token punctuation">:</span>       <span class="token operator">&amp;</span>sync<span class="token punctuation">.</span>Mutex<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	options <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>otelhttp<span class="token punctuation">.</span>Option<span class="token punctuation">{<!-- --></span>otelhttp<span class="token punctuation">.</span><span class="token function">WithSpanNameFormatter</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>operation <span class="token builtin">string</span><span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> operation <span class="token operator">+</span> r<span class="token punctuation">.</span>RequestURI
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
	http<span class="token punctuation">.</span><span class="token function">Handle</span><span class="token punctuation">(</span>Name<span class="token punctuation">,</span> otelhttp<span class="token punctuation">.</span><span class="token function">NewHandler</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>HTTPServer<span class="token punctuation">.</span>RPC<span class="token punctuation">,</span> <span class="token string">"woodpecker-ems"</span><span class="token punctuation">,</span> options<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>o <span class="token operator">*</span>Transport<span class="token punctuation">)</span> <span class="token function">RPC</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> req <span class="token operator">*</span>pb<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>pb<span class="token punctuation">.</span>Reply<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		utils<span class="token punctuation">.</span><span class="token function">ExceptionHandler</span><span class="token punctuation">(</span><span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Transport::RPC"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token boolean">_</span><span class="token punctuation">,</span> rep<span class="token punctuation">,</span> err <span class="token operator">:=</span> o<span class="token punctuation">.</span>GRPCServer<span class="token punctuation">.</span>RPC<span class="token punctuation">.</span><span class="token function">ServeGRPC</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> req<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"RPC.ServeGRPC Error: %s"</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> rep<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>pb<span class="token punctuation">.</span>Reply<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>o <span class="token operator">*</span>Transport<span class="token punctuation">)</span> <span class="token function">GRPC</span><span class="token punctuation">(</span>req <span class="token operator">*</span>Request<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Reply<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		utils<span class="token punctuation">.</span><span class="token function">ExceptionHandler</span><span class="token punctuation">(</span><span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Transport::GRPC"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// 1. Find the controller by action name.</span>
	controller<span class="token punctuation">,</span> exists <span class="token operator">:=</span> o<span class="token punctuation">.</span>GRPCServer<span class="token punctuation">.</span>Controllers<span class="token punctuation">[</span>req<span class="token punctuation">.</span>Action<span class="token punctuation">]</span>
	<span class="token keyword">if</span> exists <span class="token operator">==</span> <span class="token boolean">false</span> <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"[%d] Recieved (GRPC) request: %v with unknown action: %s"</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>TraceID<span class="token punctuation">,</span> req<span class="token punctuation">,</span> req<span class="token punctuation">.</span>Action<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token function">makeSystemErrorReply</span><span class="token punctuation">(</span>UNKNOWN_ACTION<span class="token punctuation">,</span> req<span class="token punctuation">.</span>TraceID<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 2. Decode request.</span>
	UserRequest <span class="token operator">:=</span> controller<span class="token punctuation">.</span><span class="token function">CreateRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	rp <span class="token operator">:=</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>Payload<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span>
	err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>rp<span class="token punctuation">)</span><span class="token punctuation">,</span> UserRequest<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token function">makeSystemErrorReply</span><span class="token punctuation">(</span>FAIL<span class="token punctuation">,</span> req<span class="token punctuation">.</span>TraceID<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 3. Process with the request.</span>
	code<span class="token punctuation">,</span> rep <span class="token operator">:=</span> controller<span class="token punctuation">.</span><span class="token function">Process</span><span class="token punctuation">(</span>UserRequest<span class="token punctuation">,</span> req<span class="token punctuation">.</span>TraceID<span class="token punctuation">)</span>

	<span class="token comment">// 4. Encode reply to payload.</span>
	payload<span class="token punctuation">,</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>rep<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token function">makeSystemErrorReply</span><span class="token punctuation">(</span>FAIL<span class="token punctuation">,</span> req<span class="token punctuation">.</span>TraceID<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>
	reply <span class="token operator">:=</span> <span class="token operator">&amp;</span>Reply<span class="token punctuation">{<!-- --></span>Code<span class="token punctuation">:</span> code<span class="token punctuation">,</span> TraceID<span class="token punctuation">:</span> req<span class="token punctuation">.</span>TraceID<span class="token punctuation">,</span> Payload<span class="token punctuation">:</span> <span class="token function">string</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">}</span>
	log<span class="token punctuation">.</span><span class="token function">Debugf</span><span class="token punctuation">(</span><span class="token string">"[%d] Recieved (GRPC) request: %v, Reply: %v"</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>TraceID<span class="token punctuation">,</span> req<span class="token punctuation">,</span> reply<span class="token punctuation">)</span>

	<span class="token keyword">return</span> reply<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>o <span class="token operator">*</span>Transport<span class="token punctuation">)</span> <span class="token function">HTTPRPC</span><span class="token punctuation">(</span>req <span class="token operator">*</span>Request<span class="token punctuation">)</span> <span class="token punctuation">(</span>rep <span class="token operator">*</span>Reply<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> utils<span class="token punctuation">.</span><span class="token function">ExceptionHandler</span><span class="token punctuation">(</span><span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Transport::HTTPRPC"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			rep <span class="token operator">=</span> <span class="token function">makeSystemErrorReply</span><span class="token punctuation">(</span>FAIL<span class="token punctuation">,</span> req<span class="token punctuation">.</span>TraceID<span class="token punctuation">)</span>
			err <span class="token operator">=</span> <span class="token boolean">nil</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	requestLogger <span class="token operator">:=</span> <span class="token function">NewRequestLogger</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span>

	<span class="token comment">// 1. Find the controller by action name.</span>
	controller<span class="token punctuation">,</span> exists <span class="token operator">:=</span> o<span class="token punctuation">.</span>HTTPServer<span class="token punctuation">.</span>Controllers<span class="token punctuation">[</span>req<span class="token punctuation">.</span>Action<span class="token punctuation">]</span>
	<span class="token keyword">if</span> exists <span class="token operator">==</span> <span class="token boolean">false</span> <span class="token punctuation">{<!-- --></span>
		requestLogger<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"Recieved (HTTP) request: with unknown action"</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token function">makeSystemErrorReply</span><span class="token punctuation">(</span>UNKNOWN_ACTION<span class="token punctuation">,</span> req<span class="token punctuation">.</span>TraceID<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 2. Decode request.</span>
	UserRequest <span class="token operator">:=</span> controller<span class="token punctuation">.</span><span class="token function">CreateRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	rp <span class="token operator">:=</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>Payload<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span>
	err <span class="token operator">=</span> json<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>rp<span class="token punctuation">)</span><span class="token punctuation">,</span> UserRequest<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"decode unmarshal err: %+v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token function">makeSystemErrorReply</span><span class="token punctuation">(</span>FAIL<span class="token punctuation">,</span> req<span class="token punctuation">.</span>TraceID<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 3. Process with the request.</span>
	code<span class="token punctuation">,</span> irep <span class="token operator">:=</span> controller<span class="token punctuation">.</span><span class="token function">Process</span><span class="token punctuation">(</span>UserRequest<span class="token punctuation">,</span> req<span class="token punctuation">.</span>TraceID<span class="token punctuation">)</span>
	reply <span class="token operator">:=</span> <span class="token operator">&amp;</span>Reply<span class="token punctuation">{<!-- --></span>Code<span class="token punctuation">:</span> code<span class="token punctuation">,</span> TraceID<span class="token punctuation">:</span> req<span class="token punctuation">.</span>TraceID<span class="token punctuation">,</span> Payload<span class="token punctuation">:</span> irep<span class="token punctuation">}</span>

	<span class="token keyword">if</span> log<span class="token punctuation">.</span><span class="token function">GetLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> log<span class="token punctuation">.</span>DebugLevel <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> s<span class="token punctuation">,</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>reply<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
			requestLogger<span class="token punctuation">.</span><span class="token function">Debugf</span><span class="token punctuation">(</span><span class="token string">"Recieved (HTTP) request: %+v, Reply: %+v"</span><span class="token punctuation">,</span> req<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
			requestLogger<span class="token punctuation">.</span><span class="token function">Debugf</span><span class="token punctuation">(</span><span class="token string">"Recieved (HTTP) request: %+v, Reply: %v"</span><span class="token punctuation">,</span> req<span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> reply<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">makeSystemErrorReply</span><span class="token punctuation">(</span>code <span class="token builtin">int32</span><span class="token punctuation">,</span> traceId <span class="token builtin">int64</span><span class="token punctuation">)</span> <span class="token operator">*</span>Reply <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>Reply<span class="token punctuation">{<!-- --></span>Code<span class="token punctuation">:</span> code<span class="token punctuation">,</span> TraceID<span class="token punctuation">:</span> traceId<span class="token punctuation">,</span> Payload<span class="token punctuation">:</span> <span class="token string">"{}"</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>o <span class="token operator">*</span>Transport<span class="token punctuation">)</span> <span class="token function">registerGRPC</span><span class="token punctuation">(</span>
	Name <span class="token builtin">string</span><span class="token punctuation">,</span>
	MakeEndpoint endpoint<span class="token punctuation">.</span>Endpoint<span class="token punctuation">,</span>
	DecodeRequest <span class="token keyword">func</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	EncodeReply <span class="token keyword">func</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		utils<span class="token punctuation">.</span><span class="token function">ExceptionHandler</span><span class="token punctuation">(</span><span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Transport::registerGRPC"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	o<span class="token punctuation">.</span>GRPCServer <span class="token operator">=</span> <span class="token operator">&amp;</span>GRPCServer<span class="token punctuation">{<!-- --></span>
		RPC<span class="token punctuation">:</span> grpctransport<span class="token punctuation">.</span><span class="token function">NewServer</span><span class="token punctuation">(</span>
			MakeEndpoint<span class="token punctuation">,</span>
			DecodeRequest<span class="token punctuation">,</span>
			EncodeReply<span class="token punctuation">,</span>
		<span class="token punctuation">)</span><span class="token punctuation">,</span>
		Controllers<span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>Controller<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		Mutex<span class="token punctuation">:</span>       <span class="token operator">&amp;</span>sync<span class="token punctuation">.</span>Mutex<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>o <span class="token operator">*</span>Transport<span class="token punctuation">)</span> <span class="token function">RegisterHTTPController</span><span class="token punctuation">(</span>actionName <span class="token builtin">string</span><span class="token punctuation">,</span> controller Controller<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		utils<span class="token punctuation">.</span><span class="token function">ExceptionHandler</span><span class="token punctuation">(</span><span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Transport::RegisterHTTPController"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> o<span class="token punctuation">.</span>EnableHTTP <span class="token operator">==</span> <span class="token boolean">false</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"RegisterHTTPController:ERROR: HTTP is not enable"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	o<span class="token punctuation">.</span>HTTPServer<span class="token punctuation">.</span>Mutex<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> o<span class="token punctuation">.</span>HTTPServer<span class="token punctuation">.</span>Mutex<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token boolean">_</span><span class="token punctuation">,</span> Exists <span class="token operator">:=</span> o<span class="token punctuation">.</span>HTTPServer<span class="token punctuation">.</span>Controllers<span class="token punctuation">[</span>actionName<span class="token punctuation">]</span>
	<span class="token keyword">if</span> Exists <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"Action(HTTPRPC) %s has registered"</span><span class="token punctuation">,</span> actionName<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> log<span class="token punctuation">.</span><span class="token function">GetLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> log<span class="token punctuation">.</span>DebugLevel <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Debugf</span><span class="token punctuation">(</span><span class="token string">"Register action: %s successful"</span><span class="token punctuation">,</span> actionName<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	o<span class="token punctuation">.</span>HTTPServer<span class="token punctuation">.</span>Controllers<span class="token punctuation">[</span>actionName<span class="token punctuation">]</span> <span class="token operator">=</span> controller
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>o <span class="token operator">*</span>Transport<span class="token punctuation">)</span> <span class="token function">RegisterGRPCController</span><span class="token punctuation">(</span>actionName <span class="token builtin">string</span><span class="token punctuation">,</span> controller Controller<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		utils<span class="token punctuation">.</span><span class="token function">ExceptionHandler</span><span class="token punctuation">(</span><span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Transport::RegisterGRPCController"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> o<span class="token punctuation">.</span>EnableGRPC <span class="token operator">==</span> <span class="token boolean">false</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"RegisterGRPCController:ERROR: GRPC is not enable"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	o<span class="token punctuation">.</span>GRPCServer<span class="token punctuation">.</span>Mutex<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> o<span class="token punctuation">.</span>GRPCServer<span class="token punctuation">.</span>Mutex<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token boolean">_</span><span class="token punctuation">,</span> Exists <span class="token operator">:=</span> o<span class="token punctuation">.</span>GRPCServer<span class="token punctuation">.</span>Controllers<span class="token punctuation">[</span>actionName<span class="token punctuation">]</span>
	<span class="token keyword">if</span> Exists <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"Action(GRPC) %s has registered"</span><span class="token punctuation">,</span> actionName<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	o<span class="token punctuation">.</span>GRPCServer<span class="token punctuation">.</span>Controllers<span class="token punctuation">[</span>actionName<span class="token punctuation">]</span> <span class="token operator">=</span> controller
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     创建这个transport:
    </p>
    <pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>o <span class="token operator">*</span>TransportModule<span class="token punctuation">)</span> <span class="token function">Create</span><span class="token punctuation">(</span>cfg <span class="token operator">*</span>config<span class="token punctuation">.</span>Config<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> o<span class="token punctuation">.</span>EnableHTTP <span class="token punctuation">{<!-- --></span>
		o<span class="token punctuation">.</span>HTTPAddress <span class="token operator">=</span> cfg<span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span>service<span class="token punctuation">.</span>SectionServer<span class="token punctuation">,</span> <span class="token string">"http.address"</span><span class="token punctuation">,</span> <span class="token string">"0.0.0.0:4022"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> o<span class="token punctuation">.</span>EnableGRPC <span class="token punctuation">{<!-- --></span>
		o<span class="token punctuation">.</span>GRPCAddress <span class="token operator">=</span> cfg<span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span>service<span class="token punctuation">.</span>SectionServer<span class="token punctuation">,</span> <span class="token string">"grpc.address"</span><span class="token punctuation">,</span> <span class="token string">"0.0.0.0:3022"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	log<span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">"enable.http: %t, http.address: %s, enable.grpc: %t, "</span><span class="token operator">+</span>
		<span class="token string">"grpc.address: %s"</span><span class="token punctuation">,</span> o<span class="token punctuation">.</span>EnableHTTP<span class="token punctuation">,</span> o<span class="token punctuation">.</span>HTTPAddress<span class="token punctuation">,</span> o<span class="token punctuation">.</span>EnableGRPC<span class="token punctuation">,</span> o<span class="token punctuation">.</span>GRPCAddress<span class="token punctuation">)</span>
	Exec<span class="token punctuation">,</span> Err <span class="token operator">:=</span> o<span class="token punctuation">.</span>Exec<span class="token punctuation">.</span><span class="token function">GetExecutorService</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> Err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> Err
	<span class="token punctuation">}</span>
	o<span class="token punctuation">.</span>Transport <span class="token operator">=</span> service<span class="token punctuation">.</span><span class="token function">NewTransport</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>EnableHTTP<span class="token punctuation">,</span> o<span class="token punctuation">.</span>HTTPAddress<span class="token punctuation">,</span> o<span class="token punctuation">.</span>EnableGRPC<span class="token punctuation">,</span> o<span class="token punctuation">.</span>GRPCAddress<span class="token punctuation">,</span> Exec<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     启动：
    </p>
    <pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>o <span class="token operator">*</span>TransportModule<span class="token punctuation">)</span> <span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
	o<span class="token punctuation">.</span>Transport<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

</code></pre>
    <p>
     之后启动这个rpc模块：
    </p>
    <pre><code class="prism language-go">	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> moduleinfo <span class="token operator">:=</span> <span class="token keyword">range</span> this<span class="token punctuation">.</span>moduleList <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"run module:%s ..."</span><span class="token punctuation">,</span> moduleinfo<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>minfo <span class="token operator">*</span>moduleInfo<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			this<span class="token punctuation">.</span>errorChan <span class="token operator">&lt;-</span> <span class="token operator">&amp;</span>moduleErrInfo<span class="token punctuation">{<!-- --></span>
				err<span class="token punctuation">:</span>    minfo<span class="token punctuation">.</span>module<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
				module<span class="token punctuation">:</span> minfo<span class="token punctuation">.</span>module<span class="token punctuation">,</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">(</span>moduleinfo<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
</code></pre>
    <p>
     注册rpc接口：
    </p>
    <pre><code class="prism language-go"><span class="token boolean">_</span> <span class="token operator">=</span> o<span class="token punctuation">.</span>Transport<span class="token punctuation">.</span><span class="token function">GetTransportService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">RegisterGRPCController</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>ActionQueryInstanceID<span class="token punctuation">,</span>
			<span class="token operator">&amp;</span>controllers<span class="token punctuation">.</span>QueryInstanceIDController<span class="token punctuation">{<!-- --></span>DBSrv<span class="token punctuation">:</span> dbService<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f34313335383537342f:61727469636c652f64657461696c732f313436313738303737" class_="artid" style="display:none">
 </p>
</div>


