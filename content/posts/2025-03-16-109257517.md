---
layout: post
title: "并发基础三大问题可见性原子性有序性"
date: 2025-03-16 23:08:33 +0800
description: "文章目录可见性原子性有序性（指令重排）经典的指令重排案例：单例模式的双重检查锁volatile和synchronize都可以保证有序性并发压测工具Jcstress证明指令重排会在多线程下出现问题（了解）CPU缓存分为三个级别：L1、L2、L3寄存器缓存和寄存器的区别JMM（java memory modle）可见性原子性并发编程时，当一个线程对共享变量的修改操作进行到一半时，另一个线程也可能来操作共享变量，这时就会干扰前一个线程的操作，这也就是原子性问题。public class AtomicDem"
keywords: "并发基础—三大问题：可见性、原子性、有序性"
categories: ['未分类']
tags: ['Android']
artid: "109257517"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=109257517
    alt: "并发基础三大问题可见性原子性有序性"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=109257517
featuredImagePreview: https://bing.ee123.net/img/rand?artid=109257517
cover: https://bing.ee123.net/img/rand?artid=109257517
image: https://bing.ee123.net/img/rand?artid=109257517
img: https://bing.ee123.net/img/rand?artid=109257517
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     并发基础—三大问题：可见性、原子性、有序性
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <p>
    </p>
    <h2>
     <a id="_1">
     </a>
     可见性
    </h2>
    <h2>
     <a id="_2">
     </a>
     原子性
    </h2>
    <p>
     并发编程时，当一个线程对共享变量的修改操作进行到一半时，另一个线程也可能来操作共享变量，这时就会干扰前一个线程的操作，这也就是原子性问题。
    </p>
    <pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AtomicDemo</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Thread</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    num<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
            thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        list<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>e <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                e<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                ex<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     <strong>
      上面代码的运行结果不一定是5000,原因分析如下：
     </strong>
     <br/>
     i++编译后对应的JVM指令实际有4条，当只执行了部分操作时，另一个线程同时操作i变量，就会出现原子性问题
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/2fb5cbae93c8c5753c5f2307929b0453.png#pic_center"/>
    </p>
    <h2>
     <a id="_34">
     </a>
     有序性（指令重排）
    </h2>
    <p>
     指令重排：为了保证程序的执行效率，在不影响正确性的前提下，编译器和CPU会对程序中代码进行优化，即指令重排序
    </p>
    <ul>
     <li>
      <font color="red">
       <strong>
        指令重排必须保证单线程情况下程序的运行结果是正确的
       </strong>
      </font>
     </li>
     <li>
      <font color="red">
       <strong>
        指令重排在多线程下可能会影响程序运行结果的正确性。
       </strong>
      </font>
     </li>
    </ul>
    <h3>
     <a id="_38">
     </a>
     经典的指令重排案例：单例模式的双重检查锁
    </h3>
    <h3>
     <a id="volatilesynchronize_40">
     </a>
     volatile和synchronize都可以保证有序性
    </h3>
    <ul>
     <li>
      synchronize：保证了只有一个线程在操作同步代码块内的代码，而指令重排在单线程的情况下运行结果是正确的
     </li>
    </ul>
    <h3>
     <a id="Jcstress_44">
     </a>
     并发压测工具Jcstress证明指令重排会在多线程下出现问题（了解）
    </h3>
    <pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.openjdk.jcstress<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jcstress-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.7<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre>
    <pre><code class="prism language-java"><span class="token comment">/**
* 需求：测试指令重排导致程序结果异常情况
* 方法test2中,有可能 flag=true先执行，而num=2后执行，位置交换导致出现方法test1结果r.r1=0
*/</span>
<span class="token annotation punctuation">@JCStressTest</span>
<span class="token comment">//表示对输出结果的处理  Expect.ACCEPTABLE 可以接收的结果</span>
<span class="token annotation punctuation">@Outcome</span><span class="token punctuation">(</span>id <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token string">"4"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> expect <span class="token operator">=</span> <span class="token class-name">Expect</span><span class="token punctuation">.</span><span class="token constant">ACCEPTABLE</span><span class="token punctuation">,</span> desc <span class="token operator">=</span> <span class="token string">"ok"</span><span class="token punctuation">)</span>
<span class="token comment">//Expect.ACCEPTABLE_INTERESTING 表示可以接收，并感兴趣的结果</span>
<span class="token annotation punctuation">@Outcome</span><span class="token punctuation">(</span>id <span class="token operator">=</span> <span class="token string">"0"</span><span class="token punctuation">,</span> expect <span class="token operator">=</span> <span class="token class-name">Expect</span><span class="token punctuation">.</span><span class="token constant">ACCEPTABLE_INTERESTING</span><span class="token punctuation">,</span> desc <span class="token operator">=</span> <span class="token string">"danger"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@State</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> jcstress <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token comment">//线程1执行的代码</span>
    <span class="token annotation punctuation">@Actor</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test1</span><span class="token punctuation">(</span><span class="token class-name">I_Result</span> r<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            r<span class="token punctuation">.</span>r1 <span class="token operator">=</span> num <span class="token operator">+</span> num<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            r<span class="token punctuation">.</span>r1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//线程2执行的代码</span>
    <span class="token annotation punctuation">@Actor</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test2</span><span class="token punctuation">(</span><span class="token class-name">I_Result</span> r<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        num <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
        flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/b3332b4f44dd34e5e4725ca8cb3b0426.png#pic_center"/>
    </p>
    <h3>
     <a id="CPUL1L2L3_86">
     </a>
     CPU缓存分为三个级别：L1、L2、L3
    </h3>
    <p>
     CPU的运算速度和内存的访问速度相差比较大，导致CPU每次操作内存都需要耗费大量的等待时间，于是CPU和内存直接增加了缓存设计。
    </p>
    <p>
     （1）L1（一级缓存）是最接近CPU的，三个缓存中它容量最小，速度最快，每个物理内核上都有个一级缓存L1
     <br/>
     （2）L2（二级缓存）速度比L1慢，比L3快，一般情况下每个物理核上都有一个独立的L2
     <br/>
     （3）L3（三级缓存）是三个缓存中最大的，同时也是速度最慢的，同一个CPU插槽上的核共用一个三级缓存
    </p>
    <h3>
     <a id="_92">
     </a>
     寄存器
    </h3>
    <p>
     CPU和一级缓存之间还有寄存器，CPU经常使用同一内存地址的某数据时 ，为减少频繁读取的消耗，就会把该数据存储到寄存器。
    </p>
    <h3>
     <a id="_94">
     </a>
     缓存和寄存器的区别
    </h3>
    <p>
     （1）缓存是把CPU需要的数据提前缓存起来，减少读取的消耗，但不一定是经常使用的
     <br/>
     （2）寄存器是把CPU经常使用的同一内存地址的数据缓存起来，减少读取消耗
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/86f651b64682c90802293b5e9462f488.png#pic_center">
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/42d3f4f30ef671150a35436c4add2ace.png#pic_center"/>
     </img>
    </p>
    <h4>
     <a id="JMMjava_memory_modle_99">
     </a>
     JMM（java memory modle）
    </h4>
    <p>
     <font color="red">
      <strong>
       java内存模型和java内存结构不是一回事，java内存模型用于多线程读写共享数据时，保证共享数据的可见性、有序性、原子性，主要是通过synchronize、volatile两个关键字来实现
      </strong>
     </font>
    </p>
    <p>
     （1）主内存：主内存是所有线程都能访问，所有共享变量都存储在主内存—方法区和堆
     <br/>
     （2）工作内存：每个线程都有自己的工作内存，只存储该线程需要用到的共享变量的副本，线程对变量的所有操作都是工作内存完成的，而不是直接读写主内存的变量，不同线程之间也不能相互访问工作内存中的变量。
     <br/>
     （3）jMM内存模型和硬件内存不是一回事，它是一个抽象的概念，不管是工作内存的数据还是主内存的数据，即可能存储到内存，也可能存到CPU的三级缓存或者寄存器中。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/cee307e8b816e1f5ef47caf1348cd9cd.png#pic_center"/>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a:2f2f626c6f672e6373646e2e6e65742f75736572323032352f:61727469636c652f64657461696c732f313039323537353137" class_="artid" style="display:none">
 </p>
</div>


