---
layout: post
title: "HTTP协议应用层协议HTTP从入门到深刻理解并落地部署自己的云服务2实操部署"
date: 2025-03-08 18:16:36 +0800
description: "[HTTP协议]应用层协议HTTP从入门到深刻理解并落地部署自己的云服务(2)HTTP服务器设计样例一、无法拷贝类(class uncopyable)的设计二、锁的RAII设计三、基于RAII模式和互斥锁的的日志系统设计四、网络地址信息的封装管理五、基于OOP和RAII模式管理网络套接字六、下层TCP服务器类的设计七、服务器main函数设计八、应用层HTTP服务器的设计"
keywords: "[HTTP协议]应用层协议HTTP从入门到深刻理解并落地部署自己的云服务(2)实操部署"
categories: ['Linux']
tags: ['运维', '网络协议', '网络', '服务器架构', '服务器', 'Linux', 'Http']
artid: "146114051"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146114051
    alt: "HTTP协议应用层协议HTTP从入门到深刻理解并落地部署自己的云服务2实操部署"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146114051
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146114051
cover: https://bing.ee123.net/img/rand?artid=146114051
image: https://bing.ee123.net/img/rand?artid=146114051
img: https://bing.ee123.net/img/rand?artid=146114051
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     [HTTP协议]应用层协议HTTP从入门到深刻理解并落地部署自己的云服务(2)实操部署
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="./../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="./../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-tomorrow-night" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     <strong>
      标题：[HTTP协议]应用层协议HTTP从入门到深刻理解并落地部署自己的云服务(2)实操部署
      <br/>
      @水墨不写bug
     </strong>
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/73c0cb11cf074412bdf38e73b0146f8b.jpeg#pic_center"/>
    </p>
    <hr/>
    <p>
    </p>
    <p>
    </p>
    <hr/>
    <blockquote>
     <p>
      <strong>
       本文将解释并实现一个HTTP服务器，从实现原理到细节分析都有讲解。
       <br/>
       分模块化设计让代码逻辑清晰，易维护；
      </strong>
     </p>
    </blockquote>
    <h2>
     <a id="class_uncopyable_11">
     </a>
     一、无法拷贝类(class uncopyable)的设计
    </h2>
    <blockquote>
     <p>
      <strong>
       为了驳回编译器暗自提供的功能，我们需要把相应的成员函数声明为private，并且不予实现。如果直接调用，报出编译错误；如果在其他成员函数/友元函数中调用，报出链接错误。
      </strong>
     </p>
    </blockquote>
    <p>
     <code>
      [援引自《Effective C++》by Scott Meyers 条款6：若不想使用编译器自动生成的函数，就该明确拒绝]。
     </code>
    </p>
    <p>
     <strong>
      于是，我们就需要设计出如下的不可拷贝类，来拒绝编译器的某些机能：
     </strong>
    </p>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">once</span></span>

<span class="token comment">// 继承这个类的任何类都无法实现拷贝操作</span>
<span class="token keyword">class</span> <span class="token class-name">uncopyable</span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">protected</span><span class="token operator">:</span>
    <span class="token function">uncopyable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>
    <span class="token operator">~</span><span class="token function">uncopyable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token function">uncopyable</span><span class="token punctuation">(</span><span class="token keyword">const</span> uncopyable <span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>
    uncopyable <span class="token operator">&amp;</span><span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> uncopyable <span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <blockquote>
     <p>
      <strong>
       这个代码设计实现了一个不可拷贝（uncopyable）类。继承这个类的任何类都无法进行拷贝操作。
      </strong>
     </p>
    </blockquote>
    <h4>
     <a id="_38">
     </a>
     解释：
    </h4>
    <ol>
     <li>
      <p>
       <strong>
        类声明：
       </strong>
      </p>
      <ul>
       <li>
        <code>
         class uncopyable
        </code>
        是一个基类，设计用于防止派生类对象进行拷贝操作。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        构造函数和析构函数：
       </strong>
      </p>
      <ul>
       <li>
        <code>
         protected
        </code>
        访问控制符使得构造函数和析构函数只能在派生类中访问。这意味着这个类不能被直接实例化，只能被继承。
       </li>
       <li>
        <code>
         uncopyable()
        </code>
        是默认构造函数。
       </li>
       <li>
        <code>
         ~uncopyable()
        </code>
        是析构函数。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        删除拷贝构造函数和拷贝赋值运算符：
       </strong>
      </p>
      <ul>
       <li>
        <code>
         uncopyable(const uncopyable &amp;) = delete;
        </code>
        删除了拷贝构造函数，防止对象通过拷贝构造函数进行拷贝。
       </li>
       <li>
        <code>
         uncopyable &amp;operator=(const uncopyable &amp;) = delete;
        </code>
        删除了拷贝赋值运算符，防止对象通过赋值操作进行拷贝。
       </li>
      </ul>
     </li>
    </ol>
    <h4>
     <a id="_52">
     </a>
     重要思想：
    </h4>
    <ul>
     <li>
      <p>
       <strong>
        防止拷贝：
       </strong>
       通过删除拷贝构造函数和拷贝赋值运算符，任何派生自
       <code>
        uncopyable
       </code>
       类的对象都无法进行拷贝。
      </p>
     </li>
     <li>
      <p>
       <strong>
        继承机制：
       </strong>
       使用
       <code>
        protected
       </code>
       访问控制符，使得
       <code>
        uncopyable
       </code>
       类不能直接实例化，但可以被其他类继承。这种设计模式经常被称为“不可拷贝基类”（Non-Copyable Base Class）模式。
      </p>
     </li>
    </ul>
    <h4>
     <a id="_58">
     </a>
     使用示例
    </h4>
    <pre><code class="prism language-cpp"><span class="token keyword">class</span> <span class="token class-name">exClass</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">private</span> <span class="token class-name">uncopyable</span></span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">exClass</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token comment">// 其他成员函数</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    exClass obj1<span class="token punctuation">;</span>
    <span class="token comment">// exClass obj2 = obj1; // 错误：拷贝构造函数被删除</span>
    <span class="token comment">// exClass obj3;</span>
    <span class="token comment">// obj3 = obj1; // 错误：拷贝赋值运算符被删除</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     在这个示例中，
     <code>
      exClass
     </code>
     继承自
     <code>
      uncopyable
     </code>
     ，因此
     <code>
      exClass
     </code>
     的对象不能被拷贝或赋值。这确保了
     <code>
      exClass
     </code>
     对象的独占性和唯一性。
    </p>
    <blockquote>
     <p>
      <strong>
       我们设计这个类的最终目的就是防止服务器对象被拷贝。
      </strong>
     </p>
    </blockquote>
    <h2>
     <a id="RAII_82">
     </a>
     二、锁的RAII设计
    </h2>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">once</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span>

<span class="token comment">// 使用锁需要频繁调用系统调用，十分麻烦</span>
<span class="token comment">// 于是实现锁的RAII设计</span>
<span class="token keyword">class</span> <span class="token class-name">LockGuard</span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">private</span><span class="token operator">:</span>
    pthread_mutex_t <span class="token operator">*</span><span class="token function">GetMutex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> _mutex<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token comment">// 构造函数，接收一个pthread_mutex_t类型的指针，并在构造函数中加锁</span>
    <span class="token function">LockGuard</span><span class="token punctuation">(</span>pthread_mutex_t<span class="token operator">*</span> mutex<span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token function">_mutex</span><span class="token punctuation">(</span>mutex<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span>_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 析构函数，在对象销毁时解锁</span>
    <span class="token operator">~</span><span class="token function">LockGuard</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span>_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token comment">// 指向pthread_mutex_t类型的指针</span>
    pthread_mutex_t <span class="token operator">*</span>_mutex<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/*
 *之前的理解错误了：不需要init和destroy，因为锁本身就是存在的！
 *锁在一般情况下会内置在类的内部，需要使用（加锁）的时候，把锁的地址传进来就行了
 *在构造函数内加锁，析构函数内解锁。
 *e.g.
 while(ture)
 {
    LockGuard lockguard(td-&gt;_mutex);
    if(tickets &gt; 0)
    {
        // 抢票
    }
    else
    {
        break;
    }
 }
 *while内每一次进行循环，都需要创建一个新的锁，创建即加锁，if代码块结束即为解锁
 */</span>
</code></pre>
    <p>
     这段代码实现了一个基于
     <code>
      RAII（Resource Acquisition Is Initialization）
     </code>
     模式的锁保护类
     <code>
      LockGuard
     </code>
     ，用于简化多线程编程中的锁操作。
    </p>
    <h4>
     <a id="_134">
     </a>
     解释
    </h4>
    <ol>
     <li>
      <p>
       <strong>
        类声明：
       </strong>
      </p>
      <ul>
       <li>
        <code>
         class LockGuard
        </code>
        是一个封装了
        <code>
         pthread_mutex_t
        </code>
        锁操作的类，使用 RAII 模式来管理锁的生命周期。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        构造函数：
       </strong>
      </p>
      <ul>
       <li>
        <code>
         LockGuard(pthread_mutex_t* mutex)
        </code>
        是构造函数，接收一个
        <code>
         pthread_mutex_t*
        </code>
        类型的指针，并在构造函数中调用
        <code>
         pthread_mutex_lock
        </code>
        来加锁。这确保了在创建
        <code>
         LockGuard
        </code>
        对象时，锁自动被加上。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        析构函数：
       </strong>
      </p>
      <ul>
       <li>
        <code>
         ~LockGuard()
        </code>
        是析构函数，在对象销毁时调用
        <code>
         pthread_mutex_unlock
        </code>
        来解锁。这确保了当
        <code>
         LockGuard
        </code>
        对象的生命周期结束时，锁自动被释放。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        私有成员变量：
       </strong>
      </p>
      <ul>
       <li>
        <code>
         pthread_mutex_t *_mutex
        </code>
        是一个指向
        <code>
         pthread_mutex_t
        </code>
        类型的指针，用于存储传入的锁对象。
       </li>
      </ul>
     </li>
    </ol>
    <h4>
     <a id="_147">
     </a>
     重要考虑
    </h4>
    <ul>
     <li>
      <p>
       <strong>
        RAII 模式：
       </strong>
       <code>
        RAII（Resource Acquisition Is Initialization）
       </code>
       是一种管理资源的编程技巧，它将资源的获取和释放绑定到对象的生命周期中。在
       <code>
        LockGuard
       </code>
       中，构造函数获取锁（加锁），析构函数释放锁（解锁），这确保了锁的正确管理和避免忘记解锁的错误。
      </p>
     </li>
     <li>
      <p>
       <strong>
        简化锁操作：
       </strong>
       传统的pthread库的锁操作需要显式调用
       <code>
        pthread_mutex_lock
       </code>
       和
       <code>
        pthread_mutex_unlock
       </code>
       ，这不仅繁琐而且容易出错。通过
       <code>
        LockGuard
       </code>
       的封装，用户只需在需要加锁的代码块中创建一个
       <code>
        LockGuard
       </code>
       对象，锁操作将自动管理。
      </p>
     </li>
    </ul>
    <h4>
     <a id="_153">
     </a>
     使用示例
    </h4>
    <pre><code class="prism language-cpp"><span class="token keyword">class</span> <span class="token class-name">GetTicket</span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">GetTicket</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">tickets</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">pthread_mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token operator">~</span><span class="token function">GetTicket</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">pthread_mutex_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//传入要管理的锁的地址</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">Tickets</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            LockGuard <span class="token function">lockguard</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>tickets <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 抢票</span>
                <span class="token operator">--</span>tickets<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">int</span> tickets<span class="token punctuation">;</span>
    pthread_mutex_t mutex<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     在这个示例中，
     <code>
      GetTicket
     </code>
     类管理票的分发。
     <code>
      LockGuard
     </code>
     确保在
     <code>
      Tickets
     </code>
     方法中，
     <code>
      tickets
     </code>
     自减的操作是线程安全的。每次循环迭代都会创建一个新的
     <code>
      LockGuard
     </code>
     对象，自动加锁和解锁，确保代码块内的操作是互斥的。
    </p>
    <blockquote>
     <p>
      <strong>
       这个模块的设计是为了简化pthread库的对锁的管理操作，从而确保线程间的互斥关系。
      </strong>
     </p>
    </blockquote>
    <h2>
     <a id="RAII_193">
     </a>
     三、基于RAII模式和互斥锁的的日志系统设计
    </h2>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">once</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;ctime&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstdarg&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fstream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstring&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"LockGuard.hpp"</span></span>

<span class="token keyword">namespace</span> log_ddsm
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 日志信息管理</span>
    <span class="token keyword">enum</span> <span class="token class-name">LEVEL</span>
    <span class="token punctuation">{<!-- --></span>
        DEBUG <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>   <span class="token comment">// 调试信息</span>
        INFO <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>    <span class="token comment">// 提示信息</span>
        WARNING <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token comment">// 警告</span>
        ERROR <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span>   <span class="token comment">// 错误，但是不影响服务正常运行</span>
        FATAL <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span>   <span class="token comment">// 致命错误，服务无法正常运行</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">enum</span> 
    <span class="token punctuation">{<!-- --></span>
        TIMESIZE <span class="token operator">=</span> <span class="token number">128</span><span class="token punctuation">,</span>
        LOGSIZE <span class="token operator">=</span> <span class="token number">1024</span><span class="token punctuation">,</span>
        FILE_TYPE_LOG_SIZE <span class="token operator">=</span> <span class="token number">2048</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">enum</span> 
    <span class="token punctuation">{<!-- --></span>
        SCREEN_TYPE <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">,</span>
        FILE_TYPE <span class="token operator">=</span> <span class="token number">16</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// 默认日志文件名称</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>DEFAULT_LOG_NAME <span class="token operator">=</span> <span class="token string">"./log.txt"</span><span class="token punctuation">;</span>
    <span class="token comment">// 全局锁，保护打印日志</span>
    pthread_mutex_t gmutex <span class="token operator">=</span> PTHREAD_MUTEX_INITIALIZER<span class="token punctuation">;</span>

    <span class="token comment">// 结构体，用于存储日志信息</span>
    <span class="token keyword">struct</span> <span class="token class-name">logMessage</span>
    <span class="token punctuation">{<!-- --></span>
        std<span class="token double-colon punctuation">::</span>string _level<span class="token punctuation">;</span> <span class="token comment">// 日志等级</span>
        <span class="token keyword">int</span> _level_num<span class="token punctuation">;</span>     <span class="token comment">// 日志等级的int格式</span>

        pid_t _pid<span class="token punctuation">;</span>             <span class="token comment">// 这条日志的进程id</span>
        std<span class="token double-colon punctuation">::</span>string _file_name<span class="token punctuation">;</span> <span class="token comment">// 文件名</span>
        <span class="token keyword">int</span> _file_number<span class="token punctuation">;</span>       <span class="token comment">// 行号</span>
        std<span class="token double-colon punctuation">::</span>string _cur_time<span class="token punctuation">;</span>  <span class="token comment">// 当时的时间</span>
        std<span class="token double-colon punctuation">::</span>string _log_info<span class="token punctuation">;</span>  <span class="token comment">// 日志正文</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// 通过int获取日志等级</span>
    std<span class="token double-colon punctuation">::</span>string <span class="token function">getLevel</span><span class="token punctuation">(</span><span class="token keyword">int</span> level<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>level<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token string">"DEBUG"</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token string">"INFO"</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token string">"WARNING"</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token string">"ERROR"</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">5</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token string">"FATAL"</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token string">"UNKNOWN"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 获取当前时间的字符串表示</span>
    std<span class="token double-colon punctuation">::</span>string <span class="token function">getCurTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        time_t cur <span class="token operator">=</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">tm</span> <span class="token operator">*</span>curtime <span class="token operator">=</span> <span class="token function">localtime</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cur<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span> buf<span class="token punctuation">[</span>TIMESIZE<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token function">snprintf</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"%d-%d-%d %d:%d:%d"</span><span class="token punctuation">,</span>
                 curtime<span class="token operator">-&gt;</span>tm_year <span class="token operator">+</span> <span class="token number">1900</span><span class="token punctuation">,</span>
                 curtime<span class="token operator">-&gt;</span>tm_mon <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>
                 curtime<span class="token operator">-&gt;</span>tm_mday<span class="token punctuation">,</span>
                 curtime<span class="token operator">-&gt;</span>tm_hour<span class="token punctuation">,</span>
                 curtime<span class="token operator">-&gt;</span>tm_min<span class="token punctuation">,</span>
                 curtime<span class="token operator">-&gt;</span>tm_sec<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> buf<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 日志类，用于管理日志的打印</span>
    <span class="token keyword">class</span> <span class="token class-name">Log</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span><span class="token operator">:</span>
        <span class="token comment">// 刷新日志信息，根据打印类型选择打印到屏幕或文件</span>
        <span class="token keyword">void</span> <span class="token function">FlushMessage</span><span class="token punctuation">(</span><span class="token keyword">const</span> logMessage <span class="token operator">&amp;</span>lg<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 互斥锁，保护Print过程</span>
            LockGuard <span class="token function">lockguard</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gmutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 过滤逻辑</span>
            <span class="token comment">// 致命错误到文件逻辑</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>lg<span class="token punctuation">.</span>_level_num <span class="token operator">&gt;=</span> _ignore_level<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>_print_type <span class="token operator">==</span> SCREEN_TYPE<span class="token punctuation">)</span>
                    <span class="token function">PrintToScreen</span><span class="token punctuation">(</span>lg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>_print_type <span class="token operator">==</span> FILE_TYPE<span class="token punctuation">)</span>
                    <span class="token function">PrintToFile</span><span class="token punctuation">(</span>lg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">else</span>
                    std<span class="token double-colon punctuation">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token constant">__FILE__</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" "</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">__LINE__</span> <span class="token operator">&lt;&lt;</span> <span class="token string">":"</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" UNKNOWN_TYPE "</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 打印日志信息到屏幕</span>
        <span class="token keyword">void</span> <span class="token function">PrintToScreen</span><span class="token punctuation">(</span><span class="token keyword">const</span> logMessage <span class="token operator">&amp;</span>lg<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[%s][%d][%s][%d][%s] %s"</span><span class="token punctuation">,</span> lg<span class="token punctuation">.</span>_level<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                   lg<span class="token punctuation">.</span>_pid<span class="token punctuation">,</span>
                   lg<span class="token punctuation">.</span>_file_name<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                   lg<span class="token punctuation">.</span>_file_number<span class="token punctuation">,</span>
                   lg<span class="token punctuation">.</span>_cur_time<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                   lg<span class="token punctuation">.</span>_log_info<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 打印日志信息到文件</span>
        <span class="token keyword">void</span> <span class="token function">PrintToFile</span><span class="token punctuation">(</span><span class="token keyword">const</span> logMessage <span class="token operator">&amp;</span>lg<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            std<span class="token double-colon punctuation">::</span>ofstream <span class="token function">out</span><span class="token punctuation">(</span>_log_file_name<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>ios<span class="token double-colon punctuation">::</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 追加打印</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>out<span class="token punctuation">.</span><span class="token function">is_open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                std<span class="token double-colon punctuation">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token constant">__FILE__</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" "</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">__LINE__</span> <span class="token operator">&lt;&lt;</span> <span class="token string">":"</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" LOG_FILE_OPEN fail "</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">char</span> log_txt<span class="token punctuation">[</span>FILE_TYPE_LOG_SIZE<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// 缓冲区</span>
            <span class="token function">snprintf</span><span class="token punctuation">(</span>log_txt<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>log_txt<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"[%s][%d][%s][%d][%s] %s"</span><span class="token punctuation">,</span> lg<span class="token punctuation">.</span>_level<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                     lg<span class="token punctuation">.</span>_pid<span class="token punctuation">,</span>
                     lg<span class="token punctuation">.</span>_file_name<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                     lg<span class="token punctuation">.</span>_file_number<span class="token punctuation">,</span>
                     lg<span class="token punctuation">.</span>_cur_time<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                     lg<span class="token punctuation">.</span>_log_info<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            out<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>log_txt<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>log_txt<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 写入文件</span>
        <span class="token punctuation">}</span>

    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token comment">// 构造函数，初始化打印方式和日志文件名称</span>
        <span class="token function">Log</span><span class="token punctuation">(</span><span class="token keyword">int</span> print_type <span class="token operator">=</span> SCREEN_TYPE<span class="token punctuation">)</span>
            <span class="token operator">:</span> <span class="token function">_print_type</span><span class="token punctuation">(</span>print_type<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_log_file_name</span><span class="token punctuation">(</span>DEFAULT_LOG_NAME<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_ignore_level</span><span class="token punctuation">(</span>DEBUG<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 设置日志打印方式</span>
        <span class="token keyword">void</span> <span class="token function">Enable</span><span class="token punctuation">(</span><span class="token keyword">int</span> type<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _print_type <span class="token operator">=</span> type<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/// @brief 加载日志信息，并根据打印方式进行打印</span>
        <span class="token comment">/// @param format 格式化输出</span>
        <span class="token comment">/// @param  可变参数</span>
        <span class="token comment">/*区分了本层和上层之后，就容易设置参数了*/</span>
        <span class="token keyword">void</span> <span class="token function">load_message</span><span class="token punctuation">(</span><span class="token keyword">int</span> level<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>string filename<span class="token punctuation">,</span> <span class="token keyword">int</span> filenumber<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>format<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            logMessage lg<span class="token punctuation">;</span>
            lg<span class="token punctuation">.</span>_level <span class="token operator">=</span> <span class="token function">getLevel</span><span class="token punctuation">(</span>level<span class="token punctuation">)</span><span class="token punctuation">;</span>
            lg<span class="token punctuation">.</span>_level_num <span class="token operator">=</span> level<span class="token punctuation">;</span>

            lg<span class="token punctuation">.</span>_pid <span class="token operator">=</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            lg<span class="token punctuation">.</span>_file_name <span class="token operator">=</span> filename<span class="token punctuation">;</span>
            lg<span class="token punctuation">.</span>_file_number <span class="token operator">=</span> filenumber<span class="token punctuation">;</span>
            lg<span class="token punctuation">.</span>_cur_time <span class="token operator">=</span> <span class="token function">getCurTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// valist + vsnprintf 处理可变参数</span>
            va_list ap<span class="token punctuation">;</span>
            <span class="token function">va_start</span><span class="token punctuation">(</span>ap<span class="token punctuation">,</span> format<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">char</span> log_info<span class="token punctuation">[</span>LOGSIZE<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token function">vsnprintf</span><span class="token punctuation">(</span>log_info<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>log_info<span class="token punctuation">)</span><span class="token punctuation">,</span> format<span class="token punctuation">,</span> ap<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">va_end</span><span class="token punctuation">(</span>ap<span class="token punctuation">)</span><span class="token punctuation">;</span>
            lg<span class="token punctuation">.</span>_log_info <span class="token operator">=</span> log_info<span class="token punctuation">;</span>

            <span class="token comment">// 打印逻辑</span>
            <span class="token function">FlushMessage</span><span class="token punctuation">(</span>lg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/// @brief 设置忽略的日志等级</span>
        <span class="token comment">/// @param ignorelevel 忽略的日志等级</span>
        <span class="token comment">/* DEBUG = 1,   调试信息
         *INFO = 2,     提示信息
         *WARNING = 3,  警告
         *ERROR = 4,    错误，但是不影响服务正常运行
         *FATAL = 5,    致命错误，服务无法正常运行 */</span>
        <span class="token keyword">void</span> <span class="token function">SetIgnoreLevel</span><span class="token punctuation">(</span><span class="token keyword">int</span> ignorelevel<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _ignore_level <span class="token operator">=</span> ignorelevel<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/// @brief 设置日志文件名称</span>
        <span class="token comment">/// @param newlogfilename 新的日志文件名称</span>
        <span class="token keyword">void</span> <span class="token function">SetLogFileName</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>newlogfilename<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _log_file_name <span class="token operator">=</span> newlogfilename<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token operator">~</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

    <span class="token keyword">private</span><span class="token operator">:</span>
        <span class="token keyword">int</span> _print_type<span class="token punctuation">;</span>          <span class="token comment">// 打印类型</span>
        std<span class="token double-colon punctuation">::</span>string _log_file_name<span class="token punctuation">;</span> <span class="token comment">// 日志文件名称</span>
        <span class="token keyword">int</span> _ignore_level<span class="token punctuation">;</span>        <span class="token comment">// 忽略的日志等级</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// 全局的Log对象</span>
    Log lg<span class="token punctuation">;</span>

    <span class="token comment">// 使用日志的一般格式</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LOG</span><span class="token expression"><span class="token punctuation">(</span>Level<span class="token punctuation">,</span> Format<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>                                            </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">do</span>                                                                     </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">{<!-- --></span>                                                                      </span><span class="token punctuation">\</span>
        <span class="token expression">lg<span class="token punctuation">.</span><span class="token function">load_message</span><span class="token punctuation">(</span>Level<span class="token punctuation">,</span> <span class="token constant">__FILE__</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">,</span> Format<span class="token punctuation">,</span> </span><span class="token punctuation">##</span><span class="token expression">__VA_ARGS__<span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span></span>

    <span class="token comment">/// 无法设计为inline——__VA_ARGS只能出现在宏替换中</span>
    <span class="token comment">// inline void LOG(int level,const char* format, ...)</span>
    <span class="token comment">// {<!-- --></span>
    <span class="token comment">//     lg.load_message(level,__FILE__,__LINE__,format,__VA_ARGS__);</span>
    <span class="token comment">// }</span>

    <span class="token comment">// 往文件打印</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">ENABLE_FILE</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span>         </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">do</span>                        </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">{<!-- --></span>                         </span><span class="token punctuation">\</span>
        <span class="token expression">lg<span class="token punctuation">.</span><span class="token function">Enable</span><span class="token punctuation">(</span>FILE_TYPE<span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span></span>

    <span class="token comment">// 往显示器打印</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">ENABLE_SCREEN</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span>         </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">do</span>                          </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">{<!-- --></span>                           </span><span class="token punctuation">\</span>
        <span class="token expression">lg<span class="token punctuation">.</span><span class="token function">Enable</span><span class="token punctuation">(</span>SCREEN_TYPE<span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span></span>

    <span class="token comment">// 设置日志忽略等级</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">SET_IGNORE_LEVEL</span><span class="token expression"><span class="token punctuation">(</span>Level<span class="token punctuation">)</span>  </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">do</span>                           </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">{<!-- --></span>                            </span><span class="token punctuation">\</span>
        <span class="token expression">lg<span class="token punctuation">.</span><span class="token function">SetIgnoreLevel</span><span class="token punctuation">(</span>Level<span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span></span>

    <span class="token comment">// 设置日志文件名称</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">SET_LOG_FILENAME</span><span class="token expression"><span class="token punctuation">(</span>Name<span class="token punctuation">)</span>  </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">do</span>                          </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">{<!-- --></span>                           </span><span class="token punctuation">\</span>
        <span class="token expression">lg<span class="token punctuation">.</span><span class="token function">SetLogFileName</span><span class="token punctuation">(</span>Name<span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span></span>

<span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// namespace log_ddsm</span>
</code></pre>
    <blockquote>
     <p>
      <strong>
       以上逻辑设计了一个
       <code>
        日志管理系统
       </code>
       ，提供了日志的多种输出方式（如屏幕输出和文件输出），并使用 RAII（Resource Acquisition Is Initialization）模式和互斥锁保护日志打印过程。
      </strong>
     </p>
    </blockquote>
    <h4>
     <a id="_453">
     </a>
     解释
    </h4>
    <ol>
     <li>
      <p>
       <strong>
        日志级别管理：
       </strong>
      </p>
      <ul>
       <li>
        <code>
         enum LEVEL
        </code>
        定义了不同的日志级别，从
        <code>
         DEBUG
        </code>
        到
        <code>
         FATAL
        </code>
        ，用于标识日志的重要性。在不同的场景下，需要输出的日志等级是不同的。比如在测试（Debug）阶段，最好输出全部日志信息；而在发行（Release）之后，只需要输出Warning以上级别的日志信息即可。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        日志信息结构体：
       </strong>
      </p>
      <ul>
       <li>
        <code>
         struct logMessage
        </code>
        包含了日志的详细信息，包括日志级别、进程ID、文件名、行号、当前时间和日志内容。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        获取日志级别字符串：
       </strong>
      </p>
      <ul>
       <li>
        <code>
         getLevel(int level)
        </code>
        函数根据日志级别的整数值返回相应的字符串表示。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        获取当前时间：
       </strong>
      </p>
      <ul>
       <li>
        <code>
         getCurTime()
        </code>
        函数获取当前的系统时间，并格式化为字符串。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        日志类
        <code>
         Log
        </code>
       </strong>
      </p>
      <ul>
       <li>
        <code>
         Log
        </code>
        类负责管理日志的打印。它包含了打印到屏幕和打印到文件的功能，并通过 RAII 模式和互斥锁保护打印过程。
       </li>
       <li>
        <code>
         FlushMessage(const logMessage &amp;lg)
        </code>
        函数根据日志级别和打印类型选择合适的打印方式。
       </li>
       <li>
        <code>
         PrintToScreen(const logMessage &amp;lg)
        </code>
        函数将日志打印到屏幕。
       </li>
       <li>
        <code>
         PrintToFile(const logMessage &amp;lg)
        </code>
        函数将日志打印到文件。
       </li>
       <li>
        <code>
         load_message(int level, std::string filename, int filenumber, const char *format, ...)
        </code>
        函数加载日志信息，并调用
        <code>
         FlushMessage
        </code>
        进行打印。
       </li>
       <li>
        <code>
         SetIgnoreLevel(int ignorelevel)
        </code>
        函数设置忽略的日志级别。
       </li>
       <li>
        <code>
         SetLogFileName(const char *newlogfilename)
        </code>
        函数设置日志文件名称。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        宏定义：
       </strong>
      </p>
      <ul>
       <li>
        <code>
         LOG(Level, Format, ...)
        </code>
        宏用于简化日志的打印调用，自动获取文件名和行号，并调用
        <code>
         load_message
        </code>
        函数。
       </li>
       <li>
        <code>
         ENABLE_FILE()
        </code>
        宏用于设置日志打印到文件。
       </li>
       <li>
        <code>
         ENABLE_SCREEN()
        </code>
        宏用于设置日志打印到屏幕。
       </li>
       <li>
        <code>
         SET_IGNORE_LEVEL(Level)
        </code>
        宏用于设置忽略的日志级别。
       </li>
       <li>
        <code>
         SET_LOG_FILENAME(Name)
        </code>
        宏用于设置日志文件名称。
       </li>
      </ul>
     </li>
    </ol>
    <h4>
     <a id="_483">
     </a>
     使用示例
    </h4>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"log_ddsm.hpp"</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 设置日志打印到文件</span>
    <span class="token function">ENABLE_FILE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 设置日志文件名称</span>
    <span class="token function">SET_LOG_FILENAME</span><span class="token punctuation">(</span><span class="token string">"my_log.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 设置忽略等级为INFO，低于INFO的日志不会打印</span>
    <span class="token function">SET_IGNORE_LEVEL</span><span class="token punctuation">(</span>log_ddsm<span class="token double-colon punctuation">::</span>INFO<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 打印日志</span>
    <span class="token function">LOG</span><span class="token punctuation">(</span>log_ddsm<span class="token double-colon punctuation">::</span>DEBUG<span class="token punctuation">,</span> <span class="token string">"This is a debug message\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOG</span><span class="token punctuation">(</span>log_ddsm<span class="token double-colon punctuation">::</span>INFO<span class="token punctuation">,</span> <span class="token string">"This is an info message\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOG</span><span class="token punctuation">(</span>log_ddsm<span class="token double-colon punctuation">::</span>WARNING<span class="token punctuation">,</span> <span class="token string">"This is a warning message\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOG</span><span class="token punctuation">(</span>log_ddsm<span class="token double-colon punctuation">::</span>ERROR<span class="token punctuation">,</span> <span class="token string">"This is an error message\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOG</span><span class="token punctuation">(</span>log_ddsm<span class="token double-colon punctuation">::</span>FATAL<span class="token punctuation">,</span> <span class="token string">"This is a fatal message\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     在这个示例中，我们设置日志打印到文件
     <code>
      my_log.txt
     </code>
     ，并设置忽略级别为
     <code>
      INFO
     </code>
     。然后，我们打印不同级别的日志信息。
     <br/>
     在my_log.txt中的打印结果：
    </p>
    <pre><code class="prism language-txt">[INFO][3089][test.cc][17][2025-3-8 13:51:14] This is an info message
[WARNING][3089][test.cc][18][2025-3-8 13:51:14] This is a warning message
[ERROR][3089][test.cc][19][2025-3-8 13:51:14] This is an error message
[FATAL][3089][test.cc][20][2025-3-8 13:51:14] This is a fatal message

</code></pre>
    <hr/>
    <h2>
     <a id="_518">
     </a>
     四、网络地址信息的封装管理
    </h2>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">once</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>

<span class="token keyword">class</span> <span class="token class-name">Inet</span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token comment">// 将 sockaddr_in 转换为主机序列并提取 IP 和端口</span>
    <span class="token keyword">void</span> <span class="token function">ConvertToHost</span><span class="token punctuation">(</span><span class="token keyword">const</span> sockaddr_in <span class="token operator">&amp;</span>addr<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 使用 inet_ntop 将网络序列 IP 地址转换为点分十进制字符串形式</span>
        <span class="token keyword">char</span> ip_buf<span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token function">inet_ntop</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> <span class="token operator">&amp;</span>addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">,</span> ip_buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ip_buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        _ip <span class="token operator">=</span> ip_buf<span class="token punctuation">;</span>

        <span class="token comment">// 将网络字节序的端口号转换为主机字节序</span>
        _port <span class="token operator">=</span> <span class="token function">ntohs</span><span class="token punctuation">(</span>addr<span class="token punctuation">.</span>sin_port<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 设置唯一名称</span>
    <span class="token keyword">void</span> <span class="token function">SetUname</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        _uname <span class="token operator">=</span> _ip<span class="token punctuation">;</span>
        _uname <span class="token operator">+=</span> <span class="token string">"  "</span><span class="token punctuation">;</span>
        _uname <span class="token operator">+=</span> std<span class="token double-colon punctuation">::</span><span class="token function">to_string</span><span class="token punctuation">(</span>_port<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token comment">// 默认构造函数</span>
    <span class="token function">Inet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

    <span class="token comment">// 通过 sockaddr_in 构造 Inet 类</span>
    <span class="token function">Inet</span><span class="token punctuation">(</span>sockaddr_in addr<span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token function">_addr</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">ConvertToHost</span><span class="token punctuation">(</span>_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">SetUname</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 重载等于操作符</span>
    <span class="token keyword">bool</span> <span class="token keyword">operator</span><span class="token operator">==</span><span class="token punctuation">(</span><span class="token keyword">const</span> Inet <span class="token operator">&amp;</span>inet<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span>_ip <span class="token operator">==</span> inet<span class="token punctuation">.</span>_ip <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>_port <span class="token operator">==</span> inet<span class="token punctuation">.</span>_port<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 获取 sockaddr_in 结构体</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> <span class="token function">ADDR</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> _addr<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 获取字符串 IP 地址</span>
    std<span class="token double-colon punctuation">::</span>string <span class="token function">IP</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> _ip<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 获取端口号</span>
    <span class="token keyword">uint16_t</span> <span class="token function">PORT</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> _port<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 获取唯一名称</span>
    std<span class="token double-colon punctuation">::</span>string <span class="token function">UniqueName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> _uname<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 获取唯一名称（const 版本）</span>
    <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token function">UniqueName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> _uname<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 析构函数</span>
    <span class="token operator">~</span><span class="token function">Inet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    std<span class="token double-colon punctuation">::</span>string _ip<span class="token punctuation">;</span>    <span class="token comment">// 字符串 IP 地址</span>
    <span class="token keyword">uint16_t</span> _port<span class="token punctuation">;</span>     <span class="token comment">// 端口号</span>
    sockaddr_in _addr<span class="token punctuation">;</span>  <span class="token comment">// 地址结构体</span>
    std<span class="token double-colon punctuation">::</span>string _uname<span class="token punctuation">;</span> <span class="token comment">// 唯一名称</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <blockquote>
     <p>
      <strong>
       以上代码实现了一个
       <code>
        Inet
       </code>
       类，用于封装和管理网络地址信息。
      </strong>
     </p>
    </blockquote>
    <h4>
     <a id="_612">
     </a>
     解释
    </h4>
    <ol>
     <li>
      <p>
       <strong>
        封装网络地址信息：
       </strong>
      </p>
      <ul>
       <li>
        <code>
         Inet
        </code>
        类封装了 IP 地址和端口号的信息，并提供了一些便捷的方法来获取这些信息。通过这种封装，可以更加方便地管理和操作网络地址。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        地址转换：
       </strong>
      </p>
      <ul>
       <li>
        <code>
         ConvertToHost
        </code>
        方法将
        <code>
         sockaddr_in
        </code>
        结构体中的网络字节序 IP 地址和端口号转换为主机字节序，并将 IP 地址转换为字符串形式。因为网络传输使用网络字节序，而主机通常使用主机字节序。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        唯一名称：
       </strong>
      </p>
      <ul>
       <li>
        <code>
         SetUname
        </code>
        方法将 IP 地址和端口号组合成一个唯一名称
        <code>
         _uname
        </code>
        ，用于标识一个唯一的网络地址。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        操作符重载：
       </strong>
      </p>
      <ul>
       <li>
        重载了
        <code>
         operator==
        </code>
        操作符，用于比较两个
        <code>
         Inet
        </code>
        对象是否相等。两个
        <code>
         Inet
        </code>
        对象相等的条件是它们的 IP 地址和端口号都相等。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        获取方法：
       </strong>
      </p>
      <ul>
       <li>
        提供了多个获取方法，如
        <code>
         ADDR()
        </code>
        、
        <code>
         IP()
        </code>
        、
        <code>
         PORT()
        </code>
        和
        <code>
         UniqueName()
        </code>
        ，用于获取
        <code>
         Inet
        </code>
        对象的不同属性。这些方法使得
        <code>
         Inet
        </code>
        类的使用更加便捷。
       </li>
      </ul>
     </li>
    </ol>
    <h4>
     <a id="_629">
     </a>
     使用示例
    </h4>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Inet.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    sockaddr_in addr<span class="token punctuation">;</span>
    addr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
    addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    addr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    Inet <span class="token function">inet</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"IP: "</span> <span class="token operator">&lt;&lt;</span> inet<span class="token punctuation">.</span><span class="token function">IP</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Port: "</span> <span class="token operator">&lt;&lt;</span> inet<span class="token punctuation">.</span><span class="token function">PORT</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Unique Name: "</span> <span class="token operator">&lt;&lt;</span> inet<span class="token punctuation">.</span><span class="token function">UniqueName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     在这个示例中，我们创建了一个
     <code>
      sockaddr_in
     </code>
     结构体并初始化它，然后使用它来构造一个
     <code>
      Inet
     </code>
     对象。接着，我们使用
     <code>
      Inet
     </code>
     对象的获取方法来打印 IP 地址、端口号和唯一名称。
    </p>
    <h2>
     <a id="OOPRAII_654">
     </a>
     五、基于OOP和RAII模式管理网络套接字
    </h2>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">once</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;memory&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstring&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Log.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Inet.hpp"</span></span>

<span class="token keyword">namespace</span> socket_ddsm
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 展开日志命名空间</span>
    <span class="token keyword">using</span> <span class="token keyword">namespace</span> log_ddsm<span class="token punctuation">;</span>

    <span class="token comment">// 默认port和backlog</span>
    <span class="token keyword">const</span> <span class="token keyword">static</span> <span class="token keyword">int</span> gport <span class="token operator">=</span> <span class="token number">8888</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">static</span> <span class="token keyword">int</span> gblcklog <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>

    <span class="token comment">// 错误码和常量定义</span>
    <span class="token keyword">enum</span>
    <span class="token punctuation">{<!-- --></span>
        SOCK_CREAT_FAIL <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
        BIND_FAIL<span class="token punctuation">,</span>
        LISTEN_FAIL<span class="token punctuation">,</span>
        MSSIZE <span class="token operator">=</span> <span class="token number">4096</span> <span class="token comment">// 最大消息大小</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// 对Socket的前置声明</span>
    <span class="token keyword">class</span> <span class="token class-name">Socket</span><span class="token punctuation">;</span>
    <span class="token comment">// 是一个类型名，可用于接受std::make_shared&lt;TcpSocket&gt;()的返回值</span>
    <span class="token keyword">using</span> SockSPtr <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>Socket<span class="token operator">&gt;</span><span class="token punctuation">;</span>

    <span class="token comment">// 模板方法类模式</span>
    <span class="token comment">/*基类提供方法，并组合，具体实现在派生类的实现*/</span>
    <span class="token keyword">class</span> <span class="token class-name">Socket</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token comment">// 创建套接字</span>
        <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">CreateSocketOrDie</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token comment">// 绑定端口</span>
        <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">BindOrDie</span><span class="token punctuation">(</span><span class="token keyword">uint16_t</span> port<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token comment">// 监听端口</span>
        <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">ListenOrDie</span><span class="token punctuation">(</span><span class="token keyword">int</span> blcklog <span class="token operator">=</span> gblcklog<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token comment">// 接受连接</span>
        <span class="token keyword">virtual</span> SockSPtr <span class="token function">Accepter</span><span class="token punctuation">(</span>Inet <span class="token operator">*</span>addr<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token comment">// 连接到服务器</span>
        <span class="token keyword">virtual</span> <span class="token keyword">bool</span> <span class="token function">Connector</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>peerip<span class="token punctuation">,</span> <span class="token keyword">uint16_t</span> peerport<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token comment">// 获取套接字文件描述符</span>
        <span class="token keyword">virtual</span> <span class="token keyword">int</span> <span class="token function">GetSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token comment">// 关闭套接字</span>
        <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token comment">// 接收消息</span>
        <span class="token keyword">virtual</span> ssize_t <span class="token function">Recv</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>string <span class="token operator">*</span>out<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token comment">// 发送消息</span>
        <span class="token keyword">virtual</span> ssize_t <span class="token function">Send</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>in<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token comment">// 组合的创建TCP的方法集合</span>
        <span class="token keyword">void</span> <span class="token function">BuildListenSocket</span><span class="token punctuation">(</span><span class="token keyword">int</span> port <span class="token operator">=</span> gport<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">CreateSocketOrDie</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建套接字</span>
            <span class="token function">BindOrDie</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 绑定端口</span>
            <span class="token function">ListenOrDie</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// 监听端口</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 创建客户端套接字并连接到服务器</span>
        <span class="token keyword">bool</span> <span class="token function">BuildClientSocket</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>peerip<span class="token punctuation">,</span> <span class="token keyword">uint16_t</span> peerport<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">CreateSocketOrDie</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建套接字</span>
            <span class="token keyword">return</span> <span class="token function">Connector</span><span class="token punctuation">(</span>peerip<span class="token punctuation">,</span> peerport<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 连接到服务器</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// TCP套接字类，继承自Socket基类</span>
    <span class="token keyword">class</span> <span class="token class-name">TcpSocket</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Socket</span></span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">TcpSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">:</span> <span class="token function">_socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">}</span>

        <span class="token function">TcpSocket</span><span class="token punctuation">(</span><span class="token keyword">int</span> socket<span class="token punctuation">)</span>
            <span class="token operator">:</span> <span class="token function">_socket</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">}</span>

        <span class="token operator">~</span><span class="token function">TcpSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 析构函数中不自动关闭套接字，避免意外关闭</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 创建TCP套接字</span>
        <span class="token keyword">void</span> <span class="token function">CreateSocketOrDie</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">override</span>
        <span class="token punctuation">{<!-- --></span>
            _socket <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_socket <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token function">LOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">,</span> <span class="token string">"socket create fail!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">exit</span><span class="token punctuation">(</span>SOCK_CREAT_FAIL<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">LOG</span><span class="token punctuation">(</span>DEBUG<span class="token punctuation">,</span> <span class="token string">"create sockfd success socket: %d\n"</span><span class="token punctuation">,</span> _socket<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 绑定端口</span>
        <span class="token keyword">void</span> <span class="token function">BindOrDie</span><span class="token punctuation">(</span><span class="token keyword">uint16_t</span> port<span class="token punctuation">)</span> <span class="token keyword">override</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> local<span class="token punctuation">;</span>
            <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>local<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>local<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            local<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
            local<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
            local<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> INADDR_ANY<span class="token punctuation">;</span>

            <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token function">bind</span><span class="token punctuation">(</span>_socket<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>local<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>local<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token function">LOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">,</span> <span class="token string">"bind fail!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">exit</span><span class="token punctuation">(</span>BIND_FAIL<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">LOG</span><span class="token punctuation">(</span>DEBUG<span class="token punctuation">,</span> <span class="token string">"bind success\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 监听端口</span>
        <span class="token keyword">void</span> <span class="token function">ListenOrDie</span><span class="token punctuation">(</span><span class="token keyword">int</span> blcklog<span class="token punctuation">)</span> <span class="token keyword">override</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token function">listen</span><span class="token punctuation">(</span>_socket<span class="token punctuation">,</span> blcklog<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token function">LOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">,</span> <span class="token string">"listen fail"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">exit</span><span class="token punctuation">(</span>LISTEN_FAIL<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">LOG</span><span class="token punctuation">(</span>DEBUG<span class="token punctuation">,</span> <span class="token string">"listen success\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 接受连接</span>
        SockSPtr <span class="token function">Accepter</span><span class="token punctuation">(</span>Inet <span class="token operator">*</span>peer<span class="token punctuation">)</span> <span class="token keyword">override</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> client<span class="token punctuation">;</span>
            socklen_t len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> rwfd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>_socket<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>client<span class="token punctuation">,</span> <span class="token operator">&amp;</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>rwfd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token function">LOG</span><span class="token punctuation">(</span>WARNING<span class="token punctuation">,</span> <span class="token string">"accept error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token operator">*</span>peer <span class="token operator">=</span> <span class="token function">Inet</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">,</span> <span class="token string">"accept success, client info: %s\n"</span><span class="token punctuation">,</span> peer<span class="token operator">-&gt;</span><span class="token function">UniqueName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>TcpSocket<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>rwfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 连接到服务器</span>
        <span class="token keyword">bool</span> <span class="token function">Connector</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>peerip<span class="token punctuation">,</span> <span class="token keyword">uint16_t</span> peerport<span class="token punctuation">)</span> <span class="token keyword">override</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> server<span class="token punctuation">;</span>
            <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>server<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            server<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
            server<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>peerport<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">inet_pton</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> peerip<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>server<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token double-colon punctuation">::</span><span class="token function">connect</span><span class="token punctuation">(</span>_socket<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>server<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 获取套接字文件描述符</span>
        <span class="token keyword">int</span> <span class="token function">GetSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">override</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> _socket<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 关闭套接字</span>
        <span class="token keyword">void</span> <span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">override</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_socket <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">int</span> reval <span class="token operator">=</span> <span class="token double-colon punctuation">::</span><span class="token function">close</span><span class="token punctuation">(</span>_socket<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>reval <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">,</span> <span class="token string">"_socket close error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 接收消息</span>
        ssize_t <span class="token function">Recv</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>string <span class="token operator">*</span>out<span class="token punctuation">)</span> <span class="token keyword">override</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">char</span> buf<span class="token punctuation">[</span>MSSIZE<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token double-colon punctuation">::</span><span class="token function">recv</span><span class="token punctuation">(</span>_socket<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                buf<span class="token punctuation">[</span>n<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token operator">*</span>out <span class="token operator">+=</span> buf<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> n<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 发送消息</span>
        ssize_t <span class="token function">Send</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>in<span class="token punctuation">)</span> <span class="token keyword">override</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token double-colon punctuation">::</span><span class="token function">send</span><span class="token punctuation">(</span>_socket<span class="token punctuation">,</span> in<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> in<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token keyword">private</span><span class="token operator">:</span>
        <span class="token keyword">int</span> _socket<span class="token punctuation">;</span> <span class="token comment">// 套接字文件描述符</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span> <span class="token comment">// namespace socket_ddsm</span>
</code></pre>
    <blockquote>
     <p>
      <strong>
       以上代码设计了一个
       <code>
        基于TCP的网络通信类库
       </code>
       ，使用了
       <code>
        面向对象编程（OOP）
       </code>
       和
       <code>
        RAII（Resource Acquisition Is Initialization）
       </code>
       模式来管理网络套接字的创建、绑定、监听、连接等操作。
      </strong>
     </p>
    </blockquote>
    <h4>
     <a id="_883">
     </a>
     解释
    </h4>
    <ol>
     <li>
      <p>
       <strong>
        抽象基类
        <code>
         Socket
        </code>
        ：
       </strong>
      </p>
      <ul>
       <li>
        <code>
         Socket
        </code>
        类是一个抽象基类，定义了创建、绑定、监听、接受连接、连接到服务器、发送和接收消息等虚函数。这些函数在派生类中需要实现。
       </li>
       <li>
        提供了
        <code>
         BuildListenSocket
        </code>
        和
        <code>
         BuildClientSocket
        </code>
        两个组合方法，用于简化服务器和客户端套接字的创建和配置过程。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        具体类
        <code>
         TcpSocket
        </code>
        ：
       </strong>
      </p>
      <ul>
       <li>
        <code>
         TcpSocket
        </code>
        类继承自
        <code>
         Socket
        </code>
        基类，实现了基类中定义的所有虚函数，具体负责TCP套接字的创建、绑定、监听、接受连接、连接到服务器、发送和接收消息等操作。
       </li>
       <li>
        使用日志记录（
        <code>
         LOG
        </code>
        宏）来记录每一步的操作和错误信息，方便调试和问题排查。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        日志管理：
       </strong>
      </p>
      <ul>
       <li>
        使用
        <code>
         log_ddsm
        </code>
        命名空间中的日志功能记录各种操作和错误信息，提供了详细的调试信息。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        智能指针：
       </strong>
      </p>
      <ul>
       <li>
        使用
        <code>
         std::shared_ptr
        </code>
        来管理
        <code>
         TcpSocket
        </code>
        对象的生命周期，确保资源的自动释放，避免内存泄漏。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        RAII：
       </strong>
      </p>
      <ul>
       <li>
        通过 RAII 模式管理套接字的生命周期，在创建对象时初始化资源，在对象销毁时释放资源。
       </li>
      </ul>
     </li>
    </ol>
    <h4>
     <a id="_902">
     </a>
     使用示例
    </h4>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"socket_ddsm.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Log.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Inet.hpp"</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 初始化日志系统</span>
    <span class="token function">ENABLE_SCREEN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SET_IGNORE_LEVEL</span><span class="token punctuation">(</span>log_ddsm<span class="token double-colon punctuation">::</span>DEBUG<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 创建服务器套接字</span>
    socket_ddsm<span class="token double-colon punctuation">::</span>TcpSocket server<span class="token punctuation">;</span>
    server<span class="token punctuation">.</span><span class="token function">BuildListenSocket</span><span class="token punctuation">(</span><span class="token number">8888</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 等待客户端连接</span>
    socket_ddsm<span class="token double-colon punctuation">::</span>Inet client_addr<span class="token punctuation">;</span>
    <span class="token keyword">auto</span> client <span class="token operator">=</span> server<span class="token punctuation">.</span><span class="token function">Accepter</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>client_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>client<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 接收客户端消息</span>
        std<span class="token double-colon punctuation">::</span>string msg<span class="token punctuation">;</span>
        client<span class="token operator">-&gt;</span><span class="token function">Recv</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Received message: "</span> <span class="token operator">&lt;&lt;</span> msg <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>

        <span class="token comment">// 发送回复</span>
        client<span class="token operator">-&gt;</span><span class="token function">Send</span><span class="token punctuation">(</span><span class="token string">"Hello, client!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 关闭服务器套接字</span>
    server<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     在这个示例中，我们初始化了日志系统，创建了服务器套接字并进行监听，等待客户端连接。接受到客户端连接后，接收客户端消息并发送回复，最后关闭服务器套接字。
    </p>
    <h2>
     <a id="TCP_942">
     </a>
     六、下层TCP服务器类的设计
    </h2>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">once</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;functional&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"uncopyable.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Socket.hpp"</span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> socket_ddsm<span class="token punctuation">;</span>

<span class="token comment">// Tcp服务器，接受用户发送的信息，发回消息</span>
<span class="token keyword">class</span> <span class="token class-name">TcpServer</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">uncopyable</span></span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 回调函数的类型</span>
    <span class="token keyword">using</span> service_t <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>function<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span><span class="token function">string</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>

    <span class="token comment">// 使用多线程解决服务器无法同时服务多个客户端的问题----原生线程的使用</span>
    <span class="token comment">// 创建的目的是便于传递参数</span>
    <span class="token keyword">struct</span> <span class="token class-name">ThreadData</span>
    <span class="token punctuation">{<!-- --></span>
        TcpServer <span class="token operator">*</span>_self<span class="token punctuation">;</span>
        SockSPtr _sockfd<span class="token punctuation">;</span>
        Inet _addr<span class="token punctuation">;</span>

        <span class="token function">ThreadData</span><span class="token punctuation">(</span>TcpServer <span class="token operator">*</span>self<span class="token punctuation">,</span> SockSPtr sockfd<span class="token punctuation">,</span> <span class="token keyword">const</span> Inet <span class="token operator">&amp;</span>addr<span class="token punctuation">)</span>
            <span class="token operator">:</span> <span class="token function">_self</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_sockfd</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_addr</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">}</span>
        <span class="token operator">~</span><span class="token function">ThreadData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token comment">// 在构造的时候，传入回调函数即可，实现高度解耦</span>
    <span class="token function">TcpServer</span><span class="token punctuation">(</span>service_t service<span class="token punctuation">,</span> <span class="token keyword">uint16_t</span> port <span class="token operator">=</span> gport<span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token function">_port</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_listensock</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>TcpSocket<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_isrunning</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_service</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 面向对象式的创建tcp socket</span>
        _listensock<span class="token operator">-&gt;</span><span class="token function">BuildListenSocket</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        _isrunning <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>_isrunning<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            Inet client<span class="token punctuation">;</span>
            SockSPtr newsock <span class="token operator">=</span> _listensock<span class="token operator">-&gt;</span><span class="token function">Accepter</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>newsock <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token function">LOG</span><span class="token punctuation">(</span>DEBUG<span class="token punctuation">,</span> <span class="token string">"get a new link,client info: %s,sockfd is %d\n"</span><span class="token punctuation">,</span> client<span class="token punctuation">.</span><span class="token function">UniqueName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> newsock<span class="token operator">-&gt;</span><span class="token function">GetSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 5.提供服务(服务器需要能够同时为多个客户端提供服务)</span>
            <span class="token comment">/* 使用多线程解决服务器无法同时服务多个客户端的问题----原生线程的使用
                创建一个新线程来提供服务
            */</span>
            pthread_t tid<span class="token punctuation">;</span>
            ThreadData <span class="token operator">*</span>td <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">ThreadData</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> newsock<span class="token punctuation">,</span> client<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> Excute<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>td<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        _isrunning <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">Excute</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>args<span class="token punctuation">)</span> <span class="token comment">// static 防止this指针干扰函数类型</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 新线程解除与主线程的等待关系，主线程不再需要等待新线程</span>
        <span class="token function">pthread_detach</span><span class="token punctuation">(</span><span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 目的是调用Service---static内部无法获取对象，需要传递进来--所以通过一个设计的ThreadData类把需要的参数传递进来</span>
        ThreadData <span class="token operator">*</span>ptd <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>ThreadData <span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        std<span class="token double-colon punctuation">::</span>string requeststr<span class="token punctuation">;</span>
        ssize_t n <span class="token operator">=</span> ptd<span class="token operator">-&gt;</span>_sockfd<span class="token operator">-&gt;</span><span class="token function">Recv</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>requeststr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 回调</span>
            std<span class="token double-colon punctuation">::</span>string reponsestr <span class="token operator">=</span> ptd<span class="token operator">-&gt;</span>_self<span class="token operator">-&gt;</span><span class="token function">_service</span><span class="token punctuation">(</span>requeststr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            ptd<span class="token operator">-&gt;</span>_sockfd<span class="token operator">-&gt;</span><span class="token function">Send</span><span class="token punctuation">(</span>reponsestr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 面向对象,关闭sockfd</span>
        ptd<span class="token operator">-&gt;</span>_sockfd<span class="token operator">-&gt;</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">delete</span> ptd<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token operator">~</span><span class="token function">TcpServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">uint16_t</span> _port<span class="token punctuation">;</span>       <span class="token comment">// 端口</span>
    SockSPtr _listensock<span class="token punctuation">;</span> <span class="token comment">// 自定义实现的socket类,交给智能指针管理</span>
    <span class="token keyword">bool</span> _isrunning<span class="token punctuation">;</span>
    service_t _service<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <blockquote>
     <p>
      <strong>
       上述代码设计了一个
       <code>
        TcpServer
       </code>
       类，用于创建和管理一个 TCP 服务器，能够接收客户端发送的信息，并发回响应。为了实现并发处理多个客户端的请求，代码使用了多线程。
      </strong>
     </p>
    </blockquote>
    <h4>
     <a id="_1042">
     </a>
     解释
    </h4>
    <ol>
     <li>
      <p>
       <strong>
        继承
        <code>
         uncopyable
        </code>
        类：
       </strong>
      </p>
      <ul>
       <li>
        <code>
         TcpServer
        </code>
        继承自
        <code>
         uncopyable
        </code>
        类，确保
        <code>
         TcpServer
        </code>
        对象不能被拷贝，避免了拷贝可能带来的资源管理问题。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        回调函数类型：
       </strong>
      </p>
      <ul>
       <li>
        使用
        <code>
         std::function&lt;std::string(std::string &amp;)&gt;
        </code>
        定义了一个回调函数类型
        <code>
         service_t
        </code>
        ，用于处理客户端请求并生成响应。通过将回调函数传递给
        <code>
         TcpServer
        </code>
        构造函数，实现了逻辑的高度解耦。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        多线程处理客户端请求：
       </strong>
      </p>
      <ul>
       <li>
        使用
        <code>
         ThreadData
        </code>
        结构体封装了需要传递给新线程的参数。这包括
        <code>
         TcpServer
        </code>
        对象的指针、客户端套接字和客户端地址。
       </li>
       <li>
        在
        <code>
         Start
        </code>
        方法中，服务器循环接受新连接，每接受一个新连接就创建一个新线程来处理该连接，避免了阻塞其他客户端的请求。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        线程执行函数
        <code>
         Excute
        </code>
        ：
       </strong>
      </p>
      <ul>
       <li>
        <code>
         Excute
        </code>
        是一个静态成员函数，用于作为线程的执行函数。它接受一个
        <code>
         ThreadData
        </code>
        对象，调用回调函数处理请求并发送响应。
       </li>
       <li>
        静态成员函数不依赖于具体对象，因此不会受到
        <code>
         this
        </code>
        指针的干扰。通过将
        <code>
         ThreadData
        </code>
        对象传递给
        <code>
         Excute
        </code>
        函数，可以在函数内部访问
        <code>
         TcpServer
        </code>
        对象及其成员。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        资源管理：
       </strong>
      </p>
      <ul>
       <li>
        使用智能指针
        <code>
         SockSPtr
        </code>
        管理套接字对象，确保资源在适当的时候自动释放，避免内存泄漏。
       </li>
       <li>
        在
        <code>
         Excute
        </code>
        函数末尾关闭客户端套接字并释放
        <code>
         ThreadData
        </code>
        对象。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        日志记录：
       </strong>
      </p>
      <ul>
       <li>
        使用日志记录系统记录服务器操作和错误信息，方便调试和问题排查。
       </li>
      </ul>
     </li>
    </ol>
    <h4>
     <a id="_1065">
     </a>
     使用示例
    </h4>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"TcpServer.hpp"</span></span>

std<span class="token double-colon punctuation">::</span>string <span class="token function">echo_service</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>request<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token string">"Echo: "</span> <span class="token operator">+</span> request<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 设置日志系统</span>
    <span class="token function">ENABLE_SCREEN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SET_IGNORE_LEVEL</span><span class="token punctuation">(</span>log_ddsm<span class="token double-colon punctuation">::</span>DEBUG<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 创建TCP服务器</span>
    TcpServer <span class="token function">server</span><span class="token punctuation">(</span>echo_service<span class="token punctuation">,</span> <span class="token number">8888</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 启动服务器</span>
    server<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     在这个示例中，我们创建了一个
     <code>
      TcpServer
     </code>
     对象，传入了一个简单的回显服务
     <code>
      echo_service
     </code>
     。服务器在端口 8888 上监听，并处理客户端请求，将客户端发送的消息回显给客户端。
    </p>
    <h2>
     <a id="main_1093">
     </a>
     七、服务器main函数设计
    </h2>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Socket.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"TcpServer.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Http.hpp"</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> args<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 检查使用格式</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>args <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">,</span> <span class="token string">"Usage: %s localport\n"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 获取localport并传递给TcpServer构造</span>
    <span class="token keyword">uint16_t</span> localport <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">stoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 创建 HttpServer 对象</span>
    HttpServer hserver<span class="token punctuation">;</span>
    <span class="token comment">// 创建 TcpServer 对象，绑定 HttpServer::HanderHttpRequest 方法作为处理回调</span>
    std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>TcpServer<span class="token operator">&gt;</span> tsvr <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_unique</span><span class="token generic class-name"><span class="token operator">&lt;</span>TcpServer<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
        std<span class="token double-colon punctuation">::</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>HttpServer<span class="token double-colon punctuation">::</span>HanderHttpRequest<span class="token punctuation">,</span> <span class="token operator">&amp;</span>hserver<span class="token punctuation">,</span>
                  std<span class="token double-colon punctuation">::</span>placeholders<span class="token double-colon punctuation">::</span>_1<span class="token punctuation">)</span><span class="token punctuation">,</span>
        localport<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 启动 TcpServer</span>
    tsvr<span class="token operator">-&gt;</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*// NetCal cal;

    // IOService io_service(
    //     std::bind(&amp;NetCal::Calculator, &amp;cal,
    //               std::placeholders::_1));

    // // 耦合了io_service和tcpserver
    // std::unique_ptr&lt;TcpServer&gt; utsp = std::make_unique&lt;TcpServer&gt;(
    //     std::bind(&amp;IOService::IOExcute, &amp;io_service,
    //               std::placeholders::_1,
    //               std::placeholders::_2),
    //     localport);

    // utsp-&gt;Start();*/</span>
</code></pre>
    <blockquote>
     <p>
      <strong>
       上述代码实现了一个简单的 TCP 服务器，能够接受客户端的 HTTP 请求并进行处理。代码通过结合
       <code>
        TcpServer
       </code>
       和
       <code>
        HttpServer
       </code>
       类，实现了处理 HTTP 请求的功能。
      </strong>
     </p>
    </blockquote>
    <h4>
     <a id="_1142">
     </a>
     主要步骤和解释
    </h4>
    <ol>
     <li>
      <p>
       <strong>
        包含头文件：
       </strong>
      </p>
      <ul>
       <li>
        <code>
         #include "Socket.hpp"
        </code>
       </li>
       <li>
        <code>
         #include "TcpServer.hpp"
        </code>
       </li>
       <li>
        <code>
         #include "Http.hpp"
        </code>
       </li>
       <li>
        这些头文件包含了
        <code>
         Socket
        </code>
        类、
        <code>
         TcpServer
        </code>
        类和
        <code>
         HttpServer
        </code>
        类的定义和实现。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        <code>
         main
        </code>
        函数：
       </strong>
      </p>
      <ul>
       <li>
        <code>
         int main(int args, char *argv[])
        </code>
        定义了程序的入口点。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        检查命令行参数：
       </strong>
      </p>
      <ul>
       <li>
        <code>
         if (args != 2)
        </code>
        检查命令行参数的数量是否正确。如果参数数量不正确，则输出使用提示并终止程序。
       </li>
       <li>
        <code>
         LOG(INFO, "Usage: %s localport\n", argv[0]);
        </code>
        使用日志系统输出使用提示信息。
       </li>
       <li>
        <code>
         exit(0);
        </code>
        终止程序。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        获取本地端口：
       </strong>
      </p>
      <ul>
       <li>
        <code>
         uint16_t localport = std::stoi(argv[1]);
        </code>
        将命令行参数转换为整数，表示本地端口号。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        创建
        <code>
         HttpServer
        </code>
        对象：
       </strong>
      </p>
      <ul>
       <li>
        <code>
         HttpServer hserver;
        </code>
        创建一个
        <code>
         HttpServer
        </code>
        对象，用于处理 HTTP 请求。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        创建
        <code>
         TcpServer
        </code>
        对象：
       </strong>
      </p>
      <ul>
       <li>
        <code>
         std::unique_ptr&lt;TcpServer&gt; tsvr = std::make_unique&lt;TcpServer&gt;(...)
        </code>
        创建一个
        <code>
         TcpServer
        </code>
        对象，使用智能指针管理其生命周期。
       </li>
       <li>
        <code>
         std::bind(&amp;HttpServer::HanderHttpRequest, &amp;hserver, std::placeholders::_1)
        </code>
        将
        <code>
         HttpServer
        </code>
        的
        <code>
         HanderHttpRequest
        </code>
        方法绑定为
        <code>
         TcpServer
        </code>
        的回调函数，用于处理客户端请求。
       </li>
       <li>
        <code>
         localport
        </code>
        作为参数传递给
        <code>
         TcpServer
        </code>
        构造函数，指定服务器监听的端口。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        启动
        <code>
         TcpServer
        </code>
        ：
       </strong>
      </p>
      <ul>
       <li>
        <code>
         tsvr-&gt;Start();
        </code>
        启动
        <code>
         TcpServer
        </code>
        ，开始监听并处理客户端请求。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        返回值：
       </strong>
      </p>
      <ul>
       <li>
        <code>
         return 0;
        </code>
        表示程序成功结束。
       </li>
      </ul>
     </li>
    </ol>
    <blockquote>
     <p>
      <strong>
       这些头文件分别定义了
       <code>
        Socket
       </code>
       类、
       <code>
        TcpServer
       </code>
       类和
       <code>
        HttpServer
       </code>
       类的接口和实现。完整的实现可以参考上述解释中的类设计。
      </strong>
     </p>
    </blockquote>
    <h2>
     <a id="HTTP_1178">
     </a>
     八、应用层HTTP服务器的设计
    </h2>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">once</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fstream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sstream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;vector&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unordered_map&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"uncopyable.hpp"</span></span>

<span class="token keyword">const</span> <span class="token keyword">static</span> std<span class="token double-colon punctuation">::</span>string com_sep <span class="token operator">=</span> <span class="token string">"\r\n"</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">static</span> std<span class="token double-colon punctuation">::</span>string req_sep <span class="token operator">=</span> <span class="token string">": "</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">static</span> std<span class="token double-colon punctuation">::</span>string prefixpath <span class="token operator">=</span> <span class="token string">"wwwroot"</span><span class="token punctuation">;</span> <span class="token comment">// web根目录</span>
<span class="token keyword">const</span> <span class="token keyword">static</span> std<span class="token double-colon punctuation">::</span>string homepage <span class="token operator">=</span> <span class="token string">"index.html"</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">static</span> std<span class="token double-colon punctuation">::</span>string httpversion <span class="token operator">=</span> <span class="token string">"HTTP/1.0"</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">static</span> std<span class="token double-colon punctuation">::</span>string spacesep <span class="token operator">=</span> <span class="token string">" "</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">HttpRequest</span> <span class="token comment">// 根据Http请求的结构确定</span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token comment">/// @brief 获得正文内容之前的信息</span>
    <span class="token comment">/// @param reqstr</span>
    <span class="token comment">/// @return 当前调用获取的一行字符串</span>
    std<span class="token double-colon punctuation">::</span>string <span class="token function">Getline</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>reqstr<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">auto</span> pos <span class="token operator">=</span> reqstr<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>com_sep<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pos <span class="token operator">==</span> std<span class="token double-colon punctuation">::</span>string<span class="token double-colon punctuation">::</span>npos<span class="token punctuation">)</span>
            <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        std<span class="token double-colon punctuation">::</span>string line <span class="token operator">=</span> reqstr<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> pos<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 如果找到空行，则pos==0，截取出来的line是一个空串</span>
        reqstr<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> line<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> com_sep<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 若是，同样删掉空串</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>line<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> com_sep<span class="token punctuation">;</span> <span class="token comment">// 以这种方式返回，表示已经读取到空行</span>

        <span class="token keyword">return</span> line<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 解析请求行</span>
    <span class="token keyword">void</span> <span class="token function">PraseReqLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 创建一个字符串流，类似于cin，可以以空格为分隔符分别输入给多个变量</span>
        std<span class="token double-colon punctuation">::</span>stringstream <span class="token function">ss</span><span class="token punctuation">(</span>_req_line<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ss <span class="token operator">&gt;&gt;</span> _method <span class="token operator">&gt;&gt;</span> _url <span class="token operator">&gt;&gt;</span> _verson<span class="token punctuation">;</span>

        <span class="token comment">// 构建真正的资源路径</span>
        _path <span class="token operator">+=</span> _url<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>_path<span class="token punctuation">[</span>_path<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'/'</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _path <span class="token operator">+=</span> homepage<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 解析请求头</span>
    <span class="token keyword">void</span> <span class="token function">PraseReqHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> <span class="token operator">&amp;</span>header <span class="token operator">:</span> _req_headers<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">auto</span> pos <span class="token operator">=</span> header<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>req_sep<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pos <span class="token operator">==</span> std<span class="token double-colon punctuation">::</span>string<span class="token double-colon punctuation">::</span>npos<span class="token punctuation">)</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            std<span class="token double-colon punctuation">::</span>string k <span class="token operator">=</span> header<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
            std<span class="token double-colon punctuation">::</span>string v <span class="token operator">=</span> header<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span>pos <span class="token operator">+</span> req_sep<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>k<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> v<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            _headers_kv<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">make_pair</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">HttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token function">_blank_line</span><span class="token punctuation">(</span>com_sep<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_path</span><span class="token punctuation">(</span>prefixpath<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// @brief 反序列化，解析HTTP请求内容</span>
    <span class="token comment">/// @param reqstr 请求以字符串形式发送</span>
    <span class="token keyword">void</span> <span class="token function">Deserialize</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>reqstr<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 基础反序列化</span>
        _req_line <span class="token operator">=</span> <span class="token function">Getline</span><span class="token punctuation">(</span>reqstr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取请求行</span>
        std<span class="token double-colon punctuation">::</span>string header<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            header <span class="token operator">=</span> <span class="token function">Getline</span><span class="token punctuation">(</span>reqstr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>header<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>header <span class="token operator">==</span> com_sep<span class="token punctuation">)</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>

            _req_headers<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>header<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 到这里，请求行和报头，空行被获取完</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>reqstr<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            _body_text <span class="token operator">=</span> reqstr<span class="token punctuation">;</span>

        <span class="token comment">// 进一步反序列化(填写属性字段)</span>
        <span class="token function">PraseReqLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">PraseReqHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">Print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"请求行:"</span> <span class="token operator">&lt;&lt;</span> _req_line <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> <span class="token operator">&amp;</span>header <span class="token operator">:</span> _req_headers<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"报头:"</span> <span class="token operator">&lt;&lt;</span> header <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"空行:"</span> <span class="token operator">&lt;&lt;</span> _blank_line<span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"正文:"</span> <span class="token operator">&lt;&lt;</span> _body_text <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>

        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"method:"</span> <span class="token operator">&lt;&lt;</span> _method <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"url:"</span> <span class="token operator">&lt;&lt;</span> _url <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"verson:"</span> <span class="token operator">&lt;&lt;</span> _verson <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> header <span class="token operator">:</span> _headers_kv<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> header<span class="token punctuation">.</span>first <span class="token operator">&lt;&lt;</span> <span class="token string">" "</span> <span class="token operator">&lt;&lt;</span> header<span class="token punctuation">.</span>second <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    std<span class="token double-colon punctuation">::</span>string <span class="token function">GetUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">LOG</span><span class="token punctuation">(</span>DEBUG<span class="token punctuation">,</span> <span class="token string">"client want url %s\n"</span><span class="token punctuation">,</span> _url<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> _url<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    std<span class="token double-colon punctuation">::</span>string <span class="token function">GetPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">LOG</span><span class="token punctuation">(</span>DEBUG<span class="token punctuation">,</span> <span class="token string">"client want path %s\n"</span><span class="token punctuation">,</span> _path<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> _path<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token comment">// 基本的HTTP请求格式</span>
    std<span class="token double-colon punctuation">::</span>string _req_line<span class="token punctuation">;</span> <span class="token comment">// 请求行</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">&gt;</span> _req_headers<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>string _blank_line<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>string _body_text<span class="token punctuation">;</span>

    <span class="token comment">// 具体的属性字段，需要进一步反序列化</span>
    std<span class="token double-colon punctuation">::</span>string _method<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>string _url<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>string _path<span class="token punctuation">;</span> <span class="token comment">// 用户请求的资源的真实路径，路径前需要拼上wwwroot</span>
    std<span class="token double-colon punctuation">::</span>string _verson<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>unordered_map<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>string<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&gt;</span> _headers_kv<span class="token punctuation">;</span> <span class="token comment">// 存储属性字段KV结构</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">HttpReponse</span> <span class="token comment">// 根据HTTP响应的结构确定</span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">HttpReponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">_version</span><span class="token punctuation">(</span>httpversion<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_blank_line</span><span class="token punctuation">(</span>com_sep<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 添加状态码</span>
    <span class="token keyword">void</span> <span class="token function">AddCode</span><span class="token punctuation">(</span><span class="token keyword">int</span> code<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        _status_code <span class="token operator">=</span> code<span class="token punctuation">;</span>
        _desc <span class="token operator">=</span> <span class="token string">"OK"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 添加响应头</span>
    <span class="token keyword">void</span> <span class="token function">AddHeader</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>k<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>v<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        _headers_kv<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> v<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 添加响应正文</span>
    <span class="token keyword">void</span> <span class="token function">AddBodyText</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>body_text<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        _resp_body_text <span class="token operator">=</span> body_text<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 序列化响应内容</span>
    std<span class="token double-colon punctuation">::</span>string <span class="token function">Serialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 构建状态行</span>
        _status_line <span class="token operator">=</span> _version <span class="token operator">+</span> spacesep <span class="token operator">+</span> std<span class="token double-colon punctuation">::</span><span class="token function">to_string</span><span class="token punctuation">(</span>_status_code<span class="token punctuation">)</span> <span class="token operator">+</span> spacesep <span class="token operator">+</span> _desc <span class="token operator">+</span> com_sep<span class="token punctuation">;</span>
        <span class="token comment">// 构建应答报头</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> <span class="token operator">&amp;</span>header <span class="token operator">:</span> _headers_kv<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            std<span class="token double-colon punctuation">::</span>string header_line <span class="token operator">=</span> header<span class="token punctuation">.</span>first <span class="token operator">+</span> req_sep <span class="token operator">+</span> header<span class="token punctuation">.</span>second <span class="token operator">+</span> com_sep<span class="token punctuation">;</span>
            _resp_headers<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>header_line<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 空行和正文</span>
        <span class="token comment">// 正式序列化---构建HTTP应答报文</span>
        std<span class="token double-colon punctuation">::</span>string responsestr <span class="token operator">=</span> _status_line<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> <span class="token operator">&amp;</span>line_kv <span class="token operator">:</span> _resp_headers<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            responsestr <span class="token operator">+=</span> line_kv<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        responsestr <span class="token operator">+=</span> _blank_line<span class="token punctuation">;</span>
        responsestr <span class="token operator">+=</span> _resp_body_text<span class="token punctuation">;</span>

        <span class="token keyword">return</span> responsestr<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token operator">~</span><span class="token function">HttpReponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token comment">// HttpReponse 基本属性</span>
    std<span class="token double-colon punctuation">::</span>string _version<span class="token punctuation">;</span>                                     <span class="token comment">// 版本</span>
    <span class="token keyword">int</span> _status_code<span class="token punctuation">;</span>                                         <span class="token comment">// 状态码</span>
    std<span class="token double-colon punctuation">::</span>string _desc<span class="token punctuation">;</span>                                        <span class="token comment">// 状态描述</span>
    std<span class="token double-colon punctuation">::</span>unordered_map<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>string<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&gt;</span> _headers_kv<span class="token punctuation">;</span> <span class="token comment">// 属性KV</span>

    <span class="token comment">// HTTP报文格式</span>
    std<span class="token double-colon punctuation">::</span>string _status_line<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">&gt;</span> _resp_headers<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>string _blank_line<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>string _resp_body_text<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">HttpServer</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">uncopyable</span></span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token comment">// 获取文件内容</span>
    std<span class="token double-colon punctuation">::</span>string <span class="token function">GetFileContent</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>path<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        std<span class="token double-colon punctuation">::</span>ifstream <span class="token function">in</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>ios<span class="token double-colon punctuation">::</span>binary<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>in<span class="token punctuation">.</span><span class="token function">is_open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 通过获得偏移量的方法计算文件大小</span>
        in<span class="token punctuation">.</span><span class="token function">seekg</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> in<span class="token punctuation">.</span>end<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> f_size <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">tellg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        in<span class="token punctuation">.</span><span class="token function">seekg</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> in<span class="token punctuation">.</span>beg<span class="token punctuation">)</span><span class="token punctuation">;</span>

        std<span class="token double-colon punctuation">::</span>string content<span class="token punctuation">;</span>
        content<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>f_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>content<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> f_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        in<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> content<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">HttpServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

    <span class="token comment">// 处理HTTP请求</span>
    std<span class="token double-colon punctuation">::</span>string <span class="token function">HanderHttpRequest</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>reqstr<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">DEBUG</span></span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"---------------------------------------------"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> reqstr<span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>string responsestr <span class="token operator">=</span> <span class="token string">"HTTP/1.1 200 OK\r\n"</span><span class="token punctuation">;</span>
        responsestr <span class="token operator">+=</span> <span class="token string">"Content-Type: text/html\r\n"</span><span class="token punctuation">;</span>
        responsestr <span class="token operator">+=</span> <span class="token string">"\r\n"</span><span class="token punctuation">;</span>
        responsestr <span class="token operator">+=</span> <span class="token string">"&lt;html&gt;&lt;h1&gt;hello linux!&lt;/h1&gt;&lt;/html&gt;"</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> responsestr<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
        HttpRequest req<span class="token punctuation">;</span>
        req<span class="token punctuation">.</span><span class="token function">Deserialize</span><span class="token punctuation">(</span>reqstr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>string content <span class="token operator">=</span> <span class="token function">GetFileContent</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token function">GetPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取文件内容</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>content<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 读取失败，不考虑</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// req.Print();</span>
        <span class="token comment">// std::string url = req.GetUrl();</span>
        <span class="token comment">// std::string path = req.GetPath();</span>

        <span class="token comment">// 到这里，读取一定成功</span>
        HttpReponse rsp<span class="token punctuation">;</span>
        rsp<span class="token punctuation">.</span><span class="token function">AddCode</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rsp<span class="token punctuation">.</span><span class="token function">AddHeader</span><span class="token punctuation">(</span><span class="token string">"Content-Length"</span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span><span class="token function">to_string</span><span class="token punctuation">(</span>content<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rsp<span class="token punctuation">.</span><span class="token function">AddBodyText</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> rsp<span class="token punctuation">.</span><span class="token function">Serialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    <span class="token punctuation">}</span>

    <span class="token operator">~</span><span class="token function">HttpServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <blockquote>
     <p>
      <strong>
       上述代码实现了一个简单的 HTTP 服务器，能够接收 HTTP 请求并返回响应。代码使用了面向对象编程的思想，定义了
       <code>
        HttpRequest
       </code>
       、
       <code>
        HttpReponse
       </code>
       和
       <code>
        HttpServer
       </code>
       三个类，分别用于处理 HTTP 请求、构建 HTTP 响应和管理服务器逻辑。
      </strong>
     </p>
    </blockquote>
    <h4>
     <a id="_1466">
     </a>
     解释
    </h4>
    <ol>
     <li>
      <p>
       <strong>
        HttpRequest 类：
       </strong>
      </p>
      <ul>
       <li>
        用于解析 HTTP 请求，提取请求行、请求头和请求正文。
       </li>
       <li>
        <code>
         Deserialize
        </code>
        方法通过分割字符串的方式解析请求报文，并调用
        <code>
         PraseReqLine
        </code>
        和
        <code>
         PraseReqHeader
        </code>
        方法进一步解析请求行和请求头。
       </li>
       <li>
        <code>
         Getline
        </code>
        方法用于从请求字符串中读取一行内容。
       </li>
       <li>
        <code>
         Print
        </code>
        方法用于打印请求的详细信息（用于调试）。
       </li>
       <li>
        <code>
         GetUrl
        </code>
        和
        <code>
         GetPath
        </code>
        方法用于获取请求的 URL 和路径。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        HttpReponse 类：
       </strong>
      </p>
      <ul>
       <li>
        用于构建 HTTP 响应，包含状态行、响应头和响应正文。
       </li>
       <li>
        <code>
         AddCode
        </code>
        方法用于添加响应状态码。
       </li>
       <li>
        <code>
         AddHeader
        </code>
        方法用于添加响应头。
       </li>
       <li>
        <code>
         AddBodyText
        </code>
        方法用于添加响应正文。
       </li>
       <li>
        <code>
         Serialize
        </code>
        方法用于将响应对象序列化为字符串，准备发送给客户端。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        HttpServer 类：
       </strong>
      </p>
      <ul>
       <li>
        用于处理 HTTP 请求并生成响应。
       </li>
       <li>
        <code>
         GetFileContent
        </code>
        方法用于读取请求的文件内容。
       </li>
       <li>
        <code>
         HanderHttpRequest
        </code>
        方法用于处理 HTTP 请求，解析请求并生成响应。
        <ul>
         <li>
          在调试模式下（
          <code>
           #ifdef DEBUG
          </code>
          ），直接返回一个简单的 HTML 响应。
         </li>
         <li>
          在非调试模式下，解析请求并读取请求文件内容，构建 HTTP 响应对象并序列化为字符串返回。
         </li>
        </ul>
       </li>
       <li>
        继承自
        <code>
         uncopyable
        </code>
        类，确保
        <code>
         HttpServer
        </code>
        对象不能被拷贝，避免资源管理问题。
       </li>
      </ul>
     </li>
    </ol>
    <h4>
     <a id="_1490">
     </a>
     使用示例
    </h4>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Socket.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"TcpServer.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Http.hpp"</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> args<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 检查使用格式</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>args <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">,</span> <span class="token string">"Usage: %s localport\n"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 获取localport并传递给TcpServer构造</span>
    <span class="token keyword">uint16_t</span> localport <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">stoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 创建 HttpServer 对象</span>
    HttpServer hserver<span class="token punctuation">;</span>
    <span class="token comment">// 创建 TcpServer 对象，绑定 HttpServer::HanderHttpRequest 方法作为处理回调</span>
    std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>TcpServer<span class="token operator">&gt;</span> tsvr <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_unique</span><span class="token generic class-name"><span class="token operator">&lt;</span>TcpServer<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
        std<span class="token double-colon punctuation">::</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>HttpServer<span class="token double-colon punctuation">::</span>HanderHttpRequest<span class="token punctuation">,</span> <span class="token operator">&amp;</span>hserver<span class="token punctuation">,</span>
                  std<span class="token double-colon punctuation">::</span>placeholders<span class="token double-colon punctuation">::</span>_1<span class="token punctuation">)</span><span class="token punctuation">,</span>
        localport<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 启动 TcpServer</span>
    tsvr<span class="token operator">-&gt;</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     在这个示例中，我们创建了一个
     <code>
      TcpServer
     </code>
     对象，传入了一个
     <code>
      HttpServer
     </code>
     对象的
     <code>
      HanderHttpRequest
     </code>
     方法作为回调函数，用于处理客户端的 HTTP 请求。服务器在指定端口上监听，并处理客户端请求返回响应。
    </p>
    <hr/>
    <blockquote>
     <p>
      <strong>
       通过以上的分模块的设计，我们已经实现了一个简单的HTTP服务器，它可以接受HTTP报文，并响应返回对应请求的超文本资源。
      </strong>
     </p>
    </blockquote>
    <hr/>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/aad52aaf35114ba1a95b1dd08f84e090.jpeg#pic_center">
      <br/>
      <strong>
       完~
       <br/>
       转载请注明出处
      </strong>
     </img>
    </p>
   </div>
   <link href="./../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="./../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f:672e6373646e2e6e65742f323330315f37393436353338382f:61727469636c652f64657461696c732f313436313134303531" class_="artid" style="display:none">
 </p>
</div>


