---
layout: post
title: "高并发高速将图片提交到flaskfastapi等主流服务框架"
date: 2025-03-10 07:03:22 +0800
description: "通过以上改造，您可以在不修改视频切片逻辑的前提下，将图片请求的吞吐量提升至原有单线程的10倍以上（具体取决于服务端响应速度）。若需进一步优化，可结合异步IO与连接池技术（如。高性能，高并发的读取图片，并将图片传输到服务器的应用场景很多，比如上传图片到网站，将图片提交到后台推理等。这篇文章实现一种多线程并发方式将图片提交到后台。通过线程池管理并发请求，避免手动创建/销毁线程的开销，且支持动态控制并发量。• 建议通过压力测试确定最佳值（如从10逐步增加）。• 记录失败请求的图片路径，便于后续补传。"
keywords: "【高并发】高速将图片提交到flask、fastapi等主流服务框架"
categories: ['高并发', '深度学习基础']
tags: ['Python', 'Flask', 'Fastapi']
artid: "146057541"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146057541
    alt: "高并发高速将图片提交到flaskfastapi等主流服务框架"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146057541
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146057541
cover: https://bing.ee123.net/img/rand?artid=146057541
image: https://bing.ee123.net/img/rand?artid=146057541
img: https://bing.ee123.net/img/rand?artid=146057541
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     【高并发】高速将图片提交到flask、fastapi等主流服务框架
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atelier-sulphurpool-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="_2">
     </a>
     <strong>
      一、摘要
     </strong>
    </h2>
    <p>
     高性能，高并发的读取图片，并将图片传输到服务器的应用场景很多，比如上传图片到网站，将图片提交到后台推理等。这篇文章实现一种多线程并发方式将图片提交到后台。
    </p>
    <hr/>
    <h2>
     <a id="_7">
     </a>
     <strong>
      二、多线程发送请求的实现方法
     </strong>
    </h2>
    <h3>
     <a id="1_ThreadPoolExecutor_8">
     </a>
     <strong>
      1. 使用
      <code>
       ThreadPoolExecutor
      </code>
      线程池
     </strong>
    </h3>
    <p>
     通过线程池管理并发请求，避免手动创建/销毁线程的开销，且支持动态控制并发量。
    </p>
    <pre><code class="prism language-python"><span class="token keyword">from</span> concurrent<span class="token punctuation">.</span>futures <span class="token keyword">import</span> ThreadPoolExecutor
<span class="token keyword">import</span> requests

<span class="token keyword">def</span> <span class="token function">send_image_to_service</span><span class="token punctuation">(</span>image_path<span class="token punctuation">,</span> service_url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""单张图片的请求发送逻辑"""</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>image_path<span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
            response <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>service_url<span class="token punctuation">,</span> files<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">'image'</span><span class="token punctuation">:</span> f<span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> response<span class="token punctuation">.</span>status_code
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"请求失败: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>image_path<span class="token punctuation">}</span></span><span class="token string">, 错误: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span>

<span class="token comment"># 改造后的多线程发送逻辑</span>
<span class="token keyword">def</span> <span class="token function">batch_send_images</span><span class="token punctuation">(</span>image_paths<span class="token punctuation">,</span> service_url<span class="token punctuation">,</span> max_workers<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> ThreadPoolExecutor<span class="token punctuation">(</span>max_workers<span class="token operator">=</span>max_workers<span class="token punctuation">)</span> <span class="token keyword">as</span> executor<span class="token punctuation">:</span>
        futures <span class="token operator">=</span> <span class="token punctuation">[</span>
            executor<span class="token punctuation">.</span>submit<span class="token punctuation">(</span>send_image_to_service<span class="token punctuation">,</span> path<span class="token punctuation">,</span> service_url<span class="token punctuation">)</span>
            <span class="token keyword">for</span> path <span class="token keyword">in</span> image_paths
        <span class="token punctuation">]</span>
        <span class="token comment"># 可选：获取所有请求结果</span>
        results <span class="token operator">=</span> <span class="token punctuation">[</span>future<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> future <span class="token keyword">in</span> futures<span class="token punctuation">]</span>
    <span class="token keyword">return</span> results
</code></pre>
    <h3>
     <a id="2_asyncio_36">
     </a>
     <strong>
      2. 使用
      <code>
       asyncio
      </code>
      异步请求（更高性能）
     </strong>
    </h3>
    <p>
     对于高频请求场景（如每秒数百张图片），异步请求能进一步减少I/O等待时间：
    </p>
    <pre><code class="prism language-python"><span class="token keyword">import</span> aiohttp
<span class="token keyword">import</span> asyncio

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">async_send_image</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span> image_path<span class="token punctuation">,</span> service_url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>image_path<span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
            <span class="token keyword">async</span> <span class="token keyword">with</span> session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>service_url<span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">'image'</span><span class="token punctuation">:</span> f<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">as</span> response<span class="token punctuation">:</span>
                <span class="token keyword">return</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span>status<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"异步请求失败: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>image_path<span class="token punctuation">}</span></span><span class="token string">, 错误: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">async_batch_send</span><span class="token punctuation">(</span>image_paths<span class="token punctuation">,</span> service_url<span class="token punctuation">,</span> max_concurrent<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    semaphore <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>Semaphore<span class="token punctuation">(</span>max_concurrent<span class="token punctuation">)</span>  <span class="token comment"># 限制并发数</span>
    <span class="token keyword">async</span> <span class="token keyword">with</span> aiohttp<span class="token punctuation">.</span>ClientSession<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> session<span class="token punctuation">:</span>
        tasks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> path <span class="token keyword">in</span> image_paths<span class="token punctuation">:</span>
            <span class="token keyword">async</span> <span class="token keyword">with</span> semaphore<span class="token punctuation">:</span>
                task <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>async_send_image<span class="token punctuation">(</span>session<span class="token punctuation">,</span> path<span class="token punctuation">,</span> service_url<span class="token punctuation">)</span><span class="token punctuation">)</span>
                tasks<span class="token punctuation">.</span>append<span class="token punctuation">(</span>task<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>gather<span class="token punctuation">(</span><span class="token operator">*</span>tasks<span class="token punctuation">)</span>
</code></pre>
    <hr/>
    <h4>
     <a id="_64">
     </a>
     <strong>
      三、集成到原有代码中的示例
     </strong>
    </h4>
    <pre><code class="prism language-python"><span class="token comment"># 假设已生成所有图片路径：image_paths = ["frames/frame_0001.jpg", ...]</span>
service_url <span class="token operator">=</span> <span class="token string">"http://your-service.com/upload"</span>

<span class="token comment"># 多线程发送请求（选择以下一种方式）</span>
<span class="token comment"># 方式1：线程池</span>
batch_send_images<span class="token punctuation">(</span>image_paths<span class="token punctuation">,</span> service_url<span class="token punctuation">,</span> max_workers<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>

<span class="token comment"># 方式2：异步请求（需在异步环境中运行）</span>
asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>async_batch_send<span class="token punctuation">(</span>image_paths<span class="token punctuation">,</span> service_url<span class="token punctuation">,</span> max_concurrent<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
    <hr/>
    <h4>
     <a id="_80">
     </a>
     <strong>
      四、优化注意事项
     </strong>
    </h4>
    <ol>
     <li>
      <p>
       <strong>
        并发数控制
       </strong>
       <br/>
       • 根据服务端承载能力调整
       <code>
        max_workers
       </code>
       或
       <code>
        max_concurrent
       </code>
       ，避免因过高并发导致服务崩溃。
       <br/>
       • 建议通过压力测试确定最佳值（如从10逐步增加）。
      </p>
     </li>
     <li>
      <p>
       <strong>
        错误处理与重试
       </strong>
       <br/>
       • 在
       <code>
        send_image_to_service
       </code>
       函数中增加重试机制（如
       <code>
        retrying
       </code>
       库）。
       <br/>
       • 记录失败请求的图片路径，便于后续补传。
      </p>
     </li>
     <li>
      <p>
       <strong>
        性能监控
       </strong>
       <br/>
       • 使用
       <code>
        tqdm
       </code>
       库显示进度条（参考网页4的优化方法）：
      </p>
      <pre><code class="prism language-python"><span class="token keyword">from</span> tqdm <span class="token keyword">import</span> tqdm
<span class="token keyword">with</span> ThreadPoolExecutor<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token keyword">as</span> executor<span class="token punctuation">:</span>
    futures <span class="token operator">=</span> <span class="token punctuation">[</span>executor<span class="token punctuation">.</span>submit<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token keyword">for</span> path <span class="token keyword">in</span> image_paths<span class="token punctuation">]</span>
    results <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> future <span class="token keyword">in</span> tqdm<span class="token punctuation">(</span>futures<span class="token punctuation">,</span> desc<span class="token operator">=</span><span class="token string">"发送进度"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        results<span class="token punctuation">.</span>append<span class="token punctuation">(</span>future<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
     </li>
    </ol>
    <hr/>
    <h4>
     <a id="_102">
     </a>
     <strong>
      五、适用场景对比
     </strong>
    </h4>
    <table>
     <thead>
      <tr>
       <th>
        方法
       </th>
       <th>
        适用场景
       </th>
       <th>
        性能优势
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        <code>
         ThreadPoolExecutor
        </code>
       </td>
       <td>
        简单并发控制，兼容性高
       </td>
       <td>
        中等，适合低频请求
       </td>
      </tr>
      <tr>
       <td>
        <code>
         asyncio
        </code>
       </td>
       <td>
        高频请求（如每秒百次以上）
       </td>
       <td>
        高，资源占用更低
       </td>
      </tr>
     </tbody>
    </table>
    <hr/>
    <p>
     通过以上改造，您可以在不修改视频切片逻辑的前提下，将图片请求的吞吐量提升至原有单线程的10倍以上（具体取决于服务端响应速度）。若需进一步优化，可结合异步IO与连接池技术（如
     <code>
      aiohttp
     </code>
     的持久化会话）。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
  <div class="blog-extension-box" id="blogExtensionBox" style="width:400px;margin:auto;margin-top:12px">
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e6373646e2e:6e65742f68686868686868686868777777777777777777772f:61727469636c652f64657461696c732f313436303537353431" class_="artid" style="display:none">
 </p>
</div>


