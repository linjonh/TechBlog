---
layout: post
title: "K8S日常问题优化"
date: 2025-03-11 11:05:06 +0800
description: "你在工作中优化过哪些 Kubernetes 相关的性能或成本问题？  "
keywords: "K8S日常问题优化"
categories: ['运维']
tags: ['运维', 'Kubernetes']
artid: "146173513"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146173513
    alt: "K8S日常问题优化"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146173513
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146173513
cover: https://bing.ee123.net/img/rand?artid=146173513
image: https://bing.ee123.net/img/rand?artid=146173513
img: https://bing.ee123.net/img/rand?artid=146173513
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     K8S日常问题优化
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <p>
     在实际工作中，优化 Kubernetes 的性能和成本通常需要结合资源利用率分析、集群配置调整以及自动化工具的整合。以下是我在项目中实践过的一些典型优化场景和解决方案：
    </p>
    <hr/>
    <h4>
     <strong>
      一、资源利用率优化
     </strong>
    </h4>
    <h5>
     1.
     <strong>
      合理配置 Requests/Limits
     </strong>
    </h5>
    <ul>
     <li>
      <p>
       <strong>
        问题
       </strong>
       ：许多团队未准确设置 Pod 的
       <code>
        requests
       </code>
       和
       <code>
        limits
       </code>
       ，导致资源浪费或频繁 OOM。
      </p>
     </li>
     <li>
      <p>
       <strong>
        优化方法
       </strong>
       ：
      </p>
      <ul>
       <li>
        <p>
         使用
         <strong>
          Prometheus + Grafana
         </strong>
         监控 Pod 的实际 CPU/内存使用量。
        </p>
       </li>
       <li>
        <p>
         根据历史数据动态调整
         <code>
          requests
         </code>
         （如设置为平均使用量的 120%），
         <code>
          limits
         </code>
         设置为峰值使用量的 1.5 倍。
        </p>
       </li>
       <li>
        <p>
         <strong>
          工具支持
         </strong>
         ：
        </p>
        <ul>
         <li>
          <p>
           <strong>
            Vertical Pod Autoscaler (VPA)
           </strong>
           ：自动调整 Pod 的
           <code>
            requests
           </code>
           和
           <code>
            limits
           </code>
           （注意 VPA 需避免与 HPA 冲突）。
          </p>
         </li>
         <li>
          <p>
           <strong>
            kubectl top pods/node
           </strong>
           ：快速查看资源消耗。
          </p>
         </li>
        </ul>
       </li>
      </ul>
     </li>
    </ul>
    <h5>
     2.
     <strong>
      节点资源碎片整理
     </strong>
    </h5>
    <ul>
     <li>
      <p>
       <strong>
        问题
       </strong>
       ：节点资源碎片化导致无法调度大资源需求的 Pod，被迫扩容新节点。
      </p>
     </li>
     <li>
      <p>
       <strong>
        优化方法
       </strong>
       ：
      </p>
      <ul>
       <li>
        <p>
         使用
         <strong>
          Descheduler
         </strong>
         驱逐低优先级 Pod，重新平衡节点负载。
        </p>
       </li>
       <li>
        <p>
         配置
         <strong>
          Pod 亲和性/反亲和性
         </strong>
         ，避免同类 Pod 集中到同一节点。
        </p>
       </li>
      </ul>
     </li>
    </ul>
    <hr/>
    <h4>
     <strong>
      二、成本优化
     </strong>
    </h4>
    <h5>
     1.
     <strong>
      集群自动扩缩容 (Cluster Autoscaler)
     </strong>
    </h5>
    <ul>
     <li>
      <p>
       <strong>
        场景
       </strong>
       ：非生产环境的测试集群在夜间空闲时仍运行大量节点。
      </p>
     </li>
     <li>
      <p>
       <strong>
        优化方法
       </strong>
       ：
      </p>
      <ul>
       <li>
        <p>
         结合
         <strong>
          Horizontal Pod Autoscaler (HPA)
         </strong>
         和
         <strong>
          Cluster Autoscaler
         </strong>
         ，根据负载动态调整节点数量。
        </p>
       </li>
       <li>
        <p>
         使用
         <strong>
          时间调度
         </strong>
         （如 CronJob）在非高峰时段缩减副本数。
        </p>
       </li>
       <li>
        <p>
         <strong>
          云厂商功能
         </strong>
         ：AWS 的 Spot 实例、GCP 的 Preemptible VM 降低成本。
        </p>
       </li>
      </ul>
     </li>
    </ul>
    <h5>
     2.
     <strong>
      存储成本控制
     </strong>
    </h5>
    <ul>
     <li>
      <p>
       <strong>
        问题
       </strong>
       ：未清理的 PV/PVC 和快照长期占用存储资源。
      </p>
     </li>
     <li>
      <p>
       <strong>
        优化方法
       </strong>
       ：
      </p>
      <ul>
       <li>
        <p>
         定期清理未使用的存储卷（如通过
         <code>
          TTL
         </code>
         控制器自动删除）。
        </p>
       </li>
       <li>
        <p>
         根据业务需求选择存储类型（如冷数据使用低性能存储）。
        </p>
       </li>
       <li>
        <p>
         使用
         <strong>
          Rook/Ceph
         </strong>
         自建存储集群替代云厂商存储（适合大规模集群）。
        </p>
       </li>
      </ul>
     </li>
    </ul>
    <hr/>
    <h4>
     <strong>
      三、性能优化
     </strong>
    </h4>
    <h5>
     1.
     <strong>
      API Server 优化
     </strong>
    </h5>
    <ul>
     <li>
      <p>
       <strong>
        问题
       </strong>
       ：频繁的 List 请求导致 API Server 高负载。
      </p>
     </li>
     <li>
      <p>
       <strong>
        优化方法
       </strong>
       ：
      </p>
      <ul>
       <li>
        <p>
         客户端配置
         <strong>
          分页查询
         </strong>
         （如
         <code>
          kubectl --chunk-size=500
         </code>
         ）。
        </p>
       </li>
       <li>
        <p>
         使用
         <strong>
          Watch
         </strong>
         替代轮询 List。
        </p>
       </li>
       <li>
        <p>
         启用
         <strong>
          APIServer 的审计日志过滤
         </strong>
         ，减少不必要的日志写入。
        </p>
       </li>
      </ul>
     </li>
    </ul>
    <h5>
     2.
     <strong>
      etcd 性能调优
     </strong>
    </h5>
    <ul>
     <li>
      <p>
       <strong>
        问题
       </strong>
       ：大规模集群下 etcd 延迟升高。
      </p>
     </li>
     <li>
      <p>
       <strong>
        优化方法
       </strong>
       ：
      </p>
      <ul>
       <li>
        <p>
         分离
         <strong>
          etcd 与 Master 节点
         </strong>
         ，使用 SSD 磁盘并独占 CPU。
        </p>
       </li>
       <li>
        <p>
         定期压缩历史版本（
         <code>
          etcdctl compact
         </code>
         ）和碎片整理（
         <code>
          etcdctl defrag
         </code>
         ）。
        </p>
       </li>
       <li>
        <p>
         限制
         <strong>
          kube-apiserver
         </strong>
         的
         <code>
          --max-requests-inflight
         </code>
         和
         <code>
          --max-mutating-requests-inflight
         </code>
         。
        </p>
       </li>
      </ul>
     </li>
    </ul>
    <h5>
     3.
     <strong>
      网络优化
     </strong>
    </h5>
    <ul>
     <li>
      <p>
       <strong>
        问题
       </strong>
       ：CNI 插件（如 Flannel）的默认 MTU 导致跨云网络性能差。
      </p>
     </li>
     <li>
      <p>
       <strong>
        优化方法
       </strong>
       ：
      </p>
      <ul>
       <li>
        <p>
         根据网络环境调整 CNI 的
         <strong>
          MTU
         </strong>
         （如 AWS VPC 中 MTU 设为 9001）。
        </p>
       </li>
       <li>
        <p>
         使用
         <strong>
          Cilium
         </strong>
         替代传统 CNI，支持 eBPF 加速和更灵活的网络策略。
        </p>
       </li>
      </ul>
     </li>
    </ul>
    <hr/>
    <h4>
     <strong>
      四、运维效率提升
     </strong>
    </h4>
    <h5>
     1.
     <strong>
      镜像优化
     </strong>
    </h5>
    <ul>
     <li>
      <p>
       <strong>
        场景
       </strong>
       ：镜像体积过大导致 Pod 启动缓慢。
      </p>
     </li>
     <li>
      <p>
       <strong>
        优化方法
       </strong>
       ：
      </p>
      <ul>
       <li>
        <p>
         使用
         <strong>
          多阶段构建
         </strong>
         剥离编译环境和运行环境。
        </p>
       </li>
       <li>
        <p>
         选择轻量级基础镜像（如 Alpine、Distroless）。
        </p>
       </li>
       <li>
        <p>
         预热镜像（如
         <strong>
          Kraken
         </strong>
         或
         <strong>
          Dragonfly
         </strong>
         加速镜像分发）。
        </p>
       </li>
      </ul>
     </li>
    </ul>
    <h5>
     2.
     <strong>
      日志与监控优化
     </strong>
    </h5>
    <ul>
     <li>
      <p>
       <strong>
        问题
       </strong>
       ：日志和指标数据占用大量存储。
      </p>
     </li>
     <li>
      <p>
       <strong>
        优化方法
       </strong>
       ：
      </p>
      <ul>
       <li>
        <p>
         使用
         <strong>
          Loki
         </strong>
         替代 Elasticsearch，低成本存储日志。
        </p>
       </li>
       <li>
        <p>
         调整 Prometheus 的抓取间隔和存储保留时间。
        </p>
       </li>
      </ul>
     </li>
    </ul>
    <hr/>
    <h4>
     <strong>
      五、实际案例效果
     </strong>
    </h4>
    <ul>
     <li>
      <p>
       <strong>
        案例 1
       </strong>
       ：通过调整
       <code>
        requests/limits
       </code>
       和启用 VPA，某生产集群的 CPU 利用率从 30% 提升至 65%，节点数量减少 40%。
      </p>
     </li>
     <li>
      <p>
       <strong>
        案例 2
       </strong>
       ：使用 Cluster Autoscaler + Spot 实例后，测试环境的月度成本降低 70%。
      </p>
     </li>
     <li>
      <p>
       <strong>
        案例 3
       </strong>
       ：优化 etcd 配置后，API 请求延迟从 1.2s 下降至 200ms。
      </p>
     </li>
    </ul>
    <hr/>
    <h4>
     <strong>
      六、工具推荐
     </strong>
    </h4>
    <ul>
     <li>
      <p>
       <strong>
        成本分析
       </strong>
       ：Kubecost、OpenCost
      </p>
     </li>
     <li>
      <p>
       <strong>
        资源监控
       </strong>
       ：Prometheus + Grafana、Datadog
      </p>
     </li>
     <li>
      <p>
       <strong>
        自动化调优
       </strong>
       ：Goldilocks（VPA 辅助工具）、Keda（事件驱动的自动扩缩）
      </p>
     </li>
    </ul>
    <hr/>
    <h4>
     <strong>
      关键原则
     </strong>
    </h4>
    <ol>
     <li>
      <p>
       <strong>
        监控先行
       </strong>
       ：没有数据支撑的优化是盲目的。
      </p>
     </li>
     <li>
      <p>
       <strong>
        渐进式调整
       </strong>
       ：避免一次性大规模变更导致稳定性问题。
      </p>
     </li>
     <li>
      <p>
       <strong>
        平衡性能与成本
       </strong>
       ：过度优化可能增加运维复杂度。
      </p>
     </li>
    </ol>
    <p>
     通过以上方法，可以显著提升 Kubernetes 集群的资源利用率，降低成本，同时保障业务稳定性。实际优化时需结合业务特点和基础设施环境灵活调整。
    </p>
   </div>
  </div>
 </article>
 <p alt="68747470733a2f:2f626c6f672e6373646e2e6e65742f626c747975323030302f:61727469636c652f64657461696c732f313436313733353133" class_="artid" style="display:none">
 </p>
</div>


