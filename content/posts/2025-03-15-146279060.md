---
arturl_encode: "68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f35393138303434322f:61727469636c652f64657461696c732f313436323739303630"
layout: post
title: "åœ¨-C-ä¸­ä½¿ç”¨-Dapper-æŸ¥è¯¢æ•°æ®å¹¶å¯¼å‡º-Excel"
date: 2025-03-15 15:06:33 +08:00
description: "å®Œæ•´æµç¨‹æŸ¥è¯¢æ•°æ®åº“å¤„ç†åŠ¨æ€å¯¹è±¡ï¼Œå­˜å‚¨é™æ€å¯¹è±¡ å¹¶å­˜å…¥ã€‚è°ƒç”¨ç”Ÿæˆ Excelã€‚æ”¯æŒé™æ€ & åŠ¨æ€æ•°æ®å¯¼å‡ºï¼Œè‡ªåŠ¨è§£æåµŒå¥—å¯¹è±¡ã€‚"
keywords: "åœ¨ C# ä¸­ä½¿ç”¨ Dapper æŸ¥è¯¢æ•°æ®å¹¶å¯¼å‡º Excel"
categories: ['.NET/C']
tags: ['æ•°æ®åº“', 'å¼€å‘è¯­è¨€', 'Excel', 'C']
artid: "146279060"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146279060
    alt: "åœ¨-C-ä¸­ä½¿ç”¨-Dapper-æŸ¥è¯¢æ•°æ®å¹¶å¯¼å‡º-Excel"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146279060
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146279060
cover: https://bing.ee123.net/img/rand?artid=146279060
image: https://bing.ee123.net/img/rand?artid=146279060
img: https://bing.ee123.net/img/rand?artid=146279060
---

# åœ¨ C# ä¸­ä½¿ç”¨ Dapper æŸ¥è¯¢æ•°æ®å¹¶å¯¼å‡º Excel

## 1. èƒŒæ™¯ä»‹ç»

åœ¨é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦æŸ¥è¯¢æ•°æ®åº“ä¸­çš„æ•°æ®å¹¶å¯¼å‡ºä¸º Excel è¿›è¡Œåˆ†ææˆ–å­˜æ¡£ã€‚æœ¬ç¯‡æ–‡ç« ä»‹ç»å¦‚ä½•åœ¨
**C#**
ä¸­ä½¿ç”¨
**Dapper**
æŸ¥è¯¢ SQL Server æ•°æ®ï¼Œå¹¶é€šè¿‡
**EPPlus**
ç”Ÿæˆ Excel æ–‡ä»¶ï¼Œæ”¯æŒ
**åŠ¨æ€å¯¹è±¡ (
`ExpandoObject`
) å’Œé™æ€å®ä½“å¯¹è±¡**
çš„æ•°æ®å¯¼å‡ºã€‚

### 2. ä»£ç ç»“æ„æ¦‚è§ˆ

è¯¥å®ç°åŒ…æ‹¬ä»¥ä¸‹éƒ¨åˆ†ï¼š

1. **æ•°æ®åº“æŸ¥è¯¢ (
   `DapperHelper.Query`
   )**
   ï¼šæ‰§è¡Œ SQL æŸ¥è¯¢å¹¶è¿”å›
   `DynamicParameters`
   å½¢å¼çš„ç»“æœã€‚
2. **æ•°æ®è½¬æ¢ (
   `ExpandoObject`
   )**
   ï¼šæŸ¥è¯¢ç»“æœè½¬æ¢ä¸ºåŠ¨æ€å¯¹è±¡ã€‚
3. **é™æ€å¯¹è±¡åˆ—è¡¨ (
   `Person`
   )**
   ï¼šç¤ºä¾‹æ•°æ®ã€‚
4. **Excel å¯¼å‡º (
   `ExcelHelper.ExportToExcel`
   )**
   ï¼šå°†æ•°æ®è½¬æ¢ä¸º Excel æ–‡ä»¶ï¼Œæ”¯æŒ
   **åŠ¨æ€å¯¹è±¡å’Œé™æ€å¯¹è±¡**
   ï¼Œè‡ªåŠ¨é€‚é…åµŒå¥—å±æ€§ã€‚

---

### 3. ä»£ç å®ç°

```cs
Dictionary<string, object> keyValuePairs = new();
```

* ä¸ºäº†æ–¹ä¾¿æˆ‘ä»¬è¿›è¡Œå¤šä¸ªSheetå’Œå¤šä¸ªæ•°æ®æŸ¥è¯¢ï¼Œæˆ‘è¿™è¾¹ä¼šæŠŠå¤šä¸ªæ•°æ®å­˜å‚¨åˆ°ä¸€ä¸ªé”®å€¼å¯¹é‡Œé¢ï¼Œé”®å€¼å¯¹çš„Keyæ˜¯Sheetçš„åå­—ï¼ŒValueæ˜¯æˆ‘ä»¬æŸ¥å‡ºæ¥çš„é™æ€æˆ–è€…åŠ¨æ€å®ä½“å†…å®¹çš„é›†åˆ

#### 3.1 ä½¿ç”¨ Dapper æŸ¥è¯¢æ•°æ®åº“

```cs
public static async Task<IEnumerable<DynamicParameters>> Query(string sql, object? @params = null, int? commandTimeout = null, CommandType? commandType = null)
{
    string ConnStr = AppConfig.SqlLinks;
    using (var con = new SqlConnection(ConnStr))
    {
        var results = await con.QueryAsync(sql, @params, commandTimeout: commandTimeout, commandType: commandType);
        return results.Select(r => new DynamicParameters(r));
    }
}

```

* è¯¥æ–¹æ³•ä½¿ç”¨
  **Dapper**
  æŸ¥è¯¢æ•°æ®åº“ï¼Œå¹¶è¿”å›
  `DynamicParameters`
  ã€‚
* è¿æ¥å­—ç¬¦ä¸²ä»
  `AppConfig.SqlLinks`
  è·å–ã€‚
* æˆ‘ä»¬åœ¨ä¸æƒ³åˆ›å»ºå®ä½“å¯¹è±¡çš„æƒ…å†µä¸‹ç›´æ¥é€‰æ‹©æŠŠå†…å®¹è½¬åŒ–ä¸º
  **åŠ¨æ€å®ä½“ç±»å‹**

#### 3.2 æŸ¥è¯¢ `orders` è¡¨å¹¶è½¬æ¢ä¸ºåŠ¨æ€å¯¹è±¡

```cs
string sql = "Select * From [1booking].[dbo].[orders] With(NoLock)";
var results = await DapperHelper.Query(sql);
if (results.Count() > 0 && results != null)
{
    var objects = results.Select(r =>
    {
        var expando = new ExpandoObject();
        var dict = (IDictionary<string, object>)expando!;
        foreach (var key in r.ParameterNames)
        {
            dict[key] = r.Get<object>(key);
        }
        return expando;
    });
}

```

* æŸ¥è¯¢
  `orders`
  è¡¨ï¼Œå¹¶è½¬æ¢æŸ¥è¯¢ç»“æœä¸º
  **åŠ¨æ€å¯¹è±¡ (
  `ExpandoObject`
  )**
  ã€‚
* æˆ‘ä»¬æŠŠä»–è½¬æ¢ä¸ºåŠ¨æ€å¯¹è±¡ä¹‹åï¼Œåç»­å°±å¯ä»¥ä½¿ç”¨å®ƒæ¥ç›´æ¥å±•ç¤º
* æŠŠä»–ç›´æ¥å­˜å‚¨é”®å€¼å¯¹ä¸­ï¼Œè¿™ä¸ªè‚¯å®šéƒ½ä¼šå­˜å‚¨ï¼Œæˆ‘è¿™è¾¹å°±å°‘äº›ä¸€è¡Œä»£ç äº†

#### 3.3 ç¤ºä¾‹ï¼šé™æ€å¯¹è±¡åˆ—è¡¨ `Person`

```cs
var people = new List<Person>
{
    new Person
    {
        Id = 1,
        Name = "å¼ ä¸‰",
        BirthDate = new DateTime(1990, 1, 1),
        Salary = 5000.50m,
        Address = new Address { City = "åŒ—äº¬", State = "åŒ—äº¬" },
        Info = new Info {A = "2", B = "C"}
    },
    new Person
    {
        Id = 2,
        Name = "æå››",
        BirthDate = new DateTime(1985, 5, 12),
        Salary = 8000.75m,
        Address = new Address { City = "ä¸Šæµ·", State = "ä¸Šæµ·" },
        Info = new Info {A = "1", B = "B"}
    }
};

```

* å®šä¹‰
  **é™æ€å¯¹è±¡
  `Personï¼Œè¿™é‡Œéƒ½æ˜¯æˆ‘çš„ç¤ºä¾‹ï¼Œä¸¾ä¾‹è¯´æ˜çš„ï¼Œå¯ä»¥æ˜¯ä»»ä½•é™æ€å¯¹è±¡å¤šå±‚åµŒå¥—ä¹Ÿæ˜¯æ²¡é—®é¢˜çš„`**
  ã€‚
* æŠŠä»–ç›´æ¥å­˜å‚¨é”®å€¼å¯¹ä¸­ï¼Œè¿™ä¸ªè‚¯å®šéƒ½ä¼šå­˜å‚¨ï¼Œæˆ‘è¿™è¾¹å°±å°‘äº›ä¸€è¡Œä»£ç äº†

#### 3.4 è°ƒç”¨ Excel å¯¼å‡ºæ–¹æ³•

```cs
var excelData = ExcelHelper.ExportToExcel<Task>(keyValuePairs);

```

* é€šè¿‡
  `ExcelHelper.ExportToExcel<T>`
  æ–¹æ³•ï¼Œå°†
  `keyValuePairs`
  å¯¼å‡ºä¸º Excelã€‚
* åœ¨è¿™ä¸€æ­¥ä¹Ÿå°±æ˜¯è°ƒç”¨æˆ‘ä»¬ä¸»è¦çš„å®ç°æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•é‡Œé¢ä¸»è¦æ˜¯å¤„ç†Excelå’Œæˆ‘ä»¬çš„å®ä½“åŒºåˆ†å¤„ç†ã€‚ä»¥å®ç°å…¨è‡ªåŠ¨å¤„ç†ä¸åŒºåˆ†ç±»å‹

#### 3.5 Excel å¯¼å‡ºå®ç° ( `ExcelHelper` )

```cs
public static byte[] ExportToExcel<T>(Dictionary<string, object> dataSets)
{
    // é¦–å…ˆæˆ‘ä»¬ä¸èƒ½è®©æˆ‘ä»¬çš„é›†åˆæ˜¯ç©ºçš„
    if (dataSets == null || !dataSets.Any())
    {
        throw new ArgumentException("æ•°æ®åˆ—è¡¨ä¸èƒ½ä¸ºç©º");
    }
    // å› ä¸ºè¿™ä¸ªåˆ†å•†ç”¨ç‰ˆå’Œä¸ªäººç‰ˆæœ¬ï¼Œä¸€ä¸ªæ”¶è´¹ä¸€ä¸ªä¸æ”¶è´¹ï¼Œæ‰€ä»¥æˆ‘é€‰æ‹©ä¸ªäººä½¿ç”¨
    ExcelPackage.LicenseContext = OfficeOpenXml.LicenseContext.NonCommercial;
    // åˆ›å»ºä¸€ä¸ªå¤„ç†Excelçš„ç”Ÿå‘½å‘¨æœŸ
    using (var package = new ExcelPackage())
    {
        // è¿™ä¸€æ­¥ä¹Ÿå°±æ˜¯æˆ‘ä¸Šé¢æ‰€è¯´çš„ï¼Œå¦‚æœæœ‰å¤šä¸ªé›†åˆè¿›è¡ŒåŒºåˆ†Sheetå¤„ç†ä¸åŒSheetå­˜æ”¾ä¸åŒé›†åˆæ•°æ®
        foreach (var dataSet in dataSets)
        {
            var sheetName = dataSet.Key;
            var data = dataSet.Value;
            var worksheet = package.Workbook.Worksheets.Add(sheetName);
            
            if (data is IEnumerable<ExpandoObject> dynamicList)
            {// è¿™ä¸€æ­¥ä¸»è¦æ˜¯å¤„ç†åŠ¨æ€é›†åˆå…ƒç´ 
                // è·å–åŠ¨æ€é›†åˆçš„å±æ€§ï¼Œè¿™é‡Œä¸€èˆ¬åŠ¨æ€å…ƒç´ çš„ç±»å‹æˆ‘ä»¬æ˜¯è·å–ä¸åˆ°çš„éƒ½æ˜¯null
                var properties = GetAllProperties(dynamicList.FirstOrDefault(), typeof(T));
                for (int i = 0; i < properties.Count; i++)
                {
                    // å†™å…¥ç¬¬ä¸€è¡Œå±æ€§åç§°
                    worksheet.Cells[1, i + 1].Value = properties[i].DisplayName ?? properties[i].PropertyName;
                }
                for (int row = 0; row < dynamicList.Count(); row++)
                {
                    var item = dynamicList.ElementAt(row);
                    for (int col = 0; col < properties.Count; col++)
                    {
                        // è¿™ä¸€æ­¥ç”¨æ¥å¤„ç†åµŒå¥—å±æ€§
                        worksheet.Cells[row + 2, col + 1].Value = GetNestedPropertyValue(item, properties[col].PropertyName);
                    }
                }
            }
            else if (data is IEnumerable<object> list)
            {// è¿™ä¸€æ­¥ä¸»è¦æ˜¯å¤„ç†é™æ€é›†åˆå…ƒç´ 
                // è·å–é™æ€é›†åˆçš„å±æ€§ï¼Œåƒæ˜¯é™æ€å±æ€§ï¼Œè¿™é‡Œæ˜¯å¯ä»¥è·å–åˆ°çš„
                var properties = GetAllProperties(list.FirstOrDefault(), typeof(T));
                for (int i = 0; i < properties.Count; i++)
                {
                    // å†™å…¥ç¬¬ä¸€è¡Œå±æ€§åç§°
                    worksheet.Cells[1, i + 1].Value = properties[i].DisplayName ?? properties[i].PropertyName;
                }
                int row = 2;
                foreach (var item in list)
                {
                    for (int col = 0; col < properties.Count; col++)
                    {
                        // å†™å…¥å†…å®¹
                        worksheet.Cells[row, col + 1].Value = GetNestedPropertyValue(item, properties[col].PropertyName);
                    }
                    row++;
                }
            }
            // è‡ªåŠ¨è°ƒæ•´åˆ—å®½
            worksheet.Cells.AutoFitColumns();
        }
        // è¿”å›Excelæ–‡ä»¶çš„å­—èŠ‚æ•°ç»„
        return package.GetAsByteArray();
    }
}


```

```cs
private static List<PropertyMetadata> GetAllProperties(object obj, Type type = null, string prefix = "")
{
    // å¤„ç† åŠ¨æ€å±æ€§
    if (obj is IDictionary<string, object> dict)
    {
        // éå† ExpandoObject çš„é”®å€¼å¯¹
        foreach (var key in dict.Keys)
        {
            // æ·»åŠ å±æ€§å…ƒæ•°æ®ï¼ˆExpandoObject æ²¡æœ‰ PropertyInfoï¼‰
            properties.Add(new PropertyMetadata(null, key, key));
        }
    }
    // å¤„ç†é™æ€å±æ€§
    else
    {
        // è·å–ç±»å‹çš„å…¬å…±å®ä¾‹å±æ€§
        foreach (var prop in type.GetProperties(BindingFlags.Public | BindingFlags.Instance))
        {
            // æ„é€ å±æ€§åç§°ï¼ˆè€ƒè™‘å‰ç¼€ï¼‰
            var propertyName = string.IsNullOrEmpty(prefix) ? prop.Name : $"{prefix}.{prop.Name}";

            // å¤„ç†åŸºæœ¬ç±»å‹å±æ€§
            if (prop.PropertyType.IsPrimitive || prop.PropertyType == typeof(string) || prop.PropertyType == typeof(DateTime) || prop.PropertyType == typeof(decimal))
            {
                // è·å–æ˜¾ç¤ºåç§°ï¼ˆDisplayNameAttributeï¼‰
                var displayName = prop.GetCustomAttribute<DisplayNameAttribute>()?.DisplayName;
                // æ·»åŠ å±æ€§å…ƒæ•°æ®
                properties.Add(new PropertyMetadata(prop, propertyName, displayName));
            }
            // å¤„ç†åµŒå¥—å¯¹è±¡å±æ€§
            else if (prop.PropertyType.IsClass)
            {
                // é€’å½’è·å–åµŒå¥—å±æ€§
                properties.AddRange(GetAllProperties(null, prop.PropertyType, propertyName));
            }
        }
    }
    // è¿”å›å±æ€§å…ƒæ•°æ®åˆ—è¡¨
    return properties;
}
```

```cs
/// <summary>
/// å±æ€§åç§°ï¼ˆåŒ…æ‹¬å‰ç¼€ï¼‰
/// </summary>
public string PropertyName { get; }

/// <summary>
/// å±æ€§æ˜¾ç¤ºåç§°ï¼ˆDisplayNameAttributeï¼‰
/// </summary>
public string DisplayName { get; }

/// <summary>
/// æ„é€ å‡½æ•°
/// </summary>
/// <param name="propertyInfo">PropertyInfo å¯¹è±¡ï¼ˆå¦‚æœæ˜¯åŸºæœ¬ç±»å‹ï¼Œåˆ™ä¸º nullï¼‰</param>
/// <param name="propertyName">å±æ€§åç§°ï¼ˆåŒ…æ‹¬å‰ç¼€ï¼‰</param>
/// <param name="displayName">å±æ€§æ˜¾ç¤ºåç§°ï¼ˆDisplayNameAttributeï¼‰</param>
public PropertyMetadata(PropertyInfo propertyInfo, string propertyName, string displayName)
{
    PropertyInfo = propertyInfo;
    PropertyName = propertyName;
    DisplayName = displayName;
}
```

```cs
private static object GetNestedPropertyValue(object obj, string propertyName)
{
    // åˆ†å‰²å±æ€§åç§°ï¼ˆæ”¯æŒåµŒå¥—å±æ€§ï¼‰
    var props = propertyName.Split('.');

    // åˆå§‹åŒ–å±æ€§å€¼
    object value = obj;

    // éå†å±æ€§åç§°
    foreach (var prop in props)
    {
        // æ£€æŸ¥å±æ€§å€¼æ˜¯å¦ä¸ºç©º
        if (value == null)
        {
            return null; // å¦‚æœå±æ€§å€¼ä¸ºç©ºï¼Œåˆ™è¿”å› null
        }

        // å¤„ç† åŠ¨æ€å±æ€§ï¼Œä¸€èˆ¬è¿™ä¸ªåŒºåˆ†ä¸äº†ç±»å‹ï¼Œåç»­å¯ä»¥åœ¨å†™å…¥æ–‡æ¡£çš„æ—¶å€™åŒºåˆ†ç±»å‹
        if (value is IDictionary<string, object> dict)
        {
            // å°è¯•è·å–å±æ€§å€¼
            dict.TryGetValue(prop, out value);
        }
        else // å¤„ç†é™æ€å±æ€§
        {
            // è·å–å±æ€§ä¿¡æ¯
            var propertyInfo = value.GetType().GetProperty(prop);

            // æ£€æŸ¥å±æ€§æ˜¯å¦å­˜åœ¨
            if (propertyInfo == null)
            {
                return null; // å¦‚æœå±æ€§ä¸å­˜åœ¨ï¼Œåˆ™è¿”å› null
            }

            // è·å–å±æ€§å€¼
            value = propertyInfo.GetValue(value);
        }
    }

    // è¿”å›å±æ€§å€¼
    return value;
}
```

* **è‡ªåŠ¨è§£æåŠ¨æ€å¯¹è±¡å’Œé™æ€å¯¹è±¡**
* **æ”¯æŒåµŒå¥—å¯¹è±¡å±æ€§å¯¼å‡º**
* **æ ¼å¼åŒ– Excelï¼Œè‡ªåŠ¨è°ƒæ•´åˆ—å®½**

#### **3.6Â æœ€åè¾“å‡ºç»“æœå±•ç¤º**

![](https://i-blog.csdnimg.cn/direct/d4b3dff2e43c4b81965233b75a8ee2bc.png)
![](https://i-blog.csdnimg.cn/direct/52cd97195dbf4dc29b3c9b972e5989eb.png)

---

### 4. æ€»ç»“

#### ğŸ“Œ **å®Œæ•´æµç¨‹**

1. **æŸ¥è¯¢æ•°æ®åº“**
   ï¼ˆ
   `DapperHelper.Query`
   ï¼‰ã€‚
2. **å¤„ç†åŠ¨æ€å¯¹è±¡ (
   `ExpandoObject`
   )**
   ï¼Œå¹¶å­˜å…¥
   `keyValuePairs`
   ã€‚
3. **å­˜å‚¨é™æ€å¯¹è±¡ (
   `Person`
   )**
   ï¼Œå¹¶å­˜å…¥
   `keyValuePairs`
   ã€‚
4. **è°ƒç”¨
   `ExcelHelper.ExportToExcel`
   ç”Ÿæˆ Excel**
   ã€‚
5. **æ”¯æŒé™æ€ & åŠ¨æ€æ•°æ®å¯¼å‡º**
   ï¼Œè‡ªåŠ¨è§£æåµŒå¥—å¯¹è±¡ã€‚

#### ğŸ¯ **é€‚ç”¨åœºæ™¯**

âœ…
**å¤§æ‰¹é‡æ•°æ®å¯¼å‡º**
  
âœ…
**åŠ¨æ€æ•°æ®ç»“æ„ï¼ˆ
`ExpandoObject`
ï¼‰**
  
âœ…
**æ”¯æŒåµŒå¥—å¯¹è±¡**

å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½å¸®åŠ©ä½ åœ¨ C# é¡¹ç›®ä¸­é«˜æ•ˆå¯¼å‡º Excel æ•°æ®ï¼ğŸš€