---
layout: post
title: "接上一篇,C中,如何设计等价于Qt的信号与槽机制"
date: 2025-03-16 15:31:56 +0800
description: "看下面例子：所有连接类FileManage中的信号，在changeFileName函数中被调用。输出：输出：是不是一样，是不是很酷。：）"
keywords: "接上一篇，C++中，如何设计等价于Qt的信号与槽机制。"
categories: ['未分类']
tags: ['开发语言', 'Qt', 'C']
artid: "146295628"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146295628
    alt: "接上一篇,C中,如何设计等价于Qt的信号与槽机制"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146295628
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146295628
cover: https://bing.ee123.net/img/rand?artid=146295628
image: https://bing.ee123.net/img/rand?artid=146295628
img: https://bing.ee123.net/img/rand?artid=146295628
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     接上一篇，C++中，如何设计等价于Qt的信号与槽机制。
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <h2>
     <span style="color:#fe2c24">
      看下面例子：
     </span>
    </h2>
    <pre><code class="language-cpp">
class FileManager : public QObject {
    Q_OBJECT

public:
    FileManager(QObject* parent = nullptr) : QObject(parent) {}

    void changeFileName(const QString&amp; newName) {
        fileName = newName;
        emit fileNameChanged(fileName);
    }

signals:
    void fileNameChanged(const QString&amp; newName);

private:
    QString fileName;
};
</code></pre>
    <h2>
     <span style="color:#fe2c24">
      所有连接类FileManage中的信号，在changeFileName函数中被调用。例如：
     </span>
    </h2>
    <pre><code class="language-cpp">int main(int argc, char* argv[])
{
	QApplication a(argc, argv);  //注意，这里是QApplication
 
	FileManager fm;
	 

	QObject::connect(&amp;fm, &amp;FileManager::fileNameChanged, [](const QString&amp; newName) {

		std::cout &lt;&lt; "函数1收到：文件名改变了。\n";
	});


	QObject::connect(&amp;fm, &amp;FileManager::fileNameChanged, [](const QString&amp; newName) {

		std::cout &lt;&lt; "函数2收到：文件名改变2。\n";
	});


	fm.changeFileName("abc");

   
	return a.exec();
}</code></pre>
    <p>
     输出：
    </p>
    <p>
     <img alt="" height="1160" src="https://i-blog.csdnimg.cn/direct/5e84da91990f429fb8eb1fd583be8b88.png" width="1663"/>
    </p>
    <p>
    </p>
    <h2>
     <span style="color:#fe2c24">
      下面我们也来设计相同功能的FileManager2:
     </span>
    </h2>
    <pre><code class="language-cpp">class FileManager2 {
public:
	using fileNameChanged = std::function&lt;void(const QString&amp; newName)&gt;;

public:
	std::list&lt; fileNameChanged&gt; fileNameChanged_list;
public:
	FileManager2(QObject* parent = nullptr) {}

	void changeFileName(const QString&amp; newName) {
		fileName = newName;
		for (fileNameChanged&amp;  f: fileNameChanged_list) {
			if (f != 0)
				f(newName);
		}
	}
	 
	void connect(fileNameChanged f) {
		fileNameChanged_list.push_back(f);
	}
private:
	QString fileName;
};


int main(int argc, char* argv[])
{
	QApplication a(argc, argv);  //注意，这里是QApplication
 
	FileManager2 fm;
	 

	fm.connect([](const QString&amp; newName) {

		std::cout &lt;&lt; "函数1收到：文件名改变了。\n";
	});


	fm.connect([](const QString&amp; newName) {

		std::cout &lt;&lt; "函数2收到：文件名改变。\n";
	});


	fm.changeFileName("abc");

   
	return a.exec();
}
</code></pre>
    <p>
     输出：
    </p>
    <p>
     <img alt="" height="1360" src="https://i-blog.csdnimg.cn/direct/68d0f793f8e643d1aaefc84775f4a4f3.png" width="1370"/>
    </p>
    <p>
    </p>
    <h2>
     <span style="color:#a2e043">
      是不是一样，是不是很酷。：）
     </span>
    </h2>
    <p>
    </p>
    <p>
     <span style="color:#a2e043">
      关键地方：
     </span>
    </p>
    <p>
     <img alt="" height="83" src="https://i-blog.csdnimg.cn/direct/e034a41a7ba3472b8a349f4ab35c5c3b.png" width="1374"/>
    </p>
    <p>
    </p>
    <h2>
     <img alt="" height="205" src="https://i-blog.csdnimg.cn/direct/2b81ea7b5be5467a9dbd64e6c098a4e5.png" width="1060">
      这里相当于Qt中的
      <span style="color:#fe2c24">
       emit
      </span>
     </img>
    </h2>
    <p>
     <img alt="" height="230" src="https://i-blog.csdnimg.cn/direct/937334d57b7149ca9bf1318bed19f685.png" width="952"/>
    </p>
    <p>
     这里添加一个函数指针，上篇说过：
    </p>
    <p>
     <img alt="" height="168" src="https://i-blog.csdnimg.cn/direct/93b192ddcdd149fc8b6ffebaa3548067.png" width="860"/>
    </p>
    <p>
    </p>
    <p>
     这里可连接N个Lambda
     <a href="https://baike.baidu.com/item/%E8%A1%A8%E8%BE%BE%E5%BC%8F/7655228?fromModule=lemma_inlink" rel="nofollow" title="表达式">
      表达式
     </a>
     ，与Qt一样：
    </p>
    <p>
     <img alt="" height="512" src="https://i-blog.csdnimg.cn/direct/87a6c4b0935d4a22a5e438f819b7c9aa.png" width="1057"/>
    </p>
    <h2>
     <span style="color:#fe2c24">
      连接函数：
     </span>
    </h2>
    <p>
     <img alt="" height="1211" src="https://i-blog.csdnimg.cn/direct/ac2102a55b1345578adc8cc093acd4ca.png" width="1365"/>
    </p>
    <h2>
     <span style="color:#fe2c24">
      最终也一样：
     </span>
    </h2>
    <p>
     <img alt="" height="1025" src="https://i-blog.csdnimg.cn/direct/ed55440db9fc45f8a850bbe7e4666f91.png" width="1076"/>
    </p>
    <p>
    </p>
    <h2>
     <span style="color:#fe2c24">
      由于临时灵感来了，用了几分钟写的，难免有问题, 如果使用
      <br/>
      std::list::remove 会编译不了，现在用新版方案替代，以后再完善：
     </span>
    </h2>
    <pre><code class="language-cpp">template&lt;class T&gt;
class _callback {
public:

    friend bool  operator==(const _callback&amp; l, const _callback&amp; r) {
        return l.m_id == r.m_id;
    }

    _callback(const T&amp; pf) {
        m_pf = pf;
        m_id = _DateTime::g_timeStamp();
    }

public:
    __int64 m_id;
    T m_pf;
};



class _FileManager {
public:
    using pf_fileNameChanged = std::function&lt;void(const _string&amp; oldPathName,
        const _string&amp; newPathName)&gt;;

      

    /// &lt;summary&gt;
    /// 更改文件名或路径并通知所有订阅者
    /// &lt;/summary&gt;
    /// &lt;param name="oldPathName"&gt;&lt;/param&gt;
    /// &lt;param name="newPathName"&gt;&lt;/param&gt;
    /// 创建时间：2025-03-16    最后一次修改时间：2025-03-16
    void changeFileName(const _string&amp; oldPathName, const _string&amp; newPathName);


    /// &lt;summary&gt;
    /// 更改文件夹名或路径
    /// &lt;/summary&gt;
    /// &lt;param name="oldPathName"&gt;&lt;/param&gt;
    /// &lt;param name="newPathName"&gt;&lt;/param&gt;
    /// 创建时间：2025-03-16    最后一次修改时间：2025-03-16
    void changeFolderName(const _string&amp; oldPathName, const _string&amp; newPathName);


    /// &lt;summary&gt;
    /// 删除文件
    /// &lt;/summary&gt;
    /// &lt;param name="fileName"&gt;&lt;/param&gt;
    void deleteFile(const _string&amp; fileName);


    /// &lt;summary&gt;
    /// 删除文件夹
    /// &lt;/summary&gt;
    /// &lt;param name="folderName"&gt;&lt;/param&gt;
    void deleteFolder(const _string&amp; folderName);


    // 订阅文件名更改事件
    void subscribe(const pf_fileNameChanged&amp; callback) {
        std::lock_guard&lt;std::mutex&gt; lock(m_mutex); // 线程安全
        m_fileNameChanged.push_back(callback);
    }

    // 取消订阅文件名更改事件
    void unsubscribe(const pf_fileNameChanged&amp; callback) {
        std::lock_guard&lt;std::mutex&gt; lock(m_mutex); // 线程安全
        m_fileNameChanged.remove(callback);
    }


private:
    _string m_dirPathName; // 当前文件名
    std::list&lt;_callback&lt;pf_fileNameChanged&gt;&gt; m_fileNameChanged; // 订阅者列表
    mutable std::mutex m_mutex; // 用于线程安全
};
</code></pre>
    <p>
     <img alt="" height="681" src="https://i-blog.csdnimg.cn/direct/957002e1773b4afda53844f6ea2b71bf.png" width="1532"/>
    </p>
    <p>
     <img alt="" height="291" src="https://i-blog.csdnimg.cn/direct/8e0d067fb4a345cf96a474647fd782c5.png" width="1560"/>
    </p>
   </div>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f34323934343932382f:61727469636c652f64657461696c732f313436323935363238" class_="artid" style="display:none">
 </p>
</div>


