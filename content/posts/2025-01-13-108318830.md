---
layout: post
title: "微信小程序腾讯地图获取用户所在城市信息实战"
date: 2025-01-13 15:52:38 +0800
description: "背景实现小程序进去后获取用户当前所在城市，然后显示该城市的数据，并且显示在导航栏和 Tab上。微信小"
keywords: "小程序 地图解析城市"
categories: ['未分类']
tags: ['无标签']
artid: "108318830"
image:
  path: https://api.vvhan.com/api/bing?rand=sj&artid=108318830
  alt: "微信小程序腾讯地图获取用户所在城市信息实战"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=108318830
featuredImagePreview: https://bing.ee123.net/img/rand?artid=108318830
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     【微信小程序&amp;腾讯地图】获取用户所在城市信息实战
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h3>
     <a id="_0">
     </a>
     背景
    </h3>
    <p>
     实现小程序进去后获取用户当前所在城市，然后显示该城市的数据，并且显示在导航栏和 Tab上。
    </p>
    <p>
     微信小程序中，我们可以通过调用
     <code>
      wx.getLocation()
     </code>
     获取到设备当前的地理位置信息，这个信息是当前位置的经纬度。如果我们想获取当前位置是处于哪个国家，哪个城市等信息，该如何实现呢？
    </p>
    <p>
     微信小程序中并没有提供这样的API，但是没关系，有
     <code>
      wx.getLocation()
     </code>
     得到的经纬度作为基础就够了，其他的，我们可以使用其他第三方地图服务可以来实现，比如腾讯地图API。
    </p>
    <p>
     所以整个步骤就是：
    </p>
    <p>
     在小程序中获取当前的地理位置，涉及小程序API为
     <code>
      wx.getLocation
     </code>
     <br/>
     把第1步中获得的经纬度信息通过腾讯地图的接口逆地址解析，涉及腾讯地图接口为
     <a href="https://lbs.qq.com/miniProgram/jsSdk/jsSdkGuide/methodReverseGeocoder" rel="nofollow">
      reverseGeocoder(options:Object)
     </a>
    </p>
    <h3>
     <a id="_13">
     </a>
     在小程序中获取当前的地理位置
    </h3>
    <p>
     在小程序中，调用
     <code>
      wx.getLocation
     </code>
     ，使用前需要用户授权
     <code>
      scope.userLocation
     </code>
     ，代码如下
    </p>
    <pre><code>checkAuth(callback) {
  wx.getSetting({
    success(res) {
      if (!res.authSetting\['scope.userLocation'\]) {
        wx.authorize({
          scope: 'scope.userLocation',
          success() {
            wx.getLocation({
              type: 'wgs84', 
              success(res) {
                callback(res.latitude, res.longitude)
              }
            })
          }
        })
      }
    }
  })
}
</code></pre>
    <p>
     其中
     <code>
      type
     </code>
     的取值可以为：
    </p>
    <ul>
     <li>
      <p>
       <code>
        wgs84
       </code>
       意思返回 gps 坐标
      </p>
     </li>
     <li>
      <p>
       <code>
        gcj02
       </code>
       返回可用于
       <code>
        wx.openLocation
       </code>
       的坐标
      </p>
     </li>
    </ul>
    <p>
     运行后会提示如下信息，还需要在 app.json 中配置permission字段
    </p>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/bcfe2f9286072e6abc6bc1fc351af255.png"/>
    </p>
    <p>
     查询
     <a href="https://developers.weixin.qq.com/miniprogram/dev/reference/configuration/app.html" rel="nofollow">
      文档
     </a>
     后得知，得知需要如下配置
    </p>
    <pre><code>"permission": {
    "scope.userLocation": {
      "desc": "你的位置信息将用于小程序位置接口的效果展示"
    }
}
</code></pre>
    <p>
     desc 用于在弹出的授权提示框中展示，如下
    </p>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/62027555f495150f8f7909d7647b9f50.png"/>
    </p>
    <p>
     允许后即可获取接口返回的信息，此过程会在右上角胶囊按钮上显示箭头图标
    </p>
    <pre><code>{
    accuracy: 65
    errMsg: "getLocation:ok"
    horizontalAccuracy: 65
    latitude: 30.25961    // 纬度，范围为 -90~90，负数表示南纬
    longitude: 120.13026    // 经度，范围为 -180~180，负数表示西经
    speed: \-1
    verticalAccuracy: 65
}
</code></pre>
    <p>
     <code>
      latitude
     </code>
     和
     <code>
      longitude
     </code>
     即是我们需要的两个字段
    </p>
    <h3>
     <a id="_79">
     </a>
     腾讯地图接口逆地址解析
    </h3>
    <p>
     以腾讯地图为例，我们可以去腾讯地图开放平台注册一个账号，然后在它的管理后台创建一个密钥(key)，以及进行KEY设置，按照
     <a href="https://lbs.qq.com/miniProgram/jsSdk/jsSdkGuide/jsSdkOverview" rel="nofollow">
      微信小程序JavaScript SDK
     </a>
     入门及使用限制文档
    </p>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/e35d117f0d042470297092f4a84873b7.png"/>
    </p>
    <p>
     在
     <a href="https://lbs.qq.com/dev/console/key/manage" rel="nofollow">
      KEY设置
     </a>
     的启用产品中，勾选 WebServiceAPI，选择签名校验方式，因为我是使用云开发的方式，所以没有什么域名也没有授权IP。
    </p>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/eaf3a79ccac3a2fd53ea516c9d3e2a6c.png"/>
    </p>
    <p>
     这部分代码逻辑如下
    </p>
    <pre><code>import QQMapWX from '../../scripts/qqmap-wx-jssdk.min.js'
let qqmapsdk
Page({
    onLoad: function (options) {
      // 实例化API核心类
      qqmapsdk = new QQMapWX({
         key: '开发密钥（key）'    // 必填
      });
      this.checkAuth((latitude, longitude) =&gt; {
         // https://lbs.qq.com/qqmap\_wx\_jssdk/method-reverseGeocoder.html
         qqmapsdk.reverseGeocoder({
           sig: 'KEY设置中生成的SK字符串',    // 必填
            location: {latitude, longitude},
            success(res) {
                wx.setStorageSync('loca\_city', res.result.ad\_info.city)
            },
            fail(err) {
               console.log(err)
               wx.showToast('获取城市失败')
            },
            complete() {
               // 做点什么
            }
         })
      })
    }
}）
</code></pre>
    <p>
     <code>
      reverseGeocoder
     </code>
     接口返回的结果，这里面的字段比较多，详细可以看接口文档，里面好几个字段可以取到城市，其中
     <code>
      ad_info
     </code>
     是行政区划信息，我就取这里面的
     <code>
      city
     </code>
     了。
    </p>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/e19f57e8da7bcc4b1ee0c1c6bcc25af7.png"/>
    </p>
    <blockquote>
     <p>
      以上内容转载自面糊的文章《【实战】小程序中结合腾讯地图获取用户所在城市信息》
     </p>
     <p>
      链接：https://segmentfault.com/a/1190000021318458#comment-area
     </p>
     <p>
      来源：segmentfault
     </p>
     <p>
      著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。
     </p>
    </blockquote>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f34353635333132352f:61727469636c652f64657461696c732f313038333138383330" class_="artid" style="display:none">
 </p>
</div>
