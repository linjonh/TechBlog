---
layout: post
title: "Nginx解决前端跨域问题"
date: 2025-03-07 22:46:03 +0800
description: "通过 Nginx 配置 CORS 头部信息，可以有效解决前端跨域问题，允许前端应用从不同的域名、协议或端口请求资源。在配置过程中，需要仔细考虑安全性、性能优化和管理的易用性，以确保跨域请求的安全和高效处理。Nginx 强大的配置能力使其能够灵活应对各种跨域需求，为前端应用提供强有力的支持。"
keywords: "Nginx解决前端跨域问题"
categories: ['面试', '阿里巴巴', '学习路线']
tags: ['运维', '前端', 'Nginx']
artid: "146107274"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146107274
    alt: "Nginx解决前端跨域问题"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146107274
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146107274
cover: https://bing.ee123.net/img/rand?artid=146107274
image: https://bing.ee123.net/img/rand?artid=146107274
img: https://bing.ee123.net/img/rand?artid=146107274
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Nginx解决前端跨域问题
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="./../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="./../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h5>
     <a id="1__CORS__4">
     </a>
     1. 理解 CORS 和同源策略
    </h5>
    <h6>
     <a id="11__6">
     </a>
     1.1 同源策略
    </h6>
    <p>
     同源策略是一种浏览器安全机制，用于阻止不同源（不同域名、协议或端口）的 Web 应用相互访问数据。它确保了 Web 应用的隔离性，防止恶意网站访问用户数据或执行不安全的操作。
    </p>
    <p>
     同源策略下，同一个域（相同的协议、域名和端口）内的资源可以自由访问。但如果协议、域名或端口有任何不同，浏览器会阻止这种访问。
    </p>
    <h6>
     <a id="12__CORS_12">
     </a>
     1.2 跨域资源共享 (CORS)
    </h6>
    <p>
     CORS（Cross-Origin Resource Sharing，跨域资源共享）是 W3C 标准，用于解决跨域访问问题。通过 CORS，服务器可以声明哪些来源的请求是被允许的，以及允许客户端通过哪些 HTTP 方法和头部进行访问。
    </p>
    <p>
     CORS 的实现依赖于服务器返回的特定 HTTP 头信息，这些头信息指导浏览器允许或拒绝特定的跨域请求。
    </p>
    <h5>
     <a id="2_Nginx__18">
     </a>
     2. Nginx 解决跨域问题的基本原理
    </h5>
    <p>
     Nginx 可以通过配置 HTTP 响应头来支持 CORS。这些头信息包括
     <code>
      Access-Control-Allow-Origin
     </code>
     、
     <code>
      Access-Control-Allow-Methods
     </code>
     、
     <code>
      Access-Control-Allow-Headers
     </code>
     和
     <code>
      Access-Control-Allow-Credentials
     </code>
     等。通过在 Nginx 中配置这些头信息，可以允许特定的域、方法和头部进行跨域访问。
    </p>
    <h5>
     <a id="3__Nginx__22">
     </a>
     3. 配置 Nginx 解决跨域问题
    </h5>
    <p>
     下面是如何在 Nginx 中配置 CORS 的具体步骤。
    </p>
    <h6>
     <a id="31__26">
     </a>
     3.1 基础配置
    </h6>
    <p>
     假设我们有一个 API 服务器，域名为
     <code>
      api.example.com
     </code>
     ，需要允许来自
     <code>
      www.example.com
     </code>
     的前端应用进行跨域请求。
    </p>
    <p>
     首先，找到或创建 Nginx 的配置文件（通常位于
     <code>
      /etc/nginx/nginx.conf
     </code>
     或
     <code>
      /etc/nginx/conf.d/
     </code>
     目录中），然后在需要跨域的服务器块（
     <code>
      server
     </code>
     块）或位置块（
     <code>
      location
     </code>
     块）中添加 CORS 相关的头部配置。
    </p>
    <pre><code>server {
    listen 80;
    server_name api.example.com;

    location / {
        # 设置允许跨域的域名，可以使用通配符 '*' 允许所有域访问
        add_header 'Access-Control-Allow-Origin' 'http://www.example.com';

        # 设置允许的 HTTP 方法
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, DELETE, PUT';

        # 设置允许的请求头
        add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, Accept, Origin, X-Requested-With';

        # 如果需要支持 cookie，可以设置以下 header
        add_header 'Access-Control-Allow-Credentials' 'true';

        # 如果是预检请求（OPTIONS 请求），则直接返回 204 状态码
        if ($request_method = 'OPTIONS') {
            return 204;
        }

        # 其他正常请求的处理逻辑
        proxy_pass http://backend_server;
    }
}
</code></pre>
    <h6>
     <a id="32__60">
     </a>
     3.2 关键配置项详解
    </h6>
    <ul>
     <li>
      <p>
       <strong>
        <code>
         Access-Control-Allow-Origin
        </code>
       </strong>
       ：指定允许跨域请求的来源。可以设置为具体的域名（如
       <code>
        http://www.example.com
       </code>
       ），或使用通配符
       <code>
        *
       </code>
       允许所有来源。使用通配符时，不允许设置
       <code>
        Access-Control-Allow-Credentials
       </code>
       为
       <code>
        true
       </code>
       。
      </p>
     </li>
     <li>
      <p>
       <strong>
        <code>
         Access-Control-Allow-Methods
        </code>
       </strong>
       ：指定允许的 HTTP 请求方法，如
       <code>
        GET
       </code>
       、
       <code>
        POST
       </code>
       、
       <code>
        OPTIONS
       </code>
       、
       <code>
        PUT
       </code>
       、
       <code>
        DELETE
       </code>
       等。可以根据实际需要设置。
      </p>
     </li>
     <li>
      <p>
       <strong>
        <code>
         Access-Control-Allow-Headers
        </code>
       </strong>
       ：指定允许客户端发送的自定义 HTTP 头部，如
       <code>
        Authorization
       </code>
       、
       <code>
        Content-Type
       </code>
       等。此配置项通常用于支持复杂请求（带自定义头部的请求）。
      </p>
     </li>
     <li>
      <p>
       <strong>
        <code>
         Access-Control-Allow-Credentials
        </code>
       </strong>
       ：如果客户端请求包括凭据（如 Cookies），则该选项必须设置为
       <code>
        true
       </code>
       。注意，此时
       <code>
        Access-Control-Allow-Origin
       </code>
       不能为
       <code>
        *
       </code>
       ，必须为具体的域名。
      </p>
     </li>
     <li>
      <p>
       <strong>
        预检请求的处理
       </strong>
       ：浏览器在发送某些复杂请求之前，会发送一个
       <code>
        OPTIONS
       </code>
       请求进行预检，询问服务器是否允许该请求。Nginx 可以在检测到
       <code>
        OPTIONS
       </code>
       请求时，直接返回状态码
       <code>
        204
       </code>
       ，表示请求被允许，但不包含任何内容。
      </p>
     </li>
    </ul>
    <h6>
     <a id="33__73">
     </a>
     3.3 配置通配符
    </h6>
    <p>
     在某些场景中，如果需要允许所有域访问（即不限制跨域请求的来源），可以将
     <code>
      Access-Control-Allow-Origin
     </code>
     设置为
     <code>
      *
     </code>
     ：
    </p>
    <pre><code>add_header 'Access-Control-Allow-Origin' '*';
</code></pre>
    <p>
     需要注意的是，使用通配符时，不能同时启用
     <code>
      Access-Control-Allow-Credentials
     </code>
     ，否则浏览器会拒绝请求。
    </p>
    <h6>
     <a id="34__CORS__82">
     </a>
     3.4 动态设置 CORS 头
    </h6>
    <p>
     如果需要根据请求动态设置
     <code>
      Access-Control-Allow-Origin
     </code>
     ，可以使用
     <code>
      $http_origin
     </code>
     变量来匹配请求来源。例如：
    </p>
    <pre><code>location / {
    if ($http_origin ~* 'https?://(www.)?(example1.com|example2.com)') {
        add_header 'Access-Control-Allow-Origin' "$http_origin";
        add_header 'Access-Control-Allow-Credentials' 'true';
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
        add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, Accept';
    }

    if ($request_method = 'OPTIONS') {
        return 204;
    }

    proxy_pass http://backend_server;
}
</code></pre>
    <p>
     这种配置可以在满足特定条件时，动态地允许多个域名进行跨域访问。
    </p>
    <h5>
     <a id="4__OPTIONS__104">
     </a>
     4. 预检请求与 OPTIONS 方法的处理
    </h5>
    <p>
     预检请求是 CORS 规范中定义的一种机制，用于在实际请求之前探测服务器是否允许某个跨域请求。浏览器在发送某些复杂请求时，会首先发送一个
     <code>
      OPTIONS
     </code>
     请求，询问服务器是否允许该请求。
    </p>
    <p>
     Nginx 可以通过简单的配置处理这种预检请求：
    </p>
    <pre><code>if ($request_method = 'OPTIONS') {
    add_header 'Access-Control-Allow-Origin' '*';
    add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE';
    add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, Accept, Origin, X-Requested-With';
    return 204;
}
</code></pre>
    <p>
     这段配置会在收到
     <code>
      OPTIONS
     </code>
     请求时，返回一个
     <code>
      204 No Content
     </code>
     响应，并带有必要的 CORS 头部信息，表明服务器允许接下来的实际请求。
    </p>
    <h5>
     <a id="5__120">
     </a>
     5. 实践中的注意事项
    </h5>
    <h6>
     <a id="51__122">
     </a>
     5.1 安全性考虑
    </h6>
    <p>
     虽然 CORS 是解决跨域问题的有效手段，但不应随意允许所有域访问（即设置
     <code>
      Access-Control-Allow-Origin
     </code>
     为
     <code>
      *
     </code>
     ）。这种配置可能会引发安全隐患，因为任何来源的脚本都可以访问资源。因此，在配置时应明确指定允许的来源，并严格控制跨域访问的权限。
    </p>
    <h6>
     <a id="52__126">
     </a>
     5.2 性能优化
    </h6>
    <p>
     CORS 请求处理会增加服务器的负载，特别是在预检请求频繁的情况下。为了减少性能开销，可以通过以下方法进行优化：
    </p>
    <ul>
     <li>
      <strong>
       启用缓存
      </strong>
      ：通过设置
      <code>
       Access-Control-Max-Age
      </code>
      头，可以让浏览器缓存预检请求的结果，减少实际请求前的预检次数。
     </li>
     <li>
      <strong>
       合并请求
      </strong>
      ：在可能的情况下，减少跨域请求的数量，避免不必要的预检请求。
     </li>
    </ul>
    <h6>
     <a id="53__133">
     </a>
     5.3 配置管理
    </h6>
    <p>
     在生产环境中管理 Nginx 配置时，建议将 CORS 相关的配置与其他配置分开管理。例如，可以在 Nginx 的配置文件中创建一个单独的文件来管理 CORS 配置，并在需要的
     <code>
      server
     </code>
     或
     <code>
      location
     </code>
     块中包含此文件：
    </p>
    <pre><code>include /etc/nginx/cors.conf;
</code></pre>
    <p>
     这种方式可以使配置更清晰、更易于管理。
    </p>
    <h5>
     <a id="6__142">
     </a>
     6. 示例场景与配置示例
    </h5>
    <h6>
     <a id="61__API__144">
     </a>
     6.1 单页应用与 API 后端
    </h6>
    <p>
     假设有一个单页应用（SPA）部署在
     <code>
      www.example.com
     </code>
     ，它通过 Ajax 请求从
     <code>
      api.example.com
     </code>
     获取数据。Nginx 的配置可以如下：
    </p>
    <pre><code>server {
    listen 80;
    server_name api.example.com;

    location /api/ {
        add_header 'Access-Control-Allow-Origin' 'http://www.example.com';
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
        add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type';

        if ($request_method = 'OPTIONS') {


            return 204;
        }

        proxy_pass http://backend_api_server;
    }
}
</code></pre>
    <h6>
     <a id="62__168">
     </a>
     6.2 支持多个域名的跨域访问
    </h6>
    <p>
     如果需要支持来自多个域名的跨域请求，例如
     <code>
      www.example1.com
     </code>
     和
     <code>
      www.example2.com
     </code>
     ，可以使用如下配置：
    </p>
    <pre><code>location /api/ {
    if ($http_origin ~* 'https?://(www.example1.com|www.example2.com)') {
        add_header 'Access-Control-Allow-Origin' "$http_origin";
        add_header 'Access-Control-Allow-Credentials' 'true';
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
        add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type';
    }

    if ($request_method = 'OPTIONS') {
        return 204;
    }

    proxy_pass http://backend_api_server;
}
</code></pre>
    <h5>
     <a id="7__188">
     </a>
     7. 总结
    </h5>
    <p>
     通过 Nginx 配置 CORS 头部信息，可以有效解决前端跨域问题，允许前端应用从不同的域名、协议或端口请求资源。在配置过程中，需要仔细考虑安全性、性能优化和管理的易用性，以确保跨域请求的安全和高效处理。Nginx 强大的配置能力使其能够灵活应对各种跨域需求，为前端应用提供强有力的支持。
    </p>
   </div>
   <link href="./../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="./../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f6d305f37343832333832372f:61727469636c652f64657461696c732f313436313037323734" class_="artid" style="display:none">
 </p>
</div>


