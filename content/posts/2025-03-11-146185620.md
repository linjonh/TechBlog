---
layout: post
title: "Hive-中用于小文件合并的配置参数"
date: 2025-03-11 18:01:24 +0800
description: "Hive 会在 MapReduce 任务（包含 Map 和 Reduce 阶段的任务）结束时，将生成的多个小文件合并为更大的文件。当同时启用这 3 个参数时，Hive 会在任务结束时自动合并小文件，以减少小文件的数量并优化存储和查询性能。，Hive 会在 Map-only 任务（即没有 Reduce 阶段的任务）结束时，将生成的多个小文件合并为更大的文件。文件合并会消耗额外的计算资源和时间，因此在数据量较小或文件数量不多时，可能不需要启用这些参数。Hive 会尝试将小文件合并到接近该大小的文件中。"
keywords: "hive表,合并小文件,如何设置参数"
categories: ['未分类']
tags: ['数据仓库', 'Hive', 'Hadoop']
artid: "146185620"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146185620
    alt: "Hive-中用于小文件合并的配置参数"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146185620
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146185620
cover: https://bing.ee123.net/img/rand?artid=146185620
image: https://bing.ee123.net/img/rand?artid=146185620
img: https://bing.ee123.net/img/rand?artid=146185620
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Hive 中用于小文件合并的配置参数
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <p>
     SET hive.merge.mapfiles = true;
    </p>
    <p>
     SET hive.merge.mapredfiles = true;
    </p>
    <p>
     SET hive.merge.size.per.task = 256000000; -- 256 MB
    </p>
    <p>
    </p>
    <p>
     这 3 个参数是 Hive 中用于
     <strong>
      小文件合并
     </strong>
     的配置参数，主要用于解决 Hive 表中小文件过多的问题。小文件过多会导致 NameNode 压力增大、查询性能下降以及资源浪费。通过启用这些参数，Hive 可以在任务执行过程中自动合并小文件，从而优化存储和查询性能。
    </p>
    <hr/>
    <h3>
     <strong>
      1.
      <code>
       hive.merge.mapfiles
      </code>
     </strong>
    </h3>
    <ul>
     <li>
      <p>
       <strong>
        作用
       </strong>
       : 控制是否在 Map-only 任务结束时合并小文件。
      </p>
     </li>
     <li>
      <p>
       <strong>
        默认值
       </strong>
       :
       <code>
        false
       </code>
      </p>
     </li>
     <li>
      <p>
       <strong>
        解释
       </strong>
       :
      </p>
      <ul>
       <li>
        <p>
         如果设置为
         <code>
          true
         </code>
         ，Hive 会在 Map-only 任务（即没有 Reduce 阶段的任务）结束时，将生成的多个小文件合并为更大的文件。
        </p>
       </li>
       <li>
        <p>
         适用于只有 Map 阶段的任务，例如
         <code>
          INSERT OVERWRITE
         </code>
         或
         <code>
          CREATE TABLE AS SELECT
         </code>
         。
        </p>
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        示例
       </strong>
       :
      </p>
      <pre><code class="language-sql">SET hive.merge.mapfiles = true;</code></pre>
     </li>
    </ul>
    <hr/>
    <h3>
     <strong>
      2.
      <code>
       hive.merge.mapredfiles
      </code>
     </strong>
    </h3>
    <ul>
     <li>
      <p>
       <strong>
        作用
       </strong>
       : 控制是否在 MapReduce 任务结束时合并小文件。
      </p>
     </li>
     <li>
      <p>
       <strong>
        默认值
       </strong>
       :
       <code>
        false
       </code>
      </p>
     </li>
     <li>
      <p>
       <strong>
        解释
       </strong>
       :
      </p>
      <ul>
       <li>
        <p>
         如果设置为
         <code>
          true
         </code>
         ，Hive 会在 MapReduce 任务（包含 Map 和 Reduce 阶段的任务）结束时，将生成的多个小文件合并为更大的文件。
        </p>
       </li>
       <li>
        <p>
         适用于包含 Reduce 阶段的任务，例如
         <code>
          GROUP BY
         </code>
         或
         <code>
          JOIN
         </code>
         。
        </p>
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        示例
       </strong>
       :
      </p>
      <pre><code class="language-sql">SET hive.merge.mapredfiles = true;</code></pre>
     </li>
    </ul>
    <hr/>
    <h3>
     <strong>
      3.
      <code>
       hive.merge.size.per.task
      </code>
     </strong>
    </h3>
    <ul>
     <li>
      <p>
       <strong>
        作用
       </strong>
       : 设置每个任务合并后文件的目标大小。
      </p>
     </li>
     <li>
      <p>
       <strong>
        默认值
       </strong>
       :
       <code>
        256000000
       </code>
       （即 256 MB）
      </p>
     </li>
     <li>
      <p>
       <strong>
        解释
       </strong>
       :
      </p>
      <ul>
       <li>
        <p>
         该参数定义了合并后文件的目标大小。Hive 会尝试将小文件合并到接近该大小的文件中。
        </p>
       </li>
       <li>
        <p>
         如果文件大小超过该值，则不会进一步合并。
        </p>
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        示例
       </strong>
       :
      </p>
      <pre><code class="language-sql">SET hive.merge.size.per.task = 256000000; -- 256 MB</code></pre>
     </li>
    </ul>
    <hr/>
    <h3>
     <strong>
      参数组合的作用
     </strong>
    </h3>
    <p>
     当同时启用这 3 个参数时，Hive 会在任务结束时自动合并小文件，以减少小文件的数量并优化存储和查询性能。具体行为如下：
    </p>
    <ol>
     <li>
      <p>
       <strong>
        Map-only 任务
       </strong>
       :
      </p>
      <ul>
       <li>
        <p>
         如果
         <code>
          hive.merge.mapfiles = true
         </code>
         ，Hive 会在 Map-only 任务结束时合并小文件。
        </p>
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        MapReduce 任务
       </strong>
       :
      </p>
      <ul>
       <li>
        <p>
         如果
         <code>
          hive.merge.mapredfiles = true
         </code>
         ，Hive 会在 MapReduce 任务结束时合并小文件。
        </p>
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        合并文件大小
       </strong>
       :
      </p>
      <ul>
       <li>
        <p>
         Hive 会根据
         <code>
          hive.merge.size.per.task
         </code>
         的值，将小文件合并到接近该大小的文件中。
        </p>
       </li>
      </ul>
     </li>
    </ol>
    <hr/>
    <h3>
     <strong>
      适用场景
     </strong>
    </h3>
    <ul>
     <li>
      <p>
       <strong>
        小文件问题
       </strong>
       :
      </p>
      <ul>
       <li>
        <p>
         当 Hive 表中有大量小文件（例如，文件大小远小于 HDFS 块大小）时，启用这些参数可以显著减少文件数量。
        </p>
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        ETL 任务
       </strong>
       :
      </p>
      <ul>
       <li>
        <p>
         在数据导入、转换或导出过程中，可能会生成大量小文件，此时可以使用这些参数进行优化。
        </p>
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        查询性能优化
       </strong>
       :
      </p>
      <ul>
       <li>
        <p>
         减少小文件数量可以降低 NameNode 的压力，并提高查询性能。
        </p>
       </li>
      </ul>
     </li>
    </ul>
    <hr/>
    <h3>
     <strong>
      示例
     </strong>
    </h3>
    <p>
     假设有一个 Hive 表
     <code>
      example_table
     </code>
     ，数据量较大且生成了大量小文件。可以通过以下配置优化小文件问题：
    </p>
    <pre><code class="language-sql">-- 启用 Map-only 任务的小文件合并
SET hive.merge.mapfiles = true;

-- 启用 MapReduce 任务的小文件合并
SET hive.merge.mapredfiles = true;

-- 设置合并后文件的目标大小为 256 MB
SET hive.merge.size.per.task = 256000000;

-- 执行任务
INSERT OVERWRITE TABLE example_table
SELECT * FROM source_table;</code></pre>
    <hr/>
    <h3>
     <strong>
      注意事项
     </strong>
    </h3>
    <ol>
     <li>
      <p>
       <strong>
        合并开销
       </strong>
       :
      </p>
      <ul>
       <li>
        <p>
         文件合并会消耗额外的计算资源和时间，因此在数据量较小或文件数量不多时，可能不需要启用这些参数。
        </p>
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        文件大小设置
       </strong>
       :
      </p>
      <ul>
       <li>
        <p>
         <code>
          hive.merge.size.per.task
         </code>
         的值应根据集群的 HDFS 块大小和数据量合理设置。通常设置为 HDFS 块大小（如 128 MB 或 256 MB）的倍数。
        </p>
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        任务类型
       </strong>
       :
      </p>
      <ul>
       <li>
        <p>
         根据任务类型（Map-only 或 MapReduce）选择合适的参数（
         <code>
          hive.merge.mapfiles
         </code>
         或
         <code>
          hive.merge.mapredfiles
         </code>
         ）。
        </p>
       </li>
      </ul>
     </li>
    </ol>
    <hr/>
    <h3>
     <strong>
      总结
     </strong>
    </h3>
    <ul>
     <li>
      <p>
       <strong>
        <code>
         hive.merge.mapfiles
        </code>
       </strong>
       : 用于合并 Map-only 任务生成的小文件。
      </p>
     </li>
     <li>
      <p>
       <strong>
        <code>
         hive.merge.mapredfiles
        </code>
       </strong>
       : 用于合并 MapReduce 任务生成的小文件。
      </p>
     </li>
     <li>
      <p>
       <strong>
        <code>
         hive.merge.size.per.task
        </code>
       </strong>
       : 设置合并后文件的目标大小。
      </p>
     </li>
    </ul>
    <p>
     通过合理配置这些参数，可以有效解决 Hive 中的小文件问题，优化存储和查询性能。
    </p>
   </div>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f6d305f36333332323132322f:61727469636c652f64657461696c732f313436313835363230" class_="artid" style="display:none">
 </p>
</div>


