---
layout: post
title: "Python和FastAPI框架开发和容器化部署AWS上支持多种LLM和向量数据库的微服务API"
date: 2025-03-13 21:06:31 +0800
description: "用FastAPI创建一个输入提示词和所使用的LLM名称和向量搜索方式的API，返回LLM输出文本，其中用到OpenAI GPT 4o3和AWS Bedrock上的多个LLM模型的API，通过内部的类配置使用的模型和向量数据搜索类型，向量数据搜索类型包括faiss向量数据库和AWS Kendra向量数据库搜索服务，这样的逻辑用设计模式中的工厂模式实现，用Python实现Docker打包项目Python代码并在AWS ECR上注册，在AWS ECS容器中运行，已注册则直接使用现有的。"
keywords: "Python和FastAPI框架开发和容器化部署AWS上支持多种LLM和向量数据库的微服务API"
categories: ['未分类']
tags: ['语言模型', '微服务', 'Python', 'Aws']
artid: "146242360"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146242360
    alt: "Python和FastAPI框架开发和容器化部署AWS上支持多种LLM和向量数据库的微服务API"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146242360
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146242360
cover: https://bing.ee123.net/img/rand?artid=146242360
image: https://bing.ee123.net/img/rand?artid=146242360
img: https://bing.ee123.net/img/rand?artid=146242360
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Python和FastAPI框架开发和容器化部署AWS上支持多种LLM和向量数据库的微服务API
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     用FastAPI创建一个输入提示词和所使用的LLM名称和向量搜索方式的API，返回LLM输出文本，其中用到OpenAI GPT 4o3和AWS Bedrock上的多个LLM模型的API，通过内部的类配置使用的模型和向量数据搜索类型，向量数据搜索类型包括faiss向量数据库和AWS Kendra向量数据库搜索服务，这样的逻辑用设计模式中的工厂模式实现，用Python实现Docker打包项目Python代码并在AWS ECR上注册，在AWS ECS容器中运行，已注册则直接使用现有的。
    </p>
    <p>
     使用工厂模式实现LLM和向量搜索的灵活切换。以下是实现步骤：
    </p>
    <ol>
     <li>
      修改后的项目结构：
     </li>
    </ol>
    <pre><code class="prism language-bash">fastapi-on-ecs/
├─ app/
│  ├─ src/
│  │  ├─ factories.py
│  │  ├─ llms/
│  │  │  ├─ base.py
│  │  │  ├─ openai.py
│  │  │  ├─ bedrock.py
│  │  ├─ vector_db/
│  │  │  ├─ base.py
│  │  │  ├─ faiss.py
│  │  │  ├─ kendra.py
│  ├─ main.py
│  ├─ Dockerfile
│  ├─ deploy.sh
│  ├─ requirements.txt
</code></pre>
    <ol start="2">
     <li>
      修改后的main.py：
     </li>
    </ol>
    <pre><code class="prism language-python"><span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPI<span class="token punctuation">,</span> HTTPException
<span class="token keyword">from</span> pydantic <span class="token keyword">import</span> BaseModel
<span class="token keyword">from</span> src<span class="token punctuation">.</span>factories <span class="token keyword">import</span> LLMFactory<span class="token punctuation">,</span> VectorSearchFactory

app <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">InferenceRequest</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    prompt<span class="token punctuation">:</span> <span class="token builtin">str</span>
    llm_name<span class="token punctuation">:</span> <span class="token builtin">str</span>
    vector_search_type<span class="token punctuation">:</span> <span class="token builtin">str</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/generate"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">generate_text</span><span class="token punctuation">(</span>request<span class="token punctuation">:</span> InferenceRequest<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token comment"># 向量搜索</span>
        vector_search <span class="token operator">=</span> VectorSearchFactory<span class="token punctuation">.</span>create<span class="token punctuation">(</span>request<span class="token punctuation">.</span>vector_search_type<span class="token punctuation">)</span>
        context <span class="token operator">=</span> vector_search<span class="token punctuation">.</span>search<span class="token punctuation">(</span>request<span class="token punctuation">.</span>prompt<span class="token punctuation">)</span>
        
        <span class="token comment"># LLM推理</span>
        llm <span class="token operator">=</span> LLMFactory<span class="token punctuation">.</span>create<span class="token punctuation">(</span>request<span class="token punctuation">.</span>llm_name<span class="token punctuation">)</span>
        response <span class="token operator">=</span> llm<span class="token punctuation">.</span>generate<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Context: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>context<span class="token punctuation">}</span></span><span class="token string">\nPrompt: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>request<span class="token punctuation">.</span>prompt<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        
        <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span><span class="token string">"response"</span><span class="token punctuation">:</span> response<span class="token punctuation">}</span>
    
    <span class="token keyword">except</span> ValueError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>status_code<span class="token operator">=</span><span class="token number">400</span><span class="token punctuation">,</span> detail<span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>status_code<span class="token operator">=</span><span class="token number">500</span><span class="token punctuation">,</span> detail<span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/models"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">list_models</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"llm_models"</span><span class="token punctuation">:</span> LLMFactory<span class="token punctuation">.</span>list_models<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">"vector_dbs"</span><span class="token punctuation">:</span> VectorSearchFactory<span class="token punctuation">.</span>list_vector_dbs<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">root</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span><span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"Welcome to LLM Inference API"</span><span class="token punctuation">}</span>
</code></pre>
    <ol start="3">
     <li>
      工厂实现 (src/factories.py)：
     </li>
    </ol>
    <pre><code class="prism language-python"><span class="token keyword">from</span> typing <span class="token keyword">import</span> Dict<span class="token punctuation">,</span> Type
<span class="token keyword">from</span> src<span class="token punctuation">.</span>llms<span class="token punctuation">.</span>base <span class="token keyword">import</span> BaseLLM
<span class="token keyword">from</span> src<span class="token punctuation">.</span>llms<span class="token punctuation">.</span>openai <span class="token keyword">import</span> OpenAIGPT
<span class="token keyword">from</span> src<span class="token punctuation">.</span>llms<span class="token punctuation">.</span>bedrock <span class="token keyword">import</span> BedrockLLM
<span class="token keyword">from</span> src<span class="token punctuation">.</span>vector_db<span class="token punctuation">.</span>base <span class="token keyword">import</span> BaseVectorDB
<span class="token keyword">from</span> src<span class="token punctuation">.</span>vector_db<span class="token punctuation">.</span>faiss <span class="token keyword">import</span> FAISSDB
<span class="token keyword">from</span> src<span class="token punctuation">.</span>vector_db<span class="token punctuation">.</span>kendra <span class="token keyword">import</span> KendraDB

<span class="token keyword">class</span> <span class="token class-name">LLMFactory</span><span class="token punctuation">:</span>
    _models<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Type<span class="token punctuation">[</span>BaseLLM<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"gpt-4o3"</span><span class="token punctuation">:</span> OpenAIGPT<span class="token punctuation">,</span>
        <span class="token string">"ai21-jamba"</span><span class="token punctuation">:</span> BedrockLLM<span class="token punctuation">,</span>
        <span class="token string">"claude-3-opus"</span><span class="token punctuation">:</span> BedrockLLM<span class="token punctuation">,</span>
        <span class="token comment"># 其他模型映射...</span>
    <span class="token punctuation">}</span>

    <span class="token decorator annotation punctuation">@classmethod</span>
    <span class="token keyword">def</span> <span class="token function">create</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> model_name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> BaseLLM<span class="token punctuation">:</span>
        <span class="token keyword">if</span> model_name <span class="token keyword">not</span> <span class="token keyword">in</span> cls<span class="token punctuation">.</span>_models<span class="token punctuation">:</span>
            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Unsupported model: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>model_name<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> cls<span class="token punctuation">.</span>_models<span class="token punctuation">[</span>model_name<span class="token punctuation">]</span><span class="token punctuation">(</span>model_name<span class="token punctuation">)</span>
    
    <span class="token decorator annotation punctuation">@classmethod</span>
    <span class="token keyword">def</span> <span class="token function">list_models</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token builtin">list</span><span class="token punctuation">(</span>cls<span class="token punctuation">.</span>_models<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">VectorSearchFactory</span><span class="token punctuation">:</span>
    _dbs<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Type<span class="token punctuation">[</span>BaseVectorDB<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"faiss"</span><span class="token punctuation">:</span> FAISSDB<span class="token punctuation">,</span>
        <span class="token string">"kendra"</span><span class="token punctuation">:</span> KendraDB
    <span class="token punctuation">}</span>

    <span class="token decorator annotation punctuation">@classmethod</span>
    <span class="token keyword">def</span> <span class="token function">create</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> db_type<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> BaseVectorDB<span class="token punctuation">:</span>
        <span class="token keyword">if</span> db_type <span class="token keyword">not</span> <span class="token keyword">in</span> cls<span class="token punctuation">.</span>_dbs<span class="token punctuation">:</span>
            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Unsupported vector DB: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>db_type<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> cls<span class="token punctuation">.</span>_dbs<span class="token punctuation">[</span>db_type<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token decorator annotation punctuation">@classmethod</span>
    <span class="token keyword">def</span> <span class="token function">list_vector_dbs</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token builtin">list</span><span class="token punctuation">(</span>cls<span class="token punctuation">.</span>_dbs<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
    <ol start="4">
     <li>
      基础类实现 (src/llms/base.py)：
     </li>
    </ol>
    <pre><code class="prism language-python"><span class="token keyword">from</span> abc <span class="token keyword">import</span> ABC<span class="token punctuation">,</span> abstractmethod

<span class="token keyword">class</span> <span class="token class-name">BaseLLM</span><span class="token punctuation">(</span>ABC<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token decorator annotation punctuation">@abstractmethod</span>
    <span class="token keyword">def</span> <span class="token function">generate</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> prompt<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
        <span class="token keyword">pass</span>
</code></pre>
    <ol start="5">
     <li>
      OpenAI实现 (src/llms/openai.py)：
     </li>
    </ol>
    <pre><code class="prism language-python"><span class="token keyword">import</span> openai
<span class="token keyword">from</span> <span class="token punctuation">.</span>base <span class="token keyword">import</span> BaseLLM

<span class="token keyword">class</span> <span class="token class-name">OpenAIGPT</span><span class="token punctuation">(</span>BaseLLM<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> model_name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>model_name <span class="token operator">=</span> model_name
    
    <span class="token keyword">def</span> <span class="token function">generate</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> prompt<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
        response <span class="token operator">=</span> openai<span class="token punctuation">.</span>ChatCompletion<span class="token punctuation">.</span>create<span class="token punctuation">(</span>
            model<span class="token operator">=</span>self<span class="token punctuation">.</span>model_name<span class="token punctuation">,</span>
            messages<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> prompt<span class="token punctuation">}</span><span class="token punctuation">]</span>
        <span class="token punctuation">)</span>
        <span class="token keyword">return</span> response<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>message<span class="token punctuation">.</span>content
</code></pre>
    <ol start="6">
     <li>
      Bedrock实现 (src/llms/bedrock.py)：
     </li>
    </ol>
    <pre><code class="prism language-python"><span class="token keyword">import</span> boto3
<span class="token keyword">from</span> <span class="token punctuation">.</span>base <span class="token keyword">import</span> BaseLLM

<span class="token keyword">class</span> <span class="token class-name">BedrockLLM</span><span class="token punctuation">(</span>BaseLLM<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> model_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>client <span class="token operator">=</span> boto3<span class="token punctuation">.</span>client<span class="token punctuation">(</span><span class="token string">'bedrock-runtime'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>model_id <span class="token operator">=</span> model_id
    
    <span class="token keyword">def</span> <span class="token function">generate</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> prompt<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
        body <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"prompt"</span><span class="token punctuation">:</span> prompt<span class="token punctuation">,</span>
            <span class="token string">"maxTokens"</span><span class="token punctuation">:</span> <span class="token number">1024</span>
        <span class="token punctuation">}</span>
        response <span class="token operator">=</span> self<span class="token punctuation">.</span>client<span class="token punctuation">.</span>invoke_model<span class="token punctuation">(</span>
            modelId<span class="token operator">=</span>self<span class="token punctuation">.</span>model_id<span class="token punctuation">,</span>
            body<span class="token operator">=</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>body<span class="token punctuation">)</span>
        <span class="token keyword">return</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>response<span class="token punctuation">[</span><span class="token string">'body'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'completion'</span><span class="token punctuation">]</span>
</code></pre>
    <ol start="7">
     <li>
      向量数据库实现示例 (src/vector_db/faiss.py)：
     </li>
    </ol>
    <pre><code class="prism language-python"><span class="token keyword">import</span> faiss
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">from</span> <span class="token punctuation">.</span>base <span class="token keyword">import</span> BaseVectorDB

<span class="token keyword">class</span> <span class="token class-name">FAISSDB</span><span class="token punctuation">(</span>BaseVectorDB<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>index <span class="token operator">=</span> faiss<span class="token punctuation">.</span>IndexFlatL2<span class="token punctuation">(</span><span class="token number">768</span><span class="token punctuation">)</span>
        <span class="token comment"># 加载预构建的索引</span>
    
    <span class="token keyword">def</span> <span class="token function">search</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> query<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
        <span class="token comment"># 实现向量搜索逻辑</span>
        <span class="token keyword">return</span> <span class="token string">"FAISS search results"</span>
</code></pre>
    <ol start="8">
     <li>
      更新requirements.txt：
     </li>
    </ol>
    <pre><code>fastapi==0.109.2
uvicorn==0.27.1
openai&gt;=1.0.0
boto3&gt;=1.34.0
faiss-cpu&gt;=1.7.4
</code></pre>
    <p>
     部署步骤：
    </p>
    <ol>
     <li>
      构建并推送Docker镜像：
     </li>
    </ol>
    <pre><code class="prism language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable">AWS_ACCOUNT_ID</span><span class="token operator">=</span><span class="token number">123456789012</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">AWS_REGION</span><span class="token operator">=</span>us-west-2
<span class="token builtin class-name">export</span> <span class="token assign-left variable">REGISTRY_NAME</span><span class="token operator">=</span>llm-api
<span class="token builtin class-name">export</span> <span class="token assign-left variable">TAG</span><span class="token operator">=</span>latest

<span class="token comment"># 构建镜像</span>
<span class="token function">docker</span> build <span class="token parameter variable">--platform</span> linux/amd64 <span class="token parameter variable">-t</span> <span class="token variable">$REGISTRY_NAME</span> <span class="token builtin class-name">.</span>

<span class="token comment"># 推送镜像</span>
aws ecr get-login-password <span class="token operator">|</span> <span class="token function">docker</span> login <span class="token parameter variable">--username</span> AWS --password-stdin <span class="token variable">$AWS_ACCOUNT_ID</span>.dkr.ecr.<span class="token variable">$AWS_REGION</span>.amazonaws.com
<span class="token function">docker</span> tag <span class="token variable">$REGISTRY_NAME</span> <span class="token variable">$AWS_ACCOUNT_ID</span>.dkr.ecr.<span class="token variable">$AWS_REGION</span>.amazonaws.com/<span class="token variable">$REGISTRY_NAME</span><span class="token builtin class-name">:</span><span class="token variable">$TAG</span>
<span class="token function">docker</span> push <span class="token variable">$AWS_ACCOUNT_ID</span>.dkr.ecr.<span class="token variable">$AWS_REGION</span>.amazonaws.com/<span class="token variable">$REGISTRY_NAME</span><span class="token builtin class-name">:</span><span class="token variable">$TAG</span>
</code></pre>
    <ol start="2">
     <li>
      ECS任务定义需要包含以下权限（通过IAM角色）：
     </li>
    </ol>
    <pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"Version"</span><span class="token operator">:</span> <span class="token string">"2012-10-17"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"Statement"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"Effect"</span><span class="token operator">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"Action"</span><span class="token operator">:</span> <span class="token string">"bedrock:*"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"Resource"</span><span class="token operator">:</span> <span class="token string">"*"</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"Effect"</span><span class="token operator">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"Action"</span><span class="token operator">:</span> <span class="token string">"kendra:*"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"Resource"</span><span class="token operator">:</span> <span class="token string">"*"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     该实现的关键点：
    </p>
    <ol>
     <li>
      使用工厂模式灵活切换模型和向量数据库
     </li>
     <li>
      通过boto3集成AWS Bedrock服务
     </li>
     <li>
      提供标准化的API接口
     </li>
     <li>
      容器化部署支持
     </li>
     <li>
      完善的错误处理机制
     </li>
    </ol>
    <p>
     测试API：
    </p>
    <pre><code class="prism language-bash"><span class="token function">curl</span> <span class="token parameter variable">-X</span> POST http://<span class="token operator">&lt;</span>ALB_DNS<span class="token operator">&gt;</span>/generate <span class="token punctuation">\</span>
  <span class="token parameter variable">-H</span> <span class="token string">"Content-Type: application/json"</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-d</span> <span class="token string">'{
    "prompt": "Explain quantum computing",
    "llm_name": "claude-3-opus",
    "vector_search_type": "kendra"
  }'</span>
</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f33303737373931332f:61727469636c652f64657461696c732f313436323432333630" class_="artid" style="display:none">
 </p>
</div>


