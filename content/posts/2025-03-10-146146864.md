---
layout: post
title: "PostgreSQL-18新特性之虚拟生成列"
date: 2025-03-10 21:00:00 +0800
description: "PostgreSQL 18 即将引入一个新的增强：虚拟生成列。这种类型的字段值不需要存储，而是在读取数据时进行计算。虚拟生成列类似于视图，而存储生成列更像物化视图。"
keywords: "PostgreSQL 18新特性之虚拟生成列"
categories: ['Postgresql']
tags: ['数据库', 'Postgresql']
artid: "146146864"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146146864
    alt: "PostgreSQL-18新特性之虚拟生成列"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146146864
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146146864
cover: https://bing.ee123.net/img/rand?artid=146146864
image: https://bing.ee123.net/img/rand?artid=146146864
img: https://bing.ee123.net/img/rand?artid=146146864
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     PostgreSQL 18新特性之虚拟生成列
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="./../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="./../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-tomorrow-night-eighties" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     <a href="https://www.postgresql.org/docs/12/ddl-generated-columns.html" rel="nofollow">
      PostgreSQL 12
     </a>
     提供了生成列（GENERATED ALWAYS AS STORED）功能，但是只能支持存储型的生成列，需要占用存储空间，更新成本高。
    </p>
    <p>
     为此，PostgreSQL 18 即将引入一个新的增强：
     <strong>
      虚拟生成列
     </strong>
     。这种类型的字段值不需要存储，而是在读取数据时进行计算。虚拟生成列类似于视图，而存储生成列更像物化视图。
    </p>
    <p>
     我们可以通过在
     <code>
      CREATE TABLE
     </code>
     或者
     <code>
      ALTER TABLE
     </code>
     语句中指定字段的
     <code>
      GENERATED ALWAYS AS
     </code>
     约束来创建一个生成列：
    </p>
    <pre><code class="prism language-sql">column_name data_type 
GENERATED ALWAYS <span class="token keyword">AS</span> <span class="token punctuation">(</span> generation_expr <span class="token punctuation">)</span> <span class="token punctuation">[</span> STORED <span class="token operator">|</span> VIRTUAL <span class="token punctuation">]</span>
</code></pre>
    <p>
     其中，
     <code>
      GENERATED ALWAYS AS
     </code>
     表示创建生成列；generation_expr 指定了生成列的表达式；
     <code>
      STORED
     </code>
     表示存储生成列，
     <code>
      VIRTUAL
     </code>
     代表虚拟生成列（默认值）。
    </p>
    <p>
     例如以下语句：
    </p>
    <pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> t_circle<span class="token punctuation">(</span>
   id <span class="token keyword">INTEGER</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>
   x <span class="token keyword">NUMERIC</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
   y <span class="token keyword">NUMERIC</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
   radius <span class="token keyword">NUMERIC</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
   perimeter <span class="token keyword">NUMERIC</span> GENERATED ALWAYS <span class="token keyword">AS</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> <span class="token number">3.14159265</span> <span class="token operator">*</span> radius<span class="token punctuation">)</span> VIRTUAL
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> t_circle <span class="token keyword">ADD</span> area <span class="token keyword">NUMERIC</span> GENERATED ALWAYS <span class="token keyword">AS</span> <span class="token punctuation">(</span><span class="token number">3.14159265</span> <span class="token operator">*</span> radius <span class="token operator">*</span> radius<span class="token punctuation">)</span> VIRTUAL<span class="token punctuation">;</span>
</code></pre>
    <p>
     首先，
     <code>
      CREATE TABLE
     </code>
     语句为表 t_circle 定义了一个生成列 perimeter，表示圆的周长。然后，使用
     <code>
      ALTER TABLE
     </code>
     语句增加一个生成列 area ，表示圆的面积。
    </p>
    <p>
     接下来我们插入一些数据：
    </p>
    <pre><code class="prism language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> t_circle <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> t_circle<span class="token punctuation">;</span>
id<span class="token operator">|</span>x<span class="token operator">|</span>y<span class="token operator">|</span>radius<span class="token operator">|</span>perimeter  <span class="token operator">|</span>area       <span class="token operator">|</span>
<span class="token comment">--|-|-|------|-----------|-----------|</span>
 <span class="token number">1</span><span class="token operator">|</span><span class="token number">2</span><span class="token operator">|</span><span class="token number">2</span><span class="token operator">|</span>     <span class="token number">5</span><span class="token operator">|</span><span class="token number">31.41592650</span><span class="token operator">|</span><span class="token number">78.53981625</span><span class="token operator">|</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> t_circle<span class="token punctuation">(</span>id<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> radius <span class="token punctuation">,</span>perimeter<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6.28318530</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">SQL</span> Error <span class="token punctuation">[</span><span class="token number">42601</span><span class="token punctuation">]</span>: ERROR: cannot <span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token keyword">column</span> <span class="token string">"perimeter"</span>
  Detail: <span class="token keyword">Column</span> <span class="token string">"perimeter"</span> <span class="token operator">is</span> a generated <span class="token keyword">column</span><span class="token punctuation">.</span>
</code></pre>
    <p>
     第一个插入语句没有指定生成列的值，由数据库自动计算；第二个插入语句为 perimeter 提供了数据，执行失败；
     <code>
      INSERT
     </code>
     和
     <code>
      UPDATE
     </code>
     语句不能为生成列指定值。
    </p>
    <p>
     虚拟生成列具有查询时实时计算，不占用存储空间等优点；但是目前 PostgreSQL 18 提供的虚拟生成列还存在一些限制：
    </p>
    <ul>
     <li>
      不支持索引，包括唯一约束；
     </li>
     <li>
      不支持扩展统计信息；
     </li>
     <li>
      不支持外键约束；
     </li>
     <li>
      不支持非空约束（可以使用检查约束）；
     </li>
     <li>
      不支持 ALTER TABLE / DROP EXPRESSION 语句；
     </li>
     <li>
      不支持域类型；
     </li>
     <li>
      不支持逻辑复制。
     </li>
    </ul>
   </div>
   <link href="./../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="./../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
  <div class="blog-extension-box" id="blogExtensionBox" style="width:400px;margin:auto;margin-top:12px">
  </div>
 </article>
 <p alt="68747470:733a2f2f626c6f672e6373646e2e6e65742f686f727365732f:61727469636c652f64657461696c732f313436313436383634" class_="artid" style="display:none">
 </p>
</div>


