---
layout: post
title: "Redis调优从老牛车到磁悬浮的飙车指南"
date: 2025-03-16 00:08:28 +0800
description: "各位被Redis性能按在地上摩擦的车手们！今天我们要把这辆老牛破车改装成贴地飞行的磁悬浮！从每秒撑死几千QPS的绝望，到百万级吞吐量的真香现场，系好安全带，准备开启性能压榨的狂暴模式！现在你的Redis已经变身性能怪兽！不过友情提示——这个级别的优化成果，可能会让运维同事以为你给Redis嗑了兴奋剂！（剩下1%请升级硬件解决）"
keywords: "Redis调优：从老牛车到磁悬浮的飙车指南"
categories: ['业务系统应用技术', 'Java']
tags: ['缓存', '数据库', 'Spring', 'Redis', 'Java', 'Boot']
artid: "146288157"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146288157
    alt: "Redis调优从老牛车到磁悬浮的飙车指南"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146288157
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146288157
cover: https://bing.ee123.net/img/rand?artid=146288157
image: https://bing.ee123.net/img/rand?artid=146288157
img: https://bing.ee123.net/img/rand?artid=146288157
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Redis调优：从老牛车到磁悬浮的飙车指南
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     各位被Redis性能按在地上摩擦的车手们！今天我们要把这辆老牛破车改装成贴地飞行的磁悬浮！从每秒撑死几千QPS的绝望，到百万级吞吐量的真香现场，系好安全带，准备开启性能压榨的狂暴模式！ 🏎️💨
    </p>
    <hr/>
    <h4>
     <a id="_6">
     </a>
     <strong>
      第一幕：引擎改装——内存调优の黑科技
     </strong>
    </h4>
    <p>
     <strong>
      1. 内存碎片整理术
     </strong>
    </p>
    <pre><code class="prism language-bash"><span class="token comment"># 查看碎片率（&gt;1.5就该动手了）  </span>
redis-cli info memory <span class="token operator">|</span> <span class="token function">grep</span> mem_fragmentation_ratio  

<span class="token comment"># 暴力整理（主线程卡顿警告）  </span>
redis-cli memory purge  
<span class="token comment"># 温柔疗法（4.0+版本专属）  </span>
config <span class="token builtin class-name">set</span> activedefrag <span class="token function">yes</span>  
</code></pre>
    <p>
     <strong>
      2. 对象回收の三十六计
     </strong>
    </p>
    <pre><code class="prism language-bash">maxmemory 100gb  <span class="token comment"># 别让内存裸奔！  </span>
maxmemory-policy allkeys-lfu  <span class="token comment"># 把不常用的冷宫数据踢出去  </span>
<span class="token comment"># 特殊场景可选volatile-ttl：优先清理过期Key  </span>
</code></pre>
    <p>
     <strong>
      3. 小对象压缩の缩骨功
     </strong>
    </p>
    <pre><code class="prism language-bash"><span class="token comment"># 在redis.conf里激活压缩  </span>
hash-max-ziplist-entries <span class="token number">512</span>  <span class="token comment"># Hash元素≤512用压缩  </span>
hash-max-ziplist-value <span class="token number">64</span>     <span class="token comment"># 单个元素≤64字节用压缩  </span>
list-max-ziplist-size <span class="token parameter variable">-2</span>      <span class="token comment"># List元素≤64KB用压缩  </span>
</code></pre>
    <hr/>
    <h4>
     <a id="IO_36">
     </a>
     <strong>
      第二幕：传动系统——网络与IO优化
     </strong>
    </h4>
    <p>
     <strong>
      1. 连接池の涡轮增压
     </strong>
    </p>
    <pre><code class="prism language-java"><span class="token class-name">JedisPoolConfig</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JedisPoolConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
config<span class="token punctuation">.</span><span class="token function">setMaxTotal</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 秋名山弯道级并发  </span>
config<span class="token punctuation">.</span><span class="token function">setMaxIdle</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 保持待命车手数量  </span>
config<span class="token punctuation">.</span><span class="token function">setMinIdle</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">// 最低预备役  </span>
config<span class="token punctuation">.</span><span class="token function">setTestOnBorrow</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 每次取连接做健康检查  </span>
</code></pre>
    <p>
     <strong>
      2. 管道操作の氮气加速
     </strong>
    </p>
    <pre><code class="prism language-python"><span class="token keyword">with</span> redis<span class="token punctuation">.</span>pipeline<span class="token punctuation">(</span>transaction<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span> <span class="token keyword">as</span> pipe<span class="token punctuation">:</span>  
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  
        pipe<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"key_</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>i<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>  
    results <span class="token operator">=</span> pipe<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 网络交互从1万次→1次  </span>
</code></pre>
    <p>
     <strong>
      3. 内核参数の秘密改装
     </strong>
    </p>
    <pre><code class="prism language-bash"><span class="token comment"># 调整TCP backlog队列  </span>
<span class="token builtin class-name">echo</span> <span class="token number">511</span> <span class="token operator">&gt;</span> /proc/sys/net/core/somaxconn  
<span class="token comment"># 增加文件句柄上限  </span>
<span class="token builtin class-name">ulimit</span> <span class="token parameter variable">-n</span> <span class="token number">1000000</span>  
<span class="token comment"># 禁用透明大页（防止内存延迟波动）  </span>
<span class="token builtin class-name">echo</span> never <span class="token operator">&gt;</span> /sys/kernel/mm/transparent_hugepage/enabled  
</code></pre>
    <hr/>
    <h4>
     <a id="_67">
     </a>
     <strong>
      第三幕：底盘强化——数据结构の魔改
     </strong>
    </h4>
    <p>
     <strong>
      1. 热点Keyの分筋错骨
     </strong>
    </p>
    <pre><code class="prism language-bash"><span class="token comment"># 原始大Key（找死行为）  </span>
<span class="token builtin class-name">set</span> user:10001:history <span class="token string">"1,2,3,...1000000"</span>  

<span class="token comment"># 改造方案（SSD分体式存储）：  </span>
hmset user:10001:history_part1 <span class="token string">"0-5000"</span> <span class="token string">"1,2,...,5000"</span>  
hmset user:10001:history_part2 <span class="token string">"5001-10000"</span> <span class="token string">"5001,..."</span>  
</code></pre>
    <p>
     <strong>
      2. 多维查询の空间折叠
     </strong>
    </p>
    <pre><code class="prism language-bash"><span class="token comment"># 原始低效查询  </span>
zrangebyscore temperature <span class="token parameter variable">-inf</span> +inf  <span class="token comment"># 全表扫描警告  </span>

<span class="token comment"># 建立二级索引（时空改造）：  </span>
sadd station:1001:days <span class="token number">20230101</span> <span class="token number">20230102</span><span class="token punctuation">..</span>.  
zadd temperature:1001:20230101 <span class="token number">25.3</span> <span class="token number">162000</span>  
</code></pre>
    <p>
     <strong>
      3. 统计计数の量子压缩
     </strong>
    </p>
    <pre><code class="prism language-bash"><span class="token comment"># 传统方案（内存爆炸）  </span>
sadd page:view:20230810 user1 user2<span class="token punctuation">..</span>.user1000000  

<span class="token comment"># 黑科技方案（误差1%但省95%内存）：  </span>
pfadd page:view:20230810 user1  
pfcount page:view:20230810  
</code></pre>
    <hr/>
    <h4>
     <a id="_101">
     </a>
     <strong>
      第四幕：涡轮增压——集群调优
     </strong>
    </h4>
    <p>
     <strong>
      1. 数据分片の空间跳跃
     </strong>
    </p>
    <pre><code class="prism language-bash"><span class="token comment"># 使用Hash Tag强制同slot存储  </span>
<span class="token builtin class-name">set</span> user:<span class="token punctuation">{<!-- --></span><span class="token number">10001</span><span class="token punctuation">}</span>.profile <span class="token string">"xxx"</span>  
<span class="token builtin class-name">set</span> order:<span class="token punctuation">{<!-- --></span><span class="token number">10001</span><span class="token punctuation">}</span>.20230810 <span class="token string">"yyy"</span>  
<span class="token comment"># 保证用户相关数据在同一个节点  </span>
</code></pre>
    <p>
     <strong>
      2. 跨节点事务の相对论
     </strong>
    </p>
    <pre><code class="prism language-lua"><span class="token comment">-- 使用Lua脚本保证原子性  </span>
<span class="token keyword">local</span> key1 <span class="token operator">=</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>  
<span class="token keyword">local</span> key2 <span class="token operator">=</span> KEYS<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>  
<span class="token keyword">local</span> val <span class="token operator">=</span> ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>  
redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'set'</span><span class="token punctuation">,</span> key1<span class="token punctuation">,</span> val<span class="token punctuation">)</span>  
redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'incr'</span><span class="token punctuation">,</span> key2<span class="token punctuation">)</span>  
<span class="token operator">#</span> 所有操作在单个节点执行  
</code></pre>
    <p>
     <strong>
      3. 全球多活の曲率引擎
     </strong>
    </p>
    <pre><code class="prism language-yaml"><span class="token comment"># 三地集群配置  </span>
东京集群：处理亚洲订单  
法兰克福集群：服务欧洲用户  
弗吉尼亚集群：覆盖美洲业务  
<span class="token comment"># 通过CRDT实现最终一致性  </span>
</code></pre>
    <hr/>
    <h4>
     <a id="_133">
     </a>
     <strong>
      第五幕：氮气加速——极限压榨
     </strong>
    </h4>
    <p>
     <strong>
      1. 内存盘の禁忌魔法
     </strong>
    </p>
    <pre><code class="prism language-bash"><span class="token comment"># 把AOF日志放到内存盘（土豪玩法）  </span>
<span class="token function">mount</span> <span class="token parameter variable">-t</span> tmpfs <span class="token parameter variable">-o</span> <span class="token assign-left variable">size</span><span class="token operator">=</span>20G tmpfs /mnt/ramdisk  
<span class="token comment"># 修改redis配置：  </span>
<span class="token function">dir</span> /mnt/ramdisk  
</code></pre>
    <p>
     <strong>
      2. 内核旁路の终极大招
     </strong>
    </p>
    <pre><code class="prism language-bash"><span class="token comment"># 使用DPDK接管网卡（需要定制Redis）  </span>
./configure --with-dpdk  
<span class="token comment"># 网络处理速度提升10倍！  </span>
</code></pre>
    <p>
     <strong>
      3. 硬件の黑暗改造
     </strong>
    </p>
    <ul>
     <li>
      上液冷服务器（压制CPU高温）
     </li>
     <li>
      换Optane持久内存（降低AOF延迟）
     </li>
     <li>
      装100Gbps网卡（网络不再成瓶颈）
     </li>
    </ul>
    <hr/>
    <h4>
     <a id="_157">
     </a>
     <strong>
      终极大招：调优大师の保命符
     </strong>
    </h4>
    <p>
     <strong>
      1. 渐进式优化法则
     </strong>
    </p>
    <pre><code class="prism language-bash">每次只改一个参数 → 观察监控 → 记录效果  
<span class="token comment"># 禁止在周五下午做激进的参数调整！  </span>
</code></pre>
    <p>
     <strong>
      2. 混沌工程の压力测试
     </strong>
    </p>
    <pre><code class="prism language-bash">memtier_benchmark <span class="token parameter variable">--threads</span><span class="token operator">=</span><span class="token number">64</span> <span class="token parameter variable">--clients</span><span class="token operator">=</span><span class="token number">1000</span> <span class="token punctuation">\</span>  
--test-time<span class="token operator">=</span><span class="token number">60</span> <span class="token parameter variable">--ratio</span><span class="token operator">=</span><span class="token number">1</span>:1 <span class="token parameter variable">--pipeline</span><span class="token operator">=</span><span class="token number">100</span>  
<span class="token comment"># 把集群逼到极限才能发现真问题  </span>
</code></pre>
    <p>
     <strong>
      3. 回滚预案の时空传送门
     </strong>
    </p>
    <pre><code class="prism language-bash"><span class="token comment"># 每次调优前：  </span>
<span class="token number">1</span>. 备份配置文件  
<span class="token number">2</span>. 记录当前监控指标  
<span class="token number">3</span>. 准备秒级回滚脚本  
</code></pre>
    <hr/>
    <p>
     最后送上性能调优の宇宙真理：
     <br/>
     <strong>
      没有银弹！99%的性能问题都是错误使用导致的！
     </strong>
     <br/>
     （剩下1%请升级硬件解决）
    </p>
    <p>
     现在你的Redis已经变身性能怪兽！不过友情提示——这个级别的优化成果，可能会让运维同事以为你给Redis嗑了兴奋剂！ 💊
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f:626c6f672e6373646e2e6e65742f77616e673534333230332f:61727469636c652f64657461696c732f313436323838313537" class_="artid" style="display:none">
 </p>
</div>


