---
layout: post
title: "关于sqlalchemy的使用"
date: 2025-03-06 20:06:03 +0800
description: "【代码】关于sqlalchemy的使用。"
keywords: "关于sqlalchemy的使用"
categories: ['未分类']
tags: ['数据库']
artid: "146078557"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146078557
    alt: "关于sqlalchemy的使用"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146078557
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146078557
cover: https://bing.ee123.net/img/rand?artid=146078557
image: https://bing.ee123.net/img/rand?artid=146078557
img: https://bing.ee123.net/img/rand?artid=146078557
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     关于sqlalchemy的使用
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <p>
    </p>
    <h2>
     <a id="_2">
     </a>
     说明
    </h2>
    <ol>
     <li>
      本教程所需软件及库python3.10、sqlalchemy
     </li>
     <li>
      安装与创建库、连结库
     </li>
     <li>
      创建表、增加数据
     </li>
     <li>
      查询记录
     </li>
     <li>
      更新或删除
     </li>
     <li>
      关联表定义
     </li>
    </ol>
    <h2>
     <a id="sqlachemy_10">
     </a>
     一、sqlachemy总体使用思路
    </h2>
    <ol>
     <li>
      在创建或连结后会返回engine(可以参考第二节安装与创建库、连结库)
     </li>
     <li>
      在创建表后会返回一个表名（可以参考第三节创建表、增加数据）
     </li>
     <li>
      使用时
      <strong>
       表名.方法.属性
      </strong>
     </li>
     <li>
      方法有insert,select,update,delecte
     </li>
     <li>
      与数据对接时，conn = engine.connect()—conn.execut(表方法返回的值)
     </li>
     <li>
      当数据库的数据发生改变时，要提交(conn.commit())
     </li>
     <li>
      查询时，要注意条件，有两种方法where() | or_ | and_
     </li>
    </ol>
    <h2>
     <a id="_18">
     </a>
     二、安装与创建库、连结库
    </h2>
    <ol>
     <li>
      安装库
     </li>
    </ol>
    <pre><code class="prism language-python">pip install sqlalchemy
<span class="token comment">#查看版本</span>
sqlalchemy<span class="token punctuation">.</span>__vetrsion__
</code></pre>
    <ol start="2">
     <li>
      创建库或连结库
     </li>
    </ol>
    <pre><code class="prism language-python"><span class="token comment">#连结或创建sqlite3</span>
<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> create_engine
engine <span class="token operator">=</span> create_engine<span class="token punctuation">(</span><span class="token string">'sqlite:///db_path.db'</span><span class="token punctuation">,</span>echo<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
conn <span class="token operator">=</span> engine<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
    <pre><code class="prism language-python"><span class="token comment">#连结或创建mysql</span>
<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> create_engine
engine <span class="token operator">=</span> create_engine<span class="token punctuation">(</span><span class="token string">'mysql://user:pwd@localhoast/库名'</span><span class="token punctuation">,</span>echo<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
conn <span class="token operator">=</span> engine<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     <mark>
      注：create_engine如果已经存在就连结，如果不存在就创建。
     </mark>
    </p>
    <ol start="3">
     <li>
      在sqlalchemy执行sql语句
     </li>
    </ol>
    <pre><code class="prism language-python"><span class="token keyword">import</span> sqlachemy
query <span class="token operator">=</span> sqlachemy<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token string">"select * from 表名"</span><span class="token punctuation">)</span><span class="token comment">#sql语句</span>
engine <span class="token operator">=</span> sqlalchemy<span class="token punctuation">.</span>create_engine<span class="token punctuation">(</span>`sqlite<span class="token punctuation">:</span><span class="token operator">//</span><span class="token operator">/</span>db_path<span class="token punctuation">.</span>db`<span class="token punctuation">,</span>echo<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
conn <span class="token operator">=</span> engine<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">)</span>
result_set <span class="token operator">=</span> conn<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>query<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>result_set<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
engine<span class="token punctuation">.</span>dispose<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     <strong>
      注：以下代码engine代表创建或检查数据库，conn代表连结数据库。
     </strong>
    </p>
    <h2>
     <a id="_52">
     </a>
     三、创建表、增加数据
    </h2>
    <ol>
     <li>
      创建表
      <br/>
      <mark>
       创建表要用到sqlalchemy的三个库MetaData、Table、Column及类型代码
      </mark>
     </li>
    </ol>
    <pre><code class="prism language-python"><span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> MetaData<span class="token punctuation">,</span>Table<span class="token punctuation">,</span>Column
meta <span class="token operator">=</span> MetaData<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">#Meta定义好的字段属性存在这，所以第二个字段就要传它</span>
var <span class="token operator">=</span> Table<span class="token punctuation">(</span>
<span class="token string">'表名'</span><span class="token punctuation">,</span>meta<span class="token punctuation">,</span>
Clolumn<span class="token punctuation">(</span><span class="token string">'字段名'</span><span class="token punctuation">,</span>sqlachemy<span class="token punctuation">.</span>类型<span class="token punctuation">,</span>primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">)</span>
meta<span class="token punctuation">.</span>create_all<span class="token punctuation">(</span>engine<span class="token punctuation">)</span><span class="token comment">#创建表</span>
</code></pre>
    <p>
     <mark>
      如果表已经存在了，就不会创建，如果不存在就创建。
     </mark>
     <br/>
     2. sqlachemy字段类型
    </p>
    <table>
     <thead>
      <tr>
       <th>
        名称
       </th>
       <th>
        字段英文
       </th>
       <th>
        用法
       </th>
       <th>
        说明
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        整形
       </td>
       <td>
        Integer
       </td>
       <td>
        Integer
       </td>
       <td>
        存整数
       </td>
      </tr>
      <tr>
       <td>
        小数
       </td>
       <td>
       </td>
       <td>
       </td>
       <td>
        存小数
       </td>
      </tr>
      <tr>
       <td>
        字符
       </td>
       <td>
        String
       </td>
       <td>
        String(字符个数)
       </td>
       <td>
        存字符
       </td>
      </tr>
      <tr>
       <td>
        日期
       </td>
       <td>
        Date
       </td>
       <td>
        Date
       </td>
       <td>
        存年月日
       </td>
      </tr>
      <tr>
       <td>
        –
       </td>
       <td>
        –
       </td>
       <td>
        –
       </td>
       <td>
        –
       </td>
      </tr>
     </tbody>
    </table>
    <p>
     <mark>
      注：主键primary_key=True,unique=True唯一,unllable=True不能为空。
     </mark>
    </p>
    <ol start="3">
     <li>
      增加数据（insert）
      <br/>
      3.1 插入一条数据
     </li>
    </ol>
    <pre><code class="prism language-python">var <span class="token operator">=</span> 表名<span class="token punctuation">.</span>insert<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>values<span class="token punctuation">(</span>字段名<span class="token operator">=</span>值，<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
<span class="token keyword">with</span> engine<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> conn<span class="token punctuation">:</span>
	conn<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>var<span class="token punctuation">)</span>
	conn<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     <strong>
      1、连结conn以后执行数据库操作要用conn.execut(sqlachemy语句)
     </strong>
     <br/>
     <strong>
      2、数据库数据有变要提交事务,conn.commit()
     </strong>
     <br/>
     <strong>
      3、var = 表名.insert().values(字段名=值，…)是新增数据的sqlachemy语句
     </strong>
     <br/>
     <strong>
      4、 自增长是插一次，它就增加一次，它不管你是否成功
     </strong>
     <br/>
     3.2 插入多条数据
    </p>
    <pre><code class="prism language-python">var <span class="token operator">=</span> 表名<span class="token punctuation">.</span>insert<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">with</span> engine<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> conn<span class="token punctuation">:</span>
	conn<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>var<span class="token punctuation">,</span><span class="token punctuation">[</span>
		<span class="token punctuation">{<!-- --></span><span class="token string">'字段名'</span><span class="token punctuation">:</span>value<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{<!-- --></span><span class="token string">'字段名'</span><span class="token punctuation">:</span>value<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
		<span class="token punctuation">]</span><span class="token punctuation">)</span>
	conn<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     <strong>
      这个要用列表，并且列表里放字典，key是字段名，value是对应的值
     </strong>
    </p>
    <h2>
     <a id="_106">
     </a>
     四、查询记录
    </h2>
    <ol>
     <li>
      sql查询语句
     </li>
    </ol>
    <pre><code class="prism language-python">select <span class="token operator">*</span> <span class="token keyword">from</span> 表名
</code></pre>
    <ol start="2">
     <li>
      函数表达式
     </li>
    </ol>
    <pre><code class="prism language-python">表名<span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
    <ol start="3">
     <li>
      结果获取
     </li>
    </ol>
    <pre><code class="prism language-python">结果<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#获取所有数据</span>
结果<span class="token punctuation">.</span>fetchone<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#获取第一条数据</span>
</code></pre>
    <ol start="4">
     <li>
      条件查询
     </li>
    </ol>
    <pre><code class="prism language-python">表名<span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>表名<span class="token punctuation">.</span>c<span class="token punctuation">.</span>字段名条件<span class="token punctuation">)</span>
<span class="token comment">#一次只能有一个条件</span>
<span class="token comment">#如果多个条件查询时，在后面加.where(表名.c.字段名条件)</span>
</code></pre>
    <ol start="5">
     <li>
      and_(与)、or_(或)
     </li>
    </ol>
    <pre><code class="prism language-python"><span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>sql <span class="token keyword">import</span> and_<span class="token punctuation">,</span>or_
表名<span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>or_<span class="token punctuation">(</span>条件<span class="token punctuation">,</span>条件<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token operator">|</span> and_<span class="token punctuation">(</span>条件<span class="token punctuation">,</span>条件<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># 要在where中使用and_,or_</span>
<span class="token comment"># and_,or_可以相互嵌套</span>
</code></pre>
    <h2>
     <a id="_133">
     </a>
     五、更新或删除
    </h2>
    <ol>
     <li>
      更新
     </li>
    </ol>
    <pre><code class="prism language-python">表名<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>条件<span class="token punctuation">)</span><span class="token punctuation">.</span>values<span class="token punctuation">(</span>字段名<span class="token operator">=</span>value<span class="token punctuation">)</span>
<span class="token comment">#查询结果后再更新值，一个values可以更新多条记录或所有记录，取决于查询的结果</span>
</code></pre>
    <ol start="2">
     <li>
      删除
     </li>
    </ol>
    <pre><code class="prism language-python">表名<span class="token punctuation">.</span>delete<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>条件<span class="token punctuation">)</span>
<span class="token comment">#查询结果后再删除，可以删除多条记录或所有记录，取决于查询的结果</span>
</code></pre>
    <h2>
     <a id="_144">
     </a>
     六、关联表定义
    </h2>
    <ol>
     <li>
      一对多关联(sqlachemy.ForeignKey(‘表名.id’))
     </li>
    </ol>
    <pre><code class="prism language-python"><span class="token keyword">import</span> sqlalchemy
<span class="token comment">#创建表</span>
mate <span class="token operator">=</span> sqlalchemy<span class="token punctuation">.</span>MateData<span class="token punctuation">(</span><span class="token punctuation">)</span>
表名 <span class="token operator">=</span> sqlachemy<span class="token punctuation">.</span>Table<span class="token punctuation">(</span><span class="token string">'表名'</span><span class="token punctuation">,</span>mate<span class="token punctuation">,</span>
	sqlachemy<span class="token punctuation">.</span>Column<span class="token punctuation">(</span><span class="token string">'字段名'</span><span class="token punctuation">,</span>sqlachemy<span class="token punctuation">.</span>Integer<span class="token punctuation">,</span>sqlachemy<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span><span class="token string">'关联的表名.id'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	
	<span class="token punctuation">)</span>
</code></pre>
    <ol start="2">
     <li>
      多对多
     </li>
    </ol>
    <h2>
     <a id="_156">
     </a>
     七、一对多关联查询
    </h2>
    <ol>
     <li>
      查询条件
     </li>
    </ol>
    <pre><code class="prism language-python">imort sqlalchemy
join <span class="token operator">=</span> 关联表名<span class="token punctuation">.</span>join<span class="token punctuation">(</span>被关联表名<span class="token punctuation">,</span>关联表名<span class="token punctuation">.</span>c<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token operator">==</span>被关联表名<span class="token punctuation">.</span>c<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span>
</code></pre>
    <ol start="2">
     <li>
      使用查询
     </li>
    </ol>
    <pre><code class="prism language-python">imort sqlalchemy
join <span class="token operator">=</span> 关联表名<span class="token punctuation">.</span>join<span class="token punctuation">(</span>被关联表名<span class="token punctuation">,</span>关联表名<span class="token punctuation">.</span>c<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token operator">==</span>被关联表名<span class="token punctuation">.</span>c<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span>
<span class="token comment">#关联表和被关联表的信息都显示</span>
query <span class="token operator">=</span> sqlalchemy<span class="token punctuation">.</span>select<span class="token punctuation">(</span>join<span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>关联表或被关联表<span class="token punctuation">.</span>字段<span class="token operator">=</span>value<span class="token punctuation">)</span>
<span class="token comment">#只显示关联表或被关联表的信息</span>
query <span class="token operator">=</span> sqlalchemy<span class="token punctuation">.</span>select<span class="token punctuation">(</span>被关联表名或关联表名<span class="token punctuation">)</span><span class="token punctuation">.</span>select_from<span class="token punctuation">(</span>join<span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>关联表或被关联表<span class="token punctuation">.</span>字段<span class="token operator">=</span>value<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>conn<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
    <h2>
     <a id="_172">
     </a>
     八、映射类定义与添加记录
    </h2>
    <ol>
     <li>
      映射基础
     </li>
    </ol>
    <pre><code class="prism language-python"><span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>ext<span class="token punctuation">.</span>declarative <span class="token keyword">import</span> declarative_base
Base <span class="token operator">=</span> declarative_base<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> 类名<span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
	__tablename__<span class="token operator">=</span><span class="token string">'表名'</span>
	字段名 <span class="token operator">=</span> Column<span class="token punctuation">(</span>类型<span class="token punctuation">,</span>其它参数<span class="token punctuation">)</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token comment">#创建表</span>
类名<span class="token punctuation">.</span>metadata<span class="token punctuation">.</span>create_all<span class="token punctuation">(</span>engine<span class="token punctuation">)</span> 
</code></pre>
    <ol start="2">
     <li>
      利用类添加记录
     </li>
    </ol>
    <pre><code class="prism language-python"><span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> sessionmaker

Session <span class="token operator">=</span> sessionmaker<span class="token punctuation">(</span>bind<span class="token operator">=</span>engine<span class="token punctuation">)</span>

session <span class="token operator">=</span> Session<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">#上面的类名</span>
<span class="token comment">#增加一条记录</span>
var <span class="token operator">=</span> 类名<span class="token punctuation">(</span>字段名<span class="token operator">=</span>value<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token comment">#类名实例化</span>
session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>var<span class="token punctuation">)</span>
session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">#增加多条记录</span>
varList <span class="token operator">=</span> <span class="token punctuation">[</span>类名实例化列表<span class="token punctuation">]</span>
session<span class="token punctuation">.</span>add_all<span class="token punctuation">(</span>varList<span class="token punctuation">)</span>
session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f:2f626c6f672e6373646e2e6e65742f68726a3139393033362f:61727469636c652f64657461696c732f313436303738353537" class_="artid" style="display:none">
 </p>
</div>


