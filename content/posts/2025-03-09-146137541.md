---
layout: post
title: "Python实战进阶No17-数据库连接与-ORMSQLAlchemy-实战"
date: 2025-03-09 19:58:41 +0800
description: "本文深入探讨SQLAlchemy在复杂场景下的高级应用，涵盖四大核心主题：  1. **会话生命周期管理**：通过事件钩子实现事务监控与审计追踪  2. **混合继承映射**：结合单表/连接表继承优势实现多态模型  3. **高性能操作**：批量插入与核心SQL构造优化大数据处理  4. **异步支持**：基于asyncmy的MySQL异步引擎实践  实战案例包含电商系统的分库分表实现策略与基于ORM的审计日志系统设计。"
keywords: "《Python实战进阶》No17: 数据库连接与 ORM（SQLAlchemy 实战）"
categories: ['Python']
tags: ['深度学习', '机器学习']
artid: "146137541"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146137541
    alt: "Python实战进阶No17-数据库连接与-ORMSQLAlchemy-实战"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146137541
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146137541
cover: https://bing.ee123.net/img/rand?artid=146137541
image: https://bing.ee123.net/img/rand?artid=146137541
img: https://bing.ee123.net/img/rand?artid=146137541
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     《Python实战进阶》No17: 数据库连接与 ORM（SQLAlchemy 实战）
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="No17__ORMSQLAlchemy__0">
     </a>
     No17: 数据库连接与 ORM（SQLAlchemy 实战）
    </h2>
    <hr/>
    <p>
     <strong>
      摘要
     </strong>
     <br/>
     本文深入探讨SQLAlchemy在复杂场景下的高级应用，涵盖四大核心主题：
    </p>
    <ol>
     <li>
      <strong>
       会话生命周期管理
      </strong>
      ：通过事件钩子实现事务监控与审计追踪
     </li>
     <li>
      <strong>
       混合继承映射
      </strong>
      ：结合单表/连接表继承优势实现多态模型
     </li>
     <li>
      <strong>
       高性能操作
      </strong>
      ：批量插入与核心SQL构造优化大数据处理
     </li>
     <li>
      <strong>
       异步支持
      </strong>
      ：基于asyncmy的MySQL异步引擎实践
     </li>
    </ol>
    <p>
     实战案例包含电商系统的分库分表实现策略与基于ORM的审计日志系统设计。扩展部分解析多租户架构的三种隔离方案及SQL注入防御的ORM层最佳实践。配套代码演示了从分片路由到异步操作的完整电商系统实现，帮助开发者掌握构建高并发、高安全性的企业级数据库应用能力。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/4db249ab49cb45ac83b186f47079b907.png#pic_center"/>
    </p>
    <h3>
     <a id="_14">
     </a>
     核心概念
    </h3>
    <h4>
     <a id="1_Session_16">
     </a>
     1. 会话生命周期管理（Session事件钩子）
    </h4>
    <p>
     通过事件钩子实现精细化的会话控制，典型场景包括事务边界管理、变更追踪和审计日志。
    </p>
    <pre><code class="prism language-python"><span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> event
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> sessionmaker

Session <span class="token operator">=</span> sessionmaker<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 事务提交前事件</span>
<span class="token decorator annotation punctuation">@event<span class="token punctuation">.</span>listens_for</span><span class="token punctuation">(</span>Session<span class="token punctuation">,</span> <span class="token string">'before_commit'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">before_commit</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"即将提交事务，当前待处理变更："</span><span class="token punctuation">,</span> session<span class="token punctuation">.</span>dirty<span class="token punctuation">)</span>

<span class="token comment"># 事务回滚后事件</span>
<span class="token decorator annotation punctuation">@event<span class="token punctuation">.</span>listens_for</span><span class="token punctuation">(</span>Session<span class="token punctuation">,</span> <span class="token string">'after_rollback'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">after_rollback</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"事务已回滚，清理临时状态"</span><span class="token punctuation">)</span>
</code></pre>
    <h4>
     <a id="2__36">
     </a>
     2. 混合继承映射策略
    </h4>
    <p>
     结合单表继承和连接表继承的优势，实现灵活的多态查询：
    </p>
    <pre><code class="prism language-python"><span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> Column<span class="token punctuation">,</span> Integer<span class="token punctuation">,</span> String<span class="token punctuation">,</span> ForeignKey
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>ext<span class="token punctuation">.</span>declarative <span class="token keyword">import</span> declarative_base
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> relationship

Base <span class="token operator">=</span> declarative_base<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Product</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'product'</span>
    <span class="token builtin">id</span> <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token builtin">type</span> <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 单表继承标识</span>
    __mapper_args__ <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'polymorphic_on'</span><span class="token punctuation">:</span> <span class="token builtin">type</span><span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Book</span><span class="token punctuation">(</span>Product<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'book'</span>
    <span class="token builtin">id</span> <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> ForeignKey<span class="token punctuation">(</span><span class="token string">'product.id'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    isbn <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    __mapper_args__ <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'polymorphic_identity'</span><span class="token punctuation">:</span> <span class="token string">'book'</span><span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Electronic</span><span class="token punctuation">(</span>Product<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'electronic'</span>
    <span class="token builtin">id</span> <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> ForeignKey<span class="token punctuation">(</span><span class="token string">'product.id'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    warranty <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">)</span>
    __mapper_args__ <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'polymorphic_identity'</span><span class="token punctuation">:</span> <span class="token string">'electronic'</span><span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="3_SQL_65">
     </a>
     3. 批量操作与核心SQL构造
    </h4>
    <p>
     高效处理大数据量操作的两种方式：
    </p>
    <pre><code class="prism language-python"><span class="token comment"># ORM批量插入</span>
session<span class="token punctuation">.</span>bulk_insert_mappings<span class="token punctuation">(</span>User<span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span><span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Alice"</span><span class="token punctuation">,</span> <span class="token string">"age"</span><span class="token punctuation">:</span> <span class="token number">30</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Bob"</span><span class="token punctuation">,</span> <span class="token string">"age"</span><span class="token punctuation">:</span> <span class="token number">25</span><span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment"># 核心SQL构造</span>
<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> select<span class="token punctuation">,</span> table<span class="token punctuation">,</span> column
users <span class="token operator">=</span> table<span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">,</span> 
    column<span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> column<span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> column<span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
stmt <span class="token operator">=</span> users<span class="token punctuation">.</span>insert<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span><span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'Charlie'</span><span class="token punctuation">,</span> <span class="token string">'age'</span><span class="token punctuation">:</span> <span class="token number">35</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'David'</span><span class="token punctuation">,</span> <span class="token string">'age'</span><span class="token punctuation">:</span> <span class="token number">40</span><span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
connection<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>stmt<span class="token punctuation">)</span>
</code></pre>
    <h4>
     <a id="4_greenlet_87">
     </a>
     4. 异步引擎与greenlet整合
    </h4>
    <p>
     使用asyncmy驱动实现MySQL异步操作：
    </p>
    <pre><code class="prism language-python"><span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>ext<span class="token punctuation">.</span>asyncio <span class="token keyword">import</span> create_async_engine
<span class="token keyword">import</span> asyncio

async_engine <span class="token operator">=</span> create_async_engine<span class="token punctuation">(</span>
    <span class="token string">"mysql+asyncmy://user:pass@localhost/db"</span><span class="token punctuation">,</span>
    pool_size<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> max_overflow<span class="token operator">=</span><span class="token number">10</span>
<span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">fetch_users</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">async</span> <span class="token keyword">with</span> async_engine<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> conn<span class="token punctuation">:</span>
        result <span class="token operator">=</span> <span class="token keyword">await</span> conn<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">"SELECT * FROM users"</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> result<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span>

asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>fetch_users<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
    <hr/>
    <h3>
     <a id="_109">
     </a>
     实战案例
    </h3>
    <h4>
     <a id="1__111">
     </a>
     1. 电商系统的分表分库实现
    </h4>
    <p>
     使用ShardedSession实现用户表水平分片：
    </p>
    <pre><code class="prism language-python"><span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>ext<span class="token punctuation">.</span>horizontal_shard <span class="token keyword">import</span> ShardedSession

shards <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'shard1'</span><span class="token punctuation">:</span> create_engine<span class="token punctuation">(</span><span class="token string">'sqlite:///./shard1.db'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">'shard2'</span><span class="token punctuation">:</span> create_engine<span class="token punctuation">(</span><span class="token string">'sqlite:///./shard2.db'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">def</span> <span class="token function">shard_chooser</span><span class="token punctuation">(</span>mapper<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> clause<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> instance<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">"shard%d"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>instance<span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">'shard1'</span>

session <span class="token operator">=</span> ShardedSession<span class="token punctuation">(</span>
    shards<span class="token operator">=</span>shards<span class="token punctuation">,</span>
    shard_chooser<span class="token operator">=</span>shard_chooser<span class="token punctuation">,</span>
    id_chooser<span class="token operator">=</span><span class="token keyword">lambda</span> <span class="token operator">*</span>args<span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">(</span>shards<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token comment"># 自动路由到对应分片</span>
user <span class="token operator">=</span> User<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">101</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"Alice"</span><span class="token punctuation">)</span>
session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>user<span class="token punctuation">)</span>  <span class="token comment"># 自动路由到shard2</span>
</code></pre>
    <h4>
     <a id="2__139">
     </a>
     2. 版本控制与审计日志实现
    </h4>
    <p>
     通过事件监听实现变更追踪：
    </p>
    <pre><code class="prism language-python"><span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> inspect

audit_logs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token decorator annotation punctuation">@event<span class="token punctuation">.</span>listens_for</span><span class="token punctuation">(</span>Session<span class="token punctuation">,</span> <span class="token string">'before_flush'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">track_changes</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span> context<span class="token punctuation">,</span> instances<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> obj <span class="token keyword">in</span> session<span class="token punctuation">.</span>dirty<span class="token punctuation">:</span>
        state <span class="token operator">=</span> inspect<span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
        <span class="token keyword">for</span> attr <span class="token keyword">in</span> state<span class="token punctuation">.</span>attrs<span class="token punctuation">:</span>
            hist <span class="token operator">=</span> attr<span class="token punctuation">.</span>load_history<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> hist<span class="token punctuation">.</span>has_changes<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                audit_logs<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
                    <span class="token string">'object'</span><span class="token punctuation">:</span> obj<span class="token punctuation">,</span>
                    <span class="token string">'attribute'</span><span class="token punctuation">:</span> attr<span class="token punctuation">.</span>key<span class="token punctuation">,</span>
                    <span class="token string">'old'</span><span class="token punctuation">:</span> hist<span class="token punctuation">.</span>deleted<span class="token punctuation">,</span>
                    <span class="token string">'new'</span><span class="token punctuation">:</span> hist<span class="token punctuation">.</span>added
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
    <hr/>
    <h3>
     <a id="_164">
     </a>
     扩展思考
    </h3>
    <h4>
     <a id="1__166">
     </a>
     1. 多租户架构的数据库隔离方案
    </h4>
    <p>
     三种常见实现方式：
    </p>
    <pre><code class="prism language-python"><span class="token comment"># 方案1：schema隔离</span>
<span class="token keyword">class</span> <span class="token class-name">TenantSpecificQuery</span><span class="token punctuation">(</span>Query<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ident<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>filter_by<span class="token punctuation">(</span>tenant_id<span class="token operator">=</span>current_tenant<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span>ident<span class="token punctuation">)</span>

<span class="token comment"># 方案2：行级隔离</span>
<span class="token keyword">class</span> <span class="token class-name">BaseModel</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __abstract__ <span class="token operator">=</span> <span class="token boolean">True</span>
    tenant_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

<span class="token comment"># 方案3：动态schema切换</span>
<span class="token decorator annotation punctuation">@event<span class="token punctuation">.</span>listens_for</span><span class="token punctuation">(</span>Pool<span class="token punctuation">,</span> <span class="token string">'connect'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">connect</span><span class="token punctuation">(</span>dbapi_con<span class="token punctuation">,</span> record<span class="token punctuation">)</span><span class="token punctuation">:</span>
    dbapi_con<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"SET search_path TO tenant_</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>current_tenant<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</code></pre>
    <h4>
     <a id="2_SQLORM_185">
     </a>
     2. SQL注入防御的ORM层实践
    </h4>
    <p>
     安全操作示例：
    </p>
    <pre><code class="prism language-python"><span class="token comment"># 错误方式（存在注入风险）</span>
query <span class="token operator">=</span> User<span class="token punctuation">.</span>query<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"username = '</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>input_username<span class="token punctuation">}</span></span><span class="token string">'"</span></span><span class="token punctuation">)</span>

<span class="token comment"># 正确方式</span>
query <span class="token operator">=</span> User<span class="token punctuation">.</span>query<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>User<span class="token punctuation">.</span>username <span class="token operator">==</span> input_username<span class="token punctuation">)</span>

<span class="token comment"># 动态查询安全构造</span>
<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> text
stmt <span class="token operator">=</span> text<span class="token punctuation">(</span><span class="token string">"SELECT * FROM users WHERE username = :username"</span><span class="token punctuation">)</span>
session<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>stmt<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token string">"username"</span><span class="token punctuation">:</span> input_username<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
    <hr/>
    <h3>
     <a id="_202">
     </a>
     完整代码示例
    </h3>
    <p>
     包含分表分库、审计日志、异步操作的完整电商系统示例：
    </p>
    <pre><code class="prism language-python"><span class="token comment"># 安装依赖</span>
<span class="token comment"># pip install sqlalchemy aiosqlite</span>

<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> Column<span class="token punctuation">,</span> Integer<span class="token punctuation">,</span> String<span class="token punctuation">,</span> Float<span class="token punctuation">,</span> select
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>ext<span class="token punctuation">.</span>asyncio <span class="token keyword">import</span> create_async_engine<span class="token punctuation">,</span> AsyncSession
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>ext<span class="token punctuation">.</span>declarative <span class="token keyword">import</span> declarative_base
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> sessionmaker
<span class="token keyword">import</span> asyncio

<span class="token comment"># 定义模型</span>
Base <span class="token operator">=</span> declarative_base<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Product</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'products'</span>
    <span class="token builtin">id</span> <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    name <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    price <span class="token operator">=</span> Column<span class="token punctuation">(</span>Float<span class="token punctuation">)</span>
    shard_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

<span class="token comment"># 创建异步引擎</span>
engines <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'shard1'</span><span class="token punctuation">:</span> create_async_engine<span class="token punctuation">(</span><span class="token string">'sqlite+aiosqlite:///./shard1.db'</span><span class="token punctuation">,</span> echo<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">'shard2'</span><span class="token punctuation">:</span> create_async_engine<span class="token punctuation">(</span><span class="token string">'sqlite+aiosqlite:///./shard2.db'</span><span class="token punctuation">,</span> echo<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment"># 创建异步会话工厂</span>
async_sessions <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    shard_id<span class="token punctuation">:</span> sessionmaker<span class="token punctuation">(</span>
        bind<span class="token operator">=</span>engine<span class="token punctuation">,</span>
        class_<span class="token operator">=</span>AsyncSession<span class="token punctuation">,</span>
        expire_on_commit<span class="token operator">=</span><span class="token boolean">False</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">for</span> shard_id<span class="token punctuation">,</span> engine <span class="token keyword">in</span> engines<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment"># 根据 shard_id 选择分片</span>
<span class="token keyword">def</span> <span class="token function">get_shard_id</span><span class="token punctuation">(</span>shard_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f'shard</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>shard_id <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">'</span></span>

<span class="token comment"># 异步操作示例</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 创建表</span>
    <span class="token keyword">for</span> engine <span class="token keyword">in</span> engines<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">async</span> <span class="token keyword">with</span> engine<span class="token punctuation">.</span>begin<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> conn<span class="token punctuation">:</span>
            <span class="token keyword">await</span> conn<span class="token punctuation">.</span>run_sync<span class="token punctuation">(</span>Base<span class="token punctuation">.</span>metadata<span class="token punctuation">.</span>create_all<span class="token punctuation">)</span>
    
    <span class="token comment"># 插入数据</span>
    product <span class="token operator">=</span> Product<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"Laptop"</span><span class="token punctuation">,</span> price<span class="token operator">=</span><span class="token number">999.99</span><span class="token punctuation">,</span> shard_id<span class="token operator">=</span><span class="token number">101</span><span class="token punctuation">)</span>
    shard_id <span class="token operator">=</span> get_shard_id<span class="token punctuation">(</span>product<span class="token punctuation">.</span>shard_id<span class="token punctuation">)</span>
    
    <span class="token keyword">async</span> <span class="token keyword">with</span> async_sessions<span class="token punctuation">[</span>shard_id<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> session<span class="token punctuation">:</span>
        session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>product<span class="token punctuation">)</span>
        <span class="token keyword">await</span> session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"产品已添加到 </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>shard_id<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>


    <span class="token comment"># 插入数据</span>
    product <span class="token operator">=</span> Product<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"手机"</span><span class="token punctuation">,</span> price<span class="token operator">=</span><span class="token number">10000</span><span class="token punctuation">,</span> shard_id<span class="token operator">=</span><span class="token number">102</span><span class="token punctuation">)</span>
    shard_id <span class="token operator">=</span> get_shard_id<span class="token punctuation">(</span>product<span class="token punctuation">.</span>shard_id<span class="token punctuation">)</span>
    
    <span class="token keyword">async</span> <span class="token keyword">with</span> async_sessions<span class="token punctuation">[</span>shard_id<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> session<span class="token punctuation">:</span>
        session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>product<span class="token punctuation">)</span>
        <span class="token keyword">await</span> session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"产品已添加到 </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>shard_id<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>


    
    <span class="token comment"># 查询所有分片的数据</span>
    all_products <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> shard_id<span class="token punctuation">,</span> session_factory <span class="token keyword">in</span> async_sessions<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">async</span> <span class="token keyword">with</span> session_factory<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> session<span class="token punctuation">:</span>
            result <span class="token operator">=</span> <span class="token keyword">await</span> session<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>select<span class="token punctuation">(</span>Product<span class="token punctuation">)</span><span class="token punctuation">)</span>
            products <span class="token operator">=</span> result<span class="token punctuation">.</span>scalars<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            all_products<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>products<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"从 </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>shard_id<span class="token punctuation">}</span></span><span class="token string"> 查询到 </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">len</span><span class="token punctuation">(</span>products<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> 个产品"</span></span><span class="token punctuation">)</span>
    
    <span class="token comment"># 显示所有产品</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\n所有产品:"</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> product <span class="token keyword">in</span> all_products<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"产品: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>product<span class="token punctuation">.</span>name<span class="token punctuation">}</span></span><span class="token string">, 价格: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>product<span class="token punctuation">.</span>price<span class="token punctuation">}</span></span><span class="token string">, 分片ID: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>product<span class="token punctuation">.</span>shard_id<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

<span class="token comment"># 运行异步主函数</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     <strong>
      输出:
     </strong>
    </p>
    <pre><code class="prism language-bash">d:<span class="token punctuation">\</span>python_projects<span class="token punctuation">\</span>jupyter_demo<span class="token punctuation">\</span>sqlalchemy_demo.py:11: MovedIn20Warning: The `<span class="token variable"><span class="token variable">`</span>declarative_base<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token variable">`</span></span>` <span class="token keyword">function</span> is now available as sqlalchemy.orm.declarative_base<span class="token punctuation">(</span><span class="token punctuation">)</span>. <span class="token punctuation">(</span>deprecated since: <span class="token number">2.0</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>Background on SQLAlchemy <span class="token number">2.0</span> at: https://sqlalche.me/e/b8d9<span class="token punctuation">)</span>
  Base <span class="token operator">=</span> declarative_base<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">2025</span>-03-09 <span class="token number">19</span>:50:49,625 INFO sqlalchemy.engine.Engine BEGIN <span class="token punctuation">(</span>implicit<span class="token punctuation">)</span>
<span class="token number">2025</span>-03-09 <span class="token number">19</span>:50:49,626 INFO sqlalchemy.engine.Engine PRAGMA main.table_info<span class="token punctuation">(</span><span class="token string">"products"</span><span class="token punctuation">)</span>    
<span class="token number">2025</span>-03-09 <span class="token number">19</span>:50:49,626 INFO sqlalchemy.engine.Engine <span class="token punctuation">[</span>raw sql<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">2025</span>-03-09 <span class="token number">19</span>:50:49,627 INFO sqlalchemy.engine.Engine PRAGMA temp.table_info<span class="token punctuation">(</span><span class="token string">"products"</span><span class="token punctuation">)</span>    
<span class="token number">2025</span>-03-09 <span class="token number">19</span>:50:49,627 INFO sqlalchemy.engine.Engine <span class="token punctuation">[</span>raw sql<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">2025</span>-03-09 <span class="token number">19</span>:50:49,628 INFO sqlalchemy.engine.Engine
CREATE TABLE products <span class="token punctuation">(</span>
        <span class="token function">id</span> INTEGER NOT NULL,
        name VARCHAR<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span>,
        price FLOAT,
        shard_id INTEGER NOT NULL,
        PRIMARY KEY <span class="token punctuation">(</span>id<span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token number">2025</span>-03-09 <span class="token number">19</span>:50:49,629 INFO sqlalchemy.engine.Engine <span class="token punctuation">[</span>no key <span class="token number">0</span>.00072s<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">2025</span>-03-09 <span class="token number">19</span>:50:49,636 INFO sqlalchemy.engine.Engine COMMIT
<span class="token number">2025</span>-03-09 <span class="token number">19</span>:50:49,638 INFO sqlalchemy.engine.Engine BEGIN <span class="token punctuation">(</span>implicit<span class="token punctuation">)</span>
<span class="token number">2025</span>-03-09 <span class="token number">19</span>:50:49,639 INFO sqlalchemy.engine.Engine PRAGMA main.table_info<span class="token punctuation">(</span><span class="token string">"products"</span><span class="token punctuation">)</span>    
<span class="token number">2025</span>-03-09 <span class="token number">19</span>:50:49,639 INFO sqlalchemy.engine.Engine <span class="token punctuation">[</span>raw sql<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">2025</span>-03-09 <span class="token number">19</span>:50:49,640 INFO sqlalchemy.engine.Engine PRAGMA temp.table_info<span class="token punctuation">(</span><span class="token string">"products"</span><span class="token punctuation">)</span>
<span class="token number">2025</span>-03-09 <span class="token number">19</span>:50:49,640 INFO sqlalchemy.engine.Engine <span class="token punctuation">[</span>raw sql<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">2025</span>-03-09 <span class="token number">19</span>:50:49,641 INFO sqlalchemy.engine.Engine
CREATE TABLE products <span class="token punctuation">(</span>
        <span class="token function">id</span> INTEGER NOT NULL,
        name VARCHAR<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span>,
        price FLOAT,
        shard_id INTEGER NOT NULL,
        PRIMARY KEY <span class="token punctuation">(</span>id<span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token number">2025</span>-03-09 <span class="token number">19</span>:50:49,642 INFO sqlalchemy.engine.Engine <span class="token punctuation">[</span>no key <span class="token number">0</span>.00067s<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">2025</span>-03-09 <span class="token number">19</span>:50:49,647 INFO sqlalchemy.engine.Engine COMMIT
<span class="token number">2025</span>-03-09 <span class="token number">19</span>:50:49,649 INFO sqlalchemy.engine.Engine BEGIN <span class="token punctuation">(</span>implicit<span class="token punctuation">)</span>
<span class="token number">2025</span>-03-09 <span class="token number">19</span>:50:49,650 INFO sqlalchemy.engine.Engine INSERT INTO products <span class="token punctuation">(</span>name, price, shard_id<span class="token punctuation">)</span> VALUES <span class="token punctuation">(</span>?, ?, ?<span class="token punctuation">)</span>
<span class="token number">2025</span>-03-09 <span class="token number">19</span>:50:49,650 INFO sqlalchemy.engine.Engine <span class="token punctuation">[</span>generated <span class="token keyword">in</span> <span class="token number">0</span>.00035s<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token string">'Laptop'</span>, <span class="token number">999.99</span>, <span class="token number">101</span><span class="token punctuation">)</span>
<span class="token number">2025</span>-03-09 <span class="token number">19</span>:50:49,652 INFO sqlalchemy.engine.Engine COMMIT
产品已添加到 shard2
<span class="token number">2025</span>-03-09 <span class="token number">19</span>:50:49,657 INFO sqlalchemy.engine.Engine BEGIN <span class="token punctuation">(</span>implicit<span class="token punctuation">)</span>
<span class="token number">2025</span>-03-09 <span class="token number">19</span>:50:49,658 INFO sqlalchemy.engine.Engine INSERT INTO products <span class="token punctuation">(</span>name, price, shard_id<span class="token punctuation">)</span> VALUES <span class="token punctuation">(</span>?, ?, ?<span class="token punctuation">)</span>
<span class="token number">2025</span>-03-09 <span class="token number">19</span>:50:49,659 INFO sqlalchemy.engine.Engine <span class="token punctuation">[</span>generated <span class="token keyword">in</span> <span class="token number">0</span>.00077s<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token string">'手机'</span>, <span class="token number">10000.0</span>, <span class="token number">102</span><span class="token punctuation">)</span>
<span class="token number">2025</span>-03-09 <span class="token number">19</span>:50:49,661 INFO sqlalchemy.engine.Engine COMMIT
产品已添加到 shard1
<span class="token number">2025</span>-03-09 <span class="token number">19</span>:50:49,665 INFO sqlalchemy.engine.Engine BEGIN <span class="token punctuation">(</span>implicit<span class="token punctuation">)</span>
<span class="token number">2025</span>-03-09 <span class="token number">19</span>:50:49,666 INFO sqlalchemy.engine.Engine SELECT products.id, products.name, products.price, products.shard_id
FROM products
<span class="token number">2025</span>-03-09 <span class="token number">19</span>:50:49,665 INFO sqlalchemy.engine.Engine BEGIN <span class="token punctuation">(</span>implicit<span class="token punctuation">)</span>
<span class="token number">2025</span>-03-09 <span class="token number">19</span>:50:49,666 INFO sqlalchemy.engine.Engine SELECT products.id, products.name, products.price, products.shard_id
FROM products
<span class="token number">2025</span>-03-09 <span class="token number">19</span>:50:49,666 INFO sqlalchemy.engine.Engine SELECT products.id, products.name, products.price, products.shard_id
FROM products
ducts.price, products.shard_id
FROM products
<span class="token number">2025</span>-03-09 <span class="token number">19</span>:50:49,667 INFO sqlalchemy.engine.Engine <span class="token punctuation">[</span>generated <span class="token keyword">in</span> <span class="token number">0</span>.00054s<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
从 shard1 查询到 <span class="token number">1</span> 个产品
<span class="token number">2025</span>-03-09 <span class="token number">19</span>:50:49,668 INFO sqlalchemy.engine.Engine ROLLBACK
FROM products
<span class="token number">2025</span>-03-09 <span class="token number">19</span>:50:49,667 INFO sqlalchemy.engine.Engine <span class="token punctuation">[</span>generated <span class="token keyword">in</span> <span class="token number">0</span>.00054s<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
从 shard1 查询到 <span class="token number">1</span> 个产品
<span class="token number">2025</span>-03-09 <span class="token number">19</span>:50:49,668 INFO sqlalchemy.engine.Engine ROLLBACK
<span class="token number">2025</span>-03-09 <span class="token number">19</span>:50:49,667 INFO sqlalchemy.engine.Engine <span class="token punctuation">[</span>generated <span class="token keyword">in</span> <span class="token number">0</span>.00054s<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
从 shard1 查询到 <span class="token number">1</span> 个产品
<span class="token number">2025</span>-03-09 <span class="token number">19</span>:50:49,668 INFO sqlalchemy.engine.Engine ROLLBACK
<span class="token number">2025</span>-03-09 <span class="token number">19</span>:50:49,669 INFO sqlalchemy.engine.Engine BEGIN <span class="token punctuation">(</span>implicit<span class="token punctuation">)</span>
<span class="token number">2025</span>-03-09 <span class="token number">19</span>:50:49,669 INFO sqlalchemy.engine.Engine SELECT products.id, products.name, pro从 shard1 查询到 <span class="token number">1</span> 个产品
<span class="token number">2025</span>-03-09 <span class="token number">19</span>:50:49,668 INFO sqlalchemy.engine.Engine ROLLBACK
<span class="token number">2025</span>-03-09 <span class="token number">19</span>:50:49,669 INFO sqlalchemy.engine.Engine BEGIN <span class="token punctuation">(</span>implicit<span class="token punctuation">)</span>
<span class="token number">2025</span>-03-09 <span class="token number">19</span>:50:49,669 INFO sqlalchemy.engine.Engine SELECT products.id, products.name, products.price, products.shard_id
<span class="token number">2025</span>-03-09 <span class="token number">19</span>:50:49,669 INFO sqlalchemy.engine.Engine BEGIN <span class="token punctuation">(</span>implicit<span class="token punctuation">)</span>
<span class="token number">2025</span>-03-09 <span class="token number">19</span>:50:49,669 INFO sqlalchemy.engine.Engine SELECT products.id, products.name, products.price, products.shard_id
<span class="token number">2025</span>-03-09 <span class="token number">19</span>:50:49,669 INFO sqlalchemy.engine.Engine SELECT products.id, products.name, products.price, products.shard_id
FROM products
<span class="token number">2025</span>-03-09 <span class="token number">19</span>:50:49,670 INFO sqlalchemy.engine.Engine <span class="token punctuation">[</span>generated <span class="token keyword">in</span> <span class="token number">0</span>.00029s<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
从 shard2 查询到 <span class="token number">1</span> 个产品
ducts.price, products.shard_id
FROM products
<span class="token number">2025</span>-03-09 <span class="token number">19</span>:50:49,670 INFO sqlalchemy.engine.Engine <span class="token punctuation">[</span>generated <span class="token keyword">in</span> <span class="token number">0</span>.00029s<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
从 shard2 查询到 <span class="token number">1</span> 个产品
<span class="token number">2025</span>-03-09 <span class="token number">19</span>:50:49,671 INFO sqlalchemy.engine.Engine ROLLBACK
FROM products
<span class="token number">2025</span>-03-09 <span class="token number">19</span>:50:49,670 INFO sqlalchemy.engine.Engine <span class="token punctuation">[</span>generated <span class="token keyword">in</span> <span class="token number">0</span>.00029s<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
从 shard2 查询到 <span class="token number">1</span> 个产品
<span class="token number">2025</span>-03-09 <span class="token number">19</span>:50:49,671 INFO sqlalchemy.engine.Engine ROLLBACK
从 shard2 查询到 <span class="token number">1</span> 个产品
<span class="token number">2025</span>-03-09 <span class="token number">19</span>:50:49,671 INFO sqlalchemy.engine.Engine ROLLBACK
<span class="token number">2025</span>-03-09 <span class="token number">19</span>:50:49,671 INFO sqlalchemy.engine.Engine ROLLBACK
所有产品:
产品: 手机, 价格: <span class="token number">10000.0</span>, 分片ID: <span class="token number">102</span>
所有产品:
产品: 手机, 价格: <span class="token number">10000.0</span>, 分片ID: <span class="token number">102</span>
产品: Laptop, 价格: <span class="token number">999.99</span>, 分片ID: <span class="token number">101</span>
产品: 手机, 价格: <span class="token number">10000.0</span>, 分片ID: <span class="token number">102</span>
产品: Laptop, 价格: <span class="token number">999.99</span>, 分片ID: <span class="token number">101</span>
产品: Laptop, 价格: <span class="token number">999.99</span>, 分片ID: <span class="token number">101</span>
</code></pre>
    <hr/>
    <p>
     通过本章学习，您应该能够：
    </p>
    <ol>
     <li>
      熟练使用SQLAlchemy事件系统管理会话生命周期
     </li>
     <li>
      实现复杂的继承映射策略
     </li>
     <li>
      处理大规模数据操作的性能优化
     </li>
     <li>
      构建高并发的异步数据库应用
     </li>
     <li>
      设计企业级的数据库架构方案
     </li>
    </ol>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="6874747073:3a2f2f626c6f672e6373646e2e6e65742f7977656e6731382f:61727469636c652f64657461696c732f313436313337353431" class_="artid" style="display:none">
 </p>
</div>


