---
layout: post
title: "树莓派-gpio-串口通信"
date: 2020-01-29 14:50:14 +0800
description: "使用树莓派 3B+/4B 测试 gpio，配置硬件串口，测试串口通信等。这里的板子上40pin引脚有"
keywords: "树莓派串口"
categories: ['树莓派', 'Python', 'C']
tags: ['树莓派', '嵌入式', '串口通信']
artid: "103702563"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=103702563
    alt: "树莓派-gpio-串口通信"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=103702563
featuredImagePreview: https://bing.ee123.net/img/rand?artid=103702563
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     树莓派 gpio / 串口通信
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     使用树莓派 3B+/4B 测试 gpio，配置硬件串口，测试串口通信。
    </p>
    <p>
     树莓派4B安装Debian 12（bookworm）和树莓派5B的配置差异可以跳转参看
     <a href="https://wanggao1990.blog.csdn.net/article/details/137538616" rel="nofollow">
      【树莓派4B、树莓派5使用 Debian 12（bookworm） 的配置
      <br/>
      】
     </a>
    </p>
    <p>
    </p>
    <div class="toc">
     <h4>
      文章目录
     </h4>
     <ul>
      <li>
       <a href="#1GPIODB9_8" rel="nofollow">
        1、GPIO扩展口定义、DB9接口定义
       </a>
      </li>
      <li>
       <a href="#2_19" rel="nofollow">
        2、串口设置
       </a>
      </li>
      <li>
       <ul>
        <li>
         <a href="#21%09GPIO_35" rel="nofollow">
          2.1 开启GPIO串口功能，并使用硬件串口
         </a>
        </li>
        <li>
         <a href="#22__52" rel="nofollow">
          2.2 禁用串口的控制台功能
         </a>
        </li>
        <li>
         <a href="#23__61" rel="nofollow">
          2.3 测试验证串口通信功能
         </a>
        </li>
        <li>
         <ul>
          <li>
           <a href="#231_c_69" rel="nofollow">
            2.3.1 c语言实现
           </a>
          </li>
          <li>
           <a href="#232_python_97" rel="nofollow">
            2.3.2 python实现
           </a>
          </li>
          <li>
           <a href="#233__minicom_127" rel="nofollow">
            2.3.3 minicom命令函实现
           </a>
          </li>
         </ul>
        </li>
        <li>
         <a href="#24_wiringPic_139" rel="nofollow">
          2.4 wiringPi库c语言完整串口通信代码
         </a>
        </li>
       </ul>
      </li>
      <li>
       <a href="#3GPIO__212" rel="nofollow">
        3、GPIO 编程
       </a>
      </li>
      <li>
       <ul>
        <li>
         <a href="#31_gpio_217" rel="nofollow">
          3.1 gpio命令行
         </a>
        </li>
        <li>
         <a href="#32__Python__RPiGPIO_230" rel="nofollow">
          3.2 Python 库 RPi.GPIO编程
         </a>
        </li>
        <li>
         <a href="#33__ccwiringPI_258" rel="nofollow">
          3.3 c/c++使用wiringPI库
         </a>
        </li>
       </ul>
      </li>
     </ul>
    </div>
    <p>
    </p>
    <h2>
     <a id="1GPIODB9_8">
     </a>
     1、GPIO扩展口定义、DB9接口定义
    </h2>
    <p>
     这里的板子上40pin引脚有3中编码方式：
     <br/>
     1、Board编码：对应实际的物理插槽
     <br/>
     2、BCM编码：基本和GPIO的名字对应
     <br/>
     2、wiringPi编码：wiringPi库使用的引脚编码方式
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/041e9c523a254acf4fc5b9dfe06bb502.png">
      <br/>
      DB9公头接口定义
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/9587e4962f9a2c88091903f4fb302624.png"/>
     </img>
    </p>
    <p>
     在进行串口通信，两个设备间进行双向通信时，
     <strong>
      两个设备的RXD、TXD要交错连接
     </strong>
     。
    </p>
    <h2>
     <a id="2_19">
     </a>
     2、串口设置
    </h2>
    <p>
     树莓派包含两个串口（树莓派3及以前版本）
     <br/>
     1.
     <strong>
      硬件串口
     </strong>
     （
     <font color="#ff00">
      <strong>
       /dev/ttyAMA0
      </strong>
     </font>
     ）,硬件串口由硬件实现，有单独的波特率时钟源，性能高，可靠。一般优先选择这个使用。
     <br/>
     2.
     <strong>
      mini串口
     </strong>
     （
     <font color="#ff00">
      <strong>
       /dev/ttyS0
      </strong>
     </font>
     ），mini串口时钟源是由CPU内核时钟提供，波特率受到内核时钟的影响，不稳定。
    </p>
    <blockquote>
     <p>
      树莓派3及以前版本仅2个串口，4和400有4个串口，cm系列有6个串口，详见
      <a href="https://www.raspberrypi.com/documentation/computers/configuration.html#configuring-uarts" rel="nofollow">
       树莓派官网Configuring UARTs
      </a>
      ）
      <br/>
      <br/>
      树莓派4开启 ttyAMA1，可以直接配置 dtoverlay=uart2 即可（其他 ttyAMA2 -&gt; uart3, ttyAMA3 -&gt; uart4, ttyAMA4 -&gt; uart5，具体引脚配置可以通过 dtoverlay -h uartN 查看）。
      <br/>
      <br/>
      <font color="red">
       注意 CM4 使用双相机的dtb配置（
       <a href="https://blog.csdn.net/wanggao_1990/article/details/121398020">
        树莓派计算模块CM4 eMMC系统烧写、配置、相机连接
       </a>
       ）时，ttyAMA1会失效
      </font>
      。
     </p>
    </blockquote>
    <p>
     想要通过树莓派的GPIO引脚进行稳定的串口通信，需要修改串口的映射关系。
     <br/>
     serial0是GPIO引脚对应的串口，serial1是蓝牙对应的串口，默认未启用serial0。使用
     <code>
      ls -l /dev/serial*
     </code>
     查看当前的映射关系：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/9a9eae004b8429118aee469ecacff705.png">
      <br/>
      可以看到这里是，蓝牙串口serial1使用硬件串口ttyAMA0。
     </img>
    </p>
    <h3>
     <a id="21%09GPIO_35">
     </a>
     2.1 开启GPIO串口功能，并使用硬件串口
    </h3>
    <p>
     使用
     <code>
      sudo raspi-config
     </code>
     进入图形界面
     <br/>
     选择菜单 Interfacing Options -&gt; P6 Serial,
     <br/>
     第一个选项（would you like a login shell to be accessible over serial?）选择 NO，
     <br/>
     第二个选项（would you like the serial port hardware to be enabled?）选择 YES
    </p>
    <p>
     保存后重启，查看映射关系
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/0d13b91a122f3cc5099298006de6f042.png">
      <br/>
      比之前多了一个gpio的串口serial0，并且使用的ttyS0。
      <font color="#ff00">
       这里已经是开启了GPIO串口功能，但是使用的cpu实现的软件串口
      </font>
      。
     </img>
    </p>
    <p>
     <strong>
      如果想使用稳定可靠的硬件串口，就要将树莓派3b+的硬件串口与mini串口默认映射对换
     </strong>
     （先禁用蓝牙
     <code>
      sudo systemctl disable hciuart
     </code>
     ）。
    </p>
    <p>
     在/boot/config.txt文件末尾添加一行代码
     <code>
      dtoverlay=pi3-miniuart-bt
     </code>
     （树莓派4B也使用这个命令）。 还可以直接配置禁用bluetooth，代码为
     <code>
      dtoverlay=disable-bt
     </code>
     ，见参考链接
     <a href="https://blog.csdn.net/wanggao_1990/article/details/114927334">
      【树莓派 功能配置（含网络）不定期更新】
     </a>
     。
    </p>
    <p>
     保存后重启再查看设备对用关系，发现已经调换成功。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/bd1579e92c18cc7c66de601d5955c2b0.png"/>
    </p>
    <h3>
     <a id="22__52">
     </a>
     2.2 禁用串口的控制台功能
    </h3>
    <p>
     前面步骤已经交换了硬件串口与mini串口的映射关系，但是，现在还不能使用树莓派串口模块与电脑进行通信，因为，树莓派gpio口引出串口默认是用来做控制台使用的，即是为了用串口控制树莓派，而不是通信。所以我们要禁用此默认设置。
     <br/>
     首先执行命令如下：
     <br/>
     <code>
      sudo systemctl stop serial-getty@ttyAMA0.service
     </code>
     <br/>
     <code>
      sudo systemctl disable serial-getty@ttyAMA0.service
     </code>
     <br/>
     然后执行命令行修改文件：
     <br/>
     <code>
      sudo nano /boot/cmdline.txt
     </code>
     <br/>
     并删除语句
     <code>
      console=serial0,115200
     </code>
     （没有的话就不需要此步骤）
    </p>
    <h3>
     <a id="23__61">
     </a>
     2.3 测试验证串口通信功能
    </h3>
    <p>
     这里使用三种方式进行测试验证， c语言下使用wiringPi库， python语言下使用serial包，最后命令行使用minicom工具。
     <br/>
     先安装以上开发工具
     <br/>
     <code>
      sudo apt-get install wiringpi
     </code>
     <br/>
     <code>
      sudo apt-get install python-serial
     </code>
     <br/>
     <code>
      sudo apt-get install minicom
     </code>
    </p>
    <p>
     将usb转ttl模块引脚的GND、TX、RX分别与树莓派的GND、RX、TX连接；电脑端启用串口调试助手，波特率设置一致。
    </p>
    <h4>
     <a id="231_c_69">
     </a>
     2.3.1 c语言实现
    </h4>
    <p>
     编写test.c测试代码，
    </p>
    <pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;wiringPi.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;wiringSerial.h&gt;</span></span>
  
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> fd<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">wiringPiSetup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//if((fd=serialOpen("/dev/ttyS0",115200))&lt;0) { // gpio 使用mini串口</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>fd<span class="token operator">=</span><span class="token function">serialOpen</span><span class="token punctuation">(</span><span class="token string">"/dev/ttyAMA0"</span><span class="token punctuation">,</span><span class="token number">115200</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// gpio 使用硬件串口</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"serial test output ...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">serialPrintf</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span><span class="token string">"1234567890abcdef"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token function">serialClose</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     编译
     <code>
      gcc test.c -o test -lwiringPi
     </code>
     ，运行
     <code>
      sudo ./test
     </code>
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/75cdabf6b48fdc47991fca59ee701caa.png">
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/80f4a74b1c0d5e93b5089937619df8e3.png"/>
     </img>
    </p>
    <h4>
     <a id="232_python_97">
     </a>
     2.3.2 python实现
    </h4>
    <pre><code class="prism language-python"><span class="token comment"># -*- coding: utf-8 -*</span>
<span class="token keyword">import</span> serial
<span class="token keyword">import</span> time

ser <span class="token operator">=</span> serial<span class="token punctuation">.</span>Serial<span class="token punctuation">(</span><span class="token string">"/dev/ttyAMA0"</span><span class="token punctuation">,</span><span class="token number">115200</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> <span class="token keyword">not</span> ser<span class="token punctuation">.</span>isOpen<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"open failed"</span><span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"open success: "</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>ser<span class="token punctuation">)</span>

<span class="token keyword">try</span><span class="token punctuation">:</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        count <span class="token operator">=</span> ser<span class="token punctuation">.</span>inWaiting<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
            recv <span class="token operator">=</span> ser<span class="token punctuation">.</span>read<span class="token punctuation">(</span>count<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"recv: "</span> <span class="token operator">+</span> recv<span class="token punctuation">)</span>
        	ser<span class="token punctuation">.</span>write<span class="token punctuation">(</span>recv<span class="token punctuation">)</span>
        sleep<span class="token punctuation">(</span><span class="token number">0.05</span><span class="token punctuation">)</span> 
<span class="token keyword">except</span> KeyboardInterrupt<span class="token punctuation">:</span>
    <span class="token keyword">if</span> ser <span class="token operator">!=</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        ser<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     运行python代码，并在串口调试助手中发送字符串，树莓派收到数据后打印、在回发给串口助手，截图如下。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/7e4fa390fccf1f10443e3f5826495f5e.png">
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/ba63f3a6a6fd5a75262cef73a7cd206a.png"/>
     </img>
    </p>
    <h4>
     <a id="233__minicom_127">
     </a>
     2.3.3 minicom命令函实现
    </h4>
    <p>
     使用
     <code>
      minicom -b 115200 -D /dev/ttyAMA0
     </code>
     进入串口调试界面，这里将一直等待接收，直到用户手动退出。退出时ctrl+A，再按键X退出。
     <br/>
     minicom调试界面默认是不显示用户输入，使用cttl+A，再按E即可开启（
     <strong>
      会捕获换行
     </strong>
     ）。
    </p>
    <p>
     串口助手和minicom界面的交互如下:
     <br/>
     串口助手发送“1234567890abcdef”，
     <br/>
     minicom发送"\n”，“1”，“\n”，“3”，“4”，“\n”
     <br/>
     串口助手发送“1234567890abcdef”，
    </p>
    <p>
     界面截图如下：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/6a982ae9a53bb43e008f648bdba922bb.png">
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/27391206d88f9f6ea3b2d2969b6a9858.png"/>
     </img>
    </p>
    <h3>
     <a id="24_wiringPic_139">
     </a>
     2.4 wiringPi库c语言完整串口通信代码
    </h3>
    <p>
     使用wiringPI库进行发送和持续接收的示例代码，如下
    </p>
    <pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;wiringPi.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;wiringSerial.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>

<span class="token keyword">int</span> running <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">sig_handle</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>sig <span class="token operator">==</span> SIGINT<span class="token punctuation">)</span>   running <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>    
    <span class="token function">signal</span><span class="token punctuation">(</span>SIGINT<span class="token punctuation">,</span> sig_handle<span class="token punctuation">)</span><span class="token punctuation">;</span>    

    <span class="token keyword">int</span> fd<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">wiringPiSetup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"wiringPi setup failed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">int</span> baudrate <span class="token operator">=</span> <span class="token number">115200</span><span class="token punctuation">;</span>

    <span class="token comment">//if((fd = serialOpen("/dev/ttyS0", baudrate)) &lt; 0){  </span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>fd <span class="token operator">=</span> <span class="token function">serialOpen</span><span class="token punctuation">(</span><span class="token string">"/dev/ttyAMA0"</span><span class="token punctuation">,</span>baudrate<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"serial open failed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"serial test output ...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token function">serialPrintf</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token string">"0123456789abcdef"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//发送</span>

    <span class="token keyword">while</span><span class="token punctuation">(</span>running<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
       <span class="token keyword">int</span> sz <span class="token operator">=</span> <span class="token function">serialDataAvail</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 等待介绍的数据个数</span>
       
       <span class="token keyword">if</span><span class="token punctuation">(</span>sz <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
       <span class="token punctuation">{<!-- --></span>
         <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"size %d, "</span><span class="token punctuation">,</span> sz<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">char</span> <span class="token operator">*</span>buff <span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span>sz<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"recv: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> sz<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
              <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token function">serialGetchar</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//接收一个字符</span>
              <span class="token comment">//if(c != -1)</span>
                  buff<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> c<span class="token punctuation">;</span>  
         <span class="token punctuation">}</span>
         <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> buff<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token function">free</span><span class="token punctuation">(</span>buff<span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token function">serialPrintf</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buff<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//回显</span>
       <span class="token punctuation">}</span>
       <span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
         <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">50000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 必要的延时50ms</span>
       <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">serialClose</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"close serial.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <blockquote>
     <p>
      tip:延时的作用：1、匹配串口读写速度，使得下一次读时，设备已经完成写操作; 2、减小资源占用;
      <br/>
      若不延时，CPU占用高，并且最多一次读取一个字符。
     </p>
    </blockquote>
    <h2>
     <a id="3GPIO__212">
     </a>
     3、GPIO 编程
    </h2>
    <p>
     这里演示BCM_gpio 22输出控制，串接一个220欧姆、led灯珠到GND，进行亮、灭灯控制。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/9ddf2d33058a43d3d34bd6512c6f6cdb.png"/>
     <br/>
     这里涉及引脚连线、编程中确定口线，需要熟悉引脚编码。先以gpio命令行工具说明编码、并进行测试，再使用python、c语言实现。
    </p>
    <h3>
     <a id="31_gpio_217">
     </a>
     3.1 gpio命令行
    </h3>
    <p>
     使用
     <code>
      gpio -v
     </code>
     查看版本
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/d7e5f35b715dde5a61066be2ca600025.png"/>
     <br/>
     使用
     <code>
      gpio readall
     </code>
     查看引脚编码
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/4547bafff0430bd044f232d014ce964c.png"/>
     <br/>
     <strong>
      这里我们选择的名称为"BCM_GPIO.22"，对应的是BCM编码"22"，wPi编码"3"，而实际的物理插槽BOARD编码是"15"。
     </strong>
     因此实际接线应该使用插槽编码为15的口线。
    </p>
    <p>
     gpio工具使用的是BCM编码。设置BCM_GPIO.22口为输出模式， 写”1”灯亮，写”0”灯灭。
    </p>
    <pre><code class="prism language-bash">gpio <span class="token parameter variable">-g</span> mode <span class="token number">22</span> out
gpio <span class="token parameter variable">-g</span> <span class="token function">write</span> <span class="token number">22</span> <span class="token number">1</span>
gpio <span class="token parameter variable">-g</span> <span class="token function">write</span> <span class="token number">22</span> <span class="token number">0</span>
</code></pre>
    <h3>
     <a id="32__Python__RPiGPIO_230">
     </a>
     3.2 Python 库 RPi.GPIO编程
    </h3>
    <p>
     这里的操作结果同上，使用RPi.GPIO库。若无该库，先进行安装
     <code>
      sudo pip install RPi.GPIO
     </code>
     <br/>
     先使用python idle进行简单控制
    </p>
    <pre><code class="prism language-py"><span class="token keyword">import</span> RPi<span class="token punctuation">.</span>GPIO <span class="token keyword">as</span> GPIO
GPIO<span class="token punctuation">.</span>setmode<span class="token punctuation">(</span>GPIO<span class="token punctuation">.</span>BCM<span class="token punctuation">)</span>   <span class="token comment">## 编号默认BCM</span>
GPIO<span class="token punctuation">.</span>setup<span class="token punctuation">(</span><span class="token number">22</span><span class="token punctuation">,</span> GPIO<span class="token punctuation">.</span>OUT<span class="token punctuation">)</span>
GPIO<span class="token punctuation">.</span>output<span class="token punctuation">(</span><span class="token number">22</span><span class="token punctuation">,</span> GPIO<span class="token punctuation">.</span>HIGH<span class="token punctuation">)</span>
GPIO<span class="token punctuation">.</span>output<span class="token punctuation">(</span><span class="token number">22</span><span class="token punctuation">,</span> LOW<span class="token punctuation">)</span>
GPIO<span class="token punctuation">.</span>output<span class="token punctuation">(</span><span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
GPIO<span class="token punctuation">.</span>output<span class="token punctuation">(</span><span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     在利用脚本让其间隔一秒钟亮灭
    </p>
    <pre><code class="prism language-py"><span class="token comment"># -*- coding: utf-8 -*-                 </span>
<span class="token keyword">import</span> RPi<span class="token punctuation">.</span>GPIO <span class="token keyword">as</span> GPIO               <span class="token comment">#引入RPi.GPIO库函数命名为GPIO</span>
<span class="token keyword">import</span> time                           <span class="token comment">#引入计时time函数</span>
<span class="token comment"># BOARD编号方式，基于插座引脚编号</span>
GPIO<span class="token punctuation">.</span>setmode<span class="token punctuation">(</span>GPIO<span class="token punctuation">.</span>BOARD<span class="token punctuation">)</span>              <span class="token comment">#将GPIO编程方式设置为BOARD模式</span>
<span class="token comment"># 输出模式</span>
GPIO<span class="token punctuation">.</span>setup<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span> GPIO<span class="token punctuation">.</span>OUT<span class="token punctuation">)</span>              <span class="token comment">#将Board 15引脚（BCM 22）设置为输出引脚</span>

<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>                            <span class="token comment">#条件为真，下面程序一直循环执行</span>
    GPIO<span class="token punctuation">.</span>output<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span> GPIO<span class="token punctuation">.</span>HIGH<span class="token punctuation">)</span>         <span class="token comment">#将15引脚电压置高，点亮LED灯</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>                      <span class="token comment">#延时1秒</span>
    GPIO<span class="token punctuation">.</span>output<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span> GPIO<span class="token punctuation">.</span>LOW<span class="token punctuation">)</span>          <span class="token comment">#将15引脚电压置低，熄灭LED灯</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>                      <span class="token comment">#延时1秒</span>
</code></pre>
    <h3>
     <a id="33__ccwiringPI_258">
     </a>
     3.3 c/c++使用wiringPI库
    </h3>
    <p>
     重复上面引用内容：
     <strong>
      这里我们选择的名称为"BCM_GPIO.22"，对应的是BCM编码"22"，wPi编码"3"，而实际的物理插槽BOARD编码是"15"。
     </strong>
    </p>
    <p>
     使用wiringPI库时，IO口为wPi编码，为保证和前面的实列对应相同，使用编号为
     <strong>
      3
     </strong>
     。
    </p>
    <p>
     编写以下test.c代码
     <br/>
     编译
     <code>
      gcc test.c -o test -lwiringPi
     </code>
     ，运行
     <code>
      ./test
     </code>
    </p>
    <pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;wiringPi.h&gt;</span></span>

<span class="token comment">// LED Pin - wiringPi pin 3 is BCM_GPIO 22.(pyscial 15)</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>  <span class="token macro-name">LED</span>  <span class="token expression"><span class="token number">3</span></span></span>

<span class="token keyword">int</span> <span class="token function">main</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">wiringPiSetup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"wiringPi setup failed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">pinMode</span><span class="token punctuation">(</span>LED<span class="token punctuation">,</span> OUTPUT<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 设置输出模式</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token function">digitalWrite</span><span class="token punctuation">(</span>LED<span class="token punctuation">,</span> HIGH<span class="token punctuation">)</span> <span class="token punctuation">;</span>	<span class="token comment">// On</span>
    <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>		        <span class="token comment">// mS</span>
    <span class="token function">digitalWrite</span><span class="token punctuation">(</span>LED<span class="token punctuation">,</span> LOW<span class="token punctuation">)</span> <span class="token punctuation">;</span>	<span class="token comment">// Off</span>
    <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token number">0</span> <span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c:6f672e6373646e2e6e65742f77616e6767616f5f313939302f:61727469636c652f64657461696c732f313033373032353633" class_="artid" style="display:none">
 </p>
</div>


