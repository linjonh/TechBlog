---
layout: post
title: "微信小程序开发-实现文件上传和下载"
date: 2024-12-28 16:08:17 +0800
description: "微信小程序实现文件上传下载_小程序下载文件"
keywords: "小程序下载文件"
categories: ['微信小程序开发']
tags: ['微信小程序', '小程序']
artid: "134476937"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=134476937
    alt: "微信小程序开发-实现文件上传和下载"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=134476937
featuredImagePreview: https://bing.ee123.net/img/rand?artid=134476937
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     微信小程序开发---实现文件上传和下载
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <blockquote>
     <p>
      在开发小程序的过程中，我们难免会遇到使用小程序对后端发送文件；或者接收后端的文件，本文章将手把手带你简单高效实现微信小程序的文件上传下载功能
     </p>
    </blockquote>
    <h3>
     <a id="_2">
     </a>
     前期准备
    </h3>
    <p>
     由于目前小程序保护用户个人隐私力度加大 ，因此我们要想实现文件上传，先要到
     <a href="https://mp.weixin.qq.com/" rel="nofollow">
      微信公众平台
     </a>
     申请权限，进入设置中的服务内容与声明
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/04a440279528c5206cf4436e83e40777.png"/>
    </p>
    <p>
     我们在点击更新用户隐私保护指引，在里面我们发现没有找到相应的文件选项，那我们就点击自定义，点击确认之后就会出现选项框供你选择，就按照我下面的填写并且提交之后等待审核通过就可以开发相应的文件上传下载接口
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/beaeb8c5c9627c77a2b7d83a88cb1958.png">
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/e0c2912f45eb6a609a27ba451577426f.png"/>
     </img>
    </p>
    <h3>
     <a id="_11">
     </a>
     文件上传
    </h3>
    <blockquote>
     <p>
      作者是使用HbuilderX进行开发，但是方法都是一致的，只需要按需更改调用主体就行（例如：wx;uni）
     </p>
    </blockquote>
    <p>
     首先是选择文件，微信小程序上传文件的机制是，先我们用户选取的文件创建一个零时的存放路径，等待我们点击上传的时候就可以直接将上传文件的零时路径携带在网络请求中给后端，此时后端就可以接收到文件，并且在发送文件的时候不是像之前一样使用uni.request（wx.request）而是需要使用formData格式的请求体使用专门的上传方法
    </p>
    <blockquote>
     <p>
      需要使用
      <code>
       uploadFile
      </code>
      方法上传文件，使用
      <code>
       formData
      </code>
      来存储我们的其他一些
      <code>
       JSON
      </code>
      格式的数据，比如要让后端知道这是什么文件，是第几个文件之类的信息
     </p>
    </blockquote>
    <pre><code class="prism language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uni-file-picker</span> <span class="token attr-name">@select</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>saveRelatePath<span class="token punctuation">"</span></span> <span class="token attr-name">limit</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span> <span class="token attr-name">file-mediatype</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>all<span class="token punctuation">"</span></span> <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>上传资料<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>uni-file-picker</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--@select方法是我们选取的文件之后，执行的方法，在我们选取文件之后需要将文件的零时路径进行保存 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>updata<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>primary<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>确认上传<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">export</span> <span class="token keyword">default</span><span class="token punctuation">{<!-- --></span>
	<span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>
			<span class="token literal-property property">filePath</span><span class="token operator">:</span><span class="token string">''</span><span class="token comment">//存放文件的临时目录</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token literal-property property">method</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span>
		<span class="token function">saveRelatePath</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>filePath <span class="token operator">=</span> path<span class="token punctuation">.</span>tempFilePaths<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token comment">//将文件的临时地址保存下来</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token function">updata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
			<span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span> <span class="token comment">//保存当前对象指针，用于获取到来刚刚保存的filePath</span>
			uni<span class="token punctuation">.</span><span class="token function">uploadFile</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
				<span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">'https://XXX.XXX.XX/XXX/'</span><span class="token punctuation">,</span> <span class="token comment">// 上传文件的服务器接口地址</span>
				<span class="token literal-property property">filePath</span><span class="token operator">:</span> _this<span class="token punctuation">.</span>filePath<span class="token punctuation">,</span> <span class="token comment">// 选择的文件的临时路径</span>
				<span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'file'</span><span class="token punctuation">,</span> <span class="token comment">// 服务器接收文件的字段名</span>
				<span class="token literal-property property">formData</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
					<span class="token comment">//放入JSON格式数据</span>
				<span class="token punctuation">}</span><span class="token punctuation">,</span>
				<span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token comment">//打印后端返回的数据</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre>
    <h3>
     <a id="_53">
     </a>
     文件下载
    </h3>
    <p>
     一般在开发的时候我们要下载文件一般就是小程序端向后端提供的指定URL接口发送我们要请求哪个文件，一般后端会告诉让你告诉他你要的文件是名字之类的信息。我们如果将这些信息放到请求体data里面无法正确请求文件信息，那么我们这时可能就需要将文件名拼接到之前的URL
    </p>
    <pre><code class="prism language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>download<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>下载 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">export</span> <span class="token keyword">default</span><span class="token punctuation">{<!-- --></span>
	<span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>
			fileName <span class="token operator">=</span> <span class="token string">'XXXXXX'</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token literal-property property">method</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span>
		<span class="token function">download</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
			<span class="token keyword">const</span> filePath <span class="token operator">=</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>wx<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">USER_DATA_PATH</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/test.xlsx</span><span class="token template-punctuation string">`</span></span><span class="token comment">//下载文件存储在当前微信的临时文件夹下，文件名为test，格式为xlsx</span>
				<span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span>
				uni<span class="token punctuation">.</span><span class="token function">downloadFile</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
					<span class="token comment">//1.将文件信息放在请求体中</span>
				    <span class="token comment">//url: 'https://XX/XX/XX' ,</span>
				    <span class="token comment">//data:{<!-- --></span>
				    <span class="token comment">//	fileName = _this.fileName//下载的文件名</span>
				    <span class="token comment">//},</span>
				    <span class="token comment">//2.将请求体拼接在URL上</span>
				    <span class="token comment">//注意有的可能使用斜杠 / 来进行分割有的时需要使用 ?name = "XXX"这种形式，一定要和后端确定号后端时用什么形式接收参数</span>
				    <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">'https://XX/XX/XX/'</span> <span class="token operator">+</span> _this<span class="token punctuation">.</span>fileName<span class="token punctuation">,</span>
				    
				    <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//文件下载成功使用getFileSystemManager管理文件</span>
						uni<span class="token punctuation">.</span><span class="token function">getFileSystemManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">saveFile</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token comment">//将文件保存到目前零时文件下</span>
				        <span class="token literal-property property">tempFilePath</span><span class="token operator">:</span> res<span class="token punctuation">.</span>tempFilePath<span class="token punctuation">,</span>
				        <span class="token literal-property property">filePath</span><span class="token operator">:</span> filePath<span class="token punctuation">,</span>
				        <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res_</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
							<span class="token keyword">if</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>statusCode <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token comment">//文件保存成功之后就可以打开文件</span>
								uni<span class="token punctuation">.</span><span class="token function">openDocument</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
									<span class="token literal-property property">filePath</span><span class="token operator">:</span> res_<span class="token punctuation">.</span>savedFilePath<span class="token punctuation">,</span>
									<span class="token literal-property property">showMenu</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 右上角显示三个点，微信自带的api，可以保存、转发文件</span>
									<span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
										uni<span class="token punctuation">.</span><span class="token function">showToast</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
											<span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'打开成功'</span>
										<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
									<span class="token punctuation">}</span><span class="token punctuation">,</span>
								<span class="token punctuation">}</span><span class="token punctuation">)</span>
							<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//文件没有打开成功就报错提示</span>
								uni<span class="token punctuation">.</span><span class="token function">hideLoading</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
								uni<span class="token punctuation">.</span><span class="token function">showToast</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
									<span class="token literal-property property">icon</span><span class="token operator">:</span><span class="token string">"error"</span><span class="token punctuation">,</span>
									<span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'打开失败'</span>
								<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
							<span class="token punctuation">}</span>
				        <span class="token punctuation">}</span><span class="token punctuation">,</span>
				        <span class="token function-variable function">fail</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				            uni<span class="token punctuation">.</span><span class="token function">showToast</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
				            	<span class="token literal-property property">icon</span><span class="token operator">:</span><span class="token string">"error"</span><span class="token punctuation">,</span>
				            	<span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'加载失败'</span>
				            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				        <span class="token punctuation">}</span>
				        <span class="token punctuation">}</span><span class="token punctuation">)</span>
				    <span class="token punctuation">}</span>
				<span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f34383632373735302f:61727469636c652f64657461696c732f313334343736393337" class_="artid" style="display:none">
 </p>
</div>


