---
layout: post
title: "Linux中的TCP编程接口基本使用"
date: 2025-03-07 16:09:00 +0800
description: "在UDP编程接口基本使用已经介绍过UDP编程相关的接口，本篇开始介绍TCP编程相关的接口。"
keywords: "Linux中的TCP编程接口基本使用"
categories: ['Linux']
tags: ['运维', '服务器', '开发语言', 'Tcp', 'Linux', 'C']
artid: "146098150"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146098150
    alt: "Linux中的TCP编程接口基本使用"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146098150
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146098150
cover: https://bing.ee123.net/img/rand?artid=146098150
image: https://bing.ee123.net/img/rand?artid=146098150
img: https://bing.ee123.net/img/rand?artid=146098150
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Linux中的TCP编程接口基本使用
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-github-gist" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="TCP_0">
     </a>
     TCP编程接口基本使用
    </h2>
    <h3>
     <a id="_2">
     </a>
     本篇介绍
    </h3>
    <p>
     在UDP编程接口基本使用已经介绍过UDP编程相关的接口，本篇开始介绍TCP编程相关的接口。有了UDP编程的基础，理解TCP相关的接口会更加容易，下面将按照两个方向使用TCP编程接口：
    </p>
    <ol>
     <li>
      基本使用TCP编程接口实现服务端和客户端通信
     </li>
     <li>
      使用TCP编程实现客户端控制服务器执行相关命令的程序
     </li>
    </ol>
    <h3>
     <a id="_9">
     </a>
     创建并封装服务端
    </h3>
    <h4>
     <a id="_11">
     </a>
     创建服务器类
    </h4>
    <p>
     与UDP一样，首先创建服务器类的基本框架，本次设计的服务器一旦启动就不再关闭，除非手动关闭，所以可以提供两个接口：
    </p>
    <ol>
     <li>
      <code>
       start
      </code>
      ：启动服务器
     </li>
     <li>
      <code>
       stop
      </code>
      ：停止服务器
     </li>
    </ol>
    <p>
     基本结构如下：
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">class</span> <span class="token class-name">TcpServer</span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">TcpServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 启动服务器</span>
    <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 停止服务器</span>
    <span class="token keyword">void</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>

    <span class="token operator">~</span><span class="token function">TcpServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <h4>
     <a id="_44">
     </a>
     创建服务器套接字
    </h4>
    <p>
     创建方式与UDP基本一致，只是在
     <code>
      socket
     </code>
     接口的第二个参数使用
     <code>
      SOCK_STREAM
     </code>
     而不再是
     <code>
      SOCK_DGRAM
     </code>
     ，代码如下：
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">class</span> <span class="token class-name">TcpServer</span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">TcpServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token function">_socketfd</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 创建服务器套接字</span>
        _socketfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>_socketfd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">LOG</span><span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Server initiated error: "</span> <span class="token operator">&lt;&lt;</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>ErrorNumber<span class="token double-colon punctuation">::</span>SocketFail<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">LOG</span><span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Server initated: "</span> <span class="token operator">&lt;&lt;</span> _socketfd<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ...</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">int</span> _socketfd<span class="token punctuation">;</span>  <span class="token comment">// 服务器套接字</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <h4>
     <a id="IP_73">
     </a>
     绑定服务器IP地址和端口
    </h4>
    <p>
     绑定方式与UDP基本一致，先使用原生的方式而不是直接使用封装后的
     <code>
      sockaddr_in
     </code>
     结构。在UDP编程接口基本使用部分已经提到过服务器不需要指定IP地址，所以本次一步到位，代码如下：
    </p>
    <pre><code class="prism language-cpp"><span class="token comment">// 默认端口</span>
<span class="token keyword">const</span> <span class="token keyword">uint16_t</span> default_port <span class="token operator">=</span> <span class="token number">8080</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">TcpServer</span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">TcpServer</span><span class="token punctuation">(</span><span class="token keyword">uint16_t</span> port <span class="token operator">=</span> default_port<span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token comment">// ...</span>
        <span class="token punctuation">,</span> <span class="token function">_port</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// ...</span>

        <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> server<span class="token punctuation">;</span>
        server<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
        server<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>_port<span class="token punctuation">)</span><span class="token punctuation">;</span>
        server<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> INADDR_ANY<span class="token punctuation">;</span>

        <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">bind</span><span class="token punctuation">(</span>_socketfd<span class="token punctuation">,</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>server<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">LOG</span><span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Bind error："</span> <span class="token operator">&lt;&lt;</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>ErrorNumber<span class="token double-colon punctuation">::</span>BindSocketFail<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">LOG</span><span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Bind Success"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ...</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">int</span> _socketfd<span class="token punctuation">;</span>  <span class="token comment">// 服务器套接字</span>
    <span class="token keyword">uint16_t</span> _port<span class="token punctuation">;</span> <span class="token comment">// 服务器端口</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <h4>
     <a id="_112">
     </a>
     开启服务器监听
    </h4>
    <p>
     在UDP部分，走完上面的步骤就已经完成了基本工作，一旦服务器启动就会等待连接。但是在TCP部分则不行，因为TCP是面向连接的，也就是说，使用客户端需要连接使用TCP的客户端必须先建立连接，只有连接建立完成了才可以开始通信。为了可以让客户端和服务端成功建立连接，首先需要让服务器处于监听状态，此时服务器只会一直等待客户端发起连接请求
    </p>
    <p>
     在Linux中，实现服务器监听可以使用
     <code>
      listen
     </code>
     接口，其原型如下：
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">listen</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">int</span> backlog<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     该接口的第一个参数表示当前需要作为传输的套接字，第二个参数表示等待中的客户端的最大个数。之所以会有第二个参数是因为一旦请求连接的客户端太多但是服务器又无法快速得做出响应就会导致用户一直处于等待连接状态从而造成不必要的损失。一般情况下第二个参数不建议设置比较大，而是因为应该根据实际情况决定，但是一定不能为0，本次大小定为8
    </p>
    <p>
     当监听成功，该接口会返回0，否则返回-1并设置对应的错误码
    </p>
    <p>
     在TCP中，服务器一旦被创建那么久意味着其需要开始进行监听，所以本次考虑将监听放在构造中：
    </p>
    <pre><code class="prism language-cpp"><span class="token comment">// 默认最大支持排队等待连接的客户端个数</span>
<span class="token keyword">const</span> <span class="token keyword">int</span> max_backlog <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">TcpServer</span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">TcpServer</span><span class="token punctuation">(</span><span class="token keyword">uint16_t</span> port <span class="token operator">=</span> default_port<span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token function">_socketfd</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_port</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// ...</span>

        ret <span class="token operator">=</span> <span class="token function">listen</span><span class="token punctuation">(</span>_socketfd<span class="token punctuation">,</span> max_backlog<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">LOG</span><span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Listen error："</span> <span class="token operator">&lt;&lt;</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>ErrorNumber<span class="token double-colon punctuation">::</span>ListenFail<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">LOG</span><span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Listen Success"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <h4>
     <a id="_153">
     </a>
     启动服务器
    </h4>
    <p>
     在TCP中，启动服务器的逻辑和UDP的逻辑有一点不同，因为TCP服务器在启动之前先要进行监听，所以实际上此时服务器并没有进入IO状态，所以一旦启动服务器后，首先要做的就是一旦成功建立连接就需要进入收发消息的状态
    </p>
    <p>
     首先判断服务器是否启动，如果服务器本身已经启动就不需要再次启动，所以还是使用一个
     <code>
      _isRunning
     </code>
     变量作为判断条件，基本逻辑如下：
    </p>
    <pre><code class="prism language-cpp"><span class="token comment">// 启动服务器</span>
<span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_isRunning<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        _isRunning <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     接着就是在监听成功的情况下进入IO状态，这里使用的接口就是
     <code>
      accept
     </code>
     ，其原型如下：
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">accept</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span> addr<span class="token punctuation">,</span> socklen_t <span class="token operator">*</span> addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     该接口的第一个参数表示需要绑定的服务器套接字，第二个参数表示对方的套接字结构，第二个参数表示对方套接字结构的大小，其中第二个参数和第三个参数均为输出型参数
    </p>
    <p>
     需要注意的是该接口的返回值，当函数执行成功时，该接口会返回一个套接字，这个套接字与前面通过
     <code>
      socket
     </code>
     接口获取到的套接字不同。在UDP中，只有一个套接字，就是
     <code>
      socket
     </code>
     的返回值，但是在TCP中，因为首先需要先监听，此时需要用到的实际上是监听套接字，一旦监听成功，才会给定用于IO的套接字。所以实际上，在TCP中，
     <code>
      socket
     </code>
     接口的返回值对应的是
     <code>
      listen
     </code>
     用的套接字，而
     <code>
      accept
     </code>
     的套接字就是用于IO的套接字
    </p>
    <p>
     基于上面的概念，现在对前面的代码进行一定的修正：对于前面的成员
     <code>
      _socketfd
     </code>
     ，应该修改为
     <code>
      _listen_socketfd
     </code>
     ：
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">class</span> <span class="token class-name">TcpServer</span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">TcpServer</span><span class="token punctuation">(</span><span class="token keyword">uint16_t</span> port <span class="token operator">=</span> default_port<span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token function">_listen_socketfd</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_port</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_isRunning</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 创建服务器套接字</span>
        _listen_socketfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>_listen_socketfd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">LOG</span><span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Server initiated error: "</span> <span class="token operator">&lt;&lt;</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>ErrorNumber<span class="token double-colon punctuation">::</span>SocketFail<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">LOG</span><span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Server initated: "</span> <span class="token operator">&lt;&lt;</span> _listen_socketfd<span class="token punctuation">;</span>
        
        <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">bind</span><span class="token punctuation">(</span>_listen_socketfd<span class="token punctuation">,</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>server<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ...</span>

        ret <span class="token operator">=</span> <span class="token function">listen</span><span class="token punctuation">(</span>_listen_socketfd<span class="token punctuation">,</span> max_backlog<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ...</span>
<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">int</span> _listen_socketfd<span class="token punctuation">;</span> <span class="token comment">// 服务器监听套接字</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     接着，对于接收成功也可以创建一个成员变量
     <code>
      _ac_socketfd
     </code>
     ，并用其接收
     <code>
      accept
     </code>
     接口的返回值：
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">class</span> <span class="token class-name">TcpServer</span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">TcpServer</span><span class="token punctuation">(</span><span class="token keyword">uint16_t</span> port <span class="token operator">=</span> default_port<span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token comment">// ...</span>
        <span class="token punctuation">,</span> <span class="token function">_ac_socketfd</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 启动服务器</span>
    <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_isRunning<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _isRunning <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> peer<span class="token punctuation">;</span>
                socklen_t length <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>peer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                _ac_socketfd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>_listen_socketfd<span class="token punctuation">,</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>peer<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>_ac_socketfd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token function">LOG</span><span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>WARNING<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Accept failed："</span> <span class="token operator">&lt;&lt;</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>ErrorNumber<span class="token double-colon punctuation">::</span>AcceptFail<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token function">LOG</span><span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Accept Success: "</span> <span class="token operator">&lt;&lt;</span> _ac_socketfd<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// ...</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">int</span> _ac_socketfd<span class="token punctuation">;</span>     <span class="token comment">// 服务器接收套接字</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     后续的代码与UDP思路类似，但是具体实现有些不同。因为UDP是面向数据包的，所以只能「整发整取」，但是TCP是面向字节流的，所以可以「按照需求读取」而不需要「一定完整读取」，而在文件部分，读取和写入文件也是面向字节流的，所以在TCP中，读取和写入就可以直接使用文件的读写接口。但是需要注意，因为读写不是一次性的，所以需要一个循环控制持续读和写：
    </p>
    <pre><code class="prism language-cpp"><span class="token comment">// 启动服务器</span>
<span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_isRunning<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// ...</span>

            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 读取客户端消息</span>
                <span class="token keyword">char</span> buffer<span class="token punctuation">[</span><span class="token number">4096</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
                ssize_t ret <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>_ac_socketfd<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token function">LOG</span><span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Client: "</span> <span class="token operator">&lt;&lt;</span> <span class="token function">inet_ntoa</span><span class="token punctuation">(</span>peer<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">":"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token function">ntohs</span><span class="token punctuation">(</span>peer<span class="token punctuation">.</span>sin_port<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" send: "</span> <span class="token operator">&lt;&lt;</span> buffer<span class="token punctuation">;</span>

                    <span class="token comment">// 向客户端回消息</span>
                    ret <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>_ac_socketfd<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="_289">
     </a>
     停止服务器
    </h4>
    <p>
     停止服务器和UDP思路一致，但是需要注意，除了要关闭接收套接字以外还需要关闭监听套接字，此处不再赘述：
    </p>
    <p>
     === “停止服务器函数”
    </p>
    <pre><code class="prism language-cpp"><span class="token comment">// 停止服务器</span>
<span class="token keyword">void</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_isRunning<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">close</span><span class="token punctuation">(</span>_listen_socketfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">close</span><span class="token punctuation">(</span>_ac_socketfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     === “析构函数”
    </p>
    <pre><code class="prism language-cpp"><span class="token operator">~</span><span class="token function">TcpServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="_316">
     </a>
     创建并封装客户端
    </h3>
    <h4>
     <a id="_318">
     </a>
     创建客户端类
    </h4>
    <p>
     与UDP一致，代码如下：
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">class</span> <span class="token class-name">TcpClient</span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">TcpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 启动客户端</span>
    <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 停止客户端</span>
    <span class="token keyword">void</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>

    <span class="token operator">~</span><span class="token function">TcpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <h4>
     <a id="_346">
     </a>
     创建客户端套接字
    </h4>
    <p>
     与UDP一致，此处不再赘述：
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">class</span> <span class="token class-name">TcpClient</span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">TcpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token function">_socketfd</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        _socketfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>_socketfd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">LOG</span><span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Client initiated error："</span> <span class="token operator">&lt;&lt;</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>ErrorNumber<span class="token double-colon punctuation">::</span>SocketFail<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">LOG</span><span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Client initiated"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ...</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">int</span> _socketfd<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <h4>
     <a id="_374">
     </a>
     启动客户端
    </h4>
    <p>
     因为当前是TCP，所以客户端必须先与服务端建立连接才可以进行数据传输。在Linux中，让客户端连接服务端的接口是
     <code>
      connect
     </code>
     ，其原型如下：
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> socklen_t addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     该接口的第一个参数表示传送数据需要的套接字，第二个参数表示服务器的套接字结构，第三个参数表示第二个参数的大小
    </p>
    <p>
     如果该接口连接成功或者绑定成功，则返回0，否则返回-1并且设置错误码
    </p>
    <blockquote>
     <p>
      需要注意，该接口会在成功连接后自动绑定端口和IP地址，与UDP一样不需要用户手动设置客户端的IP地址和端口
     </p>
    </blockquote>
    <p>
     因为需要用到服务器的端口和IP地址，所以在创建客户端对象时需要让用户传递IP地址和端口，所以基本代码如下：
    </p>
    <pre><code class="prism language-cpp"><span class="token comment">// 默认服务器端口和IP地址</span>
<span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string default_ip <span class="token operator">=</span> <span class="token string">"127.0.0.1"</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">uint16_t</span> default_port <span class="token operator">=</span> <span class="token number">8080</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">TcpClient</span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">TcpClient</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>ip <span class="token operator">=</span> default_ip<span class="token punctuation">,</span> <span class="token keyword">uint16_t</span> port <span class="token operator">=</span> default_port<span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token comment">// ...</span>
        <span class="token punctuation">,</span> <span class="token function">_isRunning</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_ip</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_port</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 启动客户端</span>
    <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_isRunning<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _isRunning <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token comment">// 启动后就进行connect</span>
            <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> server<span class="token punctuation">;</span>
            server<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
            server<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span>_ip<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            server<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>_port<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">connect</span><span class="token punctuation">(</span>_socketfd<span class="token punctuation">,</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>server<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token function">LOG</span><span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>WARNING<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Connect failed"</span> <span class="token operator">&lt;&lt;</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">exit</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>ErrorNumber<span class="token double-colon punctuation">::</span>ConnectFail<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">LOG</span><span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Connect Success: "</span> <span class="token operator">&lt;&lt;</span> _socketfd<span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// ...</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ...</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token comment">// ...</span>
    std<span class="token double-colon punctuation">::</span>string _ip<span class="token punctuation">;</span> <span class="token comment">// 服务器IP地址</span>
    <span class="token keyword">uint16_t</span> _port<span class="token punctuation">;</span>  <span class="token comment">// 服务器端口</span>
    <span class="token keyword">bool</span> _isRunning<span class="token punctuation">;</span> <span class="token comment">// 判断是否正在运行</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     在上面的代码中需要注意，不要把
     <code>
      connect
     </code>
     放在循环里，因为建立连接需要一次而不需要每一次发送都建立连接
    </p>
    <p>
     接着就是写入和读取消息，基本思路与UDP相同，代码如下：
    </p>
    <pre><code class="prism language-cpp"><span class="token comment">// 启动客户端</span>
<span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_isRunning<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// ...</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 向服务器写入</span>
            std<span class="token double-colon punctuation">::</span>string message<span class="token punctuation">;</span>
            std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"请输入消息："</span><span class="token punctuation">;</span>
            std<span class="token double-colon punctuation">::</span><span class="token function">getline</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>cin<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            ssize_t ret <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>_socketfd<span class="token punctuation">,</span> message<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> message<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 收到消息</span>
            <span class="token keyword">char</span> buffer<span class="token punctuation">[</span><span class="token number">4096</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
            ret <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>_socketfd<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token function">LOG</span><span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"收到服务器消息："</span> <span class="token operator">&lt;&lt;</span> buffer<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="_469">
     </a>
     停止客户端
    </h4>
    <p>
     停止客户端的思路与UDP一致，此处不再赘述：
    </p>
    <p>
     === “停止客户端函数”
    </p>
    <pre><code class="prism language-cpp"><span class="token comment">// 停止客户端</span>
<span class="token keyword">void</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_isRunning<span class="token punctuation">)</span>
        <span class="token function">close</span><span class="token punctuation">(</span>_socketfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     === “析构函数”
    </p>
    <pre><code class="prism language-cpp"><span class="token operator">~</span><span class="token function">TcpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="_493">
     </a>
     本地通信测试
    </h3>
    <p>
     <strong>
      测试步骤：
     </strong>
    </p>
    <ol>
     <li>
      先启动服务端，再启动客户端
     </li>
     <li>
      客户端向服务器端发送信息
     </li>
    </ol>
    <p>
     <strong>
      测试目标：
     </strong>
    </p>
    <ol>
     <li>
      客户端可以正常向服务器端发送信息
     </li>
     <li>
      服务端可以正常显示客户端信息并正常向客户端返回客户端发送的信息
     </li>
     <li>
      客户端可以正常显示服务端回复的信息
     </li>
    </ol>
    <p>
     测试代码如下：
    </p>
    <p>
     === “客户端”
    </p>
    <pre><code class="prism language-cpp"> <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"tcp_client.hpp"</span></span>
 <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;memory&gt;</span></span>
 
 <span class="token keyword">using</span> <span class="token keyword">namespace</span> TcpClientModule<span class="token punctuation">;</span>
 
 <span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
 <span class="token punctuation">{<!-- --></span>
     std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>TcpClient<span class="token operator">&gt;</span> tcp_client<span class="token punctuation">;</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
     <span class="token punctuation">{<!-- --></span>
         <span class="token comment">// 使用默认端口和IP地址</span>
         tcp_client <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>TcpClient<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span>
     <span class="token punctuation">{<!-- --></span>
         std<span class="token double-colon punctuation">::</span>string ip <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
         std<span class="token double-colon punctuation">::</span><span class="token keyword">uint16_t</span> port <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">stoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// 使用自定义端口和IP地址</span>
         tcp_client <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>TcpClient<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>ip<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     <span class="token keyword">else</span>
     <span class="token punctuation">{<!-- --></span>
         <span class="token function">LOG</span><span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"错误使用，正确使用为："</span> <span class="token operator">&lt;&lt;</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" IP地址 端口号（或者二者都不存在）"</span><span class="token punctuation">;</span>
         <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     
     tcp_client<span class="token operator">-&gt;</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
     tcp_client<span class="token operator">-&gt;</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
     <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
</code></pre>
    <p>
     === “服务端”
    </p>
    <pre><code class="prism language-cpp"> <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"tcp_server.hpp"</span></span>
 <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;memory&gt;</span></span>
 
 <span class="token keyword">using</span> <span class="token keyword">namespace</span> TcpServerModule<span class="token punctuation">;</span>
 
 <span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
 <span class="token punctuation">{<!-- --></span>
     std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>TcpServer<span class="token operator">&gt;</span> tcp_server<span class="token punctuation">;</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
     <span class="token punctuation">{<!-- --></span>
         <span class="token comment">// 使用默认的端口</span>
         tcp_server <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>TcpServer<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span>
     <span class="token punctuation">{<!-- --></span>
         <span class="token comment">// 使用自定义端口</span>
         std<span class="token double-colon punctuation">::</span>string port <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
         tcp_server <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>TcpServer<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     <span class="token keyword">else</span>
     <span class="token punctuation">{<!-- --></span>
         <span class="token function">LOG</span><span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"错误使用，正确方式："</span> <span class="token operator">&lt;&lt;</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" 端口（可以省略）"</span><span class="token punctuation">;</span>
         <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 
     tcp_server<span class="token operator">-&gt;</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
     tcp_server<span class="token operator">-&gt;</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
     <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
</code></pre>
    <p>
     本次设计的客户端支持用户从命令行输入端口和IP地址，否则就直接使用默认，下面是一种结果：
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/cd0513458cdd4b33aef3f0135c6749f9.png"/>
    </p>
    <h3>
     <a id="_586">
     </a>
     客户端退出但服务端没有退出的问题
    </h3>
    <p>
     在UDP中，如果客户端退出但服务端没有退出，下一次客户端再连接该服务端时不会出现问题。但是在TCP中就并不是这样，例如：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/dac67066eff84c4f9c2360cf112f3ee6.png"/>
    </p>
    <p>
     从上图可以看到，如果客户端连接后断开再连接就会出现第二次连接发送消息无法得到回应。之所以出现这个问题就是因为服务器卡在了读写死循环中，解决这个问题的方式很简单，只需要判断
     <code>
      read
     </code>
     接口返回值是否为0，如果为0，说明当前服务器并没有读取到任何内容，直接退出即可：
    </p>
    <pre><code class="prism language-cpp"><span class="token comment">// 启动服务器</span>
<span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_isRunning<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// ...</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// ...</span>
            
            <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 读取客户端消息</span>
                <span class="token keyword">char</span> buffer<span class="token punctuation">[</span><span class="token number">4096</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
                ssize_t ret <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>_ac_socketfd<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// ...</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token function">LOG</span><span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Client disconnected: "</span> <span class="token operator">&lt;&lt;</span> _ac_socketfd<span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     此时便可以解决上面的问题：
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/40b7b4f1336d45af92f2e1c01f94bed1.png"/>
    </p>
    <h3>
     <a id="_631">
     </a>
     文件描述符泄漏问题
    </h3>
    <p>
     在上面的测试结果中可以发现，当客户端退出后再重新连接服务端，此时的文件描述符由4变成了5，但是实际上文件描述符是非常有限的，对于一般的用户机来说，文件描述符最大为1024，而服务器一般为65535，使用下面的指令可以查看：
    </p>
    <pre><code class="prism language-shell"><span class="token builtin class-name">ulimit</span> <span class="token parameter variable">-a</span>
</code></pre>
    <p>
     在结果中的
     <code>
      open files
     </code>
     一栏即可看到值
    </p>
    <p>
     既然客户端已经退出了，那么对应的文件描述符就应该关闭而不是持续被占用着，此时就出现了文件描述符泄漏问题。解决这个问题很简答，只需要在判断读取结果小于0时关闭文件描述符再退出即可：
    </p>
    <pre><code class="prism language-cpp"><span class="token comment">// 启动服务器</span>
<span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_isRunning<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// ...</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// ...</span>

            <span class="token comment">// ...</span>

            <span class="token function">close</span><span class="token punctuation">(</span>_ac_socketfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="_663">
     </a>
     测试云服务器与本地进行通信
    </h3>
    <h4>
     <a id="Linux_665">
     </a>
     相同操作系统（客户端和服务端均为Linux）
    </h4>
    <p>
     测试云服务器与本地进行通信最直接的步骤如下：
    </p>
    <ol>
     <li>
      将服务端程序拷贝到云服务器
     </li>
     <li>
      本地作为客户端，通过云服务器的公网IP地址连接云服务器的服务端
     </li>
     <li>
      客户端向云服务器发送信息
     </li>
    </ol>
    <p>
     具体操作步骤与UDP类似，下面直接展示结果：
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/a8cc1bbb828641e584824465b234d44e.png"/>
    </p>
    <blockquote>
     <p>
      与UDP一样需要注意安全组的问题，以阿里云为例，设置结果如下：
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/c40af2c249ac43a888006c7e83883f85.png"/>
     </p>
    </blockquote>
    <h4>
     <a id="WindowsLinux_682">
     </a>
     不同操作系统（客户端为Windows，服务端为Linux）
    </h4>
    <p>
     因为Windows中使用接口和Linux中差不多，所以不会再详细介绍，下面直接给出Windows客户端代码：
    </p>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;winsock2.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression"><span class="token function">warning</span><span class="token punctuation">(</span>disable <span class="token operator">:</span> <span class="token number">4996</span><span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression"><span class="token function">comment</span><span class="token punctuation">(</span>lib<span class="token punctuation">,</span> </span><span class="token string">"ws2_32.lib"</span><span class="token expression"><span class="token punctuation">)</span></span></span>

std<span class="token double-colon punctuation">::</span>string serverip <span class="token operator">=</span> <span class="token string">"47.113.217.80"</span><span class="token punctuation">;</span>  <span class="token comment">// 填写云服务器IP地址</span>
<span class="token keyword">uint16_t</span> serverport <span class="token operator">=</span> <span class="token number">8888</span><span class="token punctuation">;</span> <span class="token comment">// 填写云服务开放的端口号</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    WSADATA wsaData<span class="token punctuation">;</span>
    <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token function">WSAStartup</span><span class="token punctuation">(</span><span class="token function">MAKEWORD</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>wsaData<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        std<span class="token double-colon punctuation">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"WSAStartup failed: "</span> <span class="token operator">&lt;&lt;</span> result <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    SOCKET clientSocket <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> IPPROTO_TCP<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>clientSocket <span class="token operator">==</span> INVALID_SOCKET<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        std<span class="token double-colon punctuation">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"socket failed"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
        <span class="token function">WSACleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    sockaddr_in serverAddr<span class="token punctuation">;</span>
    serverAddr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
    serverAddr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>serverport<span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token comment">// 替换为服务器端口</span>
    serverAddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span>serverip<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 替换为服务器IP地址</span>

    result <span class="token operator">=</span> <span class="token function">connect</span><span class="token punctuation">(</span>clientSocket<span class="token punctuation">,</span> <span class="token punctuation">(</span>SOCKADDR <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>serverAddr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>serverAddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> SOCKET_ERROR<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        std<span class="token double-colon punctuation">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"connect failed"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
        <span class="token function">closesocket</span><span class="token punctuation">(</span>clientSocket<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">WSACleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        std<span class="token double-colon punctuation">::</span>string message<span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Please Enter@ "</span><span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span><span class="token function">getline</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>cin<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token function">send</span><span class="token punctuation">(</span>clientSocket<span class="token punctuation">,</span> message<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> message<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">char</span> buffer<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> bytesReceived <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>clientSocket<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bytesReceived <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            buffer<span class="token punctuation">[</span>bytesReceived<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span> <span class="token comment">// 确保字符串以 null 结尾</span>
            std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Received from server: "</span> <span class="token operator">&lt;&lt;</span> buffer <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{<!-- --></span>
            std<span class="token double-colon punctuation">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"recv failed"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">closesocket</span><span class="token punctuation">(</span>clientSocket<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">WSACleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     运行结果如下：
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/264f5a00d230457583274f1772f7e259.png"/>
    </p>
    <h3>
     <a id="_762">
     </a>
     多个客户端同时连接服务器
    </h3>
    <p>
     在上面已经测试过一个客户端连接一个服务端，接下来测试多个客户端连接服务端
    </p>
    <h4>
     <a id="_766">
     </a>
     基本现象
    </h4>
    <p>
     使用本地虚拟机和云服务器的客户端本地连接云服务器的服务端：
    </p>
    <p>
     先使用虚拟机或者云服务器的客户端连接服务端：
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/1bc655e766c74decaa6f14daa01a66cb.png"/>
    </p>
    <p>
     可以看到正常连接，但是此时如果云服务器本地客户端连接云服务器的服务端：
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/aebbd6edc9214b78bfe5699524b82d45.png"/>
    </p>
    <p>
     此时就会发现，尽管云服务器客户端提示连接成功，但是服务器却没有显示接收。如果云服务器的客户端向服务器发送消息也不回得到回应：
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/b858e3cd78ab4d8fb232eadfe123de7d.png"/>
    </p>
    <p>
     如果终断虚拟机的连接，此时服务器又会显示连接成功：
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/11c5731927a1434589e0a5879af36e28.png"/>
    </p>
    <p>
     之所以会出现这个问题就是因为在上面的逻辑中：只有接收成功了才会发送消息，而一旦接收成功后，就在写入和读取中死循环，此时就导致
     <code>
      accept
     </code>
     不能继续接收。解决这个问题就需要考虑到使用子进程或者新线程，将接收和读写分别放在两个执行进程或者执行流中，根据这个思路下面提供三种解决方案：
    </p>
    <ol>
     <li>
      子进程版本
     </li>
     <li>
      新线程版本
     </li>
     <li>
      线程池版本
     </li>
    </ol>
    <h4>
     <a id="_796">
     </a>
     子进程版本
    </h4>
    <p>
     设计子进程版本的本质就是让子进程执行读写方法，先将读写逻辑抽离到一个函数中：
    </p>
    <p>
     === “读写函数”
    </p>
    <pre><code class="prism language-cpp"><span class="token comment">// 读写函数</span>
<span class="token keyword">void</span> <span class="token function">read_write_msg</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> peer<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 读取客户端消息</span>
        <span class="token keyword">char</span> buffer<span class="token punctuation">[</span><span class="token number">4096</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        ssize_t ret <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>_ac_socketfd<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">LOG</span><span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Client: "</span> <span class="token operator">&lt;&lt;</span> <span class="token function">inet_ntoa</span><span class="token punctuation">(</span>peer<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">":"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token function">ntohs</span><span class="token punctuation">(</span>peer<span class="token punctuation">.</span>sin_port<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" send: "</span> <span class="token operator">&lt;&lt;</span> buffer<span class="token punctuation">;</span>

            <span class="token comment">// 向客户端回消息</span>
            ret <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>_ac_socketfd<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">LOG</span><span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Client disconnected: "</span> <span class="token operator">&lt;&lt;</span> _ac_socketfd<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">close</span><span class="token punctuation">(</span>_ac_socketfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     === “启动服务器函数”
    </p>
    <pre><code class="prism language-cpp"><span class="token comment">// 启动服务器</span>
<span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_isRunning<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        _isRunning <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> peer<span class="token punctuation">;</span>
            socklen_t length <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>peer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            _ac_socketfd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>_listen_socketfd<span class="token punctuation">,</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>peer<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_ac_socketfd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token function">LOG</span><span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>WARNING<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Accept failed："</span> <span class="token operator">&lt;&lt;</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">exit</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>ErrorNumber<span class="token double-colon punctuation">::</span>AcceptFail<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">LOG</span><span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Accept Success: "</span> <span class="token operator">&lt;&lt;</span> _ac_socketfd<span class="token punctuation">;</span>

            <span class="token comment">// 读写逻辑</span>
            <span class="token function">read_write_msg</span><span class="token punctuation">(</span>peer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     接着，为了让子进程执行对应的任务，首先就是创建一个子进程，此处直接使用原生接口：
    </p>
    <pre><code class="prism language-cpp"><span class="token comment">// 启动服务器</span>
<span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_isRunning<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        _isRunning <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// ...</span>

            <span class="token comment">// 创建子进程</span>
            pid_t pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 子进程</span>

                <span class="token comment">// 读写逻辑</span>
                <span class="token function">read_write_msg</span><span class="token punctuation">(</span>peer<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     但是，这样写还不足以解决问题，在Linux进程间通信提到子进程会拷贝父进程描述符表，此时同样会导致文件描述符泄漏问题，所以父进程和子进程都需要关闭自己不需要的文件描述符：对于父进程来说，其需要关闭读写用的文件描述符，因为写入和读取交给了子进程；对于子进程来说，其需要关闭监听用的文件描述符，因为继续监听其他客户端的连接由父进程进行
    </p>
    <p>
     基于上面的思路，代码如下：
    </p>
    <pre><code class="prism language-cpp"><span class="token comment">// 启动服务器</span>
<span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_isRunning<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        _isRunning <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// ...</span>

            <span class="token comment">// 创建子进程</span>
            pid_t pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 子进程</span>

                <span class="token comment">// 关闭监听文件描述符</span>
                <span class="token function">close</span><span class="token punctuation">(</span>_listen_socketfd<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// ...</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 父进程关闭读写描述符</span>
            <span class="token function">close</span><span class="token punctuation">(</span>_ac_socketfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     一旦创建了子进程，父进程就需要对其进行等待并回收，如果不回收就会导致内存泄漏问题，回收子进程的方式目前有下面两种：
    </p>
    <ol>
     <li>
      使用
      <code>
       wait
      </code>
      和
      <code>
       waitpid
      </code>
      接口进行等待
     </li>
     <li>
      借助子进程退出时发送的
      <code>
       SIGCHILD
      </code>
      信号，使用
      <code>
       SIG_IGN
      </code>
      行为
     </li>
    </ol>
    <p>
     但是本次不使用上面的任意一种，而是考虑让子进程再创建一个子进程，一旦创建成功就让当前子进程退出，而让新创建的子进程（孙子进程）继续执行后续的代码，因为当前子进程已经退出并且退出前并没有回收新创建的子进程（孙子进程），所以当前孙子进程就会被操作系统托管变成孤儿进程，一旦孙子进程走到了读写逻辑下面的
     <code>
      exit(0)
     </code>
     就会退出，此时操作系统就会自动回收这个孙子进程。这个思路也被称为「双重
     <code>
      fork
     </code>
     （或者守护进程化））」。所以，代码如下：
    </p>
    <pre><code class="prism language-cpp"><span class="token comment">// 启动服务器</span>
<span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_isRunning<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        _isRunning <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// ...</span>

            <span class="token comment">// 创建子进程</span>
            pid_t pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 子进程</span>
                <span class="token comment">// ...</span>

                <span class="token comment">// 创建孙子进程</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 当前子进程执行exit(0)</span>

                <span class="token comment">// 孙子进程从此处继续向后执行</span>
                <span class="token comment">// 读写逻辑</span>
                <span class="token function">read_write_msg</span><span class="token punctuation">(</span>peer<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     现在，再进行上面的测试可以发现问题已经解决：
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/b000523b861a4e7c9c6f7fc2e3cb159b.png"/>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/ec796e224d44432f8a81eed0317ec24e.png"/>
    </p>
    <h4>
     <a id="_974">
     </a>
     新线程版本
    </h4>
    <p>
     因为所有线程共享一个文件描述符表，所以不需要手动关闭一些文件描述符，下面使用前面封装的线程进行演示：
    </p>
    <pre><code class="prism language-cpp"><span class="token comment">// 启动服务器</span>
<span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_isRunning<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        _isRunning <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// ...</span>

            <span class="token comment">// // 父进程关闭读写描述符</span>
            <span class="token comment">// close(_ac_socketfd);</span>

            <span class="token comment">// 创建新线程</span>
            Thread <span class="token function">t</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>TcpServer<span class="token double-colon punctuation">::</span>read_write_msg<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> peer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            t<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     测试之后可以发现和子进程测试的效果一样，此处不再展示
    </p>
    <h4>
     <a id="_1003">
     </a>
     线程池版本
    </h4>
    <p>
     线程池版本和新线程版本的思路非常类似，给出代码不再演示：
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">using</span> task_t <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>

<span class="token comment">// ...</span>

<span class="token keyword">class</span> <span class="token class-name">TcpServer</span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">TcpServer</span><span class="token punctuation">(</span><span class="token keyword">uint16_t</span> port <span class="token operator">=</span> default_port<span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token function">_listen_socketfd</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_port</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_isRunning</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_ac_socketfd</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 创建服务器套接字</span>
        <span class="token comment">// ...</span>

        <span class="token comment">// 绑定</span>
        <span class="token comment">// ...</span>

        <span class="token comment">// 创建线程池</span>
        _tp <span class="token operator">=</span> <span class="token class-name">ThreadPool</span><span class="token operator">&lt;</span>task_t<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 启动线程池</span>
        _tp<span class="token operator">-&gt;</span><span class="token function">startThreads</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 监听</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ...</span>

    <span class="token comment">// 启动服务器</span>
    <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_isRunning<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _isRunning <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// ...</span>

                <span class="token comment">// version-3</span>
                _tp<span class="token operator">-&gt;</span><span class="token function">pushTasks</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>TcpServer<span class="token double-colon punctuation">::</span>read_write_msg<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> peer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 停止服务器</span>
    <span class="token keyword">void</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_isRunning<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _tp<span class="token operator">-&gt;</span><span class="token function">stopThreads</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token operator">~</span><span class="token function">TcpServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token comment">// ...</span>
    std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>ThreadPool<span class="token operator">&lt;</span>task_t<span class="token operator">&gt;&gt;</span> _tp<span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <h3>
     <a id="_1074">
     </a>
     客户端控制服务器执行相关命令的程序
    </h3>
    <h4>
     <a id="_1076">
     </a>
     思路分析
    </h4>
    <p>
     既然需要客户端控制服务器执行命令就必须要经历下面的步骤：
    </p>
    <ol>
     <li>
      客户端将命令字符串发送给服务端
     </li>
     <li>
      服务端创建子进程，利用进程间通信将分析后的命令交给子进程，子进程调用
      <code>
       exec
      </code>
      家族函数将命令执行的结果通过服务器发送给客户端
     </li>
    </ol>
    <h4>
     <a id="_1083">
     </a>
     实现
    </h4>
    <p>
     因为服务端本身就是进行接收和返回结果，所以考虑将命令执行单独作为一个类来描述，本次为了执行的安全，考虑只允许用户执行部分命令，并且提供判断命令是否是合法命令，所以少不了需要查询的接口，为了更快速的查询，可以使用
     <code>
      set
     </code>
     集合。另外，因为要执行命令，所以需要一个成员函数
     <code>
      executeCommand
     </code>
     执行对应的命令，所以基本结构如下：
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">class</span> <span class="token class-name">Command</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">Command</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 构造可以执行的一些命令</span>
        _commands<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token string">"ls"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        _commands<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token string">"pwd"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        _commands<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token string">"ll"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        _commands<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token string">"touch"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        _commands<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token string">"who"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        _commands<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token string">"whoami"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 判断命令是否合法</span>
    <span class="token keyword">bool</span> <span class="token function">isValid</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>string cmd<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">auto</span> pos <span class="token operator">=</span> _commands<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pos <span class="token operator">==</span> _commands<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 执行命令</span>
    std<span class="token double-colon punctuation">::</span>string <span class="token function">executeCommand</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>cmd<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>

    <span class="token operator">~</span><span class="token function">Command</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    std<span class="token double-colon punctuation">::</span>set<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">&gt;</span> _commands<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     接着，改变服务端的读写任务的接口，此处不再使用文件的
     <code>
      read
     </code>
     和
     <code>
      write
     </code>
     接口，而是使用
     <code>
      recv
     </code>
     和
     <code>
      send
     </code>
     接口，这两个接口只是比
     <code>
      read
     </code>
     和
     <code>
      write
     </code>
     多了
     <code>
      flags
     </code>
     ，其余都一样，并且目前情况下
     <code>
      flags
     </code>
     设置为0即可：
    </p>
    <pre><code class="prism language-cpp"><span class="token comment">// 读写函数</span>
<span class="token keyword">void</span> <span class="token function">read_write_msg</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> peer<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 读取客户端消息</span>
        <span class="token keyword">char</span> buffer<span class="token punctuation">[</span><span class="token number">4096</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        ssize_t ret <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>_ac_socketfd<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">LOG</span><span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Client: "</span> <span class="token operator">&lt;&lt;</span> <span class="token function">inet_ntoa</span><span class="token punctuation">(</span>peer<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">":"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token function">ntohs</span><span class="token punctuation">(</span>peer<span class="token punctuation">.</span>sin_port<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" send: "</span> <span class="token operator">&lt;&lt;</span> buffer<span class="token punctuation">;</span>

            <span class="token comment">// 向客户端回消息</span>
            Command cmd<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cmd<span class="token punctuation">.</span><span class="token function">isValid</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 命令合法可以执行命令</span>
                std<span class="token double-colon punctuation">::</span>string ret <span class="token operator">=</span> cmd<span class="token punctuation">.</span><span class="token function">executeCommand</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">send</span><span class="token punctuation">(</span>_ac_socketfd<span class="token punctuation">,</span> ret<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ret<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token function">send</span><span class="token punctuation">(</span>_ac_socketfd<span class="token punctuation">,</span> <span class="token string">"错误指令"</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token string">"错误指令"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     接下来就是实现执行命令函数，根据前面的分析需要创建子进程调用
     <code>
      exec
     </code>
     家族函数执行对应的命令，但是在标准库中有对应的接口已经实现了这个功能：
     <code>
      popen
     </code>
     ，其原型如下：
    </p>
    <pre><code class="prism language-c">FILE <span class="token operator">*</span><span class="token function">popen</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>command<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     对应的接口就是
     <code>
      pclose
     </code>
     接口，原型如下：
    </p>
    <pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">pclose</span><span class="token punctuation">(</span>FILE <span class="token operator">*</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     对于
     <code>
      popen
     </code>
     接口来说，其会对传入的命令进行分析并创建子进程执行，将执行结果放到返回值中，因为
     <code>
      FILE
     </code>
     是文件结构，所以只需要使用文件的读写接口即可读取到其中的内容，这个接口第二个参数表示读模式或者写模式，因为是执行命令，所以只需要填入
     <code>
      "r"
     </code>
     即可
    </p>
    <p>
     结合上面的接口即可完成对应的执行命令函数：
    </p>
    <pre><code class="prism language-cpp">std<span class="token double-colon punctuation">::</span>string <span class="token function">executeCommand</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>cmd<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    FILE <span class="token operator">*</span>fp <span class="token operator">=</span> <span class="token function">popen</span><span class="token punctuation">(</span>cmd<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fp <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> buffer<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>string result<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">fgets</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">,</span> fp<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        result <span class="token operator">+=</span> buffer<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">pclose</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     !!! note
     <br/>
     <code>
      fgets
     </code>
     会自动添加
     <code>
      \0
     </code>
     ，不需要预留
     <code>
      \0
     </code>
     的位置
    </p>
    <h4>
     <a id="_1195">
     </a>
     测试
    </h4>
    <p>
     服务端主函数代码和客户端主函数代码不变，下面是测试结果：
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/48dcdae063e14e40919806e40ef0ac6f.png"/>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f6d305f37333238313539342f:61727469636c652f64657461696c732f313436303938313530" class_="artid" style="display:none">
 </p>
</div>


