---
layout: post
title: "部署ubuntu部署olmOCR"
date: 2025-03-14 17:16:15 +0800
description: "libnccl.so.2 是 NVIDIA 的 NCCL（NVIDIA Collective Communications Library）库的一部分，通常用于多 GPU 通信。这是 CUDA 工具包的一部分，通常在安装 CUDA toolkit 时应该包含这个库。从报错信息来看，问题出在 pip install -e . 时无法创建 olmocr.egg-info 目录，原因是 权限不足（Permission denied）。启动运行命令之后会安装模型权重文件，十几个G，还是很大的。"
keywords: "【部署】ubuntu部署olmOCR"
categories: ['Pdf']
tags: ['运维', 'Ubuntu', 'Linux']
artid: "146199229"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146199229
    alt: "部署ubuntu部署olmOCR"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146199229
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146199229
cover: https://bing.ee123.net/img/rand?artid=146199229
image: https://bing.ee123.net/img/rand?artid=146199229
img: https://bing.ee123.net/img/rand?artid=146199229
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     【部署】ubuntu部署olmOCR
    </h1>
   </div>
   <div class="article-resource-info-box">
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <p>
    </p>
    <p>
     项目地址：
     <br/>
     <a href="https://github.com/allenai/olmocr">
      https://github.com/allenai/olmocr
     </a>
    </p>
    <h2>
     <a id="_7">
     </a>
     一、安装依赖
    </h2>
    <hr/>
    <pre><code class="prism language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> update
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> poppler-utils ttf-mscorefonts-installer msttcorefonts fonts-crosextra-caladea fonts-crosextra-carlito gsfonts lcdf-typetools

</code></pre>
    <h2>
     <a id="condasglang_16">
     </a>
     二、安装conda新环境和sglang
    </h2>
    <hr/>
    <pre><code class="prism language-bash">conda create <span class="token parameter variable">-n</span> olmocr <span class="token assign-left variable">python</span><span class="token operator">=</span><span class="token number">3.11</span>
conda activate olmocr

<span class="token function">git</span> clone https://github.com/allenai/olmocr.git
<span class="token builtin class-name">cd</span> olmocr
<span class="token comment"># If running on CPU, run this:</span>
pip <span class="token function">install</span> <span class="token parameter variable">-e</span> <span class="token builtin class-name">.</span>
<span class="token comment"># 如果没有权限，可以安装到用户目录下</span>
pip <span class="token function">install</span> <span class="token parameter variable">--user</span> <span class="token parameter variable">-e</span> <span class="token builtin class-name">.</span>

<span class="token comment"># If running on GPU, run this instead:</span>
pip <span class="token function">install</span> <span class="token parameter variable">-e</span> .<span class="token punctuation">[</span>gpu<span class="token punctuation">]</span> --find-links https://flashinfer.ai/whl/cu124/torch2.4/flashinfer/
</code></pre>
    <p>
     GPU下使用还需要安装sglang
    </p>
    <pre><code class="prism language-bash">pip <span class="token function">install</span> <span class="token parameter variable">--upgrade</span> pip
pip <span class="token function">install</span> uv
uv pip <span class="token function">install</span> <span class="token string">"sglang[all]&gt;=0.4.4"</span> --find-links https://flashinfer.ai/whl/cu124/torch2.5/flashinfer-python
</code></pre>
    <p>
     如果网络问题装不上也可以手动安装wheel，下载好wheel文件之后，sftp传到服务器上，然后直接下载
    </p>
    <pre><code class="prism language-bash"><span class="token comment"># 在这里下载</span>
https://github.com/flashinfer-ai/flashinfer/releases/download/v0.2.3/flashinfer_python-0.2.3+cu124torch2.5-cp38-abi3-linux_x86_64.whl
</code></pre>
    <p>
     特别慢这边
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/19942586eece43b9a46dcc36702890f0.png">
      <br/>
      安装好之后再安装sglang
     </img>
    </p>
    <pre><code class="prism language-bash">uv pip <span class="token function">install</span> <span class="token string">"sglang[all]&gt;=0.4.4"</span>
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/ea25df75e5444377a66915bc28dcb8a5.png">
      <br/>
      启动运行命令之后会安装模型权重文件，十几个G，还是很大的。
     </img>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/b70f0e1cfdcc4b8da8667a519a53f962.png"/>
    </p>
    <h2>
     <a id="PDF_57">
     </a>
     三、PDF解析
    </h2>
    <h3>
     <a id="1__58">
     </a>
     1. 运行
    </h3>
    <pre><code class="prism language-bash">python <span class="token parameter variable">-m</span> olmocr.pipeline ./localworkspace <span class="token parameter variable">--pdfs</span> tests/gnarly_pdfs/horribleocr.pdf
</code></pre>
    <p>
     测试了两个pdf文件
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/79b8ae2350f34bab9cfa495f3055735e.png">
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/01949133e5d44107a4d9e4a49375b1ed.png"/>
     </img>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/aa6aa54957fb4d9fbbf97fd517645589.png">
      <br/>
      输出的是.jsonl，所以看起来并没有换行，看的不清楚
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/5986d5e7bbd245ce914f8517a465c7e6.png"/>
     </img>
    </p>
    <p>
     转换多个PDF的命令
    </p>
    <pre><code class="prism language-bash">python <span class="token parameter variable">-m</span> olmocr.pipeline ./localworkspace <span class="token parameter variable">--pdfs</span> tests/gnarly_pdfs/*.pdf
</code></pre>
    <h3>
     <a id="2__PDF__75">
     </a>
     2. 原始 PDF 并排查看结果
    </h3>
    <pre><code class="prism language-bash">python <span class="token parameter variable">-m</span> olmocr.viewer.dolmaviewer localworkspace/results/output_*.jsonl
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/42eeba8cc0694ddeba89fd2c6e2465ec.png"/>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/99464bdc56d243a6aeca00d3564e08b8.png"/>
    </p>
    <h3>
     <a id="3__83">
     </a>
     3. 更换模型
    </h3>
    <p>
     命令中可以增加模型的更换
    </p>
    <pre><code class="prism language-bash">  <span class="token parameter variable">--model</span> MODEL         List of paths where you can <span class="token function">find</span> the model to convert this pdf. You can specify several different paths here, and the script will try to use the
                        one <span class="token function">which</span> is fastest to access
</code></pre>
    <h2>
     <a id="_91">
     </a>
     四、可能出现的问题
    </h2>
    <hr/>
    <h3>
     <a id="1note_This_error_originates_from_a_subprocess_and_is_likely_not_a_problem_with_pip_93">
     </a>
     1.note: This error originates from a subprocess, and is likely not a problem with pip.
    </h3>
    <p>
     从报错信息来看，问题出在 pip install -e . 时无法创建 olmocr.egg-info 目录，原因是 权限不足（Permission denied）。以下是解决方法：
    </p>
    <ol>
     <li>
      检查当前用户权限
      <br/>
      确保你对项目目录（/data/huyuqiang/llf/ocr/olmocr）有写权限。可以通过以下命令检查：
     </li>
    </ol>
    <pre><code class="prism language-bash"><span class="token function">ls</span> <span class="token parameter variable">-ld</span> /data/huyuqiang/llf/ocr/olmocr
</code></pre>
    <p>
     如果权限不足，可以尝试修改目录权限：
    </p>
    <pre><code class="prism language-bash"><span class="token function">sudo</span> <span class="token function">chown</span> <span class="token parameter variable">-R</span> <span class="token environment constant">$USER</span><span class="token builtin class-name">:</span><span class="token environment constant">$USER</span> /data/huyuqiang/llf/ocr/olmocr
<span class="token function">sudo</span> <span class="token function">chmod</span> <span class="token parameter variable">-R</span> u+rw /data/huyuqiang/llf/ocr/olmocr
</code></pre>
    <ol start="2">
     <li>
      使用虚拟环境
      <br/>
      如果你没有使用虚拟环境，建议创建一个虚拟环境并激活它，这样可以避免权限问题：
     </li>
    </ol>
    <pre><code class="prism language-bash">python <span class="token parameter variable">-m</span> venv venv  <span class="token comment"># 创建虚拟环境</span>
<span class="token builtin class-name">source</span> venv/bin/activate  <span class="token comment"># 激活虚拟环境</span>
pip <span class="token function">install</span> <span class="token parameter variable">-e</span> <span class="token builtin class-name">.</span>  <span class="token comment"># 在虚拟环境中安装</span>
</code></pre>
    <ol start="3">
     <li>
      指定 --user 选项
      <br/>
      如果你没有管理员权限，可以尝试使用 --user 选项安装到用户目录：
     </li>
    </ol>
    <pre><code class="prism language-bash">pip <span class="token function">install</span> <span class="token parameter variable">--user</span> <span class="token parameter variable">-e</span> <span class="token builtin class-name">.</span>
</code></pre>
    <h3>
     <a id="2PDF_118">
     </a>
     2.转换单个PDF命令运行时
    </h3>
    <p>
     File “/data/huyuqiang/llf/ocr/olmocr/olmocr/pipeline.py”, line 26, in
     <br/>
     import torch
     <br/>
     File “/data/huyuqiang/anaconda3/envs/olmocr/lib/python3.11/site-packages/torch/
     <strong>
      init
     </strong>
     .py”, line 367, in
     <br/>
     from torch._C import * # noqa: F403
     <br/>
     ^^^^^^^^^^^^^^^^^^^^^^
     <br/>
     ImportError: libcupti.so.12: cannot open shared object file: No such file or directory
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/52db720ce41a4876909c0b48e5ee2bc0.png"/>
     <br/>
     这个错误表示系统找不到 CUDA Profiling Tools Interface (CUPTI) 库文件 libcupti.so.12。这是 CUDA 工具包的一部分，通常在安装 CUDA toolkit 时应该包含这个库。
    </p>
    <pre><code class="prism language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> cuda-toolkit-12-0
<span class="token comment"># 编辑 ~/.bashrc 文件</span>
<span class="token builtin class-name">echo</span> <span class="token string">'export LD_LIBRARY_PATH=/usr/local/cuda/extras/CUPTI/lib64:$LD_LIBRARY_PATH'</span> <span class="token operator">&gt;&gt;</span> ~/.bashrc
<span class="token builtin class-name">source</span> ~/.bashrc
<span class="token function">sudo</span> <span class="token function">ln</span> <span class="token parameter variable">-s</span> /usr/local/cuda/extras/CUPTI/lib64/libcupti.so.12 /usr/local/lib/libcupti.so.12
</code></pre>
    <h3>
     <a id="3ImportError_libncclso2_cannot_open_shared_object_file_No_such_file_or_directory_137">
     </a>
     3.ImportError: libnccl.so.2: cannot open shared object file: No such file or directory
    </h3>
    <p>
     这个错误表明在运行代码时，PyTorch 无法找到 libnccl.so.2 这个共享库文件。libnccl.so.2 是 NVIDIA 的 NCCL（NVIDIA Collective Communications Library）库的一部分，通常用于多 GPU 通信。以下是解决这个问题的步骤：
    </p>
    <ol>
     <li>
      检查是否安装了 NCCL
      <br/>
      NCCL 是 NVIDIA 的库，通常与 CUDA 一起安装。你可以通过以下命令检查是否安装了 NCCL：
     </li>
    </ol>
    <pre><code class="prism language-bash"><span class="token function">ls</span> /usr/lib/x86_64-linux-gnu/libnccl*

</code></pre>
    <ol start="2">
     <li>
      安装 NCCL
      <br/>
      如果 NCCL 未安装，可以通过以下步骤安装：
     </li>
    </ol>
    <p>
     方法 1：通过 NVIDIA 官方安装
     <br/>
     访问 NCCL 下载页面。
    </p>
    <p>
     根据你的系统（Ubuntu/CentOS 等）和 CUDA 版本下载对应的 NCCL 包。
    </p>
    <p>
     安装下载的包。例如，对于 Ubuntu：
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/24a55d0e12f54403bee33aba5a888ba4.png"/>
    </p>
    <pre><code class="prism language-bash">conda <span class="token function">install</span> <span class="token parameter variable">-c</span> nvidia nccl
</code></pre>
    <h3>
     <a id="4sglang_161">
     </a>
     4.已经执行了正常命令，但是需要下载sglang
    </h3>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/4b1a3e5bb30f408584ff7984f47fc7dd.png"/>
     <br/>
     <a href="https://docs.sglang.ai/start/install.html" rel="nofollow">
      https://docs.sglang.ai/start/install.html
     </a>
    </p>
    <pre><code class="prism language-bash">pip <span class="token function">install</span> <span class="token parameter variable">--upgrade</span> pip
pip <span class="token function">install</span> uv
uv pip <span class="token function">install</span> <span class="token string">"sglang[all]&gt;=0.4.4"</span> --find-links https://flashinfer.ai/whl/cu124/torch2.5/flashinfer-python
</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f34333932303833382f:61727469636c652f64657461696c732f313436313939323239" class_="artid" style="display:none">
 </p>
</div>


