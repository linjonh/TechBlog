---
layout: post
title: "Hi3516DV300-移植Qt"
date: 2025-03-12 15:36:02 +0800
description: "Hi3516DV300 移植 Qt"
keywords: "Hi3516DV300 移植Qt"
categories: ['海思方案']
tags: ['嵌入式硬件', 'Qt', 'Arm']
artid: "146154627"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146154627
    alt: "Hi3516DV300-移植Qt"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146154627
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146154627
cover: https://bing.ee123.net/img/rand?artid=146154627
image: https://bing.ee123.net/img/rand?artid=146154627
img: https://bing.ee123.net/img/rand?artid=146154627
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Hi3516DV300 移植Qt
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <p>
     之前在NXP的板子上，移植过了
     <a href="https://blog.csdn.net/pyh1322712308/article/details/145656108" title="ARM Linux 移植 tslib、Qt和OpenCV_linux qt tslib-CSDN博客">
      ARM Linux 移植 tslib、Qt和OpenCV_linux qt tslib-CSDN博客
     </a>
    </p>
    <p>
     不过海思移植Qt时还是有不少问题的。
    </p>
    <h2>
     一、Qt 下载与编译
    </h2>
    <h3>
     1. Qt 下载
    </h3>
    <p>
     <a href="https://download.qt.io/archive/qt/5.12/5.12.9/single/" rel="nofollow" title="Index of /archive/qt/5.12/5.12.9/single">
      Index of /archive/qt/5.12/5.12.9/single
     </a>
    </p>
    <pre><code>tar -xf qt-everywhere-src-5.12.9.tar.xz
</code></pre>
    <h3>
     2. 修改交叉编译器
    </h3>
    <p>
     将原来交叉编译的 qmake.conf 复制一份
    </p>
    <pre><code>cd qt-everywhere-src-5.12.9/ 
cp -r qtbase/mkspecs/linux-arm-gnueabi-g++ qtbase/mkspecs/arm-himix200-linux-g++
vim qtbase/mkspecs/arm-himix200-linux-g++/qmake.conf </code></pre>
    <p>
     修改的内容如下：
    </p>
    <pre><code>#
# qmake configuration for building with arm-linux-gnueabi-g++
#

MAKEFILE_GENERATOR      = UNIX
CONFIG                 += incremental
QMAKE_INCREMENTAL_STYLE = sublib

include(../common/linux.conf)
include(../common/gcc-base-unix.conf)
include(../common/g++-unix.conf)

# modifications to g++.conf
QMAKE_CC                = arm-himix200-linux-gcc
QMAKE_CXX               = arm-himix200-linux-g++
QMAKE_LINK              = arm-himix200-linux-g++
QMAKE_LINK_SHLIB        = arm-himix200-linux-g++

# modifications to linux.conf
QMAKE_AR                = arm-himix200-linux-ar cqs
QMAKE_OBJCOPY           = arm-himix200-linux-objcopy
QMAKE_STRIP             = arm-himix200-linux-strip

load(qt_config)

# modifications to gcc-base.conf
QMAKE_CFLAGS_RELEASE += -mcpu=cortex-a7 -mfloat-abi=softfp -mfpu=neon-vfpv4
QMAKE_CXXFLAGS_RELEASE += -mcpu=cortex-a7 -mfloat-abi=softfp -mfpu=neon-vfpv4 -fpermissive
</code></pre>
    <h3>
     3. 编译前的配置
    </h3>
    <pre><code>vim autoconfigure.sh</code></pre>
    <p>
     内容如下：
    </p>
    <pre><code class="language-bash">./configure -prefix /home/prover/linux/arm-qt \
-opensource \
-confirm-license \
-release \
-strip \
-no-eglfs -linuxfb \
-qt-zlib \
-no-gif \
-qt-libpng \
-qt-libjpeg \
-qt-freetype \
-no-rpath \
-no-pch \
-no-avx \
-no-openssl \
-no-cups \
-no-dbus \
-no-pkg-config \
-no-glib \
-no-iconv \
-xplatform arm-himix200-linux-g++ \    
-no-opengl \
-nomake examples \
-nomake tools \
-no-sqlite \
-skip qtgamepad \
-skip qtandroidextras \
-skip qtmacextras \
-skip qtx11extras \
-skip qtsensors \
-skip qtserialbus \
-skip qtserialport \
-skip qtwebengine \
-skip qtwebchannel \
-skip qtwebsockets \
-skip qtlocation \
-skip qtquickcontrols \
-skip qtpurchasing \
-skip qtconnectivity \
-skip qtscxml \
-skip qtxmlpatterns \
-skip qtnetworkauth \
-skip qtspeech \
-skip qtscript \
-skip qtremoteobjects \
-skip qtcharts \
-skip qtdatavis3d \
-skip qtwebview \
-make libs \
-make examples \
-nomake tools -nomake tests \
-gui \
-widgets \
-dbus-runtime \
--glib=no \
--iconv=no \
--pcre=qt \
--zlib=qt \
-no-openssl \
--freetype=qt \
--harfbuzz=qt \
-no-opengl \
-linuxfb \
--xcb=no \
-tslib \
--libpng=qt \
--libjpeg=qt \
--sqlite=qt \
-plugin-sql-sqlite \
-I/home/prover/linux/tslib-1.21/arm-tslib/include \
-L/home/prover/linux/tslib-1.21/arm-tslib/lib \
-recheck-all</code></pre>
    <p>
     记得交叉编译器改成海思的：-xplatform arm-himix200-linux-g++ \
    </p>
    <p>
     然后运行：
    </p>
    <pre><code>chmod +x autoconfigure.sh
sudo apt-get install g++ // 配置前请先安装 g++ 
./autoconfigure.sh </code></pre>
    <p>
    </p>
    <h3>
     4. 编译
    </h3>
    <pre><code>make -j8
make install</code></pre>
    <p>
     打包
    </p>
    <pre><code>sudo tar -jcf ./arm-qt.tar.bz2 shared
</code></pre>
    <p>
    </p>
    <h2>
     二、移植Qt
    </h2>
    <h3>
     1. SD卡挂载
    </h3>
    <p>
     由于 Nor flash 的大小就那么32M，肯定要把Qt运行库移植到SD卡上。
    </p>
    <pre><code class="language-bash">mkdir -p /sdcard
mount /dev/mmcblk0p1 /sdcard</code></pre>
    <p>
    </p>
    <p>
     可以设置开机自动挂载：
    </p>
    <p>
     <img alt="" height="160" src="https://i-blog.csdnimg.cn/direct/c14e8feadb5646bb969703ec8d80bb87.png" width="745"/>
    </p>
    <p>
    </p>
    <h3>
     2. 移植到SD卡
    </h3>
    <pre><code class="language-bash">sudo cp arm-qt.tar.bz2 /home/prover/linux/nfs/rootfs_glibc/sdcard/
</code></pre>
    <p>
     配置环境变量 /etc/profile
    </p>
    <pre><code class="language-bash">export QT_QPA_PLATFORM_PLUGIN_PATH=/sdcard/arm-qt/plugins
export QT_QPA_FONTDIR=/sdcard/arm-qt/fonts
export LD_LIBRARY_PATH=/sdcard/arm-qt
export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/sdcard/arm-qt/lib
export QT_QPA_PLATFORM=linuxfb:tty=/dev/fb0
export QT_QPA_PLATFORM=linuxfb:fb=/dev/fb0:size=1920x1080:offset=0x0:nographicsmodeswitc
</code></pre>
    <p>
    </p>
    <h2>
     三、测试Qt应用
    </h2>
    <h3>
     1. 编译demo
    </h3>
    <pre><code>cd qt-everywhere-src-5.12.9/qtbase/examples/widgets/graphicsview/collidingmice
../../../../bin/qmake
make</code></pre>
    <h3>
     2. 初始化
    </h3>
    <p>
     和之前移植 tslib 一样，海思是会对 /dev/fb0 进行封装的。这边改动 sample_tde.c 的源码，原来的 tde 是要将背景图和一些图片循环输出到屏幕的，这边我们直接不要这么做，而是直接刷新屏幕即可。
    </p>
    <p>
    </p>
    <h4>
     2.1 修改分辨率
    </h4>
    <p>
     我设置的是 1920*1080，这里的分辨率其实就是物理分辨率了。
    </p>
    <p>
     <img alt="" height="131" src="https://i-blog.csdnimg.cn/direct/2d96110a49df43ef801349e9fa1109f0.png" width="497"/>
    </p>
    <p>
     来到函数
     <span style="color:#fe2c24">
      static HI_VOID circumrotate(HI_U32 u32CurOnShow)
     </span>
    </p>
    <p>
     <span style="color:#0d0016">
      我们直接全部删了，换成下面这段：
     </span>
    </p>
    <pre><code class="language-cpp">static HI_VOID circumrotate(HI_U32 u32CurOnShow)
{
    struct fb_var_screeninfo stVarInfo; // **声明屏幕信息变量**
    
    // **获取当前屏幕参数**
    if (ioctl(g_s32Fd, FBIOGET_VSCREENINFO, &amp;stVarInfo) &lt; 0)  
    {
        TDE_PRINT("Failed to get screen info!\n");
        return;
    }

    // **执行屏幕刷新**
    if (ioctl(g_s32Fd, FBIOPAN_DISPLAY, &amp;stVarInfo) &lt; 0)
    {
        TDE_PRINT("process frame buffer device error\n");
        return;
    }

    getchar();  // **等待用户按键**
    g_s32FrameNum++;  // **递增帧数**

    return;
}
</code></pre>
    <p>
    </p>
    <h3>
     3. 运行测试
    </h3>
    <p>
     这边还编译了个demo ，animatedtiles。
    </p>
    <pre><code class="language-bash">./sample_tde 0 &amp;
./collidingmice
./animatedtiles</code></pre>
    <p>
     <img alt="" height="487" src="https://i-blog.csdnimg.cn/direct/1ad46847a01241218389ed6b9f942088.png" width="896"/>
    </p>
    <p>
     <img alt="" height="1279" src="https://i-blog.csdnimg.cn/direct/70f401a2fbce4e5cb36d906b08dfeceb.jpeg" width="1710"/>
    </p>
    <p>
    </p>
    <h2>
     小结
    </h2>
    <p>
     后面开发的思路很明显了，要学习使用海思的mpp软件包进行开发视频。而既然移植了Qt，就将mpp也集成一块。后面想要开发一个相机的UI界面，按钮控件实现拍照和直播功能；当然还要有目标检测的话，就更好了。
    </p>
   </div>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f:672e6373646e2e6e65742f707968313332323731323330382f:61727469636c652f64657461696c732f313436313534363237" class_="artid" style="display:none">
 </p>
</div>


