---
layout: post
title: "17-实现简洁架构的-Biz-层"
date: 2025-03-12 22:54:30 +0800
description: "本节课介绍如何实现简洁架构的 Biz 层。"
keywords: "17 | 实现简洁架构的 Biz 层"
categories: ['项目开发极速入门课', 'Go']
tags: ['人工智能', '云原生', 'Kubernetes', 'Golang', 'Ai']
artid: "146217238"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146217238
    alt: "17-实现简洁架构的-Biz-层"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146217238
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146217238
cover: https://bing.ee123.net/img/rand?artid=146217238
image: https://bing.ee123.net/img/rand?artid=146217238
img: https://bing.ee123.net/img/rand?artid=146217238
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     17 | 实现简洁架构的 Biz 层
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <blockquote>
     <p>
      <strong>
       提示：
      </strong>
     </p>
     <ul>
      <li>
       所有体系课见专栏：
       <a href="https://blog.csdn.net/lnxfei/category_12907774.html">
        Go 项目开发极速入门实战课
       </a>
       ；
      </li>
      <li>
       欢迎加入
       <a href="https://konglingfei.com" rel="nofollow">
        云原生 AI 实战
       </a>
       星球，12+ 高质量体系课、20+ 高质量实战项目助你在 AI 时代建立技术竞争力（聚焦于 Go、云原生、AI Infra）；
      </li>
      <li>
       本节课最终源码位于 fastgo 项目的
       <a href="https://github.com/onexstack/fastgo/tree/feature/s13">
        feature/s13
       </a>
       分支；
       <br/>
       更详细的课程版本见：
       <a href="https://konglingfei.com/cloudai/catalog/intermediate.html" rel="nofollow">
        Go 项目开发中级实战课
       </a>
       ：26 | 业务实现（3）：实现 Biz 层代码
      </li>
     </ul>
    </blockquote>
    <p>
     Biz 层依赖 Store 层，所以实现了 Store 层代码之后，便可以实现 Biz 层代码。Biz 层代码，主要用来实现系统中 REST 资源的各类业务操作，例如用户资源的增删改查等。
    </p>
    <p>
     整个 fastgo 项目的设计较为规范，规范化的项目设计带来的优点之一是开发方式的一致性和开发效率的提升。fastgo 项目 Biz 层的开发方式与 Store 层的开发方式保持一致。
    </p>
    <h3>
     <a id="API__9">
     </a>
     API 接口定义
    </h3>
    <p>
     在开发 Biz 层代码之前，需要先定义好 API 接口的请求入参和返回参数。为此，新建了
     <a href="https://github.com/onexstack/fastgo/blob/feature/s13/pkg/api/apiserver/v1/post.go">
      pkg/api/apiserver/v1/post.go
     </a>
     文件和
     <a href="https://github.com/onexstack/fastgo/blob/feature/s13/pkg/api/apiserver/v1/user.go">
      pkg/api/apiserver/v1/user.go
     </a>
     文件，分别保存了用户接口和博客接口的请求入参和返回参数。
    </p>
    <p>
     因为请求入参和返回参数（例如
     <code>
      CreateUserRequest
     </code>
     和
     <code>
      CreateUserResponse
     </code>
     ）会提供给接口调用方（客户端），所以需要将接口定义保存在 pkg/api 目录下。另外，考虑到未来 fastgo 可能会加入多个服务，每个服务都有自己的 API 定义，fastgo 项目选择了将每个服务的 API 定义保存在独立的服务目录下，例如 pkg/api/apiserver。
    </p>
    <p>
     考虑到未来 API 接口的版本升级，fastgo 项目将接口进行了版本化处理，v1 版本的接口保存在 pkg/api/apiserver/v1 目录下，v2 版本的接口保存在 pkg/api/apiserver/v2 目录下。
    </p>
    <h3>
     <a id="IBiz__15">
     </a>
     IBiz 接口定义及实现
    </h3>
    <p>
     Biz 层代码保存
     <a href="https://github.com/onexstack/fastgo/blob/feature/s13/internal/apiserver/biz/biz.go">
      internal/apiserver/biz/biz.go
     </a>
     文件中，接口名为
     <a href="https://github.com/onexstack/fastgo/blob/feature/s13/internal/apiserver/biz/biz.go#L21">
      IBiz
     </a>
     ，定义如下：
    </p>
    <pre><code class="prism language-go"><span class="token comment">// IBiz 定义了业务层需要实现的方法.</span>
<span class="token keyword">type</span> IBiz <span class="token keyword">interface</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 获取用户业务接口.</span>
    <span class="token function">UserV1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> userv1<span class="token punctuation">.</span>UserBiz
    <span class="token comment">// 获取帖子业务接口.</span>
    <span class="token function">PostV1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> postv1<span class="token punctuation">.</span>PostBiz
    <span class="token comment">// 获取帖子业务接口（V2版本）.</span>
    <span class="token comment">// PostV2() post.PostBiz</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     <code>
      IBiz
     </code>
     接口包含了 User 资源和 Post 资源 v1 版本的接口，通过抽象工厂设计模式返回对应资源的接口。在 Go 项目开发中，业务层代码的代码量通常最大、变动最频繁，并且随着项目的迭代，可能会出现不兼容的变更。
    </p>
    <p>
     这时需要对外暴露 v2 版本的 API 接口。因此，为了提高代码的可维护性并保留未来的扩展能力，Biz 层代码的存放结构如下：
    </p>
    <pre><code class="prism language-bash">internal/apiserver/biz/
├── biz.go
├── v1/ <span class="token comment"># v1 版本代码实现</span>
│   ├── post/ <span class="token comment"># 提高代码可维护性，不同资源的代码实现分别存放在不同的目录中</span>
│   │   └── post.go
│   └── user/
│       └── user.go
└── v2/ <span class="token comment"># 保留扩展能力：v2 代码保存目录</span>
</code></pre>
    <p>
     上述代码，将不同版本的代码保存在不同的版本化目录中，不同 REST 资源的业务逻辑实现保存在跟资源对应的目录中。不同资源的业务逻辑代码均在其对应的目录中实现，可以在目录级别隔离不同资源的代码实现，有利于提高代码的稳定性，并降低维护的复杂度。
    </p>
    <p>
     Biz 层依赖于 Store 层的实现，所以在创建
     <code>
      IBiz
     </code>
     实例时，需要传入
     <code>
      IStore
     </code>
     类型的实例，
     <code>
      IBiz
     </code>
     实例由
     <code>
      NewBiz
     </code>
     函数创建：
    </p>
    <pre><code class="prism language-go"><span class="token comment">// biz 是 IBiz 的一个具体实现.</span>
<span class="token keyword">type</span> biz <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
    store store<span class="token punctuation">.</span>IStore
<span class="token punctuation">}</span>

<span class="token comment">// 确保 biz 实现了 IBiz 接口.</span>
<span class="token keyword">var</span> <span class="token boolean">_</span> IBiz <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>biz<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span>

<span class="token comment">// NewBiz 创建一个 IBiz 类型的实例.</span>
<span class="token keyword">func</span> <span class="token function">NewBiz</span><span class="token punctuation">(</span>store store<span class="token punctuation">.</span>IStore<span class="token punctuation">)</span> <span class="token operator">*</span>biz <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>biz<span class="token punctuation">{<!-- --></span>store<span class="token punctuation">:</span> store<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     <code>
      IBiz
     </code>
     的实现跟
     <code>
      IStore
     </code>
     的实现是保持一致，其他代码，本节不再详解。
    </p>
    <h3>
     <a id="UserBiz__66">
     </a>
     UserBiz 接口定义及实现
    </h3>
    <p>
     User 资源的 Biz 层代码实现位于
     <a href="https://github.com/onexstack/fastgo/blob/feature/s13/internal/apiserver/biz/v1/user/user.go">
      internal/apiserver/biz/v1/user/user.go
     </a>
     文件中，其接口定义为
     <a href="https://github.com/onexstack/fastgo/blob/feature/s13/internal/apiserver/biz/v1/user/user.go#L29">
      UserBiz
     </a>
     ，代码如下：
    </p>
    <pre><code class="prism language-go"><span class="token comment">// UserBiz 定义处理用户请求所需的方法.</span>
<span class="token keyword">type</span> UserBiz <span class="token keyword">interface</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">Create</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> rq <span class="token operator">*</span>apiv1<span class="token punctuation">.</span>CreateUserRequest<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>apiv1<span class="token punctuation">.</span>CreateUserResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
    <span class="token function">Update</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> rq <span class="token operator">*</span>apiv1<span class="token punctuation">.</span>UpdateUserRequest<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>apiv1<span class="token punctuation">.</span>UpdateUserResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
    <span class="token function">Delete</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> rq <span class="token operator">*</span>apiv1<span class="token punctuation">.</span>DeleteUserRequest<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>apiv1<span class="token punctuation">.</span>DeleteUserResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
    <span class="token function">Get</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> rq <span class="token operator">*</span>apiv1<span class="token punctuation">.</span>GetUserRequest<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>apiv1<span class="token punctuation">.</span>GetUserResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
    <span class="token function">List</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> rq <span class="token operator">*</span>apiv1<span class="token punctuation">.</span>ListUserRequest<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>apiv1<span class="token punctuation">.</span>ListUserResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>

    UserExpansion
<span class="token punctuation">}</span>

<span class="token comment">// UserExpansion 定义用户操作的扩展方法.</span>
<span class="token keyword">type</span> UserExpansion <span class="token keyword">interface</span> <span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     <code>
      UserBiz
     </code>
     接口中的方法，同样也分为了两大类：标准资源 CURD 接口和扩展接口，扩展接口中实现了用户登录、Token 刷新、密码修改等方法。实现
     <code>
      UserBiz
     </code>
     接口的 Go 结构体是
     <code>
      *userBiz
     </code>
     。
    </p>
    <h4>
     <a id="Create__87">
     </a>
     创建用户：Create 方法实现
    </h4>
    <p>
     <code>
      userBiz
     </code>
     结构体的
     <code>
      Create
     </code>
     方法实现如下：
    </p>
    <pre><code class="prism language-go"><span class="token comment">// Create 实现 UserBiz 接口中的 Create 方法.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>userBiz<span class="token punctuation">)</span> <span class="token function">Create</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> rq <span class="token operator">*</span>apiv1<span class="token punctuation">.</span>CreateUserRequest<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>apiv1<span class="token punctuation">.</span>CreateUserResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">var</span> userM model<span class="token punctuation">.</span>User
    <span class="token boolean">_</span> <span class="token operator">=</span> copier<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>userM<span class="token punctuation">,</span> rq<span class="token punctuation">)</span>

    <span class="token keyword">if</span> err <span class="token operator">:=</span> b<span class="token punctuation">.</span>store<span class="token punctuation">.</span><span class="token function">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>userM<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token operator">&amp;</span>apiv1<span class="token punctuation">.</span>CreateUserResponse<span class="token punctuation">{<!-- --></span>UserID<span class="token punctuation">:</span> userM<span class="token punctuation">.</span>UserID<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     为了提高开发效率，减少不必要的代码量，
     <code>
      Create
     </code>
     方法使用了
     <code>
      [github.com/jinzhu/copier](https://github.com/jinzhu/copier)
     </code>
     的
     <code>
      Copy
     </code>
     函数给目标结构体变量
     <code>
      userM
     </code>
     赋值。
    </p>
    <p>
     在
     <code>
      Create
     </code>
     方法中，通过
     <code>
      b.store.User().Create(ctx, &amp;userM)
     </code>
     方法调用，将数据保存在数据库中。
    </p>
    <p>
     在 Go 项目开发中，数据库禁止保存明文密码。用户密码在入库前需要进行加密处理。为了加密明文密码字符串，fastgo 引入了
     <code>
      github.com/onexstack/onexstack/pkg/auth
     </code>
     包，auth 包中的
     <code>
      Encrypt
     </code>
     函数可以用来加密一个明文密码字符串。
    </p>
    <p>
     因为在入库前都需要对明文密码进行加密，所以，很自然的想到可以通过实现 GORM 框架的
     <code>
      BeforeCreate
     </code>
     钩子来实现。修改
     <a href="https://github.com/onexstack/fastgo/blob/feature/s13/internal/apiserver/model/hook.go">
      internal/apiserver/model/hook.go
     </a>
     文件，添加以下代码：
    </p>
    <pre><code class="prism language-go"><span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token operator">...</span>
    <span class="token string">"github.com/onexstack/onexstack/pkg/auth"</span>
<span class="token punctuation">)</span>

<span class="token comment">// BeforeCreate 在创建数据库记录之前加密明文密码.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>User<span class="token punctuation">)</span> <span class="token function">BeforeCreate</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// Encrypt the user password.</span>
    <span class="token keyword">var</span> err <span class="token builtin">error</span>
    m<span class="token punctuation">.</span>Password<span class="token punctuation">,</span> err <span class="token operator">=</span> auth<span class="token punctuation">.</span><span class="token function">Encrypt</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>Password<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> err
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="Update__131">
     </a>
     更新用户：Update 方法实现
    </h4>
    <p>
     <code>
      userBiz
     </code>
     结构体的
     <code>
      Update
     </code>
     方法实现如下：
    </p>
    <pre><code class="prism language-go"><span class="token comment">// Update 实现 UserBiz 接口中的 Update 方法.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>userBiz<span class="token punctuation">)</span> <span class="token function">Update</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> rq <span class="token operator">*</span>apiv1<span class="token punctuation">.</span>UpdateUserRequest<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>apiv1<span class="token punctuation">.</span>UpdateUserResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    userM<span class="token punctuation">,</span> err <span class="token operator">:=</span> b<span class="token punctuation">.</span>store<span class="token punctuation">.</span><span class="token function">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> where<span class="token punctuation">.</span><span class="token function">T</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> rq<span class="token punctuation">.</span>Username <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
        userM<span class="token punctuation">.</span>Username <span class="token operator">=</span> <span class="token operator">*</span>rq<span class="token punctuation">.</span>Username
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> rq<span class="token punctuation">.</span>Email <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
        userM<span class="token punctuation">.</span>Email <span class="token operator">=</span> <span class="token operator">*</span>rq<span class="token punctuation">.</span>Email
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> rq<span class="token punctuation">.</span>Nickname <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
        userM<span class="token punctuation">.</span>Nickname <span class="token operator">=</span> <span class="token operator">*</span>rq<span class="token punctuation">.</span>Nickname
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> rq<span class="token punctuation">.</span>Phone <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
        userM<span class="token punctuation">.</span>Phone <span class="token operator">=</span> <span class="token operator">*</span>rq<span class="token punctuation">.</span>Phone
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> err <span class="token operator">:=</span> b<span class="token punctuation">.</span>store<span class="token punctuation">.</span><span class="token function">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> userM<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token operator">&amp;</span>apiv1<span class="token punctuation">.</span>UpdateUserResponse<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     在更新用户时，根据是否传入待更新的字段来判断是否更新该字段。这样的设计方式，可以通过一个更新接口实现字段的选择性更新。
    </p>
    <h4>
     <a id="List__164">
     </a>
     查询用户列表：List 方法实现
    </h4>
    <p>
     <code>
      userBiz
     </code>
     结构体的
     <code>
      List
     </code>
     方法实现如下述代码所示：
    </p>
    <pre><code class="prism language-go"><span class="token comment">// List 实现 UserBiz 接口中的 List 方法.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>userBiz<span class="token punctuation">)</span> <span class="token function">List</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> rq <span class="token operator">*</span>apiv1<span class="token punctuation">.</span>ListUserRequest<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>apiv1<span class="token punctuation">.</span>ListUserResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    whr <span class="token operator">:=</span> where<span class="token punctuation">.</span><span class="token function">P</span><span class="token punctuation">(</span><span class="token function">int</span><span class="token punctuation">(</span>rq<span class="token punctuation">.</span>Offset<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">int</span><span class="token punctuation">(</span>rq<span class="token punctuation">.</span>Limit<span class="token punctuation">)</span><span class="token punctuation">)</span>
    count<span class="token punctuation">,</span> userList<span class="token punctuation">,</span> err <span class="token operator">:=</span> b<span class="token punctuation">.</span>store<span class="token punctuation">.</span><span class="token function">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">List</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> whr<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>

    <span class="token keyword">var</span> m sync<span class="token punctuation">.</span>Map
    eg<span class="token punctuation">,</span> ctx <span class="token operator">:=</span> errgroup<span class="token punctuation">.</span><span class="token function">WithContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>

    <span class="token comment">// 设置最大并发数量为常量 MaxConcurrency</span>
    eg<span class="token punctuation">.</span><span class="token function">SetLimit</span><span class="token punctuation">(</span>known<span class="token punctuation">.</span>MaxErrGroupConcurrency<span class="token punctuation">)</span>

    <span class="token comment">// 使用 goroutine 提高接口性能</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> user <span class="token operator">:=</span> <span class="token keyword">range</span> userList <span class="token punctuation">{<!-- --></span>
        eg<span class="token punctuation">.</span><span class="token function">Go</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">select</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">case</span> <span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">return</span> <span class="token boolean">nil</span>
                <span class="token keyword">default</span><span class="token punctuation">:</span>
                count<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> b<span class="token punctuation">.</span>store<span class="token punctuation">.</span><span class="token function">Post</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">List</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> where<span class="token punctuation">.</span><span class="token function">T</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> err
                <span class="token punctuation">}</span>

                converted <span class="token operator">:=</span> conversion<span class="token punctuation">.</span><span class="token function">UserodelToUserV1</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>
                converted<span class="token punctuation">.</span>PostCount <span class="token operator">=</span> count
                m<span class="token punctuation">.</span><span class="token function">Store</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> converted<span class="token punctuation">)</span>

                <span class="token keyword">return</span> <span class="token boolean">nil</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> err <span class="token operator">:=</span> eg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
        slog<span class="token punctuation">.</span><span class="token function">ErrorContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"Failed to wait all function calls returned"</span><span class="token punctuation">,</span> <span class="token string">"err"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>

    users <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>apiv1<span class="token punctuation">.</span>User<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>userList<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> item <span class="token operator">:=</span> <span class="token keyword">range</span> userList <span class="token punctuation">{<!-- --></span>
        user<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>ID<span class="token punctuation">)</span>
        users <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>users<span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>apiv1<span class="token punctuation">.</span>User<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    slog<span class="token punctuation">.</span><span class="token function">DebugContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"Get users from backend storage"</span><span class="token punctuation">,</span> <span class="token string">"count"</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>users<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token operator">&amp;</span>apiv1<span class="token punctuation">.</span>ListUserResponse<span class="token punctuation">{<!-- --></span>TotalCount<span class="token punctuation">:</span> count<span class="token punctuation">,</span> Users<span class="token punctuation">:</span> users<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     <code>
      List
     </code>
     方法会查询所有的用户列表，并统计用户所属的博客数，这种遍历多个列表，并且针对列表中每个元素都有耗时处理逻辑的代码，可能会导致
     <code>
      List
     </code>
     方法执行时间较久。为了提高
     <code>
      List
     </code>
     方法的性能，
     <code>
      List
     </code>
     方法中使用了 errgroup 包，并发查询每个用户的博客数。
    </p>
    <p>
     在上述代码中
     <code>
      eg.SetLimit
     </code>
     方法调用的作用是限制程序中同时运行的 Go 协程数量，以避免过多协程并发任务导致的系统资源过载（如高 CPU 和内存占用或高 I/O 消耗）。通过
     <code>
      eg.Go
     </code>
     启动的 goroutine 会按照
     <code>
      SetLimit
     </code>
     的限制规则执行。当已经有
     <code>
      MaxErrGroupConcurrency
     </code>
     个任务在运行时，新任务会阻塞，直到某个正在运行的任务完成。
    </p>
    <p>
     因为会并发处理
     <code>
      userList
     </code>
     列表中的每个元素，所以需要一个并发安全的数据类型，保存处理后的数据。Go 标准库提供了
     <code>
      sync.Map
     </code>
     数据类型，该类型是并发安全的，可以直接在 Go 协程中使用
     <code>
      sync.Map
     </code>
     的
     <code>
      Store
     </code>
     方法添加 key-value 对。在上述代码中，使用
     <code>
      m.Store
     </code>
     保存了
     <code>
      *apiv1.User
     </code>
     类型的数据。
    </p>
    <p>
     Store 层返回的数据类型为
     <code>
      *model.UserM
     </code>
     ，需要转换为 Biz 层使用的数据类型
     <code>
      *apiv1.User
     </code>
     。
     <code>
      *model.UserM
     </code>
     和
     <code>
      *apiv1.User
     </code>
     数据类型之间的相互转换，在 Biz 层经常会发生，为了提高代码的可维护性，将这类转换实现统一保存在 internal/apiserver/pkg/conversion 目录下的
     <a href="https://github.com/onexstack/fastgo/tree/feature/s13/internal/apiserver/pkg/conversion">
      conversion
     </a>
     包中。
    </p>
    <p>
     Store 层返回的用户列表是降序排列的，为了保证
     <code>
      List
     </code>
     返回的列表也是降序排列的，上述代码的最后，使用以下代码段重新排列了
     <code>
      sync.Map
     </code>
     类型变量
     <code>
      m
     </code>
     中保存的数据：
    </p>
    <pre><code class="prism language-go"><span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> item <span class="token operator">:=</span> <span class="token keyword">range</span> userList <span class="token punctuation">{<!-- --></span>
    user<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>ID<span class="token punctuation">)</span>
    users <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>users<span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>apiv1<span class="token punctuation">.</span>User<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f:626c6f672e6373646e2e6e65742f753031313633343432312f:61727469636c652f64657461696c732f313436323137323338" class_="artid" style="display:none">
 </p>
</div>


