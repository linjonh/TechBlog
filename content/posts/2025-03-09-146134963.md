---
layout: post
title: "用K8S部署Milvus服务"
date: 2025-03-09 17:04:37 +0800
description: "通过以上配置，您可以在 Kubernetes 上部署一个基础的 Milvus 向量数据库集群，适用于开发测试环境。生产部署需根据负载调整副本数、存储方案及网络策略。的简要介绍及基于 Kubernetes 的详细部署 YAML 代码，包含高可用架构、持久化存储及关键组件配置。"
keywords: "用K8S部署Milvus服务"
categories: ['未分类']
tags: ['容器', 'Milvus', 'Kubernetes']
artid: "146134963"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146134963
    alt: "用K8S部署Milvus服务"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146134963
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146134963
cover: https://bing.ee123.net/img/rand?artid=146134963
image: https://bing.ee123.net/img/rand?artid=146134963
img: https://bing.ee123.net/img/rand?artid=146134963
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     用K8S部署Milvus服务
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     以下是对
     <strong>
      Milvus
     </strong>
     的简要介绍及基于 Kubernetes 的详细部署 YAML 代码，包含高可用架构、持久化存储及关键组件配置。
    </p>
    <hr/>
    <h4>
     <a id="Milvus__4">
     </a>
     <strong>
      Milvus 简介
     </strong>
    </h4>
    <p>
     <strong>
      Milvus
     </strong>
     是一款开源的分布式向量数据库，专为海量向量数据的相似性搜索和 AI 应用设计，核心特性包括：
    </p>
    <ul>
     <li>
      <strong>
       多向量索引支持
      </strong>
      ：IVF、HNSW、Annoy 等算法。
     </li>
     <li>
      <strong>
       水平扩展
      </strong>
      ：支持动态扩缩容数据节点和查询节点。
     </li>
     <li>
      <strong>
       云原生架构
      </strong>
      ：依赖组件包括 etcd（元数据存储）、MinIO/S3（对象存储）、Pulsar/Kafka（消息队列）。
     </li>
     <li>
      <strong>
       多语言 SDK
      </strong>
      ：Python、Java、Go 等。
     </li>
    </ul>
    <hr/>
    <h4>
     <a id="_13">
     </a>
     <strong>
      部署架构
     </strong>
    </h4>
    <ul>
     <li>
      <strong>
       Milvus 核心服务
      </strong>
      ：
      <ul>
       <li>
        <strong>
         Data Node
        </strong>
        ：处理数据写入和持久化。
       </li>
       <li>
        <strong>
         Query Node
        </strong>
        ：处理向量搜索请求。
       </li>
       <li>
        <strong>
         Index Node
        </strong>
        ：构建向量索引。
       </li>
       <li>
        <strong>
         Root Coordinator
        </strong>
        ：协调集群元数据。
       </li>
       <li>
        <strong>
         Proxy
        </strong>
        ：对外暴露 API 的入口。
       </li>
      </ul>
     </li>
     <li>
      <strong>
       依赖组件
      </strong>
      ：
      <ul>
       <li>
        <strong>
         etcd
        </strong>
        ：存储元数据（3 节点集群）。
       </li>
       <li>
        <strong>
         MinIO
        </strong>
        ：对象存储（替代生产环境的 S3）。
       </li>
       <li>
        <strong>
         Pulsar
        </strong>
        ：消息队列（日志流）。
       </li>
      </ul>
     </li>
    </ul>
    <hr/>
    <h4>
     <a id="_YAML__27">
     </a>
     <strong>
      详细部署 YAML 代码
     </strong>
    </h4>
    <h5>
     <a id="1__Namespace_29">
     </a>
     <strong>
      1. 创建 Namespace
     </strong>
    </h5>
    <pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Namespace
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> milvus
</code></pre>
    <hr/>
    <h5>
     <a id="2__etcd__39">
     </a>
     <strong>
      2. 部署 etcd 集群（元数据存储）
     </strong>
    </h5>
    <pre><code class="prism language-yaml"><span class="token comment"># etcd StatefulSet</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> StatefulSet
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> etcd
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> milvus
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> etcd
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> etcd
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> etcd
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> etcd
        <span class="token key atrule">image</span><span class="token punctuation">:</span> quay.io/coreos/etcd<span class="token punctuation">:</span>v3.5.7
        <span class="token key atrule">env</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ETCD_NAME
          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
            <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>
              <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> metadata.name
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ETCD_DATA_DIR
          <span class="token key atrule">value</span><span class="token punctuation">:</span> /var/lib/etcd
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ETCD_INITIAL_CLUSTER
          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"etcd-0=http://etcd-0.etcd:2380,etcd-1=http://etcd-1.etcd:2380,etcd-2=http://etcd-2.etcd:2380"</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ETCD_INITIAL_ADVERTISE_PEER_URLS
          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"http://$(POD_NAME).etcd:2380"</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ETCD_LISTEN_PEER_URLS
          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"http://0.0.0.0:2380"</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ETCD_LISTEN_CLIENT_URLS
          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"http://0.0.0.0:2379"</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ETCD_ADVERTISE_CLIENT_URLS
          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"http://$(POD_NAME).etcd:2379"</span>
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">2379</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> client
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">2380</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> peer
        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> etcd<span class="token punctuation">-</span>data
          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/lib/etcd
  <span class="token key atrule">volumeClaimTemplates</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> etcd<span class="token punctuation">-</span>data
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">accessModes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"ReadWriteOnce"</span><span class="token punctuation">]</span>
      <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> <span class="token string">"standard"</span>
      <span class="token key atrule">resources</span><span class="token punctuation">:</span>
        <span class="token key atrule">requests</span><span class="token punctuation">:</span>
          <span class="token key atrule">storage</span><span class="token punctuation">:</span> 10Gi

<span class="token punctuation">---</span>
<span class="token comment"># etcd Service</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> etcd
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> milvus
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> None
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">2379</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> client
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">2380</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> peer
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> etcd
</code></pre>
    <hr/>
    <h5>
     <a id="3__MinIO_116">
     </a>
     <strong>
      3. 部署 MinIO（对象存储）
     </strong>
    </h5>
    <pre><code class="prism language-yaml"><span class="token comment"># MinIO Deployment</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> minio
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> milvus
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token comment"># 生产环境建议 4 节点分布式部署</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> minio
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> minio
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> minio
        <span class="token key atrule">image</span><span class="token punctuation">:</span> minio/minio<span class="token punctuation">:</span>RELEASE.2023<span class="token punctuation">-</span>09<span class="token punctuation">-</span>04T19<span class="token punctuation">-</span>57<span class="token punctuation">-</span>37Z
        <span class="token key atrule">args</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> server
        <span class="token punctuation">-</span> /data
        <span class="token key atrule">env</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MINIO_ROOT_USER
          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"minioadmin"</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MINIO_ROOT_PASSWORD
          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"minioadmin"</span>
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">9000</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">9001</span>
        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> minio<span class="token punctuation">-</span>data
          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /data
      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> minio<span class="token punctuation">-</span>data
        <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>
          <span class="token key atrule">claimName</span><span class="token punctuation">:</span> minio<span class="token punctuation">-</span>pvc

<span class="token punctuation">---</span>
<span class="token comment"># MinIO PVC</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> minio<span class="token punctuation">-</span>pvc
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> milvus
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> ReadWriteOnce
  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> <span class="token string">"standard"</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token key atrule">requests</span><span class="token punctuation">:</span>
      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 50Gi

<span class="token punctuation">---</span>
<span class="token comment"># MinIO Service</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> minio
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> milvus
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9000</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">9000</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9001</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">9001</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> minio
</code></pre>
    <hr/>
    <h5>
     <a id="4__Milvus__190">
     </a>
     <strong>
      4. 部署 Milvus 核心服务
     </strong>
    </h5>
    <pre><code class="prism language-yaml"><span class="token comment"># Milvus Proxy Service (API 入口)</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> milvus<span class="token punctuation">-</span>proxy
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> milvus
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort  <span class="token comment"># 生产环境建议 LoadBalancer 或 Ingress</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">19530</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">19530</span>
    <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">30001</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> milvus<span class="token punctuation">-</span>proxy

<span class="token punctuation">---</span>
<span class="token comment"># Milvus 组件 Deployment（示例：Proxy、Data Node、Query Node）</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> milvus<span class="token punctuation">-</span>proxy
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> milvus
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> milvus<span class="token punctuation">-</span>proxy
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> milvus<span class="token punctuation">-</span>proxy
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> proxy
        <span class="token key atrule">image</span><span class="token punctuation">:</span> milvusdb/milvus<span class="token punctuation">:</span>v2.3.3
        <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"milvus"</span><span class="token punctuation">,</span> <span class="token string">"run"</span><span class="token punctuation">,</span> <span class="token string">"proxy"</span><span class="token punctuation">]</span>
        <span class="token key atrule">env</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ETCD_ENDPOINTS
          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"etcd-0.etcd:2379,etcd-1.etcd:2379,etcd-2.etcd:2379"</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MINIO_ADDRESS
          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"minio:9000"</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MINIO_ACCESS_KEY
          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"minioadmin"</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MINIO_SECRET_KEY
          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"minioadmin"</span>
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">19530</span>
        <span class="token key atrule">resources</span><span class="token punctuation">:</span>
          <span class="token key atrule">requests</span><span class="token punctuation">:</span>
            <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">"2Gi"</span>
            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">"1"</span>
          <span class="token key atrule">limits</span><span class="token punctuation">:</span>
            <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">"4Gi"</span>
            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">"2"</span>

<span class="token comment"># Data Node、Query Node、Index Node 类似，需分别部署</span>
</code></pre>
    <hr/>
    <h4>
     <a id="_252">
     </a>
     <strong>
      验证部署
     </strong>
    </h4>
    <ol>
     <li>
      <p>
       <strong>
        检查 Pod 状态
       </strong>
       ：
      </p>
      <pre><code class="prism language-bash">kubectl get pods <span class="token parameter variable">-n</span> milvus <span class="token parameter variable">-l</span> <span class="token assign-left variable">app</span><span class="token operator">=</span>milvus-proxy
</code></pre>
     </li>
     <li>
      <p>
       <strong>
        测试 Milvus 连接
       </strong>
       ：
      </p>
      <pre><code class="prism language-python"><span class="token keyword">from</span> pymilvus <span class="token keyword">import</span> connections<span class="token punctuation">,</span> Collection
connections<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">"&lt;K8S_NODE_IP&gt;"</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">30001</span><span class="token punctuation">)</span>  <span class="token comment"># 使用 NodePort 地址</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>connections<span class="token punctuation">.</span>list_collections<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 应返回空列表（新集群）</span>
</code></pre>
     </li>
    </ol>
    <hr/>
    <h4>
     <a id="_267">
     </a>
     <strong>
      关键配置说明
     </strong>
    </h4>
    <ol>
     <li>
      <p>
       <strong>
        高可用性
       </strong>
       ：
      </p>
      <ul>
       <li>
        <strong>
         etcd
        </strong>
        ：3 节点集群，避免元数据单点故障。
       </li>
       <li>
        <strong>
         Milvus 组件
        </strong>
        ：Proxy、Data Node 等多副本部署。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        持久化存储
       </strong>
       ：
      </p>
      <ul>
       <li>
        <strong>
         etcd
        </strong>
        ：通过 PVC 持久化元数据。
       </li>
       <li>
        <strong>
         MinIO
        </strong>
        ：存储向量数据文件，生产环境建议使用分布式存储（如 Ceph 或 AWS S3）。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        资源分配
       </strong>
       ：
      </p>
      <ul>
       <li>
        <strong>
         Proxy
        </strong>
        ：至少 2 CPU 核心和 4GB 内存。
       </li>
       <li>
        <strong>
         Data Node
        </strong>
        ：根据数据量增加内存和存储。
       </li>
      </ul>
     </li>
    </ol>
    <hr/>
    <h4>
     <a id="_282">
     </a>
     <strong>
      生产环境优化建议
     </strong>
    </h4>
    <ol>
     <li>
      <p>
       <strong>
        分离组件角色
       </strong>
       ：
      </p>
      <ul>
       <li>
        专用 Root Coordinator、Data Coordinator 等组件。
       </li>
      </ul>
      <pre><code class="prism language-yaml"><span class="token comment"># 示例：Root Coordinator</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> rootcoord
  <span class="token key atrule">image</span><span class="token punctuation">:</span> milvusdb/milvus<span class="token punctuation">:</span>v2.3.3
  <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"milvus"</span><span class="token punctuation">,</span> <span class="token string">"run"</span><span class="token punctuation">,</span> <span class="token string">"rootcoord"</span><span class="token punctuation">]</span>
</code></pre>
     </li>
     <li>
      <p>
       <strong>
        监控与日志
       </strong>
       ：
      </p>
      <ul>
       <li>
        集成 Prometheus + Grafana 监控集群指标。
       </li>
       <li>
        使用 EFK（Elasticsearch + Fluentd + Kibana）收集日志。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        安全加固
       </strong>
       ：
      </p>
      <ul>
       <li>
        启用 MinIO TLS 加密。
       </li>
       <li>
        配置 Milvus 身份验证（需企业版支持）。
       </li>
      </ul>
     </li>
    </ol>
    <hr/>
    <p>
     通过以上配置，您可以在 Kubernetes 上部署一个基础的 Milvus 向量数据库集群，适用于开发测试环境。生产部署需根据负载调整副本数、存储方案及网络策略。
    </p>
    <hr/>
    <p>
     Milvus 作为分布式向量数据库，其核心功能（数据管理、向量搜索）依赖于
     <strong>
      etcd
     </strong>
     和
     <strong>
      MinIO
     </strong>
     等组件的协作。以下是它们的职责分工和协作流程：
    </p>
    <hr/>
    <h4>
     <a id="1__310">
     </a>
     <strong>
      1. 组件职责
     </strong>
    </h4>
    <table>
     <thead>
      <tr>
       <th>
        组件
       </th>
       <th>
        角色
       </th>
       <th>
        核心功能
       </th>
       <th>
        类比
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        Milvus
       </td>
       <td>
        向量数据库
       </td>
       <td>
        向量数据存储、索引构建、相似性搜索
       </td>
       <td>
        数据库引擎（如MySQL）
       </td>
      </tr>
      <tr>
       <td>
        etcd
       </td>
       <td>
        元数据存储
       </td>
       <td>
        存储集合、分片、节点状态等元信息
       </td>
       <td>
        数据库的“目录系统”
       </td>
      </tr>
      <tr>
       <td>
        MinIO
       </td>
       <td>
        对象存储
       </td>
       <td>
        存储原始向量数据、索引文件等大文件
       </td>
       <td>
        数据库的“硬盘”
       </td>
      </tr>
     </tbody>
    </table>
    <hr/>
    <h4>
     <a id="2__319">
     </a>
     <strong>
      2. 协作流程（以数据写入为例）
     </strong>
    </h4>
    <h5>
     <a id="1__321">
     </a>
     <strong>
      (1) 用户写入数据
     </strong>
    </h5>
    <ul>
     <li>
      <strong>
       Proxy
      </strong>
      接收客户端请求（如插入向量数据）。
     </li>
     <li>
      <strong>
       Proxy
      </strong>
      将数据写入消息队列（如 Pulsar/Kafka，未在YAML中体现，但实际部署需包含）。
     </li>
     <li>
      <strong>
       Root Coordinator
      </strong>
      通过
      <strong>
       etcd
      </strong>
      记录元数据（如数据对应的分片、版本信息）。
     </li>
    </ul>
    <h5>
     <a id="2_Data_Node__326">
     </a>
     <strong>
      (2) Data Node 处理数据
     </strong>
    </h5>
    <ul>
     <li>
      <strong>
       Data Node
      </strong>
      消费消息队列中的数据，进行以下操作：
      <ul>
       <li>
        <strong>
         序列化
        </strong>
        ：将向量数据转换为文件格式（如 Parquet）。
       </li>
       <li>
        <strong>
         上传至 MinIO
        </strong>
        ：将文件存储到 MinIO 的指定 Bucket。
       </li>
       <li>
        <strong>
         更新元数据
        </strong>
        ：通过
        <strong>
         etcd
        </strong>
        记录文件路径、版本等元信息。
       </li>
      </ul>
     </li>
    </ul>
    <h5>
     <a id="3_Index_Node__332">
     </a>
     <strong>
      (3) Index Node 构建索引
     </strong>
    </h5>
    <ul>
     <li>
      <strong>
       Index Node
      </strong>
      根据配置的索引类型（如 HNSW、IVF），从
      <strong>
       MinIO
      </strong>
      拉取数据文件。
     </li>
     <li>
      构建索引后，将索引文件上传回
      <strong>
       MinIO
      </strong>
      ，并通过
      <strong>
       etcd
      </strong>
      记录索引元数据。
     </li>
    </ul>
    <h5>
     <a id="4_Query_Node__336">
     </a>
     <strong>
      (4) Query Node 处理搜索请求
     </strong>
    </h5>
    <ul>
     <li>
      <strong>
       Query Node
      </strong>
      收到搜索请求后：
      <ul>
       <li>
        从
        <strong>
         etcd
        </strong>
        获取目标集合的元数据（如分片分布、索引类型）。
       </li>
       <li>
        根据元数据定位
        <strong>
         MinIO
        </strong>
        中的索引文件和数据文件。
       </li>
       <li>
        加载索引和数据，执行相似性搜索并返回结果。
       </li>
      </ul>
     </li>
    </ul>
    <hr/>
    <h4>
     <a id="3__344">
     </a>
     <strong>
      3. 关键协作场景
     </strong>
    </h4>
    <h5>
     <a id="1__345">
     </a>
     <strong>
      (1) 元数据一致性
     </strong>
    </h5>
    <ul>
     <li>
      <strong>
       etcd
      </strong>
      作为分布式键值存储，确保所有 Milvus 节点访问的元数据一致。
     </li>
     <li>
      例如：当创建新集合时，
      <strong>
       Root Coordinator
      </strong>
      将集合的 Schema 和分片信息写入 etcd，所有节点通过监听 etcd 获知变更。
     </li>
    </ul>
    <h5>
     <a id="2__349">
     </a>
     <strong>
      (2) 数据持久化与高可用
     </strong>
    </h5>
    <ul>
     <li>
      <strong>
       MinIO
      </strong>
      存储实际数据文件，确保即使 Milvus 节点宕机，数据仍可从对象存储恢复。
     </li>
     <li>
      生产环境中，MinIO 需配置为分布式模式（多节点 + 纠删码），避免数据丢失。
     </li>
    </ul>
    <h5>
     <a id="3__353">
     </a>
     <strong>
      (3) 故障恢复
     </strong>
    </h5>
    <ul>
     <li>
      <strong>
       Data Node 宕机
      </strong>
      ：
      <br/>
      Milvus 通过 etcd 检测节点状态，自动将宕机节点的分片迁移到其他健康节点，新节点从 MinIO 拉取数据重建服务。
     </li>
     <li>
      <strong>
       etcd 集群故障
      </strong>
      ：
      <br/>
      etcd 基于 Raft 协议实现高可用，半数以上节点存活即可正常服务。若全部节点宕机，Milvus 将不可用，需优先恢复 etcd。
     </li>
    </ul>
    <hr/>
    <h4>
     <a id="4__361">
     </a>
     <strong>
      4. 生产环境优化建议
     </strong>
    </h4>
    <h5>
     <a id="1_etcd__362">
     </a>
     <strong>
      (1) etcd 高可用
     </strong>
    </h5>
    <ul>
     <li>
      部署 3/5 节点的 etcd 集群，跨可用区分布。
     </li>
     <li>
      监控 etcd 性能（如写入延迟、存储空间）。
     </li>
    </ul>
    <h5>
     <a id="2_MinIO__366">
     </a>
     <strong>
      (2) MinIO 分布式部署
     </strong>
    </h5>
    <ul>
     <li>
      至少 4 节点 MinIO，启用纠删码（Erasure Coding）提高数据可靠性。
     </li>
     <li>
      示例配置：
      <pre><code class="prism language-yaml"><span class="token comment"># MinIO 分布式部署（4节点）</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> StatefulSet
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">4</span>
  <span class="token key atrule">volumeClaimTemplates</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> data
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">accessModes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>ReadWriteOnce<span class="token punctuation">]</span>
      <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> <span class="token string">"standard"</span>
      <span class="token key atrule">resources</span><span class="token punctuation">:</span>
        <span class="token key atrule">requests</span><span class="token punctuation">:</span>
          <span class="token key atrule">storage</span><span class="token punctuation">:</span> 100Gi
</code></pre>
     </li>
    </ul>
    <h5>
     <a id="3__Milvus__386">
     </a>
     <strong>
      (3) 分离 Milvus 组件角色
     </strong>
    </h5>
    <ul>
     <li>
      专用 Root Coordinator、Data Node、Query Node，避免资源竞争。
     </li>
     <li>
      示例配置（YAML 片段）：
      <pre><code class="prism language-yaml"><span class="token comment"># 专用 Root Coordinator</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> rootcoord
  <span class="token key atrule">image</span><span class="token punctuation">:</span> milvusdb/milvus<span class="token punctuation">:</span>v2.3.3
  <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"milvus"</span><span class="token punctuation">,</span> <span class="token string">"run"</span><span class="token punctuation">,</span> <span class="token string">"rootcoord"</span><span class="token punctuation">]</span>
  <span class="token key atrule">env</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ETCD_ENDPOINTS
    <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"etcd-0.etcd:2379,etcd-1.etcd:2379,etcd-2.etcd:2379"</span>
</code></pre>
     </li>
    </ul>
    <hr/>
    <h4>
     <a id="5__401">
     </a>
     <strong>
      5. 总结
     </strong>
    </h4>
    <ul>
     <li>
      <strong>
       etcd
      </strong>
      ：Milvus 的“大脑”，管理元数据和集群状态。
     </li>
     <li>
      <strong>
       MinIO
      </strong>
      ：Milvus 的“硬盘”，持久化存储向量和索引文件。
     </li>
     <li>
      <strong>
       协作逻辑
      </strong>
      ：
      <br/>
      通过 etcd 维护一致性，通过 MinIO 实现数据持久化，Milvus 各组件基于两者协作完成向量数据的存储、索引和查询。
      <br/>
      三者缺一不可，共同保障系统的可靠性、扩展性和高性能。
     </li>
    </ul>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f:626c6f672e6373646e2e6e65742f5261696e7369726975732f:61727469636c652f64657461696c732f313436313334393633" class_="artid" style="display:none">
 </p>
</div>


