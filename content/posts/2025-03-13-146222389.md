---
layout: post
title: "用Embassy库编写的自动化下载程序"
date: 2025-03-13 09:28:51 +0800
description: "Embassy 是一个基于 Kotlin 的 HTTP 客户端库，用于简化 HTTP 请求的处理。你可以使用 Embassy 来编写自动化下载程序，类似于其他 HTTP 客户端库。"
keywords: "用Embassy库编写的自动化下载程序"
categories: ['未分类']
tags: ['音视频', '运维', '自动化', '爬虫', 'Golang']
artid: "146222389"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146222389
    alt: "用Embassy库编写的自动化下载程序"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146222389
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146222389
cover: https://bing.ee123.net/img/rand?artid=146222389
image: https://bing.ee123.net/img/rand?artid=146222389
img: https://bing.ee123.net/img/rand?artid=146222389
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     用Embassy库编写的自动化下载程序
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     Embassy 是一个基于 Kotlin 的 HTTP 客户端库，用于简化 HTTP 请求的处理。你可以使用 Embassy 来编写自动化下载程序，类似于其他 HTTP 客户端库。
    </p>
    <p>
     以下是使用 Embassy 库编写的一个简单自动化下载程序的示例。该程序将从指定 URL 下载文件并保存到本地。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/51291f35717c464a93af4946aed78fac.png#pic_center"/>
    </p>
    <p>
     <strong>
      1、添加依赖
     </strong>
    </p>
    <p>
     首先，你需要在项目中添加 Embassy 依赖。你可以在
     <code>
      build.gradle.kts
     </code>
     文件中添加以下内容：
    </p>
    <pre><code class="prism language-kotlin">dependencies <span class="token punctuation">{<!-- --></span>
    <span class="token function">implementation</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"dev.inmo:embassy:1.0.0"</span></span><span class="token punctuation">)</span> <span class="token comment">// Embassy 的最新版本</span>
    <span class="token function">implementation</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"org.jetbrains.kotlinx:kotlinx-coroutines-core:1.6.0"</span></span><span class="token punctuation">)</span> <span class="token comment">// 协程库</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     确保你使用的是 Embassy 的最新版本。
    </p>
    <p>
     <strong>
      2、创建自动化下载程序
     </strong>
    </p>
    <p>
     接下来我们创建一个 Kotlin 文件
     <code>
      DownloadFileWithEmbassy.kt
     </code>
     ，并在其中编写自动化下载代码。
    </p>
    <h4>
     <a id="_24">
     </a>
     代码示例：
    </h4>
    <pre><code class="prism language-kotlin"><span class="token keyword">import</span> dev<span class="token punctuation">.</span>inmo<span class="token punctuation">.</span>embassy<span class="token punctuation">.</span>download<span class="token punctuation">.</span>DownloadService
<span class="token keyword">import</span> dev<span class="token punctuation">.</span>inmo<span class="token punctuation">.</span>embassy<span class="token punctuation">.</span>download<span class="token punctuation">.</span>toOutputStream
<span class="token keyword">import</span> kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span><span class="token operator">*</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>File
<span class="token keyword">import</span> java<span class="token punctuation">.</span>net<span class="token punctuation">.</span>URL

<span class="token comment">// 自动化下载图片或文件</span>
<span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token function">downloadFile</span><span class="token punctuation">(</span>url<span class="token operator">:</span> String<span class="token punctuation">,</span> savePath<span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 创建文件保存路径</span>
    <span class="token keyword">val</span> file <span class="token operator">=</span> <span class="token function">File</span><span class="token punctuation">(</span>savePath<span class="token punctuation">)</span>

    <span class="token comment">// 确保保存目录存在</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>file<span class="token punctuation">.</span>parentFile<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        file<span class="token punctuation">.</span>parentFile<span class="token punctuation">.</span><span class="token function">mkdirs</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 获取文件的输入流</span>
    <span class="token keyword">val</span> downloadStream <span class="token operator">=</span> <span class="token function">URL</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">openStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 将输入流写入本地文件</span>
        downloadStream<span class="token punctuation">.</span><span class="token function">use</span> <span class="token punctuation">{<!-- --></span> inputStream <span class="token operator">-&gt;</span>
            file<span class="token punctuation">.</span><span class="token function">outputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">use</span> <span class="token punctuation">{<!-- --></span> outputStream <span class="token operator">-&gt;</span>
                inputStream<span class="token punctuation">.</span><span class="token function">copyTo</span><span class="token punctuation">(</span>outputStream<span class="token punctuation">)</span>
                <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"文件下载完成: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">savePath</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Exception<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"下载失败: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token expression">e<span class="token punctuation">.</span>message</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 主程序</span>
<span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 需要下载的文件 URL</span>
    <span class="token keyword">val</span> url <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"https://example.com/image.jpg"</span></span>  <span class="token comment">// 替换为实际文件的 URL</span>
    <span class="token comment">// 文件保存路径</span>
    <span class="token keyword">val</span> savePath <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"downloaded_image.jpg"</span></span>
    
    <span class="token comment">// 执行下载</span>
    <span class="token function">downloadFile</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> savePath<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     <strong>
      代码解释：
     </strong>
    </p>
    <ol>
     <li>
      <p>
       <strong>
        <code>
         downloadFile
        </code>
        函数
       </strong>
       ：
      </p>
      <ul>
       <li>
        该函数接收文件的 URL 和保存路径，首先确保文件保存的目录存在，然后从指定的 URL 获取输入流，并将其内容保存到本地文件中。
       </li>
       <li>
        <code>
         inputStream.copyTo(outputStream)
        </code>
        用于将下载的字节流写入本地文件。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        文件下载
       </strong>
       ：
      </p>
      <ul>
       <li>
        我们使用
        <code>
         URL(url).openStream()
        </code>
        打开一个输入流，并使用
        <code>
         file.outputStream()
        </code>
        打开一个输出流，然后将输入流的内容复制到输出流。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        错误处理
       </strong>
       ：
      </p>
      <ul>
       <li>
        使用
        <code>
         try-catch
        </code>
        捕获任何可能发生的异常（例如网络错误、文件保存问题等）。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        <code>
         runBlocking
        </code>
       </strong>
       ：
      </p>
      <ul>
       <li>
        <code>
         runBlocking
        </code>
        用于启动一个阻塞的协程，等待下载任务完成。
       </li>
      </ul>
     </li>
    </ol>
    <p>
     <strong>
      3、运行程序
     </strong>
    </p>
    <ol>
     <li>
      将上述代码保存为
      <code>
       DownloadFileWithEmbassy.kt
      </code>
      文件。
     </li>
     <li>
      执行以下命令编译并运行程序：
     </li>
    </ol>
    <pre><code class="prism language-bash">kotlinc <span class="token parameter variable">-cp</span> embassy-1.0.0.jar:kotlinx-coroutines-core-1.6.0.jar DownloadFileWithEmbassy.kt -include-runtime <span class="token parameter variable">-d</span> downloadFileWithEmbassy.jar
<span class="token function">java</span> <span class="token parameter variable">-jar</span> downloadFileWithEmbassy.jar
</code></pre>
    <p>
     程序将从指定的 URL 下载文件，并将其保存到本地。
    </p>
    <p>
     <strong>
      4、总结
     </strong>
    </p>
    <p>
     在这个示例中，我们使用 Embassy 库（或类似的 Kotlin HTTP 客户端）和原生的 Java 文件操作方法来下载文件。
     <code>
      Embassy
     </code>
     本身并没有复杂的 API，因此它更多的作用是简化 HTTP 请求的过程。
    </p>
    <p>
     你可以根据需要扩展程序，例如添加多线程下载、下载进度条、支持不同文件类型的下载等。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f34343631373635312f:61727469636c652f64657461696c732f313436323232333839" class_="artid" style="display:none">
 </p>
</div>


