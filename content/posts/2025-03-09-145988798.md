---
layout: post
title: "SpringBoot条件注解ConditionalOnClass等注解的使用场景"
date: 2025-03-09 06:30:00 +0800
description: "对于频繁使用的条件组合，可以创建自定义的组合注解，提高代码的可读性和可维护性。/*** 自定义组合条件注解*//*** 使用自定义组合条件注解*/@Bean通过这种方式，可以将复杂的条件逻辑封装在一个注解中，使代码更加简洁清晰。SpringBoot的条件注解体系提供了强大而灵活的机制，使配置能够根据运行环境、依赖情况和配置属性等条件动态调整。@ConditionalOnClass等注解在自动配置和可插拔功能实现中发挥着重要作用，使得应用能够自适应地调整其行为和功能。"
keywords: "conditionalonclass 使用"
categories: ['全家桶', 'Spring', 'Java']
tags: ['后端', 'Spring', 'Java', 'Boot']
artid: "145988798"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=145988798
    alt: "SpringBoot条件注解ConditionalOnClass等注解的使用场景"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=145988798
featuredImagePreview: https://bing.ee123.net/img/rand?artid=145988798
cover: https://bing.ee123.net/img/rand?artid=145988798
image: https://bing.ee123.net/img/rand?artid=145988798
img: https://bing.ee123.net/img/rand?artid=145988798
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     SpringBoot条件注解：@ConditionalOnClass等注解的使用场景
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/d5e988badfd04991931ff2fea52ea54f.png"/>
    </p>
    <p>
    </p>
    <p>
    </p>
    <h3>
     <a id="_4">
     </a>
     引言
    </h3>
    <p>
     SpringBoot是Java开发领域中广受欢迎的框架，其核心特性之一是自动配置。自动配置使得开发者能够快速构建应用，无需繁琐的手动配置。在自动配置的实现中，条件注解发挥了关键作用，它们使得配置能够根据特定条件动态生效或失效。本文将深入探讨SpringBoot的条件注解体系，特别是@ConditionalOnClass等注解的工作原理和使用场景，帮助开发者更好地理解和应用这一强大特性，实现更灵活的应用配置。
    </p>
    <h3>
     <a id="_8">
     </a>
     一、条件注解的基本概念
    </h3>
    <p>
     条件注解是基于Spring 4引入的@Conditional注解构建的功能增强型注解。这些注解允许开发者根据特定条件控制Bean的创建、配置的加载以及组件的注册。通过条件注解，SpringBoot实现了"按需配置"的灵活机制，只在满足特定条件时才应用相应的配置，从而避免了不必要的资源消耗和潜在的冲突。
    </p>
    <p>
     SpringBoot中的条件注解主要建立在@Conditional注解的基础上，每种条件注解都对应一个特定的Condition实现类，用于判断条件是否满足。当条件满足时，注解所修饰的配置项会被处理；当条件不满足时，配置项会被跳过。
    </p>
    <pre><code class="prism language-java"><span class="token comment">/**
 * Spring原生的@Conditional注解
 */</span>
<span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">TYPE</span><span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">METHOD</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Documented</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">Conditional</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/**
     * 条件类，必须实现Condition接口
     */</span>
    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Condition</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * Condition接口定义
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Condition</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/**
     * 条件匹配方法
     * @param context 条件上下文
     * @param metadata 注解元数据
     * @return 条件是否匹配
     */</span>
    <span class="token keyword">boolean</span> <span class="token function">matches</span><span class="token punctuation">(</span><span class="token class-name">ConditionContext</span> context<span class="token punctuation">,</span> <span class="token class-name">AnnotatedTypeMetadata</span> metadata<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="ConditionalOnClass_42">
     </a>
     二、@ConditionalOnClass注解详解
    </h3>
    <h4>
     <a id="21__44">
     </a>
     2.1 基本原理与使用
    </h4>
    <p>
     @ConditionalOnClass是SpringBoot最常用的条件注解之一，用于基于类路径中是否存在特定类来控制配置。当指定的类存在于类路径中时，注解所修饰的配置才会生效。这个注解在SpringBoot的自动配置中广泛应用，用于确保只有在相关依赖可用时才启用特定功能。
    </p>
    <p>
     @ConditionalOnClass注解由OnClassCondition类实现条件检查，该类检查类加载器是否能够加载指定的类。如果所有指定的类都能被加载，则条件满足；如果任何一个类无法加载，则条件不满足。
    </p>
    <pre><code class="prism language-java"><span class="token comment">/**
 * @ConditionalOnClass注解定义
 */</span>
<span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">TYPE</span><span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">METHOD</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Documented</span>
<span class="token annotation punctuation">@Conditional</span><span class="token punctuation">(</span><span class="token class-name">OnClassCondition</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">ConditionalOnClass</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/**
     * 需要存在的类
     */</span>
    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    
    <span class="token comment">/**
     * 需要存在的类的名称（字符串形式）
     */</span>
    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="22__71">
     </a>
     2.2 典型使用场景
    </h4>
    <p>
     @ConditionalOnClass注解的典型使用场景包括：
    </p>
    <ol>
     <li>
      <strong>
       自动配置类
      </strong>
      ：只有当特定库的类存在时才应用配置
     </li>
     <li>
      <strong>
       可选功能启用
      </strong>
      ：基于是否存在功能相关的类决定是否启用特定功能
     </li>
     <li>
      <strong>
       适配不同版本
      </strong>
      ：根据类路径中的类决定使用哪个版本的实现
     </li>
    </ol>
    <p>
     以下是一个实际的使用示例，展示了如何基于类路径中是否存在Gson类来决定是否创建GsonHttpMessageConverter：
    </p>
    <pre><code class="prism language-java"><span class="token comment">/**
 * Gson自动配置示例
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@ConditionalOnClass</span><span class="token punctuation">(</span><span class="token class-name">Gson</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GsonAutoConfiguration</span> <span class="token punctuation">{<!-- --></span>
    
    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@ConditionalOnMissingBean</span>
    <span class="token keyword">public</span> <span class="token class-name">Gson</span> <span class="token function">gson</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Gson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@ConditionalOnMissingBean</span>
    <span class="token keyword">public</span> <span class="token class-name">GsonHttpMessageConverter</span> <span class="token function">gsonHttpMessageConverter</span><span class="token punctuation">(</span><span class="token class-name">Gson</span> gson<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">GsonHttpMessageConverter</span> converter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GsonHttpMessageConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        converter<span class="token punctuation">.</span><span class="token function">setGson</span><span class="token punctuation">(</span>gson<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> converter<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     在这个例子中，只有当类路径中存在Gson类时，整个配置类才会生效，从而注册相关的Bean。这确保了只有在应用引入Gson依赖时，才会配置相关组件。
    </p>
    <h3>
     <a id="_107">
     </a>
     三、其他常用条件注解
    </h3>
    <p>
     SpringBoot提供了丰富的条件注解，除了@ConditionalOnClass外，还有许多其他常用的条件注解，每一个都适用于特定的场景。
    </p>
    <h4>
     <a id="31_ConditionalOnMissingClass_111">
     </a>
     3.1 @ConditionalOnMissingClass
    </h4>
    <p>
     @ConditionalOnMissingClass注解与@ConditionalOnClass相反，它要求类路径中不存在指定的类。当指定类不存在时，配置才会生效。这常用于提供默认实现或备选方案。
    </p>
    <pre><code class="prism language-java"><span class="token comment">/**
 * 在类路径中不存在Kafka时提供备选消息处理器
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@ConditionalOnMissingClass</span><span class="token punctuation">(</span><span class="token string">"org.apache.kafka.clients.producer.KafkaProducer"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AlternativeMessageConfiguration</span> <span class="token punctuation">{<!-- --></span>
    
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">MessageProcessor</span> <span class="token function">localMessageProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">LocalMessageProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="32_ConditionalOnBeanConditionalOnMissingBean_130">
     </a>
     3.2 @ConditionalOnBean与@ConditionalOnMissingBean
    </h4>
    <p>
     这对注解用于基于Spring容器中是否存在特定Bean来控制配置。@ConditionalOnBean要求容器中存在指定的Bean，而@ConditionalOnMissingBean则要求容器中不存在指定的Bean。这常用于自动配置中提供默认实现，但允许用户自定义覆盖。
    </p>
    <pre><code class="prism language-java"><span class="token comment">/**
 * 数据源配置示例
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DataSourceConfiguration</span> <span class="token punctuation">{<!-- --></span>
    
    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@ConditionalOnMissingBean</span>
    <span class="token keyword">public</span> <span class="token class-name">DataSource</span> <span class="token function">dataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 提供默认数据源实现</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">EmbeddedDatabaseBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span><span class="token class-name">EmbeddedDatabaseType</span><span class="token punctuation">.</span><span class="token constant">H2</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@ConditionalOnBean</span><span class="token punctuation">(</span><span class="token class-name">DataSource</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">JdbcTemplate</span> <span class="token function">jdbcTemplate</span><span class="token punctuation">(</span><span class="token class-name">DataSource</span> dataSource<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 当存在DataSource时创建JdbcTemplate</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JdbcTemplate</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="33_ConditionalOnProperty_159">
     </a>
     3.3 @ConditionalOnProperty
    </h4>
    <p>
     @ConditionalOnProperty注解基于配置属性的值控制配置。它可以检查属性是否存在、是否有特定值或是否与特定值匹配。这常用于通过配置文件启用或禁用特定功能。
    </p>
    <pre><code class="prism language-java"><span class="token comment">/**
 * 基于属性配置的功能开关
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FeatureConfiguration</span> <span class="token punctuation">{<!-- --></span>
    
    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@ConditionalOnProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"feature.monitoring.enabled"</span><span class="token punctuation">,</span> havingValue <span class="token operator">=</span> <span class="token string">"true"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">MonitoringService</span> <span class="token function">monitoringService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MonitoringServiceImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@ConditionalOnProperty</span><span class="token punctuation">(</span>
        name <span class="token operator">=</span> <span class="token string">"database.type"</span><span class="token punctuation">,</span> 
        havingValue <span class="token operator">=</span> <span class="token string">"postgresql"</span><span class="token punctuation">,</span>
        matchIfMissing <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">DatabaseConnector</span> <span class="token function">postgresqlConnector</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">PostgreSQLConnector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="34_ConditionalOnExpression_188">
     </a>
     3.4 @ConditionalOnExpression
    </h4>
    <p>
     @ConditionalOnExpression注解允许使用SpEL表达式定义复杂的条件逻辑，提供了更大的灵活性。当表达式计算结果为true时，配置生效。
    </p>
    <pre><code class="prism language-java"><span class="token comment">/**
 * 基于SpEL表达式的条件配置
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ComplexConditionConfiguration</span> <span class="token punctuation">{<!-- --></span>
    
    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@ConditionalOnExpression</span><span class="token punctuation">(</span><span class="token string">"${app.environment} == 'prod' and ${app.cluster} == 'primary'"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">AlertNotifier</span> <span class="token function">productionPrimaryNotifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">HighPriorityAlertNotifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@ConditionalOnExpression</span><span class="token punctuation">(</span><span class="token string">"'${server.ssl.enabled:false}' == 'true' or '${app.security.level}' == 'high'"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">SecurityEnhancer</span> <span class="token function">securityEnhancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SecurityEnhancerImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="35_ConditionalOnResource_213">
     </a>
     3.5 @ConditionalOnResource
    </h4>
    <p>
     @ConditionalOnResource注解基于是否存在特定资源控制配置。当类路径中存在指定的资源文件时，配置才会生效。这常用于基于配置文件存在与否决定是否应用特定配置。
    </p>
    <pre><code class="prism language-java"><span class="token comment">/**
 * 基于资源文件存在的配置
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@ConditionalOnResource</span><span class="token punctuation">(</span>resources <span class="token operator">=</span> <span class="token string">"classpath:custom-config.properties"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomConfiguration</span> <span class="token punctuation">{<!-- --></span>
    
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">CustomConfigurationLoader</span> <span class="token function">customConfigurationLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CustomConfigurationLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="36_ConditionalOnWebApplicationConditionalOnNotWebApplication_232">
     </a>
     3.6 @ConditionalOnWebApplication与@ConditionalOnNotWebApplication
    </h4>
    <p>
     这对注解用于区分Web应用和非Web应用的配置。@ConditionalOnWebApplication在Web环境中生效，而@ConditionalOnNotWebApplication在非Web环境中生效。
    </p>
    <pre><code class="prism language-java"><span class="token comment">/**
 * Web应用特定配置
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@ConditionalOnWebApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebSecurityConfiguration</span> <span class="token punctuation">{<!-- --></span>
    
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">FilterRegistrationBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SecurityFilter</span><span class="token punctuation">&gt;</span></span> <span class="token function">securityFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">FilterRegistrationBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SecurityFilter</span><span class="token punctuation">&gt;</span></span> registration <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FilterRegistrationBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        registration<span class="token punctuation">.</span><span class="token function">setFilter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SecurityFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        registration<span class="token punctuation">.</span><span class="token function">addUrlPatterns</span><span class="token punctuation">(</span><span class="token string">"/*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> registration<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 非Web应用特定配置
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@ConditionalOnNotWebApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BatchProcessingConfiguration</span> <span class="token punctuation">{<!-- --></span>
    
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">BatchJobScheduler</span> <span class="token function">batchJobScheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BatchJobScheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="37_ConditionalOnJava_267">
     </a>
     3.7 @ConditionalOnJava
    </h4>
    <p>
     @ConditionalOnJava注解基于Java版本控制配置。它允许指定配置在特定的Java版本范围内生效，适用于需要特定Java版本特性的功能。
    </p>
    <pre><code class="prism language-java"><span class="token comment">/**
 * Java版本相关配置
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JavaVersionConfiguration</span> <span class="token punctuation">{<!-- --></span>
    
    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@ConditionalOnJava</span><span class="token punctuation">(</span><span class="token class-name">JavaVersion</span><span class="token punctuation">.</span><span class="token constant">EIGHT</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">CompletableFutureProcessor</span> <span class="token function">java8AsyncProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Java8CompletableFutureProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@ConditionalOnJava</span><span class="token punctuation">(</span>range <span class="token operator">=</span> <span class="token class-name">Range</span><span class="token punctuation">.</span><span class="token constant">OLDER_THAN</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token class-name">JavaVersion</span><span class="token punctuation">.</span><span class="token constant">NINE</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">LegacyProcessor</span> <span class="token function">legacyProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">LegacyProcessorImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="_292">
     </a>
     四、条件注解组合使用
    </h3>
    <p>
     条件注解可以组合使用，通过逻辑与关系（同时满足多个条件）或自定义组合注解（封装常用条件组合）创建更复杂的条件逻辑。
    </p>
    <h4>
     <a id="41__296">
     </a>
     4.1 多条件组合
    </h4>
    <p>
     当多个条件注解应用于同一个配置项时，所有条件都必须满足，配置才会生效。这实现了逻辑与（AND）的关系。
    </p>
    <pre><code class="prism language-java"><span class="token comment">/**
 * 多条件组合示例
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@ConditionalOnClass</span><span class="token punctuation">(</span><span class="token class-name">DataSource</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"spring.datasource.enabled"</span><span class="token punctuation">,</span> havingValue <span class="token operator">=</span> <span class="token string">"true"</span><span class="token punctuation">,</span> matchIfMissing <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnMissingBean</span><span class="token punctuation">(</span>type <span class="token operator">=</span> <span class="token string">"org.springframework.jdbc.core.JdbcOperations"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JdbcTemplateConfiguration</span> <span class="token punctuation">{<!-- --></span>
    
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">JdbcTemplate</span> <span class="token function">jdbcTemplate</span><span class="token punctuation">(</span><span class="token class-name">DataSource</span> dataSource<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JdbcTemplate</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     在这个例子中，只有同时满足以下条件，配置才会生效：
    </p>
    <ol>
     <li>
      类路径中存在DataSource类
     </li>
     <li>
      spring.datasource.enabled属性为true或未设置
     </li>
     <li>
      容器中不存在JdbcOperations类型的Bean
     </li>
    </ol>
    <h4>
     <a id="42__322">
     </a>
     4.2 自定义组合条件注解
    </h4>
    <p>
     对于频繁使用的条件组合，可以创建自定义的组合注解，提高代码的可读性和可维护性。
    </p>
    <pre><code class="prism language-java"><span class="token comment">/**
 * 自定义组合条件注解
 */</span>
<span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">TYPE</span><span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">METHOD</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Documented</span>
<span class="token annotation punctuation">@ConditionalOnClass</span><span class="token punctuation">(</span><span class="token class-name">DataSource</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"app.database.enabled"</span><span class="token punctuation">,</span> havingValue <span class="token operator">=</span> <span class="token string">"true"</span><span class="token punctuation">,</span> matchIfMissing <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnMissingBean</span><span class="token punctuation">(</span>type <span class="token operator">=</span> <span class="token string">"com.example.CustomDataManager"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">ConditionalOnDatabaseSupport</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

<span class="token comment">/**
 * 使用自定义组合条件注解
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@ConditionalOnDatabaseSupport</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DatabaseConfiguration</span> <span class="token punctuation">{<!-- --></span>
    
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">DataRepository</span> <span class="token function">dataRepository</span><span class="token punctuation">(</span><span class="token class-name">DataSource</span> dataSource<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JdbcDataRepository</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     通过这种方式，可以将复杂的条件逻辑封装在一个注解中，使代码更加简洁清晰。
    </p>
    <h3>
     <a id="_354">
     </a>
     五、条件注解实战应用
    </h3>
    <h4>
     <a id="51__356">
     </a>
     5.1 可插拔功能实现
    </h4>
    <p>
     条件注解可用于实现可插拔功能，通过添加或移除依赖，或修改配置属性，实现功能的动态启用或禁用，无需修改代码。
    </p>
    <pre><code class="prism language-java"><span class="token comment">/**
 * 可插拔缓存实现
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CacheConfiguration</span> <span class="token punctuation">{<!-- --></span>
    
    <span class="token annotation punctuation">@Configuration</span>
    <span class="token annotation punctuation">@ConditionalOnClass</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ConditionalOnProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"cache.type"</span><span class="token punctuation">,</span> havingValue <span class="token operator">=</span> <span class="token string">"redis"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">RedisCacheConfig</span> <span class="token punctuation">{<!-- --></span>
        
        <span class="token annotation punctuation">@Bean</span>
        <span class="token keyword">public</span> <span class="token class-name">CacheManager</span> <span class="token function">cacheManager</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span> redisConnectionFactory<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token class-name">RedisCacheManager</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>redisConnectionFactory<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Configuration</span>
    <span class="token annotation punctuation">@ConditionalOnClass</span><span class="token punctuation">(</span><span class="token class-name">CaffeineCacheManager</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ConditionalOnProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"cache.type"</span><span class="token punctuation">,</span> havingValue <span class="token operator">=</span> <span class="token string">"caffeine"</span><span class="token punctuation">,</span> matchIfMissing <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">CaffeineCacheConfig</span> <span class="token punctuation">{<!-- --></span>
        
        <span class="token annotation punctuation">@Bean</span>
        <span class="token keyword">public</span> <span class="token class-name">CacheManager</span> <span class="token function">cacheManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">CaffeineCacheManager</span> cacheManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CaffeineCacheManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            cacheManager<span class="token punctuation">.</span><span class="token function">setCaffeine</span><span class="token punctuation">(</span>
                <span class="token class-name">Caffeine</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">expireAfterWrite</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">HOURS</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">maximumSize</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> cacheManager<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     在这个例子中，通过条件注解和配置属性，可以灵活切换Redis缓存和Caffeine缓存，而无需修改代码。
    </p>
    <h4>
     <a id="52__399">
     </a>
     5.2 多环境适配
    </h4>
    <p>
     条件注解可以用于适配不同的运行环境，如开发、测试和生产环境，为每个环境提供适合的配置。
    </p>
    <pre><code class="prism language-java"><span class="token comment">/**
 * 多环境配置适配
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EnvironmentSpecificConfiguration</span> <span class="token punctuation">{<!-- --></span>
    
    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@ConditionalOnProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"app.environment"</span><span class="token punctuation">,</span> havingValue <span class="token operator">=</span> <span class="token string">"dev"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">DataSource</span> <span class="token function">devDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">EmbeddedDatabaseBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span><span class="token class-name">EmbeddedDatabaseType</span><span class="token punctuation">.</span><span class="token constant">H2</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@ConditionalOnProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"app.environment"</span><span class="token punctuation">,</span> havingValue <span class="token operator">=</span> <span class="token string">"prod"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ConditionalOnClass</span><span class="token punctuation">(</span><span class="token class-name">HikariDataSource</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">DataSource</span> <span class="token function">prodDataSource</span><span class="token punctuation">(</span>
            <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${app.datasource.url}"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> url<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${app.datasource.username}"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> username<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${app.datasource.password}"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> password<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        
        <span class="token class-name">HikariConfig</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HikariConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        config<span class="token punctuation">.</span><span class="token function">setJdbcUrl</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
        config<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
        config<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span>
        config<span class="token punctuation">.</span><span class="token function">setMaximumPoolSize</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">HikariDataSource</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="53__437">
     </a>
     5.3 第三方库集成
    </h4>
    <p>
     条件注解在与第三方库集成时特别有用，可以根据是否存在特定的第三方库类，动态配置集成点。
    </p>
    <pre><code class="prism language-java"><span class="token comment">/**
 * 第三方库集成示例
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IntegrationConfiguration</span> <span class="token punctuation">{<!-- --></span>
    
    <span class="token annotation punctuation">@Configuration</span>
    <span class="token annotation punctuation">@ConditionalOnClass</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"com.amazonaws.services.s3.AmazonS3"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">S3StorageConfiguration</span> <span class="token punctuation">{<!-- --></span>
        
        <span class="token annotation punctuation">@Bean</span>
        <span class="token annotation punctuation">@ConditionalOnProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"storage.type"</span><span class="token punctuation">,</span> havingValue <span class="token operator">=</span> <span class="token string">"s3"</span><span class="token punctuation">)</span>
        <span class="token keyword">public</span> <span class="token class-name">StorageService</span> <span class="token function">s3StorageService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">S3StorageService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Configuration</span>
    <span class="token annotation punctuation">@ConditionalOnClass</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"com.azure.storage.blob.BlobServiceClient"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">AzureStorageConfiguration</span> <span class="token punctuation">{<!-- --></span>
        
        <span class="token annotation punctuation">@Bean</span>
        <span class="token annotation punctuation">@ConditionalOnProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"storage.type"</span><span class="token punctuation">,</span> havingValue <span class="token operator">=</span> <span class="token string">"azure"</span><span class="token punctuation">)</span>
        <span class="token keyword">public</span> <span class="token class-name">StorageService</span> <span class="token function">azureStorageService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AzureBlobStorageService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Configuration</span>
    <span class="token annotation punctuation">@ConditionalOnMissingClass</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"com.amazonaws.services.s3.AmazonS3"</span><span class="token punctuation">,</span> <span class="token string">"com.azure.storage.blob.BlobServiceClient"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ConditionalOnProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"storage.type"</span><span class="token punctuation">,</span> havingValue <span class="token operator">=</span> <span class="token string">"local"</span><span class="token punctuation">,</span> matchIfMissing <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">LocalStorageConfiguration</span> <span class="token punctuation">{<!-- --></span>
        
        <span class="token annotation punctuation">@Bean</span>
        <span class="token keyword">public</span> <span class="token class-name">StorageService</span> <span class="token function">localStorageService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">LocalFileStorageService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     在这个例子中，根据类路径中是否存在特定的云存储SDK类，以及配置的存储类型，动态选择合适的存储服务实现。
    </p>
    <h3>
     <a id="_485">
     </a>
     六、条件注解最佳实践
    </h3>
    <h4>
     <a id="61__487">
     </a>
     6.1 设计原则
    </h4>
    <p>
     使用条件注解时，应遵循以下设计原则：
    </p>
    <ol>
     <li>
      <strong>
       单一职责
      </strong>
      ：每个条件注解应该检查单一条件，避免在一个注解中混合多种条件类型
     </li>
     <li>
      <strong>
       清晰可读
      </strong>
      ：使用有意义的条件表达式，使配置逻辑易于理解
     </li>
     <li>
      <strong>
       默认行为明确
      </strong>
      ：使用matchIfMissing、havingValue等参数明确指定默认行为
     </li>
     <li>
      <strong>
       组合而非嵌套
      </strong>
      ：优先使用多个条件注解组合，而非复杂的嵌套条件表达式
     </li>
    </ol>
    <pre><code class="prism language-java"><span class="token comment">/**
 * 条件注解最佳实践示例
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BestPracticeConfiguration</span> <span class="token punctuation">{<!-- --></span>
    
    <span class="token comment">// 好的实践：清晰的单一条件</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@ConditionalOnClass</span><span class="token punctuation">(</span><span class="token class-name">DataSource</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ConditionalOnProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"app.repository.enabled"</span><span class="token punctuation">,</span> havingValue <span class="token operator">=</span> <span class="token string">"true"</span><span class="token punctuation">,</span> matchIfMissing <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">JdbcRepository</span> <span class="token function">jdbcRepository</span><span class="token punctuation">(</span><span class="token class-name">DataSource</span> dataSource<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JdbcRepositoryImpl</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 避免的实践：过于复杂的条件表达式</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@ConditionalOnExpression</span><span class="token punctuation">(</span><span class="token string">"${complex.condition1} and (${complex.condition2} or ${complex.condition3})"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">ComplexService</span> <span class="token function">complexService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ComplexServiceImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="62__520">
     </a>
     6.2 调试技巧
    </h4>
    <p>
     SpringBoot提供了调试条件评估结果的功能，通过启用debug日志或使用专用属性，可以查看哪些自动配置类被应用或排除，以及原因。
    </p>
    <pre><code class="prism language-properties"># application.properties中启用条件评估报告
debug=true
</code></pre>
    <p>
     在调试模式下，SpringBoot会输出详细的条件评估报告，包括每个配置类的条件匹配结果。这有助于理解为什么某些配置未被应用，以及如何调整条件以满足需求。
    </p>
    <pre><code class="prism language-java"><span class="token comment">/**
 * 检查条件评估结果的示例代码
 */</span>
<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">ConditionEvaluationReport</span> report<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">printReport</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 获取未匹配的条件</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">ConditionOutcome</span><span class="token punctuation">&gt;</span></span> outcomes <span class="token operator">=</span> report<span class="token punctuation">.</span><span class="token function">getConditionAndOutcomesBySource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 打印每个配置的条件评估结果</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">ConditionOutcome</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> outcomes<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">": "</span> <span class="token operator">+</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="63__549">
     </a>
     6.3 性能考量
    </h4>
    <p>
     条件注解的评估会在应用启动时进行，可能影响启动时间。为了优化性能，应注意以下几点：
    </p>
    <ol>
     <li>
      <strong>
       避免过多条件
      </strong>
      ：过多的条件注解会增加启动时间
     </li>
     <li>
      <strong>
       优化条件顺序
      </strong>
      ：将可能快速失败的条件放在前面
     </li>
     <li>
      <strong>
       使用缓存
      </strong>
      ：对于频繁使用的条件检查，使用缓存避免重复计算
     </li>
    </ol>
    <pre><code class="prism language-java"><span class="token comment">/**
 * 条件注解性能优化示例
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OptimizedClassCondition</span> <span class="token keyword">implements</span> <span class="token class-name">Condition</span> <span class="token punctuation">{<!-- --></span>
    
    <span class="token comment">// 条件检查结果缓存</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> conditionCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">matches</span><span class="token punctuation">(</span><span class="token class-name">ConditionContext</span> context<span class="token punctuation">,</span> <span class="token class-name">AnnotatedTypeMetadata</span> metadata<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 获取要检查的类名</span>
        <span class="token class-name">String</span> className <span class="token operator">=</span> <span class="token function">getClassNameFromMetadata</span><span class="token punctuation">(</span>metadata<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 从缓存中获取结果，如果不存在则计算并缓存</span>
        <span class="token keyword">return</span> conditionCache<span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span>className<span class="token punctuation">,</span> cn <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>cn<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 获取类名的辅助方法</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getClassNameFromMetadata</span><span class="token punctuation">(</span><span class="token class-name">AnnotatedTypeMetadata</span> metadata<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 实现细节省略</span>
        <span class="token keyword">return</span> <span class="token string">"com.example.SomeClass"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="_590">
     </a>
     总结
    </h3>
    <p>
     SpringBoot的条件注解体系提供了强大而灵活的机制，使配置能够根据运行环境、依赖情况和配置属性等条件动态调整。@ConditionalOnClass等注解在自动配置和可插拔功能实现中发挥着重要作用，使得应用能够自适应地调整其行为和功能。
    </p>
    <p>
     通过深入理解条件注解的工作原理和使用场景，开发者可以创建更加智能和灵活的应用配置，实现"约定优于配置"的理念，同时保留在必要时进行定制的能力。条件注解不仅在SpringBoot自动配置中广泛应用，也是开发者构建灵活、可扩展应用的重要工具。
    </p>
    <p>
     在实际应用中，合理组合使用条件注解，遵循最佳实践，可以使应用配置更加清晰、灵活，同时保持良好的可维护性和可扩展性。通过条件注解，SpringBoot真正实现了"开箱即用，按需配置"的理念，为Java应用开发带来了极大的便利。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f35353334343337352f:61727469636c652f64657461696c732f313435393838373938" class_="artid" style="display:none">
 </p>
</div>


