---
layout: post
title: "旋转验证码截图识别"
date: 2025-03-10 16:42:34 +0800
description: "这里讲解识别思路前，需要注意一个地方，因为是截图，每个设备分辨率以及截图方式的不同，会导致算法准确度有差异，所以在ocr的demo网站中我上传了三种思路方式，识别方式各有差异，可能你的第一种方式准确率有80，他的第二种方式有80，并且整体截图识别的准确率也无法保证到很高，原因除了上述讲的一种外，还有就是整体图库是很大的"
keywords: "京东旋转验证码返回角度"
categories: ['Ocr']
tags: ['验证码识别', '计算机视觉', '人工智能']
artid: "146156926"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146156926
    alt: "旋转验证码截图识别"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146156926
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146156926
cover: https://bing.ee123.net/img/rand?artid=146156926
image: https://bing.ee123.net/img/rand?artid=146156926
img: https://bing.ee123.net/img/rand?artid=146156926
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     旋转验证码截图识别
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <blockquote>
     <p>
      注意，本文只提供学习的思路，严禁违反法律以及破坏信息系统等行为，本文只提供思路
      <br/>
      如有侵犯，请联系作者下架
     </p>
    </blockquote>
    <p>
     <font color="#dd0000">
      <strong>
       本文识别已同步上线至OCR识别网站： http://yxlocr.nat300.top/ocr/other/27
      </strong>
     </font>
    </p>
    <p>
     之前写过一篇文章，某东黑边旋转验证码识别，识别思路还是一样，基于梯度的计算，大家看这篇文章可以复习下这篇，链接如下：
     <a href="https://blog.csdn.net/qq_36551453/article/details/143943545?spm=1001.2014.3001.5501">
      京东黑边背景旋转验证码识别
     </a>
     ，
     <strong>
      本文开始前，先声明一下，本文提供思路，不会放完整代码，有的小伙伴拿我的思路去GPT或者别的大模型那反推，你推出来没有关系，但是你推出来准确率低，来找我要源码，说什么我推出来迟早能做出来，还不如给他源码，什么恶心人的逻辑，还是为了自己卖课用，如此自傲，能推出来一时推不了一世，换个样子你就不会做了，还是老老实实打基础学思路，才能灵活应变
     </strong>
    </p>
    <p>
     先来看截图验证码部分数据集
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/769fe298ace5463ab2bf71cd9b6b7aab.png">
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/f5cc95250d9a48f09b9e90ec6b014c31.png">
       <br/>
       这里讲解识别思路前，需要注意一个地方，因为是截图，每个设备分辨率以及截图方式的不同，会导致算法准确度有差异，所以在ocr的demo网站中我上传了三种思路方式，识别方式各有差异，可能你的第一种方式准确率有80，他的第二种方式有80，并且整体截图识别的准确率也无法保证到很高，原因除了上述讲的一种外，还有就是整体图库是很大的
      </img>
     </img>
    </p>
    <h2>
     <a id="_12">
     </a>
     识别思路
    </h2>
    <blockquote>
     <h6>
      <a id="ocrsobel_14">
      </a>
      注意：本文解决方法为ocr识别网站第一种方式，切图边缘sobel梯度
     </h6>
    </blockquote>
    <h3>
     <a id="1_16">
     </a>
     1、取出旋转缺口
    </h3>
    <p>
     取出旋转接口只要根据黑边的特征去取就可以了，从图中心开始，往外计算黑边圆，使用霍夫圆检测，下面我直接放出代码，以下图作为demo演示
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/e52f8725183f428dbf50ee2046771796.jpeg"/>
    </p>
    <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">get_radius</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">:</span>
    center_tolerance <span class="token operator">=</span> <span class="token number">10</span>

    height<span class="token punctuation">,</span> width <span class="token operator">=</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>
    image_center <span class="token operator">=</span> <span class="token punctuation">(</span>width <span class="token operator">//</span> <span class="token number">2</span><span class="token punctuation">,</span> height <span class="token operator">//</span> <span class="token number">2</span><span class="token punctuation">)</span>

    gray <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>image<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_BGR2GRAY<span class="token punctuation">)</span>

    blurred <span class="token operator">=</span> cv2<span class="token punctuation">.</span>GaussianBlur<span class="token punctuation">(</span>gray<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>

    circles <span class="token operator">=</span> cv2<span class="token punctuation">.</span>HoughCircles<span class="token punctuation">(</span>
        blurred<span class="token punctuation">,</span>  <span class="token comment"># 输入图像</span>
        cv2<span class="token punctuation">.</span>HOUGH_GRADIENT<span class="token punctuation">,</span>  <span class="token comment"># 检测方法</span>
        dp<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>  <span class="token comment"># 分辨率与图像分辨率的反比</span>
        minDist<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span>  <span class="token comment"># 圆心之间的最小距离</span>
        param1<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span>  <span class="token comment"># Canny边缘检测的高阈值</span>
        param2<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">,</span>  <span class="token comment"># 圆心检测的阈值</span>
        minRadius<span class="token operator">=</span><span class="token number">90</span><span class="token punctuation">,</span>  <span class="token comment"># 最小半径</span>
        maxRadius<span class="token operator">=</span><span class="token number">1100</span>  <span class="token comment"># 最大半径</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">if</span> circles <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        circles <span class="token operator">=</span> np<span class="token punctuation">.</span>uint16<span class="token punctuation">(</span>np<span class="token punctuation">.</span>around<span class="token punctuation">(</span>circles<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> circles<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            center <span class="token operator">=</span> <span class="token punctuation">(</span>i<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> i<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            radius <span class="token operator">=</span> i<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>

            <span class="token comment"># 计算圆心与图像中心点的距离</span>
            distance <span class="token operator">=</span> np<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span><span class="token punctuation">(</span>center<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> image_center<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token punctuation">(</span>center<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> image_center<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span>

            <span class="token comment"># 如果圆心距离图像中心在允许范围内，则保留该圆</span>
            <span class="token keyword">if</span> distance <span class="token operator">&lt;=</span> center_tolerance<span class="token punctuation">:</span>
                <span class="token keyword">return</span> radius
    
    <span class="token comment"># 如果检测不到，则输出一个大部分通用半径</span>
    <span class="token keyword">return</span> <span class="token number">173</span>
</code></pre>
    <p>
     取出圆后，效果如下
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/01a9b73129c64127b29d0507e3a7d7ec.png"/>
    </p>
    <h3>
     <a id="2_61">
     </a>
     2、边缘降噪
    </h3>
    <p>
     边缘降噪还是和之前的方式类似，从市面上这么多验证码来看，大致常用的几种方式为（切割小圆、消除黑边、色域转换），本文采用切割小圆+消除黑边的形式，具体为切割小圆后，去除小圆周围的黑边，并等比例放大
    </p>
    <pre><code class="prism language-python"><span class="token comment"># 切割小圆</span>
imagearray_que <span class="token operator">=</span> split_cicle<span class="token punctuation">(</span>imagearray_que<span class="token punctuation">,</span> radius <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">)</span>
imagearray_que <span class="token operator">=</span> large_img<span class="token punctuation">(</span>imagearray_que<span class="token punctuation">,</span> <span class="token number">1.04</span><span class="token punctuation">)</span>
<span class="token comment"># 缩小大图，消除黑边</span>
imagearray_bg <span class="token operator">=</span> bg_circle<span class="token punctuation">(</span>imagearray_bg<span class="token punctuation">,</span> radius<span class="token punctuation">,</span> renum<span class="token operator">=</span><span class="token number">.93</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     通过上述方法后，小圆和背景图如下：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/d1bd48c4c5d24889bff4129747a27585.png">
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/6deae618919941e48074d1eb6f15c825.png"/>
     </img>
    </p>
    <h4>
     <a id="3_74">
     </a>
     3、计算最小梯度
    </h4>
    <p>
     最小梯度还是和以前一样，万年不变的老套路，具体步骤思路可以看下代码
    </p>
    <pre><code class="prism language-python">
<span class="token keyword">def</span> <span class="token function">merge_img</span><span class="token punctuation">(</span>que_result<span class="token punctuation">,</span> bg_image<span class="token punctuation">,</span> radius<span class="token punctuation">,</span> angle<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 根据角度将圆放置到背景图中</span>
    que_height<span class="token punctuation">,</span> que_width <span class="token operator">=</span> que_result<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>
    <span class="token comment"># 计算旋转矩阵</span>
    rotation_matrix <span class="token operator">=</span> cv2<span class="token punctuation">.</span>getRotationMatrix2D<span class="token punctuation">(</span><span class="token punctuation">(</span>que_width <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> que_height <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> angle<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token comment"># 应用旋转矩阵进行旋转</span>
    xuanzhuan_result <span class="token operator">=</span> cv2<span class="token punctuation">.</span>warpAffine<span class="token punctuation">(</span>que_result<span class="token punctuation">,</span> rotation_matrix<span class="token punctuation">,</span> <span class="token punctuation">(</span>que_width<span class="token punctuation">,</span> que_height<span class="token punctuation">)</span><span class="token punctuation">)</span>
    center <span class="token operator">=</span> <span class="token punctuation">(</span>bg_image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">//</span> <span class="token number">2</span><span class="token punctuation">,</span> bg_image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">//</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token comment"># 创建掩膜图像，尺寸与背景图像一致</span>
    mask <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros_like<span class="token punctuation">(</span>bg_image<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    cv2<span class="token punctuation">.</span>circle<span class="token punctuation">(</span>mask<span class="token punctuation">,</span> center<span class="token punctuation">,</span> radius<span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment"># 在掩膜中画圆</span>
    <span class="token comment"># 计算旋转后的图像放置位置</span>
    bg_height<span class="token punctuation">,</span> bg_width <span class="token operator">=</span> bg_image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>
    circle_height<span class="token punctuation">,</span> circle_width <span class="token operator">=</span> xuanzhuan_result<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>
    <span class="token comment"># 创建掩膜区域</span>
    mask_overlay <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros_like<span class="token punctuation">(</span>bg_image<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token comment"># 将掩膜区域扩展到三通道</span>
    mask_overlay <span class="token operator">=</span> cv2<span class="token punctuation">.</span>merge<span class="token punctuation">(</span><span class="token punctuation">[</span>mask_overlay<span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment"># 创建一个与背景图像相同尺寸的全透明图像</span>
    result_with_que <span class="token operator">=</span> np<span class="token punctuation">.</span>copy<span class="token punctuation">(</span>bg_image<span class="token punctuation">)</span>

    <span class="token keyword">return</span> result_with_que

<span class="token keyword">def</span> <span class="token function">calculate_gradient_difference</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> circle_radius<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""计算内外圆的梯度差异"""</span>
    center_x <span class="token operator">=</span> result<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">//</span> <span class="token number">2</span>
    center_y <span class="token operator">=</span> result<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">//</span> <span class="token number">2</span>

    <span class="token comment"># 创建内外圆遮罩</span>
    circle_inner_mask <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros_like<span class="token punctuation">(</span>result<span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>
    cv2<span class="token punctuation">.</span>circle<span class="token punctuation">(</span>circle_inner_mask<span class="token punctuation">,</span> <span class="token punctuation">(</span>center_x<span class="token punctuation">,</span> center_y<span class="token punctuation">)</span><span class="token punctuation">,</span> circle_radius <span class="token operator">-</span> <span class="token number">10000</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span>
    circle_outer_mask <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros_like<span class="token punctuation">(</span>result<span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>
    cv2<span class="token punctuation">.</span>circle<span class="token punctuation">(</span>circle_outer_mask<span class="token punctuation">,</span> <span class="token punctuation">(</span>center_x<span class="token punctuation">,</span> center_y<span class="token punctuation">)</span><span class="token punctuation">,</span> circle_radius <span class="token operator">+</span> <span class="token number">10000</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 分别计算内外圆的梯度</span>
    inner_pixels <span class="token operator">=</span> cv2<span class="token punctuation">.</span>bitwise_and<span class="token punctuation">(</span>result<span class="token punctuation">,</span> circle_inner_mask<span class="token punctuation">)</span>
    outer_pixels <span class="token operator">=</span> cv2<span class="token punctuation">.</span>bitwise_and<span class="token punctuation">(</span>result<span class="token punctuation">,</span> circle_outer_mask<span class="token punctuation">)</span>

    inner_sobel_x <span class="token operator">=</span> cv2<span class="token punctuation">.</span>Sobel<span class="token punctuation">(</span>inner_pixels<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>CV_64F<span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span>
    inner_sobel_y <span class="token operator">=</span> cv2<span class="token punctuation">.</span>Sobel<span class="token punctuation">(</span>inner_pixels<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>CV_64F<span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span>
    inner_gradient_magnitude <span class="token operator">=</span> cv2<span class="token punctuation">.</span>magnitude<span class="token punctuation">(</span>inner_sobel_x<span class="token punctuation">,</span> inner_sobel_y<span class="token punctuation">)</span>

    gradient_diff <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>inner_gradient_magnitude<span class="token punctuation">)</span>
    <span class="token keyword">return</span> gradient_diff
    
<span class="token keyword">for</span> angle <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">360</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 将圆叠加到</span>
    背景图中
    image <span class="token operator">=</span> merge_img<span class="token punctuation">(</span>imagearray_que<span class="token punctuation">,</span> imagearray_bg<span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>radius<span class="token punctuation">)</span><span class="token punctuation">,</span> angle<span class="token punctuation">)</span>
    
    gradient_diff <span class="token operator">=</span> calculate_gradient_difference<span class="token punctuation">(</span>image<span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>radius<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> gradient_diff <span class="token operator">&lt;</span> min_diff<span class="token punctuation">:</span>
        min_diff <span class="token operator">=</span> gradient_diff
        min_l <span class="token operator">=</span> angle
        
pred_str <span class="token operator">=</span> min_l
</code></pre>
    <p>
     通过计算后，再将正确角度覆盖到背景中展现，如下
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/9d645d4a4d5e4c1e896e377984ebbb41.png"/>
    </p>
    <h4>
     <a id="4_138">
     </a>
     4、结语
    </h4>
    <p>
     如果使用原图，准确率至少可达到90，所以能拿到原图不要死磕截图了，不过截图的识别整体过程确实更有意思，因为你不知道你的图像算法对于整体体征到底好不好用，有时候可能不是你的算法不要用，是截图截的太屎了，如果本文还有没有介绍到的地方，欢迎提出
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f33363535313435332f:61727469636c652f64657461696c732f313436313536393236" class_="artid" style="display:none">
 </p>
</div>


