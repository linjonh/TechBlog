---
layout: post
title: "centos-steam8-部署k8s"
date: 2025-03-13 21:01:03 +0800
description: "如果没有保存也可以用kubeadm token create --print-join-command命令重新生成token。在node节点执行主节点初始化时生成的join语句，一下就代表节点已经加入集群。初始化完成后，最后会输出一个join命令，先保存，后面从节点加入集群会用到。1、创建一个简单的deployment以运行nginx。4、查看名称空间kube-system下所有的pod。将桥接的ipv4流量传递到iptables的链。可以发现大部分组件都是以pod的形式运行的。配置密钥**（主节点）**"
keywords: "centos steam8 部署k8s"
categories: ['未分类']
tags: ['Linux', 'Kubernetes', 'Centos']
artid: "146242266"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146242266
    alt: "centos-steam8-部署k8s"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146242266
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146242266
cover: https://bing.ee123.net/img/rand?artid=146242266
image: https://bing.ee123.net/img/rand?artid=146242266
img: https://bing.ee123.net/img/rand?artid=146242266
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     centos steam8 部署k8s
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="kubernetes_0">
     </a>
     kubernetes搭建
    </h2>
    <h3>
     <a id="toc_2">
     </a>
    </h3>
    <h2>
     <a id="_5">
     </a>
     准备工作（三节点）
    </h2>
    <p>
     关闭防火墙
    </p>
    <pre><code class="prism language-bash">systemctl disable <span class="token parameter variable">--now</span> firewalls
</code></pre>
    <pre><code class="prism language-bash"><span class="token function">vi</span> /etc/selinux/config
enabled改成disable
</code></pre>
    <p>
     永久关闭swap功能并重启
    </p>
    <pre><code class="prism language-bash">swapoff <span class="token parameter variable">-a</span>
<span class="token function">free</span> <span class="token parameter variable">-h</span>
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># sed -ri 's/.*swap.*/#&amp;/' /etc/fstab </span>
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># 添加三台的主机IP地址映射</span>
</code></pre>
    <p>
     将桥接的ipv4流量传递到iptables的链
    </p>
    <pre><code class="prism language-bash"><span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/sysctl.d/k8s.conf <span class="token operator">&lt;&lt;</span> EOF
<span class="token operator">&gt;</span> net.bridge.bridge-nf-call-ip6tables <span class="token operator">=</span> <span class="token number">1</span>
<span class="token operator">&gt;</span> net.bridge.bridge-nf-call-iptables <span class="token operator">=</span> <span class="token number">1</span>
<span class="token operator">&gt;</span> EOF

<span class="token function">sysctl</span> <span class="token parameter variable">--system</span>
</code></pre>
    <p>
     时间同步
    </p>
    <pre><code class="prism language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># mv /etc/yum.repos.d/* /media/</span>
<span class="token function">curl</span> <span class="token parameter variable">-o</span> /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-vault-8.5.2111.repo


<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token parameter variable">-e</span> <span class="token string">'/mirrors.cloud.aliyuncs.com/d'</span> <span class="token parameter variable">-e</span> <span class="token string">'/mirrors.aliyuncs.com/d'</span> /etc/yum.repos.d/CentOS-Base.repo

dnf <span class="token parameter variable">-y</span> <span class="token function">install</span> chrony

<span class="token function">vi</span> /etc/chronyd.conf
	pool time1.aliyun.co iburst
	
systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> chronyd
</code></pre>
    <p>
     配置密钥**（主节点）**
    </p>
    <pre><code class="prism language-bash">ssh-keygen <span class="token parameter variable">-t</span> rsa
ssh-copy-id master<span class="token punctuation">(</span>IP<span class="token punctuation">)</span>
ssh-copy-id node1<span class="token punctuation">(</span>IP<span class="token punctuation">)</span>
ssh-copy-id node2<span class="token punctuation">(</span>IP<span class="token punctuation">)</span>
</code></pre>
    <h2>
     <a id="docker_64">
     </a>
     安装docker(三节点)
    </h2>
    <pre><code class="prism language-bash">yum <span class="token function">install</span> <span class="token parameter variable">-y</span> yum-utils <span class="token function">vim</span> bash-com*

yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo

yum <span class="token function">install</span> docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

<span class="token function">service</span> <span class="token function">docker</span> start

<span class="token function">docker</span> version
</code></pre>
    <p>
     配置镜像加速器
    </p>
    <pre><code class="prism language-bash"><span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/docker/daemon.json <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
{
  "registry-mirrors": [
     "https://docker.1ms.run",
     "https://docker.xuanyuan.me"]
}
EOF</span>
<span class="token function">sudo</span> systemctl daemon-reload
<span class="token function">sudo</span> systemctl restart <span class="token function">docker</span>
</code></pre>
    <h2>
     <a id="cridockerd_92">
     </a>
     安装cri-dockerd（三节点）
    </h2>
    <pre><code class="prism language-bash"><span class="token function">wget</span> https://github.com/Mirantis/cri-dockerd/releases/download/v0.3.2/cri-dockerd-0.3.2-3.el7.x86_64.rpm

<span class="token function">rpm</span> <span class="token parameter variable">-ivh</span> cri-dockerd-0.3.2-3.el7.x86_64.rpm

<span class="token function">vi</span> /usr/lib/systemd/system/cri-docker.service
删除这行的代码写入这个代码	<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/bin/cri-dockerd --container-runtime-endpoint fd:// --pod-infra-container-image<span class="token operator">=</span>registry.aliyuncs.com/google_containers/pause:3.9

systemctl daemon-reload

systemctl <span class="token builtin class-name">enable</span> cri-docker <span class="token operator">&amp;&amp;</span> systemctl start cri-docker
</code></pre>
    <h2>
     <a id="_107">
     </a>
     添加阿里云软件源（三节点）
    </h2>
    <pre><code>cat &gt; /etc/yum.repos.d/kubernetes.repo &lt;&lt; EOF
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=0
repo_gpgcheck=0
gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF
</code></pre>
    <h2>
     <a id="kubeadmkubeletkubectl_121">
     </a>
     安装kubeadm、kubelet、kubectl（三节点）
    </h2>
    <pre><code>yum install -y kubelet-1.28.0 kubeadm-1.28.0 kubectl-1.28.0
systemctl enable kubelet
</code></pre>
    <h2>
     <a id="master_128">
     </a>
     初始化master节点
    </h2>
    <pre><code class="prism language-bash">kubeadm init <span class="token punctuation">\</span>
  --apiserver-advertise-address<span class="token operator">=</span><span class="token number">192.168</span>.100.31 <span class="token punctuation">\</span>
  --image-repository registry.aliyuncs.com/google_containers <span class="token punctuation">\</span>
  --kubernetes-version v1.28.0 <span class="token punctuation">\</span>
  --service-cidr<span class="token operator">=</span><span class="token number">10.96</span>.0.0/12 <span class="token punctuation">\</span>
  --pod-network-cidr<span class="token operator">=</span><span class="token number">10.244</span>.0.0/16 <span class="token punctuation">\</span>
  --cri-socket<span class="token operator">=</span>unix:///var/run/cri-dockerd.sock <span class="token punctuation">\</span>
  --ignore-preflight-errors<span class="token operator">=</span>all
 
</code></pre>
    <pre><code>--apiserver-advertise-address 集群通告地址
--image-repository 由于默认拉取镜像地址k8s.gcr.io国内无法访问，这里指定阿里云镜像仓库地址
--kubernetes-version K8s版本，与上面安装的一致
--service-cidr 集群内部虚拟网络，Pod统一访问入口
--pod-network-cidr Pod网络，与下面部署的CNI网络组件yaml中保持一致
--cri-socket 指定cri-dockerd接口，如果是containerd则使用--cri-socket unix:///run/containerd/containerd.sock
</code></pre>
    <ul>
     <li>
      <p>
       初始化完成后，最后会输出一个join命令，先保存，后面从节点加入集群会用到
      </p>
     </li>
     <li>
      <p>
       如果没有保存也可以用kubeadm token create --print-join-command命令重新生成token
      </p>
     </li>
    </ul>
    <pre><code class="prism language-bash">接着、拷贝kubectl使用的连接ks认证文件到默认路径
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token environment constant">$HOME</span>/.kube
<span class="token function">sudo</span> <span class="token function">cp</span> <span class="token parameter variable">-i</span> /etc/kubernetes/admin.conf <span class="token environment constant">$HOME</span>/.kube/config
<span class="token function">sudo</span> <span class="token function">chown</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> <span class="token parameter variable">-u</span><span class="token variable">)</span></span><span class="token builtin class-name">:</span><span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> <span class="token parameter variable">-g</span><span class="token variable">)</span></span> <span class="token environment constant">$HOME</span>/.kube/config

此时就可以使用kubectl工具管理k8s集群了、列入查看工作节点
kubectl get nodes
节点状态为NotReady，是因为没有安装网络插件，后买你节点加入后会安装部署
</code></pre>
    <h2>
     <a id="node_164">
     </a>
     加入node节点
    </h2>
    <p>
     在node节点执行主节点初始化时生成的join语句，一下就代表节点已经加入集群
    </p>
    <pre><code class="prism language-bash"><span class="token punctuation">[</span>root@k8s-node2 ~<span class="token punctuation">]</span><span class="token comment"># kubeadm join 192.168.124.222:6443 --token 9k6b0f.qxgcphu3a0vojhj5 --discovery-token-ca-cert-hash sha256:a08e6f0de63297aa1a88563db346a4150d4e607ab3a9c64d44dccb59b2ea9083</span>
Found multiple CRI endpoints on the host. Please define <span class="token function">which</span> one <span class="token keyword">do</span> you wish to use by setting the <span class="token string">'criSocket'</span> field <span class="token keyword">in</span> the kubeadm configuration file: unix:///var/run/containerd/containerd.sock, unix:///var/run/cri-dockerd.sock
To see the stack trace of this error execute with <span class="token parameter variable">--v</span><span class="token operator">=</span><span class="token number">5</span> or higher
	解决方法：这是表示在主机上找到多个CRI端口，可能是系统上运行了多个容器containerd或Docker。可以在join语句后面添加--cri-socket<span class="token operator">=</span>unix:///var/run/containerd/containerd.sock或者--cri-socket<span class="token operator">=</span>unix:///var/run/cri-dockerd.sock来指定容器执行命令
</code></pre>
    <h2>
     <a id="master_175">
     </a>
     安装网络插件（master）
    </h2>
    <ul>
     <li>
      1、从官网撒谎给你下载按爪给你Calico插件所需的配置文件
     </li>
    </ul>
    <pre><code class="prism language-bash"><span class="token function">wget</span> https://docs.projectcalico.org/manifests/calico.yaml
</code></pre>
    <ul>
     <li>
      <p>
       2.修改配置文件，将CALICO_IPV4POOL_CIDR值设置为之前指定的地址
      </p>
      <ul>
       <li>
        <pre><code class="prism language-bash">- name: CALICO_IPV4POOL_CIDR
- value: <span class="token string">"10.244.0.0/16"</span>
</code></pre>
       </li>
      </ul>
     </li>
     <li>
      <p>
       3、插件部署
      </p>
     </li>
     <li>
      <pre><code>kubectl apply -f calico.yaml
</code></pre>
     </li>
     <li>
      <p>
       4、查看名称空间kube-system下所有的pod
      </p>
     </li>
    </ul>
    <pre><code>kubectl get pods -n kube-system
</code></pre>
    <p>
     可以发现大部分组件都是以pod的形式运行的
    </p>
    <ul>
     <li>
      5、进一步查看calico插件在各节点上的部署情况
     </li>
    </ul>
    <pre><code>kubectl get pods -A -o wide | grep calico
</code></pre>
    <h2>
     <a id="master_214">
     </a>
     测试集群（master）
    </h2>
    <p>
     1、创建一个简单的deployment以运行nginx
    </p>
    <pre><code class="prism language-bash">kubectl create deployment nginx <span class="token parameter variable">--image</span><span class="token operator">=</span>nginx:1.8.1
</code></pre>
    <p>
     2、将改deployment发布为service一共外部访问
    </p>
    <pre><code class="prism language-bash">kubectl expose deployment nginx <span class="token parameter variable">--port</span><span class="token operator">=</span><span class="token number">80</span> <span class="token parameter variable">--type</span><span class="token operator">=</span>NodePort
</code></pre>
    <p>
     3、查看pod和service是否正常运行
    </p>
    <pre><code class="prism language-bash">kubectl get,svc
</code></pre>
    <h2>
     <a id="Dashboardmaster_234">
     </a>
     部署Dashboard（master）
    </h2>
    <ul>
     <li>
      <p>
       Dashboard是官方提供的一个UI，可用于基本管理K8s资源
      </p>
      <pre><code class="prism language-bash"><span class="token function">wget</span> https://raw.githubusercontent.com/kubernetes/dashboard/v2.7.0/aio/deploy/recommended.yaml
</code></pre>
      <ul>
       <li>
        修改配置文件暴露服务
        <ul>
         <li>
          type：NodePort
         </li>
         <li>
          nodePort： 30005
         </li>
        </ul>
       </li>
      </ul>
     </li>
     <li>
      <p>
       应用文件
      </p>
      <ul>
       <li>
        kubectl apply -f recommended.yaml
       </li>
      </ul>
     </li>
     <li>
      <p>
       访问地址：https://master节点IP:30005
      </p>
     </li>
     <li>
      <p>
       创建service account并绑定默认cluster-admin管理员集群角色
      </p>
      <ul>
       <li>
        <pre><code class="prism language-bash">- <span class="token punctuation">\</span># 创建用户
 kubectl create serviceaccount dashboard-admin <span class="token parameter variable">-n</span> kubernetes-dashboard
 <span class="token punctuation">\</span># 用户授权
 kubectl create clusterrolebinding dashboard-admin <span class="token parameter variable">--clusterrole</span><span class="token operator">=</span>cluster-admin <span class="token parameter variable">--serviceaccount</span><span class="token operator">=</span>kubernetes-dashboard:dashboard-admin
- <span class="token punctuation">\</span># 获取用户Token,每次使用都会新生成Token,之前生成的Token会作废
 kubectl create token dashboard-admin <span class="token parameter variable">-n</span> kubernetes-dashboard
</code></pre>
       </li>
      </ul>
     </li>
    </ul>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f:672e6373646e2e6e65742f323430315f38333536323439342f:61727469636c652f64657461696c732f313436323432323636" class_="artid" style="display:none">
 </p>
</div>


