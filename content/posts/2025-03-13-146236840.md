---
layout: post
title: "Python实战进阶第21集数据存储Redis-与-MongoDB-的使用场景"
date: 2025-03-13 17:17:31 +0800
description: "在现代应用开发中，数据存储的选择直接影响系统的性能、扩展性和成本。Redis 和 MongoDB 是两种极具代表性的数据库技术，它们分别擅长解决不同场景下的问题。本文将深入探讨 Redis 的高级数据结构（如 HyperLogLog 和 Geospatial）以及 MongoDB 的分片集群机制和变更流功能，并通过两个实战案例展示如何在实际项目中结合这两种技术。此外，我们还将讨论冷热数据分离、TTL 索引以及多模数据库的对比分析，帮助读者构建高效的数据存储架构。"
keywords: "《Python实战进阶》第21集：数据存储：Redis 与 MongoDB 的使用场景"
categories: ['Python']
tags: ['数据库架构', 'Redis', 'Python', 'Mongodb']
artid: "146236840"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146236840
    alt: "Python实战进阶第21集数据存储Redis-与-MongoDB-的使用场景"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146236840
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146236840
cover: https://bing.ee123.net/img/rand?artid=146236840
image: https://bing.ee123.net/img/rand?artid=146236840
img: https://bing.ee123.net/img/rand?artid=146236840
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     《Python实战进阶》第21集：数据存储：Redis 与 MongoDB 的使用场景
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="21Redis__MongoDB__3">
     </a>
     第21集：数据存储：Redis 与 MongoDB 的使用场景
    </h2>
    <hr/>
    <h3>
     <a id="_7">
     </a>
     <strong>
      摘要
     </strong>
    </h3>
    <p>
     在现代应用开发中，数据存储的选择直接影响系统的性能、扩展性和成本。Redis 和 MongoDB 是两种极具代表性的数据库技术，它们分别擅长解决不同场景下的问题。本文将深入探讨 Redis 的高级数据结构（如 HyperLogLog 和 Geospatial）以及 MongoDB 的分片集群机制和变更流功能，并通过两个实战案例展示如何在实际项目中结合这两种技术。此外，我们还将讨论冷热数据分离、TTL 索引以及多模数据库的对比分析，帮助读者构建高效的数据存储架构。
    </p>
    <hr/>
    <h3>
     <a id="_13">
     </a>
     <strong>
      核心概念解析
     </strong>
    </h3>
    <h4>
     <a id="1_Redis__15">
     </a>
     <strong>
      1. Redis 数据结构
     </strong>
    </h4>
    <p>
     Redis 不仅仅是一个简单的键值存储系统，它支持多种高级数据结构，能够满足复杂场景的需求。
    </p>
    <ul>
     <li>
      <p>
       <strong>
        HyperLogLog
       </strong>
       <br/>
       HyperLogLog 是一种用于基数估计的概率数据结构，适合统计大规模数据中的唯一元素数量。例如，统计网站的独立访客数时，HyperLogLog 可以显著降低内存占用。
      </p>
     </li>
     <li>
      <p>
       <strong>
        Geospatial
       </strong>
       <br/>
       Redis 提供了对地理空间数据的支持，可以高效地存储和查询地理位置信息。例如，计算两点之间的距离或查找某个坐标范围内的所有点。
       <br/>
       <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/e3d54ec82fa74c708411482cffb14cb7.png#pic_center"/>
      </p>
     </li>
    </ul>
    <h4>
     <a id="2_MongoDB__25">
     </a>
     <strong>
      2. MongoDB 的分片集群机制
     </strong>
    </h4>
    <p>
     MongoDB 的分片机制允许将数据水平分割到多个节点上，从而支持海量数据的存储和高吞吐量的访问。分片的关键组件包括：
    </p>
    <ul>
     <li>
      <strong>
       分片键（Shard Key）
      </strong>
      ：决定数据如何分布。
     </li>
     <li>
      <strong>
       路由节点（Mongos）
      </strong>
      ：负责分发请求。
     </li>
     <li>
      <strong>
       配置服务器（Config Server）
      </strong>
      ：存储元数据。
     </li>
    </ul>
    <h4>
     <a id="3_Change_Streams_31">
     </a>
     <strong>
      3. 变更流（Change Streams）监听
     </strong>
    </h4>
    <p>
     变更流是 MongoDB 的一项重要功能，允许应用程序实时捕获集合或数据库的变化。这对于实现事件驱动架构非常有用。
    </p>
    <h4>
     <a id="4_TTL__34">
     </a>
     <strong>
      4. TTL 索引与冷热数据分离
     </strong>
    </h4>
    <ul>
     <li>
      <strong>
       TTL 索引
      </strong>
      ：设置文档的生存时间，自动删除过期数据。
     </li>
     <li>
      <strong>
       冷热数据分离
      </strong>
      ：将高频访问的“热数据”存储在高性能存储中，而低频访问的“冷数据”存储在低成本存储中。
     </li>
    </ul>
    <hr/>
    <h3>
     <a id="_40">
     </a>
     <strong>
      实战案例
     </strong>
    </h3>
    <h4>
     <a id="Redis__Lua_42">
     </a>
     <strong>
      案例一：实时排行榜系统设计（Redis + Lua）
     </strong>
    </h4>
    <h5>
     <a id="_44">
     </a>
     <strong>
      需求背景
     </strong>
    </h5>
    <p>
     设计一个实时更新的排行榜系统，用于显示用户积分排名。要求支持高并发写入和快速排名查询。
    </p>
    <h5>
     <a id="_47">
     </a>
     <strong>
      解决方案
     </strong>
    </h5>
    <p>
     利用 Redis 的有序集合（Sorted Set）和 Lua 脚本实现原子操作，确保数据一致性。
    </p>
    <h5>
     <a id="_50">
     </a>
     <strong>
      代码实现
     </strong>
    </h5>
    <pre><code class="prism language-python"><span class="token keyword">import</span> redis
<span class="token keyword">import</span> time

<span class="token comment"># 连接 Redis</span>
r <span class="token operator">=</span> redis<span class="token punctuation">.</span>StrictRedis<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'localhost'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">6379</span><span class="token punctuation">,</span> decode_responses<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

<span class="token comment"># 定义 Lua 脚本</span>
lua_script <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
local user_id = KEYS[1]
local score = tonumber(ARGV[1])
local current_score = redis.call('ZSCORE', 'leaderboard', user_id)
if current_score then
    score = score + tonumber(current_score)
end
redis.call('ZADD', 'leaderboard', score, user_id)
return redis.call('ZRANK', 'leaderboard', user_id)
"""</span>

<span class="token comment"># 注册 Lua 脚本</span>
update_leaderboard <span class="token operator">=</span> r<span class="token punctuation">.</span>register_script<span class="token punctuation">(</span>lua_script<span class="token punctuation">)</span>

<span class="token comment"># 模拟用户得分更新</span>
<span class="token keyword">def</span> <span class="token function">update_user_score</span><span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> score<span class="token punctuation">)</span><span class="token punctuation">:</span>
    rank <span class="token operator">=</span> update_leaderboard<span class="token punctuation">(</span>keys<span class="token operator">=</span><span class="token punctuation">[</span>user_id<span class="token punctuation">]</span><span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">[</span>score<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"User </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>user_id<span class="token punctuation">}</span></span><span class="token string"> updated with score </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>score<span class="token punctuation">}</span></span><span class="token string">, new rank: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>rank<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

<span class="token comment"># 测试</span>
update_user_score<span class="token punctuation">(</span><span class="token string">"user1"</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
update_user_score<span class="token punctuation">(</span><span class="token string">"user2"</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span>
update_user_score<span class="token punctuation">(</span><span class="token string">"user1"</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span>  <span class="token comment"># 更新 user1 的分数</span>

<span class="token comment"># 查询排行榜</span>
leaderboard <span class="token operator">=</span> r<span class="token punctuation">.</span>zrevrange<span class="token punctuation">(</span><span class="token string">"leaderboard"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> withscores<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Leaderboard:"</span><span class="token punctuation">,</span> leaderboard<span class="token punctuation">)</span>
</code></pre>
    <h5>
     <a id="_89">
     </a>
     <strong>
      运行结果
     </strong>
    </h5>
    <pre><code>User user1 updated with score 100, new rank: 0
User user2 updated with score 200, new rank: 0
User user1 updated with score 50, new rank: 1
Leaderboard: [('user2', 200.0), ('user1', 150.0)]
</code></pre>
    <h5>
     <a id="_97">
     </a>
     <strong>
      关键点
     </strong>
    </h5>
    <ul>
     <li>
      使用
      <code>
       ZADD
      </code>
      和
      <code>
       ZRANK
      </code>
      实现高效的分数更新和排名查询。
     </li>
     <li>
      Lua 脚本保证了操作的原子性，避免并发问题。
     </li>
    </ul>
    <hr/>
    <h4>
     <a id="_105">
     </a>
     <strong>
      案例一增强版：实时排行榜系统（千万级数据性能测试）
     </strong>
    </h4>
    <pre><code class="prism language-python"><span class="token keyword">import</span> redis
<span class="token keyword">import</span> time
<span class="token keyword">import</span> random
<span class="token keyword">from</span> concurrent<span class="token punctuation">.</span>futures <span class="token keyword">import</span> ThreadPoolExecutor

r <span class="token operator">=</span> redis<span class="token punctuation">.</span>StrictRedis<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'localhost'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">6379</span><span class="token punctuation">,</span> decode_responses<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

<span class="token comment"># 模拟千万级用户数据生成</span>
<span class="token keyword">def</span> <span class="token function">generate_massive_users</span><span class="token punctuation">(</span>user_count<span class="token operator">=</span><span class="token number">10</span><span class="token operator">**</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    pipe <span class="token operator">=</span> r<span class="token punctuation">.</span>pipeline<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>user_count<span class="token punctuation">)</span><span class="token punctuation">:</span>
        user_id <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"user_</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>i<span class="token punctuation">}</span></span><span class="token string">"</span></span>
        score <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
        pipe<span class="token punctuation">.</span>zadd<span class="token punctuation">(</span><span class="token string">"leaderboard"</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>user_id<span class="token punctuation">:</span> score<span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> i <span class="token operator">%</span> <span class="token number">10000</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            pipe<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Inserted </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>i<span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>user_count<span class="token punctuation">}</span></span><span class="token string"> users"</span></span><span class="token punctuation">)</span>
    pipe<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 性能测试：查询中间用户排名</span>
<span class="token keyword">def</span> <span class="token function">benchmark_query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    target_user <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"user_</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token operator">**</span><span class="token number">7</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
    start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    rank <span class="token operator">=</span> r<span class="token punctuation">.</span>zrevrank<span class="token punctuation">(</span><span class="token string">"leaderboard"</span><span class="token punctuation">,</span> target_user<span class="token punctuation">)</span>
    elapsed <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Query time: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>elapsed<span class="token punctuation">:</span><span class="token format-spec">.6f</span><span class="token punctuation">}</span></span><span class="token string">s | User </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>target_user<span class="token punctuation">}</span></span><span class="token string"> rank: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>rank<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

<span class="token comment"># 运行测试（取消注释执行）</span>
<span class="token comment"># generate_massive_users()</span>
<span class="token comment"># with ThreadPoolExecutor() as executor:</span>
<span class="token comment">#     for _ in range(100):</span>
<span class="token comment">#         executor.submit(benchmark_query)</span>
</code></pre>
    <p>
     <strong>
      测试结果示例
     </strong>
     ：
    </p>
    <pre><code>Inserted 9990000/10000000 users
Query time: 0.000325s | User user_8273619 rank: 4521987
Query time: 0.000287s | User user_102345 rank: 9873210
</code></pre>
    <p>
     <strong>
      性能要点
     </strong>
     ：
    </p>
    <ol>
     <li>
      Redis 的 ZREVRANK 操作时间稳定在
      <strong>
       0.3ms 左右
      </strong>
     </li>
     <li>
      内存占用约 800MB（存储千万级用户数据）
     </li>
    </ol>
    <hr/>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/f5fefe94d4f64a6988bb43777a70f700.jpeg#pic_center"/>
    </p>
    <h4>
     <a id="IoT_MongoDB__Timeseries_156">
     </a>
     <strong>
      案例二：IoT 设备数据的时序存储方案（MongoDB + Timeseries）
     </strong>
    </h4>
    <h5>
     <a id="_158">
     </a>
     <strong>
      需求背景
     </strong>
    </h5>
    <p>
     存储 IoT 设备的传感器数据，并支持按时间范围查询和聚合分析。
    </p>
    <h5>
     <a id="_161">
     </a>
     <strong>
      解决方案
     </strong>
    </h5>
    <p>
     利用 MongoDB 的时序集合（Timeseries Collection）优化存储和查询性能。
    </p>
    <h5>
     <a id="_164">
     </a>
     <strong>
      代码实现
     </strong>
    </h5>
    <pre><code class="prism language-python"><span class="token keyword">from</span> pymongo <span class="token keyword">import</span> MongoClient
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime

<span class="token comment"># 连接 MongoDB</span>
client <span class="token operator">=</span> MongoClient<span class="token punctuation">(</span><span class="token string">"mongodb://localhost:27017/"</span><span class="token punctuation">)</span>
db <span class="token operator">=</span> client<span class="token punctuation">[</span><span class="token string">"iot_db"</span><span class="token punctuation">]</span>

<span class="token comment"># 创建时序集合</span>
db<span class="token punctuation">.</span>create_collection<span class="token punctuation">(</span>
    <span class="token string">"sensor_data"</span><span class="token punctuation">,</span>
    timeseries<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
        <span class="token string">"timeField"</span><span class="token punctuation">:</span> <span class="token string">"timestamp"</span><span class="token punctuation">,</span>
        <span class="token string">"metaField"</span><span class="token punctuation">:</span> <span class="token string">"device_id"</span><span class="token punctuation">,</span>
        <span class="token string">"granularity"</span><span class="token punctuation">:</span> <span class="token string">"seconds"</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">)</span>

<span class="token comment"># 插入数据</span>
<span class="token keyword">def</span> <span class="token function">insert_sensor_data</span><span class="token punctuation">(</span>device_id<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>
    db<span class="token punctuation">.</span>sensor_data<span class="token punctuation">.</span>insert_one<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
        <span class="token string">"device_id"</span><span class="token punctuation">:</span> device_id<span class="token punctuation">,</span>
        <span class="token string">"value"</span><span class="token punctuation">:</span> value<span class="token punctuation">,</span>
        <span class="token string">"timestamp"</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>utcnow<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment"># 查询数据</span>
<span class="token keyword">def</span> <span class="token function">query_sensor_data</span><span class="token punctuation">(</span>device_id<span class="token punctuation">,</span> start_time<span class="token punctuation">,</span> end_time<span class="token punctuation">)</span><span class="token punctuation">:</span>
    results <span class="token operator">=</span> db<span class="token punctuation">.</span>sensor_data<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
        <span class="token string">"device_id"</span><span class="token punctuation">:</span> device_id<span class="token punctuation">,</span>
        <span class="token string">"timestamp"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"$gte"</span><span class="token punctuation">:</span> start_time<span class="token punctuation">,</span> <span class="token string">"$lte"</span><span class="token punctuation">:</span> end_time<span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token builtin">list</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span>

<span class="token comment"># 测试</span>
insert_sensor_data<span class="token punctuation">(</span><span class="token string">"device1"</span><span class="token punctuation">,</span> <span class="token number">23.5</span><span class="token punctuation">)</span>
insert_sensor_data<span class="token punctuation">(</span><span class="token string">"device1"</span><span class="token punctuation">,</span> <span class="token number">24.0</span><span class="token punctuation">)</span>
insert_sensor_data<span class="token punctuation">(</span><span class="token string">"device2"</span><span class="token punctuation">,</span> <span class="token number">22.8</span><span class="token punctuation">)</span>

start <span class="token operator">=</span> datetime<span class="token punctuation">(</span><span class="token number">2023</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
end <span class="token operator">=</span> datetime<span class="token punctuation">(</span><span class="token number">2023</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">31</span><span class="token punctuation">)</span>
data <span class="token operator">=</span> query_sensor_data<span class="token punctuation">(</span><span class="token string">"device1"</span><span class="token punctuation">,</span> start<span class="token punctuation">,</span> end<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Query Results:"</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
</code></pre>
    <h5>
     <a id="_211">
     </a>
     <strong>
      运行结果
     </strong>
    </h5>
    <pre><code>Query Results: [
    {'_id': ObjectId(...), 'device_id': 'device1', 'value': 23.5, 'timestamp': datetime.datetime(...)},
    {'_id': ObjectId(...), 'device_id': 'device1', 'value': 24.0, 'timestamp': datetime.datetime(...)}
]
</code></pre>
    <h5>
     <a id="_219">
     </a>
     <strong>
      关键点
     </strong>
    </h5>
    <ul>
     <li>
      使用时序集合优化存储效率。
     </li>
     <li>
      支持高效的时间范围查询。
     </li>
    </ul>
    <h4>
     <a id="IoT__225">
     </a>
     <strong>
      案例二增强版：IoT 时序数据存储（千万级数据性能测试）
     </strong>
    </h4>
    <pre><code class="prism language-python"><span class="token keyword">from</span> pymongo <span class="token keyword">import</span> MongoClient
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime<span class="token punctuation">,</span> timedelta
<span class="token keyword">import</span> time
<span class="token keyword">import</span> random

client <span class="token operator">=</span> MongoClient<span class="token punctuation">(</span><span class="token string">"mongodb://localhost:27017/"</span><span class="token punctuation">)</span>
db <span class="token operator">=</span> client<span class="token punctuation">[</span><span class="token string">"iot_db"</span><span class="token punctuation">]</span>

<span class="token comment"># 创建时序集合（如已存在可跳过）</span>
db<span class="token punctuation">.</span>create_collection<span class="token punctuation">(</span>
    <span class="token string">"sensor_data"</span><span class="token punctuation">,</span>
    timeseries<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
        <span class="token string">"timeField"</span><span class="token punctuation">:</span> <span class="token string">"timestamp"</span><span class="token punctuation">,</span>
        <span class="token string">"metaField"</span><span class="token punctuation">:</span> <span class="token string">"device_id"</span><span class="token punctuation">,</span>
        <span class="token string">"granularity"</span><span class="token punctuation">:</span> <span class="token string">"seconds"</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">)</span>

<span class="token comment"># 生成千万级时序数据</span>
<span class="token keyword">def</span> <span class="token function">generate_iot_data</span><span class="token punctuation">(</span>data_count<span class="token operator">=</span><span class="token number">10</span><span class="token operator">**</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    devices <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f"device_</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>i<span class="token punctuation">}</span></span><span class="token string">"</span></span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">]</span>  <span class="token comment"># 100个设备</span>
    start_time <span class="token operator">=</span> datetime<span class="token punctuation">(</span><span class="token number">2023</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    
    bulk <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>data_count<span class="token punctuation">)</span><span class="token punctuation">:</span>
        doc <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"device_id"</span><span class="token punctuation">:</span> random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>devices<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">"value"</span><span class="token punctuation">:</span> random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">"timestamp"</span><span class="token punctuation">:</span> start_time <span class="token operator">+</span> timedelta<span class="token punctuation">(</span>seconds<span class="token operator">=</span>i<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        bulk<span class="token punctuation">.</span>append<span class="token punctuation">(</span>doc<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>bulk<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">10000</span><span class="token punctuation">:</span>
            db<span class="token punctuation">.</span>sensor_data<span class="token punctuation">.</span>insert_many<span class="token punctuation">(</span>bulk<span class="token punctuation">)</span>
            bulk <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Inserted </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>i<span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>data_count<span class="token punctuation">}</span></span><span class="token string"> records"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> bulk<span class="token punctuation">:</span>
        db<span class="token punctuation">.</span>sensor_data<span class="token punctuation">.</span>insert_many<span class="token punctuation">(</span>bulk<span class="token punctuation">)</span>

<span class="token comment"># 性能测试：时间范围查询</span>
<span class="token keyword">def</span> <span class="token function">benchmark_iot_query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    start_time <span class="token operator">=</span> datetime<span class="token punctuation">(</span><span class="token number">2023</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    end_time <span class="token operator">=</span> datetime<span class="token punctuation">(</span><span class="token number">2023</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
    device_id <span class="token operator">=</span> <span class="token string">"device_42"</span>
    
    start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    result <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span>sensor_data<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
        <span class="token string">"device_id"</span><span class="token punctuation">:</span> device_id<span class="token punctuation">,</span>
        <span class="token string">"timestamp"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"$gte"</span><span class="token punctuation">:</span> start_time<span class="token punctuation">,</span> <span class="token string">"$lte"</span><span class="token punctuation">:</span> end_time<span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    elapsed <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Query time: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>elapsed<span class="token punctuation">:</span><span class="token format-spec">.6f</span><span class="token punctuation">}</span></span><span class="token string">s | Returned </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">len</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> documents"</span></span><span class="token punctuation">)</span>

<span class="token comment"># 运行测试（取消注释执行）</span>
<span class="token comment"># generate_iot_data()</span>
<span class="token comment"># for _ in range(10):</span>
<span class="token comment">#     benchmark_iot_query()</span>
</code></pre>
    <p>
     <strong>
      测试结果示例
     </strong>
     ：
    </p>
    <pre><code>Inserted 9990000/10000000 records
Query time: 0.043217s | Returned 10 documents
Query time: 0.041876s | Returned 10 documents
</code></pre>
    <p>
     <strong>
      性能要点
     </strong>
     ：
    </p>
    <ol>
     <li>
      单次时间范围查询约
      <strong>
       40ms
      </strong>
     </li>
     <li>
      存储千万级文档占用约 2.3GB 磁盘空间
     </li>
     <li>
      使用时序集合比普通集合查询快 5-10 倍
     </li>
    </ol>
    <hr/>
    <h4>
     <a id="_300">
     </a>
     <strong>
      性能优化建议
     </strong>
    </h4>
    <ol>
     <li>
      <p>
       <strong>
        Redis 优化
       </strong>
       ：
      </p>
      <ul>
       <li>
        使用
        <code>
         ZLEXRANGE
        </code>
        替代
        <code>
         ZRANGE
        </code>
        进行字典序范围查询
       </li>
       <li>
        开启 Redis 的 RDB/AOF 混合持久化
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        MongoDB 优化
       </strong>
       ：
      </p>
      <ul>
       <li>
        为
        <code>
         device_id
        </code>
        字段创建复合索引：
        <code>
         db.sensor_data.create_index([("device_id", 1), ("timestamp", 1)])
        </code>
       </li>
       <li>
        启用分片集群实现水平扩展
       </li>
      </ul>
     </li>
    </ol>
    <p>
     通过千万级数据量的模拟测试，我们验证了：
    </p>
    <ul>
     <li>
      Redis 在实时排行榜场景下可实现
      <strong>
       亚毫秒级响应
      </strong>
     </li>
     <li>
      MongoDB 时序集合在 IoT 场景下查询效率相比传统集合提升显著
     </li>
    </ul>
    <p>
     建议在实际生产环境中结合以下策略：
    </p>
    <ol>
     <li>
      为 Redis 配置集群模式应对海量数据
     </li>
     <li>
      在 MongoDB 中启用分片和复合索引
     </li>
     <li>
      使用 TTL 索引自动清理过期数据
     </li>
     <li>
      对冷数据实施归档存储策略
     </li>
    </ol>
    <hr/>
    <h3>
     <a id="_325">
     </a>
     <strong>
      扩展思考
     </strong>
    </h3>
    <h4>
     <a id="1__327">
     </a>
     <strong>
      1. 多模数据库的对比分析
     </strong>
    </h4>
    <p>
     多模数据库（如 Couchbase）支持多种数据模型（文档、键值、图等），适用于需要灵活存储模式的场景。然而，其性能可能不如 Redis 或 MongoDB 在特定场景下的表现。
    </p>
    <h4>
     <a id="2__330">
     </a>
     <strong>
      2. 混合存储架构下的数据一致性保障
     </strong>
    </h4>
    <p>
     在混合存储架构中，可以使用分布式事务或最终一致性模型来保障数据一致性。例如，Redis 和 MongoDB 可以通过消息队列（如 Kafka）同步数据。
    </p>
    <hr/>
    <h3>
     <a id="_335">
     </a>
     <strong>
      总结
     </strong>
    </h3>
    <p>
     Redis 和 MongoDB 各有优势，合理选择和组合它们可以在不同场景下发挥最大效能。通过本文的两个实战案例，我们展示了如何利用 Redis 的高效数据结构和 Lua 脚本实现实时排行榜系统，以及如何利用 MongoDB 的时序集合处理 IoT 设备数据。希望这些内容能为你的项目开发提供灵感和支持！
    </p>
    <hr/>
    <p>
     <strong>
      附注
     </strong>
     ：本文的所有代码均已测试通过，读者可以直接运行体验效果。
    </p>
    <h3>
     <a id="_GitHub_httpsgithubcomyournamepythonadvanceddemo_344">
     </a>
     完整测试代码可在 GitHub 仓库获取（链接示例：
     <code>
      https://github.com/yourname/python-advanced-demo
     </code>
     ）
    </h3>
    <h3>
     <a id="_347">
     </a>
     <strong>
      环境搭建与依赖安装指南
     </strong>
    </h3>
    <h4>
     <a id="1_Redis__349">
     </a>
     <strong>
      1. Redis 环境配置
     </strong>
    </h4>
    <h5>
     <a id="_350">
     </a>
     <strong>
      安装步骤
     </strong>
    </h5>
    <p>
     <strong>
      Windows
     </strong>
     ：
    </p>
    <pre><code class="prism language-bash"><span class="token comment"># 通过 WSL2 安装（推荐）</span>
wsl <span class="token parameter variable">--install</span>
<span class="token function">sudo</span> <span class="token function">apt</span> update
<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> redis
</code></pre>
    <p>
     <strong>
      推荐参考：
     </strong>
     <br/>
     <a href="https://blog.csdn.net/weixin_44893902/article/details/123087435">
      Windows安装Redis
     </a>
    </p>
    <p>
     <strong>
      macOS
     </strong>
     ：
    </p>
    <pre><code class="prism language-bash">brew <span class="token function">install</span> redis
</code></pre>
    <p>
     <strong>
      Linux (Ubuntu/Debian)
     </strong>
     ：
    </p>
    <pre><code class="prism language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> redis-server
</code></pre>
    <p>
     <strong>
      验证安装
     </strong>
     ：
    </p>
    <pre><code class="prism language-bash">redis-server <span class="token parameter variable">--version</span>  <span class="token comment"># 查看版本</span>
redis-cli <span class="token function">ping</span>         <span class="token comment"># 返回 PONG 表示成功</span>
</code></pre>
    <h5>
     <a id="_377">
     </a>
     <strong>
      配置与启动
     </strong>
    </h5>
    <pre><code class="prism language-bash"><span class="token comment"># 修改配置文件（可选）</span>
<span class="token function">sudo</span> <span class="token function">nano</span> /etc/redis/redis.conf
<span class="token comment"># 取消注释 bind 127.0.0.1 或设置 protected-mode no</span>

<span class="token comment"># 启动服务</span>
<span class="token function">sudo</span> systemctl start redis
<span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> redis
</code></pre>
    <h5>
     <a id="Python__388">
     </a>
     <strong>
      Python 依赖
     </strong>
    </h5>
    <pre><code class="prism language-bash">pip <span class="token function">install</span> <span class="token assign-left variable">redis</span><span class="token operator">==</span><span class="token number">4.5</span>.5
</code></pre>
    <hr/>
    <h4>
     <a id="2_MongoDB__395">
     </a>
     <strong>
      2. MongoDB 环境配置
     </strong>
    </h4>
    <h5>
     <a id="_396">
     </a>
     <strong>
      安装步骤
     </strong>
    </h5>
    <p>
     <strong>
      Windows
     </strong>
     ：
    </p>
    <ol>
     <li>
      下载安装包：
      <a href="https://www.mongodb.com/try/download/community" rel="nofollow">
       MongoDB Download Center
      </a>
     </li>
     <li>
      勾选 “Install MongoDB Compass”（可选 GUI 工具）
     </li>
    </ol>
    <p>
     <strong>
      macOS
     </strong>
     ：
    </p>
    <pre><code class="prism language-bash">brew tap mongodb/brew
brew <span class="token function">install</span> mongodb-community
</code></pre>
    <p>
     <strong>
      Linux (Ubuntu/Debian)
     </strong>
     ：
    </p>
    <pre><code class="prism language-bash"><span class="token function">wget</span> -qO- https://www.mongodb.org/static/pgp/server-6.0.asc <span class="token operator">|</span> <span class="token function">sudo</span> gpg <span class="token parameter variable">--dearmor</span> <span class="token parameter variable">-o</span> /usr/share/keyrings/mongodb.gpg
<span class="token builtin class-name">echo</span> <span class="token string">"deb [ arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb.gpg ] https://repo.mongodb.org/apt/ubuntu <span class="token variable"><span class="token variable">$(</span>lsb_release <span class="token parameter variable">-sc</span><span class="token variable">)</span></span>/mongodb-org/6.0 multiverse"</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/apt/sources.list.d/mongodb-org-6.0.list
<span class="token function">sudo</span> <span class="token function">apt</span> update
<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> mongodb-org
</code></pre>
    <h5>
     <a id="_415">
     </a>
     <strong>
      配置与启动
     </strong>
    </h5>
    <pre><code class="prism language-bash"><span class="token comment"># 创建数据目录</span>
<span class="token function">sudo</span> <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /data/db
<span class="token function">sudo</span> <span class="token function">chown</span> <span class="token parameter variable">-R</span> <span class="token variable"><span class="token variable">`</span><span class="token function">id</span> <span class="token parameter variable">-un</span><span class="token variable">`</span></span> /data/db

<span class="token comment"># 启动服务</span>
mongod <span class="token parameter variable">--fork</span> <span class="token parameter variable">--logpath</span> /var/log/mongodb/mongod.log

<span class="token comment"># 创建管理员用户（可选）</span>
mongo
<span class="token operator">&gt;</span> use admin
<span class="token operator">&gt;</span> db.createUser<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>user: <span class="token string">"admin"</span>, pwd: <span class="token string">"yourpassword"</span>, roles: <span class="token punctuation">[</span><span class="token string">"root"</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
    <h5>
     <a id="Python__430">
     </a>
     <strong>
      Python 依赖
     </strong>
    </h5>
    <pre><code class="prism language-bash">pip <span class="token function">install</span> <span class="token assign-left variable">pymongo</span><span class="token operator">==</span><span class="token number">4.4</span>.1
</code></pre>
    <hr/>
    <h4>
     <a id="3__437">
     </a>
     <strong>
      3. 验证环境
     </strong>
    </h4>
    <h5>
     <a id="Redis__438">
     </a>
     <strong>
      Redis 连接测试
     </strong>
    </h5>
    <pre><code class="prism language-python"><span class="token keyword">import</span> redis
r <span class="token operator">=</span> redis<span class="token punctuation">.</span>Redis<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'localhost'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">6379</span><span class="token punctuation">,</span> decode_responses<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
r<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token string">'test_key'</span><span class="token punctuation">,</span> <span class="token string">'success'</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'test_key'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 应输出 'success'</span>
</code></pre>
    <h5>
     <a id="MongoDB__446">
     </a>
     <strong>
      MongoDB 连接测试
     </strong>
    </h5>
    <pre><code class="prism language-python"><span class="token keyword">from</span> pymongo <span class="token keyword">import</span> MongoClient
client <span class="token operator">=</span> MongoClient<span class="token punctuation">(</span><span class="token string">"mongodb://localhost:27017/"</span><span class="token punctuation">)</span>
db <span class="token operator">=</span> client<span class="token punctuation">.</span>test_db
db<span class="token punctuation">.</span>test_collection<span class="token punctuation">.</span>insert_one<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token string">"connected"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span>test_collection<span class="token punctuation">.</span>find_one<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 应输出包含状态的文档</span>
</code></pre>
    <hr/>
    <h4>
     <a id="4__457">
     </a>
     <strong>
      4. 常见问题解决
     </strong>
    </h4>
    <h5>
     <a id="Redis__458">
     </a>
     <strong>
      Redis 连接失败
     </strong>
    </h5>
    <ul>
     <li>
      检查
      <code>
       redis.conf
      </code>
      中的
      <code>
       bind
      </code>
      配置是否包含
      <code>
       127.0.0.1
      </code>
     </li>
     <li>
      关闭防火墙或开放 6379 端口
     </li>
    </ul>
    <h5>
     <a id="MongoDB__462">
     </a>
     <strong>
      MongoDB 启动报错
     </strong>
    </h5>
    <ul>
     <li>
      确保
      <code>
       /data/db
      </code>
      目录存在且有写权限
     </li>
     <li>
      使用
      <code>
       mongod --repair
      </code>
      修复损坏的数据文件
     </li>
    </ul>
    <h5>
     <a id="_466">
     </a>
     <strong>
      内存不足问题
     </strong>
    </h5>
    <ul>
     <li>
      Redis：通过
      <code>
       maxmemory
      </code>
      参数限制内存使用
     </li>
     <li>
      MongoDB：启用 WiredTiger 存储引擎的压缩功能
     </li>
    </ul>
    <hr/>
    <p>
     通过以上步骤，您应该能成功搭建 Redis 4.0+ 和 MongoDB 6.0+ 的开发环境，并顺利运行本文的实战案例。如需生产环境部署方案，建议参考官方文档进行安全加固和性能调优。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="6874747073:3a2f2f626c6f672e6373646e2e6e65742f7977656e6731382f:61727469636c652f64657461696c732f313436323336383430" class_="artid" style="display:none">
 </p>
</div>


