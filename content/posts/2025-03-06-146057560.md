---
layout: post
title: "vue3-watchEffect源码解读"
date: 2025-03-06 07:25:16 +0800
description: "的核心原理是通过类来管理副作用函数和依赖关系。在副作用函数执行过程中，自动收集所使用的响应式数据作为依赖。当这些依赖发生变化时，调度函数会被触发，重新执行副作用函数。同时，提供了清理机制，用于处理副作用函数重新执行或停止时的清理工作。"
keywords: "watcheffect的源码实现"
categories: ['学习路程', 'Vue']
tags: ['前端', 'Vue', 'Javascript']
artid: "146057560"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146057560
    alt: "vue3-watchEffect源码解读"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146057560
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146057560
cover: https://bing.ee123.net/img/rand?artid=146057560
image: https://bing.ee123.net/img/rand?artid=146057560
img: https://bing.ee123.net/img/rand?artid=146057560
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     vue3 watchEffect源码解读
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atelier-sulphurpool-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h4>
     <a id="1_watchEffect__1">
     </a>
     1.
     <code>
      watchEffect
     </code>
     函数入口
    </h4>
    <p>
     <code>
      watchEffect
     </code>
     函数定义在
     <code>
      @vue/runtime-core
     </code>
     包中，以下是简化后的核心代码：
    </p>
    <pre><code class="prism language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> effect<span class="token punctuation">,</span> ReactiveEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@vue/reactivity'</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">watchEffect</span><span class="token punctuation">(</span>
  <span class="token function-variable function">effectFn</span><span class="token operator">:</span> <span class="token punctuation">(</span>onInvalidate<span class="token operator">:</span> InvalidateCbRegistrator<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">,</span>
  options<span class="token operator">?</span><span class="token operator">:</span> WatchEffectOptions
<span class="token punctuation">)</span><span class="token operator">:</span> StopHandle <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> <span class="token function">doWatch</span><span class="token punctuation">(</span>effectFn<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
    <ul>
     <li>
      <code>
       watchEffect
      </code>
      接收一个副作用函数
      <code>
       effectFn
      </code>
      和可选的配置项
      <code>
       options
      </code>
      。
     </li>
     <li>
      它实际上调用了
      <code>
       doWatch
      </code>
      函数，将
      <code>
       effectFn
      </code>
      作为第一个参数传入，第二个参数为
      <code>
       null
      </code>
      ，这与
      <code>
       watch
      </code>
      的区别在于，
      <code>
       watch
      </code>
      通常会传入要监听的数据源，而
      <code>
       watchEffect
      </code>
      会自动收集副作用函数中使用的响应式数据作为依赖。
     </li>
    </ul>
    <h4>
     <a id="2_doWatch__16">
     </a>
     2.
     <code>
      doWatch
     </code>
     函数核心逻辑
    </h4>
    <pre><code class="prism language-typescript"><span class="token keyword">function</span> <span class="token function">doWatch</span><span class="token punctuation">(</span>
  source<span class="token operator">:</span> WatchSource <span class="token operator">|</span> WatchSource<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">|</span> WatchEffect <span class="token operator">|</span> object<span class="token punctuation">,</span>
  cb<span class="token operator">:</span> WatchCallback <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> immediate<span class="token punctuation">,</span> deep<span class="token punctuation">,</span> flush<span class="token punctuation">,</span> onTrack<span class="token punctuation">,</span> onTrigger <span class="token punctuation">}</span><span class="token operator">:</span> WatchOptions <span class="token operator">=</span> <span class="token constant">EMPTY_OBJ</span>
<span class="token punctuation">)</span><span class="token operator">:</span> StopHandle <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// ...</span>
  <span class="token keyword">let</span> <span class="token function-variable function">getter</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">any</span>
  <span class="token keyword">let</span> forceTrigger <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token keyword">let</span> isMultiSource <span class="token operator">=</span> <span class="token boolean">false</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFunction</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cb<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// watch(source, cb)</span>
      <span class="token function-variable function">getter</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// watchEffect(source)</span>
      <span class="token function-variable function">getter</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cleanup<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token function">callWithErrorHandling</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">WATCH_CALLBACK</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
          onInvalidate
        <span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> 
  <span class="token comment">// ...</span>

  <span class="token keyword">let</span> <span class="token function-variable function">cleanup</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span>
  <span class="token keyword">let</span> onInvalidate<span class="token operator">:</span> <span class="token function-variable function">InvalidateCbRegistrator</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function-variable function">fn</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    cleanup <span class="token operator">=</span> effect<span class="token punctuation">.</span><span class="token function-variable function">onStop</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">callWithAsyncErrorHandling</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">WATCH_CLEANUP</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> effect <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReactiveEffect</span><span class="token punctuation">(</span>getter<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>instance <span class="token operator">||</span> instance<span class="token punctuation">.</span>isUnmounted<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cb<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// watch(source, cb)</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// watchEffect</span>
      <span class="token function">schedulePostFlushCb</span><span class="token punctuation">(</span>run<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  effect<span class="token punctuation">.</span>onTrack <span class="token operator">=</span> onTrack
  effect<span class="token punctuation">.</span>onTrigger <span class="token operator">=</span> onTrigger

  <span class="token keyword">if</span> <span class="token punctuation">(</span>immediate<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cb<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">callWithAsyncErrorHandling</span><span class="token punctuation">(</span>cb<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> ErrorCodes<span class="token punctuation">.</span><span class="token constant">WATCH_CALLBACK</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
        <span class="token function">getter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">undefined</span><span class="token punctuation">,</span>
        onInvalidate
      <span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    effect<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">&amp;&amp;</span> instance<span class="token punctuation">.</span>scope<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">remove</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span>scope<span class="token punctuation">.</span>effects<span class="token operator">!</span><span class="token punctuation">,</span> effect<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h5>
     <a id="_91">
     </a>
     关键步骤分析：
    </h5>
    <ul>
     <li>
      <strong>
       getter 函数的创建
      </strong>
      ：
      <ul>
       <li>
        当
        <code>
         cb
        </code>
        为
        <code>
         null
        </code>
        时，说明是
        <code>
         watchEffect
        </code>
        调用。
        <code>
         getter
        </code>
        函数会先检查是否有清理函数
        <code>
         cleanup
        </code>
        ，如果有则执行它，然后调用传入的副作用函数
        <code>
         source
        </code>
        ，并将
        <code>
         onInvalidate
        </code>
        作为参数传入。
       </li>
      </ul>
     </li>
     <li>
      <strong>
       <code>
        onInvalidate
       </code>
       函数
      </strong>
      ：
      <ul>
       <li>
        用于注册清理函数。当副作用函数重新执行或停止时，清理函数会被调用。例如，在副作用函数中发起异步请求，当请求还未完成时副作用函数就需要重新执行，这时可以使用
        <code>
         onInvalidate
        </code>
        来取消之前的请求。
       </li>
      </ul>
     </li>
     <li>
      <strong>
       <code>
        ReactiveEffect
       </code>
       实例的创建
      </strong>
      ：
      <ul>
       <li>
        <code>
         ReactiveEffect
        </code>
        是 Vue 响应式系统中用于管理副作用函数和依赖关系的核心类。它接收
        <code>
         getter
        </code>
        函数和一个调度函数作为参数。
       </li>
       <li>
        调度函数会在依赖项发生变化时被调用。对于
        <code>
         watchEffect
        </code>
        ，它会将
        <code>
         run
        </code>
        函数调度到微任务队列中执行，确保在 DOM 更新后再执行副作用函数。
       </li>
      </ul>
     </li>
     <li>
      <strong>
       立即执行
      </strong>
      ：
      <ul>
       <li>
        如果
        <code>
         immediate
        </code>
        为
        <code>
         true
        </code>
        ，则会立即执行副作用函数。对于
        <code>
         watchEffect
        </code>
        ，直接调用
        <code>
         run
        </code>
        函数。
       </li>
      </ul>
     </li>
     <li>
      <strong>
       返回停止函数
      </strong>
      ：
      <ul>
       <li>
        <code>
         doWatch
        </code>
        函数返回一个停止函数，调用该函数可以停止
        <code>
         watchEffect
        </code>
        的监听，即调用
        <code>
         effect.stop()
        </code>
        方法停止
        <code>
         ReactiveEffect
        </code>
        实例的运行。
       </li>
      </ul>
     </li>
    </ul>
    <h4>
     <a id="3_ReactiveEffect__104">
     </a>
     3.
     <code>
      ReactiveEffect
     </code>
     类的作用
    </h4>
    <pre><code class="prism language-typescript"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ReactiveEffect<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token operator">=</span> <span class="token builtin">any</span><span class="token operator">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
  active <span class="token operator">=</span> <span class="token boolean">true</span>
  deps<span class="token operator">:</span> Dep<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token comment">// ...</span>

  <span class="token function">constructor</span><span class="token punctuation">(</span>
    <span class="token keyword">public</span> <span class="token function-variable function">fn</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">T</span><span class="token punctuation">,</span>
    <span class="token keyword">public</span> scheduler<span class="token operator">:</span> EffectScheduler <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

  <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>active<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
      activeEffect <span class="token operator">=</span> <span class="token keyword">this</span>
      <span class="token comment">// 清理上一次的依赖</span>
      <span class="token function">cleanupEffect</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
      <span class="token comment">// 开始收集依赖</span>
      trackOpBit <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">++</span>effectTrackDepth
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 恢复之前的依赖收集状态</span>
      trackOpBit <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">--</span>effectTrackDepth
      activeEffect <span class="token operator">=</span> <span class="token keyword">undefined</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>active<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">cleanupEffect</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>onStop<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>active <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <ul>
     <li>
      <code>
       ReactiveEffect
      </code>
      类的
      <code>
       run
      </code>
      函数会在执行副作用函数之前，将当前的
      <code>
       ReactiveEffect
      </code>
      实例设置为全局的
      <code>
       activeEffect
      </code>
      ，以便在副作用函数内部访问响应式数据时进行依赖收集。
     </li>
     <li>
      在执行完副作用函数后，会恢复之前的依赖收集状态。
     </li>
     <li>
      <code>
       stop
      </code>
      函数用于停止
      <code>
       ReactiveEffect
      </code>
      实例的运行，清理依赖关系，并执行可能存在的停止回调函数
      <code>
       onStop
      </code>
      。
     </li>
    </ul>
    <h4>
     <a id="_149">
     </a>
     总结
    </h4>
    <p>
     <code>
      watchEffect
     </code>
     的核心原理是通过
     <code>
      ReactiveEffect
     </code>
     类来管理副作用函数和依赖关系。在副作用函数执行过程中，自动收集所使用的响应式数据作为依赖。当这些依赖发生变化时，调度函数会被触发，重新执行副作用函数。同时，
     <code>
      onInvalidate
     </code>
     提供了清理机制，用于处理副作用函数重新执行或停止时的清理工作。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f33353934303733312f:61727469636c652f64657461696c732f313436303537353630" class_="artid" style="display:none">
 </p>
</div>


