---
layout: post
title: "nginx配置反向代理服务器,实现在https网站中请求http资源"
date: 2025-03-06 23:58:11 +0800
description: "‌🌈Nginx反向代理‌是一种将客户端请求转发到后端服务器的技术，主要用于负载均衡、提高安全性和提升性能。与正向代理不同，反向代理隐藏了后端服务器的真实地址，客户端与之交互时只知道反向代理服务器的地址。‌# 把http链接升级为https。"
keywords: "nginx配置反向代理服务器，实现在https网站中请求http资源"
categories: ['辅助工具开发伴侣', '负载均衡Nginx', '全栈全栈开发']
tags: ['反向代理', 'Nginx', 'Https', 'Http']
artid: "146083184"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146083184
    alt: "nginx配置反向代理服务器,实现在https网站中请求http资源"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146083184
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146083184
cover: https://bing.ee123.net/img/rand?artid=146083184
image: https://bing.ee123.net/img/rand?artid=146083184
img: https://bing.ee123.net/img/rand?artid=146083184
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     nginx配置反向代理服务器，实现在https网站中请求http资源
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <p>
    </p>
    <hr/>
    <h2>
     <a id="_5">
     </a>
     一、前言
    </h2>
    <p>
     <code>
      ‌Nginx
     </code>
     反向代理‌是一种将客户端请求转发到后端服务器的技术，主要用于负载均衡、提高安全性和提升性能。与正向代理不同，反向代理隐藏了后端服务器的真实地址，客户端与之交互时只知道反向代理服务器的地址。‌
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/63549b61f119453d85592452e69e0e77.jpeg#pic_center"/>
    </p>
    <hr/>
    <h2>
     <a id="Nginx_13">
     </a>
     二、Nginx反向代理的工作原理
    </h2>
    <p>
     当客户端发送请求到反向代理服务器时，
     <code>
      Nginx
     </code>
     会接收这些请求，并根据配置将请求转发到后端的真实服务器上。
     <code>
      Nginx
     </code>
     可以将多个请求分发到多个后端服务器，从而实现负载均衡，提高系统的并发处理能力和可用性。常见的负载均衡算法有轮询、
     <code>
      IP
     </code>
     哈希、最少连接等。
    </p>
    <h2>
     <a id="Nginx_16">
     </a>
     三、Nginx反向代理的主要功能‌
    </h2>
    <ul>
     <li>
      <strong>
       负载均衡‌
      </strong>
      ：
      <code>
       Nginx
      </code>
      可以通过反向代理实现负载均衡，将请求分发到多个后端服务器上，从而提高系统的并发处理能力和可用性。
     </li>
     <li>
      <strong>
       缓存加速‌
      </strong>
      ：
      <code>
       Nginx
      </code>
      可以缓存静态资源或动态页面，减少后端服务器的负载，提高响应速度。通过设置缓存时间、缓存规则等参数，可以灵活地控制缓存策略。‌
     </li>
     <li>
      ‌
      <strong>
       SSL终端‌
      </strong>
      ：
      <code>
       Nginx
      </code>
      可以作为
      <code>
       SSL
      </code>
      终端，接收
      <code>
       HTTPS
      </code>
      请求并进行
      <code>
       SSL/TLS
      </code>
      解密，然后将解密后的请求转发给后端服务器，减轻后端服务器的负担，提高安全性和性能。‌
     </li>
     <li>
      <strong>
       安全过滤‌
      </strong>
      ：
      <code>
       Nginx
      </code>
      可以通过反向代理实现安全过滤功能，例如防止恶意请求、
      <code>
       DDoS
      </code>
      攻击、
      <code>
       SQL
      </code>
      注入等。通过配置访问控制规则、限制请求频率等方式，可以提高系统的安全性。
     </li>
    </ul>
    <h2>
     <a id="Nginx_22">
     </a>
     四、Nginx反向代理的配置和使用场景
    </h2>
    <p>
     <code>
      Nginx
     </code>
     的反向代理功能通过配置文件进行配置，配置文件包含了全局配置、http配置和
     <code>
      server
     </code>
     配置等部分，可以设置监听端口、代理规则、缓存配置、负载均衡策略等。
     <code>
      Nginx
     </code>
     具有高性能的特点，采用异步非阻塞的事件驱动模型，可以处理大量并发连接，同时内存消耗较低，适合在资源有限的环境中使用。
    </p>
    <h2>
     <a id="_25">
     </a>
     五、实战配置
    </h2>
    <p>
     网站使用
     <code>
      nginx
     </code>
     作为服务器，协议从
     <code>
      http
     </code>
     升级为
     <code>
      https
     </code>
     的注意事项。
    </p>
    <h3>
     <a id="51__27">
     </a>
     5.1 首先，修改宝塔面板配置
    </h3>
    <p>
     选择配置文件，
     <code>
      http
     </code>
     请求重定向为
     <code>
      https
     </code>
     。所有
     <code>
      80
     </code>
     端口请求都重定向为
     <code>
      https
     </code>
     请求。
    </p>
    <pre><code class="prism language-bash"><span class="token comment"># server代表的是nginx其中的一个服务器</span>
server
<span class="token punctuation">{<!-- --></span>
    listen <span class="token number">80</span><span class="token punctuation">;</span> <span class="token comment"># listen表示监听端口号80 （http）</span>
    listen <span class="token number">443</span> ssl http2<span class="token punctuation">;</span> <span class="token comment"># 表示监听443 端口号（https）</span>
    server_name www.abc.com abc.com ip地址<span class="token punctuation">;</span> <span class="token comment"># server_name表示服务器名称，现在同时匹配3个</span>
    index index.php index.html index.htm default.php default.htm default.html<span class="token punctuation">;</span> <span class="token comment"># 匹配/www/wwwroot/abc/index.html</span>
    root /www/wwwroot/abc<span class="token punctuation">;</span> <span class="token comment"># abc表示路径，网站的起始位置为/www/wwwroot/abc</span>
    
 
    <span class="token comment">#HTTP_TO_HTTPS_START</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$server_port</span> <span class="token operator">!</span>~ <span class="token number">443</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span> <span class="token comment"># 端口号不等于443，则重写url到https://当前主机/后面所有路径，并永久重定向（permanent）</span>
        rewrite ^<span class="token punctuation">(</span>/.*<span class="token punctuation">)</span>$ https://<span class="token variable">$host</span><span class="token variable">$1</span> permanent<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="52__46">
     </a>
     5.2 接着配置代理服务器
    </h3>
    <pre><code class="prism language-bash"><span class="token comment"># 代理serve图片服务器api</span>
    location /api/ <span class="token punctuation">{<!-- --></span>
   <span class="token comment"># 通过代理，访问https://ip|域名/api/...时,代理到http://你的ip或域名:3004/api/...</span>
        proxy_pass http://你的ip或域名:3004<span class="token punctuation">;</span> <span class="token comment"># 注意`http://你的ip或域名:3004`末尾不添加`/`，这样的话`/api/`将会添加到3004后面</span>
        proxy_redirect  off<span class="token punctuation">;</span>
            proxy_set_header  Host  <span class="token variable">$host</span><span class="token punctuation">;</span>
            proxy_set_header  X-Real-IP  <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>
            proxy_set_header  X-Forwarded-For  <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>
            proxy_set_header  X-Forwarded-Proto  <span class="token variable">$scheme</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment"># 代理音乐服务器api</span>
    <span class="token comment"># /musicapi/,必须加上后面的/，不然代理服务不成功</span>
    location /musicapi/ <span class="token punctuation">{<!-- --></span>
    <span class="token comment"># 访问https://你的ip或域名/musicapi/...，</span>
    <span class="token comment"># 代理到http://你的ip或域名:3005/...,不包括/musicapi</span>
        proxy_pass http://你的ip或域名:3005/<span class="token punctuation">;</span> <span class="token comment"># 这里末尾添加了`/`，将不会添加`/musicapi/`在端口号后面</span>
        proxy_redirect  off<span class="token punctuation">;</span>
            proxy_set_header  Host  <span class="token variable">$host</span><span class="token punctuation">;</span>
            proxy_set_header  X-Real-IP  <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>
            proxy_set_header  X-Forwarded-For  <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>
            proxy_set_header  X-Forwarded-Proto  <span class="token variable">$scheme</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="53__73">
     </a>
     5.3 完成上面所有配置后
    </h3>
    <p>
     <code>
      http
     </code>
     网站升级到
     <code>
      https
     </code>
     网站，浏览器可正常访问网站，网站请求的
     <code>
      api
     </code>
     接口，需要从
     <code>
      http://ip| 域名 :3005/lyric?id=32507038
     </code>
     修改为
     <code>
      http(s)://ip|域名/musicapi/lyric?id=32507038
     </code>
     。这里的流程就是，把原本请求的
     <code>
      :3005
     </code>
     用
     <code>
      /musicapi
     </code>
     替换掉，然后浏览器发出并重定向成
     <code>
      https
     </code>
     开头的请求，接着
     <code>
      nginx
     </code>
     发现你的请求中带有
     <code>
      /musicapi
     </code>
     ，就把你的请求转发给匹配上的
     <code>
      http://
     </code>
     你的
     <code>
      ip
     </code>
     或域名
     <code>
      :3005/
     </code>
     服务器。
    </p>
    <h3>
     <a id="54indexhtml_76">
     </a>
     5.4最后还要在原来的index.html文件里添加
    </h3>
    <pre><code class="prism language-bash"><span class="token comment"># 把http链接升级为https</span>
<span class="token operator">&lt;</span>meta http-equiv<span class="token operator">=</span><span class="token string">"Content-Security-Policy"</span> <span class="token assign-left variable">content</span><span class="token operator">=</span><span class="token string">"upgrade-insecure-requests"</span> /<span class="token operator">&gt;</span>
</code></pre>
    <h3>
     <a id="55_nginx_83">
     </a>
     5.5 或者可以操作服务端的话，也可以在nginx配置里添加
    </h3>
    <pre><code class="prism language-bash">server
<span class="token punctuation">{<!-- --></span>
    listen <span class="token number">80</span><span class="token punctuation">;</span>
    listen <span class="token number">443</span> ssl http2<span class="token punctuation">;</span>
    <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
    <span class="token comment">#升级可以升级为https的连接，兼容http</span>
    add_header Content-Security-Policy <span class="token string">"upgrade-insecure-requests;connect-src *"</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c:6f672e6373646e2e6e65742f6d73733335393638313039312f:61727469636c652f64657461696c732f313436303833313834" class_="artid" style="display:none">
 </p>
</div>


