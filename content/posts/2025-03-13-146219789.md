---
layout: post
title: "LuaJIT-å­¦ä¹ 2-ä½¿ç”¨-FFI-åº“çš„å‡ ä¸ªä¾‹å­"
date: 2025-03-13 01:33:04 +0800
description: "ä½¿ç”¨ FFI åº“çš„å‡ ä¸ªä¾‹å­"
keywords: "LuaJIT å­¦ä¹ ï¼ˆ2ï¼‰â€”â€” ä½¿ç”¨ FFI åº“çš„å‡ ä¸ªä¾‹å­"
categories: ['Lua']
tags: ['Luajit', 'Lua']
artid: "146219789"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146219789
    alt: "LuaJIT-å­¦ä¹ 2-ä½¿ç”¨-FFI-åº“çš„å‡ ä¸ªä¾‹å­"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146219789
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146219789
cover: https://bing.ee123.net/img/rand?artid=146219789
image: https://bing.ee123.net/img/rand?artid=146219789
img: https://bing.ee123.net/img/rand?artid=146219789
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     LuaJIT å­¦ä¹ ï¼ˆ2ï¼‰â€”â€” ä½¿ç”¨ FFI åº“çš„å‡ ä¸ªä¾‹å­
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <p>
    </p>
    <h3>
     <a id="_1">
     </a>
     ä»‹ç»
    </h3>
    <p>
     The FFI library allows
     <strong>
      calling external C functions
     </strong>
     and
     <strong>
      using C data structures
     </strong>
     from pure Lua code.
    </p>
    <p>
     The FFI library largely obviates the need to write tedious manual Lua/C bindings in C. No need to learn a separate binding language â€”
     <strong>
      it parses plain C declarations!
     </strong>
     These can be cut-n-pasted from C header files or reference manuals. Itâ€™s up to the task of binding large libraries without the need for dealing with fragile binding generators.
    </p>
    <p>
     The FFI library is tightly integrated into LuaJIT (itâ€™s not available as a separate module). The code generated by the JIT-compiler for accesses to C data structures from Lua code is on par with the code a C compiler would generate. Calls to C functions can be inlined in JIT-compiled code, unlike calls to functions bound via the classic Lua/C API.
    </p>
    <h3>
     <a id="Motivating_Example_Calling_External_C_Functions_8">
     </a>
     Motivating Example: Calling External C Functions
    </h3>
    <p>
     Itâ€™s really easy to call an external C library function:
    </p>
    <pre><code class="prism language-lua"><span class="token comment">-- 1</span>
<span class="token keyword">local</span> ffi <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"ffi"</span><span class="token punctuation">)</span>
<span class="token comment">-- 2</span>
ffi<span class="token punctuation">.</span>cdef<span class="token string">[[
int printf(const char *fmt, ...);
]]</span>
<span class="token comment">-- 3</span>
ffi<span class="token punctuation">.</span>C<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Hello %s!"</span><span class="token punctuation">,</span> <span class="token string">"world"</span><span class="token punctuation">)</span>
</code></pre>
    <ol>
     <li>
      Load the FFI library.
     </li>
     <li>
      Add a C declaration for the function. The part inside the double-brackets is just standard C syntax.
     </li>
     <li>
      Call the named C function â€” Yes, itâ€™s that simple!
     </li>
    </ol>
    <p>
     Actually, what goes on behind the scenes is far from simple:
     <strong>
      makes use of the standard C library namespace
      <code>
       ffi.C
      </code>
      . Indexing this namespace with a symbol name (
      <code>
       "printf"
      </code>
      ) automatically binds it to the standard C library. The result is a special kind of object which, when called, runs the
      <code>
       printf
      </code>
      function. The arguments passed to this function are automatically converted from Lua objects to the corresponding C types.
     </strong>
    </p>
    <p>
     Ok, so maybe the use of
     <code>
      printf()
     </code>
     wasnâ€™t such a spectacular example. You could have done that with
     <code>
      io.write()
     </code>
     and
     <code>
      string.format()
     </code>
     , too. But you get the idea â€¦
    </p>
    <p>
     So hereâ€™s something to pop up a message box on Windows:
    </p>
    <pre><code class="prism language-lua"><span class="token keyword">local</span> ffi <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"ffi"</span><span class="token punctuation">)</span>
ffi<span class="token punctuation">.</span>cdef<span class="token string">[[
int MessageBoxA(void *w, const char *txt, const char *cap, int type);
]]</span>
ffi<span class="token punctuation">.</span>C<span class="token punctuation">.</span><span class="token function">MessageBoxA</span><span class="token punctuation">(</span><span class="token keyword">nil</span><span class="token punctuation">,</span> <span class="token string">"Hello world!"</span><span class="token punctuation">,</span> <span class="token string">"Test"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     Bing! Again, that was far too easy, no?
    </p>
    <h4>
     <a id="Lua__C__43">
     </a>
     ä¾‹å­ï¼šLua ä¸­è°ƒç”¨ C å‡½æ•°
    </h4>
    <p>
     å¦‚æœæ²¡æœ‰ FFI åº“ï¼Œè°ƒç”¨ C åº“çš„ printf å‡½æ•°éœ€è¦å†™ä¸€ä¸ª C æ¨¡å—ï¼Œç„¶ååœ¨ Lua ä»£ç ä¸­è°ƒç”¨ã€‚
    </p>
    <pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdarg.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;lua.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;lauxlib.h&gt;</span></span>

<span class="token comment">// C å‡½æ•°ï¼šè°ƒç”¨ printf å¹¶è¿”å›æ‰“å°çš„å­—ç¬¦æ•°</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">l_myprintf</span><span class="token punctuation">(</span>lua_State <span class="token operator">*</span>L<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>format <span class="token operator">=</span> <span class="token function">luaL_checkstring</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// è·å–æ ¼å¼åŒ–å­—ç¬¦ä¸²</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>str <span class="token operator">=</span> <span class="token function">luaL_checkstring</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// è·å–ç¬¬äºŒä¸ªå‚æ•°</span>

    <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token function">printf</span><span class="token punctuation">(</span>format<span class="token punctuation">,</span> str<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// è°ƒç”¨ printf</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// ä¸è¿”å›ä»»ä½• Lua å€¼</span>
<span class="token punctuation">}</span>

<span class="token comment">// Lua è°ƒç”¨ C å‡½æ•°çš„æ˜ å°„è¡¨</span>
<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">luaL_Reg</span> mylib<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">{<!-- --></span><span class="token string">"printf"</span><span class="token punctuation">,</span> l_myprintf<span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">}</span> <span class="token comment">// ç»“æŸæ ‡è®°</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// å…¥å£å‡½æ•°ï¼Œæ³¨å†Œåº“</span>
<span class="token keyword">int</span> <span class="token function">luaopen_mylib</span><span class="token punctuation">(</span>lua_State <span class="token operator">*</span>L<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">luaL_register</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> <span class="token string">"mylib"</span><span class="token punctuation">,</span> mylib<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     Lua ä»£ç 
    </p>
    <pre><code class="prism language-lua"><span class="token keyword">local</span> mylib <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"mylib"</span><span class="token punctuation">)</span>
mylib<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Hello %s!\n"</span><span class="token punctuation">,</span> <span class="token string">"world"</span><span class="token punctuation">)</span>

</code></pre>
    <p>
     Compare this with the effort required to bind that function using the classic Lua/C API: create an extra C file, add a C function that retrieves and checks the argument types passed from Lua and calls the actual C function, add a list of module functions and their names, add a
     <code>
      luaopen_*
     </code>
     function and register all module functions, compile and link it into a shared library (DLL), move it to the proper path, add Lua code that loads the module aaaand â€¦ finally call the binding function. Phew!
    </p>
    <p>
     ä¸€å¯¹æ¯”ï¼Œè°ƒç”¨ C å‡½æ•°ç®€å•äº†å¾ˆå¤šï¼
    </p>
    <p>
     å†çœ‹ä¸€ä¸ªä¾‹å­ï¼Œåœ¨ Lua ä¸­ç›´æ¥ä½¿ç”¨ C è¯­è¨€çš„ç»“æ„ä½“ã€‚
    </p>
    <h3>
     <a id="Motivating_Example_Using_C_Data_Structures_89">
     </a>
     Motivating Example: Using C Data Structures
    </h3>
    <p>
     The FFI library allows you to create and access C data structures. Of course, the main use for this is for interfacing with C functions. But they can be used stand-alone, too.
    </p>
    <p>
     Hereâ€™s a sketch of a library that operates on color images, plus a simple benchmark. First, the plain Lua version:
    </p>
    <pre><code class="prism language-lua"><span class="token keyword">local</span> floor <span class="token operator">=</span> math<span class="token punctuation">.</span>floor

<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">image_ramp_green</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
  <span class="token keyword">local</span> img <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
  <span class="token keyword">local</span> f <span class="token operator">=</span> <span class="token number">255</span><span class="token operator">/</span><span class="token punctuation">(</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token keyword">for</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>n <span class="token keyword">do</span>
    img<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> red <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> green <span class="token operator">=</span> <span class="token function">floor</span><span class="token punctuation">(</span><span class="token punctuation">(</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>f<span class="token punctuation">)</span><span class="token punctuation">,</span> blue <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> alpha <span class="token operator">=</span> <span class="token number">255</span> <span class="token punctuation">}</span>
  <span class="token keyword">end</span>
  <span class="token keyword">return</span> img
<span class="token keyword">end</span>

<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">image_to_gray</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> n<span class="token punctuation">)</span>
  <span class="token keyword">for</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>n <span class="token keyword">do</span>
    <span class="token keyword">local</span> y <span class="token operator">=</span> <span class="token function">floor</span><span class="token punctuation">(</span><span class="token number">0.3</span><span class="token operator">*</span>img<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>red <span class="token operator">+</span> <span class="token number">0.59</span><span class="token operator">*</span>img<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>green <span class="token operator">+</span> <span class="token number">0.11</span><span class="token operator">*</span>img<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>blue<span class="token punctuation">)</span>
    img<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>red <span class="token operator">=</span> y<span class="token punctuation">;</span> img<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>green <span class="token operator">=</span> y<span class="token punctuation">;</span> img<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>blue <span class="token operator">=</span> y
  <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token keyword">local</span> N <span class="token operator">=</span> <span class="token number">400</span><span class="token operator">*</span><span class="token number">400</span>
<span class="token keyword">local</span> img <span class="token operator">=</span> <span class="token function">image_ramp_green</span><span class="token punctuation">(</span>N<span class="token punctuation">)</span>
<span class="token keyword">for</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1000</span> <span class="token keyword">do</span>
  <span class="token function">image_to_gray</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> N<span class="token punctuation">)</span>
<span class="token keyword">end</span>
</code></pre>
    <p>
     This creates a table with 160.000 pixels, each of which is a table holding four number values in the range of 0-255. First, an image with a green ramp is created (1D for simplicity), then the image is converted to grayscale 1000 times. Yes, thatâ€™s silly, but I was in need of a simple example â€¦
    </p>
    <p>
     And hereâ€™s the FFI version. The modified parts have been marked in bold:
    </p>
    <pre><code class="prism language-lua"><span class="token comment">-- 1</span>
<span class="token keyword">local</span> ffi <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"ffi"</span><span class="token punctuation">)</span>
ffi<span class="token punctuation">.</span>cdef<span class="token string">[[
typedef struct { uint8_t red, green, blue, alpha; } rgba_pixel;
]]</span>

<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">image_ramp_green</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
<span class="token comment">-- 2</span>
  <span class="token keyword">local</span> img <span class="token operator">=</span> ffi<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"rgba_pixel[?]"</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span>
  <span class="token keyword">local</span> f <span class="token operator">=</span> <span class="token number">255</span><span class="token operator">/</span><span class="token punctuation">(</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment">-- 3</span>
  <span class="token keyword">for</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>n<span class="token operator">-</span><span class="token number">1</span> <span class="token keyword">do</span>
<span class="token comment">-- 4</span>
    img<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>green <span class="token operator">=</span> i<span class="token operator">*</span>f
    img<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>alpha <span class="token operator">=</span> <span class="token number">255</span>
  <span class="token keyword">end</span>
  <span class="token keyword">return</span> img
<span class="token keyword">end</span>

<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">image_to_grey</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> n<span class="token punctuation">)</span>
<span class="token comment">-- 3</span>
  <span class="token keyword">for</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>n<span class="token operator">-</span><span class="token number">1</span> <span class="token keyword">do</span>
<span class="token comment">-- 5</span>
    <span class="token keyword">local</span> y <span class="token operator">=</span> <span class="token number">0.3</span><span class="token operator">*</span>img<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>red <span class="token operator">+</span> <span class="token number">0.59</span><span class="token operator">*</span>img<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>green <span class="token operator">+</span> <span class="token number">0.11</span><span class="token operator">*</span>img<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>blue
    img<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>red <span class="token operator">=</span> y<span class="token punctuation">;</span> img<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>green <span class="token operator">=</span> y<span class="token punctuation">;</span> img<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>blue <span class="token operator">=</span> y
  <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token keyword">local</span> N <span class="token operator">=</span> <span class="token number">400</span><span class="token operator">*</span><span class="token number">400</span>
<span class="token keyword">local</span> img <span class="token operator">=</span> <span class="token function">image_ramp_green</span><span class="token punctuation">(</span>N<span class="token punctuation">)</span>
<span class="token keyword">for</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1000</span> <span class="token keyword">do</span>
  <span class="token function">image_to_grey</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> N<span class="token punctuation">)</span>
<span class="token keyword">end</span>
</code></pre>
    <p>
     Ok, so that wasnâ€™t too difficult:
    </p>
    <ol>
     <li>
      First, load the FFI library and declare the low-level data type. Here we choose a
      <code>
       struct
      </code>
      which holds four byte fields, one for each component of a 4x8 bit RGBA pixel.
     </li>
     <li>
      Creating the data structure with
      <code>
       ffi.new()
      </code>
      is straightforward â€” the
      <code>
       '?'
      </code>
      is a placeholder for the number of elements of a variable-length array.
     </li>
     <li>
      C arrays are zero-based, so the indexes have to run from
      <code>
       0
      </code>
      to
      <code>
       n-1
      </code>
      . One might want to allocate one more element instead to simplify converting legacy code.
     </li>
     <li>
      Since
      <code>
       ffi.new()
      </code>
      zero-fills the array by default, we only need to set the green and the alpha fields.
     </li>
     <li>
      The calls to
      <code>
       math.floor()
      </code>
      can be omitted here, because floating-point numbers are already truncated towards zero when converting them to an integer. This happens implicitly when the number is stored in the fields of each pixel.
     </li>
    </ol>
    <p>
     Now letâ€™s have a look at the impact of the changes: first, memory consumption for the image is down from 22 Megabytes to 640 Kilobytes (400
     <em>
      400
     </em>
     4 bytes). Thatâ€™s a factor of 35x less! So, yes, tables do have a noticeable overhead. BTW: The original program would consume 40 Megabytes in plain Lua (on x64).
    </p>
    <p>
     å†…å­˜æ¶ˆè€—æ¯”åŸå§‹çš„ç¨‹åºå°‘35å€ï¼
    </p>
    <p>
     Next, performance: the pure Lua version runs in 9.57 seconds (52.9 seconds with the Lua interpreter) and the FFI version runs in 0.48 seconds on my machine (YMMV). Thatâ€™s a factor of 20x faster (110x faster than the Lua interpreter).
    </p>
    <p>
     ä½¿ç”¨ LuaJIT FFI åº“ï¼Œæ‰§è¡Œæ—¶é—´æ¯”ä½¿ç”¨ Lua5.1 çš„çº¯ Lua ç¨‹åºå¿«110å€ï¼
    </p>
    <p>
     çŸ¥é“ LuaJIT ç‰›ï¼Œæ²¡æƒ³åˆ°è¿™ä¹ˆç‰›ï¼
    </p>
    <p>
     å†çœ‹ä¸€äº›ä¾‹å­
    </p>
    <h3>
     <a id="Accessing_Standard_System_Functions_181">
     </a>
     Accessing Standard System Functions
    </h3>
    <p>
     The following code explains how to access standard system functions. We slowly print two lines of dots by sleeping for 10 milliseconds after each dot:
    </p>
    <pre><code class="prism language-lua"><span class="token keyword">local</span> ffi <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"ffi"</span><span class="token punctuation">)</span>
<span class="token comment">-- 1</span>
ffi<span class="token punctuation">.</span>cdef<span class="token string">[[
void Sleep(int ms);
int poll(struct pollfd *fds, unsigned long nfds, int timeout);
]]</span>

<span class="token keyword">local</span> sleep
<span class="token comment">-- 2</span>
<span class="token keyword">if</span> ffi<span class="token punctuation">.</span>os <span class="token operator">==</span> <span class="token string">"Windows"</span> <span class="token keyword">then</span>
<span class="token comment">-- 3</span>
  <span class="token keyword">function</span> <span class="token function">sleep</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
<span class="token comment">-- 4</span>
    ffi<span class="token punctuation">.</span>C<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>s<span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">)</span>
  <span class="token keyword">end</span>
<span class="token keyword">else</span>
  <span class="token keyword">function</span> <span class="token function">sleep</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
<span class="token comment">-- 5</span>
    ffi<span class="token punctuation">.</span>C<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token keyword">nil</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> s<span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">)</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token keyword">for</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">160</span> <span class="token keyword">do</span>
  io<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">;</span> io<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">-- 6</span>
  <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">0.01</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>
io<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     Hereâ€™s the step-by-step explanation:
    </p>
    <ol>
     <li>
      This defines the C library functions weâ€™re going to use. The part inside the double-brackets is just standard C syntax. You can usually get this info from the C header files or the documentation provided by each C library or C compiler.
     </li>
     <li>
      The difficulty weâ€™re facing here, is that there are different standards to choose from. Windows has a simple
      <code>
       Sleep()
      </code>
      function. On other systems there are a variety of functions available to achieve sub-second sleeps, but with no clear consensus. Thankfully
      <code>
       poll()
      </code>
      can be used for this task, too, and itâ€™s present on most non-Windows systems. The check for
      <code>
       ffi.os
      </code>
      makes sure we use the Windows-specific function only on Windows systems.
     </li>
     <li>
      Here weâ€™re wrapping the call to the C function in a Lua function. This isnâ€™t strictly necessary, but itâ€™s helpful to deal with system-specific issues only in one part of the code. The way weâ€™re wrapping it ensures the check for the OS is only done during initialization and not for every call.
     </li>
     <li>
      A more subtle point is that we defined our
      <code>
       sleep()
      </code>
      function (for the sake of this example) as taking the number of seconds, but accepting fractional seconds. Multiplying this by 1000 gets us milliseconds, but that still leaves it a Lua number, which is a floating-point value. Alas, the
      <code>
       Sleep()
      </code>
      function only accepts an integer value.
      <strong>
       Luckily for us, the FFI library automatically performs the conversion when calling the function (truncating the FP value towards zero, like in C).
      </strong>
     </li>
    </ol>
    <p>
     Some readers will notice that
     <code>
      Sleep()
     </code>
     is part of
     <code>
      KERNEL32.DLL
     </code>
     and is also a
     <code>
      stdcall
     </code>
     function. So how can this possibly work? The FFI library provides the
     <code>
      ffi.C
     </code>
     default C library namespace, which allows calling functions from the default set of libraries, like a C compiler would. Also,
     <strong>
      the FFI library automatically detects
      <code>
       stdcall
      </code>
      functions, so you donâ€™t need to declare them as such.
     </strong>
    </p>
    <ol start="5">
     <li>
      The
      <code>
       poll()
      </code>
      function takes a couple more arguments weâ€™re not going to use.
      <strong>
       You can simply use
       <code>
        nil
       </code>
       to pass a
       <code>
        NULL
       </code>
       pointer and
       <code>
        0
       </code>
       for the
       <code>
        nfds
       </code>
       parameter.
      </strong>
      Please note, that the number
      <code>
       0
      </code>
      <em>
       does not convert to a pointer value
      </em>
      , unlike in C++. You really have to pass pointers to pointer arguments and numbers to number arguments.
     </li>
    </ol>
    <p>
     The page on
     <a href="https://luajit.org/ext_ffi_semantics.html" rel="nofollow">
      FFI semantics
     </a>
     has all of the gory details about
     <a href="https://luajit.org/ext_ffi_semantics.html#convert" rel="nofollow">
      conversions between Lua objects and C types
     </a>
     . For the most part you donâ€™t have to deal with this, as itâ€™s performed automatically and itâ€™s carefully designed to bridge the semantic differences between Lua and C.
    </p>
    <ol start="6">
     <li>
      Now that we have defined our own
      <code>
       sleep()
      </code>
      function, we can just call it from plain Lua code. That wasnâ€™t so bad, huh? Turning these boring animated dots into a fascinating best-selling game is left as an exercise for the reader. ğŸ˜ƒ
     </li>
    </ol>
    <h3>
     <a id="Accessing_the_zlib_Compression_Library_231">
     </a>
     Accessing the zlib Compression Library
    </h3>
    <p>
     The following code shows how to access the
     <a href="https://zlib.net/" rel="nofollow">
      zlib
     </a>
     compression library from Lua code. Weâ€™ll define two convenience wrapper functions that take a string and compress or uncompress it to another string:
    </p>
    <pre><code class="prism language-lua"><span class="token keyword">local</span> ffi <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"ffi"</span><span class="token punctuation">)</span>
<span class="token comment">-- 1</span>
ffi<span class="token punctuation">.</span>cdef<span class="token string">[[
unsigned long compressBound(unsigned long sourceLen);
int compress2(uint8_t *dest, unsigned long *destLen,
	      const uint8_t *source, unsigned long sourceLen, int level);
int uncompress(uint8_t *dest, unsigned long *destLen,
	       const uint8_t *source, unsigned long sourceLen);
]]</span>
<span class="token comment">-- 2</span>
<span class="token keyword">local</span> zlib <span class="token operator">=</span> ffi<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>ffi<span class="token punctuation">.</span>os <span class="token operator">==</span> <span class="token string">"Windows"</span> <span class="token keyword">and</span> <span class="token string">"zlib1"</span> <span class="token keyword">or</span> <span class="token string">"z"</span><span class="token punctuation">)</span>

<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">compress</span><span class="token punctuation">(</span>txt<span class="token punctuation">)</span>
<span class="token comment">-- 3</span>
  <span class="token keyword">local</span> n <span class="token operator">=</span> zlib<span class="token punctuation">.</span><span class="token function">compressBound</span><span class="token punctuation">(</span><span class="token operator">#</span>txt<span class="token punctuation">)</span>
  <span class="token keyword">local</span> buf <span class="token operator">=</span> ffi<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"uint8_t[?]"</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span>
<span class="token comment">-- 4</span>
  <span class="token keyword">local</span> buflen <span class="token operator">=</span> ffi<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"unsigned long[1]"</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span>
  <span class="token keyword">local</span> res <span class="token operator">=</span> zlib<span class="token punctuation">.</span><span class="token function">compress2</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> buflen<span class="token punctuation">,</span> txt<span class="token punctuation">,</span> <span class="token operator">#</span>txt<span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>res <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token comment">-- 5</span>
  <span class="token keyword">return</span> ffi<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> buflen<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token comment">-- 6</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">uncompress</span><span class="token punctuation">(</span>comp<span class="token punctuation">,</span> n<span class="token punctuation">)</span>
  <span class="token keyword">local</span> buf <span class="token operator">=</span> ffi<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"uint8_t[?]"</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span>
  <span class="token keyword">local</span> buflen <span class="token operator">=</span> ffi<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"unsigned long[1]"</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span>
  <span class="token keyword">local</span> res <span class="token operator">=</span> zlib<span class="token punctuation">.</span><span class="token function">uncompress</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> buflen<span class="token punctuation">,</span> comp<span class="token punctuation">,</span> <span class="token operator">#</span>comp<span class="token punctuation">)</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>res <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> ffi<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> buflen<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token comment">-- 7. Simple test code.</span>
<span class="token keyword">local</span> txt <span class="token operator">=</span> string<span class="token punctuation">.</span><span class="token function">rep</span><span class="token punctuation">(</span><span class="token string">"abcd"</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"Uncompressed size: "</span><span class="token punctuation">,</span> <span class="token operator">#</span>txt<span class="token punctuation">)</span>
<span class="token keyword">local</span> c <span class="token operator">=</span> <span class="token function">compress</span><span class="token punctuation">(</span>txt<span class="token punctuation">)</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"Compressed size: "</span><span class="token punctuation">,</span> <span class="token operator">#</span>c<span class="token punctuation">)</span>
<span class="token keyword">local</span> txt2 <span class="token operator">=</span> <span class="token function">uncompress</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token operator">#</span>txt<span class="token punctuation">)</span>
<span class="token function">assert</span><span class="token punctuation">(</span>txt2 <span class="token operator">==</span> txt<span class="token punctuation">)</span>
</code></pre>
    <p>
     Hereâ€™s the step-by-step explanation:
    </p>
    <ol>
     <li>
      <p>
       This defines some of the C functions provided by zlib. For the sake of this example, some type indirections have been reduced and it uses the predefined fixed-size integer types, while still adhering to the zlib API/ABI.
      </p>
     </li>
     <li>
      <p>
       This loads the zlib shared library. On POSIX systems, itâ€™s named
       <code>
        libz.so
       </code>
       and usually comes pre-installed.
       <strong>
        Since
        <code>
         ffi.load()
        </code>
        automatically adds any missing standard prefixes/suffixes, we can simply load the
        <code>
         "z"
        </code>
        library
       </strong>
       . On Windows itâ€™s named
       <code>
        zlib1.dll
       </code>
       and youâ€™ll have to download it first from the
       <a href="https://zlib.net/" rel="nofollow">
        zlib site
       </a>
       . The check for
       <code>
        ffi.os
       </code>
       makes sure we pass the right name to
       <code>
        ffi.load()
       </code>
       .
      </p>
     </li>
     <li>
      <p>
       First, the maximum size of the compression buffer is obtained by calling the
       <code>
        zlib.compressBound
       </code>
       function with the length of the uncompressed string. The next line allocates a byte buffer of this size.
       <strong>
        The
        <code>
         [?]
        </code>
        in the type specification indicates a variable-length array (VLA).
       </strong>
       The actual number of elements of this array is given as the 2nd argument to
       <code>
        ffi.new()
       </code>
       .
      </p>
     </li>
     <li>
      <p>
       This may look strange at first, but have a look at the declaration of the
       <code>
        compress2
       </code>
       function from zlib: the destination length is defined as a pointer! This is because you pass in the maximum buffer size and get back the actual length that was used.
      </p>
      <p>
       <strong>
        In C youâ€™d pass in the address of a local variable (
        <code>
         &amp;buflen
        </code>
        ). But since thereâ€™s no address-of operator in Lua, weâ€™ll just pass in a one-element array.
       </strong>
       Conveniently, it can be initialized with the maximum buffer size in one step. Calling the actual
       <code>
        zlib.compress2
       </code>
       function is then straightforward.
      </p>
     </li>
     <li>
      <p>
       <strong>
        We want to return the compressed data as a Lua string, so weâ€™ll use
        <code>
         ffi.string()
        </code>
       </strong>
       . It needs a pointer to the start of the data and the actual length. The length has been returned in the
       <code>
        buflen
       </code>
       array, so weâ€™ll just get it from there.
      </p>
     </li>
    </ol>
    <p>
     Note that since the function returns now, the
     <code>
      buf
     </code>
     and
     <code>
      buflen
     </code>
     variables will eventually be garbage collected. This is fine, because
     <code>
      ffi.string()
     </code>
     has copied the contents to a newly created (interned) Lua string. If you plan to call this function lots of times, consider reusing the buffers and/or handing back the results in buffers instead of strings. This will reduce the overhead for garbage collection and string interning.
    </p>
    <ol start="6">
     <li>
      The
      <code>
       uncompress
      </code>
      functions does the exact opposite of the
      <code>
       compress
      </code>
      function. The compressed data doesnâ€™t include the size of the original string, so this needs to be passed in. Otherwise, no surprises here.
     </li>
     <li>
      The code, that makes use of the functions we just defined, is just plain Lua code. It doesnâ€™t need to know anything about the LuaJIT FFI â€” the convenience wrapper functions completely hide it.
     </li>
    </ol>
    <p>
     <strong>
      One major advantage of the LuaJIT FFI is that you are now able to write those wrappers
      <em>
       in Lua
      </em>
      .
     </strong>
     And at a fraction of the time it would cost you to create an extra C module using the Lua/C API. Many of the simpler C functions can probably be used directly from your Lua code, without any wrappers.
    </p>
    <p>
     Side note: the zlib API uses the
     <code>
      long
     </code>
     type for passing lengths and sizes around. But all those zlib functions actually only deal with 32 bit values. This is an unfortunate choice for a public API, but may be explained by zlibâ€™s history â€” weâ€™ll just have to deal with it.
    </p>
    <p>
     First, you should know that a
     <code>
      long
     </code>
     is a 64 bit type e.g. on POSIX/x64 systems, but a 32 bit type on Windows/x64 and on 32 bit systems. Thus a
     <code>
      long
     </code>
     result can be either a plain Lua number or a boxed 64 bit integer cdata object, depending on the target system.
    </p>
    <p>
     Ok, so the
     <code>
      ffi.*
     </code>
     functions generally accept cdata objects wherever youâ€™d want to use a number. Thatâ€™s why we get a away with passing
     <code>
      n
     </code>
     to
     <code>
      ffi.string()
     </code>
     above. But other Lua library functions or modules donâ€™t know how to deal with this.
     <strong>
      So for maximum portability, one needs to use
      <code>
       tonumber()
      </code>
      on returned
      <code>
       long
      </code>
      results before passing them on. Otherwise the application might work on some systems, but would fail in a POSIX/x64 environment.
     </strong>
    </p>
    <h3>
     <a id="Defining_Metamethods_for_a_C_Type_305">
     </a>
     Defining Metamethods for a C Type
    </h3>
    <p>
     The following code explains how to define metamethods for a C type. We define a simple point type and add some operations to it:
    </p>
    <pre><code class="prism language-lua"><span class="token keyword">local</span> ffi <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"ffi"</span><span class="token punctuation">)</span>
<span class="token comment">-- 1</span>
ffi<span class="token punctuation">.</span>cdef<span class="token string">[[
typedef struct { double x, y; } point_t;
]]</span>

<span class="token comment">-- 2</span>
<span class="token keyword">local</span> point
<span class="token keyword">local</span> mt <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">-- 3</span>
  __add <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">point</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>x<span class="token operator">+</span>b<span class="token punctuation">.</span>x<span class="token punctuation">,</span> a<span class="token punctuation">.</span>y<span class="token operator">+</span>b<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token keyword">end</span><span class="token punctuation">,</span>
  __len <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token keyword">return</span> math<span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>x<span class="token operator">*</span>a<span class="token punctuation">.</span>x <span class="token operator">+</span> a<span class="token punctuation">.</span>y<span class="token operator">*</span>a<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token keyword">end</span><span class="token punctuation">,</span>
<span class="token comment">-- 4</span>
  __index <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    area <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token keyword">return</span> a<span class="token punctuation">.</span>x<span class="token operator">*</span>a<span class="token punctuation">.</span>x <span class="token operator">+</span> a<span class="token punctuation">.</span>y<span class="token operator">*</span>a<span class="token punctuation">.</span>y <span class="token keyword">end</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token comment">-- 5</span>
point <span class="token operator">=</span> ffi<span class="token punctuation">.</span><span class="token function">metatype</span><span class="token punctuation">(</span><span class="token string">"point_t"</span><span class="token punctuation">,</span> mt<span class="token punctuation">)</span>

<span class="token comment">-- 6</span>
<span class="token keyword">local</span> a <span class="token operator">=</span> <span class="token function">point</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
<span class="token function">print</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>x<span class="token punctuation">,</span> a<span class="token punctuation">.</span>y<span class="token punctuation">)</span>  <span class="token comment">--&gt; 3  4</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token operator">#</span>a<span class="token punctuation">)</span>        <span class="token comment">--&gt; 5</span>
<span class="token function">print</span><span class="token punctuation">(</span>a<span class="token punctuation">:</span><span class="token function">area</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">--&gt; 25</span>
<span class="token keyword">local</span> b <span class="token operator">=</span> a <span class="token operator">+</span> <span class="token function">point</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token operator">#</span>b<span class="token punctuation">)</span>        <span class="token comment">--&gt; 12.5</span>
</code></pre>
    <p>
     Hereâ€™s the step-by-step explanation:
    </p>
    <ol>
     <li>
      This defines the C type for a two-dimensional point object.
     </li>
     <li>
      We have to declare the variable holding the point constructor first, because itâ€™s used inside of a metamethod.
     </li>
     <li>
      Letâ€™s define an
      <code>
       __add
      </code>
      metamethod which adds the coordinates of two points and creates a new point object. For simplicity, this function assumes that both arguments are points. But it could be any mix of objects, if at least one operand is of the required type (e.g. adding a point plus a number or vice versa). Our
      <code>
       __len
      </code>
      metamethod returns the distance of a point to the origin.
     </li>
     <li>
      If we run out of operators, we can define named methods, too. Here, the
      <code>
       __index
      </code>
      table defines an
      <code>
       area
      </code>
      function. For custom indexing needs, one might want to define
      <code>
       __index
      </code>
      and
      <code>
       __newindex
      </code>
      <em>
       functions
      </em>
      instead.
     </li>
     <li>
      <strong>
       This associates the metamethods with our C type. This only needs to be done once.
      </strong>
      For convenience, a constructor is returned by
      <a href="https://luajit.org/ext_ffi_api.html#ffi_metatype" rel="nofollow">
       <code>
        ffi.metatype()
       </code>
      </a>
      .
      <strong>
       Weâ€™re not required to use it, though. The original C type can still be used e.g. to create an array of points. The metamethods automatically apply to any and all uses of this type.
      </strong>
     </li>
    </ol>
    <p>
     Please note, that the association with a metatable is permanent and
     <strong>
      the metatable must not be modified afterwards!
     </strong>
     Ditto for the
     <code>
      __index
     </code>
     table.
    </p>
    <ol start="6">
     <li>
      Here are some simple usage examples for the point type and their expected results. The predefined operations (such as
      <code>
       a.x
      </code>
      ) can be freely mixed with the newly defined metamethods. Note that
      <code>
       area
      </code>
      is a method and must be called with the Lua syntax for methods:
      <code>
       a:area()
      </code>
      , not
      <code>
       a.area()
      </code>
      .
     </li>
    </ol>
    <p>
     The C type metamethod mechanism is most useful when used in conjunction with C libraries that are written in an object-oriented style. Creators return a pointer to a new instance, and methods take an instance pointer as the first argument. Sometimes you can just point
     <code>
      __index
     </code>
     to the library namespace and
     <code>
      __gc
     </code>
     to the destructor and youâ€™re done. But often enough youâ€™ll want to add convenience wrappers, e.g. to return actual Lua strings or when returning multiple values.
    </p>
    <p>
     ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœä½ æœ‰ä¸€ä¸ª C åº“
     <code>
      mylib
     </code>
     ï¼Œå®ƒæœ‰ä¸€ä¸ªæ–¹æ³•
     <code>
      mylib:do_something()
     </code>
     ï¼Œä½ å¯ä»¥é€šè¿‡
     <code>
      __index
     </code>
     å°†è¯¥æ–¹æ³•æš´éœ²ç»™ Luaï¼š
    </p>
    <pre><code class="prism language-lua"><span class="token keyword">local</span> ffi <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"ffi"</span><span class="token punctuation">)</span>
ffi<span class="token punctuation">.</span>cdef<span class="token string">[[
  typedef struct { int x, y; } MyObject;
  void do_something(MyObject* obj);
]]</span>

<span class="token keyword">local</span> mylib <span class="token operator">=</span> ffi<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token string">"mylib"</span><span class="token punctuation">)</span>

<span class="token comment">-- ç»‘å®šä¸€ä¸ª MyObject ç±»å‹</span>
<span class="token keyword">local</span> MyObject <span class="token operator">=</span> ffi<span class="token punctuation">.</span><span class="token function">metatype</span><span class="token punctuation">(</span><span class="token string">"MyObject"</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
  __index <span class="token operator">=</span> mylib<span class="token punctuation">,</span>  <span class="token comment">-- å°† __index æŒ‡å‘åº“çš„å‘½åç©ºé—´</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">-- åˆ›å»ºä¸€ä¸ª MyObject å®ä¾‹</span>
<span class="token keyword">local</span> obj <span class="token operator">=</span> <span class="token function">MyObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">-- ç›´æ¥ä½¿ç”¨ C åº“çš„æ–¹æ³•</span>
obj<span class="token punctuation">:</span><span class="token function">do_something</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre>
    <p>
     æ–‡æ¡£ä¸­è¿˜æåˆ°ï¼Œæœ‰æ—¶å€™ä½ éœ€è¦æ‰‹åŠ¨å®šä¹‰
     <code>
      __gc
     </code>
     æ¥å¤„ç†å¯¹è±¡çš„é”€æ¯ã€‚åœ¨ Lua ä¸­åˆ›å»ºçš„ C å¯¹è±¡ï¼Œå¯èƒ½éœ€è¦åœ¨ Lua å¯¹è±¡è¢«åƒåœ¾å›æ”¶æ—¶æ¸…ç†å¯¹åº”çš„ C èµ„æºï¼ˆä¾‹å¦‚å…³é—­æ–‡ä»¶å¥æŸ„ã€é‡Šæ”¾å†…å­˜ç­‰ï¼‰ã€‚ä½ å¯ä»¥é€šè¿‡
     <code>
      __gc
     </code>
     æ¥å®šä¹‰ææ„å‡½æ•°ã€‚
    </p>
    <pre><code class="prism language-lua"><span class="token keyword">local</span> ffi <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"ffi"</span><span class="token punctuation">)</span>

ffi<span class="token punctuation">.</span>cdef<span class="token string">[[
  typedef struct { int x, y; } MyObject;
  void destroy_object(MyObject* obj);
]]</span>

<span class="token keyword">local</span> mylib <span class="token operator">=</span> ffi<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token string">"mylib"</span><span class="token punctuation">)</span>

<span class="token keyword">local</span> MyObject <span class="token operator">=</span> ffi<span class="token punctuation">.</span><span class="token function">metatype</span><span class="token punctuation">(</span><span class="token string">"MyObject"</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">-- å®šä¹‰ææ„å‡½æ•°</span>
  __gc <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span>
    mylib<span class="token punctuation">.</span><span class="token function">destroy_object</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span>
  <span class="token keyword">end</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">-- åˆ›å»ºä¸€ä¸ª MyObject å®ä¾‹</span>
<span class="token keyword">local</span> obj <span class="token operator">=</span> <span class="token function">MyObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre>
    <p>
     Some C libraries only declare instance pointers as an opaque
     <code>
      void *
     </code>
     type. In this case you can use a fake type for all declarations, e.g. a pointer to a named (incomplete) struct will do:
     <code>
      typedef struct foo_type *foo_handle
     </code>
     . The C side doesnâ€™t know what you declare with the LuaJIT FFI, but as long as the underlying types are compatible, everything still works.
    </p>
    <hr/>
    <h4>
     <a id="_userdata_405">
     </a>
     ä¾‹å­ï¼šåˆ›å»º userdata
    </h4>
    <p>
     å¦‚æœä¸ä½¿ç”¨ LuaJITï¼Œä½¿ç”¨æ ‡å‡†çš„ Lua è§£é‡Šå™¨å®ç°ç›¸åŒçš„ç¨‹åºï¼Œé‚£ä¹ˆéœ€è¦åˆ›å»ºä¸€ä¸ª C æ¨¡å—ï¼Œæ¨¡å—æä¾›å‡½æ•°åˆ›å»ºä¸€ä¸ª userdataï¼Œå¹¶ç»™å®ƒè®¾ç½®å…ƒè¡¨
    </p>
    <pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;lua.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;lauxlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;lualib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;math.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">double</span> x<span class="token punctuation">,</span> y<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token class-name">point_t</span><span class="token punctuation">;</span>

<span class="token comment">// åˆ›å»º point å®ä¾‹</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">point_new</span><span class="token punctuation">(</span>lua_State <span class="token operator">*</span>L<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">double</span> x <span class="token operator">=</span> <span class="token function">luaL_checknumber</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> y <span class="token operator">=</span> <span class="token function">luaL_checknumber</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">point_t</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">point_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">lua_newuserdata</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">point_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    p<span class="token operator">-&gt;</span>x <span class="token operator">=</span> x<span class="token punctuation">;</span>
    p<span class="token operator">-&gt;</span>y <span class="token operator">=</span> y<span class="token punctuation">;</span>

    <span class="token function">luaL_getmetatable</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> <span class="token string">"PointMT"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">lua_setmetatable</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// __add è¿ç®—ç¬¦</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">point_add</span><span class="token punctuation">(</span>lua_State <span class="token operator">*</span>L<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">point_t</span> <span class="token operator">*</span>a <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">point_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">luaL_checkudata</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"PointMT"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">point_t</span> <span class="token operator">*</span>b <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">point_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">luaL_checkudata</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"PointMT"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">lua_pushcfunction</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> point_new<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">lua_pushnumber</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> a<span class="token operator">-&gt;</span>x <span class="token operator">+</span> b<span class="token operator">-&gt;</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">lua_pushnumber</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> a<span class="token operator">-&gt;</span>y <span class="token operator">+</span> b<span class="token operator">-&gt;</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">lua_call</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// __len è¿ç®—ç¬¦</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">point_len</span><span class="token punctuation">(</span>lua_State <span class="token operator">*</span>L<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">point_t</span> <span class="token operator">*</span>a <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">point_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">luaL_checkudata</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"PointMT"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">lua_pushnumber</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> <span class="token function">sqrt</span><span class="token punctuation">(</span>a<span class="token operator">-&gt;</span>x <span class="token operator">*</span> a<span class="token operator">-&gt;</span>x <span class="token operator">+</span> a<span class="token operator">-&gt;</span>y <span class="token operator">*</span> a<span class="token operator">-&gt;</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// area æ–¹æ³•</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">point_area</span><span class="token punctuation">(</span>lua_State <span class="token operator">*</span>L<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">point_t</span> <span class="token operator">*</span>a <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">point_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">luaL_checkudata</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"PointMT"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">lua_pushnumber</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> a<span class="token operator">-&gt;</span>x <span class="token operator">*</span> a<span class="token operator">-&gt;</span>x <span class="token operator">+</span> a<span class="token operator">-&gt;</span>y <span class="token operator">*</span> a<span class="token operator">-&gt;</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// è·å–å­—æ®µ</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">point_get</span><span class="token punctuation">(</span>lua_State <span class="token operator">*</span>L<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">point_t</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">point_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">luaL_checkudata</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"PointMT"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>key <span class="token operator">=</span> <span class="token function">luaL_checkstring</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token string">"x"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">lua_pushnumber</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token string">"y"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">lua_pushnumber</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token string">"area"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">lua_pushcfunction</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> point_area<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">lua_pushnil</span><span class="token punctuation">(</span>L<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// æ³¨å†Œ point_t ç›¸å…³çš„å…ƒè¡¨å’Œæ–¹æ³•</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">create_point_metatable</span><span class="token punctuation">(</span>lua_State <span class="token operator">*</span>L<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">luaL_newmetatable</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> <span class="token string">"PointMT"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">lua_pushstring</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> <span class="token string">"__add"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">lua_pushcfunction</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> point_add<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">lua_settable</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">lua_pushstring</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> <span class="token string">"__len"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">lua_pushcfunction</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> point_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">lua_settable</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">lua_pushstring</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> <span class="token string">"__index"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">lua_pushcfunction</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> point_get<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">lua_settable</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">lua_pop</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// æ³¨å†Œæ¨¡å—</span>
<span class="token keyword">static</span> <span class="token keyword">const</span> luaL_Reg pointlib<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">{<!-- --></span><span class="token string">"new"</span><span class="token punctuation">,</span> point_new<span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">luaopen_point</span><span class="token punctuation">(</span>lua_State <span class="token operator">*</span>L<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">create_point_metatable</span><span class="token punctuation">(</span>L<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">luaL_register</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> <span class="token string">"point"</span><span class="token punctuation">,</span> pointlib<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


</code></pre>
    <p>
     ç„¶ååœ¨ Lua ä¸­ä½¿ç”¨è¿™ä¸ªæ¨¡å—
    </p>
    <pre><code class="prism language-lua"><span class="token keyword">local</span> point <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"point"</span><span class="token punctuation">)</span>

<span class="token keyword">local</span> a <span class="token operator">=</span> point<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
<span class="token function">print</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>x<span class="token punctuation">,</span> a<span class="token punctuation">.</span>y<span class="token punctuation">)</span>   <span class="token comment">-- è¾“å‡º 3  4</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token operator">#</span>a<span class="token punctuation">)</span>         <span class="token comment">-- è¾“å‡º 5</span>
<span class="token function">print</span><span class="token punctuation">(</span>a<span class="token punctuation">:</span><span class="token function">area</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">-- è¾“å‡º 25</span>

<span class="token keyword">local</span> b <span class="token operator">=</span> a <span class="token operator">+</span> point<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token operator">#</span>b<span class="token punctuation">)</span>         <span class="token comment">-- è¾“å‡º 12.5</span>


</code></pre>
    <p>
     æ•´ä¸ªæµç¨‹è¦å¤æ‚å¾ˆå¤šã€‚ä¸å¾—ä¸è¯´ LuaJIT çœŸç‰›é€¼ï¼
    </p>
    <h3>
     <a id="Translating_C_Idioms_529">
     </a>
     Translating C Idioms
    </h3>
    <p>
     Hereâ€™s a list of common C idioms and their translation to the LuaJIT FFI:
     <br/>
     <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://i-blog.csdnimg.cn/direct/24256a0675b947c886ea48095a9adea3.png"/>
    </p>
    <h3>
     <a id="To_Cache_or_Not_to_Cache_533">
     </a>
     To Cache or Not to Cache
    </h3>
    <p>
     The JIT compiler has special logic to eliminate all of the lookup overhead for functions resolved from a C library namespace! Thus itâ€™s not helpful and actually counter-productive to cache individual C functions like this:
    </p>
    <pre><code class="prism language-lua"><span class="token keyword">local</span> funca<span class="token punctuation">,</span> funcb <span class="token operator">=</span> ffi<span class="token punctuation">.</span>C<span class="token punctuation">.</span>funca<span class="token punctuation">,</span> ffi<span class="token punctuation">.</span>C<span class="token punctuation">.</span>funcb <span class="token comment">-- Not helpful!</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> n<span class="token punctuation">)</span>
  <span class="token keyword">for</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>n <span class="token keyword">do</span> <span class="token function">funcb</span><span class="token punctuation">(</span><span class="token function">funca</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">end</span>
<span class="token keyword">end</span>
</code></pre>
    <p>
     This turns them into indirect calls and generates bigger and slower machine code. Instead, youâ€™ll want to cache the namespace itself and rely on the JIT compiler to eliminate the lookups:
    </p>
    <pre><code class="prism language-lua"><span class="token keyword">local</span> C <span class="token operator">=</span> ffi<span class="token punctuation">.</span>C          <span class="token comment">-- Instead use this!</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> n<span class="token punctuation">)</span>
  <span class="token keyword">for</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>n <span class="token keyword">do</span> C<span class="token punctuation">.</span><span class="token function">funcb</span><span class="token punctuation">(</span>C<span class="token punctuation">.</span><span class="token function">funca</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">end</span>
<span class="token keyword">end</span>
</code></pre>
    <p>
     This generates both shorter and faster code.
     <strong>
      So donâ€™t cache C functions, but do cache namespaces!
     </strong>
     Most often the namespace is already in a local variable at an outer scope, e.g. from local lib = ffi.load(â€¦). Note that copying it to a local variable in the function scope is unnecessary.
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a:2f2f626c6f672e6373646e2e6e65742f776f6179323030382f:61727469636c652f64657461696c732f313436323139373839" class_="artid" style="display:none">
 </p>
</div>


