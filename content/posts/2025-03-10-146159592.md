---
layout: post
title: "k8s集群中部署dcgm-exporter收集GPU指标"
date: 2025-03-10 17:37:22 +0800
description: "部署dcgm-exporter的DaemonSet和Service，确保Service有正确的标签和端口。创建ServiceMonitor，选择dcgm-exporter的Service，并指定端口。检查Prometheus的targets页面，确认dcgm-exporter是否被正确发现和抓取。可能需要调整Prometheus的RBAC或网络策略，确保访问权限。"
keywords: "k8s集群中部署dcgm-exporter收集GPU指标"
categories: ['未分类']
tags: ['运维', '容器', 'Kubernetes', 'Gpu']
artid: "146159592"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146159592
    alt: "k8s集群中部署dcgm-exporter收集GPU指标"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146159592
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146159592
cover: https://bing.ee123.net/img/rand?artid=146159592
image: https://bing.ee123.net/img/rand?artid=146159592
img: https://bing.ee123.net/img/rand?artid=146159592
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     k8s集群中部署dcgm-exporter收集GPU指标
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="_0">
     </a>
     总体步骤：
    </h2>
    <ol>
     <li>
      <p>
       部署dcgm-exporter的DaemonSet和Service，确保Service有正确的标签和端口。
      </p>
     </li>
     <li>
      <p>
       创建ServiceMonitor，选择dcgm-exporter的Service，并指定端口。
      </p>
     </li>
     <li>
      <p>
       检查Prometheus的targets页面，确认dcgm-exporter是否被正确发现和抓取。
      </p>
     </li>
     <li>
      <p>
       可能需要调整Prometheus的RBAC或网络策略，确保访问权限。
      </p>
     </li>
    </ol>
    <h2>
     <a id="1dcgmexporter_9">
     </a>
     1，部署dcgm-exporter
    </h2>
    <p>
     创建dcgm-exporter.yaml文件，包含DaemonSet和Service：
    </p>
    <pre><code class="prism language-yaml"><span class="token comment"># dcgm-exporter.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DaemonSet
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> dcgm<span class="token punctuation">-</span>exporter
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> monitoring  <span class="token comment"># 假设与kube-prometheus同命名空间</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> dcgm<span class="token punctuation">-</span>exporter
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> dcgm<span class="token punctuation">-</span>exporter
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> dcgm<span class="token punctuation">-</span>exporter
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>
        <span class="token key atrule">nvidia.com/gpu.present</span><span class="token punctuation">:</span> <span class="token string">"true"</span>  <span class="token comment"># 仅在有GPU的节点运行</span>
      <span class="token key atrule">tolerations</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> nvidia.com/gpu
        <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists
        <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoSchedule
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> dcgm<span class="token punctuation">-</span>exporter
        <span class="token key atrule">image</span><span class="token punctuation">:</span> nvidia/dcgm<span class="token punctuation">-</span>exporter<span class="token punctuation">:</span>3.3.4<span class="token punctuation">-</span>3.6.12<span class="token punctuation">-</span>ubuntu22.04
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">9400</span>
        <span class="token key atrule">resources</span><span class="token punctuation">:</span>
          <span class="token key atrule">limits</span><span class="token punctuation">:</span>
            <span class="token key atrule">nvidia.com/gpu</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token comment"># 分配1个GPU</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> dcgm<span class="token punctuation">-</span>exporter
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> monitoring
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> dcgm<span class="token punctuation">-</span>exporter  <span class="token comment"># ServiceMonitor通过此标签选择</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> dcgm<span class="token punctuation">-</span>exporter
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> metrics
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9400</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">9400</span>
</code></pre>
    <p>
     应用配置：
    </p>
    <pre><code class="prism language-bash">kubectl apply <span class="token parameter variable">-f</span> dcgm-exporter.yaml
</code></pre>
    <h2>
     <a id="2_ServiceMonitor_64">
     </a>
     2. 创建ServiceMonitor资源
    </h2>
    <p>
     创建dcgm-service-monitor.yaml文件，定义如何抓取指标：
    </p>
    <pre><code class="prism language-yaml"><span class="token comment"># dcgm-service-monitor.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> monitoring.coreos.com/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceMonitor
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> dcgm<span class="token punctuation">-</span>exporter
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> monitoring  <span class="token comment"># 必须与Prometheus Operator监控的命名空间匹配</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">release</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>prometheus  <span class="token comment"># 根据实际kube-prometheus部署的标签调整</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">jobLabel</span><span class="token punctuation">:</span> dcgm<span class="token punctuation">-</span>exporter
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> metrics  <span class="token comment"># 对应Service的端口名称</span>
    <span class="token key atrule">interval</span><span class="token punctuation">:</span> 15s
    <span class="token key atrule">path</span><span class="token punctuation">:</span> /metrics  <span class="token comment"># 指标路径</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> dcgm<span class="token punctuation">-</span>exporter  <span class="token comment"># 匹配Service的标签</span>
  <span class="token key atrule">namespaceSelector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchNames</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> monitoring  <span class="token comment"># 指定Service所在的命名空间</span>
</code></pre>
    <p>
     应用配置：
    </p>
    <pre><code class="prism language-bash">kubectl apply <span class="token parameter variable">-f</span> dcgm-service-monitor.yaml
</code></pre>
    <h2>
     <a id="3_93">
     </a>
     3,验证配置
    </h2>
    <h4>
     <a id="Pod_94">
     </a>
     检查Pod状态
    </h4>
    <pre><code class="prism language-bash">kubectl get pods <span class="token parameter variable">-n</span> monitoring <span class="token parameter variable">-l</span> <span class="token assign-left variable">app</span><span class="token operator">=</span>dcgm-exporter
</code></pre>
    <h4>
     <a id="ServiceEndpoints_98">
     </a>
     查看Service和Endpoints：
    </h4>
    <pre><code class="prism language-bash">kubectl get svc,ep <span class="token parameter variable">-n</span> monitoring dcgm-exporter
</code></pre>
    <h4>
     <a id="Prometheus_UI_102">
     </a>
     访问Prometheus UI：
    </h4>
    <h6>
     <a id="1Prometheus_103">
     </a>
     1，端口转发Prometheus服务：
    </h6>
    <pre><code class="prism language-bash">kubectl <span class="token parameter variable">--namespace</span> monitoring port-forward svc/prometheus-operated <span class="token number">9090</span>
</code></pre>
    <h6>
     <a id="2_httplocalhost9090targetsdcgmexporterUP_107">
     </a>
     2，打开浏览器访问
     <code>
      http://localhost:9090/targets
     </code>
     ，确认dcgm-exporter目标状态为UP。
    </h6>
    <h4>
     <a id="GPU_109">
     </a>
     查询GPU指标：
    </h4>
    <p>
     在Prometheus中输入
     <code>
      DCGM_FI_DEV_GPU_UTIL
     </code>
     验证指标是否存在。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f6d305f36323436343836352f:61727469636c652f64657461696c732f313436313539353932" class_="artid" style="display:none">
 </p>
</div>


