---
layout: post
title: "聊一聊-Android-的消息机制"
date: 2025-03-09 09:56:22 +0800
description: "在 Android 平台上，主要用到两种通信机制，即 Binder 机制和消息机制，前者用于跨进程通信，后者用于进程内部通信。从技术实现上来说，消息机制还是比较简单的。从大的方面讲，不光是 Android 平台，各种平台的消息机制的原理基本上都是相近的，其中用到的主要概念大概有：1）消息发送者；2）消息队列；3）消息处理循环。示意图如下：图中表达的基本意思是，消息发送者通过某种方式，将消息发送到某个消息队列里，同时还有一个消息处理循环，不断从消息队列里摘取消息，并进一步解析处理。"
keywords: "聊一聊 Android 的消息机制"
categories: ['Message']
tags: ['车载系统', '系统开发', '智能手机', 'Framework', 'Android']
artid: "146127889"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146127889
    alt: "聊一聊-Android-的消息机制"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146127889
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146127889
cover: https://bing.ee123.net/img/rand?artid=146127889
image: https://bing.ee123.net/img/rand?artid=146127889
img: https://bing.ee123.net/img/rand?artid=146127889
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     聊一聊 Android 的消息机制
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h3>
     <a id="_Android__0">
     </a>
     聊一聊 Android 的消息机制
    </h3>
    <p>
     侯 亮
    </p>
    <h3>
     <a id="1__4">
     </a>
     1 概述
    </h3>
    <p>
     在 Android 平台上，主要用到两种通信机制，即 Binder 机制和消息机制，前者用于跨进程通信，后者用于进程内部通信。
    </p>
    <p>
     从技术实现上来说，消息机制还是比较简单的。从大的方面讲，不光是 Android 平台，各种平台的消息机制的原理基本上都是相近的，其中用到的主要概念大概有：
     <br/>
     1）消息发送者；
     <br/>
     2）消息队列；
     <br/>
     3）消息处理循环。
     <br/>
     示意图如下：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/71b77ec7bdaa4c6ea34bdc5ca4188ad7.png"/>
    </p>
    <p>
     图中表达的基本意思是，消息发送者通过某种方式，将消息发送到某个消息队列里，同时还有一个消息处理循环，不断从消息队列里摘取消息，并进一步解析处理。
    </p>
    <p>
     在 Android 平台上，把上图的右边部分包装成了一个 Looper 类，这个类的内部具有对应的消息队列（MessageQueue mQueue）和 loop 函数。
    </p>
    <p>
     但是 Looper 只是个简单的类而已，它虽然提供了循环处理方面的成员函数 loop ()，却不能自己凭空地运行起来，而只能寄身于某个真实的线程。而且，每个线程最多只能运作一个 Looper 对象，这一点应该很容易理解。
    </p>
    <p>
     Android 平台上另一个关键类是 Handler。当消息循环在其寄身的线程里正式运作后，外界就是通过 Handler 向消息循环发出事件的。我们再画一张示意图如下：
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/7c701770884d4cacafc76a019622b00b.png"/>
    </p>
    <p>
     当然，系统也允许多个 Handler 向同一个消息队列发送消息：
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/9862d7c6e56f4a1ba37d207c71a33500.png"/>
    </p>
    <p>
     整个消息机制的轮廓也就是这些啦，下面我们来详细阐述。
    </p>
    <h3>
     <a id="2__Looper__32">
     </a>
     2 先说一下 Looper 部分
    </h3>
    <p>
     Looper 类的定义截选如下：
     <br/>
     【frameworks/base/core/java/android/os/Looper.java】
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Looper</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String TAG <span class="token operator">=</span> <span class="token string">"Looper"</span><span class="token punctuation">;</span>

    <span class="token comment">// sThreadLocal.get() will return null unless you've called prepare().</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> ThreadLocal<span class="token operator">&lt;</span>Looper<span class="token operator">&gt;</span> sThreadLocal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token generic-function"><span class="token function">ThreadLocal</span><span class="token generic class-name"><span class="token operator">&lt;</span>Looper<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> Looper sMainLooper<span class="token punctuation">;</span>  <span class="token comment">// guarded by Looper.class</span>

    <span class="token keyword">final</span> MessageQueue mQueue<span class="token punctuation">;</span>
    <span class="token keyword">final</span> Thread mThread<span class="token punctuation">;</span>

    <span class="token keyword">private</span> Printer mLogging<span class="token punctuation">;</span>
    <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span>
    <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span>
</code></pre>
    <p>
     当一个线程运行到某处，准备运作一个 Looper 时，它必须先调用 Looper 类的静态函数 prepare ()，做一些准备工作。说穿了就是创建一个 Looper 对象，并把它设置进线程的本地存储区（TLS）里。然后线程才能继续调用 Looper 类的另一个静态函数 loop ()，从而建立起消息处理循环。示意图如下：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/4feca07146f24ed5922ac14fc1314b34.png"/>
    </p>
    <p>
     prepare () 函数的代码如下：
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">prepare</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">{<!-- --></span>
    <span class="token function">prepare</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">prepare</span><span class="token punctuation">(</span>boolean quitAllowed<span class="token punctuation">)</span> 
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sThreadLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token function">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Only one Looper may be created per thread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    sThreadLocal<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">Looper</span><span class="token punctuation">(</span>quitAllowed<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 创建Looper对象，并设置进TLS</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     可以看到，sThreadLocal.set () 一句所完成的工作，正是把新创建的 Looper 对象设置进线程本地存储区里。在 Looper.prepare () 之后，线程的主运作函数就可以调用 Looper.loop () 了。
    </p>
    <p>
     为了便于大家理解，我们多说两句关于 sThreadLocal 的细节，这会牵扯一点儿本地存储的技术。简单地说，每个线程对象内部会记录一张逻辑上的 key-value 表，当然，这张表在具体实现时不一定会被实现成 HashMap，以我们目前的代码来说，它被记录成一个数组，其中每两个数组项作为一个 key-value 单元。反正大家从逻辑上理解概念即可，不必拘泥于具体实现。很明显，一个线程内部是可以记录多个本地存储单元的，我们关心的 sThreadLocal 只是其中一个本地存储单元的 key 而已。
    </p>
    <p>
     当我们在不同 Thread 里调用 Looper.prepare () 时，其实是向 Thread 对应的那张表里添加一个 key-value 项，其中的 key 部分，指向的是同一个对象，即 Looper.sThreadLocal 静态对象，而 value 部分，则彼此不同，我们可以画出如下示意图：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/40811a144ad04f6ab4a82c26fc42321a.png"/>
    </p>
    <p>
     看到了吧，不同 Thread 会对应不同 Object [] 数组，该数组以每 2 个元素为一个 key-value 对。请注意不同 Thread 虽然使用同一个静态对象作为 key 值，最终却会对应不同的 Looper 对象，这一点系统是不会弄错的。
    </p>
    <p>
     为了由浅入深地阐述问题，我们暂时先不看 Looper.loop () 内部的代码，这个后文还会再讲。现在我们接着说说 Handler。
    </p>
    <h3>
     <a id="3__Handler__86">
     </a>
     3 接着说一下 Handler 部分
    </h3>
    <p>
     一般而言，运作 Looper 的线程会负责构造自己的 Handler 对象，当然，其他线程也可以针对某个 Looper 构造 Handler 对象。
    </p>
    <p>
     Handler 对象在构造时，不但会把 Looper 对象记录在它内部的 mLooper 成员变量中，还会把 Looper 对象的消息队列也一并记录，代码截选如下：
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">public</span> <span class="token function">Handler</span><span class="token punctuation">(</span>Callback callback<span class="token punctuation">,</span> boolean async<span class="token punctuation">)</span> 
<span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span>
    mLooper <span class="token operator">=</span> Looper<span class="token punctuation">.</span><span class="token function">myLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 记录下Looper对象</span>
    <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span>
    mQueue <span class="token operator">=</span> mLooper<span class="token punctuation">.</span>mQueue<span class="token punctuation">;</span>        <span class="token comment">// 也记录下Looper对象的消息队列</span>
    mCallback <span class="token operator">=</span> callback<span class="token punctuation">;</span>
    mAsynchronous <span class="token operator">=</span> async<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     我们也可以直接传入 Looper 对象，此时可以使用另一个构造函数：
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">public</span> <span class="token function">Handler</span><span class="token punctuation">(</span>Looper looper<span class="token punctuation">,</span> Callback callback<span class="token punctuation">,</span> boolean async<span class="token punctuation">)</span> 
<span class="token punctuation">{<!-- --></span>
    mLooper <span class="token operator">=</span> looper<span class="token punctuation">;</span>                <span class="token comment">// 记录下Looper对象</span>
    mQueue <span class="token operator">=</span> looper<span class="token punctuation">.</span>mQueue<span class="token punctuation">;</span>         <span class="token comment">// 也记录下Looper对象的消息队列</span>
    mCallback <span class="token operator">=</span> callback<span class="token punctuation">;</span>
    mAsynchronous <span class="token operator">=</span> async<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     以后，每当线程需要向消息队列发送消息时，只需调用 Handler 对象的 sendMessage () 等成员函数就可以了。
    </p>
    <p>
     简单说来，只要一个线程可以获取另一个目标线程的某个 Handler 对象，它就具有了向目标线程发送消息的能力。不过，也只是发送消息而已，消息的真正处理却是在目标线程的消息循环里完成的。
    </p>
    <p>
     前文已经说过，在 Looper 准备停当后，我们的线程会调用 Looper.loop ()，从而进入真正的循环机制。loop () 函数的代码流程非常简单，只不过是在一个 for 循环里不停从消息队列中摘取消息，而后调用 msg.target.dispatchMessage () 对消息进行派发处理而已。
    </p>
    <p>
     这么看来，msg.target 域就显得比较重要了，说穿了，这个域记录的其实就是当初向消息队列发送消息的那个 handler 啦。当我们调用 handler 的 send 函数时，最终基本上都会走到 sendMessageAtTime ()，其代码如下：
     <br/>
     【frameworks/base/core/java/android/os/Handler.java】
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">public</span> boolean <span class="token function">sendMessageAtTime</span><span class="token punctuation">(</span>Message msg<span class="token punctuation">,</span> <span class="token keyword">long</span> uptimeMillis<span class="token punctuation">)</span> 
<span class="token punctuation">{<!-- --></span>
    MessageQueue queue <span class="token operator">=</span> mQueue<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>queue <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        RuntimeException e <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">RuntimeException</span><span class="token punctuation">(</span>
                <span class="token keyword">this</span> <span class="token operator">+</span> <span class="token string">" sendMessageAtTime() called with no mQueue"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Log<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token string">"Looper"</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">enqueueMessage</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> uptimeMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

 

<span class="token keyword">private</span> boolean <span class="token function">enqueueMessage</span><span class="token punctuation">(</span>MessageQueue queue<span class="token punctuation">,</span> Message msg<span class="token punctuation">,</span> <span class="token keyword">long</span> uptimeMillis<span class="token punctuation">)</span> 
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 注意这一句，消息的target就是handler对象啦！日后msg.target.dispatchMessage()时会使用。</span>
    msg<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span> 

    <span class="token keyword">if</span> <span class="token punctuation">(</span>mAsynchronous<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        msg<span class="token punctuation">.</span><span class="token function">setAsynchronous</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> queue<span class="token punctuation">.</span><span class="token function">enqueueMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> uptimeMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     请大家注意 msg.target = this; 一句，记录的就是 handler 对象。
    </p>
    <p>
     当 Looper 的消息循环最终调用到 msg.target.dispatchMessage () 时，会间接调用到 handler 的 handleMessage () 函数，从而对消息进行实际处理。
    </p>
    <p>
     在实际运用 handler 时，大体有两种方式。一种方式是写一个继承于 Handler 的新类，并在新类里实现自己的 handleMessage () 成员函数；另一种方式是在创建匿名 Handler 对象时，直接修改 handleMessage () 成员函数。
    </p>
    <h3>
     <a id="4__MessageQueue_159">
     </a>
     4 消息队列 MessageQueue
    </h3>
    <p>
     在刚刚介绍 Handler 的 sendMessageAtTime () 时，我们已经看到最终会调用 queue.enqueueMessage () 来向消息队列打入消息。queue 对应的类是 MessageQueue，其定义截选如下：
     <br/>
     【frameworks/base/core/java/android/os/MessageQueue.java】
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">MessageQueue</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// True if the message queue can be quit.</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> boolean mQuitAllowed<span class="token punctuation">;</span>

    @<span class="token function">SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unused"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> mPtr<span class="token punctuation">;</span> <span class="token comment">// used by native code</span>

    Message mMessages<span class="token punctuation">;</span>  <span class="token comment">// 消息队列！</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> ArrayList<span class="token operator">&lt;</span>IdleHandler<span class="token operator">&gt;</span> mIdleHandlers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token generic-function"><span class="token function">ArrayList</span><span class="token generic class-name"><span class="token operator">&lt;</span>IdleHandler<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> IdleHandler<span class="token punctuation">[</span><span class="token punctuation">]</span> mPendingIdleHandlers<span class="token punctuation">;</span>
    <span class="token keyword">private</span> boolean mQuitting<span class="token punctuation">;</span>

    <span class="token comment">// Indicates whether next() is blocked waiting in pollOnce() with a non-zero timeout.</span>
    <span class="token keyword">private</span> boolean mBlocked<span class="token punctuation">;</span>

    <span class="token comment">// The next barrier token.</span>
    <span class="token comment">// Barriers are indicated by messages with a null target whose arg1 field carries the token.</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> mNextBarrierToken<span class="token punctuation">;</span>

    <span class="token keyword">private</span> native <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">nativeInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> native <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">nativeDestroy</span><span class="token punctuation">(</span><span class="token keyword">int</span> ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> native <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">nativePollOnce</span><span class="token punctuation">(</span><span class="token keyword">int</span> ptr<span class="token punctuation">,</span> <span class="token keyword">int</span> timeoutMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> native <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">nativeWake</span><span class="token punctuation">(</span><span class="token keyword">int</span> ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> native <span class="token keyword">static</span> boolean <span class="token function">nativeIsIdling</span><span class="token punctuation">(</span><span class="token keyword">int</span> ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span>
</code></pre>
    <p>
     其中 Message mMessages 记录的就是一条消息链表。另外还有几个 native 函数，这就说明 MessageQueue 会通过 JNI 技术调用到底层代码。mMessages 域记录着消息队列中所有 Java 层的实质消息。请大家注意，记录的只是 Java 层的消息，不包括 C++ 层的。MessageQueue 的示意图如下：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/3e138dffafe74fa9b29da589b5490de6.png"/>
    </p>
    <p>
     <strong>
      4.1 打入消息
     </strong>
     <br/>
     <strong>
      4.1.1enqueueMessage()
     </strong>
    </p>
    <p>
     很明显，enqueueMessage () 就是在向 MessageQueue 的消息链表里插入 Message。其代码截选如下：
     <br/>
     【frameworks/base/core/java/android/os/MessageQueue.java】
    </p>
    <pre><code class="prism language-cpp">boolean <span class="token function">enqueueMessage</span><span class="token punctuation">(</span>Message msg<span class="token punctuation">,</span> <span class="token keyword">long</span> when<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span>
        <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span>
        msg<span class="token punctuation">.</span>when <span class="token operator">=</span> when<span class="token punctuation">;</span>
        Message p <span class="token operator">=</span> mMessages<span class="token punctuation">;</span>
        boolean needWake<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> null <span class="token operator">||</span> when <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> when <span class="token operator">&lt;</span> p<span class="token punctuation">.</span>when<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 此时，新消息会插入到链表的表头，这意味着队列需要调整唤醒时间啦。</span>
             msg<span class="token punctuation">.</span>next <span class="token operator">=</span> p<span class="token punctuation">;</span>
            mMessages <span class="token operator">=</span> msg<span class="token punctuation">;</span>
            needWake <span class="token operator">=</span> mBlocked<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 此时，新消息会插入到链表的内部，一般情况下，这不需要调整唤醒时间。</span>
              <span class="token comment">// 但还必须考虑到当表头为“同步分割栏”的情况</span>
              needWake <span class="token operator">=</span> mBlocked <span class="token operator">&amp;&amp;</span> p<span class="token punctuation">.</span>target <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> msg<span class="token punctuation">.</span><span class="token function">isAsynchronous</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Message prev<span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                prev <span class="token operator">=</span> p<span class="token punctuation">;</span>
                p <span class="token operator">=</span> p<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> null <span class="token operator">||</span> when <span class="token operator">&lt;</span> p<span class="token punctuation">.</span>when<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>needWake <span class="token operator">&amp;&amp;</span> p<span class="token punctuation">.</span><span class="token function">isAsynchronous</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 说明即便msg是异步的，也不是链表中第一个异步消息，所以没必要唤醒了</span>
                    needWake <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            msg<span class="token punctuation">.</span>next <span class="token operator">=</span> p<span class="token punctuation">;</span>
            prev<span class="token punctuation">.</span>next <span class="token operator">=</span> msg<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>needWake<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">nativeWake</span><span class="token punctuation">(</span>mPtr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     打入消息的动作并不复杂，无非是在消息链表中找到合适的位置，插入 Message 节点而已。因为消息链表是按时间进行排序的，所以主要是在比对 Message 携带的 when 信息。消息链表的首个节点对应着最先将被处理的消息，如果 Message 被插到链表的头部了，就意味着队列的最近唤醒时间也应该被调整了，因此 needWake 会被设为 true，以便代码下方可以走进 nativeWake ()。
    </p>
    <p>
     <strong>
      4.1.2 说说 “同步分割栏”
     </strong>
    </p>
    <p>
     上面的代码中还有一个 “同步分割栏” 的概念需要提一下。所谓 “同步分割栏”，可以被理解为一个特殊 Message，它的 target 域为 null。它不能通过 sendMessageAtTime () 等函数打入到消息队列里，而只能通过调用 Looper 的 postSyncBarrier () 来打入。
    </p>
    <p>
     “同步分割栏” 是起什么作用的呢？它就像一个卡子，卡在消息链表中的某个位置，当消息循环不断从消息链表中摘取消息并进行处理时，一旦遇到这种 “同步分割栏”，那么即使在分割栏之后还有若干已经到时的普通 Message，也不会摘取这些消息了。请注意，此时只是不会摘取 “普通 Message” 了，如果队列中还设置有 “异步 Message”，那么还是会摘取已到时的 “异步 Message” 的。
    </p>
    <p>
     在 Android 的消息机制里，“普通 Message” 和 “异步 Message” 也就是这点儿区别啦，也就是说，如果消息列表中根本没有设置 “同步分割栏” 的话，那么 “普通 Message” 和 “异步 Message” 的处理就没什么大的不同了。
    </p>
    <p>
     打入 “同步分割栏” 的 postSyncBarrier () 函数的代码如下：
     <br/>
     【frameworks/base/core/java/android/os/Looper.java】
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">postSyncBarrier</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> mQueue<span class="token punctuation">.</span><span class="token function">enqueueSyncBarrier</span><span class="token punctuation">(</span>SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     【frameworks/base/core/java/android/os/MessageQueue.java】
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">enqueueSyncBarrier</span><span class="token punctuation">(</span><span class="token keyword">long</span> when<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> token <span class="token operator">=</span> mNextBarrierToken<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> Message msg <span class="token operator">=</span> Message<span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        msg<span class="token punctuation">.</span>when <span class="token operator">=</span> when<span class="token punctuation">;</span>
        msg<span class="token punctuation">.</span>arg1 <span class="token operator">=</span> token<span class="token punctuation">;</span>


        Message prev <span class="token operator">=</span> null<span class="token punctuation">;</span>
        Message p <span class="token operator">=</span> mMessages<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>when <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>p <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> p<span class="token punctuation">.</span>when <span class="token operator">&lt;=</span> when<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                prev <span class="token operator">=</span> p<span class="token punctuation">;</span>
                p <span class="token operator">=</span> p<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>prev <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> 
            msg<span class="token punctuation">.</span>next <span class="token operator">=</span> p<span class="token punctuation">;</span>
            prev<span class="token punctuation">.</span>next <span class="token operator">=</span> msg<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            msg<span class="token punctuation">.</span>next <span class="token operator">=</span> p<span class="token punctuation">;</span>
            mMessages <span class="token operator">=</span> msg<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> token<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     要得到 “异步 Message”，只需调用一下 Message 的 setAsynchronous () 即可：
     <br/>
     【frameworks/base/core/java/android/os/Message.java】
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAsynchronous</span><span class="token punctuation">(</span>boolean async<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>async<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        flags <span class="token operator">|=</span> FLAG_ASYNCHRONOUS<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        flags <span class="token operator">&amp;=</span> <span class="token operator">~</span>FLAG_ASYNCHRONOUS<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     一般，我们是通过 “异步 Handler” 向消息队列打入 “异步 Message” 的。异步 Handler 的 mAsynchronous 域为 true，因此它在调用 enqueueMessage () 时，可以走入：
    </p>
    <p>
     if (mAsynchronous) {
     <!-- -->
     <br/>
     msg.setAsynchronous(true);
     <br/>
     }
    </p>
    <p>
     现在我们画一张关于 “同步分割栏” 的示意图：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/37b2676ca09a4e128671f39c613f88eb.png"/>
    </p>
    <p>
     图中的消息队列中有一个 “同步分割栏”，因此它后面的 “2” 号 Message 即使到时了，也不会摘取下来。而 “3” 号 Message 因为是个异步 Message，所以当它到时后，是可以进行处理的。
    </p>
    <p>
     “同步分割栏” 这种卡子会一直卡在消息队列中，除非我们调用 removeSyncBarrier () 删除这个卡子。
     <br/>
     【frameworks/base/core/java/android/os/Looper.java】
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">removeSyncBarrier</span><span class="token punctuation">(</span><span class="token keyword">int</span> token<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    mQueue<span class="token punctuation">.</span><span class="token function">removeSyncBarrier</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     【frameworks/base/core/java/android/os/MessageQueue.java】
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token function">removeSyncBarrier</span><span class="token punctuation">(</span><span class="token keyword">int</span> token<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// Remove a sync barrier token from the queue.</span>
    <span class="token comment">// If the queue is no longer stalled by a barrier then wake it.</span>
    <span class="token function">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        Message prev <span class="token operator">=</span> null<span class="token punctuation">;</span>
        Message p <span class="token operator">=</span> mMessages<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>p <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>target <span class="token operator">!=</span> null <span class="token operator">||</span> p<span class="token punctuation">.</span>arg1 <span class="token operator">!=</span> token<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            prev <span class="token operator">=</span> p<span class="token punctuation">;</span>
            p <span class="token operator">=</span> p<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token function">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"The specified message queue synchronization "</span>
                    <span class="token operator">+</span> <span class="token string">" barrier token has not been posted or has already been removed."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">final</span> boolean needWake<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>prev <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            prev<span class="token punctuation">.</span>next <span class="token operator">=</span> p<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
            needWake <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            mMessages <span class="token operator">=</span> p<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
            needWake <span class="token operator">=</span> mMessages <span class="token operator">==</span> null <span class="token operator">||</span> mMessages<span class="token punctuation">.</span>target <span class="token operator">!=</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        p<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// If the loop is quitting then it is already awake.</span>
        <span class="token comment">// We can assume mPtr != 0 when mQuitting is false.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>needWake <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mQuitting<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">nativeWake</span><span class="token punctuation">(</span>mPtr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     和插入消息类似，如果删除动作改变了链表的头部，也意味着队列的最近唤醒时间应该被调整了，因此 needWake 会被设为 true，以便代码下方可以走进 nativeWake ()。
    </p>
    <p>
     <strong>
      4.1.3nativeWake()
     </strong>
    </p>
    <p>
     nativeWake () 对应的 C++ 层函数如下：
     <br/>
     【frameworks/base/core/jni/android_os_MessageQueue.cpp】
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">android_os_MessageQueue_nativeWake</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> jclass clazz<span class="token punctuation">,</span> jint ptr<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    NativeMessageQueue<span class="token operator">*</span> nativeMessageQueue <span class="token operator">=</span> <span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>NativeMessageQueue<span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> nativeMessageQueue<span class="token operator">-&gt;</span><span class="token function">wake</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">NativeMessageQueue</span><span class="token double-colon punctuation">::</span><span class="token function">wake</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    mLooper<span class="token operator">-&gt;</span><span class="token function">wake</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

【system<span class="token operator">/</span>core<span class="token operator">/</span>libutils<span class="token operator">/</span>Looper<span class="token punctuation">.</span>cpp】

<span class="token keyword">void</span> <span class="token class-name">Looper</span><span class="token double-colon punctuation">::</span><span class="token function">wake</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span>
    ssize_t nWrite<span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{<!-- --></span>
        nWrite <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>mWakeWritePipeFd<span class="token punctuation">,</span> <span class="token string">"W"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>nWrite <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> errno <span class="token operator">==</span> EINTR<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>nWrite <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">!=</span> EAGAIN<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">ALOGW</span><span class="token punctuation">(</span><span class="token string">"Could not write wake signal, errno=%d"</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     wake () 动作主要是向一个管道的 “写入端” 写入了 “W”。有关这个管道的细节，我们会在后文再细说，这里先放下。
    </p>
    <p>
     <strong>
      4.2 消息循环
     </strong>
    </p>
    <p>
     接下来我们来看看消息循环。我们从 Looper 的 Loop () 函数开始讲起。下面是 loop () 函数的简略代码，我们只保留了其中最关键的部分：
     <br/>
     【frameworks/base/core/java/android/os/Looper.java】
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">final</span> Looper me <span class="token operator">=</span> <span class="token function">myLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span>
    <span class="token keyword">final</span> MessageQueue queue <span class="token operator">=</span> me<span class="token punctuation">.</span>mQueue<span class="token punctuation">;</span>

    Binder<span class="token punctuation">.</span><span class="token function">clearCallingIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token keyword">long</span> ident <span class="token operator">=</span> Binder<span class="token punctuation">.</span><span class="token function">clearCallingIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        Message msg <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// might block</span>
        <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span>
        msg<span class="token punctuation">.</span>target<span class="token punctuation">.</span><span class="token function">dispatchMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 派发消息</span>
        <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> newIdent <span class="token operator">=</span> Binder<span class="token punctuation">.</span><span class="token function">clearCallingIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span>
        msg<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     无非是在一个 for 循环里不断摘取队列里的下一条消息，而后 dispatchMessage () 消息。呃，至少逻辑上就是这么简单，但如果我们希望再探索得更深一点的话，就得详细研究 MessageQueue 以及其 next () 函数了。
    </p>
    <p>
     对于 Looper 而言，它主要关心的是从消息队列里摘取消息，而后分派消息。然而对消息队列而言，在摘取消息时还要考虑更多技术细节。它关心的细节有：
     <br/>
     1）如果消息队列里目前没有合适的消息可以摘取，那么不能让它所属的线程 “傻转”，而应该使之阻塞；
     <br/>
     2）队列里的消息应该按其 “到时” 的顺序进行排列，最先到时的消息会放在队头，也就是 mMessages 域所指向的消息，其后的消息依次排开；
     <br/>
     3）阻塞的时间最好能精确一点儿，所以如果暂时没有合适的消息节点可摘时，要考虑链表首个消息节点将在什么时候到时，所以这个消息节点距离当前时刻的时间差，就是我们要阻塞的时长。
     <br/>
     4）有时候外界希望队列能在即将进入阻塞状态之前做一些动作，这些动作可以称为 idle 动作，我们需要兼顾处理这些 idle 动作。一个典型的例子是外界希望队列在进入阻塞之前做一次垃圾收集。
    </p>
    <p>
     以上所述的细节，基本上都体现在 MessageQueue 的 next () 函数里了，现在我们就来看这个函数的主要流程。
     <br/>
     4.2.1MessageQueue 的 next () 成员函数
    </p>
    <p>
     MessageQueue 的 next () 函数的代码截选如下：
    </p>
    <pre><code class="prism language-cpp">Message <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> pendingIdleHandlerCount <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// -1 only during first iteration</span>
    <span class="token keyword">int</span> nextPollTimeoutMillis <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span>
        <span class="token function">nativePollOnce</span><span class="token punctuation">(</span>mPtr<span class="token punctuation">,</span> nextPollTimeoutMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 阻塞于此</span>
        <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span>
            <span class="token comment">// 获取next消息，如能得到就返回之。</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> now <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Message prevMsg <span class="token operator">=</span> null<span class="token punctuation">;</span>
            Message msg <span class="token operator">=</span> mMessages<span class="token punctuation">;</span>  <span class="token comment">// 先尝试拿消息队列里当前第一个消息</span>
            
            <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> msg<span class="token punctuation">.</span>target <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 如果从队列里拿到的msg是个“同步分割栏”，那么就寻找其后第一个“异步消息”</span>
                <span class="token keyword">do</span> <span class="token punctuation">{<!-- --></span>
                    prevMsg <span class="token operator">=</span> msg<span class="token punctuation">;</span>
                    msg <span class="token operator">=</span> msg<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>msg <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>msg<span class="token punctuation">.</span><span class="token function">isAsynchronous</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            
            <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">&lt;</span> msg<span class="token punctuation">.</span>when<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// Next message is not ready.  Set a timeout to wake up when it is ready.</span>
                    nextPollTimeoutMillis <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>when <span class="token operator">-</span> now<span class="token punctuation">,</span> 
                                                                   Integer<span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// Got a message.</span>
                    mBlocked <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>prevMsg <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        prevMsg<span class="token punctuation">.</span>next <span class="token operator">=</span> msg<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                        mMessages <span class="token operator">=</span> msg<span class="token punctuation">.</span>next<span class="token punctuation">;</span>  <span class="token comment">// 重新设置一下消息队列的头部</span>
                    <span class="token punctuation">}</span>
                    msg<span class="token punctuation">.</span>next <span class="token operator">=</span> null<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> Log<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token string">"MessageQueue"</span><span class="token punctuation">,</span> <span class="token string">"Returning message: "</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    msg<span class="token punctuation">.</span><span class="token function">markInUse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> msg<span class="token punctuation">;</span>     <span class="token comment">// 返回得到的消息对象</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// No more messages.</span>
                nextPollTimeoutMillis <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// Process the quit message now that all pending messages have been handled.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mQuitting<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pendingIdleHandlerCount <span class="token operator">&lt;</span> <span class="token number">0</span>
                        <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>mMessages <span class="token operator">==</span> null <span class="token operator">||</span> now <span class="token operator">&lt;</span> mMessages<span class="token punctuation">.</span>when<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    pendingIdleHandlerCount <span class="token operator">=</span> mIdleHandlers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pendingIdleHandlerCount <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// No idle handlers to run.  Loop and wait some more.</span>
                mBlocked <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span>
        <span class="token comment">// 处理idle handlers部分</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> pendingIdleHandlerCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">final</span> IdleHandler idler <span class="token operator">=</span> mPendingIdleHandlers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            mPendingIdleHandlers<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> null<span class="token punctuation">;</span> <span class="token comment">// release the reference to the handler</span>

            boolean keep <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                keep <span class="token operator">=</span> idler<span class="token punctuation">.</span><span class="token function">queueIdle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>Throwable t<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                Log<span class="token punctuation">.</span><span class="token function">wtf</span><span class="token punctuation">(</span><span class="token string">"MessageQueue"</span><span class="token punctuation">,</span> <span class="token string">"IdleHandler threw exception"</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>keep<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    mIdleHandlers<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>idler<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        
        pendingIdleHandlerCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        nextPollTimeoutMillis <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     这个函数里的 for 循环并不是起循环摘取消息节点的作用，而是为了连贯 “当前时间点” 和 “处理下一条消息的时间点”。简单地说，当 “定时机制” 触发 “摘取一条消息” 的动作时，会判断事件队列的首条消息是否真的到时了，如果已经到时了，就直接返回这个 msg，而如果尚未到时，则会努力计算一个较精确的等待时间（nextPollTimeoutMillis），计算完后，那个 for 循环会掉过头再次调用到 nativePollOnce (mPtr, nextPollTimeoutMillis)，进入阻塞状态，从而等待合适的时长。
    </p>
    <p>
     上面代码中也处理了 “同步分割栏” 的情况。如果从队列里获取的消息是个 “同步分割栏” 的话，可千万不能把 “同步分割栏” 给返回了，此时会尝试找寻其后第一个 “异步消息”。
    </p>
    <p>
     next () 里另一个要说的是那些 Idle Handler，当消息队列中没有消息需要马上处理时，会判断用户是否设置了 Idle Handler，如果有的话，则会尝试处理 mIdleHandlers 中所记录的所有 Idle Handler，此时会逐个调用这些 Idle Handler 的 queueIdle () 成员函数。我们举一个例子，在 ActivityThread 中，在某种情况下会在消息队列中设置 GcIdler，进行垃圾收集，其定义如下：
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">GcIdler</span> implements MessageQueue<span class="token punctuation">.</span>IdleHandler <span class="token punctuation">{<!-- --></span>
    @Override
    <span class="token keyword">public</span> <span class="token keyword">final</span> boolean <span class="token function">queueIdle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">doGcIfNeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     一旦队列里设置了这个 Idle Handler，那么当队列中没有马上需处理的消息时，就会进行垃圾收集。
    </p>
    <p>
     4.2.1.1nativePollOnce()
    </p>
    <p>
     前文我们已经说过，next () 中调用的 nativePollOnce () 起到了阻塞作用，保证消息循环不会在无消息处理时一直在那里 “傻转”。那么，nativePollOnce () 函数究竟是如何实现阻塞功能的呢？我们来探索一下。首先，MessageQueue 类里声明的几个 native 函数，对应的 JNI 实现位于 android_os_MessageQueue.cpp 文件中：
     <br/>
     【frameworks/base/core/jni/android_os_MessageQueue.cpp】
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">static</span> JNINativeMethod gMessageQueueMethods<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/* name, signature, funcPtr */</span>
    <span class="token punctuation">{<!-- --></span> <span class="token string">"nativeInit"</span><span class="token punctuation">,</span> <span class="token string">"()I"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>android_os_MessageQueue_nativeInit <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span> <span class="token string">"nativeDestroy"</span><span class="token punctuation">,</span> <span class="token string">"(I)V"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>android_os_MessageQueue_nativeDestroy <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span> <span class="token string">"nativePollOnce"</span><span class="token punctuation">,</span> <span class="token string">"(II)V"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>android_os_MessageQueue_nativePollOnce <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span> <span class="token string">"nativeWake"</span><span class="token punctuation">,</span> <span class="token string">"(I)V"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>android_os_MessageQueue_nativeWake <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span> <span class="token string">"nativeIsIdling"</span><span class="token punctuation">,</span> <span class="token string">"(I)Z"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>android_os_MessageQueue_nativeIsIdling <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     而且在 MessageQueue 构造之时，就会调用 nativeInit () 函数。
    </p>
    <p>
     目前我们只关心 nativePollOnce 对应的 android_os_MessageQueue_nativePollOnce ()。其代码如下：
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">android_os_MessageQueue_nativePollOnce</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> jclass clazz<span class="token punctuation">,</span>
                                                             jint ptr<span class="token punctuation">,</span> jint timeoutMillis<span class="token punctuation">)</span> 
<span class="token punctuation">{<!-- --></span>
    NativeMessageQueue<span class="token operator">*</span> nativeMessageQueue <span class="token operator">=</span> <span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>NativeMessageQueue<span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    nativeMessageQueue<span class="token operator">-&gt;</span><span class="token function">pollOnce</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> timeoutMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     看到了吧，ptr 参数会被强制转换成 NativeMessageQueue*。
    </p>
    <p>
     NativeMessageQueue 的 pollOnce () 如下：
     <br/>
     【frameworks/base/core/jni/android_os_MessageQueue.cpp】
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token class-name">NativeMessageQueue</span><span class="token double-colon punctuation">::</span><span class="token function">pollOnce</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> <span class="token keyword">int</span> timeoutMillis<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    mInCallback <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    mLooper<span class="token operator">-&gt;</span><span class="token function">pollOnce</span><span class="token punctuation">(</span>timeoutMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 用到C++层的Looper对象</span>
    mInCallback <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mExceptionObj<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        env<span class="token operator">-&gt;</span><span class="token function">Throw</span><span class="token punctuation">(</span>mExceptionObj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token operator">-&gt;</span><span class="token function">DeleteLocalRef</span><span class="token punctuation">(</span>mExceptionObj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mExceptionObj <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     这里会用到 C++ 层的 Looper 类，它和 Java 层的 Looper 类可是不一样的哩。C++ 层的 Looper 类的定义截选如下：
     <br/>
     【system/core/include/utils/Looper.h】
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">class</span> <span class="token class-name">Looper</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">ALooper</span><span class="token punctuation">,</span> <span class="token keyword">public</span> <span class="token class-name">RefBase</span></span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">protected</span><span class="token operator">:</span>
    <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">Looper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">Looper</span><span class="token punctuation">(</span><span class="token keyword">bool</span> allowNonCallbacks<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> <span class="token function">getAllowNonCallbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token function">pollOnce</span><span class="token punctuation">(</span><span class="token keyword">int</span> timeoutMillis<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">*</span> outFd<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">*</span> outEvents<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">*</span> outData<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span>
    <span class="token keyword">int</span> <span class="token function">pollAll</span><span class="token punctuation">(</span><span class="token keyword">int</span> timeoutMillis<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">*</span> outFd<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">*</span> outEvents<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">*</span> outData<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span>
    <span class="token keyword">void</span> <span class="token function">wake</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> <span class="token function">addFd</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> ident<span class="token punctuation">,</span> <span class="token keyword">int</span> events<span class="token punctuation">,</span> ALooper_callbackFunc callback<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token function">addFd</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> ident<span class="token punctuation">,</span> <span class="token keyword">int</span> events<span class="token punctuation">,</span> <span class="token keyword">const</span> sp<span class="token operator">&lt;</span>LooperCallback<span class="token operator">&gt;</span><span class="token operator">&amp;</span> callback<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token function">removeFd</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token keyword">const</span> sp<span class="token operator">&lt;</span>MessageHandler<span class="token operator">&gt;</span><span class="token operator">&amp;</span> handler<span class="token punctuation">,</span> <span class="token keyword">const</span> Message<span class="token operator">&amp;</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">sendMessageDelayed</span><span class="token punctuation">(</span>nsecs_t uptimeDelay<span class="token punctuation">,</span> <span class="token keyword">const</span> sp<span class="token operator">&lt;</span>MessageHandler<span class="token operator">&gt;</span><span class="token operator">&amp;</span> handler<span class="token punctuation">,</span>
            <span class="token keyword">const</span> Message<span class="token operator">&amp;</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">sendMessageAtTime</span><span class="token punctuation">(</span>nsecs_t uptime<span class="token punctuation">,</span> <span class="token keyword">const</span> sp<span class="token operator">&lt;</span>MessageHandler<span class="token operator">&gt;</span><span class="token operator">&amp;</span> handler<span class="token punctuation">,</span>
            <span class="token keyword">const</span> Message<span class="token operator">&amp;</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">removeMessages</span><span class="token punctuation">(</span><span class="token keyword">const</span> sp<span class="token operator">&lt;</span>MessageHandler<span class="token operator">&gt;</span><span class="token operator">&amp;</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">removeMessages</span><span class="token punctuation">(</span><span class="token keyword">const</span> sp<span class="token operator">&lt;</span>MessageHandler<span class="token operator">&gt;</span><span class="token operator">&amp;</span> handler<span class="token punctuation">,</span> <span class="token keyword">int</span> what<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">bool</span> <span class="token function">isIdling</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> sp<span class="token operator">&lt;</span>Looper<span class="token operator">&gt;</span> <span class="token function">prepare</span><span class="token punctuation">(</span><span class="token keyword">int</span> opts<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setForThread</span><span class="token punctuation">(</span><span class="token keyword">const</span> sp<span class="token operator">&lt;</span>Looper<span class="token operator">&gt;</span><span class="token operator">&amp;</span> looper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> sp<span class="token operator">&lt;</span>Looper<span class="token operator">&gt;</span> <span class="token function">getForThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span>
    <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     我们把 C++ 层的 NativeMessageQueue 和 Looper 融入前文的示意图，可以得到一张新的示意图，如下所示：
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/dddc13178b7e4425a088d89524789efb.png"/>
    </p>
    <p>
     C++ 层的 Looper 的构造函数如下：
    </p>
    <pre><code class="prism language-cpp"><span class="token class-name">Looper</span><span class="token double-colon punctuation">::</span><span class="token function">Looper</span><span class="token punctuation">(</span><span class="token keyword">bool</span> allowNonCallbacks<span class="token punctuation">)</span> <span class="token operator">:</span>
        <span class="token function">mAllowNonCallbacks</span><span class="token punctuation">(</span>allowNonCallbacks<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mSendingMessage</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">mResponseIndex</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mNextMessageUptime</span><span class="token punctuation">(</span>LLONG_MAX<span class="token punctuation">)</span> 
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> wakeFds<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token function">pipe</span><span class="token punctuation">(</span>wakeFds<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 创建一个管道</span>
    <span class="token function">LOG_ALWAYS_FATAL_IF</span><span class="token punctuation">(</span>result <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"Could not create wake pipe.  errno=%d"</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>

    mWakeReadPipeFd <span class="token operator">=</span> wakeFds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">// 管道的“读取端”</span>
    mWakeWritePipeFd <span class="token operator">=</span> wakeFds<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>   <span class="token comment">// 管道的“写入端”</span>

    result <span class="token operator">=</span> <span class="token function">fcntl</span><span class="token punctuation">(</span>mWakeReadPipeFd<span class="token punctuation">,</span> F_SETFL<span class="token punctuation">,</span> O_NONBLOCK<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOG_ALWAYS_FATAL_IF</span><span class="token punctuation">(</span>result <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">,</span> 
                       <span class="token string">"Could not make wake read pipe non-blocking.  errno=%d"</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>

    result <span class="token operator">=</span> <span class="token function">fcntl</span><span class="token punctuation">(</span>mWakeWritePipeFd<span class="token punctuation">,</span> F_SETFL<span class="token punctuation">,</span> O_NONBLOCK<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOG_ALWAYS_FATAL_IF</span><span class="token punctuation">(</span>result <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">,</span> 
                       <span class="token string">"Could not make wake write pipe non-blocking.  errno=%d"</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mIdling <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token comment">// 创建一个epoll</span>
    mEpollFd <span class="token operator">=</span> <span class="token function">epoll_create</span><span class="token punctuation">(</span>EPOLL_SIZE_HINT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOG_ALWAYS_FATAL_IF</span><span class="token punctuation">(</span>mEpollFd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"Could not create epoll instance.  errno=%d"</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> eventItem<span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span> eventItem<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>epoll_event<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    eventItem<span class="token punctuation">.</span>events <span class="token operator">=</span> EPOLLIN<span class="token punctuation">;</span>
    eventItem<span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd <span class="token operator">=</span> mWakeReadPipeFd<span class="token punctuation">;</span>   
    <span class="token comment">// 监听管道的read端</span>
    result <span class="token operator">=</span> <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>mEpollFd<span class="token punctuation">,</span> EPOLL_CTL_ADD<span class="token punctuation">,</span> mWakeReadPipeFd<span class="token punctuation">,</span> <span class="token operator">&amp;</span> eventItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOG_ALWAYS_FATAL_IF</span><span class="token punctuation">(</span>result <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">,</span> 
                     <span class="token string">"Could not add wake read pipe to epoll instance.  errno=%d"</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     可以看到在构造 Looper 对象时，其内部除了创建了一个管道以外，还创建了一个 epoll 来监听管道的 “读取端”。也就是说，是利用 epoll 机制来完成阻塞动作的。每当我们向消息队列发送事件时，最终会间接向管道的 “写入端” 写入数据，这个前文已有叙述，于是 epoll 通过管道的 “读取端” 立即就感知到了风吹草动，epoll_wait () 在等到事件后，随即进行相应的事件处理。这就是消息循环阻塞并处理的大体流程。当然，因为向管道写数据只是为了通知风吹草动，所以写入的数据是非常简单的 “W” 字符串。现在大家不妨再看看前文阐述 “nativeWake ()” 的小节，应该能明白了吧。
    </p>
    <p>
     我们还是继续说消息循环。Looper 的 pollOnce () 函数如下：
     <br/>
     【system/core/libutils/Looper.cpp】
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token class-name">Looper</span><span class="token double-colon punctuation">::</span><span class="token function">pollOnce</span><span class="token punctuation">(</span><span class="token keyword">int</span> timeoutMillis<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">*</span> outFd<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">*</span> outEvents<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">*</span> outData<span class="token punctuation">)</span> 
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>outFd <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">*</span>outFd <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>outEvents <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">*</span>outEvents <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>outData <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">*</span>outData <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        result <span class="token operator">=</span> <span class="token function">pollInner</span><span class="token punctuation">(</span>timeoutMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token keyword">int</span> <span class="token class-name">Looper</span><span class="token double-colon punctuation">::</span><span class="token function">pollInner</span><span class="token punctuation">(</span><span class="token keyword">int</span> timeoutMillis<span class="token punctuation">)</span> 
<span class="token punctuation">{<!-- --></span>
<span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span>
    <span class="token comment">// 阻塞、等待</span>
<span class="token keyword">int</span> eventCount <span class="token operator">=</span> <span class="token function">epoll_wait</span><span class="token punctuation">(</span> mEpollFd<span class="token punctuation">,</span> eventItems<span class="token punctuation">,</span> 
                                   EPOLL_MAX_EVENTS<span class="token punctuation">,</span> timeoutMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span>
    <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span>
    <span class="token comment">// 处理所有epoll事件</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> eventCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> 
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> fd <span class="token operator">=</span> eventItems<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd<span class="token punctuation">;</span>
        <span class="token keyword">uint32_t</span> epollEvents <span class="token operator">=</span> eventItems<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">==</span> mWakeReadPipeFd<span class="token punctuation">)</span> 
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>epollEvents <span class="token operator">&amp;</span> EPOLLIN<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">awoken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 从管道中感知到EPOLLIN，于是调用awoken()</span>
            <span class="token punctuation">}</span> 
            <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span>
        <span class="token punctuation">}</span> 
        <span class="token keyword">else</span> 
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 如果是除管道以外的其他fd发生了变动，那么根据其对应的request，</span>
            <span class="token comment">// 将response先记录进mResponses</span>
            ssize_t requestIndex <span class="token operator">=</span> mRequests<span class="token punctuation">.</span><span class="token function">indexOfKey</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>requestIndex <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">int</span> events <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>epollEvents <span class="token operator">&amp;</span> EPOLLIN <span class="token punctuation">)</span> events <span class="token operator">|=</span> ALOOPER_EVENT_INPUT<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>epollEvents <span class="token operator">&amp;</span> EPOLLOUT<span class="token punctuation">)</span> events <span class="token operator">|=</span> ALOOPER_EVENT_OUTPUT<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>epollEvents <span class="token operator">&amp;</span> EPOLLERR<span class="token punctuation">)</span> events <span class="token operator">|=</span> ALOOPER_EVENT_ERROR<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>epollEvents <span class="token operator">&amp;</span> EPOLLHUP<span class="token punctuation">)</span> events <span class="token operator">|=</span> ALOOPER_EVENT_HANGUP<span class="token punctuation">;</span>
                <span class="token comment">// 内部会调用 mResponses.push(response);</span>
                <span class="token function">pushResponse</span><span class="token punctuation">(</span>events<span class="token punctuation">,</span> mRequests<span class="token punctuation">.</span><span class="token function">valueAt</span><span class="token punctuation">(</span>requestIndex<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> 
            <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
Done<span class="token operator">:</span> <span class="token punctuation">;</span>
    <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span>
    <span class="token comment">// 调用尚未处理的事件的回调</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>mMessageEnvelopes<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> 
    <span class="token punctuation">{<!-- --></span>
        nsecs_t now <span class="token operator">=</span> <span class="token function">systemTime</span><span class="token punctuation">(</span>SYSTEM_TIME_MONOTONIC<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> MessageEnvelope<span class="token operator">&amp;</span> messageEnvelope <span class="token operator">=</span> mMessageEnvelopes<span class="token punctuation">.</span><span class="token function">itemAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>messageEnvelope<span class="token punctuation">.</span>uptime <span class="token operator">&lt;=</span> now<span class="token punctuation">)</span> 
        <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">{<!-- --></span> 
                sp<span class="token operator">&lt;</span>MessageHandler<span class="token operator">&gt;</span> handler <span class="token operator">=</span> messageEnvelope<span class="token punctuation">.</span>handler<span class="token punctuation">;</span>
                Message message <span class="token operator">=</span> messageEnvelope<span class="token punctuation">.</span>message<span class="token punctuation">;</span>
                mMessageEnvelopes<span class="token punctuation">.</span><span class="token function">removeAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span>
                handler<span class="token operator">-&gt;</span><span class="token function">handleMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span>
        <span class="token punctuation">}</span> 
        <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            mNextMessageUptime <span class="token operator">=</span> messageEnvelope<span class="token punctuation">.</span>uptime<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span>
    <span class="token comment">// 调用所有response记录的回调</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> mResponses<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        Response<span class="token operator">&amp;</span> response <span class="token operator">=</span> mResponses<span class="token punctuation">.</span><span class="token function">editItemAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>request<span class="token punctuation">.</span>ident <span class="token operator">==</span> ALOOPER_POLL_CALLBACK<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span>
            <span class="token keyword">int</span> callbackResult <span class="token operator">=</span> response<span class="token punctuation">.</span>request<span class="token punctuation">.</span>callback<span class="token operator">-&gt;</span><span class="token function">handleEvent</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> events<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>callbackResult <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">removeFd</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     现在我们可以画一张调用示意图，理一下 loop () 函数的调用关系，如下：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/7512a73156634ba2bf1f3baac97733d1.png"/>
    </p>
    <p>
     pollInner () 调用 epoll_wait () 时传入的 timeoutMillis 参数，其实来自于前文所说的 MessageQueue 的 next () 函数里的 nextPollTimeoutMillis，next () 函数里在以下 3 种情况下，会给 nextPollTimeoutMillis 赋不同的值：
     <br/>
     1）如果消息队列中的下一条消息还要等一段时间才到时的话，那么 nextPollTimeoutMillis 赋值为 Math.min (msg.when - now, Integer.MAX_VALUE)，即时间差；
     <br/>
     2）如果消息队列已经是空队列了，那么 nextPollTimeoutMillis 赋值为 - 1；
     <br/>
     3）不管前两种情况下是否已给 nextPollTimeoutMillis 赋过值了，只要队列中有 Idle Handler 需要处理，那么在处理完所有 Idle Handler 之后，会强制将 nextPollTimeoutMillis 赋值为 0。这主要是考虑到在处理 Idle Handler 时，不知道会耗时多少，而在此期间消息队列的 “到时情况” 有可能已发生改变。
    </p>
    <p>
     不管 epoll_wait () 的超时阀值被设置成什么，只要程序从 epoll_wait () 中返回，就会尝试处理等到的 epoll 事件。目前我们的主要关心点是事件机制，所以主要讨论当 fd 等于 mWakeReadPipeFd 时的情况，此时会调用一下 awoken () 函数。该函数很简单，只是在读取 mWakeReadPipeFd 而已：
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token class-name">Looper</span><span class="token double-colon punctuation">::</span><span class="token function">awoken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">DEBUG_POLL_AND_WAKE</span></span>
    <span class="token function">ALOGD</span><span class="token punctuation">(</span><span class="token string">"%p ~ awoken"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

    <span class="token keyword">char</span> buffer<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    ssize_t nRead<span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{<!-- --></span>
        nRead <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>mWakeReadPipeFd<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>nRead <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> errno <span class="token operator">==</span> EINTR<span class="token punctuation">)</span> <span class="token operator">||</span> nRead <span class="token operator">==</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     为什么要起个名字叫 awoken () 呢？这是因为当初发送事件时，最终是调用一个 wake () 函数来通知消息队列的，现在 epoll_wait () 既然已经感应到了，自然相当于 “被唤醒”（awoken）了。
    </p>
    <p>
     除了感知 mWakeReadPipeFd 管道的情况以外，epoll 还会感知其他一些 fd 对应的事件。在 Looper 中有一个 mRequests 键值向量表（KeyedVector&lt;int, Request&gt; mRequests），其键值就是感兴趣的 fd。如果收到的 epoll 事件所携带的 fd 可以在这张表里查到，那么就将该 fd 对应的 Request 整理进 Response 对象，并将该 Response 对象记入 mResponses 表。在 pollInner () 的最后，会用一个 for 循环遍历 mResponses 表，分析每个 Response 表项对应的 Request 是不是需要 callback，如果需要的话，执行对应的回调函数：
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">int</span> callbackResult <span class="token operator">=</span> response<span class="token punctuation">.</span>request<span class="token punctuation">.</span>callback<span class="token operator">-&gt;</span><span class="token function">handleEvent</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> events<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>callbackResult <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">removeFd</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     可以看到，handleEvent () 的返回值将决定那个 Request 表项是否继续保留在 mRequests 表中，如果返回值为 0，说明不必保留了，所以删除之。删除时会同时从 epoll 中注销这个 Request 对应的 fd，表示不再对这个 fd 感兴趣了。
    </p>
    <p>
     pollInner () 内部还会集中处理所记录的所有 C++ 层的 Message。在一个 while 循环中，不断摘取 mMessageEnvelopes 向量表的第 0 个 MessageEnvelope，如果消息已经到时，则回调 handleMessage ()。
    </p>
    <pre><code class="prism language-cpp">sp<span class="token operator">&lt;</span>MessageHandler<span class="token operator">&gt;</span> handler <span class="token operator">=</span> messageEnvelope<span class="token punctuation">.</span>handler<span class="token punctuation">;</span>
Message message <span class="token operator">=</span> messageEnvelope<span class="token punctuation">.</span>message<span class="token punctuation">;</span>
mMessageEnvelopes<span class="token punctuation">.</span><span class="token function">removeAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span>

handler<span class="token operator">-&gt;</span><span class="token function">handleMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     而如果消息未到时，说明 while 循环可以 break 了。
    </p>
    <p>
     C++ 层的 Looper 及这个层次的消息链表，再加上对应其他 fd 的 Request 和 Response，可以形成下面这张示意图：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/c51059add7d147a5b5c73525a84da5ef.png"/>
    </p>
    <p>
     从我们的分析中可以知道，在 Android 中，不光是 Java 层可以发送 Message，C++ 层也可以发送，当然，不同层次的 Message 是放在不同层次的消息链中的。在 Java 层，每次尝试从队列中获取一个 Message，而后 dispatch 它。而 C++ 层的消息则尽量在一次 pollOnce 中集中处理完毕，这是它们的一点不同。
    </p>
    <h3>
     <a id="5__846">
     </a>
     5 尾声
    </h3>
    <p>
     关于 Android 的消息机制，我们就先说这么多。总体上的而言还是比较简单的，无非是通过 Handler 向 Looper 的消息队列中插入 Message，而后再由 Looper 在消息循环里具体处理。因为消息队列本身不具有链表一变动就能马上感知的功能，所以它需要借助管道和 epoll 机制来监听变动。当外界向消息队列中打入新消息后，就向管道的 “写入端” 写入简单数据，于是 epoll 可以立即感知到管道的变动，从何激发从消息队列中摘取消息的动作。这就是 Android 消息机制的大体情况。
    </p>
    <p>
     文章来源：https://my.oschina.net/youranhongcha/blog/492591
    </p>
    <p>
     更多framework实战开发干货，请关注下面“千里马学框架”
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
  <div class="blog-extension-box" id="blogExtensionBox" style="width:400px;margin:auto;margin-top:12px">
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f67:2e6373646e2e6e65742f6c6561726e6672616d65776f726b2f:61727469636c652f64657461696c732f313436313237383839" class_="artid" style="display:none">
 </p>
</div>


