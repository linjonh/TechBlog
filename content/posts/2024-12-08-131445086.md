---
layout: post
title: "Go语言单元测试"
date: 2024-12-08 17:15:00 +0800
description: "Go语言单元测试_go 单元测试"
keywords: "go 单元测试"
categories: ['Golang']
tags: ['Golang']
artid: "131445086"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=131445086
    alt: "Go语言单元测试"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=131445086
featuredImagePreview: https://bing.ee123.net/img/rand?artid=131445086
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Go语言单元测试
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-github-gist" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h3>
     <a id="1Go_0">
     </a>
     1、Go语言单元测试
    </h3>
    <p>
     Go语言中的测试依赖 go test 命令，go test 命令是一个按照一定约定和组织的测试代码的驱动程序。在包目录
    </p>
    <p>
     内，所有以
     <code>
      _test.go
     </code>
     为后缀名的源代码文件都是 go test 测试的一部分，不会被 go build 编译到最终的可执行
    </p>
    <p>
     文件中。
    </p>
    <p>
     在
     <code>
      *_test.go
     </code>
     文件中有三种类型的函数，
     <code>
      单元测试函数
     </code>
     、
     <code>
      基准测试函数
     </code>
     和
     <code>
      示例函数
     </code>
     ：
    </p>
    <table>
     <thead>
      <tr>
       <th>
        类型
       </th>
       <th>
        格式
       </th>
       <th>
        作用
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        单元测试函数
       </td>
       <td>
        前缀为Test
       </td>
       <td>
        测试程序的逻辑是否正确
       </td>
      </tr>
      <tr>
       <td>
        基准测试函数
       </td>
       <td>
        前缀为Benchmark
       </td>
       <td>
        测试程序的性能
       </td>
      </tr>
      <tr>
       <td>
        示例函数
       </td>
       <td>
        前缀为Example
       </td>
       <td>
        为程序提供示例
       </td>
      </tr>
     </tbody>
    </table>
    <p>
     go test命令会遍历所有的
     <code>
      *_test.go
     </code>
     文件中符合上述命名规则的函数，然后生成一个临时的main包用于调用相
    </p>
    <p>
     应的测试函数，然后构建并运行、报告测试结果，最后清理测试中生成的临时文件。
    </p>
    <p>
     可以使用
     <code>
      go help testfunc
     </code>
     命令查看函数的写法。
    </p>
    <pre><code class="prism language-shell">$ go <span class="token builtin class-name">help</span> testfunc
The <span class="token string">'go test'</span> <span class="token builtin class-name">command</span> expects to <span class="token function">find</span> test, benchmark, and example functions
<span class="token keyword">in</span> the <span class="token string">"*_test.go"</span> files corresponding to the package under test.

A <span class="token builtin class-name">test</span> <span class="token keyword">function</span> is one named TestXxx <span class="token punctuation">(</span>where Xxx does not start with a
lower <span class="token keyword">case</span> letter<span class="token punctuation">)</span> and should have the signature,

        func TestXxx<span class="token punctuation">(</span>t *testing.T<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">..</span>. <span class="token punctuation">}</span>

A benchmark <span class="token keyword">function</span> is one named BenchmarkXxx and should have the signature,

        func BenchmarkXxx<span class="token punctuation">(</span>b *testing.B<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">..</span>. <span class="token punctuation">}</span>

A fuzz <span class="token builtin class-name">test</span> is one named FuzzXxx and should have the signature,

        func FuzzXxx<span class="token punctuation">(</span>f *testing.F<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">..</span>. <span class="token punctuation">}</span>

An example <span class="token keyword">function</span> is similar to a <span class="token builtin class-name">test</span> <span class="token keyword">function</span> but, instead of using
*testing.T to report success or failure, prints output to os.Stdout.
If the last comment <span class="token keyword">in</span> the <span class="token keyword">function</span> starts with <span class="token string">"Output:"</span> <span class="token keyword">then</span> the output
is compared exactly against the comment <span class="token punctuation">(</span>see examples below<span class="token punctuation">)</span>. If the last
comment begins with <span class="token string">"Unordered output:"</span> <span class="token keyword">then</span> the output is compared to the
comment, however the order of the lines is ignored. An example with no such
comment is compiled but not executed. An example with no text after
<span class="token string">"Output:"</span> is compiled, executed, and expected to produce no output.

Godoc displays the body of ExampleXxx to demonstrate the use
of the function, constant, or variable Xxx. An example of a method M with
receiver <span class="token builtin class-name">type</span> T or *T is named ExampleT_M. There may be multiple examples
<span class="token keyword">for</span> a given function, constant, or variable, distinguished by a trailing _xxx,
where xxx is a suffix not beginning with an upper <span class="token keyword">case</span> letter.

Here is an example of an example:

        func <span class="token function-name function">ExamplePrintln</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                Println<span class="token punctuation">(</span><span class="token string">"The output of<span class="token entity" title="\n">\n</span>this example."</span><span class="token punctuation">)</span>
                // Output: The output of
                // this example.
        <span class="token punctuation">}</span>

Here is another example where the ordering of the output is ignored:

        func <span class="token function-name function">ExamplePerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">for</span> _, value :<span class="token operator">=</span> range Perm<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        fmt.Println<span class="token punctuation">(</span>value<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>

                // Unordered output: <span class="token number">4</span>
                // <span class="token number">2</span>
                // <span class="token number">1</span>
                // <span class="token number">3</span>
                // <span class="token number">0</span>
        <span class="token punctuation">}</span>

The entire <span class="token builtin class-name">test</span> <span class="token function">file</span> is presented as the example when it contains a single
example function, at least one other function, type, variable, or constant
declaration, and no tests, benchmarks, or fuzz tests.

See the documentation of the testing package <span class="token keyword">for</span> <span class="token function">more</span> information.
</code></pre>
    <p>
     通过
     <code>
      go help test
     </code>
     可以看到go test的使用说明。
    </p>
    <pre><code class="prism language-shell">$ go <span class="token builtin class-name">help</span> <span class="token builtin class-name">test</span>
usage: go <span class="token builtin class-name">test</span> <span class="token punctuation">[</span>build/test flags<span class="token punctuation">]</span> <span class="token punctuation">[</span>packages<span class="token punctuation">]</span> <span class="token punctuation">[</span>build/test flags <span class="token operator">&amp;</span> <span class="token builtin class-name">test</span> binary flags<span class="token punctuation">]</span>

<span class="token string">'Go test'</span> automates testing the packages named by the <span class="token function">import</span> paths.
It prints a summary of the <span class="token builtin class-name">test</span> results <span class="token keyword">in</span> the format:

        ok   archive/tar   <span class="token number">0</span>.011s
        FAIL archive/zip   <span class="token number">0</span>.022s
        ok   compress/gzip <span class="token number">0</span>.033s
        <span class="token punctuation">..</span>.
In addition to the build flags, the flags handled by <span class="token string">'go test'</span> itself are:

        -args
            Pass the remainder of the <span class="token builtin class-name">command</span> line <span class="token punctuation">(</span>everything after -args<span class="token punctuation">)</span>
            to the <span class="token builtin class-name">test</span> binary, uninterpreted and unchanged.
            Because this flag consumes the remainder of the <span class="token builtin class-name">command</span> line,
            the package list <span class="token punctuation">(</span>if present<span class="token punctuation">)</span> must appear before this flag.

        -c
            Compile the <span class="token builtin class-name">test</span> binary to pkg.test but <span class="token keyword">do</span> not run it
            <span class="token punctuation">(</span>where pkg is the last element of the package<span class="token string">'s import path).
            The file name can be changed with the -o flag.

        -exec xprog
            Run the test binary using xprog. The behavior is the same as
            in '</span>go run<span class="token string">'. See '</span>go <span class="token builtin class-name">help</span> run<span class="token string">' for details.

        -i
            Install packages that are dependencies of the test.
            Do not run the test.
            The -i flag is deprecated. Compiled packages are cached automatically.

        -json
            Convert test output to JSON suitable for automated processing.
            See '</span>go doc test2json' <span class="token keyword">for</span> the encoding details.

        -o <span class="token function">file</span>
            Compile the <span class="token builtin class-name">test</span> binary to the named file.
            The <span class="token builtin class-name">test</span> still runs <span class="token punctuation">(</span>unless -c or -i is specified<span class="token punctuation">)</span>.
</code></pre>
    <p>
     格式形如：
     <code>
      go test [build/test flags] [packages] [build/test flags &amp; test binary flags]
     </code>
    </p>
    <p>
     参数解读：
    </p>
    <ul>
     <li>
      <p>
       <code>
        -c
       </code>
       ：生成用于运行测试的可执行文件，但不执行它。这个可执行文件会被命名为 pkg.test，其中的 pkg 即
      </p>
      <p>
       为被测试代码包的导入路径的最后一个元素的名称。
      </p>
     </li>
     <li>
      <p>
       <code>
        -i
       </code>
       ：安装/重新安装运行测试所需的依赖包，但不编译和运行测试代码。
      </p>
     </li>
     <li>
      <p>
       <code>
        -o
       </code>
       ：指定用于运行测试的可执行文件的名称，追加该标记不会影响测试代码的运行，除非同时追加了标记
      </p>
      <p>
       -c 或 -i。
      </p>
     </li>
    </ul>
    <p>
     上述这几个标记可以搭配使用，搭配使用的目的可以是让 go test 命令既安装依赖包又编译测试代码，但不运行
    </p>
    <p>
     测试。也就是说，让命令程序跑一遍运行测试之前的所有流程。这可以测试一下测试过程。注意，在加入 -c 标记
    </p>
    <p>
     后，命令程序会把用于运行测试的可执行文件存放到当前目录下。
    </p>
    <p>
     关于
     <code>
      build/test flags
     </code>
     ，调用
     <code>
      go help build
     </code>
     ，这些是编译运行过程中需要使用到的参数，一般设置为空。
    </p>
    <p>
     关于
     <code>
      packages
     </code>
     ，调用
     <code>
      go help packages
     </code>
     ，这些是关于包的管理，一般设置为空。
    </p>
    <p>
     关于
     <code>
      test binary flags
     </code>
     ，调用
     <code>
      go help testflag
     </code>
     ，这些是 go test 过程中经常使用到的参数：
    </p>
    <ul>
     <li>
      <p>
       <code>
        -test.v
       </code>
       ：是否输出全部的单元测试用例(不管成功或者失败)，默认没有加上，所以只输出失败的单元测试用
      </p>
      <p>
       例。
      </p>
     </li>
     <li>
      <p>
       <code>
        -test.run pattern
       </code>
       ：只跑哪些单元测试用例。
      </p>
     </li>
     <li>
      <p>
       <code>
        -test.bench patten
       </code>
       ：只跑那些性能测试用例。
      </p>
     </li>
     <li>
      <p>
       <code>
        -test.benchmem
       </code>
       ：是否在性能测试的时候输出内存情况。
      </p>
     </li>
     <li>
      <p>
       <code>
        -test.benchtime t
       </code>
       ：性能测试运行的时间，默认是1s。
      </p>
     </li>
     <li>
      <p>
       <code>
        -test.cpuprofile cpu.out
       </code>
       ：是否输出cpu性能分析文件。
      </p>
     </li>
     <li>
      <p>
       <code>
        -test.memprofile mem.out
       </code>
       ：是否输出内存性能分析文件。
      </p>
     </li>
     <li>
      <p>
       <code>
        -test.blockprofile block.out
       </code>
       ：是否输出内部goroutine阻塞的性能分析文件。
      </p>
     </li>
     <li>
      <p>
       <code>
        -test.memprofilerate n
       </code>
       ：内存性能分析的时候有一个分配了多少的时候才打点记录的问题。这个参数就
      </p>
      <p>
       是设置打点的内存分配间隔，也就是profile中一个sample代表的内存大小。默认是设置为512 * 1024的。如
      </p>
      <p>
       果你将它设置为1，则每分配一个内存块就会在profile中有个打点，那么生成的profile的sample就会非常多。
      </p>
      <p>
       如果你设置为0，那就是不做打点了。你可以通过设置memprofilerate=1和GOGC=off来关闭内存回收，并且
      </p>
      <p>
       对每个内存块的分配进行观察。
      </p>
     </li>
     <li>
      <p>
       <code>
        -test.blockprofilerate n
       </code>
       ：基本同上，控制的是goroutine阻塞时候打点的纳秒数。默认不设置就相当
      </p>
      <p>
       于
       <code>
        -test.blockprofilerate=1
       </code>
       ，每一纳秒都打点记录一下。
      </p>
     </li>
     <li>
      <p>
       <code>
        -test.parallel n
       </code>
       ：性能测试的程序并行cpu数，默认等于GOMAXPROCS。
      </p>
     </li>
     <li>
      <p>
       <code>
        -test.timeout t
       </code>
       ：如果测试用例运行时间超过t，则抛出panic。
      </p>
     </li>
     <li>
      <p>
       <code>
        -test.cpu 1,2,4
       </code>
       ：go test -cpu=1,2,4 将会执行 3 次，其中 GOMAXPROCS 值分别为 1，2，和 4。
      </p>
     </li>
     <li>
      <p>
       <code>
        -test.short
       </code>
       ：将那些运行时间较长的测试用例运行时间缩短。
      </p>
     </li>
     <li>
      <p>
       <code>
        -test.outputdir
       </code>
       ：输出目录。
      </p>
     </li>
     <li>
      <p>
       <code>
        -test.coverprofil
       </code>
       ：测试覆盖率参数，指定输出文件。
      </p>
     </li>
    </ul>
    <p>
     所有的 test 参数：
    </p>
    <pre><code class="prism language-shell">  -test.bench regexp
        run only benchmarks matching regexp
  -test.benchmem
        print memory allocations <span class="token keyword">for</span> benchmarks
  -test.benchtime d
        run each benchmark <span class="token keyword">for</span> duration d <span class="token punctuation">(</span>default 1s<span class="token punctuation">)</span>
  -test.blockprofile <span class="token function">file</span>
        <span class="token function">write</span> a goroutine blocking profile to <span class="token function">file</span>
  -test.blockprofilerate rate
        <span class="token builtin class-name">set</span> blocking profile rate <span class="token punctuation">(</span>see runtime.SetBlockProfileRate<span class="token punctuation">)</span> <span class="token punctuation">(</span>default <span class="token number">1</span><span class="token punctuation">)</span>
  -test.count n
        run tests and benchmarks n <span class="token builtin class-name">times</span> <span class="token punctuation">(</span>default <span class="token number">1</span><span class="token punctuation">)</span>
  -test.coverprofile <span class="token function">file</span>
        <span class="token function">write</span> a coverage profile to <span class="token function">file</span>
  -test.cpu list
        comma-separated list of cpu counts to run each <span class="token builtin class-name">test</span> with
  -test.cpuprofile <span class="token function">file</span>
        <span class="token function">write</span> a cpu profile to <span class="token function">file</span>
  -test.failfast
        <span class="token keyword">do</span> not start new tests after the first <span class="token builtin class-name">test</span> failure
  -test.fuzz regexp
        run the fuzz <span class="token builtin class-name">test</span> matching regexp
  -test.fuzzcachedir string
        directory where interesting fuzzing inputs are stored <span class="token punctuation">(</span>for use only by cmd/go<span class="token punctuation">)</span>
  -test.fuzzminimizetime value
        <span class="token function">time</span> to spend minimizing a value after finding a failing input <span class="token punctuation">(</span>default 1m0s<span class="token punctuation">)</span>
  -test.fuzztime value
        <span class="token function">time</span> to spend fuzzing<span class="token punctuation">;</span> default is to run indefinitely
  -test.fuzzworker
        coordinate with the parent process to fuzz random values <span class="token punctuation">(</span>for use only by cmd/go<span class="token punctuation">)</span>
  -test.list regexp
        list tests, examples, and benchmarks matching regexp <span class="token keyword">then</span> <span class="token builtin class-name">exit</span>
  -test.memprofile <span class="token function">file</span>
        <span class="token function">write</span> an allocation profile to <span class="token function">file</span>
  -test.memprofilerate rate
        <span class="token builtin class-name">set</span> memory allocation profiling rate <span class="token punctuation">(</span>see runtime.MemProfileRate<span class="token punctuation">)</span>
  -test.mutexprofile string
        <span class="token function">write</span> a mutex contention profile to the named <span class="token function">file</span> after execution
  -test.mutexprofilefraction int
        <span class="token keyword">if</span> <span class="token operator">&gt;=</span> <span class="token number">0</span>, calls runtime.SetMutexProfileFraction<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>default <span class="token number">1</span><span class="token punctuation">)</span>
  -test.outputdir <span class="token function">dir</span>
        <span class="token function">write</span> profiles to <span class="token function">dir</span>
  -test.paniconexit0
        panic on call to os.Exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
  -test.parallel n
        run at <span class="token function">most</span> n tests <span class="token keyword">in</span> parallel <span class="token punctuation">(</span>default <span class="token number">20</span><span class="token punctuation">)</span>
  -test.run regexp
        run only tests and examples matching regexp
  -test.short
        run smaller <span class="token builtin class-name">test</span> suite to save <span class="token function">time</span>
  -test.shuffle string
        randomize the execution order of tests and benchmarks <span class="token punctuation">(</span>default <span class="token string">"off"</span><span class="token punctuation">)</span>
  -test.testlogfile <span class="token function">file</span>
        <span class="token function">write</span> <span class="token builtin class-name">test</span> action log to <span class="token function">file</span> <span class="token punctuation">(</span>for use only by cmd/go<span class="token punctuation">)</span>
  -test.timeout d
        panic <span class="token builtin class-name">test</span> binary after duration d <span class="token punctuation">(</span>default <span class="token number">0</span>, <span class="token function">timeout</span> disabled<span class="token punctuation">)</span>
  -test.trace <span class="token function">file</span>
        <span class="token function">write</span> an execution trace to <span class="token function">file</span>
  -test.v
        verbose: print additional output
</code></pre>
    <pre><code class="prism language-shell"><span class="token comment"># 带参数的例子</span>
<span class="token comment"># 其它的参数视情况决定是否添加</span>
$ go <span class="token builtin class-name">test</span> -v -parallel <span class="token number">2</span>
</code></pre>
    <h4>
     <a id="11_Go_test__269">
     </a>
     1.1 Go test 注意事项
    </h4>
    <p>
     GO 语言里面的单元测试，是使用标准库
     <code>
      testing
     </code>
     。
    </p>
    <p>
     注意事项如下：
    </p>
    <ul>
     <li>
      用来测试的代码必须以
      <code>
       _test.go
      </code>
      结尾。
     </li>
     <li>
      单元测试的函数名必须以
      <code>
       Test开头
      </code>
      ，并且只有一个参数，类型是
      <code>
       *testing.T
      </code>
      。
     </li>
     <li>
      单元测试函数名
      <code>
       Test
      </code>
      后必须紧跟着大写，比如：
      <code>
       TestAdd
      </code>
      。
     </li>
     <li>
      基准测试或压力测试必须以
      <code>
       Benchmark
      </code>
      开头，并且只有参数
      <code>
       *testing.B
      </code>
      。
     </li>
    </ul>
    <p>
     例如：
    </p>
    <pre><code class="prism language-go"><span class="token comment">// Tests</span>
<span class="token keyword">func</span> <span class="token function">TestXxx</span><span class="token punctuation">(</span><span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span>
</code></pre>
    <pre><code class="prism language-go"><span class="token keyword">package</span> go_test

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"testing"</span>
	<span class="token string">"math"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">TestAbs</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	got <span class="token operator">:=</span> math<span class="token punctuation">.</span><span class="token function">Abs</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> got <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">{<!-- --></span>
		t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"Abs(-1) = %f; want 1"</span><span class="token punctuation">,</span> got<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <pre><code class="prism language-shell">$ go <span class="token builtin class-name">test</span> -v 001_test.go
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestAbs
--- PASS: TestAbs <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
PASS
ok      command-line-arguments  <span class="token number">0</span>.258s
</code></pre>
    <pre><code class="prism language-go"><span class="token comment">// Benchmarks</span>
<span class="token keyword">func</span> <span class="token function">BenchmarkXxx</span><span class="token punctuation">(</span><span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span>
</code></pre>
    <pre><code class="prism language-go"><span class="token keyword">package</span> go_test

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"math/rand"</span>
	<span class="token string">"testing"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">BenchmarkRandInt</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{<!-- --></span>
		rand<span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <pre><code class="prism language-shell">$ go <span class="token builtin class-name">test</span> -bench BenchmarkRandInt -cpu<span class="token operator">=</span><span class="token number">1</span> -count<span class="token operator">=</span><span class="token number">5</span> 002_test.go
goos: windows
goarch: amd64
cpu: 12th Gen Intel<span class="token punctuation">(</span>R<span class="token punctuation">)</span> Core<span class="token punctuation">(</span>TM<span class="token punctuation">)</span> i7-12700
BenchmarkRandInt        <span class="token number">100000000</span>               <span class="token number">11.43</span> ns/op
BenchmarkRandInt        <span class="token number">100000000</span>               <span class="token number">11.50</span> ns/op
BenchmarkRandInt        <span class="token number">100000000</span>               <span class="token number">11.50</span> ns/op
BenchmarkRandInt        <span class="token number">100000000</span>               <span class="token number">11.46</span> ns/op
BenchmarkRandInt        <span class="token number">100000000</span>               <span class="token number">11.49</span> ns/op
PASS
ok      command-line-arguments  <span class="token number">6</span>.038s
</code></pre>
    <p>
     基准函数必须运行目标代码 b.N 次，在基准测试执行期间，b.N 被调整，直到基准测试函数持续足够长的时间以
    </p>
    <p>
     可靠地定时。
    </p>
    <p>
     如果基准测试在运行前需要一些昂贵的设置，则可以重置计时器：
     <code>
      b.ResetTimer()
     </code>
     。
    </p>
    <h4>
     <a id="12_Go_test_351">
     </a>
     1.2 Go test命令介绍
    </h4>
    <ul>
     <li>
      <code>
       go test packageName
      </code>
      ：执行这个包下面的所有测试用例。
     </li>
     <li>
      <code>
       go test .
      </code>
      ：执行当前目录下的所有测试用例。
     </li>
     <li>
      <code>
       go test 测试源文件
      </code>
      ：执行这个测试源文件里的所有测试用例。
     </li>
     <li>
      <code>
       go test -run 选项
      </code>
      ：执行指定的测试用例。
     </li>
     <li>
      <code>
       go test -bench .
      </code>
      ：执行当前路径下的所有压力测试。
     </li>
     <li>
      <code>
       go test -bench BenchmarkAdd
      </code>
      ：对BenchmarkAdd这个函数执行压力测试。
     </li>
    </ul>
    <h4>
     <a id="13__360">
     </a>
     1.3 利用单元测试来测试斐波那契数列的递归和非递归版本
    </h4>
    <p>
     斐波那契数列的计算：
    </p>
    <pre><code class="prism language-go"><span class="token keyword">package</span> fb

<span class="token comment">// 斐波那契数列的递归版本</span>
<span class="token comment">// 斐波那契数列:后一个数等于前面两个数的和</span>
<span class="token keyword">func</span> <span class="token function">FbRecursion</span><span class="token punctuation">(</span>num <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> num <span class="token operator">&lt;=</span> <span class="token number">2</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token number">1</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token function">FbRecursion</span><span class="token punctuation">(</span>num<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">FbRecursion</span><span class="token punctuation">(</span>num<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 斐波那契数列的非递归版本</span>
<span class="token comment">// 斐波那契数列:后一个数等于前面两个数的和</span>
<span class="token keyword">func</span> <span class="token function">FbNoRecursion</span><span class="token punctuation">(</span>num <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{<!-- --></span>
	l <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> num<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> num<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> i <span class="token operator">&lt;=</span> <span class="token number">2</span> <span class="token punctuation">{<!-- --></span>
			l<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
			l<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> l<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> l<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> l<span class="token punctuation">[</span>num<span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre>
    <pre><code class="prism language-go"><span class="token keyword">package</span> go_test

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"proj/fb"</span>
	<span class="token string">"testing"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> FbTestCase <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	num    <span class="token builtin">int</span>
	expect <span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> fbTestCases <span class="token operator">=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>FbTestCase<span class="token punctuation">{<!-- --></span>
	<span class="token string">"1"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>num<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> expect<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token string">"2"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>num<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> expect<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token string">"3"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>num<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> expect<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token string">"4"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>num<span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span> expect<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token string">"5"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>num<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span> expect<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token string">"9"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>num<span class="token punctuation">:</span> <span class="token number">9</span><span class="token punctuation">,</span> expect<span class="token punctuation">:</span> <span class="token number">34</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">// 基准测试</span>
<span class="token comment">// 递归测试</span>
<span class="token keyword">func</span> <span class="token function">TestFbRecursion</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">for</span> name<span class="token punctuation">,</span> tc <span class="token operator">:=</span> <span class="token keyword">range</span> fbTestCases <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 使用t.Run执行子测试</span>
		t<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>tt <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			output <span class="token operator">:=</span> fb<span class="token punctuation">.</span><span class="token function">FbRecursion</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>num<span class="token punctuation">)</span>
			<span class="token keyword">if</span> output <span class="token operator">!=</span> tc<span class="token punctuation">.</span>expect <span class="token punctuation">{<!-- --></span>
				tt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"expect: %d, but output: %d"</span><span class="token punctuation">,</span> tc<span class="token punctuation">.</span>expect<span class="token punctuation">,</span> output<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 非递归测试</span>
<span class="token keyword">func</span> <span class="token function">TestFbNoRecursion</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">for</span> name<span class="token punctuation">,</span> tc <span class="token operator">:=</span> <span class="token keyword">range</span> fbTestCases <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 使用t.Run执行子测试</span>
		t<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>tt <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			output <span class="token operator">:=</span> fb<span class="token punctuation">.</span><span class="token function">FbNoRecursion</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>num<span class="token punctuation">)</span>
			<span class="token keyword">if</span> output <span class="token operator">!=</span> tc<span class="token punctuation">.</span>expect <span class="token punctuation">{<!-- --></span>
				tt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"expect: %d, but output: %d"</span><span class="token punctuation">,</span> tc<span class="token punctuation">.</span>expect<span class="token punctuation">,</span> output<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     使用如下命令进行测试，测试结果：
    </p>
    <pre><code class="prism language-shell">$ go <span class="token builtin class-name">test</span> -run .*Fb.* -v
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestFbRecursion
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestFbRecursion/9
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestFbRecursion/1
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestFbRecursion/2
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestFbRecursion/3
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestFbRecursion/4
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestFbRecursion/5
--- PASS: TestFbRecursion <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
    --- PASS: TestFbRecursion/9 <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
    --- PASS: TestFbRecursion/1 <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
    --- PASS: TestFbRecursion/2 <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
    --- PASS: TestFbRecursion/3 <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
    --- PASS: TestFbRecursion/4 <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
    --- PASS: TestFbRecursion/5 <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestFbNoRecursion
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestFbNoRecursion/2
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestFbNoRecursion/3
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestFbNoRecursion/4
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestFbNoRecursion/5
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestFbNoRecursion/9
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestFbNoRecursion/1
--- PASS: TestFbNoRecursion <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
    --- PASS: TestFbNoRecursion/2 <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
    --- PASS: TestFbNoRecursion/3 <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
    --- PASS: TestFbNoRecursion/4 <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
    --- PASS: TestFbNoRecursion/5 <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
    --- PASS: TestFbNoRecursion/9 <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
    --- PASS: TestFbNoRecursion/1 <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
PASS
ok      proj    <span class="token number">0</span>.256s
</code></pre>
    <p>
     生成测试的二进制文件：
    </p>
    <pre><code class="prism language-shell">$ go <span class="token builtin class-name">test</span> -v -run<span class="token operator">=</span><span class="token string">"TestFbRecursion"</span> -c
<span class="token comment"># 会生成proj.test.exe文件</span>
</code></pre>
    <h4>
     <a id="14__484">
     </a>
     1.4 测试支持的函数
    </h4>
    <p>
     使用
     <code>
      go doc testing.T
     </code>
     查询文档：
    </p>
    <pre><code class="prism language-shell">$ go doc testing.T
package testing // <span class="token function">import</span> <span class="token string">"testing"</span>

<span class="token builtin class-name">type</span> T struct <span class="token punctuation">{<!-- --></span>
        // Has unexported fields.
<span class="token punctuation">}</span>
    T is a <span class="token builtin class-name">type</span> passed to Test functions to manage <span class="token builtin class-name">test</span> state and support
    formatted <span class="token builtin class-name">test</span> logs.

    A <span class="token builtin class-name">test</span> ends when its Test <span class="token keyword">function</span> returns or calls any of the methods
    FailNow, Fatal, Fatalf, SkipNow, Skip, or Skipf. Those methods, as well as
    the Parallel method, must be called only from the goroutine running the Test
    function.

    The other reporting methods, such as the variations of Log and Error, may be
    called simultaneously from multiple goroutines.

func <span class="token punctuation">(</span>c *T<span class="token punctuation">)</span> Cleanup<span class="token punctuation">(</span>f func<span class="token punctuation">(</span><span class="token punctuation">))</span>
func <span class="token punctuation">(</span>t *T<span class="token punctuation">)</span> Deadline<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>deadline time.Time, ok bool<span class="token punctuation">)</span>
func <span class="token punctuation">(</span>c *T<span class="token punctuation">)</span> Error<span class="token punctuation">(</span>args <span class="token punctuation">..</span>.any<span class="token punctuation">)</span>
func <span class="token punctuation">(</span>c *T<span class="token punctuation">)</span> Errorf<span class="token punctuation">(</span>format string, args <span class="token punctuation">..</span>.any<span class="token punctuation">)</span>
func <span class="token punctuation">(</span>c *T<span class="token punctuation">)</span> Fail<span class="token punctuation">(</span><span class="token punctuation">)</span>
func <span class="token punctuation">(</span>c *T<span class="token punctuation">)</span> FailNow<span class="token punctuation">(</span><span class="token punctuation">)</span>
func <span class="token punctuation">(</span>c *T<span class="token punctuation">)</span> Failed<span class="token punctuation">(</span><span class="token punctuation">)</span> bool
func <span class="token punctuation">(</span>c *T<span class="token punctuation">)</span> Fatal<span class="token punctuation">(</span>args <span class="token punctuation">..</span>.any<span class="token punctuation">)</span>
func <span class="token punctuation">(</span>c *T<span class="token punctuation">)</span> Fatalf<span class="token punctuation">(</span>format string, args <span class="token punctuation">..</span>.any<span class="token punctuation">)</span>
func <span class="token punctuation">(</span>c *T<span class="token punctuation">)</span> Helper<span class="token punctuation">(</span><span class="token punctuation">)</span>
func <span class="token punctuation">(</span>c *T<span class="token punctuation">)</span> Log<span class="token punctuation">(</span>args <span class="token punctuation">..</span>.any<span class="token punctuation">)</span>
func <span class="token punctuation">(</span>c *T<span class="token punctuation">)</span> Logf<span class="token punctuation">(</span>format string, args <span class="token punctuation">..</span>.any<span class="token punctuation">)</span>
func <span class="token punctuation">(</span>c *T<span class="token punctuation">)</span> Name<span class="token punctuation">(</span><span class="token punctuation">)</span> string
func <span class="token punctuation">(</span>t *T<span class="token punctuation">)</span> Parallel<span class="token punctuation">(</span><span class="token punctuation">)</span>
func <span class="token punctuation">(</span>t *T<span class="token punctuation">)</span> Run<span class="token punctuation">(</span>name string, f func<span class="token punctuation">(</span>t *T<span class="token punctuation">))</span> bool
func <span class="token punctuation">(</span>t *T<span class="token punctuation">)</span> Setenv<span class="token punctuation">(</span>key, value string<span class="token punctuation">)</span>
func <span class="token punctuation">(</span>c *T<span class="token punctuation">)</span> Skip<span class="token punctuation">(</span>args <span class="token punctuation">..</span>.any<span class="token punctuation">)</span>
func <span class="token punctuation">(</span>c *T<span class="token punctuation">)</span> SkipNow<span class="token punctuation">(</span><span class="token punctuation">)</span>
func <span class="token punctuation">(</span>c *T<span class="token punctuation">)</span> Skipf<span class="token punctuation">(</span>format string, args <span class="token punctuation">..</span>.any<span class="token punctuation">)</span>
func <span class="token punctuation">(</span>c *T<span class="token punctuation">)</span> Skipped<span class="token punctuation">(</span><span class="token punctuation">)</span> bool
func <span class="token punctuation">(</span>c *T<span class="token punctuation">)</span> TempDir<span class="token punctuation">(</span><span class="token punctuation">)</span> string
</code></pre>
    <p>
     <code>
      go doc testing testing.T.Cleanup
     </code>
     查询Cleanup的方法描述：
    </p>
    <pre><code class="prism language-shell">$ go doc testing testing.T.Cleanup
doc: too many periods <span class="token keyword">in</span> symbol specification
Usage of <span class="token punctuation">[</span>go<span class="token punctuation">]</span> doc:
        go doc
        go doc <span class="token operator">&lt;</span>pkg<span class="token operator">&gt;</span>
        go doc <span class="token operator">&lt;</span>sym<span class="token operator">&gt;</span><span class="token punctuation">[</span>.<span class="token operator">&lt;</span>methodOrField<span class="token operator">&gt;</span><span class="token punctuation">]</span>
        go doc <span class="token punctuation">[</span><span class="token operator">&lt;</span>pkg<span class="token operator">&gt;</span>.<span class="token punctuation">]</span><span class="token operator">&lt;</span>sym<span class="token operator">&gt;</span><span class="token punctuation">[</span>.<span class="token operator">&lt;</span>methodOrField<span class="token operator">&gt;</span><span class="token punctuation">]</span>
        go doc <span class="token punctuation">[</span><span class="token operator">&lt;</span>pkg<span class="token operator">&gt;</span>.<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token operator">&lt;</span>sym<span class="token operator">&gt;</span>.<span class="token punctuation">]</span><span class="token operator">&lt;</span>methodOrField<span class="token operator">&gt;</span>
        go doc <span class="token operator">&lt;</span>pkg<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>sym<span class="token operator">&gt;</span><span class="token punctuation">[</span>.<span class="token operator">&lt;</span>methodOrField<span class="token operator">&gt;</span><span class="token punctuation">]</span>
For <span class="token function">more</span> information run
        go <span class="token builtin class-name">help</span> doc

Flags:
  -all
        show all documentation <span class="token keyword">for</span> package
  -c    symbol matching honors <span class="token keyword">case</span> <span class="token punctuation">(</span>paths not affected<span class="token punctuation">)</span>
  -cmd
        show symbols with package docs even <span class="token keyword">if</span> package is a <span class="token builtin class-name">command</span>
  -short
        one-line representation <span class="token keyword">for</span> each symbol
  -src
        show <span class="token builtin class-name">source</span> code <span class="token keyword">for</span> symbol
  -u    show unexported symbols as well as exported
<span class="token builtin class-name">exit</span> status <span class="token number">2</span>
</code></pre>
    <h4>
     <a id="15__558">
     </a>
     1.5 跳过某些测试用例
    </h4>
    <p>
     通过调用
     <code>
      *T
     </code>
     或
     <code>
      *B
     </code>
     的 Skip 方法，可以在运行时跳过测试或基准测试：
    </p>
    <pre><code class="prism language-go"><span class="token keyword">package</span> go_test

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"math"</span>
	<span class="token string">"testing"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">TestTimeConsuming</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> testing<span class="token punctuation">.</span><span class="token function">Short</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		t<span class="token punctuation">.</span><span class="token function">Skip</span><span class="token punctuation">(</span><span class="token string">"skipping test in short mode."</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
		got <span class="token operator">:=</span> math<span class="token punctuation">.</span><span class="token function">Abs</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> got <span class="token operator">!=</span> <span class="token number">10</span> <span class="token punctuation">{<!-- --></span>
			t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"Abs(-1) = %f; want 10"</span><span class="token punctuation">,</span> got<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     当执行
     <code>
      go test -short
     </code>
     时就不会执行上面的 TestTimeConsuming 测试用例。
    </p>
    <pre><code class="prism language-shell">$ go <span class="token builtin class-name">test</span> 004_test.go -v -short
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestTimeConsuming
    004_test.go:10: skipping <span class="token builtin class-name">test</span> <span class="token keyword">in</span> short mode.
--- SKIP: TestTimeConsuming <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
PASS
ok      command-line-arguments  <span class="token number">0</span>.264s
</code></pre>
    <pre><code class="prism language-shell">$ go <span class="token builtin class-name">test</span> 004_test.go -v
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestTimeConsuming
--- PASS: TestTimeConsuming <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
PASS
ok      command-line-arguments  <span class="token number">0</span>.238s
</code></pre>
    <h4>
     <a id="16__601">
     </a>
     1.6 子测试
    </h4>
    <p>
     Go1.7+中新增了子测试，支持在测试函数中使用 t.Run 执行一组测试用例，这样就不需要为不同的测试数据定义
    </p>
    <p>
     多个测试函数了。
    </p>
    <pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">TestFoo</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// &lt;setup code&gt;</span>
    t<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">"A=1"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    t<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">"A=2"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    t<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">"B=1"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// &lt;tear-down code&gt;</span>
<span class="token punctuation">}</span>
</code></pre>
    <pre><code class="prism language-shell">go <span class="token builtin class-name">test</span> -run <span class="token string">''</span>        <span class="token comment"># Run all tests.</span>
go <span class="token builtin class-name">test</span> -run Foo       <span class="token comment"># Run top-level tests matching "Foo", such as "TestFooBar".</span>
go <span class="token builtin class-name">test</span> -run Foo/A<span class="token operator">=</span>    <span class="token comment"># For top-level tests matching "Foo", run subtests matching "A=".</span>
go <span class="token builtin class-name">test</span> -run /A<span class="token operator">=</span><span class="token number">1</span>      <span class="token comment"># For all top-level tests, run subtests matching "A=1".</span>
go <span class="token builtin class-name">test</span> -fuzz FuzzFoo  <span class="token comment"># Fuzz the target matching "FuzzFoo"</span>
</code></pre>
    <p>
     例子：
    </p>
    <pre><code class="prism language-go"><span class="token keyword">package</span> go_test

<span class="token keyword">import</span> <span class="token string">"testing"</span>
<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">func</span> <span class="token function">myAdd</span><span class="token punctuation">(</span>a <span class="token builtin">int</span><span class="token punctuation">,</span> b <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> a<span class="token operator">+</span>b <span class="token operator">&gt;</span> <span class="token number">10</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token number">10</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> a <span class="token operator">+</span> b
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">mySub</span><span class="token punctuation">(</span>one <span class="token builtin">int</span><span class="token punctuation">,</span> two <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> one<span class="token operator">-</span>two <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token number">1</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> one <span class="token operator">-</span> two
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">TestMyAdd</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	num <span class="token operator">:=</span> <span class="token function">myAdd</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span>
	num <span class="token operator">=</span> <span class="token function">myAdd</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span>

<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">TestMySub</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	t<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">"one"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token function">mySub</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">{<!-- --></span>
			t<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">"cal error"</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>

	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	t<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">"two"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token function">mySub</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">2</span> <span class="token punctuation">{<!-- --></span>
			t<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">" error "</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     单独调用子测试函数，执行：
    </p>
    <pre><code class="prism language-shell">$ go <span class="token builtin class-name">test</span> -run TestMySub/one -v
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestMySub
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestMySub/one
--- PASS: TestMySub <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
    --- PASS: TestMySub/one <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
PASS
ok      proj    <span class="token number">0</span>.217s

$ go <span class="token builtin class-name">test</span> -run TestMySub/two -v
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestMySub
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestMySub/two
--- PASS: TestMySub <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
    --- PASS: TestMySub/two <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
PASS
ok      proj    <span class="token number">0</span>.261s
</code></pre>
    <h4>
     <a id="17_Fuzzing_690">
     </a>
     1.7 Fuzzing
    </h4>
    <p>
     go test 和测试包支持 fuzzing，这是一种测试技术，通过随机生成的输入调用函数来发现单元测试没有预料到的错
    </p>
    <p>
     误。
    </p>
    <pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">FuzzXxx</span><span class="token punctuation">(</span><span class="token operator">*</span>testing<span class="token punctuation">.</span>F<span class="token punctuation">)</span>
</code></pre>
    <pre><code class="prism language-go"><span class="token keyword">package</span> go_test

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"bytes"</span>
	<span class="token string">"encoding/hex"</span>
	<span class="token string">"testing"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">FuzzHex</span><span class="token punctuation">(</span>f <span class="token operator">*</span>testing<span class="token punctuation">.</span>F<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> seed <span class="token operator">:=</span> <span class="token keyword">range</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token number">9</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token number">0xa</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token number">0xf</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token punctuation">{<!-- --></span>
		f<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>seed<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	f<span class="token punctuation">.</span><span class="token function">Fuzz</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">,</span> in <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		enc <span class="token operator">:=</span> hex<span class="token punctuation">.</span><span class="token function">EncodeToString</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span>
		out<span class="token punctuation">,</span> err <span class="token operator">:=</span> hex<span class="token punctuation">.</span><span class="token function">DecodeString</span><span class="token punctuation">(</span>enc<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
			t<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"%v: decode: %v"</span><span class="token punctuation">,</span> in<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>bytes<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>in<span class="token punctuation">,</span> out<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			t<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"%v: not equal after round trip: %v"</span><span class="token punctuation">,</span> in<span class="token punctuation">,</span> out<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
    <pre><code class="prism language-shell">$ go <span class="token builtin class-name">test</span> -v -fuzz FuzzHex 006_test.go
<span class="token operator">==</span><span class="token operator">=</span> FUZZ  FuzzHex
fuzz: elapsed: 0s, gathering baseline coverage: <span class="token number">0</span>/28 completed
fuzz: elapsed: 0s, gathering baseline coverage: <span class="token number">28</span>/28 completed, now fuzzing with <span class="token number">20</span> workers
fuzz: elapsed: 3s, execs: <span class="token number">2269065</span> <span class="token punctuation">(</span><span class="token number">754894</span>/sec<span class="token punctuation">)</span>, new interesting: <span class="token number">0</span> <span class="token punctuation">(</span>total: <span class="token number">28</span><span class="token punctuation">)</span>
fuzz: elapsed: 6s, execs: <span class="token number">4247710</span> <span class="token punctuation">(</span><span class="token number">660281</span>/sec<span class="token punctuation">)</span>, new interesting: <span class="token number">0</span> <span class="token punctuation">(</span>total: <span class="token number">28</span><span class="token punctuation">)</span>
fuzz: elapsed: 9s, execs: <span class="token number">6091725</span> <span class="token punctuation">(</span><span class="token number">614495</span>/sec<span class="token punctuation">)</span>, new interesting: <span class="token number">0</span> <span class="token punctuation">(</span>total: <span class="token number">28</span><span class="token punctuation">)</span>
fuzz: elapsed: 12s, execs: <span class="token number">7923134</span> <span class="token punctuation">(</span><span class="token number">609359</span>/sec<span class="token punctuation">)</span>, new interesting: <span class="token number">0</span> <span class="token punctuation">(</span>total: <span class="token number">28</span><span class="token punctuation">)</span>
fuzz: elapsed: 15s, execs: <span class="token number">9752940</span> <span class="token punctuation">(</span><span class="token number">610984</span>/sec<span class="token punctuation">)</span>, new interesting: <span class="token number">0</span> <span class="token punctuation">(</span>total: <span class="token number">28</span><span class="token punctuation">)</span>
fuzz: elapsed: 18s, execs: <span class="token number">11603037</span> <span class="token punctuation">(</span><span class="token number">612920</span>/sec<span class="token punctuation">)</span>, new interesting: <span class="token number">0</span> <span class="token punctuation">(</span>total: <span class="token number">28</span><span class="token punctuation">)</span>
fuzz: elapsed: 21s, execs: <span class="token number">13436307</span> <span class="token punctuation">(</span><span class="token number">615324</span>/sec<span class="token punctuation">)</span>, new interesting: <span class="token number">0</span> <span class="token punctuation">(</span>total: <span class="token number">28</span><span class="token punctuation">)</span>
fuzz: elapsed: 24s, execs: <span class="token number">15295542</span> <span class="token punctuation">(</span><span class="token number">615446</span>/sec<span class="token punctuation">)</span>, new interesting: <span class="token number">0</span> <span class="token punctuation">(</span>total: <span class="token number">28</span><span class="token punctuation">)</span>
fuzz: elapsed: 27s, execs: <span class="token number">16936635</span> <span class="token punctuation">(</span><span class="token number">587500</span>/sec<span class="token punctuation">)</span>, new interesting: <span class="token number">0</span> <span class="token punctuation">(</span>total: <span class="token number">28</span><span class="token punctuation">)</span>
--- PASS: FuzzHex <span class="token punctuation">(</span><span class="token number">26</span>.82s<span class="token punctuation">)</span>
PASS
ok      command-line-arguments  <span class="token number">27</span>.178s
</code></pre>
    <p>
     可以设置 -fuzz 标志，以便模糊目标，跳过所有其他测试的执行。
    </p>
    <h4>
     <a id="18__747">
     </a>
     1.8 表格驱动测试
    </h4>
    <p>
     测试讲究 case 覆盖，按上面的方式，要覆盖更多 case 时，显然通过修改代码的方式很笨拙。这时可以采用
    </p>
    <p>
     Table-Driven 的方式写测试，标准库中有很多测试是使用这种方式写的。
    </p>
    <p>
     表格驱动测试的步骤通常是定义一个测试用例表格，然后遍历表格，并使用t.Run对每个条目执行必要的测试。
    </p>
    <pre><code class="prism language-go"><span class="token keyword">package</span> go_test

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"proj/fb"</span>
	<span class="token string">"testing"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">TestFib</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">var</span> fibTests <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
		in       <span class="token builtin">int</span> <span class="token comment">// input</span>
		expected <span class="token builtin">int</span> <span class="token comment">// expected result</span>
	<span class="token punctuation">}</span><span class="token punctuation">{<!-- --></span>
		<span class="token punctuation">{<!-- --></span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{<!-- --></span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{<!-- --></span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{<!-- --></span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{<!-- --></span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{<!-- --></span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{<!-- --></span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tt <span class="token operator">:=</span> <span class="token keyword">range</span> fibTests <span class="token punctuation">{<!-- --></span>
		actual <span class="token operator">:=</span> fb<span class="token punctuation">.</span><span class="token function">FbRecursion</span><span class="token punctuation">(</span>tt<span class="token punctuation">.</span>in<span class="token punctuation">)</span>
		<span class="token keyword">if</span> actual <span class="token operator">!=</span> tt<span class="token punctuation">.</span>expected <span class="token punctuation">{<!-- --></span>
			t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"Fib(%d) = %d; expected %d"</span><span class="token punctuation">,</span> tt<span class="token punctuation">.</span>in<span class="token punctuation">,</span> actual<span class="token punctuation">,</span> tt<span class="token punctuation">.</span>expected<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <pre><code class="prism language-shell">$ go <span class="token builtin class-name">test</span> 007_test.go -v
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestFib
--- PASS: TestFib <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
PASS
ok      command-line-arguments  <span class="token number">0</span>.248s
</code></pre>
    <h4>
     <a id="19__794">
     </a>
     1.9 并行测试
    </h4>
    <p>
     表格驱动测试中通常会定义比较多的测试用例，而Go语言又天生支持并发，所以很容易发挥自身并发优势将表格
    </p>
    <p>
     驱动测试并行化。 想要在单元测试过程中使用并行测试，可以像下面的代码示例中那样通过添加t.Parallel()来实
    </p>
    <p>
     现。
    </p>
    <pre><code class="prism language-go"><span class="token keyword">package</span> go_test

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"reflect"</span>
	<span class="token string">"testing"</span>
	<span class="token string">"strings"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">TestSplitAll</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 将TLog标记为能够与其他测试并行运行</span>
	t<span class="token punctuation">.</span><span class="token function">Parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// 定义测试表格</span>
	<span class="token comment">// 为每个测试用例设置了一个名称</span>
	tests <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
		name  <span class="token builtin">string</span>
		input <span class="token builtin">string</span>
		sep   <span class="token builtin">string</span>
		want  <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>
	<span class="token punctuation">}</span><span class="token punctuation">{<!-- --></span>
		<span class="token punctuation">{<!-- --></span><span class="token string">"base case"</span><span class="token punctuation">,</span> <span class="token string">"a:b:c"</span><span class="token punctuation">,</span> <span class="token string">":"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{<!-- --></span><span class="token string">"a"</span><span class="token punctuation">,</span> <span class="token string">"b"</span><span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{<!-- --></span><span class="token string">"wrong sep"</span><span class="token punctuation">,</span> <span class="token string">"a:b:c"</span><span class="token punctuation">,</span> <span class="token string">","</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{<!-- --></span><span class="token string">"a:b:c"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{<!-- --></span><span class="token string">"more sep"</span><span class="token punctuation">,</span> <span class="token string">"abcd"</span><span class="token punctuation">,</span> <span class="token string">"bc"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{<!-- --></span><span class="token string">"a"</span><span class="token punctuation">,</span> <span class="token string">"d"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{<!-- --></span><span class="token string">"leading sep"</span><span class="token punctuation">,</span> <span class="token string">"沙河有沙又有河"</span><span class="token punctuation">,</span> <span class="token string">"沙"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{<!-- --></span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"河有"</span><span class="token punctuation">,</span> <span class="token string">"又有河"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 遍历测试用例</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tt <span class="token operator">:=</span> <span class="token keyword">range</span> tests <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 注意这里重新声明tt变量(避免多个goroutine中使用了相同的变量)</span>
		tt <span class="token operator">:=</span> tt
		<span class="token comment">// 使用t.Run()执行子测试</span>
		t<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>tt<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// 将每个测试用例标记为能够彼此并行运行</span>
			t<span class="token punctuation">.</span><span class="token function">Parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			got <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span>tt<span class="token punctuation">.</span>input<span class="token punctuation">,</span> tt<span class="token punctuation">.</span>sep<span class="token punctuation">)</span>
			<span class="token keyword">if</span> <span class="token operator">!</span>reflect<span class="token punctuation">.</span><span class="token function">DeepEqual</span><span class="token punctuation">(</span>got<span class="token punctuation">,</span> tt<span class="token punctuation">.</span>want<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"expected:%#v, got:%#v"</span><span class="token punctuation">,</span> tt<span class="token punctuation">.</span>want<span class="token punctuation">,</span> got<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <pre><code class="prism language-shell">$ go <span class="token builtin class-name">test</span> 008_test.go -v
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestSplitAll
<span class="token operator">==</span><span class="token operator">=</span> PAUSE TestSplitAll
<span class="token operator">==</span><span class="token operator">=</span> CONT  TestSplitAll
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestSplitAll/base_case
<span class="token operator">==</span><span class="token operator">=</span> PAUSE TestSplitAll/base_case
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestSplitAll/wrong_sep
<span class="token operator">==</span><span class="token operator">=</span> PAUSE TestSplitAll/wrong_sep
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestSplitAll/more_sep
<span class="token operator">==</span><span class="token operator">=</span> PAUSE TestSplitAll/more_sep
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestSplitAll/leading_sep
<span class="token operator">==</span><span class="token operator">=</span> PAUSE TestSplitAll/leading_sep
<span class="token operator">==</span><span class="token operator">=</span> CONT  TestSplitAll/base_case
<span class="token operator">==</span><span class="token operator">=</span> CONT  TestSplitAll/wrong_sep
<span class="token operator">==</span><span class="token operator">=</span> CONT  TestSplitAll/leading_sep
<span class="token operator">==</span><span class="token operator">=</span> CONT  TestSplitAll/more_sep
--- PASS: TestSplitAll <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
    --- PASS: TestSplitAll/base_case <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
    --- PASS: TestSplitAll/wrong_sep <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
    --- PASS: TestSplitAll/leading_sep <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
    --- PASS: TestSplitAll/more_sep <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
PASS
ok      command-line-arguments  <span class="token number">0</span>.237s
</code></pre>
    <h4>
     <a id="110_Main_870">
     </a>
     1.10 Main
    </h4>
    <p>
     测试或基准测试程序有时需要在执行之前或之后进行额外的设置和拆卸，有时还需要控制哪些代码在主线程上运
    </p>
    <p>
     行，为了支持这些和其他情况，如果测试文件包含以下函数：
    </p>
    <pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">TestMain</span><span class="token punctuation">(</span>m <span class="token operator">*</span>testing<span class="token punctuation">.</span>M<span class="token punctuation">)</span>
</code></pre>
    <p>
     那么生成的测试将调用 TestMain，而不是直接运行测试或基准测试。TestMain 在主 goroutine 中运行，可以围绕
    </p>
    <p>
     对 m.Run 的调用进行任何必要的设置和拆卸。m.Run 将返回一个可能传递给 os.Exit 的退出代码。如果 TestMain
    </p>
    <p>
     返回，测试包装器将把 m.Run 的结果传递给 os.Exit 本身。
    </p>
    <p>
     当调用 TestMain 时，flag.Parse 尚未运行。如果 TestMain 依赖于命令行标志，包括测试包的标志，它应该显式
    </p>
    <p>
     调用 flag.Parse。命令行标志总是在测试或基准函数运行时解析。
    </p>
    <p>
     TestMain的一个简单实现是：
    </p>
    <pre><code class="prism language-go"><span class="token keyword">package</span> go_test

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"math"</span>
	<span class="token string">"os"</span>
	<span class="token string">"testing"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">TestMain</span><span class="token punctuation">(</span>m <span class="token operator">*</span>testing<span class="token punctuation">.</span>M<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 测试之前的做一些设置</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"write setup code here..."</span><span class="token punctuation">)</span>
	<span class="token comment">// 如果 TestMain 使用了 flags，这里应该加上flag.Parse()</span>
	<span class="token comment">// 执行测试</span>
	retCode <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// 测试之后做一些拆卸工作</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"write teardown code here..."</span><span class="token punctuation">)</span>
	<span class="token comment">// 退出测试</span>
	os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span>retCode<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">TestAbs</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	got <span class="token operator">:=</span> math<span class="token punctuation">.</span><span class="token function">Abs</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> got <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">{<!-- --></span>
		t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"Abs(-1) = %f; want 1"</span><span class="token punctuation">,</span> got<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <pre><code class="prism language-shell">$ go <span class="token builtin class-name">test</span> 009_test.go -v
<span class="token function">write</span> setup code here<span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestAbs
--- PASS: TestAbs <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
PASS
<span class="token function">write</span> teardown code here<span class="token punctuation">..</span>.
ok      command-line-arguments  <span class="token number">0</span>.248s
</code></pre>
    <h4>
     <a id="111_SetupTeardown_932">
     </a>
     1.11 Setup与Teardown
    </h4>
    <p>
     有时候可能需要为每个测试集设置Setup与Teardown，也有可能需要为每个子测试设置Setup与Teardown。
    </p>
    <pre><code class="prism language-go"><span class="token keyword">package</span>  go_test

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"reflect"</span>
	<span class="token string">"strings"</span>
	<span class="token string">"testing"</span>
<span class="token punctuation">)</span>

<span class="token comment">// 测试集的Setup与Teardown</span>
<span class="token keyword">func</span> <span class="token function">setupTestCase</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token keyword">func</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	t<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">"如有需要在此执行:测试之前的setup"</span><span class="token punctuation">)</span>
	<span class="token comment">// 返回Teardown</span>
	<span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		t<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">"如有需要在此执行:测试之后的teardown"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 子测试的Setup与Teardown</span>
<span class="token keyword">func</span> <span class="token function">setupSubTest</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token keyword">func</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	t<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">"如有需要在此执行:子测试之前的setup"</span><span class="token punctuation">)</span>
	<span class="token comment">// 返回Teardown</span>
	<span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		t<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">"如有需要在此执行:子测试之后的teardown"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">TestSplit</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 定义test结构体</span>
	<span class="token keyword">type</span> test <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
		input <span class="token builtin">string</span>
		sep   <span class="token builtin">string</span>
		want  <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 测试用例使用map存储</span>
	tests <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>test<span class="token punctuation">{<!-- --></span>
		<span class="token string">"simple"</span><span class="token punctuation">:</span>      <span class="token punctuation">{<!-- --></span>input<span class="token punctuation">:</span> <span class="token string">"a:b:c"</span><span class="token punctuation">,</span> sep<span class="token punctuation">:</span> <span class="token string">":"</span><span class="token punctuation">,</span> want<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{<!-- --></span><span class="token string">"a"</span><span class="token punctuation">,</span> <span class="token string">"b"</span><span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token string">"wrong sep"</span><span class="token punctuation">:</span>   <span class="token punctuation">{<!-- --></span>input<span class="token punctuation">:</span> <span class="token string">"a:b:c"</span><span class="token punctuation">,</span> sep<span class="token punctuation">:</span> <span class="token string">","</span><span class="token punctuation">,</span> want<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{<!-- --></span><span class="token string">"a:b:c"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token string">"more sep"</span><span class="token punctuation">:</span>    <span class="token punctuation">{<!-- --></span>input<span class="token punctuation">:</span> <span class="token string">"abcd"</span><span class="token punctuation">,</span> sep<span class="token punctuation">:</span> <span class="token string">"bc"</span><span class="token punctuation">,</span> want<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{<!-- --></span><span class="token string">"a"</span><span class="token punctuation">,</span> <span class="token string">"d"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token string">"leading sep"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>input<span class="token punctuation">:</span> <span class="token string">"沙河有沙又有河"</span><span class="token punctuation">,</span> sep<span class="token punctuation">:</span> <span class="token string">"沙"</span><span class="token punctuation">,</span> want<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{<!-- --></span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"河有"</span><span class="token punctuation">,</span> <span class="token string">"又有河"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 测试之前执行setup操作</span>
	teardownTestCase <span class="token operator">:=</span> <span class="token function">setupTestCase</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
	<span class="token comment">// 测试之后执行testdoen操作</span>
	<span class="token keyword">defer</span> <span class="token function">teardownTestCase</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
	<span class="token keyword">for</span> name<span class="token punctuation">,</span> tc <span class="token operator">:=</span> <span class="token keyword">range</span> tests <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 使用t.Run()执行子测试</span>
		t<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// 子测试之前执行setup操作</span>
			teardownSubTest <span class="token operator">:=</span> <span class="token function">setupSubTest</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
			<span class="token comment">// 测试之后执行testdoen操作</span>
			<span class="token keyword">defer</span> <span class="token function">teardownSubTest</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
			got <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>input<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>sep<span class="token punctuation">)</span>
			<span class="token keyword">if</span> <span class="token operator">!</span>reflect<span class="token punctuation">.</span><span class="token function">DeepEqual</span><span class="token punctuation">(</span>got<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>want<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"expected:%#v, got:%#v"</span><span class="token punctuation">,</span> tc<span class="token punctuation">.</span>want<span class="token punctuation">,</span> got<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <pre><code class="prism language-shell">$ go <span class="token builtin class-name">test</span> 017_test.go -v
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestSplit
    017_test.go:11: 如有需要在此执行:测试之前的setup
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestSplit/simple
    017_test.go:20: 如有需要在此执行:子测试之前的setup
    017_test.go:23: 如有需要在此执行:子测试之后的teardown
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestSplit/wrong_sep
    017_test.go:20: 如有需要在此执行:子测试之前的setup
    017_test.go:23: 如有需要在此执行:子测试之后的teardown
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestSplit/more_sep
    017_test.go:20: 如有需要在此执行:子测试之前的setup
    017_test.go:23: 如有需要在此执行:子测试之后的teardown
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestSplit/leading_sep
    017_test.go:20: 如有需要在此执行:子测试之前的setup
    017_test.go:23: 如有需要在此执行:子测试之后的teardown
<span class="token operator">==</span><span class="token operator">=</span> CONT  TestSplit
    017_test.go:14: 如有需要在此执行:测试之后的teardown
--- PASS: TestSplit <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
    --- PASS: TestSplit/simple <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
    --- PASS: TestSplit/wrong_sep <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
    --- PASS: TestSplit/more_sep <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
    --- PASS: TestSplit/leading_sep <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
PASS
ok      command-line-arguments  <span class="token number">0</span>.228s
</code></pre>
    <h4>
     <a id="112__1024">
     </a>
     1.12 覆盖率测试
    </h4>
    <p>
     测试覆盖率是指代码被测试套件覆盖的百分比，也就是在测试中至少被运行一次的代码占总代码的比例，在公司内
    </p>
    <p>
     部一般会要求测试覆盖率达到80%左右。
    </p>
    <p>
     查看测试覆盖率：
    </p>
    <pre><code class="prism language-shell">$ go <span class="token builtin class-name">test</span> -cover -run .*Fb.* -coverprofile<span class="token operator">=</span><span class="token string">'c.out'</span> -coverpkg<span class="token operator">=</span>proj/fb
</code></pre>
    <ul>
     <li>
      <p>
       <code>
        -cover
       </code>
       ：代表进行覆盖率测试
      </p>
     </li>
     <li>
      <p>
       <code>
        -coverprofile
       </code>
       ：代表将结果存储到c.out
      </p>
     </li>
     <li>
      <p>
       <code>
        -coverpkg
       </code>
       ：用于指定覆盖率测试的目标包，测试代码所依赖的源文件所在包。这就是说，不是目录下的.go
      </p>
      <p>
       文件，而是直接是包就可以了
      </p>
     </li>
    </ul>
    <pre><code class="prism language-shell">$ go <span class="token builtin class-name">test</span> -cover -run .*Fb.* -coverprofile<span class="token operator">=</span><span class="token string">'c.out'</span> -coverpkg<span class="token operator">=</span>proj/fb
PASS
coverage: <span class="token number">100.0</span>% of statements <span class="token keyword">in</span> proj/fb
ok      proj    <span class="token number">0</span>.286s
</code></pre>
    <p>
     生成的测试结果，可使用
     <code>
      go tool cover -html='c.out' -o coverage.html
     </code>
     来转换成可视化的html：
    </p>
    <pre><code class="prism language-shell">$ go tool cover -html<span class="token operator">=</span><span class="token string">'c.out'</span> -o coverage.html
</code></pre>
    <p>
     查看生成的 html 内容：
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/9d4709bfeb683f2dcc3bd1a2e711907b.png#pic_center"/>
    </p>
    <p>
     图中绿色的部分是已覆盖，红色的部分是未覆盖，咱们的例子已经全部覆盖具体的函数功能。
    </p>
    <h4>
     <a id="113__1064">
     </a>
     1.13 多个文件同时进行测试
    </h4>
    <pre><code class="prism language-shell">$ go <span class="token builtin class-name">test</span> -o 001_test.go 002_test.go -v
<span class="token comment"># 或者</span>
$ go <span class="token builtin class-name">test</span> 001_test.go 002_test.go -v
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestAbs
--- PASS: TestAbs <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
PASS
ok      command-line-arguments  <span class="token number">0</span>.236s
</code></pre>
    <p>
     go test 如果不指定文件，则测试的是当前目录下的所有文件。
    </p>
    <h4>
     <a id="114__1078">
     </a>
     1.14 报告方法
    </h4>
    <p>
     遇到一个断言错误的时候，标识这个测试失败：
    </p>
    <pre><code class="prism language-go"><span class="token function">Fail</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> 测试失败，测试继续
<span class="token function">FailNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> 测试失败，测试中断
</code></pre>
    <p>
     遇到一个断言错误，只希望跳过这个错误，但是不希望标识测试失败：
    </p>
    <pre><code class="prism language-go"><span class="token function">SkipNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> 跳过测试，测试中断
</code></pre>
    <p>
     只希望打印信息：
    </p>
    <pre><code class="prism language-go">Log <span class="token punctuation">:</span> 输出信息
Logf <span class="token punctuation">:</span> 输出格式化的信息
</code></pre>
    <p>
     希望跳过这个测试，并且打印出信息：
    </p>
    <pre><code class="prism language-go">Skip <span class="token punctuation">:</span> 相当于 Log <span class="token operator">+</span> SkipNow
Skipf <span class="token punctuation">:</span> 相当于 Logf <span class="token operator">+</span> SkipNow
</code></pre>
    <p>
     希望断言失败的时候，标识测试失败，并打印出必要的信息，但是测试继续：
    </p>
    <pre><code class="prism language-go">Error <span class="token punctuation">:</span> 相当于 Log <span class="token operator">+</span> Fail
Errorf <span class="token punctuation">:</span> 相当于 Logf <span class="token operator">+</span> Fail
</code></pre>
    <p>
     希望断言失败的时候，标识测试失败，打印出必要的信息，但中断测试：
    </p>
    <pre><code class="prism language-go">Fatal <span class="token punctuation">:</span> 相当于 Log <span class="token operator">+</span> FailNow
Fatalf <span class="token punctuation">:</span> 相当于 Logf <span class="token operator">+</span> FailNow
</code></pre>
    <h3>
     <a id="2_1121">
     </a>
     2、示例函数
    </h3>
    <p>
     实例函数的编写可以使用
     <code>
      go help testfunc
     </code>
     查看：
    </p>
    <pre><code class="prism language-shell">$ go <span class="token builtin class-name">help</span> testfunc
The <span class="token string">'go test'</span> <span class="token builtin class-name">command</span> expects to <span class="token function">find</span> test, benchmark, and example functions
<span class="token keyword">in</span> the <span class="token string">"*_test.go"</span> files corresponding to the package under test.

A <span class="token builtin class-name">test</span> <span class="token keyword">function</span> is one named TestXxx <span class="token punctuation">(</span>where Xxx does not start with a
lower <span class="token keyword">case</span> letter<span class="token punctuation">)</span> and should have the signature,

        func TestXxx<span class="token punctuation">(</span>t *testing.T<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">..</span>. <span class="token punctuation">}</span>

A benchmark <span class="token keyword">function</span> is one named BenchmarkXxx and should have the signature,

        func BenchmarkXxx<span class="token punctuation">(</span>b *testing.B<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">..</span>. <span class="token punctuation">}</span>

A fuzz <span class="token builtin class-name">test</span> is one named FuzzXxx and should have the signature,

        func FuzzXxx<span class="token punctuation">(</span>f *testing.F<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">..</span>. <span class="token punctuation">}</span>

An example <span class="token keyword">function</span> is similar to a <span class="token builtin class-name">test</span> <span class="token keyword">function</span> but, instead of using
*testing.T to report success or failure, prints output to os.Stdout.
If the last comment <span class="token keyword">in</span> the <span class="token keyword">function</span> starts with <span class="token string">"Output:"</span> <span class="token keyword">then</span> the output
is compared exactly against the comment <span class="token punctuation">(</span>see examples below<span class="token punctuation">)</span>. If the last
comment begins with <span class="token string">"Unordered output:"</span> <span class="token keyword">then</span> the output is compared to the
comment, however the order of the lines is ignored. An example with no such
comment is compiled but not executed. An example with no text after
<span class="token string">"Output:"</span> is compiled, executed, and expected to produce no output.

Godoc displays the body of ExampleXxx to demonstrate the use
of the function, constant, or variable Xxx. An example of a method M with
receiver <span class="token builtin class-name">type</span> T or *T is named ExampleT_M. There may be multiple examples
<span class="token keyword">for</span> a given function, constant, or variable, distinguished by a trailing _xxx,
where xxx is a suffix not beginning with an upper <span class="token keyword">case</span> letter.

Here is an example of an example:

        func <span class="token function-name function">ExamplePrintln</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                Println<span class="token punctuation">(</span><span class="token string">"The output of<span class="token entity" title="\n">\n</span>this example."</span><span class="token punctuation">)</span>
                // Output: The output of
                // this example.
        <span class="token punctuation">}</span>

Here is another example where the ordering of the output is ignored:

        func <span class="token function-name function">ExamplePerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">for</span> _, value :<span class="token operator">=</span> range Perm<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        fmt.Println<span class="token punctuation">(</span>value<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>

                // Unordered output: <span class="token number">4</span>
                // <span class="token number">2</span>
                // <span class="token number">1</span>
                // <span class="token number">3</span>
                // <span class="token number">0</span>
        <span class="token punctuation">}</span>

The entire <span class="token builtin class-name">test</span> <span class="token function">file</span> is presented as the example when it contains a single
example function, at least one other function, type, variable, or constant
declaration, and no tests, benchmarks, or fuzz tests.

See the documentation of the testing package <span class="token keyword">for</span> <span class="token function">more</span> information.
</code></pre>
    <p>
     实例：
    </p>
    <pre><code class="prism language-go"><span class="token keyword">package</span> go_test

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"proj/fb"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">Example_fb_norecursion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>fb<span class="token punctuation">.</span><span class="token function">FbRecursion</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>fb<span class="token punctuation">.</span><span class="token function">FbNoRecursion</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// 1</span>
	<span class="token comment">// 2</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     示例函数也可以当作测试函数进行运行，运行结果需要与Output一致：
    </p>
    <pre><code class="prism language-shell">$ go <span class="token builtin class-name">test</span> 010_test.go -v
<span class="token operator">==</span><span class="token operator">=</span> RUN   Example_fb_norecursion
--- PASS: Example_fb_norecursion <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
PASS
ok      command-line-arguments  <span class="token number">0</span>.238s
</code></pre>
    <p>
     如果修改为：
    </p>
    <pre><code class="prism language-go"><span class="token keyword">package</span> go_test

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"proj/fb"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">Example_fb_norecursion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>fb<span class="token punctuation">.</span><span class="token function">FbRecursion</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>fb<span class="token punctuation">.</span><span class="token function">FbNoRecursion</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// 1</span>
	<span class="token comment">// 4</span>
<span class="token punctuation">}</span>
</code></pre>
    <pre><code class="prism language-shell">$ go <span class="token builtin class-name">test</span> 010_test.go -v
<span class="token operator">==</span><span class="token operator">=</span> RUN   Example_fb_norecursion
--- FAIL: Example_fb_norecursion <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
got:
<span class="token number">1</span>
<span class="token number">2</span>
want:
<span class="token number">1</span>
<span class="token number">4</span>
FAIL
FAIL    command-line-arguments  <span class="token number">0</span>.245s
FAIL
</code></pre>
    <p>
     示例函数只要包含了
     <code>
      // Output:
     </code>
     也是可以通过 go test 运行的可执行测试。
    </p>
    <pre><code class="prism language-shell">$ go <span class="token builtin class-name">test</span> -run Example
PASS
ok      proj    <span class="token number">0</span>.272s
</code></pre>
    <pre><code class="prism language-go"><span class="token comment">// 示例</span>
<span class="token keyword">package</span> go_test

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">func</span> <span class="token function">ExampleHello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">)</span>
	<span class="token comment">// Output: hello</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">ExampleSalutations</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"hello, and"</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"goodbye"</span><span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// hello, and</span>
	<span class="token comment">// goodbye</span>
<span class="token punctuation">}</span>
</code></pre>
    <pre><code class="prism language-shell">$ go <span class="token builtin class-name">test</span> 011_test.go -v
<span class="token operator">==</span><span class="token operator">=</span> RUN   ExampleHello
--- PASS: ExampleHello <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
<span class="token operator">==</span><span class="token operator">=</span> RUN   ExampleSalutations
--- PASS: ExampleSalutations <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
PASS
ok      command-line-arguments  <span class="token number">0</span>.223s
</code></pre>
    <p>
     前缀
     <code>
      Unordered output:
     </code>
     和
     <code>
      Output:
     </code>
     相似，但是它不按照顺序匹配。
    </p>
    <pre><code class="prism language-go"><span class="token keyword">package</span> go_test

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">func</span> <span class="token function">ExamplePerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	list <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> value <span class="token operator">:=</span> <span class="token keyword">range</span> list <span class="token punctuation">{<!-- --></span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// Unordered output: 4</span>
	<span class="token comment">// 2</span>
	<span class="token comment">// 1</span>
	<span class="token comment">// 3</span>
	<span class="token comment">// 0</span>
<span class="token punctuation">}</span>
</code></pre>
    <pre><code class="prism language-shell">$ go <span class="token builtin class-name">test</span> 012_test.go -v
<span class="token operator">==</span><span class="token operator">=</span> RUN   ExamplePerm
--- PASS: ExamplePerm <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
PASS
ok      command-line-arguments  <span class="token number">0</span>.220s
</code></pre>
    <p>
     没有 Outout 注释的示例函数被编译但不执行。
    </p>
    <p>
     一个包/类型/函数/方法的多个示例函数可以通过在名称后面附加一个不同的后缀来提供，后缀必须以小写字母开
    </p>
    <p>
     头。
    </p>
    <pre><code class="prism language-go"><span class="token comment">// package</span>
<span class="token keyword">func</span> <span class="token function">Example</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token operator">...</span> <span class="token punctuation">}</span>
<span class="token comment">// function</span>
<span class="token keyword">func</span> <span class="token function">ExampleF</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token operator">...</span> <span class="token punctuation">}</span>
<span class="token comment">// type</span>
<span class="token keyword">func</span> <span class="token function">ExampleT</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token operator">...</span> <span class="token punctuation">}</span>
<span class="token comment">// method</span>
<span class="token keyword">func</span> <span class="token function">ExampleT_M</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token operator">...</span> <span class="token punctuation">}</span>
</code></pre>
    <pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">Example_suffix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token operator">...</span> <span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">ExampleF_suffix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token operator">...</span> <span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">ExampleT_suffix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token operator">...</span> <span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">ExampleT_M_suffix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token operator">...</span> <span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="3_1340">
     </a>
     3、性能测试
    </h3>
    <p>
     性能测试就是在一定的工作负载之下检测程序性能的一种方法。
    </p>
    <pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">BenchmarkName</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     基准测试以 Benchmark 为前缀，需要一个 testing.B 类型的参数 b，基准测试必须要执行 b.N 次，这样的测试才
    </p>
    <p>
     有对照性，b.N 的值是系统根据实际情况去调整的，从而保证测试的稳定性。
    </p>
    <h4>
     <a id="31__1354">
     </a>
     3.1 支持的函数
    </h4>
    <p>
     使用
     <code>
      go doc testing.B
     </code>
     查询文档：
    </p>
    <pre><code class="prism language-shell">$ go doc testing.B
package testing // <span class="token function">import</span> <span class="token string">"testing"</span>

<span class="token builtin class-name">type</span> B struct <span class="token punctuation">{<!-- --></span>
        N int

        // Has unexported fields.
<span class="token punctuation">}</span>
    B is a <span class="token builtin class-name">type</span> passed to Benchmark functions to manage benchmark timing and to
    specify the number of iterations to run.

    A benchmark ends when its Benchmark <span class="token keyword">function</span> returns or calls any of the
    methods FailNow, Fatal, Fatalf, SkipNow, Skip, or Skipf. Those methods must
    be called only from the goroutine running the Benchmark function. The other
    reporting methods, such as the variations of Log and Error, may be called
    simultaneously from multiple goroutines.

    Like <span class="token keyword">in</span> tests, benchmark logs are accumulated during execution and dumped to
    standard output when done. Unlike <span class="token keyword">in</span> tests, benchmark logs are always
    printed, so as not to hide output whose existence may be affecting benchmark
    results.

func <span class="token punctuation">(</span>c *B<span class="token punctuation">)</span> Cleanup<span class="token punctuation">(</span>f func<span class="token punctuation">(</span><span class="token punctuation">))</span>
func <span class="token punctuation">(</span>c *B<span class="token punctuation">)</span> Error<span class="token punctuation">(</span>args <span class="token punctuation">..</span>.any<span class="token punctuation">)</span>
func <span class="token punctuation">(</span>c *B<span class="token punctuation">)</span> Errorf<span class="token punctuation">(</span>format string, args <span class="token punctuation">..</span>.any<span class="token punctuation">)</span>
func <span class="token punctuation">(</span>c *B<span class="token punctuation">)</span> Fail<span class="token punctuation">(</span><span class="token punctuation">)</span>
func <span class="token punctuation">(</span>c *B<span class="token punctuation">)</span> FailNow<span class="token punctuation">(</span><span class="token punctuation">)</span>
func <span class="token punctuation">(</span>c *B<span class="token punctuation">)</span> Failed<span class="token punctuation">(</span><span class="token punctuation">)</span> bool
func <span class="token punctuation">(</span>c *B<span class="token punctuation">)</span> Fatal<span class="token punctuation">(</span>args <span class="token punctuation">..</span>.any<span class="token punctuation">)</span>
func <span class="token punctuation">(</span>c *B<span class="token punctuation">)</span> Fatalf<span class="token punctuation">(</span>format string, args <span class="token punctuation">..</span>.any<span class="token punctuation">)</span>
func <span class="token punctuation">(</span>c *B<span class="token punctuation">)</span> Helper<span class="token punctuation">(</span><span class="token punctuation">)</span>
func <span class="token punctuation">(</span>c *B<span class="token punctuation">)</span> Log<span class="token punctuation">(</span>args <span class="token punctuation">..</span>.any<span class="token punctuation">)</span>
func <span class="token punctuation">(</span>c *B<span class="token punctuation">)</span> Logf<span class="token punctuation">(</span>format string, args <span class="token punctuation">..</span>.any<span class="token punctuation">)</span>
func <span class="token punctuation">(</span>c *B<span class="token punctuation">)</span> Name<span class="token punctuation">(</span><span class="token punctuation">)</span> string
func <span class="token punctuation">(</span>b *B<span class="token punctuation">)</span> ReportAllocs<span class="token punctuation">(</span><span class="token punctuation">)</span>
func <span class="token punctuation">(</span>b *B<span class="token punctuation">)</span> ReportMetric<span class="token punctuation">(</span>n float64, unit string<span class="token punctuation">)</span>
func <span class="token punctuation">(</span>b *B<span class="token punctuation">)</span> ResetTimer<span class="token punctuation">(</span><span class="token punctuation">)</span>
func <span class="token punctuation">(</span>b *B<span class="token punctuation">)</span> Run<span class="token punctuation">(</span>name string, f func<span class="token punctuation">(</span>b *B<span class="token punctuation">))</span> bool
func <span class="token punctuation">(</span>b *B<span class="token punctuation">)</span> RunParallel<span class="token punctuation">(</span>body func<span class="token punctuation">(</span>*PB<span class="token punctuation">))</span>
func <span class="token punctuation">(</span>b *B<span class="token punctuation">)</span> SetBytes<span class="token punctuation">(</span>n int64<span class="token punctuation">)</span>
func <span class="token punctuation">(</span>b *B<span class="token punctuation">)</span> SetParallelism<span class="token punctuation">(</span>p int<span class="token punctuation">)</span>
func <span class="token punctuation">(</span>c *B<span class="token punctuation">)</span> Setenv<span class="token punctuation">(</span>key, value string<span class="token punctuation">)</span>
func <span class="token punctuation">(</span>c *B<span class="token punctuation">)</span> Skip<span class="token punctuation">(</span>args <span class="token punctuation">..</span>.any<span class="token punctuation">)</span>
func <span class="token punctuation">(</span>c *B<span class="token punctuation">)</span> SkipNow<span class="token punctuation">(</span><span class="token punctuation">)</span>
func <span class="token punctuation">(</span>c *B<span class="token punctuation">)</span> Skipf<span class="token punctuation">(</span>format string, args <span class="token punctuation">..</span>.any<span class="token punctuation">)</span>
func <span class="token punctuation">(</span>c *B<span class="token punctuation">)</span> Skipped<span class="token punctuation">(</span><span class="token punctuation">)</span> bool
func <span class="token punctuation">(</span>b *B<span class="token punctuation">)</span> StartTimer<span class="token punctuation">(</span><span class="token punctuation">)</span>
func <span class="token punctuation">(</span>b *B<span class="token punctuation">)</span> StopTimer<span class="token punctuation">(</span><span class="token punctuation">)</span>
func <span class="token punctuation">(</span>c *B<span class="token punctuation">)</span> TempDir<span class="token punctuation">(</span><span class="token punctuation">)</span> string
</code></pre>
    <h4>
     <a id="32__1410">
     </a>
     3.2 简单例子
    </h4>
    <pre><code class="prism language-go"><span class="token keyword">package</span> go_test

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"testing"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">BenchmarkHello</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{<!-- --></span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"hello world!"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <pre><code class="prism language-shell"><span class="token comment"># 通过go test命令,加上-bench标志来执行</span>
$ go <span class="token builtin class-name">test</span> -bench BenchmarkHello
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
hello world<span class="token operator">!</span>
hello world<span class="token operator">!</span>
hello world<span class="token operator">!</span>
BenchmarkHello-20          <span class="token number">66876</span>             <span class="token number">16921</span> ns/op
PASS
ok      proj    <span class="token number">1</span>.586s
</code></pre>
    <h4>
     <a id="33__1439">
     </a>
     3.3 性能比较函数
    </h4>
    <p>
     通常需要对两个不同算法的实现使用相同的输入来进行基准比较测试。
    </p>
    <p>
     默认情况下，每个基准测试至少运行1秒。如果在Benchmark函数返回时没有到1秒，则b.N的值会按
    </p>
    <p>
     1,2,5,10,20,50，…增加，并且函数再次运行。
    </p>
    <p>
     可以使用 -benchtime 标志增加最小基准时间，以产生更准确的结果。
    </p>
    <pre><code class="prism language-go"><span class="token keyword">package</span> go_test

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"proj/fb"</span>
	<span class="token string">"testing"</span>
<span class="token punctuation">)</span>


<span class="token keyword">func</span> <span class="token function">BenchmarkFib40</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{<!-- --></span>
		fb<span class="token punctuation">.</span><span class="token function">FbRecursion</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">BenchmarkFib40No</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{<!-- --></span>
		fb<span class="token punctuation">.</span><span class="token function">FbNoRecursion</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <pre><code class="prism language-shell">$ go <span class="token builtin class-name">test</span> -bench<span class="token operator">=</span>Fib40 -benchtime<span class="token operator">=</span>20s
goos: windows
goarch: amd64
pkg: proj
cpu: 12th Gen Intel<span class="token punctuation">(</span>R<span class="token punctuation">)</span> Core<span class="token punctuation">(</span>TM<span class="token punctuation">)</span> i7-12700
BenchmarkFib40-20            <span class="token number">100</span>         <span class="token number">257579890</span> ns/op
BenchmarkFib40No-20     <span class="token number">154547244</span>              <span class="token number">163.6</span> ns/op
PASS
ok      proj    <span class="token number">67</span>.233s
</code></pre>
    <h4>
     <a id="34__1483">
     </a>
     3.4 计时方法
    </h4>
    <p>
     有三个方法用于计时：
    </p>
    <p>
     StartTimer：开始对测试进行计时。该方法会在基准测试开始时自动被调用，也可以在调用 StopTimer 之后恢复
    </p>
    <p>
     计时；
    </p>
    <p>
     StopTimer：停止对测试进行计时。当需要执行一些复杂的初始化操作，并且不想对这些操作进行测量时，就可以
    </p>
    <p>
     使用这个方法来暂时地停止计时；
    </p>
    <p>
     ResetTimer：对已经逝去的基准测试时间以及内存分配计数器进行清零。对于正在运行中的计时器，这个方法
    </p>
    <p>
     不会产生任何效果。
    </p>
    <pre><code class="prism language-go"><span class="token keyword">package</span> go_test

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"testing"</span>
	<span class="token string">"time"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">BenchmarkPrint</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 假设需要做一些耗时的无关操作</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	<span class="token comment">// 重置计时器</span>
	b<span class="token punctuation">.</span><span class="token function">ResetTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{<!-- --></span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"hello world!"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <pre><code class="prism language-shell">$ go <span class="token builtin class-name">test</span> -bench<span class="token operator">=</span>Print -v
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
hello world<span class="token operator">!</span>
hello world<span class="token operator">!</span>
hello world<span class="token operator">!</span>
hello world<span class="token operator">!</span>
BenchmarkPrintParallel-20          <span class="token number">62869</span>             <span class="token number">18777</span> ns/op
PASS
ok      proj    <span class="token number">22</span>.963s
</code></pre>
    <h4>
     <a id="35__1531">
     </a>
     3.5 并行测试
    </h4>
    <p>
     <code>
      func (b *B) RunParallel(body func(*PB))
     </code>
     会以并行的方式执行给定的基准测试。
    </p>
    <p>
     通过 RunParallel 方法能够并行地执行给定的基准测试，RunParallel 通常会与 -cpu 标志一同使用。
    </p>
    <p>
     b.SetParallelism() 可以设置使用的CPU数。
    </p>
    <p>
     body 函数将在每个 goroutine 中执行，这个函数需要设置所有 goroutine 本地的状态，并迭代直到 pb.Next 返回
    </p>
    <p>
     false 值为止。因为 StartTimer、StopTime 和 ResetTimer 这三个方法都带有全局作用，所以 body 函数不应该调
    </p>
    <p>
     用这些方法； 除此之外，body 函数也不应该调用 Run 方法。
    </p>
    <pre><code class="prism language-go"><span class="token keyword">package</span> go_test

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"testing"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">BenchmarkPrintParallel</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 设置使用的CPU数</span>
	<span class="token comment">// b.SetParallelism(1)</span>
	b<span class="token punctuation">.</span><span class="token function">RunParallel</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>pb <span class="token operator">*</span>testing<span class="token punctuation">.</span>PB<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">for</span> pb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"hello world!"</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
    <pre><code class="prism language-shell">$ go <span class="token builtin class-name">test</span> -bench<span class="token operator">=</span>PrintParallel -v
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
hello world<span class="token operator">!</span>
hello world<span class="token operator">!</span>
hello world<span class="token operator">!</span>
hello world<span class="token operator">!</span>
BenchmarkPrintParallel-20          <span class="token number">61087</span>             <span class="token number">18990</span> ns/op
PASS
ok      proj    <span class="token number">1</span>.646s
</code></pre>
    <h4>
     <a id="36__1576">
     </a>
     3.6 子测试
    </h4>
    <pre><code class="prism language-go"><span class="token keyword">package</span> go_test

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"testing"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> identifier <span class="token keyword">interface</span> <span class="token punctuation">{<!-- --></span>
	<span class="token function">idInline</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int32</span>
	<span class="token function">idNoInline</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int32</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> id32 <span class="token keyword">struct</span><span class="token punctuation">{<!-- --></span> id <span class="token builtin">int32</span> <span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>id <span class="token operator">*</span>id32<span class="token punctuation">)</span> <span class="token function">idInline</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int32</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> id<span class="token punctuation">.</span>id <span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>id <span class="token operator">*</span>id32<span class="token punctuation">)</span> <span class="token function">idNoInline</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int32</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> id<span class="token punctuation">.</span>id <span class="token punctuation">}</span>

<span class="token keyword">var</span> escapeMePlease <span class="token operator">*</span>id32

<span class="token keyword">func</span> <span class="token function">escapeToHeap</span><span class="token punctuation">(</span>id <span class="token operator">*</span>id32<span class="token punctuation">)</span> identifier <span class="token punctuation">{<!-- --></span>
	escapeMePlease <span class="token operator">=</span> id
	<span class="token keyword">return</span> escapeMePlease
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">BenchmarkMethodCall_direct</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">var</span> myID <span class="token builtin">int32</span>
	b<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">"single/noinline"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		m <span class="token operator">:=</span> <span class="token function">escapeToHeap</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>id32<span class="token punctuation">{<!-- --></span>id<span class="token punctuation">:</span> <span class="token number">6754</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>id32<span class="token punctuation">)</span>
		b<span class="token punctuation">.</span><span class="token function">ResetTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{<!-- --></span>
			myID <span class="token operator">=</span> m<span class="token punctuation">.</span><span class="token function">idNoInline</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			fmt<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span>myID<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>

	b<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">"single/inline"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		m <span class="token operator">:=</span> <span class="token function">escapeToHeap</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>id32<span class="token punctuation">{<!-- --></span>id<span class="token punctuation">:</span> <span class="token number">6754</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>id32<span class="token punctuation">)</span>
		b<span class="token punctuation">.</span><span class="token function">ResetTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{<!-- --></span>
			myID <span class="token operator">=</span> m<span class="token punctuation">.</span><span class="token function">idInline</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			fmt<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span>myID<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">BenchmarkMethodCall_interface</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">var</span> myID <span class="token builtin">int32</span>
	b<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">"single/noinline"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		m <span class="token operator">:=</span> <span class="token function">escapeToHeap</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>id32<span class="token punctuation">{<!-- --></span>id<span class="token punctuation">:</span> <span class="token number">6754</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
		b<span class="token punctuation">.</span><span class="token function">ResetTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{<!-- --></span>
			myID <span class="token operator">=</span> m<span class="token punctuation">.</span><span class="token function">idNoInline</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			fmt<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span>myID<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	b<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">"single/inline"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		m <span class="token operator">:=</span> <span class="token function">escapeToHeap</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>id32<span class="token punctuation">{<!-- --></span>id<span class="token punctuation">:</span> <span class="token number">6754</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
		b<span class="token punctuation">.</span><span class="token function">ResetTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{<!-- --></span>
			myID <span class="token operator">=</span> m<span class="token punctuation">.</span><span class="token function">idInline</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			fmt<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span>myID<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token punctuation">}</span>
</code></pre>
    <p>
     测试命令：
    </p>
    <pre><code class="prism language-shell">$ go <span class="token builtin class-name">test</span> -bench BenchmarkMethodCall_direct/single/inline -cpu<span class="token operator">=</span><span class="token number">1</span> -count<span class="token operator">=</span><span class="token number">5</span> 018_test.go
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>       <span class="token number">20631</span> ns/op
PASS
ok      command-line-arguments  <span class="token number">14</span>.152s
</code></pre>
    <pre><code class="prism language-shell">$ go <span class="token builtin class-name">test</span> -bench BenchmarkMethodCall_direct/single/noinline -cpu<span class="token operator">=</span><span class="token number">1</span> -count<span class="token operator">=</span><span class="token number">5</span> 018_test.go
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>           <span class="token number">20869</span> ns/op
PASS
ok      command-line-arguments  <span class="token number">7</span>.133s
</code></pre>
    <pre><code class="prism language-shell">$ go <span class="token builtin class-name">test</span> -bench BenchmarkMethodCall_interface/single/inline -cpu<span class="token operator">=</span><span class="token number">1</span> -count<span class="token operator">=</span><span class="token number">5</span> 018_test.go
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>            <span class="token number">20198</span> ns/op
PASS
ok      command-line-arguments  <span class="token number">13</span>.932s
</code></pre>
    <pre><code class="prism language-shell">$ go <span class="token builtin class-name">test</span> -bench BenchmarkMethodCall_interface/single/noinline -cpu<span class="token operator">=</span><span class="token number">1</span> -count<span class="token operator">=</span><span class="token number">5</span> 018_test.go
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>           <span class="token number">21178</span> ns/op
PASS
ok      command-line-arguments  <span class="token number">7</span>.070s
</code></pre>
    <pre><code class="prism language-shell">$ go <span class="token builtin class-name">test</span> -bench <span class="token builtin class-name">.</span> -cpu<span class="token operator">=</span><span class="token number">1</span> -count<span class="token operator">=</span><span class="token number">5</span> 018_test.go
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>             <span class="token number">18983</span> ns/op
PASS
ok      command-line-arguments  <span class="token number">28</span>.031s
</code></pre>
    <p>
     <code>
      ns/op
     </code>
     的意思是：ns纳秒/op操作。
    </p>
    <h3>
     <a id="4_1686">
     </a>
     4、参考
    </h3>
    <p>
     官方文档：
     <code>
      https://pkg.go.dev/testing
     </code>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f33303631343334352f:61727469636c652f64657461696c732f313331343435303836" class_="artid" style="display:none">
 </p>
</div>


