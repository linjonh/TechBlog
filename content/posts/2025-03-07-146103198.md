---
layout: post
title: "Flinkæ·±å…¥æµ…å‡ºä¹‹04æ—¶é—´æ°´å°TableSQL"
date: 2025-03-07 23:47:49 +0800
description: "åœ¨Sparkä¸­æœ‰DataFrameè¿™æ ·çš„å…³ç³»å‹ç¼–ç¨‹æ¥å£ï¼Œå› å…¶å¼ºå¤§ä¸”çµæ´»çš„è¡¨è¾¾èƒ½åŠ›ï¼Œèƒ½å¤Ÿè®©ç”¨æˆ·é€šè¿‡éå¸¸ä¸°å¯Œçš„æ¥å£å¯¹æ•°æ®è¿›è¡Œå¤„ç†ï¼Œæœ‰æ•ˆé™ä½äº†ç”¨æˆ·çš„ä½¿ç”¨æˆæœ¬ã€‚Flinkä¹Ÿæä¾›äº†å…³ç³»å‹ç¼–ç¨‹æ¥å£ Table API ä»¥åŠåŸºäºTable API çš„ SQL APIï¼Œè®©ç”¨æˆ·èƒ½å¤Ÿé€šè¿‡ä½¿ç”¨ç»“æ„åŒ–ç¼–ç¨‹æ¥å£é«˜æ•ˆåœ°æ„å»ºFlinkåº”ç”¨ã€‚åŒæ—¶Table API ä»¥åŠ SQL èƒ½å¤Ÿç»Ÿä¸€å¤„ç†æ‰¹é‡å’Œå®æ—¶è®¡ç®—ä¸šåŠ¡ï¼Œæ— é¡»åˆ‡æ¢ä¿®æ”¹ä»»ä½•åº”ç”¨ä»£ç å°±èƒ½å¤ŸåŸºäºåŒä¸€å¥— API ç¼–å†™æµå¼åº”ç”¨å’Œæ‰¹é‡åº”ç”¨ï¼Œä»è€Œè¾¾åˆ°çœŸæ­£æ„ä¹‰çš„æ‰¹æµç»Ÿä¸€ã€‚"
keywords: "Flinkæ·±å…¥æµ…å‡ºä¹‹04ï¼šæ—¶é—´ã€æ°´å°ã€Table&SQL"
categories: ['å¤§æ•°æ®æŠ€æœ¯å­¦ä¹ ']
tags: ['æ•°æ®åº“', 'Sql', 'Flink']
artid: "146103198"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146103198
    alt: "Flinkæ·±å…¥æµ…å‡ºä¹‹04æ—¶é—´æ°´å°TableSQL"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146103198
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146103198
cover: https://bing.ee123.net/img/rand?artid=146103198
image: https://bing.ee123.net/img/rand?artid=146103198
img: https://bing.ee123.net/img/rand?artid=146103198
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Flinkæ·±å…¥æµ…å‡ºä¹‹04ï¼šæ—¶é—´ã€æ°´å°ã€Table&amp;SQL
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h3>
     <a id="FlinkwaterMarkFlink_TableSQL_2">
     </a>
     æ·±å…¥ç†è§£Flinkçš„waterMarkçš„æœºåˆ¶ã€Flink Tableå’ŒSQLå¼€å‘
    </h3>
    <h3>
     <a id="three__6">
     </a>
     3ï¸âƒ£ ç›®æ ‡
    </h3>
    <ol>
     <li>
      æŒæ¡WaterMarkçš„çš„åŸç†
     </li>
     <li>
      æŒæ¡WaterMarkçš„è¿ç”¨
     </li>
     <li>
      æŒæ¡Flink Tableå’ŒSQLå¼€å‘
     </li>
    </ol>
    <h3>
     <a id="four__14">
     </a>
     4ï¸âƒ£ è¦ç‚¹
    </h3>
    <h3>
     <a id="book_1_FlinkTime_16">
     </a>
     ğŸ“– 1. Flinkä¸­çš„Timeæ¦‚å¿µ
    </h3>
    <ul>
     <li>
      <p>
       å¯¹äºæµå¼æ•°æ®å¤„ç†ï¼Œæœ€å¤§çš„ç‰¹ç‚¹æ˜¯æ•°æ®ä¸Šå…·æœ‰æ—¶é—´çš„å±æ€§ç‰¹å¾
      </p>
     </li>
     <li>
      <p>
       Flinkæ ¹æ®æ—¶é—´äº§ç”Ÿçš„ä½ç½®ä¸åŒï¼Œå¯ä»¥å°†æ—¶é—´åŒºåˆ†ä¸ºä¸‰ç§æ—¶é—´æ¦‚å¿µ
      </p>
      <ul>
       <li>
        <mark>
         Event Time
        </mark>
        ï¼ˆäº‹ä»¶ç”Ÿæˆæ—¶é—´ï¼‰
        <ul>
         <li>
          äº‹ä»¶äº§ç”Ÿçš„æ—¶é—´ï¼Œå®ƒé€šå¸¸ç”±äº‹ä»¶ä¸­çš„æ—¶é—´æˆ³æè¿°
         </li>
        </ul>
       </li>
       <li>
        <mark>
         Ingestion time
        </mark>
        ï¼ˆäº‹ä»¶æ¥å…¥æ—¶é—´ï¼‰
        <ul>
         <li>
          äº‹ä»¶è¿›å…¥Flinkç¨‹åºçš„æ—¶é—´
         </li>
        </ul>
       </li>
       <li>
        <mark>
         Processing Time
        </mark>
        ï¼ˆäº‹ä»¶å¤„ç†æ—¶é—´ï¼‰
        <ul>
         <li>
          äº‹ä»¶è¢«å¤„ç†æ—¶å½“å‰ç³»ç»Ÿçš„æ—¶é—´
         </li>
        </ul>
       </li>
      </ul>
     </li>
    </ul>
    <p>
     <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://i-blog.csdnimg.cn/direct/826ec0aef5164a009102259070b97b96.png"/>
    </p>
    <ul>
     <li>
      Flinkåœ¨æµå¤„ç†ç¨‹åºä¸­æ”¯æŒä¸åŒçš„æ—¶é—´æ¦‚å¿µã€‚
     </li>
    </ul>
    <h5>
     <a id="11_EventTime_34">
     </a>
     1.1 EventTime
    </h5>
    <ul>
     <li>
      1ã€äº‹ä»¶ç”Ÿæˆæ—¶çš„æ—¶é—´ï¼Œåœ¨è¿›å…¥Flinkä¹‹å‰å°±å·²ç»å­˜åœ¨ï¼Œå¯ä»¥ä»eventçš„å­—æ®µä¸­æŠ½å–
     </li>
     <li>
      2ã€å¿…é¡»æŒ‡å®šwatermarksï¼ˆæ°´ä½çº¿ï¼‰çš„ç”Ÿæˆæ–¹å¼
     </li>
     <li>
      3ã€ä¼˜åŠ¿ï¼šç¡®å®šæ€§ï¼Œä¹±åºã€å»¶æ—¶ã€æˆ–è€…æ•°æ®é‡æ”¾ç­‰æƒ…å†µï¼Œéƒ½èƒ½ç»™å‡ºæ­£ç¡®çš„ç»“æœ
     </li>
     <li>
      4ã€å¼±ç‚¹ï¼šå¤„ç†æ— åºäº‹ä»¶æ—¶æ€§èƒ½å’Œå»¶è¿Ÿå—åˆ°å½±å“
     </li>
    </ul>
    <h5>
     <a id="12_IngestTime_45">
     </a>
     1.2 IngestTime
    </h5>
    <ul>
     <li>
      1ã€äº‹ä»¶è¿›å…¥flinkçš„æ—¶é—´ï¼Œå³åœ¨sourceé‡Œè·å–çš„å½“å‰ç³»ç»Ÿçš„æ—¶é—´ï¼Œåç»­æ“ä½œç»Ÿä¸€ä½¿ç”¨è¯¥æ—¶é—´ã€‚
     </li>
     <li>
      2ã€ä¸éœ€è¦æŒ‡å®šwatermarksçš„ç”Ÿæˆæ–¹å¼(è‡ªåŠ¨ç”Ÿæˆ)
     </li>
     <li>
      3ã€å¼±ç‚¹ï¼šä¸èƒ½å¤„ç†æ— åºäº‹ä»¶å’Œå»¶è¿Ÿæ•°æ®
     </li>
    </ul>
    <h5>
     <a id="13_ProcessingTime_55">
     </a>
     1.3 ProcessingTime
    </h5>
    <ul>
     <li>
      <p>
       1ã€æ‰§è¡Œæ“ä½œçš„æœºå™¨çš„å½“å‰ç³»ç»Ÿæ—¶é—´(æ¯ä¸ªç®—å­éƒ½ä¸ä¸€æ ·)
      </p>
     </li>
     <li>
      <p>
       2ã€ä¸éœ€è¦æµå’Œæœºå™¨ä¹‹é—´çš„åè°ƒ
      </p>
     </li>
     <li>
      <p>
       3ã€ä¼˜åŠ¿ï¼šæœ€ä½³çš„æ€§èƒ½å’Œæœ€ä½çš„å»¶è¿Ÿ
      </p>
     </li>
     <li>
      <p>
       4ã€å¼±ç‚¹ï¼šä¸ç¡®å®šæ€§ ï¼Œå®¹æ˜“å—åˆ°å„ç§å› ç´ å½±åƒ(eventäº§ç”Ÿçš„é€Ÿåº¦ã€åˆ°è¾¾flinkçš„é€Ÿåº¦ã€åœ¨ç®—å­ä¹‹é—´ä¼ è¾“é€Ÿåº¦ç­‰)ï¼Œå‹æ ¹å°±ä¸ç®¡é¡ºåºå’Œå»¶è¿Ÿ
      </p>
     </li>
    </ul>
    <h5>
     <a id="14__67">
     </a>
     1.4 ä¸‰ç§æ—¶é—´çš„ç»¼åˆæ¯”è¾ƒ
    </h5>
    <ul>
     <li>
      <p>
       æ€§èƒ½
      </p>
      <ul>
       <li>
        ProcessingTime &gt; IngestTime &gt; EventTime
       </li>
      </ul>
     </li>
     <li>
      <p>
       å»¶è¿Ÿ
      </p>
      <ul>
       <li>
        ProcessingTime &lt; IngestTime &lt; EventTime
       </li>
      </ul>
     </li>
     <li>
      <p>
       ç¡®å®šæ€§
      </p>
      <ul>
       <li>
        EventTime &gt; IngestTime &gt; ProcessingTime
       </li>
      </ul>
     </li>
    </ul>
    <h5>
     <a id="15__Time__82">
     </a>
     1.5 è®¾ç½® Time ç±»å‹
    </h5>
    <ul>
     <li>
      <p>
       å¯ä»¥ä½ çš„æµå¤„ç†ç¨‹åºæ˜¯ä»¥å“ªä¸€ç§æ—¶é—´ä¸ºæ ‡å¿—çš„ã€‚
      </p>
      <ul>
       <li>
        åœ¨æˆ‘ä»¬åˆ›å»ºStreamExecutionEnvironmentçš„æ—¶å€™å¯ä»¥è®¾ç½®Timeç±»å‹ï¼Œä¸è®¾ç½®Timeç±»å‹ï¼Œé»˜è®¤æ˜¯ProcessingTimeã€‚
       </li>
       <li>
        å¦‚æœè®¾ç½®Timeç±»å‹ä¸ºEventTimeæˆ–è€…IngestTimeï¼Œéœ€è¦åœ¨åˆ›å»ºStreamExecutionEnvironmentä¸­è°ƒç”¨setStreamTimeCharacteristic() æ–¹æ³•æŒ‡å®šã€‚
       </li>
      </ul>
      <pre><code class="prism language-scala"><span class="token keyword">val</span> environment<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment

<span class="token comment">//ä¸è®¾ç½®Time ç±»å‹ï¼Œé»˜è®¤æ˜¯processingTimeã€‚</span>
environment<span class="token punctuation">.</span>setStreamTimeCharacteristic<span class="token punctuation">(</span>TimeCharacteristic<span class="token punctuation">.</span>ProcessingTime<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//æŒ‡å®šæµå¤„ç†ç¨‹åºä»¥IngestionTimeä¸ºå‡†</span>
<span class="token comment">//environment.setStreamTimeCharacteristic(TimeCharacteristic.IngestionTime);</span>

<span class="token comment">//æŒ‡å®šæµå¤„ç†ç¨‹åºä»¥EventTimeä¸ºå‡†</span>
<span class="token comment">//environment.setStreamTimeCharacteristic(TimeCharacteristic.EventTime);</span>

</code></pre>
     </li>
    </ul>
    <h5>
     <a id="16_ProcessWindowFunction_104">
     </a>
     1.6 ProcessWindowFunctionå®ç°æ—¶é—´ç¡®å®š
    </h5>
    <ul>
     <li>
      <p>
       éœ€æ±‚
      </p>
      <ul>
       <li>
        é€šè¿‡processå®ç°å¤„ç†æ—¶é—´çš„ç¡®å®šï¼ŒåŒ…æ‹¬æ•°æ®æ—¶é—´ã€windowæ—¶é—´ç­‰
       </li>
      </ul>
     </li>
     <li>
      <p>
       ä»£ç å¼€å‘
      </p>
      <pre><code class="prism language-scala"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>time</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang3<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span>FastDateFormat
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span></span>Tuple
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span>function<span class="token punctuation">.</span></span>ProcessWindowFunction
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{<!-- --></span>DataStream<span class="token punctuation">,</span> StreamExecutionEnvironment<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span>Time
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>windows<span class="token punctuation">.</span></span>TimeWindow
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Collector

<span class="token comment">/**
  * é€šè¿‡processå®ç°å¤„ç†æ—¶é—´çš„ç¡®å®šï¼ŒåŒ…æ‹¬æ•°æ®æ—¶é—´ï¼Œwindowæ—¶é—´ç­‰
  */</span>
<span class="token keyword">object</span> TimeWindowWordCount <span class="token punctuation">{<!-- --></span>

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">val</span> environment<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
    <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_

    <span class="token keyword">val</span> socketSource<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> environment<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">"node01"</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span>
     <span class="token comment">//å¯¹æ•°æ®è¿›è¡Œå¤„ç†</span>
    socketSource<span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span>map<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span>keyBy<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span>timeWindow<span class="token punctuation">(</span>Time<span class="token punctuation">.</span>seconds<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>Time<span class="token punctuation">.</span>seconds<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span>process<span class="token punctuation">(</span><span class="token keyword">new</span> SumProcessFunction<span class="token punctuation">)</span>
                <span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>

    environment<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token keyword">class</span> SumProcessFunction <span class="token keyword">extends</span> ProcessWindowFunction<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span><span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span><span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">,</span>Tuple<span class="token punctuation">,</span>TimeWindow<span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span>

  <span class="token keyword">val</span> format<span class="token operator">:</span> FastDateFormat <span class="token operator">=</span> FastDateFormat<span class="token punctuation">.</span>getInstance<span class="token punctuation">(</span><span class="token string">"HH:mm:ss"</span><span class="token punctuation">)</span>

  <span class="token keyword">override</span> <span class="token keyword">def</span> process<span class="token punctuation">(</span>key<span class="token operator">:</span> Tuple<span class="token punctuation">,</span> context<span class="token operator">:</span> Context<span class="token punctuation">,</span> elements<span class="token operator">:</span> Iterable<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> out<span class="token operator">:</span> Collector<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>

    println<span class="token punctuation">(</span><span class="token string">"å½“å‰ç³»ç»Ÿæ—¶é—´ä¸ºï¼š"</span><span class="token operator">+</span>format<span class="token punctuation">.</span>format<span class="token punctuation">(</span>System<span class="token punctuation">.</span>currentTimeMillis<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    println<span class="token punctuation">(</span><span class="token string">"windowçš„å¤„ç†æ—¶é—´ä¸ºï¼š"</span><span class="token operator">+</span>format<span class="token punctuation">.</span>format<span class="token punctuation">(</span>context<span class="token punctuation">.</span>currentProcessingTime<span class="token punctuation">)</span><span class="token punctuation">)</span>
    println<span class="token punctuation">(</span><span class="token string">"windowçš„å¼€å§‹æ—¶é—´ä¸ºï¼š"</span><span class="token operator">+</span>format<span class="token punctuation">.</span>format<span class="token punctuation">(</span>context<span class="token punctuation">.</span>window<span class="token punctuation">.</span>getStart<span class="token punctuation">)</span><span class="token punctuation">)</span>
    println<span class="token punctuation">(</span><span class="token string">"windowçš„ç»“æŸæ—¶é—´ä¸ºï¼š"</span><span class="token operator">+</span>format<span class="token punctuation">.</span>format<span class="token punctuation">(</span>context<span class="token punctuation">.</span>window<span class="token punctuation">.</span>getEnd<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">var</span> sum<span class="token operator">:</span><span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>eachElement <span class="token keyword">&lt;-</span> elements<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
      sum <span class="token operator">+=</span> eachElement<span class="token punctuation">.</span>_2
    <span class="token punctuation">}</span>
    out<span class="token punctuation">.</span>collect<span class="token punctuation">(</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span>getField<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>sum<span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre>
     </li>
    </ul>
    <h3>
     <a id="book_2_Watermark_172">
     </a>
     ğŸ“– 2. Watermarkæœºåˆ¶
    </h3>
    <h5>
     <a id="21_Watermark_174">
     </a>
     2.1 Watermarkçš„æ¦‚å¿µ
    </h5>
    <pre><code>   é€šå¸¸æƒ…å†µä¸‹ç”±äºç½‘ç»œæˆ–è€…ç³»ç»Ÿç­‰å¤–éƒ¨å› ç´ å½±å“ä¸‹ï¼Œ
   äº‹ä»¶æ•°æ®å¾€å¾€ä¸èƒ½åŠæ—¶ä¼ è¾“è‡³FLinkç³»ç»Ÿä¸­ï¼Œ
   å¯¼è‡´ç³»ç»Ÿçš„ä¸ç¨³å®šè€Œé€ æˆæ•°æ®ä¹±åºåˆ°è¾¾æˆ–è€…å»¶è¿Ÿè¾¾åˆ°ç­‰é—®é¢˜ï¼Œ
   å› æ­¤éœ€è¦æœ‰ä¸€ç§æœºåˆ¶èƒ½å¤Ÿæ§åˆ¶æ•°æ®å¤„ç†çš„è¿›åº¦ã€‚
   
   å…·ä½“æ¥è®²ï¼Œåœ¨åˆ›å»ºä¸€ä¸ªåŸºäºæ—¶é—´çš„windowåï¼Œéœ€è¦ç¡®å®šå±äºè¯¥windowçš„æ•°æ®å…ƒç´ æ˜¯å¦å·²ç»å…¨éƒ¨åˆ°è¾¾ï¼Œ
   ç¡®å®šåæ‰å¯ä»¥å¯¹windowä¸­çš„æ‰€æœ‰æ•°æ®åšè®¡ç®—å¤„ç†ï¼ˆå¦‚æ±‡æ€»ã€åˆ†ç»„ï¼‰ï¼Œ
   å¦‚æœæ•°æ®å¹¶æ²¡æœ‰å…¨éƒ¨åˆ°è¾¾ï¼Œåˆ™ç»§ç»­ç­‰å¾…è¯¥çª—å£çš„æ•°æ®å…¨éƒ¨åˆ°è¾¾åå†å¼€å§‹è®¡ç®—ã€‚
	
   ä½†æ˜¯å¯¹äºä½†æ˜¯å¯¹äºlate elementï¼Œæˆ‘ä»¬åˆä¸èƒ½æ— é™æœŸçš„ç­‰ä¸‹å»ï¼Œå¿…é¡»è¦æœ‰ä¸ªæœºåˆ¶æ¥ä¿è¯ä¸€ä¸ªç‰¹å®šçš„æ—¶é—´åï¼Œå¿…é¡»è§¦å‘windowå»è¿›è¡Œè®¡ç®—äº†ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹å°±éœ€è¦ç”¨åˆ°æ°´ä½çº¿ (Watermark) æœºåˆ¶ã€‚

</code></pre>
    <h5>
     <a id="22_Watermark_192">
     </a>
     2.2 Watermarkçš„ä½œç”¨
    </h5>
    <pre><code>    å®ƒèƒ½å¤Ÿè¡¡é‡æ•°æ®å¤„ç†è¿›åº¦ï¼Œä¿è¯äº‹ä»¶æ•°æ®å…¨éƒ¨åˆ°è¾¾Flinkç³»ç»Ÿï¼Œå³ä½¿æ•°æ®ä¹±åºæˆ–è€…å»¶è¿Ÿåˆ°è¾¾ï¼Œä¹Ÿèƒ½å¤Ÿåƒé¢„æœŸä¸€æ ·è®¡ç®—å‡ºæ­£ç¡®å’Œè¿ç»­çš„ç»“æœã€‚é€šå¸¸watermarkæ˜¯ç»“åˆwindowæ¥å®ç°ã€‚
</code></pre>
    <h5>
     <a id="23_Watermark_200">
     </a>
     2.3 Watermarkçš„åŸç†
    </h5>
    <pre><code>   åœ¨ Flink çš„çª—å£å¤„ç†è¿‡ç¨‹ä¸­ï¼Œå¦‚æœç¡®å®šå…¨éƒ¨æ•°æ®åˆ°è¾¾ï¼Œå°±å¯ä»¥å¯¹ Window çš„æ‰€æœ‰æ•°æ®åšçª—å£è®¡ç®—æ“ä½œï¼ˆå¦‚æ±‡æ€»ã€åˆ†ç»„ç­‰ï¼‰ï¼Œ
   å¦‚æœæ•°æ®æ²¡æœ‰å…¨éƒ¨åˆ°è¾¾ï¼Œåˆ™ç»§ç»­ç­‰å¾…è¯¥çª—å£ä¸­çš„æ•°æ®å…¨éƒ¨åˆ°è¾¾æ‰å¼€å§‹å¤„ç†ã€‚
   è¿™ç§æƒ…å†µä¸‹å°±éœ€è¦ç”¨åˆ°æ°´ä½çº¿ï¼ˆWaterMarksï¼‰æœºåˆ¶ï¼Œå®ƒèƒ½å¤Ÿè¡¡é‡æ•°æ®å¤„ç†è¿›åº¦ï¼ˆè¡¨è¾¾æ•°æ®åˆ°è¾¾çš„å®Œæ•´æ€§ï¼‰ï¼Œ
   ä¿è¯äº‹ä»¶æ•°æ®ï¼ˆå…¨éƒ¨ï¼‰åˆ°è¾¾Flinkç³»ç»Ÿï¼Œ
   æˆ–è€…åœ¨ä¹±åºåŠå»¶è¿Ÿåˆ°è¾¾æ—¶ï¼Œ
   ä¹Ÿèƒ½å¤Ÿåƒé¢„æœŸä¸€æ ·è®¡ç®—å‡ºæ­£ç¡®å¹¶ä¸”è¿ç»­çš„ç»“æœã€‚
   å½“ä»»ä½• Event è¿›å…¥åˆ° Flink ç³»ç»Ÿæ—¶ï¼Œä¼šæ ¹æ®å½“å‰æœ€å¤§äº‹ä»¶æ—¶é—´äº§ç”Ÿ Watermarks æ—¶é—´æˆ³ã€‚ 
   
</code></pre>
    <ul>
     <li>
      <p>
       é‚£ä¹ˆ Flink æ˜¯æ€ä¹ˆè®¡ç®— Watermark çš„å€¼å‘¢ï¼Ÿ
       <br/>
       â­ï¸
      </p>
      <ul>
       <li>
        <mark>
         Watermark = è¿›å…¥ Flink çš„æœ€å¤§çš„äº‹ä»¶äº§ç”Ÿæ—¶é—´ï¼ˆmaxEventTimeï¼‰â€” æŒ‡å®šçš„ä¹±åºæ—¶é—´ï¼ˆtï¼‰
        </mark>
       </li>
      </ul>
     </li>
     <li>
      <p>
       <mark>
        é‚£ä¹ˆæœ‰ Watermark çš„ Window æ˜¯æ€ä¹ˆè§¦å‘çª—å£å‡½æ•°çš„å‘¢ï¼Ÿ
       </mark>
      </p>
     </li>
    </ul>
    <blockquote>
     <p>
      ï¼ˆ1ï¼‰ watermark &gt;= windowçš„ç»“æŸæ—¶é—´
      <br/>
      ï¼ˆ2ï¼‰ è¯¥çª—å£å¿…é¡»æœ‰æ•°æ® æ³¨æ„ï¼š[window_start_time,window_end_time) ä¸­æœ‰æ•°æ®å­˜åœ¨ï¼Œå‰é—­åå¼€åŒºé—´
     </p>
    </blockquote>
    <ul>
     <li>
      <mark>
       æ³¨æ„
      </mark>
      ï¼šWatermark æœ¬è´¨å¯ä»¥ç†è§£æˆä¸€ä¸ªå»¶è¿Ÿè§¦å‘æœºåˆ¶ã€‚
     </li>
    </ul>
    <h5>
     <a id="24_Watermark__226">
     </a>
     2.4 Watermark çš„ä½¿ç”¨å­˜åœ¨ä¸‰ç§æƒ…å†µ
    </h5>
    <ul>
     <li>
      <p>
       ï¼ˆ1ï¼‰æœ‰åºçš„æ•°æ®æµä¸­çš„watermark
      </p>
      <pre><code>	å¦‚æœæ•°æ®å…ƒç´ çš„äº‹ä»¶æ—¶é—´æ˜¯æœ‰åºçš„ï¼ŒWatermark æ—¶é—´æˆ³ä¼šéšç€æ•°æ®å…ƒç´ çš„äº‹ä»¶æ—¶é—´æŒ‰é¡ºåºç”Ÿæˆï¼Œ
	æ­¤æ—¶æ°´ä½çº¿çš„å˜åŒ–å’Œäº‹ä»¶æ—¶é—´ä¿æŒä¸€ç›´ï¼ˆå› ä¸ºæ—¢ç„¶æ˜¯æœ‰åºçš„æ—¶é—´ï¼Œå°±ä¸éœ€è¦è®¾ç½®å»¶è¿Ÿäº†ï¼Œé‚£ä¹ˆ t å°±æ˜¯ 0ã€‚
	æ‰€ä»¥ watermark=maxtime-0 = maxtimeï¼‰ï¼Œä¹Ÿå°±æ˜¯ç†æƒ³çŠ¶æ€ä¸‹çš„æ°´ä½çº¿ã€‚
	å½“ Watermark æ—¶é—´å¤§äº Windows ç»“æŸæ—¶é—´å°±ä¼šè§¦å‘å¯¹ Windows çš„æ•°æ®è®¡ç®—ï¼Œ
	ä»¥æ­¤ç±»æ¨ï¼Œ ä¸‹ä¸€ä¸ª Window ä¹Ÿæ˜¯ä¸€æ ·ã€‚
</code></pre>
      <p>
       <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://i-blog.csdnimg.cn/direct/30c7be7e2e93440f83d22481cf7a7500.png"/>
      </p>
     </li>
     <li>
      <p>
       ï¼ˆ2ï¼‰ä¹±åºçš„æ•°æ®æµwatermark
      </p>
      <pre><code>	ç°å®æƒ…å†µä¸‹æ•°æ®å…ƒç´ å¾€å¾€å¹¶ä¸æ˜¯æŒ‰ç…§å…¶äº§ç”Ÿé¡ºåºæ¥å…¥åˆ° Flink ç³»ç»Ÿä¸­è¿›è¡Œå¤„ç†ï¼Œ
	è€Œé¢‘ç¹å‡ºç°ä¹±åºæˆ–è¿Ÿåˆ°çš„æƒ…å†µï¼Œè¿™ç§æƒ…å†µå°±éœ€è¦ä½¿ç”¨ Watermarks æ¥åº”å¯¹ã€‚
	æ¯”å¦‚ä¸‹å›¾ï¼Œè®¾ç½®å»¶è¿Ÿæ—¶é—´tä¸º2ã€‚
</code></pre>
      <p>
       <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://i-blog.csdnimg.cn/direct/0e2bafa323b143aea4da02e3d4d59a5c.png"/>
      </p>
     </li>
     <li>
      <p>
       ï¼ˆ3ï¼‰å¹¶è¡Œæ•°æ®æµä¸­çš„ Watermark
      </p>
      <pre><code>	åœ¨å¤šå¹¶è¡Œåº¦çš„æƒ…å†µä¸‹ï¼ŒWatermark ä¼šæœ‰ä¸€ä¸ªå¯¹é½æœºåˆ¶ï¼Œè¿™ä¸ªå¯¹é½æœºåˆ¶ä¼šå–æ‰€æœ‰ Channel ä¸­æœ€å°çš„ Watermarkã€‚
</code></pre>
      <p>
       <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://i-blog.csdnimg.cn/direct/f221cedd57984ffca69ade8583883606.png"/>
      </p>
     </li>
    </ul>
    <h5>
     <a id="25_watermarkeventtime_261">
     </a>
     2.5 å¼•å…¥watermarkå’Œeventtime
    </h5>
    <h6>
     <a id="251__Watermark__EventTime_263">
     </a>
     2.5.1 æœ‰åºæ•°æ®æµä¸­å¼•å…¥ Watermark å’Œ EventTime
    </h6>
    <ul>
     <li>
      <p>
       å®ƒä¼šå°†æ•°æ®ä¸­çš„timestampæ ¹æ®æŒ‡å®šçš„å­—æ®µæå–å¾—åˆ°Eventtimeï¼Œç„¶åä½¿ç”¨Eventtimeä½œä¸ºæœ€æ–°çš„watermark, è¿™ç§é€‚åˆäºäº‹ä»¶æŒ‰é¡ºåºç”Ÿæˆï¼Œæ²¡æœ‰ä¹±åºäº‹ä»¶çš„æƒ…å†µã€‚
      </p>
     </li>
     <li>
      <p>
       å¯¹äºæœ‰åºçš„æ•°æ®ï¼Œä»£ç æ¯”è¾ƒç®€æ´ï¼Œä¸»è¦éœ€è¦ä»æº Event ä¸­æŠ½å– EventTimeã€‚
      </p>
     </li>
     <li>
      <p>
       éœ€æ±‚
      </p>
      <ul>
       <li>
        å¯¹socketä¸­æœ‰åºï¼ˆæŒ‰ç…§æ—¶é—´é€’å¢ï¼‰çš„æ•°æ®æµï¼Œè¿›è¡Œæ¯5så¤„ç†ä¸€æ¬¡
       </li>
      </ul>
     </li>
     <li>
      <p>
       ä»£ç æ¼”ç¤º
      </p>
     </li>
    </ul>
    <pre><code class="prism language-scala"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>watermark</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang3<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span>FastDateFormat
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token punctuation">{<!-- --></span>MapFunction<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span></span>Tuple
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span>TimeCharacteristic
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span>function<span class="token punctuation">.</span></span>ProcessWindowFunction
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{<!-- --></span>DataStream<span class="token punctuation">,</span> StreamExecutionEnvironment<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span>Time
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>windows<span class="token punctuation">.</span></span>TimeWindow
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Collector

<span class="token keyword">object</span> OrderedStreamWaterMark <span class="token punctuation">{<!-- --></span>

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>

      <span class="token comment">//todo:1.æ„å»ºæµå¼å¤„ç†ç¯å¢ƒ</span>
      <span class="token keyword">val</span> environment<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
      <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_
      environment<span class="token punctuation">.</span>setParallelism<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

     <span class="token comment">//todo:2.è®¾ç½®æ—¶é—´ç±»å‹</span>
     environment<span class="token punctuation">.</span>setStreamTimeCharacteristic<span class="token punctuation">(</span>TimeCharacteristic<span class="token punctuation">.</span>EventTime<span class="token punctuation">)</span>

    <span class="token comment">//todo:3.è·å–æ•°æ®æº</span>
      <span class="token keyword">val</span> sourceStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> environment<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">"node01"</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span>

    <span class="token comment">//todo:4. æ•°æ®å¤„ç†</span>
      <span class="token keyword">val</span> mapStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> sourceStream<span class="token punctuation">.</span>map<span class="token punctuation">(</span>x<span class="token keyword">=&gt;</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toLong<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment">//todo: 5.ä»æºEventä¸­æŠ½å–eventTime</span>
        <span class="token keyword">val</span> watermarkStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> mapStream<span class="token punctuation">.</span>assignAscendingTimestamps<span class="token punctuation">(</span>x<span class="token keyword">=&gt;</span>x<span class="token punctuation">.</span>_2<span class="token punctuation">)</span>


    <span class="token comment">//todo:6. æ•°æ®è®¡ç®—</span>
     watermarkStream<span class="token punctuation">.</span>keyBy<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span>timeWindow<span class="token punctuation">(</span>Time<span class="token punctuation">.</span>seconds<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span>process<span class="token punctuation">(</span><span class="token keyword">new</span> ProcessWindowFunction<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span><span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">,</span>Tuple<span class="token punctuation">,</span>TimeWindow<span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">override</span> <span class="token keyword">def</span> process<span class="token punctuation">(</span>key<span class="token operator">:</span> Tuple<span class="token punctuation">,</span> context<span class="token operator">:</span> Context<span class="token punctuation">,</span> elements<span class="token operator">:</span> Iterable<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> out<span class="token operator">:</span> Collector<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>

                          <span class="token keyword">val</span> value<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> key<span class="token punctuation">.</span>getField<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

                          <span class="token comment">//çª—å£çš„å¼€å§‹æ—¶é—´</span>
                          <span class="token keyword">val</span> startTime<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>window<span class="token punctuation">.</span>getStart
                          <span class="token comment">//çª—å£çš„ç»“æŸæ—¶é—´</span>
                          <span class="token keyword">val</span> startEnd<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>window<span class="token punctuation">.</span>getEnd

                          <span class="token comment">//è·å–å½“å‰çš„ watermark</span>
                          <span class="token keyword">val</span> watermark<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>currentWatermark

                          <span class="token keyword">var</span> sum<span class="token operator">:</span><span class="token builtin">Long</span> <span class="token operator">=</span> <span class="token number">0</span>
                          <span class="token keyword">val</span> toList<span class="token operator">:</span> List<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> elements<span class="token punctuation">.</span>toList
                          <span class="token keyword">for</span><span class="token punctuation">(</span>eachElement <span class="token keyword">&lt;-</span>  toList<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                            sum <span class="token operator">+=</span><span class="token number">1</span>
                          <span class="token punctuation">}</span>


                          println<span class="token punctuation">(</span><span class="token string">"çª—å£çš„æ•°æ®æ¡æ•°:"</span><span class="token operator">+</span>sum<span class="token operator">+</span>
                            <span class="token string">" |çª—å£çš„ç¬¬ä¸€æ¡æ•°æ®ï¼š"</span><span class="token operator">+</span>toList<span class="token punctuation">.</span>head<span class="token operator">+</span>
                            <span class="token string">" |çª—å£çš„æœ€åä¸€æ¡æ•°æ®ï¼š"</span><span class="token operator">+</span>toList<span class="token punctuation">.</span>last<span class="token operator">+</span>
                            <span class="token string">" |çª—å£çš„å¼€å§‹æ—¶é—´ï¼š "</span><span class="token operator">+</span> startTime<span class="token operator">+</span>
                            <span class="token string">" |çª—å£çš„ç»“æŸæ—¶é—´ï¼š "</span><span class="token operator">+</span> startEnd<span class="token operator">+</span>
                            <span class="token string">" |å½“å‰çš„watermark:"</span><span class="token operator">+</span> watermark<span class="token punctuation">)</span>

                          out<span class="token punctuation">.</span>collect<span class="token punctuation">(</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span>sum<span class="token punctuation">)</span><span class="token punctuation">)</span>

                        <span class="token punctuation">}</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>

    environment<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre>
    <ul>
     <li>
      å‘é€æ•°æ®
     </li>
    </ul>
    <pre><code>000001,1461756862000
000001,1461756866000
000001,1461756872000
000001,1461756873000
000001,1461756874000
000001,1461756875000
</code></pre>
    <h6>
     <a id="252__Watermark__EventTime_363">
     </a>
     2.5.2 ä¹±åºæ•°æ®æµä¸­å¼•å…¥ Watermark å’Œ EventTime
    </h6>
    <p>
     å¯¹äºä¹±åºæ•°æ®æµï¼Œæœ‰ä¸¤ç§å¸¸è§çš„å¼•å…¥æ–¹æ³•ï¼šå‘¨æœŸæ€§å’Œé—´æ–­æ€§
    </p>
    <ul>
     <li>
      <p>
       1ã€With Periodicï¼ˆå‘¨æœŸæ€§çš„ï¼‰ Watermark
      </p>
      <pre><code>	å‘¨æœŸæ€§åœ°ç”Ÿæˆ Watermark çš„ç”Ÿæˆï¼Œé»˜è®¤æ˜¯ 100msã€‚æ¯éš” N æ¯«ç§’è‡ªåŠ¨å‘æµé‡Œæ³¨å…¥ä¸€ä¸ª Watermarkï¼Œæ—¶é—´é—´éš”ç”± streamEnv.getConfig.setAutoWatermarkInterval()å†³å®šã€‚
</code></pre>
      <ul>
       <li>
        éœ€æ±‚
        <ul>
         <li>
          å¯¹socketä¸­æ— åºæ•°æ®æµï¼Œè¿›è¡Œæ¯5så¤„ç†ä¸€æ¬¡ï¼Œæ•°æ®ä¸­ä¼šæœ‰å»¶è¿Ÿ
         </li>
        </ul>
       </li>
       <li>
        ä»£ç æ¼”ç¤º
       </li>
      </ul>
      <pre><code class="prism language-scala"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>watermark</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span></span>Tuple
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span>TimeCharacteristic
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span>AssignerWithPeriodicWatermarks
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{<!-- --></span>DataStream<span class="token punctuation">,</span> StreamExecutionEnvironment<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span>function<span class="token punctuation">.</span></span>ProcessWindowFunction
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>watermark<span class="token punctuation">.</span></span>Watermark
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span>Time
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>windows<span class="token punctuation">.</span></span>TimeWindow
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Collector
  <span class="token comment">//å¯¹æ— åºçš„æ•°æ®æµå‘¨æœŸæ€§çš„æ·»åŠ æ°´å°</span>
  <span class="token keyword">object</span> OutOfOrderStreamPeriodicWaterMark <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
         <span class="token comment">//todo:1.æ„å»ºæµå¼å¤„ç†ç¯å¢ƒ</span>
    <span class="token keyword">val</span> environment<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
    <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_
    environment<span class="token punctuation">.</span>setParallelism<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
         <span class="token comment">//todo:2.è®¾ç½®æ—¶é—´ç±»å‹</span>
   environment<span class="token punctuation">.</span>setStreamTimeCharacteristic<span class="token punctuation">(</span>TimeCharacteristic<span class="token punctuation">.</span>EventTime<span class="token punctuation">)</span>

  <span class="token comment">//todo:3.è·å–æ•°æ®æº</span>
    <span class="token keyword">val</span> sourceStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> environment<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">"node01"</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span>

  <span class="token comment">//todo:4. æ•°æ®å¤„ç†</span>
    <span class="token keyword">val</span> mapStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> sourceStream<span class="token punctuation">.</span>map<span class="token punctuation">(</span>x<span class="token keyword">=&gt;</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toLong<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment">//todo:5. æ·»åŠ æ°´ä½çº¿</span>
  mapStream<span class="token punctuation">.</span>assignTimestampsAndWatermarks<span class="token punctuation">(</span>
      <span class="token keyword">new</span> AssignerWithPeriodicWatermarks<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>

      <span class="token comment">//å®šä¹‰å»¶è¿Ÿæ—¶é—´é•¿åº¦</span>
      <span class="token comment">//è¡¨ç¤ºåœ¨5ç§’ä»¥å†…çš„æ•°æ®å»¶æ—¶æœ‰æ•ˆï¼Œè¶…è¿‡5ç§’çš„æ•°æ®è¢«è®¤å®šä¸ºè¿Ÿåˆ°äº‹ä»¶</span>

      <span class="token keyword">val</span> maxOutOfOrderness<span class="token operator">=</span><span class="token number">5000L</span>
      <span class="token comment">//å†å²æœ€å¤§äº‹ä»¶æ—¶é—´</span>
      <span class="token keyword">var</span> currentMaxTimestamp<span class="token operator">:</span><span class="token builtin">Long</span><span class="token operator">=</span>_

      <span class="token keyword">var</span> watermark<span class="token operator">:</span>Watermark<span class="token operator">=</span>_

       <span class="token comment">//å‘¨æœŸæ€§çš„ç”Ÿæˆæ°´ä½çº¿watermark</span>
      <span class="token keyword">override</span> <span class="token keyword">def</span> getCurrentWatermark<span class="token operator">:</span> Watermark <span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
        watermark <span class="token operator">=</span>  <span class="token keyword">new</span> Watermark<span class="token punctuation">(</span>currentMaxTimestamp <span class="token operator">-</span>maxOutOfOrderness<span class="token punctuation">)</span>
        watermark
      <span class="token punctuation">}</span>

      <span class="token comment">//æŠ½å–äº‹ä»¶æ—¶é—´</span>
      <span class="token keyword">override</span> <span class="token keyword">def</span> extractTimestamp<span class="token punctuation">(</span>element<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">,</span> previousElementTimestamp<span class="token operator">:</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
          <span class="token comment">//è·å–äº‹ä»¶æ—¶é—´</span>
          <span class="token keyword">val</span> currentElementEventTime<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> element<span class="token punctuation">.</span>_2

          <span class="token comment">//å¯¹æ¯”å½“å‰äº‹ä»¶æ—¶é—´å’Œå†å²æœ€å¤§äº‹ä»¶æ—¶é—´, å°†è¾ƒå¤§å€¼é‡æ–°èµ‹å€¼ç»™currentMaxTimestamp</span>
          currentMaxTimestamp<span class="token operator">=</span>Math<span class="token punctuation">.</span>max<span class="token punctuation">(</span>currentMaxTimestamp<span class="token punctuation">,</span>currentElementEventTime<span class="token punctuation">)</span>
          println<span class="token punctuation">(</span><span class="token string">"æ¥å—åˆ°çš„äº‹ä»¶ï¼š"</span><span class="token operator">+</span>element<span class="token operator">+</span><span class="token string">" |äº‹ä»¶æ—¶é—´ï¼š "</span><span class="token operator">+</span>currentElementEventTime<span class="token punctuation">)</span>

          currentElementEventTime
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span>keyBy<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span>timeWindow<span class="token punctuation">(</span>Time<span class="token punctuation">.</span>seconds<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span>process<span class="token punctuation">(</span><span class="token keyword">new</span> ProcessWindowFunction<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span><span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">,</span>Tuple<span class="token punctuation">,</span>TimeWindow<span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">override</span> <span class="token keyword">def</span> process<span class="token punctuation">(</span>key<span class="token operator">:</span> Tuple<span class="token punctuation">,</span> context<span class="token operator">:</span> Context<span class="token punctuation">,</span> elements<span class="token operator">:</span> Iterable<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> out<span class="token operator">:</span> Collector<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
       <span class="token keyword">val</span> value<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> key<span class="token punctuation">.</span>getField<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
           <span class="token comment">//çª—å£çš„å¼€å§‹æ—¶é—´</span>
            <span class="token keyword">val</span> startTime<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>window<span class="token punctuation">.</span>getStart
            <span class="token comment">//çª—å£çš„ç»“æŸæ—¶é—´</span>
            <span class="token keyword">val</span> startEnd<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>window<span class="token punctuation">.</span>getEnd

            <span class="token comment">//è·å–å½“å‰çš„ watermark</span>
            <span class="token keyword">val</span> watermark<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>currentWatermark

            <span class="token keyword">var</span> sum<span class="token operator">:</span><span class="token builtin">Long</span> <span class="token operator">=</span> <span class="token number">0</span>
            <span class="token keyword">val</span> toList<span class="token operator">:</span> List<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> elements<span class="token punctuation">.</span>toList
            <span class="token keyword">for</span><span class="token punctuation">(</span>eachElement <span class="token keyword">&lt;-</span>  toList<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
              sum <span class="token operator">+=</span><span class="token number">1</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//çª—å£çš„å¼€å§‹æ—¶é—´</span>
            <span class="token keyword">val</span> startTime<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>window<span class="token punctuation">.</span>getStart
            <span class="token comment">//çª—å£çš„ç»“æŸæ—¶é—´</span>
            <span class="token keyword">val</span> startEnd<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>window<span class="token punctuation">.</span>getEnd

            <span class="token comment">//è·å–å½“å‰çš„ watermark</span>
            <span class="token keyword">val</span> watermark<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>currentWatermark

            <span class="token keyword">var</span> sum<span class="token operator">:</span><span class="token builtin">Long</span> <span class="token operator">=</span> <span class="token number">0</span>
            <span class="token keyword">val</span> toList<span class="token operator">:</span> List<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> elements<span class="token punctuation">.</span>toList
            <span class="token keyword">for</span><span class="token punctuation">(</span>eachElement <span class="token keyword">&lt;-</span>  toList<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
              sum <span class="token operator">+=</span><span class="token number">1</span>
            <span class="token punctuation">}</span>  
            println<span class="token punctuation">(</span><span class="token string">"çª—å£çš„æ•°æ®æ¡æ•°:"</span><span class="token operator">+</span>sum<span class="token operator">+</span>
              <span class="token string">" |çª—å£çš„ç¬¬ä¸€æ¡æ•°æ®ï¼š"</span><span class="token operator">+</span>toList<span class="token punctuation">.</span>head<span class="token operator">+</span>
              <span class="token string">" |çª—å£çš„æœ€åä¸€æ¡æ•°æ®ï¼š"</span><span class="token operator">+</span>toList<span class="token punctuation">.</span>last<span class="token operator">+</span>
              <span class="token string">" |çª—å£çš„å¼€å§‹æ—¶é—´ï¼š "</span><span class="token operator">+</span>  startTime <span class="token operator">+</span>
              <span class="token string">" |çª—å£çš„ç»“æŸæ—¶é—´ï¼š "</span><span class="token operator">+</span> startEnd<span class="token operator">+</span>
              <span class="token string">" |å½“å‰çš„watermark:"</span><span class="token operator">+</span>watermark<span class="token punctuation">)</span>

            out<span class="token punctuation">.</span>collect<span class="token punctuation">(</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span>sum<span class="token punctuation">)</span><span class="token punctuation">)</span>

          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>       
       environment<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span> 
    <span class="token punctuation">}</span>  
  <span class="token punctuation">}</span>     
</code></pre>
      <ul>
       <li>
        å‘é€æ•°æ®
       </li>
      </ul>
      <pre><code>000001,1461756862000
000001,1461756872000
000001,1461756866000
000001,1461756873000
000001,1461756874000
000001,1461756875000
000001,1461756879000
000001,1461756880000
</code></pre>
     </li>
     <li>
      <p>
       2ã€With Punctuatedï¼ˆé—´æ–­æ€§çš„ï¼‰ Watermark
      </p>
      <pre><code>  é—´æ–­æ€§çš„ç”Ÿæˆ Watermark ä¸€èˆ¬æ˜¯åŸºäºæŸäº›äº‹ä»¶è§¦å‘ Watermark çš„ç”Ÿæˆå’Œå‘é€ã€‚
  æ¯”å¦‚è¯´åªç»™ç”¨æˆ·idä¸º000001çš„æ·»åŠ watermarkï¼Œå…¶ä»–çš„ç”¨æˆ·å°±ä¸æ·»åŠ 
</code></pre>
      <ul>
       <li>
        <p>
         éœ€æ±‚
        </p>
        <ul>
         <li>
          å¯¹socketä¸­æ— åºæ•°æ®æµï¼Œè¿›è¡Œæ¯5så¤„ç†ä¸€æ¬¡ï¼Œæ•°æ®ä¸­ä¼šæœ‰å»¶è¿Ÿ
         </li>
        </ul>
       </li>
       <li>
        <p>
         ä»£ç æ¼”ç¤º
        </p>
       </li>
      </ul>
      <pre><code class="prism language-scala">  <span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>watermark</span>

        <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang3<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span>FastDateFormat
        <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span>MapFunction
        <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span></span>Tuple
        <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span>TimeCharacteristic
        <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token punctuation">{<!-- --></span>AssignerWithPeriodicWatermarks<span class="token punctuation">,</span> AssignerWithPunctuatedWatermarks<span class="token punctuation">}</span>
        <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{<!-- --></span>DataStream<span class="token punctuation">,</span> StreamExecutionEnvironment<span class="token punctuation">}</span>
        <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span>function<span class="token punctuation">.</span></span>ProcessWindowFunction
        <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>watermark<span class="token punctuation">.</span></span>Watermark
        <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span>Time
        <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>windows<span class="token punctuation">.</span></span>TimeWindow
        <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Collector

        <span class="token comment">//å¯¹æ— åºçš„æ•°æ®æµé—´æ–­æ€§çš„æ·»åŠ æ°´å°</span>
        <span class="token keyword">object</span> OutOfOrderStreamPunctuatedWaterMark <span class="token punctuation">{<!-- --></span>

          <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
                      <span class="token comment">//todo:1.æ„å»ºæµå¼å¤„ç†ç¯å¢ƒ</span>
              <span class="token keyword">val</span> environment<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
              <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_
              environment<span class="token punctuation">.</span>setParallelism<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
                      <span class="token comment">//todo:2.è®¾ç½®æ—¶é—´ç±»å‹</span>
              environment<span class="token punctuation">.</span>setStreamTimeCharacteristic<span class="token punctuation">(</span>TimeCharacteristic<span class="token punctuation">.</span>EventTime<span class="token punctuation">)</span>
      
              <span class="token comment">//todo:3.è·å–æ•°æ®æº</span>
              <span class="token keyword">val</span> sourceStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> environment<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">"node01"</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span>
      
              <span class="token comment">//todo:4. æ•°æ®å¤„ç†</span>
              <span class="token keyword">val</span> mapStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> sourceStream<span class="token punctuation">.</span>map<span class="token punctuation">(</span>x<span class="token keyword">=&gt;</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toLong<span class="token punctuation">)</span><span class="token punctuation">)</span>
                      <span class="token comment">//todo:5. æ·»åŠ æ°´ä½çº¿</span>
              mapStream<span class="token punctuation">.</span>assignTimestampsAndWatermarks<span class="token punctuation">(</span>
                <span class="token keyword">new</span> AssignerWithPunctuatedWatermarks<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>
      
                  <span class="token comment">//å®šä¹‰å»¶è¿Ÿæ—¶é—´é•¿åº¦</span>
                  <span class="token comment">//è¡¨ç¤ºåœ¨5ç§’ä»¥å†…çš„æ•°æ®å»¶æ—¶æœ‰æ•ˆï¼Œè¶…è¿‡5ç§’çš„æ•°æ®è¢«è®¤å®šä¸ºè¿Ÿåˆ°äº‹ä»¶</span>
                  <span class="token keyword">val</span> maxOutOfOrderness<span class="token operator">=</span><span class="token number">5000L</span>
                  <span class="token comment">//å†å²æœ€å¤§äº‹ä»¶æ—¶é—´</span>
                  <span class="token keyword">var</span> currentMaxTimestamp<span class="token operator">:</span><span class="token builtin">Long</span><span class="token operator">=</span>_
      
                  <span class="token keyword">override</span> <span class="token keyword">def</span> checkAndGetNextWatermark<span class="token punctuation">(</span>lastElement<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">,</span> extractedTimestamp<span class="token operator">:</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token operator">:</span> Watermark <span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
                          <span class="token comment">//å½“ç”¨æˆ·idä¸º000001ç”Ÿæˆwatermark</span>
                         <span class="token keyword">if</span><span class="token punctuation">(</span>lastElement<span class="token punctuation">.</span>_1<span class="token punctuation">.</span>equals<span class="token punctuation">(</span><span class="token string">"000001"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
      
                            <span class="token keyword">val</span> watermark<span class="token operator">=</span>  <span class="token keyword">new</span> Watermark<span class="token punctuation">(</span>currentMaxTimestamp<span class="token operator">-</span>maxOutOfOrderness<span class="token punctuation">)</span>
      
                            watermark
                         <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
                           <span class="token comment">//å…¶ä»–æƒ…å†µä¸‹ä¸è¿”å›æ°´ä½çº¿</span>
                            <span class="token keyword">null</span>
                         <span class="token punctuation">}</span>
      
                  <span class="token punctuation">}</span>
      
                  <span class="token keyword">override</span> <span class="token keyword">def</span> extractTimestamp<span class="token punctuation">(</span>element<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">,</span> previousElementTimestamp<span class="token operator">:</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//è·å–äº‹ä»¶æ—¶é—´</span>
                    <span class="token keyword">val</span> currentElementEventTime<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> element<span class="token punctuation">.</span>_2
      
                    <span class="token comment">//å¯¹æ¯”å½“å‰äº‹ä»¶æ—¶é—´å’Œå†å²æœ€å¤§äº‹ä»¶æ—¶é—´, å°†è¾ƒå¤§å€¼é‡æ–°èµ‹å€¼ç»™currentMaxTimestamp</span>
                    currentMaxTimestamp<span class="token operator">=</span>Math<span class="token punctuation">.</span>max<span class="token punctuation">(</span>currentMaxTimestamp<span class="token punctuation">,</span>currentElementEventTime<span class="token punctuation">)</span>
      
                    println<span class="token punctuation">(</span><span class="token string">"æ¥å—åˆ°çš„äº‹ä»¶ï¼š"</span><span class="token operator">+</span>element<span class="token operator">+</span><span class="token string">" |äº‹ä»¶æ—¶é—´ï¼š "</span><span class="token operator">+</span>currentElementEventTime <span class="token punctuation">)</span>
      
                    currentElementEventTime
      
                  <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span>keyBy<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span>timeWindow<span class="token punctuation">(</span>Time<span class="token punctuation">.</span>seconds<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span>process<span class="token punctuation">(</span><span class="token keyword">new</span> ProcessWindowFunction<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span><span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">,</span>Tuple<span class="token punctuation">,</span>TimeWindow<span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">override</span> <span class="token keyword">def</span> process<span class="token punctuation">(</span>key<span class="token operator">:</span> Tuple<span class="token punctuation">,</span> context<span class="token operator">:</span> Context<span class="token punctuation">,</span> elements<span class="token operator">:</span> Iterable<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> out<span class="token operator">:</span> Collector<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
      
                      <span class="token keyword">val</span> value<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> key<span class="token punctuation">.</span>getField<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
      
                      <span class="token comment">//çª—å£çš„å¼€å§‹æ—¶é—´</span>
                      <span class="token keyword">val</span> startTime<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>window<span class="token punctuation">.</span>getStart
                      <span class="token comment">//çª—å£çš„ç»“æŸæ—¶é—´</span>
                      <span class="token keyword">val</span> startEnd<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>window<span class="token punctuation">.</span>getEnd
      
                      <span class="token comment">//è·å–å½“å‰çš„ watermark</span>
                      <span class="token keyword">val</span> watermark<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>currentWatermark
      
                      <span class="token keyword">var</span> sum<span class="token operator">:</span><span class="token builtin">Long</span> <span class="token operator">=</span> <span class="token number">0</span>
                      <span class="token keyword">val</span> toList<span class="token operator">:</span> List<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> elements<span class="token punctuation">.</span>toList
                      <span class="token keyword">for</span><span class="token punctuation">(</span>eachElement <span class="token keyword">&lt;-</span>  toList<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                        sum <span class="token operator">+=</span><span class="token number">1</span>
                      <span class="token punctuation">}</span>
      
                      println<span class="token punctuation">(</span><span class="token string">"çª—å£çš„æ•°æ®æ¡æ•°:"</span><span class="token operator">+</span>sum<span class="token operator">+</span>
                        <span class="token string">" |çª—å£çš„ç¬¬ä¸€æ¡æ•°æ®ï¼š"</span><span class="token operator">+</span>toList<span class="token punctuation">.</span>head<span class="token operator">+</span>
                        <span class="token string">" |çª—å£çš„æœ€åä¸€æ¡æ•°æ®ï¼š"</span><span class="token operator">+</span>toList<span class="token punctuation">.</span>last<span class="token operator">+</span>
                        <span class="token string">" |çª—å£çš„å¼€å§‹æ—¶é—´ï¼š "</span><span class="token operator">+</span>startTime <span class="token operator">+</span>
                        <span class="token string">" |çª—å£çš„ç»“æŸæ—¶é—´ï¼š "</span><span class="token operator">+</span>startEnd<span class="token operator">+</span>
                        <span class="token string">" |å½“å‰çš„watermark:"</span><span class="token operator">+</span>watermark<span class="token punctuation">)</span>
      
                      out<span class="token punctuation">.</span>collect<span class="token punctuation">(</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span>sum<span class="token punctuation">)</span><span class="token punctuation">)</span>
      
                    <span class="token punctuation">}</span>
                  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>
               environment<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span>
              <span class="token punctuation">}</span>
           <span class="token punctuation">}</span>        
</code></pre>
      <ul>
       <li>
        å‘é€æ•°æ®
       </li>
      </ul>
      <pre><code>000001,1461756862000
000001,1461756866000
000001,1461756872000
000002,1461756867000
000002,1461756868000
000002,1461756875000
000001,1461756875000
</code></pre>
     </li>
    </ul>
    <h6>
     <a id="253_Window_allowedLateness_628">
     </a>
     2.5.3 Window çš„allowedLatenesså¤„ç†å»¶è¿Ÿå¤ªå¤§çš„æ•°æ®
    </h6>
    <pre><code>	åŸºäº Event-Time çš„çª—å£å¤„ç†æµå¼æ•°æ®ï¼Œè™½ç„¶æä¾›äº† Watermark æœºåˆ¶ï¼Œå´åªèƒ½åœ¨ä¸€å®šç¨‹åº¦ä¸Šè§£å†³äº†æ•°æ®ä¹±åºçš„é—®é¢˜ã€‚ä½†åœ¨æŸäº›æƒ…å†µä¸‹æ•°æ®å¯èƒ½å»¶æ—¶ä¼šéå¸¸ä¸¥é‡ï¼Œå³ä½¿é€šè¿‡ Watermark æœºåˆ¶ä¹Ÿæ— æ³•ç­‰åˆ°æ•°æ®å…¨éƒ¨è¿›å…¥çª—å£å†è¿›è¡Œå¤„ç†ã€‚
	
	Flink ä¸­é»˜è®¤ä¼šå°†è¿™äº›è¿Ÿåˆ°çš„æ•°æ®åšä¸¢å¼ƒå¤„ç†ï¼Œä½†æ˜¯æœ‰äº›æ—¶å€™ç”¨æˆ·å¸Œæœ›å³ä½¿æ•°æ®å»¶è¿Ÿåˆ°è¾¾çš„æƒ…å†µä¸‹ï¼Œä¹Ÿèƒ½å¤Ÿæ­£å¸¸æŒ‰ç…§æµç¨‹å¤„ç†å¹¶è¾“å‡ºç»“æœï¼Œæ­¤æ—¶å°±éœ€è¦ä½¿ç”¨ Allowed Lateness æœºåˆ¶æ¥å¯¹è¿Ÿåˆ°çš„æ•°æ®è¿›è¡Œé¢å¤–çš„å¤„ç†ã€‚
</code></pre>
    <ul>
     <li>
      <p>
       è¿Ÿåˆ°æ•°æ®çš„å¤„ç†æœºåˆ¶
      </p>
      <ul>
       <li>
        <p>
         1ã€ç›´æ¥ä¸¢å¼ƒ
        </p>
       </li>
       <li>
        <p>
         2ã€æŒ‡å®šå…è®¸å†æ¬¡è¿Ÿåˆ°çš„æ—¶é—´
        </p>
        <pre><code class="prism language-scala"><span class="token comment">//ä¾‹å¦‚</span>
assignTimestampsAndWatermarks<span class="token punctuation">(</span><span class="token keyword">new</span> EventTimeExtractor<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
                <span class="token punctuation">.</span>keyBy<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span>timeWindow<span class="token punctuation">(</span>Time<span class="token punctuation">.</span>seconds<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span>allowedLateness<span class="token punctuation">(</span>Time<span class="token punctuation">.</span>seconds<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// å…è®¸äº‹ä»¶å†è¿Ÿåˆ°2ç§’</span>
                <span class="token punctuation">.</span>process<span class="token punctuation">(</span><span class="token keyword">new</span> SumProcessWindowFunction<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setParallelism<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//æ³¨æ„ï¼š</span>
<span class="token comment">//ï¼ˆ1ï¼‰. å½“æˆ‘ä»¬è®¾ç½®å…è®¸è¿Ÿåˆ°2ç§’çš„äº‹ä»¶ï¼Œç¬¬ä¸€æ¬¡ window è§¦å‘çš„æ¡ä»¶æ˜¯ watermark &gt;= window_end_time</span>
<span class="token comment">//ï¼ˆ2ï¼‰. ç¬¬äºŒæ¬¡(æˆ–è€…å¤šæ¬¡)è§¦å‘çš„æ¡ä»¶æ˜¯watermark &lt; window_end_time + allowedLateness</span>
</code></pre>
       </li>
       <li>
        <p>
         3ã€æ”¶é›†è¿Ÿåˆ°å¤ªå¤šçš„æ•°æ®
        </p>
        <pre><code class="prism language-scala"><span class="token comment">//ä¾‹å¦‚</span>
assignTimestampsAndWatermarks<span class="token punctuation">(</span><span class="token keyword">new</span> EventTimeExtractor<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
                <span class="token punctuation">.</span>keyBy<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span>timeWindow<span class="token punctuation">(</span>Time<span class="token punctuation">.</span>seconds<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span>allowedLateness<span class="token punctuation">(</span>Time<span class="token punctuation">.</span>seconds<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//å…è®¸äº‹ä»¶è¿Ÿåˆ°2ç§’</span>
                <span class="token punctuation">.</span>sideOutputLateData<span class="token punctuation">(</span>outputTag<span class="token punctuation">)</span>    <span class="token comment">//æ”¶é›†è¿Ÿåˆ°å¤ªå¤šçš„æ•°æ®</span>
                <span class="token punctuation">.</span>process<span class="token punctuation">(</span><span class="token keyword">new</span> SumProcessWindowFunction<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setParallelism<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
       </li>
      </ul>
     </li>
     <li>
      <p>
       ä»£ç æ¼”ç¤º
      </p>
      <pre><code class="prism language-scala"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>watermark</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang3<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span>FastDateFormat
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span>MapFunction
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span></span>Tuple
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span>TimeCharacteristic
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span>AssignerWithPeriodicWatermarks
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{<!-- --></span>DataStream<span class="token punctuation">,</span> OutputTag<span class="token punctuation">,</span> StreamExecutionEnvironment<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span>function<span class="token punctuation">.</span></span>ProcessWindowFunction
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>watermark<span class="token punctuation">.</span></span>Watermark
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span>Time
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>windows<span class="token punctuation">.</span></span>TimeWindow
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Collector

<span class="token comment">//è¿è¡Œæ•°æ®å†æ¬¡å»¶å»¶è¿Ÿä¸€æ®µæ—¶é—´ï¼Œå¹¶ä¸”å¯¹å»¶è¿Ÿå¤ªå¤šçš„æ•°æ®è¿›è¡Œæ”¶é›†</span>
<span class="token keyword">object</span> AllowedLatenessTest <span class="token punctuation">{<!-- --></span>

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">//todo:1.æ„å»ºæµå¼å¤„ç†ç¯å¢ƒ</span>
      <span class="token keyword">val</span> environment<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
      <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_
      environment<span class="token punctuation">.</span>setParallelism<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token comment">//todo:2.è®¾ç½®æ—¶é—´ç±»å‹</span>
   environment<span class="token punctuation">.</span>setStreamTimeCharacteristic<span class="token punctuation">(</span>TimeCharacteristic<span class="token punctuation">.</span>EventTime<span class="token punctuation">)</span>

  <span class="token comment">//todo:3.è·å–æ•°æ®æº</span>
    <span class="token keyword">val</span> sourceStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> environment<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">"node01"</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span>

  <span class="token comment">//todo:4. æ•°æ®å¤„ç†</span>
    <span class="token keyword">val</span> mapStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> sourceStream<span class="token punctuation">.</span>map<span class="token punctuation">(</span>x<span class="token keyword">=&gt;</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toLong<span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token comment">//å®šä¹‰ä¸€ä¸ªä¾§è¾“å‡ºæµçš„æ ‡ç­¾ï¼Œç”¨äºæ”¶é›†è¿Ÿåˆ°å¤ªå¤šçš„æ•°æ®</span>
    <span class="token keyword">val</span> lateTag<span class="token operator">=</span><span class="token keyword">new</span> OutputTag<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">"late"</span><span class="token punctuation">)</span>

  <span class="token comment">//todo:5.  æ•°æ®è®¡ç®—--æ·»åŠ æ°´ä½çº¿</span>
  <span class="token keyword">val</span> result<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> mapStream<span class="token punctuation">.</span>assignTimestampsAndWatermarks<span class="token punctuation">(</span>
          <span class="token keyword">new</span> AssignerWithPeriodicWatermarks<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>

            <span class="token comment">//å®šä¹‰å»¶è¿Ÿæ—¶é—´é•¿åº¦</span>
            <span class="token comment">//è¡¨ç¤ºåœ¨5ç§’ä»¥å†…çš„æ•°æ®å»¶æ—¶æœ‰æ•ˆï¼Œè¶…è¿‡5ç§’çš„æ•°æ®è¢«è®¤å®šä¸ºè¿Ÿåˆ°äº‹ä»¶</span>
            <span class="token keyword">val</span> maxOutOfOrderness <span class="token operator">=</span> <span class="token number">5000L</span>
            <span class="token comment">//å†å²æœ€å¤§äº‹ä»¶æ—¶é—´</span>
            <span class="token keyword">var</span> currentMaxTimestamp<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> _ 
                  <span class="token comment">//å‘¨æœŸæ€§çš„ç”Ÿæˆæ°´ä½çº¿watermark</span>
            <span class="token keyword">override</span> <span class="token keyword">def</span> getCurrentWatermark<span class="token operator">:</span> Watermark <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
              <span class="token keyword">val</span> watermark <span class="token operator">=</span> <span class="token keyword">new</span> Watermark<span class="token punctuation">(</span>currentMaxTimestamp <span class="token operator">-</span> maxOutOfOrderness<span class="token punctuation">)</span>
              watermark
            <span class="token punctuation">}</span>

            <span class="token comment">//æŠ½å–äº‹ä»¶æ—¶é—´</span>
            <span class="token keyword">override</span> <span class="token keyword">def</span> extractTimestamp<span class="token punctuation">(</span>element<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">,</span> previousElementTimestamp<span class="token operator">:</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
              <span class="token comment">//è·å–äº‹ä»¶æ—¶é—´</span>
              <span class="token keyword">val</span> currentElementEventTime<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> element<span class="token punctuation">.</span>_2

              <span class="token comment">//å¯¹æ¯”å½“å‰äº‹ä»¶æ—¶é—´å’Œå†å²æœ€å¤§äº‹ä»¶æ—¶é—´, å°†è¾ƒå¤§å€¼é‡æ–°èµ‹å€¼ç»™currentMaxTimestamp</span>
              currentMaxTimestamp <span class="token operator">=</span> Math<span class="token punctuation">.</span>max<span class="token punctuation">(</span>currentMaxTimestamp<span class="token punctuation">,</span> currentElementEventTime<span class="token punctuation">)</span>

              println<span class="token punctuation">(</span><span class="token string">"æ¥å—åˆ°çš„äº‹ä»¶ï¼š"</span> <span class="token operator">+</span> element <span class="token operator">+</span> <span class="token string">" |äº‹ä»¶æ—¶é—´ï¼š "</span> <span class="token operator">+</span> currentElementEventTime <span class="token punctuation">)</span>

              currentElementEventTime
            <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span>keyBy<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span>timeWindow<span class="token punctuation">(</span>Time<span class="token punctuation">.</span>seconds<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span>allowedLateness<span class="token punctuation">(</span>Time<span class="token punctuation">.</span>seconds<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//å…è®¸æ•°æ®å»¶è¿Ÿ2s</span>
            <span class="token punctuation">.</span>sideOutputLateData<span class="token punctuation">(</span>lateTag<span class="token punctuation">)</span>     <span class="token comment">//æ”¶é›†å»¶è¿Ÿå¤§å¤šçš„æ•°æ®</span>
            <span class="token punctuation">.</span>process<span class="token punctuation">(</span><span class="token keyword">new</span> ProcessWindowFunction<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Tuple<span class="token punctuation">,</span> TimeWindow<span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>
                      <span class="token keyword">override</span> <span class="token keyword">def</span> process<span class="token punctuation">(</span>key<span class="token operator">:</span> Tuple<span class="token punctuation">,</span> context<span class="token operator">:</span> Context<span class="token punctuation">,</span> elements<span class="token operator">:</span> Iterable<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> out<span class="token operator">:</span> Collector<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>

                        <span class="token keyword">val</span> value<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> key<span class="token punctuation">.</span>getField<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

                        <span class="token comment">//çª—å£çš„å¼€å§‹æ—¶é—´</span>
                        <span class="token keyword">val</span> startTime<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>window<span class="token punctuation">.</span>getStart
                        <span class="token comment">//çª—å£çš„ç»“æŸæ—¶é—´</span>
                        <span class="token keyword">val</span> startEnd<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>window<span class="token punctuation">.</span>getEnd

                        <span class="token comment">//è·å–å½“å‰çš„ watermark</span>
                        <span class="token keyword">val</span> watermark<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>currentWatermark

                        <span class="token keyword">var</span> sum<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> <span class="token number">0</span>
                        <span class="token keyword">val</span> toList<span class="token operator">:</span> List<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> elements<span class="token punctuation">.</span>toList

                        <span class="token keyword">for</span> <span class="token punctuation">(</span>eachElement <span class="token keyword">&lt;-</span> toList<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                          sum <span class="token operator">+=</span> <span class="token number">1</span>
                        <span class="token punctuation">}</span>
                              println<span class="token punctuation">(</span><span class="token string">"çª—å£çš„æ•°æ®æ¡æ•°:"</span> <span class="token operator">+</span> sum <span class="token operator">+</span>
                          <span class="token string">" |çª—å£çš„ç¬¬ä¸€æ¡æ•°æ®ï¼š"</span> <span class="token operator">+</span> toList<span class="token punctuation">.</span>head <span class="token operator">+</span>
                          <span class="token string">" |çª—å£çš„æœ€åä¸€æ¡æ•°æ®ï¼š"</span> <span class="token operator">+</span> toList<span class="token punctuation">.</span>last <span class="token operator">+</span>
                          <span class="token string">" |çª—å£çš„å¼€å§‹æ—¶é—´ï¼š "</span> <span class="token operator">+</span> startTime <span class="token operator">+</span>
                          <span class="token string">" |çª—å£çš„ç»“æŸæ—¶é—´ï¼š "</span> <span class="token operator">+</span> startEnd <span class="token operator">+</span>
                          <span class="token string">" |å½“å‰çš„watermark:"</span> <span class="token operator">+</span> watermark<span class="token punctuation">)</span>

                        out<span class="token punctuation">.</span>collect<span class="token punctuation">(</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> sum<span class="token punctuation">)</span><span class="token punctuation">)</span>

            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">//æ‰“å°å»¶è¿Ÿå¤ªå¤šçš„æ•°æ®</span>
  result<span class="token punctuation">.</span>getSideOutput<span class="token punctuation">(</span>lateTag<span class="token punctuation">)</span><span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token string">"late"</span><span class="token punctuation">)</span>

  <span class="token comment">//æ‰“å°</span>
  result<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token string">"ok"</span><span class="token punctuation">)</span>
      
  environment<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>                  
</code></pre>
     </li>
     <li>
      <p>
       å‘é€æ•°æ®
      </p>
      <pre><code>000001,1461756862000
000001,1461756866000
000001,1461756868000
000001,1461756869000
000001,1461756870000
000001,1461756862000
000001,1461756871000
000001,1461756872000
000001,1461756862000
000001,1461756863000
</code></pre>
     </li>
    </ul>
    <h6>
     <a id="254_WaterMark_806">
     </a>
     2.5.4 å¤šå¹¶è¡Œåº¦ä¸‹çš„WaterMark
    </h6>
    <p>
     <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://i-blog.csdnimg.cn/direct/69eccf0550ac42efa678bb61e6eda9d5.png"/>
    </p>
    <pre><code>æœ¬åœ°æµ‹è¯•çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœä¸è®¾ç½®å¹¶è¡Œåº¦çš„è¯ï¼Œ
é»˜è®¤è¯»å–æœ¬æœºCPUæ•°é‡è®¾ç½®å¹¶è¡Œåº¦ï¼Œ
å¯ä»¥æ‰‹åŠ¨è®¾ç½®å¹¶è¡Œåº¦environment.setParallelism(1)ï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹éƒ½ä¼šæœ‰ä¸€ä¸ªwatermark.
å¤šå¹¶è¡Œåº¦çš„æƒ…å†µä¸‹,ä¸€ä¸ªwindowå¯èƒ½ä¼šæ¥å—åˆ°å¤šä¸ªä¸åŒçº¿ç¨‹waterMarkï¼Œ
</code></pre>
    <ul>
     <li>
      <p>
       <mark>
        watermarkå¯¹é½ä¼šå–æ‰€æœ‰channelæœ€å°çš„watermarkï¼Œä»¥æœ€å°çš„watermarkä¸ºå‡†ã€‚
       </mark>
      </p>
     </li>
     <li>
      <p>
       æ¡ˆä¾‹æ¼”ç¤º
      </p>
      <pre><code class="prism language-scala">
<span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>watermark</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span></span>Tuple
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span>TimeCharacteristic
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span>AssignerWithPeriodicWatermarks
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{<!-- --></span>DataStream<span class="token punctuation">,</span> StreamExecutionEnvironment<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span>function<span class="token punctuation">.</span></span>ProcessWindowFunction
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>watermark<span class="token punctuation">.</span></span>Watermark
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span>Time
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>windows<span class="token punctuation">.</span></span>TimeWindow
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Collector

<span class="token comment">/**
  * å¾—åˆ°å¹¶æ‰“å°æ¯éš” 5 ç§’é’Ÿç»Ÿè®¡å‰ 5ç§’å†…çš„ç›¸åŒçš„ key çš„æ‰€æœ‰çš„äº‹ä»¶
  * æµ‹è¯•å¤šå¹¶è¡Œåº¦ä¸‹çš„watermark
  */</span>
<span class="token keyword">object</span> WaterMarkWindowWithMultipart <span class="token punctuation">{<!-- --></span>

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//todo:1.æ„å»ºæµå¼å¤„ç†ç¯å¢ƒ</span>
  <span class="token keyword">val</span> environment<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
  <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_
  
  <span class="token comment">//è®¾ç½®å¹¶è¡Œåº¦ä¸º2</span>
  environment<span class="token punctuation">.</span>setParallelism<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
  <span class="token comment">//todo:2.è®¾ç½®æ—¶é—´ç±»å‹</span>
  environment<span class="token punctuation">.</span>setStreamTimeCharacteristic<span class="token punctuation">(</span>TimeCharacteristic<span class="token punctuation">.</span>EventTime<span class="token punctuation">)</span>

  <span class="token comment">//todo:3.è·å–æ•°æ®æº</span>
  <span class="token keyword">val</span> sourceStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> environment<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">"node01"</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span>

  <span class="token comment">//todo:4. æ•°æ®å¤„ç†</span>
  <span class="token keyword">val</span> mapStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> sourceStream<span class="token punctuation">.</span>map<span class="token punctuation">(</span>x<span class="token keyword">=&gt;</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toLong<span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token comment">//todo:5. æ·»åŠ æ°´ä½çº¿</span>
  mapStream<span class="token punctuation">.</span>assignTimestampsAndWatermarks<span class="token punctuation">(</span>
    <span class="token keyword">new</span> AssignerWithPeriodicWatermarks<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>

      <span class="token comment">//å®šä¹‰å»¶è¿Ÿæ—¶é—´é•¿åº¦</span>
      <span class="token comment">//è¡¨ç¤ºåœ¨5ç§’ä»¥å†…çš„æ•°æ®å»¶æ—¶æœ‰æ•ˆï¼Œè¶…è¿‡5ç§’çš„æ•°æ®è¢«è®¤å®šä¸ºè¿Ÿåˆ°äº‹ä»¶</span>

      <span class="token keyword">val</span> maxOutOfOrderness<span class="token operator">=</span><span class="token number">5000L</span>
      <span class="token comment">//å†å²æœ€å¤§äº‹ä»¶æ—¶é—´</span>
      <span class="token keyword">var</span> currentMaxTimestamp<span class="token operator">:</span><span class="token builtin">Long</span><span class="token operator">=</span>_
             <span class="token comment">//å‘¨æœŸæ€§çš„ç”Ÿæˆæ°´ä½çº¿watermark</span>
      <span class="token keyword">override</span> <span class="token keyword">def</span> getCurrentWatermark<span class="token operator">:</span> Watermark <span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
       <span class="token keyword">val</span>  watermark <span class="token operator">=</span>  <span class="token keyword">new</span> Watermark<span class="token punctuation">(</span>currentMaxTimestamp <span class="token operator">-</span>maxOutOfOrderness<span class="token punctuation">)</span>
        watermark
      <span class="token punctuation">}</span>

      <span class="token comment">//æŠ½å–äº‹ä»¶æ—¶é—´</span>
      <span class="token keyword">override</span> <span class="token keyword">def</span> extractTimestamp<span class="token punctuation">(</span>element<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">,</span> previousElementTimestamp<span class="token operator">:</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">//è·å–äº‹ä»¶æ—¶é—´</span>
        <span class="token keyword">val</span> currentElementEventTime<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> element<span class="token punctuation">.</span>_2

        <span class="token comment">//å¯¹æ¯”å½“å‰äº‹ä»¶æ—¶é—´å’Œå†å²æœ€å¤§äº‹ä»¶æ—¶é—´, å°†è¾ƒå¤§å€¼é‡æ–°èµ‹å€¼ç»™currentMaxTimestamp</span>
        currentMaxTimestamp<span class="token operator">=</span>Math<span class="token punctuation">.</span>max<span class="token punctuation">(</span>currentMaxTimestamp<span class="token punctuation">,</span>currentElementEventTime<span class="token punctuation">)</span>

        <span class="token keyword">val</span> id<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> Thread<span class="token punctuation">.</span>currentThread<span class="token punctuation">.</span>getId
        println<span class="token punctuation">(</span><span class="token string">"å½“å‰çš„çº¿ç¨‹id:"</span><span class="token operator">+</span>id<span class="token operator">+</span><span class="token string">" |æ¥å—åˆ°çš„äº‹ä»¶ï¼š"</span><span class="token operator">+</span>element<span class="token operator">+</span><span class="token string">" |äº‹ä»¶æ—¶é—´ï¼š "</span><span class="token operator">+</span>currentElementEventTime<span class="token operator">+</span><span class="token string">" |å½“å‰å€¼çš„watermark:"</span><span class="token operator">+</span>getCurrentWatermark<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getTimestamp<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        currentElementEventTime
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>keyBy<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>timeWindow<span class="token punctuation">(</span>Time<span class="token punctuation">.</span>seconds<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>process<span class="token punctuation">(</span><span class="token keyword">new</span> ProcessWindowFunction<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span><span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">,</span>Tuple<span class="token punctuation">,</span>TimeWindow<span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">override</span> <span class="token keyword">def</span> process<span class="token punctuation">(</span>key<span class="token operator">:</span> Tuple<span class="token punctuation">,</span> context<span class="token operator">:</span> Context<span class="token punctuation">,</span> elements<span class="token operator">:</span> Iterable<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> out<span class="token operator">:</span> Collector<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>

        <span class="token keyword">val</span> value<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> key<span class="token punctuation">.</span>getField<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

        <span class="token comment">//çª—å£çš„å¼€å§‹æ—¶é—´</span>
        <span class="token keyword">val</span> startTime<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>window<span class="token punctuation">.</span>getStart
        <span class="token comment">//çª—å£çš„ç»“æŸæ—¶é—´</span>
        <span class="token keyword">val</span> startEnd<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>window<span class="token punctuation">.</span>getEnd

        <span class="token comment">//è·å–å½“å‰çš„ watermark</span>
        <span class="token keyword">val</span> watermark<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>currentWatermark

        <span class="token keyword">var</span> sum<span class="token operator">:</span><span class="token builtin">Long</span> <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">val</span> toList<span class="token operator">:</span> List<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> elements<span class="token punctuation">.</span>toList
        <span class="token keyword">for</span><span class="token punctuation">(</span>eachElement <span class="token keyword">&lt;-</span>  toList<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
          sum <span class="token operator">+=</span><span class="token number">1</span>
        <span class="token punctuation">}</span> 
             println<span class="token punctuation">(</span><span class="token string">"çª—å£çš„æ•°æ®æ¡æ•°:"</span><span class="token operator">+</span>sum<span class="token operator">+</span>
          <span class="token string">" |çª—å£çš„ç¬¬ä¸€æ¡æ•°æ®ï¼š"</span><span class="token operator">+</span>toList<span class="token punctuation">.</span>head<span class="token operator">+</span>
          <span class="token string">" |çª—å£çš„æœ€åä¸€æ¡æ•°æ®ï¼š"</span><span class="token operator">+</span>toList<span class="token punctuation">.</span>last<span class="token operator">+</span>
          <span class="token string">" |çª—å£çš„å¼€å§‹æ—¶é—´ï¼š "</span><span class="token operator">+</span>  startTime <span class="token operator">+</span>
          <span class="token string">" |çª—å£çš„ç»“æŸæ—¶é—´ï¼š "</span><span class="token operator">+</span> startEnd<span class="token operator">+</span>
          <span class="token string">" |å½“å‰çš„watermark:"</span><span class="token operator">+</span> watermark<span class="token punctuation">)</span>

        out<span class="token punctuation">.</span>collect<span class="token punctuation">(</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span>sum<span class="token punctuation">)</span><span class="token punctuation">)</span>

      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>
    environment<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span>

		<span class="token punctuation">}</span>    
    <span class="token punctuation">}</span>
</code></pre>
     </li>
     <li>
      <p>
       è¾“å…¥æ•°æ®
      </p>
      <pre><code>000001,1461756862000
000001,1461756864000
000001,1461756866000
000001,1461756870000
000001,1461756871000
</code></pre>
     </li>
     <li>
      <p>
       è¾“å‡ºç»“æœ
      </p>
      <pre><code>å½“å‰çš„çº¿ç¨‹id:65 |æ¥å—åˆ°çš„äº‹ä»¶ï¼š(000001,1461756862000) |äº‹ä»¶æ—¶é—´ï¼š 1461756862000 |å½“å‰å€¼çš„watermark:1461756857000
å½“å‰çš„çº¿ç¨‹id:64 |æ¥å—åˆ°çš„äº‹ä»¶ï¼š(000001,1461756864000) |äº‹ä»¶æ—¶é—´ï¼š 1461756864000 |å½“å‰å€¼çš„watermark:1461756859000
å½“å‰çš„çº¿ç¨‹id:65 |æ¥å—åˆ°çš„äº‹ä»¶ï¼š(000001,1461756866000) |äº‹ä»¶æ—¶é—´ï¼š 1461756866000 |å½“å‰å€¼çš„watermark:1461756861000
å½“å‰çš„çº¿ç¨‹id:64 |æ¥å—åˆ°çš„äº‹ä»¶ï¼š(000001,1461756870000) |äº‹ä»¶æ—¶é—´ï¼š 1461756870000 |å½“å‰å€¼çš„watermark:1461756865000
å½“å‰çš„çº¿ç¨‹id:65 |æ¥å—åˆ°çš„äº‹ä»¶ï¼š(000001,1461756871000) |äº‹ä»¶æ—¶é—´ï¼š 1461756871000 |å½“å‰å€¼çš„watermark:1461756866000
çª—å£çš„æ•°æ®æ¡æ•°:2 |çª—å£çš„ç¬¬ä¸€æ¡æ•°æ®ï¼š(000001,1461756862000) |çª—å£çš„æœ€åä¸€æ¡æ•°æ®ï¼š(000001,1461756864000) |çª—å£çš„å¼€å§‹æ—¶é—´ï¼š 1461756860000 |çª—å£çš„ç»“æŸæ—¶é—´ï¼š 1461756865000 |å½“å‰çš„watermark:1461756865000
2&gt; (000001,2)
</code></pre>
     </li>
     <li>
      <p>
       ç»“æœåˆ†æ
      </p>
     </li>
    </ul>
    <p>
     <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://i-blog.csdnimg.cn/direct/f80483414e684a5e88fe033bfa9d9698.png"/>
    </p>
    <h3>
     <a id="book_3_FlinkTableSQL_955">
     </a>
     ğŸ“– 3. Flinkçš„Tableå’ŒSQL
    </h3>
    <h5>
     <a id="31_TableSQL_957">
     </a>
     3.1 Tableä¸SQLåŸºæœ¬ä»‹ç»
    </h5>
    <pre><code>	åœ¨Sparkä¸­æœ‰DataFrameè¿™æ ·çš„å…³ç³»å‹ç¼–ç¨‹æ¥å£ï¼Œå› å…¶å¼ºå¤§ä¸”çµæ´»çš„è¡¨è¾¾èƒ½åŠ›ï¼Œ
	èƒ½å¤Ÿè®©ç”¨æˆ·é€šè¿‡éå¸¸ä¸°å¯Œçš„æ¥å£å¯¹æ•°æ®è¿›è¡Œå¤„ç†ï¼Œæœ‰æ•ˆé™ä½äº†ç”¨æˆ·çš„ä½¿ç”¨æˆæœ¬ã€‚

	Flinkä¹Ÿæä¾›äº†å…³ç³»å‹ç¼–ç¨‹æ¥å£ Table API ä»¥åŠåŸºäºTable API çš„ SQL APIï¼Œ
	è®©ç”¨æˆ·èƒ½å¤Ÿé€šè¿‡ä½¿ç”¨ç»“æ„åŒ–ç¼–ç¨‹æ¥å£é«˜æ•ˆåœ°æ„å»ºFlinkåº”ç”¨ã€‚
	åŒæ—¶Table API ä»¥åŠ SQL èƒ½å¤Ÿç»Ÿä¸€å¤„ç†æ‰¹é‡å’Œå®æ—¶è®¡ç®—ä¸šåŠ¡ï¼Œ 
	æ— é¡»åˆ‡æ¢ä¿®æ”¹ä»»ä½•åº”ç”¨ä»£ç å°±èƒ½å¤ŸåŸºäºåŒä¸€å¥— API ç¼–å†™æµå¼åº”ç”¨å’Œæ‰¹é‡åº”ç”¨ï¼Œä»è€Œè¾¾åˆ°çœŸæ­£æ„ä¹‰çš„æ‰¹æµç»Ÿä¸€ã€‚
</code></pre>
    <ul>
     <li>
      <mark>
       Apache Flink å…·æœ‰ä¸¤ä¸ªå…³ç³»å‹APIï¼šTable API å’ŒSQLï¼Œç”¨äºç»Ÿä¸€æµå’Œæ‰¹å¤„ç†
      </mark>
     </li>
     <li>
      Table API æ˜¯ç”¨äº Scala å’Œ Java è¯­è¨€çš„æŸ¥è¯¢APIï¼Œå…è®¸ä»¥éå¸¸ç›´è§‚çš„æ–¹å¼ç»„åˆå…³ç³»è¿ç®—ç¬¦çš„æŸ¥è¯¢ï¼Œä¾‹å¦‚ selectï¼Œfilter å’Œ joinã€‚Flink SQL çš„æ”¯æŒæ˜¯åŸºäºå®ç°äº†SQLæ ‡å‡†çš„ Apache Calciteã€‚æ— è®ºè¾“å…¥æ˜¯æ‰¹è¾“å…¥ï¼ˆDataSetï¼‰è¿˜æ˜¯æµè¾“å…¥ï¼ˆDataStreamï¼‰ï¼Œä»»ä¸€æ¥å£ä¸­æŒ‡å®šçš„æŸ¥è¯¢éƒ½å…·æœ‰ç›¸åŒçš„è¯­ä¹‰å¹¶æŒ‡å®šç›¸åŒçš„ç»“æœã€‚
     </li>
     <li>
      Table APIå’ŒSQLæ¥å£å½¼æ­¤é›†æˆï¼ŒFlinkçš„DataStreamå’ŒDataSet APIäº¦æ˜¯å¦‚æ­¤ã€‚æˆ‘ä»¬å¯ä»¥è½»æ¾åœ°åœ¨åŸºäºAPIæ„å»ºçš„æ‰€æœ‰APIå’Œåº“ä¹‹é—´åˆ‡æ¢ã€‚
     </li>
     <li>
      æ³¨æ„ï¼Œåˆ°ç›®å‰æœ€æ–°ç‰ˆæœ¬ä¸ºæ­¢ï¼ŒTable APIå’ŒSQLè¿˜æœ‰å¾ˆå¤šåŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­ã€‚ å¹¶é[Table APIï¼ŒSQL]å’Œ[streamï¼Œbatch]è¾“å…¥çš„æ¯ç§ç»„åˆéƒ½æ”¯æŒæ‰€æœ‰æ“ä½œ
     </li>
    </ul>
    <p>
     <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://i-blog.csdnimg.cn/direct/a38684e85d2a47f985a71a34182f4b46.png"/>
    </p>
    <h5>
     <a id="32_SQL_980">
     </a>
     3.2 ä¸ºä»€ä¹ˆéœ€è¦SQL
    </h5>
    <ul>
     <li>
      <p>
       Table API æ˜¯ä¸€ç§å…³ç³»å‹APIï¼Œç±» SQL çš„APIï¼Œç”¨æˆ·å¯ä»¥åƒæ“ä½œè¡¨ä¸€æ ·åœ°æ“ä½œæ•°æ®ï¼Œ éå¸¸çš„ç›´è§‚å’Œæ–¹ä¾¿ã€‚
      </p>
     </li>
     <li>
      <p>
       SQL ä½œä¸ºä¸€ä¸ª"äººæ‰€çš†çŸ¥"çš„è¯­è¨€ï¼Œå¦‚æœä¸€ä¸ªå¼•æ“æä¾› SQLï¼Œå®ƒå°†å¾ˆå®¹æ˜“è¢«äººä»¬æ¥å—ã€‚è¿™å·²ç»æ˜¯ä¸šç•Œå¾ˆå¸¸è§çš„ç°è±¡äº†ã€‚
      </p>
     </li>
     <li>
      <p>
       Table &amp; SQL API è¿˜æœ‰å¦ä¸€ä¸ªèŒè´£ï¼Œå°±æ˜¯æµå¤„ç†å’Œæ‰¹å¤„ç†ç»Ÿä¸€çš„APIå±‚ã€‚
      </p>
      <p>
       <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://i-blog.csdnimg.cn/direct/bc5e12b0c68a4d0a8d28e293807cd78f.png"/>
      </p>
     </li>
    </ul>
    <h5>
     <a id="33__992">
     </a>
     3.3 å¼€å‘ç¯å¢ƒæ„å»º
    </h5>
    <ul>
     <li>
      <p>
       åœ¨ Flink 1.9 ä¸­ï¼ŒTable æ¨¡å—è¿æ¥äº†æ ¸å¿ƒæ¶æ„çš„å‡çº§ï¼Œå¼•å…¥äº†é˜¿é‡Œå·´å·´ Blink å›¢é˜Ÿè´¡çŒ®çš„è¯¸å¤šåŠŸèƒ½ï¼Œå–åå«ï¼š Blink Plannerã€‚
      </p>
     </li>
     <li>
      <p>
       åœ¨ä½¿ç”¨ Table API å’Œ SQL å¼€å‘ Flink åº”ç”¨ä¹‹å‰ï¼Œé€šè¿‡æ·»åŠ  Maven çš„ä¾èµ–é…ç½®åˆ°é¡¹ç›®ä¸­ï¼Œåœ¨æœ¬åœ°å·¥ç¨‹ä¸­å¼•å…¥ç›¸åº”çš„ä¾èµ–åº“ï¼Œåº“ä¸­åŒ…å«äº† Table API å’Œ SQL æ¥å£ã€‚
      </p>
     </li>
     <li>
      <p>
       æ·»åŠ pomä¾èµ–
      </p>
      <pre><code class="prism language-xml"> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.flink<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>flink-table-planner_2.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.9.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.flink<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>flink-table-api-scala-bridge_2.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.9.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre>
     </li>
    </ul>
    <h5>
     <a id="34_TableEnvironment_1016">
     </a>
     3.4 TableEnvironmentæ„å»º
    </h5>
    <ul>
     <li>
      <p>
       å’Œ DataStream API ä¸€æ ·ï¼ŒTable API å’Œ SQL ä¸­å…·æœ‰ç›¸åŒçš„åŸºæœ¬ç¼–ç¨‹æ¨¡å‹ã€‚é¦–å…ˆéœ€è¦æ„å»ºå¯¹åº”çš„ TableEnviroment åˆ›å»ºå…³ç³»å‹ç¼–ç¨‹ç¯å¢ƒï¼Œæ‰èƒ½å¤Ÿåœ¨ç¨‹åºä¸­ä½¿ç”¨ Table API å’Œ SQLæ¥ç¼–å†™åº”ç”¨ç¨‹åºï¼Œå¦å¤– Table API å’Œ SQL æ¥å£å¯ä»¥åœ¨åº”ç”¨ä¸­åŒæ—¶ä½¿ç”¨ï¼ŒFlink SQL åŸºäº Apache Calcite æ¡†æ¶å®ç°äº† SQL æ ‡å‡†åè®®ï¼Œæ˜¯æ„å»ºåœ¨ Table API ä¹‹ä¸Šçš„æ›´é«˜çº§æ¥å£ã€‚
      </p>
     </li>
     <li>
      <p>
       é¦–å…ˆéœ€è¦åœ¨ç¯å¢ƒä¸­åˆ›å»º TableEnvironment å¯¹è±¡ï¼ŒTableEnvironment ä¸­æä¾›äº†æ³¨å†Œå†…éƒ¨è¡¨ã€æ‰§è¡Œ Flink SQL è¯­å¥ã€æ³¨å†Œè‡ªå®šä¹‰å‡½æ•°ç­‰åŠŸèƒ½ã€‚æ ¹æ®åº”ç”¨ç±»å‹çš„ä¸åŒï¼ŒTableEnvironment åˆ›å»ºæ–¹å¼ä¹Ÿæœ‰æ‰€ä¸åŒï¼Œä½†æ˜¯éƒ½æ˜¯é€šè¿‡è°ƒç”¨ create()æ–¹æ³•åˆ›å»ºã€‚
      </p>
     </li>
     <li>
      <p>
       æµè®¡ç®—ç¯å¢ƒä¸‹åˆ›å»º TableEnviroment
      </p>
      <pre><code class="prism language-scala"><span class="token comment">//åˆå§‹åŒ–Flinkçš„Streamingï¼ˆæµè®¡ç®—ï¼‰ä¸Šä¸‹æ–‡æ‰§è¡Œç¯å¢ƒ </span>
<span class="token keyword">val</span> streamEnv<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment 
<span class="token comment">//åˆå§‹åŒ–Table APIçš„ä¸Šä¸‹æ–‡ç¯å¢ƒ </span>
<span class="token keyword">val</span> tableEvn <span class="token operator">=</span>StreamTableEnvironment<span class="token punctuation">.</span>create<span class="token punctuation">(</span>streamEnv<span class="token punctuation">)</span>
</code></pre>
     </li>
     <li>
      <p>
       åœ¨ Flink1.9 ä¹‹åç”±äºå¼•å…¥äº† Blink Planner
      </p>
      <pre><code class="prism language-scala"><span class="token keyword">val</span> bsSettings <span class="token operator">=</span> EnvironmentSettings<span class="token punctuation">.</span>newInstance<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>useOldPlanner<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>inStreamingMode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>build<span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token keyword">val</span> bsTableEnv <span class="token operator">=</span> StreamTableEnvironment<span class="token punctuation">.</span>create<span class="token punctuation">(</span>streamEnv<span class="token punctuation">,</span> bsSettings<span class="token punctuation">)</span>
</code></pre>
     </li>
     <li>
      <p>
       æ³¨æ„
      </p>
      <ul>
       <li>
        Flink ç¤¾åŒºå®Œæ•´ä¿ç•™åŸæœ‰ Flink Planner (Old Planner)ï¼ŒåŒæ—¶åˆå¼•å…¥äº†æ–°çš„Blink Plannerï¼Œç”¨æˆ·å¯ä»¥è‡ªè¡Œé€‰æ‹©ä½¿ç”¨ Old Planner è¿˜æ˜¯ Blink Plannerã€‚å®˜æ–¹æ¨èæš‚æ—¶ä½¿ç”¨ Old Plannerã€‚
       </li>
      </ul>
     </li>
    </ul>
    <h5>
     <a id="35_Table_API_1044">
     </a>
     3.5 Table API
    </h5>
    <ul>
     <li>
      åœ¨ Flink ä¸­åˆ›å»ºä¸€å¼ è¡¨æœ‰ä¸¤ç§æ–¹æ³•ï¼š
      <ul>
       <li>
        ï¼ˆ1ï¼‰ä»ä¸€ä¸ªæ–‡ä»¶ä¸­å¯¼å…¥è¡¨ç»“æ„ï¼ˆStructureï¼‰ï¼ˆå¸¸ç”¨äºæ‰¹è®¡ç®—ï¼‰ï¼ˆé™æ€ï¼‰
       </li>
       <li>
        ï¼ˆ2ï¼‰ä» DataStream æˆ–è€… DataSet è½¬æ¢æˆ Table ï¼ˆåŠ¨æ€ï¼‰
       </li>
      </ul>
     </li>
    </ul>
    <h6>
     <a id="351__Table_1052">
     </a>
     3.5.1 åˆ›å»º Table
    </h6>
    <ul>
     <li>
      <p>
       Table API ä¸­å·²ç»æä¾›äº† TableSource ä»å¤–éƒ¨ç³»ç»Ÿè·å–æ•°æ®ï¼Œä¾‹å¦‚å¸¸è§çš„æ•°æ®åº“ã€æ–‡ä»¶ç³»ç»Ÿå’Œ Kafka æ¶ˆæ¯é˜Ÿåˆ—ç­‰å¤–éƒ¨ç³»ç»Ÿã€‚
      </p>
     </li>
     <li>
      <p>
       <strong>
        1ã€ä»æ–‡ä»¶ä¸­åˆ›å»º Tableï¼ˆé™æ€è¡¨ï¼‰
       </strong>
      </p>
      <ul>
       <li>
        <p>
         éœ€æ±‚
        </p>
        <ul>
         <li>
          è¯»å–csvæ–‡ä»¶ï¼Œæ–‡ä»¶å†…å®¹å‚è§è¯¾ä»¶å½“ä¸­çš„flinksql.csvæ–‡ä»¶ï¼ŒæŸ¥è¯¢å¹´é¾„å¤§äº18å²çš„äººï¼Œå¹¶å°†ç»“æœå†™å…¥åˆ°csvæ–‡ä»¶é‡Œé¢å»ï¼Œè¿™é‡Œæ¶‰åŠåˆ°flinkçš„connectçš„å„ç§ä¸å…¶ä»–å¤–éƒ¨ç³»ç»Ÿçš„è¿æ¥ï¼Œå‚è§
         </li>
         <li>
          https://ci.apache.org/projects/flink/flink-docs-release-1.9/dev/table/connect.html
         </li>
        </ul>
       </li>
       <li>
        <p>
         ä»£ç å¼€å‘
        </p>
        <pre><code class="prism language-scala"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>table</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>typeinfo<span class="token punctuation">.</span></span>TypeInformation
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>core<span class="token punctuation">.</span>fs<span class="token punctuation">.</span></span>FileSystem<span class="token punctuation">.</span>WriteMode
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{<!-- --></span>DataStream<span class="token punctuation">,</span> StreamExecutionEnvironment<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token punctuation">{<!-- --></span>Table<span class="token punctuation">,</span> Types<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>StreamTableEnvironment
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>sinks<span class="token punctuation">.</span></span>CsvTableSink
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>sources<span class="token punctuation">.</span></span>CsvTableSource
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_
<span class="token comment">/**
  * flink tableåŠ è½½csvæ–‡ä»¶
  */</span>
<span class="token keyword">object</span> TableCsvSource <span class="token punctuation">{<!-- --></span>

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
     <span class="token comment">//todo:1ã€æ„å»ºæµå¤„ç†ç¯å¢ƒ</span>
      <span class="token keyword">val</span> environment<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment

    <span class="token comment">//todo:2ã€æ„å»ºTableEnvironment</span>
    <span class="token keyword">val</span> tableEnvironment<span class="token operator">:</span> StreamTableEnvironment <span class="token operator">=</span> StreamTableEnvironment<span class="token punctuation">.</span>create<span class="token punctuation">(</span>environment<span class="token punctuation">)</span>
        <span class="token comment">//todo:3ã€æ„å»ºcsvæ•°æ®æº</span>
    <span class="token keyword">val</span> csvSource <span class="token operator">=</span> CsvTableSource<span class="token punctuation">.</span>builder<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>path<span class="token punctuation">(</span><span class="token string">"d:\\flinksql.csv"</span><span class="token punctuation">)</span>
                                   <span class="token punctuation">.</span>field<span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span> Types<span class="token punctuation">.</span>INT<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                   <span class="token punctuation">.</span>field<span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> Types<span class="token punctuation">.</span>STRING<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                   <span class="token punctuation">.</span>field<span class="token punctuation">(</span><span class="token string">"age"</span><span class="token punctuation">,</span> Types<span class="token punctuation">.</span>INT<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                   <span class="token punctuation">.</span>fieldDelimiter<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span> <span class="token comment">//å­—æ®µçš„åˆ†éš”ç¬¦</span>
                                   <span class="token punctuation">.</span>ignoreParseErrors<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//å¿½ç•¥è§£æé”™è¯¯</span>
                                   <span class="token punctuation">.</span>ignoreFirstLine<span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment">//å¿½ç•¥ç¬¬ä¸€è¡Œ</span>
                                   <span class="token punctuation">.</span>build<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">//todo:4ã€æ³¨å†Œè¡¨</span>
    tableEnvironment<span class="token punctuation">.</span>registerTableSource<span class="token punctuation">(</span><span class="token string">"myUser"</span><span class="token punctuation">,</span> csvSource<span class="token punctuation">)</span>

    <span class="token comment">//todo: 5ã€æŸ¥è¯¢ç»“æœ</span>
    <span class="token keyword">val</span> result<span class="token operator">:</span> Table <span class="token operator">=</span> tableEnvironment<span class="token punctuation">.</span>scan<span class="token punctuation">(</span><span class="token string">"myUser"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span><span class="token string">"age&gt;25"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token string">"id,name,age"</span><span class="token punctuation">)</span>
    result<span class="token punctuation">.</span>printSchema<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">//todo: 6ã€æ„å»ºSink</span>
    <span class="token keyword">val</span> tableSink <span class="token operator">=</span> <span class="token keyword">new</span> CsvTableSink<span class="token punctuation">(</span><span class="token string">"./out/tableSink.txt"</span><span class="token punctuation">,</span><span class="token string">"\t"</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>WriteMode<span class="token punctuation">.</span>OVERWRITE<span class="token punctuation">)</span>

    <span class="token comment">//todo:7ã€æ³¨å†Œsink</span>
    tableEnvironment<span class="token punctuation">.</span>registerTableSink<span class="token punctuation">(</span><span class="token string">"csvOutputTable"</span><span class="token punctuation">,</span>
                                        Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">"f1"</span><span class="token punctuation">,</span><span class="token string">"f2"</span><span class="token punctuation">,</span><span class="token string">"f3"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                        Array<span class="token punctuation">[</span>TypeInformation<span class="token punctuation">[</span>_<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">(</span>Types<span class="token punctuation">.</span>INT<span class="token punctuation">,</span>Types<span class="token punctuation">.</span>STRING<span class="token punctuation">,</span>Types<span class="token punctuation">.</span>INT<span class="token punctuation">)</span> <span class="token punctuation">,</span>
                                        tableSink<span class="token punctuation">)</span>

    <span class="token comment">//todo:8ã€å†™æ•°æ®åˆ°sink</span>
    result<span class="token punctuation">.</span>insertInto<span class="token punctuation">(</span><span class="token string">"csvOutputTable"</span><span class="token punctuation">)</span>

    environment<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">"TableCsvSource"</span><span class="token punctuation">)</span>

  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre>
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        2ã€ä»DataStreamä¸­åˆ›å»º Tableï¼ˆåŠ¨æ€è¡¨ï¼‰
       </strong>
      </p>
      <ul>
       <li>
        <p>
         éœ€æ±‚
        </p>
        <ul>
         <li>
          ä½¿ç”¨TableApiå®ŒæˆåŸºäºæµæ•°æ®çš„å¤„ç†
         </li>
        </ul>
       </li>
       <li>
        <p>
         ä»£ç å¼€å‘
        </p>
        <pre><code class="prism language-scala"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>table</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{<!-- --></span>DataStream<span class="token punctuation">,</span> StreamExecutionEnvironment<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token punctuation">{<!-- --></span>Table<span class="token punctuation">,</span> Types<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>StreamTableEnvironment
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>types<span class="token punctuation">.</span></span>Row
<span class="token comment">/**
  * ä½¿ç”¨TableApiå®ŒæˆåŸºäºæµæ•°æ®çš„å¤„ç†
  */</span>
<span class="token keyword">object</span> TableFromDataStream <span class="token punctuation">{<!-- --></span>

  <span class="token comment">//todo:å®šä¹‰æ ·ä¾‹ç±»</span>
  <span class="token keyword">case</span> <span class="token keyword">class</span> User<span class="token punctuation">(</span>id<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">,</span>name<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">,</span>age<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
           <span class="token comment">//todo:1ã€æ„å»ºæµå¤„ç†ç¯å¢ƒ</span>
        <span class="token keyword">val</span> streamEnv<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
    streamEnv<span class="token punctuation">.</span>setParallelism<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

     <span class="token comment">//todo:2ã€æ„å»ºTableEnvironment</span>
        <span class="token keyword">val</span> tableEnvironment<span class="token operator">:</span> StreamTableEnvironment <span class="token operator">=</span> StreamTableEnvironment<span class="token punctuation">.</span>create<span class="token punctuation">(</span>streamEnv<span class="token punctuation">)</span>
        <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_

    <span class="token comment">/**
      * 101,zhangsan,18
      * 102,lisi,28
      * 103,wangwu,25
      * 104,zhaoliu,30
      */</span>
     <span class="token comment">//todo:3ã€æ¥å—socketæ•°æ®</span>
        <span class="token keyword">val</span> socketStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> streamEnv<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">"node01"</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span>

     <span class="token comment">//todo:4ã€å¯¹æ•°æ®è¿›è¡Œå¤„ç†</span>
       <span class="token keyword">val</span> userStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span>User<span class="token punctuation">]</span> <span class="token operator">=</span> socketStream<span class="token punctuation">.</span>map<span class="token punctuation">(</span>x<span class="token keyword">=&gt;</span>x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>x<span class="token keyword">=&gt;</span>User<span class="token punctuation">(</span>x<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toInt<span class="token punctuation">,</span>x<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>x<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toInt<span class="token punctuation">)</span><span class="token punctuation">)</span>

     <span class="token comment">//todo:5ã€å°†æµæ³¨å†Œæˆä¸€å¼ è¡¨</span>
      tableEnvironment<span class="token punctuation">.</span>registerDataStream<span class="token punctuation">(</span><span class="token string">"userTable"</span><span class="token punctuation">,</span>userStream<span class="token punctuation">)</span>

    <span class="token comment">//todo:6ã€ä½¿ç”¨table çš„apiæŸ¥è¯¢å¹´é¾„å¤§äº20å²çš„äºº</span>
      <span class="token keyword">val</span> result<span class="token operator">:</span>Table <span class="token operator">=</span> tableEnvironment<span class="token punctuation">.</span>scan<span class="token punctuation">(</span><span class="token string">"userTable"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span><span class="token string">"age &gt;20"</span><span class="token punctuation">)</span>
  <span class="token comment">//todoï¼š7ã€å°†tableè½¬åŒ–æˆæµ</span>
     tableEnvironment<span class="token punctuation">.</span>toAppendStream<span class="token punctuation">[</span>Row<span class="token punctuation">]</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>      
        <span class="token comment">//todo:8ã€å¯åŠ¨</span>
     tableEnvironment<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">"TableFromDataStream"</span><span class="token punctuation">)</span>

  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>  
</code></pre>
       </li>
       <li>
        <p>
         å‘é€æ•°æ®
        </p>
        <pre><code class="prism language-shell"><span class="token function">nc</span> <span class="token parameter variable">-lk</span> <span class="token number">9999</span>

<span class="token number">101</span>,zhangsan,18
<span class="token number">102</span>,lisi,28
<span class="token number">103</span>,wangwu,25
<span class="token number">104</span>,zhaoliu,30
</code></pre>
       </li>
       <li>
        <p>
         <mark>
          DataStreamè½¬æ¢æˆTableé€»è¾‘
         </mark>
        </p>
        <ul>
         <li>
          æ„å»ºStreamExecutionEnvironmentå’ŒStreamTableEnvironmentå¯¹è±¡
          <ul>
           <li>
            StreamTableEnvironment.fromDataStream(dataStream: DataStream)
           </li>
           <li>
            StreamTableEnvironment.registerDataStream(dataStream: DataStream)
           </li>
          </ul>
         </li>
        </ul>
       </li>
      </ul>
     </li>
     <li>
      <p>
       æ›´å¤šçš„table APIæ“ä½œè¯¦ç»†è§å®˜ç½‘
      </p>
      <ul>
       <li>
        <a href="https://ci.apache.org/projects/flink/flink-docs-release-1.10/dev/table/tableApi.html" rel="nofollow">
         https://ci.apache.org/projects/flink/flink-docs-release-1.10/dev/table/tableApi.html
        </a>
       </li>
      </ul>
      <p>
       <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://i-blog.csdnimg.cn/direct/b342bf737e4d4c14a2fb772d26d8a704.png"/>
      </p>
     </li>
    </ul>
    <h6>
     <a id="352___Tablewindow_1214">
     </a>
     3.5.2 Tableä¸­çš„window
    </h6>
    <ul>
     <li>
      <p>
       Flink æ”¯æŒ ProcessTimeã€EventTime å’Œ IngestionTime ä¸‰ç§æ—¶é—´æ¦‚å¿µï¼Œé’ˆå¯¹æ¯ç§æ—¶é—´æ¦‚å¿µï¼ŒFlink Table API ä¸­ä½¿ç”¨
       <code>
        Schema
       </code>
       ä¸­å•ç‹¬çš„å­—æ®µæ¥è¡¨ç¤ºæ—¶é—´å±æ€§ï¼Œå½“æ—¶é—´å­—æ®µè¢«æŒ‡å®šåï¼Œå°±å¯ä»¥åœ¨åŸºäºæ—¶é—´çš„æ“ä½œç®—å­ä¸­ä½¿ç”¨ç›¸åº”çš„æ—¶é—´å±æ€§ã€‚
      </p>
     </li>
     <li>
      <p>
       åœ¨ Table API ä¸­é€šè¿‡ä½¿ç”¨==.rowtime æ¥å®šä¹‰ EventTime å­—æ®µ==ï¼Œåœ¨ ProcessTime æ—¶é—´å­—æ®µååä½¿ç”¨.proctime åç¼€æ¥æŒ‡å®š ProcessTime æ—¶é—´å±æ€§
      </p>
     </li>
     <li>
      <p>
       éœ€æ±‚
      </p>
      <ul>
       <li>
        ç»Ÿè®¡æœ€è¿‘ 5 ç§’é’Ÿï¼Œæ¯ä¸ªå•è¯å‡ºç°çš„æ¬¡æ•°
       </li>
      </ul>
     </li>
     <li>
      <p>
       ä»£ç å¼€å‘
      </p>
      <pre><code class="prism language-scala"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>table</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span>TimeCharacteristic
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span>AssignerWithPeriodicWatermarks
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{<!-- --></span>DataStream<span class="token punctuation">,</span> StreamExecutionEnvironment<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>watermark<span class="token punctuation">.</span></span>Watermark
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token punctuation">{<!-- --></span>GroupWindowedTable<span class="token punctuation">,</span> Table<span class="token punctuation">,</span> Tumble<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>StreamTableEnvironment
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>types<span class="token punctuation">.</span></span>Row

<span class="token comment">/**
  * åŸºäºtableçš„windowçª—å£æ“ä½œå¤„ç†å»¶è¿Ÿæ•°æ®
  */</span>
<span class="token keyword">object</span> TableWindowWaterMark <span class="token punctuation">{<!-- --></span>

  <span class="token comment">//å®šä¹‰æ ·ä¾‹ç±»</span>
  <span class="token keyword">case</span> <span class="token keyword">class</span> Message<span class="token punctuation">(</span>word<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">,</span>createTime<span class="token operator">:</span><span class="token builtin">Long</span><span class="token punctuation">)</span>

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//todo:1ã€æ„å»ºæµå¤„ç†ç¯å¢ƒ</span>
     <span class="token keyword">val</span> streamEnv<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
    streamEnv<span class="token punctuation">.</span>setParallelism<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

      <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_

    <span class="token comment">//æŒ‡å®šEventTimeä¸ºæ—¶é—´è¯­ä¹‰</span>
     streamEnv<span class="token punctuation">.</span>setStreamTimeCharacteristic<span class="token punctuation">(</span>TimeCharacteristic<span class="token punctuation">.</span>EventTime<span class="token punctuation">)</span>

   <span class="token comment">//todo: 2ã€æ„å»ºStreamTableEnvironment</span>
      <span class="token keyword">val</span> tableEnvironment<span class="token operator">:</span> StreamTableEnvironment <span class="token operator">=</span> StreamTableEnvironment<span class="token punctuation">.</span>create<span class="token punctuation">(</span>streamEnv<span class="token punctuation">)</span>

  <span class="token comment">//todoï¼š 3ã€æ¥å—socketæ•°æ®</span>
      <span class="token keyword">val</span> sourceStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> streamEnv<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">"node01"</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span>

  <span class="token comment">//todo: 4ã€æ•°æ®åˆ‡åˆ†å¤„ç†</span>
    <span class="token keyword">val</span> mapStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span>Message<span class="token punctuation">]</span> <span class="token operator">=</span> sourceStream<span class="token punctuation">.</span>map<span class="token punctuation">(</span>x<span class="token keyword">=&gt;</span>Message<span class="token punctuation">(</span>x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toLong<span class="token punctuation">)</span><span class="token punctuation">)</span>

   <span class="token comment">//todo: 5ã€æ·»åŠ watermark</span>
    <span class="token keyword">val</span> watermarksStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span>Message<span class="token punctuation">]</span> <span class="token operator">=</span> mapStream<span class="token punctuation">.</span>assignTimestampsAndWatermarks<span class="token punctuation">(</span><span class="token keyword">new</span> AssignerWithPeriodicWatermarks<span class="token punctuation">[</span>Message<span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>

      <span class="token comment">//å®šä¹‰å»¶è¿Ÿæ—¶é•¿</span>
      <span class="token keyword">val</span> maxOutOfOrderness <span class="token operator">=</span> <span class="token number">5000L</span>
      <span class="token comment">//å†å²æœ€å¤§äº‹ä»¶æ—¶é—´</span>
      <span class="token keyword">var</span> currentMaxTimestamp<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> _

      <span class="token keyword">override</span> <span class="token keyword">def</span> getCurrentWatermark<span class="token operator">:</span> Watermark <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">val</span> watermark <span class="token operator">=</span> <span class="token keyword">new</span> Watermark<span class="token punctuation">(</span>currentMaxTimestamp <span class="token operator">-</span> maxOutOfOrderness<span class="token punctuation">)</span>
        watermark
      <span class="token punctuation">}</span>

      <span class="token keyword">override</span> <span class="token keyword">def</span> extractTimestamp<span class="token punctuation">(</span>element<span class="token operator">:</span> Message<span class="token punctuation">,</span> previousElementTimestamp<span class="token operator">:</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>

        <span class="token keyword">val</span> eventTime<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> element<span class="token punctuation">.</span>createTime
        currentMaxTimestamp <span class="token operator">=</span> Math<span class="token punctuation">.</span>max<span class="token punctuation">(</span>eventTime<span class="token punctuation">,</span> currentMaxTimestamp<span class="token punctuation">)</span>
        eventTime
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    
    <span class="token comment">//todo:6ã€æ„å»ºTable , è®¾ç½®æ—¶é—´å±æ€§</span>
    <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_
     <span class="token keyword">val</span> table<span class="token operator">:</span> Table <span class="token operator">=</span> tableEnvironment<span class="token punctuation">.</span>fromDataStream<span class="token punctuation">(</span>watermarksStream<span class="token punctuation">,</span><span class="token char">'word,'</span>createTime<span class="token punctuation">.</span>rowtime<span class="token punctuation">)</span>
    <span class="token comment">//todo:7ã€æ·»åŠ window</span>
      <span class="token comment">//æ»šåŠ¨çª—å£ç¬¬ä¸€ç§å†™æ³•</span>
  <span class="token comment">//val windowedTable: GroupWindowedTable = table.window(Tumble.over("5.second").on("createTime").as("window"))</span>

     <span class="token comment">//æ»šåŠ¨çª—å£çš„ç¬¬äºŒç§å†™æ³•</span>
 <span class="token keyword">val</span> windowedTable<span class="token operator">:</span> GroupWindowedTable <span class="token operator">=</span> table<span class="token punctuation">.</span>window<span class="token punctuation">(</span>Tumble over <span class="token number">5.</span>second on <span class="token string">'createTime as '</span>window<span class="token punctuation">)</span>

  <span class="token comment">//todo:8ã€å¯¹çª—å£æ•°æ®è¿›è¡Œå¤„ç†</span>
     <span class="token comment">// ä½¿ç”¨2ä¸ªå­—æ®µåˆ†ç»„ï¼Œçª—å£åç§°å’Œå•è¯</span>
  <span class="token keyword">val</span> result<span class="token operator">:</span> Table <span class="token operator">=</span> windowedTable<span class="token punctuation">.</span>groupBy<span class="token punctuation">(</span><span class="token string">'window,'</span>word<span class="token punctuation">)</span>
         <span class="token comment">//å•è¯ã€çª—å£çš„å¼€å§‹ã€ç»“æŸeã€èšåˆè®¡ç®—</span>
                                       <span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token char">'word,'</span>window<span class="token punctuation">.</span>start<span class="token punctuation">,</span><span class="token string">'window.end,'</span>word<span class="token punctuation">.</span>count<span class="token punctuation">)</span>
    <span class="token comment">//todo:9ã€å°†tableè½¬æ¢æˆDataStream</span>
   <span class="token keyword">val</span> resultStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">Boolean</span><span class="token punctuation">,</span> Row<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> tableEnvironment<span class="token punctuation">.</span>toRetractStream<span class="token punctuation">[</span>Row<span class="token punctuation">]</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>

   resultStream<span class="token punctuation">.</span>filter<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span>x<span class="token punctuation">.</span>_1 <span class="token operator">==</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>

   tableEnvironment<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">"table"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
    
</code></pre>
     </li>
     <li>
      <p>
       å‘é€æ•°æ®
      </p>
      <pre><code>hadoop,1461756862000
hadoop,1461756866000
hadoop,1461756864000
hadoop,1461756870000
hadoop,1461756875000
</code></pre>
     </li>
    </ul>
    <h5>
     <a id="36_SQL_1327">
     </a>
     3.6 SQLä½¿ç”¨
    </h5>
    <ul>
     <li>
      SQL ä½œä¸º Flink ä¸­æä¾›çš„æ¥å£ä¹‹ä¸€ï¼Œå æ®ç€éå¸¸é‡è¦çš„åœ°ä½ï¼Œä¸»è¦æ˜¯å› ä¸º SQL å…·æœ‰çµæ´»å’Œä¸°å¯Œçš„è¯­æ³•ï¼Œèƒ½å¤Ÿåº”ç”¨äºå¤§éƒ¨åˆ†çš„è®¡ç®—åœºæ™¯ã€‚
     </li>
     <li>
      Flink SQL åº•å±‚ä½¿ç”¨ Apache Calcite æ¡†æ¶ï¼Œ å°†æ ‡å‡†çš„ Flink SQL è¯­å¥è§£æå¹¶è½¬æ¢æˆåº•å±‚çš„ç®—å­å¤„ç†é€»è¾‘ï¼Œå¹¶åœ¨è½¬æ¢è¿‡ç¨‹ä¸­åŸºäºè¯­æ³•è§„åˆ™å±‚é¢è¿›è¡Œæ€§èƒ½ä¼˜åŒ–ï¼Œæ¯”å¦‚è°“è¯ä¸‹æ¨ç­‰ã€‚å¦å¤–ç”¨æˆ·åœ¨ä½¿ç”¨ SQL ç¼–å†™ Flink åº”ç”¨æ—¶ï¼Œèƒ½å¤Ÿå±è”½åº•å±‚æŠ€æœ¯ç»†èŠ‚ï¼Œèƒ½å¤Ÿæ›´åŠ æ–¹ä¾¿ä¸”é«˜æ•ˆåœ°é€šè¿‡SQLè¯­å¥æ¥æ„å»ºFlinkåº”ç”¨ã€‚
     </li>
     <li>
      Flink SQLæ„å»ºåœ¨Table API ä¹‹ä¸Šï¼Œå¹¶å«ç›–äº†å¤§éƒ¨åˆ†çš„ Table API åŠŸèƒ½ç‰¹æ€§ã€‚åŒæ—¶ Flink SQL å¯ä»¥å’Œ Table API æ··ç”¨ï¼ŒFlink æœ€ç»ˆä¼šåœ¨æ•´ä½“ä¸Šå°†ä»£ç åˆå¹¶åœ¨åŒä¸€å¥—ä»£ç é€»è¾‘ä¸­
     </li>
    </ul>
    <h6>
     <a id="361_SQL_1335">
     </a>
     3.6.1 SQLæ“ä½œ
    </h6>
    <ul>
     <li>
      <p>
       ä»£ç å¼€å‘æ¼”ç¤º
      </p>
      <pre><code class="prism language-scala">
  <span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>table</span>

  <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{<!-- --></span>DataStream<span class="token punctuation">,</span> StreamExecutionEnvironment<span class="token punctuation">}</span>
  <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span>Table
  <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>StreamTableEnvironment
  <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>types<span class="token punctuation">.</span></span>Row

  <span class="token keyword">object</span> FlinkSQLTest <span class="token punctuation">{<!-- --></span>

    <span class="token comment">//todo:å®šä¹‰æ ·ä¾‹ç±»</span>
    <span class="token keyword">case</span> <span class="token keyword">class</span> User<span class="token punctuation">(</span>id<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">,</span>name<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">,</span>age<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">)</span>
     <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> 
          <span class="token comment">//todo:1ã€æ„å»ºæµå¤„ç†ç¯å¢ƒ</span>
        <span class="token keyword">val</span> streamEnv<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
    streamEnv<span class="token punctuation">.</span>setParallelism<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

     <span class="token comment">//todo:2ã€æ„å»ºTableEnvironment</span>
        <span class="token keyword">val</span> tableEnvironment<span class="token operator">:</span> StreamTableEnvironment <span class="token operator">=</span> StreamTableEnvironment<span class="token punctuation">.</span>create<span class="token punctuation">(</span>streamEnv<span class="token punctuation">)</span>
        <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_

    <span class="token comment">/**
      * 101,zhangsan,18
      * 102,lisi,20
      * 103,wangwu,25
      * 104,zhaoliu,15
      */</span>
     <span class="token comment">//todo:3ã€æ¥å—socketæ•°æ®</span>
        <span class="token keyword">val</span> socketStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> streamEnv<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">"node01"</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span>

     <span class="token comment">//todo:4ã€å¯¹æ•°æ®è¿›è¡Œå¤„ç†</span>
       <span class="token keyword">val</span> userStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span>User<span class="token punctuation">]</span> <span class="token operator">=</span> socketStream<span class="token punctuation">.</span>map<span class="token punctuation">(</span>x<span class="token keyword">=&gt;</span>x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>x<span class="token keyword">=&gt;</span>User<span class="token punctuation">(</span>x<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toInt<span class="token punctuation">,</span>x<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>x<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toInt<span class="token punctuation">)</span><span class="token punctuation">)</span>

     <span class="token comment">//todo:5ã€å°†æµæ³¨å†Œæˆä¸€å¼ è¡¨</span>
      tableEnvironment<span class="token punctuation">.</span>registerDataStream<span class="token punctuation">(</span><span class="token string">"userTable"</span><span class="token punctuation">,</span>userStream<span class="token punctuation">)</span>

    <span class="token comment">//todo:6ã€ä½¿ç”¨table çš„apiæŸ¥è¯¢å¹´é¾„å¤§äº20å²çš„äºº</span>
      <span class="token keyword">val</span> result<span class="token operator">:</span>Table <span class="token operator">=</span> tableEnvironment<span class="token punctuation">.</span>sqlQuery<span class="token punctuation">(</span><span class="token string">"select * from userTable where age &gt;20"</span><span class="token punctuation">)</span>
        <span class="token comment">//todoï¼š7ã€å°†tableè½¬åŒ–æˆæµ</span>
     tableEnvironment<span class="token punctuation">.</span>toAppendStream<span class="token punctuation">[</span>Row<span class="token punctuation">]</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">//todo:8ã€å¯åŠ¨</span>
     tableEnvironment<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">"TableFromDataStream"</span><span class="token punctuation">)</span>

  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>   
</code></pre>
     </li>
     <li>
      <p>
       å‘é€æ•°æ®
      </p>
      <pre><code>101,zhangsan,18
102,lisi,20
103,wangwu,25
104,zhaoliu,15
</code></pre>
     </li>
     <li>
      <p>
       å°†Tableè½¬æ¢æˆä¸ºDataStreamçš„ä¸¤ç§æ¨¡å¼
      </p>
      <ul>
       <li>
        <p>
         ç¬¬ä¸€ç§æ–¹å¼ï¼šAppendMode(è¿½åŠ æ¨¡å¼)
        </p>
        <pre><code>   å°†è¡¨é™„åŠ åˆ°æµæ•°æ®ï¼Œè¡¨å½“ä¸­åªèƒ½æœ‰æŸ¥è¯¢æˆ–è€…æ·»åŠ æ“ä½œï¼Œå¦‚æœæœ‰updateæˆ–è€…deleteæ“ä½œï¼Œé‚£ä¹ˆå°±ä¼šå¤±è´¥ã€‚
 åªæœ‰åœ¨åŠ¨æ€Tableä»…é€šè¿‡INSERTæ—¶æ‰èƒ½ä½¿ç”¨æ­¤æ¨¡å¼ï¼Œå³å®ƒä»…é™„åŠ ï¼Œå¹¶ä¸”ä»¥å‰å‘å‡ºçš„ç»“æœæ°¸è¿œä¸ä¼šæ›´æ–°ã€‚
 å¦‚æœæ›´æ–°æˆ–åˆ é™¤æ“ä½œä½¿ç”¨è¿½åŠ æ¨¡å¼ä¼šå¤±è´¥æŠ¥é”™ã€‚
</code></pre>
       </li>
       <li>
        <p>
         ç¬¬äºŒç§æ¨¡å¼ï¼šRetractModeï¼ˆæ’¤å›æ¨¡å¼ï¼‰
        </p>
        <pre><code>     å§‹ç»ˆå¯ä»¥ä½¿ç”¨æ­¤æ¨¡å¼ã€‚è¿”å›å€¼æ˜¯booleanç±»å‹ã€‚
     å®ƒç”¨trueæˆ–falseæ¥æ ‡è®°æ•°æ®çš„æ’å…¥å’Œæ’¤å›ï¼Œè¿”å›trueä»£è¡¨æ•°æ®æ’å…¥ï¼Œfalseä»£è¡¨æ•°æ®çš„æ’¤å›ã€‚
</code></pre>
       </li>
      </ul>
     </li>
     <li>
      <p>
       æŒ‰ç…§å®˜ç½‘çš„ç†è§£å¦‚æœæ•°æ®åªæ˜¯ä¸æ–­æ·»åŠ ï¼Œå¯ä»¥ä½¿ç”¨è¿½åŠ æ¨¡å¼ï¼Œå…¶ä½™æ–¹å¼åˆ™ä¸å¯ä»¥ä½¿ç”¨è¿½åŠ æ¨¡å¼ï¼Œè€Œæ’¤å›æ¨¡å¼ä¾§å¯ä»¥é€‚ç”¨äºæ›´æ–°ï¼Œåˆ é™¤ç­‰åœºæ™¯ã€‚å…·ä½“çš„åŒºåˆ« å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š
      </p>
      <p>
       <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://i-blog.csdnimg.cn/direct/4164122060e040aebb8ae2edcb7ff5e1.png"/>
      </p>
      <p>
       <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://i-blog.csdnimg.cn/direct/ef5057757336486a87e7c62e5d953d4b.png"/>
      </p>
     </li>
     <li>
      <p>
       é€šè¿‡ä¸Šå›¾å¯ä»¥æ¸…æ™°çš„çœ‹åˆ°ä¸¤ç§æ–¹å¼çš„åŒºåˆ«ï¼Œæˆ‘ä»¬åœ¨åˆ©ç”¨flinkSQLå¤„ç†å®æ—¶æ•°æ®æŠŠè¡¨è½¬åŒ–æˆæµçš„æ—¶å€™ï¼Œå¦‚æœä½¿ç”¨çš„sqlè¯­å¥åŒ…å«ï¼šcountï¼ˆï¼‰ group byæ—¶ï¼Œå¿…é¡»ä½¿ç”¨RetractModeæ’¤å›æ¨¡å¼ã€‚
      </p>
     </li>
    </ul>
    <h6>
     <a id="362_SQLwindow_1433">
     </a>
     3.6.2 SQLä¸­çš„window
    </h6>
    <ul>
     <li>
      <p>
       Flink SQL ä¹Ÿæ”¯æŒä¸‰ç§çª—å£ç±»å‹ï¼Œåˆ†åˆ«ä¸º Tumble Windowsã€HOP Windows å’Œ Session Windowsï¼Œå…¶ä¸­ HOP Windows å¯¹åº” Table API ä¸­çš„ Sliding Windowï¼ŒåŒæ—¶æ¯ç§çª—å£åˆ†åˆ«æœ‰ç›¸åº”çš„ä½¿ç”¨åœºæ™¯å’Œæ–¹æ³•ã€‚
      </p>
     </li>
     <li>
      <p>
       éœ€æ±‚
      </p>
      <ul>
       <li>
        ç»Ÿè®¡æœ€è¿‘ 5 ç§’é’Ÿï¼Œæ¯ä¸ªå•è¯å‡ºç°çš„æ¬¡æ•°
       </li>
      </ul>
     </li>
     <li>
      <p>
       ä»£ç å¼€å‘
      </p>
      <pre><code class="prism language-scala"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>table</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span>TimeCharacteristic
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span>AssignerWithPeriodicWatermarks
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{<!-- --></span>DataStream<span class="token punctuation">,</span> StreamExecutionEnvironment<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>watermark<span class="token punctuation">.</span></span>Watermark
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>StreamTableEnvironment
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token punctuation">{<!-- --></span>GroupWindowedTable<span class="token punctuation">,</span> Table<span class="token punctuation">,</span> Tumble<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>types<span class="token punctuation">.</span></span>Row

<span class="token comment">/**
  * åŸºäºSQLçš„windowçª—å£æ“ä½œå¤„ç†å»¶è¿Ÿæ•°æ®
  */</span>
<span class="token keyword">object</span> SQLWindowWaterMark <span class="token punctuation">{<!-- --></span>

  <span class="token comment">//å®šä¹‰æ ·ä¾‹ç±»</span>
  <span class="token keyword">case</span> <span class="token keyword">class</span> Message<span class="token punctuation">(</span>word<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">,</span>createTime<span class="token operator">:</span><span class="token builtin">Long</span><span class="token punctuation">)</span>

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//todo:1ã€æ„å»ºæµå¤„ç†ç¯å¢ƒ</span>
     <span class="token keyword">val</span> streamEnv<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
    streamEnv<span class="token punctuation">.</span>setParallelism<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

      <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_

    <span class="token comment">//æŒ‡å®šEventTimeä¸ºæ—¶é—´è¯­ä¹‰</span>
     streamEnv<span class="token punctuation">.</span>setStreamTimeCharacteristic<span class="token punctuation">(</span>TimeCharacteristic<span class="token punctuation">.</span>EventTime<span class="token punctuation">)</span>

   <span class="token comment">//todo: 2ã€æ„å»ºStreamTableEnvironment</span>
      <span class="token keyword">val</span> tableEnvironment<span class="token operator">:</span> StreamTableEnvironment <span class="token operator">=</span> StreamTableEnvironment<span class="token punctuation">.</span>create<span class="token punctuation">(</span>streamEnv<span class="token punctuation">)</span>

  <span class="token comment">//todoï¼š 3ã€æ¥å—socketæ•°æ®</span>
      <span class="token keyword">val</span> sourceStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> streamEnv<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">"node01"</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span>

  <span class="token comment">//todo: 4ã€æ•°æ®åˆ‡åˆ†å¤„ç†</span>
    <span class="token keyword">val</span> mapStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span>Message<span class="token punctuation">]</span> <span class="token operator">=</span> sourceStream<span class="token punctuation">.</span>map<span class="token punctuation">(</span>x<span class="token keyword">=&gt;</span>Message<span class="token punctuation">(</span>x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toLong<span class="token punctuation">)</span><span class="token punctuation">)</span>

   <span class="token comment">//todo: 5ã€æ·»åŠ watermark</span>
    <span class="token keyword">val</span> watermarksStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span>Message<span class="token punctuation">]</span> <span class="token operator">=</span> mapStream<span class="token punctuation">.</span>assignTimestampsAndWatermarks<span class="token punctuation">(</span><span class="token keyword">new</span> AssignerWithPeriodicWatermarks<span class="token punctuation">[</span>Message<span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>

      <span class="token comment">//å®šä¹‰å»¶è¿Ÿæ—¶é•¿</span>
      <span class="token keyword">val</span> maxOutOfOrderness <span class="token operator">=</span> <span class="token number">5000L</span>
      <span class="token comment">//å†å²æœ€å¤§äº‹ä»¶æ—¶é—´</span>
      <span class="token keyword">var</span> currentMaxTimestamp<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> _

      <span class="token keyword">override</span> <span class="token keyword">def</span> getCurrentWatermark<span class="token operator">:</span> Watermark <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">val</span> watermark <span class="token operator">=</span> <span class="token keyword">new</span> Watermark<span class="token punctuation">(</span>currentMaxTimestamp <span class="token operator">-</span> maxOutOfOrderness<span class="token punctuation">)</span>
        watermark
      <span class="token punctuation">}</span>

      <span class="token keyword">override</span> <span class="token keyword">def</span> extractTimestamp<span class="token punctuation">(</span>element<span class="token operator">:</span> Message<span class="token punctuation">,</span> previousElementTimestamp<span class="token operator">:</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>

        <span class="token keyword">val</span> eventTime<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> element<span class="token punctuation">.</span>createTime
        currentMaxTimestamp <span class="token operator">=</span> Math<span class="token punctuation">.</span>max<span class="token punctuation">(</span>eventTime<span class="token punctuation">,</span> currentMaxTimestamp<span class="token punctuation">)</span>
        eventTime
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token comment">//todo:6ã€æ³¨å†ŒDataStreamæˆè¡¨ ï¼Œè®¾ç½®æ—¶é—´å±æ€§</span>
     <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_
    tableEnvironment<span class="token punctuation">.</span>registerDataStream<span class="token punctuation">(</span><span class="token string">"t_socket"</span><span class="token punctuation">,</span>watermarksStream<span class="token punctuation">,</span><span class="token char">'word,'</span>createTime<span class="token punctuation">.</span>rowtime<span class="token punctuation">)</span>  
   <span class="token comment">//todo:7ã€sqlæŸ¥è¯¢---æ·»åŠ window---æ»šåŠ¨çª—å£----çª—å£é•¿åº¦5s</span>
  <span class="token keyword">val</span> result<span class="token operator">:</span> Table <span class="token operator">=</span> tableEnvironment<span class="token punctuation">.</span>sqlQuery<span class="token punctuation">(</span><span class="token string">"select word,count(*) from t_socket group by tumble(createTime,interval '5' second),word"</span><span class="token punctuation">)</span>   
   <span class="token comment">//todo:8ã€å°†tableè½¬æ¢æˆDataStream</span>
   <span class="token keyword">val</span> resultStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">Boolean</span><span class="token punctuation">,</span> Row<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> tableEnvironment<span class="token punctuation">.</span>toRetractStream<span class="token punctuation">[</span>Row<span class="token punctuation">]</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>

   resultStream<span class="token punctuation">.</span>filter<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span>x<span class="token punctuation">.</span>_1 <span class="token operator">==</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>

   tableEnvironment<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">"table"</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>   
  <span class="token punctuation">}</span>  
</code></pre>
     </li>
     <li>
      <p>
       å‘é€æ•°æ®
      </p>
     </li>
    </ul>
    <pre><code>hadoop,1461756862000
hadoop,1461756865000
hadoop,1461756863000
hadoop,1461756868000
hadoop,1461756870000
hadoop,1461756875000
hadoop,1461756880000
</code></pre>
    <ul>
     <li>
      <p>
       æ›´å¤šçš„SQLæ“ä½œè¯¦ç»†è§å®˜ç½‘
      </p>
      <ul>
       <li>
        <p>
         <a href="https://ci.apache.org/projects/flink/flink-docs-release-1.10/dev/table/sql/queries.html" rel="nofollow">
          https://ci.apache.org/projects/flink/flink-docs-release-1.10/dev/table/sql/queries.html
         </a>
        </p>
        <p>
         <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://i-blog.csdnimg.cn/direct/1025b20325974516857e0715f06771b9.png"/>
        </p>
       </li>
      </ul>
     </li>
    </ul>
    <h3>
     <a id="_1546">
     </a>
     æŠŠæ‰€æœ‰çš„ä»£ç éƒ½æ•²ä¸€é
    </h3>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f:626c6f672e6373646e2e6e65742f753031303334323231332f:61727469636c652f64657461696c732f313436313033313938" class_="artid" style="display:none">
 </p>
</div>


