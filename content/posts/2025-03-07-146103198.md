---
layout: post
title: "Flink深入浅出之04时间水印TableSQL"
date: 2025-03-07 23:47:49 +0800
description: "在Spark中有DataFrame这样的关系型编程接口，因其强大且灵活的表达能力，能够让用户通过非常丰富的接口对数据进行处理，有效降低了用户的使用成本。Flink也提供了关系型编程接口 Table API 以及基于Table API 的 SQL API，让用户能够通过使用结构化编程接口高效地构建Flink应用。同时Table API 以及 SQL 能够统一处理批量和实时计算业务，无须切换修改任何应用代码就能够基于同一套 API 编写流式应用和批量应用，从而达到真正意义的批流统一。"
keywords: "Flink深入浅出之04：时间、水印、Table&SQL"
categories: ['大数据技术学习']
tags: ['数据库', 'Sql', 'Flink']
artid: "146103198"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146103198
    alt: "Flink深入浅出之04时间水印TableSQL"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146103198
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146103198
cover: https://bing.ee123.net/img/rand?artid=146103198
image: https://bing.ee123.net/img/rand?artid=146103198
img: https://bing.ee123.net/img/rand?artid=146103198
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Flink深入浅出之04：时间、水印、Table&amp;SQL
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h3>
     <a id="FlinkwaterMarkFlink_TableSQL_2">
     </a>
     深入理解Flink的waterMark的机制、Flink Table和SQL开发
    </h3>
    <h3>
     <a id="three__6">
     </a>
     3️⃣ 目标
    </h3>
    <ol>
     <li>
      掌握WaterMark的的原理
     </li>
     <li>
      掌握WaterMark的运用
     </li>
     <li>
      掌握Flink Table和SQL开发
     </li>
    </ol>
    <h3>
     <a id="four__14">
     </a>
     4️⃣ 要点
    </h3>
    <h3>
     <a id="book_1_FlinkTime_16">
     </a>
     📖 1. Flink中的Time概念
    </h3>
    <ul>
     <li>
      <p>
       对于流式数据处理，最大的特点是数据上具有时间的属性特征
      </p>
     </li>
     <li>
      <p>
       Flink根据时间产生的位置不同，可以将时间区分为三种时间概念
      </p>
      <ul>
       <li>
        <mark>
         Event Time
        </mark>
        （事件生成时间）
        <ul>
         <li>
          事件产生的时间，它通常由事件中的时间戳描述
         </li>
        </ul>
       </li>
       <li>
        <mark>
         Ingestion time
        </mark>
        （事件接入时间）
        <ul>
         <li>
          事件进入Flink程序的时间
         </li>
        </ul>
       </li>
       <li>
        <mark>
         Processing Time
        </mark>
        （事件处理时间）
        <ul>
         <li>
          事件被处理时当前系统的时间
         </li>
        </ul>
       </li>
      </ul>
     </li>
    </ul>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/826ec0aef5164a009102259070b97b96.png"/>
    </p>
    <ul>
     <li>
      Flink在流处理程序中支持不同的时间概念。
     </li>
    </ul>
    <h5>
     <a id="11_EventTime_34">
     </a>
     1.1 EventTime
    </h5>
    <ul>
     <li>
      1、事件生成时的时间，在进入Flink之前就已经存在，可以从event的字段中抽取
     </li>
     <li>
      2、必须指定watermarks（水位线）的生成方式
     </li>
     <li>
      3、优势：确定性，乱序、延时、或者数据重放等情况，都能给出正确的结果
     </li>
     <li>
      4、弱点：处理无序事件时性能和延迟受到影响
     </li>
    </ul>
    <h5>
     <a id="12_IngestTime_45">
     </a>
     1.2 IngestTime
    </h5>
    <ul>
     <li>
      1、事件进入flink的时间，即在source里获取的当前系统的时间，后续操作统一使用该时间。
     </li>
     <li>
      2、不需要指定watermarks的生成方式(自动生成)
     </li>
     <li>
      3、弱点：不能处理无序事件和延迟数据
     </li>
    </ul>
    <h5>
     <a id="13_ProcessingTime_55">
     </a>
     1.3 ProcessingTime
    </h5>
    <ul>
     <li>
      <p>
       1、执行操作的机器的当前系统时间(每个算子都不一样)
      </p>
     </li>
     <li>
      <p>
       2、不需要流和机器之间的协调
      </p>
     </li>
     <li>
      <p>
       3、优势：最佳的性能和最低的延迟
      </p>
     </li>
     <li>
      <p>
       4、弱点：不确定性 ，容易受到各种因素影像(event产生的速度、到达flink的速度、在算子之间传输速度等)，压根就不管顺序和延迟
      </p>
     </li>
    </ul>
    <h5>
     <a id="14__67">
     </a>
     1.4 三种时间的综合比较
    </h5>
    <ul>
     <li>
      <p>
       性能
      </p>
      <ul>
       <li>
        ProcessingTime &gt; IngestTime &gt; EventTime
       </li>
      </ul>
     </li>
     <li>
      <p>
       延迟
      </p>
      <ul>
       <li>
        ProcessingTime &lt; IngestTime &lt; EventTime
       </li>
      </ul>
     </li>
     <li>
      <p>
       确定性
      </p>
      <ul>
       <li>
        EventTime &gt; IngestTime &gt; ProcessingTime
       </li>
      </ul>
     </li>
    </ul>
    <h5>
     <a id="15__Time__82">
     </a>
     1.5 设置 Time 类型
    </h5>
    <ul>
     <li>
      <p>
       可以你的流处理程序是以哪一种时间为标志的。
      </p>
      <ul>
       <li>
        在我们创建StreamExecutionEnvironment的时候可以设置Time类型，不设置Time类型，默认是ProcessingTime。
       </li>
       <li>
        如果设置Time类型为EventTime或者IngestTime，需要在创建StreamExecutionEnvironment中调用setStreamTimeCharacteristic() 方法指定。
       </li>
      </ul>
      <pre><code class="prism language-scala"><span class="token keyword">val</span> environment<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment

<span class="token comment">//不设置Time 类型，默认是processingTime。</span>
environment<span class="token punctuation">.</span>setStreamTimeCharacteristic<span class="token punctuation">(</span>TimeCharacteristic<span class="token punctuation">.</span>ProcessingTime<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//指定流处理程序以IngestionTime为准</span>
<span class="token comment">//environment.setStreamTimeCharacteristic(TimeCharacteristic.IngestionTime);</span>

<span class="token comment">//指定流处理程序以EventTime为准</span>
<span class="token comment">//environment.setStreamTimeCharacteristic(TimeCharacteristic.EventTime);</span>

</code></pre>
     </li>
    </ul>
    <h5>
     <a id="16_ProcessWindowFunction_104">
     </a>
     1.6 ProcessWindowFunction实现时间确定
    </h5>
    <ul>
     <li>
      <p>
       需求
      </p>
      <ul>
       <li>
        通过process实现处理时间的确定，包括数据时间、window时间等
       </li>
      </ul>
     </li>
     <li>
      <p>
       代码开发
      </p>
      <pre><code class="prism language-scala"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>time</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang3<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span>FastDateFormat
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span></span>Tuple
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span>function<span class="token punctuation">.</span></span>ProcessWindowFunction
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{<!-- --></span>DataStream<span class="token punctuation">,</span> StreamExecutionEnvironment<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span>Time
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>windows<span class="token punctuation">.</span></span>TimeWindow
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Collector

<span class="token comment">/**
  * 通过process实现处理时间的确定，包括数据时间，window时间等
  */</span>
<span class="token keyword">object</span> TimeWindowWordCount <span class="token punctuation">{<!-- --></span>

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">val</span> environment<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
    <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_

    <span class="token keyword">val</span> socketSource<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> environment<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">"node01"</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span>
     <span class="token comment">//对数据进行处理</span>
    socketSource<span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span>map<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span>keyBy<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span>timeWindow<span class="token punctuation">(</span>Time<span class="token punctuation">.</span>seconds<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>Time<span class="token punctuation">.</span>seconds<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span>process<span class="token punctuation">(</span><span class="token keyword">new</span> SumProcessFunction<span class="token punctuation">)</span>
                <span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>

    environment<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token keyword">class</span> SumProcessFunction <span class="token keyword">extends</span> ProcessWindowFunction<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span><span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span><span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">,</span>Tuple<span class="token punctuation">,</span>TimeWindow<span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span>

  <span class="token keyword">val</span> format<span class="token operator">:</span> FastDateFormat <span class="token operator">=</span> FastDateFormat<span class="token punctuation">.</span>getInstance<span class="token punctuation">(</span><span class="token string">"HH:mm:ss"</span><span class="token punctuation">)</span>

  <span class="token keyword">override</span> <span class="token keyword">def</span> process<span class="token punctuation">(</span>key<span class="token operator">:</span> Tuple<span class="token punctuation">,</span> context<span class="token operator">:</span> Context<span class="token punctuation">,</span> elements<span class="token operator">:</span> Iterable<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> out<span class="token operator">:</span> Collector<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>

    println<span class="token punctuation">(</span><span class="token string">"当前系统时间为："</span><span class="token operator">+</span>format<span class="token punctuation">.</span>format<span class="token punctuation">(</span>System<span class="token punctuation">.</span>currentTimeMillis<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    println<span class="token punctuation">(</span><span class="token string">"window的处理时间为："</span><span class="token operator">+</span>format<span class="token punctuation">.</span>format<span class="token punctuation">(</span>context<span class="token punctuation">.</span>currentProcessingTime<span class="token punctuation">)</span><span class="token punctuation">)</span>
    println<span class="token punctuation">(</span><span class="token string">"window的开始时间为："</span><span class="token operator">+</span>format<span class="token punctuation">.</span>format<span class="token punctuation">(</span>context<span class="token punctuation">.</span>window<span class="token punctuation">.</span>getStart<span class="token punctuation">)</span><span class="token punctuation">)</span>
    println<span class="token punctuation">(</span><span class="token string">"window的结束时间为："</span><span class="token operator">+</span>format<span class="token punctuation">.</span>format<span class="token punctuation">(</span>context<span class="token punctuation">.</span>window<span class="token punctuation">.</span>getEnd<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">var</span> sum<span class="token operator">:</span><span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>eachElement <span class="token keyword">&lt;-</span> elements<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
      sum <span class="token operator">+=</span> eachElement<span class="token punctuation">.</span>_2
    <span class="token punctuation">}</span>
    out<span class="token punctuation">.</span>collect<span class="token punctuation">(</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span>getField<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>sum<span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre>
     </li>
    </ul>
    <h3>
     <a id="book_2_Watermark_172">
     </a>
     📖 2. Watermark机制
    </h3>
    <h5>
     <a id="21_Watermark_174">
     </a>
     2.1 Watermark的概念
    </h5>
    <pre><code>   通常情况下由于网络或者系统等外部因素影响下，
   事件数据往往不能及时传输至FLink系统中，
   导致系统的不稳定而造成数据乱序到达或者延迟达到等问题，
   因此需要有一种机制能够控制数据处理的进度。
   
   具体来讲，在创建一个基于时间的window后，需要确定属于该window的数据元素是否已经全部到达，
   确定后才可以对window中的所有数据做计算处理（如汇总、分组），
   如果数据并没有全部到达，则继续等待该窗口的数据全部到达后再开始计算。
	
   但是对于但是对于late element，我们又不能无限期的等下去，必须要有个机制来保证一个特定的时间后，必须触发window去进行计算了。在这种情况下就需要用到水位线 (Watermark) 机制。

</code></pre>
    <h5>
     <a id="22_Watermark_192">
     </a>
     2.2 Watermark的作用
    </h5>
    <pre><code>    它能够衡量数据处理进度，保证事件数据全部到达Flink系统，即使数据乱序或者延迟到达，也能够像预期一样计算出正确和连续的结果。通常watermark是结合window来实现。
</code></pre>
    <h5>
     <a id="23_Watermark_200">
     </a>
     2.3 Watermark的原理
    </h5>
    <pre><code>   在 Flink 的窗口处理过程中，如果确定全部数据到达，就可以对 Window 的所有数据做窗口计算操作（如汇总、分组等），
   如果数据没有全部到达，则继续等待该窗口中的数据全部到达才开始处理。
   这种情况下就需要用到水位线（WaterMarks）机制，它能够衡量数据处理进度（表达数据到达的完整性），
   保证事件数据（全部）到达Flink系统，
   或者在乱序及延迟到达时，
   也能够像预期一样计算出正确并且连续的结果。
   当任何 Event 进入到 Flink 系统时，会根据当前最大事件时间产生 Watermarks 时间戳。 
   
</code></pre>
    <ul>
     <li>
      <p>
       那么 Flink 是怎么计算 Watermark 的值呢？
       <br/>
       ⭐️
      </p>
      <ul>
       <li>
        <mark>
         Watermark = 进入 Flink 的最大的事件产生时间（maxEventTime）— 指定的乱序时间（t）
        </mark>
       </li>
      </ul>
     </li>
     <li>
      <p>
       <mark>
        那么有 Watermark 的 Window 是怎么触发窗口函数的呢？
       </mark>
      </p>
     </li>
    </ul>
    <blockquote>
     <p>
      （1） watermark &gt;= window的结束时间
      <br/>
      （2） 该窗口必须有数据 注意：[window_start_time,window_end_time) 中有数据存在，前闭后开区间
     </p>
    </blockquote>
    <ul>
     <li>
      <mark>
       注意
      </mark>
      ：Watermark 本质可以理解成一个延迟触发机制。
     </li>
    </ul>
    <h5>
     <a id="24_Watermark__226">
     </a>
     2.4 Watermark 的使用存在三种情况
    </h5>
    <ul>
     <li>
      <p>
       （1）有序的数据流中的watermark
      </p>
      <pre><code>	如果数据元素的事件时间是有序的，Watermark 时间戳会随着数据元素的事件时间按顺序生成，
	此时水位线的变化和事件时间保持一直（因为既然是有序的时间，就不需要设置延迟了，那么 t 就是 0。
	所以 watermark=maxtime-0 = maxtime），也就是理想状态下的水位线。
	当 Watermark 时间大于 Windows 结束时间就会触发对 Windows 的数据计算，
	以此类推， 下一个 Window 也是一样。
</code></pre>
      <p>
       <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/30c7be7e2e93440f83d22481cf7a7500.png"/>
      </p>
     </li>
     <li>
      <p>
       （2）乱序的数据流watermark
      </p>
      <pre><code>	现实情况下数据元素往往并不是按照其产生顺序接入到 Flink 系统中进行处理，
	而频繁出现乱序或迟到的情况，这种情况就需要使用 Watermarks 来应对。
	比如下图，设置延迟时间t为2。
</code></pre>
      <p>
       <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/0e2bafa323b143aea4da02e3d4d59a5c.png"/>
      </p>
     </li>
     <li>
      <p>
       （3）并行数据流中的 Watermark
      </p>
      <pre><code>	在多并行度的情况下，Watermark 会有一个对齐机制，这个对齐机制会取所有 Channel 中最小的 Watermark。
</code></pre>
      <p>
       <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/f221cedd57984ffca69ade8583883606.png"/>
      </p>
     </li>
    </ul>
    <h5>
     <a id="25_watermarkeventtime_261">
     </a>
     2.5 引入watermark和eventtime
    </h5>
    <h6>
     <a id="251__Watermark__EventTime_263">
     </a>
     2.5.1 有序数据流中引入 Watermark 和 EventTime
    </h6>
    <ul>
     <li>
      <p>
       它会将数据中的timestamp根据指定的字段提取得到Eventtime，然后使用Eventtime作为最新的watermark, 这种适合于事件按顺序生成，没有乱序事件的情况。
      </p>
     </li>
     <li>
      <p>
       对于有序的数据，代码比较简洁，主要需要从源 Event 中抽取 EventTime。
      </p>
     </li>
     <li>
      <p>
       需求
      </p>
      <ul>
       <li>
        对socket中有序（按照时间递增）的数据流，进行每5s处理一次
       </li>
      </ul>
     </li>
     <li>
      <p>
       代码演示
      </p>
     </li>
    </ul>
    <pre><code class="prism language-scala"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>watermark</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang3<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span>FastDateFormat
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token punctuation">{<!-- --></span>MapFunction<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span></span>Tuple
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span>TimeCharacteristic
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span>function<span class="token punctuation">.</span></span>ProcessWindowFunction
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{<!-- --></span>DataStream<span class="token punctuation">,</span> StreamExecutionEnvironment<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span>Time
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>windows<span class="token punctuation">.</span></span>TimeWindow
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Collector

<span class="token keyword">object</span> OrderedStreamWaterMark <span class="token punctuation">{<!-- --></span>

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>

      <span class="token comment">//todo:1.构建流式处理环境</span>
      <span class="token keyword">val</span> environment<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
      <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_
      environment<span class="token punctuation">.</span>setParallelism<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

     <span class="token comment">//todo:2.设置时间类型</span>
     environment<span class="token punctuation">.</span>setStreamTimeCharacteristic<span class="token punctuation">(</span>TimeCharacteristic<span class="token punctuation">.</span>EventTime<span class="token punctuation">)</span>

    <span class="token comment">//todo:3.获取数据源</span>
      <span class="token keyword">val</span> sourceStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> environment<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">"node01"</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span>

    <span class="token comment">//todo:4. 数据处理</span>
      <span class="token keyword">val</span> mapStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> sourceStream<span class="token punctuation">.</span>map<span class="token punctuation">(</span>x<span class="token keyword">=&gt;</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toLong<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment">//todo: 5.从源Event中抽取eventTime</span>
        <span class="token keyword">val</span> watermarkStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> mapStream<span class="token punctuation">.</span>assignAscendingTimestamps<span class="token punctuation">(</span>x<span class="token keyword">=&gt;</span>x<span class="token punctuation">.</span>_2<span class="token punctuation">)</span>


    <span class="token comment">//todo:6. 数据计算</span>
     watermarkStream<span class="token punctuation">.</span>keyBy<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span>timeWindow<span class="token punctuation">(</span>Time<span class="token punctuation">.</span>seconds<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span>process<span class="token punctuation">(</span><span class="token keyword">new</span> ProcessWindowFunction<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span><span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">,</span>Tuple<span class="token punctuation">,</span>TimeWindow<span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">override</span> <span class="token keyword">def</span> process<span class="token punctuation">(</span>key<span class="token operator">:</span> Tuple<span class="token punctuation">,</span> context<span class="token operator">:</span> Context<span class="token punctuation">,</span> elements<span class="token operator">:</span> Iterable<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> out<span class="token operator">:</span> Collector<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>

                          <span class="token keyword">val</span> value<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> key<span class="token punctuation">.</span>getField<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

                          <span class="token comment">//窗口的开始时间</span>
                          <span class="token keyword">val</span> startTime<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>window<span class="token punctuation">.</span>getStart
                          <span class="token comment">//窗口的结束时间</span>
                          <span class="token keyword">val</span> startEnd<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>window<span class="token punctuation">.</span>getEnd

                          <span class="token comment">//获取当前的 watermark</span>
                          <span class="token keyword">val</span> watermark<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>currentWatermark

                          <span class="token keyword">var</span> sum<span class="token operator">:</span><span class="token builtin">Long</span> <span class="token operator">=</span> <span class="token number">0</span>
                          <span class="token keyword">val</span> toList<span class="token operator">:</span> List<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> elements<span class="token punctuation">.</span>toList
                          <span class="token keyword">for</span><span class="token punctuation">(</span>eachElement <span class="token keyword">&lt;-</span>  toList<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                            sum <span class="token operator">+=</span><span class="token number">1</span>
                          <span class="token punctuation">}</span>


                          println<span class="token punctuation">(</span><span class="token string">"窗口的数据条数:"</span><span class="token operator">+</span>sum<span class="token operator">+</span>
                            <span class="token string">" |窗口的第一条数据："</span><span class="token operator">+</span>toList<span class="token punctuation">.</span>head<span class="token operator">+</span>
                            <span class="token string">" |窗口的最后一条数据："</span><span class="token operator">+</span>toList<span class="token punctuation">.</span>last<span class="token operator">+</span>
                            <span class="token string">" |窗口的开始时间： "</span><span class="token operator">+</span> startTime<span class="token operator">+</span>
                            <span class="token string">" |窗口的结束时间： "</span><span class="token operator">+</span> startEnd<span class="token operator">+</span>
                            <span class="token string">" |当前的watermark:"</span><span class="token operator">+</span> watermark<span class="token punctuation">)</span>

                          out<span class="token punctuation">.</span>collect<span class="token punctuation">(</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span>sum<span class="token punctuation">)</span><span class="token punctuation">)</span>

                        <span class="token punctuation">}</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>

    environment<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre>
    <ul>
     <li>
      发送数据
     </li>
    </ul>
    <pre><code>000001,1461756862000
000001,1461756866000
000001,1461756872000
000001,1461756873000
000001,1461756874000
000001,1461756875000
</code></pre>
    <h6>
     <a id="252__Watermark__EventTime_363">
     </a>
     2.5.2 乱序数据流中引入 Watermark 和 EventTime
    </h6>
    <p>
     对于乱序数据流，有两种常见的引入方法：周期性和间断性
    </p>
    <ul>
     <li>
      <p>
       1、With Periodic（周期性的） Watermark
      </p>
      <pre><code>	周期性地生成 Watermark 的生成，默认是 100ms。每隔 N 毫秒自动向流里注入一个 Watermark，时间间隔由 streamEnv.getConfig.setAutoWatermarkInterval()决定。
</code></pre>
      <ul>
       <li>
        需求
        <ul>
         <li>
          对socket中无序数据流，进行每5s处理一次，数据中会有延迟
         </li>
        </ul>
       </li>
       <li>
        代码演示
       </li>
      </ul>
      <pre><code class="prism language-scala"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>watermark</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span></span>Tuple
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span>TimeCharacteristic
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span>AssignerWithPeriodicWatermarks
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{<!-- --></span>DataStream<span class="token punctuation">,</span> StreamExecutionEnvironment<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span>function<span class="token punctuation">.</span></span>ProcessWindowFunction
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>watermark<span class="token punctuation">.</span></span>Watermark
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span>Time
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>windows<span class="token punctuation">.</span></span>TimeWindow
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Collector
  <span class="token comment">//对无序的数据流周期性的添加水印</span>
  <span class="token keyword">object</span> OutOfOrderStreamPeriodicWaterMark <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
         <span class="token comment">//todo:1.构建流式处理环境</span>
    <span class="token keyword">val</span> environment<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
    <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_
    environment<span class="token punctuation">.</span>setParallelism<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
         <span class="token comment">//todo:2.设置时间类型</span>
   environment<span class="token punctuation">.</span>setStreamTimeCharacteristic<span class="token punctuation">(</span>TimeCharacteristic<span class="token punctuation">.</span>EventTime<span class="token punctuation">)</span>

  <span class="token comment">//todo:3.获取数据源</span>
    <span class="token keyword">val</span> sourceStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> environment<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">"node01"</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span>

  <span class="token comment">//todo:4. 数据处理</span>
    <span class="token keyword">val</span> mapStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> sourceStream<span class="token punctuation">.</span>map<span class="token punctuation">(</span>x<span class="token keyword">=&gt;</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toLong<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment">//todo:5. 添加水位线</span>
  mapStream<span class="token punctuation">.</span>assignTimestampsAndWatermarks<span class="token punctuation">(</span>
      <span class="token keyword">new</span> AssignerWithPeriodicWatermarks<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>

      <span class="token comment">//定义延迟时间长度</span>
      <span class="token comment">//表示在5秒以内的数据延时有效，超过5秒的数据被认定为迟到事件</span>

      <span class="token keyword">val</span> maxOutOfOrderness<span class="token operator">=</span><span class="token number">5000L</span>
      <span class="token comment">//历史最大事件时间</span>
      <span class="token keyword">var</span> currentMaxTimestamp<span class="token operator">:</span><span class="token builtin">Long</span><span class="token operator">=</span>_

      <span class="token keyword">var</span> watermark<span class="token operator">:</span>Watermark<span class="token operator">=</span>_

       <span class="token comment">//周期性的生成水位线watermark</span>
      <span class="token keyword">override</span> <span class="token keyword">def</span> getCurrentWatermark<span class="token operator">:</span> Watermark <span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
        watermark <span class="token operator">=</span>  <span class="token keyword">new</span> Watermark<span class="token punctuation">(</span>currentMaxTimestamp <span class="token operator">-</span>maxOutOfOrderness<span class="token punctuation">)</span>
        watermark
      <span class="token punctuation">}</span>

      <span class="token comment">//抽取事件时间</span>
      <span class="token keyword">override</span> <span class="token keyword">def</span> extractTimestamp<span class="token punctuation">(</span>element<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">,</span> previousElementTimestamp<span class="token operator">:</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
          <span class="token comment">//获取事件时间</span>
          <span class="token keyword">val</span> currentElementEventTime<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> element<span class="token punctuation">.</span>_2

          <span class="token comment">//对比当前事件时间和历史最大事件时间, 将较大值重新赋值给currentMaxTimestamp</span>
          currentMaxTimestamp<span class="token operator">=</span>Math<span class="token punctuation">.</span>max<span class="token punctuation">(</span>currentMaxTimestamp<span class="token punctuation">,</span>currentElementEventTime<span class="token punctuation">)</span>
          println<span class="token punctuation">(</span><span class="token string">"接受到的事件："</span><span class="token operator">+</span>element<span class="token operator">+</span><span class="token string">" |事件时间： "</span><span class="token operator">+</span>currentElementEventTime<span class="token punctuation">)</span>

          currentElementEventTime
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span>keyBy<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span>timeWindow<span class="token punctuation">(</span>Time<span class="token punctuation">.</span>seconds<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span>process<span class="token punctuation">(</span><span class="token keyword">new</span> ProcessWindowFunction<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span><span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">,</span>Tuple<span class="token punctuation">,</span>TimeWindow<span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">override</span> <span class="token keyword">def</span> process<span class="token punctuation">(</span>key<span class="token operator">:</span> Tuple<span class="token punctuation">,</span> context<span class="token operator">:</span> Context<span class="token punctuation">,</span> elements<span class="token operator">:</span> Iterable<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> out<span class="token operator">:</span> Collector<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
       <span class="token keyword">val</span> value<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> key<span class="token punctuation">.</span>getField<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
           <span class="token comment">//窗口的开始时间</span>
            <span class="token keyword">val</span> startTime<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>window<span class="token punctuation">.</span>getStart
            <span class="token comment">//窗口的结束时间</span>
            <span class="token keyword">val</span> startEnd<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>window<span class="token punctuation">.</span>getEnd

            <span class="token comment">//获取当前的 watermark</span>
            <span class="token keyword">val</span> watermark<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>currentWatermark

            <span class="token keyword">var</span> sum<span class="token operator">:</span><span class="token builtin">Long</span> <span class="token operator">=</span> <span class="token number">0</span>
            <span class="token keyword">val</span> toList<span class="token operator">:</span> List<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> elements<span class="token punctuation">.</span>toList
            <span class="token keyword">for</span><span class="token punctuation">(</span>eachElement <span class="token keyword">&lt;-</span>  toList<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
              sum <span class="token operator">+=</span><span class="token number">1</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//窗口的开始时间</span>
            <span class="token keyword">val</span> startTime<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>window<span class="token punctuation">.</span>getStart
            <span class="token comment">//窗口的结束时间</span>
            <span class="token keyword">val</span> startEnd<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>window<span class="token punctuation">.</span>getEnd

            <span class="token comment">//获取当前的 watermark</span>
            <span class="token keyword">val</span> watermark<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>currentWatermark

            <span class="token keyword">var</span> sum<span class="token operator">:</span><span class="token builtin">Long</span> <span class="token operator">=</span> <span class="token number">0</span>
            <span class="token keyword">val</span> toList<span class="token operator">:</span> List<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> elements<span class="token punctuation">.</span>toList
            <span class="token keyword">for</span><span class="token punctuation">(</span>eachElement <span class="token keyword">&lt;-</span>  toList<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
              sum <span class="token operator">+=</span><span class="token number">1</span>
            <span class="token punctuation">}</span>  
            println<span class="token punctuation">(</span><span class="token string">"窗口的数据条数:"</span><span class="token operator">+</span>sum<span class="token operator">+</span>
              <span class="token string">" |窗口的第一条数据："</span><span class="token operator">+</span>toList<span class="token punctuation">.</span>head<span class="token operator">+</span>
              <span class="token string">" |窗口的最后一条数据："</span><span class="token operator">+</span>toList<span class="token punctuation">.</span>last<span class="token operator">+</span>
              <span class="token string">" |窗口的开始时间： "</span><span class="token operator">+</span>  startTime <span class="token operator">+</span>
              <span class="token string">" |窗口的结束时间： "</span><span class="token operator">+</span> startEnd<span class="token operator">+</span>
              <span class="token string">" |当前的watermark:"</span><span class="token operator">+</span>watermark<span class="token punctuation">)</span>

            out<span class="token punctuation">.</span>collect<span class="token punctuation">(</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span>sum<span class="token punctuation">)</span><span class="token punctuation">)</span>

          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>       
       environment<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span> 
    <span class="token punctuation">}</span>  
  <span class="token punctuation">}</span>     
</code></pre>
      <ul>
       <li>
        发送数据
       </li>
      </ul>
      <pre><code>000001,1461756862000
000001,1461756872000
000001,1461756866000
000001,1461756873000
000001,1461756874000
000001,1461756875000
000001,1461756879000
000001,1461756880000
</code></pre>
     </li>
     <li>
      <p>
       2、With Punctuated（间断性的） Watermark
      </p>
      <pre><code>  间断性的生成 Watermark 一般是基于某些事件触发 Watermark 的生成和发送。
  比如说只给用户id为000001的添加watermark，其他的用户就不添加
</code></pre>
      <ul>
       <li>
        <p>
         需求
        </p>
        <ul>
         <li>
          对socket中无序数据流，进行每5s处理一次，数据中会有延迟
         </li>
        </ul>
       </li>
       <li>
        <p>
         代码演示
        </p>
       </li>
      </ul>
      <pre><code class="prism language-scala">  <span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>watermark</span>

        <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang3<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span>FastDateFormat
        <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span>MapFunction
        <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span></span>Tuple
        <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span>TimeCharacteristic
        <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token punctuation">{<!-- --></span>AssignerWithPeriodicWatermarks<span class="token punctuation">,</span> AssignerWithPunctuatedWatermarks<span class="token punctuation">}</span>
        <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{<!-- --></span>DataStream<span class="token punctuation">,</span> StreamExecutionEnvironment<span class="token punctuation">}</span>
        <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span>function<span class="token punctuation">.</span></span>ProcessWindowFunction
        <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>watermark<span class="token punctuation">.</span></span>Watermark
        <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span>Time
        <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>windows<span class="token punctuation">.</span></span>TimeWindow
        <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Collector

        <span class="token comment">//对无序的数据流间断性的添加水印</span>
        <span class="token keyword">object</span> OutOfOrderStreamPunctuatedWaterMark <span class="token punctuation">{<!-- --></span>

          <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
                      <span class="token comment">//todo:1.构建流式处理环境</span>
              <span class="token keyword">val</span> environment<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
              <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_
              environment<span class="token punctuation">.</span>setParallelism<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
                      <span class="token comment">//todo:2.设置时间类型</span>
              environment<span class="token punctuation">.</span>setStreamTimeCharacteristic<span class="token punctuation">(</span>TimeCharacteristic<span class="token punctuation">.</span>EventTime<span class="token punctuation">)</span>
      
              <span class="token comment">//todo:3.获取数据源</span>
              <span class="token keyword">val</span> sourceStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> environment<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">"node01"</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span>
      
              <span class="token comment">//todo:4. 数据处理</span>
              <span class="token keyword">val</span> mapStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> sourceStream<span class="token punctuation">.</span>map<span class="token punctuation">(</span>x<span class="token keyword">=&gt;</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toLong<span class="token punctuation">)</span><span class="token punctuation">)</span>
                      <span class="token comment">//todo:5. 添加水位线</span>
              mapStream<span class="token punctuation">.</span>assignTimestampsAndWatermarks<span class="token punctuation">(</span>
                <span class="token keyword">new</span> AssignerWithPunctuatedWatermarks<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>
      
                  <span class="token comment">//定义延迟时间长度</span>
                  <span class="token comment">//表示在5秒以内的数据延时有效，超过5秒的数据被认定为迟到事件</span>
                  <span class="token keyword">val</span> maxOutOfOrderness<span class="token operator">=</span><span class="token number">5000L</span>
                  <span class="token comment">//历史最大事件时间</span>
                  <span class="token keyword">var</span> currentMaxTimestamp<span class="token operator">:</span><span class="token builtin">Long</span><span class="token operator">=</span>_
      
                  <span class="token keyword">override</span> <span class="token keyword">def</span> checkAndGetNextWatermark<span class="token punctuation">(</span>lastElement<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">,</span> extractedTimestamp<span class="token operator">:</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token operator">:</span> Watermark <span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
                          <span class="token comment">//当用户id为000001生成watermark</span>
                         <span class="token keyword">if</span><span class="token punctuation">(</span>lastElement<span class="token punctuation">.</span>_1<span class="token punctuation">.</span>equals<span class="token punctuation">(</span><span class="token string">"000001"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
      
                            <span class="token keyword">val</span> watermark<span class="token operator">=</span>  <span class="token keyword">new</span> Watermark<span class="token punctuation">(</span>currentMaxTimestamp<span class="token operator">-</span>maxOutOfOrderness<span class="token punctuation">)</span>
      
                            watermark
                         <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
                           <span class="token comment">//其他情况下不返回水位线</span>
                            <span class="token keyword">null</span>
                         <span class="token punctuation">}</span>
      
                  <span class="token punctuation">}</span>
      
                  <span class="token keyword">override</span> <span class="token keyword">def</span> extractTimestamp<span class="token punctuation">(</span>element<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">,</span> previousElementTimestamp<span class="token operator">:</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//获取事件时间</span>
                    <span class="token keyword">val</span> currentElementEventTime<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> element<span class="token punctuation">.</span>_2
      
                    <span class="token comment">//对比当前事件时间和历史最大事件时间, 将较大值重新赋值给currentMaxTimestamp</span>
                    currentMaxTimestamp<span class="token operator">=</span>Math<span class="token punctuation">.</span>max<span class="token punctuation">(</span>currentMaxTimestamp<span class="token punctuation">,</span>currentElementEventTime<span class="token punctuation">)</span>
      
                    println<span class="token punctuation">(</span><span class="token string">"接受到的事件："</span><span class="token operator">+</span>element<span class="token operator">+</span><span class="token string">" |事件时间： "</span><span class="token operator">+</span>currentElementEventTime <span class="token punctuation">)</span>
      
                    currentElementEventTime
      
                  <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span>keyBy<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span>timeWindow<span class="token punctuation">(</span>Time<span class="token punctuation">.</span>seconds<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span>process<span class="token punctuation">(</span><span class="token keyword">new</span> ProcessWindowFunction<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span><span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">,</span>Tuple<span class="token punctuation">,</span>TimeWindow<span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">override</span> <span class="token keyword">def</span> process<span class="token punctuation">(</span>key<span class="token operator">:</span> Tuple<span class="token punctuation">,</span> context<span class="token operator">:</span> Context<span class="token punctuation">,</span> elements<span class="token operator">:</span> Iterable<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> out<span class="token operator">:</span> Collector<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
      
                      <span class="token keyword">val</span> value<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> key<span class="token punctuation">.</span>getField<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
      
                      <span class="token comment">//窗口的开始时间</span>
                      <span class="token keyword">val</span> startTime<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>window<span class="token punctuation">.</span>getStart
                      <span class="token comment">//窗口的结束时间</span>
                      <span class="token keyword">val</span> startEnd<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>window<span class="token punctuation">.</span>getEnd
      
                      <span class="token comment">//获取当前的 watermark</span>
                      <span class="token keyword">val</span> watermark<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>currentWatermark
      
                      <span class="token keyword">var</span> sum<span class="token operator">:</span><span class="token builtin">Long</span> <span class="token operator">=</span> <span class="token number">0</span>
                      <span class="token keyword">val</span> toList<span class="token operator">:</span> List<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> elements<span class="token punctuation">.</span>toList
                      <span class="token keyword">for</span><span class="token punctuation">(</span>eachElement <span class="token keyword">&lt;-</span>  toList<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                        sum <span class="token operator">+=</span><span class="token number">1</span>
                      <span class="token punctuation">}</span>
      
                      println<span class="token punctuation">(</span><span class="token string">"窗口的数据条数:"</span><span class="token operator">+</span>sum<span class="token operator">+</span>
                        <span class="token string">" |窗口的第一条数据："</span><span class="token operator">+</span>toList<span class="token punctuation">.</span>head<span class="token operator">+</span>
                        <span class="token string">" |窗口的最后一条数据："</span><span class="token operator">+</span>toList<span class="token punctuation">.</span>last<span class="token operator">+</span>
                        <span class="token string">" |窗口的开始时间： "</span><span class="token operator">+</span>startTime <span class="token operator">+</span>
                        <span class="token string">" |窗口的结束时间： "</span><span class="token operator">+</span>startEnd<span class="token operator">+</span>
                        <span class="token string">" |当前的watermark:"</span><span class="token operator">+</span>watermark<span class="token punctuation">)</span>
      
                      out<span class="token punctuation">.</span>collect<span class="token punctuation">(</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span>sum<span class="token punctuation">)</span><span class="token punctuation">)</span>
      
                    <span class="token punctuation">}</span>
                  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>
               environment<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span>
              <span class="token punctuation">}</span>
           <span class="token punctuation">}</span>        
</code></pre>
      <ul>
       <li>
        发送数据
       </li>
      </ul>
      <pre><code>000001,1461756862000
000001,1461756866000
000001,1461756872000
000002,1461756867000
000002,1461756868000
000002,1461756875000
000001,1461756875000
</code></pre>
     </li>
    </ul>
    <h6>
     <a id="253_Window_allowedLateness_628">
     </a>
     2.5.3 Window 的allowedLateness处理延迟太大的数据
    </h6>
    <pre><code>	基于 Event-Time 的窗口处理流式数据，虽然提供了 Watermark 机制，却只能在一定程度上解决了数据乱序的问题。但在某些情况下数据可能延时会非常严重，即使通过 Watermark 机制也无法等到数据全部进入窗口再进行处理。
	
	Flink 中默认会将这些迟到的数据做丢弃处理，但是有些时候用户希望即使数据延迟到达的情况下，也能够正常按照流程处理并输出结果，此时就需要使用 Allowed Lateness 机制来对迟到的数据进行额外的处理。
</code></pre>
    <ul>
     <li>
      <p>
       迟到数据的处理机制
      </p>
      <ul>
       <li>
        <p>
         1、直接丢弃
        </p>
       </li>
       <li>
        <p>
         2、指定允许再次迟到的时间
        </p>
        <pre><code class="prism language-scala"><span class="token comment">//例如</span>
assignTimestampsAndWatermarks<span class="token punctuation">(</span><span class="token keyword">new</span> EventTimeExtractor<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
                <span class="token punctuation">.</span>keyBy<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span>timeWindow<span class="token punctuation">(</span>Time<span class="token punctuation">.</span>seconds<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span>allowedLateness<span class="token punctuation">(</span>Time<span class="token punctuation">.</span>seconds<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 允许事件再迟到2秒</span>
                <span class="token punctuation">.</span>process<span class="token punctuation">(</span><span class="token keyword">new</span> SumProcessWindowFunction<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setParallelism<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//注意：</span>
<span class="token comment">//（1）. 当我们设置允许迟到2秒的事件，第一次 window 触发的条件是 watermark &gt;= window_end_time</span>
<span class="token comment">//（2）. 第二次(或者多次)触发的条件是watermark &lt; window_end_time + allowedLateness</span>
</code></pre>
       </li>
       <li>
        <p>
         3、收集迟到太多的数据
        </p>
        <pre><code class="prism language-scala"><span class="token comment">//例如</span>
assignTimestampsAndWatermarks<span class="token punctuation">(</span><span class="token keyword">new</span> EventTimeExtractor<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
                <span class="token punctuation">.</span>keyBy<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span>timeWindow<span class="token punctuation">(</span>Time<span class="token punctuation">.</span>seconds<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span>allowedLateness<span class="token punctuation">(</span>Time<span class="token punctuation">.</span>seconds<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//允许事件迟到2秒</span>
                <span class="token punctuation">.</span>sideOutputLateData<span class="token punctuation">(</span>outputTag<span class="token punctuation">)</span>    <span class="token comment">//收集迟到太多的数据</span>
                <span class="token punctuation">.</span>process<span class="token punctuation">(</span><span class="token keyword">new</span> SumProcessWindowFunction<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setParallelism<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
       </li>
      </ul>
     </li>
     <li>
      <p>
       代码演示
      </p>
      <pre><code class="prism language-scala"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>watermark</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang3<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span>FastDateFormat
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span>MapFunction
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span></span>Tuple
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span>TimeCharacteristic
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span>AssignerWithPeriodicWatermarks
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{<!-- --></span>DataStream<span class="token punctuation">,</span> OutputTag<span class="token punctuation">,</span> StreamExecutionEnvironment<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span>function<span class="token punctuation">.</span></span>ProcessWindowFunction
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>watermark<span class="token punctuation">.</span></span>Watermark
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span>Time
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>windows<span class="token punctuation">.</span></span>TimeWindow
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Collector

<span class="token comment">//运行数据再次延延迟一段时间，并且对延迟太多的数据进行收集</span>
<span class="token keyword">object</span> AllowedLatenessTest <span class="token punctuation">{<!-- --></span>

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">//todo:1.构建流式处理环境</span>
      <span class="token keyword">val</span> environment<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
      <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_
      environment<span class="token punctuation">.</span>setParallelism<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token comment">//todo:2.设置时间类型</span>
   environment<span class="token punctuation">.</span>setStreamTimeCharacteristic<span class="token punctuation">(</span>TimeCharacteristic<span class="token punctuation">.</span>EventTime<span class="token punctuation">)</span>

  <span class="token comment">//todo:3.获取数据源</span>
    <span class="token keyword">val</span> sourceStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> environment<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">"node01"</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span>

  <span class="token comment">//todo:4. 数据处理</span>
    <span class="token keyword">val</span> mapStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> sourceStream<span class="token punctuation">.</span>map<span class="token punctuation">(</span>x<span class="token keyword">=&gt;</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toLong<span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token comment">//定义一个侧输出流的标签，用于收集迟到太多的数据</span>
    <span class="token keyword">val</span> lateTag<span class="token operator">=</span><span class="token keyword">new</span> OutputTag<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">"late"</span><span class="token punctuation">)</span>

  <span class="token comment">//todo:5.  数据计算--添加水位线</span>
  <span class="token keyword">val</span> result<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> mapStream<span class="token punctuation">.</span>assignTimestampsAndWatermarks<span class="token punctuation">(</span>
          <span class="token keyword">new</span> AssignerWithPeriodicWatermarks<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>

            <span class="token comment">//定义延迟时间长度</span>
            <span class="token comment">//表示在5秒以内的数据延时有效，超过5秒的数据被认定为迟到事件</span>
            <span class="token keyword">val</span> maxOutOfOrderness <span class="token operator">=</span> <span class="token number">5000L</span>
            <span class="token comment">//历史最大事件时间</span>
            <span class="token keyword">var</span> currentMaxTimestamp<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> _ 
                  <span class="token comment">//周期性的生成水位线watermark</span>
            <span class="token keyword">override</span> <span class="token keyword">def</span> getCurrentWatermark<span class="token operator">:</span> Watermark <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
              <span class="token keyword">val</span> watermark <span class="token operator">=</span> <span class="token keyword">new</span> Watermark<span class="token punctuation">(</span>currentMaxTimestamp <span class="token operator">-</span> maxOutOfOrderness<span class="token punctuation">)</span>
              watermark
            <span class="token punctuation">}</span>

            <span class="token comment">//抽取事件时间</span>
            <span class="token keyword">override</span> <span class="token keyword">def</span> extractTimestamp<span class="token punctuation">(</span>element<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">,</span> previousElementTimestamp<span class="token operator">:</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
              <span class="token comment">//获取事件时间</span>
              <span class="token keyword">val</span> currentElementEventTime<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> element<span class="token punctuation">.</span>_2

              <span class="token comment">//对比当前事件时间和历史最大事件时间, 将较大值重新赋值给currentMaxTimestamp</span>
              currentMaxTimestamp <span class="token operator">=</span> Math<span class="token punctuation">.</span>max<span class="token punctuation">(</span>currentMaxTimestamp<span class="token punctuation">,</span> currentElementEventTime<span class="token punctuation">)</span>

              println<span class="token punctuation">(</span><span class="token string">"接受到的事件："</span> <span class="token operator">+</span> element <span class="token operator">+</span> <span class="token string">" |事件时间： "</span> <span class="token operator">+</span> currentElementEventTime <span class="token punctuation">)</span>

              currentElementEventTime
            <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span>keyBy<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span>timeWindow<span class="token punctuation">(</span>Time<span class="token punctuation">.</span>seconds<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span>allowedLateness<span class="token punctuation">(</span>Time<span class="token punctuation">.</span>seconds<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//允许数据延迟2s</span>
            <span class="token punctuation">.</span>sideOutputLateData<span class="token punctuation">(</span>lateTag<span class="token punctuation">)</span>     <span class="token comment">//收集延迟大多的数据</span>
            <span class="token punctuation">.</span>process<span class="token punctuation">(</span><span class="token keyword">new</span> ProcessWindowFunction<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Tuple<span class="token punctuation">,</span> TimeWindow<span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>
                      <span class="token keyword">override</span> <span class="token keyword">def</span> process<span class="token punctuation">(</span>key<span class="token operator">:</span> Tuple<span class="token punctuation">,</span> context<span class="token operator">:</span> Context<span class="token punctuation">,</span> elements<span class="token operator">:</span> Iterable<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> out<span class="token operator">:</span> Collector<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>

                        <span class="token keyword">val</span> value<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> key<span class="token punctuation">.</span>getField<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

                        <span class="token comment">//窗口的开始时间</span>
                        <span class="token keyword">val</span> startTime<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>window<span class="token punctuation">.</span>getStart
                        <span class="token comment">//窗口的结束时间</span>
                        <span class="token keyword">val</span> startEnd<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>window<span class="token punctuation">.</span>getEnd

                        <span class="token comment">//获取当前的 watermark</span>
                        <span class="token keyword">val</span> watermark<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>currentWatermark

                        <span class="token keyword">var</span> sum<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> <span class="token number">0</span>
                        <span class="token keyword">val</span> toList<span class="token operator">:</span> List<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> elements<span class="token punctuation">.</span>toList

                        <span class="token keyword">for</span> <span class="token punctuation">(</span>eachElement <span class="token keyword">&lt;-</span> toList<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                          sum <span class="token operator">+=</span> <span class="token number">1</span>
                        <span class="token punctuation">}</span>
                              println<span class="token punctuation">(</span><span class="token string">"窗口的数据条数:"</span> <span class="token operator">+</span> sum <span class="token operator">+</span>
                          <span class="token string">" |窗口的第一条数据："</span> <span class="token operator">+</span> toList<span class="token punctuation">.</span>head <span class="token operator">+</span>
                          <span class="token string">" |窗口的最后一条数据："</span> <span class="token operator">+</span> toList<span class="token punctuation">.</span>last <span class="token operator">+</span>
                          <span class="token string">" |窗口的开始时间： "</span> <span class="token operator">+</span> startTime <span class="token operator">+</span>
                          <span class="token string">" |窗口的结束时间： "</span> <span class="token operator">+</span> startEnd <span class="token operator">+</span>
                          <span class="token string">" |当前的watermark:"</span> <span class="token operator">+</span> watermark<span class="token punctuation">)</span>

                        out<span class="token punctuation">.</span>collect<span class="token punctuation">(</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> sum<span class="token punctuation">)</span><span class="token punctuation">)</span>

            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">//打印延迟太多的数据</span>
  result<span class="token punctuation">.</span>getSideOutput<span class="token punctuation">(</span>lateTag<span class="token punctuation">)</span><span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token string">"late"</span><span class="token punctuation">)</span>

  <span class="token comment">//打印</span>
  result<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token string">"ok"</span><span class="token punctuation">)</span>
      
  environment<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>                  
</code></pre>
     </li>
     <li>
      <p>
       发送数据
      </p>
      <pre><code>000001,1461756862000
000001,1461756866000
000001,1461756868000
000001,1461756869000
000001,1461756870000
000001,1461756862000
000001,1461756871000
000001,1461756872000
000001,1461756862000
000001,1461756863000
</code></pre>
     </li>
    </ul>
    <h6>
     <a id="254_WaterMark_806">
     </a>
     2.5.4 多并行度下的WaterMark
    </h6>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/69eccf0550ac42efa678bb61e6eda9d5.png"/>
    </p>
    <pre><code>本地测试的过程中，如果不设置并行度的话，
默认读取本机CPU数量设置并行度，
可以手动设置并行度environment.setParallelism(1)，每一个线程都会有一个watermark.
多并行度的情况下,一个window可能会接受到多个不同线程waterMark，
</code></pre>
    <ul>
     <li>
      <p>
       <mark>
        watermark对齐会取所有channel最小的watermark，以最小的watermark为准。
       </mark>
      </p>
     </li>
     <li>
      <p>
       案例演示
      </p>
      <pre><code class="prism language-scala">
<span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>watermark</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span></span>Tuple
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span>TimeCharacteristic
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span>AssignerWithPeriodicWatermarks
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{<!-- --></span>DataStream<span class="token punctuation">,</span> StreamExecutionEnvironment<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span>function<span class="token punctuation">.</span></span>ProcessWindowFunction
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>watermark<span class="token punctuation">.</span></span>Watermark
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span>Time
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>windows<span class="token punctuation">.</span></span>TimeWindow
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Collector

<span class="token comment">/**
  * 得到并打印每隔 5 秒钟统计前 5秒内的相同的 key 的所有的事件
  * 测试多并行度下的watermark
  */</span>
<span class="token keyword">object</span> WaterMarkWindowWithMultipart <span class="token punctuation">{<!-- --></span>

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//todo:1.构建流式处理环境</span>
  <span class="token keyword">val</span> environment<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
  <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_
  
  <span class="token comment">//设置并行度为2</span>
  environment<span class="token punctuation">.</span>setParallelism<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
  <span class="token comment">//todo:2.设置时间类型</span>
  environment<span class="token punctuation">.</span>setStreamTimeCharacteristic<span class="token punctuation">(</span>TimeCharacteristic<span class="token punctuation">.</span>EventTime<span class="token punctuation">)</span>

  <span class="token comment">//todo:3.获取数据源</span>
  <span class="token keyword">val</span> sourceStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> environment<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">"node01"</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span>

  <span class="token comment">//todo:4. 数据处理</span>
  <span class="token keyword">val</span> mapStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> sourceStream<span class="token punctuation">.</span>map<span class="token punctuation">(</span>x<span class="token keyword">=&gt;</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toLong<span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token comment">//todo:5. 添加水位线</span>
  mapStream<span class="token punctuation">.</span>assignTimestampsAndWatermarks<span class="token punctuation">(</span>
    <span class="token keyword">new</span> AssignerWithPeriodicWatermarks<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>

      <span class="token comment">//定义延迟时间长度</span>
      <span class="token comment">//表示在5秒以内的数据延时有效，超过5秒的数据被认定为迟到事件</span>

      <span class="token keyword">val</span> maxOutOfOrderness<span class="token operator">=</span><span class="token number">5000L</span>
      <span class="token comment">//历史最大事件时间</span>
      <span class="token keyword">var</span> currentMaxTimestamp<span class="token operator">:</span><span class="token builtin">Long</span><span class="token operator">=</span>_
             <span class="token comment">//周期性的生成水位线watermark</span>
      <span class="token keyword">override</span> <span class="token keyword">def</span> getCurrentWatermark<span class="token operator">:</span> Watermark <span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
       <span class="token keyword">val</span>  watermark <span class="token operator">=</span>  <span class="token keyword">new</span> Watermark<span class="token punctuation">(</span>currentMaxTimestamp <span class="token operator">-</span>maxOutOfOrderness<span class="token punctuation">)</span>
        watermark
      <span class="token punctuation">}</span>

      <span class="token comment">//抽取事件时间</span>
      <span class="token keyword">override</span> <span class="token keyword">def</span> extractTimestamp<span class="token punctuation">(</span>element<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">,</span> previousElementTimestamp<span class="token operator">:</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">//获取事件时间</span>
        <span class="token keyword">val</span> currentElementEventTime<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> element<span class="token punctuation">.</span>_2

        <span class="token comment">//对比当前事件时间和历史最大事件时间, 将较大值重新赋值给currentMaxTimestamp</span>
        currentMaxTimestamp<span class="token operator">=</span>Math<span class="token punctuation">.</span>max<span class="token punctuation">(</span>currentMaxTimestamp<span class="token punctuation">,</span>currentElementEventTime<span class="token punctuation">)</span>

        <span class="token keyword">val</span> id<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> Thread<span class="token punctuation">.</span>currentThread<span class="token punctuation">.</span>getId
        println<span class="token punctuation">(</span><span class="token string">"当前的线程id:"</span><span class="token operator">+</span>id<span class="token operator">+</span><span class="token string">" |接受到的事件："</span><span class="token operator">+</span>element<span class="token operator">+</span><span class="token string">" |事件时间： "</span><span class="token operator">+</span>currentElementEventTime<span class="token operator">+</span><span class="token string">" |当前值的watermark:"</span><span class="token operator">+</span>getCurrentWatermark<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getTimestamp<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        currentElementEventTime
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>keyBy<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>timeWindow<span class="token punctuation">(</span>Time<span class="token punctuation">.</span>seconds<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>process<span class="token punctuation">(</span><span class="token keyword">new</span> ProcessWindowFunction<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span><span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">,</span>Tuple<span class="token punctuation">,</span>TimeWindow<span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">override</span> <span class="token keyword">def</span> process<span class="token punctuation">(</span>key<span class="token operator">:</span> Tuple<span class="token punctuation">,</span> context<span class="token operator">:</span> Context<span class="token punctuation">,</span> elements<span class="token operator">:</span> Iterable<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> out<span class="token operator">:</span> Collector<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>

        <span class="token keyword">val</span> value<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> key<span class="token punctuation">.</span>getField<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

        <span class="token comment">//窗口的开始时间</span>
        <span class="token keyword">val</span> startTime<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>window<span class="token punctuation">.</span>getStart
        <span class="token comment">//窗口的结束时间</span>
        <span class="token keyword">val</span> startEnd<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>window<span class="token punctuation">.</span>getEnd

        <span class="token comment">//获取当前的 watermark</span>
        <span class="token keyword">val</span> watermark<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>currentWatermark

        <span class="token keyword">var</span> sum<span class="token operator">:</span><span class="token builtin">Long</span> <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">val</span> toList<span class="token operator">:</span> List<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> elements<span class="token punctuation">.</span>toList
        <span class="token keyword">for</span><span class="token punctuation">(</span>eachElement <span class="token keyword">&lt;-</span>  toList<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
          sum <span class="token operator">+=</span><span class="token number">1</span>
        <span class="token punctuation">}</span> 
             println<span class="token punctuation">(</span><span class="token string">"窗口的数据条数:"</span><span class="token operator">+</span>sum<span class="token operator">+</span>
          <span class="token string">" |窗口的第一条数据："</span><span class="token operator">+</span>toList<span class="token punctuation">.</span>head<span class="token operator">+</span>
          <span class="token string">" |窗口的最后一条数据："</span><span class="token operator">+</span>toList<span class="token punctuation">.</span>last<span class="token operator">+</span>
          <span class="token string">" |窗口的开始时间： "</span><span class="token operator">+</span>  startTime <span class="token operator">+</span>
          <span class="token string">" |窗口的结束时间： "</span><span class="token operator">+</span> startEnd<span class="token operator">+</span>
          <span class="token string">" |当前的watermark:"</span><span class="token operator">+</span> watermark<span class="token punctuation">)</span>

        out<span class="token punctuation">.</span>collect<span class="token punctuation">(</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span>sum<span class="token punctuation">)</span><span class="token punctuation">)</span>

      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>
    environment<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span>

		<span class="token punctuation">}</span>    
    <span class="token punctuation">}</span>
</code></pre>
     </li>
     <li>
      <p>
       输入数据
      </p>
      <pre><code>000001,1461756862000
000001,1461756864000
000001,1461756866000
000001,1461756870000
000001,1461756871000
</code></pre>
     </li>
     <li>
      <p>
       输出结果
      </p>
      <pre><code>当前的线程id:65 |接受到的事件：(000001,1461756862000) |事件时间： 1461756862000 |当前值的watermark:1461756857000
当前的线程id:64 |接受到的事件：(000001,1461756864000) |事件时间： 1461756864000 |当前值的watermark:1461756859000
当前的线程id:65 |接受到的事件：(000001,1461756866000) |事件时间： 1461756866000 |当前值的watermark:1461756861000
当前的线程id:64 |接受到的事件：(000001,1461756870000) |事件时间： 1461756870000 |当前值的watermark:1461756865000
当前的线程id:65 |接受到的事件：(000001,1461756871000) |事件时间： 1461756871000 |当前值的watermark:1461756866000
窗口的数据条数:2 |窗口的第一条数据：(000001,1461756862000) |窗口的最后一条数据：(000001,1461756864000) |窗口的开始时间： 1461756860000 |窗口的结束时间： 1461756865000 |当前的watermark:1461756865000
2&gt; (000001,2)
</code></pre>
     </li>
     <li>
      <p>
       结果分析
      </p>
     </li>
    </ul>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/f80483414e684a5e88fe033bfa9d9698.png"/>
    </p>
    <h3>
     <a id="book_3_FlinkTableSQL_955">
     </a>
     📖 3. Flink的Table和SQL
    </h3>
    <h5>
     <a id="31_TableSQL_957">
     </a>
     3.1 Table与SQL基本介绍
    </h5>
    <pre><code>	在Spark中有DataFrame这样的关系型编程接口，因其强大且灵活的表达能力，
	能够让用户通过非常丰富的接口对数据进行处理，有效降低了用户的使用成本。

	Flink也提供了关系型编程接口 Table API 以及基于Table API 的 SQL API，
	让用户能够通过使用结构化编程接口高效地构建Flink应用。
	同时Table API 以及 SQL 能够统一处理批量和实时计算业务， 
	无须切换修改任何应用代码就能够基于同一套 API 编写流式应用和批量应用，从而达到真正意义的批流统一。
</code></pre>
    <ul>
     <li>
      <mark>
       Apache Flink 具有两个关系型API：Table API 和SQL，用于统一流和批处理
      </mark>
     </li>
     <li>
      Table API 是用于 Scala 和 Java 语言的查询API，允许以非常直观的方式组合关系运算符的查询，例如 select，filter 和 join。Flink SQL 的支持是基于实现了SQL标准的 Apache Calcite。无论输入是批输入（DataSet）还是流输入（DataStream），任一接口中指定的查询都具有相同的语义并指定相同的结果。
     </li>
     <li>
      Table API和SQL接口彼此集成，Flink的DataStream和DataSet API亦是如此。我们可以轻松地在基于API构建的所有API和库之间切换。
     </li>
     <li>
      注意，到目前最新版本为止，Table API和SQL还有很多功能正在开发中。 并非[Table API，SQL]和[stream，batch]输入的每种组合都支持所有操作
     </li>
    </ul>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/a38684e85d2a47f985a71a34182f4b46.png"/>
    </p>
    <h5>
     <a id="32_SQL_980">
     </a>
     3.2 为什么需要SQL
    </h5>
    <ul>
     <li>
      <p>
       Table API 是一种关系型API，类 SQL 的API，用户可以像操作表一样地操作数据， 非常的直观和方便。
      </p>
     </li>
     <li>
      <p>
       SQL 作为一个"人所皆知"的语言，如果一个引擎提供 SQL，它将很容易被人们接受。这已经是业界很常见的现象了。
      </p>
     </li>
     <li>
      <p>
       Table &amp; SQL API 还有另一个职责，就是流处理和批处理统一的API层。
      </p>
      <p>
       <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/bc5e12b0c68a4d0a8d28e293807cd78f.png"/>
      </p>
     </li>
    </ul>
    <h5>
     <a id="33__992">
     </a>
     3.3 开发环境构建
    </h5>
    <ul>
     <li>
      <p>
       在 Flink 1.9 中，Table 模块迎来了核心架构的升级，引入了阿里巴巴 Blink 团队贡献的诸多功能，取名叫： Blink Planner。
      </p>
     </li>
     <li>
      <p>
       在使用 Table API 和 SQL 开发 Flink 应用之前，通过添加 Maven 的依赖配置到项目中，在本地工程中引入相应的依赖库，库中包含了 Table API 和 SQL 接口。
      </p>
     </li>
     <li>
      <p>
       添加pom依赖
      </p>
      <pre><code class="prism language-xml"> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.flink<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>flink-table-planner_2.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.9.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.flink<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>flink-table-api-scala-bridge_2.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.9.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre>
     </li>
    </ul>
    <h5>
     <a id="34_TableEnvironment_1016">
     </a>
     3.4 TableEnvironment构建
    </h5>
    <ul>
     <li>
      <p>
       和 DataStream API 一样，Table API 和 SQL 中具有相同的基本编程模型。首先需要构建对应的 TableEnviroment 创建关系型编程环境，才能够在程序中使用 Table API 和 SQL来编写应用程序，另外 Table API 和 SQL 接口可以在应用中同时使用，Flink SQL 基于 Apache Calcite 框架实现了 SQL 标准协议，是构建在 Table API 之上的更高级接口。
      </p>
     </li>
     <li>
      <p>
       首先需要在环境中创建 TableEnvironment 对象，TableEnvironment 中提供了注册内部表、执行 Flink SQL 语句、注册自定义函数等功能。根据应用类型的不同，TableEnvironment 创建方式也有所不同，但是都是通过调用 create()方法创建。
      </p>
     </li>
     <li>
      <p>
       流计算环境下创建 TableEnviroment
      </p>
      <pre><code class="prism language-scala"><span class="token comment">//初始化Flink的Streaming（流计算）上下文执行环境 </span>
<span class="token keyword">val</span> streamEnv<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment 
<span class="token comment">//初始化Table API的上下文环境 </span>
<span class="token keyword">val</span> tableEvn <span class="token operator">=</span>StreamTableEnvironment<span class="token punctuation">.</span>create<span class="token punctuation">(</span>streamEnv<span class="token punctuation">)</span>
</code></pre>
     </li>
     <li>
      <p>
       在 Flink1.9 之后由于引入了 Blink Planner
      </p>
      <pre><code class="prism language-scala"><span class="token keyword">val</span> bsSettings <span class="token operator">=</span> EnvironmentSettings<span class="token punctuation">.</span>newInstance<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>useOldPlanner<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>inStreamingMode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>build<span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token keyword">val</span> bsTableEnv <span class="token operator">=</span> StreamTableEnvironment<span class="token punctuation">.</span>create<span class="token punctuation">(</span>streamEnv<span class="token punctuation">,</span> bsSettings<span class="token punctuation">)</span>
</code></pre>
     </li>
     <li>
      <p>
       注意
      </p>
      <ul>
       <li>
        Flink 社区完整保留原有 Flink Planner (Old Planner)，同时又引入了新的Blink Planner，用户可以自行选择使用 Old Planner 还是 Blink Planner。官方推荐暂时使用 Old Planner。
       </li>
      </ul>
     </li>
    </ul>
    <h5>
     <a id="35_Table_API_1044">
     </a>
     3.5 Table API
    </h5>
    <ul>
     <li>
      在 Flink 中创建一张表有两种方法：
      <ul>
       <li>
        （1）从一个文件中导入表结构（Structure）（常用于批计算）（静态）
       </li>
       <li>
        （2）从 DataStream 或者 DataSet 转换成 Table （动态）
       </li>
      </ul>
     </li>
    </ul>
    <h6>
     <a id="351__Table_1052">
     </a>
     3.5.1 创建 Table
    </h6>
    <ul>
     <li>
      <p>
       Table API 中已经提供了 TableSource 从外部系统获取数据，例如常见的数据库、文件系统和 Kafka 消息队列等外部系统。
      </p>
     </li>
     <li>
      <p>
       <strong>
        1、从文件中创建 Table（静态表）
       </strong>
      </p>
      <ul>
       <li>
        <p>
         需求
        </p>
        <ul>
         <li>
          读取csv文件，文件内容参见课件当中的flinksql.csv文件，查询年龄大于18岁的人，并将结果写入到csv文件里面去，这里涉及到flink的connect的各种与其他外部系统的连接，参见
         </li>
         <li>
          https://ci.apache.org/projects/flink/flink-docs-release-1.9/dev/table/connect.html
         </li>
        </ul>
       </li>
       <li>
        <p>
         代码开发
        </p>
        <pre><code class="prism language-scala"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>table</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>typeinfo<span class="token punctuation">.</span></span>TypeInformation
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>core<span class="token punctuation">.</span>fs<span class="token punctuation">.</span></span>FileSystem<span class="token punctuation">.</span>WriteMode
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{<!-- --></span>DataStream<span class="token punctuation">,</span> StreamExecutionEnvironment<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token punctuation">{<!-- --></span>Table<span class="token punctuation">,</span> Types<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>StreamTableEnvironment
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>sinks<span class="token punctuation">.</span></span>CsvTableSink
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>sources<span class="token punctuation">.</span></span>CsvTableSource
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_
<span class="token comment">/**
  * flink table加载csv文件
  */</span>
<span class="token keyword">object</span> TableCsvSource <span class="token punctuation">{<!-- --></span>

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
     <span class="token comment">//todo:1、构建流处理环境</span>
      <span class="token keyword">val</span> environment<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment

    <span class="token comment">//todo:2、构建TableEnvironment</span>
    <span class="token keyword">val</span> tableEnvironment<span class="token operator">:</span> StreamTableEnvironment <span class="token operator">=</span> StreamTableEnvironment<span class="token punctuation">.</span>create<span class="token punctuation">(</span>environment<span class="token punctuation">)</span>
        <span class="token comment">//todo:3、构建csv数据源</span>
    <span class="token keyword">val</span> csvSource <span class="token operator">=</span> CsvTableSource<span class="token punctuation">.</span>builder<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>path<span class="token punctuation">(</span><span class="token string">"d:\\flinksql.csv"</span><span class="token punctuation">)</span>
                                   <span class="token punctuation">.</span>field<span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span> Types<span class="token punctuation">.</span>INT<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                   <span class="token punctuation">.</span>field<span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> Types<span class="token punctuation">.</span>STRING<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                   <span class="token punctuation">.</span>field<span class="token punctuation">(</span><span class="token string">"age"</span><span class="token punctuation">,</span> Types<span class="token punctuation">.</span>INT<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                   <span class="token punctuation">.</span>fieldDelimiter<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span> <span class="token comment">//字段的分隔符</span>
                                   <span class="token punctuation">.</span>ignoreParseErrors<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//忽略解析错误</span>
                                   <span class="token punctuation">.</span>ignoreFirstLine<span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment">//忽略第一行</span>
                                   <span class="token punctuation">.</span>build<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">//todo:4、注册表</span>
    tableEnvironment<span class="token punctuation">.</span>registerTableSource<span class="token punctuation">(</span><span class="token string">"myUser"</span><span class="token punctuation">,</span> csvSource<span class="token punctuation">)</span>

    <span class="token comment">//todo: 5、查询结果</span>
    <span class="token keyword">val</span> result<span class="token operator">:</span> Table <span class="token operator">=</span> tableEnvironment<span class="token punctuation">.</span>scan<span class="token punctuation">(</span><span class="token string">"myUser"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span><span class="token string">"age&gt;25"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token string">"id,name,age"</span><span class="token punctuation">)</span>
    result<span class="token punctuation">.</span>printSchema<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">//todo: 6、构建Sink</span>
    <span class="token keyword">val</span> tableSink <span class="token operator">=</span> <span class="token keyword">new</span> CsvTableSink<span class="token punctuation">(</span><span class="token string">"./out/tableSink.txt"</span><span class="token punctuation">,</span><span class="token string">"\t"</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>WriteMode<span class="token punctuation">.</span>OVERWRITE<span class="token punctuation">)</span>

    <span class="token comment">//todo:7、注册sink</span>
    tableEnvironment<span class="token punctuation">.</span>registerTableSink<span class="token punctuation">(</span><span class="token string">"csvOutputTable"</span><span class="token punctuation">,</span>
                                        Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">"f1"</span><span class="token punctuation">,</span><span class="token string">"f2"</span><span class="token punctuation">,</span><span class="token string">"f3"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                        Array<span class="token punctuation">[</span>TypeInformation<span class="token punctuation">[</span>_<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">(</span>Types<span class="token punctuation">.</span>INT<span class="token punctuation">,</span>Types<span class="token punctuation">.</span>STRING<span class="token punctuation">,</span>Types<span class="token punctuation">.</span>INT<span class="token punctuation">)</span> <span class="token punctuation">,</span>
                                        tableSink<span class="token punctuation">)</span>

    <span class="token comment">//todo:8、写数据到sink</span>
    result<span class="token punctuation">.</span>insertInto<span class="token punctuation">(</span><span class="token string">"csvOutputTable"</span><span class="token punctuation">)</span>

    environment<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">"TableCsvSource"</span><span class="token punctuation">)</span>

  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre>
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        2、从DataStream中创建 Table（动态表）
       </strong>
      </p>
      <ul>
       <li>
        <p>
         需求
        </p>
        <ul>
         <li>
          使用TableApi完成基于流数据的处理
         </li>
        </ul>
       </li>
       <li>
        <p>
         代码开发
        </p>
        <pre><code class="prism language-scala"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>table</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{<!-- --></span>DataStream<span class="token punctuation">,</span> StreamExecutionEnvironment<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token punctuation">{<!-- --></span>Table<span class="token punctuation">,</span> Types<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>StreamTableEnvironment
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>types<span class="token punctuation">.</span></span>Row
<span class="token comment">/**
  * 使用TableApi完成基于流数据的处理
  */</span>
<span class="token keyword">object</span> TableFromDataStream <span class="token punctuation">{<!-- --></span>

  <span class="token comment">//todo:定义样例类</span>
  <span class="token keyword">case</span> <span class="token keyword">class</span> User<span class="token punctuation">(</span>id<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">,</span>name<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">,</span>age<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
           <span class="token comment">//todo:1、构建流处理环境</span>
        <span class="token keyword">val</span> streamEnv<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
    streamEnv<span class="token punctuation">.</span>setParallelism<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

     <span class="token comment">//todo:2、构建TableEnvironment</span>
        <span class="token keyword">val</span> tableEnvironment<span class="token operator">:</span> StreamTableEnvironment <span class="token operator">=</span> StreamTableEnvironment<span class="token punctuation">.</span>create<span class="token punctuation">(</span>streamEnv<span class="token punctuation">)</span>
        <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_

    <span class="token comment">/**
      * 101,zhangsan,18
      * 102,lisi,28
      * 103,wangwu,25
      * 104,zhaoliu,30
      */</span>
     <span class="token comment">//todo:3、接受socket数据</span>
        <span class="token keyword">val</span> socketStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> streamEnv<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">"node01"</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span>

     <span class="token comment">//todo:4、对数据进行处理</span>
       <span class="token keyword">val</span> userStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span>User<span class="token punctuation">]</span> <span class="token operator">=</span> socketStream<span class="token punctuation">.</span>map<span class="token punctuation">(</span>x<span class="token keyword">=&gt;</span>x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>x<span class="token keyword">=&gt;</span>User<span class="token punctuation">(</span>x<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toInt<span class="token punctuation">,</span>x<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>x<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toInt<span class="token punctuation">)</span><span class="token punctuation">)</span>

     <span class="token comment">//todo:5、将流注册成一张表</span>
      tableEnvironment<span class="token punctuation">.</span>registerDataStream<span class="token punctuation">(</span><span class="token string">"userTable"</span><span class="token punctuation">,</span>userStream<span class="token punctuation">)</span>

    <span class="token comment">//todo:6、使用table 的api查询年龄大于20岁的人</span>
      <span class="token keyword">val</span> result<span class="token operator">:</span>Table <span class="token operator">=</span> tableEnvironment<span class="token punctuation">.</span>scan<span class="token punctuation">(</span><span class="token string">"userTable"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span><span class="token string">"age &gt;20"</span><span class="token punctuation">)</span>
  <span class="token comment">//todo：7、将table转化成流</span>
     tableEnvironment<span class="token punctuation">.</span>toAppendStream<span class="token punctuation">[</span>Row<span class="token punctuation">]</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>      
        <span class="token comment">//todo:8、启动</span>
     tableEnvironment<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">"TableFromDataStream"</span><span class="token punctuation">)</span>

  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>  
</code></pre>
       </li>
       <li>
        <p>
         发送数据
        </p>
        <pre><code class="prism language-shell"><span class="token function">nc</span> <span class="token parameter variable">-lk</span> <span class="token number">9999</span>

<span class="token number">101</span>,zhangsan,18
<span class="token number">102</span>,lisi,28
<span class="token number">103</span>,wangwu,25
<span class="token number">104</span>,zhaoliu,30
</code></pre>
       </li>
       <li>
        <p>
         <mark>
          DataStream转换成Table逻辑
         </mark>
        </p>
        <ul>
         <li>
          构建StreamExecutionEnvironment和StreamTableEnvironment对象
          <ul>
           <li>
            StreamTableEnvironment.fromDataStream(dataStream: DataStream)
           </li>
           <li>
            StreamTableEnvironment.registerDataStream(dataStream: DataStream)
           </li>
          </ul>
         </li>
        </ul>
       </li>
      </ul>
     </li>
     <li>
      <p>
       更多的table API操作详细见官网
      </p>
      <ul>
       <li>
        <a href="https://ci.apache.org/projects/flink/flink-docs-release-1.10/dev/table/tableApi.html" rel="nofollow">
         https://ci.apache.org/projects/flink/flink-docs-release-1.10/dev/table/tableApi.html
        </a>
       </li>
      </ul>
      <p>
       <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/b342bf737e4d4c14a2fb772d26d8a704.png"/>
      </p>
     </li>
    </ul>
    <h6>
     <a id="352___Tablewindow_1214">
     </a>
     3.5.2 Table中的window
    </h6>
    <ul>
     <li>
      <p>
       Flink 支持 ProcessTime、EventTime 和 IngestionTime 三种时间概念，针对每种时间概念，Flink Table API 中使用
       <code>
        Schema
       </code>
       中单独的字段来表示时间属性，当时间字段被指定后，就可以在基于时间的操作算子中使用相应的时间属性。
      </p>
     </li>
     <li>
      <p>
       在 Table API 中通过使用==.rowtime 来定义 EventTime 字段==，在 ProcessTime 时间字段名后使用.proctime 后缀来指定 ProcessTime 时间属性
      </p>
     </li>
     <li>
      <p>
       需求
      </p>
      <ul>
       <li>
        统计最近 5 秒钟，每个单词出现的次数
       </li>
      </ul>
     </li>
     <li>
      <p>
       代码开发
      </p>
      <pre><code class="prism language-scala"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>table</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span>TimeCharacteristic
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span>AssignerWithPeriodicWatermarks
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{<!-- --></span>DataStream<span class="token punctuation">,</span> StreamExecutionEnvironment<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>watermark<span class="token punctuation">.</span></span>Watermark
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token punctuation">{<!-- --></span>GroupWindowedTable<span class="token punctuation">,</span> Table<span class="token punctuation">,</span> Tumble<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>StreamTableEnvironment
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>types<span class="token punctuation">.</span></span>Row

<span class="token comment">/**
  * 基于table的window窗口操作处理延迟数据
  */</span>
<span class="token keyword">object</span> TableWindowWaterMark <span class="token punctuation">{<!-- --></span>

  <span class="token comment">//定义样例类</span>
  <span class="token keyword">case</span> <span class="token keyword">class</span> Message<span class="token punctuation">(</span>word<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">,</span>createTime<span class="token operator">:</span><span class="token builtin">Long</span><span class="token punctuation">)</span>

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//todo:1、构建流处理环境</span>
     <span class="token keyword">val</span> streamEnv<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
    streamEnv<span class="token punctuation">.</span>setParallelism<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

      <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_

    <span class="token comment">//指定EventTime为时间语义</span>
     streamEnv<span class="token punctuation">.</span>setStreamTimeCharacteristic<span class="token punctuation">(</span>TimeCharacteristic<span class="token punctuation">.</span>EventTime<span class="token punctuation">)</span>

   <span class="token comment">//todo: 2、构建StreamTableEnvironment</span>
      <span class="token keyword">val</span> tableEnvironment<span class="token operator">:</span> StreamTableEnvironment <span class="token operator">=</span> StreamTableEnvironment<span class="token punctuation">.</span>create<span class="token punctuation">(</span>streamEnv<span class="token punctuation">)</span>

  <span class="token comment">//todo： 3、接受socket数据</span>
      <span class="token keyword">val</span> sourceStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> streamEnv<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">"node01"</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span>

  <span class="token comment">//todo: 4、数据切分处理</span>
    <span class="token keyword">val</span> mapStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span>Message<span class="token punctuation">]</span> <span class="token operator">=</span> sourceStream<span class="token punctuation">.</span>map<span class="token punctuation">(</span>x<span class="token keyword">=&gt;</span>Message<span class="token punctuation">(</span>x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toLong<span class="token punctuation">)</span><span class="token punctuation">)</span>

   <span class="token comment">//todo: 5、添加watermark</span>
    <span class="token keyword">val</span> watermarksStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span>Message<span class="token punctuation">]</span> <span class="token operator">=</span> mapStream<span class="token punctuation">.</span>assignTimestampsAndWatermarks<span class="token punctuation">(</span><span class="token keyword">new</span> AssignerWithPeriodicWatermarks<span class="token punctuation">[</span>Message<span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>

      <span class="token comment">//定义延迟时长</span>
      <span class="token keyword">val</span> maxOutOfOrderness <span class="token operator">=</span> <span class="token number">5000L</span>
      <span class="token comment">//历史最大事件时间</span>
      <span class="token keyword">var</span> currentMaxTimestamp<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> _

      <span class="token keyword">override</span> <span class="token keyword">def</span> getCurrentWatermark<span class="token operator">:</span> Watermark <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">val</span> watermark <span class="token operator">=</span> <span class="token keyword">new</span> Watermark<span class="token punctuation">(</span>currentMaxTimestamp <span class="token operator">-</span> maxOutOfOrderness<span class="token punctuation">)</span>
        watermark
      <span class="token punctuation">}</span>

      <span class="token keyword">override</span> <span class="token keyword">def</span> extractTimestamp<span class="token punctuation">(</span>element<span class="token operator">:</span> Message<span class="token punctuation">,</span> previousElementTimestamp<span class="token operator">:</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>

        <span class="token keyword">val</span> eventTime<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> element<span class="token punctuation">.</span>createTime
        currentMaxTimestamp <span class="token operator">=</span> Math<span class="token punctuation">.</span>max<span class="token punctuation">(</span>eventTime<span class="token punctuation">,</span> currentMaxTimestamp<span class="token punctuation">)</span>
        eventTime
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    
    <span class="token comment">//todo:6、构建Table , 设置时间属性</span>
    <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_
     <span class="token keyword">val</span> table<span class="token operator">:</span> Table <span class="token operator">=</span> tableEnvironment<span class="token punctuation">.</span>fromDataStream<span class="token punctuation">(</span>watermarksStream<span class="token punctuation">,</span><span class="token char">'word,'</span>createTime<span class="token punctuation">.</span>rowtime<span class="token punctuation">)</span>
    <span class="token comment">//todo:7、添加window</span>
      <span class="token comment">//滚动窗口第一种写法</span>
  <span class="token comment">//val windowedTable: GroupWindowedTable = table.window(Tumble.over("5.second").on("createTime").as("window"))</span>

     <span class="token comment">//滚动窗口的第二种写法</span>
 <span class="token keyword">val</span> windowedTable<span class="token operator">:</span> GroupWindowedTable <span class="token operator">=</span> table<span class="token punctuation">.</span>window<span class="token punctuation">(</span>Tumble over <span class="token number">5.</span>second on <span class="token string">'createTime as '</span>window<span class="token punctuation">)</span>

  <span class="token comment">//todo:8、对窗口数据进行处理</span>
     <span class="token comment">// 使用2个字段分组，窗口名称和单词</span>
  <span class="token keyword">val</span> result<span class="token operator">:</span> Table <span class="token operator">=</span> windowedTable<span class="token punctuation">.</span>groupBy<span class="token punctuation">(</span><span class="token string">'window,'</span>word<span class="token punctuation">)</span>
         <span class="token comment">//单词、窗口的开始、结束e、聚合计算</span>
                                       <span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token char">'word,'</span>window<span class="token punctuation">.</span>start<span class="token punctuation">,</span><span class="token string">'window.end,'</span>word<span class="token punctuation">.</span>count<span class="token punctuation">)</span>
    <span class="token comment">//todo:9、将table转换成DataStream</span>
   <span class="token keyword">val</span> resultStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">Boolean</span><span class="token punctuation">,</span> Row<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> tableEnvironment<span class="token punctuation">.</span>toRetractStream<span class="token punctuation">[</span>Row<span class="token punctuation">]</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>

   resultStream<span class="token punctuation">.</span>filter<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span>x<span class="token punctuation">.</span>_1 <span class="token operator">==</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>

   tableEnvironment<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">"table"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
    
</code></pre>
     </li>
     <li>
      <p>
       发送数据
      </p>
      <pre><code>hadoop,1461756862000
hadoop,1461756866000
hadoop,1461756864000
hadoop,1461756870000
hadoop,1461756875000
</code></pre>
     </li>
    </ul>
    <h5>
     <a id="36_SQL_1327">
     </a>
     3.6 SQL使用
    </h5>
    <ul>
     <li>
      SQL 作为 Flink 中提供的接口之一，占据着非常重要的地位，主要是因为 SQL 具有灵活和丰富的语法，能够应用于大部分的计算场景。
     </li>
     <li>
      Flink SQL 底层使用 Apache Calcite 框架， 将标准的 Flink SQL 语句解析并转换成底层的算子处理逻辑，并在转换过程中基于语法规则层面进行性能优化，比如谓词下推等。另外用户在使用 SQL 编写 Flink 应用时，能够屏蔽底层技术细节，能够更加方便且高效地通过SQL语句来构建Flink应用。
     </li>
     <li>
      Flink SQL构建在Table API 之上，并含盖了大部分的 Table API 功能特性。同时 Flink SQL 可以和 Table API 混用，Flink 最终会在整体上将代码合并在同一套代码逻辑中
     </li>
    </ul>
    <h6>
     <a id="361_SQL_1335">
     </a>
     3.6.1 SQL操作
    </h6>
    <ul>
     <li>
      <p>
       代码开发演示
      </p>
      <pre><code class="prism language-scala">
  <span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>table</span>

  <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{<!-- --></span>DataStream<span class="token punctuation">,</span> StreamExecutionEnvironment<span class="token punctuation">}</span>
  <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span>Table
  <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>StreamTableEnvironment
  <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>types<span class="token punctuation">.</span></span>Row

  <span class="token keyword">object</span> FlinkSQLTest <span class="token punctuation">{<!-- --></span>

    <span class="token comment">//todo:定义样例类</span>
    <span class="token keyword">case</span> <span class="token keyword">class</span> User<span class="token punctuation">(</span>id<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">,</span>name<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">,</span>age<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">)</span>
     <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> 
          <span class="token comment">//todo:1、构建流处理环境</span>
        <span class="token keyword">val</span> streamEnv<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
    streamEnv<span class="token punctuation">.</span>setParallelism<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

     <span class="token comment">//todo:2、构建TableEnvironment</span>
        <span class="token keyword">val</span> tableEnvironment<span class="token operator">:</span> StreamTableEnvironment <span class="token operator">=</span> StreamTableEnvironment<span class="token punctuation">.</span>create<span class="token punctuation">(</span>streamEnv<span class="token punctuation">)</span>
        <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_

    <span class="token comment">/**
      * 101,zhangsan,18
      * 102,lisi,20
      * 103,wangwu,25
      * 104,zhaoliu,15
      */</span>
     <span class="token comment">//todo:3、接受socket数据</span>
        <span class="token keyword">val</span> socketStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> streamEnv<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">"node01"</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span>

     <span class="token comment">//todo:4、对数据进行处理</span>
       <span class="token keyword">val</span> userStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span>User<span class="token punctuation">]</span> <span class="token operator">=</span> socketStream<span class="token punctuation">.</span>map<span class="token punctuation">(</span>x<span class="token keyword">=&gt;</span>x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>x<span class="token keyword">=&gt;</span>User<span class="token punctuation">(</span>x<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toInt<span class="token punctuation">,</span>x<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>x<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toInt<span class="token punctuation">)</span><span class="token punctuation">)</span>

     <span class="token comment">//todo:5、将流注册成一张表</span>
      tableEnvironment<span class="token punctuation">.</span>registerDataStream<span class="token punctuation">(</span><span class="token string">"userTable"</span><span class="token punctuation">,</span>userStream<span class="token punctuation">)</span>

    <span class="token comment">//todo:6、使用table 的api查询年龄大于20岁的人</span>
      <span class="token keyword">val</span> result<span class="token operator">:</span>Table <span class="token operator">=</span> tableEnvironment<span class="token punctuation">.</span>sqlQuery<span class="token punctuation">(</span><span class="token string">"select * from userTable where age &gt;20"</span><span class="token punctuation">)</span>
        <span class="token comment">//todo：7、将table转化成流</span>
     tableEnvironment<span class="token punctuation">.</span>toAppendStream<span class="token punctuation">[</span>Row<span class="token punctuation">]</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">//todo:8、启动</span>
     tableEnvironment<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">"TableFromDataStream"</span><span class="token punctuation">)</span>

  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>   
</code></pre>
     </li>
     <li>
      <p>
       发送数据
      </p>
      <pre><code>101,zhangsan,18
102,lisi,20
103,wangwu,25
104,zhaoliu,15
</code></pre>
     </li>
     <li>
      <p>
       将Table转换成为DataStream的两种模式
      </p>
      <ul>
       <li>
        <p>
         第一种方式：AppendMode(追加模式)
        </p>
        <pre><code>   将表附加到流数据，表当中只能有查询或者添加操作，如果有update或者delete操作，那么就会失败。
 只有在动态Table仅通过INSERT时才能使用此模式，即它仅附加，并且以前发出的结果永远不会更新。
 如果更新或删除操作使用追加模式会失败报错。
</code></pre>
       </li>
       <li>
        <p>
         第二种模式：RetractMode（撤回模式）
        </p>
        <pre><code>     始终可以使用此模式。返回值是boolean类型。
     它用true或false来标记数据的插入和撤回，返回true代表数据插入，false代表数据的撤回。
</code></pre>
       </li>
      </ul>
     </li>
     <li>
      <p>
       按照官网的理解如果数据只是不断添加，可以使用追加模式，其余方式则不可以使用追加模式，而撤回模式侧可以适用于更新，删除等场景。具体的区别 如下图所示：
      </p>
      <p>
       <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/4164122060e040aebb8ae2edcb7ff5e1.png"/>
      </p>
      <p>
       <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/ef5057757336486a87e7c62e5d953d4b.png"/>
      </p>
     </li>
     <li>
      <p>
       通过上图可以清晰的看到两种方式的区别，我们在利用flinkSQL处理实时数据把表转化成流的时候，如果使用的sql语句包含：count（） group by时，必须使用RetractMode撤回模式。
      </p>
     </li>
    </ul>
    <h6>
     <a id="362_SQLwindow_1433">
     </a>
     3.6.2 SQL中的window
    </h6>
    <ul>
     <li>
      <p>
       Flink SQL 也支持三种窗口类型，分别为 Tumble Windows、HOP Windows 和 Session Windows，其中 HOP Windows 对应 Table API 中的 Sliding Window，同时每种窗口分别有相应的使用场景和方法。
      </p>
     </li>
     <li>
      <p>
       需求
      </p>
      <ul>
       <li>
        统计最近 5 秒钟，每个单词出现的次数
       </li>
      </ul>
     </li>
     <li>
      <p>
       代码开发
      </p>
      <pre><code class="prism language-scala"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>table</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span>TimeCharacteristic
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span>AssignerWithPeriodicWatermarks
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{<!-- --></span>DataStream<span class="token punctuation">,</span> StreamExecutionEnvironment<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>watermark<span class="token punctuation">.</span></span>Watermark
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>StreamTableEnvironment
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token punctuation">{<!-- --></span>GroupWindowedTable<span class="token punctuation">,</span> Table<span class="token punctuation">,</span> Tumble<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>types<span class="token punctuation">.</span></span>Row

<span class="token comment">/**
  * 基于SQL的window窗口操作处理延迟数据
  */</span>
<span class="token keyword">object</span> SQLWindowWaterMark <span class="token punctuation">{<!-- --></span>

  <span class="token comment">//定义样例类</span>
  <span class="token keyword">case</span> <span class="token keyword">class</span> Message<span class="token punctuation">(</span>word<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">,</span>createTime<span class="token operator">:</span><span class="token builtin">Long</span><span class="token punctuation">)</span>

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//todo:1、构建流处理环境</span>
     <span class="token keyword">val</span> streamEnv<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
    streamEnv<span class="token punctuation">.</span>setParallelism<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

      <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_

    <span class="token comment">//指定EventTime为时间语义</span>
     streamEnv<span class="token punctuation">.</span>setStreamTimeCharacteristic<span class="token punctuation">(</span>TimeCharacteristic<span class="token punctuation">.</span>EventTime<span class="token punctuation">)</span>

   <span class="token comment">//todo: 2、构建StreamTableEnvironment</span>
      <span class="token keyword">val</span> tableEnvironment<span class="token operator">:</span> StreamTableEnvironment <span class="token operator">=</span> StreamTableEnvironment<span class="token punctuation">.</span>create<span class="token punctuation">(</span>streamEnv<span class="token punctuation">)</span>

  <span class="token comment">//todo： 3、接受socket数据</span>
      <span class="token keyword">val</span> sourceStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> streamEnv<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">"node01"</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span>

  <span class="token comment">//todo: 4、数据切分处理</span>
    <span class="token keyword">val</span> mapStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span>Message<span class="token punctuation">]</span> <span class="token operator">=</span> sourceStream<span class="token punctuation">.</span>map<span class="token punctuation">(</span>x<span class="token keyword">=&gt;</span>Message<span class="token punctuation">(</span>x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toLong<span class="token punctuation">)</span><span class="token punctuation">)</span>

   <span class="token comment">//todo: 5、添加watermark</span>
    <span class="token keyword">val</span> watermarksStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span>Message<span class="token punctuation">]</span> <span class="token operator">=</span> mapStream<span class="token punctuation">.</span>assignTimestampsAndWatermarks<span class="token punctuation">(</span><span class="token keyword">new</span> AssignerWithPeriodicWatermarks<span class="token punctuation">[</span>Message<span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>

      <span class="token comment">//定义延迟时长</span>
      <span class="token keyword">val</span> maxOutOfOrderness <span class="token operator">=</span> <span class="token number">5000L</span>
      <span class="token comment">//历史最大事件时间</span>
      <span class="token keyword">var</span> currentMaxTimestamp<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> _

      <span class="token keyword">override</span> <span class="token keyword">def</span> getCurrentWatermark<span class="token operator">:</span> Watermark <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">val</span> watermark <span class="token operator">=</span> <span class="token keyword">new</span> Watermark<span class="token punctuation">(</span>currentMaxTimestamp <span class="token operator">-</span> maxOutOfOrderness<span class="token punctuation">)</span>
        watermark
      <span class="token punctuation">}</span>

      <span class="token keyword">override</span> <span class="token keyword">def</span> extractTimestamp<span class="token punctuation">(</span>element<span class="token operator">:</span> Message<span class="token punctuation">,</span> previousElementTimestamp<span class="token operator">:</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>

        <span class="token keyword">val</span> eventTime<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> element<span class="token punctuation">.</span>createTime
        currentMaxTimestamp <span class="token operator">=</span> Math<span class="token punctuation">.</span>max<span class="token punctuation">(</span>eventTime<span class="token punctuation">,</span> currentMaxTimestamp<span class="token punctuation">)</span>
        eventTime
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token comment">//todo:6、注册DataStream成表 ，设置时间属性</span>
     <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_
    tableEnvironment<span class="token punctuation">.</span>registerDataStream<span class="token punctuation">(</span><span class="token string">"t_socket"</span><span class="token punctuation">,</span>watermarksStream<span class="token punctuation">,</span><span class="token char">'word,'</span>createTime<span class="token punctuation">.</span>rowtime<span class="token punctuation">)</span>  
   <span class="token comment">//todo:7、sql查询---添加window---滚动窗口----窗口长度5s</span>
  <span class="token keyword">val</span> result<span class="token operator">:</span> Table <span class="token operator">=</span> tableEnvironment<span class="token punctuation">.</span>sqlQuery<span class="token punctuation">(</span><span class="token string">"select word,count(*) from t_socket group by tumble(createTime,interval '5' second),word"</span><span class="token punctuation">)</span>   
   <span class="token comment">//todo:8、将table转换成DataStream</span>
   <span class="token keyword">val</span> resultStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">Boolean</span><span class="token punctuation">,</span> Row<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> tableEnvironment<span class="token punctuation">.</span>toRetractStream<span class="token punctuation">[</span>Row<span class="token punctuation">]</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>

   resultStream<span class="token punctuation">.</span>filter<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span>x<span class="token punctuation">.</span>_1 <span class="token operator">==</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>

   tableEnvironment<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">"table"</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>   
  <span class="token punctuation">}</span>  
</code></pre>
     </li>
     <li>
      <p>
       发送数据
      </p>
     </li>
    </ul>
    <pre><code>hadoop,1461756862000
hadoop,1461756865000
hadoop,1461756863000
hadoop,1461756868000
hadoop,1461756870000
hadoop,1461756875000
hadoop,1461756880000
</code></pre>
    <ul>
     <li>
      <p>
       更多的SQL操作详细见官网
      </p>
      <ul>
       <li>
        <p>
         <a href="https://ci.apache.org/projects/flink/flink-docs-release-1.10/dev/table/sql/queries.html" rel="nofollow">
          https://ci.apache.org/projects/flink/flink-docs-release-1.10/dev/table/sql/queries.html
         </a>
        </p>
        <p>
         <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/1025b20325974516857e0715f06771b9.png"/>
        </p>
       </li>
      </ul>
     </li>
    </ul>
    <h3>
     <a id="_1546">
     </a>
     把所有的代码都敲一遍
    </h3>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f:626c6f672e6373646e2e6e65742f753031303334323231332f:61727469636c652f64657461696c732f313436313033313938" class_="artid" style="display:none">
 </p>
</div>


