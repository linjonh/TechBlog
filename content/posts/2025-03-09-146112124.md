---
layout: post
title: "aws学习笔记第三十二课-深入使用cdkAPI-Gateway-event-bridge"
date: 2025-03-09 11:00:27 +0800
description: "cdklambda。"
keywords: "aws(学习笔记第三十二课) 深入使用cdk(API Gateway + event bridge)"
categories: ['Aws']
tags: ['笔记', '学习', 'Aws']
artid: "146112124"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146112124
    alt: "aws学习笔记第三十二课-深入使用cdkAPI-Gateway-event-bridge"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146112124
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146112124
cover: https://bing.ee123.net/img/rand?artid=146112124
image: https://bing.ee123.net/img/rand?artid=146112124
img: https://bing.ee123.net/img/rand?artid=146112124
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     aws(学习笔记第三十二课) 深入使用cdk(API Gateway + event bridge)
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <p>
    </p>
    <h2>
     <a id="aws_cdk_1">
     </a>
     aws(学习笔记第三十二课) 深入使用cdk
    </h2>
    <ul>
     <li class="task-list-item">
      <input checked="true" class="task-list-item-checkbox" disabled="disabled" type="checkbox"/>
      使用
      <code>
       cdk
      </code>
      生成
      <code>
       aws API Gateway
      </code>
      +
      <code>
       lambda
      </code>
      以及
      <code>
       eventbridge
      </code>
      等等
     </li>
    </ul>
    <h2>
     <a id="_3">
     </a>
     学习内容：
    </h2>
    <ul>
     <li>
      使用
      <code>
       aws API Gateway
      </code>
      +
      <code>
       lambda
      </code>
     </li>
     <li>
      使用
      <code>
       event bridge
      </code>
      练习
      <code>
       producer
      </code>
      和
      <code>
       consumer
      </code>
     </li>
    </ul>
    <hr/>
    <h3>
     <a id="1_aws_API_Gatewaylambda_7">
     </a>
     1. 使用
     <code>
      aws API Gateway
     </code>
     +
     <code>
      lambda
     </code>
    </h3>
    <h4>
     <a id="11__8">
     </a>
     1.1. 以前的练习
    </h4>
    <ul>
     <li>
      以前的例子
      <br/>
      <a href="https://blog.csdn.net/sealaugh1980/article/details/145427789">
       API Gateway + lambda
      </a>
      这个例子中已经使用了手动创建，使用练习了
      <code>
       aws API Gateway
      </code>
      +
      <code>
       lambda
      </code>
     </li>
     <li>
      使用
      <code>
       cdk
      </code>
      来创建
      <br/>
      这里，采用
      <code>
       cdk
      </code>
      的方式来创建
      <code>
       API Gateway
      </code>
      +
      <code>
       lambda
      </code>
      。
      <br/>
      <a href="https://gitcode.com/gh_mirrors/aw/aws-cdk-examples/tree/main/python/api-cors-lambda">
       代码链接 api-cors-lambda
      </a>
     </li>
    </ul>
    <h4>
     <a id="12_cdkAPI_Gateway__lambda_14">
     </a>
     1.2. 使用
     <code>
      cdk
     </code>
     创建
     <code>
      API Gateway
     </code>
     +
     <code>
      lambda
     </code>
    </h4>
    <ul>
     <li>
      整体架构
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/a76ef16babc04594aaa6078adde5eebf.png"/>
     </li>
     <li>
      代码解析
      <ul>
       <li>
        创建
        <code>
         lambda
        </code>
        函数
        <pre><code class="prism language-python">	   base_lambda <span class="token operator">=</span> _lambda<span class="token punctuation">.</span>Function<span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">'ApiCorsLambda'</span><span class="token punctuation">,</span>
	   handler<span class="token operator">=</span><span class="token string">'lambda-handler.handler'</span><span class="token punctuation">,</span>
	   runtime<span class="token operator">=</span>_lambda<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>PYTHON_3_12<span class="token punctuation">,</span>
	   code<span class="token operator">=</span>_lambda<span class="token punctuation">.</span>Code<span class="token punctuation">.</span>from_asset<span class="token punctuation">(</span><span class="token string">'lambda'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
        注意，这里没有创建
        <code>
         VPC
        </code>
        ，因为这里不需要显示的创建
        <code>
         VPC
        </code>
        。
        <br/>
        <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/0333c15d48a34a59916cae985b8cc4aa.png">
         <ul>
          <li>
           <p>
            创建
            <code>
             API
            </code>
            并且添加
            <code>
             resource
            </code>
           </p>
           <pre><code class="prism language-python">        base_api <span class="token operator">=</span> _apigw<span class="token punctuation">.</span>RestApi<span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">'ApiGatewayWithCors'</span><span class="token punctuation">,</span>
                                  rest_api_name<span class="token operator">=</span><span class="token string">'ApiGatewayWithCors'</span><span class="token punctuation">)</span>

        example_entity <span class="token operator">=</span> base_api<span class="token punctuation">.</span>root<span class="token punctuation">.</span>add_resource<span class="token punctuation">(</span>
            <span class="token string">'example'</span><span class="token punctuation">,</span>
        default_cors_preflight_options<span class="token operator">=</span>_apigw<span class="token punctuation">.</span>CorsOptions<span class="token punctuation">(</span>
                allow_methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'OPTIONS'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                allow_origins<span class="token operator">=</span>_apigw<span class="token punctuation">.</span>Cors<span class="token punctuation">.</span>ALL_ORIGINS<span class="token punctuation">)</span>
</code></pre>
           <p>
            <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/e710beb9e1e64ddda60a971339ad82e8.png"/>
           </p>
          </li>
          <li>
           <p>
            创建
            <code>
             LambdaIntegration
            </code>
            将
            <code>
             API
            </code>
            和
            <code>
             lambda
            </code>
            进行绑定
           </p>
           <pre><code class="prism language-python">      example_entity_lambda_integration <span class="token operator">=</span> _apigw<span class="token punctuation">.</span>LambdaIntegration<span class="token punctuation">(</span>
            base_lambda<span class="token punctuation">,</span>
            proxy<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
            integration_responses<span class="token operator">=</span><span class="token punctuation">[</span>
                _apigw<span class="token punctuation">.</span>IntegrationResponse<span class="token punctuation">(</span>
                    status_code<span class="token operator">=</span><span class="token string">"200"</span><span class="token punctuation">,</span>
                    response_parameters<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
                        <span class="token string">'method.response.header.Access-Control-Allow-Origin'</span><span class="token punctuation">:</span> <span class="token string">"'*'"</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">)</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">)</span>
</code></pre>
           <p>
            <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/fdb012c72aae4609bf3a269b6928a11f.png"/>
           </p>
          </li>
          <li>
           <p>
            对
            <code>
             API
            </code>
            加入
            <code>
             method
            </code>
           </p>
           <pre><code class="prism language-python">      example_entity<span class="token punctuation">.</span>add_method<span class="token punctuation">(</span>
            <span class="token string">'GET'</span><span class="token punctuation">,</span> example_entity_lambda_integration<span class="token punctuation">,</span>
            method_responses<span class="token operator">=</span><span class="token punctuation">[</span>
                _apigw<span class="token punctuation">.</span>MethodResponse<span class="token punctuation">(</span>
                    status_code<span class="token operator">=</span><span class="token string">"200"</span><span class="token punctuation">,</span>
                    response_parameters<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
                        <span class="token string">'method.response.header.Access-Control-Allow-Origin'</span><span class="token punctuation">:</span> <span class="token boolean">True</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">)</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">)</span>
</code></pre>
           <p>
            <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/92e3cdfba1db4081909519e173a26a07.png"/>
           </p>
          </li>
         </ul>
        </img>
       </li>
      </ul>
     </li>
    </ul>
    <h4>
     <a id="13_cdkAPI_Gateway__lambda_71">
     </a>
     1.3. 确认
     <code>
      cdk
     </code>
     创建
     <code>
      API Gateway
     </code>
     +
     <code>
      lambda
     </code>
    </h4>
    <ul>
     <li>
      执行创建的
      <code>
       cdk
      </code>
      <pre><code class="prism language-shell">	cdk --require-approval never deploy
</code></pre>
     </li>
     <li>
      查看创建的结果
      <ul>
       <li>
        <p>
         <code>
          lambda
         </code>
         创建结果
         <br/>
         <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/1d992e3fe5144b6896335bfc624e0638.png"/>
        </p>
       </li>
       <li>
        <p>
         <code>
          API
         </code>
         创建结果
         <br/>
         <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/9c3afc3912954086b816f40d3dc80ce6.png"/>
        </p>
       </li>
       <li>
        <p>
         确认
         <code>
          API
         </code>
         的调用
         <code>
          URL
         </code>
         <br/>
         <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/54aea8a3cb6c4e3bb11d336b19a7c7b4.png"/>
        </p>
       </li>
       <li>
        <p>
         访问
         <code>
          API
         </code>
         的调用
         <code>
          URL
         </code>
         <br/>
         之后不要忘记
         <code>
          cdk destroy
         </code>
         <br/>
         <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/00cf9499f88c4c6d8051ebdb252f16f5.png"/>
        </p>
       </li>
      </ul>
     </li>
    </ul>
    <h3>
     <a id="2__event_bridgeproducerconsumer_87">
     </a>
     2. 使用
     <code>
      event bridge
     </code>
     练习
     <code>
      producer
     </code>
     和
     <code>
      consumer
     </code>
    </h3>
    <h4>
     <a id="21__88">
     </a>
     2.1. 代码链接
    </h4>
    <p>
     <a href="https://gitcode.com/gh_mirrors/aw/aws-cdk-examples/tree/main/python/api-eventbridge-lambda">
      api-eventbridge-lambda的代码链接
     </a>
     <br/>
     这里主要练习使用
     <code>
      eventbridge
     </code>
     ，进行
     <code>
      producer
     </code>
     和
     <code>
      consumer
     </code>
     的练习。
    </p>
    <h4>
     <a id="22__91">
     </a>
     2.2. 开始练习
    </h4>
    <ul>
     <li>
      整体架构
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/8764adf8995c4b39a13b9740970a6b81.png"/>
     </li>
     <li>
      代码解析
      <ul>
       <li>
        <p>
         生成
         <code>
          producer
         </code>
        </p>
        <pre><code class="prism language-python">			        <span class="token comment">#</span>
			        <span class="token comment"># Producer Lambda</span>
			        <span class="token comment">#</span>
			        event_producer_lambda <span class="token operator">=</span> _lambda<span class="token punctuation">.</span>Function<span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">"eventProducerLambda"</span><span class="token punctuation">,</span>
			                                                 runtime<span class="token operator">=</span>_lambda<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>PYTHON_3_12<span class="token punctuation">,</span>
			                                                 handler<span class="token operator">=</span><span class="token string">"event_producer_lambda.lambda_handler"</span><span class="token punctuation">,</span>
			                                                 code<span class="token operator">=</span>_lambda<span class="token punctuation">.</span>Code<span class="token punctuation">.</span>from_asset<span class="token punctuation">(</span><span class="token string">"lambda"</span><span class="token punctuation">)</span>
			                                                 <span class="token punctuation">)</span>
			
			        event_policy <span class="token operator">=</span> iam<span class="token punctuation">.</span>PolicyStatement<span class="token punctuation">(</span>effect<span class="token operator">=</span>iam<span class="token punctuation">.</span>Effect<span class="token punctuation">.</span>ALLOW<span class="token punctuation">,</span> resources<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'*'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> actions<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'events:PutEvents'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
			
			        event_producer_lambda<span class="token punctuation">.</span>add_to_role_policy<span class="token punctuation">(</span>event_policy<span class="token punctuation">)</span>
</code></pre>
        <p>
         这里，
         <code>
          producer
         </code>
         被赋予权限
         <code>
          putEvents
         </code>
         ，因为之后要向
         <code>
          eventbridge
         </code>
         进行
         <code>
          putEvents
         </code>
         操作。
         <br/>
         <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/a2368cad51bc4dd889b92ae7c24395f6.png"/>
        </p>
       </li>
       <li>
        <p>
         <code>
          producer
         </code>
         的处理代码
        </p>
        <pre><code class="prism language-python">	<span class="token keyword">def</span> <span class="token function">lambda_handler</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">:</span>
	    eventbridge_client <span class="token operator">=</span> boto3<span class="token punctuation">.</span>client<span class="token punctuation">(</span><span class="token string">'events'</span><span class="token punctuation">)</span>
	    request_body <span class="token operator">=</span> event<span class="token punctuation">[</span><span class="token string">"body"</span><span class="token punctuation">]</span>
	    <span class="token keyword">if</span> request_body <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
	        request_body <span class="token operator">=</span> <span class="token string">""</span>
	    <span class="token comment"># Structure of EventBridge Event</span>
	    eventbridge_event <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
	        <span class="token string">'Time'</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	        <span class="token string">'Source'</span><span class="token punctuation">:</span> <span class="token string">'com.mycompany.myapp'</span><span class="token punctuation">,</span>
	        <span class="token string">'Detail'</span><span class="token punctuation">:</span> request_body<span class="token punctuation">,</span>
	        <span class="token string">'DetailType'</span><span class="token punctuation">:</span> <span class="token string">'service_status'</span>
	    <span class="token punctuation">}</span>
	    logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span>eventbridge_event<span class="token punctuation">)</span>
	
	    <span class="token comment"># Send event to EventBridge</span>
	    response <span class="token operator">=</span> eventbridge_client<span class="token punctuation">.</span>put_events<span class="token punctuation">(</span>
	        Entries<span class="token operator">=</span><span class="token punctuation">[</span>
	            eventbridge_event
	        <span class="token punctuation">]</span>
	    <span class="token punctuation">)</span>
	
	    logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span>response<span class="token punctuation">)</span>
	
	    <span class="token comment"># Returns success reponse to API Gateway</span>
	    <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>
	        <span class="token string">"statusCode"</span><span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
	        <span class="token string">"body"</span><span class="token punctuation">:</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
	            <span class="token string">"result"</span><span class="token punctuation">:</span> <span class="token string">"from Producer"</span>
	        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	    <span class="token punctuation">}</span>
</code></pre>
        <p>
         这里，使用了
         <code>
          boto3
         </code>
         这个
         <code>
          python package
         </code>
         ，AWS ‌Boto3‌ 是亚马逊云服务（
         <code>
          AWS
         </code>
         ）官方提供的
         <code>
          Python SDK
         </code>
         ，主要用于通过代码与
         <code>
          AWS
         </code>
         服务进行交互和管理。这里使用
         <code>
          boto3
         </code>
         向
         <code>
          eventbridge
         </code>
         进行
         <code>
          putEvents
         </code>
         。
        </p>
       </li>
       <li>
        <p>
         <code>
          consumer1
         </code>
         和
         <code>
          consumer2
         </code>
        </p>
        <pre><code class="prism language-python">			        <span class="token comment">#</span>
			        <span class="token comment"># Approved Consumer1</span>
			        <span class="token comment">#</span>
			        event_consumer1_lambda <span class="token operator">=</span> _lambda<span class="token punctuation">.</span>Function<span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">"eventConsumer1Lambda"</span><span class="token punctuation">,</span>
			                                                  runtime<span class="token operator">=</span>_lambda<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>PYTHON_3_8<span class="token punctuation">,</span>
			                                                  handler<span class="token operator">=</span><span class="token string">"event_consumer_lambda.lambda_handler"</span><span class="token punctuation">,</span>
			                                                  code<span class="token operator">=</span>_lambda<span class="token punctuation">.</span>Code<span class="token punctuation">.</span>from_asset<span class="token punctuation">(</span><span class="token string">"lambda"</span><span class="token punctuation">)</span>
			                                                  <span class="token punctuation">)</span>
			
			        event_consumer1_rule <span class="token operator">=</span> events<span class="token punctuation">.</span>Rule<span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">'eventConsumer1LambdaRule'</span><span class="token punctuation">,</span>
			                                           description<span class="token operator">=</span><span class="token string">'Approved Transactions'</span><span class="token punctuation">,</span>
			                                           event_pattern<span class="token operator">=</span>events<span class="token punctuation">.</span>EventPattern<span class="token punctuation">(</span>source<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'com.mycompany.myapp'</span><span class="token punctuation">]</span>
			                                                                             <span class="token punctuation">)</span><span class="token punctuation">)</span>
			
			        event_consumer1_rule<span class="token punctuation">.</span>add_target<span class="token punctuation">(</span>targets<span class="token punctuation">.</span>LambdaFunction<span class="token punctuation">(</span>handler<span class="token operator">=</span>event_consumer1_lambda<span class="token punctuation">)</span><span class="token punctuation">)</span>
			
			        <span class="token comment">#</span>
			        <span class="token comment"># Approved Consumer2</span>
			        <span class="token comment">#</span>
			        event_consumer2_lambda <span class="token operator">=</span> _lambda<span class="token punctuation">.</span>Function<span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">"eventConsumer2Lambda"</span><span class="token punctuation">,</span>
			                                                  runtime<span class="token operator">=</span>_lambda<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>PYTHON_3_8<span class="token punctuation">,</span>
			                                                  handler<span class="token operator">=</span><span class="token string">"event_consumer_lambda.lambda_handler"</span><span class="token punctuation">,</span>
			                                                  code<span class="token operator">=</span>_lambda<span class="token punctuation">.</span>Code<span class="token punctuation">.</span>from_asset<span class="token punctuation">(</span><span class="token string">"lambda"</span><span class="token punctuation">)</span>
			                                                  <span class="token punctuation">)</span>
			
			        event_consumer2_rule <span class="token operator">=</span> events<span class="token punctuation">.</span>Rule<span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">'eventConsumer2LambdaRule'</span><span class="token punctuation">,</span>
			                                           description<span class="token operator">=</span><span class="token string">'Approved Transactions'</span><span class="token punctuation">,</span>
			                                           event_pattern<span class="token operator">=</span>events<span class="token punctuation">.</span>EventPattern<span class="token punctuation">(</span>source<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'com.mycompany.myapp'</span><span class="token punctuation">]</span>
			                                                                             <span class="token punctuation">)</span><span class="token punctuation">)</span>
			        event_consumer2_rule<span class="token punctuation">.</span>add_target<span class="token punctuation">(</span>targets<span class="token punctuation">.</span>LambdaFunction<span class="token punctuation">(</span>handler<span class="token operator">=</span>event_consumer2_lambda<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
        <p>
         <code>
          consumer1
         </code>
         和
         <code>
          consumer2
         </code>
         类似，就是接受到了
         <code>
          eventbridge
         </code>
         的
         <code>
          event
         </code>
         之后，进行
         <code>
          log
         </code>
         输出。
        </p>
        <pre><code class="prism language-python">			<span class="token keyword">def</span> <span class="token function">lambda_handler</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">:</span>
			    logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span>event<span class="token punctuation">)</span>
			
			    <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>
			        <span class="token string">"statusCode"</span><span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
			        <span class="token string">"body"</span><span class="token punctuation">:</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
			            <span class="token string">"result"</span><span class="token punctuation">:</span> <span class="token string">"testing..."</span>
			        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			    <span class="token punctuation">}</span>
</code></pre>
        <p>
         <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/b5d1ab08cfb04778b5508e0767244a42.png"/>
        </p>
       </li>
       <li>
        <p>
         <code>
          consumer3
         </code>
         使用
         <code>
          kinesisfirehose
         </code>
         对
         <code>
          event
         </code>
         进行接受，并保存到
         <code>
          S3 bucket
         </code>
         上
        </p>
        <pre><code class="prism language-python">	        <span class="token comment">#</span>
	        <span class="token comment"># Approved Consumer3</span>
	        <span class="token comment">#</span>
	
	        <span class="token comment"># Create S3 bucket for KinesisFirehose destination</span>
	        ingest_bucket <span class="token operator">=</span> s3<span class="token punctuation">.</span>Bucket<span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">'test-ngest-bucket'</span><span class="token punctuation">)</span>
	
	        <span class="token comment"># Create a Role for KinesisFirehose</span>
	        firehose_role <span class="token operator">=</span> iam<span class="token punctuation">.</span>Role<span class="token punctuation">(</span>
	            self<span class="token punctuation">,</span> <span class="token string">'myRole'</span><span class="token punctuation">,</span>
	            assumed_by<span class="token operator">=</span>iam<span class="token punctuation">.</span>ServicePrincipal<span class="token punctuation">(</span><span class="token string">'firehose.amazonaws.com'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	
	        <span class="token comment"># Create and attach policy that gives permissions to write in to the S3 bucket.</span>
	        iam<span class="token punctuation">.</span>Policy<span class="token punctuation">(</span>
	            self<span class="token punctuation">,</span> <span class="token string">'s3_attr'</span><span class="token punctuation">,</span>
	            policy_name<span class="token operator">=</span><span class="token string">'s3kinesis'</span><span class="token punctuation">,</span>
	            statements<span class="token operator">=</span><span class="token punctuation">[</span>iam<span class="token punctuation">.</span>PolicyStatement<span class="token punctuation">(</span>
	                actions<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'s3:*'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
	                resources<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'arn:aws:s3:::'</span> <span class="token operator">+</span> ingest_bucket<span class="token punctuation">.</span>bucket_name <span class="token operator">+</span> <span class="token string">'/*'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
	                <span class="token comment"># resources=['*'])],</span>
	            roles<span class="token operator">=</span><span class="token punctuation">[</span>firehose_role<span class="token punctuation">]</span><span class="token punctuation">,</span>
	        <span class="token punctuation">)</span>
	
	        event_consumer3_kinesisfirehose <span class="token operator">=</span> _firehose<span class="token punctuation">.</span>CfnDeliveryStream<span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">"consumer3-firehose"</span><span class="token punctuation">,</span>
	                                                                      s3_destination_configuration<span class="token operator">=</span>_firehose<span class="token punctuation">.</span>CfnDeliveryStream<span class="token punctuation">.</span>S3DestinationConfigurationProperty<span class="token punctuation">(</span>
	                                                                          bucket_arn<span class="token operator">=</span>ingest_bucket<span class="token punctuation">.</span>bucket_arn<span class="token punctuation">,</span>
	                                                                          buffering_hints<span class="token operator">=</span>_firehose<span class="token punctuation">.</span>CfnDeliveryStream<span class="token punctuation">.</span>BufferingHintsProperty<span class="token punctuation">(</span>
	                                                                              interval_in_seconds<span class="token operator">=</span><span class="token number">60</span>
	                                                                          <span class="token punctuation">)</span><span class="token punctuation">,</span>
	                                                                          compression_format<span class="token operator">=</span><span class="token string">"UNCOMPRESSED"</span><span class="token punctuation">,</span>
	                                                                          role_arn<span class="token operator">=</span>firehose_role<span class="token punctuation">.</span>role_arn
	                                                                      <span class="token punctuation">)</span><span class="token punctuation">)</span>
	
	        event_consumer3_rule <span class="token operator">=</span> events<span class="token punctuation">.</span>Rule<span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">'eventConsumer3KinesisRule'</span><span class="token punctuation">,</span>
	                                           description<span class="token operator">=</span><span class="token string">'Approved Transactions'</span><span class="token punctuation">,</span>
	                                           event_pattern<span class="token operator">=</span>events<span class="token punctuation">.</span>EventPattern<span class="token punctuation">(</span>source<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'com.mycompany.myapp'</span><span class="token punctuation">]</span>
	                                                                             <span class="token punctuation">)</span><span class="token punctuation">)</span>
	        event_consumer3_rule<span class="token punctuation">.</span>add_target<span class="token punctuation">(</span>targets<span class="token punctuation">.</span>KinesisFirehoseStream<span class="token punctuation">(</span>stream<span class="token operator">=</span>event_consumer3_kinesisfirehose<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
        <p>
         <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/53e51e85ed3e423ca4f0ddafd9898dfe.png"/>
        </p>
       </li>
       <li>
        <p>
         将
         <code>
          producer
         </code>
         通过
         <code>
          API Gateway
         </code>
         进行公开
        </p>
        <pre><code class="prism language-python">	        <span class="token comment"># defines an API Gateway REST API resource backed by our "atm_producer_lambda" function.</span>
	        api <span class="token operator">=</span> api_gw<span class="token punctuation">.</span>LambdaRestApi<span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">'SampleAPI-EventBridge-Multi-Consumer'</span><span class="token punctuation">,</span>
	                             handler<span class="token operator">=</span>event_producer_lambda<span class="token punctuation">,</span>
	                             proxy<span class="token operator">=</span><span class="token boolean">False</span>
	                             <span class="token punctuation">)</span>
	        items <span class="token operator">=</span> api<span class="token punctuation">.</span>root<span class="token punctuation">.</span>add_resource<span class="token punctuation">(</span><span class="token string">"items"</span><span class="token punctuation">)</span>
	        items<span class="token punctuation">.</span>add_method<span class="token punctuation">(</span><span class="token string">"POST"</span><span class="token punctuation">)</span>  <span class="token comment"># POST /items</span>
</code></pre>
       </li>
      </ul>
     </li>
    </ul>
    <h4>
     <a id="23__245">
     </a>
     2.3. 代码部署的确认
    </h4>
    <p>
     接下来进行
     <code>
      cdk deploy
     </code>
     来确认执行效果。
    </p>
    <ul>
     <li>
      一个
      <code>
       producer
      </code>
      与两个
      <code>
       consumer
      </code>
      ，都是
      <code>
       lambda
      </code>
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/dea7ea6265da44a2a40161e514324eed.png"/>
     </li>
     <li>
      第三个
      <code>
       consumer
      </code>
      ，一个
      <code>
       kinesisFireHose
      </code>
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/0fa5b56075e04e2f86c26b6f23963404.png"/>
     </li>
     <li>
      <code>
       API
      </code>
      的
      <code>
       producer
      </code>
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/07a8e7a84a4d4dd9aeb1459eac9e3644.png"/>
     </li>
    </ul>
    <h4>
     <a id="24__253">
     </a>
     2.4. 对部署进行测试
    </h4>
    <ul>
     <li>
      对
      <code>
       API
      </code>
      进行测试调用
      <br/>
      返回了正常的结果。这里，需要对请求正文
      <code>
       request body
      </code>
      一定要设定参数这里设置如下。
      <pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span><span class="token string-property property">"item1"</span><span class="token operator">:</span><span class="token string">"123"</span><span class="token punctuation">,</span><span class="token string-property property">"item2"</span><span class="token operator">:</span><span class="token string">"234"</span><span class="token punctuation">}</span>
</code></pre>
      使用
      <code>
       API
      </code>
      调用，之后启动
      <code>
       producer
      </code>
      的
      <code>
       lamdba
      </code>
      ，向
      <code>
       eventbridge
      </code>
      进行
      <code>
       putEvents
      </code>
      。
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/203280f5dd6949789d7c4aa0d45362f9.png"/>
     </li>
     <li>
      对
      <code>
       consumer1
      </code>
      和
      <code>
       consumer2
      </code>
      进行确认
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/c53c77e86c3e483fb43dd1f719989114.png"/>
     </li>
     <li>
      对
      <code>
       consumer3
      </code>
      进行确认
      <br/>
      这里主要是对
      <code>
       S3 bucket
      </code>
      进行确认。可以看到，
      <br/>
      <code>
       producer
      </code>
      -&gt;
      <code>
       event
      </code>
      -&gt;
      <code>
       eventbridge
      </code>
      -&gt;
      <code>
       consumer3
      </code>
      -&gt;
      <code>
       kinesis firehose
      </code>
      -&gt;
      <code>
       S3 bucket
      </code>
      <br/>
      最后
      <code>
       cdk destroy
      </code>
      。
     </li>
    </ul>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/ad1474c3014648cba5b6e1c6f7ad5640.png"/>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c:6f672e6373646e2e6e65742f7365616c61756768313938302f:61727469636c652f64657461696c732f313436313132313234" class_="artid" style="display:none">
 </p>
</div>


