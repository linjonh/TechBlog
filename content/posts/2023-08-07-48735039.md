---
layout: post
title: "Android-即时音视频解决方案2腾讯云"
date: 2023-08-07 22:54:27 +0800
description: "上一篇文章介绍了环信的解决方案，见Android 即时音视频解决方案1——环信，这篇文章，介绍一下更"
keywords: "android 集成腾讯实时音频"
categories: ['基础', 'Android']
tags: ['语音', '视频', '腾讯云', '签名', 'Android']
artid: "48735039"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=48735039
    alt: "Android-即时音视频解决方案2腾讯云"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=48735039
featuredImagePreview: https://bing.ee123.net/img/rand?artid=48735039
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Android 即时音视频解决方案2——腾讯云
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     上一篇文章介绍了环信的解决方案，见
     <a href="http://blog.csdn.net/sbsujjbcy/article/details/48734951">
      Android 即时音视频解决方案1——环信
     </a>
     ，这篇文章，介绍一下更加靠谱，也就是腾讯云的解决方案，毕竟腾讯是是这方面的头头，比较靠谱。当然，集成腾讯云比集成环信稍微复杂那么一点，需要有一点点的耐心。
    </p>
    <p>
     官方地址
     <a href="http://www.qcloud.com/product/avc.html" rel="nofollow">
      音视频云通信 AVC
     </a>
    </p>
    <p>
     SDK下载
     <a href="http://qzonestyle.gtimg.cn/open/qcloud/avc/js/sdk_download/av_sdk/QAV_Android_SDK1.3.0.zip" rel="nofollow">
      AV Andriod1.3
     </a>
    </p>
    <p>
     文档地址
     <a href="http://www.qcloud.com/wiki/%E9%9F%B3%E8%A7%86%E9%A2%91%E4%BA%91%E9%80%9A%E8%AE%AF" rel="nofollow">
      音视频云通讯
     </a>
    </p>
    <p>
     先讲讲腾讯云的原理，使用腾讯云的时候，要有一个账号体系，这个账号体系比较灵活，可以使用独立模式也可以只用第三方账号体系，这里使用独立模式。
    </p>
    <p>
     使用独立模式，要使用腾讯云的服务的时候，我们无需将用户的账号密码同步到腾讯，但是我们的服务端需要进行一定的处理。 用户在APP客户端输入帐号密码后到APP自有帐号登录服务器验证，验证成功后自有帐号登录服务器使用私钥派发签名（sig）给客户端；客户端提交用户帐号和私钥签名IM云（通过IMSDK或者音视频SDK接口），验证签名成功后向终端派发相应票据，进而使用IM云服务。
    </p>
    <ul>
     <li>
      开发者需要保证私钥安全，腾讯完全信赖私钥签名；
     </li>
     <li>
      签名有效期由开发者指定，并加密在私钥签名中；
     </li>
     <li>
      该集成方式无需将APP自有帐号的帐号密码同步腾讯，最大程度保证开发者用户数据的私密性。
     </li>
    </ul>
    <p>
     下面贴出官方文档的一个例子说明
    </p>
    <p>
     假设开发者开发的APP为天天互动，天天互动自有服务器（开发自己开发）支持用户注册功能，同时天天互动接入了腾讯音视频通讯服务。某一天用户A在天天互动注册了帐号，登录天天互动后使用腾讯的音视频服务与家人视频。那么天天互动是如何实现这一功能呢？下面描述具体登录流程：
     <br/>
     - 用户A在天天互动的客户端输入自己的帐号及密码后，客户端传给天天互动的帐号服务器进行验证；
     <br/>
     - 天天互动的帐号服务器验证用户A的信息成功后，使用天天互动的私钥通过TLS提供的后台API生成签名（sig）；
     <br/>
     - 天天互动的帐号服务器将生成的签名派发给天天互动的客户端；
     <br/>
     - 天天互动的客户端使用音视频云通讯相关服务时，需要提交帐号类型（accounttype）、sdkappid、identifier（也就是我们常说的用户id）和签名（由天天互动账号服务器调用TLS后台API生成并派发的）到音视频SDK或者IMSDK的login接口进行验证，验证成功后即可使用相关服务。
    </p>
    <p>
     下面我们进行服务器端的编码
    </p>
    <p>
     几个有用的文档和链接
     <br/>
     -
     <a href="http://qzonestyle.gtimg.cn/qzone/vas/opensns/res/doc/tls_api_manual.docx" rel="nofollow">
      TLS后台API开发指引
     </a>
     <br/>
     -
     <a href="http://qzonestyle.gtimg.cn/qzone/vas/opensns/res/doc/tls_sig_api-windows-64-20150713.zip" rel="nofollow">
      windows 64位 API
     </a>
     <br/>
     -
     <a href="http://www.qcloud.com/wiki/%E9%9F%B3%E8%A7%86%E9%A2%91%E4%BA%91%E9%80%9A%E8%AE%AF%E8%B4%A6%E5%8F%B7%E7%99%BB%E5%BD%95%E9%9B%86%E6%88%90" rel="nofollow">
      音视频云通讯账号登录集成
     </a>
    </p>
    <p>
     服务器端签名的函数，这里使用PHP
    </p>
    <pre class="prettyprint"><code class="hljs xml"><span class="php"><span class="hljs-preprocessor">&lt;?php</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">signature</span><span class="hljs-params">(<span class="hljs-variable">$account_type</span>, <span class="hljs-variable">$identifier</span>, <span class="hljs-variable">$appid_at_3rd</span>,
           <span class="hljs-variable">$sdk_appid</span>, <span class="hljs-variable">$expiry_after</span>, <span class="hljs-variable">$private_key_path</span>)</span>{<!-- --></span>
    <span class="hljs-variable">$command</span> = <span class="hljs-string">'signature.exe'</span>
   . <span class="hljs-string">' '</span>. escapeshellarg(<span class="hljs-variable">$private_key_path</span>)
   . <span class="hljs-string">' '</span> . escapeshellarg(<span class="hljs-variable">$expiry_after</span>)
   . <span class="hljs-string">' '</span> . escapeshellarg(<span class="hljs-variable">$sdk_appid</span>)
   . <span class="hljs-string">' '</span> . escapeshellarg(<span class="hljs-variable">$account_type</span>)
   . <span class="hljs-string">' '</span> . escapeshellarg(<span class="hljs-variable">$appid_at_3rd</span>)
   . <span class="hljs-string">' '</span> .escapeshellarg(<span class="hljs-variable">$identifier</span>);
    <span class="hljs-variable">$ret</span> = exec(<span class="hljs-variable">$command</span>, <span class="hljs-variable">$out</span>, <span class="hljs-variable">$status</span>);
    <span class="hljs-keyword">if</span>( <span class="hljs-variable">$status</span> == -<span class="hljs-number">1</span>){
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$ret</span>;
}
<span class="hljs-preprocessor">?&gt;</span></span>
</code></pre>
    <p>
     当然你还需要将服务器sdk中的signarure.exe放到当前目录下，此外还有私钥
    </p>
    <p>
     当我们服务接收到客户端请求时，登陆成功后会进行签名，需要将签名下发到客户端，客户端利用该签名向腾讯服务器验证
    </p>
    <pre class="prettyprint"><code class="hljs php"><span class="hljs-preprocessor">&lt;?php</span>
<span class="hljs-keyword">include_once</span>(<span class="hljs-string">'function.php'</span>);
<span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'username'</span>]) &amp;&amp; <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'password'</span>])){
    <span class="hljs-variable">$account</span>[<span class="hljs-string">'username'</span>]=<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'username'</span>] ;    
    <span class="hljs-variable">$account</span>[<span class="hljs-string">'password'</span>]=<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'password'</span>];
    <span class="hljs-comment">//这里处理自己服务器登录的流程</span>

    <span class="hljs-comment">//自己服务器登录成功后向客户端下发加密的rsa串</span>
    <span class="hljs-variable">$result</span>=signature(<span class="hljs-string">"1071"</span>,<span class="hljs-variable">$account</span>[<span class="hljs-string">'username'</span>],<span class="hljs-string">"1400001973"</span>,<span class="hljs-string">"1400001973"</span>,<span class="hljs-number">60</span>*<span class="hljs-number">60</span>*<span class="hljs-number">24</span>*<span class="hljs-number">30</span>,<span class="hljs-string">"./private_key"</span>);
    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$result</span>==<span class="hljs-keyword">null</span>){
        <span class="hljs-variable">$res</span>[<span class="hljs-string">'status'</span>]=<span class="hljs-number">500</span>;
        <span class="hljs-variable">$res</span>[<span class="hljs-string">'message'</span>]=<span class="hljs-string">"server error"</span>;
        <span class="hljs-keyword">echo</span> json_encode(<span class="hljs-variable">$res</span>);
    }<span class="hljs-keyword">else</span>{
        <span class="hljs-variable">$res</span>[<span class="hljs-string">'status'</span>]=<span class="hljs-number">200</span>;
        <span class="hljs-variable">$res</span>[<span class="hljs-string">'message'</span>]=<span class="hljs-variable">$result</span>;
        <span class="hljs-keyword">echo</span> json_encode(<span class="hljs-variable">$res</span>);
    }

}<span class="hljs-keyword">else</span>{
    <span class="hljs-variable">$res</span>[<span class="hljs-string">'status'</span>]=<span class="hljs-number">404</span>;
    <span class="hljs-variable">$res</span>[<span class="hljs-string">'message'</span>]=<span class="hljs-string">"params is not right"</span>;
    <span class="hljs-keyword">echo</span> json_encode(<span class="hljs-variable">$res</span>);
}

<span class="hljs-preprocessor">?&gt;</span>
</code></pre>
    <p>
     签名的参数在腾讯云的后台管理可以看到
    </p>
    <p>
     <img alt="这里写图片描述" src="https://img-blog.csdn.net/20150928124250338" title=""/>
    </p>
    <p>
     <img alt="这里写图片描述" src="https://img-blog.csdn.net/20150928124258454" title=""/>
    </p>
    <p>
     注意有一个时间戳参数，该参数代表多久之后过期，由开发者控制。
    </p>
    <p>
     接下来就是客户端的事了。首先就是集成
    </p>
    <p>
     <img alt="这里写图片描述" src="https://img-blog.csdn.net/20150928124330970" title=""/>
    </p>
    <p>
     权限
    </p>
    <pre class="prettyprint"><code class="hljs xml">    <span class="hljs-tag">&lt;<span class="hljs-title">uses-permission</span> <span class="hljs-attribute">android:name</span>=<span class="hljs-value">"android.permission.ACCESS_COARSE_LOCATION"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">uses-permission</span> <span class="hljs-attribute">android:name</span>=<span class="hljs-value">"android.permission.ACCESS_NETWORK_STATE"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">uses-permission</span> <span class="hljs-attribute">android:name</span>=<span class="hljs-value">"android.permission.ACCESS_WIFI_STATE"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">uses-permission</span> <span class="hljs-attribute">android:name</span>=<span class="hljs-value">"android.permission.CAMERA"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">uses-permission</span> <span class="hljs-attribute">android:name</span>=<span class="hljs-value">"android.permission.CHANGE_NETWORK_STATE"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">uses-permission</span> <span class="hljs-attribute">android:name</span>=<span class="hljs-value">"android.permission.GET_TASKS"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">uses-permission</span> <span class="hljs-attribute">android:name</span>=<span class="hljs-value">"android.permission.INTERNET"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">uses-permission</span> <span class="hljs-attribute">android:name</span>=<span class="hljs-value">"android.permission.MODIFY_AUDIO_SETTINGS"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">uses-permission</span> <span class="hljs-attribute">android:name</span>=<span class="hljs-value">"android.permission.READ_LOGS"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">uses-permission</span> <span class="hljs-attribute">android:name</span>=<span class="hljs-value">"android.permission.READ_PHONE_STATE"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">uses-permission</span> <span class="hljs-attribute">android:name</span>=<span class="hljs-value">"android.permission.RECEIVE_BOOT_COMPLETED"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">uses-permission</span> <span class="hljs-attribute">android:name</span>=<span class="hljs-value">"android.permission.RECORD_AUDIO"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">uses-permission</span> <span class="hljs-attribute">android:name</span>=<span class="hljs-value">"android.permission.VIBRATE"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">uses-permission</span> <span class="hljs-attribute">android:name</span>=<span class="hljs-value">"android.permission.WAKE_LOCK"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">uses-permission</span> <span class="hljs-attribute">android:name</span>=<span class="hljs-value">"android.permission.WRITE_EXTERNAL_STORAGE"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">uses-permission</span> <span class="hljs-attribute">android:name</span>=<span class="hljs-value">"android.permission.BLUETOOTH"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">uses-permission</span> <span class="hljs-attribute">android:name</span>=<span class="hljs-value">"android.permission.BLUETOOTH_ADMIN"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">uses-permission</span> <span class="hljs-attribute">android:name</span>=<span class="hljs-value">"android.permission.BROADCAST_STICKY"</span>/&gt;</span></code></pre>
    <p>
     声明组件
    </p>
    <pre class="prettyprint"><code class="hljs applescript"> &lt;<span class="hljs-type">application</span>
        android:<span class="hljs-property">name</span>=<span class="hljs-string">".app.App"</span>&gt;
&lt;/<span class="hljs-type">application</span> &gt;</code></pre>
    <pre class="prettyprint"><code class="hljs xml"> <span class="hljs-tag">&lt;<span class="hljs-title">activity
</span>            <span class="hljs-attribute">android:name</span>=<span class="hljs-value">".activity.AvActivity"</span>
            <span class="hljs-attribute">android:configChanges</span>=<span class="hljs-value">"keyboardHidden|orientation|locale|screenSize"</span>
            <span class="hljs-attribute">android:screenOrientation</span>=<span class="hljs-value">"portrait"</span> /&gt;</span></code></pre>
    <p>
     App类的内容很简单，就是获得QavsdkControl
    </p>
    <pre class="prettyprint"><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">App</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Application</span>{<!-- --></span>
    <span class="hljs-keyword">private</span> QavsdkControl mQavsdkControl = <span class="hljs-keyword">null</span>;
    <span class="hljs-annotation">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onCreate</span>() {
        <span class="hljs-keyword">super</span>.onCreate();
        mQavsdkControl = <span class="hljs-keyword">new</span> QavsdkControl(<span class="hljs-keyword">this</span>);
    }

    <span class="hljs-keyword">public</span> QavsdkControl <span class="hljs-title">getQavsdkControl</span>() {
        <span class="hljs-keyword">return</span> mQavsdkControl;
    }
}
</code></pre>
    <p>
     然后需要拷几个现成的类
    </p>
    <p>
     <img alt="这里写图片描述" src="https://img-blog.csdn.net/20150928124339833" title=""/>
    </p>
    <p>
     你需要修改内容，让他不报错，大部分都是资源相关的东西。
    </p>
    <p>
     然后需要修改两个变量，共两处，值在腾讯云后台获得
    </p>
    <p>
     <img alt="这里写图片描述" src="https://img-blog.csdn.net/20150928124745021" title=""/>
    </p>
    <p>
     <img alt="这里写图片描述" src="https://img-blog.csdn.net/20150928124940608" title=""/>
    </p>
    <p>
     客户端的注册功能由开发者自己实现，因为腾讯云不干涉注册，而登陆需要先登录自己的服务器，然后拿签名向腾讯服务器验证。
    </p>
    <pre class="prettyprint"><code class="hljs avrasm">private void login() {
        String u=username<span class="hljs-preprocessor">.getText</span>()<span class="hljs-preprocessor">.toString</span>()<span class="hljs-comment">;</span>
        String p=password<span class="hljs-preprocessor">.getText</span>()<span class="hljs-preprocessor">.toString</span>()<span class="hljs-comment">;</span>
        if (TextUtils<span class="hljs-preprocessor">.isEmpty</span>(u)||TextUtils<span class="hljs-preprocessor">.isEmpty</span>(p)){
            Toast<span class="hljs-preprocessor">.makeText</span>(getApplicationContext(),<span class="hljs-string">"账号或密码不能为空！"</span>,Toast<span class="hljs-preprocessor">.LENGTH</span>_LONG)<span class="hljs-preprocessor">.show</span>()<span class="hljs-comment">;</span>
            return <span class="hljs-comment">;</span>
        }
        //首先登录自己的服务器
        //自己服务器登录成功后，服务器需要返回rsa加密后的串
        RequestBody requestBody= new FormEncodingBuilder()
                <span class="hljs-preprocessor">.add</span>(<span class="hljs-string">"username"</span>,u)
                <span class="hljs-preprocessor">.add</span>(<span class="hljs-string">"password"</span>,p)
                <span class="hljs-preprocessor">.build</span>()<span class="hljs-comment">;</span>
        String url=<span class="hljs-string">"http://10.0.0.24/tencent/index.php"</span><span class="hljs-comment">;</span>
        Request request=new Request<span class="hljs-preprocessor">.Builder</span>()<span class="hljs-preprocessor">.url</span>(url)<span class="hljs-preprocessor">.post</span>(requestBody)<span class="hljs-preprocessor">.build</span>()<span class="hljs-comment">;</span>
        mOkHttpClient<span class="hljs-preprocessor">.newCall</span>(request)<span class="hljs-preprocessor">.enqueue</span>(new Callback() {
            @Override
            public void onFailure(Request request, IOException e) {
                Log<span class="hljs-preprocessor">.e</span>(<span class="hljs-string">"TAG"</span>, <span class="hljs-string">"Error,register failure."</span>)<span class="hljs-comment">;</span>
            }

            @Override
            public void onResponse(Response response) throws IOException {
                String result = response<span class="hljs-preprocessor">.body</span>()<span class="hljs-preprocessor">.string</span>()<span class="hljs-comment">;</span>
                LoginModel bean = gson<span class="hljs-preprocessor">.fromJson</span>(result, LoginModel<span class="hljs-preprocessor">.class</span>)<span class="hljs-comment">;</span>
                Message message = Message<span class="hljs-preprocessor">.obtain</span>()<span class="hljs-comment">;</span>
                message<span class="hljs-preprocessor">.obj</span> = bean<span class="hljs-comment">;</span>
                message<span class="hljs-preprocessor">.what</span> = LOGIN<span class="hljs-comment">;</span>
                mHandler<span class="hljs-preprocessor">.sendMessage</span>(message)<span class="hljs-comment">;</span>
            }
        })<span class="hljs-comment">;</span>

        //获得rsa加密串后发起音视频前需要向腾讯服务器验证。

    }</code></pre>
    <pre class="prettyprint"><code class="hljs java">  <span class="hljs-keyword">private</span> Handler mHandler=<span class="hljs-keyword">new</span> Handler(){
        <span class="hljs-annotation">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleMessage</span>(Message msg) {
            <span class="hljs-keyword">switch</span> (msg.what){
                <span class="hljs-keyword">case</span> LOGIN:
                    LoginModel bean= (LoginModel) msg.obj;
                    <span class="hljs-keyword">if</span> (bean.getStatus()==<span class="hljs-number">200</span>){
                        sign=bean.getMessage();
                        <span class="hljs-comment">//保存sign</span>
                        Log.e(<span class="hljs-string">"TAG"</span>,<span class="hljs-string">"sign:"</span>+sign);
                        Toast.makeText(getApplicationContext(),<span class="hljs-string">"登录成功,请稍后！"</span>,Toast.LENGTH_LONG).show();
                        startTencentContext();
                    }<span class="hljs-keyword">else</span>{
                        Toast.makeText(getApplicationContext(),<span class="hljs-string">"登录失败！"</span>+bean.getMessage(),Toast.LENGTH_LONG).show();
                    }
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">default</span>:
                    <span class="hljs-keyword">break</span>;
            }
            <span class="hljs-keyword">super</span>.handleMessage(msg);
        }
    };</code></pre>
    <p>
     登陆成功后就可以拿到该签名了。之后开始向腾讯服务验证
    </p>
    <pre class="prettyprint"><code class="hljs avrasm">  private void startTencentContext() {
        //发起音视频前需要向腾讯服务器验证。
        String u=username<span class="hljs-preprocessor">.getText</span>()<span class="hljs-preprocessor">.toString</span>()<span class="hljs-comment">;</span>
        String p=password<span class="hljs-preprocessor">.getText</span>()<span class="hljs-preprocessor">.toString</span>()<span class="hljs-comment">;</span>
        if (TextUtils<span class="hljs-preprocessor">.isEmpty</span>(u)||TextUtils<span class="hljs-preprocessor">.isEmpty</span>(p)){
            Toast<span class="hljs-preprocessor">.makeText</span>(getApplicationContext(),<span class="hljs-string">"账号或密码不能为空！"</span>,Toast<span class="hljs-preprocessor">.LENGTH</span>_LONG)<span class="hljs-preprocessor">.show</span>()<span class="hljs-comment">;</span>
            return <span class="hljs-comment">;</span>
        }
        if(TextUtils<span class="hljs-preprocessor">.isEmpty</span>(sign)){
            Toast<span class="hljs-preprocessor">.makeText</span>(MainActivity<span class="hljs-preprocessor">.this</span>, <span class="hljs-string">"请先登录"</span>, Toast<span class="hljs-preprocessor">.LENGTH</span>_SHORT)<span class="hljs-preprocessor">.show</span>()<span class="hljs-comment">;</span>
            return <span class="hljs-comment">;</span>
        }
        if (!mQavsdkControl<span class="hljs-preprocessor">.hasAVContext</span>()) {
            if (!mQavsdkControl<span class="hljs-preprocessor">.isDefaultAppid</span>()) {
                Toast<span class="hljs-preprocessor">.makeText</span>(getApplicationContext(), getString(R<span class="hljs-preprocessor">.string</span><span class="hljs-preprocessor">.help</span>_msg_appid_not_default), Toast<span class="hljs-preprocessor">.LENGTH</span>_LONG)<span class="hljs-preprocessor">.show</span>()<span class="hljs-comment">;</span>
            }
            if (!mQavsdkControl<span class="hljs-preprocessor">.isDefaultUid</span>()) {
                Toast<span class="hljs-preprocessor">.makeText</span>(getApplicationContext(), getString(R<span class="hljs-preprocessor">.string</span><span class="hljs-preprocessor">.help</span>_msg_uid_not_default), Toast<span class="hljs-preprocessor">.LENGTH</span>_LONG)<span class="hljs-preprocessor">.show</span>()<span class="hljs-comment">;</span>
            }
            mLoginErrorCode = mQavsdkControl<span class="hljs-preprocessor">.startContext</span>(u, sign)<span class="hljs-comment">;</span>

            if (mLoginErrorCode != AVConstants<span class="hljs-preprocessor">.AV</span>_ERROR_OK) {
                Toast<span class="hljs-preprocessor">.makeText</span>(getApplicationContext(),<span class="hljs-string">"错误码:"</span>+mLoginErrorCode, Toast<span class="hljs-preprocessor">.LENGTH</span>_LONG)<span class="hljs-preprocessor">.show</span>()<span class="hljs-comment">;</span>
            }
        }
    }
</code></pre>
    <p>
     验证的结果是广播异步返回的，因此我们需要注册一个广播接收器，接收这个消息
    </p>
    <pre class="prettyprint"><code class="hljs avrasm">private void initStartContextBroadcast() {
        IntentFilter intentFilter = new IntentFilter()<span class="hljs-comment">;</span>
        intentFilter<span class="hljs-preprocessor">.addAction</span>(Util<span class="hljs-preprocessor">.ACTION</span>_START_CONTEXT_COMPLETE)<span class="hljs-comment">;</span>
        intentFilter<span class="hljs-preprocessor">.addAction</span>(Util<span class="hljs-preprocessor">.ACTION</span>_CLOSE_CONTEXT_COMPLETE)<span class="hljs-comment">;</span>
        registerReceiver(mStartContextBroadcastReceiver, intentFilter)<span class="hljs-comment">;</span>
}
private BroadcastReceiver mStartContextBroadcastReceiver = new BroadcastReceiver() {
        @Override
        public void onReceive(Context context, Intent intent) {
            String action = intent<span class="hljs-preprocessor">.getAction</span>()<span class="hljs-comment">;</span>
            Log<span class="hljs-preprocessor">.e</span>(<span class="hljs-string">"TAG"</span>, <span class="hljs-string">"WL_DEBUG onReceive action = "</span> + action)<span class="hljs-comment">;</span>
            Log<span class="hljs-preprocessor">.e</span>(<span class="hljs-string">"TAG"</span>, <span class="hljs-string">"WL_DEBUG ANR StartContextActivity onReceive action = "</span> + action + <span class="hljs-string">" In"</span>)<span class="hljs-comment">;</span>
            if (action<span class="hljs-preprocessor">.equals</span>(Util<span class="hljs-preprocessor">.ACTION</span>_START_CONTEXT_COMPLETE)) {
                mLoginErrorCode = intent<span class="hljs-preprocessor">.getIntExtra</span>( Util<span class="hljs-preprocessor">.EXTRA</span>_AV_ERROR_RESULT, AVConstants<span class="hljs-preprocessor">.AV</span>_ERROR_OK)<span class="hljs-comment">;</span>
                if (mLoginErrorCode == AVConstants<span class="hljs-preprocessor">.AV</span>_ERROR_OK) {
                    Intent i=new Intent(MainActivity<span class="hljs-preprocessor">.this</span>,CallActivity<span class="hljs-preprocessor">.class</span>)<span class="hljs-comment">;</span>
                    Bundle bundle=new Bundle()<span class="hljs-comment">;</span>
                    bundle<span class="hljs-preprocessor">.putString</span>(<span class="hljs-string">"from"</span>,username<span class="hljs-preprocessor">.getText</span>()<span class="hljs-preprocessor">.toString</span>())<span class="hljs-comment">;</span>
                    i<span class="hljs-preprocessor">.putExtras</span>(bundle)<span class="hljs-comment">;</span>
                    startActivity(i)<span class="hljs-comment">;</span>
                } else {
                    Toast<span class="hljs-preprocessor">.makeText</span>(getApplicationContext(), getString(R<span class="hljs-preprocessor">.string</span><span class="hljs-preprocessor">.help</span>_msg_login_error), Toast<span class="hljs-preprocessor">.LENGTH</span>_LONG)<span class="hljs-preprocessor">.show</span>()<span class="hljs-comment">;</span>

                }
            } else if (action<span class="hljs-preprocessor">.equals</span>(Util<span class="hljs-preprocessor">.ACTION</span>_CLOSE_CONTEXT_COMPLETE)) {

            }
            Log<span class="hljs-preprocessor">.e</span>(<span class="hljs-string">"TAG"</span>, <span class="hljs-string">"WL_DEBUG ANR StartContextActivity onReceive action = "</span> + action + <span class="hljs-string">" Out"</span>)<span class="hljs-comment">;</span>
        }
    }<span class="hljs-comment">;</span></code></pre>
    <p>
     之后我们就跳到了另外一个Activity当中，这个Activity中用来处理发起视频通话，处理通话失败等特殊情况的逻辑了，基本上直接从原Demo中复制代码修改即可，直接看代码
    </p>
    <pre class="prettyprint"><code class="hljs avrasm">
public class CallActivity extends AppCompatActivity implements View<span class="hljs-preprocessor">.OnClickListener</span>{
    private String from<span class="hljs-comment">;</span>
    private EditText to<span class="hljs-comment">;</span>
    private Button video,voice<span class="hljs-comment">;</span>

    private QavsdkControl mQavsdkControl<span class="hljs-comment">;</span>

    private int mCreateRoomErrorCode = AVConstants<span class="hljs-preprocessor">.AV</span>_ERROR_OK<span class="hljs-comment">;</span>
    private int mCloseRoomErrorCode = AVConstants<span class="hljs-preprocessor">.AV</span>_ERROR_OK<span class="hljs-comment">;</span>
    private int mAcceptErrorCode = AVConstants<span class="hljs-preprocessor">.AV</span>_ERROR_OK<span class="hljs-comment">;</span>
    private int mInviteErrorCode = AVConstants<span class="hljs-preprocessor">.AV</span>_ERROR_OK<span class="hljs-comment">;</span>
    private int mRefuseErrorCode = AVConstants<span class="hljs-preprocessor">.AV</span>_ERROR_OK<span class="hljs-comment">;</span>
    private int mJoinRoomErrorCode = AVConstants<span class="hljs-preprocessor">.AV</span>_ERROR_OK<span class="hljs-comment">;</span>


    private String mReceiveIdentifier = <span class="hljs-string">""</span><span class="hljs-comment">;</span>
    private String mSelfIdentifier = <span class="hljs-string">""</span><span class="hljs-comment">;</span>
    private boolean mIsVideo = false<span class="hljs-comment">;</span>
    private boolean isSender = false<span class="hljs-comment">;</span>
    private boolean isReceiver = false<span class="hljs-comment">;</span>
    private BroadcastReceiver mBroadcastReceiver = new BroadcastReceiver() {

        @Override
        public void onReceive(Context context, Intent intent) {
            String action = intent<span class="hljs-preprocessor">.getAction</span>()<span class="hljs-comment">;</span>
            Log<span class="hljs-preprocessor">.e</span>(<span class="hljs-string">"TAG"</span>, <span class="hljs-string">"WL_DEBUG onReceive action = "</span> + action)<span class="hljs-comment">;</span>
            Log<span class="hljs-preprocessor">.e</span>(<span class="hljs-string">"TAG"</span>, <span class="hljs-string">"WL_DEBUG ANR CreateRoomActivity onReceive action = "</span> + action + <span class="hljs-string">" In"</span>)<span class="hljs-comment">;</span>
            if (action<span class="hljs-preprocessor">.equals</span>(Util<span class="hljs-preprocessor">.ACTION</span>_ACCEPT_COMPLETE)) {
                String identifier = intent<span class="hljs-preprocessor">.getStringExtra</span>(Util<span class="hljs-preprocessor">.EXTRA</span>_IDENTIFIER)<span class="hljs-comment">;</span>
                mSelfIdentifier = intent<span class="hljs-preprocessor">.getStringExtra</span>(Util<span class="hljs-preprocessor">.EXTRA</span>_SELF_IDENTIFIER)<span class="hljs-comment">;</span>
                mReceiveIdentifier = identifier<span class="hljs-comment">;</span>
                long roomId = intent<span class="hljs-preprocessor">.getLongExtra</span>(Util<span class="hljs-preprocessor">.EXTRA</span>_ROOM_ID, -<span class="hljs-number">1</span>)<span class="hljs-comment">;</span>
                mAcceptErrorCode = intent<span class="hljs-preprocessor">.getIntExtra</span>(
                        Util<span class="hljs-preprocessor">.EXTRA</span>_AV_ERROR_RESULT, AVConstants<span class="hljs-preprocessor">.AV</span>_ERROR_OK)<span class="hljs-comment">;</span>

                if (mAcceptErrorCode == AVConstants<span class="hljs-preprocessor">.AV</span>_ERROR_OK) {
                    mQavsdkControl<span class="hljs-preprocessor">.enterRoom</span>(roomId, identifier, mIsVideo)<span class="hljs-comment">;</span>
                } else {
                    Toast<span class="hljs-preprocessor">.makeText</span>(CallActivity<span class="hljs-preprocessor">.this</span>,R<span class="hljs-preprocessor">.string</span><span class="hljs-preprocessor">.accept</span>_failed,Toast<span class="hljs-preprocessor">.LENGTH</span>_SHORT)<span class="hljs-preprocessor">.show</span>()<span class="hljs-comment">;</span>
                }
            } else if (action<span class="hljs-preprocessor">.equals</span>(Util<span class="hljs-preprocessor">.ACTION</span>_CLOSE_ROOM_COMPLETE)) {
            } else if (action<span class="hljs-preprocessor">.equals</span>(Util<span class="hljs-preprocessor">.ACTION</span>_INVITE_ACCEPTED)) {

                startActivity(mReceiveIdentifier,mSelfIdentifier)<span class="hljs-comment">;</span>
            } else if (action<span class="hljs-preprocessor">.equals</span>(Util<span class="hljs-preprocessor">.ACTION</span>_INVITE_CANCELED)) {
                    Toast<span class="hljs-preprocessor">.makeText</span>(getApplicationContext(), R<span class="hljs-preprocessor">.string</span><span class="hljs-preprocessor">.invite</span>_canceled_toast,
                            Toast<span class="hljs-preprocessor">.LENGTH</span>_LONG)<span class="hljs-preprocessor">.show</span>()<span class="hljs-comment">;</span>
            } else if (action<span class="hljs-preprocessor">.equals</span>(Util<span class="hljs-preprocessor">.ACTION</span>_INVITE_COMPLETE)) {
                if (isReceiver) {
                    Toast<span class="hljs-preprocessor">.makeText</span>(getApplicationContext(), R<span class="hljs-preprocessor">.string</span><span class="hljs-preprocessor">.notify</span>_conflict,
                            Toast<span class="hljs-preprocessor">.LENGTH</span>_LONG)<span class="hljs-preprocessor">.show</span>()<span class="hljs-comment">;</span>
                }

                mInviteErrorCode = intent<span class="hljs-preprocessor">.getIntExtra</span>(
                        Util<span class="hljs-preprocessor">.EXTRA</span>_AV_ERROR_RESULT, AVConstants<span class="hljs-preprocessor">.AV</span>_ERROR_OK)<span class="hljs-comment">;</span>

                if (mInviteErrorCode == AVConstants<span class="hljs-preprocessor">.AV</span>_ERROR_OK) {
                    //等待对方接受邀请
                    Toast<span class="hljs-preprocessor">.makeText</span>(getApplicationContext(), R<span class="hljs-preprocessor">.string</span><span class="hljs-preprocessor">.dialog</span>_waitting_title,
                            Toast<span class="hljs-preprocessor">.LENGTH</span>_LONG)<span class="hljs-preprocessor">.show</span>()<span class="hljs-comment">;</span>

                } else {
                    //邀请失败
                    Toast<span class="hljs-preprocessor">.makeText</span>(getApplicationContext(), R<span class="hljs-preprocessor">.string</span><span class="hljs-preprocessor">.invite</span>_failed,
                            Toast<span class="hljs-preprocessor">.LENGTH</span>_LONG)<span class="hljs-preprocessor">.show</span>()<span class="hljs-comment">;</span>
                    closeRoom()<span class="hljs-comment">;</span>
                }

            } else if (action<span class="hljs-preprocessor">.equals</span>(Util<span class="hljs-preprocessor">.ACTION</span>_INVITE_REFUSED)) {
                    Toast<span class="hljs-preprocessor">.makeText</span>(getApplicationContext(), R<span class="hljs-preprocessor">.string</span><span class="hljs-preprocessor">.invite</span>_refused_toast,
                            Toast<span class="hljs-preprocessor">.LENGTH</span>_LONG)<span class="hljs-preprocessor">.show</span>()<span class="hljs-comment">;</span>
            } else if (action<span class="hljs-preprocessor">.equals</span>(Util<span class="hljs-preprocessor">.ACTION</span>_RECV_INVITE)) {
                if (isSender) {
                    Toast<span class="hljs-preprocessor">.makeText</span>(getApplicationContext(), R<span class="hljs-preprocessor">.string</span><span class="hljs-preprocessor">.notify</span>_conflict,
                            Toast<span class="hljs-preprocessor">.LENGTH</span>_LONG)<span class="hljs-preprocessor">.show</span>()<span class="hljs-comment">;</span>
                }

                isReceiver = true<span class="hljs-comment">;</span>
                mIsVideo = intent<span class="hljs-preprocessor">.getBooleanExtra</span>(Util<span class="hljs-preprocessor">.EXTRA</span>_IS_VIDEO, false)<span class="hljs-comment">;</span>
                new AlertDialog<span class="hljs-preprocessor">.Builder</span>(CallActivity<span class="hljs-preprocessor">.this</span>)
                        <span class="hljs-preprocessor">.setTitle</span>(R<span class="hljs-preprocessor">.string</span><span class="hljs-preprocessor">.invite</span>_title)
                        <span class="hljs-preprocessor">.setPositiveButton</span>(android<span class="hljs-preprocessor">.R</span><span class="hljs-preprocessor">.string</span><span class="hljs-preprocessor">.ok</span>,
                                new DialogInterface<span class="hljs-preprocessor">.OnClickListener</span>() {
                                    public void onClick(DialogInterface dialog,
                                                        int whichButton) {
                                        mQavsdkControl<span class="hljs-preprocessor">.accept</span>()<span class="hljs-comment">;</span>
                                    }
                                })
                        <span class="hljs-preprocessor">.setNegativeButton</span>(android<span class="hljs-preprocessor">.R</span><span class="hljs-preprocessor">.string</span><span class="hljs-preprocessor">.cancel</span>,
                                new DialogInterface<span class="hljs-preprocessor">.OnClickListener</span>() {
                                    public void onClick(DialogInterface dialog,
                                                        int whichButton) {
                                        mQavsdkControl<span class="hljs-preprocessor">.refuse</span>()<span class="hljs-comment">;</span>
                                        isSender = isReceiver = false<span class="hljs-comment">;</span>
                                    }
                                })
                        <span class="hljs-preprocessor">.setOnCancelListener</span>(
                                new DialogInterface<span class="hljs-preprocessor">.OnCancelListener</span>() {
                                    @Override
                                    public void onCancel(DialogInterface dialog) {
                                        Log<span class="hljs-preprocessor">.e</span>(<span class="hljs-string">"TAG"</span>, <span class="hljs-string">"WL_DEBUG onCancel"</span>)<span class="hljs-comment">;</span>
                                        mQavsdkControl<span class="hljs-preprocessor">.refuse</span>()<span class="hljs-comment">;</span>
                                        isSender = isReceiver = false<span class="hljs-comment">;</span>
                                    }
                                })<span class="hljs-preprocessor">.create</span>()<span class="hljs-preprocessor">.show</span>()<span class="hljs-comment">;</span>




            } else if (action<span class="hljs-preprocessor">.equals</span>(Util<span class="hljs-preprocessor">.ACTION</span>_REFUSE_COMPLETE)) {
                mRefuseErrorCode = intent<span class="hljs-preprocessor">.getIntExtra</span>(
                        Util<span class="hljs-preprocessor">.EXTRA</span>_AV_ERROR_RESULT, AVConstants<span class="hljs-preprocessor">.AV</span>_ERROR_OK)<span class="hljs-comment">;</span>

                if (mRefuseErrorCode != AVConstants<span class="hljs-preprocessor">.AV</span>_ERROR_OK) {
                    Toast<span class="hljs-preprocessor">.makeText</span>(getApplicationContext(), R<span class="hljs-preprocessor">.string</span><span class="hljs-preprocessor">.refuse</span>_failed,
                            Toast<span class="hljs-preprocessor">.LENGTH</span>_LONG)<span class="hljs-preprocessor">.show</span>()<span class="hljs-comment">;</span>
                }

            } else if (action<span class="hljs-preprocessor">.equals</span>(Util<span class="hljs-preprocessor">.ACTION</span>_ROOM_CREATE_COMPLETE)) {
                mCreateRoomErrorCode = intent<span class="hljs-preprocessor">.getIntExtra</span>(
                        Util<span class="hljs-preprocessor">.EXTRA</span>_AV_ERROR_RESULT, AVConstants<span class="hljs-preprocessor">.AV</span>_ERROR_OK)<span class="hljs-comment">;</span>
                if (mCreateRoomErrorCode != AVConstants<span class="hljs-preprocessor">.AV</span>_ERROR_OK) {
                    Toast<span class="hljs-preprocessor">.makeText</span>(getApplicationContext(), R<span class="hljs-preprocessor">.string</span><span class="hljs-preprocessor">.create</span>_room_failed,
                            Toast<span class="hljs-preprocessor">.LENGTH</span>_LONG)<span class="hljs-preprocessor">.show</span>()<span class="hljs-comment">;</span>
                }
            } else if (action<span class="hljs-preprocessor">.equals</span>(Util<span class="hljs-preprocessor">.ACTION</span>_ROOM_JOIN_COMPLETE)) {
                mJoinRoomErrorCode = intent<span class="hljs-preprocessor">.getIntExtra</span>(
                        Util<span class="hljs-preprocessor">.EXTRA</span>_AV_ERROR_RESULT, AVConstants<span class="hljs-preprocessor">.AV</span>_ERROR_OK)<span class="hljs-comment">;</span>
                if (mJoinRoomErrorCode != AVConstants<span class="hljs-preprocessor">.AV</span>_ERROR_OK) {
                    Toast<span class="hljs-preprocessor">.makeText</span>(getApplicationContext(), R<span class="hljs-preprocessor">.string</span><span class="hljs-preprocessor">.join</span>_room_failed,
                            Toast<span class="hljs-preprocessor">.LENGTH</span>_LONG)<span class="hljs-preprocessor">.show</span>()<span class="hljs-comment">;</span>
                } else {
                    startActivity(mReceiveIdentifier,mSelfIdentifier)<span class="hljs-comment">;</span>
                }
            }
            Log<span class="hljs-preprocessor">.e</span>(<span class="hljs-string">"TAG"</span>, <span class="hljs-string">"WL_DEBUG ANR CreateRoomActivity onReceive action = "</span> + action + <span class="hljs-string">" Out"</span>)<span class="hljs-comment">;</span>
        }
    }<span class="hljs-comment">;</span>

    private void closeRoom() {
        mCloseRoomErrorCode = mQavsdkControl<span class="hljs-preprocessor">.exitRoom</span>()<span class="hljs-comment">;</span>
        if (mCloseRoomErrorCode != AVConstants<span class="hljs-preprocessor">.AV</span>_ERROR_OK) {
            Toast<span class="hljs-preprocessor">.makeText</span>(CallActivity<span class="hljs-preprocessor">.this</span>,R<span class="hljs-preprocessor">.string</span><span class="hljs-preprocessor">.close</span>_room_failed,Toast<span class="hljs-preprocessor">.LENGTH</span>_SHORT)<span class="hljs-preprocessor">.show</span>()<span class="hljs-comment">;</span>
        }
    }
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super<span class="hljs-preprocessor">.onCreate</span>(savedInstanceState)<span class="hljs-comment">;</span>
        setContentView(R<span class="hljs-preprocessor">.layout</span><span class="hljs-preprocessor">.activity</span>_call)<span class="hljs-comment">;</span>
        initIntent()<span class="hljs-comment">;</span>
        initView()<span class="hljs-comment">;</span>
        initInviteBroadcast()<span class="hljs-comment">;</span>
        mQavsdkControl = ((App) getApplication())<span class="hljs-preprocessor">.getQavsdkControl</span>()<span class="hljs-comment">;</span>
    }

    private void initIntent() {
        Intent intent=getIntent()<span class="hljs-comment">;</span>
        Bundle bundle=intent<span class="hljs-preprocessor">.getExtras</span>()<span class="hljs-comment">;</span>
        from=bundle<span class="hljs-preprocessor">.getString</span>(<span class="hljs-string">"from"</span>)<span class="hljs-comment">;</span>
        Log<span class="hljs-preprocessor">.e</span>(<span class="hljs-string">"TAG"</span>,<span class="hljs-string">"from:"</span>+from)<span class="hljs-comment">;</span>
    }

    private void initInviteBroadcast() {
        IntentFilter intentFilter = new IntentFilter()<span class="hljs-comment">;</span>
        intentFilter<span class="hljs-preprocessor">.addAction</span>(Util<span class="hljs-preprocessor">.ACTION</span>_ACCEPT_COMPLETE)<span class="hljs-comment">;</span>
        intentFilter<span class="hljs-preprocessor">.addAction</span>(Util<span class="hljs-preprocessor">.ACTION</span>_CLOSE_ROOM_COMPLETE)<span class="hljs-comment">;</span>
        intentFilter<span class="hljs-preprocessor">.addAction</span>(Util<span class="hljs-preprocessor">.ACTION</span>_INVITE_ACCEPTED)<span class="hljs-comment">;</span>
        intentFilter<span class="hljs-preprocessor">.addAction</span>(Util<span class="hljs-preprocessor">.ACTION</span>_INVITE_CANCELED)<span class="hljs-comment">;</span>
        intentFilter<span class="hljs-preprocessor">.addAction</span>(Util<span class="hljs-preprocessor">.ACTION</span>_INVITE_COMPLETE)<span class="hljs-comment">;</span>
        intentFilter<span class="hljs-preprocessor">.addAction</span>(Util<span class="hljs-preprocessor">.ACTION</span>_INVITE_REFUSED)<span class="hljs-comment">;</span>
        intentFilter<span class="hljs-preprocessor">.addAction</span>(Util<span class="hljs-preprocessor">.ACTION</span>_RECV_INVITE)<span class="hljs-comment">;</span>
        intentFilter<span class="hljs-preprocessor">.addAction</span>(Util<span class="hljs-preprocessor">.ACTION</span>_REFUSE_COMPLETE)<span class="hljs-comment">;</span>
        intentFilter<span class="hljs-preprocessor">.addAction</span>(Util<span class="hljs-preprocessor">.ACTION</span>_ROOM_CREATE_COMPLETE)<span class="hljs-comment">;</span>
        intentFilter<span class="hljs-preprocessor">.addAction</span>(Util<span class="hljs-preprocessor">.ACTION</span>_ROOM_JOIN_COMPLETE)<span class="hljs-comment">;</span>
        registerReceiver(mBroadcastReceiver, intentFilter)<span class="hljs-comment">;</span>
    }



    private void initView() {
        to= (EditText) findViewById(R<span class="hljs-preprocessor">.id</span><span class="hljs-preprocessor">.to</span>)<span class="hljs-comment">;</span>
        video= (Button) findViewById(R<span class="hljs-preprocessor">.id</span><span class="hljs-preprocessor">.video</span>)<span class="hljs-comment">;</span>
        voice= (Button) findViewById(R<span class="hljs-preprocessor">.id</span><span class="hljs-preprocessor">.voice</span>)<span class="hljs-comment">;</span>
        video<span class="hljs-preprocessor">.setOnClickListener</span>(this)<span class="hljs-comment">;</span>
        voice<span class="hljs-preprocessor">.setOnClickListener</span>(this)<span class="hljs-comment">;</span>
    }

    @Override
    public void onClick(View v) {
        switch (v<span class="hljs-preprocessor">.getId</span>()){
            case R<span class="hljs-preprocessor">.id</span><span class="hljs-preprocessor">.voice</span>:
                voice()<span class="hljs-comment">;</span>
                <span class="hljs-keyword">break</span><span class="hljs-comment">;</span>
            case R<span class="hljs-preprocessor">.id</span><span class="hljs-preprocessor">.video</span>:
                video()<span class="hljs-comment">;</span>
                <span class="hljs-keyword">break</span><span class="hljs-comment">;</span>
            default:
                <span class="hljs-keyword">break</span><span class="hljs-comment">;</span>
        }
    }






    private void voice() {
        mSelfIdentifier=from<span class="hljs-comment">;</span>
        mReceiveIdentifier=to<span class="hljs-preprocessor">.getText</span>()<span class="hljs-preprocessor">.toString</span>()<span class="hljs-comment">;</span>
        mIsVideo=false<span class="hljs-comment">;</span>
        if (Util<span class="hljs-preprocessor">.isNetworkAvailable</span>(getApplicationContext())) {
            if (TextUtils<span class="hljs-preprocessor">.isEmpty</span>(mSelfIdentifier)) {
                Toast<span class="hljs-preprocessor">.makeText</span>(getApplicationContext(), getString(R<span class="hljs-preprocessor">.string</span><span class="hljs-preprocessor">.help</span>_msg_send_account_error), Toast<span class="hljs-preprocessor">.LENGTH</span>_SHORT)<span class="hljs-preprocessor">.show</span>()<span class="hljs-comment">;</span>
            } else if (TextUtils<span class="hljs-preprocessor">.isEmpty</span>(mReceiveIdentifier)) {
                Toast<span class="hljs-preprocessor">.makeText</span>(getApplicationContext(), getString(R<span class="hljs-preprocessor">.string</span><span class="hljs-preprocessor">.help</span>_msg_recv_account_error), Toast<span class="hljs-preprocessor">.LENGTH</span>_SHORT)<span class="hljs-preprocessor">.show</span>()<span class="hljs-comment">;</span>
            } else {
                if (mSelfIdentifier<span class="hljs-preprocessor">.equals</span>(mReceiveIdentifier)) {
                    Toast<span class="hljs-preprocessor">.makeText</span>(getApplicationContext(), getString(R<span class="hljs-preprocessor">.string</span><span class="hljs-preprocessor">.help</span>_msg_account_send_equal_recv), Toast<span class="hljs-preprocessor">.LENGTH</span>_SHORT)<span class="hljs-preprocessor">.show</span>()<span class="hljs-comment">;</span>
                } else {
                    invite(mIsVideo)<span class="hljs-comment">;</span>
                    isSender = true<span class="hljs-comment">;</span>
                }
            }
        } else {
            Toast<span class="hljs-preprocessor">.makeText</span>(getApplicationContext(), getString(R<span class="hljs-preprocessor">.string</span><span class="hljs-preprocessor">.notify</span>_no_network), Toast<span class="hljs-preprocessor">.LENGTH</span>_SHORT)<span class="hljs-preprocessor">.show</span>()<span class="hljs-comment">;</span>
        }

    }

    private void video() {
        mSelfIdentifier=from<span class="hljs-comment">;</span>
        mReceiveIdentifier=to<span class="hljs-preprocessor">.getText</span>()<span class="hljs-preprocessor">.toString</span>()<span class="hljs-comment">;</span>
        mIsVideo=true<span class="hljs-comment">;</span>
        if (Util<span class="hljs-preprocessor">.isNetworkAvailable</span>(getApplicationContext())) {
            if (TextUtils<span class="hljs-preprocessor">.isEmpty</span>(mSelfIdentifier)) {
                Toast<span class="hljs-preprocessor">.makeText</span>(getApplicationContext(), getString(R<span class="hljs-preprocessor">.string</span><span class="hljs-preprocessor">.help</span>_msg_send_account_error), Toast<span class="hljs-preprocessor">.LENGTH</span>_SHORT)<span class="hljs-preprocessor">.show</span>()<span class="hljs-comment">;</span>
            } else if (TextUtils<span class="hljs-preprocessor">.isEmpty</span>(mReceiveIdentifier)) {
                Toast<span class="hljs-preprocessor">.makeText</span>(getApplicationContext(), getString(R<span class="hljs-preprocessor">.string</span><span class="hljs-preprocessor">.help</span>_msg_recv_account_error), Toast<span class="hljs-preprocessor">.LENGTH</span>_SHORT)<span class="hljs-preprocessor">.show</span>()<span class="hljs-comment">;</span>
            } else {
                if (mSelfIdentifier<span class="hljs-preprocessor">.equals</span>(mReceiveIdentifier)) {
                    Toast<span class="hljs-preprocessor">.makeText</span>(getApplicationContext(), getString(R<span class="hljs-preprocessor">.string</span><span class="hljs-preprocessor">.help</span>_msg_account_send_equal_recv), Toast<span class="hljs-preprocessor">.LENGTH</span>_SHORT)<span class="hljs-preprocessor">.show</span>()<span class="hljs-comment">;</span>
                } else {
                    invite(mIsVideo)<span class="hljs-comment">;</span>
                    isSender = true<span class="hljs-comment">;</span>
                }
            }
        } else {
            Toast<span class="hljs-preprocessor">.makeText</span>(getApplicationContext(), getString(R<span class="hljs-preprocessor">.string</span><span class="hljs-preprocessor">.notify</span>_no_network), Toast<span class="hljs-preprocessor">.LENGTH</span>_SHORT)<span class="hljs-preprocessor">.show</span>()<span class="hljs-comment">;</span>
        }

    }



    private void startActivity(String mReceiveIdentifier,String mSelfIdentifier) {
        Log<span class="hljs-preprocessor">.e</span>(<span class="hljs-string">"TAG"</span>, <span class="hljs-string">"WL_DEBUG startActivity"</span>)<span class="hljs-comment">;</span>
        if ((mQavsdkControl != null) &amp;&amp; (mQavsdkControl<span class="hljs-preprocessor">.getAVContext</span>() != null) &amp;&amp; (mQavsdkControl<span class="hljs-preprocessor">.getAVContext</span>()<span class="hljs-preprocessor">.getAudioCtrl</span>() != null)) {
            mQavsdkControl<span class="hljs-preprocessor">.getAVContext</span>()<span class="hljs-preprocessor">.getAudioCtrl</span>()<span class="hljs-preprocessor">.startTRAEService</span>()<span class="hljs-comment">;</span>
        }
        startActivityForResult(
                new Intent(Intent<span class="hljs-preprocessor">.ACTION</span>_MAIN)
                        <span class="hljs-preprocessor">.putExtra</span>(Util<span class="hljs-preprocessor">.EXTRA</span>_IDENTIFIER, mReceiveIdentifier)
                        <span class="hljs-preprocessor">.putExtra</span>(Util<span class="hljs-preprocessor">.EXTRA</span>_SELF_IDENTIFIER, mSelfIdentifier)
                        <span class="hljs-preprocessor">.setClass</span>(this, AvActivity<span class="hljs-preprocessor">.class</span>),
                <span class="hljs-number">0</span>)<span class="hljs-comment">;</span>
    }

    @Override
    protected void onDestroy() {
        super<span class="hljs-preprocessor">.onDestroy</span>()<span class="hljs-comment">;</span>

        if (mBroadcastReceiver != null) {
            unregisterReceiver(mBroadcastReceiver)<span class="hljs-comment">;</span>
        }
    }
    @Override
    protected void onActivityResult(int requestCode, int resultCode, Intent data) {
        Log<span class="hljs-preprocessor">.e</span>(<span class="hljs-string">"TAG"</span>, <span class="hljs-string">"WL_DEBUG onActivityResult"</span>)<span class="hljs-comment">;</span>
        isSender = isReceiver = false<span class="hljs-comment">;</span>
        if ((mQavsdkControl != null) &amp;&amp; (mQavsdkControl<span class="hljs-preprocessor">.getAVContext</span>() != null) &amp;&amp; (mQavsdkControl<span class="hljs-preprocessor">.getAVContext</span>()<span class="hljs-preprocessor">.getAudioCtrl</span>() != null)) {
            mQavsdkControl<span class="hljs-preprocessor">.getAVContext</span>()<span class="hljs-preprocessor">.getAudioCtrl</span>()<span class="hljs-preprocessor">.stopTRAEService</span>()<span class="hljs-comment">;</span>
        }
        closeRoom()<span class="hljs-comment">;</span>
    }


    private void invite(boolean isVideo) {
        if (TextUtils<span class="hljs-preprocessor">.isEmpty</span>(mReceiveIdentifier))
            return<span class="hljs-comment">;</span>
        mQavsdkControl<span class="hljs-preprocessor">.invite</span>(mReceiveIdentifier, isVideo)<span class="hljs-comment">;</span>

    }

}
</code></pre>
    <p>
     这样就差不多可以跑一个试试了。
    </p>
    <p>
     <img alt="这里写图片描述" src="https://img-blog.csdn.net/20150928125002788" title=""/>
    </p>
    <p>
     <img alt="这里写图片描述" src="https://img-blog.csdn.net/20150928125145543" title=""/>
    </p>
    <p>
     <img alt="这里写图片描述" src="https://img-blog.csdn.net/20150928125153672" title=""/>
    </p>
    <p>
     <img alt="这里写图片描述" src="https://img-blog.csdn.net/20150928125205371" title=""/>
    </p>
    <p>
     <img alt="这里写图片描述" src="https://img-blog.csdn.net/20150928125212430" title=""/>
    </p>
    <p>
     <img alt="这里写图片描述" src="https://img-blog.csdn.net/20150928125219822" title=""/>
    </p>
    <p>
     <img alt="这里写图片描述" src="https://img-blog.csdn.net/20150928125228281" title=""/>
    </p>
    <p>
     其他细节看腾讯的文档把，多看几次就能把握个大概了。
    </p>
    <p>
     源码下载
     <br/>
     <a href="http://download.csdn.net/detail/sbsujjbcy/9139613">
      http://download.csdn.net/detail/sbsujjbcy/9139613
     </a>
    </p>
    <p>
     Github
     <br/>
     <a href="https://github.com/lizhangqu/VoiceAndVideo">
      https://github.com/lizhangqu/VoiceAndVideo
     </a>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a:2f2f626c6f672e6373646e2e6e65742f736273756a6a626379:2f61727469636c652f64657461696c732f3438373335303339" class_="artid" style="display:none">
 </p>
</div>


