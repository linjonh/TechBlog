---
layout: post
title: "Vue-系列之refreactivetoReftoRefs"
date: 2025-03-14 09:57:12 +0800
description: "Vue 系列之：ref、reactive、toRef、toRefs"
keywords: "Vue 系列之：ref、reactive、toRef、toRefs"
categories: ['Vue']
tags: ['Vue']
artid: "146239933"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146239933
    alt: "Vue-系列之refreactivetoReftoRefs"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146239933
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146239933
cover: https://bing.ee123.net/img/rand?artid=146239933
image: https://bing.ee123.net/img/rand?artid=146239933
img: https://bing.ee123.net/img/rand?artid=146239933
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Vue 系列之：ref、reactive、toRef、toRefs
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="_0">
     </a>
     前言
    </h2>
    <p>
     <code>
      setup
     </code>
     函数中默认定义的变量并不是响应式的（即数据变了以后页面不会跟着变），如果想让变量变为响应式的变量，需要使用
     <code>
      ref
     </code>
     和
     <code>
      reactive
     </code>
     函数修饰变量。
    </p>
    <h3>
     <a id="proxy_ref_reactive__2">
     </a>
     响应式对象、proxy 对象、ref 对象、reactive 对象，四者之间的关系
    </h3>
    <ul>
     <li>
      <p>
       proxy 对象、ref 对象、reactive 对象都是具体的对象，而响应式对象是一个概念。
      </p>
      <ul>
       <li>
        <p>
         Proxy 对象是实现响应式对象的一种方式（Vue2 中通过
         <code>
          Object.defineProperty
         </code>
         来实现响应式对象）。
        </p>
       </li>
       <li>
        <p>
         ref 对象、reactive 对象都是响应式对象的一种。
        </p>
       </li>
      </ul>
     </li>
     <li>
      <p>
       Proxy 对象是 ES6 中引入的一个新特性，用于创建一个对象的代理，从而可以拦截并自定义对象的基本操作。Proxy 对象可以看作是在目标对象之前架设的一层“拦截”，外界对该对象的访问都必须先通过这层拦截。
      </p>
     </li>
     <li>
      <p>
       ref 创建的对象本身并不是一个 Proxy 对象，它实际上返回的是一个
       <code>
        RefImpl
       </code>
       类型的对象，是一个包含
       <code>
        .value
       </code>
       属性的响应式对象。
      </p>
     </li>
     <li>
      <p>
       在 Vue3 的响应式系统中，当使用 reactive 函数时，它实际上会返回一个 Proxy 对象。也是就说 reactive 对象其实就是 Proxy 对象。但在 Vue3 的 API 层面，我们通常将其称为“响应式对象”或“reactive 对象”，以强调其响应式特性。
      </p>
     </li>
    </ul>
    <h2>
     <a id="ref_14">
     </a>
     ref
    </h2>
    <p>
     <code>
      ref
     </code>
     函数是 Vue 的响应式 API 之一，用于创建一个响应式的引用对象。它会返回一个响应式的对象，该对象包含一个
     <code>
      value
     </code>
     属性，用于存储和访问实际的值。
    </p>
    <pre><code class="prism language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>box<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    {<!-- -->{ proxy }}
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">setup</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> ref <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> proxy <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token string">'测试'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"test:"</span><span class="token punctuation">,</span> proxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">scoped</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
<span class="token selector">.box</span> <span class="token punctuation">{<!-- --></span>
  <span class="token property">padding</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/3770a0b57e2e4ceeb3147d1a84cd08cb.png"/>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/a6f24e16e9b646369837cc93d38b7ca2.png"/>
    </p>
    <p>
     我们知道
     <code>
      ref
     </code>
     可以生成基本数据类型的响应式数据，那么它可以用来生成引用类型的响应式数据吗？答案是可以的。
    </p>
    <pre><code class="prism language-js"><span class="token keyword">const</span> proxy <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'张三'</span><span class="token punctuation">,</span> <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/a53dbbd8c2ec4cb3b01a08cd6f412fae.png"/>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/aa3db3d10bae46648d9b4181c8d02bdc.png"/>
    </p>
    <p>
     区别来了：
    </p>
    <ul>
     <li>
      <p>
       当给
       <code>
        ref
       </code>
       传递一个原始类型时，它会简单地将这个值包装在一个对象中，这个对象有一个
       <code>
        value
       </code>
       属性指向原始值
      </p>
     </li>
     <li>
      <p>
       当给
       <code>
        ref
       </code>
       传递一个对象或数组这样的复杂类型时，Vue 不仅会创建一个
       <code>
        value
       </code>
       属性来存储该对象，
       <strong>
        还会用一个
        <code>
         Proxy
        </code>
        对象来包装这个对象，以实现更深层次的响应式
       </strong>
       。这就意味着当对象更深层次的属性值改变时，这些改变也会被 Vue 自动追踪。
      </p>
     </li>
    </ul>
    <pre><code class="prism language-js"><span class="token keyword">const</span> proxy <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'张三'</span><span class="token punctuation">,</span> <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token literal-property property">school</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'提瓦特小学'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">addr</span><span class="token operator">:</span> <span class="token string">'蒙德'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  proxy<span class="token punctuation">.</span>value<span class="token punctuation">.</span>school<span class="token punctuation">.</span>teacher <span class="token operator">=</span> <span class="token string">'钟离'</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"test:"</span><span class="token punctuation">,</span> proxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/8731b74f4ff1465392483e6d19e1e7cb.png"/>
    </p>
    <p>
     通过示例可以看到，给
     <code>
      ref
     </code>
     对象加了一个不存在的属性，也触发了响应式。那为什么很多文章都说
     <code>
      ref
     </code>
     是浅监听呢？它明明实现了深层次的监听呀？
    </p>
    <p>
     首先搞懂
     <code>
      ref
     </code>
     是怎么实现响应式的：
    </p>
    <h3>
     <a id="ref__76">
     </a>
     ref 的基本实现
    </h3>
    <p>
     <strong>
      对于基本数据类型
     </strong>
     ，
     <code>
      ref
     </code>
     是通过创建一个包含
     <code>
      value
     </code>
     属性的对象来实现响应式的。具体来说，
     <code>
      ref
     </code>
     会创建一个带有 getter 和 setter 的对象，这样当
     <code>
      value
     </code>
     被读取或修改时，Vue3 的响应式系统可以检测到这些变化并触发相应的更新。
    </p>
    <pre><code class="prism language-js"><span class="token keyword">function</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> refObject <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">__v_isRef</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token keyword">get</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">track</span><span class="token punctuation">(</span>refObject<span class="token punctuation">,</span> <span class="token string">'get'</span><span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 跟踪读取操作</span>
      <span class="token keyword">return</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">set</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token parameter">newValue</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>newValue <span class="token operator">!==</span> value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        value <span class="token operator">=</span> newValue<span class="token punctuation">;</span>
        <span class="token function">trigger</span><span class="token punctuation">(</span>refObject<span class="token punctuation">,</span> <span class="token string">'set'</span><span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 触发更新操作</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> refObject<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <ul>
     <li>
      <p>
       <strong>
        <code>
         __v_isRef
        </code>
       </strong>
       ：这是一个标志属性，用于标识这个对象是一个
       <code>
        ref
       </code>
       对象。
      </p>
     </li>
     <li>
      <p>
       <strong>
        <code>
         get value()
        </code>
       </strong>
       ：这是一个 getter 方法，当访问
       <code>
        refObject.value
       </code>
       时会调用这个方法。在 getter 中，会调用
       <code>
        track
       </code>
       函数来跟踪读取操作。
      </p>
     </li>
     <li>
      <p>
       <strong>
        <code>
         set value(newValue)
        </code>
       </strong>
       ：这是一个 setter 方法，当修改
       <code>
        refObject.value
       </code>
       时会调用这个方法。在 setter 中，会检查新值和旧值是否不同，如果不同，则更新值并调用
       <code>
        trigger
       </code>
       函数来触发更新操作。
      </p>
     </li>
     <li>
      <p>
       <strong>
        <code>
         track
        </code>
        函数
       </strong>
       ：用于跟踪依赖关系。当组件读取
       <code>
        refObject.value
       </code>
       时，
       <code>
        track
       </code>
       函数会被调用，记录当前的依赖关系。这样，当
       <code>
        value
       </code>
       发生变化时，Vue 3 可以知道哪些组件需要更新。
      </p>
     </li>
     <li>
      <p>
       <strong>
        <code>
         trigger
        </code>
        函数
       </strong>
       ：用于触发更新。当
       <code>
        value
       </code>
       发生变化时，
       <code>
        trigger
       </code>
       函数会被调用，通知相关的组件进行更新。
      </p>
     </li>
    </ul>
    <p>
     <strong>
      对于引用数据类型
     </strong>
     ，ref 会使用 reactive 来创建一个响应式代理对象。reactive 函数又会使用 Proxy 来创建一个响应式代理对象。
    </p>
    <pre><code class="prism language-js"><span class="token keyword">function</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> refObject <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">__v_isRef</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token keyword">get</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">track</span><span class="token punctuation">(</span>refObject<span class="token punctuation">,</span> <span class="token string">'get'</span><span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 跟踪读取操作</span>
      <span class="token keyword">return</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">set</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token parameter">newValue</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>newValue <span class="token operator">!==</span> value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        value <span class="token operator">=</span> newValue<span class="token punctuation">;</span>
        <span class="token function">trigger</span><span class="token punctuation">(</span>refObject<span class="token punctuation">,</span> <span class="token string">'set'</span><span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 触发更新操作</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// 如果 value 是一个对象，则使用 reactive 包装</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isObject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    refObject<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> refObject<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">isObject</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> <span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> value <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     由于
     <code>
      refObject.value
     </code>
     就是一个响应式对象，所以可以深度监听其内部属性的变化。所以 “ref 是浅监听” 这句话是
     <strong>
      错
     </strong>
     的！
    </p>
    <p>
     总结：
    </p>
    <ul>
     <li>
      <p>
       对于基本数据类型，
       <code>
        ref
       </code>
       是通过创建一个包含
       <code>
        .value
       </code>
       属性的响应式对象来保证响应式的，
       <code>
        .value
       </code>
       属性的值就是原来的值
      </p>
     </li>
     <li>
      <p>
       对于引用数据类型，
       <code>
        .value
       </code>
       属性的值是通过
       <code>
        reactive
       </code>
       函数来创建的一个响应式对象。
      </p>
     </li>
    </ul>
    <h3>
     <a id="_ref__value_146">
     </a>
     为什么 ref 需要使用 .value？
    </h3>
    <p>
     为什么
     <code>
      ref
     </code>
     在设计的时候要使用
     <code>
      .value
     </code>
     ，而
     <code>
      reactive
     </code>
     就不需要使用
     <code>
      .value
     </code>
     ？都不使用
     <code>
      .value
     </code>
     不是更好吗？
    </p>
    <p>
     这是因为 Vue.js 的响应式系统是基于 Proxy 和 Reflect API 的，而这些 API 只能代理对象，不能代理原始类型。因此
     <code>
      ref
     </code>
     函数会先创建一个 ref 对象，该对象有一个
     <code>
      .value
     </code>
     属性：
    </p>
    <ul>
     <li>
      <p>
       对于基本数据类型，
       <code>
        ref
       </code>
       会将这个值直接封装在
       <code>
        value
       </code>
       属性中；
      </p>
     </li>
     <li>
      <p>
       对于引用数据类型，
       <code>
        ref
       </code>
       也会将这个对象或数组封装在
       <code>
        value
       </code>
       属性中，但 Vue 会使用
       <code>
        Proxy
       </code>
       机制（通过 reactive 函数实现）来确保这个对象或数组是响应式的。
      </p>
     </li>
    </ul>
    <h2>
     <a id="reactive_154">
     </a>
     reactive
    </h2>
    <p>
     <code>
      reactive
     </code>
     <strong>
      函数
     </strong>
     接受一个对象作为参数，并返回一个新的响应式对象。这个新对象会“代理”原始对象，使得对原始对象的属性进行读取和修改时，Vue 可以追踪这些变化并相应地更新 DOM。
    </p>
    <p>
     当你使用
     <code>
      reactive
     </code>
     创建一个响应式对象时，Vue 内部实际上是创建了一个 Proxy 对象。
    </p>
    <h3>
     <a id="_Proxy__158">
     </a>
     什么是 Proxy 对象
    </h3>
    <p>
     Proxy 是 ES6 提供的一个新特性，它允许我们创建一个对象的代理，从而可以拦截并定义该对象的基本操作（如属性查找、赋值、枚举、函数调用等）的行为。
    </p>
    <p>
     在 Vue3 中，
     <code>
      reactive
     </code>
     函数使用 Proxy 对象来包装原始对象，并拦截对该对象属性的访问和修改操作。当这些操作发生时，Proxy 可以执行一些额外的逻辑，例如依赖收集和触发更新。
    </p>
    <h3>
     <a id="_162">
     </a>
     底层实现机制
    </h3>
    <p>
     简化源码：
    </p>
    <pre><code class="prism language-js"><span class="token comment">// 1. reactive 是一个函数</span>
<span class="token keyword">function</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 1. 它返回一个 Proxy 对象</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 2. 在读取属性时（即执行 get 操作）会进行依赖收集</span>
    <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 3. 依赖收集</span>
      <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> result <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 如果结果是对象，递归使其成为响应式</span>
      <span class="token keyword">return</span> <span class="token keyword">typeof</span> result <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> result <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token function">reactive</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token operator">:</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 4. 当属性值发生变化时（即执行 set 操作）会触发更新</span>
    <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">const</span> oldValue <span class="token operator">=</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> result <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>oldValue <span class="token operator">!==</span> value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 5. 触发更新</span>
        <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 假设的 track 和 trigger 函数</span>

<span class="token comment">// 依赖收集</span>
<span class="token keyword">function</span> <span class="token function">track</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">/*
  当访问响应式对象的属性时，
  Vue会记录下当前正在执行的副作用函数（effect），
  这些函数依赖于该属性的值。这个过程称为依赖收集。
  */</span>
<span class="token punctuation">}</span>

<span class="token comment">// 触发更新</span>
<span class="token keyword">function</span> <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">/*
  当响应式对象的属性发生变化时，
  Vue会通知所有依赖该属性的副作用函数重新执行，
  从而实现视图的自动更新。这个过程称为触发更新。
  */</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     Vue3 的响应式系统通过依赖收集来追踪哪些响应式数据被哪些副作用函数（effect）所依赖。当访问响应式数据时，Vue 会记录下当前正在执行的副作用函数，并建立数据与副作用之间的依赖关系。
    </p>
    <p>
     当响应式数据发生变化时，Vue 会触发更新操作。这个更新操作会遍历依赖关系图，并逐个执行依赖的副作用函数，从而实现视图的自动更新。
    </p>
    <p>
     简单来说就是：接收对象—&gt;创建 Proxy—&gt;依赖收集—&gt;触发更新
    </p>
    <h3>
     <a id="_218">
     </a>
     原始对象与代理对象的关系
    </h3>
    <p>
     通过一个示例来了解他们之间的关系：
    </p>
    <pre><code class="prism language-js"><span class="token comment">// 原始对象</span>
<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'张三'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">18</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 处理器对象，定义拦截行为</span>
<span class="token keyword">const</span> handler <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 拦截属性读取操作</span>
  <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Getting </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>property<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> target<span class="token punctuation">[</span>property<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token comment">// 拦截属性设置操作</span>
  <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Setting </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>property<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> to </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>value<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    target<span class="token punctuation">[</span>property<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 创建代理对象</span>
<span class="token keyword">const</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>

obj<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">19</span>
<span class="token comment">// proxy.age = 20</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"obj.age:"</span><span class="token punctuation">,</span> obj<span class="token punctuation">.</span>age<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"proxy.age:"</span><span class="token punctuation">,</span> proxy<span class="token punctuation">.</span>age<span class="token punctuation">)</span>
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/d12b14a9938a4a5992b0ad2eb0bd7ddf.png"/>
    </p>
    <p>
     可以看到，当原始对象的属性值发生变化时，代理对象的属性值也发生了变化，这是因为
     <strong>
      代理对象读取的其实还是原始对象的属性值
     </strong>
     ：
     <code>
      return target[property]
     </code>
    </p>
    <pre><code class="prism language-js"><span class="token comment">// obj.age = 19</span>
proxy<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">20</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"obj.age:"</span><span class="token punctuation">,</span> obj<span class="token punctuation">.</span>age<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"proxy.age:"</span><span class="token punctuation">,</span> proxy<span class="token punctuation">.</span>age<span class="token punctuation">)</span>
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/635a2281d22a4ad79d1e8facd5fe9902.png"/>
    </p>
    <p>
     可以看到，当代理对象的属性值发生变化时，原始对象的属性值也发生了变化，这是因为
     <strong>
      改变代理对象的属性值，其实就是在改变原始对象的属性值
     </strong>
     ：
     <code>
      target[property] = value
     </code>
    </p>
    <p>
     问题来了：
    </p>
    <p>
     当响应式数据发生变化时，Vue 会触发更新操作，这很好理解， 但是当原始对象发生变化时，Vue 也会触发更新操作吗？因为上面的例子中当使用
     <code>
      obj.age = 19
     </code>
     时，并没有触发
     <code>
      set
     </code>
     方法。
    </p>
    <p>
     来看示例：
    </p>
    <pre><code class="prism language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>box<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>{<!-- -->{ obj }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>{<!-- -->{ proxy }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">setup</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> ref<span class="token punctuation">,</span> reactive<span class="token punctuation">,</span> watch <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span><span class="token punctuation">;</span>

<span class="token comment">// 原始对象</span>
<span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'张三'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">18</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> proxy <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  obj<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">19</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"obj:"</span><span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"proxy:"</span><span class="token punctuation">,</span> proxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">watch</span><span class="token punctuation">(</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">newVal<span class="token punctuation">,</span> oldVal</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"newVal:"</span><span class="token punctuation">,</span> newVal<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"oldVal:"</span><span class="token punctuation">,</span> oldVal<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">deep</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">scoped</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
<span class="token selector">.box</span> <span class="token punctuation">{<!-- --></span>
  <span class="token property">padding</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/99c13de001284ebc860051ddb68f7e11.png">
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/58a096ce3e274251aed78b73993985e6.png"/>
     </img>
    </p>
    <p>
     可以看到，当修改原始对象的属性值时，这个修改会反应到 Proxy 对象中（打印的 proxy 值发生了变化），但是 Vue 的响应式系统并没有做出更新（页面中的 age 值没有发生变化，watch 中的内容也没有执行）
    </p>
    <p>
     所以说：
     <strong>
      直接操作原始对象会触发 Vue 响应式更新这句话是错的。
     </strong>
    </p>
    <blockquote>
     <p>
      在 Vue3 中，如果响应式对象中的某个属性是一个普通对象或数组，并且你在之后将其替换为一个新的对象或数组，那么新的对象或数组将不会是响应式的。
     </p>
    </blockquote>
    <p>
     如何理解这段话？看示例：
    </p>
    <pre><code class="prism language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>box<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>proxy：{<!-- -->{ proxy.user.name }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>obj：{<!-- -->{ obj.name }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>test<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>测试<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">setup</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> ref<span class="token punctuation">,</span> reactive<span class="token punctuation">,</span> watch <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> proxy <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">user</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'张三'</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'李四'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  proxy<span class="token punctuation">.</span>user <span class="token operator">=</span> obj<span class="token punctuation">;</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    obj<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'王五'</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"proxy:"</span><span class="token punctuation">,</span> proxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"obj:"</span><span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">scoped</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
<span class="token selector">.box</span> <span class="token punctuation">{<!-- --></span>
  <span class="token property">padding</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/65d214f4fc194fbda72ac78bf4d88334.png"/>
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/95fa222cc3594862afb5eda2eab994ae.png"/>
    </p>
    <p>
     当点击按钮后，页面中显示的是"李四"而不是"王五"，但是打印的值都是"王五"，说明是视图没有更新，即新对象 obj 不是响应式的。
    </p>
    <h3>
     <a id="_362">
     </a>
     非响应式转换
    </h3>
    <p>
     将非响应式对象转换成响应式对象可以用 ref 或 reactive，那么将响应式对象转换为非响应式对象有哪些方法呢？
    </p>
    <h4>
     <a id="toRaw__364">
     </a>
     toRaw 函数
    </h4>
    <p>
     该函数的主要作用是获取一个由
     <code>
      reactive
     </code>
     或者
     <code>
      ref
     </code>
     创建的代理对象所包装的原始对象。
    </p>
    <pre><code class="prism language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>box<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>proxy：{<!-- -->{ proxy.name }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>obj：{<!-- -->{ obj.name }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>test<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>测试<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">setup</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> ref<span class="token punctuation">,</span> reactive<span class="token punctuation">,</span> toRaw <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> proxy <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">"张三"</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token function">toRaw</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  obj<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'李四'</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"proxy:"</span><span class="token punctuation">,</span> proxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"obj:"</span><span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">scoped</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
<span class="token selector">.box</span> <span class="token punctuation">{<!-- --></span>
  <span class="token property">padding</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
</code></pre>
    <p>
     <code>
      toRaw
     </code>
     返回的是原始数据的引用。因此，对
     <code>
      rawData
     </code>
     的修改会影响到原始的响应式对象。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/8262f59e6680444199c256ae680f8731.png"/>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/36fe44d2ba484429ab953915cde060fa.png"/>
    </p>
    <p>
     点击按钮后，打印值变化了，但是页面值没有变化，丢失了响应性。
    </p>
    <h4>
     <a id="_405">
     </a>
     直接解构丢失响应性
    </h4>
    <pre><code class="prism language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>box<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>proxy：{<!-- -->{ proxy.name }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>obj：{<!-- -->{ name }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>test<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>测试<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">setup</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> ref<span class="token punctuation">,</span> reactive <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> proxy <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">"张三"</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> <span class="token punctuation">{<!-- --></span> name <span class="token punctuation">}</span> <span class="token operator">=</span> proxy

<span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  name <span class="token operator">=</span> <span class="token string">'李四'</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"proxy:"</span><span class="token punctuation">,</span> proxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"name:"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/1fc3a1bd23c14e13b1df64c4449bdc54.png"/>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/a77ea54723ea49fc9d0d0c56f67b1720.png"/>
    </p>
    <p>
     点击按钮后，页面值没有变化，丢失了响应性。
    </p>
    <h4>
     <a id="Vue2__436">
     </a>
     Vue2 动态添加的新属性
    </h4>
    <p>
     在 Vue2 中，动态添加的新属性默认不是响应式的，这是因为 Vue2 的响应式系统是基于 ES5 的
     <code>
      Object.defineProperty
     </code>
     方法实现的，该方法无法拦截对象属性的添加和删除。
    </p>
    <p>
     但是 Vue3 使用了 ES6 的
     <code>
      Proxy
     </code>
     代理对象来实现响应式，动态添加的新属性默认是响应式的。
    </p>
    <h3>
     <a id="ref__reactive__440">
     </a>
     ref 与 reactive 的区别
    </h3>
    <p>
     当你通过
     <code>
      ref
     </code>
     包装一个对象时，你实际上得到的是一个包含
     <code>
      .value
     </code>
     属性的对象，这个
     <code>
      .value
     </code>
     属性指向你原始的对象。
    </p>
    <ul>
     <li>
      <p>
       对于基本数据类型，
       <code>
        .value
       </code>
       属性的值就是原来的值
      </p>
     </li>
     <li>
      <p>
       对于引用数据类型，
       <code>
        .value
       </code>
       属性的值是通过
       <code>
        reactive
       </code>
       函数来创建的一个响应式对象。
      </p>
     </li>
    </ul>
    <p>
     <code>
      reactive
     </code>
     不会包装对象在另一个对象中，而是直接使对象本身变为响应式的。
    </p>
    <h2>
     <a id="toRef_448">
     </a>
     toRef
    </h2>
    <p>
     <code>
      toRef
     </code>
     使源响应式对象的某个属性成为一个
     <code>
      ref
     </code>
     对象。它接收两个参数：源响应式对象和属性名，返回一个
     <code>
      ref
     </code>
     数据。
    </p>
    <p>
     注意点：
    </p>
    <ol>
     <li>
      <p>
       “源响应式对象”，即源对象需要是 ref 对象或 reactice 对象
      </p>
     </li>
     <li>
      <p>
       “返回一个 ref 数据”，即要用 .value 才能获取到实际值
      </p>
     </li>
     <li>
      <p>
       如果源对象如果是 ref 对象，则要使用 .value；reactive 对象则不需要
      </p>
     </li>
     <li>
      <p>
       修改返回的 ref 对象时源对象也会跟着变
      </p>
     </li>
    </ol>
    <pre><code class="prism language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>box<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>refObj：{<!-- -->{ refObj }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>reactiveObj：{<!-- -->{ reactiveObj }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">setup</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> ref<span class="token punctuation">,</span> reactive<span class="token punctuation">,</span> toRef <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> proxy1 <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'张三'</span><span class="token punctuation">,</span> <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token literal-property property">school</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'提瓦特小学'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">addr</span><span class="token operator">:</span> <span class="token string">'蒙德'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> proxy2 <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'张三'</span><span class="token punctuation">,</span> <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token literal-property property">school</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'提瓦特小学'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">addr</span><span class="token operator">:</span> <span class="token string">'蒙德'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> refObj <span class="token operator">=</span> <span class="token function">toRef</span><span class="token punctuation">(</span>proxy1<span class="token punctuation">.</span>value<span class="token punctuation">,</span> <span class="token string">'school'</span><span class="token punctuation">)</span> <span class="token comment">// ref 源对象需要使用 .value</span>
<span class="token keyword">let</span> reactiveObj <span class="token operator">=</span> <span class="token function">toRef</span><span class="token punctuation">(</span>proxy2<span class="token punctuation">,</span> <span class="token string">'school'</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"refObj:"</span><span class="token punctuation">,</span> refObj<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"reactiveObj:"</span><span class="token punctuation">,</span> reactiveObj<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">scoped</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
<span class="token selector">.box</span> <span class="token punctuation">{<!-- --></span>
  <span class="token property">padding</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/79767397112245248e56df7ae7fb8079.png"/>
    </p>
    <p>
     在 Vue3 中，toRef 函数的作用是使响应式对象的属性也成为响应式对象，响应式对象的属性本来就是响应式的，为什么还需要用 toRef 函数去转换呢？也就是说 toRef 的实际使用场景有哪些？
    </p>
    <ol>
     <li>
      <p>
       <strong>
        解构响应式对象时保持响应性
       </strong>
       ：当你解构一个响应式对象时，得到的属性会失去它们的响应性，因为它们不再是响应式对象的一部分。使用
       <code>
        toRef
       </code>
       可以让你在解构后仍然保持这些属性的响应性。
      </p>
     </li>
     <li>
      <p>
       <strong>
        传递响应式属性作为 props
       </strong>
       ：当你将响应式对象的属性作为 prop 传递给子组件时，如果直接传递属性本身，那么子组件将接收到属性的当前值，而不是一个响应式引用。这意味着如果父组件中的属性值发生变化，子组件将不会接收到这个更新，除非使用了
       <code>
        .sync
       </code>
       修饰符或
       <code>
        v-model
       </code>
       。但是，使用
       <code>
        toRef
       </code>
       可以创建一个响应式引用，并将其作为 prop 传递，这样子组件就可以响应父组件中属性值的变化了。
      </p>
     </li>
    </ol>
    <h2>
     <a id="toRefs_507">
     </a>
     toRefs
    </h2>
    <p>
     <code>
      toRefs
     </code>
     它接受一个响应式对象作为参数，并返回一个新的普通对象，普通对象的每个属性都是一个 ref 对象。
    </p>
    <p>
     注意点：
    </p>
    <ol>
     <li>
      <p>
       返回的是一个普通对象，不是响应式对象
      </p>
     </li>
     <li>
      <p>
       返回的普通对象的每个属性都是 ref 对象
      </p>
     </li>
     <li>
      <p>
       改变属性的 ref 对象的值，源响应式对象也会跟着变
      </p>
     </li>
    </ol>
    <pre><code class="prism language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>box<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>proxy：{<!-- -->{ proxy }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>toRefsObj：{<!-- -->{ toRefsObj }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">setup</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> reactive<span class="token punctuation">,</span> toRefs <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> proxy <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'张三'</span><span class="token punctuation">,</span> <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token literal-property property">school</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'提瓦特小学'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">addr</span><span class="token operator">:</span> <span class="token string">'蒙德'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> toRefsObj <span class="token operator">=</span> <span class="token function">toRefs</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"toRefsObj:"</span><span class="token punctuation">,</span> toRefsObj<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  toRefsObj<span class="token punctuation">.</span>name<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">'李四'</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">scoped</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
<span class="token selector">.box</span> <span class="token punctuation">{<!-- --></span>
  <span class="token property">padding</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
</code></pre>
    <p>
     1 秒钟后页面值刷新了，表明是响应式的：
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/64c54fd8a8a14bdfad7c7f57bb3f3f05.png"/>
    </p>
    <p>
     toRefsObj 是普通对象：
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/ddb6bb82df964070aeb032e7c2f3ded5.png"/>
    </p>
    <p>
     toRef 和 toRefs 最大的区别就是：
    </p>
    <ul>
     <li>
      <p>
       <code>
        toRef
       </code>
       ：用于将响应式对象中的
       <strong>
        单个属性
       </strong>
       转换为一个独立的响应式引用（
       <code>
        ref
       </code>
       ）。
      </p>
     </li>
     <li>
      <p>
       <code>
        toRefs
       </code>
       ：用于将响应式对象中的
       <strong>
        所有属性
       </strong>
       都转换为独立的响应式引用。
      </p>
     </li>
    </ul>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f34383234313938392f:61727469636c652f64657461696c732f313436323339393333" class_="artid" style="display:none">
 </p>
</div>


