---
layout: post
title: "微前端实战总结篇"
date: 2024-06-07 12:02:40 +0800
description: "微前端就是将不同的功能按照不同的维度拆分成多个子应用。通过主应用来加载这些子应用。微前端的核心在于拆"
keywords: "微前端实战"
categories: ['未分类']
tags: ['前端']
artid: "139523147"
image:
  path: https://api.vvhan.com/api/bing?rand=sj&artid=139523147
  alt: "微前端实战总结篇"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=139523147
featuredImagePreview: https://bing.ee123.net/img/rand?artid=139523147
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     【微前端实战总结篇】
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <div id="container">
     <p>
      <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/4bb2ebcd91529d2686b0c1763b19576a.png"/>
     </p>
     <p>
      微前端现有的落地方案可以分为三类，自组织模式、基座模式以及模块加载模式。
     </p>
     <h3 id="一、为什么需要微前端">
      <a class="headerlink" href="#一、为什么需要微前端" rel="nofollow" title="一、为什么需要微前端?">
      </a>
      一、为什么需要微前端?
     </h3>
     <p>
      这里我们通过3W(what,why,how)的方式来讲解什么是微前端：
     </p>
     <h4 id="1-What-什么是微前端">
      <a class="headerlink" href="#1-What-什么是微前端" rel="nofollow" title="1.What?什么是微前端?">
      </a>
      1.What?什么是微前端?
     </h4>
     <p>
      <img alt="" src="https://img-home.csdnimg.cn/images/20230724024159.png?origin_url=https%3A%2F%2Fblog.poetries.top%2Fimg%2Fstatic%2Fimages%2F20210731160243.png&amp;pos_id=img-XamNLLqD-1717732831371%29"/>
     </p>
     <p>
      微前端就是将不同的功能按照不同的维度拆分成多个子应用。通过主应用来加载这些子应用。
     </p>
     <blockquote>
      <p>
       微前端的核心在于拆, 拆完后再合!
      </p>
     </blockquote>
     <h4 id="2-Why-为什么去使用他">
      <a class="headerlink" href="#2-Why-为什么去使用他" rel="nofollow" title="2.Why?为什么去使用他?">
      </a>
      2.Why?为什么去使用他?
     </h4>
     <ul>
      <li>
       不同团队间开发同一个应用技术栈不同怎么破？
      </li>
      <li>
       希望每个团队都可以独立开发，独立部署怎么破？
      </li>
      <li>
       项目中还需要老的应用代码怎么破？
      </li>
     </ul>
     <blockquote>
      <p>
       我们是不是可以将一个应用划分成若干个子应用，再将子应用打包成一个个的lib呢？当路径切换时加载不同的子应用，这样每个子应用都是独立的，技术栈也就不用再做限制了！从而解决了前端协同开发的问题。
      </p>
     </blockquote>
     <h4 id="3-How-怎样落地微前端">
      <a class="headerlink" href="#3-How-怎样落地微前端" rel="nofollow" title="3.How?怎样落地微前端?">
      </a>
      3.How?怎样落地微前端?
     </h4>
     <p>
      <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/55fe213924a2009f214a6d60b8443966.png"/>
     </p>
     <ul>
      <li>
       2018年
       <code>
        Single-SPA
       </code>
       诞生了，
       <code>
        single-spa
       </code>
       是一个用于前端微服务化的JavaScript前端解决方案 (本身没有处理样式隔离、js执行隔离) 实现了路由劫持和应用加载；
      </li>
      <li>
       2019年 qiankun基于Single-SPA, 提供了更加开箱即用的 API (
       <code>
        single-spa + sandbox + import-html-entry
       </code>
       )，它 做到了技术栈无关，并且接入简单(有多简单呢，像iframe一样简单)
      </li>
     </ul>
     <blockquote>
      <p>
       总结：子应用可以独立构建，运行时动态加载，主子应用完全解耦，并且技术栈无关，靠的是协议接入(这里提前强调一下：子应用必须导出
       <code>
        bootstrap、mount、unmount
       </code>
       三个方法)。
      </p>
     </blockquote>
     <p>
      这里先回答一下大家可能会有的疑问：
     </p>
     <p>
      <strong>
       这不是iframe吗？
      </strong>
     </p>
     <blockquote>
      <p>
       如果使用的是
       <code>
        iframe
       </code>
       ，当iframe中的子应用切换路由时用户刷新页面就尴尬了。
      </p>
     </blockquote>
     <p>
      <strong>
       应用间如何通信？
      </strong>
     </p>
     <ul>
      <li>
       基于URL来进行数据传递，但是这种传递消息的方式能力较弱
      </li>
      <li>
       基于CustomEvent实现通信；
      </li>
      <li>
       <ul>
        <li>
         基于props主子应用间通信；
        </li>
       </ul>
      </li>
      <li>
       使用全局变量、Redux进行通信
      </li>
     </ul>
     <p>
      <strong>
       如何处理公共依赖？
      </strong>
     </p>
     <ul>
      <li>
       CDN -
       <code>
        externals
       </code>
      </li>
      <li>
       webpack
       <code>
        联邦模块
       </code>
      </li>
     </ul>
     <h3 id="二、SingleSpa实战">
      <a class="headerlink" href="#二、SingleSpa实战" rel="nofollow" title="二、SingleSpa实战">
      </a>
      二、SingleSpa实战
     </h3>
     <blockquote>
      <p>
       官网
       <a href="https://zh-hans.single-spa.js.org/docs/configuration" rel="noopener noopener noreferrer" target="_blank">
        https://zh-hans.single-spa.js.org/docs/configuration
       </a>
      </p>
     </blockquote>
     <h4 id="1-构建子应用">
      <a class="headerlink" href="#1-构建子应用" rel="nofollow" title="1.构建子应用">
      </a>
      1.构建子应用
     </h4>
     <blockquote>
      <p>
       首先创建一个vue子应用，并通过
       <code>
        single-spa-vue
       </code>
       来导出必要的生命周期：
      </p>
      <figure class="highlight plain">
       <table>
        <tbody>
         <tr>
          <td class="code">
           <pre><span class="line">vue create spa-vue  </span><br/><span class="line">npm install single-spa-vue</span><br/></pre>
          </td>
         </tr>
        </tbody>
       </table>
      </figure>
      <figure class="highlight js">
       <table>
        <tbody>
         <tr>
          <td class="code">
           <pre><span class="line"><span class="comment">// main.js</span></span><br/><span class="line"></span><br/><span class="line"><span class="keyword">import</span> singleSpaVue <span class="keyword">from</span> <span class="string">'single-spa-vue'</span>;</span><br/><span class="line"></span><br/><span class="line"><span class="keyword">const</span> appOptions = {<!-- --></span><br/><span class="line">   el: <span class="string">'#vue'</span>,</span><br/><span class="line">   router,</span><br/><span class="line">   render: <span class="function"><span class="params">h</span> =&gt;</span> h(App)</span><br/><span class="line">}</span><br/><span class="line"></span><br/><span class="line"><span class="comment">// 在非子应用中正常挂载应用</span></span><br/><span class="line"><span class="keyword">if</span>(!<span class="built_in">window</span>.singleSpaNavigate){<!-- --></span><br/><span class="line"> <span class="keyword">delete</span> appOptions.el;</span><br/><span class="line"> <span class="keyword">new</span> Vue(appOptions).$mount(<span class="string">'#app'</span>);</span><br/><span class="line">}</span><br/><span class="line"></span><br/><span class="line"><span class="keyword">const</span> vueLifeCycle = singleSpaVue({<!-- --></span><br/><span class="line">   Vue,</span><br/><span class="line">   appOptions</span><br/><span class="line">});</span><br/><span class="line"></span><br/><span class="line"></span><br/><span class="line"><span class="comment">// 子应用必须导出以下生命周期：bootstrap、mount、unmount</span></span><br/><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> bootstrap = vueLifeCycle.bootstrap;</span><br/><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> mount = vueLifeCycle.mount;</span><br/><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> unmount = vueLifeCycle.unmount;</span><br/><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> vueLifeCycle;</span><br/></pre>
          </td>
         </tr>
        </tbody>
       </table>
      </figure>
      <p>
       <strong>
        配置子路由基础路径
       </strong>
      </p>
      <figure class="highlight js">
       <table>
        <tbody>
         <tr>
          <td class="code">
           <pre><span class="line"><span class="comment">// router.js</span></span><br/><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> VueRouter({<!-- --></span><br/><span class="line">  mode: <span class="string">'history'</span>,</span><br/><span class="line">  base: <span class="string">'/vue'</span>,   <span class="comment">//改变路径配置</span></span><br/><span class="line">  routes</span><br/><span class="line">})</span><br/></pre>
          </td>
         </tr>
        </tbody>
       </table>
      </figure>
      ```csharp 在这里插入代码片 ```
     </blockquote>
    </div>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/9f0d4082ba8cb3b6a37c32744006af6d.png"/>
    </p>
    <h4 id="2-配置库打包">
     <a class="headerlink" href="#2-配置库打包" rel="nofollow" title="2.配置库打包">
     </a>
     2.配置库打包
    </h4>
    <blockquote>
     <p>
      将子模块打包成类库
     </p>
    </blockquote>
    <figure class="highlight js">
     <table>
      <tbody>
       <tr>
        <td class="code">
         <pre><span class="line"><span class="comment">//vue.config.js</span></span><br/><span class="line"><span class="built_in">module</span>.exports = {<!-- --></span><br/><span class="line">    configureWebpack: {<!-- --></span><br/><span class="line">    <span class="comment">// 把属性挂载到window上方便父应用调用
 window.singleVue.bootstrap/mount/unmount</span></span><br/><span class="line">        output: {<!-- --></span><br/><span class="line">            library: <span class="string">'singleVue'</span>,</span><br/><span class="line">            libraryTarget: <span class="string">'umd'</span></span><br/><span class="line">        },</span><br/><span class="line">        devServer:{<!-- --></span><br/><span class="line">            port:<span class="number">10000</span></span><br/><span class="line">        }</span><br/><span class="line">    }</span><br/><span class="line">}</span><br/></pre>
        </td>
       </tr>
      </tbody>
     </table>
    </figure>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/cd725e5f236c8994caaeca70d66aa62f.png"/>
    </p>
    <h4 id="3-主应用搭建">
     <a class="headerlink" href="#3-主应用搭建" rel="nofollow" title="3.主应用搭建">
     </a>
     3.主应用搭建
    </h4>
    <figure class="highlight plain">
     <table>
      <tbody>
       <tr>
        <td class="code">
         <pre><span class="line">&lt;div id="nav"&gt;</span><br/><span class="line">    &lt;router-link to="/vue"&gt;vue项目router-link&gt; </span><br/><span class="line">    &lt;div id="vue"&gt;div&gt;</span><br/><span class="line">div&gt;</span><br/></pre>
        </td>
       </tr>
      </tbody>
     </table>
    </figure>
    <blockquote>
     <p>
      将子应用挂载到
      <code>
       id="vue"
      </code>
      标签中
     </p>
    </blockquote>
    <figure class="highlight js">
     <table>
      <tbody>
       <tr>
        <td class="code">
         <pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'vue'</span></span><br/><span class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">'./App.vue'</span></span><br/><span class="line"><span class="keyword">import</span> router <span class="keyword">from</span> <span class="string">'./router'</span></span><br/><span class="line"><span class="keyword">import</span> {registerApplication,start} <span class="keyword">from</span> <span class="string">'single-spa'</span></span><br/><span class="line"></span><br/><span class="line">Vue.config.productionTip = <span class="literal">false</span></span><br/><span class="line"></span><br/><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">loadScript</span>(<span class="params">url</span>) </span>{<!-- --></span><br/><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>{<!-- --></span><br/><span class="line">    <span class="keyword">let</span> script = <span class="built_in">document</span>.createElement(<span class="string">'script'</span>)</span><br/><span class="line">    script.src = url </span><br/><span class="line">    script.onload = resolve</span><br/><span class="line">    script.onerror = reject</span><br/><span class="line">    <span class="built_in">document</span>.head.appendChild(script)</span><br/><span class="line">  })</span><br/><span class="line">}</span><br/><span class="line"></span><br/><span class="line"><span class="comment">// 注册应用</span></span><br/><span class="line">registerApplication(<span class="string">'myVueApp'</span>,</span><br/><span class="line">  <span class="keyword">async</span> ()=&gt;{<!-- --></span><br/><span class="line">    <span class="built_in">console</span>.info(<span class="string">'load'</span>)</span><br/><span class="line">    <span class="comment">// singlespa问题 </span></span><br/><span class="line">    <span class="comment">// 加载文件需要自己构建script标签 但是不知道应用有多少个文件</span></span><br/><span class="line">    <span class="comment">// 样式不隔离</span></span><br/><span class="line">    <span class="comment">// 全局对象没有js沙箱的机制 比如加载不同的应用 每个应用都用同一个环境</span></span><br/><span class="line">    <span class="comment">// 先加载公共的</span></span><br/><span class="line">    <span class="keyword">await</span> loadScript(<span class="string">'http://localhost:10000/js/chunk-vendors.js'</span>)</span><br/><span class="line">    <span class="keyword">await</span> loadScript(<span class="string">'http://localhost:10000/js/app.js'</span>)</span><br/><span class="line"></span><br/><span class="line">    <span class="keyword">return</span> <span class="built_in">window</span>.singleVue <span class="comment">// bootstrap mount unmount</span></span><br/><span class="line">  },</span><br/><span class="line">  <span class="comment">// 用户切换到/vue下 我们需要加载刚才定义的子应用</span></span><br/><span class="line">  location=&gt;location.pathname.startsWith(<span class="string">'/vue'</span>),</span><br/><span class="line">)</span><br/><span class="line"></span><br/><span class="line">start()</span><br/><span class="line"></span><br/><span class="line"><span class="keyword">new</span> Vue({<!-- --></span><br/><span class="line">  router,</span><br/><span class="line">  render: <span class="function"><span class="params">h</span> =&gt;</span> h(App)</span><br/><span class="line">}).$mount(<span class="string">'#app'</span>)</span><br/></pre>
        </td>
       </tr>
      </tbody>
     </table>
    </figure>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/583049c02777fbb5cf1f67d8c23171d0.png"/>
    </p>
    <h4 id="4-动态设置子应用publicPath">
     <a class="headerlink" href="#4-动态设置子应用publicPath" rel="nofollow" title="4.动态设置子应用publicPath">
     </a>
     4.动态设置子应用publicPath
    </h4>
    <figure class="highlight js">
     <table>
      <tbody>
       <tr>
        <td class="code">
         <pre><span class="line"><span class="keyword">if</span>(<span class="built_in">window</span>.singleSpaNavigate){<!-- --></span><br/><span class="line">  __webpack_public_path__ = <span class="string">'http://localhost:10000/'</span></span><br/><span class="line">}</span><br/></pre>
        </td>
       </tr>
      </tbody>
     </table>
    </figure>
    <h3 id="三、qiankun实战">
     <a class="headerlink" href="#三、qiankun实战" rel="nofollow" title="三、qiankun实战">
     </a>
     三、qiankun实战
    </h3>
    <blockquote>
     <p>
      <code>
       qiankun
      </code>
      是目前比较完善的一个微前端解决方案，它已在蚂蚁内部经受过足够大量的项目考验及打磨，十分健壮。这里附上官网。
     </p>
    </blockquote>
    <blockquote>
     <p>
      <a href="https://qiankun.umijs.org/zh/guide" rel="noopener noopener noreferrer" target="_blank">
       https://qiankun.umijs.org/zh/guide
      </a>
     </p>
    </blockquote>
    <h4 id="1-主应用编写">
     <a class="headerlink" href="#1-主应用编写" rel="nofollow" title="1.主应用编写">
     </a>
     1.主应用编写
    </h4>
    <figure class="highlight html">
     <table>
      <tbody>
       <tr>
        <td class="code">
         <pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br/><span class="line">  <span class="comment">&lt;!--注意这里不要写app 否则跟子应用的加载冲突</span></span><br/><span class="line"><span class="comment">  &lt;div id="app"&gt;--&gt;</span></span><br/><span class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br/><span class="line">    <span class="tag">&lt;<span class="name">el-menu</span> <span class="attr">:router</span>=<span class="string">"true"</span> <span class="attr">mode</span>=<span class="string">"horizontal"</span>&gt;</span></span><br/><span class="line">      <span class="comment">&lt;!-- 基座中可以放自己的路由 --&gt;</span></span><br/><span class="line">      <span class="tag">&lt;<span class="name">el-menu-item</span> <span class="attr">index</span>=<span class="string">"/"</span>&gt;</span>Home<span class="tag">&lt;/<span class="name">el-menu-item</span>&gt;</span></span><br/><span class="line"></span><br/><span class="line">      <span class="comment">&lt;!-- 引用其他子应用 --&gt;</span></span><br/><span class="line">      <span class="tag">&lt;<span class="name">el-menu-item</span> <span class="attr">index</span>=<span class="string">"/vue"</span>&gt;</span>vue应用<span class="tag">&lt;/<span class="name">el-menu-item</span>&gt;</span></span><br/><span class="line">      <span class="tag">&lt;<span class="name">el-menu-item</span> <span class="attr">index</span>=<span class="string">"/react"</span>&gt;</span>react应用<span class="tag">&lt;/<span class="name">el-menu-item</span>&gt;</span></span><br/><span class="line">    <span class="tag">&lt;/<span class="name">el-menu</span>&gt;</span></span><br/><span class="line">    <span class="tag">&lt;<span class="name">router-view</span> /&gt;</span></span><br/><span class="line"></span><br/><span class="line">    <span class="comment">&lt;!-- 其他子应用的挂载节点 --&gt;</span></span><br/><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"vue"</span> /&gt;</span></span><br/><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"react"</span> /&gt;</span></span><br/><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br/><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br/><span class="line"></span><br/><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br/><span class="line"></span><br/><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br/></pre>
        </td>
       </tr>
      </tbody>
     </table>
    </figure>
    <p>
     <strong>
      注册子应用
     </strong>
    </p>
    <figure class="highlight js">
     <table>
      <tbody>
       <tr>
        <td class="code">
         <pre><span class="line"></span><br/><span class="line"><span class="keyword">import</span> { registerMicroApps,start } <span class="keyword">from</span> <span class="string">'qiankun'</span></span><br/><span class="line"><span class="comment">// 基座写法</span></span><br/><span class="line"><span class="keyword">const</span> apps = [</span><br/><span class="line">  {<!-- --></span><br/><span class="line">    name: <span class="string">'vueApp'</span>, <span class="comment">// 名字</span></span><br/><span class="line">    <span class="comment">// 默认会加载这个HTML，解析里面的js动态执行 （子应用必须支持跨域）</span></span><br/><span class="line">    entry: <span class="string">'//localhost:10000'</span>,  </span><br/><span class="line">    container: <span class="string">'#vue'</span>, <span class="comment">// 容器</span></span><br/><span class="line">    activeRule: <span class="string">'/vue'</span>, <span class="comment">// 激活的路径 访问/vue把应用挂载到#vue上</span></span><br/><span class="line">    props: { <span class="comment">// 传递属性给子应用接收</span></span><br/><span class="line">      a: <span class="number">1</span>,</span><br/><span class="line">    }</span><br/><span class="line">  },</span><br/><span class="line">  {<!-- --></span><br/><span class="line">    name: <span class="string">'reactApp'</span>,</span><br/><span class="line">    <span class="comment">// 默认会加载这个HTML，解析里面的js动态执行 （子应用必须支持跨域）</span></span><br/><span class="line">    entry: <span class="string">'//localhost:20000'</span>,  </span><br/><span class="line">    container: <span class="string">'#react'</span>,</span><br/><span class="line">    activeRule: <span class="string">'/react'</span> <span class="comment">// 访问/react把应用挂载到#react上</span></span><br/><span class="line">  },</span><br/><span class="line">]</span><br/><span class="line"></span><br/><span class="line"><span class="comment">// 注册</span></span><br/><span class="line">registerMicroApps(apps)</span><br/><span class="line"><span class="comment">// 开启</span></span><br/><span class="line">start({<!-- --></span><br/><span class="line">  prefetch: <span class="literal">false</span> <span class="comment">// 取消预加载</span></span><br/><span class="line">})</span><br/></pre>
        </td>
       </tr>
      </tbody>
     </table>
    </figure>
    <h4 id="2-子Vue应用">
     <a class="headerlink" href="#2-子Vue应用" rel="nofollow" title="2.子Vue应用">
     </a>
     2.子Vue应用
    </h4>
    <figure class="highlight js">
     <table>
      <tbody>
       <tr>
        <td class="code">
         <pre><span class="line"><span class="comment">// src/router.js</span></span><br/><span class="line"></span><br/><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> VueRouter({<!-- --></span><br/><span class="line">  mode: <span class="string">'history'</span>,</span><br/><span class="line">  <span class="comment">// base里主应用里面注册的保持一致</span></span><br/><span class="line">  base: <span class="string">'/vue'</span>,</span><br/><span class="line">  routes</span><br/><span class="line">})</span><br/></pre>
        </td>
       </tr>
      </tbody>
     </table>
    </figure>
    <figure class="highlight js">
     <table>
      <tbody>
       <tr>
        <td class="code">
         <pre><span class="line"><span class="comment">// main.js</span></span><br/><span class="line"></span><br/><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'vue'</span></span><br/><span class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">'./App.vue'</span></span><br/><span class="line"><span class="keyword">import</span> router <span class="keyword">from</span> <span class="string">'./router'</span></span><br/><span class="line"></span><br/><span class="line">Vue.config.productionTip = <span class="literal">false</span></span><br/><span class="line"></span><br/><span class="line"><span class="keyword">let</span> instance = <span class="literal">null</span></span><br/><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params"></span>) </span>{<!-- --></span><br/><span class="line">  instance = <span class="keyword">new</span> Vue({<!-- --></span><br/><span class="line">    router,</span><br/><span class="line">    render: <span class="function"><span class="params">h</span> =&gt;</span> h(App)</span><br/><span class="line">  }).$mount(<span class="string">'#app'</span>) <span class="comment">// 这里是挂载到自己的HTML中 基座会拿到挂载后的HTML 将其插入进去</span></span><br/><span class="line">}</span><br/><span class="line"></span><br/><span class="line"><span class="comment">// 独立运行微应用</span></span><br/><span class="line"><span class="comment">// https://qiankun.umijs.org/zh/faq#%E5%A6%82%E4%BD%95%E7%8B%AC%E7%AB%8B%E8%BF%90%E8%A1%8C%E5%BE%AE%E5%BA%94%E7%94%A8%EF%BC%9F</span></span><br/><span class="line"><span class="keyword">if</span>(!<span class="built_in">window</span>.__POWERED_BY_QIANKUN__) {<!-- --></span><br/><span class="line">  render()</span><br/><span class="line">}</span><br/><span class="line"></span><br/><span class="line"><span class="comment">// 如果被qiankun使用 会动态注入路径</span></span><br/><span class="line"><span class="keyword">if</span>(<span class="built_in">window</span>.__POWERED_BY_QIANKUN__) {<!-- --></span><br/><span class="line">  <span class="comment">// qiankun 将会在微应用 bootstrap 之前注入一个运行时的 publicPath 变量，你需要做的是在微应用的 entry js 的顶部添加如下代码：</span></span><br/><span class="line">  __webpack_public_path__ = <span class="built_in">window</span>.__INJECTED_PUBLIC_PATH_BY_QIANKUN__;</span><br/><span class="line">}</span><br/><span class="line"></span><br/><span class="line"><span class="comment">// 子应用的协议 导出供父应用调用 必须导出promise</span></span><br/><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">bootstrap</span>(<span class="params">props</span>) </span>{} <span class="comment">// 启动可以不用写 需要导出方法</span></span><br/><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">mount</span>(<span class="params">props</span>) </span>{<!-- --></span><br/><span class="line">  render()</span><br/><span class="line">}</span><br/><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">unmount</span>(<span class="params">props</span>) </span>{<!-- --></span><br/><span class="line">  instance.$destroy()</span><br/><span class="line">}</span><br/></pre>
        </td>
       </tr>
      </tbody>
     </table>
    </figure>
    <blockquote>
     <p>
      这里不要忘记子应用的钩子导出。
     </p>
    </blockquote>
    <figure class="highlight js">
     <table>
      <tbody>
       <tr>
        <td class="code">
         <pre><span class="line"><span class="comment">// vue.config.js</span></span><br/><span class="line"></span><br/><span class="line"><span class="built_in">module</span>.exports = {<!-- --></span><br/><span class="line">    devServer:{<!-- --></span><br/><span class="line">        port:<span class="number">10000</span>,</span><br/><span class="line">        headers:{<!-- --></span><br/><span class="line">            <span class="string">'Access-Control-Allow-Origin'</span>:<span class="string">'*'</span> <span class="comment">//允许访问跨域</span></span><br/><span class="line">        }</span><br/><span class="line">    },</span><br/><span class="line">    configureWebpack:{<!-- --></span><br/><span class="line">        <span class="comment">// 打umd包</span></span><br/><span class="line">        output:{<!-- --></span><br/><span class="line">            library:<span class="string">'vueApp'</span>,</span><br/><span class="line">            libraryTarget:<span class="string">'umd'</span></span><br/><span class="line">        }</span><br/><span class="line">    }</span><br/><span class="line">}</span><br/></pre>
        </td>
       </tr>
      </tbody>
     </table>
    </figure>
    <h4 id="3-子React应用">
     <a class="headerlink" href="#3-子React应用" rel="nofollow" title="3.子React应用">
     </a>
     3.子React应用
    </h4>
    <blockquote>
     <p>
      再起一个子应用，为了表明技术栈无关特性，这里使用了一个
      <code>
       React
      </code>
      项目：
     </p>
    </blockquote>
    <figure class="highlight html">
     <table>
      <tbody>
       <tr>
        <td class="code">
         <pre><span class="line">// app.js</span><br/><span class="line"></span><br/><span class="line">import logo from './logo.svg';</span><br/><span class="line">import './App.css';</span><br/><span class="line">import {BrowserRouter,Route,Link} from 'react-router-dom'</span><br/><span class="line"></span><br/><span class="line">function App() {<!-- --></span><br/><span class="line">  return (</span><br/><span class="line">    // /react跟主应用配置保持一致</span><br/><span class="line">    <span class="tag">&lt;<span class="name">BrowserRouter</span> <span class="attr">basename</span>=<span class="string">"/react"</span>&gt;</span></span><br/><span class="line">      <span class="tag">&lt;<span class="name">Link</span> <span class="attr">to</span>=<span class="string">"/"</span>&gt;</span>首页<span class="tag">&lt;/<span class="name">Link</span>&gt;</span></span><br/><span class="line">      <span class="tag">&lt;<span class="name">Link</span> <span class="attr">to</span>=<span class="string">"/about"</span>&gt;</span>关于<span class="tag">&lt;/<span class="name">Link</span>&gt;</span></span><br/><span class="line"></span><br/><span class="line">      <span class="tag">&lt;<span class="name">Route</span> <span class="attr">path</span>=<span class="string">"/"</span> <span class="attr">exact</span> <span class="attr">render</span>=<span class="string">{()</span>=&gt;</span>(</span><br/><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"App"</span>&gt;</span></span><br/><span class="line">          <span class="tag">&lt;<span class="name">header</span> <span class="attr">className</span>=<span class="string">"App-header"</span>&gt;</span></span><br/><span class="line">            <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">{logo}</span> <span class="attr">className</span>=<span class="string">"App-logo"</span> <span class="attr">alt</span>=<span class="string">"logo"</span> /&gt;</span></span><br/><span class="line">            <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br/><span class="line">              Edit <span class="tag">&lt;<span class="name">code</span>&gt;</span>src/App.js<span class="tag">&lt;/<span class="name">code</span>&gt;</span> and save to reload.</span><br/><span class="line">            <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br/><span class="line">            <span class="tag">&lt;<span class="name">a</span></span></span><br/><span class="line"><span class="tag">              <span class="attr">className</span>=<span class="string">"App-link"</span></span></span><br/><span class="line"><span class="tag">              <span class="attr">href</span>=<span class="string">"https://reactjs.org"</span></span></span><br/><span class="line"><span class="tag">              <span class="attr">target</span>=<span class="string">"_blank"</span></span></span><br/><span class="line"><span class="tag">              <span class="attr">rel</span>=<span class="string">"noopener noreferrer"</span></span></span><br/><span class="line"><span class="tag">            &gt;</span></span><br/><span class="line">              Learn React</span><br/><span class="line">            <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br/><span class="line">          <span class="tag">&lt;/<span class="name">header</span>&gt;</span></span><br/><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br/><span class="line">      )} /&gt;</span><br/><span class="line">      </span><br/><span class="line">      <span class="tag">&lt;<span class="name">Route</span> <span class="attr">path</span>=<span class="string">"/about"</span> <span class="attr">exact</span> <span class="attr">render</span>=<span class="string">{()</span>=&gt;</span>(</span><br/><span class="line">        <span class="tag">&lt;<span class="name">h1</span>&gt;</span>About Page<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br/><span class="line">      )}&gt;<span class="tag">&lt;/<span class="name">Route</span>&gt;</span></span><br/><span class="line">    <span class="tag">&lt;/<span class="name">BrowserRouter</span>&gt;</span></span><br/><span class="line">  );</span><br/><span class="line">}</span><br/><span class="line"></span><br/><span class="line">export default App;</span><br/></pre>
        </td>
       </tr>
      </tbody>
     </table>
    </figure>
    <figure class="highlight js">
     <table>
      <tbody>
       <tr>
        <td class="code">
         <pre><span class="line"><span class="comment">// index.js</span></span><br/><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br/><span class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">'react-dom'</span>;</span><br/><span class="line"><span class="keyword">import</span> <span class="string">'./index.css'</span>;</span><br/><span class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">'./App'</span>;</span><br/><span class="line"><span class="keyword">import</span> reportWebVitals <span class="keyword">from</span> <span class="string">'./reportWebVitals'</span>;</span><br/><span class="line"></span><br/><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params"></span>) </span>{<!-- --></span><br/><span class="line">  ReactDOM.render(</span><br/><span class="line">    &lt;React.StrictMode&gt;</span><br/><span class="line">      &lt;App /&gt;</span><br/><span class="line">    &lt;<span class="regexp">/React.StrictMode&gt;,</span></span><br/><span class="line"><span class="regexp">    document.getElementById('root')</span></span><br/><span class="line"><span class="regexp">  );</span></span><br/><span class="line"><span class="regexp">}</span></span><br/><span class="line"><span class="regexp"></span></span><br/><span class="line"><span class="regexp">/</span><span class="regexp">/ If you want to start measuring performance in your app, pass a function</span></span><br/><span class="line"><span class="regexp">/</span><span class="regexp">/ to log results (for example: reportWebVitals(console.log))</span></span><br/><span class="line"><span class="regexp">/</span><span class="regexp">/ or send to an analytics endpoint. Learn more: https:/</span><span class="regexp">/bit.ly/</span>CRA-vitals</span><br/><span class="line">reportWebVitals();</span><br/><span class="line"></span><br/><span class="line"><span class="comment">// 独立运行</span></span><br/><span class="line"><span class="keyword">if</span>(!<span class="built_in">window</span>.__POWERED_BY_QIANKUN__){<!-- --></span><br/><span class="line">  render()</span><br/><span class="line">}</span><br/><span class="line"></span><br/><span class="line"><span class="comment">// 子应用协议</span></span><br/><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">bootstrap</span>(<span class="params"></span>) </span>{}</span><br/><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">mount</span>(<span class="params"></span>) </span>{<!-- --></span><br/><span class="line">  render()</span><br/><span class="line">}</span><br/><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">unmount</span>(<span class="params"></span>) </span>{<!-- --></span><br/><span class="line">  ReactDOM.unmountComponentAtNode(<span class="built_in">document</span>.getElementById(<span class="string">"root"</span>));</span><br/><span class="line">}</span><br/></pre>
        </td>
       </tr>
      </tbody>
     </table>
    </figure>
    <p>
     <strong>
      重写react中的webpack配置文件 (config-overrides.js)
     </strong>
    </p>
    <figure class="highlight plain">
     <table>
      <tbody>
       <tr>
        <td class="code">
         <pre><span class="line">yarn add react-app-rewired --save-dev</span><br/></pre>
        </td>
       </tr>
      </tbody>
     </table>
    </figure>
    <blockquote>
     <p>
      修改package.json文件
     </p>
    </blockquote>
    <figure class="highlight js">
     <table>
      <tbody>
       <tr>
        <td class="code">
         <pre><span class="line"><span class="comment">// react-scripts 改成 react-app-rewired</span></span><br/><span class="line"><span class="string">"scripts"</span>: {<!-- --></span><br/><span class="line">    <span class="string">"start"</span>: <span class="string">"react-app-rewired start"</span>,</span><br/><span class="line">    <span class="string">"build"</span>: <span class="string">"react-app-rewired build"</span>,</span><br/><span class="line">    <span class="string">"test"</span>: <span class="string">"react-app-rewired test"</span>,</span><br/><span class="line">    <span class="string">"eject"</span>: <span class="string">"react-app-rewired eject"</span></span><br/><span class="line">  },</span><br/></pre>
        </td>
       </tr>
      </tbody>
     </table>
    </figure>
    <blockquote>
     <p>
      在根目录新建配置文件
     </p>
    </blockquote>
    <figure class="highlight js">
     <table>
      <tbody>
       <tr>
        <td class="code">
         <pre><span class="line"><span class="comment">// 配置文件重写</span></span><br/><span class="line">touch config-overrides.js</span><br/></pre>
        </td>
       </tr>
      </tbody>
     </table>
    </figure>
    <figure class="highlight js">
     <table>
      <tbody>
       <tr>
        <td class="code">
         <pre><span class="line"><span class="comment">// config-overrides.js</span></span><br/><span class="line"></span><br/><span class="line"><span class="built_in">module</span>.exports = {<!-- --></span><br/><span class="line">  webpack: <span class="function">(<span class="params">config</span>) =&gt;</span> {<!-- --></span><br/><span class="line">    <span class="comment">// 名字和基座配置的一样</span></span><br/><span class="line">    config.output.library = <span class="string">'reactApp'</span>;</span><br/><span class="line">    config.output.libraryTarget = <span class="string">"umd"</span>;</span><br/><span class="line">    config.output.publicPath = <span class="string">'http://localhost:20000/'</span></span><br/><span class="line">    <span class="keyword">return</span> config</span><br/><span class="line">  },</span><br/><span class="line">  devServer: <span class="function"><span class="keyword">function</span> (<span class="params">configFunction</span>) </span>{<!-- --></span><br/><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">proxy, allowedHost</span>) </span>{<!-- --></span><br/><span class="line">      <span class="keyword">const</span> config = configFunction(proxy, allowedHost);</span><br/><span class="line"></span><br/><span class="line">      <span class="comment">// 配置跨域</span></span><br/><span class="line">      config.headers = {<!-- --></span><br/><span class="line">        <span class="string">"Access-Control-Allow-Origin"</span>: <span class="string">"*"</span>,</span><br/><span class="line">      };</span><br/><span class="line">      <span class="keyword">return</span> config;</span><br/><span class="line">    };</span><br/><span class="line">  },</span><br/><span class="line">};</span><br/></pre>
        </td>
       </tr>
      </tbody>
     </table>
    </figure>
    <p>
     <strong>
      配置.env文件
     </strong>
    </p>
    <blockquote>
     <p>
      根目录新建
      <code>
       .env
      </code>
     </p>
    </blockquote>
    <figure class="highlight plain">
     <table>
      <tbody>
       <tr>
        <td class="code">
         <pre><span class="line">PORT=20000</span><br/><span class="line"># socket发送端口</span><br/><span class="line">WDS_SOCKET_PORT=20000</span><br/></pre>
        </td>
       </tr>
      </tbody>
     </table>
    </figure>
    <p>
     <strong>
      React路由配置
     </strong>
    </p>
    <figure class="highlight js">
     <table>
      <tbody>
       <tr>
        <td class="code">
         <pre><span class="line"><span class="keyword">import</span> { BrowserRouter, Route, Link } <span class="keyword">from</span> <span class="string">"react-router-dom"</span></span><br/><span class="line"></span><br/><span class="line"><span class="keyword">const</span> BASE_NAME = <span class="built_in">window</span>.__POWERED_BY_QIANKUN__ ? <span class="string">"/react"</span> : <span class="string">""</span>;</span><br/><span class="line"></span><br/><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>{<!-- --></span><br/><span class="line">  <span class="keyword">return</span> (</span><br/><span class="line">    &lt;BrowserRouter basename={BASE_NAME}&gt;&lt;Link to="/"&gt;首页Link&gt;&lt;Link to="/about"&gt;关于Link&gt;&lt;Route path="/" exact render={() =&gt; &lt;h1&gt;hello homeh1&gt;}&gt;Route&gt;&lt;Route path="/about" render={() =&gt; &lt;h1&gt;hello abouth1&gt;}&gt;Route&gt;BrowserRouter&gt;</span><br/><span class="line">  );</span><br/><span class="line">}</span><br/></pre>
        </td>
       </tr>
      </tbody>
     </table>
    </figure>
    <p>
     <img alt="" src="https://img-home.csdnimg.cn/images/20230724024159.png?origin_url=https%3A%2F%2Fblog.poetries.top%2Fimg%2Fstatic%2Fimages%2F20210731205952.png&amp;pos_id=img-yEjFI8j5-1717732918851%29"/>
    </p>
    <h3 id="四、飞冰微前端实战">
     <a class="headerlink" href="#四、飞冰微前端实战" rel="nofollow" title="四、飞冰微前端实战">
     </a>
     四、飞冰微前端实战
    </h3>
    <blockquote>
     <p>
      官方接入指南
      <a href="https://micro-frontends.ice.work/docs/guide" rel="noopener noopener noreferrer" target="_blank">
       https://micro-frontends.ice.work/docs/guide
      </a>
     </p>
    </blockquote>
    <h4 id="4-1-react主应用编写">
     <a class="headerlink" href="#4-1-react主应用编写" rel="nofollow" title="4.1 react主应用编写">
     </a>
     4.1 react主应用编写
    </h4>
    <figure class="highlight js">
     <table>
      <tbody>
       <tr>
        <td class="code">
         <pre><span class="line">$ npm init ice icestark-layout @icedesign/stark-layout-scaffold</span><br/><span class="line">$ cd icestark-layout</span><br/><span class="line">$ npm install</span><br/><span class="line">$ npm start</span><br/></pre>
        </td>
       </tr>
      </tbody>
     </table>
    </figure>
    <figure class="highlight js">
     <table>
      <tbody>
       <tr>
        <td class="code">
         <pre><span class="line"><span class="comment">// src/app.jsx中加入</span></span><br/><span class="line"></span><br/><span class="line"><span class="keyword">const</span> appConfig: IAppConfig = {<!-- --></span><br/><span class="line"></span><br/><span class="line">  ...</span><br/><span class="line">  </span><br/><span class="line">  icestark: {<!-- --></span><br/><span class="line">    type: <span class="string">'framework'</span>,</span><br/><span class="line">    Layout: FrameworkLayout,</span><br/><span class="line">    getApps: <span class="keyword">async</span> () =&gt; {<!-- --></span><br/><span class="line">      <span class="keyword">const</span> apps = [</span><br/><span class="line">      {<!-- --></span><br/><span class="line">        path: <span class="string">'/vue'</span>,</span><br/><span class="line">        title: <span class="string">'vue微应用测试'</span>,</span><br/><span class="line">        sandbox: <span class="literal">false</span>,</span><br/><span class="line">        url: [</span><br/><span class="line">          <span class="comment">// 测试环境</span></span><br/><span class="line">          <span class="comment">// 请求子应用端口下的服务，子应用的vue.config.js里面 需要配置headers跨域请求头</span></span><br/><span class="line">          <span class="string">"http://localhost:3001/js/chunk-vendors.js"</span>,</span><br/><span class="line">          <span class="string">"http://localhost:3001/js/app.js"</span>,</span><br/><span class="line">        ],</span><br/><span class="line">      },</span><br/><span class="line">      {<!-- --></span><br/><span class="line">        path: <span class="string">'/react'</span>,</span><br/><span class="line">        title: <span class="string">'react微应用测试'</span>,</span><br/><span class="line">        sandbox: <span class="literal">true</span>,</span><br/><span class="line">        url: [</span><br/><span class="line">          <span class="comment">// 测试环境</span></span><br/><span class="line">          <span class="comment">// 请求子应用端口下的服务，子应用的webpackDevServer.config.js里面 需要配置headers跨域请求头</span></span><br/><span class="line">          <span class="string">"http://localhost:3000/static/js/bundle.js"</span>,</span><br/><span class="line">        ],</span><br/><span class="line">      }</span><br/><span class="line">    ];</span><br/><span class="line">      <span class="keyword">return</span> apps;</span><br/><span class="line">    },</span><br/><span class="line">    appRouter: {<!-- --></span><br/><span class="line">      LoadingComponent: PageLoading,</span><br/><span class="line">    },</span><br/><span class="line">  },</span><br/><span class="line">};</span><br/></pre>
        </td>
       </tr>
      </tbody>
     </table>
    </figure>
    <figure class="highlight js">
     <table>
      <tbody>
       <tr>
        <td class="code">
         <pre><span class="line"><span class="comment">// 侧边栏菜单</span></span><br/><span class="line"><span class="comment">// src/layouts/menuConfig.ts 改造</span></span><br/><span class="line"></span><br/><span class="line"><span class="keyword">const</span> asideMenuConfig = [</span><br/><span class="line">  {<!-- --></span><br/><span class="line">    name: <span class="string">'vue微应用测试'</span>,</span><br/><span class="line">    icon: <span class="string">'set'</span>,</span><br/><span class="line">    path: <span class="string">'/vue'</span> </span><br/><span class="line">  },</span><br/><span class="line">  {<!-- --></span><br/><span class="line">    name: <span class="string">'React微应用测试'</span>,</span><br/><span class="line">    icon: <span class="string">'set'</span>,</span><br/><span class="line">    path: <span class="string">'/react'</span></span><br/><span class="line">  },</span><br/><span class="line">]</span><br/></pre>
        </td>
       </tr>
      </tbody>
     </table>
    </figure>
    <h4 id="4-2-vue子应用接入">
     <a class="headerlink" href="#4-2-vue子应用接入" rel="nofollow" title="4.2 vue子应用接入">
     </a>
     4.2 vue子应用接入
    </h4>
    <figure class="highlight plain">
     <table>
      <tbody>
       <tr>
        <td class="code">
         <pre><span class="line"># 创建一个子应用</span><br/><span class="line">vue create vue-child</span><br/></pre>
        </td>
       </tr>
      </tbody>
     </table>
    </figure>
    <figure class="highlight js">
     <table>
      <tbody>
       <tr>
        <td class="code">
         <pre><span class="line"><span class="comment">// 修改vue.config.js</span></span><br/><span class="line"></span><br/><span class="line"><span class="built_in">module</span>.exports = {<!-- --></span><br/><span class="line">  devServer: {<!-- --></span><br/><span class="line">    open: <span class="literal">true</span>, <span class="comment">// 设置浏览器自动打开项目</span></span><br/><span class="line">    port: <span class="number">3001</span>, <span class="comment">// 设置端口</span></span><br/><span class="line">    <span class="comment">// 支持跨域 方便主应用请求子应用资源</span></span><br/><span class="line">    headers: {<!-- --></span><br/><span class="line">      <span class="string">'Access-Control-Allow-Origin'</span> : <span class="string">'*'</span>,</span><br/><span class="line">      <span class="string">'Access-Control-Allow-Methods'</span>: <span class="string">'GET, POST, PUT, DELETE, PATCH, OPTIONS'</span>,</span><br/><span class="line">      <span class="string">'Access-Control-Allow-Headers'</span>: <span class="string">'X-Requested-With, content-type, Authorization'</span>,</span><br/><span class="line">    }</span><br/><span class="line">  },</span><br/><span class="line">  configureWebpack: {<!-- --></span><br/><span class="line">    <span class="comment">// 打包成lib包 umd格式</span></span><br/><span class="line">    output: {<!-- --></span><br/><span class="line">      library: <span class="string">'icestark-vue'</span>,</span><br/><span class="line">      libraryTarget: <span class="string">'umd'</span>,</span><br/><span class="line">    },</span><br/><span class="line">  }</span><br/><span class="line">}</span><br/></pre>
        </td>
       </tr>
      </tbody>
     </table>
    </figure>
    <blockquote>
     <p>
      <code>
       src/main.js
      </code>
      改造
     </p>
    </blockquote>
    <figure class="highlight js">
     <table>
      <tbody>
       <tr>
        <td class="code">
         <pre><span class="line"><span class="keyword">import</span> { createApp } <span class="keyword">from</span> <span class="string">'vue'</span></span><br/><span class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">'./App.vue'</span></span><br/><span class="line"><span class="keyword">import</span> router <span class="keyword">from</span> <span class="string">'./router'</span></span><br/><span class="line"><span class="keyword">import</span> store <span class="keyword">from</span> <span class="string">'./store'</span></span><br/><span class="line"></span><br/><span class="line"><span class="keyword">import</span> {<!-- --></span><br/><span class="line">  isInIcestark,</span><br/><span class="line">  getMountNode,</span><br/><span class="line">  registerAppEnter,</span><br/><span class="line">  registerAppLeave,</span><br/><span class="line">  setLibraryName</span><br/><span class="line">} <span class="keyword">from</span> <span class="string">'@ice/stark-app'</span></span><br/><span class="line"></span><br/><span class="line"><span class="keyword">let</span> vue = createApp(App)</span><br/><span class="line">vue.use(store)</span><br/><span class="line">vue.use(router)</span><br/><span class="line"></span><br/><span class="line"><span class="comment">// 注意：`setLibraryName` 的入参需要与 webpack 工程配置的 output.library 保持一致</span></span><br/><span class="line"><span class="comment">//  重要 不加不生效 和 vue.config.js中配置的一样</span></span><br/><span class="line">setLibraryName(<span class="string">'icestark-vue'</span>)</span><br/><span class="line"></span><br/><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">mount</span>(<span class="params">{ container }</span>) </span>{<!-- --></span><br/><span class="line">  <span class="comment">// ![](https://img-blog.csdnimg.cn/img_convert/9a8ce21b17bc7e9e5fc0abaa530f4200.png)</span></span><br/><span class="line">  <span class="built_in">console</span>.log(container,<span class="string">'container'</span>)</span><br/><span class="line">  vue.mount(container);</span><br/><span class="line">}</span><br/><span class="line"></span><br/><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">unmount</span>(<span class="params"></span>) </span>{<!-- --></span><br/><span class="line">  vue.unmount();</span><br/><span class="line">}</span><br/><span class="line">  </span><br/><span class="line"><span class="keyword">if</span> (!isInIcestark()) {<!-- --></span><br/><span class="line">  vue.mount(<span class="string">'#app'</span>)</span><br/><span class="line">}</span><br/></pre>
        </td>
       </tr>
      </tbody>
     </table>
    </figure>
    <blockquote>
     <p>
      router改造
     </p>
    </blockquote>
    <figure class="highlight plain">
     <table>
      <tbody>
       <tr>
        <td class="code">
         <pre><span class="line">import { getBasename } from '@ice/stark-app';</span><br/><span class="line"></span><br/><span class="line"></span><br/><span class="line">const router = createRouter({<!-- --></span><br/><span class="line">  // 重要 在主应用中的基准路由</span><br/><span class="line">  base: getBasename(),</span><br/><span class="line">  routes</span><br/><span class="line">})</span><br/><span class="line"></span><br/><span class="line">export default router</span><br/></pre>
        </td>
       </tr>
      </tbody>
     </table>
    </figure>
    <h4 id="4-3-react子应用接入">
     <a class="headerlink" href="#4-3-react子应用接入" rel="nofollow" title="4.3 react子应用接入">
     </a>
     4.3 react子应用接入
    </h4>
    <figure class="highlight plain">
     <table>
      <tbody>
       <tr>
        <td class="code">
         <pre><span class="line">create-react-app react-child</span><br/></pre>
        </td>
       </tr>
      </tbody>
     </table>
    </figure>
    <figure class="highlight plain">
     <table>
      <tbody>
       <tr>
        <td class="code">
         <pre><span class="line">// src/app.js</span><br/><span class="line"></span><br/><span class="line">import { isInIcestark, getMountNode, registerAppEnter, registerAppLeave } from '@ice/stark-app';</span><br/><span class="line"></span><br/><span class="line">export function mount(props) {<!-- --></span><br/><span class="line">  ReactDOM.render(&lt;App /&gt;, props.container);</span><br/><span class="line">}</span><br/><span class="line"></span><br/><span class="line">export function unmount(props) {<!-- --></span><br/><span class="line">  ReactDOM.unmountComponentAtNode(props.container);</span><br/><span class="line">}</span><br/><span class="line"></span><br/><span class="line">if (!isInIcestark()) {<!-- --></span><br/><span class="line">  ReactDOM.render(&lt;App /&gt;, document.getElementById('root'));</span><br/><span class="line">}</span><br/><span class="line"></span><br/><span class="line">if (isInIcestark()) {<!-- --></span><br/><span class="line">  registerAppEnter(() =&gt; {<!-- --></span><br/><span class="line">    ReactDOM.render(&lt;App /&gt;, getMountNode());</span><br/><span class="line">  })</span><br/><span class="line">  registerAppLeave(() =&gt; {<!-- --></span><br/><span class="line">    ReactDOM.unmountComponentAtNode(getMountNode());</span><br/><span class="line">  })</span><br/><span class="line">} else {<!-- --></span><br/><span class="line">  ReactDOM.render(&lt;App /&gt;, document.getElementById('root'));</span><br/><span class="line">}</span><br/></pre>
        </td>
       </tr>
      </tbody>
     </table>
    </figure>
    <blockquote>
     <p>
      <code>
       npm run eject
      </code>
      后，改造
      <code>
       config/webpackDevServer.config.js
      </code>
     </p>
    </blockquote>
    <figure class="highlight js">
     <table>
      <tbody>
       <tr>
        <td class="code">
         <pre><span class="line">hot: <span class="string">''</span>,</span><br/><span class="line">port: <span class="string">''</span>,</span><br/><span class="line">...</span><br/><span class="line"></span><br/><span class="line"><span class="comment">// 支持跨域</span></span><br/><span class="line">headers: {<!-- --></span><br/><span class="line">  <span class="string">'Access-Control-Allow-Origin'</span> : <span class="string">'*'</span>,</span><br/><span class="line">  <span class="string">'Access-Control-Allow-Methods'</span>: <span class="string">'GET, POST, PUT, DELETE, PATCH, OPTIONS'</span>,</span><br/><span class="line">  <span class="string">'Access-Control-Allow-Headers'</span>: <span class="string">'X-Requested-With, content-type, Authorization'</span>,</span><br/><span class="line">},</span><br/></pre>
        </td>
       </tr>
      </tbody>
     </table>
    </figure>
    <h3 id="五、CSS隔离方案">
     <a class="headerlink" href="#五、CSS隔离方案" rel="nofollow" title="五、CSS隔离方案">
     </a>
     五、CSS隔离方案
    </h3>
    <h4 id="子应用之间样式隔离：">
     <a class="headerlink" href="#子应用之间样式隔离：" rel="nofollow" title="子应用之间样式隔离：">
     </a>
     子应用之间样式隔离：
    </h4>
    <blockquote>
     <p>
      <code>
       Dynamic Stylesheet
      </code>
      动态样式表，当应用切换时移除掉老应用样式，再添加新应用样式，保证在一个时间点内只有一个应用的样式表生效
     </p>
    </blockquote>
    <h4 id="主应用和子应用之间的样式隔离：">
     <a class="headerlink" href="#主应用和子应用之间的样式隔离：" rel="nofollow" title="主应用和子应用之间的样式隔离：">
     </a>
     主应用和子应用之间的样式隔离：
    </h4>
    <ul>
     <li>
      <code>
       BEM(Block Element Modifier)
      </code>
      约定项目前缀
     </li>
     <li>
      <code>
       CSS-Modules
      </code>
      打包时生成不冲突的选择器名
     </li>
     <li>
      Shadow DOM 真正意义上的隔离
     </li>
     <li>
      <code>
       css-in-js
      </code>
     </li>
    </ul>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/2c78f25e27535c552ea5fe2c902c2821.png"/>
    </p>
    <figure class="highlight html">
     <table>
      <tbody>
       <tr>
        <td class="code">
         <pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br/><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">""</span>&gt;</span></span><br/><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br/><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br/><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"IE=edge"</span>&gt;</span></span><br/><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width,initial-scale=1.0"</span>&gt;</span></span><br/><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>shadow dom<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br/><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br/><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br/><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>hello world<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br/><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"shadow"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br/><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br/><span class="line"><span class="javascript">      <span class="keyword">let</span> shadowDOM = <span class="built_in">document</span>.getElementById(<span class="string">'shadow'</span>).attachShadow({<!-- --><span class="attr">mode</span>: <span class="string">'closed'</span>}) <span class="comment">// 外界无法访问 </span></span></span><br/><span class="line"><span class="javascript">      <span class="keyword">let</span> pEle = <span class="built_in">document</span>.createElement(<span class="string">'p'</span>)</span></span><br/><span class="line"><span class="javascript">      pEle.innerHTML = <span class="string">'hello shadowDOM'</span></span></span><br/><span class="line"><span class="javascript">      <span class="keyword">let</span> styleEle = <span class="built_in">document</span>.createElement(<span class="string">'style'</span>)</span></span><br/><span class="line"><span class="javascript">      styleEle.textContent = <span class="string">`p{color:red} `</span></span></span><br/><span class="line"></span><br/><span class="line"><span class="javascript">      <span class="comment">// ![](https://img-blog.csdnimg.cn/img_convert/21e62bdfc6d28a07c2b65490909b8179.png)</span></span></span><br/><span class="line">      shadowDOM.appendChild(styleEle)</span><br/><span class="line">      shadowDOM.appendChild(pEle)</span><br/><span class="line"></span><br/><span class="line"><span class="javascript">      <span class="comment">// react vue 里面的弹框等因为挂载到body上 所以用shadowDOM不行 </span></span></span><br/><span class="line"><span class="javascript">      <span class="comment">// 会挂载到全局污染样式</span></span></span><br/><span class="line"><span class="javascript">      <span class="comment">//document.body.appendChild(pEle)</span></span></span><br/><span class="line"></span><br/><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br/><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br/><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br/></pre>
        </td>
       </tr>
      </tbody>
     </table>
    </figure>
    <blockquote>
     <p>
      <code>
       shadow DOM
      </code>
      内部的元素始终不会影响到它的外部元素，可以实现真正意义上的隔离
     </p>
    </blockquote>
    <h3 id="六、JS沙箱机制">
     <a class="headerlink" href="#六、JS沙箱机制" rel="nofollow" title="六、JS沙箱机制">
     </a>
     六、JS沙箱机制
    </h3>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/6cfe3a7ae2c3c042d7f354cc3aac8ef9.png"/>
    </p>
    <blockquote>
     <p>
      当运行子应用时应该跑在内部沙箱环境中
     </p>
    </blockquote>
    <ul>
     <li>
      快照沙箱，当应用沙箱挂载或卸载时记录快照，在切换时依据快照恢复环境 (无法支持多实例)
     </li>
     <li>
      <code>
       Proxy
      </code>
      代理沙箱，不影响全局环境
     </li>
    </ul>
    <h4 id="1-快照沙箱">
     <a class="headerlink" href="#1-快照沙箱" rel="nofollow" title="1.快照沙箱">
     </a>
     1.快照沙箱
    </h4>
    <ol>
     <li>
      激活时将当前window属性进行快照处理
     </li>
     <li>
      失活时用快照中的内容和当前window属性比对
     </li>
     <li>
      如果属性发生变化保存到
      <code>
       modifyPropsMap
      </code>
      中，并用快照还原window属性
     </li>
     <li>
      再次激活时，再次进行快照，并用上次修改的结果还原window属性
     </li>
    </ol>
    <figure class="highlight js">
     <table>
      <tbody>
       <tr>
        <td class="code">
         <pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SnapshotSandbox</span> </span>{<!-- --></span><br/><span class="line">    <span class="keyword">constructor</span>() {<!-- --></span><br/><span class="line">        <span class="keyword">this</span>.proxy = <span class="built_in">window</span>; </span><br/><span class="line">        <span class="keyword">this</span>.modifyPropsMap = {}; <span class="comment">// 修改了哪些属性</span></span><br/><span class="line">        <span class="keyword">this</span>.active();</span><br/><span class="line">    }</span><br/><span class="line">    active() {<!-- --></span><br/><span class="line">        <span class="keyword">this</span>.windowSnapshot = {}; <span class="comment">// window对象的快照</span></span><br/><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> prop <span class="keyword">in</span> <span class="built_in">window</span>) {<!-- --></span><br/><span class="line">            <span class="keyword">if</span> (<span class="built_in">window</span>.hasOwnProperty(prop)) {<!-- --></span><br/><span class="line">                <span class="comment">// 将window上的属性进行拍照</span></span><br/><span class="line">                <span class="keyword">this</span>.windowSnapshot[prop] = <span class="built_in">window</span>[prop];</span><br/><span class="line">   }</span><br/><span class="line">        }</span><br/><span class="line">        <span class="built_in">Object</span>.keys(<span class="keyword">this</span>.modifyPropsMap).forEach(<span class="function"><span class="params">p</span> =&gt;</span> {<!-- --></span><br/><span class="line">            <span class="built_in">window</span>[p] = <span class="keyword">this</span>.modifyPropsMap[p];</span><br/><span class="line">        });</span><br/><span class="line">    }</span><br/><span class="line">    inactive() {<!-- --></span><br/><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> prop <span class="keyword">in</span> <span class="built_in">window</span>) { <span class="comment">// diff 差异</span></span><br/><span class="line">            <span class="keyword">if</span> (<span class="built_in">window</span>.hasOwnProperty(prop)) {<!-- --></span><br/><span class="line">                <span class="comment">// 将上次拍照的结果和本次window属性做对比</span></span><br/><span class="line">                <span class="keyword">if</span> (<span class="built_in">window</span>[prop] !== <span class="keyword">this</span>.windowSnapshot[prop]) {<!-- --></span><br/><span class="line">                    <span class="comment">// 保存修改后的结果</span></span><br/><span class="line">                    <span class="keyword">this</span>.modifyPropsMap[prop] = <span class="built_in">window</span>[prop]; </span><br/><span class="line">                    <span class="comment">// 还原window</span></span><br/><span class="line">                    <span class="built_in">window</span>[prop] = <span class="keyword">this</span>.windowSnapshot[prop]; </span><br/><span class="line">                }</span><br/><span class="line">            }</span><br/><span class="line">        }</span><br/><span class="line">    }</span><br/><span class="line">}</span><br/></pre>
        </td>
       </tr>
      </tbody>
     </table>
    </figure>
    <figure class="highlight js">
     <table>
      <tbody>
       <tr>
        <td class="code">
         <pre><span class="line"><span class="keyword">let</span> sandbox = <span class="keyword">new</span> SnapshotSandbox();</span><br/><span class="line">(<span class="function">(<span class="params"><span class="built_in">window</span></span>) =&gt;</span> {<!-- --></span><br/><span class="line">    <span class="built_in">window</span>.a = <span class="number">1</span>;</span><br/><span class="line">    <span class="built_in">window</span>.b = <span class="number">2</span>;</span><br/><span class="line">    <span class="built_in">window</span>.c = <span class="number">3</span></span><br/><span class="line">    <span class="built_in">console</span>.log(a,b,c)</span><br/><span class="line">    sandbox.inactive();</span><br/><span class="line">    <span class="built_in">console</span>.log(a,b,c)</span><br/><span class="line">})(sandbox.proxy);</span><br/></pre>
        </td>
       </tr>
      </tbody>
     </table>
    </figure>
    <blockquote>
     <p>
      快照沙箱只能针对单实例应用场景，如果是多个实例同时挂载的情况则无法解决，这时只能通过Proxy代理沙箱来实现
     </p>
    </blockquote>
    <h4 id="2-Proxy-代理沙箱">
     <a class="headerlink" href="#2-Proxy-代理沙箱" rel="nofollow" title="2.Proxy 代理沙箱">
     </a>
     2.Proxy 代理沙箱
    </h4>
    <figure class="highlight js">
     <table>
      <tbody>
       <tr>
        <td class="code">
         <pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProxySandbox</span> </span>{<!-- --></span><br/><span class="line">    <span class="keyword">constructor</span>() {<!-- --></span><br/><span class="line">        <span class="keyword">const</span> rawWindow = <span class="built_in">window</span>;</span><br/><span class="line">        <span class="keyword">const</span> fakeWindow = {}</span><br/><span class="line">        <span class="keyword">const</span> proxy = <span class="keyword">new</span> <span class="built_in">Proxy</span>(fakeWindow, {<!-- --></span><br/><span class="line">            <span class="keyword">set</span>(target, p, value) {<!-- --></span><br/><span class="line">                target[p] = value;</span><br/><span class="line">                <span class="keyword">return</span> <span class="literal">true</span></span><br/><span class="line">            },</span><br/><span class="line">            <span class="keyword">get</span>(target, p) {<!-- --></span><br/><span class="line">                <span class="keyword">return</span> target[p] || rawWindow[p];</span><br/><span class="line">            }</span><br/><span class="line">        });</span><br/><span class="line">        <span class="keyword">this</span>.proxy = proxy</span><br/><span class="line">    }</span><br/><span class="line">}</span><br/><span class="line"><span class="keyword">let</span> sandbox1 = <span class="keyword">new</span> ProxySandbox();</span><br/><span class="line"><span class="keyword">let</span> sandbox2 = <span class="keyword">new</span> ProxySandbox();</span><br/><span class="line"><span class="built_in">window</span>.a = <span class="number">1</span>;</span><br/><span class="line">(<span class="function">(<span class="params"><span class="built_in">window</span></span>) =&gt;</span> {<!-- --></span><br/><span class="line">    <span class="built_in">window</span>.a = <span class="string">'hello'</span>;</span><br/><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">window</span>.a)</span><br/><span class="line">})(sandbox1.proxy);</span><br/><span class="line">(<span class="function">(<span class="params"><span class="built_in">window</span></span>) =&gt;</span> {<!-- --></span><br/><span class="line">    <span class="built_in">window</span>.a = <span class="string">'world'</span>;</span><br/><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">window</span>.a)</span><br/><span class="line">})(sandbox2.proxy);</span><br/></pre>
        </td>
       </tr>
      </tbody>
     </table>
    </figure>
    <blockquote>
     <p>
      每个应用都创建一个
      <code>
       proxy
      </code>
      来代理
      <code>
       window
      </code>
      对象，好处是每个应用都是相对独立的，不需要直接更改全局的
      <code>
       window
      </code>
      属性
     </p>
    </blockquote>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f:2f626c6f672e6373646e2e6e65742f64656d6f74616e67312f:61727469636c652f64657461696c732f313339353233313437" class_="artid" style="display:none">
 </p>
</div>
