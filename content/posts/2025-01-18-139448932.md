---
layout: post
title: "一文搞懂Java应用ProtoBuf协议"
date: 2025-01-18 04:10:05 +0800
description: "本文将从ProtoBuf的概念开始介绍，ProtoBuf即谷歌自"
keywords: "java proto"
categories: ['未分类']
tags: ['网络协议', '开发语言', '后端', 'Java']
artid: "139448932"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=139448932
    alt: "一文搞懂Java应用ProtoBuf协议"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=139448932
featuredImagePreview: https://bing.ee123.net/img/rand?artid=139448932
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     一文搞懂Java应用ProtoBuf协议
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <div class="toc">
     <h4>
      文章目录
     </h4>
     <ul>
      <li>
       <a href="#JavaProtoBuf_3" rel="nofollow">
        一文搞懂Java应用ProtoBuf协议
       </a>
      </li>
      <li>
       <ul>
        <li>
         <a href="#_5" rel="nofollow">
          一、序言
         </a>
        </li>
        <li>
         <a href="#_13" rel="nofollow">
          二、基础概念
         </a>
        </li>
        <li>
         <ul>
          <li>
           <a href="#1ProtoBuf_15" rel="nofollow">
            1、何为ProtoBuf
           </a>
          </li>
          <li>
           <ul>
            <li>
             <a href="#11__23" rel="nofollow">
              1.1 优劣性
             </a>
            </li>
           </ul>
          </li>
          <li>
           <a href="#2ProtoBuf_29" rel="nofollow">
            2、ProtoBuf文件语法
           </a>
          </li>
          <li>
           <ul>
            <li>
             <a href="#21__52" rel="nofollow">
              2.1 基本结构
             </a>
            </li>
            <li>
             <a href="#22__69" rel="nofollow">
              2.2 字段规则
             </a>
            </li>
            <li>
             <a href="#23__78" rel="nofollow">
              2.3 字段类型
             </a>
            </li>
            <li>
             <ul>
              <li>
               <a href="#231__82" rel="nofollow">
                2.3.1 标量类型
               </a>
              </li>
              <li>
               <a href="#232__95" rel="nofollow">
                2.3.2 复合类型
               </a>
              </li>
             </ul>
            </li>
            <li>
             <a href="#24__152" rel="nofollow">
              2.4 字段编号
             </a>
            </li>
           </ul>
          </li>
         </ul>
        </li>
        <li>
         <a href="#JavaProtoBuf_156" rel="nofollow">
          三、Java操作ProtoBuf
         </a>
        </li>
        <li>
         <ul>
          <li>
           <a href="#1protoJava_158" rel="nofollow">
            1、生成proto对应Java文件
           </a>
          </li>
          <li>
           <ul>
            <li>
             <a href="#11__160" rel="nofollow">
              1.1 下载编译器
             </a>
            </li>
            <li>
             <a href="#12_proto_168" rel="nofollow">
              1.2 编写proto文件
             </a>
            </li>
            <li>
             <a href="#13_Java_200" rel="nofollow">
              1.3 输出Java文件
             </a>
            </li>
           </ul>
          </li>
          <li>
           <a href="#2_217" rel="nofollow">
            2、引入第三方依赖库
           </a>
          </li>
          <li>
           <a href="#3_238" rel="nofollow">
            3、编写测试类
           </a>
          </li>
          <li>
           <ul>
            <li>
             <a href="#31__240" rel="nofollow">
              3.1 序列化
             </a>
            </li>
            <li>
             <a href="#32__272" rel="nofollow">
              3.2 反序列化
             </a>
            </li>
            <li>
             <a href="#33__291" rel="nofollow">
              3.3 完整测试结果
             </a>
            </li>
           </ul>
          </li>
         </ul>
        </li>
        <li>
         <a href="#_352" rel="nofollow">
          四、后记
         </a>
        </li>
       </ul>
      </li>
     </ul>
    </div>
    <p>
    </p>
    <hr/>
    <h2>
     <a id="JavaProtoBuf_3">
     </a>
     一文搞懂Java应用ProtoBuf协议
    </h2>
    <h3>
     <a id="_5">
     </a>
     一、序言
    </h3>
    <p>
     我们日常写代码，服务之间的接口交互基本使用的都是JSON格式的数据，其可读性及易用性都较好，对于其它格式的协议研究过少，最近经手的项目涉及到与其它公司进行数据汇总，数据的访问频率非常高且数据量较大，除引入Kafka等消息中间件外，另计划将通信协议格式调整为谷歌的ProtoBuf协议。
    </p>
    <p>
     小豪近期也简要研究了一下ProtoBuf，本文将从ProtoBuf的概念开始介绍，逐步带大家搞清楚如何使用Java操作ProtoBuf协议，旨在帮助大家快速上手Protobuf的基本使用。本文大纲如下：
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/5b7d120eae032e5145c0e5a2b4098336.png#pic_center"/>
    </p>
    <h3>
     <a id="_13">
     </a>
     二、基础概念
    </h3>
    <h4>
     <a id="1ProtoBuf_15">
     </a>
     1、何为ProtoBuf
    </h4>
    <p>
     百度百科对它的介绍的是：Protocol Buffers（简称ProtoBuf）是Google公司开发的一种数据描述语言，类似于XML能够将结构化数据序列化，可用于数据存储、通信协议等方面。它不依赖于语言和平台并且可扩展性极强。现阶段官方支持C++、JAVA、Python、Objective C、C#、Ruby、PHP、JavaScript八种编程语言，还可以找到大量的几乎涵盖所有语言的第三方拓展包。
    </p>
    <p>
     Protocol Buffers在谷歌被广泛用于各种结构化信息存储和交换。Protocol Buffers作为一个自定义的远程过程调用（RPC）系统，用于在谷歌几乎所有的设备间的通信。
    </p>
    <blockquote>
     <p>
      <strong>
       简要理解，ProtoBuf即谷歌自己制定的一种数据格式，类似于Json、XML等
      </strong>
     </p>
    </blockquote>
    <h5>
     <a id="11__23">
     </a>
     1.1 优劣性
    </h5>
    <p>
     谷歌制定的ProtoBuf最大的优势就是高效性，不同于Json和XML使用文本进行数据编码，ProtoBuf采用二进制进行编码，其传输速度、解析速度都比较快，序列化后的体积也更小。
    </p>
    <p>
     但相较于Json和XML，其可读性太差了，只能通过反序列化得到可读的数据内容，另外通用性也较差，只在谷歌内部用的比较多。
    </p>
    <h4>
     <a id="2ProtoBuf_29">
     </a>
     2、ProtoBuf文件语法
    </h4>
    <p>
     这里我们首先编写一个简要的ProtoBuf文件，内容如下，文件名为
     <code>
      userInfo.proto
     </code>
     ，文件内容如下：
    </p>
    <pre><code class="prism language-lua">syntax <span class="token operator">=</span> <span class="token string">"proto3"</span><span class="token punctuation">;</span>
<span class="token operator">//</span> 表示生成的序列化器的Java包
option java_package <span class="token operator">=</span> <span class="token string">"com.example.hgspb.pbmodel"</span><span class="token punctuation">;</span>
<span class="token operator">//</span> 表示生成的Java序列化器的类名
option java_outer_classname <span class="token operator">=</span> <span class="token string">"UserInfoFactory"</span><span class="token punctuation">;</span>

message <span class="token function">UserInfo</span> <span class="token punctuation">{<!-- --></span>
	required int64 id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	string name <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
	EnumSex sex <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

enum <span class="token function">EnumSex</span> <span class="token punctuation">{<!-- --></span>
	SEX_MAN <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	<span class="token operator">//</span> 男
	SEX_WOMAN <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>	<span class="token operator">//</span> 女
<span class="token punctuation">}</span>
</code></pre>
    <h5>
     <a id="21__52">
     </a>
     2.1 基本结构
    </h5>
    <p>
     ProtoBuf语法结构如下：
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/cb5ff66d6e46bcc84ae077c13887b54d.jpeg#pic_center"/>
    </p>
    <ol>
     <li>
      <strong>
       语法版本
      </strong>
      ：首行
      <code>
       syntax = "proto3"
      </code>
      代表当前使用的是
      <code>
       proto3
      </code>
      规范的语法
     </li>
     <li>
      <strong>
       包名
      </strong>
      ：第二、三行代表输出Java文件之后的对应的包以及类名（注：生成的Java类名不要与
      <code>
       message
      </code>
      声明的消息名称一致）
     </li>
     <li>
      <strong>
       消息定义
      </strong>
      ：剩下的其它行代表
      <code>
       message
      </code>
      消息结构与
      <code>
       enum
      </code>
      枚举类型。
     </li>
    </ol>
    <p>
     其中
     <code>
      message
     </code>
     关键字，作用为定义一种消息类型，类似于Java中定义
     <code>
      Class
     </code>
     实体类一样，
     <code>
      message
     </code>
     里面定义所包含的属性，属性由
     <strong>
      字段规则、字段类型、字段名称和字段编号
     </strong>
     组成。
    </p>
    <pre><code class="prism language-java"><span class="token comment">// 属性格式</span>
<span class="token punctuation">[</span>字段规则<span class="token punctuation">]</span> 字段类型 字段名称 <span class="token operator">=</span> 字段标识符<span class="token punctuation">;</span>
</code></pre>
    <h5>
     <a id="22__69">
     </a>
     2.2 字段规则
    </h5>
    <p>
     字段规则类似于MySQL中的约束，即对数据的限制条件。
    </p>
    <p>
     ProtoBuf常见的约束有以下几种：
    </p>
    <ol>
     <li>
      <strong>
       singular
      </strong>
      ：字段可以出现
      <code>
       0
      </code>
      次或出现
      <code>
       1
      </code>
      次（不得超过
      <code>
       1
      </code>
      次），
      <code>
       proto3
      </code>
      语法默认的字段规则
     </li>
     <li>
      <strong>
       repeated
      </strong>
      ：字段可以出现任意多次（包括
      <code>
       0
      </code>
      次），类似于Java中的集合
     </li>
    </ol>
    <h5>
     <a id="23__78">
     </a>
     2.3 字段类型
    </h5>
    <p>
     字段类型包括常用的标量类型与复合类型。
    </p>
    <h6>
     <a id="231__82">
     </a>
     2.3.1 标量类型
    </h6>
    <p>
     标量类型类似于Java中的基本类型，对应关系如下表所示：
    </p>
    <table>
     <thead>
      <tr>
       <th align="left">
        ProtoBuf类型
       </th>
       <th align="left">
        Java类型
       </th>
       <th align="left">
        默认值
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td align="left">
        int32
       </td>
       <td align="left">
        int
       </td>
       <td align="left">
        0
       </td>
      </tr>
      <tr>
       <td align="left">
        int64
       </td>
       <td align="left">
        long
       </td>
       <td align="left">
        0L
       </td>
      </tr>
      <tr>
       <td align="left">
        float
       </td>
       <td align="left">
        float
       </td>
       <td align="left">
        0.0F
       </td>
      </tr>
      <tr>
       <td align="left">
        double
       </td>
       <td align="left">
        double
       </td>
       <td align="left">
        0.0D
       </td>
      </tr>
      <tr>
       <td align="left">
        bool
       </td>
       <td align="left">
        boolean
       </td>
       <td align="left">
        false
       </td>
      </tr>
      <tr>
       <td align="left">
        string
       </td>
       <td align="left">
        String
       </td>
       <td align="left">
        “”
       </td>
      </tr>
     </tbody>
    </table>
    <h6>
     <a id="232__95">
     </a>
     2.3.2 复合类型
    </h6>
    <p>
     复合类型可以是其它
     <code>
      message
     </code>
     消息，或
     <code>
      enum
     </code>
     枚举等，类似于Java中的引用类型。
    </p>
    <p>
     这里分别列举一下Java中
     <code>
      List
     </code>
     、
     <code>
      Map
     </code>
     等数据结构在ProtoBuf中的用法：
    </p>
    <p>
     ① 引用其它
     <code>
      message
     </code>
     消息、
     <code>
      enum
     </code>
     枚举：
    </p>
    <pre><code class="prism language-lua">message <span class="token function">UserInfo</span> <span class="token punctuation">{<!-- --></span>
	<span class="token operator">//</span> 字段类型为UserDetail消息名
	UserDetail detail <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token operator">//</span> 字段类型为EnumSex枚举
	EnumSex sex <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

message <span class="token function">UserDetail</span> <span class="token punctuation">{<!-- --></span>
	int64 id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	string name <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

enum <span class="token function">EnumSex</span> <span class="token punctuation">{<!-- --></span>
	SEX_MAN <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	<span class="token operator">//</span> 男（枚举编号默认从<span class="token number">0</span>开始）
	SEX_WOMAN <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>	<span class="token operator">//</span> 女
<span class="token punctuation">}</span>
</code></pre>
    <p>
     ②引用
     <code>
      List
     </code>
     集合：
    </p>
    <pre><code class="prism language-lua">message <span class="token function">UserList</span> <span class="token punctuation">{<!-- --></span>
	<span class="token operator">//</span> 声明字段规则为repeated，字段类型为UserInfo，即为List集合
	<span class="token operator">//</span> 等价于 <span class="token operator">=</span><span class="token operator">&gt;</span> List<span class="token operator">&lt;</span>UserDetail<span class="token operator">&gt;</span>
	repeated UserDetail detailList <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

message <span class="token function">UserDetail</span> <span class="token punctuation">{<!-- --></span>
	int64 id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	string name <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     ③引用
     <code>
      Map
     </code>
     集合：
    </p>
    <pre><code class="prism language-lua">message <span class="token function">UserCache</span> <span class="token punctuation">{<!-- --></span>
	<span class="token operator">//</span> 字段类型为map，即为Map集合
	<span class="token operator">//</span> 等价于 <span class="token operator">=</span><span class="token operator">&gt;</span> Map<span class="token operator">&lt;</span>Long<span class="token punctuation">,</span> UserDetail<span class="token operator">&gt;</span>
	map<span class="token operator">&lt;</span>int64<span class="token punctuation">,</span> UserDetail<span class="token operator">&gt;</span> userCacheMap <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

message <span class="token function">UserDetail</span> <span class="token punctuation">{<!-- --></span>
	int64 id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	string name <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h5>
     <a id="24__152">
     </a>
     2.4 字段编号
    </h5>
    <p>
     字段编号即字段的唯一标识，从
     <code>
      1
     </code>
     开始编号，后续ProtoBuf传递时，实际上传递是就是该编号而非字段名
    </p>
    <h3>
     <a id="JavaProtoBuf_156">
     </a>
     三、Java操作ProtoBuf
    </h3>
    <h4>
     <a id="1protoJava_158">
     </a>
     1、生成proto对应Java文件
    </h4>
    <h5>
     <a id="11__160">
     </a>
     1.1 下载编译器
    </h5>
    <p>
     首先我们需要下载ProtoBuf编译器，小豪这里下载的是21.10版本win64位的（
     <a href="https://github.com/protocolbuffers/protobuf/releases/download/v21.10/protoc-21.10-win64.zip">
      github下载地址在这
     </a>
     ）
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/4dcb05333f56ebe0ede347cd8f9eef5d.jpeg#pic_center"/>
    </p>
    <p>
     下载后直接解压即可。
    </p>
    <h5>
     <a id="12_proto_168">
     </a>
     1.2 编写proto文件
    </h5>
    <p>
     之后编写好对应的proto文件，这里我们直接使用下面的proto文件：
    </p>
    <pre><code class="prism language-lua">syntax <span class="token operator">=</span> <span class="token string">"proto3"</span><span class="token punctuation">;</span>
<span class="token operator">//</span> 表示生成的序列化器的Java包
option java_package <span class="token operator">=</span> <span class="token string">"com.example.hgspb.pbmodel"</span><span class="token punctuation">;</span>
<span class="token operator">//</span> 表示生成的Java序列化器的类名
option java_outer_classname <span class="token operator">=</span> <span class="token string">"UserFactory"</span><span class="token punctuation">;</span>

message <span class="token function">UserCache</span> <span class="token punctuation">{<!-- --></span>

	<span class="token operator">//</span> 声明字段规则为repeated，字段类型为UserInfo，即为List集合
	<span class="token operator">//</span> 等价于 <span class="token operator">=</span><span class="token operator">&gt;</span> List<span class="token operator">&lt;</span>UserDetail<span class="token operator">&gt;</span>
	repeated UserInfo userCacheList <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	
	<span class="token operator">//</span> 字段类型为map，即为Map集合
	<span class="token operator">//</span> 等价于 <span class="token operator">=</span><span class="token operator">&gt;</span> Map<span class="token operator">&lt;</span>Long<span class="token punctuation">,</span> UserDetail<span class="token operator">&gt;</span>
	map<span class="token operator">&lt;</span>int64<span class="token punctuation">,</span> UserInfo<span class="token operator">&gt;</span> userCacheMap <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

message <span class="token function">UserInfo</span> <span class="token punctuation">{<!-- --></span>
	int64 id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	string name <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     将proto文件放置于下载的ProtoBuf编译器的
     <code>
      bin
     </code>
     目录下：
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/1b0ad1af55bcb00b69c4345895be76d8.jpeg#pic_center"/>
    </p>
    <h5>
     <a id="13_Java_200">
     </a>
     1.3 输出Java文件
    </h5>
    <p>
     执行
     <code>
      protoc.exe --java_out=./ user.proto
     </code>
     命令
    </p>
    <pre><code class="prism language-java"><span class="token comment">// 编译Java文件语法规范</span>
protoc<span class="token punctuation">.</span>exe <span class="token operator">--</span>java_out<span class="token operator">=</span><span class="token punctuation">.</span>/ proto文件名
</code></pre>
    <p>
     如图，会在我们配置的输出包名路径下，生成对应的Java文件：
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/7530c33508bc98b1d4c494ee9f954622.jpeg#pic_center"/>
    </p>
    <p>
     拷贝到我们项目中即可。
    </p>
    <blockquote>
     <p>
      另外，IDEA也内置ProtoBuf相关插件，可通过插件生成对应的Java文件，但配置过程较为繁琐
     </p>
    </blockquote>
    <h4>
     <a id="2_217">
     </a>
     2、引入第三方依赖库
    </h4>
    <p>
     操作ProtoBuf，我们需要在
     <code>
      maven
     </code>
     中引入两个
     <code>
      Jar
     </code>
     包：
    </p>
    <pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.google.protobuf<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>protobuf-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.21.10<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.google.protobuf<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>protobuf-java-util<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.21.10<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre>
    <blockquote>
     <p>
      这里对应的
      <code>
       Jar
      </code>
      版本必须要与下载的ProtoBuf编译器版本保持一直，否则会报错。
     </p>
     <p>
      如刚才我们下载的编译器版本为protoc-21.10，使用proto3语法，这里对应的
      <code>
       Jar
      </code>
      包版本即为3.21.10版本
     </p>
    </blockquote>
    <h4>
     <a id="3_238">
     </a>
     3、编写测试类
    </h4>
    <h5>
     <a id="31__240">
     </a>
     3.1 序列化
    </h5>
    <p>
     序列化一般分为4步：
    </p>
    <p>
     ①创建对象构造器，使用
     <code>
      newBuilder()
     </code>
     方法：
    </p>
    <pre><code class="prism language-java"><span class="token comment">// 创建对象构造器</span>
<span class="token class-name">UserFactory<span class="token punctuation">.</span>UserInfo<span class="token punctuation">.</span>Builder</span> userInfoBuild <span class="token operator">=</span> <span class="token class-name">UserFactory<span class="token punctuation">.</span>UserInfo</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     ②为对象属性赋值，使用
     <code>
      setter()
     </code>
     方法：
    </p>
    <pre><code class="prism language-java"><span class="token comment">// 属性赋值</span>
userInfoBuild<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"xiaohao"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     ③构造对象，使用对象构造器的
     <code>
      build()
     </code>
     方法：
    </p>
    <pre><code class="prism language-java"><span class="token comment">// 构造对象</span>
<span class="token class-name">UserFactory<span class="token punctuation">.</span>UserInfo</span> userInfo <span class="token operator">=</span> userInfoBuild<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     ④序列化Java对象，使用对象的
     <code>
      toByteArray()
     </code>
     方法：
    </p>
    <pre><code class="prism language-java"><span class="token comment">// 转换为字节数组</span>
<span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> userInfoBytes <span class="token operator">=</span> userInfo<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <h5>
     <a id="32__272">
     </a>
     3.2 反序列化
    </h5>
    <p>
     序列化一般分为2步：
    </p>
    <p>
     ①反序列为Java对象，使用
     <code>
      parseFrom()
     </code>
     方法：
    </p>
    <pre><code class="prism language-java"><span class="token comment">// 反序列化为Java对象</span>
<span class="token class-name">UserFactory<span class="token punctuation">.</span>UserInfo</span> userInfoRes <span class="token operator">=</span> <span class="token class-name">UserFactory<span class="token punctuation">.</span>UserInfo</span><span class="token punctuation">.</span><span class="token function">parseFrom</span><span class="token punctuation">(</span>userInfoBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     ②获取对象属性值，使用
     <code>
      getter()
     </code>
     方法：
    </p>
    <pre><code class="prism language-java"><span class="token comment">// 获取属性值</span>
<span class="token keyword">long</span> id <span class="token operator">=</span> userInfoRes<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> name <span class="token operator">=</span> userInfoRes<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <h5>
     <a id="33__291">
     </a>
     3.3 完整测试结果
    </h5>
    <pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">// 序列化：</span>
    <span class="token comment">// 创建userInfo对象构造器</span>
    <span class="token class-name">UserFactory<span class="token punctuation">.</span>UserInfo<span class="token punctuation">.</span>Builder</span> userInfoBuild <span class="token operator">=</span> <span class="token class-name">UserFactory<span class="token punctuation">.</span>UserInfo</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 属性赋值</span>
    userInfoBuild<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"xiaohao"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 构造userInfo对象</span>
    <span class="token class-name">UserFactory<span class="token punctuation">.</span>UserInfo</span> userInfo <span class="token operator">=</span> userInfoBuild<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 创建userCache对象构造器</span>
    <span class="token class-name">UserFactory<span class="token punctuation">.</span>UserCache<span class="token punctuation">.</span>Builder</span> userCacheBuild <span class="token operator">=</span> <span class="token class-name">UserFactory<span class="token punctuation">.</span>UserCache</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 属性赋值：userCacheList集合</span>
    userCacheBuild<span class="token punctuation">.</span><span class="token function">addUserCacheList</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    userCacheBuild<span class="token punctuation">.</span><span class="token function">addUserCacheList</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 属性赋值：userCacheMap集合</span>
    userCacheBuild<span class="token punctuation">.</span><span class="token function">putUserCacheMap</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 构造userCache对象</span>
    <span class="token class-name">UserFactory<span class="token punctuation">.</span>UserCache</span> userCache <span class="token operator">=</span> userCacheBuild<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 转换为字节数组</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> userCacheBytes <span class="token operator">=</span> userCache<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"序列化结果userCacheBytes："</span> <span class="token operator">+</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>userCacheBytes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"---------------------------------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 反序列化：</span>
    <span class="token class-name">UserFactory<span class="token punctuation">.</span>UserCache</span> userCacheRes <span class="token operator">=</span> <span class="token class-name">UserFactory<span class="token punctuation">.</span>UserCache</span><span class="token punctuation">.</span><span class="token function">parseFrom</span><span class="token punctuation">(</span>userCacheBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取userCacheList集合</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserFactory<span class="token punctuation">.</span>UserInfo</span><span class="token punctuation">&gt;</span></span> userCacheList <span class="token operator">=</span> userCacheRes<span class="token punctuation">.</span><span class="token function">getUserCacheListList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取userCacheMap集合</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">UserFactory<span class="token punctuation">.</span>UserInfo</span><span class="token punctuation">&gt;</span></span> userCacheMap <span class="token operator">=</span> userCacheRes<span class="token punctuation">.</span><span class="token function">getUserCacheMapMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"反序列化结果userCacheList："</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    userCacheList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>u <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>u<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"反序列化结果userCacheMap："</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    userCacheMap<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> v<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>k <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre>
    <p>
     控制台输出：
    </p>
    <pre><code class="prism language-java">序列化结果userCacheBytes：<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">120</span><span class="token punctuation">,</span> <span class="token number">105</span><span class="token punctuation">,</span> <span class="token number">97</span><span class="token punctuation">,</span> <span class="token number">111</span><span class="token punctuation">,</span> <span class="token number">104</span><span class="token punctuation">,</span> <span class="token number">97</span><span class="token punctuation">,</span> <span class="token number">111</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">120</span><span class="token punctuation">,</span> <span class="token number">105</span><span class="token punctuation">,</span> <span class="token number">97</span><span class="token punctuation">,</span> <span class="token number">111</span><span class="token punctuation">,</span> <span class="token number">104</span><span class="token punctuation">,</span> <span class="token number">97</span><span class="token punctuation">,</span> <span class="token number">111</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">120</span><span class="token punctuation">,</span> <span class="token number">105</span><span class="token punctuation">,</span> <span class="token number">97</span><span class="token punctuation">,</span> <span class="token number">111</span><span class="token punctuation">,</span> <span class="token number">104</span><span class="token punctuation">,</span> <span class="token number">97</span><span class="token punctuation">,</span> <span class="token number">111</span><span class="token punctuation">]</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
反序列化结果userCacheList：id<span class="token operator">:</span> <span class="token number">1</span>
name<span class="token operator">:</span> <span class="token string">"xiaohao"</span>

id<span class="token operator">:</span> <span class="token number">1</span>
name<span class="token operator">:</span> <span class="token string">"xiaohao"</span>

反序列化结果userCacheMap：<span class="token number">1</span><span class="token operator">:</span>id<span class="token operator">:</span> <span class="token number">1</span>
name<span class="token operator">:</span> <span class="token string">"xiaohao"</span>
</code></pre>
    <h3>
     <a id="_352">
     </a>
     四、后记
    </h3>
    <p>
     本文从ProtoBuf的基础概念介绍开始，最后引申到Java操作ProtoBuf协议，其最大的特点就是体积小、传输高效，一方面由于其使用二进制方式存储，另一方面其采用
     <strong>
      TLV
     </strong>
     （Tag-Length-Value）数据编码格式，进一步压缩了字节占用，从而减小了传输开销。
    </p>
    <p>
     本文内容作为随笔，也希望能帮助到初学者，如果大家觉得内容对你有帮助，不妨考虑点点赞，关注关注小豪，后续小豪将会继续更新其它Java相关文章~
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c:6f672e6373646e2e6e65742f6d6d313237343838393739322f:61727469636c652f64657461696c732f313339343438393332" class_="artid" style="display:none">
 </p>
</div>


