---
layout: post
title: "FastGPT原理分析-数据集创建第一步"
date: 2025-03-14 08:21:06 +0800
description: "本文介绍了FastGpt创建数据集的总体流程，并详细分析了第一步的实现步骤和实现原理。可以看到，这一步只是把数据放到了Mongodb的训练队列的表中，那么，当数据插入到Mongodb后，该如何处理这些数据？而处理这些数据的任务又是如何触发的呢？这些实现的原理和逻辑，在下一篇文章中进行分析。"
keywords: "FastGPT原理分析-数据集创建第一步"
categories: ['大模型Llm']
tags: ['语言模型', '大模型', '人工智能', 'Llm']
artid: "146248030"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146248030
    alt: "FastGPT原理分析-数据集创建第一步"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146248030
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146248030
cover: https://bing.ee123.net/img/rand?artid=146248030
image: https://bing.ee123.net/img/rand?artid=146248030
img: https://bing.ee123.net/img/rand?artid=146248030
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     FastGPT原理分析-数据集创建第一步
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h4>
     <a id="_0">
     </a>
     概述
    </h4>
    <p>
     FastGPT的文件上传过程分为两个阶段：第一个阶段：是文件上传。第二个阶段：是对文件进行向量化处理和QA化处理。本文介绍文件上传的总体流程，并对创建数据集的第一步的详细实现逻辑进行分析。
    </p>
    <h4>
     <a id="_4">
     </a>
     数据集创建总体流程
    </h4>
    <p>
     数据集创建分为两个步骤：
    </p>
    <ol>
     <li>
      第一步：文件上传和预处理，插入记录到mongodb的训练队列dataset_trainings表中。
     </li>
     <li>
      第二步：监控mongodb的插入操作，并启动数据处理：(1)嵌入向量的计算或(2)QA文本拆分。
     </li>
    </ol>
    <pre><code>// 创建数据集并插入mongodb的数据表中
createCollectionAndInsertData
   -&gt; pushDataListToTrainingQueue // 将数据集数据推送到训练队列

// 注册处理函数，并自动处理数据
startMongoWatch
   -&gt; createDatasetTrainingMongoWatch // 监控mongodb的插入操作，触发文本处理任务
      -&gt; generateQA(); # QA问答对的处理
      -&gt; generateVector();  # 嵌入向量处理
</code></pre>
    <h4>
     <a id="_23">
     </a>
     数据集创建第一步的实现
    </h4>
    <p>
     数据集创建的第一步就是上传文件并对数据进行预处理，然后获取相关数据处理的参数，并把参数保存到mongodb的训练队列中。后续的处理任务，会根据数据集的处理配置来调用相应的模型或服务进行处理。数据集处理第一步的主要逻辑如下：
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/0a798dfcc2044c069b97041b62ec1a9e.png#pic_center"/>
    </p>
    <h4>
     <a id="_29">
     </a>
     数据创建第一步实现逻辑
    </h4>
    <p>
     创建数据集是在createCollectionAndInsertData函数中进行处理的，该函数又主要调用了pushDataListToTrainingQueue，该函数的实现逻辑如下：
    </p>
    <ol>
     <li>
      <strong>
       模型验证与配置
      </strong>
      ：
     </li>
    </ol>
    <ul>
     <li>
      验证参数中的推理大模型和嵌入向量大模型是否有效。
     </li>
     <li>
      根据训练模式（chunk/qa/auto）设置最大token数和权重
     </li>
     <li>
      如果模型无效或训练模式无效，会抛出错误
     </li>
    </ul>
    <ol start="2">
     <li>
      <strong>
       数据预处理
      </strong>
      ：
     </li>
    </ol>
    <ul>
     <li>
      使用
      <code>
       simpleText
      </code>
      函数清理问题和答案中的空白字符
     </li>
     <li>
      处理索引数据，同样进行文本清理
     </li>
     <li>
      过滤掉空问题、重复内容和超过最大token限制的数据
     </li>
     <li>
      将数据分类为成功、过长、重复和错误四类
     </li>
    </ul>
    <ol start="3">
     <li>
      <strong>
       数据插入
      </strong>
     </li>
    </ol>
    <ul>
     <li>
      使用批量插入的方式将数据插入到MongoDB中，每批200条
     </li>
     <li>
      如果批量插入失败，会记录失败的文档并尝试单独插入
     </li>
     <li>
      支持在传入的session中执行，如果没有传入session则创建新的事务
     </li>
    </ul>
    <p>
     这个函数主要用于将数据集数据预处理后插入到训练队列中，确保数据的有效性和完整性，同时支持事务处理以保证数据一致性。
    </p>
    <h4>
     <a id="_54">
     </a>
     数据创建第一步主要实现源码分析
    </h4>
    <pre><code>export async function pushDataListToTrainingQueue({

  // 验证模型配置：检查agentModel和vectorModel的有效性，设置最大token数和权重。
  const { model, maxToken, weight } = await (async () =&gt; {
    const agentModelData = getLLMModel(agentModel);
    if (!agentModelData) {
      return Promise.reject(`File model ${agentModel} is inValid`);
    }
    const vectorModelData = getVectorModel(vectorModel);
    if (!vectorModelData) {
      return Promise.reject(`Vector model ${vectorModel} is inValid`);
    }
    
</code></pre>
    <ul>
     <li>
      设置最大token数和权重
     </li>
    </ul>
    <pre><code class="prism language-typescript">    <span class="token keyword">if</span> <span class="token punctuation">(</span>trainingMode <span class="token operator">===</span> TrainingModeEnum<span class="token punctuation">.</span>chunk<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>
        maxToken<span class="token operator">:</span> vectorModelData<span class="token punctuation">.</span>maxToken <span class="token operator">*</span> <span class="token number">1.5</span><span class="token punctuation">,</span>
        model<span class="token operator">:</span> vectorModelData<span class="token punctuation">.</span>model<span class="token punctuation">,</span>
        weight<span class="token operator">:</span> vectorModelData<span class="token punctuation">.</span>weight
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>trainingMode <span class="token operator">===</span> TrainingModeEnum<span class="token punctuation">.</span>qa <span class="token operator">||</span> trainingMode <span class="token operator">===</span> TrainingModeEnum<span class="token punctuation">.</span>auto<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>
        maxToken<span class="token operator">:</span> agentModelData<span class="token punctuation">.</span>maxContext <span class="token operator">*</span> <span class="token number">0.8</span><span class="token punctuation">,</span>
        model<span class="token operator">:</span> agentModelData<span class="token punctuation">.</span>model<span class="token punctuation">,</span>
        weight<span class="token operator">:</span> <span class="token number">0</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
    <ul>
     <li>
      过滤过长或重复的内容
     </li>
    </ul>
    <pre><code class="prism language-typescript">  <span class="token comment">// 过滤重复和过长的内容</span>
  <span class="token comment">// filter repeat or equal content</span>
  <span class="token keyword">const</span> set <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> filterResult<span class="token operator">:</span> Record<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> PushDatasetDataChunkProps<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    success<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    overToken<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    repeat<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    error<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <ul>
     <li>
      处理QA问答对的，并去掉空的字符
     </li>
    </ul>
    <pre><code class="prism language-typescript">  <span class="token comment">// format q and a, remove empty char</span>
  data<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    item<span class="token punctuation">.</span>q <span class="token operator">=</span> <span class="token function">simpleText</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span>
    item<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token function">simpleText</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre>
    <ul>
     <li>
      批量插入mongodb的dataset_trainings表中
     </li>
    </ul>
    <pre><code class="prism language-typescript">  <span class="token comment">// 使用 insertMany 批量插入</span>
  <span class="token comment">// 数据插入：批量插入数据（每批200条）</span>
  <span class="token keyword">const</span> batchSize <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token function-variable function">insertData</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>startIndex<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> session<span class="token operator">:</span> ClientSession<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> list <span class="token operator">=</span> filterResult<span class="token punctuation">.</span>success<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>startIndex<span class="token punctuation">,</span> startIndex <span class="token operator">+</span> batchSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>list<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">await</span> MongoDatasetTraining<span class="token punctuation">.</span><span class="token function">insertMany</span><span class="token punctuation">(</span>
        list<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
</code></pre>
    <h4>
     <a id="_142">
     </a>
     总结
    </h4>
    <p>
     本文介绍了FastGpt创建数据集的总体流程，并详细分析了第一步的实现步骤和实现原理。可以看到，这一步只是把数据放到了Mongodb的训练队列的表中，那么，当数据插入到Mongodb后，该如何处理这些数据？而处理这些数据的任务又是如何触发的呢？这些实现的原理和逻辑，在下一篇文章中进行分析。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a:2f2f626c6f672e6373646e2e6e65742f7a675f686f7665722f:61727469636c652f64657461696c732f313436323438303330" class_="artid" style="display:none">
 </p>
</div>


