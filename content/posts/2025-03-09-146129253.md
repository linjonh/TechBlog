---
layout: post
title: "Flink实时特征工程"
date: 2025-03-09 11:23:50 +0800
description: "参考文档：https://developer.aliyun.com/article/1176024。"
keywords: "Flink实时特征工程"
categories: ['未分类']
tags: ['大数据', 'Flink']
artid: "146129253"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146129253
    alt: "Flink实时特征工程"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146129253
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146129253
cover: https://bing.ee123.net/img/rand?artid=146129253
image: https://bing.ee123.net/img/rand?artid=146129253
img: https://bing.ee123.net/img/rand?artid=146129253
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Flink实时特征工程
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h4>
     <a id="Flink_0">
     </a>
     <strong>
      一、写在前面：为什么实时特征工程需要Flink？
     </strong>
    </h4>
    <h5>
     <a id="11__2">
     </a>
     <strong>
      1.1 传统批处理的痛点
     </strong>
    </h5>
    <ul>
     <li>
      <strong>
       场景错配
      </strong>
      ：用户行为数据（点击/加购）天然是流式的，T+1统计导致特征时效性差（昨天用户加购的商品，今天才进入推荐系统）
     </li>
     <li>
      <strong>
       资源浪费
      </strong>
      ：凌晨集中跑批时集群压力大，白天资源闲置
     </li>
     <li>
      <strong>
       业务响应慢
      </strong>
      ：新活动效果评估要等次日，无法实时调整策略
     </li>
    </ul>
    <h5>
     <a id="12_Flink_7">
     </a>
     <strong>
      1.2 Flink的杀手锏
     </strong>
    </h5>
    <ul>
     <li>
      <strong>
       真正的流处理
      </strong>
      ：数据像水流一样持续处理（对比Spark Streaming的微批）
     </li>
     <li>
      <strong>
       事件时间语义
      </strong>
      ：处理乱序数据不乱（双十一订单可能延迟到达）
     </li>
     <li>
      <strong>
       状态管理
      </strong>
      ：记住用户最近30次点击（没有Redis也能玩转上下文特征）
     </li>
     <li>
      <strong>
       Exactly-Once
      </strong>
      ：金融级精度保障（不会重复扣款）
     </li>
     <li>
      <strong>
       高吞吐低延迟
      </strong>
      ：单节点每秒处理百万条，亚秒级延迟（实测每秒处理20W条用户行为日志，P99延迟&lt;500ms）
     </li>
    </ul>
    <hr/>
    <h4>
     <a id="Flink_16">
     </a>
     <strong>
      二、Flink实时特征工程架构解剖
     </strong>
    </h4>
    <h5>
     <a id="21__18">
     </a>
     <strong>
      2.1 典型架构图
     </strong>
    </h5>
    <pre><code>[Kafka] --&gt; [Flink SQL ETL] --&gt; [特征存储(HBase/Redis)] --&gt; [在线服务]
         |--&gt; [实时数仓(Doris)] 
         |--&gt; [监控告警(Prometheus)]
</code></pre>
    <h5>
     <a id="22__25">
     </a>
     <strong>
      2.2 核心组件详解
     </strong>
    </h5>
    <ul>
     <li>
      <p>
       <strong>
        Source层
       </strong>
       ：
      </p>
      <ul>
       <li>
        Kafka（主流选择，需关注Consumer Group偏移量管理）
       </li>
       <li>
        自定义Source（兼容埋点SDK直传场景）
       </li>
       <li>
        CDC（MySQL Binlog实时捕获，适合订单特征）
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        Processing层
       </strong>
       ：
      </p>
      <ul>
       <li>
        <strong>
         Operator Chains
        </strong>
        ：算子链优化（减少序列化开销）
       </li>
       <li>
        <strong>
         Watermark机制
        </strong>
        ：对付延迟数据的"时间沙漏"（允许乱序3秒）
       </li>
       <li>
        <strong>
         State Backend
        </strong>
        ：
        <ul>
         <li>
          MemoryStateBackend（本地调试用）
         </li>
         <li>
          RocksDB（生产标配，支持增量Checkpoint）
         </li>
         <li>
          自定义状态后端（对接外部存储如Cassandra）
         </li>
        </ul>
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        Sink层
       </strong>
       ：
      </p>
      <ul>
       <li>
        <strong>
         Keyed存储
        </strong>
        ：用户维度特征入Redis（String/Hash结构）
       </li>
       <li>
        <strong>
         OLAP存储
        </strong>
        ：Doris/ClickHouse存聚合特征（供BI实时分析）
       </li>
       <li>
        <strong>
         回撤流处理
        </strong>
        ：维表JOIN时处理更新的技巧（避免特征漂移）
       </li>
      </ul>
     </li>
    </ul>
    <hr/>
    <h4>
     <a id="_46">
     </a>
     <strong>
      三、时间窗口的十八般武艺
     </strong>
    </h4>
    <h5>
     <a id="31_Tumbling_48">
     </a>
     <strong>
      3.1 滚动窗口（Tumbling）
     </strong>
    </h5>
    <ul>
     <li>
      <strong>
       适用场景
      </strong>
      ：每分钟UV统计
     </li>
     <li>
      <strong>
       代码示例
      </strong>
      ：
     </li>
    </ul>
    <pre><code class="prism language-java">windowedStream <span class="token operator">=</span> dataStream
  <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token class-name">UserBehavior</span><span class="token operator">::</span><span class="token function">getUserId</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token class-name">TumblingEventTimeWindows</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">minutes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <h5>
     <a id="32_Sliding_57">
     </a>
     <strong>
      3.2 滑动窗口（Sliding）
     </strong>
    </h5>
    <ul>
     <li>
      <strong>
       特殊配置
      </strong>
      ：窗口大小=10min，滑动步长=1min（内存消耗需警惕）
     </li>
     <li>
      <strong>
       优化技巧
      </strong>
      ：复用窗口计算结果（增量聚合函数）
     </li>
    </ul>
    <h5>
     <a id="33_Session_61">
     </a>
     <strong>
      3.3 会话窗口（Session）
     </strong>
    </h5>
    <ul>
     <li>
      <strong>
       动态特性
      </strong>
      ：用户两次操作间隔超5min则拆分会话
     </li>
     <li>
      <strong>
       参数调优
      </strong>
      ：gap时间设置影响内存占用（长会话需状态清理策略）
     </li>
    </ul>
    <h5>
     <a id="34_Global_65">
     </a>
     <strong>
      3.4 全局窗口（Global）
     </strong>
    </h5>
    <ul>
     <li>
      <strong>
       高阶用法
      </strong>
      ：配合触发器实现TopN统计（每100条触发计算）
     </li>
    </ul>
    <hr/>
    <h4>
     <a id="_70">
     </a>
     <strong>
      四、状态管理的生存指南
     </strong>
    </h4>
    <h5>
     <a id="41__72">
     </a>
     <strong>
      4.1 状态类型
     </strong>
    </h5>
    <ul>
     <li>
      <strong>
       ValueState
      </strong>
      ：存储单个值（用户最后登录时间）
     </li>
     <li>
      <strong>
       ListState
      </strong>
      ：存储列表（最近10次搜索关键词）
     </li>
     <li>
      <strong>
       MapState
      </strong>
      ：键值对（商品ID -&gt; 点击次数）
     </li>
     <li>
      <strong>
       AggregatingState
      </strong>
      ：自定义聚合（维护复杂统计对象）
     </li>
    </ul>
    <h5>
     <a id="42__78">
     </a>
     <strong>
      4.2 状态容错
     </strong>
    </h5>
    <ul>
     <li>
      <p>
       <strong>
        Checkpoint流程
       </strong>
       ：
      </p>
      <ol>
       <li>
        JobManager发起Checkpoint请求
       </li>
       <li>
        Source插入Barrier（类似水流中的分隔标记）
       </li>
       <li>
        算子异步快照状态
       </li>
       <li>
        全链路确认后提交
       </li>
      </ol>
     </li>
     <li>
      <p>
       <strong>
        恢复策略
       </strong>
       ：
      </p>
      <ul>
       <li>
        全量恢复：从最近完成的Checkpoint重启
       </li>
       <li>
        增量恢复（RocksDB专属优势）
       </li>
      </ul>
     </li>
    </ul>
    <h5>
     <a id="43__89">
     </a>
     <strong>
      4.3 状态过期
     </strong>
    </h5>
    <ul>
     <li>
      <strong>
       TTL配置
      </strong>
      ：
     </li>
    </ul>
    <pre><code class="prism language-java"><span class="token class-name">StateTtlConfig</span> ttlConfig <span class="token operator">=</span> <span class="token class-name">StateTtlConfig</span>
    <span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">days</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">setUpdateType</span><span class="token punctuation">(</span><span class="token class-name">OnCreateAndWrite</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">cleanupInRocksdbCompactFilter</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <hr/>
    <h4>
     <a id="_101">
     </a>
     <strong>
      五、实战：电商用户画像特征生成
     </strong>
    </h4>
    <h5>
     <a id="51__103">
     </a>
     <strong>
      5.1 需求拆解
     </strong>
    </h5>
    <ul>
     <li>
      <strong>
       短期兴趣
      </strong>
      ：最近1小时点击类目分布
     </li>
     <li>
      <strong>
       长期偏好
      </strong>
      ：过去30天购买品牌TOP3
     </li>
     <li>
      <strong>
       实时特征
      </strong>
      ：当前购物车金额
     </li>
    </ul>
    <h5>
     <a id="52__108">
     </a>
     <strong>
      5.2 代码实现
     </strong>
    </h5>
    <pre><code class="prism language-java"><span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserBehavior</span><span class="token punctuation">&gt;</span></span> stream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">addSource</span><span class="token punctuation">(</span>kafkaSource<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 实时计算购物车总金额</span>
<span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CartTotal</span><span class="token punctuation">&gt;</span></span> cartFeatures <span class="token operator">=</span> stream
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>behavior <span class="token operator">-&gt;</span> <span class="token string">"cart"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>behavior<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token class-name">UserBehavior</span><span class="token operator">::</span><span class="token function">getUserId</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CartAggregator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 近1小时类目偏好（滑动窗口）</span>
<span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryPref</span><span class="token punctuation">&gt;</span></span> cateFeatures <span class="token operator">=</span> stream
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>behavior <span class="token operator">-&gt;</span> <span class="token string">"click"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>behavior<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token class-name">UserBehavior</span><span class="token operator">::</span><span class="token function">getUserId</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token class-name">SlidingEventTimeWindows</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">hours</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">minutes</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CategoryAggregate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 维表关联商品信息</span>
cartFeatures<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>itemDimStream<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>cart <span class="token operator">-&gt;</span> cart<span class="token punctuation">.</span><span class="token function">getItemId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dim <span class="token operator">-&gt;</span> dim<span class="token punctuation">.</span><span class="token function">getItemId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ItemEnrichment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <h5>
     <a id="53__131">
     </a>
     <strong>
      5.3 性能优化
     </strong>
    </h5>
    <ul>
     <li>
      <strong>
       旁路缓存
      </strong>
      ：维表查询增加Guava Cache（减少DB压力）
     </li>
     <li>
      <strong>
       异步IO
      </strong>
      ：提升Redis查询吞吐（实测QPS提升8倍）
     </li>
     <li>
      <strong>
       批量写入
      </strong>
      ：攒批10ms或满100条写入HBase
     </li>
    </ul>
    <hr/>
    <h4>
     <a id="_138">
     </a>
     <strong>
      六、生产环境避坑大全
     </strong>
    </h4>
    <h5>
     <a id="61__140">
     </a>
     <strong>
      6.1 反压定位
     </strong>
    </h5>
    <ul>
     <li>
      <strong>
       监控指标
      </strong>
      ：
      <code>
       outQueueUsage
      </code>
      &gt; 0.8 告警
     </li>
     <li>
      <strong>
       排查步骤
      </strong>
      ：
      <ol>
       <li>
        Checkpoint时长是否激增
       </li>
       <li>
        查看火焰图定位热点代码
       </li>
       <li>
        检查外部系统吞吐（如HBase是否限流）
       </li>
      </ol>
     </li>
    </ul>
    <h5>
     <a id="62__147">
     </a>
     <strong>
      6.2 内存调优
     </strong>
    </h5>
    <ul>
     <li>
      <strong>
       配置参数
      </strong>
      ：
     </li>
    </ul>
    <pre><code class="prism language-yaml"><span class="token key atrule">taskmanager.memory.process.size</span><span class="token punctuation">:</span> 4096m
<span class="token key atrule">taskmanager.memory.managed.fraction</span><span class="token punctuation">:</span> <span class="token number">0.4</span>
</code></pre>
    <ul>
     <li>
      <strong>
       GC优化
      </strong>
      ：G1垃圾回收器 + 适当增大堆内存
     </li>
    </ul>
    <h5>
     <a id="63__155">
     </a>
     <strong>
      6.3 数据倾斜
     </strong>
    </h5>
    <ul>
     <li>
      <strong>
       预聚合
      </strong>
      ：在LocalKeyBy阶段做局部聚合
     </li>
     <li>
      <strong>
       加盐打散
      </strong>
      ：对热点Key添加随机后缀
     </li>
     <li>
      <strong>
       维度升级
      </strong>
      ：将用户维特征提升到设备维度
     </li>
    </ul>
    <hr/>
    <h4>
     <a id="Flink_116__162">
     </a>
     <strong>
      七、Flink 1.16 新特性应用
     </strong>
    </h4>
    <h5>
     <a id="71__164">
     </a>
     <strong>
      7.1 自适应批处理
     </strong>
    </h5>
    <ul>
     <li>
      <strong>
       动态调整
      </strong>
      ：根据数据量自动切换流/批模式
     </li>
     <li>
      <strong>
       资源节省
      </strong>
      ：小批量数据减少Checkpoint开销
     </li>
    </ul>
    <h5>
     <a id="72__168">
     </a>
     <strong>
      7.2 混合源支持
     </strong>
    </h5>
    <ul>
     <li>
      <strong>
       统一API
      </strong>
      ：同一Job中处理有界/无界数据
     </li>
    </ul>
    <pre><code class="prism language-java"><span class="token class-name">FileSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> source <span class="token operator">=</span> <span class="token class-name">FileSource</span>
    <span class="token punctuation">.</span><span class="token function">forRecordStreamFormat</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TextLineFormat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Path</span><span class="token punctuation">.</span><span class="token function">fromLocalFile</span><span class="token punctuation">(</span>testDir<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <h5>
     <a id="73__176">
     </a>
     <strong>
      7.3 增强的窗口语义
     </strong>
    </h5>
    <ul>
     <li>
      <strong>
       会话窗口优化
      </strong>
      ：支持基于计数的会话切割
     </li>
     <li>
      <strong>
       窗口合并策略
      </strong>
      ：自定义相邻窗口合并逻辑
     </li>
    </ul>
    <hr/>
    <h4>
     <a id="_182">
     </a>
     <strong>
      八、实践
     </strong>
    </h4>
    <h5>
     <a id="81__184">
     </a>
     <strong>
      8.1 监控体系搭建
     </strong>
    </h5>
    <ul>
     <li>
      <strong>
       核心指标
      </strong>
      ：
      <ul>
       <li>
        消费延迟（Kafka Lag）
       </li>
       <li>
        Checkpoint成功率
       </li>
       <li>
        算子背压比例
       </li>
      </ul>
     </li>
     <li>
      <strong>
       可视化方案
      </strong>
      ：Grafana + Prometheus 自定义看板
     </li>
    </ul>
    <h5>
     <a id="82__191">
     </a>
     <strong>
      8.2 混沌工程实践
     </strong>
    </h5>
    <ul>
     <li>
      <strong>
       故障注入
      </strong>
      ：
      <ul>
       <li>
        随机Kill TaskManager
       </li>
       <li>
        模拟网络分区
       </li>
       <li>
        制造高延迟数据
       </li>
      </ul>
     </li>
    </ul>
    <h5>
     <a id="83__197">
     </a>
     <strong>
      8.3 成本控制
     </strong>
    </h5>
    <ul>
     <li>
      <strong>
       自动扩缩容
      </strong>
      ：根据Kafka堆积量动态调整并行度
     </li>
     <li>
      <strong>
       冷热分离
      </strong>
      ：7天前的特征转存至OSS降低成本
     </li>
    </ul>
    <hr/>
    <p>
     参考文档：https://developer.aliyun.com/article/1176024
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f34313036373739362f:61727469636c652f64657461696c732f313436313239323533" class_="artid" style="display:none">
 </p>
</div>


