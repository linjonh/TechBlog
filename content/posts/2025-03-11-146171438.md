---
layout: post
title: "pop_dialog_statestate-State弹出对话栈并返回到主助手,让整个对话流程图可以明确追踪对话流,并将控制权委派给特定的子对话图"
date: 2025-03-11 10:13:46 +0800
description: "这段代码的主要目的是在对话系统中实现“退出当前技能/子对话”的功能。通过调用 `pop_dialog_state` 函数：- **更新对话状态**：将当前状态设置为 `\"pop\"`，表示回退到上一层或主对话状态。- **发送恢复消息**：生成一条工具消息，提示系统回到主助手，并提醒主助手查看历史对话以便继续辅助用户。- **连接对话图节点**：通过添加节点和边，将此状态变化集成到整个对话流程图中，使系统能自动将对话权交还给主助手。例如，当用户在使用航班查询技能后决定退出并交回主助手时，系统会通过该"
keywords: "pop_dialog_state(state: State)弹出对话栈并返回到主助手，让整个对话流程图可以明确追踪对话流，并将控制权委派给特定的子对话图。"
categories: ['Langgraph']
tags: ['Tools', 'Python', 'Langgraph', 'Agent']
artid: "146171438"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146171438
    alt: "pop_dialog_statestate-State弹出对话栈并返回到主助手,让整个对话流程图可以明确追踪对话流,并将控制权委派给特定的子对话图"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146171438
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146171438
cover: https://bing.ee123.net/img/rand?artid=146171438
image: https://bing.ee123.net/img/rand?artid=146171438
img: https://bing.ee123.net/img/rand?artid=146171438
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     pop_dialog_state(state: State)弹出对话栈并返回到主助手，让整个对话流程图可以明确追踪对话流，并将控制权委派给特定的子对话图。
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h3>
     <a id="_0">
     </a>
     示例代码：
    </h3>
    <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">pop_dialog_state</span><span class="token punctuation">(</span>state<span class="token punctuation">:</span> State<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">dict</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""弹出对话栈并返回到主助手。

    这让整个对话流程图可以明确追踪对话流，并将控制权委派给特定的子对话图。
    """</span>
    messages <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">if</span> state<span class="token punctuation">[</span><span class="token string">"messages"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tool_calls<span class="token punctuation">:</span>
        <span class="token comment"># 注意：目前没有处理 llm 并行调用工具的边缘情况</span>
        messages<span class="token punctuation">.</span>append<span class="token punctuation">(</span>
            ToolMessage<span class="token punctuation">(</span>
                content<span class="token operator">=</span><span class="token string">"恢复与主助手的对话。请回顾过去的对话内容，并根据需要协助用户。"</span><span class="token punctuation">,</span>
                tool_call_id<span class="token operator">=</span>state<span class="token punctuation">[</span><span class="token string">"messages"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tool_calls<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"id"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"dialog_state"</span><span class="token punctuation">:</span> <span class="token string">"pop"</span><span class="token punctuation">,</span>
        <span class="token string">"messages"</span><span class="token punctuation">:</span> messages<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

self<span class="token punctuation">.</span>builder<span class="token punctuation">.</span>add_node<span class="token punctuation">(</span><span class="token string">"leave_skill"</span><span class="token punctuation">,</span> pop_dialog_state<span class="token punctuation">)</span>
self<span class="token punctuation">.</span>builder<span class="token punctuation">.</span>add_edge<span class="token punctuation">(</span><span class="token string">"leave_skill"</span><span class="token punctuation">,</span> <span class="token string">"primary_assistant"</span><span class="token punctuation">)</span>

</code></pre>
    <hr/>
    <h4>
     <a id="_29">
     </a>
     详细解释
    </h4>
    <ol>
     <li>
      <p>
       <strong>
        函数定义与文档字符串
       </strong>
      </p>
      <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">pop_dialog_state</span><span class="token punctuation">(</span>state<span class="token punctuation">:</span> State<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">dict</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""弹出对话栈并返回到主助手。

    这让整个对话流程图可以明确追踪对话流，并将控制权委派给特定的子对话图。
    """</span>
</code></pre>
      <ul>
       <li>
        <strong>
         作用
        </strong>
        ：定义了一个名为
        <code>
         pop_dialog_state
        </code>
        的函数，该函数接收一个
        <code>
         state
        </code>
        对象，并返回一个字典。
       </li>
       <li>
        <strong>
         目的
        </strong>
        ：当对话过程中需要结束当前子对话或技能，并返回主助手接管对话时，就会调用这个函数。
       </li>
       <li>
        <strong>
         解释
        </strong>
        ：所谓“弹出对话栈”就是结束当前技能的状态，恢复到上一级（主助手）的控制状态。
       </li>
       <li>
        <strong>
         举例
        </strong>
        ：如果用户正在使用某个子技能（如航班查询），而后决定结束该技能，系统就会调用这个函数返回到主助手。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        初始化消息列表
       </strong>
      </p>
      <pre><code class="prism language-python">messages <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</code></pre>
      <ul>
       <li>
        <strong>
         作用
        </strong>
        ：创建一个空列表，用于存储后续生成的消息。
       </li>
       <li>
        <strong>
         解释
        </strong>
        ：在返回的字典中，这个列表会包含需要发送给用户的工具消息。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        判断是否存在工具调用
       </strong>
      </p>
      <pre><code class="prism language-python"><span class="token keyword">if</span> state<span class="token punctuation">[</span><span class="token string">"messages"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tool_calls<span class="token punctuation">:</span>
</code></pre>
      <ul>
       <li>
        <strong>
         作用
        </strong>
        ：检查
        <code>
         state
        </code>
        对象中最后一条消息是否包含工具调用（
        <code>
         tool_calls
        </code>
        ）。
       </li>
       <li>
        <strong>
         解释
        </strong>
        ：只有当最后一条消息中有工具调用信息时，才需要生成一条恢复对话的消息。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        生成工具消息
       </strong>
      </p>
      <pre><code class="prism language-python">messages<span class="token punctuation">.</span>append<span class="token punctuation">(</span>
    ToolMessage<span class="token punctuation">(</span>
        content<span class="token operator">=</span><span class="token string">"恢复与主助手的对话。请回顾过去的对话内容，并根据需要协助用户。"</span><span class="token punctuation">,</span>
        tool_call_id<span class="token operator">=</span>state<span class="token punctuation">[</span><span class="token string">"messages"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tool_calls<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"id"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre>
      <ul>
       <li>
        <strong>
         作用
        </strong>
        ：创建一个
        <code>
         ToolMessage
        </code>
        对象，并将其添加到
        <code>
         messages
        </code>
        列表中。
       </li>
       <li>
        <strong>
         ToolMessage 内容说明
        </strong>
        ：
        <ul>
         <li>
          <strong>
           “恢复与主助手的对话”
          </strong>
          ：说明当前对话将回到主助手，由主助手接管。
         </li>
         <li>
          <strong>
           “请回顾过去的对话内容，并根据需要协助用户”
          </strong>
          ：提示主助手参考之前的对话记录，继续协助用户解决问题。
         </li>
        </ul>
       </li>
       <li>
        <strong>
         工具调用 ID
        </strong>
        ：
        <ul>
         <li>
          从
          <code>
           state["messages"][-1].tool_calls[0]["id"]
          </code>
          中提取 ID，用于标识此次工具调用的关联信息。
         </li>
        </ul>
       </li>
       <li>
        <strong>
         举例
        </strong>
        ：假设
        <code>
         state["messages"][-1].tool_calls[0]["id"]
        </code>
        的值为
        <code>
         "abc123"
        </code>
        ，那么生成的 ToolMessage 会带有
        <code>
         tool_call_id="abc123"
        </code>
        。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        返回新的对话状态和消息
       </strong>
      </p>
      <pre><code class="prism language-python"><span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"dialog_state"</span><span class="token punctuation">:</span> <span class="token string">"pop"</span><span class="token punctuation">,</span>
    <span class="token string">"messages"</span><span class="token punctuation">:</span> messages<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre>
      <ul>
       <li>
        <strong>
         作用
        </strong>
        ：构造一个字典，包含两个键：
        <ul>
         <li>
          <code>
           "dialog_state"
          </code>
          设置为
          <code>
           "pop"
          </code>
          ，表示当前对话状态已经弹出，返回到上一级对话。
         </li>
         <li>
          <code>
           "messages"
          </code>
          包含前面生成的工具消息列表。
         </li>
        </ul>
       </li>
       <li>
        <strong>
         解释
        </strong>
        ：这一步将更新系统的对话状态，同时传递消息，指示主助手接管对话。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        将节点和边添加到对话图中
       </strong>
      </p>
      <pre><code class="prism language-python">self<span class="token punctuation">.</span>builder<span class="token punctuation">.</span>add_node<span class="token punctuation">(</span><span class="token string">"leave_skill"</span><span class="token punctuation">,</span> pop_dialog_state<span class="token punctuation">)</span>
self<span class="token punctuation">.</span>builder<span class="token punctuation">.</span>add_edge<span class="token punctuation">(</span><span class="token string">"leave_skill"</span><span class="token punctuation">,</span> <span class="token string">"primary_assistant"</span><span class="token punctuation">)</span>
</code></pre>
      <ul>
       <li>
        <strong>
         作用
        </strong>
        ：
        <ul>
         <li>
          <code>
           add_node
          </code>
          将
          <code>
           pop_dialog_state
          </code>
          函数作为一个节点，命名为
          <code>
           "leave_skill"
          </code>
          。
         </li>
         <li>
          <code>
           add_edge
          </code>
          将
          <code>
           "leave_skill"
          </code>
          节点与
          <code>
           "primary_assistant"
          </code>
          节点连接起来。
         </li>
        </ul>
       </li>
       <li>
        <strong>
         解释
        </strong>
        ：
        <ul>
         <li>
          当对话流程经过
          <code>
           "leave_skill"
          </code>
          节点时，就会执行
          <code>
           pop_dialog_state
          </code>
          函数，更新对话状态。
         </li>
         <li>
          之后，对话流会继续沿着边转移到
          <code>
           "primary_assistant"
          </code>
          ，即让主助手重新控制对话。
         </li>
        </ul>
       </li>
       <li>
        <strong>
         举例
        </strong>
        ：假如用户结束了当前技能的使用，系统会调用
        <code>
         "leave_skill"
        </code>
        节点，执行
        <code>
         pop_dialog_state
        </code>
        ，然后自动转到主助手处理后续对话。
       </li>
      </ul>
     </li>
    </ol>
    <hr/>
    <h4>
     <a id="_102">
     </a>
     总结
    </h4>
    <p>
     这段代码的主要目的是在对话系统中实现“退出当前技能/子对话”的功能。通过调用
     <code>
      pop_dialog_state
     </code>
     函数：
    </p>
    <ul>
     <li>
      <strong>
       更新对话状态
      </strong>
      ：将当前状态设置为
      <code>
       "pop"
      </code>
      ，表示回退到上一层或主对话状态。
     </li>
     <li>
      <strong>
       发送恢复消息
      </strong>
      ：生成一条工具消息，提示系统回到主助手，并提醒主助手查看历史对话以便继续辅助用户。
     </li>
     <li>
      <strong>
       连接对话图节点
      </strong>
      ：通过添加节点和边，将此状态变化集成到整个对话流程图中，使系统能自动将对话权交还给主助手。
     </li>
    </ul>
    <p>
     例如，当用户在使用航班查询技能后决定退出并交回主助手时，系统会通过该方法将状态弹出，并将对话控制权切换给主助手，从而确保整个对话流程能够顺畅进行。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f:626c6f672e6373646e2e6e65742f753031333536353133332f:61727469636c652f64657461696c732f313436313731343338" class_="artid" style="display:none">
 </p>
</div>


