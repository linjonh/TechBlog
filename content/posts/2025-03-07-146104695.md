---
layout: post
title: "渗透测试基于时间的盲注Time-Based-Blind-SQL-Injection"
date: 2025-03-07 20:45:44 +0800
description: "基于时间的盲注（Time-Based Blind SQL Injection） 攻击语句，常见于对数据库的渗透测试或恶意攻击中"
keywords: "【渗透测试】基于时间的盲注（Time-Based Blind SQL Injection）"
categories: ['Java']
tags: ['数据库', 'Web', 'Sql']
artid: "146104695"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146104695
    alt: "渗透测试基于时间的盲注Time-Based-Blind-SQL-Injection"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146104695
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146104695
cover: https://bing.ee123.net/img/rand?artid=146104695
image: https://bing.ee123.net/img/rand?artid=146104695
img: https://bing.ee123.net/img/rand?artid=146104695
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     【渗透测试】基于时间的盲注（Time-Based Blind SQL Injection）
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h4>
     <a id="ERROR_0">
     </a>
     发生ERROR日志告警
    </h4>
    <p>
     查看系统日志如下：
    </p>
    <pre><code class="prism language-python">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>IllegalArgumentException<span class="token punctuation">:</span> Illegal character <span class="token keyword">in</span> query at index <span class="token number">203</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span><span class="token operator">//</span>api<span class="token punctuation">.</span>weixin<span class="token punctuation">.</span>qq<span class="token punctuation">.</span>com<span class="token operator">/</span>sns<span class="token operator">/</span>jscode2session?access_token<span class="token operator">=</span>90_Vap5zo5UTJS4jbuvneMkyS1LHwHAgrofaX8bnIfW8EHXA71IRZwsqzJam9bo1m3zRcSrbgCsG<span class="token operator">-</span>ydmu2HYWZiJEnR<span class="token operator">-</span>jTzTKW<span class="token operator">&amp;</span>js_code<span class="token operator">=</span>" OR <span class="token punctuation">(</span>SELECT<span class="token operator">*</span>FROM<span class="token punctuation">(</span>SELECT<span class="token punctuation">(</span>SLEEP<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>uczk<span class="token punctuation">)</span> limit <span class="token number">1</span><span class="token comment">#&amp;secret=75c3afd41c5216fb652a00f3&amp;grant_type=authorization_code&amp;appid=wxf84e2db9e488888</span>


用户登录及注册失败<span class="token operator">-</span>微信小程序 code<span class="token punctuation">:</span>0evbf4ac2ml2slzSF2Ybxm6 err<span class="token punctuation">:</span>错误代码：<span class="token number">40029</span><span class="token punctuation">,</span> 错误信息：code 无效，微信原始报文：<span class="token punctuation">{<!-- --></span><span class="token string">"errcode"</span><span class="token punctuation">:</span><span class="token number">40029</span><span class="token punctuation">,</span><span class="token string">"errmsg"</span><span class="token punctuation">:</span><span class="token string">"invalid code, rid: 67cae4aa-724ecdd5-123302e1"</span><span class="token punctuation">}</span>mdc<span class="token punctuation">:</span><span class="token punctuation">{<!-- --></span><span class="token string">"RequestId"</span><span class="token punctuation">:</span><span class="token string">""</span><span class="token punctuation">}</span>timestamp<span class="token punctuation">:</span><span class="token number">2025</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">07</span> <span class="token number">20</span><span class="token punctuation">:</span><span class="token number">20</span><span class="token punctuation">:</span><span class="token number">58.557</span>


public <span class="token keyword">class</span> <span class="token class-name">UserLoginReq</span> <span class="token punctuation">{<!-- --></span>

    <span class="token operator">/</span><span class="token operator">**</span>
     <span class="token operator">*</span> 微信小程序appid
     <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token decorator annotation punctuation">@NotNull</span><span class="token punctuation">(</span>message <span class="token operator">=</span> <span class="token string">"微信小程序appid不能为空"</span><span class="token punctuation">)</span>
    <span class="token decorator annotation punctuation">@Schema</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"Appid"</span><span class="token punctuation">,</span> title <span class="token operator">=</span> <span class="token string">"微信小程序appid"</span><span class="token punctuation">)</span>
    private String appid<span class="token punctuation">;</span>

    <span class="token operator">/</span><span class="token operator">**</span>
     <span class="token operator">*</span> 授权code  
     <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token decorator annotation punctuation">@NotNull</span><span class="token punctuation">(</span>message <span class="token operator">=</span> <span class="token string">"授权code不能为空"</span><span class="token punctuation">)</span>
    <span class="token decorator annotation punctuation">@Schema</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"Code"</span><span class="token punctuation">,</span> title <span class="token operator">=</span> <span class="token string">"授权code"</span><span class="token punctuation">)</span>
    private String code<span class="token punctuation">;</span>

    <span class="token operator">/</span><span class="token operator">**</span>
     <span class="token operator">*</span> 授权作用域
     <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token decorator annotation punctuation">@NotNull</span><span class="token punctuation">(</span>message <span class="token operator">=</span> <span class="token string">"授权作用域不能为空"</span><span class="token punctuation">)</span>
    <span class="token decorator annotation punctuation">@Schema</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"Scopes"</span><span class="token punctuation">,</span> title <span class="token operator">=</span> <span class="token string">"授权作用域"</span><span class="token punctuation">)</span>
    private Set<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> scopes<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

通过上述可以看出，渗透者通过调用登录接口请求参数，传递code参数值： OR <span class="token punctuation">(</span>SELECT<span class="token operator">*</span>FROM<span class="token punctuation">(</span>SELECT<span class="token punctuation">(</span>SLEEP<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>uczk<span class="token punctuation">)</span> limit <span class="token number">1</span>
进行渗透测试；
需要加强对code参数的校验！
</code></pre>
    <h4>
     <a id="SELECTFROMSELECTSLEEP4uczk_limit_1_39">
     </a>
     (SELECT*FROM(SELECT(SLEEP(4)))uczk) limit 1
    </h4>
    <h3>
     <a id="_TimeBased_Blind_SQL_Injection__40">
     </a>
     以上代码是一个典型的
     <strong>
      基于时间的盲注（Time-Based Blind SQL Injection）
     </strong>
     攻击语句，常见于对数据库的渗透测试或恶意攻击中。
    </h3>
    <h4>
     <a id="_43">
     </a>
     <strong>
      关键特征解析
     </strong>
    </h4>
    <ol>
     <li>
      <p>
       <strong>
        <code>
         SLEEP(4)
        </code>
        函数
       </strong>
       ：
      </p>
      <ul>
       <li>
        在 MySQL 中，
        <code>
         SLEEP(N)
        </code>
        会让数据库暂停执行
        <code>
         N
        </code>
        秒。攻击者通过观察页面响应时间是否延迟，间接判断注入是否成功（即使没有直接回显数据）。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        子查询结构
       </strong>
       ：
      </p>
      <ul>
       <li>
        <code>
         (SELECT * FROM (SELECT SLEEP(4)) uczk)
        </code>
        ：
        <ul>
         <li>
          内层
          <code>
           SELECT SLEEP(4)
          </code>
          生成一个单行单列的结果（值为
          <code>
           0
          </code>
          ，因为
          <code>
           SLEEP
          </code>
          返回执行结果）。
         </li>
         <li>
          外层
          <code>
           SELECT * FROM (...) uczk
          </code>
          中的
          <code>
           uczk
          </code>
          是子查询的别名（避免语法错误）。
         </li>
         <li>
          该子查询的目的是确保语法正确性，同时触发时间延迟。
         </li>
        </ul>
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        <code>
         OR
        </code>
        条件与
        <code>
         LIMIT 1
        </code>
       </strong>
       ：
      </p>
      <ul>
       <li>
        <code>
         OR
        </code>
        用于绕过原有查询条件（如登录验证），将原查询逻辑变为永真（
        <code>
         OR TRUE
        </code>
        ）。
       </li>
       <li>
        <code>
         LIMIT 1
        </code>
        确保只返回一行结果，避免因多行数据导致应用程序报错。
       </li>
      </ul>
     </li>
    </ol>
    <hr/>
    <h4>
     <a id="_59">
     </a>
     <strong>
      攻击原理
     </strong>
    </h4>
    <ul>
     <li>
      <strong>
       盲注场景
      </strong>
      ：当目标页面没有显式错误信息或数据回显时，攻击者通过时间差推断漏洞存在。
     </li>
     <li>
      <strong>
       执行过程
      </strong>
      ：
      <ol>
       <li>
        攻击者将恶意负载插入输入参数（如 URL、表单字段）。
       </li>
       <li>
        后端数据库执行拼接后的 SQL 语句，触发
        <code>
         SLEEP(4)
        </code>
        。
       </li>
       <li>
        若页面响应时间增加约 4 秒，则确认存在 SQL 注入漏洞。
       </li>
      </ol>
     </li>
    </ul>
    <hr/>
    <h4>
     <a id="_68">
     </a>
     <strong>
      防御建议
     </strong>
    </h4>
    <ol>
     <li>
      <strong>
       参数化查询（预编译语句）
      </strong>
      ：
      <pre><code class="prism language-python"><span class="token comment"># 正确示例（使用参数化查询）</span>
cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">"SELECT * FROM users WHERE id = %s"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>user_id<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
     </li>
     <li>
      <strong>
       输入过滤与白名单
      </strong>
      ：
      <ul>
       <li>
        对用户输入进行严格校验（如类型、长度、格式）。
       </li>
      </ul>
     </li>
     <li>
      <strong>
       最小化数据库权限
      </strong>
      ：
      <ul>
       <li>
        避免使用高权限账户连接数据库，限制
        <code>
         SLEEP
        </code>
        等危险函数的使用。
       </li>
      </ul>
     </li>
     <li>
      <strong>
       监控与日志审计
      </strong>
      ：
      <ul>
       <li>
        记录异常查询行为，及时告警长时间执行的 SQL 语句。
       </li>
      </ul>
     </li>
    </ol>
    <hr/>
    <h4>
     <a id="_83">
     </a>
     <strong>
      总结
     </strong>
    </h4>
    <p>
     该语句通过
     <code>
      SLEEP
     </code>
     函数制造时间延迟，属于典型的
     <strong>
      基于时间的盲注
     </strong>
     ，主要针对 MySQL 数据库。开发者需加强输入校验并使用参数化查询，从根本上杜绝此类攻击。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f34323433303934372f:61727469636c652f64657461696c732f313436313034363935" class_="artid" style="display:none">
 </p>
</div>


