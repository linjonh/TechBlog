---
layout: post
title: "介绍如何基于现有的可运行STGCNSpatial-Temporal-Graph-Convolutional-Network模型代码进行交通流预测的改动"
date: 2025-03-06 13:30:39 +0800
description: "数据准备：加载和预处理交通流数据，构建图结构。模型修改：确保STGCN模型适用于交通流预测任务。训练和评估：训练模型并评估其在交通流预测上的性能。通过以上步骤，你可以基于现有的STGCN模型代码进行交通流预测的改动。关键步骤包括数据准备、模型修改和训练评估。根据实际情况，你可能需要调整模型参数和超参数以获得更好的性能。"
keywords: "介绍如何基于现有的可运行STGCN（Spatial-Temporal Graph Convolutional Network）模型代码进行交通流预测的改动"
categories: ['深度学习', '大数据', 'Python']
tags: ['Python']
artid: "146067910"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146067910
    alt: "介绍如何基于现有的可运行STGCNSpatial-Temporal-Graph-Convolutional-Network模型代码进行交通流预测的改动"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146067910
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146067910
cover: https://bing.ee123.net/img/rand?artid=146067910
image: https://bing.ee123.net/img/rand?artid=146067910
img: https://bing.ee123.net/img/rand?artid=146067910
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     介绍如何基于现有的可运行STGCN（Spatial-Temporal Graph Convolutional Network）模型代码进行交通流预测的改动
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     下面将详细介绍如何基于现有的可运行STGCN（Spatial-Temporal Graph Convolutional Network）模型代码进行交通流预测的改动。STGCN是一种用于处理时空数据的深度学习模型，非常适合交通流预测任务。
    </p>
    <h4>
     <a id="_2">
     </a>
     步骤概述
    </h4>
    <ol>
     <li>
      <strong>
       数据准备
      </strong>
      ：加载和预处理交通流数据，构建图结构。
     </li>
     <li>
      <strong>
       模型修改
      </strong>
      ：确保STGCN模型适用于交通流预测任务。
     </li>
     <li>
      <strong>
       训练和评估
      </strong>
      ：训练模型并评估其在交通流预测上的性能。
     </li>
    </ol>
    <h4>
     <a id="_7">
     </a>
     详细步骤
    </h4>
    <h5>
     <a id="1__9">
     </a>
     1. 数据准备
    </h5>
    <p>
     首先，你需要准备交通流数据，通常以时间序列的形式表示，同时构建图结构来表示交通网络中节点之间的关系。以下是一个简单的数据加载和预处理示例：
    </p>
    <pre><code class="prism language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">import</span> torch

<span class="token comment"># 加载交通流数据</span>
data <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">'traffic_flow_data.csv'</span><span class="token punctuation">)</span>  <span class="token comment"># 假设数据存储在CSV文件中</span>
data <span class="token operator">=</span> data<span class="token punctuation">.</span>values  <span class="token comment"># 转换为NumPy数组</span>

<span class="token comment"># 划分训练集和测试集</span>
train_ratio <span class="token operator">=</span> <span class="token number">0.8</span>
train_size <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">*</span> train_ratio<span class="token punctuation">)</span>
train_data <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token punctuation">:</span>train_size<span class="token punctuation">]</span>
test_data <span class="token operator">=</span> data<span class="token punctuation">[</span>train_size<span class="token punctuation">:</span><span class="token punctuation">]</span>

<span class="token comment"># 数据归一化</span>
mean <span class="token operator">=</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>train_data<span class="token punctuation">)</span>
std <span class="token operator">=</span> np<span class="token punctuation">.</span>std<span class="token punctuation">(</span>train_data<span class="token punctuation">)</span>
train_data <span class="token operator">=</span> <span class="token punctuation">(</span>train_data <span class="token operator">-</span> mean<span class="token punctuation">)</span> <span class="token operator">/</span> std
test_data <span class="token operator">=</span> <span class="token punctuation">(</span>test_data <span class="token operator">-</span> mean<span class="token punctuation">)</span> <span class="token operator">/</span> std

<span class="token comment"># 构建图邻接矩阵</span>
<span class="token comment"># 这里假设你已经有了图的邻接矩阵，例如通过交通网络的拓扑结构得到</span>
adj_matrix <span class="token operator">=</span> np<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">'adj_matrix.npy'</span><span class="token punctuation">)</span>  <span class="token comment"># 加载邻接矩阵</span>
adj_matrix <span class="token operator">=</span> torch<span class="token punctuation">.</span>FloatTensor<span class="token punctuation">(</span>adj_matrix<span class="token punctuation">)</span>

<span class="token comment"># 生成训练和测试数据的输入输出序列</span>
<span class="token keyword">def</span> <span class="token function">generate_sequences</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> seq_length<span class="token punctuation">)</span><span class="token punctuation">:</span>
    inputs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    outputs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">-</span> seq_length<span class="token punctuation">)</span><span class="token punctuation">:</span>
        inputs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>data<span class="token punctuation">[</span>i<span class="token punctuation">:</span>i<span class="token operator">+</span>seq_length<span class="token punctuation">]</span><span class="token punctuation">)</span>
        outputs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>data<span class="token punctuation">[</span>i<span class="token operator">+</span>seq_length<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>inputs<span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>outputs<span class="token punctuation">)</span>

seq_length <span class="token operator">=</span> <span class="token number">12</span>  <span class="token comment"># 输入序列长度</span>
train_inputs<span class="token punctuation">,</span> train_outputs <span class="token operator">=</span> generate_sequences<span class="token punctuation">(</span>train_data<span class="token punctuation">,</span> seq_length<span class="token punctuation">)</span>
test_inputs<span class="token punctuation">,</span> test_outputs <span class="token operator">=</span> generate_sequences<span class="token punctuation">(</span>test_data<span class="token punctuation">,</span> seq_length<span class="token punctuation">)</span>

train_inputs <span class="token operator">=</span> torch<span class="token punctuation">.</span>FloatTensor<span class="token punctuation">(</span>train_inputs<span class="token punctuation">)</span>
train_outputs <span class="token operator">=</span> torch<span class="token punctuation">.</span>FloatTensor<span class="token punctuation">(</span>train_outputs<span class="token punctuation">)</span>
test_inputs <span class="token operator">=</span> torch<span class="token punctuation">.</span>FloatTensor<span class="token punctuation">(</span>test_inputs<span class="token punctuation">)</span>
test_outputs <span class="token operator">=</span> torch<span class="token punctuation">.</span>FloatTensor<span class="token punctuation">(</span>test_outputs<span class="token punctuation">)</span>
</code></pre>
    <h5>
     <a id="2__57">
     </a>
     2. 模型修改
    </h5>
    <p>
     确保现有的STGCN模型代码适用于交通流预测任务。以下是一个简单的STGCN模型示例：
    </p>
    <pre><code class="prism language-python"><span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>functional <span class="token keyword">as</span> F

<span class="token keyword">class</span> <span class="token class-name">ChebConv</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> in_channels<span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span> K<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>ChebConv<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>K <span class="token operator">=</span> K
        self<span class="token punctuation">.</span>in_channels <span class="token operator">=</span> in_channels
        self<span class="token punctuation">.</span>out_channels <span class="token operator">=</span> out_channels
        self<span class="token punctuation">.</span>weight <span class="token operator">=</span> nn<span class="token punctuation">.</span>Parameter<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>FloatTensor<span class="token punctuation">(</span>K<span class="token punctuation">,</span> in_channels<span class="token punctuation">,</span> out_channels<span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>bias <span class="token operator">=</span> nn<span class="token punctuation">.</span>Parameter<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>FloatTensor<span class="token punctuation">(</span>out_channels<span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>reset_parameters<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">reset_parameters</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        nn<span class="token punctuation">.</span>init<span class="token punctuation">.</span>xavier_uniform_<span class="token punctuation">(</span>self<span class="token punctuation">.</span>weight<span class="token punctuation">)</span>
        nn<span class="token punctuation">.</span>init<span class="token punctuation">.</span>zeros_<span class="token punctuation">(</span>self<span class="token punctuation">.</span>bias<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> L<span class="token punctuation">)</span><span class="token punctuation">:</span>
        batch_size<span class="token punctuation">,</span> num_nodes<span class="token punctuation">,</span> in_channels <span class="token operator">=</span> x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span>
        outputs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> b <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>batch_size<span class="token punctuation">)</span><span class="token punctuation">:</span>
            Tx_0 <span class="token operator">=</span> x<span class="token punctuation">[</span>b<span class="token punctuation">]</span>
            output <span class="token operator">=</span> torch<span class="token punctuation">.</span>matmul<span class="token punctuation">(</span>Tx_0<span class="token punctuation">,</span> self<span class="token punctuation">.</span>weight<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>K <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">:</span>
                Tx_1 <span class="token operator">=</span> torch<span class="token punctuation">.</span>matmul<span class="token punctuation">(</span>L<span class="token punctuation">,</span> Tx_0<span class="token punctuation">)</span>
                output <span class="token operator">+=</span> torch<span class="token punctuation">.</span>matmul<span class="token punctuation">(</span>Tx_1<span class="token punctuation">,</span> self<span class="token punctuation">.</span>weight<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword">for</span> k <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>K<span class="token punctuation">)</span><span class="token punctuation">:</span>
                Tx_2 <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> torch<span class="token punctuation">.</span>matmul<span class="token punctuation">(</span>L<span class="token punctuation">,</span> Tx_1<span class="token punctuation">)</span> <span class="token operator">-</span> Tx_0
                output <span class="token operator">+=</span> torch<span class="token punctuation">.</span>matmul<span class="token punctuation">(</span>Tx_2<span class="token punctuation">,</span> self<span class="token punctuation">.</span>weight<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span>
                Tx_0<span class="token punctuation">,</span> Tx_1 <span class="token operator">=</span> Tx_1<span class="token punctuation">,</span> Tx_2
            outputs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>output<span class="token punctuation">)</span>
        outputs <span class="token operator">=</span> torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span>outputs<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        outputs <span class="token operator">+=</span> self<span class="token punctuation">.</span>bias
        <span class="token keyword">return</span> outputs

<span class="token keyword">class</span> <span class="token class-name">STGCNBlock</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> in_channels<span class="token punctuation">,</span> spatial_channels<span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span> num_nodes<span class="token punctuation">,</span> K<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>STGCNBlock<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>temporal_conv1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>cheb_conv <span class="token operator">=</span> ChebConv<span class="token punctuation">(</span>out_channels<span class="token punctuation">,</span> spatial_channels<span class="token punctuation">,</span> K<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>temporal_conv2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>spatial_channels<span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>batch_norm <span class="token operator">=</span> nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>num_nodes<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> L<span class="token punctuation">)</span><span class="token punctuation">:</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>temporal_conv1<span class="token punctuation">(</span>x<span class="token punctuation">.</span>permute<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>permute<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        x <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        batch_size<span class="token punctuation">,</span> num_nodes<span class="token punctuation">,</span> seq_length<span class="token punctuation">,</span> in_channels <span class="token operator">=</span> x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span>
        x <span class="token operator">=</span> x<span class="token punctuation">.</span>view<span class="token punctuation">(</span>batch_size<span class="token punctuation">,</span> num_nodes<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>cheb_conv<span class="token punctuation">(</span>x<span class="token punctuation">,</span> L<span class="token punctuation">)</span>
        x <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> x<span class="token punctuation">.</span>view<span class="token punctuation">(</span>batch_size<span class="token punctuation">,</span> num_nodes<span class="token punctuation">,</span> seq_length<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>temporal_conv2<span class="token punctuation">(</span>x<span class="token punctuation">.</span>permute<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>permute<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>batch_norm<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token keyword">return</span> x

<span class="token keyword">class</span> <span class="token class-name">STGCN</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> num_nodes<span class="token punctuation">,</span> num_features<span class="token punctuation">,</span> num_timesteps_input<span class="token punctuation">,</span> num_timesteps_output<span class="token punctuation">,</span> K<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>STGCN<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>block1 <span class="token operator">=</span> STGCNBlock<span class="token punctuation">(</span>in_channels<span class="token operator">=</span>num_features<span class="token punctuation">,</span> spatial_channels<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span> out_channels<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span> num_nodes<span class="token operator">=</span>num_nodes<span class="token punctuation">,</span> K<span class="token operator">=</span>K<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>block2 <span class="token operator">=</span> STGCNBlock<span class="token punctuation">(</span>in_channels<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span> spatial_channels<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span> out_channels<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span> num_nodes<span class="token operator">=</span>num_nodes<span class="token punctuation">,</span> K<span class="token operator">=</span>K<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fc <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>num_timesteps_input <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">,</span> num_timesteps_output<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> L<span class="token punctuation">)</span><span class="token punctuation">:</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>block1<span class="token punctuation">(</span>x<span class="token punctuation">,</span> L<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>block2<span class="token punctuation">(</span>x<span class="token punctuation">,</span> L<span class="token punctuation">)</span>
        batch_size<span class="token punctuation">,</span> num_nodes<span class="token punctuation">,</span> seq_length<span class="token punctuation">,</span> num_features <span class="token operator">=</span> x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span>
        x <span class="token operator">=</span> x<span class="token punctuation">.</span>view<span class="token punctuation">(</span>batch_size<span class="token punctuation">,</span> num_nodes<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>fc<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token keyword">return</span> x

<span class="token comment"># 初始化模型</span>
num_nodes <span class="token operator">=</span> data<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
num_features <span class="token operator">=</span> <span class="token number">1</span>
num_timesteps_input <span class="token operator">=</span> seq_length
num_timesteps_output <span class="token operator">=</span> <span class="token number">1</span>
K <span class="token operator">=</span> <span class="token number">3</span>  <span class="token comment"># Chebyshev多项式的阶数</span>
model <span class="token operator">=</span> STGCN<span class="token punctuation">(</span>num_nodes<span class="token punctuation">,</span> num_features<span class="token punctuation">,</span> num_timesteps_input<span class="token punctuation">,</span> num_timesteps_output<span class="token punctuation">,</span> K<span class="token punctuation">)</span>
</code></pre>
    <h5>
     <a id="3__140">
     </a>
     3. 训练和评估
    </h5>
    <p>
     训练模型并评估其在交通流预测上的性能。
    </p>
    <pre><code class="prism language-python"><span class="token keyword">import</span> torch<span class="token punctuation">.</span>optim <span class="token keyword">as</span> optim

<span class="token comment"># 定义损失函数和优化器</span>
criterion <span class="token operator">=</span> nn<span class="token punctuation">.</span>MSELoss<span class="token punctuation">(</span><span class="token punctuation">)</span>
optimizer <span class="token operator">=</span> optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span><span class="token number">0.001</span><span class="token punctuation">)</span>

<span class="token comment"># 训练模型</span>
num_epochs <span class="token operator">=</span> <span class="token number">100</span>
<span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_epochs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    model<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>
    optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
    outputs <span class="token operator">=</span> model<span class="token punctuation">(</span>train_inputs<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> adj_matrix<span class="token punctuation">)</span>
    loss <span class="token operator">=</span> criterion<span class="token punctuation">(</span>outputs<span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> train_outputs<span class="token punctuation">)</span>
    loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
    optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>epoch <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">10</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Epoch [</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>epoch<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>num_epochs<span class="token punctuation">}</span></span><span class="token string">], Loss: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token format-spec">.4f</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>

<span class="token comment"># 评估模型</span>
model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    test_outputs_pred <span class="token operator">=</span> model<span class="token punctuation">(</span>test_inputs<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> adj_matrix<span class="token punctuation">)</span>
    test_loss <span class="token operator">=</span> criterion<span class="token punctuation">(</span>test_outputs_pred<span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> test_outputs<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Test Loss: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>test_loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token format-spec">.4f</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>

<span class="token comment"># 反归一化预测结果</span>
test_outputs_pred <span class="token operator">=</span> test_outputs_pred<span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> std <span class="token operator">+</span> mean
test_outputs <span class="token operator">=</span> test_outputs<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> std <span class="token operator">+</span> mean
</code></pre>
    <h4>
     <a id="_174">
     </a>
     总结
    </h4>
    <p>
     通过以上步骤，你可以基于现有的STGCN模型代码进行交通流预测的改动。关键步骤包括数据准备、模型修改和训练评估。根据实际情况，你可能需要调整模型参数和超参数以获得更好的性能。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f:2f626c6f672e6373646e2e6e65742f6875616e67686d38382f:61727469636c652f64657461696c732f313436303637393130" class_="artid" style="display:none">
 </p>
</div>


