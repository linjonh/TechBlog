---
layout: post
title: "Websocket的基本使用"
date: 2025-03-10 16:03:21 +0800
description: "该文章讲解了websocket协议的基本概念以及在python中的基本使用"
keywords: "websocket地址怎么写"
categories: ['未分类']
tags: ['网络协议', '网络', '前端', 'Websocket']
artid: "146156821"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146156821
    alt: "Websocket的基本使用"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146156821
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146156821
cover: https://bing.ee123.net/img/rand?artid=146156821
image: https://bing.ee123.net/img/rand?artid=146156821
img: https://bing.ee123.net/img/rand?artid=146156821
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Websocket的基本使用
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="1_WebSocket_0">
     </a>
     1.
     <code>
      WebSocket
     </code>
    </h2>
    <p>
     <code>
      WebSocket
     </code>
     是一种在单个
     <code>
      TCP
     </code>
     连接上进行全双工通信的协议，它在现代
     <code>
      Web
     </code>
     开发和网络应用中发挥着重要作用。在
     <code>
      WebSocket
     </code>
     出现之前，实现服务器与客户端实时通信主要采用轮询
     <code>
      Polling
     </code>
     和长轮询
     <code>
      Long - Polling
     </code>
     等技术。轮询是客户端定时向服务器发送请求询问是否有新数据；长轮询则是客户端发送请求后，服务器若没有新数据就保持连接，直到有新数据才响应。这些方式存在效率低、资源消耗大等问题。为了解决这些问题，
     <code>
      WebSocket
     </code>
     协议应运而生，它由
     <code>
      HTML5
     </code>
     标准定义，旨在提供一种高效、实时的双向通信机制。
    </p>
    <h3>
     <a id="11__6">
     </a>
     1.1 工作原理
    </h3>
    <p>
     <code>
      Websocket
     </code>
     协议的主流版本为
     <code>
      Websocket 13
     </code>
     ，由
     <code>
      RFC 6455
     </code>
     定义，基于
     <code>
      TCP
     </code>
     协议实现。
     <code>
      WebSocket
     </code>
     的实现原理基于其独特的协议设计和通信机制，核心在于建立持久化的全双工连接，突破传统
     <code>
      HTTP
     </code>
     请求-响应模式的限制。以下是其实现原理的详细解析：
    </p>
    <ul>
     <li>
      <p>
       握手阶段【协议升级】：
       <code>
        WebSocket
       </code>
       通过
       <code>
        HTTP
       </code>
       协议发起握手，升级到
       <code>
        WebSocket
       </code>
       协议，过程如下：
      </p>
      <ul>
       <li>
        <p>
         客户端请求：客户端发送
         <code>
          HTTP
         </code>
         请求，携带
         <code>
          Upgrade: websocket
         </code>
         头，表明希望升级到
         <code>
          WebSocket
         </code>
         协议。
        </p>
        <pre><code class="prism language-text">GET /chat HTTP/1.1
Host: example.com
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==  # 随机16字节 Base64 编码，客户端生成的随机值，用于服务端验证
Sec-WebSocket-Version: 13	// 指定协议版本
Origin: https://example.com
</code></pre>
       </li>
       <li>
        <p>
         服务端响应：服务端验证请求后返回
         <code>
          101 Switching Protocols
         </code>
         响应，完成协议升级。
        </p>
        <pre><code class="prism language-text">HTTP/1.1 101 Switching Protocols
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Accept: s3pPLMBiTxaQ9kYGzzhZRbK+xOo=  # 由客户端 Key + GUID 哈希生成
</code></pre>
       </li>
       <li>
        <p>
         握手完成：成功握手后，
         <code>
          TCP
         </code>
         连接保持打开状态，后续通信直接使用
         <code>
          Websocket
         </code>
         协议帧，不在依赖
         <code>
          Http
         </code>
         。
        </p>
       </li>
      </ul>
     </li>
     <li>
      <p>
       数据传输阶段：一旦连接升级成功，就建立了一个全双工的
       <code>
        WebSocket
       </code>
       连接。客户端和服务器可以在这个连接上随时向对方发送数据，而不需要像
       <code>
        HTTP
       </code>
       请求那样每次都重新建立连接。
      </p>
     </li>
     <li>
      <p>
       关闭连接阶段：当一方想要关闭连接时，会发送一个关闭帧，另一方收到后也发送一个关闭帧进行确认，然后双方关闭连接。
      </p>
     </li>
    </ul>
    <h3>
     <a id="12__41">
     </a>
     1.2 特点与应用场景
    </h3>
    <p>
     <code>
      Websocket
     </code>
     一些有以下特点：
    </p>
    <ul>
     <li>
      全双工通信：客户端和服务器可以同时、独立地向对方发送数据，这使得实时通信变得更加高效。例如，在在线聊天应用中，用户可以随时发送和接收消息。
     </li>
     <li>
      低延迟：由于避免了
      <code>
       HTTP
      </code>
      请求的开销，
      <code>
       WebSocket
      </code>
      连接建立后数据传输的延迟非常低，适合对实时性要求较高的应用，如金融交易系统、实时游戏等。
     </li>
     <li>
      较少的控制开销：
      <code>
       WebSocket
      </code>
      协议在连接建立后，只需要较少的控制信息来维持连接，相比于
      <code>
       HTTP
      </code>
      请求，减少了额外的头部信息，降低了带宽消耗。
     </li>
     <li>
      跨平台兼容性：现代浏览器和大多数服务器端框架都支持
      <code>
       WebSocket
      </code>
      协议，使得开发者可以方便地在不同平台上实现
      <code>
       WebSocket
      </code>
      通信。
     </li>
    </ul>
    <p>
     基于以上特点，能够体现出
     <code>
      Websocket
     </code>
     协议的优势，以下是该协议的常用场景：
    </p>
    <ul>
     <li>
      实时聊天应用：如在线客服系统、即时通讯软件等，用户可以实时发送和接收消息，实现高效的沟通。
     </li>
     <li>
      实时数据更新：股票行情、体育赛事比分等需要实时更新数据的场景，服务器可以实时将最新数据推送给客户端。
     </li>
     <li>
      多人在线游戏：在多人在线游戏中，玩家的操作和状态需要实时同步，
      <code>
       WebSocket
      </code>
      可以保证游戏的流畅性和实时性。
     </li>
     <li>
      多人协作：多个用户可以同时编辑同一个文档，服务器实时将每个用户的编辑操作同步给其他用户。
     </li>
    </ul>
    <h2>
     <a id="2_PythonWebsocket_59">
     </a>
     2.
     <code>
      Python
     </code>
     中使用
     <code>
      Websocket
     </code>
    </h2>
    <p>
     在
     <code>
      Python
     </code>
     中实现
     <code>
      WebSocket
     </code>
     协议通常借助第三方库，主流选择包括
     <code>
      websockets
     </code>
     【轻量异步】、
     <code>
      Tornado
     </code>
     【异步框架】和
     <code>
      Django Channels
     </code>
     【集成 Django 生态】。
    </p>
    <table>
     <thead>
      <tr>
       <th align="center">
        <strong>
         库
        </strong>
       </th>
       <th align="center">
        <strong>
         特点
        </strong>
       </th>
       <th align="center">
        <strong>
         适用场景
        </strong>
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td align="center">
        <strong>
         <code>
          websockets
         </code>
        </strong>
       </td>
       <td align="center">
        轻量级异步库，
        <code>
         API
        </code>
        简洁，支持
        <code>
         Python 3.6+
        </code>
        。
       </td>
       <td align="center">
        快速搭建简单
        <code>
         WebSocket
        </code>
        服务
       </td>
      </tr>
      <tr>
       <td align="center">
        <strong>
         <code>
          Tornado
         </code>
        </strong>
       </td>
       <td align="center">
        异步网络框架，内置
        <code>
         WebSocket
        </code>
        支持，适合复杂应用。
       </td>
       <td align="center">
        高性能实时服务，如聊天服务器
       </td>
      </tr>
      <tr>
       <td align="center">
        <strong>
         <code>
          Django Channels
         </code>
        </strong>
       </td>
       <td align="center">
        集成
        <code>
         Django
        </code>
        ，支持
        <code>
         WebSocket
        </code>
        、
        <code>
         HTTP/2
        </code>
        等协议，需搭配
        <code>
         ASGI
        </code>
        服务器。
       </td>
       <td align="center">
        <code>
         Django
        </code>
        项目中的实时功能扩展
       </td>
      </tr>
     </tbody>
    </table>
    <h3>
     <a id="21_websockets_API_71">
     </a>
     2.1
     <code>
      websockets API
     </code>
    </h3>
    <p>
     <code>
      websockets
     </code>
     是一个用于在
     <code>
      Python
     </code>
     中实现
     <code>
      WebSocket
     </code>
     协议的异步库，适用于构建实时通信应用。安装指令为
     <code>
      pip install websockets
     </code>
     ，该库的常用
     <code>
      API
     </code>
     如下:
    </p>
    <ul>
     <li>
      <p>
       服务端
       <code>
        API
       </code>
      </p>
      <ul>
       <li>
        <p>
         <code>
          websockets.serve()
         </code>
         ：创建
         <code>
          WebSocket
         </code>
         服务器。其参数如下：
        </p>
        <ul>
         <li>
          <p>
           <code>
            handler
           </code>
           ：处理客户端连接的异步函数，需接收
           <code>
            websocket
           </code>
           和
           <code>
            path
           </code>
           参数。
          </p>
         </li>
         <li>
          <p>
           <code>
            host
           </code>
           /
           <code>
            port
           </code>
           ：绑定地址和端口。
          </p>
         </li>
         <li>
          <p>
           <code>
            ping_interval
           </code>
           /
           <code>
            ping_timeout
           </code>
           ：心跳检测间隔和超时时间，默认禁用。
          </p>
         </li>
         <li>
          <p>
           <code>
            origins
           </code>
           ：允许的跨域来源，列表形式，如
           <code>
            origins=["https://example.com"]
           </code>
           。
          </p>
         </li>
         <li>
          <p>
           <code>
            ssl
           </code>
           ：
           <code>
            SSL
           </code>
           上下文，用于
           <code>
            wss://
           </code>
           安全连接。
          </p>
          <pre><code class="prism language-js"><span class="token keyword">async</span> def <span class="token function">handler</span><span class="token punctuation">(</span>websocket<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token operator">:</span>
    pass

server <span class="token operator">=</span> websockets<span class="token punctuation">.</span><span class="token function">serve</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> <span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">8765</span><span class="token punctuation">,</span> ping_interval<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">)</span>
</code></pre>
         </li>
        </ul>
       </li>
       <li>
        <p>
         <code>
          WebSocketServer
         </code>
         对象：通过
         <code>
          serve()
         </code>
         返回的服务器对象，通常用
         <code>
          async with
         </code>
         管理生命周期。
        </p>
        <pre><code class="prism language-python"><span class="token keyword">async</span> <span class="token keyword">with</span> websockets<span class="token punctuation">.</span>serve<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token keyword">as</span> server<span class="token punctuation">:</span>
    <span class="token keyword">await</span> server<span class="token punctuation">.</span>wait_closed<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 阻塞直到服务器关闭</span>
</code></pre>
       </li>
      </ul>
     </li>
     <li>
      <p>
       客户端常用
       <code>
        API
       </code>
      </p>
      <ul>
       <li>
        <p>
         <code>
          websockets.connect()
         </code>
         ：连接到
         <code>
          WebSocket
         </code>
         服务器。其参数如下：
        </p>
        <ul>
         <li>
          <p>
           <code>
            uri
           </code>
           ：服务器地址，如
           <code>
            ws://localhost:8765
           </code>
           。
          </p>
         </li>
         <li>
          <p>
           <code>
            ping_interval
           </code>
           /
           <code>
            ping_timeout
           </code>
           ：客户端心跳配置。
          </p>
         </li>
         <li>
          <p>
           <code>
            ssl
           </code>
           ：用于
           <code>
            HTTPS
           </code>
           的
           <code>
            SSL
           </code>
           上下文。
          </p>
          <pre><code class="prism language-python"><span class="token keyword">async</span> <span class="token keyword">with</span> websockets<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token string">"ws://localhost:8765"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> websocket<span class="token punctuation">:</span>
    <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">"Hello"</span><span class="token punctuation">)</span>
</code></pre>
         </li>
        </ul>
       </li>
      </ul>
     </li>
     <li>
      <p>
       连接对象``WebSocketCommonProtocol
       <code>
        ：无论是服务端还是客户端的连接，均通过
       </code>
       websocket` 对象操作，核心方法如下。
      </p>
      <ul>
       <li>
        <p>
         发送消息：
         <code>
          await websocket.send(message)
         </code>
         ，发送文本或二进制数据。
        </p>
        <pre><code class="prism language-python"><span class="token keyword">await</span> websocket<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">"Hello!"</span><span class="token punctuation">)</span>
<span class="token keyword">await</span> websocket<span class="token punctuation">.</span>send<span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"data"</span><span class="token punctuation">:</span> <span class="token string">"test"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
       </li>
       <li>
        <p>
         接收消息：
         <code>
          await websocket.recv()
         </code>
         ，接收一条文本或二进制消息。
        </p>
        <pre><code class="prism language-python"><span class="token operator">//</span> 循环接收
<span class="token keyword">async</span> <span class="token keyword">for</span> message <span class="token keyword">in</span> websocket<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Received: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>message<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</code></pre>
       </li>
       <li>
        <p>
         关闭连接：
         <code>
          await websocket.close(code=1000, reason="")
         </code>
         ，主动关闭连接，支持状态码和原因，如
         <code>
          1000
         </code>
         【正常关闭】、
         <code>
          1001
         </code>
         【服务器终止】、
         <code>
          1002
         </code>
         【协议错误】。
        </p>
        <pre><code class="prism language-python"><span class="token keyword">await</span> websocket<span class="token punctuation">.</span>close<span class="token punctuation">(</span>code<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">,</span> reason<span class="token operator">=</span><span class="token string">"Done"</span><span class="token punctuation">)</span>
</code></pre>
       </li>
       <li>
        <p>
         连接状态
        </p>
        <ul>
         <li>
          <code>
           websocket.open
          </code>
          ：连接是否处于打开状态。
         </li>
         <li>
          <code>
           websocket.closed
          </code>
          ：连接是否已关闭。
         </li>
        </ul>
       </li>
      </ul>
     </li>
     <li>
      <p>
       异常处理
      </p>
      <ul>
       <li>
        <p>
         <code>
          websockets.exceptions.ConnectionClosed
         </code>
         ：当连接意外时关闭抛出。
        </p>
        <pre><code class="prism language-python"><span class="token keyword">try</span><span class="token punctuation">:</span>
    <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">except</span> websockets<span class="token punctuation">.</span>exceptions<span class="token punctuation">.</span>ConnectionClosed <span class="token keyword">as</span> e<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Connection closed: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>e<span class="token punctuation">.</span>code<span class="token punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>e<span class="token punctuation">.</span>reason<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</code></pre>
       </li>
       <li>
        <p>
         <code>
          InvalidHandshake
         </code>
         ：握手失败，如服务器未实现
         <code>
          WebSocket
         </code>
         。
        </p>
       </li>
       <li>
        <p>
         <code>
          InvalidMessage
         </code>
         ：消息格式错误。
        </p>
       </li>
      </ul>
     </li>
     <li>
      <p>
       配置
       <code>
        SSL/TLS
       </code>
       【配置安全连接】
      </p>
      <ul>
       <li>
        <p>
         服务端配置
        </p>
        <pre><code class="prism language-python"><span class="token keyword">import</span> ssl

ssl_context <span class="token operator">=</span> ssl<span class="token punctuation">.</span>SSLContext<span class="token punctuation">(</span>ssl<span class="token punctuation">.</span>PROTOCOL_TLS_SERVER<span class="token punctuation">)</span>
ssl_context<span class="token punctuation">.</span>load_cert_chain<span class="token punctuation">(</span><span class="token string">"server.crt"</span><span class="token punctuation">,</span> <span class="token string">"server.key"</span><span class="token punctuation">)</span>

server <span class="token operator">=</span> websockets<span class="token punctuation">.</span>serve<span class="token punctuation">(</span>handler<span class="token punctuation">,</span> <span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">8765</span><span class="token punctuation">,</span> ssl<span class="token operator">=</span>ssl_context<span class="token punctuation">)</span>
</code></pre>
       </li>
       <li>
        <p>
         客户端配置
        </p>
        <pre><code class="prism language-python">ssl_context <span class="token operator">=</span> ssl<span class="token punctuation">.</span>SSLContext<span class="token punctuation">(</span>ssl<span class="token punctuation">.</span>PROTOCOL_TLS_CLIENT<span class="token punctuation">)</span>
ssl_context<span class="token punctuation">.</span>load_verify_locations<span class="token punctuation">(</span><span class="token string">"server.crt"</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">with</span> websockets<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token string">"wss://localhost:8765"</span><span class="token punctuation">,</span> ssl<span class="token operator">=</span>ssl_context<span class="token punctuation">)</span> <span class="token keyword">as</span> ws<span class="token punctuation">:</span>
    <span class="token keyword">pass</span>
</code></pre>
       </li>
      </ul>
     </li>
    </ul>
    <h3>
     <a id="22_asyncawait_186">
     </a>
     2.2
     <code>
      async
     </code>
     与
     <code>
      await
     </code>
    </h3>
    <p>
     在
     <code>
      Python
     </code>
     里，
     <code>
      async
     </code>
     和
     <code>
      await
     </code>
     是异步编程的核心特性，它们基于
     <code>
      asyncio
     </code>
     库实现，能让代码在处理
     <code>
      I/O
     </code>
     密集型任务时更高效。
    </p>
    <ul>
     <li>
      <p>
       <code>
        async
       </code>
       关键字
      </p>
      <ul>
       <li>
        <p>
         定义协程函数：
         <code>
          async
         </code>
         用于定义协程函数。协程函数是一种特殊的函数，它不会像普通函数那样直接执行，而是返回一个协程对象。要执行协程函数，需要将其放到事件循环中。在下面例子中，
         <code>
          greet
         </code>
         是一个协程函数，调用它时并不会立即执行函数体中的代码，而是返回一个协程对象。
        </p>
        <pre><code class="prism language-python"><span class="token keyword">import</span> asyncio

<span class="token comment"># 使用 async 定义协程函数</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">greet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"开始执行协程函数"</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 模拟 I/O 操作</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"协程函数执行结束"</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">"Hello, World!"</span>

<span class="token comment"># 调用协程函数，返回协程对象</span>
coro <span class="token operator">=</span> greet<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span>coro<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># &lt;class 'coroutine'&gt;</span>
</code></pre>
       </li>
       <li>
        <p>
         异步生成器：
         <code>
          async
         </code>
         还能用于定义异步生成器，异步生成器可以在异步环境中逐个生成值。在下面例子中，
         <code>
          async_generator
         </code>
         是一个异步生成器，
         <code>
          async for
         </code>
         用于迭代异步生成器中的值。
        </p>
        <pre><code class="prism language-python"><span class="token keyword">import</span> asyncio

<span class="token comment"># 定义异步生成器</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">async_generator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">yield</span> i

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">async</span> <span class="token keyword">for</span> num <span class="token keyword">in</span> async_generator<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span>

asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
       </li>
       <li>
        <p>
         <code>
          await
         </code>
         关键字
        </p>
        <ul>
         <li>
          <p>
           暂停协程执行：
           <code>
            await
           </code>
           只能在协程函数内部使用，它用于暂停当前协程的执行，等待一个可等待对象【另一个协程、
           <code>
            Future
           </code>
           对象、
           <code>
            Task
           </code>
           对象】完成，并返回其结果。当遇到
           <code>
            await
           </code>
           时，控制权会暂时交回给事件循环，事件循环可以去执行其他任务。在下面例子中，
           <code>
            main
           </code>
           协程函数里的
           <code>
            await fetch_data()
           </code>
           会暂停
           <code>
            main
           </code>
           协程的执行，直到
           <code>
            fetch_data
           </code>
           协程执行完毕，然后将
           <code>
            fetch_data
           </code>
           的返回值赋给
           <code>
            result
           </code>
           。
          </p>
          <pre><code class="prism language-python"><span class="token keyword">import</span> asyncio

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">fetch_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"开始获取数据"</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment"># 模拟耗时的数据获取操作</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"数据获取完成"</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">"Data"</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    result <span class="token operator">=</span> <span class="token keyword">await</span> fetch_data<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 等待 fetch_data 协程完成</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"获取到的数据: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>result<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

<span class="token comment"># 创建事件循环并运行主协程</span>
asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
         </li>
         <li>
          <p>
           处理多个可等待对象：可以使用
           <code>
            asyncio.gather()
           </code>
           同时运行多个协程，
           <code>
            await
           </code>
           会等待所有协程都完成。在下面例子中，
           <code>
            asyncio.gather(task1(), task2())
           </code>
           会并发运行
           <code>
            task1
           </code>
           和
           <code>
            task2
           </code>
           协程，
           <code>
            await
           </code>
           会等待这两个协程都完成，然后将它们的返回值以列表形式存储在
           <code>
            results
           </code>
           中。
          </p>
          <pre><code class="prism language-python"><span class="token keyword">import</span> asyncio

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">task1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Task 1 开始"</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Task 1 完成"</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">1</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">task2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Task 2 开始"</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Task 2 完成"</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">2</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    results <span class="token operator">=</span> <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>task1<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> task2<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"所有任务的结果: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>results<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
         </li>
        </ul>
       </li>
      </ul>
     </li>
    </ul>
    <p>
     在下面例子中，
     <code>
      fetch
     </code>
     是一个协程函数，用于发送
     <code>
      HTTP
     </code>
     请求并返回响应内容。
     <code>
      main
     </code>
     协程函数中，使用
     <code>
      asyncio.gather()
     </code>
     并发执行多个
     <code>
      fetch
     </code>
     协程，
     <code>
      await
     </code>
     会等待所有请求都完成，然后打印每个响应内容的长度。
    </p>
    <pre><code class="prism language-python"><span class="token keyword">import</span> asyncio
<span class="token keyword">import</span> aiohttp

<span class="token comment"># 异步函数，用于发送 HTTP 请求</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">fetch</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">async</span> <span class="token keyword">with</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span> <span class="token keyword">as</span> response<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 主协程函数，用于并发执行多个请求</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    urls <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token string">"http://example.com"</span><span class="token punctuation">,</span>
        <span class="token string">"http://example.org"</span><span class="token punctuation">,</span>
        <span class="token string">"http://example.net"</span>
    <span class="token punctuation">]</span>
    <span class="token keyword">async</span> <span class="token keyword">with</span> aiohttp<span class="token punctuation">.</span>ClientSession<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> session<span class="token punctuation">:</span>
        tasks <span class="token operator">=</span> <span class="token punctuation">[</span>fetch<span class="token punctuation">(</span>session<span class="token punctuation">,</span> url<span class="token punctuation">)</span> <span class="token keyword">for</span> url <span class="token keyword">in</span> urls<span class="token punctuation">]</span>
        results <span class="token operator">=</span> <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>gather<span class="token punctuation">(</span><span class="token operator">*</span>tasks<span class="token punctuation">)</span>
        <span class="token keyword">for</span> result <span class="token keyword">in</span> results<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 运行主协程</span>
asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
    <h3>
     <a id="22__304">
     </a>
     2.2 实时日志监控
    </h3>
    <pre><code class="prism language-python"><span class="token operator">//</span> 服务端代码
<span class="token keyword">import</span> asyncio
<span class="token keyword">import</span> websockets
<span class="token keyword">import</span> time

connected <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">log_monitor</span><span class="token punctuation">(</span>websocket<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    connected<span class="token punctuation">.</span>add<span class="token punctuation">(</span>websocket<span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token comment"># 模拟持续发送日志</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            log <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"Log at </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>time<span class="token punctuation">.</span>ctime<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
            <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>send<span class="token punctuation">(</span>log<span class="token punctuation">)</span>
            <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> websockets<span class="token punctuation">.</span>exceptions<span class="token punctuation">.</span>ConnectionClosed<span class="token punctuation">:</span>
        <span class="token keyword">pass</span>
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        connected<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>websocket<span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">async</span> <span class="token keyword">with</span> websockets<span class="token punctuation">.</span>serve<span class="token punctuation">(</span>log_monitor<span class="token punctuation">,</span> <span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">8765</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>Future<span class="token punctuation">(</span><span class="token punctuation">)</span>

asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
    <pre><code class="prism language-python"><span class="token operator">//</span> 客户端代码
<span class="token keyword">import</span> asyncio
<span class="token keyword">import</span> websockets

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">log_client</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">async</span> <span class="token keyword">with</span> websockets<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token string">"ws://localhost:8765"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> websocket<span class="token punctuation">:</span>
        <span class="token keyword">async</span> <span class="token keyword">for</span> log <span class="token keyword">in</span> websocket<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Received log: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>log<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>log_client<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f37343039303737312f:61727469636c652f64657461696c732f313436313536383231" class_="artid" style="display:none">
 </p>
</div>


