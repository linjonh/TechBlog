---
layout: post
title: "å¤§å‰ç«¯å®ç°ä¸€ä¸ªå‰ç«¯åŸ‹ç‚¹SDK,å¹¶å°è£…æˆNPMåŒ…"
date: 2025-08-26T14:38:03+0800
description: "ğŸš€æ¥åšä¸€ä¸ªæ”¯æŒçš„å‰ç«¯åŸ‹ç‚¹ SDKï¼Œå¹¶æŠŠå®ƒå°è£…æˆçš„å½¢å¼ã€‚"
keywords: "ã€å¤§å‰ç«¯ã€‘å®ç°ä¸€ä¸ªå‰ç«¯åŸ‹ç‚¹SDKï¼Œå¹¶å°è£…æˆNPMåŒ…"
categories: ['å‰ç«¯', 'React']
tags: ['å‰ç«¯', 'Npm', 'Arcgis']
artid: "150856167"
arturl: "https://blog.csdn.net/qq_41688840/article/details/150856167"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=150856167
    alt: "å¤§å‰ç«¯å®ç°ä¸€ä¸ªå‰ç«¯åŸ‹ç‚¹SDK,å¹¶å°è£…æˆNPMåŒ…"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=150856167
featuredImagePreview: https://bing.ee123.net/img/rand?artid=150856167
cover: https://bing.ee123.net/img/rand?artid=150856167
image: https://bing.ee123.net/img/rand?artid=150856167
img: https://bing.ee123.net/img/rand?artid=150856167
---



# ã€å¤§å‰ç«¯ã€‘å®ç°ä¸€ä¸ªå‰ç«¯åŸ‹ç‚¹SDKï¼Œå¹¶å°è£…æˆNPMåŒ…



ğŸš€æ¥åšä¸€ä¸ªæ”¯æŒ **React** çš„å‰ç«¯åŸ‹ç‚¹ SDKï¼Œå¹¶æŠŠå®ƒå°è£…æˆ **npm åŒ…** çš„å½¢å¼ã€‚æ•´ä½“åˆ† 3 éƒ¨åˆ†ï¼š

1. **æ ¸å¿ƒ SDK**ï¼ˆç‹¬ç«‹çš„é‡‡é›† & ä¸ŠæŠ¥é€»è¾‘ï¼‰
2. **React Hook / HOC æ”¯æŒ**ï¼ˆè‡ªåŠ¨åŸ‹ç‚¹ï¼šè·¯ç”±å˜åŒ–ã€ç»„ä»¶æ¸²æŸ“ã€ç‚¹å‡»äº‹ä»¶ï¼‰
3. **npm åŒ…ç»“æ„**ï¼ˆpackage.jsonã€æ‰“åŒ…é…ç½®ï¼‰

---

### 1. SDK æ ¸å¿ƒé€»è¾‘ï¼ˆ`src/core.ts`ï¼‰

```ts
// src/core.ts (ä¿®æ”¹å)
export interface AnalyticsOptions {
  serverUrl: string;
  appId: string;
  userId?: string;
  maxQueueSize?: number;
  interval?: number;
  enableErrorTracking?: boolean; // æ˜¯å¦å¯ç”¨é”™è¯¯ç›‘æ§
}

export class AnalyticsSDK {
  private serverUrl: string;
  private appId: string;
  private userId: string;
  private queue: EventData[] = [];
  private maxQueueSize: number;
  private interval: number;

  constructor(options: AnalyticsOptions) {
    this.serverUrl = options.serverUrl;
    this.appId = options.appId;
    this.userId = options.userId || this.getUserId();
    this.maxQueueSize = options.maxQueueSize || 10;
    this.interval = options.interval || 5000;

    this.startFlushTimer();
    window.addEventListener("beforeunload", () => this.flush(true));

    // å¼€å¯é”™è¯¯ç›‘æ§
    if (options.enableErrorTracking) {
      this.setupErrorTracking();
    }
  }

  private getUserId(): string {
    let uid = localStorage.getItem("analytics_uid");
    if (!uid) {
      uid = "uid_" + Math.random().toString(36).substring(2, 9);
      localStorage.setItem("analytics_uid", uid);
    }
    return uid;
  }

  public track(eventName: string, properties: Record<string, any> = {}) {
    const event: EventData = {
      eventName,
      properties,
      appId: this.appId,
      userId: this.userId,
      timestamp: Date.now(),
      url: window.location.href,
      ua: navigator.userAgent,
    };

    this.queue.push(event);
    if (this.queue.length >= this.maxQueueSize) {
      this.flush();
    }
  }

  private flush(sync = false) {
    if (this.queue.length === 0) return;
    const events = this.queue.splice(0, this.queue.length);

    if (sync && navigator.sendBeacon) {
      navigator.sendBeacon(this.serverUrl, JSON.stringify(events));
    } else {
      fetch(this.serverUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(events),
      }).catch(() => {
        this.queue.unshift(...events);
      });
    }
  }

  private startFlushTimer() {
    setInterval(() => this.flush(), this.interval);
  }

  /** ç»‘å®šå…¨å±€é”™è¯¯ç›‘æ§ */
  private setupErrorTracking() {
    // JSè¿è¡Œæ—¶é”™è¯¯ & èµ„æºåŠ è½½é”™è¯¯
    window.onerror = (message, source, lineno, colno, error) => {
      this.track("error_event", {
        type: "js_error",
        message,
        source,
        lineno,
        colno,
        stack: error?.stack || "",
      });
    };

    // Promise æœªå¤„ç†å¼‚å¸¸
    window.addEventListener("unhandledrejection", (event) => {
      this.track("error_event", {
        type: "unhandled_promise",
        reason: event.reason ? event.reason.toString() : "",
      });
    });
  }
}

```

---

### 2. React Hook æ”¯æŒï¼ˆ`src/react.tsx`ï¼‰

è¿™é‡Œåšå‡ ä¸ªå°è£…ï¼š

* **usePageView**ï¼šç›‘å¬é¡µé¢åˆ‡æ¢ï¼ˆé€‚é… React Routerï¼‰
* **useTrackClick**ï¼šç‚¹å‡»åŸ‹ç‚¹ Hook
* **withTrackClick**ï¼šHOC åŒ…è£¹ç»„ä»¶

```tsx
// src/react.tsx
import { useEffect } from "react";
import { useLocation } from "react-router-dom";
import { AnalyticsSDK } from "./core";

let sdk: AnalyticsSDK | null = null;

export const initAnalytics = (instance: AnalyticsSDK) => {
  sdk = instance;
};

// Hook: é¡µé¢è®¿é—®åŸ‹ç‚¹
export const usePageView = () => {
  const location = useLocation();
  useEffect(() => {
    if (sdk) {
      sdk.track("page_view", { path: location.pathname });
    }
  }, [location]);
};

// Hook: ç‚¹å‡»åŸ‹ç‚¹
export const useTrackClick = (eventName: string, props?: Record<string, any>) => {
  return () => {
    if (sdk) {
      sdk.track(eventName, props);
    }
  };
};

// HOC: åŒ…è£¹ç»„ä»¶è‡ªåŠ¨åŸ‹ç‚¹ç‚¹å‡»
export const withTrackClick = <P extends object>(
  Component: React.ComponentType<P>,
  eventName: string,
  props?: Record<string, any>
) => {
  return (componentProps: P) => {
    const handleClick = () => {
      if (sdk) {
        sdk.track(eventName, props);
      }
    };
    return <div onClick={handleClick}><Component {...componentProps} /></div>;
  };
};

```

---

### 3. npm åŒ…ç›®å½•ç»“æ„

```
my-analytics-sdk/
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ rollup.config.js      # æ‰“åŒ…é…ç½®
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ core.ts           # SDKæ ¸å¿ƒé€»è¾‘
â”‚   â”œâ”€â”€ react.tsx         # React hooks/HOC
â”‚   â””â”€â”€ index.ts          # å…¥å£æ–‡ä»¶

```

#### `src/index.ts`

```ts
export { AnalyticsSDK } from "./core";
export { initAnalytics, usePageView, useTrackClick, withTrackClick } from "./react";

```

---

### 4. æ‰“åŒ…é…ç½®ï¼ˆ`rollup.config.js`ï¼‰

```js
import typescript from "@rollup/plugin-typescript";
import { terser } from "rollup-plugin-terser";

export default {
  input: "src/index.ts",
  output: [
    { file: "dist/index.cjs.js", format: "cjs" },
    { file: "dist/index.esm.js", format: "esm" },
  ],
  plugins: [typescript(), terser()],
  external: ["react", "react-router-dom"],
};

```

---

### 5. ä½¿ç”¨ç¤ºä¾‹ï¼ˆReact é¡¹ç›®ä¸­ï¼‰

```tsx
// App.tsx
import React from "react";
import { BrowserRouter, Route, Routes } from "react-router-dom";
import { AnalyticsSDK, initAnalytics, usePageView, useTrackClick } from "my-analytics-sdk";

const sdk = new AnalyticsSDK({
  serverUrl: "https://your-server.com/track",
  appId: "my-app",
});
initAnalytics(sdk);

function Home() {
  usePageView();
  const handleClick = useTrackClick("click_home_button", { id: "btn1" });
  return <button onClick={handleClick}>ç‚¹æˆ‘åŸ‹ç‚¹</button>;
}

function About() {
  usePageView();
  return <div>About Page</div>;
}

export default function App() {
  return (
    <BrowserRouter>
      <Routes>
        <Route path="/" element={<Home />} />
        <Route path="/about" element={<About />} />
      </Routes>
    </BrowserRouter>
  );
}

```

---

âœ… è‡³æ­¤ï¼Œå°±æœ‰äº†ä¸€ä¸ª **æ”¯æŒ React è·¯ç”± + æ‰‹åŠ¨/è‡ªåŠ¨åŸ‹ç‚¹çš„ SDK**ï¼Œå¹¶ä¸”èƒ½å‘å¸ƒæˆ **npm åŒ…**ã€‚  
 åªéœ€ `npm publish` å°±èƒ½åœ¨å…¶ä»–é¡¹ç›®ä¸­ç›´æ¥ `npm install my-analytics-sdk` ä½¿ç”¨ã€‚

---

### 6. å¢åŠ é”™è¯¯ç›‘æ§

åŠ ä¸€ä¸ª **é”™è¯¯ç›‘æ§ï¼ˆwindow.onerror + unhandledrejectionï¼‰è‡ªåŠ¨åŸ‹ç‚¹** çš„åŠŸèƒ½ï¼Œè®© SDK æ—¢èƒ½åšåŸ‹ç‚¹åˆèƒ½åšå¼‚å¸¸ç›‘æ§

é”™è¯¯ç›‘æ§å…¶å®æ˜¯å‰ç«¯åŸ‹ç‚¹ SDK å¾ˆé‡è¦çš„ä¸€éƒ¨åˆ†ã€‚æˆ‘ä»¬å¯ä»¥åœ¨ **SDK åˆå§‹åŒ–æ—¶** è‡ªåŠ¨ç›‘å¬å…¨å±€çš„ï¼š

* `window.onerror` â†’ æ•è·åŒæ­¥ JS é”™è¯¯ / èµ„æºåŠ è½½é”™è¯¯
* `window.onunhandledrejection` â†’ æ•è·æœªå¤„ç†çš„ Promise å¼‚å¸¸

å¹¶æŠŠè¿™äº›é”™è¯¯ä¹Ÿå½“ä½œç‰¹æ®Šäº‹ä»¶ï¼ˆ`error_event`ï¼‰ä¸ŠæŠ¥ã€‚

---

#### 6.1 ä½¿ç”¨æ–¹å¼ï¼ˆReact é¡¹ç›®é‡Œï¼‰

```tsx
import React from "react";
import { BrowserRouter, Route, Routes } from "react-router-dom";
import { AnalyticsSDK, initAnalytics, usePageView } from "my-analytics-sdk";

const sdk = new AnalyticsSDK({
  serverUrl: "https://your-server.com/track",
  appId: "my-app",
  enableErrorTracking: true, // å¼€å¯é”™è¯¯ç›‘æ§
});
initAnalytics(sdk);

function Home() {
  usePageView();

  const throwError = () => {
    throw new Error("æ‰‹åŠ¨è§¦å‘ä¸€ä¸ªé”™è¯¯è¯•è¯•");
  };

  const rejectPromise = () => {
    Promise.reject("æ‰‹åŠ¨è§¦å‘ Promise å¼‚å¸¸");
  };

  return (
    <div>
      <h1>é¦–é¡µ</h1>
      <button onClick={throwError}>æŠ› JS é”™è¯¯</button>
      <button onClick={rejectPromise}>æŠ› Promise é”™è¯¯</button>
    </div>
  );
}

function About() {
  usePageView();
  return <div>å…³äºé¡µé¢</div>;
}

export default function App() {
  return (
    <BrowserRouter>
      <Routes>
        <Route path="/" element={<Home />} />
        <Route path="/about" element={<About />} />
      </Routes>
    </BrowserRouter>
  );
}

```

---

#### 6.2 ä¸ŠæŠ¥åˆ°æœåŠ¡ç«¯çš„é”™è¯¯æ•°æ®ç¤ºä¾‹

```json
[
  {
    "eventName": "error_event",
    "properties": {
      "type": "js_error",
      "message": "Uncaught Error: æ‰‹åŠ¨è§¦å‘ä¸€ä¸ªé”™è¯¯è¯•è¯•",
      "source": "http://localhost:3000/static/js/main.js",
      "lineno": 42,
      "colno": 13,
      "stack": "Error: æ‰‹åŠ¨è§¦å‘ä¸€ä¸ªé”™è¯¯è¯•è¯•\n    at onClick..."
    },
    "appId": "my-app",
    "userId": "uid_xxx",
    "timestamp": 1693042000000,
    "url": "http://localhost:3000/",
    "ua": "Mozilla/5.0 ..."
  }
]

```

---

âœ… è‡³æ­¤ï¼ŒSDK å·²ç»åŒæ—¶æ”¯æŒ **åŸ‹ç‚¹ + å¼‚å¸¸ç›‘æ§**ï¼Œè€Œä¸”èƒ½ç›´æ¥ä½œä¸º npm åŒ…å‘å¸ƒã€‚  
 è¿™æ ·å°±èƒ½åœ¨å®é™…é¡¹ç›®ä¸­åšåˆ°åŸ‹ç‚¹ã€é”™è¯¯ç›‘æ§ä¸€ä½“åŒ–ã€‚



