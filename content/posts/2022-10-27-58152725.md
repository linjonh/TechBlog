---
layout: post
title: "iOS-音视频合成,-AVMutableComposition来合成音视频"
date: 2022-10-27 15:25:51 +0800
description: "音视频主要是利用AVFoundation框架下的AVMutableComposition来合成音视频"
keywords: "avmutablecomposition"
categories: ['Ios']
tags: ['无标签']
artid: "58152725"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=58152725
    alt: "iOS-音视频合成,-AVMutableComposition来合成音视频"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=58152725
featuredImagePreview: https://bing.ee123.net/img/rand?artid=58152725
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     iOS 音视频合成,  AVMutableComposition来合成音视频
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <p>
     <br/>
    </p>
    <p>
    </p>
    <p style="margin-top:0px; margin-bottom:25px; word-break:break-word; color:rgb(47,47,47); font-size:16px">
     音视频主要是利用AVFoundation框架下的AVMutableComposition来合成音视频.
    </p>
    <h3 style="line-height:1.7; color:rgb(47,47,47); margin:0px 0px 15px; font-size:24px">
     在AVMutableComposition中传入两个数据流,一个是音频一个是视频,之后调用合成方法就可以了
    </h3>
    <h2 style="font-size:26px; margin:0px 0px 15px; line-height:1.7; color:rgb(47,47,47)">
     上代码
    </h2>
    <h3 style="line-height:1.7; color:rgb(47,47,47); margin:0px 0px 15px; font-size:24px">
     storyBoard中拖入一个button,一个imageView
    </h3>
    <div class="image-package" style="padding-bottom:25px; width:700px; margin-left:-40px; text-align:center; color:rgb(47,47,47); font-size:16px">
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/fe8110d5fae5ea779116cef7bb1105c4.webp?x-image-process=image/format,png" style="">
      <br style=""/>
      <div class="image-caption" style="min-width:20%; max-width:80%; min-height:22px; display:inline-block; padding:10px; margin:0px auto; border-bottom-width:1px; border-bottom-style:solid; border-bottom-color:rgb(217,217,217); font-size:14px; color:rgb(150,150,150); line-height:1.7">
       这里写图片描述
      </div>
     </img>
    </div>
    <h3 style="line-height:1.7; color:rgb(47,47,47); margin:0px 0px 15px; font-size:24px">
     为了效果好可以将IamgeView的背景色调为黑色
    </h3>
    <h3 style="line-height:1.7; color:rgb(47,47,47); margin:0px 0px 15px; font-size:24px">
     然后在ViewController中添加以下代码
    </h3>
    <pre class="hljs objectivec" style="overflow:auto; font-family:Menlo,Monaco,Consolas,'Courier New',monospace; font-size:13px; padding:15px; margin-top:0px; margin-bottom:20px; line-height:1.42857; word-break:break-word; word-wrap:normal; color:rgb(101,123,131); background-color:rgb(246,246,246); border:1px solid rgb(204,204,204)"><code class="objectivec" style="font-family:Menlo,Monaco,Consolas,'Courier New',monospace; font-size:12px; background-color:transparent; padding:0px; border:none"><span class="hljs-meta" style="">#import <span class="hljs-meta-string" style="">"ViewController.h"</span></span>
<span class="hljs-meta" style="">#import <span class="hljs-meta-string" style="">&lt;AVFoundation/AVFoundation.h&gt;</span></span>
<span class="hljs-meta" style="">#import <span class="hljs-meta-string" style="">"MBProgressHUD+MJ.h"</span></span>
<span class="hljs-class" style=""><span class="hljs-keyword" style="color:rgb(133,153,0)">@interface</span> <span class="hljs-title" style="color:rgb(181,137,0)">ViewController</span> ()</span>
<span class="hljs-comment" style="color:rgb(147,161,161)">/** 用于播放 */</span>
<span class="hljs-keyword" style="color:rgb(133,153,0)">@property</span> (<span class="hljs-keyword" style="color:rgb(133,153,0)">weak</span>, <span class="hljs-keyword" style="color:rgb(133,153,0)">nonatomic</span>) <span class="hljs-keyword" style="color:rgb(133,153,0)">IBOutlet</span> <span class="hljs-built_in" style="color:rgb(38,139,210)">UIImageView</span> *imageView;

<span class="hljs-keyword" style="color:rgb(133,153,0)">@end</span>

<span class="hljs-class" style=""><span class="hljs-keyword" style="color:rgb(133,153,0)">@implementation</span> <span class="hljs-title" style="color:rgb(181,137,0)">ViewController</span></span>

- (<span class="hljs-keyword" style="color:rgb(133,153,0)">void</span>)viewDidLoad {
    [<span class="hljs-keyword" style="color:rgb(133,153,0)">super</span> viewDidLoad];

}

- (<span class="hljs-keyword" style="color:rgb(133,153,0)">IBAction</span>)mergeAction:(<span class="hljs-built_in" style="color:rgb(38,139,210)">UIButton</span> *)sender {
    [<span class="hljs-keyword" style="color:rgb(133,153,0)">self</span> merge];
}
<span class="hljs-comment" style="color:rgb(147,161,161)">// 混合音乐</span>
- (<span class="hljs-keyword" style="color:rgb(133,153,0)">void</span>)merge{
    <span class="hljs-comment" style="color:rgb(147,161,161)">// mbp提示框</span>
    [MBProgressHUD showMessage:<span class="hljs-string" style="color:rgb(42,161,152)">@"正在处理中"</span>];
    <span class="hljs-comment" style="color:rgb(147,161,161)">// 路径</span>
    <span class="hljs-built_in" style="color:rgb(38,139,210)">NSString</span> *documents = [<span class="hljs-built_in" style="color:rgb(38,139,210)">NSHomeDirectory</span>() stringByAppendingPathComponent:<span class="hljs-string" style="color:rgb(42,161,152)">@"Documents"</span>];
    <span class="hljs-comment" style="color:rgb(147,161,161)">// 声音来源</span>
    <span class="hljs-built_in" style="color:rgb(38,139,210)">NSURL</span> *audioInputUrl = [<span class="hljs-built_in" style="color:rgb(38,139,210)">NSURL</span> fileURLWithPath:[[<span class="hljs-built_in" style="color:rgb(38,139,210)">NSBundle</span> mainBundle] pathForResource:<span class="hljs-string" style="color:rgb(42,161,152)">@"五环之歌"</span> ofType:<span class="hljs-string" style="color:rgb(42,161,152)">@"mp3"</span>]];
    <span class="hljs-comment" style="color:rgb(147,161,161)">// 视频来源</span>
    <span class="hljs-built_in" style="color:rgb(38,139,210)">NSURL</span> *videoInputUrl = [<span class="hljs-built_in" style="color:rgb(38,139,210)">NSURL</span> fileURLWithPath:[[<span class="hljs-built_in" style="color:rgb(38,139,210)">NSBundle</span> mainBundle] pathForResource:<span class="hljs-string" style="color:rgb(42,161,152)">@"myPlayer"</span> ofType:<span class="hljs-string" style="color:rgb(42,161,152)">@"mp4"</span>]];

    <span class="hljs-comment" style="color:rgb(147,161,161)">// 最终合成输出路径</span>
    <span class="hljs-built_in" style="color:rgb(38,139,210)">NSString</span> *outPutFilePath = [documents stringByAppendingPathComponent:<span class="hljs-string" style="color:rgb(42,161,152)">@"merge.mp4"</span>];
    <span class="hljs-comment" style="color:rgb(147,161,161)">// 添加合成路径</span>
    <span class="hljs-built_in" style="color:rgb(38,139,210)">NSURL</span> *outputFileUrl = [<span class="hljs-built_in" style="color:rgb(38,139,210)">NSURL</span> fileURLWithPath:outPutFilePath];
    <span class="hljs-comment" style="color:rgb(147,161,161)">// 时间起点</span>
    <span class="hljs-built_in" style="color:rgb(38,139,210)">CMTime</span> nextClistartTime = kCMTimeZero;
    <span class="hljs-comment" style="color:rgb(147,161,161)">// 创建可变的音视频组合</span>
    <span class="hljs-built_in" style="color:rgb(38,139,210)">AVMutableComposition</span> *comosition = [<span class="hljs-built_in" style="color:rgb(38,139,210)">AVMutableComposition</span> composition];


    <span class="hljs-comment" style="color:rgb(147,161,161)">// 视频采集</span>
    <span class="hljs-built_in" style="color:rgb(38,139,210)">AVURLAsset</span> *videoAsset = [[<span class="hljs-built_in" style="color:rgb(38,139,210)">AVURLAsset</span> alloc] initWithURL:videoInputUrl options:<span class="hljs-literal" style="">nil</span>];
    <span class="hljs-comment" style="color:rgb(147,161,161)">// 视频时间范围</span>
    <span class="hljs-built_in" style="color:rgb(38,139,210)">CMTimeRange</span> videoTimeRange = <span class="hljs-built_in" style="color:rgb(38,139,210)">CMTimeRangeMake</span>(kCMTimeZero, videoAsset.duration);
    <span class="hljs-comment" style="color:rgb(147,161,161)">// 视频通道 枚举 kCMPersistentTrackID_Invalid = 0</span>
    <span class="hljs-built_in" style="color:rgb(38,139,210)">AVMutableCompositionTrack</span> *videoTrack = [comosition addMutableTrackWithMediaType:<span class="hljs-built_in" style="color:rgb(38,139,210)">AVMediaTypeVideo</span> preferredTrackID:kCMPersistentTrackID_Invalid];
    <span class="hljs-comment" style="color:rgb(147,161,161)">// 视频采集通道</span>
    <span class="hljs-built_in" style="color:rgb(38,139,210)">AVAssetTrack</span> *videoAssetTrack = [[videoAsset tracksWithMediaType:<span class="hljs-built_in" style="color:rgb(38,139,210)">AVMediaTypeVideo</span>] firstObject];
    <span class="hljs-comment" style="color:rgb(147,161,161)">//  把采集轨道数据加入到可变轨道之中</span>
    [videoTrack insertTimeRange:videoTimeRange ofTrack:videoAssetTrack atTime:nextClistartTime error:<span class="hljs-literal" style="">nil</span>];



    <span class="hljs-comment" style="color:rgb(147,161,161)">// 声音采集</span>
    <span class="hljs-built_in" style="color:rgb(38,139,210)">AVURLAsset</span> *audioAsset = [[<span class="hljs-built_in" style="color:rgb(38,139,210)">AVURLAsset</span> alloc] initWithURL:audioInputUrl options:<span class="hljs-literal" style="">nil</span>];
    <span class="hljs-comment" style="color:rgb(147,161,161)">// 因为视频短这里就直接用视频长度了,如果自动化需要自己写判断</span>
    <span class="hljs-built_in" style="color:rgb(38,139,210)">CMTimeRange</span> audioTimeRange = videoTimeRange;
    <span class="hljs-comment" style="color:rgb(147,161,161)">// 音频通道</span>
    <span class="hljs-built_in" style="color:rgb(38,139,210)">AVMutableCompositionTrack</span> *audioTrack = [comosition addMutableTrackWithMediaType:<span class="hljs-built_in" style="color:rgb(38,139,210)">AVMediaTypeAudio</span> preferredTrackID:kCMPersistentTrackID_Invalid];
    <span class="hljs-comment" style="color:rgb(147,161,161)">// 音频采集通道</span>
    <span class="hljs-built_in" style="color:rgb(38,139,210)">AVAssetTrack</span> *audioAssetTrack = [[audioAsset tracksWithMediaType:<span class="hljs-built_in" style="color:rgb(38,139,210)">AVMediaTypeAudio</span>] firstObject];
    <span class="hljs-comment" style="color:rgb(147,161,161)">// 加入合成轨道之中</span>
    [audioTrack insertTimeRange:audioTimeRange ofTrack:audioAssetTrack atTime:nextClistartTime error:<span class="hljs-literal" style="">nil</span>];

    <span class="hljs-comment" style="color:rgb(147,161,161)">// 创建一个输出</span>
    <span class="hljs-built_in" style="color:rgb(38,139,210)">AVAssetExportSession</span> *assetExport = [[<span class="hljs-built_in" style="color:rgb(38,139,210)">AVAssetExportSession</span> alloc] initWithAsset:comosition presetName:<span class="hljs-built_in" style="color:rgb(38,139,210)">AVAssetExportPresetMediumQuality</span>];
    <span class="hljs-comment" style="color:rgb(147,161,161)">// 输出类型</span>
    assetExport.outputFileType = <span class="hljs-built_in" style="color:rgb(38,139,210)">AVFileTypeQuickTimeMovie</span>;
    <span class="hljs-comment" style="color:rgb(147,161,161)">// 输出地址</span>
    assetExport.outputURL = outputFileUrl;
    <span class="hljs-comment" style="color:rgb(147,161,161)">// 优化</span>
    assetExport.shouldOptimizeForNetworkUse = <span class="hljs-literal" style="">YES</span>;
    <span class="hljs-comment" style="color:rgb(147,161,161)">// 合成完毕</span>
    [assetExport exportAsynchronouslyWithCompletionHandler:^{
        <span class="hljs-comment" style="color:rgb(147,161,161)">// 回到主线程</span>
        <span class="hljs-built_in" style="color:rgb(38,139,210)">dispatch_async</span>(dispatch_get_main_queue(), ^{
            <span class="hljs-comment" style="color:rgb(147,161,161)">// 调用播放方法</span>
            [<span class="hljs-keyword" style="color:rgb(133,153,0)">self</span> playWithUrl:outputFileUrl];
        });
    }];
}

<span class="hljs-comment" style="color:rgb(147,161,161)">/** 播放方法 */</span>
- (<span class="hljs-keyword" style="color:rgb(133,153,0)">void</span>)playWithUrl:(<span class="hljs-built_in" style="color:rgb(38,139,210)">NSURL</span> *)url{
    <span class="hljs-comment" style="color:rgb(147,161,161)">// 传入地址</span>
    <span class="hljs-built_in" style="color:rgb(38,139,210)">AVPlayerItem</span> *playerItem = [<span class="hljs-built_in" style="color:rgb(38,139,210)">AVPlayerItem</span> playerItemWithURL:url];
    <span class="hljs-comment" style="color:rgb(147,161,161)">// 播放器</span>
    <span class="hljs-built_in" style="color:rgb(38,139,210)">AVPlayer</span> *player = [<span class="hljs-built_in" style="color:rgb(38,139,210)">AVPlayer</span> playerWithPlayerItem:playerItem];
    <span class="hljs-comment" style="color:rgb(147,161,161)">// 播放器layer</span>
    <span class="hljs-built_in" style="color:rgb(38,139,210)">AVPlayerLayer</span> *playerLayer = [<span class="hljs-built_in" style="color:rgb(38,139,210)">AVPlayerLayer</span> playerLayerWithPlayer:player];
    playerLayer.frame = <span class="hljs-keyword" style="color:rgb(133,153,0)">self</span>.imageView.frame;
    <span class="hljs-comment" style="color:rgb(147,161,161)">// 视频填充模式</span>
    playerLayer.videoGravity = <span class="hljs-built_in" style="color:rgb(38,139,210)">AVLayerVideoGravityResizeAspect</span>;
    <span class="hljs-comment" style="color:rgb(147,161,161)">// 添加到imageview的layer上</span>
    [<span class="hljs-keyword" style="color:rgb(133,153,0)">self</span>.imageView.layer addSublayer:playerLayer];
    <span class="hljs-comment" style="color:rgb(147,161,161)">// 隐藏提示框 开始播放</span>
    [MBProgressHUD hideHUD];
    [MBProgressHUD showSuccess:<span class="hljs-string" style="color:rgb(42,161,152)">@"合成完成"</span>];
    <span class="hljs-comment" style="color:rgb(147,161,161)">// 播放</span>
    [player play];
}</code></pre>
    <h3 style="line-height:1.7; color:rgb(47,47,47); margin:0px 0px 15px; font-size:24px">
     MBP是一个第三方提示类,如果不关心这个功能可以删除这三行代码和头文件
    </h3>
    <pre class="hljs groovy" style="overflow:auto; font-family:Menlo,Monaco,Consolas,'Courier New',monospace; font-size:13px; padding:15px; margin-top:0px; margin-bottom:20px; line-height:1.42857; word-break:break-word; word-wrap:normal; color:rgb(101,123,131); background-color:rgb(246,246,246); border:1px solid rgb(204,204,204)"><code class="groovy" style="font-family:Menlo,Monaco,Consolas,'Courier New',monospace; font-size:12px; background-color:transparent; padding:0px; border:none"><span class="hljs-comment" style="color:rgb(147,161,161)">// mbp提示框</span>
    [MBProgressHUD <span class="hljs-string" style="color:rgb(42,161,152)">showMessage:</span>@<span class="hljs-string" style="color:rgb(42,161,152)">"正在处理中"</span>];
<span class="hljs-comment" style="color:rgb(147,161,161)">// 隐藏提示框 开始播放</span>
    [MBProgressHUD hideHUD];
    [MBProgressHUD <span class="hljs-string" style="color:rgb(42,161,152)">showSuccess:</span>@<span class="hljs-string" style="color:rgb(42,161,152)">"合成完成"</span>];</code></pre>
    <h2 style="font-size:26px; margin:0px 0px 15px; line-height:1.7; color:rgb(47,47,47)">
     效果图
    </h2>
    <h4 style="line-height:1.7; color:rgb(47,47,47); margin:0px 0px 15px; font-size:22px">
     因为是gif..请自己yy出Uber视频配上五环之歌(我感觉还挺配的)
    </h4>
    <div class="image-package" style="padding-bottom:25px; width:700px; margin-left:-40px; text-align:center; color:rgb(47,47,47); font-size:16px">
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/bc1b75f4b6822618f030a2baf26ca501.webp?x-image-process=image/format,png" style="">
      <br style=""/>
      <div class="image-caption" style="min-width:20%; max-width:80%; min-height:22px; display:inline-block; padding:10px; margin:0px auto; border-bottom-width:1px; border-bottom-style:solid; border-bottom-color:rgb(217,217,217); font-size:14px; color:rgb(150,150,150); line-height:1.7">
       这里写图片描述
      </div>
     </img>
    </div>
    <h3 style="line-height:1.7; color:rgb(47,47,47); margin:0px 0px 15px; font-size:24px">
     GitHub:
     <a href="https://github.com/Lafree317/MergeVideoAndMusic" rel="noopener noreferrer" style="background-color:transparent; color:rgb(49,148,208); text-decoration:none" target="_blank">
      https://github.com/Lafree317/MergeVideoAndMusic
     </a>
    </h3>
    <br/>
    <p>
     <br/>
    </p>
    <p>
     <br/>
    </p>
   </div>
  </div>
 </article>
 <p alt="68747470733a2f2f:626c6f672e6373646e2e6e65742f6a65737365383831303235:2f61727469636c652f64657461696c732f3538313532373235" class_="artid" style="display:none">
 </p>
</div>


