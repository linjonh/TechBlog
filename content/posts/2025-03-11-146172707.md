---
layout: post
title: "网络编程HTTP网络编程"
date: 2025-03-11 12:04:59 +0800
description: "HTTP(Hyper  Text  Transfer  Protocol,超文本传输协议)是用于从万维网(WWW:World  Wide Web) 服务器(简称Web 服务器)传输超文本到本地浏览器的传送协议，基于TCP/IP 通信协 议来传递数据 (HTML   文件、图片文件、查询结果等)。"
keywords: "【网络编程】HTTP网络编程"
categories: ['网络编程']
tags: ['网络协议', '网络', 'Http']
artid: "146172707"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146172707
    alt: "网络编程HTTP网络编程"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146172707
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146172707
cover: https://bing.ee123.net/img/rand?artid=146172707
image: https://bing.ee123.net/img/rand?artid=146172707
img: https://bing.ee123.net/img/rand?artid=146172707
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     【网络编程】HTTP网络编程
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h3>
     <a id="131___HTTP__0">
     </a>
     13.1 HTTP 简介
    </h3>
    <p>
     HTTP(Hyper Text Transfer Protocol,超文本传输协议)是用于从万维网(WWW:World Wide Web) 服务器(简称Web 服务器)传输超文本到本地浏览器的传送协议，基于TCP/IP 通信协 议来传递数据 (HTML 文件、图片文件、查询结果等)。
    </p>
    <h3>
     <a id="132__HTTP__3">
     </a>
     13.2 HTTP 的工作原理
    </h3>
    <p>
     HTTP协议工作于客户端/服务器端架构上。浏览器作为HTTP 客户端通过URL 向 HTTP 服务器端即Web 服务器发送所有请求。
    </p>
    <p>
     Web服务器有Apache 服务器、IIS 服务器 (Internet Information Services) 等。 Web服务器根据接收到的请求向客户端发送响应信息。
     <br/>
     HTTP 的默认端口号为80,但是你也可以改为8080或者其他端口。 HTTP的注意事项如下3点：
    </p>
    <ul>
     <li>
      (1)HTTP 是无连接：无连接的含义是限制每次连接只处理一个请求。服务器处理完客 户的请求，并收到客户的应答后即断开连接。采用这种方式可以节省传输时间。
     </li>
     <li>
      (2)HTTP 是媒体独立的：这意味着，只要客户端和服务器知道如何处理数据内容，任 何类型的数据都可以通过HTTP 发送。客户端以及服务器指定使用适合的MIME-type内容类 型。
     </li>
     <li>
      (3)HTTP 是无状态的：HTTP 协议是无状态协议。无状态是指协议对于事务处理没有记 忆能力。缺少状态意味着如果后续处理需要前面的信息，则它必须重传，这样可能导致每次连 接传送的数据量增大。另一方面，在服务器不需要先前信息时它的应答较快。
     </li>
    </ul>
    <p>
     我们来看一下HTTP 协议通信流程，如图13-1所示。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/5ea8743a24434149bebf646c5c021d38.png"/>
    </p>
    <h3>
     <a id="133_HTTP__22">
     </a>
     13.3 HTTP 的特点
    </h3>
    <p>
     HTTP 协议的主要特点可概括如下：
    </p>
    <ul>
     <li>
      (1)支持客户/服务器模式。
     </li>
     <li>
      (2)简单快速：客户向服务器请求服务时，只需传送请求方法和路径。请求方法常用的 有 GET 、HEAD 、POST 。每种方法规定了客户与服务器联系的类型不同。HTTP 协议简单， 使得HTTP 服务器的程序规模小，因而通信速度很快。
     </li>
     <li>
      (3)灵活： HTTP 允许传输任意类型的数据对象。正在传输的类型由Content-Type 加 以 标记 。
     </li>
     <li>
      (4)无连接：无连接的含义是限制每次连接只处理一个请求。服务器处理完客户的请求， 并收到客户的应答后即断开连接。采用这种方式可以节省传输时间。
     </li>
     <li>
      (5)无状态： HTTP 协议是无状态协议。无状态是指协议对于事务处理没有记忆能力。 缺少状态意味着如果后续处理需要前面的信息，则它必须重传，这样可能导致每次连接传送的 数据量增大。另一方面，在服务器不需要先前信息时它的应答就较快。
     </li>
    </ul>
    <h3>
     <a id="134__HTTP__34">
     </a>
     13.4 HTTP 的消息结构
    </h3>
    <ul>
     <li>
      <p>
       HTTP 是基于客户端/服务器端 (C/S) 的架构模型，通过一个可靠的链接来交换信息，是一个无状态的请求/响应协议。
      </p>
     </li>
     <li>
      <p>
       一 个HTTP 客户端是一个应用程序(Web 浏览器或其他任何客户端),通过连接到服务 器达到向服务器发送一个或多个HTTP 请求的目的。
      </p>
     </li>
     <li>
      <p>
       一 个HTTP 服务器同样也是一个应用程序(通常是一个Web 服务，如Apache Web服务 器或IS 服务器等),接收客户端的请求并向客户端发送HTTP 响应数据。
      </p>
     </li>
     <li>
      <p>
       HTTP使用统一资源标识符(Uniform Resource Identifiers,URI)来传输数据和建立连接。
      </p>
     </li>
     <li>
      <p>
       一旦建立连接后，数据消息就通过类似 Internet 邮件所使用的格式[RFC5322]和多用途 Internet邮件扩展 (MIME)[RFC2045] 来传送。
      </p>
     </li>
    </ul>
    <h3>
     <a id="135__45">
     </a>
     13.5 客户端请求消息
    </h3>
    <p>
     客户端发送一个HTTP 请求到服务器的请求消息由请求行(request line)、请求头部(也 称请求头)、空行和请求数据4部分组成。图13-2给出了请求报文的一般格式。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/f9c02c4dfda5459192eb621747a0ca29.png">
      <br/>
      HTTP 协议定义了8种请求方法(或者叫“动作”),表明对 Request-URI 指定的资源 的不同操作方式，具体如下：
     </img>
    </p>
    <ul>
     <li>
      (1)OPTIONS: 返回服务器针对特定资源所支持的HTTP 请求方法。也可以利用向Web 服务器发送’*'的请求来测试服务器的功能性。
     </li>
     <li>
      (2)HEAD: 向服务器索要与GET 请求相一致的响应，只不过响应体将不会被返回。这 一方法可以在不必传输整个响应内容的情况下就获取包含在响应消息头中的元信息。
     </li>
     <li>
      (3)GET: 向特定的资源发出请求。
     </li>
     <li>
      (4)POST: 向指定资源提交数据进行处理请求(例如，提交表单或者上传文件)。数据 被包含在请求体中。POST 请求可能会导致新资源的创建和/或已有资源的修改。
     </li>
     <li>
      (5)PUT: 向指定资源位置上传其最新内容。
     </li>
     <li>
      (6)DELETE: 请求服务器删除 Request-URI 所标识的资源。
     </li>
     <li>
      (7)TRACE: 回显服务器收到的请求，主要用于测试或诊断。
     </li>
     <li>
      (8)CONNECT:HTTP/1.1 协议中预留给能够将连接改为管道方式的代理服务器。
     </li>
    </ul>
    <p>
     虽然HTTP 的请求方式有8种，但是我们在实际应用中常用的也就是get 和post, 其他请 求方式也都可以通过这两种方式间接地实现。
    </p>
    <h3>
     <a id="136__63">
     </a>
     13.6 服务器响应消息
    </h3>
    <p>
     HTTP 响应也由4个部分组成，分别是状态行、消息报头(也称响应头)、空行和响应正文，如图13-3所示。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/3598bb010fd3456e9fa495344baf5d2c.png"/>
    </p>
    <hr/>
    <p>
     下面给出一个典型的使用GET来传递数据的实例。
    </p>
    <p>
     <strong>
      客户端请求：
     </strong>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/d7bcdf45a88748acb84f5bb789338a6b.png"/>
    </p>
    <p>
     <strong>
      服务器端响应：
     </strong>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/8f8dd91c3b094d908627b40777ba3e80.png"/>
    </p>
    <p>
     <strong>
      输出结果
     </strong>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/0b307cbfa9454f66b66632dab6b43f4a.png"/>
    </p>
    <p>
     图13-4演示请求和响应HTTP报文的操作。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/9e8e52cc647443219d0c05cfc019f406.png"/>
    </p>
    <h3>
     <a id="137_HTTP__96">
     </a>
     13.7 HTTP 状态码
    </h3>
    <p>
     当浏览者访问一个网页时，浏览者的浏览器会向网页所在服务器发出请求。当浏览器接收 并显示网页前，此网页所在的服务器会返回一个包含HTTP 状态码的信息头(server header), 用以响应浏览器的请求。
     <br/>
     HTTP状态码的英文为HTTP Status Code。下面是常见的HTTP 状态码：
    </p>
    <ul>
     <li>
      200:请求成功。
     </li>
     <li>
      301:资源(网页等)被永久转移到其他URL。
     </li>
     <li>
      404:请求的资源(网页等)不存在。
     </li>
     <li>
      500:内部服务器错误。
     </li>
    </ul>
    <h3>
     <a id="138_HTTP__106">
     </a>
     13.8 HTTP 状态码分类
    </h3>
    <p>
     HTTP状态码由3个十进制数字组成，第一个十进制数字定义状态码的类型，后两个数字没有分类的作用。HTTP 状态码共分为5种类型，如表13-1所示。
    </p>
    <table>
     <thead>
      <tr>
       <th>
       </th>
       <th>
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        分类
       </td>
       <td>
        分类描述
       </td>
      </tr>
      <tr>
       <td>
        1**
       </td>
       <td>
        信息，服务器收到请求，需要请求者继续执行操作
       </td>
      </tr>
      <tr>
       <td>
        2**
       </td>
       <td>
        成功，操作被成功接收并处理
       </td>
      </tr>
      <tr>
       <td>
        3**
       </td>
       <td>
        重定向，需要进一步的操作以完成请求
       </td>
      </tr>
      <tr>
       <td>
        4**
       </td>
       <td>
        客户端错误，请求包含语法错误或无法完成请求
       </td>
      </tr>
      <tr>
       <td>
        5**
       </td>
       <td>
        服务器错误，服务器在处理请求的过程中发生了错误
       </td>
      </tr>
     </tbody>
    </table>
    <h3>
     <a id="139_HTTP__119">
     </a>
     13.9 实现HTTP 服务器
    </h3>
    <p>
     前面对 HTTP 协议进行了简单的介绍。下面我们利用前面的网络技术来实现一个 HTTP 服务器。我们学了好多服务器技术，比如CAsynSocket 、CSocket 、WSAAsyncSelect等。这里 我们选择WSAAsyncSelect 技 术 。
    </p>
    <p>
     WSAAsyncSelect 模型是Windows socket的一个异步I/O 模 型，利用这个模型，应用程序可在一个套接字上接收以Windows 消息为基础的网络事件通知。 Windows sockets应用程序在创建套接字后，调用WSAAsyncSelect 函数注册感兴趣的网络事 件，当该事件发生时Windows 窗口收到消息，应用程序就可以对接收到的网络事件进行处理。 利用 WSAAsyncSelect 函数，将socket 消息发送到 hWnd 窗口上，然后在那里处理相应的 FD_READ 、FD_WRITE等消息。更多关于WSAAsyncSelect 的知识，我们前面章节已经介绍 过 了 。
    </p>
    <p>
     为了便于学习，我们的HTTP 实现的功能并不多，主要实现了HTTP 最基本的一些功能。 大家可以把这个例子作为原型，完善其功能。
    </p>
    <p>
     我们的HTTP 服务器基于异步选择模型WSAAsyncSelect。通过前面章节的学习应该知道， 这个模型需要一个Windows 窗口，因此我们的程序是一个基于对话框的程序。
    </p>
    <h4>
     <a id="1392__128">
     </a>
     13.9.2 界面设计
    </h4>
    <ul>
     <li>
      (1)新建一个对话框工程，工程名是WebServer。
     </li>
     <li>
      (2)切换到资源视图，打开对话框编辑器，放置按钮，如图13-5所示。
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/bfb293ab8ff74a5b975d74026ba064f0.png">
       <br/>
       从控件标题我们大致能知道其含义了。其中，服务器的根目录主要是放置网页文件的，比 如 index.htm。
      </img>
     </li>
    </ul>
    <p>
     <strong>
      log.h
     </strong>
    </p>
    <pre><code class="prism language-cpp"><span class="token comment">//zww</span>
<span class="token comment">/****************************************************************************************
* ///
*	Original Filename: 	Log.h
*
*	
*	Comments:	
* \\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
****************************************************************************************/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>AFX_LOG_H__82043CA7_5940_4F7E_A316_7F91096B2008__INCLUDED_<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AFX_LOG_H__82043CA7_5940_4F7E_A316_7F91096B2008__INCLUDED_</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">_MSC_VER <span class="token operator">&gt;</span> <span class="token number">1000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">once</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">// _MSC_VER &gt; 1000</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_MSG_SIZE</span>	<span class="token expression"><span class="token number">1024</span></span></span>

<span class="token keyword">class</span> <span class="token class-name">CLog</span>  
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
	BOOL <span class="token function">ClearLog</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	BOOL <span class="token function">LogMessage</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token keyword">long</span> <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">CLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">CLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">private</span><span class="token operator">:</span>
	FILE <span class="token operator">*</span>m_f<span class="token punctuation">;</span>
	<span class="token keyword">char</span> szLogFilePath<span class="token punctuation">[</span>MAX_PATH<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> szMessage<span class="token punctuation">[</span>MAX_MSG_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> szDT<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">tm</span> <span class="token operator">*</span>newtime<span class="token punctuation">;</span>
	time_t ltime<span class="token punctuation">;</span>
	CRITICAL_SECTION cs<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">// !defined(AFX_LOG_H__82043CA7_5940_4F7E_A316_7F91096B2008__INCLUDED_)</span></span>

</code></pre>
    <p>
     log.cpp
    </p>
    <pre><code class="prism language-cpp"><span class="token comment">//zww</span>
<span class="token comment">/****************************************************************************************
* ///
*	Original Filename: 	Log.cpp
*
*	History:
*	Created/Modified by				Date			Main Purpose/Changes
*	Souren M. Abeghyan				2001/05/25		Implementation of the CLog class.
*	
*	Comments:	
* \\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
****************************************************************************************/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stdafx.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Log.h"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">_DEBUG</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">undef</span> <span class="token expression">THIS_FILE</span></span>
<span class="token keyword">static</span> <span class="token keyword">char</span> THIS_FILE<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token constant">__FILE__</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">new</span> <span class="token expression">DEBUG_NEW</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token comment">//</span>
<span class="token comment">// Construction/Destruction</span>
<span class="token comment">//</span>

<span class="token class-name">CLog</span><span class="token double-colon punctuation">::</span><span class="token function">CLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">InitializeCriticalSection</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cs<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">CLog</span><span class="token double-colon punctuation">::</span><span class="token operator">~</span><span class="token function">CLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">DeleteCriticalSection</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cs<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>



BOOL <span class="token class-name">CLog</span><span class="token double-colon punctuation">::</span><span class="token function">LogMessage</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>szFolder<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>szMsg<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>szMsg1<span class="token punctuation">,</span> <span class="token keyword">long</span> nNumber<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">EnterCriticalSection</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cs<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">time</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ltime<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获得计算机系统当前的日历时间</span>

	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strlen</span><span class="token punctuation">(</span>szFolder<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strlen</span><span class="token punctuation">(</span>szMsg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
	
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">GetWindowsDirectory</span><span class="token punctuation">(</span>szLogFilePath<span class="token punctuation">,</span> MAX_PATH<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">LeaveCriticalSection</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cs<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token keyword">if</span><span class="token punctuation">(</span>szLogFilePath<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token char">'\\'</span><span class="token punctuation">)</span>
		<span class="token function">strcat</span><span class="token punctuation">(</span>szLogFilePath<span class="token punctuation">,</span> <span class="token string">"\\"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">strcat</span><span class="token punctuation">(</span>szLogFilePath<span class="token punctuation">,</span> szFolder<span class="token punctuation">)</span><span class="token punctuation">;</span>

	m_f <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>szLogFilePath<span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>m_f <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>				
	<span class="token punctuation">{<!-- --></span>
		newtime <span class="token operator">=</span> <span class="token function">localtime</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ltime<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//将时间数值变换成本地时间，考虑到本地时区和夏令时标志;</span>
		<span class="token function">strftime</span><span class="token punctuation">(</span>szDT<span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token comment">// 格式化显示日期时间</span>
					<span class="token string">"%a, %d %b %Y %H:%M:%S"</span><span class="token punctuation">,</span> newtime<span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token keyword">if</span><span class="token punctuation">(</span>szMsg1 <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
			<span class="token function">sprintf</span><span class="token punctuation">(</span>szMessage<span class="token punctuation">,</span> <span class="token string">"%s - %s.\t[%s]\t[%d]\n"</span><span class="token punctuation">,</span> szDT<span class="token punctuation">,</span> szMsg<span class="token punctuation">,</span> szMsg1<span class="token punctuation">,</span> nNumber<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">else</span>
			<span class="token function">sprintf</span><span class="token punctuation">(</span>szMessage<span class="token punctuation">,</span> <span class="token string">"%s - %s.\t[%d]\n"</span><span class="token punctuation">,</span> szDT<span class="token punctuation">,</span> szMsg<span class="token punctuation">,</span> nNumber<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token function">fwrite</span><span class="token punctuation">(</span>szMessage<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>szMessage<span class="token punctuation">)</span><span class="token punctuation">,</span> m_f<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>n <span class="token operator">!=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>szMessage<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">LeaveCriticalSection</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cs<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">fclose</span><span class="token punctuation">(</span>m_f<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token function">fclose</span><span class="token punctuation">(</span>m_f<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">LeaveCriticalSection</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cs<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> TRUE<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">LeaveCriticalSection</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cs<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>



BOOL <span class="token class-name">CLog</span><span class="token double-colon punctuation">::</span><span class="token function">ClearLog</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>szFolder<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strlen</span><span class="token punctuation">(</span>szFolder<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
	
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">GetWindowsDirectory</span><span class="token punctuation">(</span>szLogFilePath<span class="token punctuation">,</span> MAX_PATH<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>

	<span class="token keyword">if</span><span class="token punctuation">(</span>szLogFilePath<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token char">'\\'</span><span class="token punctuation">)</span>
		<span class="token function">strcat</span><span class="token punctuation">(</span>szLogFilePath<span class="token punctuation">,</span> <span class="token string">"\\"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">strcat</span><span class="token punctuation">(</span>szLogFilePath<span class="token punctuation">,</span> szFolder<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> 	<span class="token function">DeleteFile</span><span class="token punctuation">(</span>szLogFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
    <p>
     WebServer.h
    </p>
    <pre><code class="prism language-cpp"><span class="token comment">//zww</span>
<span class="token comment">// WebServer.h : main header file for the WEBSERVER application</span>
<span class="token comment">//</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>AFX_WEBSERVER_H__3F794A8E_734C_4694_8F25_F7CC03C513E5__INCLUDED_<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AFX_WEBSERVER_H__3F794A8E_734C_4694_8F25_F7CC03C513E5__INCLUDED_</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">_MSC_VER <span class="token operator">&gt;</span> <span class="token number">1000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">once</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">// _MSC_VER &gt; 1000</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__AFXWIN_H__</span></span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">error</span> <span class="token expression">include </span><span class="token char">'stdafx.h'</span> <span class="token expression">before including <span class="token keyword">this</span> file <span class="token keyword">for</span> PCH</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"resource.h"</span>		<span class="token comment">// main symbols</span></span>

<span class="token comment">/</span>
<span class="token comment">// CWebServerApp:</span>
<span class="token comment">// See WebServer.cpp for the implementation of this class</span>
<span class="token comment">//</span>

<span class="token keyword">class</span> <span class="token class-name">CWebServerApp</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">CWinApp</span></span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
	<span class="token function">CWebServerApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Overrides</span>
	<span class="token comment">// ClassWizard generated virtual function overrides</span>
	<span class="token comment">//{<!-- -->{AFX_VIRTUAL(CWebServerApp)</span>
	<span class="token keyword">public</span><span class="token operator">:</span>
	<span class="token keyword">virtual</span> BOOL <span class="token function">InitInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//}}AFX_VIRTUAL</span>

<span class="token comment">// Implementation</span>

	<span class="token comment">//{<!-- -->{AFX_MSG(CWebServerApp)</span>
		<span class="token comment">// NOTE - the ClassWizard will add and remove member functions here.</span>
		<span class="token comment">//    DO NOT EDIT what you see in these blocks of generated code !</span>
	<span class="token comment">//}}AFX_MSG</span>
	<span class="token function">DECLARE_MESSAGE_MAP</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token comment">/</span>

<span class="token comment">//{<!-- -->{AFX_INSERT_LOCATION}}</span>
<span class="token comment">// Microsoft Visual C++ will insert additional declarations immediately before the previous line.</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">// !defined(AFX_WEBSERVER_H__3F794A8E_734C_4694_8F25_F7CC03C513E5__INCLUDED_)</span></span>

</code></pre>
    <p>
     WebServer.cpp
    </p>
    <pre><code class="prism language-cpp"><span class="token comment">// WebServer.cpp : Defines the class behaviors for the application.</span>
<span class="token comment">// zww</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stdafx.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"WebServer.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"WebServerDlg.h"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">_DEBUG</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">new</span> <span class="token expression">DEBUG_NEW</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">undef</span> <span class="token expression">THIS_FILE</span></span>
<span class="token keyword">static</span> <span class="token keyword">char</span> THIS_FILE<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">__FILE__</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token comment">/</span>
<span class="token comment">// CWebServerApp</span>

<span class="token function">BEGIN_MESSAGE_MAP</span><span class="token punctuation">(</span>CWebServerApp<span class="token punctuation">,</span> CWinApp<span class="token punctuation">)</span>
	<span class="token comment">//{<!-- -->{AFX_MSG_MAP(CWebServerApp)</span>
		<span class="token comment">// NOTE - the ClassWizard will add and remove mapping macros here.</span>
		<span class="token comment">//    DO NOT EDIT what you see in these blocks of generated code!</span>
	<span class="token comment">//}}AFX_MSG</span>
	<span class="token function">ON_COMMAND</span><span class="token punctuation">(</span>ID_HELP<span class="token punctuation">,</span> CWinApp<span class="token double-colon punctuation">::</span>OnHelp<span class="token punctuation">)</span>
<span class="token function">END_MESSAGE_MAP</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">/</span>
<span class="token comment">// CWebServerApp construction</span>

<span class="token class-name">CWebServerApp</span><span class="token double-colon punctuation">::</span><span class="token function">CWebServerApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">// TODO: add construction code here,</span>
	<span class="token comment">// Place all significant initialization in InitInstance</span>
<span class="token punctuation">}</span>

<span class="token comment">/</span>
<span class="token comment">// The one and only CWebServerApp object</span>

CWebServerApp theApp<span class="token punctuation">;</span>

<span class="token comment">/</span>
<span class="token comment">// CWebServerApp initialization</span>

BOOL <span class="token class-name">CWebServerApp</span><span class="token double-colon punctuation">::</span><span class="token function">InitInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">AfxEnableControlContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Standard initialization</span>
	<span class="token comment">// If you are not using these features and wish to reduce the size</span>
	<span class="token comment">//  of your final executable, you should remove from the following</span>
	<span class="token comment">//  the specific initialization routines you do not need.</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">_AFXDLL</span></span>
	<span class="token function">Enable3dControls</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">// Call this when using MFC in a shared DLL</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
	<span class="token function">Enable3dControlsStatic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// Call this when linking to MFC statically</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

	<span class="token function">SetRegistryKey</span><span class="token punctuation">(</span><span class="token string">"AcID_Soft"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//弹出对话框</span>
	CWebServerDlg dlg<span class="token punctuation">;</span>
	m_pMainWnd <span class="token operator">=</span> <span class="token operator">&amp;</span>dlg<span class="token punctuation">;</span>
	<span class="token keyword">int</span> nResponse <span class="token operator">=</span> dlg<span class="token punctuation">.</span><span class="token function">DoModal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>nResponse <span class="token operator">==</span> IDOK<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token comment">// TODO: Place code here to handle when the dialog is</span>
		<span class="token comment">//  dismissed with OK</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>nResponse <span class="token operator">==</span> IDCANCEL<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token comment">// TODO: Place code here to handle when the dialog is</span>
		<span class="token comment">//  dismissed with Cancel</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Since the dialog has been closed, return FALSE so that we exit the</span>
	<span class="token comment">//  application, rather than start the application's message pump.</span>
	<span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
    <p>
     WebServerDlg.h
    </p>
    <pre><code class="prism language-cpp"><span class="token comment">//zww</span>
<span class="token comment">// WebServerDlg.h : header file</span>
<span class="token comment">//</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>AFX_WEBSERVERDLG_H__8F4AD293_7AED_4ED5_A263_0ED2ED7032C8__INCLUDED_<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AFX_WEBSERVERDLG_H__8F4AD293_7AED_4ED5_A263_0ED2ED7032C8__INCLUDED_</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">_MSC_VER <span class="token operator">&gt;</span> <span class="token number">1000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">once</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">// _MSC_VER &gt; 1000</span></span>

<span class="token comment">/</span>
<span class="token comment">// CWebServerDlg dialog</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"HTTPServer.h"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TIMER_ID_1</span>	<span class="token expression"><span class="token number">1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TIMER_TO_1</span>	<span class="token expression"><span class="token number">500</span></span></span>

<span class="token keyword">class</span> <span class="token class-name">CWebServerDlg</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">CDialog</span></span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
	UINT	nTimerID<span class="token punctuation">;</span>
	BOOL	m_bRun<span class="token punctuation">;</span>
<span class="token comment">// Construction</span>
<span class="token keyword">public</span><span class="token operator">:</span>
	<span class="token keyword">void</span> <span class="token function">RestoreSettings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token function">SaveSettings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">CWebServerDlg</span><span class="token punctuation">(</span>CWnd<span class="token operator">*</span> pParent <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// standard constructor</span>

<span class="token comment">// Dialog Data</span>
	<span class="token comment">//{<!-- -->{AFX_DATA(CWebServerDlg)</span>
	<span class="token keyword">enum</span> <span class="token punctuation">{<!-- --></span> IDD <span class="token operator">=</span> IDD_WEBSERVER_DIALOG <span class="token punctuation">}</span><span class="token punctuation">;</span>
	CStatic	m_nVisitors<span class="token punctuation">;</span>
	CStatic	m_nBytesRecv<span class="token punctuation">;</span>
	CStatic	m_nBytesSent<span class="token punctuation">;</span>
	CStatic	m_nRequests<span class="token punctuation">;</span>
	CStatic	m_nActiveConn<span class="token punctuation">;</span>
	CString	m_szHomeDir<span class="token punctuation">;</span>
	CString	m_szDefIndex<span class="token punctuation">;</span>
	<span class="token keyword">int</span>		m_Port<span class="token punctuation">;</span>
	<span class="token keyword">int</span>		m_PTO<span class="token punctuation">;</span>
	CString	m_szStatus<span class="token punctuation">;</span>
	<span class="token comment">//}}AFX_DATA</span>

	<span class="token comment">// ClassWizard generated virtual function overrides</span>
	<span class="token comment">//{<!-- -->{AFX_VIRTUAL(CWebServerDlg)</span>
	<span class="token keyword">protected</span><span class="token operator">:</span>
	<span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">DoDataExchange</span><span class="token punctuation">(</span>CDataExchange<span class="token operator">*</span> pDX<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// DDX/DDV support</span>
	<span class="token comment">//}}AFX_VIRTUAL</span>

<span class="token comment">// Implementation</span>
<span class="token keyword">protected</span><span class="token operator">:</span>
	HICON m_hIcon<span class="token punctuation">;</span>
	CHTTPServer WebServer<span class="token punctuation">;</span>

	<span class="token comment">// Generated message map functions</span>
	<span class="token comment">//{<!-- -->{AFX_MSG(CWebServerDlg)</span>
	<span class="token keyword">virtual</span> BOOL <span class="token function">OnInitDialog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	afx_msg <span class="token keyword">void</span> <span class="token function">OnSysCommand</span><span class="token punctuation">(</span>UINT nID<span class="token punctuation">,</span> LPARAM lParam<span class="token punctuation">)</span><span class="token punctuation">;</span>
	afx_msg <span class="token keyword">void</span> <span class="token function">OnPaint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	afx_msg HCURSOR <span class="token function">OnQueryDragIcon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	afx_msg <span class="token keyword">void</span> <span class="token function">OnStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	afx_msg <span class="token keyword">void</span> <span class="token function">OnStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	afx_msg <span class="token keyword">void</span> <span class="token function">OnClose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">OnOK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	afx_msg <span class="token keyword">void</span> <span class="token function">OnTimer</span><span class="token punctuation">(</span>UINT nIDEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
	afx_msg <span class="token keyword">void</span> <span class="token function">OnReset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	afx_msg <span class="token keyword">void</span> <span class="token function">OnHomedirbrowse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//}}AFX_MSG</span>
	<span class="token function">DECLARE_MESSAGE_MAP</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">//{<!-- -->{AFX_INSERT_LOCATION}}</span>
<span class="token comment">// Microsoft Visual C++ will insert additional declarations immediately before the previous line.</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">// !defined(AFX_WEBSERVERDLG_H__8F4AD293_7AED_4ED5_A263_0ED2ED7032C8__INCLUDED_)</span></span>

</code></pre>
    <p>
     WebServerDlg.cpp
    </p>
    <pre><code class="prism language-cpp"><span class="token comment">// WebServerDlg.cpp : implementation file</span>
<span class="token comment">// zww</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stdafx.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"WebServer.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"WebServerDlg.h"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">_DEBUG</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">new</span> <span class="token expression">DEBUG_NEW</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">undef</span> <span class="token expression">THIS_FILE</span></span>
<span class="token keyword">static</span> <span class="token keyword">char</span> THIS_FILE<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">__FILE__</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token comment">/</span>
<span class="token comment">// CAboutDlg dialog used for App About</span>

<span class="token keyword">class</span> <span class="token class-name">CAboutDlg</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">CDialog</span></span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
	<span class="token function">CAboutDlg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Dialog Data</span>
	<span class="token comment">//{<!-- -->{AFX_DATA(CAboutDlg)</span>
	<span class="token keyword">enum</span> <span class="token punctuation">{<!-- --></span> IDD <span class="token operator">=</span> IDD_ABOUTBOX <span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token comment">//}}AFX_DATA</span>

	<span class="token comment">// ClassWizard generated virtual function overrides</span>
	<span class="token comment">//{<!-- -->{AFX_VIRTUAL(CAboutDlg)</span>
	<span class="token keyword">protected</span><span class="token operator">:</span>
	<span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">DoDataExchange</span><span class="token punctuation">(</span>CDataExchange<span class="token operator">*</span> pDX<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// DDX/DDV support</span>
	<span class="token comment">//}}AFX_VIRTUAL</span>

<span class="token comment">// Implementation</span>
<span class="token keyword">protected</span><span class="token operator">:</span>
	<span class="token comment">//{<!-- -->{AFX_MSG(CAboutDlg)</span>
	<span class="token comment">//}}AFX_MSG</span>
	<span class="token function">DECLARE_MESSAGE_MAP</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token class-name">CAboutDlg</span><span class="token double-colon punctuation">::</span><span class="token function">CAboutDlg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">CDialog</span><span class="token punctuation">(</span>CAboutDlg<span class="token double-colon punctuation">::</span>IDD<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//{<!-- -->{AFX_DATA_INIT(CAboutDlg)</span>
	<span class="token comment">//}}AFX_DATA_INIT</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">CAboutDlg</span><span class="token double-colon punctuation">::</span><span class="token function">DoDataExchange</span><span class="token punctuation">(</span>CDataExchange<span class="token operator">*</span> pDX<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token class-name">CDialog</span><span class="token double-colon punctuation">::</span><span class="token function">DoDataExchange</span><span class="token punctuation">(</span>pDX<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//{<!-- -->{AFX_DATA_MAP(CAboutDlg)</span>
	<span class="token comment">//}}AFX_DATA_MAP</span>
<span class="token punctuation">}</span>

<span class="token function">BEGIN_MESSAGE_MAP</span><span class="token punctuation">(</span>CAboutDlg<span class="token punctuation">,</span> CDialog<span class="token punctuation">)</span>
	<span class="token comment">//{<!-- -->{AFX_MSG_MAP(CAboutDlg)</span>
		<span class="token comment">// No message handlers</span>
	<span class="token comment">//}}AFX_MSG_MAP</span>
<span class="token function">END_MESSAGE_MAP</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">/</span>
<span class="token comment">// CWebServerDlg dialog</span>

<span class="token class-name">CWebServerDlg</span><span class="token double-colon punctuation">::</span><span class="token function">CWebServerDlg</span><span class="token punctuation">(</span>CWnd<span class="token operator">*</span> pParent <span class="token comment">/*=NULL*/</span><span class="token punctuation">)</span>
	<span class="token operator">:</span> <span class="token function">CDialog</span><span class="token punctuation">(</span>CWebServerDlg<span class="token double-colon punctuation">::</span>IDD<span class="token punctuation">,</span> pParent<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//{<!-- -->{AFX_DATA_INIT(CWebServerDlg)</span>
	<span class="token comment">//初始化参数</span>
	m_szHomeDir <span class="token operator">=</span> <span class="token function">_T</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	m_szDefIndex <span class="token operator">=</span> <span class="token function">_T</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	m_Port <span class="token operator">=</span> <span class="token number">81</span><span class="token punctuation">;</span>
	m_PTO <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
	m_szStatus <span class="token operator">=</span> <span class="token function">_T</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//}}AFX_DATA_INIT</span>
	<span class="token comment">// Note that LoadIcon does not require a subsequent DestroyIcon in Win32</span>
	m_hIcon <span class="token operator">=</span> <span class="token function">AfxGetApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">LoadIcon</span><span class="token punctuation">(</span>IDR_MAINFRAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">CWebServerDlg</span><span class="token double-colon punctuation">::</span><span class="token function">DoDataExchange</span><span class="token punctuation">(</span>CDataExchange<span class="token operator">*</span> pDX<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token class-name">CDialog</span><span class="token double-colon punctuation">::</span><span class="token function">DoDataExchange</span><span class="token punctuation">(</span>pDX<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//{<!-- -->{AFX_DATA_MAP(CWebServerDlg)</span>
	<span class="token function">DDX_Control</span><span class="token punctuation">(</span>pDX<span class="token punctuation">,</span> IDC_VISITORS<span class="token punctuation">,</span> m_nVisitors<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">DDX_Control</span><span class="token punctuation">(</span>pDX<span class="token punctuation">,</span> IDC_BYTESRECV<span class="token punctuation">,</span> m_nBytesRecv<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">DDX_Control</span><span class="token punctuation">(</span>pDX<span class="token punctuation">,</span> IDC_BYTESENT<span class="token punctuation">,</span> m_nBytesSent<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">DDX_Control</span><span class="token punctuation">(</span>pDX<span class="token punctuation">,</span> IDC_REQUESTS<span class="token punctuation">,</span> m_nRequests<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">DDX_Control</span><span class="token punctuation">(</span>pDX<span class="token punctuation">,</span> IDC_ACTIVECONN<span class="token punctuation">,</span> m_nActiveConn<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">DDX_Text</span><span class="token punctuation">(</span>pDX<span class="token punctuation">,</span> IDC_HOMEDIR<span class="token punctuation">,</span> m_szHomeDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">DDX_Text</span><span class="token punctuation">(</span>pDX<span class="token punctuation">,</span> IDC_DEFINDEXFILE<span class="token punctuation">,</span> m_szDefIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">DDX_Text</span><span class="token punctuation">(</span>pDX<span class="token punctuation">,</span> IDC_PORT<span class="token punctuation">,</span> m_Port<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">DDV_MinMaxInt</span><span class="token punctuation">(</span>pDX<span class="token punctuation">,</span> m_Port<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">65535</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">DDX_Text</span><span class="token punctuation">(</span>pDX<span class="token punctuation">,</span> IDC_PTO<span class="token punctuation">,</span> m_PTO<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">DDV_MinMaxInt</span><span class="token punctuation">(</span>pDX<span class="token punctuation">,</span> m_PTO<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">DDX_Text</span><span class="token punctuation">(</span>pDX<span class="token punctuation">,</span> IDC_STATUS<span class="token punctuation">,</span> m_szStatus<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//}}AFX_DATA_MAP</span>
<span class="token punctuation">}</span>

<span class="token function">BEGIN_MESSAGE_MAP</span><span class="token punctuation">(</span>CWebServerDlg<span class="token punctuation">,</span> CDialog<span class="token punctuation">)</span>
	<span class="token comment">//{<!-- -->{AFX_MSG_MAP(CWebServerDlg)</span>
	<span class="token function">ON_WM_SYSCOMMAND</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">ON_WM_PAINT</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">ON_WM_QUERYDRAGICON</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">ON_BN_CLICKED</span><span class="token punctuation">(</span>IDC_START<span class="token punctuation">,</span> OnStart<span class="token punctuation">)</span>
	<span class="token function">ON_BN_CLICKED</span><span class="token punctuation">(</span>IDC_STOP<span class="token punctuation">,</span> OnStop<span class="token punctuation">)</span>
	<span class="token function">ON_WM_CLOSE</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">ON_WM_TIMER</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">ON_BN_CLICKED</span><span class="token punctuation">(</span>IDC_RESET<span class="token punctuation">,</span> OnReset<span class="token punctuation">)</span>
	<span class="token function">ON_BN_CLICKED</span><span class="token punctuation">(</span>IDC_HOMEDIRBROWSE<span class="token punctuation">,</span> OnHomedirbrowse<span class="token punctuation">)</span>
	<span class="token comment">//}}AFX_MSG_MAP</span>
<span class="token function">END_MESSAGE_MAP</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">/</span>
<span class="token comment">// CWebServerDlg message handlers</span>

BOOL <span class="token class-name">CWebServerDlg</span><span class="token double-colon punctuation">::</span><span class="token function">OnInitDialog</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token class-name">CDialog</span><span class="token double-colon punctuation">::</span><span class="token function">OnInitDialog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Add "About..." menu item to system menu.</span>

	<span class="token comment">// IDM_ABOUTBOX must be in the system command range.</span>
	<span class="token function">ASSERT</span><span class="token punctuation">(</span><span class="token punctuation">(</span>IDM_ABOUTBOX <span class="token operator">&amp;</span> <span class="token number">0xFFF0</span><span class="token punctuation">)</span> <span class="token operator">==</span> IDM_ABOUTBOX<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">ASSERT</span><span class="token punctuation">(</span>IDM_ABOUTBOX <span class="token operator">&lt;</span> <span class="token number">0xF000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	CMenu<span class="token operator">*</span> pSysMenu <span class="token operator">=</span> <span class="token function">GetSystemMenu</span><span class="token punctuation">(</span>FALSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>pSysMenu <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		CString strAboutMenu<span class="token punctuation">;</span>
		strAboutMenu<span class="token punctuation">.</span><span class="token function">LoadString</span><span class="token punctuation">(</span>IDS_ABOUTBOX<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>strAboutMenu<span class="token punctuation">.</span><span class="token function">IsEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			pSysMenu<span class="token operator">-&gt;</span><span class="token function">AppendMenu</span><span class="token punctuation">(</span>MF_SEPARATOR<span class="token punctuation">)</span><span class="token punctuation">;</span>
			pSysMenu<span class="token operator">-&gt;</span><span class="token function">AppendMenu</span><span class="token punctuation">(</span>MF_STRING<span class="token punctuation">,</span> IDM_ABOUTBOX<span class="token punctuation">,</span> strAboutMenu<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Set the icon for this dialog.  The framework does this automatically</span>
	<span class="token comment">//  when the application's main window is not a dialog</span>
	<span class="token function">SetIcon</span><span class="token punctuation">(</span>m_hIcon<span class="token punctuation">,</span> TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">// Set big icon</span>
	<span class="token function">SetIcon</span><span class="token punctuation">(</span>m_hIcon<span class="token punctuation">,</span> FALSE<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// Set small icon</span>
	
	<span class="token comment">// TODO: Add extra initialization here</span>
	m_bRun <span class="token operator">=</span> FALSE<span class="token punctuation">;</span>
	<span class="token comment">//保存设置</span>
	<span class="token function">RestoreSettings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//启动服务</span>
	<span class="token function">OnStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token keyword">return</span> TRUE<span class="token punctuation">;</span>  <span class="token comment">// return TRUE  unless you set the focus to a control</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">CWebServerDlg</span><span class="token double-colon punctuation">::</span><span class="token function">OnSysCommand</span><span class="token punctuation">(</span>UINT nID<span class="token punctuation">,</span> LPARAM lParam<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>nID <span class="token operator">&amp;</span> <span class="token number">0xFFF0</span><span class="token punctuation">)</span> <span class="token operator">==</span> IDM_ABOUTBOX<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		CAboutDlg dlgAbout<span class="token punctuation">;</span>
		dlgAbout<span class="token punctuation">.</span><span class="token function">DoModal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token class-name">CDialog</span><span class="token double-colon punctuation">::</span><span class="token function">OnSysCommand</span><span class="token punctuation">(</span>nID<span class="token punctuation">,</span> lParam<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// If you add a minimize button to your dialog, you will need the code below</span>
<span class="token comment">//  to draw the icon.  For MFC applications using the document/view model,</span>
<span class="token comment">//  this is automatically done for you by the framework.</span>

<span class="token keyword">void</span> <span class="token class-name">CWebServerDlg</span><span class="token double-colon punctuation">::</span><span class="token function">OnPaint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IsIconic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		CPaintDC <span class="token function">dc</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// device context for painting</span>

		<span class="token function">SendMessage</span><span class="token punctuation">(</span>WM_ICONERASEBKGND<span class="token punctuation">,</span> <span class="token punctuation">(</span>WPARAM<span class="token punctuation">)</span> dc<span class="token punctuation">.</span><span class="token function">GetSafeHdc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// Center icon in client rectangle</span>
		<span class="token keyword">int</span> cxIcon <span class="token operator">=</span> <span class="token function">GetSystemMetrics</span><span class="token punctuation">(</span>SM_CXICON<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> cyIcon <span class="token operator">=</span> <span class="token function">GetSystemMetrics</span><span class="token punctuation">(</span>SM_CYICON<span class="token punctuation">)</span><span class="token punctuation">;</span>
		CRect rect<span class="token punctuation">;</span>
		<span class="token function">GetClientRect</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rect<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token punctuation">(</span>rect<span class="token punctuation">.</span><span class="token function">Width</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> cxIcon <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> y <span class="token operator">=</span> <span class="token punctuation">(</span>rect<span class="token punctuation">.</span><span class="token function">Height</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> cyIcon <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>

		<span class="token comment">// Draw the icon</span>
		dc<span class="token punctuation">.</span><span class="token function">DrawIcon</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> m_hIcon<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token class-name">CDialog</span><span class="token double-colon punctuation">::</span><span class="token function">OnPaint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token comment">// The system calls this to obtain the cursor to display while the user drags</span>
<span class="token comment">//  the minimized window.</span>
HCURSOR <span class="token class-name">CWebServerDlg</span><span class="token double-colon punctuation">::</span><span class="token function">OnQueryDragIcon</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token punctuation">(</span>HCURSOR<span class="token punctuation">)</span> m_hIcon<span class="token punctuation">;</span>
<span class="token punctuation">}</span>




<span class="token comment">//启动服务子程序</span>
<span class="token keyword">void</span> <span class="token class-name">CWebServerDlg</span><span class="token double-colon punctuation">::</span><span class="token function">OnStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//如果已经在运行</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>m_bRun<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">AfxMessageBox</span><span class="token punctuation">(</span><span class="token string">"服务器已经在运行"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">UpdateData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//否则启动服务</span>
	m_bRun <span class="token operator">=</span> WebServer<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token function">LPCTSTR</span><span class="token punctuation">(</span>m_szHomeDir<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">LPCTSTR</span><span class="token punctuation">(</span>m_szDefIndex<span class="token punctuation">)</span><span class="token punctuation">,</span> m_Port<span class="token punctuation">,</span> m_PTO <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>m_bRun<span class="token punctuation">)</span>
		nTimerID <span class="token operator">=</span> <span class="token function">SetTimer</span><span class="token punctuation">(</span>TIMER_ID_1<span class="token punctuation">,</span> TIMER_TO_1<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	m_szStatus <span class="token operator">=</span> <span class="token string">"程序服务中..."</span><span class="token punctuation">;</span>
	<span class="token function">UpdateData</span><span class="token punctuation">(</span>FALSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>





<span class="token comment">//停止服务</span>
<span class="token keyword">void</span> <span class="token class-name">CWebServerDlg</span><span class="token double-colon punctuation">::</span><span class="token function">OnStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>m_bRun<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token comment">//调用Shutdown来关闭服务</span>
		BOOL bResult <span class="token operator">=</span> WebServer<span class="token punctuation">.</span><span class="token function">Shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">KillTimer</span><span class="token punctuation">(</span>nTimerID<span class="token punctuation">)</span><span class="token punctuation">;</span>
		m_bRun <span class="token operator">=</span> FALSE<span class="token punctuation">;</span>
		m_szStatus <span class="token operator">=</span> <span class="token string">"目前没有提供服务."</span><span class="token punctuation">;</span>
		<span class="token function">UpdateData</span><span class="token punctuation">(</span>FALSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">AfxMessageBox</span><span class="token punctuation">(</span><span class="token string">"服务没有启动"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>





<span class="token comment">//退出程序</span>
<span class="token keyword">void</span> <span class="token class-name">CWebServerDlg</span><span class="token double-colon punctuation">::</span><span class="token function">OnClose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">{<!-- --></span>
	
	<span class="token comment">//保存设置</span>
	<span class="token function">SaveSettings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">OnStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">CDialog</span><span class="token double-colon punctuation">::</span><span class="token function">OnClose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>






<span class="token keyword">void</span> <span class="token class-name">CWebServerDlg</span><span class="token double-colon punctuation">::</span><span class="token function">OnOK</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">{<!-- --></span>
	<span class="token function">SaveSettings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">OnStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">CDialog</span><span class="token double-colon punctuation">::</span><span class="token function">OnOK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>



<span class="token comment">//定时器处理程序,主要是显示服务器数据</span>
<span class="token keyword">void</span> <span class="token class-name">CWebServerDlg</span><span class="token double-colon punctuation">::</span><span class="token function">OnTimer</span><span class="token punctuation">(</span>UINT nIDEvent<span class="token punctuation">)</span> 
<span class="token punctuation">{<!-- --></span>
	StatisticsTag st<span class="token punctuation">;</span>
	CString szTemp<span class="token punctuation">;</span>
	
	WebServer<span class="token punctuation">.</span><span class="token function">GetStats</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span><span class="token punctuation">;</span>

	szTemp<span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> st<span class="token punctuation">.</span>nClientsConnected<span class="token punctuation">)</span><span class="token punctuation">;</span>
	m_nActiveConn<span class="token punctuation">.</span><span class="token function">SetWindowText</span><span class="token punctuation">(</span>szTemp<span class="token punctuation">)</span><span class="token punctuation">;</span>

	szTemp<span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">"%.1f"</span><span class="token punctuation">,</span> st<span class="token punctuation">.</span>nTotalRecv<span class="token punctuation">)</span><span class="token punctuation">;</span>
	m_nBytesRecv<span class="token punctuation">.</span><span class="token function">SetWindowText</span><span class="token punctuation">(</span>szTemp<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	szTemp<span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">"%.1f"</span><span class="token punctuation">,</span> st<span class="token punctuation">.</span>nTotalSent<span class="token punctuation">)</span><span class="token punctuation">;</span>
	m_nBytesSent<span class="token punctuation">.</span><span class="token function">SetWindowText</span><span class="token punctuation">(</span>szTemp<span class="token punctuation">)</span><span class="token punctuation">;</span>

	szTemp<span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> st<span class="token punctuation">.</span>nTotalHits<span class="token punctuation">)</span><span class="token punctuation">;</span>
	m_nRequests<span class="token punctuation">.</span><span class="token function">SetWindowText</span><span class="token punctuation">(</span>szTemp<span class="token punctuation">)</span><span class="token punctuation">;</span>

	szTemp<span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> st<span class="token punctuation">.</span>nVisitors<span class="token punctuation">)</span><span class="token punctuation">;</span>
	m_nVisitors<span class="token punctuation">.</span><span class="token function">SetWindowText</span><span class="token punctuation">(</span>szTemp<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token class-name">CDialog</span><span class="token double-colon punctuation">::</span><span class="token function">OnTimer</span><span class="token punctuation">(</span>nIDEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">//重新启动服务</span>
<span class="token keyword">void</span> <span class="token class-name">CWebServerDlg</span><span class="token double-colon punctuation">::</span><span class="token function">OnReset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">{<!-- --></span>
	<span class="token function">OnStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	WebServer<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">UpdateData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">OnStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">//设置服务根目录</span>
<span class="token keyword">void</span> <span class="token class-name">CWebServerDlg</span><span class="token double-colon punctuation">::</span><span class="token function">OnHomedirbrowse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">{<!-- --></span>
	BROWSEINFO	bi<span class="token punctuation">;</span>
	<span class="token keyword">char</span> folder_name<span class="token punctuation">[</span>MAX_PATH<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> dir_name<span class="token punctuation">[</span>MAX_PATH<span class="token punctuation">]</span><span class="token punctuation">;</span>
	LPMALLOC lpMalloc<span class="token punctuation">;</span> 
	
	bi<span class="token punctuation">.</span>hwndOwner <span class="token operator">=</span> <span class="token function">GetSafeHwnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	bi<span class="token punctuation">.</span>pidlRoot <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	bi<span class="token punctuation">.</span>pszDisplayName <span class="token operator">=</span> folder_name<span class="token punctuation">;</span>
	bi<span class="token punctuation">.</span>lpszTitle <span class="token operator">=</span> <span class="token string">"请选择目录"</span><span class="token punctuation">;</span>
	bi<span class="token punctuation">.</span>ulFlags <span class="token operator">=</span> BIF_EDITBOX <span class="token operator">|</span> BIF_STATUSTEXT<span class="token punctuation">;</span>
	bi<span class="token punctuation">.</span>lpfn <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	bi<span class="token punctuation">.</span>lParam <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	bi<span class="token punctuation">.</span>iImage <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	
	LPITEMIDLIST pidl <span class="token operator">=</span> <span class="token function">SHBrowseForFolder</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bi<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>pidl<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">SHGetPathFromIDList</span><span class="token punctuation">(</span>pidl<span class="token punctuation">,</span> dir_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
		m_szHomeDir <span class="token operator">=</span> dir_name<span class="token punctuation">;</span>
		<span class="token function">UpdateData</span><span class="token punctuation">(</span>FALSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">SHGetMalloc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lpMalloc<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>lpMalloc <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
	<span class="token punctuation">{<!-- --></span> 
		<span class="token keyword">if</span><span class="token punctuation">(</span>pidl <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> 
		<span class="token punctuation">{<!-- --></span> 
			lpMalloc<span class="token operator">-&gt;</span><span class="token function">Free</span><span class="token punctuation">(</span>pidl<span class="token punctuation">)</span><span class="token punctuation">;</span> 
		<span class="token punctuation">}</span>  
		lpMalloc<span class="token operator">-&gt;</span><span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token punctuation">}</span> 
<span class="token punctuation">}</span>


<span class="token comment">//保存设置</span>
<span class="token keyword">void</span> <span class="token class-name">CWebServerDlg</span><span class="token double-colon punctuation">::</span><span class="token function">SaveSettings</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	CWinApp<span class="token operator">*</span> pApp <span class="token operator">=</span> <span class="token function">AfxGetApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token function">UpdateData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	pApp<span class="token operator">-&gt;</span><span class="token function">WriteProfileString</span><span class="token punctuation">(</span><span class="token string">"Settings"</span><span class="token punctuation">,</span> <span class="token string">"Server Root"</span><span class="token punctuation">,</span> m_szHomeDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
	pApp<span class="token operator">-&gt;</span><span class="token function">WriteProfileString</span><span class="token punctuation">(</span><span class="token string">"Settings"</span><span class="token punctuation">,</span> <span class="token string">"Defindex"</span><span class="token punctuation">,</span> m_szDefIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	pApp<span class="token operator">-&gt;</span><span class="token function">WriteProfileInt</span><span class="token punctuation">(</span><span class="token string">"Settings"</span><span class="token punctuation">,</span> <span class="token string">"Port"</span><span class="token punctuation">,</span> m_Port<span class="token punctuation">)</span><span class="token punctuation">;</span>
	pApp<span class="token operator">-&gt;</span><span class="token function">WriteProfileInt</span><span class="token punctuation">(</span><span class="token string">"Settings"</span><span class="token punctuation">,</span> <span class="token string">"PTO"</span><span class="token punctuation">,</span> m_PTO<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">//获取设置</span>
<span class="token keyword">void</span> <span class="token class-name">CWebServerDlg</span><span class="token double-colon punctuation">::</span><span class="token function">RestoreSettings</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	CWinApp<span class="token operator">*</span> pApp <span class="token operator">=</span> <span class="token function">AfxGetApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//默认服务器根目录是"C:\\ServerRoot"</span>
	m_szHomeDir <span class="token operator">=</span> pApp<span class="token operator">-&gt;</span><span class="token function">GetProfileString</span><span class="token punctuation">(</span><span class="token string">"Settings"</span><span class="token punctuation">,</span> <span class="token string">"Server Root"</span><span class="token punctuation">,</span> <span class="token string">"C:\\ServerRoot"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	m_szDefIndex <span class="token operator">=</span> pApp<span class="token operator">-&gt;</span><span class="token function">GetProfileString</span><span class="token punctuation">(</span><span class="token string">"Settings"</span><span class="token punctuation">,</span> <span class="token string">"Defindex"</span><span class="token punctuation">,</span> <span class="token string">"index.htm"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	m_Port <span class="token operator">=</span> pApp<span class="token operator">-&gt;</span><span class="token function">GetProfileInt</span><span class="token punctuation">(</span><span class="token string">"Settings"</span><span class="token punctuation">,</span> <span class="token string">"Port"</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	m_PTO <span class="token operator">=</span> pApp<span class="token operator">-&gt;</span><span class="token function">GetProfileInt</span><span class="token punctuation">(</span><span class="token string">"Settings"</span><span class="token punctuation">,</span> <span class="token string">"PTO"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">UpdateData</span><span class="token punctuation">(</span>FALSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     HTTPServer.h
    </p>
    <pre><code class="prism language-cpp"><span class="token comment">//zww</span>
<span class="token comment">/****************************************************************************************
* ///
*	Original Filename: 	HTTPServer.h

*	Comments:	
* \\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
****************************************************************************************/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>AFX_HTTPSERVER_H__177A41DC_432E_4819_A614_8A0D66ABF434__INCLUDED_<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AFX_HTTPSERVER_H__177A41DC_432E_4819_A614_8A0D66ABF434__INCLUDED_</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">_MSC_VER <span class="token operator">&gt;</span> <span class="token number">1000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">once</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">// _MSC_VER &gt; 1000</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"GenericServer.h"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ERROR404</span>			<span class="token string">"/fnf.html"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ERROR501</span>			<span class="token string">"/mna.html"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SERVERNAME</span>			<span class="token string">"AcIDSoftWebServer/0.1b"</span></span>


<span class="token keyword">typedef</span> map<span class="token operator">&lt;</span>string<span class="token punctuation">,</span> string<span class="token operator">&gt;</span>				MIMETYPES<span class="token punctuation">;</span>


<span class="token keyword">class</span> <span class="token class-name">CHTTPServer</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">CGenericServer</span></span>  
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
					<span class="token function">CHTTPServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">virtual</span>			<span class="token operator">~</span><span class="token function">CHTTPServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	BOOL			<span class="token function">Start</span><span class="token punctuation">(</span>string<span class="token punctuation">,</span> string<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	BOOL			<span class="token function">IsComplete</span><span class="token punctuation">(</span>string<span class="token punctuation">)</span><span class="token punctuation">;</span>
	BOOL			<span class="token function">ParseRequest</span><span class="token punctuation">(</span>string<span class="token punctuation">,</span> string<span class="token operator">&amp;</span><span class="token punctuation">,</span> BOOL<span class="token operator">&amp;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span>				<span class="token function">GotConnection</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span>				<span class="token function">DataSent</span><span class="token punctuation">(</span>DWORD<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">private</span><span class="token operator">:</span>
	string			m_HomeDir<span class="token punctuation">;</span>
	string			m_DefIndex<span class="token punctuation">;</span>
	MIMETYPES		MimeTypes<span class="token punctuation">;</span>
	
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">// !defined(AFX_HTTPSERVER_H__177A41DC_432E_4819_A614_8A0D66ABF434__INCLUDED_)</span></span>

</code></pre>
    <p>
     HTTPServer.cpp
    </p>
    <pre><code class="prism language-cpp"><span class="token comment">/****************************************************************************************
* ///
*	Original Filename: 	HTTPServer.cpp
*
*	History:
*	Created/Modified by				Date			Main Purpose/Changes
*	Souren M. Abeghyan				2001/05/25		Implementation of the CHTTPServer class
*	
*	Comments:	
* \\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
****************************************************************************************/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stdafx.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"WebServer.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"HTTPServer.h"</span></span>
<span class="token comment">// zww</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">_DEBUG</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">undef</span> <span class="token expression">THIS_FILE</span></span>
<span class="token keyword">static</span> <span class="token keyword">char</span> THIS_FILE<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token constant">__FILE__</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">new</span> <span class="token expression">DEBUG_NEW</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token comment">//</span>
<span class="token comment">// Construction/Destruction</span>
<span class="token comment">//</span>

<span class="token class-name">CHTTPServer</span><span class="token double-colon punctuation">::</span><span class="token function">CHTTPServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//</span>
	<span class="token comment">// 初始化 MIME 类型</span>
	<span class="token comment">//</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"doc"</span><span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token string">"application/msword"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"bin"</span><span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token string">"application/octet-stream"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"dll"</span><span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token string">"application/octet-stream"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"exe"</span><span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token string">"application/octet-stream"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"pdf"</span><span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token string">"application/pdf"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"p7c"</span><span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token string">"application/pkcs7-mime"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"ai"</span><span class="token punctuation">]</span>		<span class="token operator">=</span> <span class="token string">"application/postscript"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"eps"</span><span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token string">"application/postscript"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"ps"</span><span class="token punctuation">]</span>		<span class="token operator">=</span> <span class="token string">"application/postscript"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"rtf"</span><span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token string">"application/rtf"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"fdf"</span><span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token string">"application/vnd.fdf"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"arj"</span><span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token string">"application/x-arj"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"gz"</span><span class="token punctuation">]</span>		<span class="token operator">=</span> <span class="token string">"application/x-gzip"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"class"</span><span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token string">"application/x-java-class"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"js"</span><span class="token punctuation">]</span>		<span class="token operator">=</span> <span class="token string">"application/x-javascript"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"lzh"</span><span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token string">"application/x-lzh"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"lnk"</span><span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token string">"application/x-ms-shortcut"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"tar"</span><span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token string">"application/x-tar"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"hlp"</span><span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token string">"application/x-winhelp"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"cert"</span><span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token string">"application/x-x509-ca-cert"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"zip"</span><span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token string">"application/zip"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"cab"</span><span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token string">"application/x-compressed"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"arj"</span><span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token string">"application/x-compressed"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"aif"</span><span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token string">"audio/aiff"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"aifc"</span><span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token string">"audio/aiff"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"aiff"</span><span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token string">"audio/aiff"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"au"</span><span class="token punctuation">]</span>		<span class="token operator">=</span> <span class="token string">"audio/basic"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"snd"</span><span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token string">"audio/basic"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"mid"</span><span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token string">"audio/midi"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"rmi"</span><span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token string">"audio/midi"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"mp3"</span><span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token string">"audio/mpeg"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"vox"</span><span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token string">"audio/voxware"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"wav"</span><span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token string">"audio/wav"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"ra"</span><span class="token punctuation">]</span>		<span class="token operator">=</span> <span class="token string">"audio/x-pn-realaudio"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"ram"</span><span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token string">"audio/x-pn-realaudio"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"bmp"</span><span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token string">"image/bmp"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"gif"</span><span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token string">"image/gif"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"jpeg"</span><span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token string">"image/jpeg"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"jpg"</span><span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token string">"image/jpeg"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"tif"</span><span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token string">"image/tiff"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"tiff"</span><span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token string">"image/tiff"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"xbm"</span><span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token string">"image/xbm"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"wrl"</span><span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token string">"model/vrml"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"htm"</span><span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token string">"text/html"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"html"</span><span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token string">"text/html"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"c"</span><span class="token punctuation">]</span>		<span class="token operator">=</span> <span class="token string">"text/plain"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"cpp"</span><span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token string">"text/plain"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"def"</span><span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token string">"text/plain"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"h"</span><span class="token punctuation">]</span>		<span class="token operator">=</span> <span class="token string">"text/plain"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"txt"</span><span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token string">"text/plain"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"rtx"</span><span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token string">"text/richtext"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"rtf"</span><span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token string">"text/richtext"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"java"</span><span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token string">"text/x-java-source"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"css"</span><span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token string">"text/css"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"mpeg"</span><span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token string">"video/mpeg"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"mpg"</span><span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token string">"video/mpeg"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"mpe"</span><span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token string">"video/mpeg"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"avi"</span><span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token string">"video/msvideo"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"mov"</span><span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token string">"video/quicktime"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"qt"</span><span class="token punctuation">]</span>		<span class="token operator">=</span> <span class="token string">"video/quicktime"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"shtml"</span><span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token string">"wwwserver/html-ssi"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"asa"</span><span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token string">"wwwserver/isapi"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"asp"</span><span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token string">"wwwserver/isapi"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"cfm"</span><span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token string">"wwwserver/isapi"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"dbm"</span><span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token string">"wwwserver/isapi"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"isa"</span><span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token string">"wwwserver/isapi"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"plx"</span><span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token string">"wwwserver/isapi"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"url"</span><span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token string">"wwwserver/isapi"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"cgi"</span><span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token string">"wwwserver/isapi"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"php"</span><span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token string">"wwwserver/isapi"</span><span class="token punctuation">;</span>
	MimeTypes<span class="token punctuation">[</span><span class="token string">"wcgi"</span><span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token string">"wwwserver/isapi"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">CHTTPServer</span><span class="token double-colon punctuation">::</span><span class="token operator">~</span><span class="token function">CHTTPServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>

<span class="token punctuation">}</span>


<span class="token keyword">int</span> <span class="token class-name">CHTTPServer</span><span class="token double-colon punctuation">::</span><span class="token function">GotConnection</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">int</span> <span class="token class-name">CHTTPServer</span><span class="token double-colon punctuation">::</span><span class="token function">DataSent</span><span class="token punctuation">(</span>DWORD<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">//启动服务，重要函数，分析根目录</span>
BOOL <span class="token class-name">CHTTPServer</span><span class="token double-colon punctuation">::</span><span class="token function">Start</span><span class="token punctuation">(</span>string HomeDir<span class="token punctuation">,</span> string DefIndex<span class="token punctuation">,</span> <span class="token keyword">int</span> Port<span class="token punctuation">,</span> <span class="token keyword">int</span> PersTO<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	m_HomeDir		<span class="token operator">=</span> HomeDir<span class="token punctuation">;</span>
	m_DefIndex		<span class="token operator">=</span> DefIndex<span class="token punctuation">;</span>

	<span class="token keyword">if</span><span class="token punctuation">(</span>m_HomeDir<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span>m_HomeDir<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token string">"\\"</span><span class="token punctuation">)</span>
		m_HomeDir <span class="token operator">+=</span> <span class="token string">"\\"</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token function">Run</span><span class="token punctuation">(</span>Port<span class="token punctuation">,</span> PersTO<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//是否完成</span>
BOOL <span class="token class-name">CHTTPServer</span><span class="token double-colon punctuation">::</span><span class="token function">IsComplete</span><span class="token punctuation">(</span>string szRequest<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>szRequest<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span>szRequest<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"\r\n\r\n"</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> TRUE<span class="token punctuation">;</span>
	<span class="token keyword">else</span>
		<span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>



<span class="token comment">//分析请求数据</span>
BOOL <span class="token class-name">CHTTPServer</span><span class="token double-colon punctuation">::</span><span class="token function">ParseRequest</span><span class="token punctuation">(</span>string szRequest<span class="token punctuation">,</span> string <span class="token operator">&amp;</span>szResponse<span class="token punctuation">,</span> BOOL <span class="token operator">&amp;</span>bKeepAlive<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//</span>
	<span class="token comment">//</span>
	string szMethod<span class="token punctuation">;</span>
	string szFileName<span class="token punctuation">;</span>
	string szFileExt<span class="token punctuation">;</span>
	string <span class="token function">szStatusCode</span><span class="token punctuation">(</span><span class="token string">"200 OK"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	string <span class="token function">szContentType</span><span class="token punctuation">(</span><span class="token string">"text/html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	string <span class="token function">szConnectionType</span><span class="token punctuation">(</span><span class="token string">"close"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	string szNotFoundMessage<span class="token punctuation">;</span>
	string szDateTime<span class="token punctuation">;</span>
	<span class="token keyword">char</span> pResponseHeader<span class="token punctuation">[</span><span class="token number">2048</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	fpos_t lengthActual <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>pBuf <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> n<span class="token punctuation">;</span>
				
	<span class="token comment">//</span>
	<span class="token comment">// 检查提交方法</span>
	<span class="token comment">//</span>
	n <span class="token operator">=</span> szRequest<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>n <span class="token operator">!=</span> string<span class="token double-colon punctuation">::</span>npos<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		szMethod <span class="token operator">=</span> szRequest<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>szMethod <span class="token operator">==</span> <span class="token string">"GET"</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token comment">//</span>
			<span class="token comment">// 获取文件名</span>
			<span class="token comment">// </span>
			<span class="token keyword">int</span> n1 <span class="token operator">=</span> szRequest<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">,</span> n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>n <span class="token operator">!=</span> string<span class="token double-colon punctuation">::</span>npos<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				szFileName <span class="token operator">=</span> szRequest<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span>n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> n1 <span class="token operator">-</span> n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span><span class="token punctuation">(</span>szFileName <span class="token operator">==</span> <span class="token string">"/"</span><span class="token punctuation">)</span>
				<span class="token punctuation">{<!-- --></span>
					szFileName <span class="token operator">=</span> m_DefIndex<span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token function">LogMessage</span><span class="token punctuation">(</span>LOGFILENAME<span class="token punctuation">,</span> <span class="token string">"No 'space' found in Request String #1"</span><span class="token punctuation">,</span> <span class="token string">"ParseRequest"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span>
		<span class="token punctuation">{<!-- --></span>
			szStatusCode <span class="token operator">=</span> <span class="token string">"501 Not Implemented"</span><span class="token punctuation">;</span>
			szFileName <span class="token operator">=</span> ERROR501<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">LogMessage</span><span class="token punctuation">(</span>LOGFILENAME<span class="token punctuation">,</span> <span class="token string">"No 'space' found in Request String #2"</span><span class="token punctuation">,</span> <span class="token string">"ParseRequest"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//</span>
	<span class="token comment">// 分析链接类型</span>
	<span class="token comment">//</span>
	n <span class="token operator">=</span> szRequest<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">"\nConnection: Keep-Alive"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>n <span class="token operator">!=</span> string<span class="token double-colon punctuation">::</span>npos<span class="token punctuation">)</span>
		bKeepAlive <span class="token operator">=</span> TRUE<span class="token punctuation">;</span>

	<span class="token comment">//</span>
	<span class="token comment">// 分析内容类型</span>
	<span class="token comment">//</span>
	<span class="token keyword">int</span> nPointPos <span class="token operator">=</span> szFileName<span class="token punctuation">.</span><span class="token function">rfind</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>nPointPos <span class="token operator">!=</span> string<span class="token double-colon punctuation">::</span>npos<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		szFileExt <span class="token operator">=</span> szFileName<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span>nPointPos <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> szFileName<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">strlwr</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>szFileExt<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		MIMETYPES<span class="token double-colon punctuation">::</span>iterator it<span class="token punctuation">;</span>
		it <span class="token operator">=</span> MimeTypes<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>szFileExt<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>it <span class="token operator">!=</span> MimeTypes<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			szContentType <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>it<span class="token punctuation">)</span><span class="token punctuation">.</span>second<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//得到目前的时间</span>
	<span class="token comment">//</span>
	<span class="token keyword">char</span> szDT<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">tm</span> <span class="token operator">*</span>newtime<span class="token punctuation">;</span>
	time_t ltime<span class="token punctuation">;</span>
	
	<span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">(</span>time_t<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>ltime<span class="token punctuation">)</span><span class="token punctuation">;</span>
	newtime <span class="token operator">=</span> <span class="token function">gmtime</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ltime<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">strftime</span><span class="token punctuation">(</span>szDT<span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span>
		<span class="token string">"%a, %d %b %Y %H:%M:%S GMT"</span><span class="token punctuation">,</span> newtime<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//</span>
	<span class="token comment">// 读取文件</span>
	<span class="token comment">//</span>
	FILE <span class="token operator">*</span>f<span class="token punctuation">;</span>
	f <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token punctuation">(</span>m_HomeDir <span class="token operator">+</span> szFileName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"r+b"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>f <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>				
	<span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 获得文件大小</span>
		<span class="token function">fseek</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">SEEK_END</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">fgetpos</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token operator">&amp;</span>lengthActual<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">fseek</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">SEEK_SET</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		pBuf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">char</span><span class="token punctuation">[</span>lengthActual <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

		length <span class="token operator">=</span> <span class="token function">fread</span><span class="token punctuation">(</span>pBuf<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> lengthActual<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">fclose</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">//</span>
		<span class="token comment">// 返回响应</span>
		<span class="token comment">//</span>
		<span class="token function">sprintf</span><span class="token punctuation">(</span>pResponseHeader<span class="token punctuation">,</span> <span class="token string">"HTTP/1.0 %s\r\nDate: %s\r\nServer: %s\r\nAccept-Ranges: bytes\r\nContent-Length: %d\r\nConnection: %s\r\nContent-Type: %s\r\n\r\n"</span><span class="token punctuation">,</span>
			szStatusCode<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> szDT<span class="token punctuation">,</span> SERVERNAME<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>length<span class="token punctuation">,</span> bKeepAlive <span class="token operator">?</span> <span class="token string">"Keep-Alive"</span> <span class="token operator">:</span> <span class="token string">"close"</span><span class="token punctuation">,</span> szContentType<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token comment">//</span>
		<span class="token comment">// 如果文件没有找到	   </span>
		<span class="token comment">//</span>
		f <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token punctuation">(</span>m_HomeDir <span class="token operator">+</span> ERROR404<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"r+b"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>f <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>				
		<span class="token punctuation">{<!-- --></span>
			<span class="token comment">// 获取文件大小</span>
			<span class="token function">fseek</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">SEEK_END</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">fgetpos</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token operator">&amp;</span>lengthActual<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">fseek</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">SEEK_SET</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			pBuf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">char</span><span class="token punctuation">[</span>lengthActual <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
			length <span class="token operator">=</span> <span class="token function">fread</span><span class="token punctuation">(</span>pBuf<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> lengthActual<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">fclose</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
			szNotFoundMessage <span class="token operator">=</span> <span class="token function">string</span><span class="token punctuation">(</span>pBuf<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">delete</span> pBuf<span class="token punctuation">;</span>
			pBuf <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		szStatusCode <span class="token operator">=</span> <span class="token string">"404 Resource not found"</span><span class="token punctuation">;</span>

		<span class="token function">sprintf</span><span class="token punctuation">(</span>pResponseHeader<span class="token punctuation">,</span> <span class="token string">"HTTP/1.0 %s\r\nContent-Length: %d\r\nContent-Type: text/html\r\nDate: %s\r\nServer: %s\r\n\r\n%s"</span><span class="token punctuation">,</span>
			szStatusCode<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> szNotFoundMessage<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> szDT<span class="token punctuation">,</span> SERVERNAME<span class="token punctuation">,</span> szNotFoundMessage<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		bKeepAlive <span class="token operator">=</span> FALSE<span class="token punctuation">;</span>  
	<span class="token punctuation">}</span>

	szResponse <span class="token operator">=</span> <span class="token function">string</span><span class="token punctuation">(</span>pResponseHeader<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>pBuf<span class="token punctuation">)</span>
		szResponse <span class="token operator">+=</span> <span class="token function">string</span><span class="token punctuation">(</span>pBuf<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">delete</span> pBuf<span class="token punctuation">;</span>
	pBuf <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	

	<span class="token keyword">return</span> TRUE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
    <p>
     GernericServer.h
    </p>
    <pre><code class="prism language-cpp"><span class="token comment">//zww</span>
<span class="token comment">/****************************************************************************************
* ///
*	Original Filename: 	genericserver.h
*
*	
*	Comments:	
* \\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
****************************************************************************************/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>AFX_GENERICSERVER_H__6C21FFA2_485A_11D5_9692_0050BA8CD8A0__INCLUDED_<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AFX_GENERICSERVER_H__6C21FFA2_485A_11D5_9692_0050BA8CD8A0__INCLUDED_</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">_MSC_VER <span class="token operator">&gt;</span> <span class="token number">1000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">once</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">// _MSC_VER &gt; 1000</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">THREADKILL_TO</span>		<span class="token expression"><span class="token number">1000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">THREADWAIT_TO</span>		<span class="token expression"><span class="token number">30000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TICK</span>				<span class="token expression"><span class="token number">100</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">THREADEXIT_SUCCESS</span>	<span class="token expression"><span class="token number">0x1234</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SERVERPORT</span>			<span class="token expression"><span class="token number">80</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_BUFFER</span>			<span class="token expression"><span class="token number">100000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SENDBLOCK</span>			<span class="token expression"><span class="token number">200000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LOGFILENAME</span>			<span class="token string">"UMServer.log"</span></span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression"><span class="token function">warning</span><span class="token punctuation">(</span>disable<span class="token operator">:</span><span class="token number">4786</span><span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;winsock2.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;vector&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;deque&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;map&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;algorithm&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;list&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;functional&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;process.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Log.h"</span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">NewConnectionTag</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">ThreadTag</span>
<span class="token punctuation">{<!-- --></span>
	HANDLE				hThread<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>		threadID<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token keyword">struct</span> <span class="token class-name">IDCompare</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token class-name">binary_function</span><span class="token operator">&lt;</span><span class="token class-name">ThreadTag</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token operator">&gt;</span></span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">bool</span> <span class="token keyword">operator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> ThreadTag<span class="token operator">&amp;</span> _X<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token operator">&amp;</span> _Y<span class="token punctuation">)</span> <span class="token keyword">const</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token punctuation">(</span>_X<span class="token punctuation">.</span>threadID <span class="token operator">==</span> _Y<span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token keyword">typedef</span> list<span class="token operator">&lt;</span>ThreadTag<span class="token operator">&gt;</span>					THREADLIST<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> list<span class="token operator">&lt;</span>HANDLE<span class="token operator">&gt;</span>					HANDLELIST<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> vector<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span>					STRVECT<span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">StatisticsTag</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">long</span>					nClientsConnected<span class="token punctuation">;</span>
	<span class="token keyword">long</span>					nTotalHits<span class="token punctuation">;</span>
	<span class="token keyword">double</span>					nTotalSent<span class="token punctuation">;</span>
	<span class="token keyword">double</span>					nTotalRecv<span class="token punctuation">;</span>
	<span class="token keyword">double</span>					nErrosCount<span class="token punctuation">;</span>
	<span class="token keyword">long</span>					nVisitors<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token keyword">class</span> <span class="token class-name">CGenericServer</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">CLog</span></span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
							<span class="token function">CGenericServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">virtual</span>					<span class="token operator">~</span><span class="token function">CGenericServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">public</span><span class="token operator">:</span>						
	<span class="token keyword">void</span>					<span class="token function">GetStats</span><span class="token punctuation">(</span>StatisticsTag<span class="token operator">&amp;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span>					<span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	BOOL					<span class="token function">Run</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	BOOL					<span class="token function">Shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">protected</span><span class="token operator">:</span>					
	<span class="token keyword">virtual</span> <span class="token keyword">int</span>				<span class="token function">GotConnection</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span>				<span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">virtual</span> <span class="token keyword">int</span>				<span class="token function">DataSent</span><span class="token punctuation">(</span>DWORD<span class="token punctuation">)</span>							<span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">virtual</span> BOOL			<span class="token function">IsComplete</span><span class="token punctuation">(</span>string<span class="token punctuation">)</span>						<span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">virtual</span> BOOL			<span class="token function">ParseRequest</span><span class="token punctuation">(</span>string<span class="token punctuation">,</span> string<span class="token operator">&amp;</span><span class="token punctuation">,</span> BOOL<span class="token operator">&amp;</span><span class="token punctuation">)</span>	<span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">private</span><span class="token operator">:</span>				
	<span class="token keyword">static</span> UINT	__stdcall	<span class="token function">AcceptThread</span><span class="token punctuation">(</span>LPVOID<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">static</span> UINT __stdcall 	<span class="token function">ClientThread</span><span class="token punctuation">(</span>LPVOID<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">static</span> UINT __stdcall 	<span class="token function">HelperThread</span><span class="token punctuation">(</span>LPVOID<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	BOOL					<span class="token function">AddClient</span><span class="token punctuation">(</span>SOCKET<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span>					<span class="token function">CleanupThread</span><span class="token punctuation">(</span>WSAEVENT<span class="token punctuation">,</span> SOCKET<span class="token punctuation">,</span> NewConnectionTag<span class="token operator">*</span><span class="token punctuation">,</span> DWORD<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span>					<span class="token function">CleanupThread</span><span class="token punctuation">(</span>WSAEVENT<span class="token punctuation">,</span> WSAEVENT<span class="token punctuation">,</span> SOCKET<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">private</span><span class="token operator">:</span>					
	HANDLE					ThreadA<span class="token punctuation">;</span> <span class="token comment">// Accept Thread</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>			ThreadA_ID<span class="token punctuation">;</span>
	HANDLE					ThreadC<span class="token punctuation">;</span> <span class="token comment">// Cleanup Thread</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>			ThreadC_ID<span class="token punctuation">;</span>
							
	WSAEVENT				ShutdownEvent<span class="token punctuation">;</span>
							
	HANDLE					ThreadLaunchedEvent<span class="token punctuation">;</span>
 						
	THREADLIST				ThreadList<span class="token punctuation">;</span>
	HANDLELIST				HandleList<span class="token punctuation">;</span>
							
	StatisticsTag			Stats<span class="token punctuation">;</span>
	CRITICAL_SECTION		cs<span class="token punctuation">;</span>
	CRITICAL_SECTION		_cs<span class="token punctuation">;</span>

	<span class="token keyword">int</span>						ServerPort<span class="token punctuation">;</span>
	<span class="token keyword">int</span>						PersistenceTO<span class="token punctuation">;</span>

	BOOL					bRun<span class="token punctuation">;</span>
<span class="token keyword">protected</span><span class="token operator">:</span>
	STRVECT					Visitors<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">NewConnectionTag</span>
<span class="token punctuation">{<!-- --></span>
	CGenericServer			<span class="token operator">*</span>pGenericServer<span class="token punctuation">;</span>
	SOCKET					s<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">// !defined(AFX_GENERICSERVER_H__6C21FFA2_485A_11D5_9692_0050BA8CD8A0__INCLUDED_)</span></span>

</code></pre>
    <p>
     GernericServer.cpp
    </p>
    <pre><code class="prism language-cpp"><span class="token comment">/****************************************************************************************
* ///
*	Original Filename: 	genericserver.cpp
*
*	History:
*	Created/Modified by				Date			Main Purpose/Changes
*	Souren M. Abeghyan				2001/05/25		Implementation of the CGenericServer class.
*	
*	Comments:	
* \\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
****************************************************************************************/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stdafx.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"GenericServer.h"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">_DEBUG</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">undef</span> <span class="token expression">THIS_FILE</span></span>
<span class="token keyword">static</span> <span class="token keyword">char</span> THIS_FILE<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token constant">__FILE__</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">new</span> <span class="token expression">DEBUG_NEW</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token comment">// zww</span>
<span class="token comment">//</span>
<span class="token comment">// Construction/Destruction</span>
<span class="token comment">//</span>

<span class="token class-name">CGenericServer</span><span class="token double-colon punctuation">::</span><span class="token function">CGenericServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	bRun <span class="token operator">=</span> FALSE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">CGenericServer</span><span class="token double-colon punctuation">::</span><span class="token operator">~</span><span class="token function">CGenericServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	
<span class="token punctuation">}</span>



<span class="token comment">//获取状态</span>
<span class="token keyword">void</span> <span class="token class-name">CGenericServer</span><span class="token double-colon punctuation">::</span><span class="token function">GetStats</span><span class="token punctuation">(</span>StatisticsTag <span class="token operator">&amp;</span>st<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	st<span class="token punctuation">.</span>nTotalRecv <span class="token operator">=</span> Stats<span class="token punctuation">.</span>nTotalRecv<span class="token punctuation">;</span>
	st<span class="token punctuation">.</span>nTotalSent <span class="token operator">=</span> Stats<span class="token punctuation">.</span>nTotalSent<span class="token punctuation">;</span>
	st<span class="token punctuation">.</span>nTotalHits <span class="token operator">=</span> Stats<span class="token punctuation">.</span>nTotalHits<span class="token punctuation">;</span>
	st<span class="token punctuation">.</span>nVisitors  <span class="token operator">=</span> Visitors<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">EnterCriticalSection</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_cs<span class="token punctuation">)</span><span class="token punctuation">;</span>
	st<span class="token punctuation">.</span>nClientsConnected <span class="token operator">=</span> ThreadList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">LeaveCriticalSection</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_cs<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">//增加新的连接</span>
BOOL <span class="token class-name">CGenericServer</span><span class="token double-colon punctuation">::</span><span class="token function">AddClient</span><span class="token punctuation">(</span>SOCKET s<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> ClientAddress<span class="token punctuation">,</span> <span class="token keyword">int</span> port<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">GotConnection</span><span class="token punctuation">(</span>ClientAddress<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>

	STRVECT<span class="token double-colon punctuation">::</span>iterator it<span class="token punctuation">;</span>
	it <span class="token operator">=</span> <span class="token function">find</span><span class="token punctuation">(</span>Visitors<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Visitors<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ClientAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>it <span class="token operator">==</span> Visitors<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		Visitors<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>ClientAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">InterlockedIncrement</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Stats<span class="token punctuation">.</span>nTotalHits<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	ThreadTag		Thread<span class="token punctuation">;</span>
	HANDLE			hThread<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>	threadID<span class="token punctuation">;</span>

	<span class="token function">EnterCriticalSection</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cs<span class="token punctuation">)</span><span class="token punctuation">;</span>
	NewConnectionTag <span class="token operator">*</span>NewConn	<span class="token operator">=</span> <span class="token keyword">new</span> NewConnectionTag<span class="token punctuation">;</span>
	NewConn<span class="token operator">-&gt;</span>pGenericServer		<span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
	NewConn<span class="token operator">-&gt;</span>s					<span class="token operator">=</span> s<span class="token punctuation">;</span>
	hThread <span class="token operator">=</span> <span class="token punctuation">(</span>HANDLE<span class="token punctuation">)</span><span class="token function">_beginthreadex</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ClientThread<span class="token punctuation">,</span> NewConn<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>threadID<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>hThread<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		Thread<span class="token punctuation">.</span>threadID <span class="token operator">=</span> threadID<span class="token punctuation">;</span>
		Thread<span class="token punctuation">.</span>hThread <span class="token operator">=</span> hThread<span class="token punctuation">;</span>
		ThreadList<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>Thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
		<span class="token function">LogMessage</span><span class="token punctuation">(</span>LOGFILENAME<span class="token punctuation">,</span> <span class="token string">"_beginthreadex(...) failure"</span><span class="token punctuation">,</span> <span class="token string">"AddClient"</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">LeaveCriticalSection</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cs<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> TRUE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">//启动服务器</span>
BOOL <span class="token class-name">CGenericServer</span><span class="token double-colon punctuation">::</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token keyword">int</span> Port<span class="token punctuation">,</span> <span class="token keyword">int</span> PersTO<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>bRun<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">LogMessage</span><span class="token punctuation">(</span>LOGFILENAME<span class="token punctuation">,</span> <span class="token string">"_beginthreadex(...) failure, for Launch Thread"</span><span class="token punctuation">,</span> <span class="token string">"Run"</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	ServerPort <span class="token operator">=</span> Port<span class="token punctuation">;</span>
	PersistenceTO <span class="token operator">=</span> PersTO<span class="token punctuation">;</span>

	<span class="token function">InitializeCriticalSection</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cs<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">InitializeCriticalSection</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_cs<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	ThreadLaunchedEvent	<span class="token operator">=</span> <span class="token function">CreateEvent</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> FALSE<span class="token punctuation">,</span> TRUE<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 启动接收线程</span>
	<span class="token function">ResetEvent</span><span class="token punctuation">(</span>ThreadLaunchedEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
	ThreadA <span class="token operator">=</span> <span class="token punctuation">(</span>HANDLE<span class="token punctuation">)</span><span class="token function">_beginthreadex</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> AcceptThread<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>ThreadA_ID<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>ThreadA<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">LogMessage</span><span class="token punctuation">(</span>LOGFILENAME<span class="token punctuation">,</span> <span class="token string">"_beginthreadex(...) failure, for Launch Thread"</span><span class="token punctuation">,</span> <span class="token string">"Run"</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">WaitForSingleObject</span><span class="token punctuation">(</span>ThreadLaunchedEvent<span class="token punctuation">,</span> THREADWAIT_TO<span class="token punctuation">)</span> <span class="token operator">!=</span> WAIT_OBJECT_0<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">LogMessage</span><span class="token punctuation">(</span>LOGFILENAME<span class="token punctuation">,</span> <span class="token string">"Unable to get response from Accept Thread withing specified Timeout -&gt;"</span><span class="token punctuation">,</span> <span class="token string">"Run"</span><span class="token punctuation">,</span> THREADWAIT_TO<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">CloseHandle</span><span class="token punctuation">(</span>ThreadLaunchedEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 启动帮助线程</span>
	<span class="token function">ResetEvent</span><span class="token punctuation">(</span>ThreadLaunchedEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
	ThreadC <span class="token operator">=</span> <span class="token punctuation">(</span>HANDLE<span class="token punctuation">)</span><span class="token function">_beginthreadex</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> HelperThread<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>ThreadC_ID<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>ThreadC<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">LogMessage</span><span class="token punctuation">(</span>LOGFILENAME<span class="token punctuation">,</span> <span class="token string">"_beginthreadex(...) failure, for Helper Thread"</span><span class="token punctuation">,</span> <span class="token string">"Run"</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">WaitForSingleObject</span><span class="token punctuation">(</span>ThreadLaunchedEvent<span class="token punctuation">,</span> THREADWAIT_TO<span class="token punctuation">)</span> <span class="token operator">!=</span> WAIT_OBJECT_0<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">LogMessage</span><span class="token punctuation">(</span>LOGFILENAME<span class="token punctuation">,</span> <span class="token string">"Unable to get response from Helper Thread within specified Timeout -&gt;"</span><span class="token punctuation">,</span> <span class="token string">"Run"</span><span class="token punctuation">,</span> THREADWAIT_TO<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">CloseHandle</span><span class="token punctuation">(</span>ThreadLaunchedEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token function">CloseHandle</span><span class="token punctuation">(</span>ThreadLaunchedEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	bRun <span class="token operator">=</span> TRUE<span class="token punctuation">;</span>

	<span class="token keyword">return</span> TRUE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">//关闭服务</span>
BOOL <span class="token class-name">CGenericServer</span><span class="token double-colon punctuation">::</span><span class="token function">Shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>bRun<span class="token punctuation">)</span>
		<span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
	
	BOOL bResult <span class="token operator">=</span> TRUE<span class="token punctuation">;</span>
	HANDLE	hArray<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

	hArray<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> ThreadA<span class="token punctuation">;</span>
	hArray<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> ThreadC<span class="token punctuation">;</span>

	<span class="token comment">//</span>
	<span class="token comment">// 关闭接收和helper线程</span>
	<span class="token comment">//</span>
	<span class="token function">SetEvent</span><span class="token punctuation">(</span>ShutdownEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
	DWORD n <span class="token operator">=</span> <span class="token function">WaitForMultipleObjects</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> hArray<span class="token punctuation">,</span> TRUE<span class="token punctuation">,</span> THREADKILL_TO<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span><span class="token punctuation">(</span>n <span class="token operator">==</span> WAIT_TIMEOUT <span class="token operator">||</span> n <span class="token operator">==</span> WAIT_FAILED<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">LogMessage</span><span class="token punctuation">(</span>LOGFILENAME<span class="token punctuation">,</span> <span class="token string">"WaitForMultipleObjects(...) timed out"</span><span class="token punctuation">,</span> <span class="token string">"Shutdown"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">TerminateThread</span><span class="token punctuation">(</span>ThreadA<span class="token punctuation">,</span> THREADEXIT_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token function">LogMessage</span><span class="token punctuation">(</span>LOGFILENAME<span class="token punctuation">,</span> <span class="token string">"TerminateThread(.ThreadA.) failure, probably it is already terminated"</span><span class="token punctuation">,</span> <span class="token string">"Shutdown"</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">TerminateThread</span><span class="token punctuation">(</span>ThreadC<span class="token punctuation">,</span> THREADEXIT_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token function">LogMessage</span><span class="token punctuation">(</span>LOGFILENAME<span class="token punctuation">,</span> <span class="token string">"TerminateThread(.ThreadC.) failure, probably it is already terminated"</span><span class="token punctuation">,</span> <span class="token string">"Shutdown"</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		bResult <span class="token operator">=</span> FALSE<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">CloseHandle</span><span class="token punctuation">(</span>ThreadA<span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token function">CloseHandle</span><span class="token punctuation">(</span>ThreadC<span class="token punctuation">)</span><span class="token punctuation">;</span> 

	<span class="token comment">//</span>
	<span class="token comment">// 所有的客户线程都结束</span>
	<span class="token comment">//</span>
	THREADLIST<span class="token double-colon punctuation">::</span>iterator it<span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>ThreadList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token function">DeleteCriticalSection</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cs<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">DeleteCriticalSection</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_cs<span class="token punctuation">)</span><span class="token punctuation">;</span>

	bRun <span class="token operator">=</span> FALSE<span class="token punctuation">;</span>
	
	<span class="token keyword">return</span> bResult<span class="token punctuation">;</span>
<span class="token punctuation">}</span>



<span class="token keyword">void</span> <span class="token class-name">CGenericServer</span><span class="token double-colon punctuation">::</span><span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//</span>
	<span class="token comment">// Reset statistic values</span>
	<span class="token comment">//</span>
	Stats<span class="token punctuation">.</span>nClientsConnected		<span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	Stats<span class="token punctuation">.</span>nErrosCount			<span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	Stats<span class="token punctuation">.</span>nTotalSent			<span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	Stats<span class="token punctuation">.</span>nTotalRecv			<span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	Stats<span class="token punctuation">.</span>nTotalHits			<span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	Stats<span class="token punctuation">.</span>nVisitors				<span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>



<span class="token comment">//清除线程</span>
<span class="token keyword">void</span> <span class="token class-name">CGenericServer</span><span class="token double-colon punctuation">::</span><span class="token function">CleanupThread</span><span class="token punctuation">(</span>WSAEVENT Event<span class="token punctuation">,</span> SOCKET s<span class="token punctuation">,</span> NewConnectionTag<span class="token operator">*</span> pNewConn<span class="token punctuation">,</span> DWORD dwThreadID<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>Event<span class="token punctuation">)</span>
		<span class="token function">WSACloseEvent</span><span class="token punctuation">(</span>Event<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">closesocket</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">EnterCriticalSection</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cs<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">delete</span> pNewConn<span class="token punctuation">;</span>
	<span class="token function">LeaveCriticalSection</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cs<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	THREADLIST<span class="token double-colon punctuation">::</span>iterator it<span class="token punctuation">;</span>
	it <span class="token operator">=</span> <span class="token function">find_if</span><span class="token punctuation">(</span>ThreadList<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ThreadList<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">bind2nd</span><span class="token punctuation">(</span><span class="token function">IDCompare</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dwThreadID<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>it <span class="token operator">!=</span> ThreadList<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">EnterCriticalSection</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_cs<span class="token punctuation">)</span><span class="token punctuation">;</span>
		HANDLE aaa <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>it<span class="token punctuation">)</span><span class="token punctuation">.</span>hThread<span class="token punctuation">;</span>
		HandleList<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>it<span class="token punctuation">)</span><span class="token punctuation">.</span>hThread<span class="token punctuation">)</span><span class="token punctuation">;</span>
		ThreadList<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">LeaveCriticalSection</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_cs<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
		<span class="token function">LogMessage</span><span class="token punctuation">(</span>LOGFILENAME<span class="token punctuation">,</span> <span class="token string">"Thread not found in the list"</span><span class="token punctuation">,</span> <span class="token string">"ClientThread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>



<span class="token comment">//清除线程</span>
<span class="token keyword">void</span> <span class="token class-name">CGenericServer</span><span class="token double-colon punctuation">::</span><span class="token function">CleanupThread</span><span class="token punctuation">(</span>WSAEVENT Event<span class="token punctuation">,</span> WSAEVENT ShutdownEvent<span class="token punctuation">,</span> SOCKET s<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>Event<span class="token punctuation">)</span>
		<span class="token function">WSACloseEvent</span><span class="token punctuation">(</span>Event<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span><span class="token punctuation">(</span>ShutdownEvent<span class="token punctuation">)</span>
		<span class="token function">WSACloseEvent</span><span class="token punctuation">(</span>ShutdownEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
		<span class="token function">closesocket</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">WSACleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>




UINT __stdcall <span class="token class-name">CGenericServer</span><span class="token double-colon punctuation">::</span><span class="token function">AcceptThread</span><span class="token punctuation">(</span>LPVOID pParam<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	CGenericServer <span class="token operator">*</span>pGenericServer <span class="token operator">=</span> <span class="token punctuation">(</span>CGenericServer<span class="token operator">*</span><span class="token punctuation">)</span>pParam<span class="token punctuation">;</span>
	SOCKET s<span class="token punctuation">;</span> <span class="token comment">// 主线程</span>
	WORD wVersionRequested<span class="token punctuation">;</span>
	WSADATA wsaData<span class="token punctuation">;</span>
	sockaddr_in saLocal<span class="token punctuation">;</span>
	WSAEVENT Handles<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	WSANETWORKEVENTS	NetworkEvents<span class="token punctuation">;</span>
	sockaddr ClientAddr<span class="token punctuation">;</span>
	INT addrlen <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ClientAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
	sockaddr_in sain<span class="token punctuation">;</span>
	<span class="token keyword">char</span> cAddr<span class="token punctuation">[</span><span class="token number">50</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> result<span class="token punctuation">;</span>
	
	saLocal<span class="token punctuation">.</span>sin_family		<span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
	saLocal<span class="token punctuation">.</span>sin_port		<span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>pGenericServer<span class="token operator">-&gt;</span>ServerPort<span class="token punctuation">)</span><span class="token punctuation">;</span>
	saLocal<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> INADDR_ANY<span class="token punctuation">;</span>
	
	wVersionRequested <span class="token operator">=</span> <span class="token function">MAKEWORD</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	result <span class="token operator">=</span> <span class="token function">WSAStartup</span><span class="token punctuation">(</span>wVersionRequested<span class="token punctuation">,</span> <span class="token operator">&amp;</span>wsaData<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>result <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		pGenericServer<span class="token operator">-&gt;</span><span class="token function">LogMessage</span><span class="token punctuation">(</span>LOGFILENAME<span class="token punctuation">,</span> <span class="token string">"WSAStartup(...) failure"</span><span class="token punctuation">,</span> <span class="token string">"AcceptThread"</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> THREADEXIT_SUCCESS<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token keyword">if</span><span class="token punctuation">(</span>	<span class="token function">LOBYTE</span><span class="token punctuation">(</span>wsaData<span class="token punctuation">.</span>wVersion<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">2</span> <span class="token operator">||</span>
		<span class="token function">HIBYTE</span><span class="token punctuation">(</span>wsaData<span class="token punctuation">.</span>wVersion<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span> 
	<span class="token punctuation">{<!-- --></span>
		pGenericServer<span class="token operator">-&gt;</span><span class="token function">LogMessage</span><span class="token punctuation">(</span>LOGFILENAME<span class="token punctuation">,</span> <span class="token string">"Requested Socket version not exist"</span><span class="token punctuation">,</span> <span class="token string">"AcceptThread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		pGenericServer<span class="token operator">-&gt;</span><span class="token function">CleanupThread</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> THREADEXIT_SUCCESS<span class="token punctuation">;</span> 
	<span class="token punctuation">}</span>
	
	s <span class="token operator">=</span> <span class="token function">WSASocket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>LPWSAPROTOCOL_INFO<span class="token punctuation">)</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> WSA_FLAG_OVERLAPPED<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>s <span class="token operator">==</span> INVALID_SOCKET<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		pGenericServer<span class="token operator">-&gt;</span><span class="token function">LogMessage</span><span class="token punctuation">(</span>LOGFILENAME<span class="token punctuation">,</span> <span class="token string">"WSASocket(...) failure"</span><span class="token punctuation">,</span> <span class="token string">"AcceptThread"</span><span class="token punctuation">,</span> <span class="token function">WSAGetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		pGenericServer<span class="token operator">-&gt;</span><span class="token function">CleanupThread</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> THREADEXIT_SUCCESS<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token comment">//</span>
	<span class="token comment">//	绑定</span>
	<span class="token comment">//</span>
	result <span class="token operator">=</span> <span class="token double-colon punctuation">::</span><span class="token function">bind</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>saLocal<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>saLocal<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>result <span class="token operator">==</span> SOCKET_ERROR<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		pGenericServer<span class="token operator">-&gt;</span><span class="token function">LogMessage</span><span class="token punctuation">(</span>LOGFILENAME<span class="token punctuation">,</span> <span class="token string">"bind(...) failure"</span><span class="token punctuation">,</span> <span class="token string">"AcceptThread"</span><span class="token punctuation">,</span> <span class="token function">WSAGetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		pGenericServer<span class="token operator">-&gt;</span><span class="token function">CleanupThread</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> THREADEXIT_SUCCESS<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>	

	<span class="token comment">//</span>
	<span class="token comment">//	侦听</span>
	<span class="token comment">//</span>
	result <span class="token operator">=</span> <span class="token function">listen</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> SOMAXCONN<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>result <span class="token operator">==</span> SOCKET_ERROR<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		pGenericServer<span class="token operator">-&gt;</span><span class="token function">LogMessage</span><span class="token punctuation">(</span>LOGFILENAME<span class="token punctuation">,</span> <span class="token string">"listen(...) failure"</span><span class="token punctuation">,</span> <span class="token string">"AcceptThread"</span><span class="token punctuation">,</span> <span class="token function">WSAGetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		pGenericServer<span class="token operator">-&gt;</span><span class="token function">CleanupThread</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> THREADEXIT_SUCCESS<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>	
	
 	pGenericServer<span class="token operator">-&gt;</span>ShutdownEvent <span class="token operator">=</span> <span class="token function">WSACreateEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>pGenericServer<span class="token operator">-&gt;</span>ShutdownEvent <span class="token operator">==</span> WSA_INVALID_EVENT<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		pGenericServer<span class="token operator">-&gt;</span><span class="token function">LogMessage</span><span class="token punctuation">(</span>LOGFILENAME<span class="token punctuation">,</span> <span class="token string">"WSACreateEvent(...) failure for ShutdownEvent"</span><span class="token punctuation">,</span> <span class="token string">"AcceptThread"</span><span class="token punctuation">,</span> <span class="token function">WSAGetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		pGenericServer<span class="token operator">-&gt;</span><span class="token function">CleanupThread</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> THREADEXIT_SUCCESS<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>		

	WSAEVENT Event <span class="token operator">=</span> <span class="token function">WSACreateEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>Event <span class="token operator">==</span> WSA_INVALID_EVENT<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		pGenericServer<span class="token operator">-&gt;</span><span class="token function">LogMessage</span><span class="token punctuation">(</span>LOGFILENAME<span class="token punctuation">,</span> <span class="token string">"WSACreateEvent(...) failure for Event"</span><span class="token punctuation">,</span> <span class="token string">"AcceptThread"</span><span class="token punctuation">,</span> <span class="token function">WSAGetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		pGenericServer<span class="token operator">-&gt;</span><span class="token function">CleanupThread</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> pGenericServer<span class="token operator">-&gt;</span>ShutdownEvent<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> THREADEXIT_SUCCESS<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>		
	
	Handles<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> pGenericServer<span class="token operator">-&gt;</span>ShutdownEvent<span class="token punctuation">;</span>
	Handles<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> Event<span class="token punctuation">;</span>

	result <span class="token operator">=</span> <span class="token function">WSAEventSelect</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> Event<span class="token punctuation">,</span> FD_ACCEPT<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>result <span class="token operator">==</span> SOCKET_ERROR<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		pGenericServer<span class="token operator">-&gt;</span><span class="token function">LogMessage</span><span class="token punctuation">(</span>LOGFILENAME<span class="token punctuation">,</span> <span class="token string">"WSAEventSelect(...) failure"</span><span class="token punctuation">,</span> <span class="token string">"AcceptThread"</span><span class="token punctuation">,</span> <span class="token function">WSAGetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		pGenericServer<span class="token operator">-&gt;</span><span class="token function">CleanupThread</span><span class="token punctuation">(</span>Event<span class="token punctuation">,</span> pGenericServer<span class="token operator">-&gt;</span>ShutdownEvent<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> THREADEXIT_SUCCESS<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">SetEvent</span><span class="token punctuation">(</span>pGenericServer<span class="token operator">-&gt;</span>ThreadLaunchedEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		DWORD EventCaused <span class="token operator">=</span> <span class="token function">WSAWaitForMultipleEvents</span><span class="token punctuation">(</span>
			<span class="token number">2</span><span class="token punctuation">,</span>
			Handles<span class="token punctuation">,</span>  
			FALSE<span class="token punctuation">,</span>                  
			WSA_INFINITE<span class="token punctuation">,</span> 
			FALSE<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span><span class="token punctuation">(</span>EventCaused <span class="token operator">==</span> WAIT_FAILED <span class="token operator">||</span> EventCaused <span class="token operator">==</span> WAIT_OBJECT_0<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>EventCaused <span class="token operator">==</span> WAIT_FAILED<span class="token punctuation">)</span>
				pGenericServer<span class="token operator">-&gt;</span><span class="token function">LogMessage</span><span class="token punctuation">(</span>LOGFILENAME<span class="token punctuation">,</span> <span class="token string">"WaitForMultipleObjects(...) failure"</span><span class="token punctuation">,</span> <span class="token string">"AcceptThread"</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			pGenericServer<span class="token operator">-&gt;</span><span class="token function">CleanupThread</span><span class="token punctuation">(</span>Event<span class="token punctuation">,</span> pGenericServer<span class="token operator">-&gt;</span>ShutdownEvent<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> THREADEXIT_SUCCESS<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		result <span class="token operator">=</span> <span class="token function">WSAEnumNetworkEvents</span><span class="token punctuation">(</span>
			s<span class="token punctuation">,</span>                           
			Event<span class="token punctuation">,</span>              
			<span class="token operator">&amp;</span>NetworkEvents<span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token keyword">if</span><span class="token punctuation">(</span>result <span class="token operator">==</span> SOCKET_ERROR<span class="token punctuation">)</span>						 
		<span class="token punctuation">{<!-- --></span>
			pGenericServer<span class="token operator">-&gt;</span><span class="token function">LogMessage</span><span class="token punctuation">(</span>LOGFILENAME<span class="token punctuation">,</span> <span class="token string">"WSAEnumNetworkEvents(...) failure"</span><span class="token punctuation">,</span> <span class="token string">"AcceptThread"</span><span class="token punctuation">,</span> <span class="token function">WSAGetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			pGenericServer<span class="token operator">-&gt;</span><span class="token function">CleanupThread</span><span class="token punctuation">(</span>Event<span class="token punctuation">,</span> pGenericServer<span class="token operator">-&gt;</span>ShutdownEvent<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> THREADEXIT_SUCCESS<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">if</span><span class="token punctuation">(</span>NetworkEvents<span class="token punctuation">.</span>lNetworkEvents <span class="token operator">==</span> FD_ACCEPT<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			SOCKET ClientSocket <span class="token operator">=</span> <span class="token function">WSAAccept</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ClientAddr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>addrlen<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sain<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ClientAddr<span class="token punctuation">,</span> addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">sprintf</span><span class="token punctuation">(</span>cAddr<span class="token punctuation">,</span> <span class="token string">"%d.%d.%d.%d"</span><span class="token punctuation">,</span> 
				sain<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>S_un<span class="token punctuation">.</span>S_un_b<span class="token punctuation">.</span>s_b1<span class="token punctuation">,</span> 
				sain<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>S_un<span class="token punctuation">.</span>S_un_b<span class="token punctuation">.</span>s_b2<span class="token punctuation">,</span> 
				sain<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>S_un<span class="token punctuation">.</span>S_un_b<span class="token punctuation">.</span>s_b3<span class="token punctuation">,</span> 
				sain<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>S_un<span class="token punctuation">.</span>S_un_b<span class="token punctuation">.</span>s_b4<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token keyword">if</span><span class="token punctuation">(</span>INVALID_SOCKET <span class="token operator">==</span> ClientSocket<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				pGenericServer<span class="token operator">-&gt;</span><span class="token function">LogMessage</span><span class="token punctuation">(</span>LOGFILENAME<span class="token punctuation">,</span> <span class="token string">"WSAAccept(...) failure"</span><span class="token punctuation">,</span> <span class="token string">"AcceptThread"</span><span class="token punctuation">,</span> <span class="token function">WSAGetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token comment">// 有一个文件错误</span>
				<span class="token keyword">continue</span><span class="token punctuation">;</span> 
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>pGenericServer<span class="token operator">-&gt;</span><span class="token function">AddClient</span><span class="token punctuation">(</span>ClientSocket<span class="token punctuation">,</span> cAddr<span class="token punctuation">,</span> sain<span class="token punctuation">.</span>sin_port<span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">{<!-- --></span>
					pGenericServer<span class="token operator">-&gt;</span><span class="token function">LogMessage</span><span class="token punctuation">(</span>LOGFILENAME<span class="token punctuation">,</span> <span class="token string">"AddClient(...) failure"</span><span class="token punctuation">,</span> <span class="token string">"AcceptThread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">continue</span><span class="token punctuation">;</span> <span class="token comment">// I think there is no reason to shutdown whole server if just one connection failed</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	pGenericServer<span class="token operator">-&gt;</span><span class="token function">CleanupThread</span><span class="token punctuation">(</span>Event<span class="token punctuation">,</span> pGenericServer<span class="token operator">-&gt;</span>ShutdownEvent<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> THREADEXIT_SUCCESS<span class="token punctuation">;</span> 
<span class="token punctuation">}</span>	


									  



<span class="token comment">//客户端线程</span>
<span class="token keyword">unsigned</span> __stdcall <span class="token class-name">CGenericServer</span><span class="token double-colon punctuation">::</span><span class="token function">ClientThread</span><span class="token punctuation">(</span>LPVOID pParam<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	NewConnectionTag <span class="token operator">*</span>pNewConn <span class="token operator">=</span> <span class="token punctuation">(</span>NewConnectionTag<span class="token operator">*</span><span class="token punctuation">)</span>pParam<span class="token punctuation">;</span>
	CGenericServer <span class="token operator">*</span>pGenericServer <span class="token operator">=</span> pNewConn<span class="token operator">-&gt;</span>pGenericServer<span class="token punctuation">;</span>
	SOCKET s <span class="token operator">=</span> pNewConn<span class="token operator">-&gt;</span>s<span class="token punctuation">;</span>

	<span class="token keyword">int</span>					result<span class="token punctuation">;</span>
	WSAEVENT			EventArray<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	WSANETWORKEVENTS	NetworkEvents<span class="token punctuation">;</span>

	BOOL				bResend <span class="token operator">=</span> FALSE<span class="token punctuation">;</span>
	WSABUF				Buffer<span class="token punctuation">;</span>
	DWORD				NumberOfBytesSent<span class="token punctuation">;</span>
	DWORD				dwBytesSent<span class="token punctuation">;</span>
	BOOL				bKeepAlive <span class="token operator">=</span> FALSE<span class="token punctuation">;</span>
	string				szRequest<span class="token punctuation">;</span>
	string				szResponse<span class="token punctuation">;</span>
				
	WSAEVENT			Event <span class="token operator">=</span> <span class="token function">WSACreateEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span><span class="token punctuation">(</span>Event <span class="token operator">==</span> WSA_INVALID_EVENT<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		pGenericServer<span class="token operator">-&gt;</span><span class="token function">LogMessage</span><span class="token punctuation">(</span>LOGFILENAME<span class="token punctuation">,</span> <span class="token string">"WSACreateEvent(...) failure"</span><span class="token punctuation">,</span> <span class="token string">"ClientThread"</span><span class="token punctuation">,</span> <span class="token function">WSAGetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		pGenericServer<span class="token operator">-&gt;</span><span class="token function">CleanupThread</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> s<span class="token punctuation">,</span> pNewConn<span class="token punctuation">,</span> <span class="token function">GetCurrentThreadId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> THREADEXIT_SUCCESS<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	result <span class="token operator">=</span> <span class="token function">WSAEventSelect</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> Event<span class="token punctuation">,</span> FD_READ <span class="token operator">|</span> FD_WRITE <span class="token operator">|</span> FD_CLOSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>result <span class="token operator">==</span> SOCKET_ERROR<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		pGenericServer<span class="token operator">-&gt;</span><span class="token function">LogMessage</span><span class="token punctuation">(</span>LOGFILENAME<span class="token punctuation">,</span> <span class="token string">"WSAEventSelect(...) failure"</span><span class="token punctuation">,</span> <span class="token string">"ClientThread"</span><span class="token punctuation">,</span> <span class="token function">WSAGetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		pGenericServer<span class="token operator">-&gt;</span><span class="token function">CleanupThread</span><span class="token punctuation">(</span>Event<span class="token punctuation">,</span> s<span class="token punctuation">,</span> pNewConn<span class="token punctuation">,</span> <span class="token function">GetCurrentThreadId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> THREADEXIT_SUCCESS<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	EventArray<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> Event<span class="token punctuation">;</span>
	EventArray<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> pGenericServer<span class="token operator">-&gt;</span>ShutdownEvent<span class="token punctuation">;</span>

	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		DWORD EventCaused <span class="token operator">=</span> <span class="token function">WSAWaitForMultipleEvents</span><span class="token punctuation">(</span>
			<span class="token number">2</span><span class="token punctuation">,</span>
			EventArray<span class="token punctuation">,</span>  
			FALSE<span class="token punctuation">,</span>                  
			pGenericServer<span class="token operator">-&gt;</span>PersistenceTO <span class="token operator">?</span> pGenericServer<span class="token operator">-&gt;</span>PersistenceTO <span class="token operator">:</span> WSA_INFINITE<span class="token punctuation">,</span> 
			FALSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token keyword">if</span><span class="token punctuation">(</span>WSA_WAIT_FAILED <span class="token operator">==</span> EventCaused<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			pGenericServer<span class="token operator">-&gt;</span><span class="token function">LogMessage</span><span class="token punctuation">(</span>LOGFILENAME<span class="token punctuation">,</span> <span class="token string">"WSAWaitForMultipleEvents(...) failure"</span><span class="token punctuation">,</span> <span class="token string">"ClientThread"</span><span class="token punctuation">,</span> <span class="token function">WSAGetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			pGenericServer<span class="token operator">-&gt;</span><span class="token function">CleanupThread</span><span class="token punctuation">(</span>Event<span class="token punctuation">,</span> s<span class="token punctuation">,</span> pNewConn<span class="token punctuation">,</span> <span class="token function">GetCurrentThreadId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> THREADEXIT_SUCCESS<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">//</span>
		<span class="token comment">// 检查是否服务器任务已经完成 </span>
		<span class="token comment">//</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>EventCaused <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">||</span> EventCaused <span class="token operator">==</span> WSA_WAIT_TIMEOUT<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			pGenericServer<span class="token operator">-&gt;</span><span class="token function">CleanupThread</span><span class="token punctuation">(</span>Event<span class="token punctuation">,</span> s<span class="token punctuation">,</span> pNewConn<span class="token punctuation">,</span> <span class="token function">GetCurrentThreadId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> THREADEXIT_SUCCESS<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		
		<span class="token comment">//</span>
		<span class="token comment">//	分析什么网络事件产生</span>
		<span class="token comment">//</span>
		result <span class="token operator">=</span> <span class="token function">WSAEnumNetworkEvents</span><span class="token punctuation">(</span>
			s<span class="token punctuation">,</span>                           
			Event<span class="token punctuation">,</span>              
			<span class="token operator">&amp;</span>NetworkEvents<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span><span class="token punctuation">(</span>result <span class="token operator">==</span> SOCKET_ERROR<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			pGenericServer<span class="token operator">-&gt;</span><span class="token function">LogMessage</span><span class="token punctuation">(</span>LOGFILENAME<span class="token punctuation">,</span> <span class="token string">"WSAEnumNetworkEvents(...) failure"</span><span class="token punctuation">,</span> <span class="token string">"ClientThread"</span><span class="token punctuation">,</span> <span class="token function">WSAGetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">continue</span><span class="token punctuation">;</span> 
		<span class="token punctuation">}</span>
		
		<span class="token comment">//</span>
		<span class="token comment">// 其他情况</span>
		<span class="token comment">//</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>NetworkEvents<span class="token punctuation">.</span>lNetworkEvents<span class="token punctuation">)</span>
			<span class="token keyword">continue</span><span class="token punctuation">;</span>

		<span class="token comment">//</span>
		<span class="token comment">// 处理事件</span>
		<span class="token comment">// </span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>NetworkEvents<span class="token punctuation">.</span>lNetworkEvents <span class="token operator">&amp;</span> FD_READ<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token comment">//</span>
			<span class="token comment">//	不需要接收接传入的数据，只需要传给继承类</span>
			<span class="token comment">//</span>
			DWORD NumberOfBytesRecvd<span class="token punctuation">;</span>
			WSABUF Buffers<span class="token punctuation">;</span>
			DWORD dwBufferCount <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
			<span class="token keyword">char</span> szBuffer<span class="token punctuation">[</span>MAX_BUFFER<span class="token punctuation">]</span><span class="token punctuation">;</span>
			DWORD Flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			Buffers<span class="token punctuation">.</span>buf <span class="token operator">=</span> szBuffer<span class="token punctuation">;</span>
			Buffers<span class="token punctuation">.</span>len <span class="token operator">=</span> MAX_BUFFER<span class="token punctuation">;</span>
			
			result <span class="token operator">=</span> <span class="token function">WSARecv</span><span class="token punctuation">(</span>
				s<span class="token punctuation">,</span>
				<span class="token operator">&amp;</span>Buffers<span class="token punctuation">,</span>
				dwBufferCount<span class="token punctuation">,</span>
				<span class="token operator">&amp;</span>NumberOfBytesRecvd<span class="token punctuation">,</span>
				<span class="token operator">&amp;</span>Flags<span class="token punctuation">,</span>
				<span class="token constant">NULL</span><span class="token punctuation">,</span>
				<span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			
			<span class="token keyword">if</span><span class="token punctuation">(</span>result <span class="token operator">!=</span> SOCKET_ERROR<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				pGenericServer<span class="token operator">-&gt;</span>Stats<span class="token punctuation">.</span>nTotalRecv <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>NumberOfBytesRecvd <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">;</span>

				<span class="token comment">//</span>
				<span class="token comment">// 检测是否获得完整的请求</span>
				<span class="token comment">//</span>
				szRequest <span class="token operator">+=</span> <span class="token function">string</span><span class="token punctuation">(</span>szBuffer<span class="token punctuation">,</span> NumberOfBytesRecvd<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>pGenericServer<span class="token operator">-&gt;</span><span class="token function">IsComplete</span><span class="token punctuation">(</span>szRequest<span class="token punctuation">)</span><span class="token punctuation">)</span>
					<span class="token keyword">continue</span><span class="token punctuation">;</span>

				<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>pGenericServer<span class="token operator">-&gt;</span><span class="token function">ParseRequest</span><span class="token punctuation">(</span>szRequest<span class="token punctuation">,</span> szResponse<span class="token punctuation">,</span> bKeepAlive<span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">{<!-- --></span>
					pGenericServer<span class="token operator">-&gt;</span><span class="token function">CleanupThread</span><span class="token punctuation">(</span>Event<span class="token punctuation">,</span> s<span class="token punctuation">,</span> pNewConn<span class="token punctuation">,</span> <span class="token function">GetCurrentThreadId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">return</span> THREADEXIT_SUCCESS<span class="token punctuation">;</span>
				<span class="token punctuation">}</span>

				<span class="token comment">//</span>
				<span class="token comment">// 发送响应倒客户端</span>
				<span class="token comment">//</span>
				NumberOfBytesSent <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
				dwBytesSent <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
				<span class="token keyword">do</span>
				<span class="token punctuation">{<!-- --></span>
					Buffer<span class="token punctuation">.</span>len <span class="token operator">=</span> <span class="token punctuation">(</span>szResponse<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> dwBytesSent<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> SENDBLOCK <span class="token operator">?</span> SENDBLOCK <span class="token operator">:</span> szResponse<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> dwBytesSent<span class="token punctuation">;</span>	
					Buffer<span class="token punctuation">.</span>buf <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>DWORD<span class="token punctuation">)</span>szResponse<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> dwBytesSent<span class="token punctuation">)</span><span class="token punctuation">;</span>

					result <span class="token operator">=</span> <span class="token function">WSASend</span><span class="token punctuation">(</span>
						s<span class="token punctuation">,</span>                                                
						<span class="token operator">&amp;</span>Buffer<span class="token punctuation">,</span>                                     
						<span class="token number">1</span><span class="token punctuation">,</span>                                    
						<span class="token operator">&amp;</span>NumberOfBytesSent<span class="token punctuation">,</span>
						<span class="token number">0</span><span class="token punctuation">,</span>                                          
						<span class="token number">0</span><span class="token punctuation">,</span>                           
						<span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					
					<span class="token keyword">if</span><span class="token punctuation">(</span>SOCKET_ERROR <span class="token operator">!=</span> result<span class="token punctuation">)</span>
						dwBytesSent <span class="token operator">+=</span> NumberOfBytesSent<span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>dwBytesSent <span class="token operator">&lt;</span> szResponse<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> SOCKET_ERROR <span class="token operator">!=</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">WSAGetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> WSAEWOULDBLOCK<span class="token punctuation">)</span>
				<span class="token punctuation">{<!-- --></span>
					bResend <span class="token operator">=</span> TRUE<span class="token punctuation">;</span>
					<span class="token keyword">continue</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>

				<span class="token keyword">if</span><span class="token punctuation">(</span>SOCKET_ERROR <span class="token operator">!=</span> result<span class="token punctuation">)</span>
				<span class="token punctuation">{<!-- --></span>
					pGenericServer<span class="token operator">-&gt;</span>Stats<span class="token punctuation">.</span>nTotalSent <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>dwBytesSent <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">;</span>
					pGenericServer<span class="token operator">-&gt;</span><span class="token function">DataSent</span><span class="token punctuation">(</span>dwBytesSent<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">else</span>
				<span class="token punctuation">{<!-- --></span>
					pGenericServer<span class="token operator">-&gt;</span><span class="token function">LogMessage</span><span class="token punctuation">(</span>LOGFILENAME<span class="token punctuation">,</span> <span class="token string">"WSASend(...) failure"</span><span class="token punctuation">,</span> <span class="token string">"ClientThread, Primary Send"</span><span class="token punctuation">,</span> <span class="token function">WSAGetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					bKeepAlive <span class="token operator">=</span> FALSE<span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				
				<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>bKeepAlive<span class="token punctuation">)</span> 
				<span class="token punctuation">{<!-- --></span>
					pGenericServer<span class="token operator">-&gt;</span><span class="token function">CleanupThread</span><span class="token punctuation">(</span>Event<span class="token punctuation">,</span> s<span class="token punctuation">,</span> pNewConn<span class="token punctuation">,</span> <span class="token function">GetCurrentThreadId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">return</span> THREADEXIT_SUCCESS<span class="token punctuation">;</span>
				<span class="token punctuation">}</span>

				<span class="token comment">//</span>
				<span class="token comment">// 完成请求，清除缓冲区</span>
				<span class="token comment">//</span>
				szRequest<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> string<span class="token double-colon punctuation">::</span>npos<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span>
				pGenericServer<span class="token operator">-&gt;</span><span class="token function">LogMessage</span><span class="token punctuation">(</span>LOGFILENAME<span class="token punctuation">,</span> <span class="token string">"WSARecv(...) failure"</span><span class="token punctuation">,</span> <span class="token string">"ClientThread"</span><span class="token punctuation">,</span> <span class="token function">WSAGetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		
		
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>NetworkEvents<span class="token punctuation">.</span>lNetworkEvents <span class="token operator">&amp;</span> FD_WRITE<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> bResend<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token comment">//</span>
			<span class="token comment">// 发送响应倒客户端</span>
			<span class="token comment">//</span>
			<span class="token keyword">do</span>
			<span class="token punctuation">{<!-- --></span>
				Buffer<span class="token punctuation">.</span>len <span class="token operator">=</span> <span class="token punctuation">(</span>szResponse<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> dwBytesSent<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> SENDBLOCK <span class="token operator">?</span> SENDBLOCK <span class="token operator">:</span> szResponse<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> dwBytesSent<span class="token punctuation">;</span>	
				Buffer<span class="token punctuation">.</span>buf <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>DWORD<span class="token punctuation">)</span>szResponse<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> dwBytesSent<span class="token punctuation">)</span><span class="token punctuation">;</span>
				
				result <span class="token operator">=</span> <span class="token function">WSASend</span><span class="token punctuation">(</span>
					s<span class="token punctuation">,</span>                                                
					<span class="token operator">&amp;</span>Buffer<span class="token punctuation">,</span>                                     
					<span class="token number">1</span><span class="token punctuation">,</span>                                    
					<span class="token operator">&amp;</span>NumberOfBytesSent<span class="token punctuation">,</span>
					<span class="token number">0</span><span class="token punctuation">,</span>                                          
					<span class="token number">0</span><span class="token punctuation">,</span>                           
					<span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token keyword">if</span><span class="token punctuation">(</span>SOCKET_ERROR <span class="token operator">!=</span> result<span class="token punctuation">)</span>				
					dwBytesSent <span class="token operator">+=</span> NumberOfBytesSent<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>dwBytesSent <span class="token operator">&lt;</span> szResponse<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> SOCKET_ERROR <span class="token operator">!=</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
			
			<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">WSAGetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> WSAEWOULDBLOCK<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				bResend <span class="token operator">=</span> TRUE<span class="token punctuation">;</span>
				<span class="token keyword">continue</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			<span class="token keyword">if</span><span class="token punctuation">(</span>SOCKET_ERROR <span class="token operator">!=</span> result<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				pGenericServer<span class="token operator">-&gt;</span>Stats<span class="token punctuation">.</span>nTotalSent <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>dwBytesSent <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">;</span>
				pGenericServer<span class="token operator">-&gt;</span><span class="token function">DataSent</span><span class="token punctuation">(</span>dwBytesSent<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span>
			<span class="token punctuation">{<!-- --></span>
				pGenericServer<span class="token operator">-&gt;</span><span class="token function">LogMessage</span><span class="token punctuation">(</span>LOGFILENAME<span class="token punctuation">,</span> <span class="token string">"WSASend(...) failure"</span><span class="token punctuation">,</span> <span class="token string">"ClientThread, Primary Send"</span><span class="token punctuation">,</span> <span class="token function">WSAGetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				bKeepAlive <span class="token operator">=</span> FALSE<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			
			<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>bKeepAlive<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				pGenericServer<span class="token operator">-&gt;</span><span class="token function">CleanupThread</span><span class="token punctuation">(</span>Event<span class="token punctuation">,</span> s<span class="token punctuation">,</span> pNewConn<span class="token punctuation">,</span> <span class="token function">GetCurrentThreadId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> THREADEXIT_SUCCESS<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			
			bResend <span class="token operator">=</span> FALSE<span class="token punctuation">;</span>

			<span class="token comment">//</span>
			<span class="token comment">// 清除缓冲区</span>
			<span class="token comment">//</span>
			szRequest<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> string<span class="token double-colon punctuation">::</span>npos<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>	
		
		
		<span class="token keyword">if</span><span class="token punctuation">(</span>NetworkEvents<span class="token punctuation">.</span>lNetworkEvents <span class="token operator">&amp;</span> FD_CLOSE<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			pGenericServer<span class="token operator">-&gt;</span><span class="token function">CleanupThread</span><span class="token punctuation">(</span>Event<span class="token punctuation">,</span> s<span class="token punctuation">,</span> pNewConn<span class="token punctuation">,</span> <span class="token function">GetCurrentThreadId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> THREADEXIT_SUCCESS<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> THREADEXIT_SUCCESS<span class="token punctuation">;</span> <span class="token comment">//</span>
<span class="token punctuation">}</span>	






UINT __stdcall <span class="token class-name">CGenericServer</span><span class="token double-colon punctuation">::</span><span class="token function">HelperThread</span><span class="token punctuation">(</span>LPVOID pParam<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	CGenericServer <span class="token operator">*</span>pGenericServer <span class="token operator">=</span> <span class="token punctuation">(</span>CGenericServer<span class="token operator">*</span><span class="token punctuation">)</span>pParam<span class="token punctuation">;</span>
	HANDLELIST<span class="token double-colon punctuation">::</span>iterator it<span class="token punctuation">;</span>

	<span class="token function">SetEvent</span><span class="token punctuation">(</span>pGenericServer<span class="token operator">-&gt;</span>ThreadLaunchedEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">WaitForSingleObject</span><span class="token punctuation">(</span>pGenericServer<span class="token operator">-&gt;</span>ShutdownEvent<span class="token punctuation">,</span> TICK<span class="token punctuation">)</span> <span class="token operator">==</span> WAIT_TIMEOUT<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">EnterCriticalSection</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pGenericServer<span class="token operator">-&gt;</span>_cs<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">while</span><span class="token punctuation">(</span>pGenericServer<span class="token operator">-&gt;</span>HandleList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				HANDLE h <span class="token operator">=</span> pGenericServer<span class="token operator">-&gt;</span>HandleList<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
				DWORD n <span class="token operator">=</span> <span class="token function">WaitForSingleObject</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> THREADKILL_TO<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span><span class="token punctuation">(</span>n <span class="token operator">==</span> WAIT_TIMEOUT<span class="token punctuation">)</span>
				<span class="token punctuation">{<!-- --></span>
					pGenericServer<span class="token operator">-&gt;</span><span class="token function">LogMessage</span><span class="token punctuation">(</span>LOGFILENAME<span class="token punctuation">,</span> <span class="token string">"WaitForSingleObject(...) timed out"</span><span class="token punctuation">,</span> <span class="token string">"HelperThread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">TerminateThread</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> THREADEXIT_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">)</span>
						pGenericServer<span class="token operator">-&gt;</span><span class="token function">LogMessage</span><span class="token punctuation">(</span>LOGFILENAME<span class="token punctuation">,</span> <span class="token string">"TerminateThread(.h.) failure, probably it is already terminated"</span><span class="token punctuation">,</span> <span class="token string">"HelperThread"</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token function">CloseHandle</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">;</span>
				pGenericServer<span class="token operator">-&gt;</span>HandleList<span class="token punctuation">.</span><span class="token function">pop_front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token function">LeaveCriticalSection</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pGenericServer<span class="token operator">-&gt;</span>_cs<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span>
			<span class="token keyword">return</span> THREADEXIT_SUCCESS<span class="token punctuation">;</span><span class="token comment">//不是超时返回，说明服务关闭了。</span>
		
	<span class="token punctuation">}</span>
	
	<span class="token keyword">return</span> THREADEXIT_SUCCESS<span class="token punctuation">;</span>
<span class="token punctuation">}</span>	










</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f:626c6f672e6373646e2e6e65742f416e746f6e696f3931352f:61727469636c652f64657461696c732f313436313732373037" class_="artid" style="display:none">
 </p>
</div>


