---
layout: post
title: "c-union使用笔记"
date: 2025-03-13 09:08:18 +0800
description: "C++联合（union）是一种特殊的数据结构，允许在相同内存位置存储不同的数据类型，其核心价值在于。（所有成员共享同一块内存）。：通过枚举标记联合当前存储的数据类型，避免错误访问。对于需要更安全的类型存储，推荐使用。"
keywords: "c++ union使用笔记"
categories: ['C']
tags: ['笔记', 'C']
artid: "146221942"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146221942
    alt: "c-union使用笔记"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146221942
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146221942
cover: https://bing.ee123.net/img/rand?artid=146221942
image: https://bing.ee123.net/img/rand?artid=146221942
img: https://bing.ee123.net/img/rand?artid=146221942
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     c++ union使用笔记
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <br/>
    C++联合（union）是一种特殊的数据结构，允许在相同内存位置存储不同的数据类型，其核心价值在于
    <strong>
     节省内存空间
    </strong>
    （所有成员共享同一块内存）。以下是联合的详细说明和应用示例：
    <p>
    </p>
    <hr/>
    <h4>
     <a id="_5">
     </a>
     一、联合的简单使用
    </h4>
    <p>
     <strong>
      特点
     </strong>
     ：
    </p>
    <ul>
     <li>
      所有成员共享同一块内存（大小为最大成员的大小）
     </li>
     <li>
      同一时间只能使用一个成员
     </li>
     <li>
      默认访问权限为
      <code>
       public
      </code>
     </li>
    </ul>
    <p>
     <strong>
      示例
     </strong>
     ：
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">union</span> NumericData <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    <span class="token keyword">double</span> d<span class="token punctuation">;</span>
    <span class="token keyword">char</span> c<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    NumericData data<span class="token punctuation">;</span>
    data<span class="token punctuation">.</span>i <span class="token operator">=</span> <span class="token number">42</span><span class="token punctuation">;</span>                <span class="token comment">// 存储整数</span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> data<span class="token punctuation">.</span>i <span class="token operator">&lt;&lt;</span> <span class="token string">"\n"</span><span class="token punctuation">;</span> <span class="token comment">// 输出 42</span>
    
    data<span class="token punctuation">.</span>d <span class="token operator">=</span> <span class="token number">3.14</span><span class="token punctuation">;</span>              <span class="token comment">// 覆盖内存，存储双精度浮点数</span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> data<span class="token punctuation">.</span>d <span class="token operator">&lt;&lt;</span> <span class="token string">"\n"</span><span class="token punctuation">;</span> <span class="token comment">// 输出 3.14</span>
    
    <span class="token comment">// 注意：此时访问 data.i 将得到无意义的值！</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <hr/>
    <h4>
     <a id="_34">
     </a>
     二、联合与枚举结合
    </h4>
    <p>
     <strong>
      核心思想
     </strong>
     ：通过枚举标记联合当前存储的数据类型，避免错误访问。
    </p>
    <p>
     <strong>
      示例1
     </strong>
     ：
    </p>
    <pre><code class="prism language-cpp"><span class="token comment">// 定义数据类型标签</span>
<span class="token keyword">enum</span> <span class="token keyword">class</span> <span class="token class-name">DataType</span> <span class="token punctuation">{<!-- --></span> INT<span class="token punctuation">,</span> DOUBLE<span class="token punctuation">,</span> CHAR <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">DataContainer</span> <span class="token punctuation">{<!-- --></span>
    DataType tag<span class="token punctuation">;</span> <span class="token comment">// 类型标记</span>
    <span class="token keyword">union</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> i<span class="token punctuation">;</span>
        <span class="token keyword">double</span> d<span class="token punctuation">;</span>
        <span class="token keyword">char</span> c<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    DataContainer dc<span class="token punctuation">;</span>
    dc<span class="token punctuation">.</span>tag <span class="token operator">=</span> DataType<span class="token double-colon punctuation">::</span>INT<span class="token punctuation">;</span>
    dc<span class="token punctuation">.</span>i <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>

    <span class="token comment">// 安全访问：先检查类型标记</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dc<span class="token punctuation">.</span>tag <span class="token operator">==</span> DataType<span class="token double-colon punctuation">::</span>INT<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> dc<span class="token punctuation">.</span>i <span class="token operator">&lt;&lt;</span> <span class="token string">"\n"</span><span class="token punctuation">;</span> <span class="token comment">// 输出 100</span>
    <span class="token punctuation">}</span>

    dc<span class="token punctuation">.</span>tag <span class="token operator">=</span> DataType<span class="token double-colon punctuation">::</span>DOUBLE<span class="token punctuation">;</span>
    dc<span class="token punctuation">.</span>d <span class="token operator">=</span> <span class="token number">2.718</span><span class="token punctuation">;</span>
    <span class="token comment">// 错误示例：未检查标记直接访问将导致未定义行为</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <hr/>
    <p>
     <strong>
      示例2
     </strong>
     ：
    </p>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>

<span class="token keyword">enum</span> <span class="token keyword">class</span> <span class="token class-name">DataType</span> <span class="token punctuation">{<!-- --></span> INT<span class="token punctuation">,</span> DOUBLE<span class="token punctuation">,</span> STRING <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">Variant</span> <span class="token punctuation">{<!-- --></span>
    DataType type<span class="token punctuation">;</span>
    <span class="token keyword">union</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> i<span class="token punctuation">;</span>
        <span class="token keyword">double</span> d<span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>string s<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// 构造函数</span>
    <span class="token function">Variant</span><span class="token punctuation">(</span><span class="token keyword">int</span> val<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">type</span><span class="token punctuation">(</span>DataType<span class="token double-colon punctuation">::</span>INT<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">i</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token function">Variant</span><span class="token punctuation">(</span><span class="token keyword">double</span> val<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">type</span><span class="token punctuation">(</span>DataType<span class="token double-colon punctuation">::</span>DOUBLE<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">d</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token function">Variant</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> val<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">type</span><span class="token punctuation">(</span>DataType<span class="token double-colon punctuation">::</span>STRING<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">new</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span> std<span class="token double-colon punctuation">::</span><span class="token function">string</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Placement new 构造字符串</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 析构函数</span>
    <span class="token operator">~</span><span class="token function">Variant</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> DataType<span class="token double-colon punctuation">::</span>STRING<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            s<span class="token punctuation">.</span><span class="token operator">~</span><span class="token function">basic_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 手动析构字符串</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 拷贝构造函数</span>
    <span class="token function">Variant</span><span class="token punctuation">(</span><span class="token keyword">const</span> Variant<span class="token operator">&amp;</span> other<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">type</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">case</span> DataType<span class="token double-colon punctuation">::</span>INT<span class="token operator">:</span> i <span class="token operator">=</span> other<span class="token punctuation">.</span>i<span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> DataType<span class="token double-colon punctuation">::</span>DOUBLE<span class="token operator">:</span> d <span class="token operator">=</span> other<span class="token punctuation">.</span>d<span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> DataType<span class="token double-colon punctuation">::</span>STRING<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span> std<span class="token double-colon punctuation">::</span><span class="token function">string</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 赋值运算符</span>
    Variant<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> Variant<span class="token operator">&amp;</span> other<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">!=</span> <span class="token operator">&amp;</span>other<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> DataType<span class="token double-colon punctuation">::</span>STRING<span class="token punctuation">)</span> s<span class="token punctuation">.</span><span class="token operator">~</span><span class="token function">basic_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            type <span class="token operator">=</span> other<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">case</span> DataType<span class="token double-colon punctuation">::</span>INT<span class="token operator">:</span> i <span class="token operator">=</span> other<span class="token punctuation">.</span>i<span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> DataType<span class="token double-colon punctuation">::</span>DOUBLE<span class="token operator">:</span> d <span class="token operator">=</span> other<span class="token punctuation">.</span>d<span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> DataType<span class="token double-colon punctuation">::</span>STRING<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span> std<span class="token double-colon punctuation">::</span><span class="token function">string</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <hr/>
    <h4>
     <a id="Anonymous_Union_124">
     </a>
     三、匿名联合（Anonymous Union）
    </h4>
    <p>
     <strong>
      特点
     </strong>
     ：
    </p>
    <ul>
     <li>
      没有名称，直接访问成员
     </li>
     <li>
      常用于结构体或类内部简化访问
     </li>
     <li>
      C++11 起允许包含非平凡类型（如
      <code>
       string
      </code>
      ，但需谨慎使用）
     </li>
    </ul>
    <p>
     <strong>
      示例
     </strong>
     ：
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">struct</span> <span class="token class-name">Data</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">enum</span> <span class="token punctuation">{<!-- --></span> INT<span class="token punctuation">,</span> FLOAT <span class="token punctuation">}</span> type<span class="token punctuation">;</span>
    <span class="token keyword">union</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 匿名联合</span>
        <span class="token keyword">int</span> i<span class="token punctuation">;</span>
        <span class="token keyword">float</span> f<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 使用示例</span>
Data d<span class="token punctuation">;</span>
d<span class="token punctuation">.</span>type <span class="token operator">=</span> Data<span class="token double-colon punctuation">::</span>INT<span class="token punctuation">;</span>
d<span class="token punctuation">.</span>i <span class="token operator">=</span> <span class="token number">42</span><span class="token punctuation">;</span> <span class="token comment">// 直接访问匿名联合成员</span>
</code></pre>
    <hr/>
    <h4>
     <a id="_149">
     </a>
     四、关键注意事项
    </h4>
    <ol>
     <li>
      <strong>
       内存覆盖
      </strong>
      ：修改一个成员会影响其他成员的值。
     </li>
     <li>
      <strong>
       类型安全
      </strong>
      ：必须手动跟踪当前有效成员（通常结合枚举）。
     </li>
     <li>
      <strong>
       构造/析构
      </strong>
      ：C++11 起支持含有非平凡类型的联合，但需显式管理生命周期。
     </li>
     <li>
      <strong>
       应用场景
      </strong>
      ：
      <ul>
       <li>
        协议解析（如网络数据包）
       </li>
       <li>
        硬件寄存器映射
       </li>
       <li>
        内存敏感型应用（嵌入式系统）
       </li>
      </ul>
     </li>
    </ol>
    <hr/>
    <h4>
     <a id="C17_stdvariant_160">
     </a>
     五、C++17 扩展：
     <code>
      std::variant
     </code>
    </h4>
    <p>
     对于需要更安全的类型存储，推荐使用
     <code>
      std::variant
     </code>
     （C++17 引入）：
    </p>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;variant&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>variant<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">double</span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&gt;</span> data<span class="token punctuation">;</span>
    data <span class="token operator">=</span> <span class="token number">42</span><span class="token punctuation">;</span> <span class="token comment">// 存储 int</span>
    data <span class="token operator">=</span> <span class="token string">"Hello"</span><span class="token punctuation">;</span> <span class="token comment">// 存储 string</span>
    <span class="token comment">// 自动跟踪当前类型，无需手动标记</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470:733a2f2f626c6f672e6373646e2e6e65742f6a70706473732f:61727469636c652f64657461696c732f313436323231393432" class_="artid" style="display:none">
 </p>
</div>


