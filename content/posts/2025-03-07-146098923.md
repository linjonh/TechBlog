---
layout: post
title: "银河麒麟高级服务器操作系统实例虚拟机桥接网络问题分析及处理"
date: 2025-03-07 16:28:18 +0800
description: "由此可知，由于使用team0（roundrobin ）模式，虚拟机arp广播报文，经vnet0进入网桥，此时网桥mac学习到虚拟机的mac地址对应vnet0的port，此时fdb表是正确的。V10SP2系统，使用kvm运行虚拟机，如果是物理机两个网口做成一个team，然后team接网桥，虚拟机再通过这个网桥连接网络，这种方式网络会有问题。实际测试下来，确实会发现网络不通，此时如把team1从网桥删掉，换成物理网口，网络就可以正常使用，单独配置team，也可以正常使用。物理机/虚拟机/云/容器。"
keywords: "【银河麒麟高级服务器操作系统实例】虚拟机桥接网络问题分析及处理"
categories: ['银河麒麟高级服务器操作系统', '银河麒麟操作系统问题处理分享']
tags: ['运维', '电脑', '服务器', '开发语言', 'Php', 'Linux']
artid: "146098923"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146098923
    alt: "银河麒麟高级服务器操作系统实例虚拟机桥接网络问题分析及处理"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146098923
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146098923
cover: https://bing.ee123.net/img/rand?artid=146098923
image: https://bing.ee123.net/img/rand?artid=146098923
img: https://bing.ee123.net/img/rand?artid=146098923
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     【银河麒麟高级服务器操作系统实例】虚拟机桥接网络问题分析及处理
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <p>
     更多银河麒麟操作系统产品及技术讨论，欢迎加入银河麒麟操作系统官方论坛
    </p>
    <p>
     https://forum.kylinos.cn
    </p>
    <hr/>
    <p>
     了解更多银河麒麟操作系统全新产品，请点击访问
    </p>
    <p>
     麒麟软件产品专区：https://product.kylinos.cn
    </p>
    <p>
     开发者专区：https://developer.kylinos.cn
    </p>
    <p>
     文档中心：https://document.kylinos.cn
     <br/>
    </p>
    <hr/>
    <h3 style="text-align:left">
     <strong>
      <strong>
       <strong>
        服务器环境以及配置
       </strong>
      </strong>
     </strong>
    </h3>
    <table border="1" cellspacing="0" style="margin-left:4.8000pt; width:98.9600%">
     <tbody>
      <tr>
       <td style="background-color:#f1f1f1; height:14.1500pt; width:77.0000pt">
        <p style="margin-left:.0001pt; margin-right:0; text-align:center">
         <span style="color:#000000">
          系统环境
         </span>
        </p>
       </td>
       <td style="background-color:#ffffff; height:14.1500pt; width:146.7000pt">
        <p style="margin-left:.0001pt; margin-right:0; text-align:center">
         <span style="color:#000000">
          物理机/虚拟机/云/容器
         </span>
        </p>
       </td>
       <td style="background-color:#ffffff; height:14.1500pt; width:254.4000pt">
        <p style="margin-left:.0001pt; margin-right:0; text-align:center">
         <span style="color:#000000">
          虚拟机
         </span>
        </p>
       </td>
      </tr>
      <tr>
       <td style="background-color:#f1f1f1; height:14.1500pt; width:77.0000pt">
        <p style="margin-left:.0001pt; margin-right:0; text-align:center">
         <span style="color:#000000">
          网络环境
         </span>
        </p>
       </td>
       <td style="background-color:#ffffff; height:14.1500pt; width:146.7000pt">
        <p style="margin-left:.0001pt; margin-right:0; text-align:center">
         <span style="color:#000000">
          外网/私有网络/无网络
         </span>
        </p>
       </td>
       <td style="background-color:#ffffff; height:14.1500pt; width:254.4000pt">
        <p style="margin-left:.0001pt; margin-right:0; text-align:center">
         <span style="color:#000000">
          私有网络
         </span>
        </p>
       </td>
      </tr>
      <tr>
       <td rowspan="4" style="background-color:#f1f1f1; height:14.1500pt; width:77.0000pt">
        <p style="margin-left:.0001pt; margin-right:0; text-align:center">
         <strong>
          <span style="color:#000000">
           硬件环境
          </span>
         </strong>
        </p>
       </td>
       <td style="background-color:#ffffff; height:14.1500pt; width:146.7000pt">
        <p style="margin-left:.0001pt; margin-right:0; text-align:center">
         <span style="background-color:#ffffff">
          <span style="color:#000000">
           机型
          </span>
         </span>
        </p>
       </td>
       <td style="background-color:#ffffff; height:14.1500pt; width:254.4000pt">
        <p style="margin-left:0; margin-right:0; text-align:center">
         <span style="color:#000000">
          -
         </span>
        </p>
       </td>
      </tr>
      <tr>
       <td style="background-color:#ffffff; height:14.1500pt; width:146.7000pt">
        <p style="margin-left:.0001pt; margin-right:0; text-align:center">
         <span style="background-color:#ffffff">
          <span style="color:#000000">
           处理器
          </span>
         </span>
        </p>
       </td>
       <td style="background-color:#ffffff; height:14.1500pt; width:254.4000pt">
        <p style="margin-left:0; margin-right:0; text-align:center">
         <span style="color:#000000">
          鲲鹏920
         </span>
        </p>
       </td>
      </tr>
      <tr>
       <td style="background-color:#ffffff; height:14.1500pt; width:146.7000pt">
        <p style="margin-left:.0001pt; margin-right:0; text-align:center">
         <span style="background-color:#ffffff">
          <span style="color:#000000">
           内存
          </span>
         </span>
        </p>
       </td>
       <td style="background-color:#ffffff; height:14.1500pt; width:254.4000pt">
        <p style="margin-left:.0001pt; margin-right:0; text-align:center">
         <span style="color:#000000">
          DDR4
         </span>
        </p>
       </td>
      </tr>
      <tr>
       <td style="background-color:#ffffff; height:14.1500pt; width:146.7000pt">
        <p style="margin-left:.0001pt; margin-right:0; text-align:center">
         <span style="background-color:#ffffff">
          <span style="color:#000000">
           整机类型/架构
          </span>
         </span>
        </p>
       </td>
       <td style="background-color:#ffffff; height:14.1500pt; width:254.4000pt">
        <p style="margin-left:.0001pt; margin-right:0; text-align:center">
         <span style="color:#000000">
          arm
         </span>
        </p>
       </td>
      </tr>
      <tr>
       <td rowspan="2" style="background-color:#f1f1f1; height:14.1500pt; width:77.0000pt">
        <p style="margin-left:.0001pt; margin-right:0; text-align:center">
         <strong>
          <span style="color:#000000">
           软件环境
          </span>
         </strong>
        </p>
       </td>
       <td style="background-color:#ffffff; height:14.1500pt; width:146.7000pt">
        <p style="margin-left:.0001pt; margin-right:0; text-align:center">
         <span style="background-color:#ffffff">
          <span style="color:#000000">
           具体操作系统版本
          </span>
         </span>
        </p>
       </td>
       <td style="background-color:#ffffff; height:14.1500pt; width:254.4000pt">
        <p style="margin-left:.0001pt; margin-right:0; text-align:center">
         <span style="color:#000000">
          银河麒麟高级服务器操作系统 V10SP2
         </span>
        </p>
       </td>
      </tr>
      <tr>
       <td style="background-color:#ffffff; height:14.1500pt; width:146.7000pt">
        <p style="margin-left:.0001pt; margin-right:0; text-align:center">
         <span style="background-color:#ffffff">
          <span style="color:#000000">
           内核版本
          </span>
         </span>
        </p>
       </td>
       <td style="background-color:#ffffff; height:14.1500pt; width:254.4000pt">
        <p style="margin-left:.0001pt; margin-right:0; text-align:center">
         <span style="color:#000000">
          4.19.90-24.4.v2101.ky10.aarch64
         </span>
        </p>
       </td>
      </tr>
     </tbody>
    </table>
    <h3 style="text-align:left">
     <strong>
      <strong>
       <strong>
        现象描述
       </strong>
      </strong>
     </strong>
    </h3>
    <p style="text-align:left">
     <span style="color:#000000">
      银河麒麟高级服务器操作系统
     </span>
     V10SP2系统，使用kvm运行虚拟机，如果是物理机两个网口做成一个team，然后team接网桥，虚拟机再通过这个网桥连接网络，这种方式网络会有问题。
    </p>
    <p style="margin-left:21.0000pt; text-align:left">
    </p>
    <p style="margin-left:21.0000pt; text-align:left">
     本地环境验证，使用配置方式一直有问题，采用nmcli如下配置：
    </p>
    <p style="margin-left:21.0000pt; text-align:left">
     物理机：
    </p>
    <p style="margin-left:21.0000pt; text-align:left">
     1、创建team及slave
    </p>
    <p style="margin-left:21.0000pt; text-align:left">
     # nmcli connection add type team con-name team1 ifname team1 config '{"runner": {"name": "roundrobin"}, "link_watch": {"name": "ethtool"}}'
    </p>
    <p style="margin-left:21.0000pt; text-align:left">
     # nmcli connection add type team-slave con-name team1-port1 ifname ens224 master team1
    </p>
    <p style="margin-left:21.0000pt; text-align:left">
     # nmcli connection add type team-slave con-name team1-port2 ifname ens256 master team1
    </p>
    <p style="margin-left:21.0000pt; text-align:left">
     2、创建网桥
    </p>
    <p style="margin-left:21.0000pt; text-align:left">
     # mcli connection add type bridge con-name br1 ifname br1
    </p>
    <p style="margin-left:21.0000pt; text-align:left">
     配置网桥IP
    </p>
    <p style="margin-left:21.0000pt; text-align:left">
     3、添加team1到br1
    </p>
    <p style="margin-left:21.0000pt; text-align:left">
     # nmcli c mod team1 master br1
    </p>
    <p style="margin-left:21.0000pt; text-align:left">
     4、激活网络
    </p>
    <p style="margin-left:21.0000pt; text-align:left">
     # nmcli connection up team1
    </p>
    <p style="margin-left:21.0000pt; text-align:left">
     # nmcli connection up team1-port1
    </p>
    <p style="margin-left:21.0000pt; text-align:left">
     # nmcli connection up team1-port2
    </p>
    <p style="margin-left:21.0000pt; text-align:left">
     # nmcli connection up br1
    </p>
    <p style="text-align:left">
    </p>
    <p style="text-align:left">
     <strong>
      虚拟机连接br1
     </strong>
    </p>
    <p style="margin-left:21.0000pt; text-align:left">
     图形化操作
    </p>
    <p style="margin-left:21.0000pt; text-align:left">
     实际测试下来，确实会发现网络不通，此时如把team1从网桥删掉，换成物理网口，网络就可以正常使用，单独配置team，也可以正常使用。
    </p>
    <p style="text-align:left">
    </p>
    <h3 style="text-align:left">
     <strong>
      <strong>
       <strong>
        现象分析
       </strong>
      </strong>
     </strong>
    </h3>
    <ol>
     <li style="text-align:left">
      针对该问题，做了以下测试。
     </li>
     <li style="text-align:left">
      启动虚拟机1，在宿主机上tcpdump分别在team1-slave1，team1-slave2，vnet0三个口抓icmp报文，虚拟机1里启动ping 网关ip，发现team1-slave1、team2-slave2几乎同时收到arp reply报文，但是vnet0没有收到该报文，只有arp request报文，所以虚拟机网络一直不正常。
     </li>
     <li style="text-align:left">
      在宿主机做ifconfig team1-slave1 down，虚拟机网络恢复正常。
     </li>
     <li style="text-align:left">
      在宿主机做ifconfig team1-slave1 up，虚拟机网络异常。
     </li>
     <li style="text-align:left">
      在宿主机做ifconfig team1-slave2 down，虚拟机网络正常。
     </li>
     <li style="text-align:left">
      <span style="color:#c00000">
       宿主机把team1从网桥踢出，将一物理网卡加入网桥，虚拟机网络正常。
      </span>
     </li>
    </ol>
    <h3 style="margin-left:0.0001pt; margin-right:0px; text-align:left">
    </h3>
    <h3 style="margin-left:0.0001pt; margin-right:0px; text-align:left">
     <strong>
      分析总结
     </strong>
    </h3>
    <p style="margin-left:21.0000pt; text-align:left">
     根据上述分析结果，梳理网络拓扑，本地搭建环境复现问题，发现Linux bridge的fdb表存在问题：
    </p>
    <p>
     <img alt="" height="122" src="https://i-blog.csdnimg.cn/direct/e6b01ea4d6824df08ba56f4909e43296.png" width="1280"/>
    </p>
    <p style="margin-left:21.0000pt; text-align:center">
     图1 虚拟机mac地址
    </p>
    <p>
     <img alt="" height="711" src="https://i-blog.csdnimg.cn/direct/af8bd35a22a049478340b28cf788c4ac.png" width="1280"/>
    </p>
    <p style="margin-left:21.0000pt; text-align:center">
     图二 宿主机mac地址
    </p>
    <p style="margin-left:21.0000pt; text-align:center">
    </p>
    <p>
     <img alt="" height="403" src="https://i-blog.csdnimg.cn/direct/056325efcf1d4612afe807f0d9f22f2e.png" width="1280"/>
    </p>
    <p style="margin-left:21.0000pt; text-align:center">
     图三 网桥fdb表
    </p>
    <p style="margin-left:21.0000pt; text-align:left">
     由图三可见，虚拟机的mac地址，应与vnet0同属同一port，但实际却与team网卡同属同一port。故报文在二层即无法到达vnet0，符合上节的抓包现象。
    </p>
    <p style="margin-left:21.0000pt; text-align:left">
     进一步分析fdb表为何不对，梳理网络拓扑及报文路径：
    </p>
    <p>
     <img alt="" height="720" src="https://i-blog.csdnimg.cn/direct/95dbeea7af6c465b89f05e06c7341652.png" width="739"/>
    </p>
    <p style="text-align:left">
     <br/>
     由此可知，由于使用team0（roundrobin ）模式，虚拟机arp广播报文，经vnet0进入网桥，此时网桥mac学习到虚拟机的mac地址对应vnet0的port，此时fdb表是正确的。arp广播报文通过team网卡发出，由于是轮询模式，此时两个物理网卡均会发送arp广播报文。交换机收到物理网卡的广播报文后，会向所有端口进行转发，此时也会转发到team的另一slave网卡。此时网桥会收到该arp广播报文，并进行mac地址学习，记录虚拟机的mac地址对应team的port，此后fdb表便一直为错误的，后续报文均不通。
    </p>
    <h3 style="text-align:left">
     <strong>
      <strong>
       <strong>
        分析结果
       </strong>
      </strong>
     </strong>
    </h3>
    <p style="margin-left:21.0000pt; text-align:left">
     通过上述分析，需要限制交换机将广播报文发回聚合端口，当服务器设置为mode0时，交换机需要设置为手动聚合模式。
    </p>
    <p style="margin-left:0.0000pt; text-align:left">
    </p>
    <h3 style="text-align:left">
     <strong>
      <strong>
       <strong>
        后续计划与建议
       </strong>
      </strong>
     </strong>
    </h3>
    <p style="margin-left:.0001pt; margin-right:0; text-align:left">
     如果使用mode0模式需要配置交换机为手动聚合模式，或者设置Linux网桥强制泛洪；如果使用mode1模式，交换机侧无需任何修改。
    </p>
   </div>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f:672e6373646e2e6e65742f323330315f37373232333435312f:61727469636c652f64657461696c732f313436303938393233" class_="artid" style="display:none">
 </p>
</div>


