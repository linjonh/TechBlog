---
layout: post
title: "å¯¹WebSocketåšä¸€ç‚¹ç®€å•çš„ç†è§£"
date: 2025-03-06 19:36:47 +0800
description: "WebSocket æ˜¯åŸºäº TCP çš„ä¸€ç§æ–°çš„ã€‚å®ƒå®ç°äº†æµè§ˆå™¨ä¸æœåŠ¡å™¨å…¨åŒå·¥é€šä¿¡â€”â€”æµè§ˆå™¨å’ŒæœåŠ¡å™¨åªéœ€è¦å®Œæˆä¸€æ¬¡æ¡æ‰‹ï¼Œä¸¤è€…ä¹‹é—´å°±å¯ä»¥åˆ›å»ºçš„è¿æ¥ï¼Œ å¹¶è¿›è¡Œæ•°æ®ä¼ è¾“ã€‚HTTPæ˜¯WebSocketæ˜¯HTTPé€šä¿¡æ˜¯çš„ï¼ŒåŸºäºè¯·æ±‚å“åº”æ¨¡å¼WebSocketæ”¯æŒé€šä¿¡HTTPå’ŒWebSocketåº•å±‚éƒ½æ˜¯TCPè¿æ¥æœåŠ¡å™¨é•¿æœŸç»´æŠ¤é•¿è¿æ¥éœ€è¦ä¸€å®šçš„æˆæœ¬ å„ä¸ªæµè§ˆå™¨æ”¯æŒç¨‹åº¦ä¸ä¸€ WebSocket æ˜¯é•¿è¿æ¥ï¼Œå—ç½‘ç»œé™åˆ¶æ¯”è¾ƒå¤§ï¼Œéœ€è¦å¤„ç†å¥½é‡è¿WebSocketå¹¶ä¸èƒ½å®Œå…¨å–ä»£HTTPï¼Œå®ƒåªé€‚åˆåœ¨ç‰¹å®šçš„åœºæ™¯ä¸‹ä½¿ç”¨ã€‚"
keywords: "å¯¹WebSocketåšä¸€ç‚¹ç®€å•çš„ç†è§£"
categories: ['æœªåˆ†ç±»']
tags: ['ç½‘ç»œåè®®', 'ç½‘ç»œ', 'Websocket']
artid: "146055282"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146055282
    alt: "å¯¹WebSocketåšä¸€ç‚¹ç®€å•çš„ç†è§£"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146055282
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146055282
cover: https://bing.ee123.net/img/rand?artid=146055282
image: https://bing.ee123.net/img/rand?artid=146055282
img: https://bing.ee123.net/img/rand?artid=146055282
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     å¯¹WebSocketåšä¸€ç‚¹ç®€å•çš„ç†è§£
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <h2>
     1.æ¦‚å¿µ
    </h2>
    <p>
     WebSocket æ˜¯åŸºäº TCP çš„ä¸€ç§æ–°çš„
     <strong>
      ç½‘ç»œåè®®
     </strong>
     ã€‚å®ƒå®ç°äº†æµè§ˆå™¨ä¸æœåŠ¡å™¨å…¨åŒå·¥é€šä¿¡â€”â€”æµè§ˆå™¨å’ŒæœåŠ¡å™¨åªéœ€è¦å®Œæˆä¸€æ¬¡æ¡æ‰‹ï¼Œä¸¤è€…ä¹‹é—´å°±å¯ä»¥åˆ›å»º
     <strong>
      æŒä¹…æ€§
     </strong>
     çš„è¿æ¥ï¼Œ å¹¶è¿›è¡Œ
     <strong>
      åŒå‘
     </strong>
     æ•°æ®ä¼ è¾“ã€‚
    </p>
    <p>
     <strong>
      HTTPåè®®å’ŒWebSocketåè®®å¯¹æ¯”ï¼š
     </strong>
    </p>
    <ul>
     <li>
      <p>
       HTTPæ˜¯
       <strong>
        çŸ­è¿æ¥
       </strong>
      </p>
     </li>
     <li>
      <p>
       WebSocketæ˜¯
       <strong>
        é•¿è¿æ¥
       </strong>
      </p>
     </li>
     <li>
      <p>
       HTTPé€šä¿¡æ˜¯
       <strong>
        å•å‘
       </strong>
       çš„ï¼ŒåŸºäºè¯·æ±‚å“åº”æ¨¡å¼
      </p>
     </li>
     <li>
      <p>
       WebSocketæ”¯æŒ
       <strong>
        åŒå‘
       </strong>
       é€šä¿¡
      </p>
     </li>
     <li>
      <p>
       HTTPå’ŒWebSocketåº•å±‚éƒ½æ˜¯TCPè¿æ¥
       <img alt="" height="392" src="https://i-blog.csdnimg.cn/direct/a32707df05d04884940fd2879dfd72ce.png" width="658"/>
      </p>
     </li>
     <li>
      <p>
       <strong>
        WebSocketç¼ºç‚¹ï¼š
       </strong>
      </p>
      <p>
       æœåŠ¡å™¨é•¿æœŸç»´æŠ¤é•¿è¿æ¥éœ€è¦ä¸€å®šçš„æˆæœ¬ å„ä¸ªæµè§ˆå™¨æ”¯æŒç¨‹åº¦ä¸ä¸€ WebSocket æ˜¯é•¿è¿æ¥ï¼Œå—ç½‘ç»œé™åˆ¶æ¯”è¾ƒå¤§ï¼Œéœ€è¦å¤„ç†å¥½é‡è¿
      </p>
      <p>
       <strong>
        ç»“è®ºï¼š
       </strong>
       WebSocketå¹¶ä¸èƒ½å®Œå…¨å–ä»£HTTPï¼Œå®ƒåªé€‚åˆåœ¨ç‰¹å®šçš„åœºæ™¯ä¸‹ä½¿ç”¨
      </p>
      WebSocketçš„ä½¿ç”¨åœºæ™¯ï¼šè§†é¢‘å¼¹å¹•ï¼Œç½‘é¡µèŠå¤©ï¼Œè‚¡ç¥¨åŸºé‡‘æŠ¥ä»·å®æ—¶æ›´æ–°ï¼Œ ä½“è‚²å®å†µæ›´æ–°
     </li>
    </ul>
    <h2>
     2.ç¤ºä¾‹
    </h2>
    <h3>
     2.1 åŸºç¡€é…ç½®
    </h3>
    <p>
     å¯¼å…¥Mavenåæ ‡
    </p>
    <blockquote>
     <pre>&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-websocket&lt;/artifactId&gt;
&lt;/dependency&gt;</pre>
    </blockquote>
    <blockquote>
     <pre>/**
 * WebSocketé…ç½®ç±»ï¼Œç”¨äºæ³¨å†ŒWebSocketçš„Bean
 * @Author GuihaoLv
 */
@Configuration
public class WebSocketConfig {
</pre>
     <pre>/**
 * åˆ›å»ºå¹¶è¿”å›ä¸€ä¸ª ServerEndpointExporter å®ä¾‹ã€‚
 *
 * ServerEndpointExporter æ˜¯ Spring æä¾›çš„ä¸€ä¸ªå·¥å…·ç±»ï¼Œç”¨äºè‡ªåŠ¨æ³¨å†Œä½¿ç”¨äº† @ServerEndpoint æ³¨è§£çš„ WebSocket ç«¯ç‚¹ã€‚
 * è¿™æ ·å¯ä»¥é¿å…æ‰‹åŠ¨æ³¨å†Œæ¯ä¸ª WebSocket ç«¯ç‚¹ã€‚
 *
 * @return ServerEndpointExporter å®ä¾‹
 */
    @Bean
    public ServerEndpointExporter serverEndpointExporter() {
        return new ServerEndpointExporter();
    }

}
</pre>
    </blockquote>
    <pre>WebSocketæœåŠ¡å™¨ç«¯ç»„ä»¶ï¼š</pre>
    <blockquote>
     <pre>import org.springframework.stereotype.Component;
import com.alibaba.fastjson.JSON;
import com.alibaba.fastjson.JSONObject;
import javax.websocket.*;
import javax.websocket.server.PathParam;
import javax.websocket.server.ServerEndpoint;
import java.io.IOException;
import java.util.Collection;
import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.CopyOnWriteArraySet;

/**
* WebSocketæœåŠ¡å™¨ç«¯ç»„ä»¶
* @Author GuihaoLv
*/
@Component
//æ ‡è®°è¿™ä¸ªç±»æ˜¯ä¸€ä¸ªWebSocketç«¯ç‚¹ï¼Œå¯ä»¥æ¥æ”¶æ¥è‡ªå®¢æˆ·ç«¯çš„WebSocketè¿æ¥è¯·æ±‚ã€‚/ws/{sid}è¡¨ç¤ºWebSocketçš„URLè·¯å¾„æ¨¡å¼ï¼Œå…¶ä¸­{sid}æ˜¯è·¯å¾„å‚æ•°ï¼Œä»£è¡¨ä¼šè¯IDï¼ˆSession IDï¼‰ã€‚
@ServerEndpoint("/ws/{userId}")
public class WebSocketServer {
    //è¿™é‡Œå£°æ˜äº†ä¸€ä¸ªé™æ€çš„Mapï¼Œç”¨æ¥å­˜å‚¨æ¯ä¸ªè¿æ¥çš„Sessionå¯¹è±¡ï¼Œé”®æ˜¯sidï¼Œå€¼æ˜¯å¯¹åº”çš„Sessionã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼ŒæœåŠ¡å™¨å¯ä»¥è¿½è¸ªæ¯ä¸€ä¸ªè¿æ¥çš„å®¢æˆ·ç«¯ã€‚
    private static Map&lt;String, Session&gt; sessionMap = new ConcurrentHashMap();
    //ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„é›†åˆï¼Œç”¨æ¥å­˜å‚¨æ‰€æœ‰æ´»åŠ¨çš„WebSocketServerå®ä¾‹ã€‚
    public static CopyOnWriteArraySet&lt;WebSocketServer&gt; webSockets = new CopyOnWriteArraySet&lt;&gt;();

    //@OnOpenï¼šå½“ä¸€ä¸ªæ–°çš„WebSocketè¿æ¥æˆåŠŸå»ºç«‹æ—¶ï¼Œæ­¤æ–¹æ³•ä¼šè¢«è°ƒç”¨ã€‚
    @OnOpen
    public void onOpen(Session session, @PathParam("userId") String userId) {
        System.out.println("å®¢æˆ·ç«¯ï¼š" + userId + "å»ºç«‹è¿æ¥");
        webSockets.add(this);
        sessionMap.put(userId, session);//æŠŠæ–°çš„Sessionå¯¹è±¡å­˜å…¥sessionMapä¸­ã€‚
    }


    //æ¯å½“ä»å®¢æˆ·ç«¯æ¥æ”¶åˆ°æ¶ˆæ¯æ—¶ï¼Œè¯¥æ–¹æ³•å°±ä¼šè§¦å‘ã€‚è¿™é‡Œåªæ˜¯ç®€å•åœ°æ‰“å°å‡ºæ”¶åˆ°çš„æ¶ˆæ¯ã€‚
    @OnMessage
   public void onMessage(String message, @PathParam("userId") String userId) {
       System.out.println("æ”¶åˆ°æ¥è‡ªå®¢æˆ·ç«¯ï¼š" + userId + "çš„ä¿¡æ¯:" + message);
    }
 



    //å½“ä¸€ä¸ªWebSocketè¿æ¥å…³é—­æ—¶ï¼Œæ­¤æ–¹æ³•ä¼šè¢«è°ƒç”¨ã€‚å®ƒä¼šä»sessionMapä¸­ç§»é™¤ç›¸åº”çš„Sessionå¯¹è±¡ï¼Œå¹¶è¾“å‡ºä¸€æ¡æ—¥å¿—ä¿¡æ¯ã€‚
    @OnClose
    public void onClose(@PathParam("userId") String userId) {
        System.out.println("è¿æ¥æ–­å¼€:" + userId);
        webSockets.remove(this);
        sessionMap.remove(userId);
    }

    //éå†æ‰€æœ‰ç°å­˜çš„Sessionå¯¹è±¡ï¼Œå¹¶å°è¯•å‘æ¯ä¸ªå®¢æˆ·ç«¯å‘é€æ–‡æœ¬æ¶ˆæ¯ã€‚å¦‚æœå‘é€è¿‡ç¨‹ä¸­é‡åˆ°ä»»ä½•å¼‚å¸¸ï¼Œå°±æ•è·å¼‚å¸¸å¹¶æ‰“å°å †æ ˆè·Ÿè¸ªä¿¡æ¯ã€‚
    public void sendToAllClient(String message) {
        Collection&lt;Session&gt; sessions = sessionMap.values();
        for (Session session : sessions) {
            try {
                session.getBasicRemote().sendText(message);
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }
     /**
     * å‘ç”Ÿé”™è¯¯æ—¶è°ƒç”¨
     */
    @OnError
    public void onError(Session session, Throwable error) {
        System.err.println("WebSocket å‘ç”Ÿé”™è¯¯: " + error.getMessage());
        error.printStackTrace();
    }
}</pre>
    </blockquote>
    <p>
     å‰ç«¯å·¥å…·ç±»ï¼š
    </p>
    <blockquote>
     <pre>const url = "ws://127.0.0.1:8080/ws/{userId}"; // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦æ›¿æ¢ {userId} ä¸ºå®é™…çš„ç”¨æˆ·ID
//å®šä¹‰äº† WebSocket å·¥å…·ç±»çš„ç»“æ„å’Œæ–¹æ³•ç­¾åã€‚
interface Socket {
  websocket: WebSocket | null;  // WebSocket è¿æ¥å®ä¾‹
  init: (userId: string) =&gt; void; // éœ€è¦ä¼ å…¥ userId åˆå§‹åŒ–è¿æ¥
  send: (data: object) =&gt; void;   // å‘é€æ•°æ®çš„æ–¹æ³•
  onMessage: (callback: (msg) =&gt; void) =&gt; void; // æ¶ˆæ¯ç›‘å¬å›è°ƒ
  onClose: (callback: () =&gt; void) =&gt; void; // å…³é—­å›è°ƒ
  onError: (callback: (error: Event) =&gt; void) =&gt; void; // é”™è¯¯å›è°ƒ
  onMessageCallback: ((msg) =&gt; void) | null; // å­˜å‚¨æ¶ˆæ¯å›è°ƒ
  onCloseCallback: (() =&gt; void) | null; // å­˜å‚¨å…³é—­å›è°ƒ
  onErrorCallback: ((error: Event) =&gt; void) | null; // å­˜å‚¨é”™è¯¯å›è°ƒ
}

const socket: Socket = {
  websocket: null,
  //ç”¨æ¥å­˜å‚¨äº‹ä»¶å›è°ƒå‡½æ•°ã€‚
  onMessageCallback: null,
  onCloseCallback: null,
  onErrorCallback: null,

  init: (userId: string) =&gt; {
    const fullUrl = url.replace("{userId}", userId); // åŠ¨æ€æ›¿æ¢ userId
    if (socket.websocket) return; // é¿å…é‡å¤è¿æ¥

    socket.websocket = new WebSocket(fullUrl);

    /**
     * å½“æ”¶åˆ°æ¶ˆæ¯æ—¶è°ƒç”¨è¯¥å›è°ƒå‡½æ•°ã€‚
     */
    socket.websocket.onopen = () =&gt; {
      console.log("WebSocket è¿æ¥æˆåŠŸ");
    };

    /**
     * å½“ WebSocket è¿æ¥å…³é—­æ—¶è°ƒç”¨è¯¥å›è°ƒå‡½æ•°ã€‚
     * @param e
     */
    socket.websocket.onclose = (e) =&gt; {
      console.log("WebSocket è¿æ¥å…³é—­", e);
      socket.websocket = null; // è¿æ¥å…³é—­åé‡ç½® WebSocket
      if (socket.onCloseCallback) {
        socket.onCloseCallback();
      }
    };

     /**
     * å½“ WebSocket å‘ç”Ÿé”™è¯¯æ—¶è°ƒç”¨è¯¥å›è°ƒå‡½æ•°ã€‚
     * @param e
     */
    socket.websocket.onerror = (e) =&gt; {
      console.error("WebSocket é”™è¯¯", e);
      if (socket.onErrorCallback) {
        socket.onErrorCallback(e);
      }
    };

    //æ”¶åˆ° WebSocket æ¶ˆæ¯ æ—¶æ‰§è¡Œï¼š
    // event.data æ˜¯æ¥æ”¶åˆ°çš„å­—ç¬¦ä¸²ï¼Œå…ˆ JSON.parse() è§£ææˆå¯¹è±¡ã€‚
    // è°ƒç”¨ onMessageCallback å›è°ƒï¼Œå¦‚æœå¤–éƒ¨ç›‘å¬äº†æ¶ˆæ¯ã€‚
    socket.websocket.onmessage = (event) =&gt; {
      try {
        const message = JSON.parse(event.data);
        console.log("ğŸ“© æ”¶åˆ° WebSocket æ¶ˆæ¯:", message);
        if (socket.onMessageCallback) {
          socket.onMessageCallback(message);
        }
      } catch (error) {
        console.error("è§£ææ¶ˆæ¯å¤±è´¥:", error);
      }
    };
  },

  //æ¶ˆæ¯å‘é€ (send æ–¹æ³•)
  send: (data: object) =&gt; {
    if (socket.websocket &amp;&amp; socket.websocket.readyState === WebSocket.OPEN) {
      socket.websocket.send(JSON.stringify(data));
    } else {
      console.log("WebSocket æœªè¿æ¥ï¼Œå°è¯•é‡è¿");
      setTimeout(() =&gt; socket.send(data), 1000); // å°è¯•é‡æ–°å‘é€æ¶ˆæ¯
    }
  },

  //ç›‘å¬æ¶ˆæ¯ï¼ŒonMessageCallback å­˜å‚¨æ¶ˆæ¯å›è°ƒå‡½æ•°ï¼Œæ”¶åˆ°æ¶ˆæ¯æ—¶è§¦å‘ã€‚
  onMessage: (callback: (msg) =&gt; void) =&gt; {
    socket.onMessageCallback = callback;
  },

  //ç›‘å¬å…³é—­ï¼ŒonCloseCallback å­˜å‚¨å…³é—­å›è°ƒå‡½æ•°ï¼Œè¿æ¥å…³é—­æ—¶è§¦å‘ã€‚
  onClose: (callback: () =&gt; void) =&gt; {
    socket.onCloseCallback = callback;
  },

  //ç›‘å¬é”™è¯¯ï¼ŒonErrorCallback å­˜å‚¨é”™è¯¯å›è°ƒå‡½æ•°ï¼Œè¿æ¥é”™è¯¯æ—¶è§¦å‘ã€‚
  onError: (callback: (error: Event) =&gt; void) =&gt; {
    socket.onErrorCallback = callback;
  },
};

export default socket;
</pre>
    </blockquote>
    <h3>
     2.2 å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯äº¤äº’ç¤ºä¾‹
    </h3>
    <p>
     æœåŠ¡ç«¯æ¥æ”¶æ¶ˆæ¯çš„æ–¹æ³•ï¼š
    </p>
    <blockquote>
     <pre>@OnMessage
public void onMessage(String message, @PathParam("userId") String userId) {
    System.out.println("æ”¶åˆ°æ¥è‡ªå®¢æˆ·ç«¯ï¼š" + userId + "çš„ä¿¡æ¯:" + message);
}
</pre>
    </blockquote>
    <p>
     å®¢æˆ·ç«¯æµ‹è¯•é¡µé¢ï¼š
    </p>
    <blockquote>
     <pre>&lt;script setup lang="ts"&gt;
import socket from '@/utils/webSocket0.ts';
import {ref} from "vue"; // å¼•å…¥ WebSocket å·¥å…·ç±»

const userId = ref('');

function connect() {
  if (!userId.value) {
    alert('Please enter a User ID');
    return;
  }

  //åˆå§‹åŒ– WebSocket è¿æ¥ï¼Œä¼ å…¥ç”¨æˆ·IDä½œä¸ºå‚æ•°ã€‚
  socket.init(userId.value);

  socket.onMessage((message) =&gt; {
    console.log('æ”¶åˆ°æ¶ˆæ¯:', message);
    appendMessage(`æ”¶åˆ°æ¶ˆæ¯: ${JSON.stringify(message)}`);
  });

  socket.onClose(() =&gt; {
    console.log('WebSocket è¿æ¥å·²å…³é—­');
    appendMessage('WebSocket è¿æ¥å·²å…³é—­');
  });

  socket.onError((error) =&gt; {
    console.error('WebSocket é”™è¯¯:', error);
    appendMessage('WebSocket é”™è¯¯');
  });
}

//é€ ä¸€æ¡ç±»å‹ä¸º 'chat' çš„æ¶ˆæ¯ï¼Œå†…å®¹ä¸º 'Hello, Server!'ã€‚
//ä½¿ç”¨ socket.send(message); å‘é€æ¶ˆæ¯åˆ°æœåŠ¡å™¨ã€‚
//é€šè¿‡ appendMessage å‡½æ•°åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºå·²å‘é€çš„æ¶ˆæ¯å†…å®¹ã€‚
function sendMessage() {
  const message = { type: 'chat', content: 'Hello, Server!' };
  socket.send(message);
  appendMessage(`å‘é€æ¶ˆæ¯: ${JSON.stringify(message)}`);
}

//æ£€æŸ¥ socket.websocket æ˜¯å¦å­˜åœ¨ï¼ˆå³ WebSocket è¿æ¥æ˜¯å¦å·²ç»å»ºç«‹ï¼‰ã€‚
//å¦‚æœå­˜åœ¨ï¼Œåˆ™è°ƒç”¨ close() æ–¹æ³•å…³é—­è¿æ¥ã€‚
function disconnect() {
  if (socket.websocket) {
    socket.websocket.close();
  }
}

//è·å–é¡µé¢ä¸Š ID ä¸º messages çš„ div å…ƒç´ ã€‚
//åˆ›å»ºä¸€ä¸ªæ–°çš„ div å…ƒç´ ï¼Œè®¾ç½®å…¶æ–‡æœ¬å†…å®¹ä¸ºä¼ å…¥çš„æ¶ˆæ¯ï¼Œå¹¶å°†å…¶è¿½åŠ åˆ° messagesDiv ä¸­
function appendMessage(message: string) {
  const messagesDiv = document.getElementById('messages');
  if (messagesDiv) {
    const messageElement = document.createElement('div');
    messageElement.textContent = message;
    messagesDiv.appendChild(messageElement);
  }
}
&lt;/script&gt;

&lt;template&gt;
  &lt;div&gt;
    &lt;h1&gt;WebSocket Client Simulation&lt;/h1&gt;
    &lt;input v-model="userId" type="text" placeholder="Enter User ID"/&gt;
    &lt;button @click="connect"&gt;Connect&lt;/button&gt;
    &lt;button @click="sendMessage"&gt;Send Message&lt;/button&gt;
    &lt;button @click="disconnect"&gt;Disconnect&lt;/button&gt;
    &lt;div id="messages"&gt;&lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;style scoped&gt;
/* æ ·å¼å¯ä»¥æ ¹æ®éœ€è¦è¿›è¡Œè°ƒæ•´ */
input {
  margin-right: 10px;
}

button {
  margin-right: 10px;
}

#messages {
  margin-top: 20px;
  border: 1px solid #ccc;
  padding: 10px;
  width: 300px;
  height: 200px;
  overflow-y: scroll;
}
&lt;/style&gt;</pre>
    </blockquote>
    <p>
     é¡µé¢åŸå‹ï¼š
    </p>
    <p>
     <img alt="" height="602" src="https://i-blog.csdnimg.cn/direct/136890b805df4167a78a0d527fc6dd3d.png" width="837"/>
    </p>
    <p>
     è¿æ¥å®¢æˆ·ç«¯ï¼š
    </p>
    <p>
     <img alt="" height="181" src="https://i-blog.csdnimg.cn/direct/11c58cf3451448aebc04338aa7e90e63.png" width="484"/>
    </p>
    <p>
    </p>
    <p>
     å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘é€æ¶ˆæ¯ï¼š
    </p>
    <p>
     <img alt="" height="392" src="https://i-blog.csdnimg.cn/direct/e3fd5b7d0ef14e738aadf1b82f57d0c1.png" width="689"/>
    </p>
    <p>
     æ–­å¼€è¿æ¥ï¼š
     <img alt="" height="258" src="https://i-blog.csdnimg.cn/direct/cb5d316566f84bcb865096a5b767a063.png" width="930"/>
    </p>
    <h3 style="background-color:transparent">
     2.3 å®¢æˆ·ç«¯ä¸å®¢æˆ·ç«¯çš„äº¤äº’ç›‘å¬
    </h3>
    <p>
     æœåŠ¡ç«¯æ¥æ”¶æ¶ˆæ¯å¤„ç†ï¼š
    </p>
    <blockquote>
     <pre>@OnMessage
public void onMessage(String message, @PathParam("userId") String userId) {
    System.out.println("æ”¶åˆ°æ¥è‡ªå®¢æˆ·ç«¯ï¼š" + userId + "çš„ä¿¡æ¯:" + message);
    try {
        // ä½¿ç”¨ FastJSON è§£æ JSON å­—ç¬¦ä¸²
        JSONObject jsonMessage = JSON.parseObject(message);
        String toUserId = jsonMessage.getString("toUserId");

        // è·å–ç›®æ ‡ç”¨æˆ·çš„ä¼šè¯
        Session targetSession = sessionMap.get(toUserId);

        if (targetSession != null &amp;&amp; targetSession.isOpen()) {
            System.out.println("æ­£åœ¨å‘ç”¨æˆ·ï¼š" + toUserId + "å‘é€æ¶ˆæ¯");
            // å°†æ¶ˆæ¯è½¬å‘ç»™ç›®æ ‡ç”¨æˆ·
            targetSession.getBasicRemote().sendText(jsonMessage.toJSONString());
        } else {
            System.out.println("æ— æ³•æ‰¾åˆ°ç›®æ ‡ç”¨æˆ·æˆ–è¿æ¥å·²å…³é—­ï¼š" + toUserId);
        }
    } catch (Exception e) {
        e.printStackTrace();
    }
}</pre>
    </blockquote>
    <p>
     ç”¨æˆ·Aï¼š
    </p>
    <blockquote>
     <pre>&lt;template&gt;
  &lt;div&gt;
    &lt;h1&gt;ç”¨æˆ·A&lt;/h1&gt;
    &lt;input v-model="message" placeholder="è¾“å…¥æ¶ˆæ¯" /&gt;
    &lt;button @click="sendMessage"&gt;å‘é€æ¶ˆæ¯&lt;/button&gt;
    &lt;div id="messages"&gt;
      &lt;div v-for="(msg, index) in messages" :key="index"&gt;{<!-- -->{ msg }}&lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
import { ref } from 'vue';
import socket from '@/utils/webSocket0.ts'; // å¼•å…¥ WebSocket å·¥å…·ç±»

const userId = 'userA'; // ç”¨æˆ·Açš„ID
const message = ref('');
const messages = ref&lt;string[]&gt;([]);

socket.init(userId);

socket.onMessage((msg) =&gt; {
  console.log('æ”¶åˆ°æ¶ˆæ¯:', msg);
  appendMessage(`æ”¶åˆ°æ¶ˆæ¯: ${JSON.stringify(msg)}`);
});

socket.onError((error) =&gt; {
  console.error('WebSocket é”™è¯¯:', error);
  appendMessage('WebSocket é”™è¯¯');
});

function sendMessage() {
  const msgContent = { type: 'chat', content: message.value, toUserId: 'userB' };
  socket.send(msgContent);
  appendMessage(`å‘é€æ¶ˆæ¯: ${JSON.stringify(msgContent)}`);
  message.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
}

function appendMessage(messageText: string) {
  messages.value.push(messageText);
}
&lt;/script&gt;

&lt;style scoped&gt;
/* æ ·å¼å¯ä»¥æ ¹æ®éœ€è¦è¿›è¡Œè°ƒæ•´ */
input {
  margin-right: 10px;
}

button {
  margin-right: 10px;
}

#messages {
  margin-top: 20px;
  border: 1px solid #ccc;
  padding: 10px;
  width: 300px;
  height: 200px;
  overflow-y: scroll;
}
&lt;/style&gt;</pre>
    </blockquote>
    <p>
     ç”¨æˆ·Bï¼š
    </p>
    <blockquote>
     <pre>&lt;template&gt;
  &lt;div&gt;
    &lt;h1&gt;ç”¨æˆ·B&lt;/h1&gt;
    &lt;div id="messages"&gt;
      &lt;div v-for="(msg, index) in messages" :key="index"&gt;{<!-- -->{ msg }}&lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
import { ref, onMounted } from 'vue';
import socket from '@/utils/webSocket0.ts'; // å¼•å…¥ WebSocket å·¥å…·ç±»

const userId = 'userB'; // ç”¨æˆ·Bçš„ID
const messages = ref&lt;string[]&gt;([]);

// åˆå§‹åŒ– WebSocket è¿æ¥
function initSocket() {
  socket.init(userId);

  socket.onMessage((msg) =&gt; {
    if (msg.toUserId === userId) {
      console.log('æ”¶åˆ°æ¶ˆæ¯:', msg);
      appendMessage(`æ”¶åˆ°æ¶ˆæ¯: ${JSON.stringify(msg)}`);
    }
  });

  socket.onError((error) =&gt; {
    console.error('WebSocket é”™è¯¯:', error);
    appendMessage('WebSocket é”™è¯¯');
  });
}

// å°†æ–°æ¶ˆæ¯æ·»åŠ åˆ°æ¶ˆæ¯åˆ—è¡¨ä¸­
function appendMessage(messageText: string) {
  messages.value.push(messageText);
}

// åœ¨ç»„ä»¶æŒ‚è½½æ—¶åˆå§‹åŒ– WebSocket
onMounted(() =&gt; {
  initSocket();
});
&lt;/script&gt;

&lt;style scoped&gt;
/* æ ·å¼å¯ä»¥æ ¹æ®éœ€è¦è¿›è¡Œè°ƒæ•´ */
#messages {
  margin-top: 20px;
  border: 1px solid #ccc;
  padding: 10px;
  width: 300px;
  height: 200px;
  overflow-y: scroll;
}
&lt;/style&gt;
</pre>
    </blockquote>
    <p>
     <img alt="" height="542" src="https://i-blog.csdnimg.cn/direct/a29cdf02beb04685b59a7a7159d9912e.png" width="1218"/>
    </p>
    <p>
     ç”¨æˆ·Aå‘æ¶ˆæ¯ç»™ç”¨æˆ·Bï¼š
    </p>
    <p>
     <img alt="" height="461" src="https://i-blog.csdnimg.cn/direct/410b44fab70144ad857ba01db5d3ce7a.png" width="613">
      <img alt="" height="711" src="https://i-blog.csdnimg.cn/direct/fd92eb5fdd0245518ae9a98af63e323a.png" width="1248"/>
      <img alt="" height="192" src="https://i-blog.csdnimg.cn/direct/30ce66c57fb54c8c84326ccf8a6d0d9e.png" width="1030"/>
     </img>
    </p>
    <h3>
     2.4: ä¸€ä¸ªå®é™…çš„æ¶ˆæ¯æ¨é€åœºæ™¯ï¼š
    </h3>
    <p>
     æœåŠ¡ç«¯æ¶ˆæ¯æ¨é€å¤„ç†ï¼š
    </p>
    <blockquote>
     <pre>//å¦‚æœæ˜¯å›å¤è¯„è®º
blogCommentsSaveDto.setAnswerUserId(userMapper.getUserByUsername(blogCommentsSaveDto.getAnswerUserName()));
//å°†å›å¤æ¨é€ç»™æ¥æ”¶è€…
webSocketServer.sendToClient(blogCommentsSaveDto.getAnswerUserId().toString(),getUser().getId().toString(),blogCommentsSaveDto.getContent());</pre>
    </blockquote>
    <p>
    </p>
    <blockquote>
     <pre>/**
 * å‘æŒ‡å®šå®¢æˆ·ç«¯å‘é€æ–‡æœ¬æ¶ˆæ¯
 * @param userId å®¢æˆ·ç«¯çš„ä¼šè¯ID
 * @param message è¦å‘é€çš„æ¶ˆæ¯
 */
public void sendToClient(String userId, String fromId,String message) {
    try {
        // åˆ›å»ºæ ‡å‡†æ¶ˆæ¯ç»“æ„
        JSONObject messageJson = new JSONObject();
        messageJson.put("content", message); // åŸå§‹å†…å®¹æ”¾åœ¨contentå­—æ®µ
        messageJson.put("timestamp", System.currentTimeMillis());
        messageJson.put("status", "success");
        messageJson.put("from",fromId);
        Session session = sessionMap.get(userId);
        if (session != null &amp;&amp; session.isOpen()) {
            // å‘é€åºåˆ—åŒ–çš„JSONå­—ç¬¦ä¸²
            session.getBasicRemote().sendText(messageJson.toJSONString());
        }
    } catch (Exception e) {
       e.printStackTrace();
    }
}</pre>
    </blockquote>
    <p>
     å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯å»ºç«‹è¿æ¥å¹¶ä¸”å®æ—¶ç›‘å¬æ¶ˆæ¯ï¼š
    </p>
    <blockquote>
     <pre>// æ–°å¢å¯¼å…¥
import { onUnmounted } from 'vue'
import socket from '@/utils/webSocket0.ts' // å‡è®¾socketå·¥å…·ç±»è·¯å¾„
import { useUserStore } from '@/stores/userStore.ts'

// æ–°å¢æ¶ˆæ¯é€šçŸ¥çŠ¶æ€
const notifications = ref&lt;string[]&gt;([])
const userStore = useUserStore()

// åˆå§‹åŒ–WebSocket
const initWebSocket = () =&gt; {
  if (!userStore.userInfo?.userId) {
    console.error('ç”¨æˆ·æœªç™»å½•ï¼Œæ— æ³•å»ºç«‹WebSocketè¿æ¥')
    return
  }

  // åˆå§‹åŒ–è¿æ¥
  socket.init(userStore.userInfo.userId.toString())

  // æ¶ˆæ¯ç›‘å¬
  socket.onMessage((msg) =&gt; {
    console.log('æ”¶åˆ°æ–°å›å¤é€šçŸ¥:', msg)
    notifications.value.push(msg.content)

    // è‡ªåŠ¨åˆ·æ–°è¯„è®ºï¼ˆå¸¦1ç§’å»¶è¿Ÿé¿å…è¯·æ±‚å†²çªï¼‰
    setTimeout(loadComments, 1000)
  })

  // é”™è¯¯å¤„ç†
  socket.onError((err) =&gt; {
    console.error('WebSocketé”™è¯¯:', err)
  })
}

// ç»„ä»¶æŒ‚è½½æ—¶
onMounted(() =&gt; {
  loadComments()
  initWebSocket()
})</pre>
    </blockquote>
    <p>
    </p>
    <blockquote>
     <pre>&lt;h1&gt;è¯„è®ºåŒº&lt;/h1&gt;
&lt;!-- åœ¨é¡¶éƒ¨æ·»åŠ é€šçŸ¥æ  --&gt;
&lt;div v-if="notifications.length" class="notifications"&gt;
  &lt;div
    v-for="(msg, index) in notifications"
    :key="index"
    class="notification-item"
  &gt;
    ğŸ†• æ‚¨æ”¶åˆ°æ–°å›å¤ï¼š{<!-- -->{ msg }}
  &lt;/div&gt;
&lt;/div&gt;</pre>
    </blockquote>
    <p>
    </p>
    <p>
     <img alt="" height="250" src="https://i-blog.csdnimg.cn/direct/40bf7a56542c45a098364baea4e4be9a.png" width="918"/>
     <img alt="" height="289" src="https://i-blog.csdnimg.cn/direct/a7dfc1aa95a54d7791fe24d7b33e94fa.png" width="758"/>
    </p>
   </div>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f:672e6373646e2e6e65742f323330335f38303535363731392f:61727469636c652f64657461696c732f313436303535323832" class_="artid" style="display:none">
 </p>
</div>


