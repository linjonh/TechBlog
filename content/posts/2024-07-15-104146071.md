---
layout: post
title: Java-Agent-调试,Java-agent-debug
date: 2024-07-15 03:49:19 +0800
categories: ['Arthas']
tags: ['Javaagent', 'Java', 'Agent']
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=104146071
    alt: Java-Agent-调试,Java-agent-debug
artid: 104146071
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=104146071
featuredImagePreview: https://bing.ee123.net/img/rand?artid=104146071
---
<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Java Agent 调试，Java agent debug
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="./../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="./../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="Java_Agent_agent_debug_0">
     </a>
     Java Agent 调试，agent debug
    </h2>
    <p>
    </p>
    <h3>
     <a id="_3">
     </a>
     一、简介
    </h3>
    <p>
     Java agent 是在另外一个 Java 应用（“目标”应用）启动之前要执行的 Java 程序，这样 agent 就有机会修改目标应用或者应用所运行的环境。修改环境的时候做到对于项目中的代码没有入侵性，不需要修改老项目代码即可实现想要的能力，比如常见的skywoking，就是通过这样的方式实现的。比如这篇文章 通过修改字节码实现Java Agent
     <a href="https://www.infoq.cn/article/Easily-Create-Java-Agents-with-ByteBuddy/" rel="nofollow">
      通过使用 Byte Buddy，便捷地创建 Java Agent
     </a>
     。还有一些功能，比如热更新、arthas 替换class字节码等等。
    </p>
    <p>
    </p>
    <h4>
     <a id="_7">
     </a>
     问题
    </h4>
    <ul>
     <li>
      Java agent的实现原理是什么？
     </li>
     <li>
      Java agent 如何调试呢？习惯了现在的直接代码调试？对于agent 有点慌。
     </li>
    </ul>
    <p>
    </p>
    <h3>
     <a id="_13">
     </a>
     二、原理
    </h3>
    <p>
     Java agent 主要是通过Instrumentation实现的。
     <br/>
    </p>
    <h4>
     <a id="Instrumentation_16">
     </a>
     Instrumentation
    </h4>
    <p>
    </p>
    <h5>
     <a id="_18">
     </a>
     简介
    </h5>
    <p>
     <a href="https://www.cnblogs.com/yelao/p/9841810.html" rel="nofollow">
      java.lang.instrument 做动态 Instrumentation
     </a>
     是 Java SE 5 的新特性，它把 Java 的 instrument 功能从本地代码中解放出来，使之可以用 Java 代码的方式解决问题。使用 Instrumentation，开发者可以构建一个独立于应用程序的代理程序（Agent），用来监测和协助运行在 JVM 上的程序，甚至能够替换和修改某些类的定义。有了这样的功能，开发者就可以实现更为灵活的运行时虚拟机监控和 Java 类操作了，这样的特性实际上提供了一种虚拟机级别支持的 AOP 实现方式，使得开发者无需对 JDK 做任何升级和改动，就可以实现某些 AOP 的功能了。
     <br/>
     在 Java SE 6 里面，instrumentation 包被赋予了更强大的功能：启动后的 instrument、本地代码（native code）instrument，以及动态改变 classpath 等等。这些改变，意味着 Java 具有了更强的动态控制、解释能力，它使得 Java 语言变得更加灵活多变。
     <br/>
     “java.lang.instrument”包的具体实现，依赖于 JVMTI。JVMTI（Java Virtual Machine Tool Interface）是一套由 Java 虚拟机提供的，为 JVM 相关的工具提供的本地编程接口集合。JVMTI 是从 Java SE 5 开始引入，整合和取代了以前使用的 Java Virtual Machine Profiler Interface (JVMPI) 和 the Java Virtual Machine Debug Interface (JVMDI)，而在 Java SE 6 中，JVMPI 和 JVMDI 已经消失了。JVMTI 提供了一套”代理”程序机制，可以支持第三方工具程序以代理的方式连接和访问 JVM，并利用 JVMTI 提供的丰富的编程接口，完成很多跟 JVM 相关的功能。
     <a href="https://mp.weixin.qq.com/s?__biz=MzI3MTEwODc5Ng==&amp;mid=2650859362&amp;idx=1&amp;sn=6d0a588da10ebf38e9d83cfa4e7e16fa&amp;chksm=f13298b1c64511a78e3a87df0f1ddebd87719a36a9335edd759c404cd5c53d65e9383da613f1&amp;scene=21#wechat_redirect" rel="nofollow">
      当我们谈Debug时，我们在谈什么(Debug实现原理)
     </a>
     这个让我想到了这篇文章，其实感觉和debug的道理一样的，debug的时候可以修改参数，或者数据的信息。
     <br/>
    </p>
    <h5>
     <a id="_21">
     </a>
     官方文档
    </h5>
    <p>
     This class provides services needed to instrument Java programming language code. Instrumentation is the addition of byte-codes to methods for the purpose of gathering data to be utilized by tools. Since the changes are purely additive, these tools do not modify application state or behavior. Examples of such benign tools include monitoring agents, profilers, coverage analyzers, and event loggers.（这个类提供了测试 Java 编程语言代码所需的服务。仪器是将字节代码添加到方法中，目的是收集工具使用的数据。由于这些更改纯粹是附加的，因此这些工具不会修改应用程序状态或行为。此类良性工具的示例包括监控代理、分析器、覆盖分析器和事件记录器。）
     <br/>
     有两种方法可以获取仪器接口的实例:
    </p>
    <ul>
     <li>
      When a JVM is launched in a way that indicates an agent class. In that case an Instrumentation instance is passed to the premain method of the agent class.（当 JVM 以指示代理类的方式启动时。在这种情况下，检测实例被传递给代理类的 premain 方法。）
     </li>
     <li>
      When a JVM provides a mechanism to start agents sometime after the JVM is launched. In that case an Instrumentation instance is passed to the agentmain method of the agent code.（当 JVM 在 JVM 启动后的某个时候提供启动代理的机制时，检测实例被传递给代理类的 agentmain 方法）
     </li>
    </ul>
    <p>
     Java Instrumentation-csdn
     <a href="https://blog.csdn.net/DorMOUSENone/article/details/81781131">
      https://blog.csdn.net/DorMOUSENone/article/details/81781131
     </a>
     <br/>
    </p>
    <h3>
     <a id="Java_agent_debug__29">
     </a>
     三、Java agent debug 实践
    </h3>
    <p>
    </p>
    <h4>
     <a id="Agent__31">
     </a>
     Agent 包结构
    </h4>
    <p>
    </p>
    <h5>
     <a id="agent__33">
     </a>
     agent 打包的信息
    </h5>
    <p>
     META-INF.MANIFEST.MF,需要保护一些信息，就是入口类需要传递一个Instrumentation变量给你，JVM 启动的入口类的信息 Premain-Class: com.wangji92.agent.JvmAgentAop，这样标识这个是一个agent。
    </p>
    <pre><code class="prism language-xml">Manifest-Version: 1.0
Implementation-Title: jvm-agent-aop
Premain-Class: com.wangji92.agent.JvmAgentAop
Implementation-Version: 1.0-SNAPSHOT
Built-By: wangji
Agent-Class: com.wangji92.agent.JvmAgentAop
Can-Redefine-Classes: true
Specification-Title: jvm-agent-aop
Can-Retransform-Classes: true
Created-By: Apache Maven 3.6.1
Build-Jdk: 1.8.0_181
Specification-Version: 1.0-SNAPSHOT
</code></pre>
    <p>
    </p>
    <h5>
     <a id="agent__51">
     </a>
     agent 入口类小例子
    </h5>
    <pre><code class="prism language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>wangji92<span class="token punctuation">.</span>agent<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>instrument<span class="token punctuation">.</span>Instrumentation<span class="token punctuation">;</span>

<span class="token comment">/**
 * @author 汪小哥
 * @date 31-01-2020
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BeforeJvmJavaAgent</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">premain</span><span class="token punctuation">(</span>String agentArgs<span class="token punctuation">,</span> Instrumentation inst<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"this is an agent."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"this is an agent 和jvm 一起启动"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"args:"</span> <span class="token operator">+</span> agentArgs <span class="token operator">+</span> <span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        Class<span class="token punctuation">[</span><span class="token punctuation">]</span> allLoadedClasses <span class="token operator">=</span> inst<span class="token punctuation">.</span><span class="token function">getAllLoadedClasses</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>Class <span class="token class-name">loadedClass</span> <span class="token operator">:</span> allLoadedClasses<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"load class:"</span> <span class="token operator">+</span> loadedClass<span class="token punctuation">.</span><span class="token function">getCanonicalName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>loadedClass<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"  classloader"</span><span class="token operator">+</span>loadedClass<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre>
    <p>
    </p>
    <h5>
     <a id="maven_arthas_82">
     </a>
     maven 配置，参考arthas
    </h5>
    <pre><code class="prism language-xml"> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>finalName</span><span class="token punctuation">&gt;</span></span>simple-before-jvm-agent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>finalName</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.maven.plugins<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>maven-compiler-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span><span class="token punctuation">&gt;</span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>source</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>target</span><span class="token punctuation">&gt;</span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>target</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>encoding</span><span class="token punctuation">&gt;</span></span>UTF-8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>encoding</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>showDeprecation</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>showDeprecation</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.maven.plugins<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>maven-assembly-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executions</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>execution</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goals</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">&gt;</span></span>single<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goals</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>phase</span><span class="token punctuation">&gt;</span></span>package<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>phase</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>descriptorRefs</span><span class="token punctuation">&gt;</span></span>
                                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>descriptorRef</span><span class="token punctuation">&gt;</span></span>jar-with-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>descriptorRef</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>descriptorRefs</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>archive</span><span class="token punctuation">&gt;</span></span>
                                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>manifestEntries</span><span class="token punctuation">&gt;</span></span>
                                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Premain-Class</span><span class="token punctuation">&gt;</span></span>com.wangji92.agent.BeforeJvmJavaAgent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Premain-Class</span><span class="token punctuation">&gt;</span></span>
                                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Agent-Class</span><span class="token punctuation">&gt;</span></span>com.wangji92.agent.BeforeJvmJavaAgent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Agent-Class</span><span class="token punctuation">&gt;</span></span>
                                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Can-Redefine-Classes</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Can-Redefine-Classes</span><span class="token punctuation">&gt;</span></span>
                                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Can-Retransform-Classes</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Can-Retransform-Classes</span><span class="token punctuation">&gt;</span></span>
                                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Specification-Title</span><span class="token punctuation">&gt;</span></span>${project.name}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Specification-Title</span><span class="token punctuation">&gt;</span></span>
                                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Specification-Version</span><span class="token punctuation">&gt;</span></span>${project.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Specification-Version</span><span class="token punctuation">&gt;</span></span>
                                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Implementation-Title</span><span class="token punctuation">&gt;</span></span>${project.name}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Implementation-Title</span><span class="token punctuation">&gt;</span></span>
                                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Implementation-Version</span><span class="token punctuation">&gt;</span></span>${project.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Implementation-Version</span><span class="token punctuation">&gt;</span></span>
                                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>manifestEntries</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>archive</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>execution</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executions</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span>
</code></pre>
    <p>
    </p>
    <h4>
     <a id="Java_agent__131">
     </a>
     Java agent 加载的两种方式
    </h4>
    <p>
     根据Java agent的挂载方式有两种，一种是直接在启动的时候挂载，一种是启动完成之后进行挂载（arthas 就是通过这种方式实现的）。这里实践的时候采用第一种。
     <br/>
    </p>
    <h5>
     <a id="JVM__134">
     </a>
     JVM 一起启动
    </h5>
    <p>
     直接在启动参数中增加即可
    </p>
    <pre><code class="prism language-xml"># 通过java 可以查看到帮助文档 
-javaagent:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>jarpath</span><span class="token punctuation">&gt;</span></span>[=<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>选项</span><span class="token punctuation">&gt;</span></span>]
 加载 Java 编程语言代理, 请参阅 java.lang.instrument
</code></pre>
    <p>
     比如这个
    </p>
    <ul>
     <li>
      simple-before-jvm-agent-jar-with-dependencies.jar  agent 包
     </li>
     <li>
      target-java.jar 目标spring boot 程序
     </li>
    </ul>
    <pre><code class="prism language-bash"><span class="token shebang important">#!/bin/sh</span> -x
dir<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">cd</span> `dirname $0`<span class="token punctuation">;</span><span class="token function">pwd</span><span class="token variable">)</span></span>
<span class="token keyword">echo</span> <span class="token variable">$dir</span>
mvn clean package <span class="token operator">&amp;&amp;</span> \
java -javaagent:<span class="token variable">$dir</span>/simple-before-jvm-agent/target/simple-before-jvm-agent-jar-with-dependencies.jar<span class="token operator">=</span>text-args \
-jar <span class="token variable">$dir</span>/target-java/target/target-java.jar
</code></pre>
    <p>
    </p>
    <h5>
     <a id="JVM__arthas_156">
     </a>
     JVM 启动之后 挂载(参考arthas)
    </h5>
    <p>
     将arthas-agent attach 到目标java进程。
     <br/>
     主要代码：com.taobao.arthas.core.Arthas#attachAgent，直到这里，原始的arthas-core的进程处理已经结束了，同事触发了arthas-agent.jar 作为目标java类的代码类触发了arthas-agent Agent-Class（具体可以参考maven xml 配置） agentmain 方法
    </p>
    <pre><code class="prism language-xml">## 1、attach 到目标进程
virtualMachine = VirtualMachine.attach("" + configure.getJavaPid());

## 2、在jvm启动后天就agent，第一个是agent的jar位置，第二个传递的参数
## 了解更多可以参考 java.lang.instrument.Instrumentation
virtualMachine.loadAgent(arthasAgentPath,
                    configure.getArthasCore() + ";" + configure.toString());
</code></pre>
    <p>
    </p>
    <h4>
     <a id="debug_169">
     </a>
     理解debug
    </h4>
    <p>
     <a href="https://mp.weixin.qq.com/s?__biz=MzI3MTEwODc5Ng==&amp;mid=2650859362&amp;idx=1&amp;sn=6d0a588da10ebf38e9d83cfa4e7e16fa&amp;chksm=f13298b1c64511a78e3a87df0f1ddebd87719a36a9335edd759c404cd5c53d65e9383da613f1&amp;scene=21#wechat_redirect" rel="nofollow">
      当我们谈Debug时，我们在谈什么(Debug实现原理)
     </a>
     这篇文章被我引用了很多次，其实debug就是JPDA之上进行处理，Java agent 也是通过 Instrumentation 依赖JVMTI 实现对于JVM中的字节码修改，获取JVM 虚拟机的加载的字节码的信息，两者之间太像了，当我们想讨论如何debug java agnet的代码的时候，是否想过agent 和目标的代码有什么异同？对对，都是在同一个JVM中的。无论是我们使用远程debug 还是IDEA上的debug其实实质上都是建立在JPDA的基础上，JPDA（Java Platform Debugger Architecture）是Java平台调试体系结构的缩写。由3个规范组成，分别是JVMTI(JVM Tool Interface)，JDWP(Java Debug Wire Protocol)，JDI(Java Debug Interface) 。因此都是在一个JVM 里面的，只要目标class 启动的时候开启了debug，那么agent 也可以被debug的。可能在直接使用IDEA debug的时候有一些限制，比如必须在同级的module下面才能debug，那么远程debug就是天然的可以啦！
    </p>
    <p>
    </p>
    <h4>
     <a id="Agent_debugAOP__173">
     </a>
     实战Agent debug(AOP 统计耗时)
    </h4>
    <p>
    </p>
    <h5>
     <a id="agent__175">
     </a>
     agent 入口类
    </h5>
    <pre><code class="prism language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>wangji92<span class="token punctuation">.</span>agent<span class="token punctuation">;</span>

<span class="token keyword">import</span> net<span class="token punctuation">.</span>bytebuddy<span class="token punctuation">.</span>agent<span class="token punctuation">.</span>builder<span class="token punctuation">.</span>AgentBuilder<span class="token punctuation">;</span>
<span class="token keyword">import</span> net<span class="token punctuation">.</span>bytebuddy<span class="token punctuation">.</span>description<span class="token punctuation">.</span>type<span class="token punctuation">.</span>TypeDescription<span class="token punctuation">;</span>
<span class="token keyword">import</span> net<span class="token punctuation">.</span>bytebuddy<span class="token punctuation">.</span>dynamic<span class="token punctuation">.</span>DynamicType<span class="token punctuation">;</span>
<span class="token keyword">import</span> net<span class="token punctuation">.</span>bytebuddy<span class="token punctuation">.</span>implementation<span class="token punctuation">.</span>MethodDelegation<span class="token punctuation">;</span>
<span class="token keyword">import</span> net<span class="token punctuation">.</span>bytebuddy<span class="token punctuation">.</span>matcher<span class="token punctuation">.</span>ElementMatchers<span class="token punctuation">;</span>
<span class="token keyword">import</span> net<span class="token punctuation">.</span>bytebuddy<span class="token punctuation">.</span>utility<span class="token punctuation">.</span>JavaModule<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>instrument<span class="token punctuation">.</span>Instrumentation<span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token keyword">static</span> net<span class="token punctuation">.</span>bytebuddy<span class="token punctuation">.</span>matcher<span class="token punctuation">.</span>ElementMatchers<span class="token punctuation">.</span>*<span class="token punctuation">;</span>

<span class="token comment">/**
 * https://segmentfault.com/a/1190000007253689
 * https://www.infoq.cn/article/Easily-Create-Java-Agents-with-ByteBuddy/
 * https://blog.csdn.net/undergrowth/article/details/86493336
 * https://www.jianshu.com/p/7a5a2c78dab4
 * https://blog.csdn.net/DorMOUSENone/article/details/81781131
 * jvmAop 处理
 *
 * @author 汪小哥
 * @date 01-02-2020
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JvmAgentAop</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">premain</span><span class="token punctuation">(</span>String agentArgs<span class="token punctuation">,</span> Instrumentation inst<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"this is an agent."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"this is an agent 和jvm 一起启动"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"args:"</span> <span class="token operator">+</span> agentArgs <span class="token operator">+</span> <span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">AgentBuilder<span class="token punctuation">.</span>Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token function">nameStartsWith</span><span class="token punctuation">(</span><span class="token string">"com.wangji92.target"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token function">not</span><span class="token punctuation">(</span><span class="token function">isInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token function">not</span><span class="token punctuation">(</span><span class="token function">isStatic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AgentBuilder<span class="token punctuation">.</span>Transformer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> DynamicType<span class="token punctuation">.</span>Builder<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> <span class="token function">transform</span><span class="token punctuation">(</span>DynamicType<span class="token punctuation">.</span>Builder<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> builder<span class="token punctuation">,</span> TypeDescription typeDescription<span class="token punctuation">,</span> ClassLoader classLoader<span class="token punctuation">,</span> JavaModule module<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">method</span><span class="token punctuation">(</span>ElementMatchers<span class="token punctuation">.</span><span class="token function">any</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">intercept</span><span class="token punctuation">(</span>MethodDelegation<span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>CostTimeInterceptor<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">installOn</span><span class="token punctuation">(</span>inst<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre>
    <p>
    </p>
    <h5>
     <a id="bytebuddy_AOP__223">
     </a>
     byte-buddy AOP 处理
    </h5>
    <p>
     byte-buddy 修改字节码可以参考这个
     <a href="https://blog.csdn.net/undergrowth/article/details/86493336">
      https://blog.csdn.net/undergrowth/article/details/86493336
     </a>
     ，
     <br/>
     这里只是简单的统计耗死问题。
    </p>
    <pre><code class="prism language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>wangji92<span class="token punctuation">.</span>agent<span class="token punctuation">;</span>

<span class="token keyword">import</span> net<span class="token punctuation">.</span>bytebuddy<span class="token punctuation">.</span>implementation<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Origin<span class="token punctuation">;</span>
<span class="token keyword">import</span> net<span class="token punctuation">.</span>bytebuddy<span class="token punctuation">.</span>implementation<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>RuntimeType<span class="token punctuation">;</span>
<span class="token keyword">import</span> net<span class="token punctuation">.</span>bytebuddy<span class="token punctuation">.</span>implementation<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>SuperCall<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>Method<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>Callable<span class="token punctuation">;</span>

<span class="token comment">/**
 * aop 耗时计算
 *
 * @author 汪小哥
 * @date 01-02-2020
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CostTimeInterceptor</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@RuntimeType</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> Object <span class="token function">intercept</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Origin</span> Method method<span class="token punctuation">,</span>
                                   <span class="token annotation punctuation">@SuperCall</span> Callable<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> callable<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{<!-- --></span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"call "</span> <span class="token operator">+</span> method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> start <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> callable<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>method <span class="token operator">+</span> <span class="token string">" took "</span> <span class="token operator">+</span> <span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre>
    <p>
    </p>
    <h5>
     <a id="_258">
     </a>
     目标类
    </h5>
    <pre><code class="prism language-java"><span class="token comment">/**
 * @author 汪小哥
 * @date 30-01-2020
 */</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JavaAgentTargetController</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/test/{name}"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token keyword">public</span> String <span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> String name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        String result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
           <span class="token comment">//</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
    </p>
    <h5>
     <a id="_284">
     </a>
     启动脚本
    </h5>
    <p>
     这里通过脚本启动，并开启远程debug，然后在IDEA 中添加一个remote debug 填写端口5005，随便访问一个目录类，即可实现debug agent的目的
    </p>
    <pre><code class="prism language-bash"><span class="token shebang important">#!/bin/sh</span> -x
dir<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">cd</span> `dirname $0`<span class="token punctuation">;</span><span class="token function">pwd</span><span class="token variable">)</span></span>
<span class="token keyword">echo</span> <span class="token variable">$dir</span>
mvn clean package <span class="token operator">&amp;&amp;</span> \
java -agentlib:jdwp<span class="token operator">=</span>transport<span class="token operator">=</span>dt_socket,address<span class="token operator">=</span>5005,server<span class="token operator">=</span>y,suspend<span class="token operator">=</span>n \
-javaagent:<span class="token variable">$dir</span>/jvm-agent-aop/target/jvm-agent-aop-jar-with-dependencies.jar<span class="token operator">=</span>text-args \
-jar <span class="token variable">$dir</span>/target-java/target/target-java.jar

<span class="token comment"># 本文主要是为了测试 agent的debug 功能，从而了解arthas debug</span>
<span class="token comment"># 实际上，agent的 remote debug 只要agent和target 在同一个jvm 中就会被加载，从而可以debug。</span>


<span class="token comment">## 通过Byte Buddy 实现字节码修改（skyworking 也是这样的） 参考 https://zhuanlan.zhihu.com/p/84514959</span>
<span class="token comment">## 使用bytebuddy构建agent   https://segmentfault.com/a/1190000007253689</span>
<span class="token comment">## 通过使用 Byte Buddy，便捷地创建 Java Agent  https://www.infoq.cn/article/Easily-Create-Java-Agents-with-ByteBuddy/</span>
<span class="token comment">## byte-buddy 1.9.6 简述及原理1  https://blog.csdn.net/undergrowth/article/details/86493336 github 有demo</span>
<span class="token comment">## java agent: JVM的层面的"AOP"  https://www.jianshu.com/p/7a5a2c78dab4</span>

</code></pre>
    <p>
    </p>
    <h3>
     <a id="_309">
     </a>
     四、总结
    </h3>
    <p>
     不断的学习、总结，才能理解更加的深刻。
     <br/>
     代码地址：
     <a href="https://github.com/WangJi92/java-agent">
      https://github.com/WangJi92/java-agent
     </a>
    </p>
    <p>
     更多
     <a href="https://wangji.blog.csdn.net/" rel="nofollow">
      汪小哥
     </a>
    </p>
   </div>
   <link href="./../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="./../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
</div>


