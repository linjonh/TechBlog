---
layout: post
title: "WebRTC中音视频服务质量QoS之RTT衡量网络往返时延的加权平均RTT计算机制详解"
date: 2025-03-15 23:55:25 +0800
description: "WebRTC 提供 ‌两种 RTT 计算模式‌，适应不同传输场景‌DLSR‌ 表示自接收端最后一次收到发送端 Sender Report (SR) 到生成当前 Receiver Report (RR) 的时间间隔，单位为 ‌1/65536 秒‌‌1。若接收端未收到过 SR 报文，则 DLSR 值为零‌1。"
keywords: "WebRTC中音视频服务质量QoS之RTT衡量网络往返时延的加权平均RTT计算机制‌详解"
categories: ['Webrtc']
tags: ['音视频', '网络', 'Webrtc']
artid: "146284867"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146284867
    alt: "WebRTC中音视频服务质量QoS之RTT衡量网络往返时延的加权平均RTT计算机制详解"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146284867
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146284867
cover: https://bing.ee123.net/img/rand?artid=146284867
image: https://bing.ee123.net/img/rand?artid=146284867
img: https://bing.ee123.net/img/rand?artid=146284867
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     WebRTC中音视频服务质量QoS之RTT衡量网络往返时延的加权平均RTT计算机制‌详解
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="WebRTCQoSRTTRTT_2">
     </a>
     WebRTC中音视频服务质量QoS之RTT衡量网络往返时延加权平均RTT计算机制‌的详解
    </h2>
    <p>
    </p>
    <p>
    </p>
    <hr color="#000000" size='1"'/>
    <p>
     <font color="red">
      WebRTC专题开嗨鸭 ！！！
     </font>
    </p>
    <p>
     一、 WebRTC 线程模型
    </p>
    <p>
     <a href="https://chensongpoixs.github.io/2021/12/11/WebRTC%E4%B8%AD%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B%E5%92%8C%E5%B8%B8%E8%A7%81%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B%E4%BB%8B%E7%BB%8D/#/" rel="nofollow">
      1、WebRTC中线程模型和常见线程模型介绍
     </a>
    </p>
    <p>
     <a href="https://chensongpoixs.github.io/2022/01/02/WebRTC%E7%BD%91%E7%BB%9CPhysicalSocketServer%E4%B9%8BWSAEventselect%E6%A8%A1%E5%9E%8B%E4%BD%BF%E7%94%A8/" rel="nofollow">
      2、WebRTC网络PhysicalSocketServer之WSAEventselect模型使用
     </a>
    </p>
    <p>
     二、 WebRTC媒体协商
    </p>
    <p>
     <a href="https://chensongpoixs.github.io/2022/04/17/WebRTC%E5%AA%92%E4%BD%93%E5%8D%8F%E5%95%86%E4%B9%8BSDP%E4%B8%ADJsepSessionDescription%E7%B1%BB%E7%BB%93%E6%9E%84%E5%88%86%E6%9E%90/" rel="nofollow">
      1、WebRTC媒体协商之SDP中JsepSessionDescription类结构分析
     </a>
    </p>
    <p>
     <a href="https://chensongpoixs.github.io/2022/01/09/WebRTC%E5%AA%92%E4%BD%93%E5%8D%8F%E5%95%86%E4%B9%8BCreatePeerConnectionFactory-CreatePeerConnection-CreateOffer/" rel="nofollow">
      2、WebRTC媒体协商之CreatePeerConnectionFactory、CreatePeerConnection、CreateOffer
     </a>
    </p>
    <p>
     <a href="https://chensongpoixs.github.io/2022/10/04/WebRTC%E4%B9%8B%E8%AF%81%E4%B9%A6certificate%E7%94%9F%E6%88%90%E7%9A%84%E6%97%B6%E6%9C%BA%E5%88%86%E6%9E%90/#/" rel="nofollow">
      3、WebRTC之证书(certificate)生成的时机分析
     </a>
    </p>
    <p>
     <a href="" rel="nofollow">
      4、WebRTC源码之RtpTransceiver添加视频轨道的AddTrack函数中桥接模式的流程分析
     </a>
    </p>
    <p>
     三、 WebRTC 音频数据采集
    </p>
    <p>
     <a href="https://chensongpoixs.github.io/2022/08/14/WebRTC%E6%BA%90%E7%A0%81%E4%B9%8B%E9%9F%B3%E9%A2%91%E8%AE%BE%E5%A4%87%E6%92%AD%E6%94%BE%E6%B5%81%E7%A8%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" rel="nofollow">
      1、WebRTC源码之音频设备播放流程源码分析
     </a>
    </p>
    <p>
     <a href="https://chensongpoixs.github.io/2022/08/14/WebRTC%E6%BA%90%E7%A0%81%E4%B9%8B%E9%9F%B3%E9%A2%91%E8%AE%BE%E5%A4%87%E7%9A%84%E5%BD%95%E5%88%B6%E6%B5%81%E7%A8%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/#/" rel="nofollow">
      2、WebRTC源码之音频设备的录制流程源码分析
     </a>
    </p>
    <p>
     四、 WebRTC 音频引擎(编解码和3A算法)
    </p>
    <p>
     五、 WebRTC 视频数据采集
    </p>
    <p>
     六、 WebRTC 视频引擎( 编解码)
    </p>
    <p>
     七、 WebRTC 网络传输
    </p>
    <p>
     <a href="https://blog.csdn.net/Poisx/article/details/124521731">
      1、WebRTC的ICE之STUN协议
     </a>
    </p>
    <p>
     <a href="https://chensongpoixs.github.io/2022/05/30/WebRTC%E7%9A%84ICE%E4%B9%8BDtls_SSL_TLSv1.x%E5%8D%8F%E8%AE%AE%E8%AF%A6%E8%A7%A3/" rel="nofollow">
      2、WebRTC的ICE之Dtls/SSL/TLSv1.x协议详解
     </a>
    </p>
    <p>
     八、 WebRTC服务质量(Qos)
    </p>
    <p>
     <a href="https://chensongpoixs.github.io/2021/11/16/WebRTC%E4%B8%ADRTCP%E5%8D%8F%E8%AE%AE%E8%AF%A6%E8%A7%A3/" rel="nofollow">
      1、WebRTC中RTCP协议详解
     </a>
    </p>
    <p>
     <a href="https://chensongpoixs.github.io/2022/05/29/WebRTC%E4%B8%ADRTP%E5%8D%8F%E8%AE%AE%E8%AF%A6%E8%A7%A3/#/" rel="nofollow">
      2、WebRTC中RTP协议详解
     </a>
    </p>
    <p>
     <a href="https://chensongpoixs.github.io/2022/05/30/WebRTC%E4%B9%8BNACK-RTX-%E5%9C%A8%E4%BB%80%E4%B9%88%E6%97%B6%E6%9C%BA%E5%88%A4%E6%96%AD%E4%B8%A2%E5%8C%85%E5%8F%91%E9%80%81NACK%E8%AF%B7%E6%B1%82%E5%92%8CRTX%E4%B8%A2%E5%8C%85%E9%87%8D%E4%BC%A0/" rel="nofollow">
      3、WebRTC之NACK、RTX 在什么时机判断丢包发送NACK请求和RTX丢包重传
     </a>
    </p>
    <p>
     <a href="https://chensongpoixs.github.io/2022/07/26/WebRTC%E6%BA%90%E7%A0%81%E4%B9%8B%E8%A7%86%E9%A2%91%E8%B4%A8%E9%87%8F%E7%BB%9F%E8%AE%A1%E6%95%B0%E6%8D%AE%E4%B8%AD%E5%9F%BA%E7%A1%80%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%88%86%E6%9E%90/" rel="nofollow">
      4、WebRTC源码之视频质量统计数据的数据结构分析
     </a>
    </p>
    <p>
     <a href="" rel="nofollow">
      5、WebRTC源码之RTCPReceiver源码分析
     </a>
    </p>
    <p>
     <a href="" rel="nofollow">
      6、WebRTC中音视频服务质量QoS之RTT衡量网络往返时延加权平均RTT计算机制‌的详解
     </a>
    </p>
    <p>
     九、 NetEQ
    </p>
    <p>
     十、 Simulcast与SVC
    </p>
    <h2>
     <a id="_71">
     </a>
     前言
    </h2>
    <h2>
     <a id="___RTT__73">
     </a>
     一、 RTT 网络往返时延的原理‌
    </h2>
    <p>
     WebRTC 提供 ‌两种 RTT 计算模式‌，适应不同传输场景
    </p>
    <h3>
     <a id="1SRRR__77">
     </a>
     1、基于发送端（SR/RR 模式）
    </h3>
    <p>
     ***
     <font color="red">
      触发条件‌： 发送端周期性发送 ‌Sender Report (SR)‌，接收端回应 ‌Receiver Report (RR)‌‌
     </font>
     ***
    </p>
    <h4>
     <a id="__82">
     </a>
     ①. ‌基本定义‌
    </h4>
    <pre><code>	‌DLSR‌ 表示自接收端最后一次收到发送端 Sender Report (SR) 到生成当前 Receiver Report (RR) 的时间间隔，单位为 ‌1/65536 秒‌‌1。
	若接收端未收到过 SR 报文，则 DLSR 值为零‌1。
</code></pre>
    <h4>
     <a id="__RTT__87">
     </a>
     ②. ‌计算 RTT 网络往返时延的原理‌
    </h4>
    <pre><code>	在端到端通信中（以端点 A 和 B 为例）：

	‌A 发送 SR‌：记录发送时间 t1（即 LSR，Last SR Timestamp）‌2。
	‌B 接收 SR‌：记录接收时间 last_recv_time‌2。
	‌B 发送 RR‌：计算从 last_recv_time 到当前时间的延迟（即 DLSR），并附加到 RR 报文‌2。
	‌A 接收 RR‌：根据公式 RTT = 当前时间 - LSR - DLSR 计算往返时间。
</code></pre>
    <p>
     公式：
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        R 
        
       
         T 
        
       
         T 
        
       
         = 
        
        
        
          T 
         
         
         
           c 
          
         
           u 
          
         
           r 
          
         
           r 
          
         
           e 
          
         
           n 
          
         
           t 
          
         
        
       
         − 
        
        
        
          T 
         
         
         
           L 
          
         
           S 
          
         
           R 
          
         
        
       
         − 
        
        
         
         
           T 
          
          
          
            D 
           
          
            L 
           
          
            S 
           
          
            R 
           
          
         
        
          65536 
         
        
       
      
        {RTT=T_{current} − T_ {LSR} − \frac{T_{DLSR}}{65536}}
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 1.2336em; vertical-align: -0.345em;">
         </span>
         <span class="mord">
          <span class="mord mathnormal" style="margin-right: 0.1389em;">
           RTT
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           =
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.1389em;">
            T
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.2806em;">
               <span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mathnormal mtight">
                   c
                  </span>
                  <span class="mord mathnormal mtight">
                   u
                  </span>
                  <span class="mord mathnormal mtight">
                   rre
                  </span>
                  <span class="mord mathnormal mtight">
                   n
                  </span>
                  <span class="mord mathnormal mtight">
                   t
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
          <span class="mbin">
           −
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.1389em;">
            T
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3283em;">
               <span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mathnormal mtight">
                   L
                  </span>
                  <span class="mord mathnormal mtight" style="margin-right: 0.0077em;">
                   SR
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
          <span class="mbin">
           −
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
          <span class="mord">
           <span class="mopen nulldelimiter">
           </span>
           <span class="mfrac">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.8886em;">
               <span class="" style="top: -2.655em;">
                <span class="pstrut" style="height: 3em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mtight">
                   65536
                  </span>
                 </span>
                </span>
               </span>
               <span class="" style="top: -3.23em;">
                <span class="pstrut" style="height: 3em;">
                </span>
                <span class="frac-line" style="border-bottom-width: 0.04em;">
                </span>
               </span>
               <span class="" style="top: -3.4103em;">
                <span class="pstrut" style="height: 3em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mtight">
                   <span class="mord mathnormal mtight" style="margin-right: 0.1389em;">
                    T
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t vlist-t2">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.3448em;">
                       <span class="" style="top: -2.3567em; margin-left: -0.1389em; margin-right: 0.0714em;">
                        <span class="pstrut" style="height: 2.5em;">
                        </span>
                        <span class="sizing reset-size3 size1 mtight">
                         <span class="mord mtight">
                          <span class="mord mathnormal mtight" style="margin-right: 0.0278em;">
                           D
                          </span>
                          <span class="mord mathnormal mtight">
                           L
                          </span>
                          <span class="mord mathnormal mtight" style="margin-right: 0.0077em;">
                           SR
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                      <span class="vlist-s">
                       ​
                      </span>
                     </span>
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.1433em;">
                       <span class="">
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.345em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mclose nulldelimiter">
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     (单位：秒)
    </p>
    <p>
     参数说明‌：
    </p>
    <p>
     ​
     <br/>
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        T 
         
         
         
           L 
          
         
           S 
          
         
           R 
          
         
        
       
      
        T_ {LSR}
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.8333em; vertical-align: -0.15em;">
         </span>
         <span class="mord">
          <span class="mord mathnormal" style="margin-right: 0.1389em;">
           T
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.3283em;">
              <span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mathnormal mtight">
                  L
                 </span>
                 <span class="mord mathnormal mtight" style="margin-right: 0.0077em;">
                  SR
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.15em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     ：发送端最后一次 SR 的 NTP 时间戳（中间 32 位）‌3。
     <br/>
     ‌
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        T 
         
         
         
           D 
          
         
           L 
          
         
           S 
          
         
           R 
          
         
           ‌ 
          
         
        
       
      
        T_{DLSR‌}
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.8333em; vertical-align: -0.15em;">
         </span>
         <span class="mord">
          <span class="mord mathnormal" style="margin-right: 0.1389em;">
           T
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.3283em;">
              <span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.0278em;">
                  D
                 </span>
                 <span class="mord mathnormal mtight">
                  L
                 </span>
                 <span class="mord mathnormal mtight" style="margin-right: 0.0077em;">
                  SR
                 </span>
                 <span class="mord mtight">
                  ‌
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.15em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     ：接收端处理 SR 到生成 RR 的延迟（单位：1/65536 秒）‌
    </p>
    <h4>
     <a id="__Sender_Report__SR__104">
     </a>
     ③ 发送 Sender Report (SR) 协议
    </h4>
    <h5>
     <a id="SenderReport__106">
     </a>
     SenderReport 协议的格式
    </h5>
    <pre><code class="prism language-javascript">
<span class="token comment">//    Sender report (SR) (RFC 3550).</span>
<span class="token comment">//     0                   1                   2                   3</span>
<span class="token comment">//     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span>
<span class="token comment">//    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span class="token comment">//    |V=2|P|    RC   |   PT=SR=200   |             length            |</span>
<span class="token comment">//    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span class="token comment">//  0 |                         SSRC of sender                        |</span>
<span class="token comment">//    +=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+</span>
<span class="token comment">//  4 |              NTP timestamp, most significant word             |</span>
<span class="token comment">//    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span class="token comment">//  8 |             NTP timestamp, least significant word             |</span>
<span class="token comment">//    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span class="token comment">// 12 |                         RTP timestamp                         |</span>
<span class="token comment">//    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span class="token comment">// 16 |                     sender's packet count                     |</span>
<span class="token comment">//    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span class="token comment">// 20 |                      sender's octet count                     |</span>
<span class="token comment">// 24 +=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+</span>
</code></pre>
    <h5>
     <a id="SR_130">
     </a>
     组织SR协议
    </h5>
    <pre><code class="prism language-javascript">
<span class="token literal-property property">std</span><span class="token operator">:</span><span class="token operator">:</span>unique_ptr<span class="token operator">&lt;</span>rtcp<span class="token operator">:</span><span class="token operator">:</span>RtcpPacket<span class="token operator">&gt;</span> RTCPSender<span class="token operator">:</span><span class="token operator">:</span><span class="token function">BuildSR</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">const</span> RtcpContext<span class="token operator">&amp;</span> ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// Timestamp shouldn't be estimated before first media frame.</span>
  <span class="token constant">RTC_DCHECK_GE</span><span class="token punctuation">(</span>last_frame_capture_time_ms_<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// The timestamp of this RTCP packet should be estimated as the timestamp of</span>
  <span class="token comment">// the frame being captured at this moment. We are calculating that</span>
  <span class="token comment">// timestamp as the last frame's timestamp + the time since the last frame</span>
  <span class="token comment">// was captured.</span>
  int rtp_rate <span class="token operator">=</span> rtp_clock_rates_khz_<span class="token punctuation">[</span>last_payload_type_<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>rtp_rate <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    rtp_rate <span class="token operator">=</span>
        <span class="token punctuation">(</span>audio_ <span class="token operator">?</span> kBogusRtpRateForAudioRtcp <span class="token operator">:</span> kVideoPayloadTypeFrequency<span class="token punctuation">)</span> <span class="token operator">/</span>
        <span class="token number">1000</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// Round now_us_ to the closest millisecond, because Ntp time is rounded</span>
  <span class="token comment">// when converted to milliseconds,</span>
  uint32_t rtp_timestamp <span class="token operator">=</span>
      timestamp_offset_ <span class="token operator">+</span> last_rtp_timestamp_ <span class="token operator">+</span>
      <span class="token punctuation">(</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>now_us_ <span class="token operator">+</span> <span class="token number">500</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span> <span class="token operator">-</span> last_frame_capture_time_ms_<span class="token punctuation">)</span> <span class="token operator">*</span> rtp_rate<span class="token punctuation">;</span>

  <span class="token literal-property property">rtcp</span><span class="token operator">:</span><span class="token operator">:</span>SenderReport<span class="token operator">*</span> report <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">rtcp</span><span class="token operator">:</span><span class="token operator">:</span><span class="token function">SenderReport</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  report<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">SetSenderSsrc</span><span class="token punctuation">(</span>ssrc_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  report<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">SetNtp</span><span class="token punctuation">(</span><span class="token function">TimeMicrosToNtp</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>now_us_<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  report<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">SetRtpTimestamp</span><span class="token punctuation">(</span>rtp_timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  report<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">SetPacketCount</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>feedback_state_<span class="token punctuation">.</span>packets_sent<span class="token punctuation">)</span><span class="token punctuation">;</span>
  report<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">SetOctetCount</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>feedback_state_<span class="token punctuation">.</span>media_bytes_sent<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// TODO@chensong  2025-03-15  获取当前发送 </span>
  report<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">SetReportBlocks</span><span class="token punctuation">(</span><span class="token function">CreateReportBlocks</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>feedback_state_<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token literal-property property">std</span><span class="token operator">:</span><span class="token operator">:</span>unique_ptr<span class="token operator">&lt;</span>rtcp<span class="token operator">:</span><span class="token operator">:</span>RtcpPacket<span class="token operator">&gt;</span><span class="token punctuation">(</span>report<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
    <h5>
     <a id="SRRRReportBlock_LSRDLSR_168">
     </a>
     SR和RR中都有ReportBlock数据块保存 LSR和DLSR的信息
    </h5>
    <pre><code class="prism language-javascript">
<span class="token comment">// From RFC 3550, RTP: A Transport Protocol for Real-Time Applications.</span>
<span class="token comment">//</span>
<span class="token comment">// RTCP report block (RFC 3550).</span>
<span class="token comment">//</span>
<span class="token comment">//     0                   1                   2                   3</span>
<span class="token comment">//     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span>
<span class="token comment">//    +=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+</span>
<span class="token comment">//  0 |                 SSRC_1 (SSRC of first source)                 |</span>
<span class="token comment">//    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span class="token comment">//  4 | fraction lost |       cumulative number of packets lost       |</span>
<span class="token comment">//    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span class="token comment">//  8 |           extended highest sequence number received           |</span>
<span class="token comment">//    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span class="token comment">// 12 |                      interarrival jitter                      |</span>
<span class="token comment">//    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span class="token comment">// 16 |                         last SR (LSR)                         |</span>
<span class="token comment">//    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span class="token comment">// 20 |                   delay since last SR (DLSR)                  |</span>
<span class="token comment">// 24 +=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+</span>
</code></pre>
    <h5>
     <a id="SRRRReportBlock_195">
     </a>
     SR和RR中都有ReportBlock协议解析
    </h5>
    <p>
     last_sr_ ：发送端发送时间
    </p>
    <p>
     delay_since_last_sr_ : 是远端最后接受SR或者RR包的时间
    </p>
    <pre><code class="prism language-javascript">

bool ReportBlock<span class="token operator">:</span><span class="token operator">:</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">const</span> uint8_t<span class="token operator">*</span> buffer<span class="token punctuation">,</span> size_t length</span><span class="token punctuation">)</span> 
<span class="token punctuation">{<!-- --></span>
  <span class="token constant">RTC_DCHECK</span><span class="token punctuation">(</span>buffer <span class="token operator">!=</span> nullptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">&lt;</span> ReportBlock<span class="token operator">:</span><span class="token operator">:</span>kLength<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token constant">RTC_LOG</span><span class="token punctuation">(</span><span class="token constant">LS_ERROR</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Report Block should be 24 bytes long"</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 接收到的媒体源ssrc</span>
  source_ssrc_ <span class="token operator">=</span> ByteReader<span class="token operator">&lt;</span>uint32_t<span class="token operator">&gt;</span><span class="token operator">:</span><span class="token operator">:</span><span class="token function">ReadBigEndian</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buffer<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// TODO@chensong 2022-10-19  丢包率 fraction_lost</span>
  <span class="token comment">/**
		TODO@chensong 2023-03-07  
		某时刻收到的有序包的数量Count = transmitted-retransmitte,当前时刻为Count2,上一时刻为Count1;

        接收端以一定的频率发送RTCP包（RR、REMB、NACK等）时，会统计两次发送间隔之间(fraction)的接收包信息。

        接收端发送的RR包中包含两个丢包:

        一个是fraction_lost，是两次统计间隔间的丢包率(以256为基数换算成8bit)。

        一个是cumulative number of packets lost，是总的累积丢包。 
  **/</span>
  fraction_lost_ <span class="token operator">=</span> buffer<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// 接收开始丢包总数， 迟到包不算丢包，重传有可以导致负数</span>
  cumulative_lost_ <span class="token operator">=</span> ByteReader<span class="token operator">&lt;</span>int32_t<span class="token punctuation">,</span> <span class="token number">3</span><span class="token operator">&gt;</span><span class="token operator">:</span><span class="token operator">:</span><span class="token function">ReadBigEndian</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buffer<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 低16位表示收到的最大seq，高16位表示seq循环次数</span>
  extended_high_seq_num_ <span class="token operator">=</span> ByteReader<span class="token operator">&lt;</span>uint32_t<span class="token operator">&gt;</span><span class="token operator">:</span><span class="token operator">:</span><span class="token function">ReadBigEndian</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buffer<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// rtp包到达时间间隔的统计方差</span>
  jitter_ <span class="token operator">=</span> ByteReader<span class="token operator">&lt;</span>uint32_t<span class="token operator">&gt;</span><span class="token operator">:</span><span class="token operator">:</span><span class="token function">ReadBigEndian</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buffer<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ntp时间戳的中间32位</span>
  last_sr_ <span class="token operator">=</span> ByteReader<span class="token operator">&lt;</span>uint32_t<span class="token operator">&gt;</span><span class="token operator">:</span><span class="token operator">:</span><span class="token function">ReadBigEndian</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buffer<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 记录上一个接收SR的时间与上一个发送SR的时间差</span>
  delay_since_last_sr_ <span class="token operator">=</span> ByteReader<span class="token operator">&lt;</span>uint32_t<span class="token operator">&gt;</span><span class="token operator">:</span><span class="token operator">:</span><span class="token function">ReadBigEndian</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buffer<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
    <h4>
     <a id="__ReceiverReportRR_245">
     </a>
     ④ 发送ReceiverReport（RR）协议
    </h4>
    <h5>
     <a id="ReceiverReport_247">
     </a>
     ReceiverReport协议格式
    </h5>
    <pre><code class="prism language-javascript">
<span class="token comment">// RTCP receiver report (RFC 3550).</span>
<span class="token comment">//</span>
<span class="token comment">//   0                   1                   2                   3</span>
<span class="token comment">//   0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span>
<span class="token comment">//  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span class="token comment">//  |V=2|P|    RC   |   PT=RR=201   |             length            |</span>
<span class="token comment">//  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span class="token comment">//  |                     SSRC of packet sender                     |</span>
<span class="token comment">//  +=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+</span>
<span class="token comment">//  |                         report block(s)                       |</span>
<span class="token comment">//  |                            ....                               |</span>

</code></pre>
    <h5>
     <a id="_ReceiverReportRR_265">
     </a>
     组织 ReceiverReport(RR)数据
    </h5>
    <p>
     在RTCPSender类中BuildRR方法中调用 GetFeedbackState方法获取 ReportBlock数据
    </p>
    <p>
     调用流程
    </p>
    <p>
     RTCPSender类BuildRR —&gt; ModuleRtpRtcpImpl::GetFeedbackState获取 remote_sender_rtp_time_(远端发送时间)和 last_received_sr_ntp_ （最后一次接受时间）
     <br/>
     —&gt;LastReceivedNTP 方法调用NTP方法
     <br/>
     –&gt;RTCPReceiver类NTP 获取 remote_sender_rtp_time_(远端发送时间)和 last_received_sr_ntp_ （最后一次接受时间）
    </p>
    <pre><code class="prism language-javascript">
<span class="token literal-property property">std</span><span class="token operator">:</span><span class="token operator">:</span>unique_ptr<span class="token operator">&lt;</span>rtcp<span class="token operator">:</span><span class="token operator">:</span>RtcpPacket<span class="token operator">&gt;</span> RTCPSender<span class="token operator">:</span><span class="token operator">:</span><span class="token function">BuildRR</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">const</span> RtcpContext<span class="token operator">&amp;</span> ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">rtcp</span><span class="token operator">:</span><span class="token operator">:</span>ReceiverReport<span class="token operator">*</span> report <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">rtcp</span><span class="token operator">:</span><span class="token operator">:</span><span class="token function">ReceiverReport</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  report<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">SetSenderSsrc</span><span class="token punctuation">(</span>ssrc_<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// TODO@chensong 2025-03-15  rtp_rtcp_impl.cc -&gt;  ModuleRtpRtcpImpl::GetFeedbackState</span>
  report<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">SetReportBlocks</span><span class="token punctuation">(</span><span class="token function">CreateReportBlocks</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>feedback_state_<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token literal-property property">std</span><span class="token operator">:</span><span class="token operator">:</span>unique_ptr<span class="token operator">&lt;</span>rtcp<span class="token operator">:</span><span class="token operator">:</span>RtcpPacket<span class="token operator">&gt;</span><span class="token punctuation">(</span>report<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>





<span class="token comment">// TODO(pbos): Handle media and RTX streams separately (separate RTCP</span>
<span class="token comment">// feedbacks).</span>
<span class="token literal-property property">RTCPSender</span><span class="token operator">:</span><span class="token operator">:</span>FeedbackState ModuleRtpRtcpImpl<span class="token operator">:</span><span class="token operator">:</span><span class="token function">GetFeedbackState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">RTCPSender</span><span class="token operator">:</span><span class="token operator">:</span>FeedbackState state<span class="token punctuation">;</span>
  <span class="token comment">// This is called also when receiver_only is true. Hence below</span>
  <span class="token comment">// checks that rtp_sender_ exists.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>rtp_sender_<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    StreamDataCounters rtp_stats<span class="token punctuation">;</span>
    StreamDataCounters rtx_stats<span class="token punctuation">;</span>
    rtp_sender_<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">GetDataCounters</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rtp_stats<span class="token punctuation">,</span> <span class="token operator">&amp;</span>rtx_stats<span class="token punctuation">)</span><span class="token punctuation">;</span>
    state<span class="token punctuation">.</span>packets_sent <span class="token operator">=</span>
        rtp_stats<span class="token punctuation">.</span>transmitted<span class="token punctuation">.</span>packets <span class="token operator">+</span> rtx_stats<span class="token punctuation">.</span>transmitted<span class="token punctuation">.</span>packets<span class="token punctuation">;</span>
    state<span class="token punctuation">.</span>media_bytes_sent <span class="token operator">=</span> rtp_stats<span class="token punctuation">.</span>transmitted<span class="token punctuation">.</span>payload_bytes <span class="token operator">+</span>
                             rtx_stats<span class="token punctuation">.</span>transmitted<span class="token punctuation">.</span>payload_bytes<span class="token punctuation">;</span>
    state<span class="token punctuation">.</span>send_bitrate <span class="token operator">=</span> rtp_sender_<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">BitrateSent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  state<span class="token punctuation">.</span>module <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token comment">// TODO@chensong 2025-03-15 获取远端发送信息包时间 和当前最后接收一包记录时间</span>
  <span class="token function">LastReceivedNTP</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>state<span class="token punctuation">.</span>last_rr_ntp_secs<span class="token punctuation">,</span> <span class="token operator">&amp;</span>state<span class="token punctuation">.</span>last_rr_ntp_frac<span class="token punctuation">,</span>
                  <span class="token operator">&amp;</span>state<span class="token punctuation">.</span>remote_sr<span class="token punctuation">)</span><span class="token punctuation">;</span>

  state<span class="token punctuation">.</span>last_xr_rtis <span class="token operator">=</span> rtcp_receiver_<span class="token punctuation">.</span><span class="token function">ConsumeReceivedXrReferenceTimeInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> state<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

bool RTCPReceiver<span class="token operator">:</span><span class="token operator">:</span><span class="token constant">NTP</span><span class="token punctuation">(</span>uint32_t<span class="token operator">*</span> received_ntp_secs<span class="token punctuation">,</span>
                       uint32_t<span class="token operator">*</span> received_ntp_frac<span class="token punctuation">,</span>
                       uint32_t<span class="token operator">*</span> rtcp_arrival_time_secs<span class="token punctuation">,</span>
                       uint32_t<span class="token operator">*</span> rtcp_arrival_time_frac<span class="token punctuation">,</span>
                       uint32_t<span class="token operator">*</span> rtcp_timestamp<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">rtc</span><span class="token operator">:</span><span class="token operator">:</span>CritScope <span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rtcp_receiver_lock_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>last_received_sr_ntp_<span class="token punctuation">.</span><span class="token function">Valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//   TODO@chensong 2025-03-15  last_rr_ntp_frac 发送时间戳</span>
  <span class="token comment">// NTP from incoming SenderReport.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>received_ntp_secs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token operator">*</span>received_ntp_secs <span class="token operator">=</span> remote_sender_ntp_time_<span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>received_ntp_frac<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token operator">*</span>received_ntp_frac <span class="token operator">=</span> remote_sender_ntp_time_<span class="token punctuation">.</span><span class="token function">fractions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Rtp time from incoming SenderReport.</span>
  <span class="token comment">// TODO@chensong 2025-03-15 远端接受最后一个rtp包的时间</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>rtcp_timestamp<span class="token punctuation">)</span> 
  <span class="token punctuation">{<!-- --></span>
    <span class="token operator">*</span>rtcp_timestamp <span class="token operator">=</span> remote_sender_rtp_time_<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Local NTP time when we received a RTCP packet with a send block.</span>
  <span class="token comment">// TODO@chensong 2025-03-15 本地接受最后一个rtcp包的时间</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>rtcp_arrival_time_secs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token operator">*</span>rtcp_arrival_time_secs <span class="token operator">=</span> last_received_sr_ntp_<span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>rtcp_arrival_time_frac<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token operator">*</span>rtcp_arrival_time_frac <span class="token operator">=</span> last_received_sr_ntp_<span class="token punctuation">.</span><span class="token function">fractions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 接收SenderReport包信息</span>
<span class="token keyword">void</span> <span class="token literal-property property">RTCPReceiver</span><span class="token operator">:</span><span class="token operator">:</span><span class="token function">HandleSenderReport</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">const</span> CommonHeader<span class="token operator">&amp;</span> rtcp_block<span class="token punctuation">,</span>
                                      PacketInformation<span class="token operator">*</span> packet_information</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">rtcp</span><span class="token operator">:</span><span class="token operator">:</span>SenderReport sender_report<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sender_report<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>rtcp_block<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token operator">++</span>num_skipped_packets_<span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> uint32_t remote_ssrc <span class="token operator">=</span> sender_report<span class="token punctuation">.</span><span class="token function">sender_ssrc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  packet_information<span class="token operator">-</span><span class="token operator">&gt;</span>remote_ssrc <span class="token operator">=</span> remote_ssrc<span class="token punctuation">;</span>

  <span class="token function">UpdateTmmbrRemoteIsAlive</span><span class="token punctuation">(</span>remote_ssrc<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Have I received RTP packets from this party?</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>remote_ssrc_ <span class="token operator">==</span> remote_ssrc<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// Only signal that we have received a SR when we accept one.</span>
    packet_information<span class="token operator">-</span><span class="token operator">&gt;</span>packet_type_flags <span class="token operator">|=</span> kRtcpSr<span class="token punctuation">;</span>
	<span class="token comment">// TODO@chensong 2025-03-15   SR =&gt; RR </span>
    remote_sender_ntp_time_ <span class="token operator">=</span> sender_report<span class="token punctuation">.</span><span class="token function">ntp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    remote_sender_rtp_time_ <span class="token operator">=</span> sender_report<span class="token punctuation">.</span><span class="token function">rtp_timestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    last_received_sr_ntp_ <span class="token operator">=</span> <span class="token function">TimeMicrosToNtp</span><span class="token punctuation">(</span>clock_<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">TimeInMicroseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// We will only store the send report from one source, but</span>
    <span class="token comment">// we will store all the receive blocks.</span>
    packet_information<span class="token operator">-</span><span class="token operator">&gt;</span>packet_type_flags <span class="token operator">|=</span> kRtcpRr<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token literal-property property">rtcp</span><span class="token operator">:</span><span class="token operator">:</span>ReportBlock<span class="token operator">&amp;</span> report_block <span class="token operator">:</span> sender_report<span class="token punctuation">.</span><span class="token function">report_blocks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">HandleReportBlock</span><span class="token punctuation">(</span>report_block<span class="token punctuation">,</span> packet_information<span class="token punctuation">,</span> remote_ssrc<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h5>
     <a id="rtt__RTT_390">
     </a>
     终止计算rtt往返时延 加权平均RTT计算机制‌
    </h5>
    <h6>
     <a id="_WebRTC1_392">
     </a>
     定时计算 WebRTC中默认1秒
    </h6>
    <p>
     在ModuleRtpRtcpImpl类中Process方法中统计 加权平均RTT计算机制‌
    </p>
    <pre><code class="prism language-javascript">
<span class="token comment">// Process any pending tasks such as timeouts (non time critical events).</span>
<span class="token keyword">void</span> <span class="token literal-property property">ModuleRtpRtcpImpl</span><span class="token operator">:</span><span class="token operator">:</span><span class="token function">Process</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> int64_t now <span class="token operator">=</span> clock_<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">TimeInMilliseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  next_process_time_ <span class="token operator">=</span> now <span class="token operator">+</span> kRtpRtcpMaxIdleTimeProcessMs<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>rtp_sender_<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">&gt;=</span> last_bitrate_process_time_ <span class="token operator">+</span> kRtpRtcpBitrateProcessTimeMs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      rtp_sender_<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">ProcessBitrate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      last_bitrate_process_time_ <span class="token operator">=</span> now<span class="token punctuation">;</span>
      next_process_time_ <span class="token operator">=</span>
          <span class="token literal-property property">std</span><span class="token operator">:</span><span class="token operator">:</span><span class="token function">min</span><span class="token punctuation">(</span>next_process_time_<span class="token punctuation">,</span> now <span class="token operator">+</span> kRtpRtcpBitrateProcessTimeMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  bool process_rtt <span class="token operator">=</span> now <span class="token operator">&gt;=</span> last_rtt_process_time_ <span class="token operator">+</span> kRtpRtcpRttProcessTimeMs<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>rtcp_sender_<span class="token punctuation">.</span><span class="token function">Sending</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// Process RTT if we have received a report block and we haven't</span>
    <span class="token comment">// processed RTT for at least |kRtpRtcpRttProcessTimeMs| milliseconds.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rtcp_receiver_<span class="token punctuation">.</span><span class="token function">LastReceivedReportBlockMs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> last_rtt_process_time_ <span class="token operator">&amp;&amp;</span>
        process_rtt<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">std</span><span class="token operator">:</span><span class="token operator">:</span>vector<span class="token operator">&lt;</span>RTCPReportBlock<span class="token operator">&gt;</span> receive_blocks<span class="token punctuation">;</span>
      rtcp_receiver_<span class="token punctuation">.</span><span class="token function">StatisticsReceived</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>receive_blocks<span class="token punctuation">)</span><span class="token punctuation">;</span>
      int64_t max_rtt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>std<span class="token operator">:</span><span class="token operator">:</span>vector<span class="token operator">&lt;</span>RTCPReportBlock<span class="token operator">&gt;</span><span class="token operator">:</span><span class="token operator">:</span>iterator it <span class="token operator">=</span> receive_blocks<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           it <span class="token operator">!=</span> receive_blocks<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>it<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        int64_t rtt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        rtcp_receiver_<span class="token punctuation">.</span><span class="token constant">RTT</span><span class="token punctuation">(</span>it<span class="token operator">-</span><span class="token operator">&gt;</span>sender_ssrc<span class="token punctuation">,</span> <span class="token operator">&amp;</span>rtt<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        max_rtt <span class="token operator">=</span> <span class="token punctuation">(</span>rtt <span class="token operator">&gt;</span> max_rtt<span class="token punctuation">)</span> <span class="token operator">?</span> rtt <span class="token operator">:</span> max_rtt<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// Report the rtt.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>rtt_stats_ <span class="token operator">&amp;&amp;</span> max_rtt <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        rtt_stats_<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">OnRttUpdate</span><span class="token punctuation">(</span>max_rtt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Verify receiver reports are delivered and the reported sequence number</span>
    <span class="token comment">// is increasing.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rtcp_receiver_<span class="token punctuation">.</span><span class="token function">RtcpRrTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token constant">RTC_LOG_F</span><span class="token punctuation">(</span><span class="token constant">LS_WARNING</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Timeout: No RTCP RR received."</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rtcp_receiver_<span class="token punctuation">.</span><span class="token function">RtcpRrSequenceNumberTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token constant">RTC_LOG_F</span><span class="token punctuation">(</span><span class="token constant">LS_WARNING</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Timeout: No increase in RTCP RR extended "</span>
                               <span class="token string">"highest sequence number."</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>remote_bitrate_ <span class="token operator">&amp;&amp;</span> rtcp_sender_<span class="token punctuation">.</span><span class="token constant">TMMBR</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      unsigned int target_bitrate <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token literal-property property">std</span><span class="token operator">:</span><span class="token operator">:</span>vector<span class="token operator">&lt;</span>unsigned int<span class="token operator">&gt;</span> ssrcs<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>remote_bitrate_<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">LatestEstimate</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ssrcs<span class="token punctuation">,</span> <span class="token operator">&amp;</span>target_bitrate<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ssrcs<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          target_bitrate <span class="token operator">=</span> target_bitrate <span class="token operator">/</span> ssrcs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        rtcp_sender_<span class="token punctuation">.</span><span class="token function">SetTargetBitrate</span><span class="token punctuation">(</span>target_bitrate<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// Report rtt from receiver.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process_rtt<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      int64_t rtt_ms<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>rtt_stats_ <span class="token operator">&amp;&amp;</span> rtcp_receiver_<span class="token punctuation">.</span><span class="token function">GetAndResetXrRrRtt</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rtt_ms<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        rtt_stats_<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">OnRttUpdate</span><span class="token punctuation">(</span>rtt_ms<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Get processed rtt.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>process_rtt<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    last_rtt_process_time_ <span class="token operator">=</span> now<span class="token punctuation">;</span>
    next_process_time_ <span class="token operator">=</span> std<span class="token operator">:</span><span class="token operator">:</span><span class="token function">min</span><span class="token punctuation">(</span>
        next_process_time_<span class="token punctuation">,</span> last_rtt_process_time_ <span class="token operator">+</span> kRtpRtcpRttProcessTimeMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rtt_stats_<span class="token punctuation">)</span> 
	<span class="token punctuation">{<!-- --></span>
		<span class="token comment">// TODO@chensong 2025-03-15  1秒更新一次 rtt    公式</span>
    
		  <span class="token comment">/*
  TODO@chensong 2025-03-15 
  加权平均RTT计算机制‌
	在实时通信场景（如WebRTC）中，RTT（往返时延）的平滑计算对网络状态感知和拥塞控制至关重要。通过 ‌加权移动平均（Weighted Moving Average）‌ 
	对RTT值进行动态调整，可有效平衡历史数据与实时测量值的影响，抑制短期波动带来的干扰。以下是核心实现逻辑：

	‌1. 公式定义‌
	‌计算方式‌：
	新平均RTT由 ‌历史平均值（old_avg）‌ 与 ‌最新测量值（new_sample）‌ 按权重合成，公式为：

	text
	Copy Code
	avg_rtt = 0.7 * old_avg + 0.3 * new_sample  
	其中，历史数据权重为70%（0.7），新样本权重为30%（0.3）‌23。

	‌数学意义‌：

	‌旧值主导（70%）‌：确保长期趋势稳定，避免偶发延迟突变（如网络抖动）对整体估计的过度影响‌23。
	‌新值补充（30%）‌：快速响应网络状态的渐进变化（如带宽增减或路由切换）‌
  */</span>
      <span class="token comment">// Make sure we have a valid RTT before setting.</span>
      int64_t last_rtt <span class="token operator">=</span> rtt_stats_<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">LastProcessedRtt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>last_rtt <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token function">set_rtt_ms</span><span class="token punctuation">(</span>last_rtt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>rtcp_sender_<span class="token punctuation">.</span><span class="token function">TimeToSendRTCPReport</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    rtcp_sender_<span class="token punctuation">.</span><span class="token function">SendRTCP</span><span class="token punctuation">(</span><span class="token function">GetFeedbackState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> kRtcpReport<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">TMMBR</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> rtcp_receiver_<span class="token punctuation">.</span><span class="token function">UpdateTmmbrTimers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    rtcp_receiver_<span class="token punctuation">.</span><span class="token function">NotifyTmmbrUpdated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="2RTCP_XR__511">
     </a>
     2、基于接收端（RTCP XR 模式）
    </h3>
    <h4>
     <a id="_RTCP_Extended_Reports_XR__RTT__512">
     </a>
     触发条件‌：接收端仅拉流（不发送媒体数据），通过 ‌RTCP Extended Reports (XR)‌ 扩展协议实现 RTT 探测‌
    </h4>
    <p>
     实现步骤‌：
    </p>
    <ol>
     <li>
      <p>
       网关发送 ‌RRTR 报文‌（含 NTP 时间戳
       <span class="katex--inline">
        <span class="katex">
         <span class="katex-mathml">
          T 
           
           
           
             R 
            
           
             R 
            
           
             T 
            
           
             R 
            
           
          
         
        
          T_{RRTR}
         </span>
         <span class="katex-html">
          <span class="base">
           <span class="strut" style="height: 0.8333em; vertical-align: -0.15em;">
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.1389em;">
             T
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.3283em;">
                <span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mtight">
                   <span class="mord mathnormal mtight" style="margin-right: 0.0077em;">
                    RRTR
                   </span>
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.15em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
       )
      </p>
     </li>
     <li>
      <p>
       接收端回复 ‌DLRR 报文‌，包含
      </p>
      <ul>
       <li>
        原
        <span class="katex--inline">
         <span class="katex">
          <span class="katex-mathml">
           T 
            
            
            
              R 
             
            
              R 
             
            
              T 
             
            
              R 
             
            
           
          
         
           T_{RRTR}
          </span>
          <span class="katex-html">
           <span class="base">
            <span class="strut" style="height: 0.8333em; vertical-align: -0.15em;">
            </span>
            <span class="mord">
             <span class="mord mathnormal" style="margin-right: 0.1389em;">
              T
             </span>
             <span class="msupsub">
              <span class="vlist-t vlist-t2">
               <span class="vlist-r">
                <span class="vlist" style="height: 0.3283em;">
                 <span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;">
                  <span class="pstrut" style="height: 2.7em;">
                  </span>
                  <span class="sizing reset-size6 size3 mtight">
                   <span class="mord mtight">
                    <span class="mord mathnormal mtight" style="margin-right: 0.0077em;">
                     RRTR
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
                <span class="vlist-s">
                 ​
                </span>
               </span>
               <span class="vlist-r">
                <span class="vlist" style="height: 0.15em;">
                 <span class="">
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
        (即为LRR)
       </li>
       <li>
        处理延迟
        <span class="katex--inline">
         <span class="katex">
          <span class="katex-mathml">
           T 
            
            
            
              D 
             
            
              L 
             
            
              S 
             
            
              R 
             
            
           
          
         
           T_{DLSR}
          </span>
          <span class="katex-html">
           <span class="base">
            <span class="strut" style="height: 0.8333em; vertical-align: -0.15em;">
            </span>
            <span class="mord">
             <span class="mord mathnormal" style="margin-right: 0.1389em;">
              T
             </span>
             <span class="msupsub">
              <span class="vlist-t vlist-t2">
               <span class="vlist-r">
                <span class="vlist" style="height: 0.3283em;">
                 <span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;">
                  <span class="pstrut" style="height: 2.7em;">
                  </span>
                  <span class="sizing reset-size6 size3 mtight">
                   <span class="mord mtight">
                    <span class="mord mathnormal mtight" style="margin-right: 0.0278em;">
                     D
                    </span>
                    <span class="mord mathnormal mtight">
                     L
                    </span>
                    <span class="mord mathnormal mtight" style="margin-right: 0.0077em;">
                     SR
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
                <span class="vlist-s">
                 ​
                </span>
               </span>
               <span class="vlist-r">
                <span class="vlist" style="height: 0.15em;">
                 <span class="">
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
        (接收 RRTR 到发送 DLRR 的时间)
       </li>
      </ul>
     </li>
     <li>
      <p>
       网关计算公式
      </p>
      <p>
       <span class="katex--inline">
        <span class="katex">
         <span class="katex-mathml">
          R 
          
         
           T 
          
         
           T 
          
         
           = 
          
          
          
            T 
           
           
           
             c 
            
           
             u 
            
           
             r 
            
           
             r 
            
           
             e 
            
           
             n 
            
           
             t 
            
           
          
         
        
          RTT = {T_{current}}
         </span>
         <span class="katex-html">
          <span class="base">
           <span class="strut" style="height: 0.6833em;">
           </span>
           <span class="mord mathnormal" style="margin-right: 0.1389em;">
            RTT
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
           <span class="mrel">
            =
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 0.8333em; vertical-align: -0.15em;">
           </span>
           <span class="mord">
            <span class="mord">
             <span class="mord mathnormal" style="margin-right: 0.1389em;">
              T
             </span>
             <span class="msupsub">
              <span class="vlist-t vlist-t2">
               <span class="vlist-r">
                <span class="vlist" style="height: 0.2806em;">
                 <span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;">
                  <span class="pstrut" style="height: 2.7em;">
                  </span>
                  <span class="sizing reset-size6 size3 mtight">
                   <span class="mord mtight">
                    <span class="mord mathnormal mtight">
                     c
                    </span>
                    <span class="mord mathnormal mtight">
                     u
                    </span>
                    <span class="mord mathnormal mtight">
                     rre
                    </span>
                    <span class="mord mathnormal mtight">
                     n
                    </span>
                    <span class="mord mathnormal mtight">
                     t
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
                <span class="vlist-s">
                 ​
                </span>
               </span>
               <span class="vlist-r">
                <span class="vlist" style="height: 0.15em;">
                 <span class="">
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
       -
       <span class="katex--inline">
        <span class="katex">
         <span class="katex-mathml">
          T 
           
           
           
             T 
            
           
             R 
            
           
             R 
            
           
          
         
        
          {T_{TRR}}
         </span>
         <span class="katex-html">
          <span class="base">
           <span class="strut" style="height: 0.8333em; vertical-align: -0.15em;">
           </span>
           <span class="mord">
            <span class="mord">
             <span class="mord mathnormal" style="margin-right: 0.1389em;">
              T
             </span>
             <span class="msupsub">
              <span class="vlist-t vlist-t2">
               <span class="vlist-r">
                <span class="vlist" style="height: 0.3283em;">
                 <span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;">
                  <span class="pstrut" style="height: 2.7em;">
                  </span>
                  <span class="sizing reset-size6 size3 mtight">
                   <span class="mord mtight">
                    <span class="mord mathnormal mtight" style="margin-right: 0.0077em;">
                     TRR
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
                <span class="vlist-s">
                 ​
                </span>
               </span>
               <span class="vlist-r">
                <span class="vlist" style="height: 0.15em;">
                 <span class="">
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
       -
       <span class="katex--inline">
        <span class="katex">
         <span class="katex-mathml">
          T 
           
           
           
             D 
            
           
             L 
            
           
             S 
            
           
             R 
            
           
          
         
        
          {T_{DLSR}}
         </span>
         <span class="katex-html">
          <span class="base">
           <span class="strut" style="height: 0.8333em; vertical-align: -0.15em;">
           </span>
           <span class="mord">
            <span class="mord">
             <span class="mord mathnormal" style="margin-right: 0.1389em;">
              T
             </span>
             <span class="msupsub">
              <span class="vlist-t vlist-t2">
               <span class="vlist-r">
                <span class="vlist" style="height: 0.3283em;">
                 <span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;">
                  <span class="pstrut" style="height: 2.7em;">
                  </span>
                  <span class="sizing reset-size6 size3 mtight">
                   <span class="mord mtight">
                    <span class="mord mathnormal mtight" style="margin-right: 0.0278em;">
                     D
                    </span>
                    <span class="mord mathnormal mtight">
                     L
                    </span>
                    <span class="mord mathnormal mtight" style="margin-right: 0.0077em;">
                     SR
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
                <span class="vlist-s">
                 ​
                </span>
               </span>
               <span class="vlist-r">
                <span class="vlist" style="height: 0.15em;">
                 <span class="">
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </p>
     </li>
    </ol>
    <h2>
     <a id="RTT_525">
     </a>
     二、网络质量评估算法之时延加权平均RTT计算机制‌
    </h2>
    <p>
     加权平均RTT计算机制‌
     <br/>
     在实时通信场景（如WebRTC）中，RTT（往返时延）的平滑计算对网络状态感知和拥塞控制至关重要。通过 ‌加权移动平均（Weighted Moving Average）‌
     <br/>
     对RTT值进行动态调整，可有效平衡历史数据与实时测量值的影响，抑制短期波动带来的干扰。以下是核心实现逻辑：
    </p>
    <pre><code>‌1. 公式定义‌

‌计算方式‌：

新平均RTT由 ‌历史平均值（old_avg）‌ 与 ‌最新测量值（new_sample）‌ 按权重合成，公式为：


avg_rtt = 0.7 * old_avg + 0.3 * new_sample  

其中，历史数据权重为70%（0.7），新样本权重为30%（0.3）‌23。

‌数学意义‌：

‌旧值主导（70%）‌：确保长期趋势稳定，避免偶发延迟突变（如网络抖动）对整体估计的过度影响‌23。

‌新值补充（30%）‌：快速响应网络状态的渐进变化（如带宽增减或路由切换）‌
</code></pre>
    <h2>
     <a id="_rtprtcp_WebRTCrtt_549">
     </a>
     三、 rtp和rtcp发送包列表数据保存时间 （WebRTC根据rtt计算的）
    </h2>
    <pre><code class="prism language-javascript">

<span class="token keyword">void</span> <span class="token literal-property property">RtpPacketHistory</span><span class="token operator">:</span><span class="token operator">:</span><span class="token function">CullOldPackets</span><span class="token punctuation">(</span><span class="token parameter">int64_t now_ms</span><span class="token punctuation">)</span> 
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//TODO@chensong 2025-03-15 比如NACK（否定确认）或ARQ（自动重传请求）中的缓冲区管理策略有关。</span>
	<span class="token comment">//  根据 rtt 放弃 rtp包 </span>
	<span class="token comment">// 公式 ： 淘汰时间 = 3 × max(基准时间, 3 × 当前RTT)</span>
    <span class="token comment">// 基准时间通常为 1000ms（兜底值，防止 RTT 过小导致缓存不足）</span>
  int64_t packet_duration_ms <span class="token operator">=</span> std<span class="token operator">:</span><span class="token operator">:</span><span class="token function">max</span><span class="token punctuation">(</span>kMinPacketDurationRtt <span class="token operator">*</span> rtt_ms_<span class="token punctuation">,</span> kMinPacketDurationMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>packet_history_<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    auto stored_packet_it <span class="token operator">=</span> packet_history_<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token operator">*</span>start_seqno_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token constant">RTC_DCHECK</span><span class="token punctuation">(</span>stored_packet_it <span class="token operator">!=</span> packet_history_<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>packet_history_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> kMaxCapacity <span class="token comment">/* 9600*/</span><span class="token punctuation">)</span> 
	<span class="token punctuation">{<!-- --></span>
      <span class="token comment">// We have reached the absolute max capacity, remove one packet</span>
      <span class="token comment">// unconditionally.</span>
      <span class="token function">RemovePacket</span><span class="token punctuation">(</span>stored_packet_it<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> StoredPacket<span class="token operator">&amp;</span> stored_packet <span class="token operator">=</span> stored_packet_it<span class="token operator">-</span><span class="token operator">&gt;</span>second<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>stored_packet<span class="token punctuation">.</span>send_time_ms<span class="token punctuation">)</span> 
	<span class="token punctuation">{<!-- --></span>
      <span class="token comment">// Don't remove packets that have not been sent.</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>stored_packet<span class="token punctuation">.</span>send_time_ms <span class="token operator">+</span> packet_duration_ms <span class="token operator">&gt;</span> now_ms<span class="token punctuation">)</span> 
	<span class="token punctuation">{<!-- --></span>
      <span class="token comment">// Don't cull packets too early to avoid failed retransmission requests.</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>packet_history_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> number_to_store_ <span class="token operator">||</span>
        <span class="token punctuation">(</span>mode_ <span class="token operator">==</span> StorageMode<span class="token operator">:</span><span class="token operator">:</span>kStoreAndCull <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span>stored_packet<span class="token punctuation">.</span>send_time_ms <span class="token operator">+</span> <span class="token punctuation">(</span>packet_duration_ms <span class="token operator">*</span> kPacketCullingDelayFactor<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> now_ms<span class="token punctuation">)</span><span class="token punctuation">)</span> 
	<span class="token punctuation">{<!-- --></span>
      <span class="token comment">// Too many packets in history, or this packet has timed out. Remove it</span>
      <span class="token comment">// and continue.</span>
      <span class="token function">RemovePacket</span><span class="token punctuation">(</span>stored_packet_it<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token keyword">else</span> 
	<span class="token punctuation">{<!-- --></span>
      <span class="token comment">// No more packets can be removed right now.</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="687474:70733a2f2f626c6f672e6373646e2e6e65742f506f6973782f:61727469636c652f64657461696c732f313436323834383637" class_="artid" style="display:none">
 </p>
</div>


