---
layout: post
title: "Ansible-自动化运维"
date: 2025-03-15 23:03:58 +0800
description: "2.1安装 EPEL 源：sudo dnf install epel-release。"
keywords: "Ansible 自动化运维"
categories: ['Linux']
tags: ['运维', '自动化', 'Ansible']
artid: "146286145"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146286145
    alt: "Ansible-自动化运维"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146286145
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146286145
cover: https://bing.ee123.net/img/rand?artid=146286145
image: https://bing.ee123.net/img/rand?artid=146286145
img: https://bing.ee123.net/img/rand?artid=146286145
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Ansible 自动化运维
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <p>
    </p>
    <p>
     Ansible架构:
    </p>
    <p>
     <img alt="" height="461" src="https://i-blog.csdnimg.cn/direct/32dd0cbcf790492e89d8998fc6149b61.png" width="949"/>
    </p>
    <h2>
     <strong>
      一.部署主机清单 前期环境准备:
     </strong>
    </h2>
    <p>
     管理端:
    </p>
    <p>
     192.168.60.128
    </p>
    <p>
     被管理端:
    </p>
    <p>
     client1:192.168.60.129
    </p>
    <p>
     client2:192.168.60.131
    </p>
    <h4>
     <span style="color:#0d0016">
      <span style="background-color:#eaf4fc">
       1.1 所有被管理端配置ssh密钥   (1.免密登陆   2.允许root远程登陆) 脚本如下:
      </span>
     </span>
    </h4>
    <pre><code class="language-bash">#!/bin/bash

# 检查 sshpass 是否已安装
if ! command -v sshpass &amp;&gt; /dev/null; then
    echo "请先安装 sshpass 工具！"
    exit 1
fi

# 固定的 IP 地址列表
ip_list="192.168.60.129 192.168.60.131"

# 检查并生成 SSH 密钥
if [ ! -f ~/.ssh/id_rsa ]; then
    echo '----------------'
    echo '1. 创建 key'
    echo '----------------'
    if ! ssh-keygen -f ~/.ssh/id_rsa -t rsa -P ''; then
        echo "生成 SSH 密钥失败！"
        exit 1
    fi
else
    echo "SSH 密钥已存在，跳过生成步骤。"
fi

echo '----------------'
echo '2. 分发 key'
echo '----------------'

for ip in $ip_list; do
    echo "----------------"
    echo "分发 key 到 $ip"
    echo "----------------"
    if sshpass -p2004129 ssh-copy-id -i ~/.ssh/id_rsa.pub -o StrictHostKeyChecking=no root@$ip; then
        echo "分发公钥到 $ip 成功！"
    else
        echo "分发公钥到 $ip 失败！"
    fi
done</code></pre>
    <p>
     运行效果:
    </p>
    <p>
     <img alt="" height="436" src="https://i-blog.csdnimg.cn/direct/e87c3de766574176a684612cf630475b.png" width="1433"/>
    </p>
    <h4>
     <strong>
      1.2 控制端安装ansible
     </strong>
    </h4>
    <p>
     <span style="color:#fe2c24">
      2.1安装 EPEL 源：
      <span style="background-color:#38d8f0">
       sudo dnf install epel-release
      </span>
     </span>
    </p>
    <p>
     sudo dnf install ansible
    </p>
    <p>
     ansible --version
    </p>
    <p>
     ok~~~~~~~~~~~~~~~~~~~~~~~~~~~
    </p>
    <p>
     <img alt="" height="225" src="https://i-blog.csdnimg.cn/direct/41bf973afdae43758b87333060c03980.png" width="1418"/>
    </p>
    <p>
     <strong>
      3.安装完成之后  配置主机清单~   配置文件地址:
      <span style="background-color:#d4e9d5">
       /etc/ansible/hosts
      </span>
     </strong>
    </p>
    <p>
     <span style="background-color:#d4e9d5">
      [Server1]  为组名    将.129   和.131分配在一个组~~~~~~~~~~
     </span>
    </p>
    <p>
     <img alt="" height="264" src="https://i-blog.csdnimg.cn/direct/15c9d1b98e1c43958fd09ad76f363a38.png" width="846"/>
    </p>
    <p>
     4.测试使用:
    </p>
    <p>
     <span style="color:#956fe7">
      测试1
     </span>
     # ansible Server1 -m ping     //测试主机是否通~~~~~~~~
    </p>
    <p>
     出现
     <span style="color:#1c7331">
      绿色
     </span>
     就说明通了~~~~~~
     <img alt="" height="439" src="https://i-blog.csdnimg.cn/direct/5a82120eaf72466e835779c1ac45933a.png" width="1217"/>
    </p>
    <p>
     <span style="color:#956fe7">
      测试2
     </span>
     # ansible Server1 -m command - a 'hostname'    // -m 指定模块    -a 执行的命令     command命令执行模块
    </p>
    <p>
     <img alt="" height="178" src="https://i-blog.csdnimg.cn/direct/fd5d894adaab4cf0903a343704473681.png" width="1170"/>
    </p>
    <p>
     <span style="color:#956fe7">
      测试3 #
     </span>
     ansible Server1 -m shell -a 'ip addr | grep inet'
    </p>
    <p>
     <span style="color:#ff9900">
      <strong>
       注意command不能识别管道!!!!!!
      </strong>
     </span>
    </p>
    <p>
     <img alt="" height="386" src="https://i-blog.csdnimg.cn/direct/746db6282f5f4f28bf2f66d5564d63a6.png" width="1540"/>
    </p>
    <p>
    </p>
    <h4>
     <strong>
      1.3 ansible 核心配置文件:
     </strong>
    </h4>
    <p>
     就最前面这两个
    </p>
    <p>
     ansible.cfg  # ansible核心配置文件
    </p>
    <p>
     <img alt="" height="96" src="https://i-blog.csdnimg.cn/direct/223d4203023c447a86f44cfc9585b8c7.png" width="1005"/>
    </p>
    <p>
    </p>
    <p>
     hosts  #主机清单
    </p>
    <p>
     如何设置子组（就是将多个组 合并在一个组）
    </p>
    <p>
     在host文件下这样写:
    </p>
    <p>
     [data:children]     // children关键字
    </p>
    <p>
     组名
    </p>
    <p>
     组名
    </p>
    <p>
     ~n
    </p>
    <p>
     <img alt="" height="317" src="https://i-blog.csdnimg.cn/direct/ee31c6f6d6624473988d7979222024ae.png" width="960"/>
    </p>
    <p>
     测试一下看
    </p>
    <p>
     # ansible data -m ping
    </p>
    <p>
     <img alt="" height="450" src="https://i-blog.csdnimg.cn/direct/46e3866300df4eba909c1b4765582508.png" width="1365"/>
    </p>
    <p>
     测试所有主机是否ping通
    </p>
    <p>
     # ansible all -m ping
    </p>
    <p>
     <img alt="" height="427" src="https://i-blog.csdnimg.cn/direct/74b5ec5c20544232bb686ba090c05189.png" width="1139"/>
    </p>
    <p>
     <strong>
      ansibel核心模块
     </strong>
    </p>
    <p>
     <img alt="" height="753" src="https://i-blog.csdnimg.cn/direct/02347cb5fb5c4cc6b6a593ec9ccae24f.png" width="1142"/>
    </p>
    <p>
     如何查询命令帮助:
     <span style="color:#fe2c24">
      ansible-doc -s command
     </span>
    </p>
    <p>
     <span style="color:#fe2c24">
      ansible官方文档:
     </span>
     <a href="https://docs.ansible.com/" rel="nofollow" title="Ansible Documentation">
      Ansible Documentation
     </a>
    </p>
    <p>
     <img alt="" height="531" src="https://i-blog.csdnimg.cn/direct/630fe73287b541fca0185568bf9fccdc.png" width="1596"/>
    </p>
    <p>
     模块使用:
    </p>
    <h2>
     <strong>
      二.命令脚本相关模块
     </strong>
    </h2>
    <p>
     <span style="color:#fe2c24">
      <strong>
       1.command
      </strong>
     </span>
     支持简单的命令
     <span style="color:#fe2c24">
      不支持管道符号
     </span>
     ！！！！ 默认模块  不写 也是他
    </p>
    <p>
     ansible all -m command -a '命令'
    </p>
    <p>
    </p>
    <p>
     <span style="color:#fe2c24">
      <strong>
       2.shell模块
      </strong>
     </span>
     支持  一些特殊的符号！
    </p>
    <p>
     ansible all -m shell -a 'ip a s ens160 | grep inet'
    </p>
    <p>
     <img alt="" height="226" src="https://i-blog.csdnimg.cn/direct/9df201f96f73463ea4ed117b66658dc2.png" width="1306"/>
    </p>
    <p>
    </p>
    <p>
     <span style="color:#fe2c24">
      <strong>
       3.script模块  传输
      </strong>
     </span>
     <span style="color:#0d0016">
      脚本到被管理端   并
     </span>
     <span style="color:#fe2c24">
      执行
     </span>
    </p>
    <p>
     <span style="color:#0d0016">
      3.1比如我们在管理端写一个安装nmap软件脚本
     </span>
    </p>
    <p>
     <span style="color:#0d0016">
      脚本内容  名称:
     </span>
    </p>
    <p>
     <img alt="" height="187" src="https://i-blog.csdnimg.cn/direct/54c6948b85c142c2af26c938e696529d.png" width="1081"/>
    </p>
    <p>
     <span style="color:#0d0016">
      执行命令:
     </span>
     <span style="color:#0d0016">
      ansible all -m script -a '/home/test/script-ans/nmapins.sh'
     </span>
    </p>
    <p>
     <img alt="" height="446" src="https://i-blog.csdnimg.cn/direct/ab9b6fff284c44b2829ad31c2b351f74.png" width="1447"/>
    </p>
    <p>
     看一下被控端受否安装(直接在管理端测试nmap这个工具)
    </p>
    <p>
     ansible all -m shell -a 'nmap localhost'
    </p>
    <p>
     <img alt="" height="533" src="https://i-blog.csdnimg.cn/direct/7aa7991a7070416f92b324c32a94fac3.png" width="1068"/>
    </p>
    <p>
    </p>
    <h2 style="background-color:transparent">
     二.文件相关模块
    </h2>
    <p>
     <img alt="" height="201" src="https://i-blog.csdnimg.cn/direct/ead954633f4b42568aa04538893f744a.png" width="755"/>
    </p>
    <h4>
     2.1创建目录和文件
    </h4>
    <p>
     <img alt="" height="358" src="https://i-blog.csdnimg.cn/direct/5639bd6cba764c7b8ae0b2f7f8a295f8.png" width="1298"/>
    </p>
    <p>
     目录:ansible all -m file -a 'path=/home/ansible-test state=directory'
    </p>
    <p>
     <img alt="" height="336" src="https://i-blog.csdnimg.cn/direct/c26c5b7bac5246bfb00fd5dd870b6e80.png" width="910"/>
    </p>
    <p>
     文件:ansible all -m file -a 'path=/home/ansible-test/hello.txt state=touch'
    </p>
    <p>
     <img alt="" height="366" src="https://i-blog.csdnimg.cn/direct/d36af26ca34444a6952b4811d2c1f09d.png" width="940"/>
    </p>
    <p>
    </p>
    <h4>
     2.2创建软连接
    </h4>
    <p>
     ansible all -m file -a 'src=/home/ansible-test/hello.txt path=/home/test/hello.txt.soft state=link'
    </p>
    <p>
     <img alt="" height="428" src="https://i-blog.csdnimg.cn/direct/541f50c548f24cb39a0d5f4831d20d6c.png" width="1161"/>
    </p>
    <p>
     看看是否成功:ansible all -a 'ls -l /home/test'
    </p>
    <p>
     <img alt="" height="214" src="https://i-blog.csdnimg.cn/direct/60c3dc60d94748a98c4915d7aff42c7c.png" width="1092"/>
    </p>
    <p>
    </p>
    <p>
     删除(都是加一个参数就可以
     <span style="color:#fe2c24">
      state=ansent
     </span>
     ）
    </p>
    <p>
     删除一个文件:ansible all -m file -a 'path=/home/ansible-test/hello.txt state=absent'
    </p>
    <p>
     注意是:state=absent   不是
     <span style="color:#fe2c24">
      state：absent
     </span>
    </p>
    <p>
     <img alt="" height="302" src="https://i-blog.csdnimg.cn/direct/d522b1ae318c452692624f08942387c9.png" width="1231"/>
    </p>
    <p>
    </p>
    <h4>
     案例:创建一个txt文件 所有者是:root   组:root   权限:755
    </h4>
    <p>
     ansible all -m file -a 'path=/tmp/xxw.txt state=touch group=root owner=root'
    </p>
    <p>
     <img alt="" height="326" src="https://i-blog.csdnimg.cn/direct/70447900d07e40fbae6c2053b59863af.png" width="1188"/>
    </p>
    <p>
    </p>
    <h2>
     三. 文件传输copy模块
    </h2>
    <p>
     <img alt="" height="246" src="https://i-blog.csdnimg.cn/direct/2564ab521ed344da97489f55aec5718f.png" width="785"/>
    </p>
    <p>
    </p>
    <p>
    </p>
    <p>
    </p>
    <p>
    </p>
    <p>
    </p>
    <p>
    </p>
    <p>
    </p>
    <p>
    </p>
    <p>
    </p>
    <p>
    </p>
   </div>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f34373833303737342f:61727469636c652f64657461696c732f313436323836313435" class_="artid" style="display:none">
 </p>
</div>


