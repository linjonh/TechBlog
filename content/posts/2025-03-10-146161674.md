---
layout: post
title: "Smart-contract-自毁合约"
date: 2025-03-10 19:26:25 +0800
description: "函数是 Solidity 提供的一个强大工具，用于销毁合约并回收资源。在使用时，需要谨慎考虑合约的状态和资金处理，确保自毁操作符合预期且不会导致问题。通过合理的设计和应用场景，自毁合约可以在区块链开发中发挥重要作用，为智能合约的生命周期管理提供灵活性和安全性。"
keywords: "Smart contract -- 自毁合约"
categories: ['智能合约', '区块链应用搭建', 'Solidity']
tags: ['智能合约', '区块链']
artid: "146161674"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146161674
    alt: "Smart-contract-自毁合约"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146161674
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146161674
cover: https://bing.ee123.net/img/rand?artid=146161674
image: https://bing.ee123.net/img/rand?artid=146161674
img: https://bing.ee123.net/img/rand?artid=146161674
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Smart contract -- 自毁合约
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <p>
     在区块链开发中，Solidity 语言提供了强大的功能，其中自毁合约是一个独特且重要的特性。今天，就让我们深入探讨一下 Solidity 中的自毁合约，以及如何使用
     <code>
      selfdestruct
     </code>
     函数。
    </p>
    <p>
     <strong>
      注意：
     </strong>
     使用继承时请确保代码的正确性，以防丢失个人财产，在这里友情提示您，不要复制来源不明的solidity代码并进行部署。本文为自己梳理总结，如有不足还请指出，感谢包容。
    </p>
    <p>
     学习更多solidity知识请访问
     <a class="link-info" href="https://github.com/Daik1018/Solidity" title="Github -- solidity">
      Github -- solidity
     </a>
     基础 ，更多实例在
     <a class="link-info" href="https://github.com/Daik1018/Solidity" title="Smart contract">
      Smart contract
     </a>
    </p>
    <p>
    </p>
    <h3>
     一、自毁合约的概念
    </h3>
    <p>
     一种具有自我终结能力的智能合约。自毁合约，顾名思义，是指合约在执行过程中，可以主动销毁自身。一旦合约自毁，其占用的存储空间将被释放，同时可以将剩余的以太币发送到指定地址。这一功能在某些特定场景下非常有用，比如当合约完成其使命，或者需要紧急停止合约运行并回收资源时。
    </p>
    <p>
     当满足特定条件时，合约可以调用
     <code>
      selfdestruct
     </code>
     函数，这将导致合约从以太坊区块链上永久删除。合约的存储数据将被清除，并且其关联的代码也不再存在。同时，合约剩余的以太币余额会被发送到指定的接收地址。
    </p>
    <p>
    </p>
    <h3>
     二、自毁合约的用途
    </h3>
    <ol>
     <li>
      <p>
       <strong>
        资金清算
       </strong>
       ：当一个项目结束或合约不再需要时，可以使用自毁合约将剩余资金返还给所有者或特定的受益人。例如，一个众筹合约在达到目标金额并完成项目交付后，可能会选择自毁并将剩余资金退还给参与者。
      </p>
     </li>
     <li>
      <p>
       <strong>
        安全考量
       </strong>
       ：在某些情况下，如果发现合约存在严重漏洞或安全隐患，自毁合约可以作为一种紧急措施，防止黑客进一步攻击和窃取资金。通过自毁合约，可以迅速停止合约的运行，并将资金转移到安全地址。
      </p>
     </li>
     <li>
      <p>
       <strong>
        合约升级与替换
       </strong>
       ：在智能合约的开发过程中，可能需要对合约进行升级以添加新功能或修复漏洞。旧版本的合约可以通过自毁的方式，将资金和相关状态转移到新版本的合约中，实现平滑过渡。
      </p>
     </li>
    </ol>
    <p>
    </p>
    <h3>
     三、selfdestruct 函数的用法
    </h3>
    <p>
     <code>
      selfdestruct
     </code>
     是 Solidity 提供的一个内置函数，用于销毁当前合约。它的语法如下：
    </p>
    <pre><code>selfdestruct(address payable recipient)</code></pre>
    <p>
     其中，
     <code>
      recipient
     </code>
     是接收合约剩余以太币的地址，且该地址必须是
     <code>
      payable
     </code>
     类型，这意味着它能够接收以太币。
    </p>
    <h3>
    </h3>
    <h3>
     四、示例代码解析
    </h3>
    <p>
     下面是一个简单的自毁合约示例：
    </p>
    <pre><code>// SPDX-License-Identifier: MIT
pragma solidity ^0.8.8;

contract SelfDestructContract {
    constructor() payable {}

    function destroySelf() external {
        selfdestruct(payable(msg.sender));
    }

    function testCall() external pure returns (uint) {
        return 123;
    }
}</code></pre>
    <h4>
     合约说明
    </h4>
    <ol>
     <li>
      <p>
       <strong>
        构造函数
       </strong>
       ：
       <code>
        constructor() payable
       </code>
       表示合约部署时可以接收以太币。
      </p>
     </li>
     <li>
      <p>
       <strong>
        destroySelf 函数
       </strong>
       ：这是自毁函数，当被外部调用时，会销毁合约，并将合约中的剩余以太币发送给调用者（
       <code>
        msg.sender
       </code>
       ）。注意，
       <code>
        msg.sender
       </code>
       需要被转换为
       <code>
        payable
       </code>
       类型。
      </p>
     </li>
     <li>
      <p>
       <strong>
        testCall 函数
       </strong>
       ：一个简单的测试函数，用于演示合约在自毁前后的状态变化。
      </p>
     </li>
    </ol>
    <h3>
    </h3>
    <h3>
     五、使用场景与注意事项
    </h3>
    <h4>
     使用场景
    </h4>
    <ul>
     <li>
      <p>
       <strong>
        紧急停止
       </strong>
       ：当合约出现安全漏洞或紧急情况时，可以通过自毁合约来停止其运行，防止进一步的损失。
      </p>
     </li>
     <li>
      <p>
       <strong>
        资源回收
       </strong>
       ：当合约完成其任务后，自毁可以释放区块链上的存储空间，并将剩余资金返还给指定地址。
      </p>
     </li>
    </ul>
    <h4>
     注意事项
    </h4>
    <ul>
     <li>
      <p>
       <strong>
        不可逆性
       </strong>
       ：合约一旦自毁，将无法恢复。因此，在调用
       <code>
        selfdestruct
       </code>
       之前，必须确保这是合约的最终状态。
      </p>
     </li>
     <li>
      <p>
       <strong>
        资金处理
       </strong>
       ：自毁时，合约中的剩余资金会发送到指定地址。需要确保该地址能够正确接收和处理这些资金。
      </p>
     </li>
     <li>
      <p>
       <strong>
        状态变化
       </strong>
       ：自毁后，合约中的所有状态变量和存储数据都将被清除。
      </p>
     </li>
    </ul>
    <h3>
    </h3>
    <h3>
     六、实际应用示例
    </h3>
    <p>
     假设我们有一个限时任务合约，任务完成后合约自动销毁，并将剩余资金返还给创建者。以下是实现这一功能的代码：
    </p>
    <pre><code>// SPDX-License-Identifier: MIT
pragma solidity ^0.8.8;

contract TaskContract {
    address payable public owner;
    uint public deadline;

    constructor(uint _duration) payable {
        owner = payable(msg.sender);
        deadline = block.timestamp + _duration;
    }

    function performTask() external {
        // 执行任务的逻辑
    }

    function withdraw() external {
        require(msg.sender == owner, "Only owner can withdraw");
        payable(owner).transfer(address(this).balance);
    }

    function destroyContract() external {
        require(block.timestamp &gt;= deadline || msg.sender == owner, "Cannot destroy yet");
        selfdestruct(owner);
    }
}</code></pre>
    <h4>
     合约说明
    </h4>
    <ol>
     <li>
      <p>
       <strong>
        构造函数
       </strong>
       ：部署合约时，指定任务的持续时间
       <code>
        _duration
       </code>
       ，并将创建者设置为所有者
       <code>
        owner
       </code>
       。
      </p>
     </li>
     <li>
      <p>
       <strong>
        performTask 函数
       </strong>
       ：用于执行任务的逻辑。
      </p>
     </li>
     <li>
      <p>
       <strong>
        withdraw 函数
       </strong>
       ：允许所有者提取合约中的资金。
      </p>
     </li>
     <li>
      <p>
       <strong>
        destroyContract 函数
       </strong>
       ：在任务超时或所有者主动调用时，销毁合约，并将剩余资金发送给所有者。
      </p>
     </li>
    </ol>
    <h3>
    </h3>
    <p>
     以下是一个完整的自毁合约示例：
    </p>
    <pre><code>// SPDX-License-Identifier: MIT
pragma solidity ^0.8.8;

// 修改合约名称为 SelfDestructContract
contract SelfDestructContract {
    constructor() payable {}

    // 修改函数名称为 destroySelf
    function destroySelf() external {
        selfdestruct(payable(msg.sender));
        //必须是payable类型，默认是没有的
    }

    //一旦调用就会把剩下的主币发送到sender的账户上
    //自毁的意思也就是说强制把剩下的主币发送到需要的账户上，如果没有会进行报错

    function testCall() external pure returns (uint) {
        return 123;
    }
}
</code></pre>
    <p>
    </p>
    <p>
     在这个合约中，
     <code>
      SelfDestructContract
     </code>
     包含一个构造函数，允许在部署合约时向合约转入资金。
     <code>
      destroySelf
     </code>
     函数是实现自毁功能的关键，当外部调用
     <code>
      destroySelf
     </code>
     时，合约将调用
     <code>
      selfdestruct
     </code>
     函数，并将合约的剩余资金发送给调用者（
     <code>
      msg.sender
     </code>
     ）。
     <code>
      testCall
     </code>
     函数是一个简单的示例函数，用于返回一个固定的整数值，与自毁功能并无直接关联。
    </p>
    <p>
     假设 Alice 部署了这个合约，并向合约转入了 10 以太币。在某个时刻，Alice 决定销毁合约并收回资金，她只需调用合约的
     <code>
      destroySelf
     </code>
     函数。此时，合约将从区块链上删除，而 10 以太币将被发送回 Alice 的账户。
    </p>
    <p>
    </p>
    <h3>
     七、注意事项
    </h3>
    <ol>
     <li>
      <p>
       <strong>
        不可逆操作
       </strong>
       ：自毁合约是不可逆的，一旦执行，合约将永久消失，无法恢复。因此，在调用
       <code>
        selfdestruct
       </code>
       之前，务必仔细确认所有条件和后果。
      </p>
     </li>
     <li>
      <p>
       <strong>
        安全风险
       </strong>
       ：由于自毁合约涉及资金转移，需要确保接收资金的地址是安全可靠的。如果将资金发送到一个错误或被黑客控制的地址，资金将面临损失风险。
      </p>
     </li>
     <li>
      <p>
       <strong>
        Gas 费用
       </strong>
       ：执行
       <code>
        selfdestruct
       </code>
       操作需要消耗一定的 Gas 费用。在设计合约时，需要考虑合约的余额是否足够支付 Gas 费用，以确保自毁操作能够成功执行。
      </p>
     </li>
    </ol>
    <p>
    </p>
    <h3>
     八、总结
    </h3>
    <p>
     <code>
      selfdestruct
     </code>
     函数是 Solidity 提供的一个强大工具，用于销毁合约并回收资源。在使用时，需要谨慎考虑合约的状态和资金处理，确保自毁操作符合预期且不会导致问题。通过合理的设计和应用场景，自毁合约可以在区块链开发中发挥重要作用，为智能合约的生命周期管理提供灵活性和安全性。
    </p>
    <p>
    </p>
   </div>
  </div>
 </article>
 <p alt="68747470733a2f:2f626c6f672e6373646e2e6e65742f44616c696b313031382f:61727469636c652f64657461696c732f313436313631363734" class_="artid" style="display:none">
 </p>
</div>


