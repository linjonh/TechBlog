---
layout: post
title: "ubuntu-解决-DNS-代理设置错误,导致不能上网的-DoHDoT问题"
date: 2025-03-10 22:07:03 +0800
description: "ubuntu 解决DNS 代理设置错误，导致不能上网的问题"
keywords: "ubuntu 解决 DNS 代理设置错误，导致不能上网的 DoH、DoT问题"
categories: ['网络']
tags: ['运维', 'Ubuntu', 'Linux']
artid: "146165322"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146165322
    alt: "ubuntu-解决-DNS-代理设置错误,导致不能上网的-DoHDoT问题"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146165322
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146165322
cover: https://bing.ee123.net/img/rand?artid=146165322
image: https://bing.ee123.net/img/rand?artid=146165322
img: https://bing.ee123.net/img/rand?artid=146165322
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     ubuntu 解决 DNS 代理设置错误，导致不能上网的 DoH、DoT问题
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <p>
    </p>
    <p>
     老旧的 udp dns明文查询，早就被 doh ，dot取代了。优选 doh，更自在。
    </p>
    <p>
     但目前的现状是 3种 DNS 传输协议 udp / doh / dot 同时存在。
    </p>
    <blockquote>
     <h5>
      未来，如何选择？
     </h5>
     <ul>
      <li>
       测试： udp dns：简单方便
      </li>
      <li>
       内网：dot：方便管理
      </li>
      <li>
       外网：doh，DoQ 自在
      </li>
     </ul>
     <p>
      DoQ (DNS over QUIC)：
     </p>
     <p>
      DoQ是一种新兴的技术，它结合了DNS查询和QUIC协议的优势。QUIC是一个
      <span style="color:#b95514">
       基于UDP的
      </span>
      多路复用传输协议，它减少了连接建立时间，并提供了
      <span style="color:#b95514">
       更好的性能
      </span>
      <span style="color:#333333">
       和
      </span>
      <span style="color:#b95514">
       加密支持
      </span>
      。DoQ旨在进一步提升DNS查询的效率和隐私性。
      <a href="https://www.dnswiki.cn/index.php?title=DoH,_DoT,_DoQ_%E7%9A%84%E5%8C%BA%E5%88%AB" rel="nofollow" title="DoH, DoT, DoQ 的区别 - DNS-WIKI">
       DoH, DoT, DoQ 的区别 - DNS-WIKI
      </a>
     </p>
     <p>
      再未来 DoX ：变是永远的不变。
     </p>
     <h3>
      优缺点
     </h3>
     <ul>
      <li>
       DNS
       <ul>
        <li>
         优点：原生支持，广泛部署，无需额外配置。
        </li>
        <li>
         缺点：明文传输，容易受到篡改和监听。
        </li>
       </ul>
      </li>
      <li>
       DoH
       <ul>
        <li>
         优点：与HTTPS流量不可区分，难以被审查，易于绕过某些网络限制。
        </li>
        <li>
         缺点：可能与现有的网络基础设施（如中间件、缓存）存在兼容性问题。
        </li>
       </ul>
      </li>
      <li>
       DoT
       <ul>
        <li>
         优点：设计简洁，易于实现，提供端到端加密。
        </li>
        <li>
         缺点：可被ISP或网络防火墙识别并阻止，因为使用了专用端口。
        </li>
       </ul>
      </li>
      <li>
       DoQ
       <ul>
        <li>
         优点：减少连接延迟，提高传输效率，支持并发请求。
        </li>
        <li>
         缺点：目前支持度不广，需要进一步测试和部署。
        </li>
       </ul>
      </li>
     </ul>
    </blockquote>
    <p>
     1.
    </p>
    <blockquote>
     <p>
      abc@mpc:~$ sudo netstat -tulnp | grep ':53'
      <br/>
      tcp6       0      0 :::53                   :::*                    LISTEN      1/init
      <br/>
      udp        0      0 0.0.0.0:5353            0.0.0.0:*                           662/avahi-daemon: r
      <br/>
      udp6       0      0 :::53                   :::*                                1/init
      <br/>
      udp6       0      0 :::5353                 :::*                                662/avahi-daemon: r
     </p>
     <p>
      #
     </p>
     <p>
      # 由于53 端口已经被占用了，所以运行下面 3句，是不会改变上面的结果的。
     </p>
     <p>
      abc@mpc:~$ sudo systemctl stop systemd-resolved
      <br/>
      abc@mpc:~$ sudo systemctl start systemd-resolved
     </p>
    </blockquote>
    <p>
     2.
    </p>
    <blockquote>
     <p>
      abc@mpc:~$ sudo lsof -i:53
      <br/>
      COMMAND    PID             USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
      <br/>
      systemd      1             root   67u  IPv6   8304      0t0  UDP *:domain
      <br/>
      systemd      1             root   68u  IPv6   6829      0t0  TCP *:domain (LISTEN)
      <br/>
      systemd-t  554 systemd-timesync   12u  IPv4  50483      0t0  UDP localhost:58362-&gt;127.0.0.53:domain
      <br/>
      dnss       673             dnss    3u  IPv6   6829      0t0  TCP *:domain (LISTEN)
      <br/>
      <span style="color:#b95514">
       <strong>
        dnss
       </strong>
      </span>
      673             dnss    8u  IPv6   6829      0t0  TCP *:domain (LISTEN)
      <br/>
      dnss       673             dnss    9u  IPv6   8304      0t0  UDP *:domain
      <br/>
      snapd      692             root   17u  IPv4  51454      0t0  UDP localhost:36633-&gt;127.0.0.53:domain
      <br/>
      firefox   4322             test   18u  IPv4  53266      0t0  UDP localhost:33606-&gt;127.0.0.53:domain
      <br/>
      firefox   4322             test   55u  IPv4  52458      0t0  UDP localhost:34866-&gt;127.0.0.53:domain
     </p>
     <p>
      #
     </p>
     <p>
      # dnss为官方仓库里就有的，一句简单命令就可以 doh 了，OK。但是，doh 被那啥了，国内的一些 doh可以使用。
     </p>
     <p>
      路由器，DNS服务器，本质上都可以是中间人，只不过这个中间人到底是谁而已。
     </p>
    </blockquote>
    <p>
     3.
    </p>
    <blockquote>
     <p>
      abc@mpc:~$ sudo apt remove dnss
     </p>
     <p>
      abc@mpc:~$ sudo netstat -tulnp | grep ':53'
      <br/>
      udp        0      0 0.0.0.0:5353            0.0.0.0:*                           662/avahi-daemon: r
      <br/>
      udp6       0      0 :::5353                 :::*                                662/avahi-daemon: r
     </p>
     <p>
     </p>
     <p>
      ## stop dnss 即可，并不是一定要 remove
     </p>
    </blockquote>
    <blockquote>
     <p>
      abc@mpc:~$ sudo systemctl stop systemd-resolved
      <br/>
      abc@mpc:~$ sudo systemctl start systemd-resolved
     </p>
    </blockquote>
    <ul>
     <li>
      systemd-resolved 为 debian 系自带的域名服务器；使用 ip 为 127.0.0.53:53
     </li>
     <li>
      127.0.0.1:53 给其他dns代理服务器使用的。
     </li>
     <li>
      dns查询顺序：先查询 systemd-resolved dns 127.0.0.53:53，无效、则查询 127.0.0.1:53  ？
      <br/>
      当然，并不只是这里提到的，实际上，中间还有其他的查询路径，比如 hosts 文件
     </li>
     <li>
      所以用户自己配置了dns服务器时，如需要使用自己的，则需要先停止系统自带的 systemd-resolved dns ？有些是代理软件自行设置，有些则需要用户自己设置。
     </li>
    </ul>
    <p>
     ​
    </p>
    <blockquote>
     <p>
      <strong>
       应用程序发起 DNS 请求
      </strong>
      <br/>
      ├─ 1. 检查本地 `/etc/hosts` 文件（若域名存在则直接返回 IP）‌#自己也可以进行DNS劫持
      <br/>
      ├─ 2. 查询本地 DNS 缓存（如 `systemd-resolved` 或浏览器缓存）‌
      <br/>
      ├─ 3. 通过 `/etc/resolv.conf` 找到 DNS 服务器地址（
      <strong>
       默认
      </strong>
      <strong>
       指向 `127.0.0.53:53`
      </strong>
      ）‌
      <br/>
      │   ├─ 若使用 `systemd-resolved`：请求转发至 `127.0.0.53:53`（本地代理，OS自带？）‌
      <br/>
      │   │   ├─ `systemd-resolved` 根据配置（`/run/systemd/resolve/resolv.conf`）
     </p>
     <p>
      │   │   │     向外部 DNS 服务器发起查询‌
      <br/>
      │   │   └─ 结果缓存并返回给应用程序‌
      <br/>
      │   └─
      <strong>
       若
      </strong>
      <strong>
       手动绑定
      </strong>
      <strong>
       其他服务（如 `dnsmasq`，
       <span style="color:#b95514">
        用户代理，不是系统默认自带的代理
       </span>
       ）
      </strong>
      ：
     </p>
     <p>
      │         请求直接发往 `127.0.0.1:53`（需服务已监听此地址）‌
      <br/>
      └─ 4. 外部 DNS 服务器响应，最终返回 IP 给应用程序‌
     </p>
     <p>
     </p>
     <p>
     </p>
    </blockquote>
    <p>
    </p>
    <p>
     4.
    </p>
    <blockquote>
     <p>
      abc@mpc:~$ sudo netstat -tulnp | grep ':53'
      <br/>
      tcp        0      0
      <span style="color:#be191c">
       <strong>
        127.0.0.53:53
       </strong>
      </span>
      0.0.0.0:*               LISTEN      5360/
      <span style="color:#b95514">
       <strong>
        systemd-resolv
       </strong>
      </span>
      <br/>
      udp        0      0 127.0.0.53:53           0.0.0.0:*                           5360/systemd-resolv
      <br/>
      udp        0      0 0.0.0.0:5353            0.0.0.0:*                           662/avahi-daemon: r
      <br/>
      udp6       0      0 :::5353                 :::*                                662/avahi-daemon: r
     </p>
    </blockquote>
    <blockquote>
     <p>
      tcp        0      0
      <span style="color:#be191c">
       <strong>
        127.0.0.53:53
       </strong>
      </span>
      0.0.0.0:*               LISTEN      5360/
      <span style="color:#b95514">
       <strong>
        systemd-resolv
       </strong>
      </span>
     </p>
     <p>
      <span style="color:#b95514">
       <strong>
        系统自带的 DNS 服务，回来了。
       </strong>
      </span>
     </p>
     <p>
      <span style="color:#b95514">
       <strong>
        OK
       </strong>
      </span>
     </p>
    </blockquote>
    <p>
    </p>
   </div>
  </div>
 </article>
 <p alt="6874747073:3a2f2f626c6f672e6373646e2e6e65742f6b656e323233322f:61727469636c652f64657461696c732f313436313635333232" class_="artid" style="display:none">
 </p>
</div>


