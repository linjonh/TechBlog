---
layout: post
title: "Spring-Boot-3.3.4-升级导致-Logback-之前回滚策略配置不兼容问题解决"
date: 2025-03-10 17:00:31 +0800
description: "在将 Spring Boot 项目升级至 3.3.4 版本后，遇到 Logback 配置的兼容性问题。本文将详细描述该问题的错误信息、原因分析，并提供调整日志回滚策略的解决方案。在 Spring Boot 升级至 3.3.4 后，由于底层 Logback 版本的更新，原先使用的类和日志文件名中的%i令牌会引发兼容性问题。通过调整日志回滚策略，使用新的并去除不兼容的文件命名模式，可以顺利解决这些问题，使日志系统恢复正常运行。"
keywords: "lagback %i不能使用"
categories: ['面试', '阿里巴巴', '学习路线']
tags: ['Spring', 'Logback', 'Java', 'Boot']
artid: "146158626"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146158626
    alt: "Spring-Boot-3.3.4-升级导致-Logback-之前回滚策略配置不兼容问题解决"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146158626
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146158626
cover: https://bing.ee123.net/img/rand?artid=146158626
image: https://bing.ee123.net/img/rand?artid=146158626
img: https://bing.ee123.net/img/rand?artid=146158626
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Spring Boot 3.3.4 升级导致 Logback 之前回滚策略配置不兼容问题解决
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h4>
     <a id="_4">
     </a>
     前言
    </h4>
    <p>
     在将 Spring Boot 项目升级至 3.3.4 版本后，遇到 Logback 配置的兼容性问题。本文将详细描述该问题的错误信息、原因分析，并提供调整日志回滚策略的解决方案。
    </p>
    <h4>
     <a id="_8">
     </a>
     错误描述
    </h4>
    <p>
     这是SpringBoot 3.3.3版本之前的回滚策略的配置
    </p>
    <pre><code>    &lt;!-- 日志记录器的滚动策略，按日期，按大小记录 --&gt;
    &lt;rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy"&gt;
        &lt;fileNamePattern&gt;${LOG_HOME}/%d{yyyy-MM-dd}.%i.log&lt;/fileNamePattern&gt;
        &lt;timeBasedFileNamingAndTriggeringPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP"&gt;
            &lt;maxFileSize&gt;10MB&lt;/maxFileSize&gt;
        &lt;/timeBasedFileNamingAndTriggeringPolicy&gt;
        &lt;!--日志文档保留天数--&gt;
        &lt;maxHistory&gt;30&lt;/maxHistory&gt;
    &lt;/rollingPolicy&gt;
</code></pre>
    <p>
     当 升级至 Spring Boot 3.3.4 版本后，启动时出现以下报错：
    </p>
    <pre><code>Exception in thread "main" java.lang.IllegalStateException: java.lang.IllegalStateException: Logback configuration error detected: 
ERROR in ch.qos.logback.core.model.processor.ImplicitModelHandler - Could not create component [timeBasedFileNamingAndTriggeringPolicy] of type [ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP] java.lang.ClassNotFoundException: ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP
ERROR in c.q.l.core.rolling.DefaultTimeBasedFileNamingAndTriggeringPolicy - Filename pattern [/logs/app/%d{yyyy-MM-dd}.%i.log] contains an integer token converter, i.e. %i, INCOMPATIBLE with this configuration. Remove it.
</code></pre>
    <p>
     主要问题出现在
     <code>
      logback
     </code>
     日志配置的
     <code>
      SizeAndTimeBasedFNATP
     </code>
     类以及日志文件命名中的
     <code>
      %i
     </code>
     令牌使用上。
    </p>
    <h5>
     <a id="_32">
     </a>
     关键错误信息：
    </h5>
    <ol>
     <li>
      <code>
       java.lang.ClassNotFoundException: ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP
      </code>
     </li>
     <li>
      <code>
       Filename pattern contains an integer token converter, i.e. %i, INCOMPATIBLE with this configuration
      </code>
     </li>
    </ol>
    <h4>
     <a id="_37">
     </a>
     原因分析
    </h4>
    <p>
     在升级 Spring Boot 版本至 3.3.4 后，底层的 Logback 版本也随之更新。在较新的 Logback 版本中，以下变化引发了兼容性问题：
    </p>
    <ol>
     <li>
      <p>
       <strong>
        <code>
         SizeAndTimeBasedFNATP
        </code>
        类弃用
       </strong>
       ：
      </p>
      <ul>
       <li>
        在新的 Logback 版本中，
        <code>
         SizeAndTimeBasedFNATP
        </code>
        类已经被移除或不再使用。之前用来支持基于大小和时间的日志滚动的策略必须替换为新的策略类。
       </li>
       <li>
        此类需要被
        <code>
         SizeAndTimeBasedRollingPolicy
        </code>
        替代，它能够同时支持按文件大小和时间进行日志滚动。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        日志文件命名中的
        <code>
         %i
        </code>
        令牌不兼容
       </strong>
       ：
      </p>
      <ul>
       <li>
        日志文件命名模式中使用的
        <code>
         %i
        </code>
        令牌，用于在日志滚动时生成多个文件（如
        <code>
         log.1
        </code>
        ,
        <code>
         log.2
        </code>
        等），但这与
        <code>
         TimeBasedRollingPolicy
        </code>
        不兼容。
        <code>
         TimeBasedRollingPolicy
        </code>
        仅基于时间滚动日志，不支持
        <code>
         %i
        </code>
        分片。
       </li>
      </ul>
     </li>
    </ol>
    <h4>
     <a id="_49">
     </a>
     解决方案
    </h4>
    <h5>
     <a id="_51">
     </a>
     调整日志回滚策略
    </h5>
    <p>
     为了解决以上问题，我们需要将原有的
     <code>
      TimeBasedRollingPolicy
     </code>
     替换为新的
     <code>
      SizeAndTimeBasedRollingPolicy
     </code>
     ，并调整日志文件的命名模式以去除不兼容的
     <code>
      %i
     </code>
     令牌。
    </p>
    <h5>
     <a id="_55">
     </a>
     配置修改
    </h5>
    <p>
     以下是修改后的
     <code>
      logback-spring.xml
     </code>
     配置：
    </p>
    <pre><code>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;configuration&gt;

    &lt;!-- SpringBoot默认logback的配置 --&gt;
    &lt;include resource="org/springframework/boot/logging/logback/defaults.xml"/&gt;

    &lt;springProperty scope="context" name="APP_NAME" source="spring.application.name"/&gt;
    &lt;property name="LOG_HOME" value="/logs/${APP_NAME}"/&gt;

    &lt;!-- 1. 输出到控制台 --&gt;
    &lt;appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender"&gt;
        &lt;filter class="ch.qos.logback.classic.filter.ThresholdFilter"&gt;
            &lt;level&gt;DEBUG&lt;/level&gt;
        &lt;/filter&gt;
        &lt;encoder&gt;
            &lt;Pattern&gt;${CONSOLE_LOG_PATTERN}&lt;/Pattern&gt;
            &lt;charset&gt;UTF-8&lt;/charset&gt;
        &lt;/encoder&gt;
    &lt;/appender&gt;

    &lt;!-- 2. 输出到文件 --&gt;
    &lt;appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender"&gt;
        &lt;file&gt;${LOG_HOME}/log.log&lt;/file&gt;
        &lt;encoder&gt;
            &lt;pattern&gt;%d{yyyy-MM-dd HH:mm:ss.SSS} -%5level ---[%15.15thread] %-40.40logger{39} : %msg%n%n&lt;/pattern&gt;
            &lt;charset&gt;UTF-8&lt;/charset&gt;
        &lt;/encoder&gt;
        &lt;!-- 使用SizeAndTimeBasedRollingPolicy替代旧的策略 --&gt;
        &lt;rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy"&gt;
            &lt;!-- 滚动后的日志文件命名模式 --&gt;
            &lt;fileNamePattern&gt;${LOG_HOME}/%d{yyyy-MM-dd}-%i.log&lt;/fileNamePattern&gt;
            &lt;!-- 日志文件的最大大小 --&gt;
            &lt;maxFileSize&gt;10MB&lt;/maxFileSize&gt;
            &lt;!-- 最大保留30天的日志 --&gt;
            &lt;maxHistory&gt;30&lt;/maxHistory&gt;
            &lt;!-- 总日志文件大小不超过3GB --&gt;
            &lt;totalSizeCap&gt;3GB&lt;/totalSizeCap&gt;
        &lt;/rollingPolicy&gt;
        &lt;filter class="ch.qos.logback.classic.filter.ThresholdFilter"&gt;
            &lt;level&gt;INFO&lt;/level&gt;
        &lt;/filter&gt;
    &lt;/appender&gt;

    &lt;!-- 开发环境输出至控制台 --&gt;
    &lt;springProfile name="dev"&gt;
        &lt;root level="INFO"&gt;
            &lt;appender-ref ref="CONSOLE"/&gt;
        &lt;/root&gt;
    &lt;/springProfile&gt;

    &lt;!-- 生产环境输出至文件 --&gt;
    &lt;springProfile name="prod"&gt;
        &lt;root level="INFO"&gt;
            &lt;appender-ref ref="CONSOLE"/&gt;
            &lt;appender-ref ref="FILE"/&gt;
        &lt;/root&gt;
    &lt;/springProfile&gt;

&lt;/configuration&gt;
</code></pre>
    <h5>
     <a id="_120">
     </a>
     修改内容说明：
    </h5>
    <ol>
     <li>
      <p>
       <strong>
        使用
        <code>
         SizeAndTimeBasedRollingPolicy
        </code>
       </strong>
       ：
      </p>
      <ul>
       <li>
        该策略同时支持按时间和文件大小滚动日志。与旧的
        <code>
         TimeBasedRollingPolicy
        </code>
        类相比，它是更推荐的滚动策略。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        文件命名模式调整
       </strong>
       ：
      </p>
      <ul>
       <li>
        在
        <code>
         fileNamePattern
        </code>
        中，使用
        <code>
         %d{yyyy-MM-dd}-%i.log
        </code>
        作为文件名格式，这允许日志按照日期命名，并在同一天滚动日志时通过
        <code>
         %i
        </code>
        生成分片文件（如
        <code>
         2024-10-01-1.log
        </code>
        ,
        <code>
         2024-10-01-2.log
        </code>
        等）。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        限制日志大小和保留时间
       </strong>
       ：
      </p>
      <ul>
       <li>
        <code>
         maxFileSize
        </code>
        设置为 10MB，表示单个日志文件的最大大小。
       </li>
       <li>
        <code>
         maxHistory
        </code>
        设置为 30，表示最多保留30天的日志文件。
       </li>
       <li>
        <code>
         totalSizeCap
        </code>
        设置为 3GB，表示日志总大小不能超过 3GB。达到该限制时，将删除最早的日志文件。
       </li>
      </ul>
     </li>
    </ol>
    <h4>
     <a id="_134">
     </a>
     总结
    </h4>
    <p>
     在 Spring Boot 升级至 3.3.4 后，由于底层 Logback 版本的更新，原先使用的
     <code>
      TimeBasedRollingPolicy
     </code>
     类和日志文件名中的
     <code>
      %i
     </code>
     令牌会引发兼容性问题。通过调整日志回滚策略，使用新的
     <code>
      SizeAndTimeBasedRollingPolicy
     </code>
     并去除不兼容的文件命名模式，可以顺利解决这些问题，使日志系统恢复正常运行。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f6d305f37343832353130382f:61727469636c652f64657461696c732f313436313538363236" class_="artid" style="display:none">
 </p>
</div>


