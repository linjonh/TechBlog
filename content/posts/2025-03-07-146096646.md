---
layout: post
title: "iOS-聊天-IM-消息收发管理工具"
date: 2025-03-07 17:56:20 +0800
description: "之前提过消息列表是由数据驱动的，这次说的聊天消息收发管理工具就是驱动列表展示的数据引擎。与iOS 客户端 IM 以及列表 UI 框架里提到的 ChatContext 是同一个，它作为新聊天消息列表的数据引擎，内部无业务属性，可以接入到多种聊天场景，比如单聊、群聊、临时会话等等。"
keywords: "iOS 聊天 IM 消息收发管理工具"
categories: ['Ios']
tags: ['适配器模式', '责任链模式', '设计模式', '前端', 'Ios', 'Cocoa']
artid: "146096646"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146096646
    alt: "iOS-聊天-IM-消息收发管理工具"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146096646
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146096646
cover: https://bing.ee123.net/img/rand?artid=146096646
image: https://bing.ee123.net/img/rand?artid=146096646
img: https://bing.ee123.net/img/rand?artid=146096646
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     iOS 聊天 IM 消息收发管理工具
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="iOS__IM__0">
     </a>
     iOS 聊天 IM 消息收发管理工具
    </h2>
    <p>
     连续疯狂加班告一段落，趁着离职前夕的空闲时间，整理一下重构相关的文档。之前写过两篇文章
     <a href="https://blog.csdn.net/ID314846818/article/details/122344669?spm=1001.2014.3001.5502">
      iOS 客户端 IM 以及列表 UI 框架
      <br/>
     </a>
     、
     <a href="https://blog.csdn.net/ID314846818/article/details/128818082?spm=1001.2014.3001.5501">
      iOS 客户端 IM 消息卡片插件化
     </a>
     ，突然发现时间过的真的很快，这都已经是两年多以前的事情了，我居然没再写点什么，自责三秒钟。
     <a href="https://blog.csdn.net/ID314846818/article/details/122344669?spm=1001.2014.3001.5502">
      iOS 客户端 IM 以及列表 UI 框架
      <br/>
     </a>
     总体讲了探探这边
     <strong>
      IM 整体框架架构
     </strong>
     ，
     <strong>
      消息的收发、存储基本流程
     </strong>
     以及
     <strong>
      UI框架的接口设计
     </strong>
     ，
     <a href="https://blog.csdn.net/ID314846818/article/details/128818082?spm=1001.2014.3001.5501">
      iOS 客户端 IM 消息卡片插件化
     </a>
     讲的比较微观，是说消息列表中的一条消息，如何通过插件支持交互以及与其他消息联动。
    </p>
    <p>
     本篇想讲的是
     <strong>
      消息的收发、存储基本流程
     </strong>
     的实现，算是给 IM 部分收个尾。
    </p>
    <h3>
     <a id="1__7">
     </a>
     1. 简介
    </h3>
    <p>
     之前提过消息列表是由数据驱动的，这次说的聊天消息收发管理工具就是驱动列表展示的数据引擎。与
     <a href="https://blog.csdn.net/ID314846818/article/details/122344669?spm=1001.2014.3001.5502">
      iOS 客户端 IM 以及列表 UI 框架
      <br/>
     </a>
     里提到的 ChatContext 是同一个，它作为新聊天消息列表的数据引擎，内部无业务属性，可以接入到多种聊天场景，比如单聊、群聊、临时会话等等。
    </p>
    <h3>
     <a id="2__11">
     </a>
     2. 消息收发基本流程
    </h3>
    <blockquote>
     <p>
      这里在
      <a href="https://blog.csdn.net/ID314846818/article/details/122344669?spm=1001.2014.3001.5502">
       iOS 客户端 IM 以及列表 UI 框架
       <br/>
      </a>
      中已经写过，为方便阅读，姑且粘过来一份吧
     </p>
    </blockquote>
    <h4>
     <a id="21__14">
     </a>
     2.1 消息发送过程
    </h4>
    <p>
     消息的发送是基于 HTTP 请求，主要包含两种类型：一种是
     <strong>
      同步参数类型
     </strong>
     （简单文本）、一种是
     <strong>
      异步参数类型
     </strong>
     的消息（多媒体，或者文本消息增加各种检查等）。
    </p>
    <ol>
     <li>
      同步参数类型，是组装好参数后，直接通过 POST 请求发送到服务器；
     </li>
     <li>
      异步参数类型消息，在调用发送消息的接口之前，需要先将多媒体数据上传到 CDN 服务器，然后把返回的地址链接拼到发送消息的请求参数中，再请求发送消息接口，实现消息的发送；
     </li>
     <li>
      异步参数类型消息还包括一些特殊的多媒体信息，比如第三方服务提供的大表情消息，在调用发送消息接口之前，就需要把第三方获数据另保存一份到自己的 CDN 服务器，然后把返回的数据拼接到发送消息参数中，请求发送消息接口，实现消息的发送。
      <br/>
      <img alt="消息发送流程图" src="https://i-blog.csdnimg.cn/blog_migrate/6b37b62dece5801b5e0e677ccb161041.png#pic_center"/>
     </li>
    </ol>
    <h4>
     <a id="22__22">
     </a>
     2.2 消息接收过程
    </h4>
    <p>
     消息的接收是基于 WebSocket 长连接和 HTTP 请求相互配合来实现的。WebSocket 是 App 内用于服务端向客户端发送通知消息的单向通讯服务工具
    </p>
    <ol>
     <li>
      有了新的消息，服务端会通过 WebSocket 向接收方主动发送通知消息；
     </li>
     <li>
      做为主动通知的补充，客户端端上还有轮询任务，以固定时间间隔来通过 HTTP 请求服务端询问是否有新的消息；
     </li>
     <li>
      客户端收到通知消息之后，再通过 HTTP 请求新消息数据，来展示到对应的 UI；
      <br/>
      <img alt="消息接收流程图" src="https://i-blog.csdnimg.cn/blog_migrate/bc587179a7f12555956c4c6fcff94a9a.png#pic_center"/>
     </li>
    </ol>
    <h4>
     <a id="23__28">
     </a>
     2.3 消息的存储
    </h4>
    <p>
     消息的存储底层采用 sqlite 和第三方 FMDB 开源框架，再此基础之上开发了一套支持 ORM 以及 SQL 语句生成工具的基础库。每个支持数据库保存的 Model 类内部保存了具体表名、不同字段与表字段的映射，进行数据库操作的时候可以根据这些信息生成对应的 SQL 语句来保存到本地数据库。本地消息的保存就是直接通过框架保存到数据库即可，网络部分是请求到数据后，通过前后端约定的 envelop key 确定到具体数据 Model 的类，从而根据 ORM 信息来保存到数据库，大概就介绍到这里吧，不再做过多的介绍了。
    </p>
    <h3>
     <a id="3_ChatContext_31">
     </a>
     3. ChatContext
    </h3>
    <p>
     ChatContext 内部主要有以下三个模块：
     <br/>
     1、ChatMessenger，负责消息发送，失败重试等
     <br/>
     2、ChatMessageListLoader，负责加载新消息以及历史消息，不负责存储，内部会根据锚点使用 LocalLoader（本地数据库加载）或者RemoteLoader（远程加载）来加载数据
     <br/>
     3、ChatDataManager 负责存储管理内存中的消息数据，内部
    </p>
    <p>
     通过协调这三个模块来实现
     <kbd>
      消息收发
     </kbd>
     、
     <kbd>
      消息加载
     </kbd>
     、
     <kbd>
      消息数据变更回调
     </kbd>
     。
     <mark>
      消息列表
     </mark>
     会监听
     <mark>
      消息数据变更
     </mark>
     来实现UI更新，从而达到
     <strong>
      数据驱动
     </strong>
     的目的
    </p>
    <h4>
     <a id="31__39">
     </a>
     3.1 架构设计图
    </h4>
    <p>
     <img alt="请添加图片描述" src="https://i-blog.csdnimg.cn/direct/8d61626ebc794e5e9b4e56fa7c92a302.png#pic_center"/>
    </p>
    <h4>
     <a id="32__41">
     </a>
     3.2 接口设计
    </h4>
    <pre><code class="prism language-swift">	<span class="token comment">/// 消息数据</span>
    <span class="token keyword">private</span><span class="token punctuation">(</span><span class="token keyword">set</span><span class="token punctuation">)</span> <span class="token keyword">var</span> messages<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token class-name">Message</span><span class="token punctuation">]</span>
        
    <span class="token comment">/// 消息发送工具</span>
    <span class="token keyword">let</span> messenger<span class="token punctuation">:</span> <span class="token class-name">ChatMessenger</span>

    <span class="token comment">/// 是否有更多历史消息</span>
    <span class="token keyword">var</span> hasMorePreviousMessages<span class="token punctuation">:</span> <span class="token class-name">Bool</span>

    <span class="token comment">/// 注册消息数组数据变更监听者</span>
    <span class="token keyword">func</span> <span class="token function-definition function">registerMsgDataObserver</span><span class="token punctuation">(</span>observer<span class="token punctuation">:</span> <span class="token class-name">ChatContextMsgDataObservable</span><span class="token punctuation">)</span>

    <span class="token comment">/// 清空消息历史消息</span>
    <span class="token keyword">func</span> <span class="token function-definition function">clearAllMessages</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span>

    <span class="token comment">/// 拉取历史消息</span>
    <span class="token comment">/// TODO: 从当前消息拉取到指定时间的历史消息</span>
    <span class="token keyword">func</span> <span class="token function-definition function">fetchMorePreviousMessages</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token operator">-&gt;</span> <span class="token punctuation">[</span><span class="token class-name">Message</span><span class="token punctuation">]</span>
</code></pre>
    <h4>
     <a id="33_ChatMessenger_63">
     </a>
     3.3 ChatMessenger
    </h4>
    <p>
     该模块主要负责消息发送，以及发送流程控制，其中发送流程控制是指：
     <br/>
     1、
     <strong>
      发送消息前
     </strong>
     拼装各业务提供的基础参数
     <br/>
     2、
     <strong>
      将要发送时
     </strong>
     询问业务方是否拦截
     <br/>
     3、
     <strong>
      发送成功
     </strong>
     回调或者
     <strong>
      发送失败
     </strong>
     时修改返回给业务的错误信息
    </p>
    <p>
     接口设计
    </p>
    <pre><code class="prism language-swift">
	<span class="token comment">/// 发送同步类型参数消息</span>
    <span class="token keyword">public</span> <span class="token keyword">func</span> <span class="token function-definition function">sendMessage</span><span class="token punctuation">(</span>withSynParameterBuilder builder<span class="token punctuation">:</span> <span class="token class-name">BaseMessageParameterBuilder</span> <span class="token operator">&amp;</span> <span class="token class-name">MessageSynParameterBuilder</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token operator">-&gt;</span> <span class="token punctuation">(</span><span class="token class-name">PUGMessage</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token class-name">TXTResponse</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token class-name">PUGError</span><span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 询问业务组装基础参数</span>
        <span class="token function">setup</span><span class="token punctuation">(</span>messageParameterBuilder<span class="token punctuation">:</span> builder<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span>synParameterBuilder<span class="token punctuation">:</span> builder<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/// 发送异步类型参数消息</span>
    <span class="token keyword">public</span> <span class="token keyword">func</span> <span class="token function-definition function">sendMessage</span><span class="token punctuation">(</span>withAsynParameterBuilder builder<span class="token punctuation">:</span> <span class="token class-name">BaseMessageParameterBuilder</span> <span class="token operator">&amp;</span> <span class="token class-name">MessageAsynParameterBuilder</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token operator">-&gt;</span> <span class="token punctuation">(</span><span class="token class-name">PUGMessage</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token class-name">TXTResponse</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token class-name">PUGError</span><span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">setup</span><span class="token punctuation">(</span>messageParameterBuilder<span class="token punctuation">:</span> builder<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span>asynParameterBuilder<span class="token punctuation">:</span> builder<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
	<span class="token keyword">private</span> <span class="token keyword">func</span> <span class="token function-definition function">sendMessage</span><span class="token punctuation">(</span>synParameterBuilder<span class="token punctuation">:</span> <span class="token class-name">MessageSynParameterBuilder</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token operator">-&gt;</span> <span class="token punctuation">(</span><span class="token class-name">PUGMessage</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token class-name">TXTResponse</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token class-name">PUGError</span><span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	    <span class="token comment">// 通知业务消息即将发送</span>
        observableTable<span class="token operator">?</span><span class="token punctuation">.</span>allObjects<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> observer <span class="token keyword">in</span>
            observer<span class="token punctuation">.</span>chatMessenger<span class="token operator">?</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">,</span> willSendMessageWithBuilder<span class="token punctuation">:</span> synParameterBuilder<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">let</span> ret <span class="token operator">=</span> <span class="token keyword">await</span> basicMessenger<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>synParameterBuilder<span class="token punctuation">:</span> synParameterBuilder<span class="token punctuation">,</span>
                                                   willSendMessageChecker<span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">[</span><span class="token keyword">weak</span> <span class="token keyword">self</span><span class="token punctuation">]</span> localMessage <span class="token keyword">in</span>
            <span class="token comment">// 业务检查消息是否可以进入正常发送流程</span>
            <span class="token keyword">return</span> <span class="token keyword">self</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">checkSending</span><span class="token punctuation">(</span>localMsg<span class="token punctuation">:</span> localMessage<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> failedMessageModifier<span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">[</span><span class="token keyword">weak</span> <span class="token keyword">self</span><span class="token punctuation">]</span> result <span class="token keyword">in</span>
            <span class="token comment">// 消息发送失败，通知业务修改错误信息</span>
            <span class="token keyword">return</span> <span class="token keyword">self</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span>failedMsg<span class="token punctuation">:</span> result<span class="token punctuation">.</span>message<span class="token punctuation">,</span> error<span class="token punctuation">:</span> result<span class="token punctuation">.</span>error<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token comment">// 通知业务消息发送完成（包括成功、失败）</span>
        <span class="token function">publish</span><span class="token punctuation">(</span>didSentMessageWithResult<span class="token punctuation">:</span> ret<span class="token punctuation">)</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">.</span><span class="token function">toTuple</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre>
    <p>
     消息发送流程图
     <br/>
     <img alt="请添加图片描述" src="https://i-blog.csdnimg.cn/direct/2e41a1051ec648f7904820ebcfa4d583.png#pic_center"/>
    </p>
    <h4>
     <a id="34_ChatMessageListLoader_107">
     </a>
     3.4 ChatMessageListLoader
    </h4>
    <p>
     该模块负责消息数据的加载，并不负责存储，ChatContext 的拉取消息接口内部调用 ChatMessageListLoader 加载消息，并存储在 ChatDataManager 中，如下所示
    </p>
    <pre><code class="prism language-swift">
<span class="token keyword">func</span> <span class="token function-definition function">loadNewMessages</span><span class="token punctuation">(</span><span class="token punctuation">)</span> asyc <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">let</span> msgs <span class="token operator">=</span> <span class="token keyword">await</span> loader<span class="token punctuation">.</span><span class="token function">loadNewMessages</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	dataManager<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>msgs<span class="token punctuation">)</span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span>

</code></pre>
    <p>
     下面是 ChatMessageListLoader 支持的功能以及接口设计
    </p>
    <pre><code class="prism language-swift">
<span class="token comment">/// 是否可以加载更旧的消息 = canLoadOldRemoteMessages || canLoadOldLocalMessages</span>
<span class="token keyword">var</span> canLoadOldMessages<span class="token punctuation">:</span> <span class="token class-name">Bool</span>

<span class="token comment">/// 是否可以从本地数据库加载更旧的消息</span>
<span class="token keyword">var</span> canLoadOldLocalMessages<span class="token punctuation">:</span> <span class="token class-name">Bool</span>

<span class="token comment">/// 是否可以从远端加载更旧的消息</span>
<span class="token keyword">var</span> canLoadOldRemoteMessages<span class="token punctuation">:</span> <span class="token class-name">Bool</span>

<span class="token comment">/// 加载新消息，只从后端拉取</span>
<span class="token keyword">func</span> <span class="token function-definition function">loadNewMessages</span><span class="token punctuation">(</span><span class="token punctuation">)</span> asyc <span class="token operator">-&gt;</span> <span class="token class-name">Result</span>

<span class="token comment">/// 加载旧消息，优先从数据库获取，然后从后端获取旧消息</span>
<span class="token keyword">func</span> <span class="token function-definition function">loadOldMessages</span><span class="token punctuation">(</span><span class="token punctuation">)</span> asyc <span class="token operator">-&gt;</span> <span class="token class-name">Result</span>

<span class="token comment">/// 清空消息时调用</span>
<span class="token keyword">func</span> <span class="token function-definition function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> asyc

</code></pre>
    <h4>
     <a id="35_ChatDataManager_142">
     </a>
     3.5 ChatDataManager
    </h4>
    <p>
     消息数据的存储工具，负责数据去重、排序，提供增删改查功能
    </p>
    <pre><code class="prism language-swift">
<span class="token keyword">class</span> <span class="token class-name">ChatDataManager</span><span class="token operator">&lt;</span><span class="token class-name">Item</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>

	<span class="token comment">/// 当前存储的数据</span>
	<span class="token keyword">private</span><span class="token punctuation">(</span><span class="token keyword">set</span><span class="token punctuation">)</span> <span class="token keyword">var</span> items<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token class-name">Item</span><span class="token punctuation">]</span>
	
	<span class="token comment">/// 初始化方法，sorter: 用于排序</span>
	<span class="token keyword">init</span><span class="token punctuation">(</span>sorter<span class="token punctuation">:</span> <span class="token class-name">Comparator</span><span class="token punctuation">)</span>
	
	<span class="token comment">/// 头部添加</span>
	<span class="token keyword">func</span> <span class="token function-definition function">prepend</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> items<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token class-name">Item</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token comment">/// 尾部添加</span>
	<span class="token keyword">func</span> <span class="token function-definition function">append</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> items<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token class-name">Item</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token comment">/// 更新</span>
	<span class="token keyword">func</span> <span class="token function-definition function">update</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> items<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token class-name">Item</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token comment">/// 删除</span>
	<span class="token keyword">func</span> <span class="token function-definition function">deletedItems</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> itemIDs<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token comment">/// 移除所有元素</span>
	<span class="token keyword">func</span> <span class="token function-definition function">removeAllItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="4__ChatContext__168">
     </a>
     4. 发送消息部分，接入 ChatContext 前后对比
    </h3>
    <h4>
     <a id="41__ChatContext__169">
     </a>
     4.1 使用 ChatContext 发送消息
    </h4>
    <p>
     重构后不在需要了解消息发送具体原理即可快速上手，仅需要关注与后端新增的参数字段即可，下面看一下新增一种消息发送类型所需要做：
    </p>
    <h5>
     <a id="411__171">
     </a>
     4.1.1 创建发送参数
    </h5>
    <pre><code class="prism language-c">@interface PUGLocationMessageParameterBuilder <span class="token operator">:</span> PUGBaseMessageParameterBuilder<span class="token operator">&lt;</span>PUGMessageSynParameterBuilder<span class="token operator">&gt;</span>

@<span class="token function">property</span> <span class="token punctuation">(</span>strong<span class="token punctuation">)</span> PUGLocationMessageInfo <span class="token operator">*</span>locationInfo<span class="token punctuation">;</span> 

@end

@implementation PUGLocationMessageParameterBuilder

<span class="token comment">// 用于保存到数据库的消息</span>
<span class="token operator">-</span> <span class="token punctuation">(</span>nullable PUGMessage <span class="token operator">*</span><span class="token punctuation">)</span>buildMessage <span class="token punctuation">{<!-- --></span>
    PUGMessageBuilder <span class="token operator">*</span>builder <span class="token operator">=</span> <span class="token punctuation">[</span>self generateBaseMessageBuilder<span class="token punctuation">]</span><span class="token punctuation">;</span>
    builder<span class="token punctuation">.</span>locationDictionary <span class="token operator">=</span> self<span class="token punctuation">.</span>locationInfo<span class="token punctuation">.</span>toDictionary<span class="token punctuation">;</span>
    builder<span class="token punctuation">.</span>retryParameter <span class="token operator">=</span> <span class="token punctuation">[</span>self buildParameter<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> builder<span class="token punctuation">.</span>build<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 发送给后端的参数</span>
<span class="token operator">-</span> <span class="token punctuation">(</span>nonnull NSDictionary <span class="token operator">*</span><span class="token punctuation">)</span>buildParameter <span class="token punctuation">{<!-- --></span>
    NSMutableDictionary <span class="token operator">*</span>para <span class="token operator">=</span> <span class="token punctuation">[</span>self generateBaseParameter<span class="token punctuation">]</span><span class="token punctuation">.</span>mutableCopy<span class="token punctuation">;</span>
    <span class="token comment">// 仅需要关注与后端新增的参数字段即可</span>
    <span class="token punctuation">[</span>para txt_setObjectSafely<span class="token operator">:</span>self<span class="token punctuation">.</span>locationInfo<span class="token punctuation">.</span>toDictionary forKey<span class="token operator">:</span>@<span class="token string">"location"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> para<span class="token punctuation">.</span>copy<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

@end
</code></pre>
    <h5>
     <a id="212__199">
     </a>
     2.1.2 调用发送消息接口
    </h5>
    <ol>
     <li>
      可以在全局获取发送工具
     </li>
     <li>
      消息发送失败重试逻辑，不需要额外处理
     </li>
     <li>
      调用完发送后，所有相关业务处理以及消息刷新都会处理，不需要额外调用
     </li>
    </ol>
    <pre><code class="prism language-c">PUGLocationMessageParameterBuilder <span class="token operator">*</span>paraBuilder <span class="token operator">=</span> <span class="token punctuation">[</span>PUGLocationMessageParameterBuilder alloc<span class="token punctuation">]</span> init<span class="token punctuation">]</span><span class="token punctuation">;</span>
paraBuilder<span class="token punctuation">.</span>locationInfo <span class="token operator">=</span> locationInfo<span class="token punctuation">;</span>
<span class="token punctuation">[</span>PUGChatContext context<span class="token operator">:</span>@<span class="token string">""</span><span class="token punctuation">]</span><span class="token punctuation">.</span>messageSender sendMessageWithSynParameterBuilder<span class="token operator">:</span>paraBuilder<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre>
    <h4>
     <a id="42__210">
     </a>
     4.2 重构前的发送消息
    </h4>
    <p>
     重构前需要关注消息发送流程中的各种细节，包括所有网络请求的基础参数、何时保存数据库、何时处理通用错误、消息重试发送等等。下面是重构前需要开发的五个部分
    </p>
    <h5>
     <a id="421__MessageNetworkInterface__213">
     </a>
     4.2.1 在 MessageNetworkInterface 中新增一个发送消息请求
    </h5>
    <p>
     并且很多比较难懂的公共参数不能丢失
    </p>
    <pre><code class="prism language-c"><span class="token operator">+</span> <span class="token punctuation">(</span>nullable TXTRESTApiRequest <span class="token operator">*</span><span class="token punctuation">)</span>postTextMessage<span class="token operator">:</span><span class="token punctuation">(</span>NSString <span class="token operator">*</span><span class="token punctuation">)</span>content conversaitonID<span class="token operator">:</span><span class="token punctuation">(</span>NSString <span class="token operator">*</span><span class="token punctuation">)</span>conversationID primaryKeyID<span class="token operator">:</span><span class="token punctuation">(</span>NSString <span class="token operator">*</span><span class="token punctuation">)</span>primaryKey referenceDictionary<span class="token operator">:</span><span class="token punctuation">(</span>NSDictionary <span class="token operator">*</span><span class="token punctuation">)</span>referenceDictionary parameters<span class="token operator">:</span><span class="token punctuation">(</span>nullable NSDictionary <span class="token operator">*</span><span class="token punctuation">)</span>parameters completion<span class="token operator">:</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">(</span><span class="token operator">^</span><span class="token punctuation">)</span><span class="token punctuation">(</span>PUGError <span class="token operator">*</span>error<span class="token punctuation">,</span> PUGMessage <span class="token operator">*</span>data<span class="token punctuation">,</span> NSDictionary <span class="token operator">*</span>retryParameter<span class="token punctuation">)</span><span class="token punctuation">)</span>completion <span class="token punctuation">{<!-- --></span>
    <span class="token function">NSAssert</span><span class="token punctuation">(</span>parameters<span class="token punctuation">[</span>@<span class="token string">"msgType"</span><span class="token punctuation">]</span> <span class="token operator">!=</span> nil<span class="token punctuation">,</span> @<span class="token string">"Has no relevant key: 'msgType'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>content<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">1</span> <span class="token operator">||</span> completion <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> conversationID<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 文本消息没有内容直接return</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>completion <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">completion</span><span class="token punctuation">(</span><span class="token punctuation">[</span>PUGError errorWithCode<span class="token operator">:</span>PUGCommonErrorInvalidParameters description<span class="token operator">:</span>@<span class="token string">"Invalid Parameters"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> nil<span class="token punctuation">,</span> nil<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> nil<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    TXTRESTApiRequest <span class="token operator">*</span>req <span class="token operator">=</span> <span class="token punctuation">[</span>TXTRESTApiRequest requestOfPOSTMethod<span class="token punctuation">]</span><span class="token punctuation">;</span>
    req<span class="token punctuation">.</span>urlString <span class="token operator">=</span> <span class="token punctuation">[</span>self messagesForConversationWithID<span class="token operator">:</span>conversationID withWithParameters<span class="token operator">:</span>@<span class="token punctuation">[</span>@<span class="token punctuation">(</span>PUGBusinessKeyLiterature<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    NSDictionary <span class="token operator">*</span>params<span class="token punctuation">;</span>
    NSDictionary <span class="token operator">*</span>idempotentInfo <span class="token operator">=</span> @<span class="token punctuation">{<!-- --></span>
        @<span class="token string">"id"</span> <span class="token operator">:</span> <span class="token function">mNonnilString</span><span class="token punctuation">(</span>primaryKey<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>referenceDictionary<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        params <span class="token operator">=</span> @<span class="token punctuation">{<!-- --></span>@<span class="token string">"xx"</span><span class="token operator">:</span> content<span class="token punctuation">,</span>
                   @<span class="token string">"xxx"</span><span class="token operator">:</span> referenceDictionary<span class="token punctuation">,</span>
                   @<span class="token string">"xxx"</span><span class="token operator">:</span> idempotentInfo
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        params <span class="token operator">=</span> @<span class="token punctuation">{<!-- --></span>@<span class="token string">"xx"</span><span class="token operator">:</span> content<span class="token punctuation">,</span>
                   @<span class="token string">"xxx"</span><span class="token operator">:</span> idempotentInfo
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>parameters<span class="token punctuation">.</span>count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        NSMutableDictionary <span class="token operator">*</span>tmp <span class="token operator">=</span> params<span class="token punctuation">.</span>mutableCopy<span class="token punctuation">;</span>
        <span class="token punctuation">[</span>tmp addEntriesFromDictionary<span class="token operator">:</span>parameters<span class="token punctuation">]</span><span class="token punctuation">;</span>
        params <span class="token operator">=</span> tmp<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    req<span class="token punctuation">.</span>paramsDictionary <span class="token operator">=</span> params<span class="token punctuation">;</span>
    req<span class="token punctuation">.</span>responseSerializerType <span class="token operator">=</span> TXTResponseSerializerTypeCustomize<span class="token punctuation">;</span>
    req<span class="token punctuation">.</span>responseSerializer <span class="token operator">=</span> <span class="token punctuation">[</span>self postMessageParser<span class="token operator">:</span>primaryKey<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span>req startWithResponseBlock<span class="token operator">:</span><span class="token operator">^</span><span class="token punctuation">(</span>TXTResponse <span class="token operator">*</span>response<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        PUGError <span class="token operator">*</span>error <span class="token operator">=</span> <span class="token punctuation">[</span>PUGErrorParser errorFromResponse<span class="token operator">:</span>response<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">completion</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> error <span class="token operator">==</span> nil <span class="token operator">?</span> response<span class="token punctuation">.</span>responseObject <span class="token operator">:</span> nil<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> req<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
    <h5>
     <a id="322__PUGLocationMessagePlugin__260">
     </a>
     3.2.2 新建一个 PUGLocationMessagePlugin 实现发送新消息以及重试发送消息
    </h5>
    <p>
     需要熟悉消息发送流程，进行保存数据库，网络请求，刷新UI 等，包括同步数据库，调用 PUGMessageNetworkInterface 发送接口，还要关注通用逻辑的细节，以及刷新列表等
    </p>
    <pre><code class="prism language-c"><span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>sendLocationInfo<span class="token operator">:</span><span class="token punctuation">(</span>PUGLocationMessageInfo <span class="token operator">*</span><span class="token punctuation">)</span>locationInfo <span class="token punctuation">{<!-- --></span>
    @<span class="token function">weakify</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span>self sendLocation<span class="token operator">:</span>locationInfo addCompletion<span class="token operator">:</span><span class="token operator">^</span><span class="token punctuation">(</span>PUGError <span class="token operator">*</span>error<span class="token punctuation">,</span> PUGMessage <span class="token operator">*</span>message<span class="token punctuation">,</span> NSInteger index<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        @<span class="token function">strongify</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span>self<span class="token punctuation">.</span>controller showNewMessage<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> completion<span class="token operator">:</span><span class="token operator">^</span><span class="token punctuation">(</span>PUGError <span class="token operator">*</span>error<span class="token punctuation">,</span> PUGMessage <span class="token operator">*</span>message<span class="token punctuation">,</span> NSInteger index<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        @<span class="token function">strongify</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span>self<span class="token punctuation">.</span>controller sendMessageCompletion<span class="token operator">:</span>message<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>self processSendMessageError<span class="token operator">:</span>error message<span class="token operator">:</span>message<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//common error</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">[</span>self<span class="token punctuation">.</span>controller reloadMessages<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>sendLocationMessage<span class="token operator">:</span><span class="token punctuation">(</span>PUGMessage <span class="token operator">*</span><span class="token punctuation">)</span>locationMessage completion<span class="token operator">:</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">^</span><span class="token punctuation">)</span><span class="token punctuation">(</span>PUGError <span class="token operator">*</span>error<span class="token punctuation">,</span>PUGMessage <span class="token operator">*</span>message<span class="token punctuation">,</span>NSInteger index<span class="token punctuation">)</span><span class="token punctuation">)</span>sentCompletion <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">^</span>messageSendStatusCheckCompletion<span class="token punctuation">)</span><span class="token punctuation">(</span>PUGError <span class="token operator">*</span>error<span class="token punctuation">,</span> PUGMessage <span class="token operator">*</span>message<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">[</span>self<span class="token punctuation">.</span>useCase messageSendStatusCheckCompletion<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     NOTIC: 需要关注各种细节
     经后端确认，发消息接口发送的内容如果携带xxx字段并且满足xxx或者sticker或者media三字段中任意字段不为空，
     会被判定为回答xxxx对应的那个真心话，此时如果value不为空，会被认为是一条普通的文字消息，
     收消息一方收到的message消息体内将不包含xxx字段。
     */</span>
    NSDictionary <span class="token operator">*</span>networkParametersDictionary <span class="token operator">=</span> @<span class="token punctuation">{<!-- --></span>
        @<span class="token string">"xxx"</span><span class="token operator">:</span> <span class="token punctuation">[</span>NSDictionary dictionaryWithDictionary<span class="token operator">:</span>locationMessage<span class="token punctuation">.</span>locationDictionary<span class="token punctuation">]</span><span class="token punctuation">,</span>
        @<span class="token string">"xxx"</span><span class="token operator">:</span> <span class="token function">mNonnilString</span><span class="token punctuation">(</span>locationMessage<span class="token punctuation">.</span>msgType<span class="token punctuation">)</span><span class="token punctuation">,</span>
        @<span class="token string">"xxx"</span><span class="token operator">:</span> <span class="token function">mNonnilString</span><span class="token punctuation">(</span><span class="token punctuation">[</span>TXTStatistics currentPageID<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span>PUGMessageNetworkInterface postTextMessage<span class="token operator">:</span>@<span class="token string">"location"</span> conversaitonID<span class="token operator">:</span>self<span class="token punctuation">.</span>useCase<span class="token punctuation">.</span>conversationID messageReferenceID<span class="token operator">:</span>nil primaryKeyID<span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">(</span>PUGMessage <span class="token operator">*</span><span class="token punctuation">)</span>locationMessage primaryKeyID<span class="token punctuation">]</span> parameters<span class="token operator">:</span>networkParametersDictionary completion<span class="token operator">:</span><span class="token operator">^</span><span class="token punctuation">(</span>PUGError <span class="token operator">*</span>error<span class="token punctuation">,</span> PUGMessage <span class="token operator">*</span>data<span class="token punctuation">,</span> NSDictionary <span class="token operator">*</span>retryParameter<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>messageSendStatusCheckCompletion<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">messageSendStatusCheckCompletion</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">[</span>self<span class="token punctuation">.</span>useCase updateSentMessage<span class="token operator">:</span>data error<span class="token operator">:</span>error sentCompletion<span class="token operator">:</span>sentCompletion originalMessage<span class="token operator">:</span>locationMessage retryParameter<span class="token operator">:</span>retryParameter<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>self<span class="token punctuation">.</span>controller respondsToSelector<span class="token operator">:</span>@<span class="token function">selector</span><span class="token punctuation">(</span>messageDidSend<span class="token operator">:</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">[</span>self<span class="token punctuation">.</span>controller messageDidSend<span class="token operator">:</span>self<span class="token punctuation">.</span>useCase<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>sendLocation<span class="token operator">:</span><span class="token punctuation">(</span>PUGLocationMessageInfo <span class="token operator">*</span><span class="token punctuation">)</span>location addCompletion<span class="token operator">:</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">^</span><span class="token punctuation">)</span><span class="token punctuation">(</span>PUGError <span class="token operator">*</span>error<span class="token punctuation">,</span> PUGMessage <span class="token operator">*</span>message<span class="token punctuation">,</span> NSInteger index<span class="token punctuation">)</span><span class="token punctuation">)</span>addCompletion  completion<span class="token operator">:</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">^</span><span class="token punctuation">)</span><span class="token punctuation">(</span>PUGError <span class="token operator">*</span>error<span class="token punctuation">,</span> PUGMessage <span class="token operator">*</span>message<span class="token punctuation">,</span> NSInteger index<span class="token punctuation">)</span><span class="token punctuation">)</span>sentCompletion <span class="token punctuation">{<!-- --></span>
    PUGMessage <span class="token operator">*</span>reference <span class="token operator">=</span>  <span class="token punctuation">[</span>self<span class="token punctuation">.</span>useCase findLatestQuestionMessage<span class="token punctuation">]</span><span class="token punctuation">;</span>
    PUGMessage <span class="token operator">*</span>locationMessage <span class="token operator">=</span> <span class="token punctuation">[</span>PUGMessageDatabaseInterface locationMessage<span class="token operator">:</span>location referenceMessage<span class="token operator">:</span>reference otherUser<span class="token operator">:</span>self<span class="token punctuation">.</span>useCase<span class="token punctuation">.</span>otherUser conversationID<span class="token operator">:</span>self<span class="token punctuation">.</span>useCase<span class="token punctuation">.</span>conversationID<span class="token punctuation">]</span><span class="token punctuation">;</span>
    NSInteger index <span class="token operator">=</span> <span class="token punctuation">[</span>self<span class="token punctuation">.</span>useCase addOrReplaceMessage<span class="token operator">:</span>locationMessage toFront<span class="token operator">:</span>NO<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span>self<span class="token punctuation">.</span>useCase updateCurrentConversation<span class="token operator">:</span>locationMessage addedMessagesCount<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>addCompletion<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">addCompletion</span><span class="token punctuation">(</span>nil<span class="token punctuation">,</span>locationMessage<span class="token punctuation">,</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    @<span class="token function">weakify</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span>PUGMessageDatabaseInterface asyncSaveMessage<span class="token operator">:</span>locationMessage completion<span class="token operator">:</span><span class="token operator">^</span><span class="token punctuation">(</span>BOOL result<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        @<span class="token function">strongify</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span>self<span class="token punctuation">.</span>useCase checkIfUnmatchedByOtherUserWithMessage<span class="token operator">:</span>locationMessage completion<span class="token operator">:</span>sentCompletion<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">[</span>self sendLocationMessage<span class="token operator">:</span>locationMessage completion<span class="token operator">:</span>sentCompletion<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>retryFailedMessage<span class="token operator">:</span><span class="token punctuation">(</span>PUGMessage <span class="token operator">*</span><span class="token punctuation">)</span>message updated<span class="token operator">:</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">^</span><span class="token punctuation">)</span><span class="token punctuation">(</span>PUGMessage <span class="token operator">*</span>message<span class="token punctuation">,</span>NSInteger index<span class="token punctuation">)</span><span class="token punctuation">)</span>updatedBlock completion<span class="token operator">:</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">^</span><span class="token punctuation">)</span><span class="token punctuation">(</span>PUGError <span class="token operator">*</span>error<span class="token punctuation">,</span> PUGMessage <span class="token operator">*</span>message<span class="token punctuation">,</span> NSInteger index<span class="token punctuation">)</span><span class="token punctuation">)</span>sentCompletion <span class="token punctuation">{<!-- --></span>
    
    PUGMessage <span class="token operator">*</span>updatedMessage <span class="token operator">=</span> <span class="token punctuation">[</span>message copyWithBlock<span class="token operator">:</span><span class="token operator">^</span><span class="token punctuation">(</span>PUGMessageBuilder <span class="token operator">*</span> _Nonnull builder<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        builder<span class="token punctuation">.</span>apiObjectState <span class="token operator">=</span> PUGObjectStatePending<span class="token punctuation">;</span>
        builder<span class="token punctuation">.</span>createdTime <span class="token operator">=</span> <span class="token punctuation">[</span>NSDate pug_serverDate<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    
    NSInteger index <span class="token operator">=</span> <span class="token punctuation">[</span>self<span class="token punctuation">.</span>useCase updateMessage<span class="token operator">:</span>updatedMessage<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>updatedBlock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">updatedBlock</span><span class="token punctuation">(</span>updatedMessage<span class="token punctuation">,</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">^</span>messageSendStatusCheckCompletion<span class="token punctuation">)</span><span class="token punctuation">(</span>PUGError <span class="token operator">*</span>error<span class="token punctuation">,</span> PUGMessage <span class="token operator">*</span>message<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">[</span>self<span class="token punctuation">.</span>useCase messageSendStatusCheckCompletion<span class="token punctuation">]</span><span class="token punctuation">;</span>
    
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">^</span>completion<span class="token punctuation">)</span><span class="token punctuation">(</span>PUGError <span class="token operator">*</span>error<span class="token punctuation">,</span> PUGMessage <span class="token operator">*</span>message<span class="token punctuation">,</span> NSInteger index<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">^</span><span class="token punctuation">(</span>PUGError <span class="token operator">*</span>error<span class="token punctuation">,</span> PUGMessage <span class="token operator">*</span>message<span class="token punctuation">,</span> NSInteger index<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sentCompletion<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">sentCompletion</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> message<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    
    @<span class="token function">weakify</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span>PUGMessageDatabaseInterface asyncSaveMessage<span class="token operator">:</span>updatedMessage completion<span class="token operator">:</span><span class="token operator">^</span><span class="token punctuation">(</span>BOOL result<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        @<span class="token function">strongify</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>updatedMessage<span class="token punctuation">.</span>msgType isEqualToString<span class="token operator">:</span>PUGMessageMsgTypeLocation<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">[</span>self sendLocationMessage<span class="token operator">:</span>updatedMessage completion<span class="token operator">:</span><span class="token operator">^</span><span class="token punctuation">(</span>PUGError <span class="token operator">*</span>error<span class="token punctuation">,</span> PUGMessage <span class="token operator">*</span>message<span class="token punctuation">,</span>NSInteger index<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>completion<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">completion</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> message<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>messageSendStatusCheckCompletion<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">messageSendStatusCheckCompletion</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h5>
     <a id="323__357">
     </a>
     3.2.3 只能在消息详情页，或者能获取到消息详情页的类中，调用发送请求
    </h5>
    <p>
     在 PUGMessageViewController、PUGGroupMessageViewController 等消息详情页暴露发送位置消息的接口，内部调用 PUGLocationMessagePlugin 实现发送方法
    </p>
    <pre><code class="prism language-c"><span class="token comment">// 在 PUGGroupMessagesViewController 内部实现</span>

<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>sendLocationMessageInfo<span class="token operator">:</span><span class="token punctuation">(</span>PUGLocationMessageInfo <span class="token operator">*</span><span class="token punctuation">)</span>locationMessageInfo <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">[</span>self<span class="token punctuation">.</span>tableViewPlugin<span class="token punctuation">.</span>locationPlugin sendLocationInfo<span class="token operator">:</span>locationMessageInfo<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span>self<span class="token punctuation">.</span>commercializeService messageVCDidSendMessageAction<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h5>
     <a id="324__368">
     </a>
     3.2.4 管理维护传递调用链
    </h5>
    <p>
     让后将 PUGMessageViewController、PUGGroupMessageViewController 等消息详情页传给 PUGChooseLocationHandler 类，通过这些消息详情页暴露的发送接口进行调用发送
    </p>
    <pre><code class="prism language-c"><span class="token comment">// 在 PUGChooseLocationHandler 中实现</span>

<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>sendLocation <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span>self checkLocationPermissionAlert<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    PUGChooseLocationViewController <span class="token operator">*</span>chooseLocationVC <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>PUGChooseLocationViewController alloc<span class="token punctuation">]</span> init<span class="token punctuation">]</span><span class="token punctuation">;</span>
    chooseLocationVC<span class="token punctuation">.</span>shouldGetMapItemsFromBackground <span class="token operator">=</span> PUGDeviceInfo<span class="token punctuation">.</span>isChineseMobileNumber<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>self<span class="token punctuation">.</span>useCase isGroupChat<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        chooseLocationVC<span class="token punctuation">.</span>sourceName <span class="token operator">=</span> @<span class="token string">"GROUP_CHAT_VIEW"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        chooseLocationVC<span class="token punctuation">.</span>sourceName <span class="token operator">=</span> @<span class="token string">"CHAT_VIEW"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    @<span class="token function">weakify</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">;</span>
    chooseLocationVC<span class="token punctuation">.</span>sendLocationHandler <span class="token operator">=</span> <span class="token operator">^</span><span class="token punctuation">(</span>MKMapItem <span class="token operator">*</span>mapItem<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        @<span class="token function">strongify</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span>self<span class="token punctuation">.</span>controller sendLocationMessageInfo<span class="token operator">:</span><span class="token punctuation">[</span>PUGLocationMessageInfo locationMessageInfoFromMapItem<span class="token operator">:</span>mapItem<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    UINavigationController <span class="token operator">*</span>navi <span class="token operator">=</span> <span class="token punctuation">[</span>PUGThemeManager createNavigationController<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>navi<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
    
    navi<span class="token punctuation">.</span>navigationBar<span class="token punctuation">.</span>translucent <span class="token operator">=</span> YES<span class="token punctuation">;</span>
    navi<span class="token punctuation">.</span>viewControllers <span class="token operator">=</span> @<span class="token punctuation">[</span>chooseLocationVC<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span>self<span class="token punctuation">.</span>controller presentViewController<span class="token operator">:</span>navi animated<span class="token operator">:</span>YES completion<span class="token operator">:</span>nil<span class="token punctuation">]</span><span class="token punctuation">;</span>
    chooseLocationVC<span class="token punctuation">.</span>title <span class="token operator">=</span> <span class="token function">PUGChatLocalizedString</span><span class="token punctuation">(</span>@<span class="token string">"LOCATION_CHOOSE_VIEW_TITLE"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
    <h5>
     <a id="325__400">
     </a>
     3.2.5 处理自动发送以及重试逻辑
    </h5>
    <pre><code class="prism language-c">
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">mark <span class="token operator">-</span> 重传消息</span></span>
<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>retrySendMessage<span class="token operator">:</span><span class="token punctuation">(</span>PUGMessage <span class="token operator">*</span><span class="token punctuation">)</span>message <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>message<span class="token punctuation">.</span>msgType isEqualToString<span class="token operator">:</span>PUGMessageMsgTypeImage<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">[</span>message<span class="token punctuation">.</span>msgType isEqualToString<span class="token operator">:</span>PUGMessageMsgTypeExchangePhoto<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">[</span>self retrySendImageMessage<span class="token operator">:</span>message<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>message<span class="token punctuation">.</span>msgType isEqualToString<span class="token operator">:</span>PUGMessageMsgTypeAudio<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">[</span>self retrySendAudioMessage<span class="token operator">:</span>message<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>message<span class="token punctuation">.</span>msgType isEqualToString<span class="token operator">:</span>PUGMessageMsgTypeVideo<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">[</span>self retrySendVideoMessage<span class="token operator">:</span>message<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>message<span class="token punctuation">.</span>msgType isEqualToString<span class="token operator">:</span>PUGMessageMsgTypeRealShot<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        PUGPictureInfo <span class="token operator">*</span>pictureInfo <span class="token operator">=</span> <span class="token punctuation">[</span>message realShotPictureInfos<span class="token punctuation">]</span><span class="token punctuation">.</span>firstObject<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pictureInfo<span class="token punctuation">.</span>hasVideo<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">[</span>self retrySendVideoMessage<span class="token operator">:</span>message<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">[</span>self retrySendImageMessage<span class="token operator">:</span>message<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">[</span>self retrySendNormalMessage<span class="token operator">:</span>message<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">mark <span class="token operator">-</span> 重传普通消息</span></span>
<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>retrySendNormalMessage<span class="token operator">:</span><span class="token punctuation">(</span>PUGMessage <span class="token operator">*</span><span class="token punctuation">)</span>message <span class="token punctuation">{<!-- --></span>
    @<span class="token function">weakify</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span>PUGMessageRetryNetworkInterface retrySendMessage<span class="token operator">:</span>message completion<span class="token operator">:</span><span class="token operator">^</span><span class="token punctuation">(</span>PUGError <span class="token operator">*</span> _Nonnull error<span class="token punctuation">,</span> PUGMessage <span class="token operator">*</span> _Nonnull data<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        @<span class="token function">strongify</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span>self done<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">[</span>self uploadMediaFailedWithMessage<span class="token operator">:</span>message error<span class="token operator">:</span>error<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            NSDictionary <span class="token operator">*</span>info <span class="token operator">=</span> @<span class="token punctuation">{<!-- --></span>
                @<span class="token string">"newMessage"</span> <span class="token operator">:</span> data<span class="token punctuation">,</span>
                @<span class="token string">"originalMessage"</span> <span class="token operator">:</span> message
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token punctuation">[</span><span class="token punctuation">[</span>NSNotificationCenter defaultCenter<span class="token punctuation">]</span> postNotificationName<span class="token operator">:</span>PUGRetrySendMessageSuccessNotification object<span class="token operator">:</span>nil userInfo<span class="token operator">:</span>info<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">[</span>self logRetryMessageSCWithMessage<span class="token operator">:</span>message<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="_443">
     </a>
     总结
    </h3>
    <p>
     这里介绍了消息收发以及数据管理部分的基本设计，并对重构前后做了对比，可以明显看出来良好架构对于开发效率以及维护成本方面的优势，由于个人水平有限，以及篇幅限制，这里没有列出一些巧妙设计的细节，包括参数构造器设计，这个与具体业务场景有关，有兴趣可以私信
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f49443331343834363831382f:61727469636c652f64657461696c732f313436303936363436" class_="artid" style="display:none">
 </p>
</div>


