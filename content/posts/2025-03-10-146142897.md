---
layout: post
title: "PySpark实现导出两个包含多个Parquet数据文件的S3目录里的对应值的差异值分析"
date: 2025-03-10 06:21:31 +0800
description: "【代码】PySpark实现导出两个包含多个Parquet数据文件的S3目录里的对应值的差异值分析。"
keywords: "PySpark实现导出两个包含多个Parquet数据文件的S3目录里的对应值的差异值分析"
categories: ['未分类']
tags: ['数据分析', '云计算', 'Spark', 'Python']
artid: "146142897"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146142897
    alt: "PySpark实现导出两个包含多个Parquet数据文件的S3目录里的对应值的差异值分析"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146142897
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146142897
cover: https://bing.ee123.net/img/rand?artid=146142897
image: https://bing.ee123.net/img/rand?artid=146142897
img: https://bing.ee123.net/img/rand?artid=146142897
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     PySpark实现导出两个包含多个Parquet数据文件的S3目录里的对应值的差异值分析
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="./../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="./../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     编写PySpark代码实现从一个包含多个Parquet数据文件的Amazon S3目录的dataframe数据里取两个维度字段，一个度量字段的数据，根据这两个维度字段的数据分组统计，计算度量字段的数据的分组总计值，得到一个包含两个维度字段和度量字段的分组总计值字段的dataframe，再从另一个包含多个Parquet数据文件的S3目录的dataframe数据里取两个维度字段，一个度量字段的数据组成一个dataframe，将这两个字段的对应字段full outer join起来，显示所有字段和两个度量字段值相减的值，以及相减的值除以第一个dataframe的度量值的百分比数值。
    </p>
    <p>
     PySpark代码：
    </p>
    <pre><code class="prism language-python"><span class="token keyword">from</span> pyspark<span class="token punctuation">.</span>sql <span class="token keyword">import</span> SparkSession
<span class="token keyword">from</span> pyspark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>functions <span class="token keyword">import</span> <span class="token builtin">sum</span><span class="token punctuation">,</span> col<span class="token punctuation">,</span> coalesce<span class="token punctuation">,</span> lit

<span class="token comment"># 初始化SparkSession</span>
spark <span class="token operator">=</span> SparkSession<span class="token punctuation">.</span>builder \
    <span class="token punctuation">.</span>appName<span class="token punctuation">(</span><span class="token string">"MetricComparison"</span><span class="token punctuation">)</span> \
    <span class="token punctuation">.</span>getOrCreate<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 读取第一个S3目录数据并进行聚合</span>
df1 <span class="token operator">=</span> spark<span class="token punctuation">.</span>read<span class="token punctuation">.</span>parquet<span class="token punctuation">(</span><span class="token string">"s3a://your-bucket/first-data-path/"</span><span class="token punctuation">)</span>
df1_agg <span class="token operator">=</span> df1<span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token string">"dim_col1"</span><span class="token punctuation">,</span> <span class="token string">"dim_col2"</span><span class="token punctuation">,</span> <span class="token string">"metric_col"</span><span class="token punctuation">)</span> \
    <span class="token punctuation">.</span>groupBy<span class="token punctuation">(</span><span class="token string">"dim_col1"</span><span class="token punctuation">,</span> <span class="token string">"dim_col2"</span><span class="token punctuation">)</span> \
    <span class="token punctuation">.</span>agg<span class="token punctuation">(</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token string">"metric_col"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>alias<span class="token punctuation">(</span><span class="token string">"total_metric1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 读取第二个S3目录数据并进行聚合</span>
df2 <span class="token operator">=</span> spark<span class="token punctuation">.</span>read<span class="token punctuation">.</span>parquet<span class="token punctuation">(</span><span class="token string">"s3a://your-bucket/second-data-path/"</span><span class="token punctuation">)</span>
df2_agg <span class="token operator">=</span> df2<span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token string">"dim_col1"</span><span class="token punctuation">,</span> <span class="token string">"dim_col2"</span><span class="token punctuation">,</span> <span class="token string">"metric_col"</span><span class="token punctuation">)</span> \
    <span class="token punctuation">.</span>groupBy<span class="token punctuation">(</span><span class="token string">"dim_col1"</span><span class="token punctuation">,</span> <span class="token string">"dim_col2"</span><span class="token punctuation">)</span> \
    <span class="token punctuation">.</span>agg<span class="token punctuation">(</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token string">"metric_col"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>alias<span class="token punctuation">(</span><span class="token string">"total_metric2"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 执行Full Outer Join</span>
joined_df <span class="token operator">=</span> df1_agg<span class="token punctuation">.</span>join<span class="token punctuation">(</span>
    df2_agg<span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token string">"dim_col1"</span><span class="token punctuation">,</span> <span class="token string">"dim_col2"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"full_outer"</span>
<span class="token punctuation">)</span>

<span class="token comment"># 计算度量差值及百分比</span>
result_df <span class="token operator">=</span> joined_df<span class="token punctuation">.</span>withColumn<span class="token punctuation">(</span>
    <span class="token string">"metric_diff"</span><span class="token punctuation">,</span>
    coalesce<span class="token punctuation">(</span>col<span class="token punctuation">(</span><span class="token string">"total_metric1"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> coalesce<span class="token punctuation">(</span>col<span class="token punctuation">(</span><span class="token string">"total_metric2"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">.</span>withColumn<span class="token punctuation">(</span>
    <span class="token string">"percentage_diff"</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span>col<span class="token punctuation">(</span><span class="token string">"metric_diff"</span><span class="token punctuation">)</span> <span class="token operator">/</span> coalesce<span class="token punctuation">(</span>col<span class="token punctuation">(</span><span class="token string">"total_metric1"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span>
<span class="token punctuation">)</span>

<span class="token comment"># 显示结果（可根据需要调整显示行数）</span>
result_df<span class="token punctuation">.</span>show<span class="token punctuation">(</span>truncate<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
</code></pre>
    <h4>
     <a id="_45">
     </a>
     关键步骤说明：
    </h4>
    <ol>
     <li>
      <p>
       <strong>
        数据读取与聚合
       </strong>
       ：
      </p>
      <ul>
       <li>
        从两个S3路径分别读取Parquet数据
       </li>
       <li>
        使用
        <code>
         groupBy
        </code>
        对两个维度字段分组
       </li>
       <li>
        使用
        <code>
         sum
        </code>
        聚合函数计算度量字段总计
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        表连接
       </strong>
       ：
      </p>
      <ul>
       <li>
        使用
        <code>
         full_outer
        </code>
        连接方式合并两个数据集
       </li>
       <li>
        保留两个表中所有的维度组合
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        差值计算
       </strong>
       ：
      </p>
      <ul>
       <li>
        使用
        <code>
         coalesce
        </code>
        处理空值（将null转换为0进行运算）
       </li>
       <li>
        计算绝对值差值和百分比差值
       </li>
       <li>
        添加防止除零机制（将分母null转换为1）
       </li>
      </ul>
     </li>
    </ol>
    <h4>
     <a id="_60">
     </a>
     注意事项：
    </h4>
    <ol>
     <li>
      <p>
       需要将代码中的以下占位符替换为实际值：
      </p>
      <ul>
       <li>
        <code>
         s3a://your-bucket/first-data-path/
        </code>
       </li>
       <li>
        <code>
         s3a://your-bucket/second-data-path/
        </code>
       </li>
       <li>
        <code>
         dim_col1
        </code>
        ,
        <code>
         dim_col2
        </code>
        （维度字段名）
       </li>
       <li>
        <code>
         metric_col
        </code>
        （度量字段名）
       </li>
      </ul>
     </li>
     <li>
      <p>
       如果数据量较大：
      </p>
      <ul>
       <li>
        建议添加缓存策略
        <code>
         .cache()
        </code>
       </li>
       <li>
        调整shuffle分区数：
        <code>
         spark.conf.set("spark.sql.shuffle.partitions", 200)
        </code>
       </li>
      </ul>
     </li>
     <li>
      <p>
       空值处理策略可根据业务需求调整：
      </p>
      <ul>
       <li>
        当前代码将null视为0进行计算
       </li>
       <li>
        如需保留null可使用
        <code>
         .withColumn("metric_diff", col("total_metric1") - col("total_metric2"))
        </code>
       </li>
      </ul>
     </li>
     <li>
      <p>
       结果输出方式：
      </p>
      <ul>
       <li>
        当前使用
        <code>
         .show()
        </code>
        直接打印
       </li>
       <li>
        可改用
        <code>
         .write
        </code>
        方法写入存储系统
       </li>
      </ul>
     </li>
    </ol>
    <p>
     最终结果示例：
    </p>
    <pre><code>+---------+---------+-------------+-------------+-----------+------------------+
|dim_col1 |dim_col2 |total_metric1|total_metric2|metric_diff|percentage_diff   |
+---------+---------+-------------+-------------+-----------+------------------+
|A        |X        |1500         |1200         |300        |20.0              |
|B        |Y        |800          |null         |800        |100.0             |
|C        |Z        |null         |500          |-500       |null              |
+---------+---------+-------------+-------------+-----------+------------------+
</code></pre>
   </div>
   <link href="./../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="./../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f33303737373931332f:61727469636c652f64657461696c732f313436313432383937" class_="artid" style="display:none">
 </p>
</div>


