---
layout: post
title: "Java-Agent"
date: 2025-03-05 19:00:00 +0800
description: "çœŸæ­£æ‹‰å¼€å¼€å‘è€…å·®è·çš„ï¼Œä»æ¥ä¸æ˜¯ä»£ç é‡ï¼æˆ‘æ˜¯æ›¾ç»­ç¼˜ï¼Œä»Šå¤©å¸¦ä½ ç”¨æ¶æ„å¸ˆæ€ç»´æ‹†è§£æŠ€æœ¯æ–¹æ¡ˆï¼Œå…³æ³¨æˆ‘çš„äººéƒ½åœ¨æå‡è®¤çŸ¥ç»´åº¦ğŸ§ â€"
keywords: "Java Agent"
categories: ['æœªåˆ†ç±»']
tags: ['å¼€å‘è¯­è¨€', 'Java']
artid: "145694989"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=145694989
    alt: "Java-Agent"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=145694989
featuredImagePreview: https://bing.ee123.net/img/rand?artid=145694989
cover: https://bing.ee123.net/img/rand?artid=145694989
image: https://bing.ee123.net/img/rand?artid=145694989
img: https://bing.ee123.net/img/rand?artid=145694989
---

# Java Agent
> â€œçœŸæ­£æ‹‰å¼€å¼€å‘è€…å·®è·çš„ï¼Œä»æ¥ä¸æ˜¯ä»£ç é‡ï¼æˆ‘æ˜¯æ›¾ç»­ç¼˜ï¼Œä»Šå¤©å¸¦ä½ ç”¨æ¶æ„å¸ˆæ€ç»´æ‹†è§£æŠ€æœ¯æ–¹æ¡ˆï¼Œå…³æ³¨æˆ‘çš„äººéƒ½åœ¨æå‡è®¤çŸ¥ç»´åº¦ğŸ§ â€
## JVMTI
JVMTIï¼ˆJava Virtual Machine Tool Interfaceï¼‰æ˜¯ä¸€ç§æä¾›å¯¹ Java è™šæ‹Ÿæœºå†…éƒ¨çŠ¶æ€è®¿é—®çš„åŸç”ŸNative
ç¼–ç¨‹æ¥å£ï¼Œå®ƒå…è®¸å¤–éƒ¨å·¥å…·å’Œä»£ç†ç¨‹åºä»¥åŸç”Ÿä»£ç çš„å½¢å¼ä¸JVMè¿›è¡Œäº¤äº’ã€‚è¿™ä½¿å¾—å¼€å‘äººå‘˜ä¸ä»…èƒ½å¤Ÿè°ƒè¯•åœ¨è¯¥è™šæ‹Ÿæœºä¸Šè¿è¡Œçš„ Java
ç¨‹åºï¼Œè¿˜èƒ½æŸ¥çœ‹å®ƒä»¬è¿è¡Œçš„çŠ¶æ€ï¼Œè®¾ç½®å›è°ƒå‡½æ•°ï¼Œæ§åˆ¶æŸäº›ç¯å¢ƒå˜é‡ï¼Œä»è€Œä¼˜åŒ–ç¨‹åºæ€§èƒ½ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¹¶éæ‰€æœ‰çš„JVMå®ç°éƒ½æ”¯æŒJVMTIã€‚
JVMTI æ˜¯ Java å¹³å°è°ƒè¯•ä½“ç³»ï¼ˆJava Platform Debugger Architectureï¼ŒJPDAï¼‰çš„ä¸€éƒ¨åˆ†ï¼Œä½äº JPDA
çš„æœ€åº•å±‚ã€‚è¿™ç§æœºåˆ¶è‡ª J2SE 5.0 å¼•å…¥ï¼Œå–ä»£äº†æ—©æœŸçš„ JVMDI å’Œ JVMPI æ¥å£ï¼Œæä¾›äº†æ›´å…¨é¢å’Œé«˜æ•ˆçš„å·¥å…·æ¥å£ã€‚
JVMTI æä¾›äº†ä¸€ç»„ C è¯­è¨€ APIï¼Œå…è®¸ä»£ç†æŸ¥è¯¢å’Œä¿®æ”¹ JVM çš„çŠ¶æ€ã€‚è¿™äº› API åŒ…æ‹¬ `jvmtiEnv` æ¥å£ï¼Œä»£ç†å¯ä»¥é€šè¿‡å®ƒè®¿é—® JVM
çš„å†…éƒ¨ä¿¡æ¯ã€‚
è¦ä½¿ç”¨ JVMTI ï¼Œæˆ‘ä»¬éœ€è¦ç¼–å†™ä¸€ä¸ª C æˆ– C++ ç¨‹åºæ¥å®ç°æˆ‘ä»¬çš„å·¥å…·é€»è¾‘ã€‚è¿™ä¸ªç¨‹åºå°†ä½¿ç”¨ JVMTI API ä¸ JVM
äº¤äº’ã€‚æ¥ä¸‹æ¥éœ€è¦ç¼–è¯‘æˆ‘ä»¬çš„ä»£ç†ä»£ç ç”Ÿæˆä¸€ä¸ªå…±äº«åº“ï¼ˆåœ¨ Linux ä¸Šæ˜¯ `.so` æ–‡ä»¶ï¼Œåœ¨ Windows ä¸Šæ˜¯ `.dll` æ–‡ä»¶ï¼‰ã€‚
åœ¨å¯åŠ¨ JVM æ—¶é€šè¿‡ `-agentlib` å‚æ•°æŒ‡å®šä»£ç†åº“çš„ä½ç½®ã€‚
æˆ–è€…ä½¿ç”¨ `jattach` å‘½ä»¤æˆ–é€šè¿‡ JVM çš„ `attach` æœºåˆ¶æ¥åŠ¨æ€åŠ è½½ä»£ç†ã€‚
ç”±äº JVMTI ä¸»è¦æ˜¯åŸºäº C/C++ çš„ï¼Œå› æ­¤å¯¹äºä¹ æƒ¯ä½¿ç”¨ Java å¼€å‘çš„å¼€å‘è€…æ¥è¯´ï¼Œè°ƒè¯•å¯èƒ½è¾ƒä¸ºå›°éš¾ã€‚
## `Instrumentation`æ¥å£
Instrumentationæ˜¯Java 6å¼•å…¥çš„APIï¼Œä½äº `java.lang.instrument`
åŒ…ä¸‹ï¼Œæ—¨åœ¨ç®€åŒ–JVMTIçš„ä¸€äº›å¤æ‚æ€§ï¼Œå¹¶æä¾›æ›´é«˜çº§åˆ«çš„æŠ½è±¡æ¥æ”¯æŒJavaä»£ç†ï¼ˆJava agentsï¼‰ã€‚
Instrumentationæä¾›äº†ä¸€ç»„æ›´æ˜“äºä½¿ç”¨çš„å‡½æ•°ï¼Œä½¿å¾—Javaå¼€å‘è€…å¯ä»¥æ›´å®¹æ˜“åœ°ç›‘æ§å’Œä¿®æ”¹JVMï¼Œè€Œä¸éœ€è¦æ·±å…¥äº†è§£JVMTIçš„ç»†èŠ‚ã€‚ä¾‹å¦‚ï¼ŒInstrumentationæ¥å£ä¸­çš„`addTransformer`æ–¹æ³•å®é™…ä¸Šæ˜¯é€šè¿‡JVMTIçš„å‡½æ•°æ¥å®ç°çš„ã€‚
è¦ä½¿ç”¨Instrumentationï¼Œéœ€è¦åˆ›å»ºä¸€ä¸ªåŒ…å« `premain` æ–¹æ³•æˆ– `agentmain` æ–¹æ³•çš„ç±»ï¼Œè¿™äº›æ–¹æ³•æ˜¯ Java Agent
çš„å…¥å£ç‚¹ï¼Œ`Instrumentation`æ¥å£å¯ä½œä¸ºæ–¹æ³•çš„å‚æ•°ï¼ŒJVM ä¼šåœ¨é€‚å½“çš„æ—¶å€™è°ƒç”¨å®ƒä»¬ã€‚
### é‡è¦æ–¹æ³•
ä»¥ä¸‹æ˜¯ä¸€äº›`Instrumentation`æ¥å£ä¸­å¸¸ç”¨çš„æ–¹æ³•ï¼š
\* `addTransformer(ClassFileTransformer transformer, boolean canRetransform)`: æ·»åŠ ä¸€ä¸ªç±»æ–‡ä»¶è½¬æ¢å™¨ã€‚
\* `retransformClasses(Class ... classes)`: é‡æ–°è½¬æ¢æŒ‡å®šçš„ç±»ã€‚
\* `redefineClasses(ClassDefinition... definitions)`: é‡æ–°å®šä¹‰æŒ‡å®šçš„ç±»ã€‚
\* `getAllLoadedClasses()`: è¿”å›æ‰€æœ‰å·²åŠ è½½çš„ç±»ã€‚
\* `getObjectSize(Object objectToSize)`: è¿”å›æŒ‡å®šå¯¹è±¡åŠå…¶å¼•ç”¨å¯¹è±¡çš„å¤§å°ã€‚
\* `appendToBootstrapClassLoaderSearch(JarFile jarfile)`: å°†æŒ‡å®šçš„jaræ–‡ä»¶æ·»åŠ åˆ°å¼•å¯¼ç±»åŠ è½½å™¨çš„æœç´¢è·¯å¾„ã€‚
\* `appendToSystemClassLoaderSearch(JarFile jarfile)`: å°†æŒ‡å®šçš„jaræ–‡ä»¶æ·»åŠ åˆ°ç³»ç»Ÿç±»åŠ è½½å™¨çš„æœç´¢è·¯å¾„ã€‚
## Java Agent
Java Agentæ˜¯ä¸€ç§ç‰¹æ®Šç±»å‹çš„Javaç¨‹åºï¼Œå®ƒåœ¨JVMï¼ˆJavaè™šæ‹Ÿæœºï¼‰å¯åŠ¨æ—¶æˆ–è¿è¡Œæ—¶è¢«åŠ è½½ï¼Œç”¨äºç›‘æ§å’Œæ“ä½œJVMå†…éƒ¨çš„ä¸€äº›çŠ¶æ€å’Œè¡Œä¸ºã€‚
è¿™ä¸ªJavaç¨‹åºæ˜¯ä¸€ä¸ªjaræ–‡ä»¶ï¼ŒåŒ…å«Agent Classå’ŒMANIFEST.MFã€‚
### Agent Class
Agent Classæ˜¯æŒ‡åŒ…å«`premain`æˆ–`agentmain`æ–¹æ³•çš„Javaç±»ã€‚è¿™ä¸ªç±»æ˜¯Java
Agentçš„æ ¸å¿ƒï¼Œå®ƒè´Ÿè´£å®šä¹‰å½“Agentè¢«åŠ è½½åˆ°JVMæ—¶åº”è¯¥æ‰§è¡Œçš„æ“ä½œã€‚
é€šå¸¸ï¼Œä¸€ä¸ªAgent ClassåªåŒ…å«ä¸€ä¸ª`premain`æ–¹æ³•æˆ–ä¸€ä¸ª`agentmain`æ–¹æ³•ï¼Œæˆ–è€…ä¸¤è€…éƒ½æœ‰ã€‚
Agent Classå¿…é¡»æ‰“åŒ…åœ¨ä¸€ä¸ªjaræ–‡ä»¶ä¸­ï¼Œå¹¶ä¸”è¿™ä¸ªjaræ–‡ä»¶éœ€è¦åœ¨MANIFEST.MFæ–‡ä»¶ä¸­æŒ‡æ˜Agent Classã€‚
#### `premain` æ–¹æ³•
`premain`æ–¹æ³•æ˜¯åœ¨JVMå¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œåœ¨åº”ç”¨ç¨‹åºçš„`main`æ–¹æ³•æ‰§è¡Œä¹‹å‰è¢«è°ƒç”¨çš„æ–¹æ³•ã€‚å®ƒçš„ç›®çš„æ˜¯åœ¨åº”ç”¨ç¨‹åºçš„ä»»ä½•ç±»è¢«åŠ è½½ä¹‹å‰ï¼Œå¯¹JVMè¿›è¡Œåˆå§‹åŒ–è®¾ç½®ã€‚
`premain`æ–¹æ³•æœ‰ä¸¤ç§å¯èƒ½çš„ç­¾åï¼š
public static void premain(String agentArgs, Instrumentation inst);
æˆ–è€…
public static void premain(String agentArgs);
å¦‚æœä¸¤ä¸ªç‰ˆæœ¬éƒ½å­˜åœ¨ï¼Œä¼˜å…ˆä½¿ç”¨å¸¦æœ‰`Instrumentation`å‚æ•°çš„æ–¹æ³•ã€‚
#### `agentmain`æ–¹æ³•
`agentmain`æ–¹æ³•å…è®¸åœ¨JVMè¿è¡Œæ—¶åŠ¨æ€åœ°åŠ è½½Agentã€‚è¿™æ„å‘³ç€åº”ç”¨ç¨‹åºå·²ç»å¯åŠ¨å¹¶ä¸”å¯èƒ½å·²ç»è¿è¡Œäº†ä¸€æ®µæ—¶é—´ï¼Œç„¶åAgentè¢«é™„åŠ åˆ°JVMä¸Šã€‚
`agentmain`æ–¹æ³•çš„ç­¾åå¦‚ä¸‹ï¼š
public static void agentmain(String agentArgs, Instrumentation inst);
æˆ–è€…
public static void agentmain(String agentArgs);
å¦‚æœä¸¤ä¸ªç‰ˆæœ¬éƒ½å­˜åœ¨ï¼Œä¼˜å…ˆä½¿ç”¨å¸¦æœ‰`Instrumentation`å‚æ•°çš„æ–¹æ³•ã€‚
### MANIFEST.MFæ–‡ä»¶
MANIFEST.MFæ–‡ä»¶æ˜¯ä¸€ä¸ªå¤šè¡Œæ–‡æœ¬æ–‡ä»¶ï¼Œä½äºjaræ–‡ä»¶çš„META-INFç›®å½•ä¸‹ã€‚å®ƒåŒ…å«å…³äºjaræ–‡ä»¶å’Œå…¶å†…å®¹çš„å…ƒæ•°æ®ã€‚
ä»¥ä¸‹æ˜¯MANIFEST.MFæ–‡ä»¶çš„ä¸€ä¸ªåŸºæœ¬ç¤ºä¾‹ï¼Œå®ƒæŒ‡æ˜äº†Premain-Classå’ŒAgent-Classå±æ€§ï¼š
Manifest-Version: 1.0
Premain-Class: com.example.MyAgent
Agent-Class: com.example.MyAgent
Can-Redefine-Classes: true
Can-Retransform-Classes: true
ä»¥ä¸‹æ˜¯æ¯ä¸ªå±æ€§çš„è¯´æ˜ï¼š
\* `Manifest-Version`: æŒ‡ç¤ºmanifestæ–‡ä»¶çš„ç‰ˆæœ¬ï¼Œé€šå¸¸æ˜¯1.0ã€‚
\* `Premain-Class`: æŒ‡å®šåŒ…å«`premain`æ–¹æ³•çš„ç±»çš„å…¨é™å®šåã€‚è¿™ä¸ªç±»ä¼šåœ¨JVMå¯åŠ¨æ—¶åŠ è½½Agentä¹‹å‰è¢«è°ƒç”¨ã€‚
\* `Agent-Class`: æŒ‡å®šåŒ…å«`agentmain`æ–¹æ³•çš„ç±»çš„å…¨é™å®šåã€‚è¿™ä¸ªç±»ä¼šåœ¨JVMè¿è¡Œæ—¶åŠ¨æ€åŠ è½½Agentæ—¶è¢«è°ƒç”¨ã€‚
\* `Can-Redefine-Classes`: å¦‚æœè®¾ç½®ä¸ºtrueï¼Œåˆ™å…è®¸é‡æ–°å®šä¹‰ç±»ã€‚è¿™æ˜¯åœ¨`Instrumentation`æ¥å£ä¸­ä½¿ç”¨`redefineClasses`æ–¹æ³•æ‰€å¿…éœ€çš„ã€‚
\* `Can-Retransform-Classes`: å¦‚æœè®¾ç½®ä¸ºtrueï¼Œåˆ™å…è®¸é‡æ–°è½¬æ¢ç±»ã€‚è¿™æ˜¯åœ¨`Instrumentation`æ¥å£ä¸­ä½¿ç”¨`retransformClasses`æ–¹æ³•æ‰€å¿…éœ€çš„ã€‚
### åˆ›å»ºAgentçš„æ­¥éª¤
#### åˆ›å»º Agent Class
é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ç¼–å†™ä¸€ä¸ª Java ç±»ï¼Œè¯¥ç±»åŒ…å« `premain` æ–¹æ³•ï¼ˆå¦‚æœå¸Œæœ›åœ¨ JVM å¯åŠ¨æ—¶åŠ è½½ï¼‰æˆ– `agentmain` æ–¹æ³•ï¼ˆå¦‚æœå¸Œæœ›åœ¨
JVM è¿è¡Œæ—¶åŠ è½½ï¼‰ã€‚
ä¾‹å¦‚ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ Agent Class ç¤ºä¾‹ï¼š
import java.lang.instrument.Instrumentation;
public class MyAgent {
public static void premain(String agentArgs, Instrumentation inst) {
System.out.println("MyAgent premain method called with args: " + agentArgs);
// åœ¨è¿™é‡Œå¯ä»¥æ·»åŠ å­—èŠ‚ç æ“ä½œæˆ–å…¶ä»–åˆå§‹åŒ–é€»è¾‘
// æ³¨å†Œå­—èŠ‚ç è½¬æ¢å™¨
inst.addTransformer(new MyTransformer());
}
public static void agentmain(String agentArgs, Instrumentation inst) {
System.out.println("MyAgent agentmain method called with args: " + agentArgs);
// å¦‚æœå®ç°äº† agentmain æ–¹æ³•ï¼Œé‚£ä¹ˆå®ƒä¼šåœ¨ JVM è¿è¡Œæ—¶åŠ¨æ€åŠ è½½ agent æ—¶è¢«è°ƒç”¨
}
}
public class MyTransformer implements ClassFileTransformer {
@Override
public byte[] transform(ClassLoader loader, String className, Class  classBeingRedefined,
ProtectionDomain protectionDomain, byte[] classfileBuffer) throws IllegalClassFormatException {
// å¯¹å­—èŠ‚ç è¿›è¡Œæ“ä½œ
return transformedBytes;
}
}
#### ç¼–è¯‘ Java ç±»
ç¼–è¯‘ä¸Šé¢çš„ Java ç±»ï¼Œç”Ÿæˆ `.class` æ–‡ä»¶ã€‚å‡è®¾æˆ‘ä»¬çš„æºä»£ç æ–‡ä»¶åä¸º `MyAgent.java`ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿›è¡Œç¼–è¯‘ï¼š
javac MyAgent.java
è¿™å°†ä¼šç”Ÿæˆ `MyAgent.class` æ–‡ä»¶ã€‚
#### åˆ›å»º MANIFEST.MF æ–‡ä»¶
åˆ›å»ºä¸€ä¸ªç›®å½•ç»“æ„æ¥å­˜æ”¾ç¼–è¯‘åçš„ç±»æ–‡ä»¶å’ŒMANIFEST.MFæ–‡ä»¶ã€‚ä¾‹å¦‚ï¼š
myagent/
â”œâ”€â”€ com/
â”‚ â””â”€â”€ example/
â”‚ â””â”€â”€ MyAgent.class
â””â”€â”€ META-INF/
â””â”€â”€ MANIFEST.MF
åˆ›å»ºä¸€ä¸ª `MANIFEST.MF` æ–‡ä»¶ï¼Œå¹¶åœ¨å…¶ä¸­æŒ‡å®š Agent Class åç§°ã€‚è¿™ä¸ªæ–‡ä»¶åº”è¯¥æ”¾åœ¨ JAR æ–‡ä»¶çš„ `META-
INF/MANIFEST.MF` è·¯å¾„ä¸‹ã€‚å†…å®¹å¦‚ä¸‹ï¼š
Manifest-Version: 1.0
Agent-Class: com.example.MyAgent
Premain-Class: com.example.MyAgent
Can-Redefine-Classes: true
Can-Retransform-Classes: true
Can-Set-Native-Method-Prefix: false
åœ¨è¿™é‡Œï¼Œ`Agent-Class` è¡ŒæŒ‡å®šäº† Agent Class çš„å®Œå…¨é™å®šåï¼ˆåŒ…æ‹¬åŒ…åï¼‰ã€‚
#### æ‰“åŒ…ä¸º JAR æ–‡ä»¶
ä½¿ç”¨ `jar` å‘½ä»¤å°†æ‰€æœ‰çš„ `.class` æ–‡ä»¶ä»¥åŠ `MANIFEST.MF` æ–‡ä»¶æ‰“åŒ…æˆä¸€ä¸ª JAR æ–‡ä»¶ã€‚ä¾‹å¦‚ï¼š
jar cf MyAgent.jar MyAgent.class META-INF/
è¿™å°†åˆ›å»ºä¸€ä¸ªåä¸º `MyAgent.jar` çš„ JAR æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«äº† Agent Class ä»¥åŠ MANIFEST æ–‡ä»¶ã€‚
#### å¯åŠ¨Agent
ç°åœ¨æˆ‘ä»¬æœ‰äº†ä¸€ä¸ªåŒ…å«æ­£ç¡®é…ç½®çš„ JAR æ–‡ä»¶ï¼Œå¯ä»¥é€šè¿‡ `-javaagent` å‚æ•°æ¥å¯åŠ¨ JVM å¹¶åŠ è½½ä½ çš„ Java Agentã€‚ä¾‹å¦‚ï¼š
java -javaagent:/path/to/MyAgent.jar=option=value -jar yourapp.jar
åœ¨è¿™é‡Œï¼Œ`/path/to/MyAgent.jar` æ˜¯æˆ‘ä»¬çš„ JAR æ–‡ä»¶çš„è·¯å¾„ï¼Œ`option=value` æ˜¯ä¼ é€’ç»™ `premain` æ–¹æ³•çš„å‚æ•°ã€‚
Java Agentçš„åŠ è½½åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼šåœ¨JVMå¯åŠ¨æ—¶åŠ è½½å’Œåœ¨JVMè¿è¡Œæ—¶åŠ¨æ€åŠ è½½ã€‚ä»¥ä¸‹æ˜¯è¿™ä¸¤ç§æƒ…å†µçš„è¯¦ç»†è¯´æ˜ã€‚
##### JVMå¯åŠ¨æ—¶åŠ è½½
åœ¨JVMå¯åŠ¨æ—¶åŠ è½½Agentæ˜¯é€šè¿‡`-javaagent`å‘½ä»¤è¡Œé€‰é¡¹æ¥å®ç°çš„ã€‚
åœ¨å¯åŠ¨JVMæ—¶ï¼Œä½¿ç”¨`-javaagent`é€‰é¡¹æŒ‡å®šAgent jaræ–‡ä»¶çš„ä½ç½®ã€‚
java -javaagent:myagent.jar -jar MyApp.jar
æˆ–è€…ï¼Œå¦‚æœä½ æ˜¯åœ¨å‘½ä»¤è¡Œå¯åŠ¨Javaåº”ç”¨ç¨‹åºï¼š
java -javaagent:myagent.jar com.example.MyApp
åœ¨è¿™é‡Œï¼Œ`myagent.jar`æ˜¯åŒ…å«Agentçš„jaræ–‡ä»¶ï¼Œ`MyApp.jar`æˆ–`com.example.MyApp`æ˜¯ä½ è¦å¯åŠ¨çš„åº”ç”¨ç¨‹åºã€‚
å¯ä»¥é€šè¿‡`-javaagent`é€‰é¡¹å¤šæ¬¡æŒ‡å®šå¤šä¸ªAgentã€‚
##### JVMè¿è¡Œæ—¶åŠ¨æ€åŠ è½½
åŠ¨æ€åŠ è½½Agentå…è®¸æˆ‘ä»¬åœ¨JVMå·²ç»è¿è¡Œçš„æƒ…å†µä¸‹åŠ è½½Agentï¼Œè€Œä¸éœ€è¦é‡å¯JVMã€‚
æˆ‘ä»¬çš„Agentç±»åº”è¯¥å®ç°ä¸€ä¸ª`agentmain`æ–¹æ³•ï¼Œç”¨äºåœ¨Agentè¢«åŠ¨æ€åŠ è½½æ—¶æ‰§è¡Œã€‚
public class MyAgent {
public static void agentmain(String agentArgs, Instrumentation inst) {
// æ‰§è¡Œæ“ä½œ
}
}
æŒ‰ç…§å¯åŠ¨æ—¶åŠ è½½Agentçš„æ­¥éª¤ï¼Œåˆ›å»ºåŒ…å«`Agent-Class`å±æ€§çš„`MANIFEST.MF`æ–‡ä»¶ï¼Œå¹¶å°†Agentç±»æ‰“åŒ…åˆ°jaræ–‡ä»¶ä¸­ã€‚
ä½¿ç”¨`com.sun.tools.attach`åŒ…ä¸­çš„`VirtualMachine`ç±»æ¥attachåˆ°ç›®æ ‡JVMå¹¶åŠ è½½Agentã€‚
import com.sun.tools.attach.\*;
public class AgentLoader {
public static void main(String[] args) throws Exception {
// è·å–ç›®æ ‡JVMçš„PID
String pid = "1234"; // éœ€è¦æ›¿æ¢ä¸ºç›®æ ‡JVMçš„PID
// Attachåˆ°ç›®æ ‡JVM
VirtualMachine vm = VirtualMachine.attach(pid);
// åŠ è½½Agent
vm.loadAgent("/path/to/myagent.jar", "arguments");
// Detach
vm.detach();
}
}
### Attach æ¥å£
Attach æ¥å£æ˜¯ Java è™šæ‹Ÿæœºï¼ˆJVMï¼‰æä¾›çš„ä¸€ä¸ªç”¨äºåŠ¨æ€åŠ è½½ Java Agent çš„æœºåˆ¶ã€‚é€šè¿‡ Attach æ¥å£ï¼Œå¯ä»¥åœ¨ Java
è™šæ‹Ÿæœºï¼ˆJVMï¼‰è¿è¡Œæ—¶é™„åŠ ä¸€ä¸ª Java Agentã€‚
JDK è‡ªå¸¦çš„ä¸€äº›å‘½ä»¤ï¼Œå¦‚ jstackï¼ˆç”¨äºæ‰“å°çº¿ç¨‹æ ˆï¼‰ã€jpsï¼ˆç”¨äºåˆ—å‡ºJavaè¿›ç¨‹ï¼‰å’Œ jmapï¼ˆç”¨äºè¿›è¡Œå†…å­˜dumpï¼‰ï¼Œéƒ½æ˜¯é€šè¿‡Attach
APIå®ç°çš„ã€‚
#### è¿›ç¨‹é—´é€šä¿¡
Attach APIåˆ©ç”¨è¿›ç¨‹é—´é€šä¿¡æœºåˆ¶ï¼ˆInter-Process Communication,
IPCï¼‰æ¥å®ç°å¤–éƒ¨è¿›ç¨‹ä¸JVMä¹‹é—´çš„äº¤äº’ã€‚ä»¥ä¸‹æ˜¯è¿›ç¨‹é—´é€šä¿¡çš„è¿‡ç¨‹ï¼š
\* \*\*Socketè¿æ¥\*\* ï¼šAttach APIé€šè¿‡åˆ›å»ºä¸€ä¸ªsocketè¿æ¥åˆ°ç›®æ ‡JVMçš„Attach Listenerçº¿ç¨‹ã€‚è¿™ä¸ªè¿æ¥æ˜¯å»ºç«‹åœ¨TCPæˆ–UNIXåŸŸsocketä¹‹ä¸Šçš„ï¼Œå…·ä½“å–å†³äºæ“ä½œç³»ç»Ÿã€‚
\* \*\*æŒ‡ä»¤å‘é€\*\* ï¼šä¸€æ—¦è¿æ¥å»ºç«‹ï¼Œå¤–éƒ¨è¿›ç¨‹å°±å¯ä»¥é€šè¿‡è¿™ä¸ªsocketå‘é€æŒ‡ä»¤ç»™JVMã€‚è¿™äº›æŒ‡ä»¤å¯ä»¥æ˜¯åŠ è½½Java Agentã€è·å–JVMä¿¡æ¯ã€è§¦å‘åƒåœ¾å›æ”¶ç­‰ã€‚
\* \*\*ç»“æœè¿”å›\*\* ï¼šJVMåœ¨æ¥æ”¶åˆ°æŒ‡ä»¤åï¼Œä¼šæ‰§è¡Œç›¸åº”çš„æ“ä½œï¼Œå¹¶å°†ç»“æœè¿”å›ç»™å¤–éƒ¨è¿›ç¨‹ã€‚è¿™ç§é€šä¿¡æ˜¯åŒå‘çš„ï¼Œç¡®ä¿äº†å¤–éƒ¨è¿›ç¨‹å¯ä»¥ä¸JVMè¿›è¡Œæœ‰æ•ˆçš„äº¤äº’ã€‚
#### ä¿¡å·ç›‘å¬çº¿ç¨‹
åœ¨JVMå†…éƒ¨ï¼Œæœ‰ä¸€ä¸ªåä¸ºâ€œSignal Dispatcherâ€çš„çº¿ç¨‹ï¼Œå®ƒåœ¨JVMå¯åŠ¨æ—¶è¢«åˆ›å»ºï¼Œä¸“é—¨ç”¨äºç›‘å¬æ“ä½œç³»ç»Ÿå‘å‡ºçš„ä¿¡å·ã€‚
å½“æ“ä½œç³»ç»Ÿå‘JVMè¿›ç¨‹å‘é€ç‰¹å®šä¿¡å·æ—¶ï¼ŒSignal
Dispatcherçº¿ç¨‹ä¼šæ•è·è¿™äº›ä¿¡å·å¹¶è¿›è¡Œå¤„ç†ã€‚ä¾‹å¦‚ï¼Œåœ¨æŸäº›æ“ä½œç³»ç»Ÿä¸­ï¼Œå‘é€ç‰¹å®šçš„ä¿¡å·å¯ä»¥è§¦å‘JVMæ‰§è¡Œé™„åŠ ï¼ˆattachï¼‰æˆ–åˆ†ç¦»ï¼ˆdetachï¼‰æ“ä½œã€‚
åœ¨Attachæœºåˆ¶ä¸­ï¼Œå½“å¤–éƒ¨è¿›ç¨‹æƒ³è¦è¿æ¥åˆ°JVMæ—¶ï¼Œå®ƒå¯èƒ½ä¼šé€šè¿‡æ“ä½œç³»ç»Ÿå‘é€ä¸€ä¸ªä¿¡å·ç»™JVMã€‚JVMæ¥æ”¶åˆ°è¿™ä¸ªä¿¡å·åï¼Œä¼šå”¤é†’Attach
Listenerçº¿ç¨‹ï¼Œå‡†å¤‡æ¥å—å³å°†åˆ°æ¥çš„socketè¿æ¥è¯·æ±‚ã€‚
#### Attachå·¥ä½œæµç¨‹
1. \*\*å‘ç°JVMå®ä¾‹\*\* ï¼šå¤–éƒ¨è¿›ç¨‹é€šè¿‡æ“ä½œç³»ç»Ÿçš„è¿›ç¨‹ç®¡ç†åŠŸèƒ½æ¥æŸ¥æ‰¾ç›®æ ‡JVMçš„PIDã€‚
2. \*\*å‘é€ä¿¡å·\*\* ï¼šå¤–éƒ¨è¿›ç¨‹é€šè¿‡æ“ä½œç³»ç»Ÿå‘é€ä¸€ä¸ªä¿¡å·ç»™ç›®æ ‡JVMã€‚è¿™ä¸ªä¿¡å·ä¼šç”±Signal Dispatcherçº¿ç¨‹æ¥æ”¶ã€‚
3. \*\*å»ºç«‹è¿æ¥\*\* ï¼šSignal Dispatcherçº¿ç¨‹å”¤é†’Attach Listenerçº¿ç¨‹ï¼Œè¯¥çº¿ç¨‹éšåä¼šç›‘å¬æ¥è‡ªå¤–éƒ¨è¿›ç¨‹çš„socketè¿æ¥è¯·æ±‚ã€‚
4. \*\*éªŒè¯å’Œæˆæƒ\*\* ï¼šä¸€æ—¦socketè¿æ¥å»ºç«‹ï¼ŒJVMä¼šè¿›è¡Œå®‰å…¨æ£€æŸ¥ï¼Œç¡®ä¿å¤–éƒ¨è¿›ç¨‹æœ‰æƒé™æ‰§è¡Œåç»­æ“ä½œã€‚
5. \*\*æ‰§è¡Œæ“ä½œ\*\* ï¼šé€šè¿‡éªŒè¯çš„å¤–éƒ¨è¿›ç¨‹ç°åœ¨å¯ä»¥é€šè¿‡Attach APIå‘é€æŒ‡ä»¤ï¼ŒJVMæ‰§è¡Œè¿™äº›æŒ‡ä»¤å¹¶è¿”å›ç»“æœã€‚
### Agentå·¥ä½œæµç¨‹
Java Agent åˆ©ç”¨ `Instrumentation` API å’Œ `ClassFileTransformer` å®ç°ç±»åŠ è½½æ—¶çš„å­—èŠ‚ç ä¿®æ”¹ï¼Œä»è€Œè¾¾åˆ°
AOPã€æ€§èƒ½ç›‘æ§ã€å®‰å…¨æ£€æŸ¥ç­‰ç›®çš„ã€‚
1. \*\*JVMå¯åŠ¨\*\* ï¼šå½“JVMå¯åŠ¨æ—¶ï¼Œå®ƒä¼šåŠ è½½ä¸€ä¸ªjava agentçš„classæ–‡ä»¶ã€‚
2. \*\*æ‰§è¡Œpremain()æ–¹æ³•\*\* ï¼šåœ¨java agentçš„classè¢«åŠ è½½ä¹‹åï¼Œä¼šæ‰§è¡Œè¯¥ç±»ä¸­çš„premain()æ–¹æ³•ã€‚è¿™æ˜¯agentçš„ä¸»è¦å…¥å£ç‚¹ã€‚
3. \*\*Instrumentation APIçš„ä½¿ç”¨\*\* ï¼šåœ¨premain()æ–¹æ³•å†…éƒ¨ï¼Œä¼šè°ƒç”¨Instrumentation APIæ¥å¯¹å­—èŠ‚ç è¿›è¡Œæ“ä½œã€‚
4. \*\*æ·»åŠ ClassFileTransformer\*\* ï¼šé€šè¿‡Instrumentation APIï¼Œå¯ä»¥æ³¨å†Œä¸€ä¸ªClassFileTransformerå®ä¾‹ï¼Œç”¨äºè½¬æ¢ç±»çš„å­—èŠ‚ç ã€‚
5. \*\*JVMTIç›‘å¬äº‹ä»¶\*\* ï¼šJVMTIï¼ˆJava Virtual Machine Tool Interfaceï¼‰ä¼šè¢«ç”¨æ¥ç›‘å¬ç±»åŠ è½½äº‹ä»¶ã€‚
6. \*\*å›è°ƒClassFileTransformer.transform()æ–¹æ³•\*\* ï¼šæ¯å½“ä¸€ä¸ªæ–°çš„ç±»è¢«åŠ è½½æ—¶ï¼Œä¹‹å‰æ³¨å†Œçš„ClassFileTransformerçš„transform()æ–¹æ³•å°±ä¼šè¢«å›è°ƒã€‚
7. \*\*ä¿®æ”¹æœªåŠ è½½çš„ç±»\*\* ï¼šåœ¨transform()æ–¹æ³•ä¸­ï¼Œå¯ä»¥å¯¹å°šæœªåŠ è½½åˆ°å†…å­˜ä¸­çš„ç±»è¿›è¡Œä¿®æ”¹æˆ–æ›¿æ¢ã€‚
8. \*\*AppClassLoaderæˆ–å…¶ä»–ClassLoaderåŠ è½½ç±»\*\* ï¼šç»è¿‡å¯èƒ½çš„ä¿®æ”¹åï¼Œç±»æœ€ç»ˆç”±AppClassLoaderæˆ–å…¶ä»–ClassLoaderåŠ è½½åˆ°JVMä¸­ã€‚
9. \*\*ä½¿ç”¨å·²åŠ è½½çš„ç±»\*\* ï¼šä¸€æ—¦ç±»è¢«æˆåŠŸåŠ è½½ï¼Œå°±å¯ä»¥åœ¨åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨è¿™äº›ç±»ã€‚
10. \*\*å…¶ä»–ClassLoaderåŠ è½½ç±»\*\* ï¼šé™¤äº†AppClassLoaderä¹‹å¤–ï¼Œè¿˜æœ‰å…¶ä»–çš„ClassLoaderå¯èƒ½å‚ä¸ç±»çš„åŠ è½½è¿‡ç¨‹ã€‚
11. \*\*æ¯æ¬¡åŠ è½½æ–°ç±»å‰å›è°ƒ\*\* ï¼šå¯¹äºæ¯ä¸ªæ–°çš„ç±»åŠ è½½å°è¯•ï¼Œéƒ½ä¼šå†æ¬¡è§¦å‘ClassFileTransformerçš„transform()æ–¹æ³•çš„å›è°ƒã€‚
12. \*\*è¿”å›ä¿®æ”¹åçš„ç±»\*\* ï¼štransform()æ–¹æ³•å¤„ç†å®Œæ¯•åï¼Œä¼šå°†ä¿®æ”¹åçš„ç±»è¿”å›ç»™JVMç»§ç»­åç»­çš„åŠ è½½å’Œä½¿ç”¨è¿‡ç¨‹ã€‚
13. \*\*ç»“æŸpremain()æ–¹æ³•å¹¶æ‰§è¡Œmain()æ–¹æ³•\*\* ï¼špremain()æ–¹æ³•ç»“æŸåï¼Œç¨‹åºçš„ä¸»çº¿ç¨‹ä¼šå¼€å§‹æ‰§è¡Œmain()æ–¹æ³•ã€‚
åœ¨æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œ`Instrumentation` API èµ·åˆ°äº†å…³é”®çš„ä½œç”¨ï¼Œå®ƒè´Ÿè´£åè°ƒ Agent å’Œåº”ç”¨ç¨‹åºä¹‹é—´çš„å…³ç³»ï¼Œä½¿ Agent
å¯ä»¥åœ¨ç±»åŠ è½½æ—¶è¿›è¡Œå¹²é¢„ã€‚`ClassFileTransformer`
æ˜¯ä¸€ä¸ªé‡è¦çš„ç»„ä»¶ï¼Œå®ƒå®ç°äº†å­—èŠ‚ç çš„è½¬æ¢é€»è¾‘ï¼Œå¯ä»¥æ ¹æ®éœ€æ±‚ä¿®æ”¹ç±»çš„å­—èŠ‚ç ã€‚è€Œ`Instrumentation` æ¥å£å®é™…ä¸Šæ˜¯åŸºäº JVMTI å®ç°çš„ã€‚
> å‚è€ƒè¿æ¥ï¼š
>
> https://juejin.cn/post/7157684112122183693#heading-4
å‚è€ƒæ–‡ç« ï¼šhttps://cengxuyuan.cn