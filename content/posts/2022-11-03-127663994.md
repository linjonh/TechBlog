---
layout: post
title: "驱动开发内核封装WSK网络通信接口"
date: 2022-11-03 09:37:50 +0800
description: "本章`LyShark`将带大家学习如何在内核中使用标准的`Socket`套接字通信接口，我们都知道`"
keywords: "wsk 库"
categories: ['内核安全编程技术实践', 'Windows']
tags: ['驱动开发', '网络', '内核开发', 'Windows', 'C', 'C']
artid: "127663994"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=127663994
    alt: "驱动开发内核封装WSK网络通信接口"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=127663994
featuredImagePreview: https://bing.ee123.net/img/rand?artid=127663994
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     驱动开发：内核封装WSK网络通信接口
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atelier-sulphurpool-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     本章
     <code>
      LyShark
     </code>
     将带大家学习如何在内核中使用标准的
     <code>
      Socket
     </code>
     套接字通信接口，我们都知道
     <code>
      Windows
     </code>
     应用层下可直接调用
     <code>
      WinSocket
     </code>
     来实现网络通信，但在内核模式下应用层API接口无法使用，内核模式下有一套专有的
     <code>
      WSK
     </code>
     通信接口，我们对WSK进行封装，让其与应用层调用规范保持一致，并实现内核与内核直接通过
     <code>
      Socket
     </code>
     通信的案例。
    </p>
    <p>
     当然在早期如果需要实现网络通信一般都会采用
     <code>
      TDI
     </code>
     框架，但在新版本
     <code>
      Windows10
     </code>
     系统上虽然依然可以使用TDI接口，但是
     <code>
      LyShark
     </code>
     并不推荐使用，因为微软已经对接口搁置了，为了使WSK通信更加易用，我们需要封装内核层中的通信API，新建
     <code>
      LySocket.hpp
     </code>
     头文件，该文件中封装了WSK通信API接口，其封装格式与应用层接口保持了高度一致，当需要在内核中使用Socket通信时可直接引入本文件。
    </p>
    <p>
     我们需要使用
     <code>
      WDM
     </code>
     驱动程序，并配置以下参数。
    </p>
    <ul>
     <li>
      配置属性 -&gt; 连接器 -&gt; 输入-&gt; 附加依赖 -&gt; $(DDK_LIB_PATH)\Netio.lib
     </li>
     <li>
      配置属性 -&gt; C/C++ -&gt; 常规 -&gt; 设置 警告等级2级 (警告视为错误关闭)
     </li>
    </ul>
    <p>
     配置好以后，我们就开始吧，先来看看服务端如何实现！
    </p>
    <p>
     对于
     <code>
      服务端
     </code>
     来说，驱动通信必须保证服务端开启多线程来处理异步请求，不然驱动加载后系统会处于等待状态，而一旦等待则系统将会卡死，那么对于服务端
     <code>
      DriverEntry
     </code>
     入口说我们不能让其等待，必须使用
     <code>
      PsCreateSystemThread
     </code>
     来启用系统线程，该函数属于WDM的一部分，官方定义如下；
    </p>
    <pre><code class="prism language-c">NTSTATUS <span class="token function">PsCreateSystemThread</span><span class="token punctuation">(</span>
  <span class="token punctuation">[</span>out<span class="token punctuation">]</span>           PHANDLE            ThreadHandle<span class="token punctuation">,</span>
  <span class="token punctuation">[</span>in<span class="token punctuation">]</span>            ULONG              DesiredAccess<span class="token punctuation">,</span>
  <span class="token punctuation">[</span>in<span class="token punctuation">,</span> optional<span class="token punctuation">]</span>  POBJECT_ATTRIBUTES ObjectAttributes<span class="token punctuation">,</span>
  <span class="token punctuation">[</span>in<span class="token punctuation">,</span> optional<span class="token punctuation">]</span>  HANDLE             ProcessHandle<span class="token punctuation">,</span>
  <span class="token punctuation">[</span>out<span class="token punctuation">,</span> optional<span class="token punctuation">]</span> PCLIENT_ID         ClientId<span class="token punctuation">,</span>
  <span class="token punctuation">[</span>in<span class="token punctuation">]</span>            PKSTART_ROUTINE    StartRoutine<span class="token punctuation">,</span>
  <span class="token punctuation">[</span>in<span class="token punctuation">,</span> optional<span class="token punctuation">]</span>  PVOID              StartContext
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     我们使用
     <code>
      PsCreateSystemThread
     </code>
     函数开辟线程
     <code>
      TcpListenWorker
     </code>
     在线程内部执行如下流程启动驱动服务端，由于我们自己封装实现了标准接口组，所以使用起来几乎与应用层无任何差异了。
    </p>
    <ul>
     <li>
      CreateSocket 创建套接字
     </li>
     <li>
      Bind 绑定套接字
     </li>
     <li>
      Accept 等待接收请求
     </li>
     <li>
      Receive 用于接收返回值
     </li>
     <li>
      Send 用于发送返回值
     </li>
    </ul>
    <pre><code class="prism language-c"><span class="token comment">// 署名权</span>
<span class="token comment">// right to sign one's name on a piece of work</span>
<span class="token comment">// PowerBy: LyShark</span>
<span class="token comment">// Email: me@lyshark.com</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"LySocket.hpp"</span></span>

PETHREAD m_EThread <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

<span class="token comment">// 线程函数</span>
<span class="token comment">// PowerBy: LySHark</span>
VOID <span class="token function">TcpListenWorker</span><span class="token punctuation">(</span>PVOID Context<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	WSK_SOCKET<span class="token operator">*</span> paccept_socket <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	SOCKADDR_IN LocalAddress <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
	SOCKADDR_IN RemoteAddress <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
	NTSTATUS status <span class="token operator">=</span> STATUS_UNSUCCESSFUL<span class="token punctuation">;</span>

	<span class="token comment">// 创建套接字</span>
	PWSK_SOCKET TcpSocket <span class="token operator">=</span> <span class="token function">CreateSocket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> IPPROTO_TCP<span class="token punctuation">,</span> WSK_FLAG_LISTEN_SOCKET<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>TcpSocket <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 设置绑定地址</span>
	LocalAddress<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
	LocalAddress<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> INADDR_ANY<span class="token punctuation">;</span>
	LocalAddress<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">HTON_SHORT</span><span class="token punctuation">(</span><span class="token number">8888</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	status <span class="token operator">=</span> <span class="token function">Bind</span><span class="token punctuation">(</span>TcpSocket<span class="token punctuation">,</span> <span class="token punctuation">(</span>PSOCKADDR<span class="token punctuation">)</span><span class="token operator">&amp;</span>LocalAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">NT_SUCCESS</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 循环接收</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		CHAR<span class="token operator">*</span> read_buffer <span class="token operator">=</span> <span class="token punctuation">(</span>CHAR<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">ExAllocatePoolWithTag</span><span class="token punctuation">(</span>NonPagedPool<span class="token punctuation">,</span> <span class="token number">2048</span><span class="token punctuation">,</span> <span class="token string">"read"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		paccept_socket <span class="token operator">=</span> <span class="token function">Accept</span><span class="token punctuation">(</span>TcpSocket<span class="token punctuation">,</span> <span class="token punctuation">(</span>PSOCKADDR<span class="token punctuation">)</span><span class="token operator">&amp;</span>LocalAddress<span class="token punctuation">,</span> <span class="token punctuation">(</span>PSOCKADDR<span class="token punctuation">)</span><span class="token operator">&amp;</span>RemoteAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>paccept_socket <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">continue</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// 接收数据</span>
		<span class="token function">memset</span><span class="token punctuation">(</span>read_buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2048</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> read_len <span class="token operator">=</span> <span class="token function">Receive</span><span class="token punctuation">(</span>paccept_socket<span class="token punctuation">,</span> read_buffer<span class="token punctuation">,</span> <span class="token number">2048</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>read_len <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">DbgPrint</span><span class="token punctuation">(</span><span class="token string">"[内核A] =&gt; %s \n"</span><span class="token punctuation">,</span> read_buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">// 发送数据</span>
			<span class="token keyword">char</span> send_buffer<span class="token punctuation">[</span><span class="token number">2048</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Hi, lyshark.com B"</span><span class="token punctuation">;</span>
			<span class="token function">Send</span><span class="token punctuation">(</span>paccept_socket<span class="token punctuation">,</span> send_buffer<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>send_buffer<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">// 接收确认包</span>
			<span class="token function">memset</span><span class="token punctuation">(</span>read_buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2048</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">Receive</span><span class="token punctuation">(</span>paccept_socket<span class="token punctuation">,</span> read_buffer<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// 清理堆</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>read_buffer <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">ExFreePool</span><span class="token punctuation">(</span>read_buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// 关闭当前套接字</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>paccept_socket<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">CloseSocket</span><span class="token punctuation">(</span>paccept_socket<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>TcpSocket<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">CloseSocket</span><span class="token punctuation">(</span>TcpSocket<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">PsTerminateSystemThread</span><span class="token punctuation">(</span>STATUS_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 关闭套接字</span>
VOID <span class="token function">UnDriver</span><span class="token punctuation">(</span>PDRIVER_OBJECT driver<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">WSKCleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">KeWaitForSingleObject</span><span class="token punctuation">(</span>m_EThread<span class="token punctuation">,</span> Executive<span class="token punctuation">,</span> KernelMode<span class="token punctuation">,</span> FALSE<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>m_EThread <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">ObDereferenceObject</span><span class="token punctuation">(</span>m_EThread<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

NTSTATUS <span class="token function">DriverEntry</span><span class="token punctuation">(</span>IN PDRIVER_OBJECT Driver<span class="token punctuation">,</span> PUNICODE_STRING RegistryPath<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">DbgPrint</span><span class="token punctuation">(</span><span class="token string">"hello lyshark.com \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 初始化</span>
	<span class="token function">WSKStartup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	HANDLE hThread <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	NTSTATUS status <span class="token operator">=</span> STATUS_UNSUCCESSFUL<span class="token punctuation">;</span>

	<span class="token comment">// 创建系统线程</span>
	status <span class="token operator">=</span> <span class="token function">PsCreateSystemThread</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hThread<span class="token punctuation">,</span> THREAD_ALL_ACCESS<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> TcpListenWorker<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">NT_SUCCESS</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> status<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 获取线程EProcess结构</span>
	status <span class="token operator">=</span> <span class="token function">ObReferenceObjectByHandle</span><span class="token punctuation">(</span>hThread<span class="token punctuation">,</span> THREAD_ALL_ACCESS<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> KernelMode<span class="token punctuation">,</span> <span class="token punctuation">(</span>PVOID<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>m_EThread<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">NT_SUCCESS</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token operator">==</span> FALSE<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> status<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">ZwClose</span><span class="token punctuation">(</span>hThread<span class="token punctuation">)</span><span class="token punctuation">;</span>
	Driver<span class="token operator">-&gt;</span>DriverUnload <span class="token operator">=</span> UnDriver<span class="token punctuation">;</span>
	<span class="token keyword">return</span> STATUS_SUCCESS<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     对于客户端来说，只需要创建套接字并连接到指定地址即可，这个过程大体上可以总结为如下；
    </p>
    <ul>
     <li>
      CreateSocket 创建套接字
     </li>
     <li>
      Bind 绑定套接字
     </li>
     <li>
      Connect 链接服务端驱动
     </li>
     <li>
      Send 发送数据到服务端
     </li>
     <li>
      Receive 接收数据到服务端
     </li>
    </ul>
    <pre><code class="prism language-c"><span class="token comment">// 署名权</span>
<span class="token comment">// right to sign one's name on a piece of work</span>
<span class="token comment">// PowerBy: LyShark</span>
<span class="token comment">// Email: me@lyshark.com</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"LySocket.hpp"</span></span>

VOID <span class="token function">UnDriver</span><span class="token punctuation">(</span>PDRIVER_OBJECT driver<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 卸载并关闭Socket库</span>
	<span class="token function">WSKCleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

NTSTATUS <span class="token function">DriverEntry</span><span class="token punctuation">(</span>IN PDRIVER_OBJECT Driver<span class="token punctuation">,</span> PUNICODE_STRING RegistryPath<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">DbgPrint</span><span class="token punctuation">(</span><span class="token string">"hello lyshark.com \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 初始化</span>
	<span class="token function">WSKStartup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	NTSTATUS      status <span class="token operator">=</span> STATUS_SUCCESS<span class="token punctuation">;</span>
	SOCKADDR_IN   LocalAddress <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
	SOCKADDR_IN   RemoteAddress <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

	<span class="token comment">// 创建套接字</span>
	PWSK_SOCKET TcpSocket <span class="token operator">=</span> <span class="token function">CreateSocket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> IPPROTO_TCP<span class="token punctuation">,</span> WSK_FLAG_CONNECTION_SOCKET<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>TcpSocket <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		Driver<span class="token operator">-&gt;</span>DriverUnload <span class="token operator">=</span> UnDriver<span class="token punctuation">;</span>
		<span class="token keyword">return</span> STATUS_SUCCESS<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	LocalAddress<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
	LocalAddress<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> INADDR_ANY<span class="token punctuation">;</span>
	status <span class="token operator">=</span> <span class="token function">Bind</span><span class="token punctuation">(</span>TcpSocket<span class="token punctuation">,</span> <span class="token punctuation">(</span>PSOCKADDR<span class="token punctuation">)</span><span class="token operator">&amp;</span>LocalAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 绑定失败则关闭驱动</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">NT_SUCCESS</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">CloseSocket</span><span class="token punctuation">(</span>TcpSocket<span class="token punctuation">)</span><span class="token punctuation">;</span>

		Driver<span class="token operator">-&gt;</span>DriverUnload <span class="token operator">=</span> UnDriver<span class="token punctuation">;</span>
		<span class="token keyword">return</span> STATUS_SUCCESS<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 初始化服务端地址与端口信息</span>
	ULONG address<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token number">127</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

	RemoteAddress<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
	RemoteAddress<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">change_uint</span><span class="token punctuation">(</span>address<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> address<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> address<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> address<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	RemoteAddress<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">HTON_SHORT</span><span class="token punctuation">(</span><span class="token number">8888</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	status <span class="token operator">=</span> <span class="token function">Connect</span><span class="token punctuation">(</span>TcpSocket<span class="token punctuation">,</span> <span class="token punctuation">(</span>PSOCKADDR<span class="token punctuation">)</span><span class="token operator">&amp;</span>RemoteAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 连接服务端,如果失败则关闭驱动</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">NT_SUCCESS</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">CloseSocket</span><span class="token punctuation">(</span>TcpSocket<span class="token punctuation">)</span><span class="token punctuation">;</span>
		Driver<span class="token operator">-&gt;</span>DriverUnload <span class="token operator">=</span> UnDriver<span class="token punctuation">;</span>
		<span class="token keyword">return</span> STATUS_SUCCESS<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 发送数据</span>
	<span class="token keyword">char</span> send_buffer<span class="token punctuation">[</span><span class="token number">2048</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"hello lyshark.com A"</span><span class="token punctuation">;</span>
	<span class="token function">Send</span><span class="token punctuation">(</span>TcpSocket<span class="token punctuation">,</span> send_buffer<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>send_buffer<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 接收数据</span>
	CHAR<span class="token operator">*</span> read_buffer <span class="token operator">=</span> <span class="token punctuation">(</span>CHAR<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">ExAllocatePoolWithTag</span><span class="token punctuation">(</span>NonPagedPool<span class="token punctuation">,</span> <span class="token number">2048</span><span class="token punctuation">,</span> <span class="token string">"read"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">memset</span><span class="token punctuation">(</span>read_buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">Receive</span><span class="token punctuation">(</span>TcpSocket<span class="token punctuation">,</span> read_buffer<span class="token punctuation">,</span> <span class="token number">2048</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">DbgPrint</span><span class="token punctuation">(</span><span class="token string">"[内核B] =&gt; %s \n"</span><span class="token punctuation">,</span> read_buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 发送确认包</span>
	<span class="token function">Send</span><span class="token punctuation">(</span>TcpSocket<span class="token punctuation">,</span> <span class="token string">"ok"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 释放内存</span>
	<span class="token function">ExFreePool</span><span class="token punctuation">(</span>read_buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">CloseSocket</span><span class="token punctuation">(</span>TcpSocket<span class="token punctuation">)</span><span class="token punctuation">;</span>
	Driver<span class="token operator">-&gt;</span>DriverUnload <span class="token operator">=</span> UnDriver<span class="token punctuation">;</span>
	<span class="token keyword">return</span> STATUS_SUCCESS<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     编译两个驱动程序，首先运行
     <code>
      server.sys
     </code>
     驱动，运行后该驱动会在后台等待客户端连接，接着运行
     <code>
      client.sys
     </code>
     屏幕上可输出如下提示，说明通信已经建立了。
    </p>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/59d6891bb52daa2f0c6a440b65b7e754.png"/>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c:6f672e6373646e2e6e65742f6c79736861726b5f6373646e2f:61727469636c652f64657461696c732f313237363633393934" class_="artid" style="display:none">
 </p>
</div>


