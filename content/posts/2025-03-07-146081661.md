---
layout: post
title: "GoTeams-3构建api重构错误码"
date: 2025-03-07 15:41:24 +0800
description: "把系统构建api层，前端发起请求将通过api层，api又内部调用gRPC服务，使系统安全性和可拓展性都增加了，然后还进行了重构错误码。"
keywords: "【GoTeams】-3：构建api、重构错误码"
categories: ['Goteams']
tags: ['错误码', 'Grpc', 'Api']
artid: "146081661"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146081661
    alt: "GoTeams-3构建api重构错误码"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146081661
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146081661
cover: https://bing.ee123.net/img/rand?artid=146081661
image: https://bing.ee123.net/img/rand?artid=146081661
img: https://bing.ee123.net/img/rand?artid=146081661
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     【GoTeams】-3：构建api、重构错误码
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/2dd65b68a7b040d185c3bda27f45db2f.png">
      <br/>
     </img>
    </p>
    <p>
    </p>
    <h2>
     <a id="1__api_4">
     </a>
     1. 构建api
    </h2>
    <p>
     首先复制
     <code>
      project-user
     </code>
     ，改名为
     <code>
      project-api
     </code>
     ，放在总的路径下，然后在工作区中进行导入。
    </p>
    <p>
     运行命令
     <code>
      go work use .\project-api\
     </code>
     新建工作区之间的关联，同时需要把刚刚复制过来的api下的go.mod文件进行更改，更改
     <code>
      module
     </code>
     名字，不然工作区会报错。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/5b73a4f7fb5a4f99a154734fff7a6d7f.png"/>
    </p>
    <p>
     在api下的main函数中，更改import引用，导入相对应的包，更新如下。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/0f58cbd9e0eb4678a7b65781787f9852.png"/>
    </p>
    <p>
     先来看看效果，先分别启动
     <code>
      project-user
     </code>
     ，然后通过
     <code>
      project-api
     </code>
     暴露的服务，我们来申请验证码，
     <code>
      api
     </code>
     将会调用
     <code>
      user
     </code>
     里面的
     <code>
      grpc
     </code>
     ，并获得
     <code>
      grpc
     </code>
     的返回结果后包装成一个响应返回给服务器。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/ad684019ec0a409eb80a4d56288697b6.png">
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/a6c7340156f74076a156a62757f83e6f.png">
       <br/>
       这样api端也能够响应了。
      </img>
     </img>
    </p>
    <h3>
     <a id="_29">
     </a>
     梳理调用关系
    </h3>
    <p>
     这里使用
     <code>
      project-api
     </code>
     作为网关层接入层，主要是处理外部的HTTP请求，进行路由转发等，然后
     <code>
      project-user
     </code>
     作为服务层，提供核心业务逻辑处理。
    </p>
    <p>
     那么现在前段发来请求之后，应该是这样的：
     <code>
      外部请求 → project-api(HTTP:80) → project-user(gRPC:8881)
     </code>
    </p>
    <p>
     首先用户发送HTTP请求到API层。
    </p>
    <pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>HandlerUser<span class="token punctuation">)</span> <span class="token function">getCaptcha</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    mobile <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">PostForm</span><span class="token punctuation">(</span><span class="token string">"mobile"</span><span class="token punctuation">)</span>
    <span class="token comment">// 通过 gRPC 调用 user 服务</span>
    rsp<span class="token punctuation">,</span> err <span class="token operator">:=</span> LoginServiceClient<span class="token punctuation">.</span><span class="token function">GetCaptcha</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token operator">&amp;</span>loginServiceV1<span class="token punctuation">.</span>CaptchaMessage<span class="token punctuation">{<!-- --></span>Mobile<span class="token punctuation">:</span> mobile<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     API 层通过 gRPC 调用 User 服务：
    </p>
    <pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>ls LoginService<span class="token punctuation">)</span> <span class="token function">GetCaptcha</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> msg <span class="token operator">*</span>CaptchaMessage<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>CaptchaResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 具体的业务逻辑实现</span>
    rsp<span class="token punctuation">,</span> err <span class="token operator">:=</span> LoginServiceClient<span class="token punctuation">.</span><span class="token function">GetCaptcha</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token operator">&amp;</span>loginServiceV1<span class="token punctuation">.</span>CaptchaMessage<span class="token punctuation">{<!-- --></span>Mobile<span class="token punctuation">:</span> mobile<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     这样就是实现了
     <code>
      职责分离
     </code>
     ：API 层负责协议转换和请求处理，服务层专注业务逻辑，并且实现了
     <code>
      安全性
     </code>
     ：内部服务不直接暴露给外部，同时还有 扩展性：可以方便地添加新的服务和 API，以及维护性：各层独立维护和部署。
    </p>
    <p>
     这里主要就是三个代码，分别是
     <code>
      api层下面的user三个包
     </code>
     ，进行grpc服务的调用。
    </p>
    <p>
     <code>
      router.go
     </code>
     代码如下。
    </p>
    <pre><code class="prism language-go"><span class="token keyword">package</span> user

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"github.com/gin-gonic/gin"</span>
	<span class="token string">"log"</span>
	<span class="token string">"test.com/project-api/router"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> RouterUser <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"init user router"</span><span class="token punctuation">)</span>
	ru <span class="token operator">:=</span> <span class="token operator">&amp;</span>RouterUser<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
	router<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>ru<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>RouterUser<span class="token punctuation">)</span> <span class="token function">Route</span><span class="token punctuation">(</span>r <span class="token operator">*</span>gin<span class="token punctuation">.</span>Engine<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">//初始化grpc的客户端连接</span>
	<span class="token function">InitRpcUserClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	h <span class="token operator">:=</span> <span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	r<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span><span class="token string">"/project/login/getCaptcha"</span><span class="token punctuation">,</span> h<span class="token punctuation">.</span>getCaptcha<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre>
    <p>
     <code>
      rpc.go
     </code>
     代码如下：
    </p>
    <pre><code class="prism language-go"><span class="token keyword">package</span> user

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"google.golang.org/grpc"</span>
	<span class="token string">"google.golang.org/grpc/credentials/insecure"</span>
	<span class="token string">"log"</span>
	loginServiceV1 <span class="token string">"test.com/project-user/pkg/service/login.service.v1"</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> LoginServiceClient loginServiceV1<span class="token punctuation">.</span>LoginServiceClient

<span class="token keyword">func</span> <span class="token function">InitRpcUserClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	conn<span class="token punctuation">,</span> err <span class="token operator">:=</span> grpc<span class="token punctuation">.</span><span class="token function">Dial</span><span class="token punctuation">(</span><span class="token string">":8881"</span><span class="token punctuation">,</span> grpc<span class="token punctuation">.</span><span class="token function">WithTransportCredentials</span><span class="token punctuation">(</span>insecure<span class="token punctuation">.</span><span class="token function">NewCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">//这里调用的是Fatalf，理论上调度失败了，不能再继续运行</span>
		<span class="token comment">// Fatalf记录信息错误之后会立即调用os.Exit(1)来终止程序</span>
		<span class="token comment">//不会继续执行后续代码，也不会执行defer语句</span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"did not connect: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	LoginServiceClient <span class="token operator">=</span> loginServiceV1<span class="token punctuation">.</span><span class="token function">NewLoginServiceClient</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span>

<span class="token punctuation">}</span>
</code></pre>
    <p>
     <code>
      user.go
     </code>
     代码如下，作用是发起gRPC调用，然后封装gRPC的结果作为响应给前端。
    </p>
    <pre><code class="prism language-go"><span class="token keyword">package</span> user

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"context"</span>
	<span class="token string">"github.com/gin-gonic/gin"</span>
	<span class="token string">"net/http"</span>
	common <span class="token string">"test.com/project-common"</span>

	loginServiceV1 <span class="token string">"test.com/project-user/pkg/service/login.service.v1"</span>
	<span class="token string">"time"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> HandlerUser <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>HandlerUser <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>HandlerUser<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>HandlerUser<span class="token punctuation">)</span> <span class="token function">getCaptcha</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	result <span class="token operator">:=</span> <span class="token operator">&amp;</span>common<span class="token punctuation">.</span>Result<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
	mobile <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">PostForm</span><span class="token punctuation">(</span><span class="token string">"mobile"</span><span class="token punctuation">)</span>
	<span class="token comment">//发起GPRC调用</span>
	c<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	rsp<span class="token punctuation">,</span> err <span class="token operator">:=</span> LoginServiceClient<span class="token punctuation">.</span><span class="token function">GetCaptcha</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token operator">&amp;</span>loginServiceV1<span class="token punctuation">.</span>CaptchaMessage<span class="token punctuation">{<!-- --></span>Mobile<span class="token punctuation">:</span> mobile<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		ctx<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> result<span class="token punctuation">.</span><span class="token function">Fail</span><span class="token punctuation">(</span><span class="token number">2001</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	ctx<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> result<span class="token punctuation">.</span><span class="token function">Success</span><span class="token punctuation">(</span>rsp<span class="token punctuation">.</span>Code<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre>
    <h3>
     <a id="api_154">
     </a>
     api包的作用
    </h3>
    <p>
     这个
     <code>
      api.go
     </code>
     文件的作用是通过空导入（blank import）来初始化 user 包，也就是触发 user 包中的
     <code>
      init()
     </code>
     函数执行，因为我们在
     <code>
      router.go
     </code>
     的包中，有如下代码。
    </p>
    <pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"init user router"</span><span class="token punctuation">)</span>
    ru <span class="token operator">:=</span> <span class="token operator">&amp;</span>RouterUser<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    router<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>ru<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/4b97b9b0cd1b4f96b403c5d726e97faf.png">
      <br/>
      这种设计模式的好处就是，每个功能模块都可以独立管理自己的路由，只需要在api.go中添加相应的导入即可。
     </img>
    </p>
    <h3>
     <a id="_170">
     </a>
     路由梳理
    </h3>
    <p>
     这里有很多路由+各种接口的实现、注册等，比较乱，这里梳理下关系，也巩固下对接口的认识。
    </p>
    <p>
     这个图就比较清晰了，能够知道到底是怎么处理路由的。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/700f3a13d3ce431480c7d0519c0bb74a.png"/>
    </p>
    <h3>
     <a id="Register_178">
     </a>
     注册Register代码语法
    </h3>
    <p>
     这里Register里边有一个代码的语法可以看看，回顾一下Go的语法知识。
    </p>
    <pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">Register</span><span class="token punctuation">(</span>ro <span class="token operator">...</span>Router<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    routers <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>routers<span class="token punctuation">,</span> ro<span class="token operator">...</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     这里涉及到两个 Go 语言的特性：可变参数 ：
     <code>
      ro ...Router
     </code>
     ，
     <code>
      ...Router
     </code>
     表示这个函数可以接收任意数量的 Router 类型参数，在函数内部，
     <code>
      ro
     </code>
     会被当作
     <code>
      Router 类型的切片
     </code>
     使用。
    </p>
    <p>
     比如：
    </p>
    <pre><code class="prism language-go"><span class="token function">Register</span><span class="token punctuation">(</span>router1<span class="token punctuation">)</span>              <span class="token comment">// 传入一个</span>
<span class="token function">Register</span><span class="token punctuation">(</span>router1<span class="token punctuation">,</span> router2<span class="token punctuation">)</span>     <span class="token comment">// 传入多个</span>
</code></pre>
    <p>
     在
     <code>
      append
     </code>
     函数调用时，
     <code>
      ro...
     </code>
     会将切片
     <code>
      ro
     </code>
     展开成多个独立的参数，
     <code>
      routers = append(routers, ro...)
     </code>
     相当于把 ro 切片中的所有元素都追加到
     <code>
      routers 切片
     </code>
     中。
    </p>
    <pre><code class="prism language-go"><span class="token comment">// 假设有这样的调用</span>
router1 <span class="token operator">:=</span> <span class="token operator">&amp;</span>RouterUser<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
router2 <span class="token operator">:=</span> <span class="token operator">&amp;</span>RouterOrder<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token function">Register</span><span class="token punctuation">(</span>router1<span class="token punctuation">,</span> router2<span class="token punctuation">)</span>

<span class="token comment">// 函数内部执行</span>
routers <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>routers<span class="token punctuation">,</span> router1<span class="token punctuation">,</span> router2<span class="token punctuation">)</span>  <span class="token comment">// ro... 被展开成多个参数</span>
</code></pre>
    <h2>
     <a id="2__209">
     </a>
     2. 重构错误码
    </h2>
    <p>
     把model中的code重构下，错误码为grpc提供的status状态，status 包是 gRPC 提供的错误处理工具，用于创建标准化的 gRPC 错误。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/91bb4e5a7301464f9df73b672e757479.png">
      <br/>
      然后在rpc的返回的地方，也对应的进行更改返回参数。
     </img>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/8ace26bfe2644f33b75f041b4b002fa8.png"/>
     <br/>
     上述方式是通过gRPC提供的status来进行error处理的，这里我们也可以通过自己定义error来实现错误处理，来看看具体的实现。
    </p>
    <p>
     首先我们在
     <code>
      common
     </code>
     中定义实现errs的两个go文件，分别如下。
    </p>
    <p>
     <code>
      errs.go
     </code>
     中的代码作用是自定义了错误结构，以及创建新错误的方法。
    </p>
    <pre><code class="prism language-go"><span class="token keyword">package</span> errs

<span class="token keyword">type</span> ErrorCode <span class="token builtin">int</span>

<span class="token keyword">type</span> BError <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	Code ErrorCode
	Msg  <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>e <span class="token operator">*</span>BError<span class="token punctuation">)</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> e<span class="token punctuation">.</span>Msg
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NewError</span><span class="token punctuation">(</span>code ErrorCode<span class="token punctuation">,</span> msg <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>BError <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>BError<span class="token punctuation">{<!-- --></span>
		Code<span class="token punctuation">:</span> code<span class="token punctuation">,</span>
		Msg<span class="token punctuation">:</span>  msg<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     在
     <code>
      grpc_go
     </code>
     代码中将业务错误转换为 gRPC 错误，然后还有 解析 gRPC 错误的两个方法。
    </p>
    <pre><code class="prism language-go"><span class="token keyword">package</span> errs

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	codes <span class="token string">"google.golang.org/grpc/codes"</span>
	<span class="token string">"google.golang.org/grpc/status"</span>
	common <span class="token string">"test.com/project-common"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">GrpcError</span><span class="token punctuation">(</span>err <span class="token operator">*</span>BError<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span><span class="token function">Code</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>Code<span class="token punctuation">)</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span>Msg<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 解析GrpcError 返回一个BusinessCode和string类型</span>
<span class="token keyword">func</span> <span class="token function">ParseGrpcError</span><span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>common<span class="token punctuation">.</span>BusinessCode<span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	fromError<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> status<span class="token punctuation">.</span><span class="token function">FromError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token keyword">return</span> common<span class="token punctuation">.</span><span class="token function">BusinessCode</span><span class="token punctuation">(</span>fromError<span class="token punctuation">.</span><span class="token function">Code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fromError<span class="token punctuation">.</span><span class="token function">Message</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     所以流程是，服务层发现错误，然后创建业务错误，转换为gRPC错误，通过RPC传输，API层接受错误之后，解析gRPC错误，并且转换为http相应，返回给客户端。
    </p>
    <p>
     在model中我们定义了业务的code码，也就是下面这个。
    </p>
    <pre><code class="prism language-go"><span class="token keyword">package</span> model

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"test.com/project-common/errs"</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> <span class="token punctuation">(</span>
	NoLegalMobile <span class="token operator">=</span> errs<span class="token punctuation">.</span><span class="token function">NewError</span><span class="token punctuation">(</span><span class="token number">2001</span><span class="token punctuation">,</span> <span class="token string">"手机号不合法"</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre>
    <p>
     那么通过在service服务端把业务代码包装下，也就是把业务错误，转换为gRPC格式的错误，
     <code>
      return nil, errs.GrpcError(model.NoLegalMobile)
     </code>
     。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/02e5ed51ce6543ea8a7e5d5713624a95.png"/>
     <br/>
     然后通过api网关层的user.go解析错误，并且返回对应的错误。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/0b08e746df6b4340945da02cde8746f8.png"/>
    </p>
    <hr/>
    <p>
     所以为什么要转换为gRPC错误进行封装和拆解？
    </p>
    <p>
     <strong>
      因为gRPC 使用特定的错误格式进行传输，并且普通的业务错误无法直接通过 gRPC 传递，gRPC 错误包含标准的错误码和消息格式。
     </strong>
    </p>
    <p>
     来看看gRPC中关于Error的定义，其中Code是uint32类型的错误码。
    </p>
    <p>
     那么uint32和int有什么区别呢？int是有符号整数，可以表示正数和负数，而uint32是无符号的，并且uint32一定是4字节，适合网络协议、二进制文件处理等。
    </p>
    <p>
     uint32可以占用更少的内存（int64是根据主机来的，64位就是8字节，而32位是4字节），并且在网络传输中数据包更小，处理速度更快。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/1a3e4960749c4e319b8d54c985fef47d.png"/>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f:626c6f672e6373646e2e6e65742f7468656169706f7765722f:61727469636c652f64657461696c732f313436303831363631" class_="artid" style="display:none">
 </p>
</div>


