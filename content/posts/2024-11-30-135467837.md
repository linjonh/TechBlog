---
layout: post
title: "使用FFmpegEasyDarwin搭建音视频推拉流测试环境"
date: 2024-11-30 22:14:01 +0800
description: "本文详细介绍了如何在Windows上使用VS2017编译FFmpeg并将其与流媒体服务器EasyDa"
keywords: "ffmpeg easydarwin"
categories: ['音视频开发']
tags: ['音视频', 'Ffmpeg']
artid: "135467837"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=135467837
    alt: "使用FFmpegEasyDarwin搭建音视频推拉流测试环境"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=135467837
featuredImagePreview: https://bing.ee123.net/img/rand?artid=135467837
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     使用FFmpeg+EasyDarwin搭建音视频推拉流测试环境
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h3>
     <a id="1__0">
     </a>
     1. 前言
    </h3>
    <p>
     在上一篇文章《使用VS2017在win10 x64上编译调试FFmpeg（附源码和虚拟机下载）》中，我们讲解了如何搭建FFmpeg源码编译和调试环境。
    </p>
    <p>
     调试FFmpeg，还需要搭建流媒体服务器。流媒体服务器的作用是通过网络对外提供音视频服务，包括但不限于提供视频推流、拉流服务。推流（Push）：推流是指将音视频数据从本地设备（如摄像头、麦克风）通过网络上传到服务器的过程。拉流（Pull）：拉流是指从直播服务器获取音视频数据并在本地进行播放的过程。
    </p>
    <p>
     FFmpeg通过网路连接到流媒体服务器后，基于音视频协议和流媒体服务器通过交互，拉取或者推送视频数据。我们使用免费的EasyDarwin作为流媒体服务器，EasyDarwin使用简单，能够满足测试需求。
    </p>
    <h3>
     <a id="2_EasyDarwin_7">
     </a>
     2. 安装运行EasyDarwin
    </h3>
    <h4>
     <a id="21_EasyDarwin_8">
     </a>
     2.1 下载EasyDarwin
    </h4>
    <p>
     Github：https://github.com/EasyDarwin/EasyDarwin
    </p>
    <p>
     官网：https://www.easydarwin.org/p/easydarwin.html
    </p>
    <p>
     官网和Github的版本都比较低，可以从下面的地址下载更高的8.1版本：
    </p>
    <ul>
     <li>
      （关注Qt未来工程师，回复
      <strong>
       EasyDarwin 8.1
      </strong>
      获取下载地址）
     </li>
    </ul>
    <h4>
     <a id="22_EasyDarwin_17">
     </a>
     2.2 运行EasyDarwin
    </h4>
    <p>
     双击EasyDarwin.exe，即可运行。启动界面如下所示：
    </p>
    <p>
     <img alt="EasyDarwin启动界面" src="https://i-blog.csdnimg.cn/blog_migrate/85f02ae8cc3e5eac925aa603f999c6e4.png"/>
    </p>
    <p>
     根据提示，我们使用浏览器打开地址 http://192.168.0.108:10008 即可访问服务器后台。这个地址因每台电脑的网络环境而异，会不一样。后台界面如下所示：
    </p>
    <p>
     <img alt="EasyDarwin后台管理页面" src="https://i-blog.csdnimg.cn/blog_migrate/8eeae36c3b51982183c43ab71eaa4bba.png"/>
    </p>
    <p>
     后台可以看到推拉流信息列表、资源占用、版本等信息。
    </p>
    <h3>
     <a id="3_FFmpeg_28">
     </a>
     3. 使用FFmpeg推流
    </h3>
    <h4>
     <a id="31_FFmpeg_29">
     </a>
     3.1 获取FFmpeg工具包
    </h4>
    <p>
     我们可以使用VS2017本地编译出来的FFmpeg程序，也可以使用网络上下载的FFmpeg程序工具包。FFmpeg程序工具包下载地址：
    </p>
    <ul>
     <li>
      https://www.gyan.dev/ffmpeg/builds/packages/ffmpeg-6.1.1-essentials_build.zip
     </li>
    </ul>
    <h4>
     <a id="32__34">
     </a>
     3.2 获取视频素材
    </h4>
    <p>
     在使用FFmpeg向EasyDarwin推送视频流前，我们需要准备一段本地视频文件作为素材。笔者收集了一些音视频测试素材，下载地址：
    </p>
    <ul>
     <li>
      （关注Qt未来工程师，回复
      <strong>
       音视频测试素材
      </strong>
      获取下载地址）
     </li>
    </ul>
    <p>
     以上音视频素材会长期更新，一些好的视频资源也会同步上传到B站。
    </p>
    <h4>
     <a id="33_FFmpeg_41">
     </a>
     3.3 使用FFmpeg命令推流
    </h4>
    <p>
     进入到FFmpeg程序工具包的bin目录下，在终端中执行以下命令即可实现将本地文件循环推流到EasyDarwin：
    </p>
    <pre><code>.\ffmpeg -r 25 -re -stream_loop -10000 -i "国外街头广场行人视频-1920x1080-1分56秒.mp4"  -vcodec copy -rtsp_transport tcp -f rtsp  rtsp://192.168.0.108/test/1
</code></pre>
    <p>
     注意rtsp地址中的ip要改成EasyDarwin服务器的地址，ip地址后面的路径可以自拟。推流命令执行结果如下：
    </p>
    <p>
     <img alt="推流命令执行结果" src="https://i-blog.csdnimg.cn/blog_migrate/b6af2956dd1d7e7ba6e740e7c1d4e875.png"/>
    </p>
    <p>
     查看EasyDarwin后台：
    </p>
    <p>
     <img alt="EasyDarwin推流列表" src="https://i-blog.csdnimg.cn/blog_migrate/b056557fa59f21c20326c622ffd00eff.png"/>
    </p>
    <p>
     可以看到推流成功。
    </p>
    <h3>
     <a id="4__56">
     </a>
     4. 拉流调试
    </h3>
    <h4>
     <a id="41_VLC_57">
     </a>
     4.1 使用VLC测试视频
    </h4>
    <p>
     首先我们使用 VLC 测试视频是否可以正常拉流播放。VLC是一款功能强大的免费开源播放器，纯播放器，没有任何广告，音视频开发必备。下载地址在官网：
    </p>
    <ul>
     <li>
      https://www.videolan.org/vlc/index.zh_CN.html
     </li>
    </ul>
    <p>
     安装完成后，打开VLC media palyer，从菜单中选择：“媒体”-&gt;“打开网络串流”，在弹出的窗口中输入视频播放地址。视频播放地址从EasyDarwin后台页面中获取。如下所示：
    </p>
    <p>
     <img alt="获取视频播放地址" src="https://i-blog.csdnimg.cn/blog_migrate/d197a9fd6e5f575253df2bd8513bb5ac.png"/>
    </p>
    <p>
     <img alt="VLC打开网络串流" src="https://i-blog.csdnimg.cn/blog_migrate/e5727f43f12bd1d79cd41819b031aa68.png"/>
    </p>
    <p>
     点击播放，可正常播放，说明视频推拉流都正常，播放画面如下所示：
    </p>
    <p>
     <img alt="VLC拉流播放" src="https://i-blog.csdnimg.cn/blog_migrate/0052ace0eaecd31d2c5432a6ac31a2f7.png"/>
    </p>
    <h4>
     <a id="42_FFmpeg_71">
     </a>
     4.2 使用FFmpeg调试下拉流
    </h4>
    <p>
     笔者在win10虚拟机中调试FFmpeg，要保证虚拟机能ping通主机（可以使用Vmware的桥接模式）。启动win10虚拟机后，在虚拟机中进行ping宿主机测试，如下图所示。这里不详细讲解，有问题的同学可以查一下解决方法。
    </p>
    <p>
     <img alt="虚拟机ping宿主机" src="https://i-blog.csdnimg.cn/blog_migrate/86105824483ef09eba706d0f21fecbed.png"/>
    </p>
    <p>
     当然，同学们也可以将FFmpeg程序包，VLC软件，EasyDarwin软件全部放到虚拟机中运行，这样调试起来可能会更加简单，这方面大家拿到虚拟机后可以自由发挥。
    </p>
    <p>
     打开 ffmpeg_deps.sln 解决方案。将ffmpeg项目设置为启动项目，右键ffmpeg项目，在弹出的菜单中选择"属性"。在属性对话框中，将调试命令设置为（默认已设置）：
    </p>
    <pre><code>$(OutDir)\bin\x64\$(TargetName)$(TargetExt) 
</code></pre>
    <p>
     命令参数设置为：
    </p>
    <pre><code>-i rtsp://192.168.0.108/test/1 -codec copy C:\Users\qtfuture\Desktop\1.mp4
</code></pre>
    <p>
     如下图所示：
    </p>
    <p>
     <img alt="vs调试启动ffmpeg拉流配置" src="https://i-blog.csdnimg.cn/blog_migrate/3ecfd1f99dae86911078fc6def489818.png"/>
    </p>
    <p>
     此命令的含义为，使用ffmpeg拉取地址为rtsp://192.168.0.108/test/1的视频流，保存到桌面上的1.mp4。
    </p>
    <p>
     点击调试即可正常开始进行拉流源码调试。至此，完整的调试环境准备完成。在此基础上，读者可以自行实验推拉流等各种操作，步骤和原理和上述过程基本一致。
    </p>
    <h3>
     <a id="5__97">
     </a>
     5. 结语
    </h3>
    <p>
     音视频系统环境稍微有些复杂，这也是学习音视频开发的难点所在。准备好完整的ffmpeg调试环境后，我们便可以尽情地探索ffmpeg内部的实现细节。后面的文章中，我们将通过源码调试对ffmpeg内部各个模块和原理进行专题研究，敬请关注。
    </p>
    <hr/>
    <p>
     本文原创发布于Qt未来工程师。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
  <div class="blog-extension-box" id="blogExtensionBox" style="width:400px;margin:auto;margin-top:12px">
  </div>
 </article>
 <p alt="68747470733a2f2f:626c6f672e6373646e2e6e65742f753031323739303530332f:61727469636c652f64657461696c732f313335343637383337" class_="artid" style="display:none">
 </p>
</div>


