---
layout: post
title: "24.策略模式实现日志"
date: 2025-03-16 16:47:24 +0800
description: "介绍了日志的常见属性，以及成熟可用的日志库，对策略模式进行了介绍，并基于策略模式实现了简单的日志"
keywords: "24.策略模式实现日志"
categories: ['Linux']
tags: ['系统编程', '策略模式', '日志', '操作系统', '互斥', 'C']
artid: "146282643"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146282643
    alt: "24.策略模式实现日志"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146282643
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146282643
cover: https://bing.ee123.net/img/rand?artid=146282643
image: https://bing.ee123.net/img/rand?artid=146282643
img: https://bing.ee123.net/img/rand?artid=146282643
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     24.策略模式实现日志
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-tomorrow-night-eighties" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h3>
     <a id="_0">
     </a>
     日志的介绍
    </h3>
    <p>
     计算机中的日志是记录系统和软件运行中发送事件的文件，主要作用是监控运行状态、记录异常信息，帮助快速定位问题并支持程序员进行问题修复。它是系统维护、故障排查和安全管理的重要工具。
    </p>
    <p>
     日志格式以下几个指标是必须得有的：
     <br/>
     • 时间戳
     <br/>
     • 日志等级
     <br/>
     • 日志内容
     <br/>
     以下几个指标是可选的：
     <br/>
     • 文件名
     <br/>
     • 行号
     <br/>
     • 进程与线程相关id信息
    </p>
    <p>
     日志有现成的解决方案，如：spdlog、glog、Boost.Log、Log4cxx等等，我们依旧采用自定义日志的方式。
     <br/>
     这里我们采用设计模式中的策略模式来进行日志的设计，我们想要的日志格式如下：
    </p>
    <pre><code class="prism language-bash"><span class="token comment">#[可读性很好的时间] [⽇志等级] [进程pid] [打印对应⽇志的文件名][行号] - 消息内容，支持可变参数</span>
<span class="token punctuation">[</span><span class="token number">2025</span>-2-16 <span class="token number">9</span>:13:13<span class="token punctuation">]</span> <span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">2422165</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>Log.cc<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span> - hello world
<span class="token punctuation">[</span><span class="token number">2025</span>-2-16 <span class="token number">9</span>:13:13<span class="token punctuation">]</span> <span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">2422165</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>Log.cc<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span> - hello world
<span class="token punctuation">[</span><span class="token number">2025</span>-2-16 <span class="token number">9</span>:13:13<span class="token punctuation">]</span> <span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">2422165</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>Log.cc<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span> - hello world
<span class="token punctuation">[</span><span class="token number">2025</span>-2-16 <span class="token number">9</span>:13:13<span class="token punctuation">]</span> <span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">2422165</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>Log.cc<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span> - hello world
<span class="token punctuation">[</span><span class="token number">2025</span>-2-16 <span class="token number">9</span>:13:13<span class="token punctuation">]</span> <span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">2422165</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>Log.cc<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">17</span><span class="token punctuation">]</span> - hello world
</code></pre>
    <p>
     所以我们想要实现的日志需要实现两个部分：日志信息的生成与落盘方式的构建（显示器or文件）。这里我们采用策略模式生成落盘方式，例用内部类生成信息，最终完成日志的输出。
    </p>
    <h3>
     <a id="_23">
     </a>
     日志的实现
    </h3>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fstream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;memory&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;ctime&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sstream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;filesystem&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"mutex.hpp"</span></span>
<span class="token keyword">namespace</span> LogMudual
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>
    <span class="token keyword">using</span> <span class="token keyword">namespace</span> MutexModel<span class="token punctuation">;</span>
    <span class="token comment">//  默认路径和日志名称</span>
    <span class="token keyword">const</span> string defaultpath <span class="token operator">=</span> <span class="token string">"./log/"</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> string defaultname <span class="token operator">=</span> <span class="token string">"log.txt"</span><span class="token punctuation">;</span>
    <span class="token comment">// 日志等级</span>
    <span class="token keyword">enum</span> <span class="token keyword">class</span> <span class="token class-name">LogLevel</span>
    <span class="token punctuation">{<!-- --></span>
        DEBUG<span class="token punctuation">,</span>
        INFO<span class="token punctuation">,</span>
        WARNING<span class="token punctuation">,</span>
        ERROR<span class="token punctuation">,</span>
        FATAL
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// 根据时间戳，获取可读性较强的时间信息</span>
    string <span class="token function">GetCurTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        time_t tm <span class="token operator">=</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">tm</span> curr<span class="token punctuation">;</span>
        <span class="token function">localtime_r</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tm<span class="token punctuation">,</span> <span class="token operator">&amp;</span>curr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        stringstream ss<span class="token punctuation">;</span>
        ss <span class="token operator">&lt;&lt;</span> curr<span class="token punctuation">.</span>tm_year <span class="token operator">+</span> <span class="token number">1900</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"-"</span>
           <span class="token operator">&lt;&lt;</span> curr<span class="token punctuation">.</span>tm_mon <span class="token operator">&lt;&lt;</span> <span class="token string">"-"</span>
           <span class="token operator">&lt;&lt;</span> curr<span class="token punctuation">.</span>tm_mday <span class="token operator">&lt;&lt;</span> <span class="token string">" "</span>
           <span class="token operator">&lt;&lt;</span> curr<span class="token punctuation">.</span>tm_hour <span class="token operator">&lt;&lt;</span> <span class="token string">":"</span>
           <span class="token operator">&lt;&lt;</span> curr<span class="token punctuation">.</span>tm_min <span class="token operator">&lt;&lt;</span> <span class="token string">":"</span>
           <span class="token operator">&lt;&lt;</span> curr<span class="token punctuation">.</span>tm_sec<span class="token punctuation">;</span>
        <span class="token keyword">return</span> ss<span class="token punctuation">.</span><span class="token function">str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//将日志等级转成字符串</span>
    string <span class="token function">LogLevelToString</span><span class="token punctuation">(</span>LogLevel level<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>level<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">case</span> LogLevel<span class="token double-colon punctuation">::</span>DEBUG<span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token string">"DEBUG"</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> LogLevel<span class="token double-colon punctuation">::</span>INFO<span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token string">"INFO"</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> LogLevel<span class="token double-colon punctuation">::</span>WARNING<span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token string">"WARNING"</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> LogLevel<span class="token double-colon punctuation">::</span>ERROR<span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token string">"ERROR"</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> LogLevel<span class="token double-colon punctuation">::</span>FATAL<span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token string">"FATAL"</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token string">"UNKNOWN"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 策略模式构建落盘方式</span>
    <span class="token comment">//基类</span>
    <span class="token keyword">class</span> <span class="token class-name">LogStrategy</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">LogStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>
        <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">SyncLog</span><span class="token punctuation">(</span><span class="token keyword">const</span> string <span class="token operator">&amp;</span>message<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 不同模式的刷新方式</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token comment">//落盘方式为显示器</span>
    <span class="token keyword">class</span> <span class="token class-name">ConsoleLogStrategy</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">LogStrategy</span></span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">ConsoleLogStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">}</span>
        <span class="token comment">//重写虚函数</span>
        <span class="token keyword">void</span> <span class="token function">SyncLog</span><span class="token punctuation">(</span><span class="token keyword">const</span> string <span class="token operator">&amp;</span>message<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            LockGuard <span class="token function">lock</span><span class="token punctuation">(</span>_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            cout <span class="token operator">&lt;&lt;</span> message <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token keyword">private</span><span class="token operator">:</span>
        Mutex _mutex<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token comment">//落盘方式为文件</span>
    <span class="token keyword">class</span> <span class="token class-name">FileLogStrategy</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">LogStrategy</span></span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token operator">~</span><span class="token function">FileLogStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">}</span>
        <span class="token function">FileLogStrategy</span><span class="token punctuation">(</span><span class="token keyword">const</span> string <span class="token operator">&amp;</span>logpath <span class="token operator">=</span> defaultpath<span class="token punctuation">,</span> <span class="token keyword">const</span> string <span class="token operator">&amp;</span>logname <span class="token operator">=</span> defaultname<span class="token punctuation">)</span>
            <span class="token operator">:</span> <span class="token function">_logpath</span><span class="token punctuation">(</span>logpath<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_logname</span><span class="token punctuation">(</span>logname<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            LockGuard <span class="token function">lock</span><span class="token punctuation">(</span>_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//应用C++17的接口完成文件操作</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>filesystem<span class="token double-colon punctuation">::</span><span class="token function">exists</span><span class="token punctuation">(</span>_logpath<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span>
            <span class="token punctuation">{<!-- --></span>
                std<span class="token double-colon punctuation">::</span>filesystem<span class="token double-colon punctuation">::</span><span class="token function">create_directories</span><span class="token punctuation">(</span>_logpath<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>filesystem<span class="token double-colon punctuation">::</span>filesystem_error <span class="token operator">&amp;</span>e<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                std<span class="token double-colon punctuation">::</span>cerr <span class="token operator">&lt;&lt;</span> e<span class="token punctuation">.</span><span class="token function">what</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token char">'\n'</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//重写虚函数</span>
        <span class="token keyword">void</span> <span class="token function">SyncLog</span><span class="token punctuation">(</span><span class="token keyword">const</span> string <span class="token operator">&amp;</span>message<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            LockGuard <span class="token function">lock</span><span class="token punctuation">(</span>_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            string log <span class="token operator">=</span> _logpath <span class="token operator">+</span> _logname<span class="token punctuation">;</span>
            ofstream <span class="token function">out</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ios<span class="token double-colon punctuation">::</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 追加⽅式</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>out<span class="token punctuation">.</span><span class="token function">is_open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            out <span class="token operator">&lt;&lt;</span> message <span class="token operator">&lt;&lt;</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>
            out<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token keyword">private</span><span class="token operator">:</span>
        Mutex _mutex<span class="token punctuation">;</span>
        <span class="token keyword">const</span> string <span class="token operator">&amp;</span>_logpath<span class="token punctuation">;</span>
        <span class="token keyword">const</span> string <span class="token operator">&amp;</span>_logname<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
	
	<span class="token comment">//日志类</span>
    <span class="token keyword">class</span> <span class="token class-name">Logger</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">Logger</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
        	<span class="token comment">//默认落盘显示器</span>
            <span class="token function">UseConsoleStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">void</span> <span class="token function">UseConsoleStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _strategy <span class="token operator">=</span> <span class="token generic-function"><span class="token function">make_unique</span><span class="token generic class-name"><span class="token operator">&lt;</span>ConsoleLogStrategy<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">void</span> <span class="token function">UseFileLogStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _strategy <span class="token operator">=</span> <span class="token generic-function"><span class="token function">make_unique</span><span class="token generic class-name"><span class="token operator">&lt;</span>FileLogStrategy<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
		<span class="token comment">//内部类：日志信息</span>
        <span class="token keyword">class</span> <span class="token class-name">LogMessage</span>
        <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">public</span><span class="token operator">:</span>
            <span class="token function">LogMessage</span><span class="token punctuation">(</span>LogLevel type<span class="token punctuation">,</span> string filename<span class="token punctuation">,</span> <span class="token keyword">int</span> line<span class="token punctuation">,</span> Logger <span class="token operator">&amp;</span>logger<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">_type</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                                                   <span class="token function">_curr_time</span><span class="token punctuation">(</span><span class="token function">GetCurTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                                                   <span class="token function">_pid</span><span class="token punctuation">(</span><span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                                                   <span class="token function">_filename</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                                                   <span class="token function">_line</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                                                   <span class="token function">_logger</span><span class="token punctuation">(</span>logger<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
            	<span class="token comment">//字符串流</span>
                std<span class="token double-colon punctuation">::</span>stringstream ssbuffer<span class="token punctuation">;</span>
                ssbuffer <span class="token operator">&lt;&lt;</span> <span class="token string">"["</span> <span class="token operator">&lt;&lt;</span> _curr_time <span class="token operator">&lt;&lt;</span> <span class="token string">"] "</span>
                         <span class="token operator">&lt;&lt;</span> <span class="token string">"["</span> <span class="token operator">&lt;&lt;</span> <span class="token function">LogLevelToString</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"] "</span>
                         <span class="token operator">&lt;&lt;</span> <span class="token string">"["</span> <span class="token operator">&lt;&lt;</span> _pid <span class="token operator">&lt;&lt;</span> <span class="token string">"] "</span>
                         <span class="token operator">&lt;&lt;</span> <span class="token string">"["</span> <span class="token operator">&lt;&lt;</span> _filename <span class="token operator">&lt;&lt;</span> <span class="token string">"] "</span>
                         <span class="token operator">&lt;&lt;</span> <span class="token string">"["</span> <span class="token operator">&lt;&lt;</span> _line <span class="token operator">&lt;&lt;</span> <span class="token string">"]"</span>
                         <span class="token operator">&lt;&lt;</span> <span class="token string">" - "</span><span class="token punctuation">;</span>
                _loginfo <span class="token operator">=</span> ssbuffer<span class="token punctuation">.</span><span class="token function">str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
			<span class="token comment">//重载&lt;&lt;，完成自定义信息输出部分</span>
            <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
            LogMessage <span class="token operator">&amp;</span><span class="token keyword">operator</span><span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span><span class="token keyword">const</span> T <span class="token operator">&amp;</span>info<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                stringstream ssbuffer<span class="token punctuation">;</span>
                ssbuffer <span class="token operator">&lt;&lt;</span> info<span class="token punctuation">;</span>
                _loginfo <span class="token operator">+=</span> ssbuffer<span class="token punctuation">.</span><span class="token function">str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//刷新日志</span>
            <span class="token operator">~</span><span class="token function">LogMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>_logger<span class="token punctuation">.</span>_strategy<span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    _logger<span class="token punctuation">.</span>_strategy<span class="token operator">-&gt;</span><span class="token function">SyncLog</span><span class="token punctuation">(</span>_loginfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token keyword">private</span><span class="token operator">:</span>
            LogLevel _type<span class="token punctuation">;</span>         <span class="token comment">// 日志等级</span>
            std<span class="token double-colon punctuation">::</span>string _curr_time<span class="token punctuation">;</span> <span class="token comment">// 日志时间</span>
            pid_t _pid<span class="token punctuation">;</span>             <span class="token comment">// 写入日志的时间</span>
            std<span class="token double-colon punctuation">::</span>string _filename<span class="token punctuation">;</span>  <span class="token comment">// 对应的文件名</span>
            <span class="token keyword">int</span> _line<span class="token punctuation">;</span>              <span class="token comment">// 对应的文件⾏号</span>
            Logger <span class="token operator">&amp;</span>_logger<span class="token punctuation">;</span>        <span class="token comment">// 引用外部logger类, ⽅便使用策略进行刷新</span>
            std<span class="token double-colon punctuation">::</span>string _loginfo<span class="token punctuation">;</span>   <span class="token comment">// 一条合并完成的，完整的日志信息</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token comment">//故意不带&amp;，目的就是为了生成LogMessage对象，让它在析构时将日志信息刷新</span>
        LogMessage <span class="token keyword">operator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>LogLevel type<span class="token punctuation">,</span> string filename<span class="token punctuation">,</span> <span class="token keyword">int</span> line<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token function">LogMessage</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> filename<span class="token punctuation">,</span> line<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token operator">~</span><span class="token function">Logger</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            
        <span class="token punctuation">}</span>
    <span class="token keyword">private</span><span class="token operator">:</span>
        std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>LogStrategy<span class="token operator">&gt;</span> _strategy<span class="token punctuation">;</span><span class="token comment">//日志刷新的策略</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    Logger logger<span class="token punctuation">;</span><span class="token comment">//定义全局对象</span>

<span class="token comment">// 使用宏，可以进行代码插⼊，⽅便随时获取文件名和行号</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LOG</span><span class="token expression"><span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token function">logger</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> <span class="token constant">__FILE__</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">)</span></span></span>
<span class="token comment">// 提供选择使⽤何种日志策略的方法</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">ENABLE_CONSOLE_LOG_STRATEGY</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span> logger<span class="token punctuation">.</span><span class="token function">UseConsoleStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">ENABLE_FILE_LOG_STRATEGY</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span> logger<span class="token punctuation">.</span><span class="token function">UseFileStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span>
<span class="token punctuation">}</span>
</code></pre>
    <pre><code class="prism language-cpp"><span class="token comment">//test.cc</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Log.hpp"</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> LogMudual<span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">ENABLE_CONSOLE_LOG_STRATEGY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOG</span><span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>DEBUG<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"hello world"</span><span class="token punctuation">;</span>
    <span class="token function">LOG</span><span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>DEBUG<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"hello world"</span><span class="token punctuation">;</span>
    <span class="token function">LOG</span><span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>DEBUG<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"hello world"</span><span class="token punctuation">;</span>
    <span class="token function">ENABLE_FILE_LOG_STRATEGY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOG</span><span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>DEBUG<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"hello world"</span><span class="token punctuation">;</span>
    <span class="token function">LOG</span><span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>DEBUG<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"hello world"</span><span class="token punctuation">;</span>
    <span class="token function">LOG</span><span class="token punctuation">(</span>LogLevel<span class="token double-colon punctuation">::</span>WARNING<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"hello world"</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f:672e6373646e2e6e65742f323330315f38303235383333362f:61727469636c652f64657461696c732f313436323832363433" class_="artid" style="display:none">
 </p>
</div>


