---
layout: post
title: "存储优化protobuf与mmkv"
date: 2025-03-11 19:27:31 +0800
description: "高效序列化：比XML小3-10倍，比JSON小2-5倍解析速度快：比XML快20-100倍语言中立：支持多种编程语言向前兼容：可以在不破坏现有应用的情况下更新数据结构在目录下创建user.protoMALE = 1;FEMALE = 2;MMKV是腾讯开源的一个基于mmap的高性能通用key-value组件，专为移动应用设计，用于替代SharedPreferences。高性能：基于内存映射(mmap)，读写性能远超SharedPreferences多进程安全。"
keywords: "存储优化（protobuf与mmkv）"
categories: ['Android']
tags: ['Kotlin', 'Android']
artid: "146186612"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146186612
    alt: "存储优化protobuf与mmkv"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146186612
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146186612
cover: https://bing.ee123.net/img/rand?artid=146186612
image: https://bing.ee123.net/img/rand?artid=146186612
img: https://bing.ee123.net/img/rand?artid=146186612
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     存储优化（protobuf与mmkv）
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="protobufmmkv_0">
     </a>
     存储优化（protobuf与mmkv）
    </h2>
    <p>
     在Android应用开发中，数据存储是一个基础且关键的环节。随着应用功能的日益复杂，数据量的增加，传统的存储方式如SharedPreferences、SQLite等在性能上的局限性逐渐显现。本文将深入探讨两种高效的存储优化方案：Protocol Buffers (protobuf) 和 MMKV，帮助开发者构建更高效、更可靠的数据存储系统。
    </p>
    <h3>
     <a id="_4">
     </a>
     一、传统存储方式的局限性
    </h3>
    <p>
     在讨论优化方案前，我们先来分析一下传统存储方式存在的问题：
    </p>
    <h4>
     <a id="11_SharedPreferences_8">
     </a>
     1.1 SharedPreferences的局限
    </h4>
    <pre><code class="prism language-java"><span class="token comment">// SharedPreferences的典型使用方式</span>
<span class="token class-name">SharedPreferences</span> sp <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getSharedPreferences</span><span class="token punctuation">(</span><span class="token string">"config"</span><span class="token punctuation">,</span> <span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">MODE_PRIVATE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">SharedPreferences<span class="token punctuation">.</span>Editor</span> editor <span class="token operator">=</span> sp<span class="token punctuation">.</span><span class="token function">edit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
editor<span class="token punctuation">.</span><span class="token function">putString</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">,</span> <span class="token string">"张三"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
editor<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span><span class="token string">"age"</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
editor<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 或commit()</span>
</code></pre>
    <p>
     SharedPreferences虽然使用简单，但存在以下问题：
    </p>
    <ul>
     <li>
      <strong>
       性能问题
      </strong>
      ：apply()方法虽然是异步的，但在主线程中仍可能造成ANR
     </li>
     <li>
      <strong>
       全量写入
      </strong>
      ：即使只修改一个小的键值，也会导致整个文件的重写
     </li>
     <li>
      <strong>
       数据类型有限
      </strong>
      ：只支持基本数据类型和String
     </li>
     <li>
      <strong>
       多进程不安全
      </strong>
      ：在多进程环境下容易出现数据丢失或不一致
     </li>
    </ul>
    <h4>
     <a id="12_SQLite_26">
     </a>
     1.2 SQLite的局限
    </h4>
    <pre><code class="prism language-java"><span class="token comment">// SQLite插入数据示例</span>
<span class="token class-name">ContentValues</span> values <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ContentValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
values<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"张三"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
values<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"age"</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
db<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> values<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     SQLite虽然功能强大，但也有其不足：
    </p>
    <ul>
     <li>
      <strong>
       启动耗时
      </strong>
      ：数据库连接和初始化需要时间
     </li>
     <li>
      <strong>
       操作复杂
      </strong>
      ：相比键值存储，需要编写更多代码
     </li>
     <li>
      <strong>
       资源占用
      </strong>
      ：对于简单数据存储来说过于重量级
     </li>
    </ul>
    <h3>
     <a id="Protocol_Buffers_protobuf__42">
     </a>
     二、Protocol Buffers (protobuf) 详解
    </h3>
    <h4>
     <a id="21_protobuf_44">
     </a>
     2.1 什么是protobuf
    </h4>
    <p>
     Protocol Buffers是Google开发的一种轻量级、高效的结构化数据序列化机制，具有以下特点：
    </p>
    <ul>
     <li>
      <strong>
       高效序列化
      </strong>
      ：比XML小3-10倍，比JSON小2-5倍
     </li>
     <li>
      <strong>
       解析速度快
      </strong>
      ：比XML快20-100倍
     </li>
     <li>
      <strong>
       语言中立
      </strong>
      ：支持多种编程语言
     </li>
     <li>
      <strong>
       向前兼容
      </strong>
      ：可以在不破坏现有应用的情况下更新数据结构
     </li>
    </ul>
    <h4>
     <a id="22_Androidprotobuf_53">
     </a>
     2.2 在Android中使用protobuf
    </h4>
    <h5>
     <a id="221__55">
     </a>
     2.2.1 添加依赖
    </h5>
    <pre><code class="prism language-gradle">dependencies {
    // protobuf依赖
    implementation 'com.google.protobuf:protobuf-javalite:3.18.0'
    // protobuf编译插件
    implementation 'com.google.protobuf:protoc:3.18.0'
}
</code></pre>
    <h5>
     <a id="222_proto_66">
     </a>
     2.2.2 定义.proto文件
    </h5>
    <p>
     在
     <code>
      src/main/proto
     </code>
     目录下创建
     <code>
      user.proto
     </code>
     文件：
    </p>
    <pre><code class="prism language-protobuf">syntax = "proto3";

package com.example.myapp;

option java_package = "com.example.myapp.proto";
option java_multiple_files = true;

message User {
  string name = 1;
  int32 age = 2;
  string email = 3;
  
  enum Gender {
    UNKNOWN = 0;
    MALE = 1;
    FEMALE = 2;
  }
  
  Gender gender = 4;
  repeated string hobbies = 5;
}
</code></pre>
    <h5>
     <a id="223_Gradle_94">
     </a>
     2.2.3 配置Gradle插件
    </h5>
    <pre><code class="prism language-gradle">plugins {
    id 'com.google.protobuf' version '0.8.18'
}

protobuf {
    protoc {
        artifact = 'com.google.protobuf:protoc:3.18.0'
    }
    generateProtoTasks {
        all().each { task -&gt;
            task.builtins {
                java {
                    option 'lite'
                }
            }
        }
    }
}
</code></pre>
    <h5>
     <a id="224__117">
     </a>
     2.2.4 使用生成的类
    </h5>
    <pre><code class="prism language-java"><span class="token comment">// 创建User对象</span>
<span class="token class-name">User<span class="token punctuation">.</span>Builder</span> userBuilder <span class="token operator">=</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">User</span> user <span class="token operator">=</span> userBuilder
    <span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"张三"</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">setAge</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">setEmail</span><span class="token punctuation">(</span><span class="token string">"zhangsan@example.com"</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">setGender</span><span class="token punctuation">(</span><span class="token class-name">User<span class="token punctuation">.</span>Gender</span><span class="token punctuation">.</span><span class="token constant">MALE</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">addHobbies</span><span class="token punctuation">(</span><span class="token string">"读书"</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">addHobbies</span><span class="token punctuation">(</span><span class="token string">"旅行"</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 序列化</span>
<span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> userBytes <span class="token operator">=</span> user<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 将序列化数据保存到文件</span>
<span class="token class-name">FileOutputStream</span> fos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token string">"user.pb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
fos<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>userBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
fos<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 从文件读取并反序列化</span>
<span class="token class-name">FileInputStream</span> fis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">"user.pb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span>fis<span class="token punctuation">.</span><span class="token function">available</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
fis<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
fis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">User</span> parsedUser <span class="token operator">=</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token function">parseFrom</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <h4>
     <a id="23_protobuf_147">
     </a>
     2.3 protobuf的优化原理
    </h4>
    <ol>
     <li>
      <strong>
       紧凑的二进制格式
      </strong>
      ：使用变长编码，小数字占用更少的字节
     </li>
     <li>
      <strong>
       字段编号
      </strong>
      ：使用数字而非字符串标识字段，减少存储空间
     </li>
     <li>
      <strong>
       可选字段
      </strong>
      ：未设置的字段不占用空间
     </li>
     <li>
      <strong>
       高效的解析算法
      </strong>
      ：无需遍历整个数据结构
     </li>
    </ol>
    <h3>
     <a id="MMKV_154">
     </a>
     三、MMKV详解
    </h3>
    <h4>
     <a id="31_MMKV_156">
     </a>
     3.1 什么是MMKV
    </h4>
    <p>
     MMKV是腾讯开源的一个基于mmap的高性能通用key-value组件，专为移动应用设计，用于替代SharedPreferences。
    </p>
    <p>
     主要特点：
    </p>
    <ul>
     <li>
      <strong>
       高性能
      </strong>
      ：基于内存映射(mmap)，读写性能远超SharedPreferences
     </li>
     <li>
      <strong>
       多进程安全
      </strong>
      ：支持多进程并发读写
     </li>
     <li>
      <strong>
       崩溃恢复
      </strong>
      ：进程崩溃不会丢失数据
     </li>
     <li>
      <strong>
       加密支持
      </strong>
      ：可以对数据进行AES加密
     </li>
    </ul>
    <h4>
     <a id="32_AndroidMMKV_167">
     </a>
     3.2 在Android中使用MMKV
    </h4>
    <h5>
     <a id="321__169">
     </a>
     3.2.1 添加依赖
    </h5>
    <pre><code class="prism language-gradle">dependencies {
    implementation 'com.tencent:mmkv:1.2.14'
}
</code></pre>
    <h5>
     <a id="322_MMKV_177">
     </a>
     3.2.2 初始化MMKV
    </h5>
    <pre><code class="prism language-java"><span class="token comment">// 在Application的onCreate方法中初始化</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyApplication</span> <span class="token keyword">extends</span> <span class="token class-name">Application</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> rootDir <span class="token operator">=</span> <span class="token constant">MMKV</span><span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token string">"MMKV"</span><span class="token punctuation">,</span> <span class="token string">"mmkv root: "</span> <span class="token operator">+</span> rootDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h5>
     <a id="323__191">
     </a>
     3.2.3 基本使用
    </h5>
    <pre><code class="prism language-java"><span class="token comment">// 获取默认实例</span>
<span class="token class-name">MMKV</span> kv <span class="token operator">=</span> <span class="token constant">MMKV</span><span class="token punctuation">.</span><span class="token function">defaultMMKV</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 写入数据</span>
kv<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">"bool"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
kv<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">"int"</span><span class="token punctuation">,</span> <span class="token number">123</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
kv<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">"long"</span><span class="token punctuation">,</span> <span class="token number">123456789L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
kv<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">"float"</span><span class="token punctuation">,</span> <span class="token number">3.14f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
kv<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">"double"</span><span class="token punctuation">,</span> <span class="token number">3.14159</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
kv<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">"string"</span><span class="token punctuation">,</span> <span class="token string">"Hello MMKV"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
kv<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">"bytes"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span><span class="token number">97</span><span class="token punctuation">,</span> <span class="token number">98</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 读取数据</span>
<span class="token keyword">boolean</span> bValue <span class="token operator">=</span> kv<span class="token punctuation">.</span><span class="token function">decodeBool</span><span class="token punctuation">(</span><span class="token string">"bool"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> iValue <span class="token operator">=</span> kv<span class="token punctuation">.</span><span class="token function">decodeInt</span><span class="token punctuation">(</span><span class="token string">"int"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">long</span> lValue <span class="token operator">=</span> kv<span class="token punctuation">.</span><span class="token function">decodeLong</span><span class="token punctuation">(</span><span class="token string">"long"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">float</span> fValue <span class="token operator">=</span> kv<span class="token punctuation">.</span><span class="token function">decodeFloat</span><span class="token punctuation">(</span><span class="token string">"float"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">double</span> dValue <span class="token operator">=</span> kv<span class="token punctuation">.</span><span class="token function">decodeDouble</span><span class="token punctuation">(</span><span class="token string">"double"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> sValue <span class="token operator">=</span> kv<span class="token punctuation">.</span><span class="token function">decodeString</span><span class="token punctuation">(</span><span class="token string">"string"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> kv<span class="token punctuation">.</span><span class="token function">decodeBytes</span><span class="token punctuation">(</span><span class="token string">"bytes"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <h5>
     <a id="324__216">
     </a>
     3.2.4 多进程支持
    </h5>
    <pre><code class="prism language-java"><span class="token comment">// 创建多进程实例</span>
<span class="token class-name">MMKV</span> mmkv <span class="token operator">=</span> <span class="token constant">MMKV</span><span class="token punctuation">.</span><span class="token function">mmkvWithID</span><span class="token punctuation">(</span><span class="token string">"MultiProcess"</span><span class="token punctuation">,</span> <span class="token constant">MMKV</span><span class="token punctuation">.</span><span class="token constant">MULTI_PROCESS_MODE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
mmkv<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">"process_id"</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span>Process</span><span class="token punctuation">.</span><span class="token function">myPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <h5>
     <a id="325__224">
     </a>
     3.2.5 加密支持
    </h5>
    <pre><code class="prism language-java"><span class="token comment">// 创建加密实例</span>
<span class="token class-name">String</span> cryptKey <span class="token operator">=</span> <span class="token string">"my_crypt_key"</span><span class="token punctuation">;</span>
<span class="token class-name">MMKV</span> kv <span class="token operator">=</span> <span class="token constant">MMKV</span><span class="token punctuation">.</span><span class="token function">mmkvWithID</span><span class="token punctuation">(</span><span class="token string">"encrypted"</span><span class="token punctuation">,</span> cryptKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
kv<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">,</span> <span class="token string">"admin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
kv<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">,</span> <span class="token string">"123456"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <h4>
     <a id="33_MMKV_234">
     </a>
     3.3 MMKV的底层实现原理
    </h4>
    <h5>
     <a id="331_mmap_236">
     </a>
     3.3.1 内存映射(mmap)技术
    </h5>
    <p>
     MMKV的核心技术是内存映射(Memory Mapped Files)，它是一种将文件内容映射到进程的虚拟内存空间的技术。
    </p>
    <pre><code class="prism language-java"><span class="token comment">// MMKV中mmap的核心实现（C++代码简化版）</span>
<span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">mmapFile</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> size_t size<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">void</span><span class="token operator">*</span> ptr <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span>nullptr<span class="token punctuation">,</span> size<span class="token punctuation">,</span> <span class="token constant">PROT_READ</span> <span class="token operator">|</span> <span class="token constant">PROT_WRITE</span><span class="token punctuation">,</span> <span class="token constant">MAP_SHARED</span><span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ptr <span class="token operator">==</span> <span class="token constant">MAP_FAILED</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 处理映射失败</span>
        <span class="token keyword">return</span> nullptr<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> ptr<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     <strong>
      工作原理
     </strong>
     ：
    </p>
    <ol>
     <li>
      <p>
       <strong>
        零拷贝
       </strong>
       ：传统文件操作需要先将文件数据从磁盘拷贝到内核空间，再从内核空间拷贝到用户空间。而mmap直接在虚拟内存中操作，避免了这两次拷贝过程。
      </p>
     </li>
     <li>
      <p>
       <strong>
        页缓存共享
       </strong>
       ：多个进程可以共享同一个文件的页缓存，节省内存。
      </p>
     </li>
     <li>
      <p>
       <strong>
        延迟加载
       </strong>
       ：操作系统会根据需要将文件数据加载到物理内存，而不是一次性全部加载。
      </p>
     </li>
     <li>
      <p>
       <strong>
        写回机制
       </strong>
       ：对映射内存的修改不会立即写回磁盘，而是由操作系统的页面置换算法决定何时写回，提高了写入效率。
      </p>
     </li>
    </ol>
    <h5>
     <a id="332__262">
     </a>
     3.3.2 文件结构与数据组织
    </h5>
    <p>
     MMKV的文件由两部分组成：
    </p>
    <ol>
     <li>
      <strong>
       数据文件
      </strong>
      ：存储实际的键值对数据
     </li>
     <li>
      <strong>
       元数据文件
      </strong>
      ：存储索引信息，用于快速定位键值对
     </li>
    </ol>
    <pre><code>+----------------+     +----------------+
|  数据文件       |     |  元数据文件     |
|  (mmkv.dat)    |     |  (mmkv.crc)    |
+----------------+     +----------------+
| 键值对1         |     | 键1的位置和长度  |
| 键值对2         |     | 键2的位置和长度  |
| ...            |     | ...            |
+----------------+     +----------------+
</code></pre>
    <h5>
     <a id="333__280">
     </a>
     3.3.3 写时复制与增量更新
    </h5>
    <p>
     MMKV采用了写时复制(Copy-On-Write)和增量更新策略：
    </p>
    <ol>
     <li>
      <p>
       <strong>
        写时复制
       </strong>
       ：当需要修改数据时，MMKV不会直接修改原有数据，而是创建一个新的副本进行修改。这样可以保证在修改过程中，其他读取操作仍然可以访问旧数据，提高了并发性能。
      </p>
     </li>
     <li>
      <p>
       <strong>
        增量更新
       </strong>
       ：MMKV不会像SharedPreferences那样每次修改都重写整个文件，而是采用追加写入的方式。新的键值对会被追加到文件末尾，同时更新元数据中的索引信息。
      </p>
     </li>
    </ol>
    <pre><code class="prism language-java"><span class="token comment">// 伪代码：MMKV的写入流程</span>
<span class="token keyword">void</span> <span class="token function">encode</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 1. 序列化值</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data <span class="token operator">=</span> <span class="token function">serialize</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 2. 追加到文件末尾</span>
    <span class="token keyword">int</span> position <span class="token operator">=</span> <span class="token function">appendToFile</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 3. 更新内存中的索引表</span>
    <span class="token function">updateIndex</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> position<span class="token punctuation">,</span> data<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 4. 异步更新元数据文件</span>
    <span class="token function">asyncUpdateMetaInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h5>
     <a id="334__305">
     </a>
     3.3.4 异步落盘机制
    </h5>
    <p>
     MMKV的写入操作分为两个阶段：
    </p>
    <ol>
     <li>
      <p>
       <strong>
        内存操作
       </strong>
       ：首先在内存中完成数据的修改和索引更新，这一步速度非常快。
      </p>
     </li>
     <li>
      <p>
       <strong>
        异步落盘
       </strong>
       ：然后通过后台线程将修改异步写入磁盘，不会阻塞主线程。
      </p>
     </li>
    </ol>
    <pre><code class="prism language-java"><span class="token comment">// 伪代码：MMKV的异步落盘机制</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">asyncSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>needSync<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    
    executor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mmapLock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">msync</span><span class="token punctuation">(</span>memoryPtr<span class="token punctuation">,</span> fileSize<span class="token punctuation">,</span> <span class="token constant">MS_ASYNC</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                needSync <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h5>
     <a id="335__328">
     </a>
     3.3.5 数据校验与崩溃恢复
    </h5>
    <p>
     MMKV使用CRC32进行数据校验，确保数据的完整性：
    </p>
    <ol>
     <li>
      <p>
       <strong>
        写入校验
       </strong>
       ：每次写入数据时，会计算数据的CRC校验值并存储。
      </p>
     </li>
     <li>
      <p>
       <strong>
        读取校验
       </strong>
       ：读取数据时，会重新计算CRC值并与存储的值比较，如果不一致，说明数据已损坏。
      </p>
     </li>
     <li>
      <p>
       <strong>
        崩溃恢复
       </strong>
       ：当检测到数据损坏时，MMKV会尝试从上一个有效的状态恢复数据。
      </p>
     </li>
    </ol>
    <pre><code class="prism language-java"><span class="token comment">// 伪代码：MMKV的崩溃恢复机制</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">loadFromFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 读取文件内容</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> content <span class="token operator">=</span> <span class="token function">readFromMappedFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 计算CRC校验值</span>
    <span class="token keyword">int</span> crc <span class="token operator">=</span> <span class="token function">calculateCRC</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 比较校验值</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>crc <span class="token operator">!=</span> storedCRC<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 数据损坏，尝试恢复</span>
        <span class="token function">recoverFromBackup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 数据正常，解析内容</span>
        <span class="token function">parseContent</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h5>
     <a id="336__358">
     </a>
     3.3.6 多进程并发控制
    </h5>
    <p>
     MMKV通过文件锁和内存屏障等机制实现多进程安全：
    </p>
    <ol>
     <li>
      <p>
       <strong>
        文件锁
       </strong>
       ：在多进程模式下，MMKV使用文件锁来同步对同一文件的访问。
      </p>
     </li>
     <li>
      <p>
       <strong>
        内存屏障
       </strong>
       ：确保内存操作的可见性和顺序性，防止指令重排导致的数据不一致。
      </p>
     </li>
    </ol>
    <pre><code class="prism language-java"><span class="token comment">// 伪代码：MMKV的多进程锁实现</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">lockForWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isMultiProcess<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 获取文件锁</span>
        fileLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 执行写操作</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isMultiProcess<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 释放文件锁</span>
        fileLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="_382">
     </a>
     四、性能对比与选型建议
    </h3>
    <h4>
     <a id="41__384">
     </a>
     4.1 性能对比
    </h4>
    <p>
     以下是在中端Android设备上的性能测试结果（数据仅供参考）：
    </p>
    <table>
     <thead>
      <tr>
       <th>
        操作
       </th>
       <th>
        SharedPreferences
       </th>
       <th>
        SQLite
       </th>
       <th>
        MMKV
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        写入100条数据(ms)
       </td>
       <td>
        320
       </td>
       <td>
        150
       </td>
       <td>
        12
       </td>
      </tr>
      <tr>
       <td>
        读取100条数据(ms)
       </td>
       <td>
        28
       </td>
       <td>
        48
       </td>
       <td>
        5
       </td>
      </tr>
      <tr>
       <td>
        文件大小(KB)
       </td>
       <td>
        15
       </td>
       <td>
        20
       </td>
       <td>
        10
       </td>
      </tr>
     </tbody>
    </table>
    <h4>
     <a id="42__394">
     </a>
     4.2 选型建议
    </h4>
    <ul>
     <li>
      <strong>
       简单键值存储
      </strong>
      ：MMKV是最佳选择，特别是需要高频读写或多进程访问时
     </li>
     <li>
      <strong>
       大量关系型数据
      </strong>
      ：SQLite仍然是首选
     </li>
     <li>
      <strong>
       配置信息
      </strong>
      ：小型应用可以继续使用SharedPreferences，大型应用建议迁移到MMKV
     </li>
    </ul>
    <h3>
     <a id="_400">
     </a>
     五、实战案例：聊天应用的消息缓存优化
    </h3>
    <h4>
     <a id="51__402">
     </a>
     5.1 需求分析
    </h4>
    <p>
     聊天应用需要缓存大量消息，要求：
    </p>
    <ul>
     <li>
      快速读写
     </li>
     <li>
      支持复杂的消息结构
     </li>
     <li>
      节省存储空间
     </li>
     <li>
      崩溃恢复
     </li>
    </ul>
    <h4>
     <a id="52__410">
     </a>
     5.2 实现方案
    </h4>
    <p>
     结合protobuf和MMKV的优势，我们设计如下方案：
    </p>
    <ol>
     <li>
      使用protobuf定义消息结构
     </li>
     <li>
      使用MMKV存储序列化后的消息
     </li>
    </ol>
    <h5>
     <a id="521__417">
     </a>
     5.2.1 定义消息结构
    </h5>
    <pre><code class="prism language-protobuf">syntax = "proto3";

package com.example.chat;

option java_package = "com.example.chat.proto";
option java_multiple_files = true;

message ChatMessage {
  string message_id = 1;
  string sender_id = 2;
  string receiver_id = 3;
  string content = 4;
  int64 timestamp = 5;
  
  enum MessageType {
    TEXT = 0;
    IMAGE = 1;
    VIDEO = 2;
    AUDIO = 3;
  }
  
  MessageType type = 6;
  
  message MediaInfo {
    string url = 1;
    int32 duration = 2; // 音视频时长
    string thumbnail = 3; // 缩略图URL
  }
  
  MediaInfo media_info = 7;
  bool is_read = 8;
}

message Conversation {
  string conversation_id = 1;
  repeated ChatMessage messages = 2;
  int64 last_update_time = 3;
}
</code></pre>
    <h5>
     <a id="522__460">
     </a>
     5.2.2 消息缓存管理器
    </h5>
    <pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MessageCacheManager</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">TAG</span> <span class="token operator">=</span> <span class="token string">"MessageCacheManager"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">MessageCacheManager</span> instance<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">MMKV</span> mmkv<span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token class-name">MessageCacheManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mmkv <span class="token operator">=</span> <span class="token constant">MMKV</span><span class="token punctuation">.</span><span class="token function">mmkvWithID</span><span class="token punctuation">(</span><span class="token string">"chat_messages"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">synchronized</span> <span class="token class-name">MessageCacheManager</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageCacheManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> instance<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 保存会话</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">saveConversation</span><span class="token punctuation">(</span><span class="token class-name">Conversation</span> conversation<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token string">"conv_"</span> <span class="token operator">+</span> conversation<span class="token punctuation">.</span><span class="token function">getConversationId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data <span class="token operator">=</span> conversation<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mmkv<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"保存会话失败"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 获取会话</span>
    <span class="token keyword">public</span> <span class="token class-name">Conversation</span> <span class="token function">getConversation</span><span class="token punctuation">(</span><span class="token class-name">String</span> conversationId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token string">"conv_"</span> <span class="token operator">+</span> conversationId<span class="token punctuation">;</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data <span class="token operator">=</span> mmkv<span class="token punctuation">.</span><span class="token function">decodeBytes</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token class-name">Conversation</span><span class="token punctuation">.</span><span class="token function">parseFrom</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"获取会话失败"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 保存单条消息</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">saveMessage</span><span class="token punctuation">(</span><span class="token class-name">String</span> conversationId<span class="token punctuation">,</span> <span class="token class-name">ChatMessage</span> message<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Conversation</span> conversation <span class="token operator">=</span> <span class="token function">getConversation</span><span class="token punctuation">(</span>conversationId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Conversation<span class="token punctuation">.</span>Builder</span> builder<span class="token punctuation">;</span>
            
            <span class="token keyword">if</span> <span class="token punctuation">(</span>conversation <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                builder <span class="token operator">=</span> <span class="token class-name">Conversation</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">setConversationId</span><span class="token punctuation">(</span>conversationId<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">setLastUpdateTime</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                builder <span class="token operator">=</span> <span class="token class-name">Conversation</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span>conversation<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 检查消息是否已存在</span>
                <span class="token keyword">boolean</span> exists <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ChatMessage</span> existingMsg <span class="token operator">:</span> conversation<span class="token punctuation">.</span><span class="token function">getMessagesList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>existingMsg<span class="token punctuation">.</span><span class="token function">getMessageId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getMessageId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        exists <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>exists<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">// 消息已存在，不重复添加</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            
            <span class="token comment">// 添加新消息并更新时间戳</span>
            builder<span class="token punctuation">.</span><span class="token function">addMessages</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>
                   <span class="token punctuation">.</span><span class="token function">setLastUpdateTime</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token comment">// 保存更新后的会话</span>
            <span class="token function">saveConversation</span><span class="token punctuation">(</span>builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"保存消息失败"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 删除会话</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deleteConversation</span><span class="token punctuation">(</span><span class="token class-name">String</span> conversationId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token string">"conv_"</span> <span class="token operator">+</span> conversationId<span class="token punctuation">;</span>
        mmkv<span class="token punctuation">.</span><span class="token function">removeValueForKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 获取所有会话ID</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAllConversationIds</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> keys <span class="token operator">=</span> mmkv<span class="token punctuation">.</span><span class="token function">allKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>keys <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> key <span class="token operator">:</span> keys<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"conv_"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    result<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 去掉"conv_"前缀</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 清除所有缓存</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">clearAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mmkv<span class="token punctuation">.</span><span class="token function">clearAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h5>
     <a id="523__567">
     </a>
     5.2.3 性能测试与对比
    </h5>
    <p>
     我们对比了传统SQLite方案与Protobuf+MMKV方案在聊天应用中的性能表现：
    </p>
    <table>
     <thead>
      <tr>
       <th>
        操作
       </th>
       <th>
        SQLite方案
       </th>
       <th>
        Protobuf+MMKV方案
       </th>
       <th>
        性能提升
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        写入1000条消息(ms)
       </td>
       <td>
        850
       </td>
       <td>
        120
       </td>
       <td>
        约7倍
       </td>
      </tr>
      <tr>
       <td>
        读取1000条消息(ms)
       </td>
       <td>
        320
       </td>
       <td>
        80
       </td>
       <td>
        约4倍
       </td>
      </tr>
      <tr>
       <td>
        存储空间占用(MB)
       </td>
       <td>
        1.8
       </td>
       <td>
        0.9
       </td>
       <td>
        约50%
       </td>
      </tr>
      <tr>
       <td>
        应用启动加载时间(ms)
       </td>
       <td>
        280
       </td>
       <td>
        45
       </td>
       <td>
        约6倍
       </td>
      </tr>
     </tbody>
    </table>
    <h5>
     <a id="524__578">
     </a>
     5.2.4 实现要点与优化技巧
    </h5>
    <ol>
     <li>
      <strong>
       批量操作优化
      </strong>
      ：对于批量消息的读写，可以一次性操作而不是逐条处理
     </li>
    </ol>
    <pre><code class="prism language-java"><span class="token comment">// 批量保存消息示例</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">saveMessages</span><span class="token punctuation">(</span><span class="token class-name">String</span> conversationId<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ChatMessage</span><span class="token punctuation">&gt;</span></span> messages<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Conversation</span> conversation <span class="token operator">=</span> <span class="token function">getConversation</span><span class="token punctuation">(</span>conversationId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Conversation<span class="token punctuation">.</span>Builder</span> builder<span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>conversation <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        builder <span class="token operator">=</span> <span class="token class-name">Conversation</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setConversationId</span><span class="token punctuation">(</span>conversationId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        builder <span class="token operator">=</span> <span class="token class-name">Conversation</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span>conversation<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 添加所有新消息</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ChatMessage</span> message <span class="token operator">:</span> messages<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        builder<span class="token punctuation">.</span><span class="token function">addMessages</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    builder<span class="token punctuation">.</span><span class="token function">setLastUpdateTime</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">saveConversation</span><span class="token punctuation">(</span>builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <ol start="2">
     <li>
      <strong>
       消息分页存储
      </strong>
      ：当会话消息过多时，可以按时间段分页存储
     </li>
    </ol>
    <pre><code class="prism language-java"><span class="token comment">// 分页存储示例</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">PAGE_SIZE</span> <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span> <span class="token comment">// 每页100条消息</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">saveMessageWithPaging</span><span class="token punctuation">(</span><span class="token class-name">String</span> conversationId<span class="token punctuation">,</span> <span class="token class-name">ChatMessage</span> message<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 获取当前页的消息</span>
    <span class="token class-name">String</span> pageKey <span class="token operator">=</span> <span class="token function">getPageKey</span><span class="token punctuation">(</span>conversationId<span class="token punctuation">,</span> message<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> pageData <span class="token operator">=</span> mmkv<span class="token punctuation">.</span><span class="token function">decodeBytes</span><span class="token punctuation">(</span>pageKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token class-name">ChatMessagePage<span class="token punctuation">.</span>Builder</span> pageBuilder<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pageData <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        pageBuilder <span class="token operator">=</span> <span class="token class-name">ChatMessagePage</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">ChatMessagePage</span> page <span class="token operator">=</span> <span class="token class-name">ChatMessagePage</span><span class="token punctuation">.</span><span class="token function">parseFrom</span><span class="token punctuation">(</span>pageData<span class="token punctuation">)</span><span class="token punctuation">;</span>
            pageBuilder <span class="token operator">=</span> <span class="token class-name">ChatMessagePage</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token comment">// 检查页是否已满</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>page<span class="token punctuation">.</span><span class="token function">getMessagesCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token constant">PAGE_SIZE</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 创建新页</span>
                pageKey <span class="token operator">=</span> <span class="token function">createNewPageKey</span><span class="token punctuation">(</span>conversationId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                pageBuilder <span class="token operator">=</span> <span class="token class-name">ChatMessagePage</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"解析消息页失败"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            pageBuilder <span class="token operator">=</span> <span class="token class-name">ChatMessagePage</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 添加消息到页</span>
    pageBuilder<span class="token punctuation">.</span><span class="token function">addMessages</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mmkv<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>pageKey<span class="token punctuation">,</span> pageBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 更新会话索引</span>
    <span class="token function">updateConversationIndex</span><span class="token punctuation">(</span>conversationId<span class="token punctuation">,</span> pageKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 获取页面键</span>
<span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getPageKey</span><span class="token punctuation">(</span><span class="token class-name">String</span> conversationId<span class="token punctuation">,</span> <span class="token keyword">long</span> timestamp<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 根据时间戳计算页面ID</span>
    <span class="token keyword">long</span> pageId <span class="token operator">=</span> timestamp <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token constant">PAGE_SIZE</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 每PAGE_SIZE条消息或每1000毫秒一页</span>
    <span class="token keyword">return</span> <span class="token string">"conv_"</span> <span class="token operator">+</span> conversationId <span class="token operator">+</span> <span class="token string">"_page_"</span> <span class="token operator">+</span> pageId<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 创建新页面键</span>
<span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">createNewPageKey</span><span class="token punctuation">(</span><span class="token class-name">String</span> conversationId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">long</span> currentTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">getPageKey</span><span class="token punctuation">(</span>conversationId<span class="token punctuation">,</span> currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 更新会话索引</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">updateConversationIndex</span><span class="token punctuation">(</span><span class="token class-name">String</span> conversationId<span class="token punctuation">,</span> <span class="token class-name">String</span> pageKey<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 在会话索引中记录页面信息</span>
    <span class="token comment">// 实际应用中可能需要更复杂的索引结构</span>
<span class="token punctuation">}</span>
</code></pre>
    <ol start="3">
     <li>
      <strong>
       加密存储敏感消息
      </strong>
      ：对于敏感内容，可以使用MMKV的加密功能
     </li>
    </ol>
    <pre><code class="prism language-java"><span class="token comment">// 加密存储示例</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">saveEncryptedMessage</span><span class="token punctuation">(</span><span class="token class-name">String</span> conversationId<span class="token punctuation">,</span> <span class="token class-name">ChatMessage</span> message<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 使用加密实例</span>
    <span class="token class-name">MMKV</span> encryptedMMKV <span class="token operator">=</span> <span class="token constant">MMKV</span><span class="token punctuation">.</span><span class="token function">mmkvWithID</span><span class="token punctuation">(</span><span class="token string">"encrypted_"</span> <span class="token operator">+</span> conversationId<span class="token punctuation">,</span> cryptKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 保存加密消息</span>
    <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token string">"msg_"</span> <span class="token operator">+</span> message<span class="token punctuation">.</span><span class="token function">getMessageId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    encryptedMMKV<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> message<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="_678">
     </a>
     六、存储优化相关面试题解析
    </h3>
    <h4>
     <a id="61__680">
     </a>
     6.1 基础概念题
    </h4>
    <h5>
     <a id="Q1_SharedPreferencesSQLiteMMKV_682">
     </a>
     Q1: SharedPreferences、SQLite、MMKV各有什么优缺点？适用于哪些场景？
    </h5>
    <p>
     <strong>
      答
     </strong>
     ：
    </p>
    <p>
     <strong>
      SharedPreferences
     </strong>
     ：
    </p>
    <ul>
     <li>
      优点：使用简单，API友好，适合存储少量简单数据
     </li>
     <li>
      缺点：全量写入，多进程不安全，可能导致ANR
     </li>
     <li>
      适用场景：存储应用配置、用户偏好等小型数据
     </li>
    </ul>
    <p>
     <strong>
      SQLite
     </strong>
     ：
    </p>
    <ul>
     <li>
      优点：支持复杂查询，事务管理，数据完整性强
     </li>
     <li>
      缺点：启动耗时，API较复杂，资源占用较大
     </li>
     <li>
      适用场景：结构化数据存储，需要关系查询的场景
     </li>
    </ul>
    <p>
     <strong>
      MMKV
     </strong>
     ：
    </p>
    <ul>
     <li>
      优点：高性能，多进程安全，崩溃恢复，支持加密
     </li>
     <li>
      缺点：不支持复杂查询，需要额外依赖
     </li>
     <li>
      适用场景：高频读写的键值对存储，替代SharedPreferences
     </li>
    </ul>
    <h5>
     <a id="Q2_mmapMMKV_701">
     </a>
     Q2: 什么是mmap？它在MMKV中的作用是什么？
    </h5>
    <p>
     <strong>
      答
     </strong>
     ：mmap(内存映射)是一种将文件内容映射到进程虚拟内存空间的技术。在MMKV中，mmap的作用有：
    </p>
    <ol>
     <li>
      实现零拷贝：避免了传统文件操作中内核空间和用户空间的数据拷贝
     </li>
     <li>
      提高读写性能：直接在内存中操作，减少IO开销
     </li>
     <li>
      支持多进程共享：多个进程可以共享同一块内存区域
     </li>
     <li>
      实现持久化：对映射内存的修改最终会同步到磁盘文件
     </li>
    </ol>
    <h4>
     <a id="62__710">
     </a>
     6.2 实战应用题
    </h4>
    <h5>
     <a id="Q3_SharedPreferencesANR_712">
     </a>
     Q3: 如何优化SharedPreferences导致的ANR问题？
    </h5>
    <p>
     <strong>
      答
     </strong>
     ：
    </p>
    <ol>
     <li>
      <strong>
       使用apply()替代commit()
      </strong>
      ：apply()是异步的，不会阻塞主线程
     </li>
     <li>
      <strong>
       批量操作
      </strong>
      ：多次修改合并为一次提交
     </li>
     <li>
      <strong>
       避免在主线程初始化
      </strong>
      ：将SharedPreferences的初始化放在后台线程
     </li>
     <li>
      <strong>
       迁移到MMKV
      </strong>
      ：替换为性能更好的MMKV
     </li>
     <li>
      <strong>
       使用ContentProvider预加载
      </strong>
      ：在应用启动时预加载SharedPreferences
     </li>
    </ol>
    <pre><code class="prism language-java"><span class="token comment">// 批量操作示例</span>
<span class="token class-name">SharedPreferences<span class="token punctuation">.</span>Editor</span> editor <span class="token operator">=</span> sp<span class="token punctuation">.</span><span class="token function">edit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 多次修改</span>
editor<span class="token punctuation">.</span><span class="token function">putString</span><span class="token punctuation">(</span><span class="token string">"key1"</span><span class="token punctuation">,</span> <span class="token string">"value1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
editor<span class="token punctuation">.</span><span class="token function">putString</span><span class="token punctuation">(</span><span class="token string">"key2"</span><span class="token punctuation">,</span> <span class="token string">"value2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
editor<span class="token punctuation">.</span><span class="token function">putString</span><span class="token punctuation">(</span><span class="token string">"key3"</span><span class="token punctuation">,</span> <span class="token string">"value3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 一次提交</span>
editor<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <h5>
     <a id="Q4__733">
     </a>
     Q4: 在大型应用中，如何设计一个高效的数据存储方案？
    </h5>
    <p>
     <strong>
      答
     </strong>
     ：
    </p>
    <ol>
     <li>
      <p>
       <strong>
        分层存储
       </strong>
       ：
      </p>
      <ul>
       <li>
        内存层：使用LruCache缓存热点数据
       </li>
       <li>
        持久层：根据数据特点选择合适的存储方式
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        存储策略
       </strong>
       ：
      </p>
      <ul>
       <li>
        配置信息：MMKV
       </li>
       <li>
        结构化数据：Room/SQLite
       </li>
       <li>
        大文件：文件系统
       </li>
       <li>
        网络数据：结合缓存策略的网络库
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        性能优化
       </strong>
       ：
      </p>
      <ul>
       <li>
        异步操作：IO操作放在后台线程
       </li>
       <li>
        批量处理：合并多次操作
       </li>
       <li>
        预加载：启动时预加载关键数据
       </li>
       <li>
        懒加载：按需加载非关键数据
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        数据同步
       </strong>
       ：
      </p>
      <ul>
       <li>
        版本控制：使用版本号管理数据更新
       </li>
       <li>
        增量同步：只同步变更数据
       </li>
       <li>
        冲突解决：设计冲突检测和解决策略
       </li>
      </ul>
     </li>
    </ol>
    <h4>
     <a id="63__758">
     </a>
     6.3 原理深度题
    </h4>
    <h5>
     <a id="Q5_ProtobufJSON_760">
     </a>
     Q5: Protobuf相比JSON有哪些优势？其序列化原理是什么？
    </h5>
    <p>
     <strong>
      答
     </strong>
     ：
    </p>
    <p>
     <strong>
      优势
     </strong>
     ：
    </p>
    <ol>
     <li>
      更小的体积：二进制格式，比JSON小2-5倍
     </li>
     <li>
      更快的解析：解析速度比JSON快5-10倍
     </li>
     <li>
      更严格的类型：强类型定义，减少运行时错误
     </li>
     <li>
      向前兼容：可以在不破坏现有应用的情况下更新数据结构
     </li>
    </ol>
    <p>
     <strong>
      序列化原理
     </strong>
     ：
    </p>
    <ol>
     <li>
      <strong>
       变长编码
      </strong>
      ：使用Varint编码，小数字占用更少字节
     </li>
     <li>
      <strong>
       标签-值对
      </strong>
      ：每个字段使用数字标签而非字符串
     </li>
     <li>
      <strong>
       紧凑布局
      </strong>
      ：省略默认值和空字段，只序列化有值的字段
     </li>
     <li>
      <strong>
       二进制格式
      </strong>
      ：直接使用二进制表示，无需文本转换
     </li>
    </ol>
    <pre><code>// Protobuf编码示例（伪代码）
field1 -&gt; tag(1) + wiretype(0) + varint(123)  // 可能只占2-3个字节
field2 -&gt; tag(2) + wiretype(2) + length(5) + "hello"  // 字符串前有长度前缀
</code></pre>
    <h5>
     <a id="Q6_MMKV_782">
     </a>
     Q6: MMKV如何保证多进程安全和崩溃恢复？
    </h5>
    <p>
     <strong>
      答
     </strong>
     ：
    </p>
    <p>
     <strong>
      多进程安全
     </strong>
     ：
    </p>
    <ol>
     <li>
      <strong>
       文件锁
      </strong>
      ：使用文件锁(FileLock)同步多进程访问
     </li>
     <li>
      <strong>
       内存屏障
      </strong>
      ：确保内存操作的可见性和顺序性
     </li>
     <li>
      <strong>
       原子操作
      </strong>
      ：关键操作保证原子性
     </li>
     <li>
      <strong>
       写时复制
      </strong>
      ：修改数据时创建副本，避免读写冲突
     </li>
    </ol>
    <p>
     <strong>
      崩溃恢复
     </strong>
     ：
    </p>
    <ol>
     <li>
      <strong>
       数据校验
      </strong>
      ：使用CRC32校验数据完整性
     </li>
     <li>
      <strong>
       日志机制
      </strong>
      ：记录操作日志，用于恢复
     </li>
     <li>
      <strong>
       备份策略
      </strong>
      ：定期创建数据快照
     </li>
     <li>
      <strong>
       增量更新
      </strong>
      ：采用追加写入方式，保留历史数据
     </li>
     <li>
      <strong>
       异步落盘
      </strong>
      ：内存操作完成后异步写入磁盘
     </li>
    </ol>
    <pre><code class="prism language-java"><span class="token comment">// MMKV崩溃恢复伪代码</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 1. 检查CRC校验</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">checkDataIntegrity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 2. 尝试从日志恢复</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasValidLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">recoverFromLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 3. 尝试从备份恢复</span>
            <span class="token function">recoverFromBackup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 4. 重建索引</span>
    <span class="token function">rebuildIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="_817">
     </a>
     七、总结
    </h3>
    <p>
     本文详细介绍了Android中的高效存储方案：Protocol Buffers和MMKV。通过对比传统存储方式的局限性，我们可以看到这两种方案在性能、稳定性和易用性上的优势。
    </p>
    <p>
     Protobuf提供了高效的序列化机制，特别适合结构化数据的存储和传输；而MMKV则通过内存映射、异步落盘等技术，为键值对存储提供了极致的性能体验。
    </p>
    <p>
     在实际应用中，我们可以根据数据特点和应用场景，选择合适的存储方案，甚至可以像案例中展示的那样，结合两者的优势，构建更高效、更可靠的数据存储系统。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f:672e6373646e2e6e65742f77616e673239353638393634392f:61727469636c652f64657461696c732f313436313836363132" class_="artid" style="display:none">
 </p>
</div>


