---
layout: post
title: "基于动手学强化学习的知识点五第-18-章-离线强化学习gym版本-0.26"
date: 2025-03-15 19:24:34 +0800
description: "第 18 章 离线强化学习（gym版本 ＞= 0.26）（一）"
keywords: "基于“动手学强化学习”的知识点（五）：第 18 章 离线强化学习（gym版本 ＞= 0.26）"
categories: ['动手学强化学习']
tags: ['强化学习']
artid: "146283913"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146283913
    alt: "基于动手学强化学习的知识点五第-18-章-离线强化学习gym版本-0.26"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146283913
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146283913
cover: https://bing.ee123.net/img/rand?artid=146283913
image: https://bing.ee123.net/img/rand?artid=146283913
img: https://bing.ee123.net/img/rand?artid=146283913
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     基于“动手学强化学习”的知识点（五）：第 18 章 离线强化学习（gym版本 ＞= 0.26）
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <p>
    </p>
    <h2>
     <a id="_2">
     </a>
     摘要
    </h2>
    <p>
     本系列知识点讲解基于
     <a href="https://hrl.boyuai.com/chapter/1/%E5%88%9D%E6%8E%A2%E5%BC%BA%E5%8C%96%E5%AD%A6%E4%B9%A0" rel="nofollow">
      动手学强化学习
     </a>
     中的内容进行详细的疑难点分析！具体内容请阅读
     <a href="https://hrl.boyuai.com/chapter/1/%E5%88%9D%E6%8E%A2%E5%BC%BA%E5%8C%96%E5%AD%A6%E4%B9%A0" rel="nofollow">
      动手学强化学习
     </a>
     ！
    </p>
    <hr/>
    <p>
     对应
     <a href="https://hrl.boyuai.com/chapter/3/%E7%A6%BB%E7%BA%BF%E5%BC%BA%E5%8C%96%E5%AD%A6%E4%B9%A0" rel="nofollow">
      动手学强化学习——离线强化学习
     </a>
    </p>
    <hr/>
    <h2>
     <a id="SAC__12">
     </a>
     SAC 算法部分
    </h2>
    <blockquote>
     <p>
      代码讲解对应
      <a href="https://blog.csdn.net/xzs1210652636/article/details/146259812">
       基于“动手学强化学习”的知识点（一）：第 14 章 SAC 算法（gym版本 ＞= 0.26）
      </a>
     </p>
    </blockquote>
    <blockquote>
     <p>
      为了生成数据集，在倒立摆环境中从零开始训练一个在线 SAC 智能体，直到算法达到收敛效果，把训练过程中智能体采集的所有轨迹保存下来作为数据集。这样，数据集中既包含训练初期较差策略的采样，又包含训练后期较好策略的采样，是一个混合数据集。下面给出生成数据集的代码，SAC 部分直接使用 14.5 节中的代码，因此不再详细解释。——
      <a href="https://hrl.boyuai.com/chapter/3/%E7%A6%BB%E7%BA%BF%E5%BC%BA%E5%8C%96%E5%AD%A6%E4%B9%A0/#184-cql-%E4%BB%A3%E7%A0%81%E5%AE%9E%E8%B7%B5" rel="nofollow">
       18.4 CQL 代码实践
      </a>
     </p>
    </blockquote>
    <pre><code class="prism language-python">
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> gym
<span class="token keyword">from</span> tqdm <span class="token keyword">import</span> tqdm
<span class="token keyword">import</span> random
<span class="token keyword">import</span> rl_utils
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>functional <span class="token keyword">as</span> F
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>distributions <span class="token keyword">import</span> Normal
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt


<span class="token comment"># 传统的SAC算法</span>
<span class="token keyword">class</span> <span class="token class-name">PolicyNetContinuous</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> state_dim<span class="token punctuation">,</span> hidden_dim<span class="token punctuation">,</span> action_dim<span class="token punctuation">,</span> action_bound<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>PolicyNetContinuous<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fc1 <span class="token operator">=</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>state_dim<span class="token punctuation">,</span> hidden_dim<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fc_mu <span class="token operator">=</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>hidden_dim<span class="token punctuation">,</span> action_dim<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fc_std <span class="token operator">=</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>hidden_dim<span class="token punctuation">,</span> action_dim<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>action_bound <span class="token operator">=</span> action_bound

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        x <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>fc1<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
        mu <span class="token operator">=</span> self<span class="token punctuation">.</span>fc_mu<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        std <span class="token operator">=</span> F<span class="token punctuation">.</span>softplus<span class="token punctuation">(</span>self<span class="token punctuation">.</span>fc_std<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
        dist <span class="token operator">=</span> Normal<span class="token punctuation">(</span>mu<span class="token punctuation">,</span> std<span class="token punctuation">)</span>
        normal_sample <span class="token operator">=</span> dist<span class="token punctuation">.</span>rsample<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># rsample()是重参数化采样</span>
        log_prob <span class="token operator">=</span> dist<span class="token punctuation">.</span>log_prob<span class="token punctuation">(</span>normal_sample<span class="token punctuation">)</span>
        action <span class="token operator">=</span> torch<span class="token punctuation">.</span>tanh<span class="token punctuation">(</span>normal_sample<span class="token punctuation">)</span>
        <span class="token comment"># 计算tanh_normal分布的对数概率密度</span>
        log_prob <span class="token operator">=</span> log_prob <span class="token operator">-</span> torch<span class="token punctuation">.</span>log<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> torch<span class="token punctuation">.</span>tanh<span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">pow</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1e-7</span><span class="token punctuation">)</span>
        action <span class="token operator">=</span> action <span class="token operator">*</span> self<span class="token punctuation">.</span>action_bound
        <span class="token keyword">return</span> action<span class="token punctuation">,</span> log_prob


<span class="token keyword">class</span> <span class="token class-name">QValueNetContinuous</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> state_dim<span class="token punctuation">,</span> hidden_dim<span class="token punctuation">,</span> action_dim<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>QValueNetContinuous<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fc1 <span class="token operator">=</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>state_dim <span class="token operator">+</span> action_dim<span class="token punctuation">,</span> hidden_dim<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fc2 <span class="token operator">=</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>hidden_dim<span class="token punctuation">,</span> hidden_dim<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fc_out <span class="token operator">=</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>hidden_dim<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">:</span>
        cat <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">,</span> a<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        x <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>fc1<span class="token punctuation">(</span>cat<span class="token punctuation">)</span><span class="token punctuation">)</span>
        x <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>fc2<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>fc_out<span class="token punctuation">(</span>x<span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">SACContinuous</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">''' 处理连续动作的SAC算法 '''</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> state_dim<span class="token punctuation">,</span> hidden_dim<span class="token punctuation">,</span> action_dim<span class="token punctuation">,</span> action_bound<span class="token punctuation">,</span>
                 actor_lr<span class="token punctuation">,</span> critic_lr<span class="token punctuation">,</span> alpha_lr<span class="token punctuation">,</span> target_entropy<span class="token punctuation">,</span> tau<span class="token punctuation">,</span> gamma<span class="token punctuation">,</span>
                 device<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>actor <span class="token operator">=</span> PolicyNetContinuous<span class="token punctuation">(</span>state_dim<span class="token punctuation">,</span> hidden_dim<span class="token punctuation">,</span> action_dim<span class="token punctuation">,</span>
                                         action_bound<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>  <span class="token comment"># 策略网络</span>
        self<span class="token punctuation">.</span>critic_1 <span class="token operator">=</span> QValueNetContinuous<span class="token punctuation">(</span>state_dim<span class="token punctuation">,</span> hidden_dim<span class="token punctuation">,</span>
                                            action_dim<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>  <span class="token comment"># 第一个Q网络</span>
        self<span class="token punctuation">.</span>critic_2 <span class="token operator">=</span> QValueNetContinuous<span class="token punctuation">(</span>state_dim<span class="token punctuation">,</span> hidden_dim<span class="token punctuation">,</span>
                                            action_dim<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>  <span class="token comment"># 第二个Q网络</span>
        self<span class="token punctuation">.</span>target_critic_1 <span class="token operator">=</span> QValueNetContinuous<span class="token punctuation">(</span>state_dim<span class="token punctuation">,</span>
                                                   hidden_dim<span class="token punctuation">,</span> action_dim<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>
                                                       device<span class="token punctuation">)</span>  <span class="token comment"># 第一个目标Q网络</span>
        self<span class="token punctuation">.</span>target_critic_2 <span class="token operator">=</span> QValueNetContinuous<span class="token punctuation">(</span>state_dim<span class="token punctuation">,</span>
                                                   hidden_dim<span class="token punctuation">,</span> action_dim<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>
                                                       device<span class="token punctuation">)</span>  <span class="token comment"># 第二个目标Q网络</span>
        <span class="token comment"># 令目标Q网络的初始参数和Q网络一样</span>
        self<span class="token punctuation">.</span>target_critic_1<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>self<span class="token punctuation">.</span>critic_1<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>target_critic_2<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>self<span class="token punctuation">.</span>critic_2<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>actor_optimizer <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>self<span class="token punctuation">.</span>actor<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                lr<span class="token operator">=</span>actor_lr<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>critic_1_optimizer <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>self<span class="token punctuation">.</span>critic_1<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                   lr<span class="token operator">=</span>critic_lr<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>critic_2_optimizer <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>self<span class="token punctuation">.</span>critic_2<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                   lr<span class="token operator">=</span>critic_lr<span class="token punctuation">)</span>
        <span class="token comment"># 使用alpha的log值,可以使训练结果比较稳定</span>
        self<span class="token punctuation">.</span>log_alpha <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>np<span class="token punctuation">.</span>log<span class="token punctuation">(</span><span class="token number">0.01</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>log_alpha<span class="token punctuation">.</span>requires_grad <span class="token operator">=</span> <span class="token boolean">True</span>  <span class="token comment">#对alpha求梯度</span>
        self<span class="token punctuation">.</span>log_alpha_optimizer <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span><span class="token punctuation">[</span>self<span class="token punctuation">.</span>log_alpha<span class="token punctuation">]</span><span class="token punctuation">,</span>
                                                    lr<span class="token operator">=</span>alpha_lr<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>target_entropy <span class="token operator">=</span> target_entropy  <span class="token comment"># 目标熵的大小</span>
        self<span class="token punctuation">.</span>gamma <span class="token operator">=</span> gamma
        self<span class="token punctuation">.</span>tau <span class="token operator">=</span> tau
        self<span class="token punctuation">.</span>device <span class="token operator">=</span> device

    <span class="token keyword">def</span> <span class="token function">take_action</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> <span class="token builtin">tuple</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            state <span class="token operator">=</span> state<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        state <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span>state<span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span>
        action <span class="token operator">=</span> self<span class="token punctuation">.</span>actor<span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span>action<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

    <span class="token keyword">def</span> <span class="token function">calc_target</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> rewards<span class="token punctuation">,</span> next_states<span class="token punctuation">,</span> dones<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 计算目标Q值</span>
        next_actions<span class="token punctuation">,</span> log_prob <span class="token operator">=</span> self<span class="token punctuation">.</span>actor<span class="token punctuation">(</span>next_states<span class="token punctuation">)</span>
        entropy <span class="token operator">=</span> <span class="token operator">-</span>log_prob
        q1_value <span class="token operator">=</span> self<span class="token punctuation">.</span>target_critic_1<span class="token punctuation">(</span>next_states<span class="token punctuation">,</span> next_actions<span class="token punctuation">)</span>
        q2_value <span class="token operator">=</span> self<span class="token punctuation">.</span>target_critic_2<span class="token punctuation">(</span>next_states<span class="token punctuation">,</span> next_actions<span class="token punctuation">)</span>
        next_value <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span>q1_value<span class="token punctuation">,</span>
                               q2_value<span class="token punctuation">)</span> <span class="token operator">+</span> self<span class="token punctuation">.</span>log_alpha<span class="token punctuation">.</span>exp<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> entropy
        td_target <span class="token operator">=</span> rewards <span class="token operator">+</span> self<span class="token punctuation">.</span>gamma <span class="token operator">*</span> next_value <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> dones<span class="token punctuation">)</span>
        <span class="token keyword">return</span> td_target

    <span class="token keyword">def</span> <span class="token function">soft_update</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> net<span class="token punctuation">,</span> target_net<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> param_target<span class="token punctuation">,</span> param <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>target_net<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                       net<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            param_target<span class="token punctuation">.</span>data<span class="token punctuation">.</span>copy_<span class="token punctuation">(</span>param_target<span class="token punctuation">.</span>data <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">-</span> self<span class="token punctuation">.</span>tau<span class="token punctuation">)</span> <span class="token operator">+</span>
                                    param<span class="token punctuation">.</span>data <span class="token operator">*</span> self<span class="token punctuation">.</span>tau<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">update</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> transition_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>
        states <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>transition_dict<span class="token punctuation">[</span><span class="token string">'states'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                              dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span>
        actions <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>transition_dict<span class="token punctuation">[</span><span class="token string">'actions'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                               dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span>
        rewards <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>transition_dict<span class="token punctuation">[</span><span class="token string">'rewards'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                               dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span>
        next_states <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>transition_dict<span class="token punctuation">[</span><span class="token string">'next_states'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                   dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span>
        dones <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>transition_dict<span class="token punctuation">[</span><span class="token string">'dones'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                             dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span>
        rewards <span class="token operator">=</span> <span class="token punctuation">(</span>rewards <span class="token operator">+</span> <span class="token number">8.0</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">8.0</span>  <span class="token comment"># 对倒立摆环境的奖励进行重塑</span>

        <span class="token comment"># 更新两个Q网络</span>
        td_target <span class="token operator">=</span> self<span class="token punctuation">.</span>calc_target<span class="token punctuation">(</span>rewards<span class="token punctuation">,</span> next_states<span class="token punctuation">,</span> dones<span class="token punctuation">)</span>
        critic_1_loss <span class="token operator">=</span> torch<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>
            F<span class="token punctuation">.</span>mse_loss<span class="token punctuation">(</span>self<span class="token punctuation">.</span>critic_1<span class="token punctuation">(</span>states<span class="token punctuation">,</span> actions<span class="token punctuation">)</span><span class="token punctuation">,</span> td_target<span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        critic_2_loss <span class="token operator">=</span> torch<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>
            F<span class="token punctuation">.</span>mse_loss<span class="token punctuation">(</span>self<span class="token punctuation">.</span>critic_2<span class="token punctuation">(</span>states<span class="token punctuation">,</span> actions<span class="token punctuation">)</span><span class="token punctuation">,</span> td_target<span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>critic_1_optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
        critic_1_loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>critic_1_optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>critic_2_optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
        critic_2_loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>critic_2_optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># 更新策略网络</span>
        new_actions<span class="token punctuation">,</span> log_prob <span class="token operator">=</span> self<span class="token punctuation">.</span>actor<span class="token punctuation">(</span>states<span class="token punctuation">)</span>
        entropy <span class="token operator">=</span> <span class="token operator">-</span>log_prob
        q1_value <span class="token operator">=</span> self<span class="token punctuation">.</span>critic_1<span class="token punctuation">(</span>states<span class="token punctuation">,</span> new_actions<span class="token punctuation">)</span>
        q2_value <span class="token operator">=</span> self<span class="token punctuation">.</span>critic_2<span class="token punctuation">(</span>states<span class="token punctuation">,</span> new_actions<span class="token punctuation">)</span>
        actor_loss <span class="token operator">=</span> torch<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token operator">-</span>self<span class="token punctuation">.</span>log_alpha<span class="token punctuation">.</span>exp<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> entropy <span class="token operator">-</span>
                                torch<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span>q1_value<span class="token punctuation">,</span> q2_value<span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>actor_optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
        actor_loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>actor_optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># 更新alpha值</span>
        alpha_loss <span class="token operator">=</span> torch<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>
            <span class="token punctuation">(</span>entropy <span class="token operator">-</span> self<span class="token punctuation">.</span>target_entropy<span class="token punctuation">)</span><span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>log_alpha<span class="token punctuation">.</span>exp<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>log_alpha_optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
        alpha_loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>log_alpha_optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>soft_update<span class="token punctuation">(</span>self<span class="token punctuation">.</span>critic_1<span class="token punctuation">,</span> self<span class="token punctuation">.</span>target_critic_1<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>soft_update<span class="token punctuation">(</span>self<span class="token punctuation">.</span>critic_2<span class="token punctuation">,</span> self<span class="token punctuation">.</span>target_critic_2<span class="token punctuation">)</span>


env_name <span class="token operator">=</span> <span class="token string">'Pendulum-v1'</span>
env <span class="token operator">=</span> gym<span class="token punctuation">.</span>make<span class="token punctuation">(</span>env_name<span class="token punctuation">)</span>
state_dim <span class="token operator">=</span> env<span class="token punctuation">.</span>observation_space<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
action_dim <span class="token operator">=</span> env<span class="token punctuation">.</span>action_space<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
action_bound <span class="token operator">=</span> env<span class="token punctuation">.</span>action_space<span class="token punctuation">.</span>high<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># 动作最大值</span>
random<span class="token punctuation">.</span>seed<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>seed<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token string">'seed'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">seed_fn</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> seed<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        env<span class="token punctuation">.</span>reset<span class="token punctuation">(</span>seed<span class="token operator">=</span>seed<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span>seed<span class="token punctuation">]</span>
    env<span class="token punctuation">.</span>seed <span class="token operator">=</span> seed_fn<span class="token punctuation">.</span>__get__<span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># env.seed(0)</span>
torch<span class="token punctuation">.</span>manual_seed<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

actor_lr <span class="token operator">=</span> <span class="token number">3e-4</span>
critic_lr <span class="token operator">=</span> <span class="token number">3e-3</span>
alpha_lr <span class="token operator">=</span> <span class="token number">3e-4</span>
num_episodes <span class="token operator">=</span> <span class="token number">100</span>
hidden_dim <span class="token operator">=</span> <span class="token number">128</span>
gamma <span class="token operator">=</span> <span class="token number">0.99</span>
tau <span class="token operator">=</span> <span class="token number">0.005</span>  <span class="token comment"># 软更新参数</span>
buffer_size <span class="token operator">=</span> <span class="token number">100000</span>
minimal_size <span class="token operator">=</span> <span class="token number">1000</span>
batch_size <span class="token operator">=</span> <span class="token number">64</span>
target_entropy <span class="token operator">=</span> <span class="token operator">-</span>env<span class="token punctuation">.</span>action_space<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
device <span class="token operator">=</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">"cuda"</span><span class="token punctuation">)</span> <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span>
    <span class="token string">"cpu"</span><span class="token punctuation">)</span>

replay_buffer <span class="token operator">=</span> rl_utils<span class="token punctuation">.</span>ReplayBuffer<span class="token punctuation">(</span>buffer_size<span class="token punctuation">)</span>
agent <span class="token operator">=</span> SACContinuous<span class="token punctuation">(</span>state_dim<span class="token punctuation">,</span> hidden_dim<span class="token punctuation">,</span> action_dim<span class="token punctuation">,</span> action_bound<span class="token punctuation">,</span>
                      actor_lr<span class="token punctuation">,</span> critic_lr<span class="token punctuation">,</span> alpha_lr<span class="token punctuation">,</span> target_entropy<span class="token punctuation">,</span> tau<span class="token punctuation">,</span>
                      gamma<span class="token punctuation">,</span> device<span class="token punctuation">)</span>

return_list <span class="token operator">=</span> rl_utils<span class="token punctuation">.</span>train_off_policy_agent<span class="token punctuation">(</span>env<span class="token punctuation">,</span> agent<span class="token punctuation">,</span> num_episodes<span class="token punctuation">,</span>
                                              replay_buffer<span class="token punctuation">,</span> minimal_size<span class="token punctuation">,</span>
                                              batch_size<span class="token punctuation">)</span>

episodes_list <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>return_list<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>episodes_list<span class="token punctuation">,</span> return_list<span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">'Episodes'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">'Returns'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'SAC on {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>env_name<span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
    <br/>
    <h2>
     <a id="CQL__228">
     </a>
     CQL 算法
    </h2>
    <h3>
     <a id="CQL__229">
     </a>
     CQL 总结与大函数意义
    </h3>
    <p>
     <strong>
      CQL（Conservative Q-Learning）
     </strong>
     类的整体设计在 SAC 算法基础上增加了保守性正则项，用于减少 Q 函数过估计，改善离线 RL 表现。
    </p>
    <ul>
     <li>
      <p>
       <strong>
        构造函数
       </strong>
      </p>
      <ul>
       <li>
        <strong>
         意义
        </strong>
        ：初始化 SAC 中的 actor、critic（两个及对应目标网络）、以及温度参数和优化器，并传入 CQL 特有的超参数 beta（正则系数）和 num_random（动作采样数）。
       </li>
       <li>
        <strong>
         输入
        </strong>
        ：状态、动作维度、各个学习率、目标熵、tau、gamma、设备、beta、num_random。
       </li>
       <li>
        <strong>
         输出
        </strong>
        ：构造好的 CQL 实例，准备进行更新。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        take_action
       </strong>
      </p>
      <ul>
       <li>
        <strong>
         意义
        </strong>
        ：给定状态，利用 actor 网络采样动作，用于与环境交互。
       </li>
       <li>
        <strong>
         输入
        </strong>
        ：单个状态（例如 [0.1, 0.2, -0.1]）。
       </li>
       <li>
        <strong>
         输出
        </strong>
        ：对应动作（例如 [0.8]）。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        soft_update
       </strong>
      </p>
      <ul>
       <li>
        <strong>
         意义
        </strong>
        ：平滑更新目标 Q 网络参数，保证训练稳定性。
       </li>
       <li>
        <strong>
         输入
        </strong>
        ：当前 Q 网络和对应目标网络。
       </li>
       <li>
        <strong>
         输出
        </strong>
        ：目标网络参数更新为旧值与当前值的线性组合。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        update
       </strong>
      </p>
      <ul>
       <li>
        <strong>
         意义
        </strong>
        ：使用一批真实环境转移数据更新 actor、critic 网络和温度参数 (\alpha)，同时在 SAC 基础上加入 CQL 正则项
        <br/>
        <span class="katex--display">
         <span class="katex-display">
          <span class="katex">
           <span class="katex-mathml">
            L 
             
            
              CQL 
             
            
           
             = 
            
            
            
              L 
             
            
              critic 
             
            
           
             + 
            
           
             β 
            
           
             ( 
            
           
             log 
            
           
             ⁡ 
            
           
             ∑ 
            
           
             exp 
            
           
             ⁡ 
            
           
             ( 
            
           
             Q 
            
           
             ( 
            
           
             s 
            
           
             , 
            
            
            
              a 
             
            
              ′ 
             
            
           
             ) 
            
           
             − 
            
           
             log 
            
           
             ⁡ 
            
            
            
              π 
             
            
              ref 
             
            
           
             ( 
            
            
            
              a 
             
            
              ′ 
             
            
           
             ) 
            
           
             ) 
            
           
             − 
            
            
            
              E 
             
             
             
               ( 
              
             
               s 
              
             
               , 
              
             
               a 
              
             
               ) 
              
             
               ∼ 
              
             
               D 
              
             
            
           
             [ 
            
           
             Q 
            
           
             ( 
            
           
             s 
            
           
             , 
            
           
             a 
            
           
             ) 
            
           
             ] 
            
           
             ) 
            
           
          
            L_{\text{CQL}} = L_{\text{critic}} + \beta \Big(\log\sum \exp(Q(s,a') - \log \pi_{\text{ref}}(a')) - \mathbb{E}_{(s,a) \sim D}[Q(s,a)]\Big)
           </span>
           <span class="katex-html">
            <span class="base">
             <span class="strut" style="height: 0.9694em; vertical-align: -0.2861em;">
             </span>
             <span class="mord">
              <span class="mord mathnormal">
               L
              </span>
              <span class="msupsub">
               <span class="vlist-t vlist-t2">
                <span class="vlist-r">
                 <span class="vlist" style="height: 0.3283em;">
                  <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                   <span class="pstrut" style="height: 2.7em;">
                   </span>
                   <span class="sizing reset-size6 size3 mtight">
                    <span class="mord mtight">
                     <span class="mord text mtight">
                      <span class="mord mtight">
                       CQL
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                 <span class="vlist-s">
                  ​
                 </span>
                </span>
                <span class="vlist-r">
                 <span class="vlist" style="height: 0.2861em;">
                  <span class="">
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="mspace" style="margin-right: 0.2778em;">
             </span>
             <span class="mrel">
              =
             </span>
             <span class="mspace" style="margin-right: 0.2778em;">
             </span>
            </span>
            <span class="base">
             <span class="strut" style="height: 0.8333em; vertical-align: -0.15em;">
             </span>
             <span class="mord">
              <span class="mord mathnormal">
               L
              </span>
              <span class="msupsub">
               <span class="vlist-t vlist-t2">
                <span class="vlist-r">
                 <span class="vlist" style="height: 0.3175em;">
                  <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                   <span class="pstrut" style="height: 2.7em;">
                   </span>
                   <span class="sizing reset-size6 size3 mtight">
                    <span class="mord mtight">
                     <span class="mord text mtight">
                      <span class="mord mtight">
                       critic
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                 <span class="vlist-s">
                  ​
                 </span>
                </span>
                <span class="vlist-r">
                 <span class="vlist" style="height: 0.15em;">
                  <span class="">
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="mspace" style="margin-right: 0.2222em;">
             </span>
             <span class="mbin">
              +
             </span>
             <span class="mspace" style="margin-right: 0.2222em;">
             </span>
            </span>
            <span class="base">
             <span class="strut" style="height: 1.8em; vertical-align: -0.65em;">
             </span>
             <span class="mord mathnormal" style="margin-right: 0.0528em;">
              β
             </span>
             <span class="mord">
              <span class="delimsizing size2">
               (
              </span>
             </span>
             <span class="mspace" style="margin-right: 0.1667em;">
             </span>
             <span class="mop">
              lo
              <span style="margin-right: 0.0139em;">
               g
              </span>
             </span>
             <span class="mspace" style="margin-right: 0.1667em;">
             </span>
             <span class="mop op-symbol large-op" style="position: relative; top: 0em;">
              ∑
             </span>
             <span class="mspace" style="margin-right: 0.1667em;">
             </span>
             <span class="mop">
              exp
             </span>
             <span class="mopen">
              (
             </span>
             <span class="mord mathnormal">
              Q
             </span>
             <span class="mopen">
              (
             </span>
             <span class="mord mathnormal">
              s
             </span>
             <span class="mpunct">
              ,
             </span>
             <span class="mspace" style="margin-right: 0.1667em;">
             </span>
             <span class="mord">
              <span class="mord mathnormal">
               a
              </span>
              <span class="msupsub">
               <span class="vlist-t">
                <span class="vlist-r">
                 <span class="vlist" style="height: 0.8019em;">
                  <span class="" style="top: -3.113em; margin-right: 0.05em;">
                   <span class="pstrut" style="height: 2.7em;">
                   </span>
                   <span class="sizing reset-size6 size3 mtight">
                    <span class="mord mtight">
                     <span class="mord mtight">
                      ′
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="mclose">
              )
             </span>
             <span class="mspace" style="margin-right: 0.2222em;">
             </span>
             <span class="mbin">
              −
             </span>
             <span class="mspace" style="margin-right: 0.2222em;">
             </span>
            </span>
            <span class="base">
             <span class="strut" style="height: 1.0519em; vertical-align: -0.25em;">
             </span>
             <span class="mop">
              lo
              <span style="margin-right: 0.0139em;">
               g
              </span>
             </span>
             <span class="mspace" style="margin-right: 0.1667em;">
             </span>
             <span class="mord">
              <span class="mord mathnormal" style="margin-right: 0.0359em;">
               π
              </span>
              <span class="msupsub">
               <span class="vlist-t vlist-t2">
                <span class="vlist-r">
                 <span class="vlist" style="height: 0.3361em;">
                  <span class="" style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;">
                   <span class="pstrut" style="height: 2.7em;">
                   </span>
                   <span class="sizing reset-size6 size3 mtight">
                    <span class="mord mtight">
                     <span class="mord text mtight">
                      <span class="mord mtight">
                       ref
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                 <span class="vlist-s">
                  ​
                 </span>
                </span>
                <span class="vlist-r">
                 <span class="vlist" style="height: 0.15em;">
                  <span class="">
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="mopen">
              (
             </span>
             <span class="mord">
              <span class="mord mathnormal">
               a
              </span>
              <span class="msupsub">
               <span class="vlist-t">
                <span class="vlist-r">
                 <span class="vlist" style="height: 0.8019em;">
                  <span class="" style="top: -3.113em; margin-right: 0.05em;">
                   <span class="pstrut" style="height: 2.7em;">
                   </span>
                   <span class="sizing reset-size6 size3 mtight">
                    <span class="mord mtight">
                     <span class="mord mtight">
                      ′
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="mclose">
              ))
             </span>
             <span class="mspace" style="margin-right: 0.2222em;">
             </span>
             <span class="mbin">
              −
             </span>
             <span class="mspace" style="margin-right: 0.2222em;">
             </span>
            </span>
            <span class="base">
             <span class="strut" style="height: 1.8em; vertical-align: -0.65em;">
             </span>
             <span class="mord">
              <span class="mord mathbb">
               E
              </span>
              <span class="msupsub">
               <span class="vlist-t vlist-t2">
                <span class="vlist-r">
                 <span class="vlist" style="height: 0.3448em;">
                  <span class="" style="top: -2.5198em; margin-left: 0em; margin-right: 0.05em;">
                   <span class="pstrut" style="height: 2.7em;">
                   </span>
                   <span class="sizing reset-size6 size3 mtight">
                    <span class="mord mtight">
                     <span class="mopen mtight">
                      (
                     </span>
                     <span class="mord mathnormal mtight">
                      s
                     </span>
                     <span class="mpunct mtight">
                      ,
                     </span>
                     <span class="mord mathnormal mtight">
                      a
                     </span>
                     <span class="mclose mtight">
                      )
                     </span>
                     <span class="mrel mtight">
                      ∼
                     </span>
                     <span class="mord mathnormal mtight" style="margin-right: 0.0278em;">
                      D
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                 <span class="vlist-s">
                  ​
                 </span>
                </span>
                <span class="vlist-r">
                 <span class="vlist" style="height: 0.3552em;">
                  <span class="">
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="mopen">
              [
             </span>
             <span class="mord mathnormal">
              Q
             </span>
             <span class="mopen">
              (
             </span>
             <span class="mord mathnormal">
              s
             </span>
             <span class="mpunct">
              ,
             </span>
             <span class="mspace" style="margin-right: 0.1667em;">
             </span>
             <span class="mord mathnormal">
              a
             </span>
             <span class="mclose">
              )]
             </span>
             <span class="mord">
              <span class="delimsizing size2">
               )
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
        <br/>
        其中通过对随机动作、策略动作和下一动作进行采样，计算 logsumexp 的项。
       </li>
       <li>
        <strong>
         步骤
        </strong>
        ：
        <ol>
         <li>
          计算 TD 目标
          <span class="katex--inline">
           <span class="katex">
            <span class="katex-mathml">
             y 
             
            
              = 
             
            
              r 
             
            
              + 
             
            
              γ 
             
            
              ( 
             
            
              min 
             
            
              ⁡ 
             
            
              ( 
             
             
             
               Q 
              
             
               1 
              
             
               ′ 
              
             
            
              , 
             
             
             
               Q 
              
             
               2 
              
             
               ′ 
              
             
            
              ) 
             
            
              + 
             
            
              α 
             
            
              ⋅ 
             
            
              entropy 
             
            
              ) 
             
            
           
             y = r + \gamma ( \min(Q_1', Q_2') + \alpha \cdot \text{entropy})
            </span>
            <span class="katex-html">
             <span class="base">
              <span class="strut" style="height: 0.625em; vertical-align: -0.1944em;">
              </span>
              <span class="mord mathnormal" style="margin-right: 0.0359em;">
               y
              </span>
              <span class="mspace" style="margin-right: 0.2778em;">
              </span>
              <span class="mrel">
               =
              </span>
              <span class="mspace" style="margin-right: 0.2778em;">
              </span>
             </span>
             <span class="base">
              <span class="strut" style="height: 0.6667em; vertical-align: -0.0833em;">
              </span>
              <span class="mord mathnormal" style="margin-right: 0.0278em;">
               r
              </span>
              <span class="mspace" style="margin-right: 0.2222em;">
              </span>
              <span class="mbin">
               +
              </span>
              <span class="mspace" style="margin-right: 0.2222em;">
              </span>
             </span>
             <span class="base">
              <span class="strut" style="height: 1.0019em; vertical-align: -0.25em;">
              </span>
              <span class="mord mathnormal" style="margin-right: 0.0556em;">
               γ
              </span>
              <span class="mopen">
               (
              </span>
              <span class="mop">
               min
              </span>
              <span class="mopen">
               (
              </span>
              <span class="mord">
               <span class="mord mathnormal">
                Q
               </span>
               <span class="msupsub">
                <span class="vlist-t vlist-t2">
                 <span class="vlist-r">
                  <span class="vlist" style="height: 0.7519em;">
                   <span class="" style="top: -2.4519em; margin-left: 0em; margin-right: 0.05em;">
                    <span class="pstrut" style="height: 2.7em;">
                    </span>
                    <span class="sizing reset-size6 size3 mtight">
                     <span class="mord mtight">
                      1
                     </span>
                    </span>
                   </span>
                   <span class="" style="top: -3.063em; margin-right: 0.05em;">
                    <span class="pstrut" style="height: 2.7em;">
                    </span>
                    <span class="sizing reset-size6 size3 mtight">
                     <span class="mord mtight">
                      <span class="mord mtight">
                       ′
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                  <span class="vlist-s">
                   ​
                  </span>
                 </span>
                 <span class="vlist-r">
                  <span class="vlist" style="height: 0.2481em;">
                   <span class="">
                   </span>
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="mpunct">
               ,
              </span>
              <span class="mspace" style="margin-right: 0.1667em;">
              </span>
              <span class="mord">
               <span class="mord mathnormal">
                Q
               </span>
               <span class="msupsub">
                <span class="vlist-t vlist-t2">
                 <span class="vlist-r">
                  <span class="vlist" style="height: 0.7519em;">
                   <span class="" style="top: -2.4519em; margin-left: 0em; margin-right: 0.05em;">
                    <span class="pstrut" style="height: 2.7em;">
                    </span>
                    <span class="sizing reset-size6 size3 mtight">
                     <span class="mord mtight">
                      2
                     </span>
                    </span>
                   </span>
                   <span class="" style="top: -3.063em; margin-right: 0.05em;">
                    <span class="pstrut" style="height: 2.7em;">
                    </span>
                    <span class="sizing reset-size6 size3 mtight">
                     <span class="mord mtight">
                      <span class="mord mtight">
                       ′
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                  <span class="vlist-s">
                   ​
                  </span>
                 </span>
                 <span class="vlist-r">
                  <span class="vlist" style="height: 0.2481em;">
                   <span class="">
                   </span>
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="mclose">
               )
              </span>
              <span class="mspace" style="margin-right: 0.2222em;">
              </span>
              <span class="mbin">
               +
              </span>
              <span class="mspace" style="margin-right: 0.2222em;">
              </span>
             </span>
             <span class="base">
              <span class="strut" style="height: 0.4445em;">
              </span>
              <span class="mord mathnormal" style="margin-right: 0.0037em;">
               α
              </span>
              <span class="mspace" style="margin-right: 0.2222em;">
              </span>
              <span class="mbin">
               ⋅
              </span>
              <span class="mspace" style="margin-right: 0.2222em;">
              </span>
             </span>
             <span class="base">
              <span class="strut" style="height: 1em; vertical-align: -0.25em;">
              </span>
              <span class="mord text">
               <span class="mord">
                entropy
               </span>
              </span>
              <span class="mclose">
               )
              </span>
             </span>
            </span>
           </span>
          </span>
          。
         </li>
         <li>
          分别计算 critic_1_loss 与 critic_2_loss（均方误差损失）。
         </li>
         <li>
          额外采样一批随机动作（均匀分布），以及策略生成的当前和下一动作，对各个 Q 网络的输出进行 logsumexp 操作，形成 CQL 正则项；
         </li>
         <li>
          总的 critic 损失 = SAC critic loss +
          <span class="katex--inline">
           <span class="katex">
            <span class="katex-mathml">
             β 
             
            
           
             \beta
            </span>
            <span class="katex-html">
             <span class="base">
              <span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;">
              </span>
              <span class="mord mathnormal" style="margin-right: 0.0528em;">
               β
              </span>
             </span>
            </span>
           </span>
          </span>
          ×(CQL 正则项差值)。
         </li>
         <li>
          分别更新 critic_1 与 critic_2；
         </li>
         <li>
          更新 actor，使其最大化
          <span class="katex--inline">
           <span class="katex">
            <span class="katex-mathml">
             min 
             
            
              ⁡ 
             
            
              ( 
             
             
             
               Q 
              
             
               1 
              
             
            
              , 
             
             
             
               Q 
              
             
               2 
              
             
            
              ) 
             
            
              − 
             
            
              α 
             
            
              log 
             
            
              ⁡ 
             
            
              π 
             
            
              ( 
             
            
              a 
             
            
              ∣ 
             
            
              s 
             
            
              ) 
             
            
           
             \min(Q_1, Q_2) - \alpha \log\pi(a|s)
            </span>
            <span class="katex-html">
             <span class="base">
              <span class="strut" style="height: 1em; vertical-align: -0.25em;">
              </span>
              <span class="mop">
               min
              </span>
              <span class="mopen">
               (
              </span>
              <span class="mord">
               <span class="mord mathnormal">
                Q
               </span>
               <span class="msupsub">
                <span class="vlist-t vlist-t2">
                 <span class="vlist-r">
                  <span class="vlist" style="height: 0.3011em;">
                   <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                    <span class="pstrut" style="height: 2.7em;">
                    </span>
                    <span class="sizing reset-size6 size3 mtight">
                     <span class="mord mtight">
                      1
                     </span>
                    </span>
                   </span>
                  </span>
                  <span class="vlist-s">
                   ​
                  </span>
                 </span>
                 <span class="vlist-r">
                  <span class="vlist" style="height: 0.15em;">
                   <span class="">
                   </span>
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="mpunct">
               ,
              </span>
              <span class="mspace" style="margin-right: 0.1667em;">
              </span>
              <span class="mord">
               <span class="mord mathnormal">
                Q
               </span>
               <span class="msupsub">
                <span class="vlist-t vlist-t2">
                 <span class="vlist-r">
                  <span class="vlist" style="height: 0.3011em;">
                   <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                    <span class="pstrut" style="height: 2.7em;">
                    </span>
                    <span class="sizing reset-size6 size3 mtight">
                     <span class="mord mtight">
                      2
                     </span>
                    </span>
                   </span>
                  </span>
                  <span class="vlist-s">
                   ​
                  </span>
                 </span>
                 <span class="vlist-r">
                  <span class="vlist" style="height: 0.15em;">
                   <span class="">
                   </span>
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="mclose">
               )
              </span>
              <span class="mspace" style="margin-right: 0.2222em;">
              </span>
              <span class="mbin">
               −
              </span>
              <span class="mspace" style="margin-right: 0.2222em;">
              </span>
             </span>
             <span class="base">
              <span class="strut" style="height: 1em; vertical-align: -0.25em;">
              </span>
              <span class="mord mathnormal" style="margin-right: 0.0037em;">
               α
              </span>
              <span class="mspace" style="margin-right: 0.1667em;">
              </span>
              <span class="mop">
               lo
               <span style="margin-right: 0.0139em;">
                g
               </span>
              </span>
              <span class="mspace" style="margin-right: 0.1667em;">
              </span>
              <span class="mord mathnormal" style="margin-right: 0.0359em;">
               π
              </span>
              <span class="mopen">
               (
              </span>
              <span class="mord mathnormal">
               a
              </span>
              <span class="mord">
               ∣
              </span>
              <span class="mord mathnormal">
               s
              </span>
              <span class="mclose">
               )
              </span>
             </span>
            </span>
           </span>
          </span>
          ；
         </li>
         <li>
          更新
          <span class="katex--inline">
           <span class="katex">
            <span class="katex-mathml">
             α 
             
            
           
             \alpha
            </span>
            <span class="katex-html">
             <span class="base">
              <span class="strut" style="height: 0.4306em;">
              </span>
              <span class="mord mathnormal" style="margin-right: 0.0037em;">
               α
              </span>
             </span>
            </span>
           </span>
          </span>
          使策略熵接近目标熵；
         </li>
         <li>
          最后对目标网络进行软更新。
         </li>
        </ol>
       </li>
       <li>
        <strong>
         输入
        </strong>
        ：
        <ul>
         <li>
          transition_dict 包含 ‘states’, ‘actions’, ‘rewards’, ‘next_states’, ‘dones’。
         </li>
        </ul>
       </li>
       <li>
        <strong>
         输出
        </strong>
        ：
        <ul>
         <li>
          模型参数更新后，策略和 Q 网络得到改进。
         </li>
        </ul>
       </li>
      </ul>
     </li>
    </ul>
    <hr/>
    <h3>
     <a id="CQL__272">
     </a>
     CQL 总结
    </h3>
    <p>
     <strong>
      CQL
     </strong>
     类在 SAC 框架下增加了保守性正则项，以降低 Q 函数对未见动作过高的估计，从而实现更为保守的 Q 学习。主要流程包括：
    </p>
    <ul>
     <li>
      <strong>
       网络初始化
      </strong>
      ：构造策略网络、两个 Q 网络、对应目标网络，温度参数 (\alpha) 及其优化器，以及 SAC 固有参数（gamma、tau、目标熵）和 CQL 超参数（beta、num_random）。
     </li>
     <li>
      <strong>
       动作采样
      </strong>
      （take_action）：给定状态通过 actor 网络采样动作。
     </li>
     <li>
      <strong>
       软更新
      </strong>
      （soft_update）：平滑更新目标网络参数。
     </li>
     <li>
      <strong>
       更新过程
      </strong>
      （update）：
      <ol>
       <li>
        从 transition_dict 中读取数据并转换为张量；
       </li>
       <li>
        计算 SAC 的 TD 目标和 critic 损失；
       </li>
       <li>
        额外采样随机动作及策略动作，并计算 CQL 正则项（通过 logsumexp）；
       </li>
       <li>
        总的 critic 损失 = SAC critic loss + beta*(正则项差值)；
       </li>
       <li>
        更新 critic 网络、策略网络及温度参数 (\alpha)；
       </li>
       <li>
        最后软更新目标网络参数。
       </li>
      </ol>
     </li>
    </ul>
    <hr/>
    <h3>
     <a id="CQL__289">
     </a>
     CQL 类详细分析
    </h3>
    <pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">CQL</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">''' CQL算法 '''</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> state_dim<span class="token punctuation">,</span> hidden_dim<span class="token punctuation">,</span> action_dim<span class="token punctuation">,</span> action_bound<span class="token punctuation">,</span>
                 actor_lr<span class="token punctuation">,</span> critic_lr<span class="token punctuation">,</span> alpha_lr<span class="token punctuation">,</span> target_entropy<span class="token punctuation">,</span> tau<span class="token punctuation">,</span> gamma<span class="token punctuation">,</span>
                 device<span class="token punctuation">,</span> beta<span class="token punctuation">,</span> num_random<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        定义 CQL 类构造函数，接收状态、隐藏、动作维度、动作范围，
        以及各优化器学习率、目标熵、tau、gamma、
        设备、CQL正则系数 beta 和随机采样数 num_random。
        """</span>
        <span class="token triple-quoted-string string">'''创建策略网络（actor），用于输出动作分布并采样连续动作。'''</span>
        self<span class="token punctuation">.</span>actor <span class="token operator">=</span> PolicyNetContinuous<span class="token punctuation">(</span>state_dim<span class="token punctuation">,</span> hidden_dim<span class="token punctuation">,</span> action_dim<span class="token punctuation">,</span> action_bound<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
        <span class="token triple-quoted-string string">'''创建两个 Q 网络，分别用于评估 (state,action) 对的价值，帮助降低过估计偏差。'''</span>
        self<span class="token punctuation">.</span>critic_1 <span class="token operator">=</span> QValueNetContinuous<span class="token punctuation">(</span>state_dim<span class="token punctuation">,</span> hidden_dim<span class="token punctuation">,</span> action_dim<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>critic_2 <span class="token operator">=</span> QValueNetContinuous<span class="token punctuation">(</span>state_dim<span class="token punctuation">,</span> hidden_dim<span class="token punctuation">,</span> action_dim<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
        <span class="token triple-quoted-string string">'''创建目标 Q 网络，用于计算 TD 目标，使得训练更稳定。'''</span>
        self<span class="token punctuation">.</span>target_critic_1 <span class="token operator">=</span> QValueNetContinuous<span class="token punctuation">(</span>state_dim<span class="token punctuation">,</span> hidden_dim<span class="token punctuation">,</span> action_dim<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>target_critic_2 <span class="token operator">=</span> QValueNetContinuous<span class="token punctuation">(</span>state_dim<span class="token punctuation">,</span> hidden_dim<span class="token punctuation">,</span> action_dim<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
        <span class="token triple-quoted-string string">'''复制 critic 网络参数到目标网络，保证初始时一致。'''</span>
        self<span class="token punctuation">.</span>target_critic_1<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>self<span class="token punctuation">.</span>critic_1<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>target_critic_2<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>self<span class="token punctuation">.</span>critic_2<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token triple-quoted-string string">'''为策略网络分配 Adam 优化器，学习率 actor_lr。'''</span>
        self<span class="token punctuation">.</span>actor_optimizer <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>self<span class="token punctuation">.</span>actor<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span>actor_lr<span class="token punctuation">)</span>
        <span class="token triple-quoted-string string">'''分别为两个 Q 网络创建 Adam 优化器。'''</span>
        self<span class="token punctuation">.</span>critic_1_optimizer <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>self<span class="token punctuation">.</span>critic_1<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span>critic_lr<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>critic_2_optimizer <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>self<span class="token punctuation">.</span>critic_2<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span>critic_lr<span class="token punctuation">)</span>
        <span class="token triple-quoted-string string">'''初始化温度参数的对数，log_alpha = log(0.01) ≈ -4.6052。'''</span>
        self<span class="token punctuation">.</span>log_alpha <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>np<span class="token punctuation">.</span>log<span class="token punctuation">(</span><span class="token number">0.01</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">)</span>
        <span class="token triple-quoted-string string">'''使 log_alpha 可求梯度，从而在训练过程中自动调整 alpha=exp({log_alpha})。'''</span>
        self<span class="token punctuation">.</span>log_alpha<span class="token punctuation">.</span>requires_grad <span class="token operator">=</span> <span class="token boolean">True</span>  <span class="token comment">#对alpha求梯度</span>
        <span class="token triple-quoted-string string">'''为 log_alpha 创建 Adam 优化器，学习率 alpha_lr。'''</span>
        self<span class="token punctuation">.</span>log_alpha_optimizer <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span><span class="token punctuation">[</span>self<span class="token punctuation">.</span>log_alpha<span class="token punctuation">]</span><span class="token punctuation">,</span> lr<span class="token operator">=</span>alpha_lr<span class="token punctuation">)</span>
        <span class="token triple-quoted-string string">'''保存目标熵，用于温度调整。'''</span>
        self<span class="token punctuation">.</span>target_entropy <span class="token operator">=</span> target_entropy  <span class="token comment"># 目标熵的大小</span>
        <span class="token triple-quoted-string string">'''保存折扣因子 gamma。'''</span>
        self<span class="token punctuation">.</span>gamma <span class="token operator">=</span> gamma
        <span class="token triple-quoted-string string">'''保存软更新系数 tau，用于目标网络更新。'''</span>
        self<span class="token punctuation">.</span>tau <span class="token operator">=</span> tau
        <span class="token triple-quoted-string string">'''保存 CQL 损失函数中的系数 beta，用于权衡 Q 网络额外正则项。'''</span>
        self<span class="token punctuation">.</span>beta <span class="token operator">=</span> beta  <span class="token comment"># CQL损失函数中的系数</span>
        <span class="token triple-quoted-string string">'''保存 CQL 中在计算正则项时所采样的随机动作数，用于估计动作分布上界。'''</span>
        self<span class="token punctuation">.</span>num_random <span class="token operator">=</span> num_random  <span class="token comment"># CQL中的动作采样数</span>

    <span class="token keyword">def</span> <span class="token function">take_action</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""定义策略执行接口，给定单个状态，输出对应动作。"""</span>
        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> <span class="token builtin">tuple</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            state <span class="token operator">=</span> state<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        state <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span>state<span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
        <span class="token comment"># action = self.actor(state)[0]</span>
        <span class="token comment"># log_prob = self.actor(state)[1]</span>
        action<span class="token punctuation">,</span> log_prob <span class="token operator">=</span> self<span class="token punctuation">.</span>actor<span class="token punctuation">(</span>state<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span>action<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

    <span class="token keyword">def</span> <span class="token function">soft_update</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> net<span class="token punctuation">,</span> target_net<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""对目标网络进行软更新，即用当前网络参数更新目标网络参数。"""</span>
        <span class="token keyword">for</span> param_target<span class="token punctuation">,</span> param <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>target_net<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> net<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            param_target<span class="token punctuation">.</span>data<span class="token punctuation">.</span>copy_<span class="token punctuation">(</span>param_target<span class="token punctuation">.</span>data <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">-</span> self<span class="token punctuation">.</span>tau<span class="token punctuation">)</span> <span class="token operator">+</span> param<span class="token punctuation">.</span>data <span class="token operator">*</span> self<span class="token punctuation">.</span>tau<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">update</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> transition_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        定义策略与 Q 网络的更新过程，使用从环境采集的经验数据更新所有网络参数，同时计算 CQL 的额外正则项。
        """</span>
        <span class="token triple-quoted-string string">'''从transition_dict中提取数据'''</span>
        states <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>transition_dict<span class="token punctuation">[</span><span class="token string">'states'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
        actions <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>transition_dict<span class="token punctuation">[</span><span class="token string">'actions'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
        rewards <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>transition_dict<span class="token punctuation">[</span><span class="token string">'rewards'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
        next_states <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>transition_dict<span class="token punctuation">[</span><span class="token string">'next_states'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
        dones <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>transition_dict<span class="token punctuation">[</span><span class="token string">'dones'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
        <span class="token triple-quoted-string string">'''对奖励进行归一化处理，这里将倒立摆环境的奖励平移与缩放，使得奖励范围更加稳定。'''</span>
        rewards <span class="token operator">=</span> <span class="token punctuation">(</span>rewards <span class="token operator">+</span> <span class="token number">8.0</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">8.0</span>  <span class="token comment"># 对倒立摆环境的奖励进行重塑</span>
        <span class="token triple-quoted-string string">'''对所有下一状态通过 actor 得到下一动作及其对数概率。'''</span>
        next_actions<span class="token punctuation">,</span> log_prob <span class="token operator">=</span> self<span class="token punctuation">.</span>actor<span class="token punctuation">(</span>next_states<span class="token punctuation">)</span>
        <span class="token triple-quoted-string string">'''计算熵项，即熵 = - log_prob。'''</span>
        entropy <span class="token operator">=</span> <span class="token operator">-</span>log_prob
        <span class="token triple-quoted-string string">'''用目标 Q 网络计算下一状态下的 Q 值估计。'''</span>
        q1_value <span class="token operator">=</span> self<span class="token punctuation">.</span>target_critic_1<span class="token punctuation">(</span>next_states<span class="token punctuation">,</span> next_actions<span class="token punctuation">)</span>
        q2_value <span class="token operator">=</span> self<span class="token punctuation">.</span>target_critic_2<span class="token punctuation">(</span>next_states<span class="token punctuation">,</span> next_actions<span class="token punctuation">)</span>
        <span class="token triple-quoted-string string">'''计算下一时刻的价值估计，选择较小的 Q 值（双 Q 机制），并加入熵正则项 α⋅entropy。'''</span>
        next_value <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span>q1_value<span class="token punctuation">,</span> q2_value<span class="token punctuation">)</span> <span class="token operator">+</span> self<span class="token punctuation">.</span>log_alpha<span class="token punctuation">.</span>exp<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> entropy
        <span class="token triple-quoted-string string">'''
        计算 TD 目标，若 done 为 1（终止状态）则不加折扣。
        td_target = 当前的即时奖励 + gamma*下一阶段的奖励
        '''</span>
        td_target <span class="token operator">=</span> rewards <span class="token operator">+</span> self<span class="token punctuation">.</span>gamma <span class="token operator">*</span> next_value <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> dones<span class="token punctuation">)</span>
        <span class="token triple-quoted-string string">'''
        分别计算两个 Q 网络的均方误差（MSE）损失，相对于 td_target（detach防止梯度流向目标）。
        '''</span>
        critic_1_loss <span class="token operator">=</span> torch<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>F<span class="token punctuation">.</span>mse_loss<span class="token punctuation">(</span>self<span class="token punctuation">.</span>critic_1<span class="token punctuation">(</span>states<span class="token punctuation">,</span> actions<span class="token punctuation">)</span><span class="token punctuation">,</span> td_target<span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        critic_2_loss <span class="token operator">=</span> torch<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>F<span class="token punctuation">.</span>mse_loss<span class="token punctuation">(</span>self<span class="token punctuation">.</span>critic_2<span class="token punctuation">(</span>states<span class="token punctuation">,</span> actions<span class="token punctuation">)</span><span class="token punctuation">,</span> td_target<span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment"># 以上与SAC相同,以下Q网络更新是CQL的额外部分</span>
        <span class="token triple-quoted-string string">'''取当前批次样本数量。'''</span>
        batch_size <span class="token operator">=</span> states<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token triple-quoted-string string">'''
        作用：
        - 生成一组随机均匀分布的动作，形状为 (batch_size*num_random, action_dim)，范围在 [-1,1]。
        - 用于 CQL 正则项计算，作为额外的动作样本。
        数值例子：
        - 若 batch_size=64, num_random=10, action_dim=1，则生成形状为 (640,1) 的随机动作，
          如 [[0.23], [-0.45], …]。
        '''</span>
        random_unif_actions <span class="token operator">=</span> torch<span class="token punctuation">.</span>rand<span class="token punctuation">(</span><span class="token punctuation">[</span>batch_size <span class="token operator">*</span> self<span class="token punctuation">.</span>num_random<span class="token punctuation">,</span> actions<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">.</span>uniform_<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
        <span class="token triple-quoted-string string">'''
        作用：
        计算均匀分布的对数概率密度。
        - 由于在连续区间 [−1,1] 中，均匀密度为 1/2 对于每个动作维度，因此对数概率为 log(0.5)；
        - 对于 action_dim 个维度，总和为 log(0.5^action_dim)。
        '''</span>
        random_unif_log_pi <span class="token operator">=</span> np<span class="token punctuation">.</span>log<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token operator">**</span>next_actions<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment"># random_unif_log_pi = np.log(0.5) * next_actions.shape[-1]</span>
        <span class="token triple-quoted-string string">'''
        作用：增加数据集
        - 将 states 增加一个新维度，重复 num_random 次，使得每个样本重复 num_random 次，
          最后 reshape 成 (batch_size*num_random, state_dim)。
        数值例子：
        - 若 states shape=(64,3), 
          unsqueeze后变为 (64,1,3), 
          repeat 后变为 (64,10,3), view 后为 (640,3).
        '''</span>
        tmp_states <span class="token operator">=</span> states<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>repeat<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>num_random<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> states<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        tmp_next_states <span class="token operator">=</span> next_states<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>repeat<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>num_random<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> next_states<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token triple-quoted-string string">'''用策略网络对 tmp_states（重复后的真实状态）采样动作，得到随机采样的当前动作及其对数概率。'''</span>
        random_curr_actions<span class="token punctuation">,</span> random_curr_log_pi <span class="token operator">=</span> self<span class="token punctuation">.</span>actor<span class="token punctuation">(</span>tmp_states<span class="token punctuation">)</span>
        <span class="token triple-quoted-string string">'''同理，对 tmp_next_states 采样下一步动作和对应对数概率。'''</span>
        random_next_actions<span class="token punctuation">,</span> random_next_log_pi <span class="token operator">=</span> self<span class="token punctuation">.</span>actor<span class="token punctuation">(</span>tmp_next_states<span class="token punctuation">)</span>
        <span class="token triple-quoted-string string">'''用 critic 网络计算对于 tmp_states 与随机均匀动作 random_unif_actions 的 Q 值，之后 reshape 成 (batch_size, num_random, 1)。'''</span>
        q1_unif <span class="token operator">=</span> self<span class="token punctuation">.</span>critic_1<span class="token punctuation">(</span>tmp_states<span class="token punctuation">,</span> random_unif_actions<span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>num_random<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        q2_unif <span class="token operator">=</span> self<span class="token punctuation">.</span>critic_2<span class="token punctuation">(</span>tmp_states<span class="token punctuation">,</span> random_unif_actions<span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>num_random<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token triple-quoted-string string">'''用 critic 网络计算对于 tmp_states 与随机当前动作的 Q 值，并 reshape。'''</span>
        q1_curr <span class="token operator">=</span> self<span class="token punctuation">.</span>critic_1<span class="token punctuation">(</span>tmp_states<span class="token punctuation">,</span> random_curr_actions<span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>num_random<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        q2_curr <span class="token operator">=</span> self<span class="token punctuation">.</span>critic_2<span class="token punctuation">(</span>tmp_states<span class="token punctuation">,</span> random_curr_actions<span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>num_random<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token triple-quoted-string string">'''用 critic 网络计算对于 tmp_states 与随机下一动作的 Q 值，并 reshape。'''</span>
        q1_next <span class="token operator">=</span> self<span class="token punctuation">.</span>critic_1<span class="token punctuation">(</span>tmp_states<span class="token punctuation">,</span> random_next_actions<span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>num_random<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        q2_next <span class="token operator">=</span> self<span class="token punctuation">.</span>critic_2<span class="token punctuation">(</span>tmp_states<span class="token punctuation">,</span> random_next_actions<span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>num_random<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token triple-quoted-string string">'''
        作用：
        - 将三部分 Q 值进行拼接：
          1. 对于随机均匀采样动作：减去其对数概率（固定值）；
          2. 对于策略采样的当前动作：减去对应对数概率（detach 后避免梯度传递）；
          3. 对于策略采样的下一动作：同理。
        - 拼接维度为第 1 维（即动作样本维度）。
        数值例子：
        - 假设每个部分形状为 (64,10,1)，拼接后 q1_cat 形状为 (64,30,1)。
        在 Conservative Q-Learning (CQL) 中，为了防止 Q 函数在离线数据之外的动作上过高估计，
        会在 critic 损失中增加一个正则项。正则项的思想是“保守地”估计 Q 值，使得对于未见过的动作，
        Q 值不至于过高。具体来说，CQL 的正则项大致形式为：
                            Penalty=logE_{a∼μ}[exp(Q(s,a)−logμ(a))]−E_{(s,a)∼D}[Q(s,a)]
        '''</span>
        q1_cat <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>
            q1_unif <span class="token operator">-</span> random_unif_log_pi<span class="token punctuation">,</span>
            q1_curr <span class="token operator">-</span> random_curr_log_pi<span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>num_random<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            q1_next <span class="token operator">-</span> random_next_log_pi<span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>num_random<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        q2_cat <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>
            q2_unif <span class="token operator">-</span> random_unif_log_pi<span class="token punctuation">,</span>
            q2_curr <span class="token operator">-</span> random_curr_log_pi<span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>num_random<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            q2_next <span class="token operator">-</span> random_next_log_pi<span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>num_random<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token triple-quoted-string string">'''
        作用：
        - 对 q1_cat 和 q2_cat 在动作维度上做 logsumexp 操作，再取平均，得到一个标量，
          表示对所有随机动作样本的软最大值。
        - logsumexp 是一种平滑的最大值函数，计算公式：
                            log∑_iexp(xi)
        '''</span>
        qf1_loss_1 <span class="token operator">=</span> torch<span class="token punctuation">.</span>logsumexp<span class="token punctuation">(</span>q1_cat<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>
        qf2_loss_1 <span class="token operator">=</span> torch<span class="token punctuation">.</span>logsumexp<span class="token punctuation">(</span>q2_cat<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token triple-quoted-string string">'''分别计算 critic 网络对于当前真实 (states, actions) 的 Q 值的均值。'''</span>
        qf1_loss_2 <span class="token operator">=</span> self<span class="token punctuation">.</span>critic_1<span class="token punctuation">(</span>states<span class="token punctuation">,</span> actions<span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>
        qf2_loss_2 <span class="token operator">=</span> self<span class="token punctuation">.</span>critic_2<span class="token punctuation">(</span>states<span class="token punctuation">,</span> actions<span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token triple-quoted-string string">'''将原本 SAC 中的 critic 损失（均方误差）与 CQL 正则项相加，构成最终 critic 损失。'''</span>
        qf1_loss <span class="token operator">=</span> critic_1_loss <span class="token operator">+</span> self<span class="token punctuation">.</span>beta <span class="token operator">*</span> <span class="token punctuation">(</span>qf1_loss_1 <span class="token operator">-</span> qf1_loss_2<span class="token punctuation">)</span>
        qf2_loss <span class="token operator">=</span> critic_2_loss <span class="token operator">+</span> self<span class="token punctuation">.</span>beta <span class="token operator">*</span> <span class="token punctuation">(</span>qf2_loss_1 <span class="token operator">-</span> qf2_loss_2<span class="token punctuation">)</span>
        <span class="token triple-quoted-string string">'''
        对 critic_1 的损失进行反向传播更新。
        对 critic_2 的损失进行反向传播更新。
        '''</span>
        self<span class="token punctuation">.</span>critic_1_optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
        qf1_loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span>retain_graph<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>critic_1_optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>critic_2_optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
        qf2_loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span>retain_graph<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>critic_2_optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># 更新策略网络</span>
        <span class="token triple-quoted-string string">'''使用当前策略对真实状态采样动作，并获得对应对数概率。
        self.actor未更新'''</span>
        new_actions<span class="token punctuation">,</span> log_prob <span class="token operator">=</span> self<span class="token punctuation">.</span>actor<span class="token punctuation">(</span>states<span class="token punctuation">)</span>
        entropy <span class="token operator">=</span> <span class="token operator">-</span>log_prob
        <span class="token triple-quoted-string string">'''
        评估当前策略生成的动作的 Q 值，使用 critic_1 和 critic_2 分别计算，并取最小值以降低过估计。
        self.critic_1和self.critic_2是刚更新过的
        '''</span>
        q1_value <span class="token operator">=</span> self<span class="token punctuation">.</span>critic_1<span class="token punctuation">(</span>states<span class="token punctuation">,</span> new_actions<span class="token punctuation">)</span>
        q2_value <span class="token operator">=</span> self<span class="token punctuation">.</span>critic_2<span class="token punctuation">(</span>states<span class="token punctuation">,</span> new_actions<span class="token punctuation">)</span>
        <span class="token triple-quoted-string string">'''
        作用：
        - 计算策略损失，目标是最大化 min(𝑄1,𝑄2)−𝛼log𝜋；这里取负号后作为损失。
        '''</span>
        actor_loss <span class="token operator">=</span> torch<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token operator">-</span>self<span class="token punctuation">.</span>log_alpha<span class="token punctuation">.</span>exp<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> entropy <span class="token operator">-</span> torch<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span>q1_value<span class="token punctuation">,</span> q2_value<span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>actor_optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
        actor_loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>actor_optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># 更新alpha值</span>
        <span class="token triple-quoted-string string">'''
        作用：
        - 计算温度参数 α 的损失，目标是使策略熵接近目标熵。
        - detach() 表示不对 entropy 反向传播梯度，只更新 alpha。
        SAC原始论文中：
                            J(α)=E_{a∼π}[−α(logπ(a∣s)+Htarget)]，其中H=−logπ(a∣s)
        '''</span>
        alpha_loss <span class="token operator">=</span> torch<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">(</span>entropy <span class="token operator">-</span> self<span class="token punctuation">.</span>target_entropy<span class="token punctuation">)</span><span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>log_alpha<span class="token punctuation">.</span>exp<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>log_alpha_optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
        alpha_loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>log_alpha_optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>soft_update<span class="token punctuation">(</span>self<span class="token punctuation">.</span>critic_1<span class="token punctuation">,</span> self<span class="token punctuation">.</span>target_critic_1<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>soft_update<span class="token punctuation">(</span>self<span class="token punctuation">.</span>critic_2<span class="token punctuation">,</span> self<span class="token punctuation">.</span>target_critic_2<span class="token punctuation">)</span>


random<span class="token punctuation">.</span>seed<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>seed<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token string">'seed'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">seed_fn</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> seed<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        env<span class="token punctuation">.</span>reset<span class="token punctuation">(</span>seed<span class="token operator">=</span>seed<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span>seed<span class="token punctuation">]</span>
    env<span class="token punctuation">.</span>seed <span class="token operator">=</span> seed_fn<span class="token punctuation">.</span>__get__<span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># env.seed(0)</span>
torch<span class="token punctuation">.</span>manual_seed<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

beta <span class="token operator">=</span> <span class="token number">5.0</span>
num_random <span class="token operator">=</span> <span class="token number">5</span>
num_epochs <span class="token operator">=</span> <span class="token number">100</span>
num_trains_per_epoch <span class="token operator">=</span> <span class="token number">500</span>

agent <span class="token operator">=</span> CQL<span class="token punctuation">(</span>state_dim<span class="token punctuation">,</span> hidden_dim<span class="token punctuation">,</span> action_dim<span class="token punctuation">,</span> action_bound<span class="token punctuation">,</span> actor_lr<span class="token punctuation">,</span>
            critic_lr<span class="token punctuation">,</span> alpha_lr<span class="token punctuation">,</span> target_entropy<span class="token punctuation">,</span> tau<span class="token punctuation">,</span> gamma<span class="token punctuation">,</span> device<span class="token punctuation">,</span> beta<span class="token punctuation">,</span>
            num_random<span class="token punctuation">)</span>

return_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> tqdm<span class="token punctuation">(</span>total<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">(</span>num_epochs <span class="token operator">/</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> desc<span class="token operator">=</span><span class="token string">'Iteration %d'</span> <span class="token operator">%</span> i<span class="token punctuation">)</span> <span class="token keyword">as</span> pbar<span class="token punctuation">:</span>
        <span class="token keyword">for</span> i_epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>num_epochs <span class="token operator">/</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># 此处与环境交互只是为了评估策略,最后作图用,不会用于训练</span>
            epoch_return <span class="token operator">=</span> <span class="token number">0</span>
            state <span class="token operator">=</span> env<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span>
            done <span class="token operator">=</span> <span class="token boolean">False</span>
            <span class="token keyword">while</span> <span class="token keyword">not</span> done<span class="token punctuation">:</span>
                action <span class="token operator">=</span> agent<span class="token punctuation">.</span>take_action<span class="token punctuation">(</span>state<span class="token punctuation">)</span>
                result <span class="token operator">=</span> env<span class="token punctuation">.</span>step<span class="token punctuation">(</span>action<span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">5</span><span class="token punctuation">:</span>
                    next_state<span class="token punctuation">,</span> reward<span class="token punctuation">,</span> done<span class="token punctuation">,</span> truncated<span class="token punctuation">,</span> info <span class="token operator">=</span> result
                    done <span class="token operator">=</span> done <span class="token keyword">or</span> truncated  <span class="token comment"># 可合并 terminated 和 truncated 标志</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    next_state<span class="token punctuation">,</span> reward<span class="token punctuation">,</span> done<span class="token punctuation">,</span> info <span class="token operator">=</span> result
                <span class="token comment"># next_state, reward, done, _ = env.step(action)</span>
                state <span class="token operator">=</span> next_state
                epoch_return <span class="token operator">+=</span> reward
            return_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>epoch_return<span class="token punctuation">)</span>

            <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_trains_per_epoch<span class="token punctuation">)</span><span class="token punctuation">:</span>
                b_s<span class="token punctuation">,</span> b_a<span class="token punctuation">,</span> b_r<span class="token punctuation">,</span> b_ns<span class="token punctuation">,</span> b_d <span class="token operator">=</span> replay_buffer<span class="token punctuation">.</span>sample<span class="token punctuation">(</span>batch_size<span class="token punctuation">)</span>
                transition_dict <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token string">'states'</span><span class="token punctuation">:</span> b_s<span class="token punctuation">,</span>
                    <span class="token string">'actions'</span><span class="token punctuation">:</span> b_a<span class="token punctuation">,</span>
                    <span class="token string">'next_states'</span><span class="token punctuation">:</span> b_ns<span class="token punctuation">,</span>
                    <span class="token string">'rewards'</span><span class="token punctuation">:</span> b_r<span class="token punctuation">,</span>
                    <span class="token string">'dones'</span><span class="token punctuation">:</span> b_d
                <span class="token punctuation">}</span>
                agent<span class="token punctuation">.</span>update<span class="token punctuation">(</span>transition_dict<span class="token punctuation">)</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>i_epoch <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">10</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                pbar<span class="token punctuation">.</span>set_postfix<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
                    <span class="token string">'epoch'</span><span class="token punctuation">:</span>
                    <span class="token string">'%d'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>num_epochs <span class="token operator">/</span> <span class="token number">10</span> <span class="token operator">*</span> i <span class="token operator">+</span> i_epoch <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token string">'return'</span><span class="token punctuation">:</span>
                    <span class="token string">'%.3f'</span> <span class="token operator">%</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>return_list<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            pbar<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>


epochs_list <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>return_list<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>epochs_list<span class="token punctuation">,</span> return_list<span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">'Epochs'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">'Returns'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'CQL on {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>env_name<span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>

mv_return <span class="token operator">=</span> rl_utils<span class="token punctuation">.</span>moving_average<span class="token punctuation">(</span>return_list<span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>episodes_list<span class="token punctuation">,</span> mv_return<span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">'Episodes'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">'Returns'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'CQL on {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>env_name<span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f:672e6373646e2e6e65742f787a73313231303635323633362f:61727469636c652f64657461696c732f313436323833393133" class_="artid" style="display:none">
 </p>
</div>


