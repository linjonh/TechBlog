---
layout: post
title: "Qt-D指针与Q指针的设计哲学"
date: 2025-03-16 20:37:30 +0800
description: "在探索Qt源码的过程中会看到类的成员有一个d指针，d指针类型是一个private的类，这种设计模式称为PIMPL（pointer to implementation），本文根据Qt官方文章介绍d指针与q指针，理解其中的设计哲学。"
keywords: "Qt-D指针与Q指针的设计哲学"
categories: ['Qt']
tags: ['开发语言', '底层原理', 'Qt', 'Q', 'D', 'C']
artid: "146297613"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146297613
    alt: "Qt-D指针与Q指针的设计哲学"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146297613
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146297613
cover: https://bing.ee123.net/img/rand?artid=146297613
image: https://bing.ee123.net/img/rand?artid=146297613
img: https://bing.ee123.net/img/rand?artid=146297613
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Qt-D指针与Q指针的设计哲学
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <p>
    </p>
    <h2>
     <a id="_1">
     </a>
     前言
    </h2>
    <p>
     在探索Qt源码的过程中会看到类的成员有一个d指针，d指针类型是一个private的类，这种设计模式称为PIMPL（pointer to implementation），本文根据Qt
     <a href="https://wiki.qt.io/D-Pointer" rel="nofollow">
      官方文章
     </a>
     介绍d指针与q指针，理解其中的设计哲学。
    </p>
    <h3>
     <a id="PIMLP_3">
     </a>
     PIMLP与二进制兼容性
    </h3>
    <p>
     PIMPL（pointer to implementation）或称Opaque Pointer指的是将一个类的功能实现通过另一个实现类的指针隐藏起来，例如头文件有如下声明：
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">class</span> <span class="token class-name">Widget</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">Widget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">private</span><span class="token operator">:</span>
	WidgetImpl<span class="token operator">*</span> p<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     在cpp中实现WidgetImpl类
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">class</span> <span class="token class-name">WidgetImpl</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// implementation</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     这种设计模式通常使用在库的实现当中，因为它有两个好处：
    </p>
    <ol>
     <li>
      隐藏类实现。包括一些没必要暴露给用户的内部函数声明，以及需要的成员变量等实现细节。
     </li>
     <li>
      库的二进制兼容。当改变实现类的数据成员时，不影响库的二进制兼容性，原本使用库的主程序不需要重新编译，只需要把库文件（动态库）进行替换即可。
     </li>
    </ol>
    <p>
     让我们看一个二进制不兼容的例子，假设有如下实现，并且将其编译成WidgetLib1.0动态库：
    </p>
    <pre><code class="prism language-cpp"> <span class="token keyword">class</span> <span class="token class-name">Widget</span>
 <span class="token punctuation">{<!-- --></span>
 <span class="token comment">// ...</span>
 <span class="token keyword">private</span><span class="token operator">:</span>
    Rect m_geometry<span class="token punctuation">;</span>
 <span class="token punctuation">}</span><span class="token punctuation">;</span>
 
 <span class="token keyword">class</span> <span class="token class-name">Label</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Widget</span></span>
 <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token comment">// ... </span>
    String <span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> 
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> m_text<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
 <span class="token keyword">private</span><span class="token operator">:</span>
     String m_text<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
</code></pre>
    <p>
     当我们有一天希望升级Widget类的功能，需要新增一个数据成员，如下：
    </p>
    <pre><code class="prism language-cpp"> <span class="token keyword">class</span> <span class="token class-name">Widget</span>
 <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// ...</span>
 <span class="token keyword">private</span><span class="token operator">:</span>
     Rect m_geometry<span class="token punctuation">;</span>
     String m_stylesheet<span class="token punctuation">;</span> <span class="token comment">// NEW in WidgetLib 1.1</span>
 <span class="token punctuation">}</span><span class="token punctuation">;</span>
 
 <span class="token keyword">class</span> <span class="token class-name">Label</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Widget</span></span>
 <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">public</span><span class="token operator">:</span>
     <span class="token comment">// ...</span>
     String <span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span>
     <span class="token punctuation">{<!-- --></span>
         <span class="token keyword">return</span> m_text<span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 
 <span class="token keyword">private</span><span class="token operator">:</span>
     String m_text<span class="token punctuation">;</span>
 <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     此时编译出WidgetLib1.1库后，替换1.0库，这时运行主程序会发生崩溃。原因在于我们新增了一个数据成员，从而改变了类Widget的大小，当编译器在编译生成底层代码时，它会使用到数据成员的偏移量从而访问某个对象的某一个数据成员，下面是WidgetLib1.0和WidgetLib1.1简化后label对象的内存分布对比。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/d7fbb175469a4a0c857e2c86abb3c768.png">
      <br/>
      在WidgetLib1.0中，m_text在label对象偏移量为1的位置，而在WidgetLib1.1中，m_text偏移量为2。对于主程序而言，在编译使用1.0版本的主程序时，主程序中调用text()接口的代码会被翻译成访问label对象偏移量为1的位置的数据，而在升级到WidgetLib1.1后，由于主程序没有重新编译，只是替换了库，库中的m_text偏移量变为了2，但是主程序由于没有重新编译，因此它访问的仍然是偏移量为1的位置，但是此时访问到的实际上是m_stylesheet的变量。
      <br/>
      这里text()的代码实现的翻译在主程序中而不是在lib中，是因为其实现是在头文件中写的，那么如果不是写在头文件中结果有变化吗？答案是没有，因为编译器依赖于对象的大小生成代码，并且要求编译时和运行时的对象大小是一致的，如果我们主程序中声明了一个在栈上的label对象，编译器在编译时（主程序+1.0库）认为对象的大小是2，而升级库到1.1后，主程序运行时的实际大小为3，那么在创建对象的时候就会把栈中的数据覆盖掉从而破坏栈。
     </img>
    </p>
    <p>
     至此我们得出一个结论，如果希望程序在库升级后能继续使用，我们就
     <strong>
      不能改变类的大小
     </strong>
     。
    </p>
    <h3>
     <a id="D_77">
     </a>
     D指针
    </h3>
    <p>
     解决方法就是让导出的类拥有一个指针，这个指针指向了所有内部的数据，当内部数据的成员增减时，由于这个指针只在库中用到，因此只会影响到库，对主程序而言，类的大小一直都是一个内部数据指针的大小，因此不会对主程序产生影响，这个指针在Qt中称为D指针。
    </p>
    <pre><code class="prism language-cpp"> <span class="token comment">/* Since d_ptr is a pointer and is never referenced in header file
 (it would cause a compile error) WidgetPrivate doesn't have to be included,
 but forward-declared instead.
 The definition of the class can be written in widget.cpp or
 in a separate file, say widget_p.h */</span>
 <span class="token keyword">class</span> <span class="token class-name">WidgetPrivate</span><span class="token punctuation">;</span>
 
 <span class="token keyword">class</span> <span class="token class-name">Widget</span>
 <span class="token punctuation">{<!-- --></span>
     <span class="token comment">// ...</span>
     Rect <span class="token function">geometry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>
     <span class="token comment">// ... </span>
 
 <span class="token keyword">private</span><span class="token operator">:</span>
     WidgetPrivate <span class="token operator">*</span>d_ptr<span class="token punctuation">;</span>
 <span class="token punctuation">}</span><span class="token punctuation">;</span>
‎
</code></pre>
    <p>
     在widget_p.h中
    </p>
    <pre><code class="prism language-cpp"><span class="token comment">/* widget_p.h (_p means private) */</span>
<span class="token keyword">struct</span> <span class="token class-name">WidgetPrivate</span>
<span class="token punctuation">{<!-- --></span>
    Rect geometry<span class="token punctuation">;</span>
    String stylesheet<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     widget.cpp
    </p>
    <pre><code class="prism language-cpp"><span class="token comment">// With this #include, we can access WidgetPrivate.</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"widget_p.h"</span></span>

<span class="token class-name">Widget</span><span class="token double-colon punctuation">::</span><span class="token function">Widget</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">d_ptr</span><span class="token punctuation">(</span><span class="token keyword">new</span> WidgetPrivate<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// Creation of private data</span>
<span class="token punctuation">}</span>

Rect <span class="token class-name">Widget</span><span class="token double-colon punctuation">::</span><span class="token function">geometry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// The d-ptr is only accessed in the library code</span>
    <span class="token keyword">return</span> d_ptr<span class="token operator">-&gt;</span>geometry<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <pre><code class="prism language-cpp"><span class="token keyword">class</span> <span class="token class-name">Label</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Widget</span></span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// ...</span>
    String <span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token comment">// Each class maintains its own d-pointer</span>
    LabelPrivate <span class="token operator">*</span>d_ptr<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     label.cpp
    </p>
    <pre><code class="prism language-cpp"><span class="token comment">// Unlike WidgetPrivate, the author decided LabelPrivate</span>
<span class="token comment">// to be defined in the source file itself</span>
<span class="token keyword">struct</span> <span class="token class-name">LabelPrivate</span>
<span class="token punctuation">{<!-- --></span>
    String text<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token class-name">Label</span><span class="token double-colon punctuation">::</span><span class="token function">Label</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">d_ptr</span><span class="token punctuation">(</span><span class="token keyword">new</span> LabelPrivate<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span>

String <span class="token class-name">Label</span><span class="token double-colon punctuation">::</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> d_ptr<span class="token operator">-&gt;</span>text<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     由于d指针只在库中使用，而每次发布库都会重新编译，因此Private类可以随意更改而不会影响主程序。
    </p>
    <p>
     这种实现方式有如下好处：
    </p>
    <ol>
     <li>
      二进制兼容性
     </li>
     <li>
      隐藏实现细节。只需一个头文件和一个库。
     </li>
     <li>
      头文件没有实现细节相关的api，用户可以更清晰的看到能使用的api
     </li>
     <li>
      编译更快。因为所有实现细节都从头文件都移到了实现类的cpp文件中
     </li>
    </ol>
    <h3>
     <a id="Q_160">
     </a>
     Q指针
    </h3>
    <p>
     有时在Private实现类中我们希望访问原有类的指针，调用它的一些函数，因此在实现类中通常会保存一个指针指向原有的类，这个指针我们称为Q指针。
     <br/>
     widget.h
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">class</span> <span class="token class-name">WidgetPrivate</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Widget</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// ...</span>
    Rect <span class="token function">geometry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
<span class="token keyword">private</span><span class="token operator">:</span>
    WidgetPrivate <span class="token operator">*</span>d_ptr<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     widget_p.h
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">struct</span> <span class="token class-name">WidgetPrivate</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// Constructor that initializes the q-ptr</span>
    <span class="token function">WidgetPrivate</span><span class="token punctuation">(</span>Widget <span class="token operator">*</span>q<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">q_ptr</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span>
    Widget <span class="token operator">*</span>q_ptr<span class="token punctuation">;</span> <span class="token comment">// q-ptr points to the API class</span>
    Rect geometry<span class="token punctuation">;</span>
    String stylesheet<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     widget.cpp
    </p>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"widget_p.h"</span></span>
<span class="token comment">// Create private data.</span>
<span class="token comment">// Pass the 'this' pointer to initialize the q-ptr</span>
<span class="token class-name">Widget</span><span class="token double-colon punctuation">::</span><span class="token function">Widget</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">d_ptr</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">WidgetPrivate</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span>

Rect <span class="token class-name">Widget</span><span class="token double-colon punctuation">::</span><span class="token function">geometry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// the d-ptr is only accessed in the library code</span>
    <span class="token keyword">return</span> d_ptr<span class="token operator">-&gt;</span>geometry<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     ‎label.h
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">class</span> <span class="token class-name">Label</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Widget</span></span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// ...</span>
    String <span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    LabelPrivate <span class="token operator">*</span>d_ptr<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     label.cpp
    </p>
    <pre><code class="prism language-cpp"><span class="token comment">// Unlike WidgetPrivate, the author decided LabelPrivate</span>
<span class="token comment">// to be defined in the source file itself</span>
<span class="token keyword">struct</span> <span class="token class-name">LabelPrivate</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">LabelPrivate</span><span class="token punctuation">(</span>Label <span class="token operator">*</span>q<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">q_ptr</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span>
    Label <span class="token operator">*</span>q_ptr<span class="token punctuation">;</span>
    String text<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token class-name">Label</span><span class="token double-colon punctuation">::</span><span class="token function">Label</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">d_ptr</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">LabelPrivate</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span>

String <span class="token class-name">Label</span><span class="token double-colon punctuation">::</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> d_ptr<span class="token operator">-&gt;</span>text<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="d_232">
     </a>
     优化d指针继承
    </h3>
    <p>
     注意到Widget和Label类都声明了一个各自类的Private类指针，且子类构造函数在实例化父类时使用的是默认无参的构造函数，因此，当我们实例化Label时，会先调用基类的构造函数，然后new WidgetPrivate，接着调用子类的构造函数，然后new LabelPrivate，对于某些深度继承的类，这种设计将会造成多次的内存申请，且有多个相互独立的Private类对象存在，子类的d_ptr还会覆盖父类的同名数据成员d_ptr。解决方法是让Private类也具有继承关系，将子类的指针沿着Private类继承链向上传递。注意这种方式要求Private父类要在单独的头文件中声明（而不是直接写在cpp文件中），否则无法被其他Private子类继承。改进后的设计如下：
     <br/>
     widget.h
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">class</span> <span class="token class-name">Widget</span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">Widget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
<span class="token keyword">protected</span><span class="token operator">:</span>
    <span class="token comment">// only subclasses may access the below</span>
    <span class="token comment">// allow subclasses to initialize with their own concrete Private</span>
    <span class="token function">Widget</span><span class="token punctuation">(</span>WidgetPrivate <span class="token operator">&amp;</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>
    WidgetPrivate <span class="token operator">*</span>d_ptr<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     widget_p.h
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">struct</span> <span class="token class-name">WidgetPrivate</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">WidgetPrivate</span><span class="token punctuation">(</span>Widget <span class="token operator">*</span>q<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">q_ptr</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span> <span class="token comment">// constructor that initializes the q-ptr</span>
    Widget <span class="token operator">*</span>q_ptr<span class="token punctuation">;</span> <span class="token comment">// q-ptr that points to the API class</span>
    Rect geometry<span class="token punctuation">;</span>
    String stylesheet<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     widget.cpp
    </p>
    <pre><code class="prism language-cpp"><span class="token class-name">Widget</span><span class="token double-colon punctuation">::</span><span class="token function">Widget</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">d_ptr</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">WidgetPrivate</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span>

<span class="token class-name">Widget</span><span class="token double-colon punctuation">::</span><span class="token function">Widget</span><span class="token punctuation">(</span>WidgetPrivate <span class="token operator">&amp;</span>d<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">d_ptr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>d<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     label.h
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">class</span> <span class="token class-name">Label</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Widget</span></span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">Label</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
<span class="token keyword">protected</span><span class="token operator">:</span>
    <span class="token function">Label</span><span class="token punctuation">(</span>LabelPrivate <span class="token operator">&amp;</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// allow Label subclasses to pass on their Private</span>
    <span class="token comment">// notice how Label does not have a d_ptr! It just uses Widget's d_ptr.</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     label.cpp
    </p>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"widget_p.h"</span></span>

<span class="token keyword">class</span> <span class="token class-name">LabelPrivate</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">WidgetPrivate</span></span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    String text<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token class-name">Label</span><span class="token double-colon punctuation">::</span><span class="token function">Label</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 <span class="token operator">:</span> <span class="token function">Widget</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">new</span> LabelPrivate<span class="token punctuation">)</span> <span class="token comment">// initialize the d-pointer with our own Private</span>
<span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span>

<span class="token class-name">Label</span><span class="token double-colon punctuation">::</span><span class="token function">Label</span><span class="token punctuation">(</span>LabelPrivate <span class="token operator">&amp;</span>d<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">Widget</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     当我们创建Label对象，只会发生一次内存申请，即new LabelPrivate。
    </p>
    <h3>
     <a id="Q_DQ_Q_300">
     </a>
     Q_D和Q_Q
    </h3>
    <p>
     在Label类方法中，当我们访问d_ptr时，访问的是基类声明的WidgetPrivate类型的指针，在Label类的方法中为了访问LabelPrivate的成员text，需要向下转换
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token class-name">Label</span><span class="token double-colon punctuation">::</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token keyword">const</span> String <span class="token operator">&amp;</span>text<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    LabelPrivate <span class="token operator">*</span>d <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>LabelPrivate<span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>d_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// cast to our private type</span>
    d<span class="token operator">-&gt;</span>text <span class="token operator">=</span> text<span class="token punctuation">;</span>
<span class="token punctuation">}</span>‎
</code></pre>
    <p>
     Qt定义了Q_D函数帮我们做上述的转化，以简化代码，Q_Q函数类似：
    </p>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">Q_D</span><span class="token expression"><span class="token punctuation">(</span>Class<span class="token punctuation">)</span> Class</span><span class="token punctuation">##</span><span class="token expression">Private <span class="token operator">*</span> <span class="token keyword">const</span> d <span class="token operator">=</span> <span class="token function">d_func</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">Q_Q</span><span class="token expression"><span class="token punctuation">(</span>Class<span class="token punctuation">)</span> Class <span class="token operator">*</span> <span class="token keyword">const</span> q <span class="token operator">=</span> <span class="token function">q_func</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span>
</code></pre>
    <p>
     其中d_func()是把d_ptr进行类似static_cast&lt;LabelPrivate*&gt;的类型转换。于是代码简化为：
    </p>
    <pre><code class="prism language-cpp"><span class="token comment">// With Q_D you can use the members of LabelPrivate from Label</span>
<span class="token keyword">void</span> <span class="token class-name">Label</span><span class="token double-colon punctuation">::</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token keyword">const</span> String <span class="token operator">&amp;</span>text<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">Q_D</span><span class="token punctuation">(</span>Label<span class="token punctuation">)</span><span class="token punctuation">;</span>
    d<span class="token operator">-&gt;</span>text <span class="token operator">=</span> text<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// With Q_Q you can use the members of Label from LabelPrivate</span>
<span class="token keyword">void</span> <span class="token class-name">LabelPrivate</span><span class="token double-colon punctuation">::</span><span class="token function">someHelperFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">Q_Q</span><span class="token punctuation">(</span>Label<span class="token punctuation">)</span><span class="token punctuation">;</span>
    q<span class="token operator">-&gt;</span><span class="token function">selectAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     d_func()通过Q_DECLARE_PRIVATE定义了两个版本，一个返回Private类指针，一个返回const Private类指针，此外Q_DECLARE_PRIVATE还声明ClassPrivate是Class的友元类，如下：
    </p>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">Q_DECLARE_PRIVATE</span><span class="token expression"><span class="token punctuation">(</span>Class<span class="token punctuation">)</span></span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">inline</span> Class</span><span class="token punctuation">##</span><span class="token expression">Private<span class="token operator">*</span> <span class="token function">d_func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span></span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token keyword">return</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>Class</span><span class="token punctuation">##</span><span class="token expression">Private <span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token function">qGetPtrHelper</span><span class="token punctuation">(</span>d_ptr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">}</span></span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">inline</span> <span class="token keyword">const</span> Class</span><span class="token punctuation">##</span><span class="token expression">Private<span class="token operator">*</span> <span class="token function">d_func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span></span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token keyword">return</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span><span class="token keyword">const</span> Class</span><span class="token punctuation">##</span><span class="token expression">Private <span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token function">qGetPtrHelper</span><span class="token punctuation">(</span>d_ptr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">}</span></span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">friend</span> <span class="token keyword">class</span> <span class="token class-name">Class</span></span><span class="token punctuation">##</span><span class="token expression">Private<span class="token punctuation">;</span></span></span>
</code></pre>
    <p>
     我们可以在公共类（导出类）声明一个Q_DECLARE_PRIVATE，从而快速声明返回const和非const Private类指针的d_func()，以及声明Private类是当前类的友元类，如下：
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">class</span> <span class="token class-name">QLabel</span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token function">Q_DECLARE_PRIVATE</span><span class="token punctuation">(</span>QLabel<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     <code>
      friend class Class##Private
     </code>
     的作用是让Private类可以访问公共类的public/protected/private接口。
     <br/>
     注意，当我们需要使用const版本的Private类指针时，使用如下写法：
    </p>
    <pre><code class="prism language-cpp"><span class="token function">Q_D</span><span class="token punctuation">(</span><span class="token keyword">const</span> Label<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 自动调用const版本的d_func()</span>
</code></pre>
    <p>
     通常d_func()是在类内部使用，不过某些情况下，也可以通过声明friend class的方式使得其它类可以访问当前类内部的数据，这些数据通常无法从当前类的公共api得到，例如，在QLabel类中声明ClassA是友元类，ClassA对象访问QLabel内部数据的方法如下：
    </p>
    <pre><code class="prism language-cpp"><span class="token comment">// ClassA声明为QLabel的friend class, ClassA方法中可以有如下调用</span>
label<span class="token operator">-&gt;</span><span class="token function">d_func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span>linkClickCount<span class="token punctuation">;</span>
</code></pre>
    <p>
     参考：
    </p>
    <ol>
     <li>
      https://wiki.qt.io/D-Pointer
     </li>
    </ol>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a:2f2f626c6f672e6373646e2e6e65742f6d72626f6e6531312f:61727469636c652f64657461696c732f313436323937363133" class_="artid" style="display:none">
 </p>
</div>


