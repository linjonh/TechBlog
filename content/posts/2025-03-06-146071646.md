---
layout: post
title: "Redis-的过期策略与键的过期时间设置"
date: 2025-03-06 15:30:04 +0800
description: "Redis 的过期机制通过惰性删除和定期删除两种策略，实现了内存资源的高效管理。通过合理设置键的过期时间，可以优化 Redis 的性能和内存使用。同时，了解过期机制的实现原理，有助于更好地应对高并发和大数据量的场景。在实际应用中，建议根据业务需求灵活使用 Redis 的过期命令，并结合监控工具和配置优化，确保 Redis 的稳定性和高效性。"
keywords: "redis如何实现键的过期删除?解释惰性删除和定期删除的机制。"
categories: ['Redis']
tags: ['数据库', 'Redis', 'Bootstrap']
artid: "146071646"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146071646
    alt: "Redis-的过期策略与键的过期时间设置"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146071646
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146071646
cover: https://bing.ee123.net/img/rand?artid=146071646
image: https://bing.ee123.net/img/rand?artid=146071646
img: https://bing.ee123.net/img/rand?artid=146071646
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Redis 的过期策略与键的过期时间设置
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     Redis 是一个高性能的键值存储系统，广泛应用于缓存、消息队列等场景。为了管理内存资源，Redis 提供了键的过期机制，允许用户为键设置生存时间（TTL）。本文将深入探讨 Redis 的过期策略、如何设置键的过期时间，以及这些机制背后的实现原理。
    </p>
    <h2>
     <a id="_Redis__1">
     </a>
     一、 Redis 的过期策略
    </h2>
    <p>
     Redis 通过两种主要策略来处理键的过期问题：​惰性删除和定期删除。
    </p>
    <h3>
     <a id="11_Lazy_Expiration_4">
     </a>
     1.1 ​惰性删除（Lazy Expiration）​
    </h3>
    <ul>
     <li>
      ​原理：当客户端访问一个键时，Redis 会检查该键是否已过期。如果已过期，则立即删除该键，并返回空值。
     </li>
     <li>
      ​优点：只有在访问时才会触发删除操作，节省了 CPU 资源。
     </li>
     <li>
      ​缺点：如果过期键长时间未被访问，会导致内存浪费。
     </li>
    </ul>
    <h3>
     <a id="12_Active_Expiration_10">
     </a>
     1.2 ​定期删除（Active Expiration）​
    </h3>
    <ul>
     <li>
      ​原理：Redis 会定期（默认每秒 10 次）随机检查一定数量的键，删除其中已过期的键。 ​
     </li>
     <li>
      优点：可以及时清理过期键，减少内存占用。
     </li>
     <li>
      ​缺点：如果过期键数量过多，可能会占用一定的 CPU 资源。
     </li>
    </ul>
    <h3>
     <a id="13__16">
     </a>
     1.3 ​过期策略的平衡
    </h3>
    <p>
     Redis 通过结合惰性删除和定期删除，实现了内存管理和性能的平衡。惰性删除确保只有在需要时才处理过期键，而定期删除则防止过期键长期占用内存。
    </p>
    <h2>
     <a id="_19">
     </a>
     二、如何设置键的过期时间
    </h2>
    <p>
     Redis 提供了多种命令来设置键的过期时间。
    </p>
    <h3>
     <a id="21_EXPIRE__22">
     </a>
     2.1 ​
     <strong>
      EXPIRE 命令
     </strong>
    </h3>
    <p>
     为键设置一个以秒为单位的生存时间。
     <br/>
     <strong>
      语法：EXPIRE key seconds
     </strong>
    </p>
    <pre><code class="prism language-bash">SET mykey <span class="token string">"Hello"</span>
EXPIRE mykey <span class="token number">60</span>  -- <span class="token number">60</span> 秒后过期
</code></pre>
    <h3>
     <a id="22_PEXPIRE__31">
     </a>
     2.2 ​
     <strong>
      PEXPIRE 命令
     </strong>
    </h3>
    <p>
     为键设置一个以毫秒为单位的生存时间。
     <br/>
     <strong>
      语法：PEXPIRE key milliseconds
     </strong>
     <br/>
     示例：
    </p>
    <pre><code class="prism language-bash">SET mykey <span class="token string">"Hello"</span>
PEXPIRE mykey <span class="token number">60000</span>  -- <span class="token number">60000</span> 毫秒（60 秒）后过期
</code></pre>
    <h3>
     <a id="23_EXPIREAT__41">
     </a>
     2.3 ​
     <strong>
      EXPIREAT 命令
     </strong>
    </h3>
    <p>
     为键设置一个以 Unix 时间戳（秒）为单位的过期时间。
     <br/>
     语法：EXPIREAT key timestamp
     <br/>
     示例：
     <br/>
     redis
     <br/>
     SET mykey “Hello”
     <br/>
     EXPIREAT mykey 1672502400 – 2023-01-01 00:00:00 过期
    </p>
    <h3>
     <a id="24_PEXPIREAT__48">
     </a>
     2.4 ​
     <strong>
      PEXPIREAT 命令
     </strong>
    </h3>
    <p>
     为键设置一个以 Unix 时间戳（毫秒）为单位的过期时间。
     <br/>
     <strong>
      语法：PEXPIREAT key timestamp
     </strong>
     <br/>
     示例：
    </p>
    <pre><code class="prism language-bash">SET mykey <span class="token string">"Hello"</span>
PEXPIREAT mykey <span class="token number">1672502400000</span>  -- <span class="token number">2023</span>-01-01 00:00:00 过期
</code></pre>
    <h3>
     <a id="25_TTL__PTTL__58">
     </a>
     2.5 ​
     <strong>
      TTL 和 PTTL 命令
     </strong>
    </h3>
    <p>
     <strong>
      TTL：返回键的剩余生存时间（秒）。
      <br/>
      PTTL：返回键的剩余生存时间（毫秒）。
     </strong>
     <br/>
     示例：
    </p>
    <pre><code class="prism language-bash">TTL mykey  -- 返回剩余秒数
PTTL mykey -- 返回剩余毫秒数
</code></pre>
    <h3>
     <a id="26_PERSIST__68">
     </a>
     2.6 ​
     <strong>
      PERSIST 命令
     </strong>
    </h3>
    <p>
     移除键的过期时间，使其永久有效。
     <br/>
     <strong>
      语法：PERSIST key
     </strong>
     <br/>
     示例：
    </p>
    <pre><code class="prism language-bash">PERSIST mykey  -- 移除 mykey 的过期时间
</code></pre>
    <h2>
     <a id="__77">
     </a>
     三、 过期机制的实现原理
    </h2>
    <p>
     Redis 的过期机制基于以下数据结构实现：
    </p>
    <h3>
     <a id="31_Expires_Dictionary_80">
     </a>
     3.1 ​过期字典（Expires Dictionary）​
    </h3>
    <ul>
     <li>
      Redis 使用一个独立的字典（哈希表）来存储所有键的过期时间。
     </li>
     <li>
      键是数据库中的键，值是对应的过期时间戳。
     </li>
    </ul>
    <h3>
     <a id="32__85">
     </a>
     3.2 ​过期键的删除
    </h3>
    <ul>
     <li>
      ​惰性删除：当访问键时，Redis 会检查过期字典，如果当前时间大于过期时间，则删除该键。 ​
     </li>
     <li>
      定期删除：Redis会定期随机检查一定数量的键，删除其中已过期的键。
     </li>
    </ul>
    <h3>
     <a id="33__90">
     </a>
     3.3 ​内存回收
    </h3>
    <p>
     当 Redis 的内存使用达到上限时，会触发内存回收机制（如 maxmemory-policy 配置），优先删除过期键以释放内存。
    </p>
    <h2>
     <a id="__92">
     </a>
     四、 最佳实践
    </h2>
    <h3>
     <a id="41__93">
     </a>
     4.1 ​合理设置过期时间
    </h3>
    <ul>
     <li>
      根据业务需求设置合理的过期时间，避免键过早或过晚过期。
     </li>
     <li>
      对于缓存场景，可以使用较短的过期时间（如几分钟或几小时）。
     </li>
    </ul>
    <h3>
     <a id="42__98">
     </a>
     4.2 ​监控过期键数量
    </h3>
    <p>
     使用 INFO 命令监控 Redis 中的过期键数量，确保内存资源得到有效管理。
    </p>
    <pre><code class="prism language-bash">INFO keyspace
</code></pre>
    <h3>
     <a id="43__105">
     </a>
     4.3 ​避免大量键同时过期
    </h3>
    <p>
     如果大量键在同一时间过期，可能会导致 Redis 性能下降。可以通过随机化过期时间来缓解这一问题。
    </p>
    <h3>
     <a id="44__maxmemorypolicy__107">
     </a>
     4.4 ​使用 maxmemory-policy 配置
    </h3>
    <p>
     配置 Redis 的内存回收策略，优先删除过期键或最近最少使用的键（LRU）。
    </p>
    <pre><code class="prism language-bash">CONFIG SET maxmemory-policy volatile-lru
</code></pre>
    <h3>
     <a id="_114">
     </a>
     五、总结
    </h3>
    <p>
     Redis 的过期机制通过惰性删除和定期删除两种策略，实现了内存资源的高效管理。通过合理设置键的过期时间，可以优化 Redis 的性能和内存使用。同时，了解过期机制的实现原理，有助于更好地应对高并发和大数据量的场景。
    </p>
    <p>
     在实际应用中，建议根据业务需求灵活使用 Redis 的过期命令，并结合监控工具和配置优化，确保 Redis 的稳定性和高效性。
    </p>
    <h3>
     <a id="_119">
     </a>
     参考资料
    </h3>
    <p>
     Redis 官方文档：https://redis.io/commands#expire
     <br/>
     《Redis 设计与实现》——黄健宏
     <br/>
     希望这篇博文能帮助你更好地理解 Redis 的过期策略与键的过期时间设置！如果有任何问题或建议，欢迎留言讨论。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f:672e6373646e2e6e65742f323330315f38313138363833312f:61727469636c652f64657461696c732f313436303731363436" class_="artid" style="display:none">
 </p>
</div>


