---
layout: post
title: "Android-StrictMode-使用与原理深度解析"
date: 2025-03-11 22:34:16 +0800
description: "StrictMode 是 Android 开发中不可或缺的性能检测工具，其核心原理是通过 动态插桩 和 Looper 监控 实现主线程耗时操作的检测。合理配置策略可显著提升应用流畅性，但需注意生产环境的禁用和误报处理。"
keywords: "Android StrictMode 使用与原理深度解析"
categories: ['Android']
tags: ['耗时检测', '性能优化', '内存泄漏', '代码规范', 'Strictmode', 'Kotlin', 'Android']
artid: "146189007"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146189007
    alt: "Android-StrictMode-使用与原理深度解析"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146189007
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146189007
cover: https://bing.ee123.net/img/rand?artid=146189007
image: https://bing.ee123.net/img/rand?artid=146189007
img: https://bing.ee123.net/img/rand?artid=146189007
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Android StrictMode 使用与原理深度解析
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     Android StrictMode 是 Android 系统提供的一种开发者工具，用于检测应用主线程中不合理的耗时操作（如磁盘 I/O、网络请求等）和内存泄漏问题。通过配置策略和惩罚机制，它帮助开发者在早期发现潜在性能问题，提升应用流畅性。以下从
     <strong>
      使用方式
     </strong>
     和
     <strong>
      实现原理
     </strong>
     两方面进行深度解析。
    </p>
    <hr/>
    <h3>
     <a id="StrictMode__6">
     </a>
     一、StrictMode 使用详解
    </h3>
    <h4>
     <a id="1__8">
     </a>
     1. 基础配置
    </h4>
    <p>
     在
     <code>
      Application
     </code>
     或
     <code>
      Activity
     </code>
     的
     <code>
      onCreate()
     </code>
     中初始化 StrictMode：
    </p>
    <pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyApp</span> <span class="token keyword">extends</span> <span class="token class-name">Application</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">BuildConfig</span><span class="token punctuation">.</span><span class="token constant">DEBUG</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 配置线程策略（检测主线程问题）</span>
            <span class="token class-name">StrictMode<span class="token punctuation">.</span>ThreadPolicy</span> threadPolicy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StrictMode<span class="token punctuation">.</span>ThreadPolicy<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">detectDiskReads</span><span class="token punctuation">(</span><span class="token punctuation">)</span>     <span class="token comment">// 检测磁盘读</span>
                <span class="token punctuation">.</span><span class="token function">detectDiskWrites</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment">// 检测磁盘写</span>
                <span class="token punctuation">.</span><span class="token function">detectNetwork</span><span class="token punctuation">(</span><span class="token punctuation">)</span>       <span class="token comment">// 检测网络请求</span>
                <span class="token punctuation">.</span><span class="token function">penaltyLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span>         <span class="token comment">// 违例时打印日志</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">StrictMode</span><span class="token punctuation">.</span><span class="token function">setThreadPolicy</span><span class="token punctuation">(</span>threadPolicy<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 配置虚拟机策略（检测内存泄漏等）</span>
            <span class="token class-name">StrictMode<span class="token punctuation">.</span>VmPolicy</span> vmPolicy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StrictMode<span class="token punctuation">.</span>VmPolicy<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">detectLeakedSqlLiteObjects</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment">// 检测 SQLite 对象未关闭</span>
                <span class="token punctuation">.</span><span class="token function">detectLeakedClosableObjects</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 检测 Closeable 对象未关闭</span>
                <span class="token punctuation">.</span><span class="token function">penaltyLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                  <span class="token comment">// 违例时打印日志</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">StrictMode</span><span class="token punctuation">.</span><span class="token function">setVmPolicy</span><span class="token punctuation">(</span>vmPolicy<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <hr/>
    <h4>
     <a id="2__40">
     </a>
     2. 常用检测项
    </h4>
    <ul>
     <li>
      <p>
       <strong>
        ThreadPolicy（线程策略）
       </strong>
      </p>
      <ul>
       <li>
        <strong>
         <mark>
          detectDiskReads() / detectDiskWrites()
         </mark>
        </strong>
        ：主线程磁盘读写。
       </li>
       <li>
        <strong>
         <mark>
          detectNetwork()
         </mark>
        </strong>
        ：主线程网络请求。
       </li>
       <li>
        <strong>
         <mark>
          detectCustomSlowCalls()
         </mark>
        </strong>
        ：自定义耗时操作。
        <br/>
        <br/>
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        VmPolicy（虚拟机策略）
       </strong>
      </p>
      <ul>
       <li>
        <p>
         <strong>
          <mark>
           detectActivityLeaks()
          </mark>
         </strong>
         ：Activity 未正确销毁导致的内存泄漏。
        </p>
       </li>
       <li>
        <p>
         <strong>
          <mark>
           detectLeakedClosableObjects()
          </mark>
         </strong>
         ：未关闭的 Closeable 对象（如文件流）。
        </p>
       </li>
       <li>
        <p>
         <strong>
          <mark>
           detectLeakedRegistrationObjects()
          </mark>
         </strong>
         ：未注销的 BroadcastReceiver 或 ServiceConnection。
        </p>
       </li>
      </ul>
     </li>
    </ul>
    <hr/>
    <h4>
     <a id="3__56">
     </a>
     3. 惩罚机制
    </h4>
    <ul>
     <li>
      <strong>
       penaltyLog()
      </strong>
      ：输出日志（默认方式）。
     </li>
     <li>
      <strong>
       penaltyDialog()
      </strong>
      ：弹出警告对话框（仅限 Debug 模式）。
     </li>
     <li>
      <strong>
       penaltyDeath()
      </strong>
      ：直接崩溃应用（极端调试场景）。
     </li>
     <li>
      <strong>
       penaltyDropBox()
      </strong>
      ：将违例信息记录到系统 DropBox。
     </li>
    </ul>
    <hr/>
    <h4>
     <a id="4__63">
     </a>
     4. 临时忽略检测
    </h4>
    <p>
     通过
     <strong>
      ThreadPolicy
     </strong>
     的
     <strong>
      permit
     </strong>
     方法临时放宽策略：
    </p>
    <pre><code class="prism language-java"><span class="token class-name">StrictMode<span class="token punctuation">.</span>ThreadPolicy</span> oldPolicy <span class="token operator">=</span> <span class="token class-name">StrictMode</span><span class="token punctuation">.</span><span class="token function">getThreadPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">StrictMode</span><span class="token punctuation">.</span><span class="token function">setThreadPolicy</span><span class="token punctuation">(</span><span class="token class-name">ThreadPolicy</span><span class="token punctuation">.</span><span class="token constant">LAX</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 临时禁用检测</span>
<span class="token comment">// 执行可能违例的代码</span>
<span class="token class-name">StrictMode</span><span class="token punctuation">.</span><span class="token function">setThreadPolicy</span><span class="token punctuation">(</span>oldPolicy<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// 恢复原策略</span>
</code></pre>
    <br/>
    <h3>
     <a id="StrictMode__74">
     </a>
     二、StrictMode 实现原理
    </h3>
    <h4>
     <a id="1__Hook__75">
     </a>
     1. 基于 Hook 的监控机制
    </h4>
    <p>
     StrictMode 通过
     <strong>
      动态插桩
     </strong>
     在关键系统 API 中插入检测逻辑。例如：
    </p>
    <ul>
     <li>
      <p>
       <strong>
        文件操作
       </strong>
       ：在
       <strong>
        FileInputStream.read()
       </strong>
       、
       <strong>
        FileOutputStream.write()
       </strong>
       等方法中插入检测代码。
      </p>
     </li>
     <li>
      <p>
       <strong>
        网络操作
       </strong>
       ：在
       <strong>
        HttpURLConnection.connect()
       </strong>
       、
       <strong>
        Socket.connect()
       </strong>
       等方法中触发检查。
      </p>
     </li>
     <li>
      <p>
       <strong>
        内存对象
       </strong>
       ：通过
       <strong>
        CloseGuard
       </strong>
       监控
       <strong>
        Closeable
       </strong>
       对象的释放。
      </p>
     </li>
    </ul>
    <h4>
     <a id="2__84">
     </a>
     2. 主线程监控
    </h4>
    <ul>
     <li>
      <p>
       <strong>
        Looper 监控
       </strong>
       ：通过
       <strong>
        Looper
       </strong>
       的
       <strong>
        MessageQueue
       </strong>
       日志机制，在
       <strong>
        Message
       </strong>
       处理前后插入检查逻辑（
       <strong>
        Looper.getMainLooper()
       </strong>
       的
       <strong>
        LoggingHandler
       </strong>
       ）。
      </p>
     </li>
     <li>
      <p>
       <strong>
        违例判断
       </strong>
       ：当检测到主线程执行磁盘或网络操作时，触发
       <strong>
        StrictMode.noteSlowCall()
       </strong>
       ，并根据策略处理违例。
      </p>
     </li>
    </ul>
    <h4>
     <a id="3__89">
     </a>
     3. 违例处理流程
    </h4>
    <ul>
     <li>
      <p>
       <strong>
        违例触发
       </strong>
       ：系统检测到违例行为（如主线程执行网络请求）。
      </p>
     </li>
     <li>
      <p>
       <strong>
        策略匹配
       </strong>
       ：检查当前线程或虚拟机的策略配置。
      </p>
     </li>
     <li>
      <p>
       <strong>
        执行惩罚
       </strong>
       ：根据策略执行日志记录、弹窗或崩溃。
      </p>
     </li>
     <li>
      <p>
       <strong>
        信息收集
       </strong>
       ：通过
       <strong>
        AndroidBlockGuardPolicy
       </strong>
       收集堆栈信息，生成违例报告。
      </p>
     </li>
    </ul>
    <h4>
     <a id="4__98">
     </a>
     4. 虚拟机策略的实现
    </h4>
    <p>
     <strong>
      对象泄漏检测
     </strong>
     ：利用
     <strong>
      WeakReference
     </strong>
     和
     <strong>
      ReferenceQueue
     </strong>
     追踪对象生命周期。当对象未被释放时，触发
     <strong>
      VmPolicy
     </strong>
     的检测逻辑。
    </p>
    <p>
     <strong>
      Activity 泄漏检测
     </strong>
     ：通过
     <strong>
      ActivityLifecycleCallbacks
     </strong>
     监控
     <strong>
      Activity
     </strong>
     的
     <strong>
      onDestroy
     </strong>
     () 是否被正确调用。
    </p>
    <h4>
     <a id="5__103">
     </a>
     5. 性能优化
    </h4>
    <ul>
     <li>
      <p>
       <strong>
        避免生产环境使用
       </strong>
       ：
       <strong>
        StrictMode
       </strong>
       的检测逻辑会带来性能损耗，需通过
       <strong>
        BuildConfig.DEBUG
       </strong>
       限制仅在开发环境启用。
      </p>
     </li>
     <li>
      <p>
       <strong>
        异步线程池
       </strong>
       ：通过
       <strong>
        StrictMode.noteSlowCall()
       </strong>
       的耗时阈值（默认 500ms）避免误报。
      </p>
     </li>
    </ul>
    <h3>
     <a id="_109">
     </a>
     三、注意事项
    </h3>
    <ul>
     <li>
      <p>
       <strong>
        兼容性
       </strong>
       ：不同
       <strong>
        Android
       </strong>
       版本的检测项可能不同（如 Android 11 默认禁止主线程网络访问）。
      </p>
     </li>
     <li>
      <p>
       <strong>
        误报处理
       </strong>
       ：某些系统级操作（如
       <strong>
        SharedPreferences
       </strong>
       的
       <strong>
        apply
       </strong>
       ()）可能绕过检测。
      </p>
     </li>
     <li>
      <p>
       <strong>
        结合其他工具
       </strong>
       ：需与
       <strong>
        Profiler
       </strong>
       、
       <strong>
        LeakCanary
       </strong>
       等工具配合，全面优化性能。
      </p>
     </li>
    </ul>
    <h3>
     <a id="_117">
     </a>
     四、总结
    </h3>
    <p>
     StrictMode 是 Android 开发中不可或缺的性能检测工具，其核心原理是通过 动态插桩 和 Looper 监控 实现主线程耗时操作的检测。合理配置策略可显著提升应用流畅性，但需注意生产环境的禁用和误报处理。
    </p>
    <br/>
    <br/>
    <br/>
    <p>
     其它推荐：
    </p>
    <ol>
     <li>
      <a href="https://mp.csdn.net/mp_blog/creation/editor/146184252">
       《Android应用性能优化全解析》
      </a>
     </li>
     <li>
      <a href="https://blog.csdn.net/weijiangbc0/article/details/146163497?spm=1001.2014.3001.5501">
       《Android Glide 深度解析：工作原理、LRU 缓存机制与最佳实践》
      </a>
     </li>
    </ol>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f7765696a69616e676263302f:61727469636c652f64657461696c732f313436313839303037" class_="artid" style="display:none">
 </p>
</div>


