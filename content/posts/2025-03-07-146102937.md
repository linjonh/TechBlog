---
layout: post
title: "FE-React-初窥门径五React-组件的加载过程commit-阶段"
date: 2025-03-07 19:01:03 +0800
description: "为了描述方便，图中略过了很多内容，例如 FiberNode 中的。（总共有两个 Fiber Tree，组件加载过程只创建一个）最后编辑于：2025-02-24 21:39:58。之前，React 已经创建好了 3 跟 Fiber 节点，变量）的 FiberNode 创建了多个子孙元素。这个全局变量的值会变，图中画的是它的初始值）一图胜千言，（函数前面的数字，表示缩进层次）做的事情就是创建 FiberTree，做的事情，它主要做了两件事，的业务逻辑，这个阶段由。我们来画一下它们的关系，为一个标记为 WIP（"
keywords: "[FE] React 初窥门径（五）：React 组件的加载过程（commit 阶段）"
categories: ['面试题汇总与解析']
tags: ['课程设计', 'Vue', 'Spring', 'Mysql', 'Java', 'Boot']
artid: "146102937"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146102937
    alt: "FE-React-初窥门径五React-组件的加载过程commit-阶段"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146102937
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146102937
cover: https://bing.ee123.net/img/rand?artid=146102937
image: https://bing.ee123.net/img/rand?artid=146102937
img: https://bing.ee123.net/img/rand?artid=146102937
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     [FE] React 初窥门径（五）：React 组件的加载过程（commit 阶段）
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <div>
     <div class="note-content">
      <h4>
       1. 回顾
      </h4>
      <p>
       <a href="https://www.jianshu.com/p/ece64383e930" rel="nofollow noopener noreferrer" target="_blank">
        前一篇
       </a>
       文章我们看到，
       <code>
        ReactDOM.render
       </code>
       总共包含这些步骤，
       <br/>
      </p>
      <div class="image-package">
       <div class="image-container" style="max-width: 700px; max-height: 842px;">
        <div class="image-container-fill">
        </div>
        <div class="image-view">
         <img src="https://i-blog.csdnimg.cn/img_convert/3c070d4956b402cac74215895ea39cee.webp?x-oss-process=image/format,png">
         </img>
        </div>
       </div>
       <div class="image-caption">
       </div>
      </div>
      <p>
      </p>
      <p>
       然后介绍了
       <code>
        performSyncWorkOnRoot
       </code>
       做的事情，它主要做了两件事，
      </p>
      <ul>
       <li>
        <code>
         renderRootSync
        </code>
        可称之为
        <strong>
         render 阶段
        </strong>
        ：创建了一颗 Fiber Tree（包含 html fragment 并未挂在到 DOM 中）
       </li>
       <li>
        <code>
         commitRoot
        </code>
        可称之为
        <strong>
         commit 阶段
        </strong>
        ：将 Fiber Tree 实际写入 DOM
       </li>
      </ul>
      <p>
       前文我们重点介绍了
       <strong>
        render 阶段
       </strong>
       的业务逻辑，这个阶段由
       <code>
        renderRootSync
       </code>
       来完成，
       <br/>
       其中
       <code>
        markRenderStarted
       </code>
       和
       <code>
        markRenderStopped
       </code>
       标志了
       <strong>
        render 阶段
       </strong>
       的开始和结束。
      </p>
      <pre><code>[6] performSyncWorkOnRoot                                   &lt;- 已创建好了 一个 FiberRootNode 和 两个 FiberNode（下文解释）
    [7] renderRootSync
        [8] markRenderStarted                               &lt;- 开始 render 阶段
        [8] workLoopSync                                    &lt;- 从上到下处理 FiberTree
            [9] performUnitOfWork ---- [HostRoot {tag: 3}]  &lt;- 处理 WIP FiberNode
                [10] beginWork$1
                    [11] beginWork
                        [12] updateHostRoot
                            [13] reconcileChildren          &lt;- 创建 child FiberNode
            [9] performUnitOfWork ---- [IndeterminateComponent {tag: 2}] (&lt;App /&gt;)  &lt;- 处理 child FiberNode
                [10] beginWork$1
                    [11] beginWork
                        [12] mountIndeterminateComponent
                            [13] renderWithHooks
                                [14] Component
                            [13] reconcileChildren          &lt;- 创建 child FiberNode
            [9] performUnitOfWork ---- [HostText {tag: 6}] ('hello world')          &lt;- 处理 child FiberNode
                [10] beginWork$1
                    [11] beginWork
                        [12] updateHostText
                [10] completeUnitOfWork                     &lt;- 从下到上处理 FiberTree
                    [11] completeWork ---- [HostText {tag: 6}] ('hello world')
                        [12] createTextInstance
                            [13] createTextNode
                                [14] createTextNode [HTMLElement] ('hello world')
                    [11] completeWork ---- [IndeterminateComponent {tag: 2}] (&lt;App /&gt;)
                    [11] completeWork ---- [HostRoot {tag: 3}]
        [8] markRenderStopped                               &lt;- 结束 render 阶段
    [7] commitRoot
        [8] runWithPriority$1
            [9] reactPriorityToSchedulerPriority
            [9] Scheduler_runWithPriority
                    [11] markCommitStarted
                    ？                                       &lt;- 本文重点介绍这里
                    [11] markCommitStopped
    [7] ensureRootIsScheduled
</code></pre>
      <p>
       需知在
       <code>
        performSyncWorkOnRoot
       </code>
       之前，React 已经创建好了 3 跟 Fiber 节点，
      </p>
      <ul>
       <li>
        一个 FiberRootNode，
        <code>
         tag
        </code>
        为
        <code>
         LagacyRoot
        </code>
        ：它的
        <code>
         containerInfo
        </code>
        指向了
        <code>
         div#root
        </code>
        这个 DOM 元素
       </li>
       <li>
        两个互为
        <code>
         alternate
        </code>
        的 FiberNode，
        <code>
         tag
        </code>
        为
        <code>
         HostRoot
        </code>
        ：它的
        <code>
         stateNode
        </code>
        指向了上面那个 FiberRootNode
       </li>
      </ul>
      <p>
       我们来画一下它们的关系，
      </p>
      <br/>
      <div class="image-package">
       <div class="image-container" style="max-width: 700px; max-height: 455px;">
        <div class="image-container-fill">
        </div>
        <div class="image-view">
         <img src="https://i-blog.csdnimg.cn/img_convert/36694596f26304cbd49a326735495523.webp?x-oss-process=image/format,png">
         </img>
        </div>
       </div>
       <div class="image-caption">
       </div>
      </div>
      <p>
       从图中可以看出
       <strong>
        render 阶段
       </strong>
       做的事情就是创建 FiberTree，
       <br/>
       为一个标记为 WIP（
       <code>
        workInProgress
       </code>
       变量）的 FiberNode 创建了多个子孙元素。
       <br/>
       （在
       <strong>
        render 阶段
       </strong>
       执行过程中，
       <code>
        workInProgress
       </code>
       这个全局变量的值会变，图中画的是它的初始值）
      </p>
      <p>
       为了描述方便，图中略过了很多内容，例如 FiberNode 中的
       <code>
        updateQueue
       </code>
       等等。
      </p>
      <h4>
       2. 在大图中的位置
      </h4>
      <p>
       本文开始介绍
       <strong>
        commit 阶段
       </strong>
       的业务逻辑，
       <br/>
       VSCode 插件
       <a href="https://links.jianshu.com/go?to=https%3A%2F%2Fmarketplace.visualstudio.com%2Fitems%3FitemName%3Dvsls-contrib.codetour" rel="nofollow noopener noreferrer" target="_blank">
        CodeTour
       </a>
       的安装可以参考
       <a href="https://www.jianshu.com/p/ece64383e930" rel="nofollow noopener noreferrer" target="_blank">
        前一篇
       </a>
       文章，
       <br/>
       相关仓库在这里
       <a href="https://links.jianshu.com/go?to=https%3A%2F%2Fgithub.com%2Fthzt%2Freact-tour%2Ftree%2Fv17.0.2" rel="nofollow noopener noreferrer" target="_blank">
        github: thzt/react-tour
       </a>
       。
      </p>
      <p>
       <code>
        ReactDOM.render
       </code>
       的全流程在这里，
       <br/>
       <a href="https://links.jianshu.com/go?to=https%3A%2F%2Fgithub.com%2Fthzt%2Freact-tour%2Fblob%2Fv17.0.2%2Fbiz%2F4.1.1%2520%25E7%25BB%2584%25E4%25BB%25B6%25E5%258A%25A0%25E8%25BD%25BD%25E8%25BF%2587%25E7%25A8%258B%25EF%25BC%259A%25E5%2587%25BD%25E6%2595%25B0%25E7%25BB%2584%25E4%25BB%25B6%25EF%25BC%2588%25E5%2585%25A8%25E6%25B5%2581%25E7%25A8%258B%25EF%25BC%2589.txt" rel="nofollow noopener noreferrer" target="_blank">
        4.1.1 组件加载过程：函数组件（全流程）
       </a>
      </p>
      <p>
       我们要看这部分内容，即
       <code>
        commitRoot
       </code>
       的调用过程，
       <br/>
      </p>
      <div class="image-package">
       <div class="image-container" style="max-width: 700px; max-height: 505px;">
        <div class="image-container-fill">
        </div>
        <div class="image-view">
         <img src="https://i-blog.csdnimg.cn/img_convert/72d18bff9cca116419a0f1e77116cd3b.webp?x-oss-process=image/format,png">
         </img>
        </div>
       </div>
       <div class="image-caption">
       </div>
      </div>
      <p>
      </p>
      <h4>
       3. commitRoot 业务逻辑
      </h4>
      <p>
       一图胜千言，（函数前面的数字，表示缩进层次）
      </p>
      <pre><code>[7] commitRoot
    [8] runWithPriority$1
        [9] Scheduler_runWithPriority
            [10] eventHandler=commitRootImpl
                [11] markCommitStarted
                [11] invokeGuardedCallback                           &lt;- 第一步
                    [12] invokeGuardedCallbackImpl$1
                        [13] dispatchEvent
                            [14] func=commitBeforeMutationEffects
                                [15] commitBeforeMutationLifeCycles
                                    [16] clearContainer              &lt;- div#root 的 textContext 置空
                [11] invokeGuardedCallback                           &lt;- 第二步（这里要注意，看下文）
                    [12] invokeGuardedCallbackImpl$1
                        [13] dispatchEvent
                            [14] func=commitMutationEffects
                                [15] commitPlacement
                                    [16] insertOrAppendPlacementNodeIntoContainer     &lt;- 把 FiberNode &lt;App /&gt; 放到 div#root 中
                                        [17] insertOrAppendPlacementNodeIntoContainer &lt;- 这是个递归函数，找到后代节点 stateNode 指向的 #text
                                            [18] appendChildToContainer
                                                [19] appendChild                      &lt;-  实际操作 DOM，之后页面立即展示效果
                [11] invokeGuardedCallback                           &lt;- 第三步
                    [12] invokeGuardedCallbackImpl$1
                        [13] dispatchEvent
                            [14] func=commitLayoutEffects
                [11] markCommitStopped
</code></pre>
      <p>
       我们看到
       <code>
        commitRoot
       </code>
       总共包含了三个步骤：
      </p>
      <ul>
       <li>
        <code>
         commitBeforeMutationEffects
        </code>
        ：将 div#root 置空
       </li>
       <li>
        <code>
         commitMutationEffects
        </code>
        ：将 #text 实际写入 DOM 中
       </li>
       <li>
        <code>
         commitLayoutEffects
        </code>
        ：当前示例，这一块没有特殊要说明的事情
       </li>
      </ul>
      <p>
       <strong>
        commit 阶段
       </strong>
       用
       <code>
        markCommitStarted
       </code>
       和
       <code>
        markCommitStopped
       </code>
       标记了开始和结束。
      </p>
      <p>
       值得注意的是，
       <strong>
        commit 阶段
       </strong>
       第三步
       <code>
        commitLayoutEffects
       </code>
       之前，
       <br/>
       React 会将 FiberRootNode 的
       <code>
        current
       </code>
       属性指向创建好了 Fiber Tree。
       <br/>
       （总共有两个 Fiber Tree，组件加载过程只创建一个）
       <br/>
      </p>
      <div class="image-package">
       <div class="image-container" style="max-width: 700px; max-height: 363px;">
        <div class="image-container-fill">
        </div>
        <div class="image-view">
         <img src="https://i-blog.csdnimg.cn/img_convert/5b3dff639f149bdee82300a1150ba3f6.webp?x-oss-process=image/format,png">
         </img>
        </div>
       </div>
       <div class="image-caption">
       </div>
      </div>
      <p>
      </p>
      <p>
       如图所示，
      </p>
      <br/>
      <div class="image-package">
       <div class="image-container" style="max-width: 700px; max-height: 455px;">
        <div class="image-container-fill">
        </div>
        <div class="image-view">
         <img src="https://i-blog.csdnimg.cn/img_convert/a0e117e7fb915e837feca41af8f01cc5.webp?x-oss-process=image/format,png">
         </img>
        </div>
       </div>
       <div class="image-caption">
       </div>
      </div>
      <hr/>
      <h4>
       参考
      </h4>
      <p>
       <a href="https://www.jianshu.com/p/ece64383e930" rel="nofollow noopener noreferrer" target="_blank">
        React 初窥门径（四）：React 组件的加载过程（render 阶段）
       </a>
       <br/>
       <a href="https://links.jianshu.com/go?to=https%3A%2F%2Fmarketplace.visualstudio.com%2Fitems%3FitemName%3Dvsls-contrib.codetour" rel="nofollow noopener noreferrer" target="_blank">
        VSCode: CodeTour
       </a>
       <br/>
       <a href="https://links.jianshu.com/go?to=https%3A%2F%2Fgithub.com%2Fthzt%2Freact-tour%2Ftree%2Fv17.0.2" rel="nofollow noopener noreferrer" target="_blank">
        github: thzt/react-tour
       </a>
       <br/>
       <a href="https://links.jianshu.com/go?to=https%3A%2F%2Fgithub.com%2Fthzt%2Freact-tour%2Fblob%2Fv17.0.2%2Fbiz%2F4.1.1%2520%25E7%25BB%2584%25E4%25BB%25B6%25E5%258A%25A0%25E8%25BD%25BD%25E8%25BF%2587%25E7%25A8%258B%25EF%25BC%259A%25E5%2587%25BD%25E6%2595%25B0%25E7%25BB%2584%25E4%25BB%25B6%25EF%25BC%2588%25E5%2585%25A8%25E6%25B5%2581%25E7%25A8%258B%25EF%25BC%2589.txt" rel="nofollow noopener noreferrer" target="_blank">
        4.1.1 组件加载过程：函数组件（全流程）
       </a>
      </p>
     </div>
     <div class="note-meta-time">
      最后编辑于：2025-02-24 21:39:58
     </div>
     <div class="copyright">
      © 
   著作权归作者所有,转载或内容合作请联系作者
     </div>
    </div>
    <br/>
    <img src="https://img-blog.csdnimg.cn/direct/67c64049147741939b85489caefbb597.png" width="800px">
     <br/>
     <p style="font-weight: 700;">
      喜欢的朋友记得点赞、收藏、关注哦！！！
     </p>
    </img>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
  <div class="blog-extension-box" id="blogExtensionBox" style="width:400px;margin:auto;margin-top:12px">
  </div>
 </article>
 <p alt="68747470733a2f:2f626c6f672e6373646e2e6e65742f726974615f303536372f:61727469636c652f64657461696c732f313436313032393337" class_="artid" style="display:none">
 </p>
</div>


