---
arturl_encode: "68747470733a2f2f626c6f67:2e6373646e2e6e65742f6c656e6779756566656e673231322f:61727469636c652f64657461696c732f313230303432343139"
layout: post
title: "v3S-驱动-i2c-OLED屏幕"
date: 2024-11-29 17:27:54 +08:00
description: "文章目录一、硬件连接二、配置内核三、修改设备树文件四、运行测试1. 打印日志2.简单操作2. 编写测"
keywords: "solomon ssd1307 framebuffer support"
categories: ['荔枝派V3S', 'Linux']
tags: ['物联网', 'Linux']
artid: "120042419"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=120042419
    alt: "v3S-驱动-i2c-OLED屏幕"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=120042419
featuredImagePreview: https://bing.ee123.net/img/rand?artid=120042419
---

# v3S 驱动 i2c OLED屏幕

#### 文章目录

* [一、硬件连接](#_1)
* [二、配置内核](#_4)
* [三、修改设备树文件](#_20)
* [四、运行测试](#_47)
* + [1. 打印日志](#1__48)
  + [2.简单操作](#2_53)
  + [2. 编写测试demo](#2_demo_71)
* [五、关于tty测试](#tty_225)
* [六、修改屏幕显示终端信息](#_240)
* [参考链接](#_257)

## 一、硬件连接

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/89bd01c00703440ebad2848d03bd25f2.png)

## 二、配置内核

默认是选中的
（可以跳过这一步）
  
在linux源代码下执行

```c
make menuconfig

```

选中 <*> Solomon SSD1307 framebuffer support
  
**直接搜索 FB_SSD1307**

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/ff579d5bf6a616c23c147d76d3d44264.png)
  
按1进入

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/061c5fa27859e13f63b646f39caa3762.png)

## 三、修改设备树文件

添加ssd1306fb-i2c节点，0x3c是i2c设备的地址

在sun8i-v3s-licheepi-zero-dock.dts中添加：

```c
	ssd1306fb: ssd1306fb@3c {
        compatible = "solomon,ssd1306fb-i2c";
        reg = <0x3c>;
        solomon,width = <128>;
        solomon,height = <64>;
       /* reset-gpios = <&pio 1 0 GPIO_ACTIVE_HIGH>;*/  // 没有使用复位引脚 
        solomon,page-offset = <0>;
        solomon,com-invdir;
    };

```

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/673017fad6cf7f507ac929ec7322026f.png)
  
编译内核和编译dtb
  
因为内核没有修改，这里只编译设备树

```c
make dtbs

```

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/9a729e45ede7376e32df9aa9ee195c48.png)
  
然后将设备树拷贝到开发板上，上电

## 四、运行测试

### 1. 打印日志

**可以看到打印的日志：**
  
![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/b6f414d9b20854f690f3e82cd7b3fcab.png)
  
然后可以看到OLED有一个横杠闪烁。

### 2.简单操作

驱动注册后一般会挂载为/dev/fb0或者/dev/fb1设备文件。
  
我们查看一下
  
![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/467a23fa88b7ac759af3cad7cc4508f3.png)
  
可以看到我们有两个fb设备，因为我有两个屏幕。

这里可以简单测试一下。

**随机数：执行这个命令会让屏幕出现花屏现象，fb1可以改为fb0，这样可以看出两个屏幕的变化。**

```c
cat /dev/urandom > /dev/fb1

```

**清屏：执行这个命令会让屏幕不显示**

```c
cat /dev/zero > /dev/fb1

```

### 2. 编写测试demo

写一个简单的oled模块测试程序，读取屏幕信息，并刷将荔枝派logo显示上去效果如下：

```c
#include <unistd.h>
#include <stdio.h>
#include <fcntl.h>
#include <linux/fb.h>
#include <sys/mman.h>
#include <stdlib.h>
#include <string.h>
#include <sys/ioctl.h>

	/*seconds: the seconds; mseconds: the micro seconds*/
	void setTimer(int seconds, int mseconds)
{
	struct timeval temp;
	temp.tv_sec = seconds;
	temp.tv_usec = mseconds;
	printf("timer1\n");
	select(0, NULL, NULL, NULL, &temp);
	printf("timer2\n");
	return ;
}

int main ()
{
	char lichee[] = {
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0xE0,0x00,0x04,0x00,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x60,0x00,0x06,0x00,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x40,0x00,0x04,0x00,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x40,0x00,0x00,0x00,0x04,0x00,0x00,0x00,0x00,0x06,0x00,0x00,0x00,0x00,0x00,0x00,
		0x40,0x00,0x00,0x00,0x04,0x00,0x00,0x00,0x00,0x07,0x00,0x00,0x00,0x00,0x00,0x00,
		0x40,0x00,0x00,0x00,0x04,0x00,0x00,0x00,0xC0,0x0F,0x00,0x00,0x00,0x00,0x00,0x00,
		0x40,0x00,0x07,0x3C,0x74,0xE0,0x81,0x03,0xE0,0x0F,0x00,0x00,0x00,0x00,0x00,0x00,
		0x40,0x00,0x04,0x22,0x8C,0x10,0x43,0x04,0xF0,0x1F,0x00,0x00,0x00,0x00,0x00,0x00,
		0x40,0x00,0x04,0x42,0x84,0x10,0x22,0x0C,0xF8,0x1F,0x00,0x00,0x00,0x00,0x00,0x00,
		0x40,0x00,0x04,0x03,0x84,0x08,0x22,0x08,0xFC,0x3F,0x00,0x00,0x00,0x00,0x00,0x00,
		0x40,0x00,0x04,0x01,0x84,0x18,0x22,0x08,0xFE,0x3F,0x00,0x00,0x00,0x00,0x00,0x00,
		0x40,0x00,0x04,0x01,0x84,0x18,0x20,0x00,0xFE,0x7F,0x00,0x00,0x00,0x00,0x00,0x00,
		0x40,0x00,0x04,0x01,0x84,0x08,0x20,0x00,0xFE,0x7F,0x00,0x00,0x00,0x00,0x00,0x00,
		0x40,0x10,0x04,0x03,0x84,0x18,0x20,0x00,0xFE,0xFF,0x00,0x00,0x00,0x00,0x00,0x08,
		0x40,0x10,0x04,0x02,0x84,0x10,0x22,0x00,0xFF,0xFF,0x01,0x00,0x00,0x00,0x00,0x0C,
		0x40,0x18,0x04,0x06,0x84,0x30,0x40,0x04,0xFF,0xFF,0x03,0x00,0x00,0x00,0x00,0x06,
		0xE0,0x0F,0x1F,0x1C,0xCE,0xC1,0x80,0x03,0xFF,0xFF,0x07,0x00,0x00,0x00,0x00,0x07,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0xFF,0xFF,0x0F,0x00,0x00,0x00,0x80,0x07,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0xBF,0xFF,0x1F,0x00,0x00,0x00,0xC0,0x07,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0xDF,0xFF,0x7F,0x00,0x00,0x00,0xE0,0x07,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0xC7,0xFF,0xFF,0x00,0x00,0x00,0xF0,0x03,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0xC9,0xFF,0xFF,0x01,0x00,0x00,0xF0,0x03,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x40,0xC0,0xFF,0xFF,0x03,0x00,0x00,0xF8,0x03,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0xC0,0xFF,0xFF,0x07,0x00,0x00,0xF0,0x03,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x40,0xC0,0xF7,0xFF,0x0F,0x00,0x00,0xF8,0x03,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0xE3,0xFF,0xFF,0x1F,0x00,0x00,0xF8,0x01,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0xEF,0xFF,0xFF,0x7F,0x00,0x00,0xF8,0x01,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0xFB,0xFF,0xFF,0xFF,0x00,0x00,0xFC,0x01,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0xFF,0xFF,0xFF,0xFF,0x03,0x00,0xFC,0x00,
		0x40,0x30,0x00,0x06,0x04,0x00,0x00,0x80,0xFF,0xFF,0xFF,0xFF,0x07,0x00,0xFE,0x00,
		0x40,0x10,0x02,0x06,0x04,0xC0,0x00,0x9C,0xFF,0xFF,0xFF,0xFF,0x0F,0x00,0xFF,0x00,
		0xFE,0xFF,0x07,0x06,0x04,0x80,0xC8,0x81,0xFF,0xFF,0xFF,0xFF,0x3F,0x00,0x7F,0x00,
		0x40,0x10,0x00,0x06,0x04,0x80,0x08,0x00,0xFF,0xFF,0xFF,0xFF,0x7F,0x80,0x7F,0x00,
		0x40,0x13,0x00,0x16,0xCC,0x00,0x08,0x10,0xFF,0xFF,0xFF,0xFF,0xFF,0xC0,0x7F,0x00,
		0x00,0xC3,0xC0,0x3F,0x04,0x00,0x08,0x0E,0xFE,0xFF,0xFF,0xFF,0xFF,0xE3,0x3F,0x00,
		0x00,0xC1,0x00,0x06,0x04,0x10,0x48,0x00,0xFE,0xFF,0xFF,0xFF,0xFF,0xF7,0x3F,0x00,
		0x80,0x41,0x00,0x06,0x04,0x20,0x49,0x00,0xFE,0xFF,0xFF,0xFF,0xFF,0xFF,0x3F,0x00,
		0x80,0x40,0x00,0x0E,0x44,0x20,0x48,0x30,0xFC,0xFF,0xFF,0xFF,0xFF,0xFF,0x3F,0x00,
		0x60,0x78,0x00,0x9F,0x61,0x80,0x48,0x08,0xF8,0xFF,0xFF,0xFF,0xFF,0xFF,0x3F,0x00,
		0x38,0x30,0x00,0x17,0x60,0x80,0x48,0x02,0xF8,0xFF,0xFF,0xFF,0xFF,0xFF,0x3F,0x00,
		0x20,0x60,0x00,0x17,0x21,0x80,0x48,0x02,0xF0,0xFF,0xFF,0xFF,0xFF,0xFF,0x1F,0x00,
		0xFE,0xFB,0x83,0x06,0x30,0x40,0x48,0x02,0xE0,0xFF,0xFF,0xFF,0xFF,0xFF,0x1F,0x00,
		0x30,0x23,0x02,0x06,0x12,0x70,0x44,0x04,0xC0,0xFF,0xFF,0xFF,0xFF,0xFF,0x0F,0x00,
		0x30,0x23,0x42,0x06,0x1A,0x60,0x44,0x04,0x80,0xFF,0xFF,0xFF,0xFF,0xFF,0x07,0x00,
		0x10,0x31,0x02,0x06,0x0C,0x40,0x44,0x08,0x80,0xFF,0xFF,0xFF,0xFF,0xFF,0x03,0x00,
		0x18,0x11,0x03,0x06,0x0E,0x60,0x42,0x18,0xC0,0xFF,0xFF,0xFF,0xFF,0xFF,0x01,0x00,
		0x88,0x19,0x03,0x06,0x31,0x60,0xC2,0x30,0xE0,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,
		0xC4,0xCD,0x01,0x86,0xE0,0x61,0x41,0x20,0xE0,0xFF,0xFF,0xFF,0xFF,0x7F,0x00,0x00,
		0x00,0x82,0x01,0x36,0x80,0x00,0x00,0x00,0xF0,0xFF,0xFF,0xFF,0xFF,0x1F,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xE0,0x9F,0xFF,0xFF,0xFF,0x07,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x0F,0xFF,0xFF,0xFF,0x01,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0xFC,0xFF,0x7F,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xF0,0xFF,0x0F,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xF8,0x7F,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xE0,0x01,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
	};
	int fp=0;
	long screensize=0;

	char *fbp = 0;

	struct fb_var_screeninfo vinfo;
	struct fb_fix_screeninfo finfo;
	fp = open ("/dev/fb0",O_RDWR);

	if (fp < 0){
		printf("Error : Can not open framebuffer device/n");
		exit(1);
	}

	if (ioctl(fp,FBIOGET_FSCREENINFO,&finfo)){
		printf("Error reading fixed information/n");
		exit(2);
	}

	if (ioctl(fp,FBIOGET_VSCREENINFO,&vinfo)){
		printf("Error reading variable information/n");
		exit(3);
	}

	printf("The mem is :%d\n",finfo.smem_len);
	printf("The line_length is :%d\n",finfo.line_length);
	printf("The xres is :%d\n",vinfo.xres);
	printf("The yres is :%d\n",vinfo.yres);
	printf("bits_per_pixel is :%d\n",vinfo.bits_per_pixel);

	screensize = vinfo.xres * vinfo.yres * vinfo.bits_per_pixel / 8;
	printf("screensize: %d\n",screensize);
	fbp =(char *) mmap (0, screensize, PROT_READ | PROT_WRITE, MAP_SHARED,
		fp,0);
	if ((int) fbp == -1)
	{
		printf ("Error: failed to map framebuffer device to memory./n");
		exit (4);
	}

	int i=0;
	memset(fbp, 0x00, 1024);
	setTimer(3,0);
//	while(1){
		for(i=0;i<1024;i++){
			fbp[i]=lichee[i];
		}
		//setTimer(3,0);
	//	memset(fbp, 0x00, 1024);
	//	setTimer(3,0);
//	}
	munmap (fbp, screensize);
	close (fp);
}

```

编译，拷贝
  
运行
  
![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/ddbc90512d992efdf220aa1ca22e6470.png)
  
之后屏幕显示
  
![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/2ab5e5b298062ff58ace992021464eae.png)

## 五、关于tty测试

关于tty的讲解（暂时还没有搞明白）
  
这里有个链接
  
[tty](https://www.cnblogs.com/wangtianxj/archive/2009/08/27/1555296.html)

测试:
  
输入

```c
echo hello > /dev/tty0

```

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/e3e64c27c8c735390049130d7d19f43f.png)
  
会在OLED上显示输入的字符
  
![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/2951858de79896fd0c578eb972214084.png)

## 六、修改屏幕显示终端信息

在uboot修改bootargs

```c
setenv bootargs root=/dev/nfs rw nfsroot=192.168.1.4:/home/luatao/linux/nfs/rootfs ip=192.168.1.50:192.168.1.4:192.168.1.1:255.255.255.0::eth0:off init=/linuxrc console=ttyS0,115200 console=tty0

```

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/a33ae764d8b5dbaf3237e9c7c7b7b809.png)
  
在屏幕上就会打印出启动的信息，但实在是太慢了。（受不了）
  
![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/ff6aa5bb3fe1a1ab26267895cb4975ef.png)
  
还是改回去

```c
setenv bootargs root=/dev/nfs rw nfsroot=192.168.1.4:/home/luatao/linux/nfs/rootfs ip=192.168.1.50:192.168.1.4:192.168.1.1:255.255.255.0::eth0:off init=/linuxrc console=ttyS0,115200

```

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/2cd46302a93d339bb49da34da7a1adb6.png)
  
到这就基本完成了。

## 参考链接

<https://www.kancloud.cn/lichee/lpi0/326953>