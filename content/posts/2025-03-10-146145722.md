---
layout: post
title: "transformer模型介绍大语言模型-LLMBook-学习二"
date: 2025-03-10 12:14:03 +0800
description: "位置编码采用。"
keywords: "大语言模型 注意力机制"
categories: ['大模型从入门到实战', 'Yk']
tags: ['语言模型', '学习', 'Transformer']
artid: "146145722"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146145722
    alt: "transformer模型介绍大语言模型-LLMBook-学习二"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146145722
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146145722
cover: https://bing.ee123.net/img/rand?artid=146145722
image: https://bing.ee123.net/img/rand?artid=146145722
img: https://bing.ee123.net/img/rand?artid=146145722
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     transformer模型介绍——大语言模型 LLMBook 学习（二）
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h3>
     <a id="1_transformer_0">
     </a>
     1. transformer模型
    </h3>
    <h4>
     <a id="11__1">
     </a>
     1.1 注意力机制
    </h4>
    <p>
     **注意力机制（Attention Mechanism）**在人工智能中的应用，实际上是对人类认知系统中的注意力机制的一种模拟。它主要模仿了人类在处理信息时的选择性注意（Selective Attention），即我们不会平均分配注意力，而是会集中关注关键信息。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/179412443ea746008155f60db1fa345b.png"/>
    </p>
    <h4>
     <a id="12__4">
     </a>
     1.2 注意力机制原理
    </h4>
    <p>
     注意力机制是一种
     <strong>
      动态加权机制
     </strong>
     ，用于在输入数据中
     <strong>
      选取最相关的信息
     </strong>
     ，并赋予不同的权重。它最初用于
     <strong>
      神经机器翻译（Neural Machine Translation, NMT）
     </strong>
     ，后来广泛应用于
     <strong>
      自然语言处理（NLP）、计算机视觉（CV）和异常检测
     </strong>
     等任务。
    </p>
    <hr/>
    <h5>
     <a id="1__9">
     </a>
     <strong>
      1. 注意力计算流程
     </strong>
    </h5>
    <p>
     如图所示，注意力机制主要包括
     <strong>
      Query（查询）、Key（键）、Value（值）
     </strong>
     三个核心概念，它们的计算过程分为
     <strong>
      三步
     </strong>
     ：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/bceab2b66f2d445c830e93bad69f2e1d.png"/>
    </p>
    <h6>
     <a id="_Query__Key__13">
     </a>
     <strong>
      第一步：计算 Query 和 Key 之间的相似度
     </strong>
    </h6>
    <ul>
     <li>
      我们用
      <strong>
       查询向量（Query，记作
       <span class="katex--inline">
        <span class="katex">
         <span class="katex-mathml">
          q 
          
         
        
          q
         </span>
         <span class="katex-html">
          <span class="base">
           <span class="strut" style="height: 0.625em; vertical-align: -0.1944em;">
           </span>
           <span class="mord mathnormal" style="margin-right: 0.0359em;">
            q
           </span>
          </span>
         </span>
        </span>
       </span>
      </strong>
      ，去匹配多个
      <strong>
       键向量（Keys，记作
       <span class="katex--inline">
        <span class="katex">
         <span class="katex-mathml">
          k 
           
          
            j 
           
          
         
        
          k_j
         </span>
         <span class="katex-html">
          <span class="base">
           <span class="strut" style="height: 0.9805em; vertical-align: -0.2861em;">
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.0315em;">
             k
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.3117em;">
                <span class="" style="top: -2.55em; margin-left: -0.0315em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                   j
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.2861em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </strong>
      ，计算它们的
      <strong>
       相似度
      </strong>
      。
     </li>
     <li>
      这里采用的是
      <strong>
       点积（Dot Product
      </strong>
      来度量相似度：
      <br/>
      <span class="katex--display">
       <span class="katex-display">
        <span class="katex">
         <span class="katex-mathml">
          e 
           
           
           
             i 
            
           
             j 
            
           
          
         
           = 
          
          
          
            q 
           
          
            T 
           
          
          
          
            k 
           
          
            j 
           
          
         
        
          e_{ij} = q^T k_j
         </span>
         <span class="katex-html">
          <span class="base">
           <span class="strut" style="height: 0.7167em; vertical-align: -0.2861em;">
           </span>
           <span class="mord">
            <span class="mord mathnormal">
             e
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.3117em;">
                <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mtight">
                   <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                    ij
                   </span>
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.2861em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
           <span class="mrel">
            =
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 1.1774em; vertical-align: -0.2861em;">
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.0359em;">
             q
            </span>
            <span class="msupsub">
             <span class="vlist-t">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.8913em;">
                <span class="" style="top: -3.113em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.1389em;">
                   T
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.0315em;">
             k
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.3117em;">
                <span class="" style="top: -2.55em; margin-left: -0.0315em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                   j
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.2861em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </li>
     <li>
      其中：
      <ul>
       <li>
        <span class="katex--inline">
         <span class="katex">
          <span class="katex-mathml">
           q 
           
          
         
           q
          </span>
          <span class="katex-html">
           <span class="base">
            <span class="strut" style="height: 0.625em; vertical-align: -0.1944em;">
            </span>
            <span class="mord mathnormal" style="margin-right: 0.0359em;">
             q
            </span>
           </span>
          </span>
         </span>
        </span>
        是查询向量（query）
       </li>
       <li>
        <span class="katex--inline">
         <span class="katex">
          <span class="katex-mathml">
           k 
            
           
             j 
            
           
          
         
           k_j
          </span>
          <span class="katex-html">
           <span class="base">
            <span class="strut" style="height: 0.9805em; vertical-align: -0.2861em;">
            </span>
            <span class="mord">
             <span class="mord mathnormal" style="margin-right: 0.0315em;">
              k
             </span>
             <span class="msupsub">
              <span class="vlist-t vlist-t2">
               <span class="vlist-r">
                <span class="vlist" style="height: 0.3117em;">
                 <span class="" style="top: -2.55em; margin-left: -0.0315em; margin-right: 0.05em;">
                  <span class="pstrut" style="height: 2.7em;">
                  </span>
                  <span class="sizing reset-size6 size3 mtight">
                   <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                    j
                   </span>
                  </span>
                 </span>
                </span>
                <span class="vlist-s">
                 ​
                </span>
               </span>
               <span class="vlist-r">
                <span class="vlist" style="height: 0.2861em;">
                 <span class="">
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
        是键向量（key）
       </li>
       <li>
        <span class="katex--inline">
         <span class="katex">
          <span class="katex-mathml">
           e 
            
            
            
              i 
             
            
              j 
             
            
           
          
         
           e_{ij}
          </span>
          <span class="katex-html">
           <span class="base">
            <span class="strut" style="height: 0.7167em; vertical-align: -0.2861em;">
            </span>
            <span class="mord">
             <span class="mord mathnormal">
              e
             </span>
             <span class="msupsub">
              <span class="vlist-t vlist-t2">
               <span class="vlist-r">
                <span class="vlist" style="height: 0.3117em;">
                 <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                  <span class="pstrut" style="height: 2.7em;">
                  </span>
                  <span class="sizing reset-size6 size3 mtight">
                   <span class="mord mtight">
                    <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                     ij
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
                <span class="vlist-s">
                 ​
                </span>
               </span>
               <span class="vlist-r">
                <span class="vlist" style="height: 0.2861em;">
                 <span class="">
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
        表示查询
        <span class="katex--inline">
         <span class="katex">
          <span class="katex-mathml">
           q 
           
          
         
           q
          </span>
          <span class="katex-html">
           <span class="base">
            <span class="strut" style="height: 0.625em; vertical-align: -0.1944em;">
            </span>
            <span class="mord mathnormal" style="margin-right: 0.0359em;">
             q
            </span>
           </span>
          </span>
         </span>
        </span>
        与键
        <span class="katex--inline">
         <span class="katex">
          <span class="katex-mathml">
           k 
            
           
             j 
            
           
          
         
           k_j
          </span>
          <span class="katex-html">
           <span class="base">
            <span class="strut" style="height: 0.9805em; vertical-align: -0.2861em;">
            </span>
            <span class="mord">
             <span class="mord mathnormal" style="margin-right: 0.0315em;">
              k
             </span>
             <span class="msupsub">
              <span class="vlist-t vlist-t2">
               <span class="vlist-r">
                <span class="vlist" style="height: 0.3117em;">
                 <span class="" style="top: -2.55em; margin-left: -0.0315em; margin-right: 0.05em;">
                  <span class="pstrut" style="height: 2.7em;">
                  </span>
                  <span class="sizing reset-size6 size3 mtight">
                   <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                    j
                   </span>
                  </span>
                 </span>
                </span>
                <span class="vlist-s">
                 ​
                </span>
               </span>
               <span class="vlist-r">
                <span class="vlist" style="height: 0.2861em;">
                 <span class="">
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
        的相似度得分
       </li>
      </ul>
     </li>
    </ul>
    <p>
     <strong>
      直观理解
     </strong>
     ：
    </p>
    <ul>
     <li>
      如果
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         q 
         
        
       
         q
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.625em; vertical-align: -0.1944em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0359em;">
           q
          </span>
         </span>
        </span>
       </span>
      </span>
      和
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         k 
          
         
           j 
          
         
        
       
         k_j
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.9805em; vertical-align: -0.2861em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.0315em;">
            k
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3117em;">
               <span class="" style="top: -2.55em; margin-left: -0.0315em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                  j
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.2861em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      方向相似（即表示的信息相似），则它们的点积
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         e 
          
          
          
            i 
           
          
            j 
           
          
         
        
       
         e_{ij}
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.7167em; vertical-align: -0.2861em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            e
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3117em;">
               <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                   ij
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.2861em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      会较大。
     </li>
     <li>
      反之，如果
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         q 
         
        
       
         q
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.625em; vertical-align: -0.1944em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0359em;">
           q
          </span>
         </span>
        </span>
       </span>
      </span>
      和
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         k 
          
         
           j 
          
         
        
       
         k_j
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.9805em; vertical-align: -0.2861em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.0315em;">
            k
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3117em;">
               <span class="" style="top: -2.55em; margin-left: -0.0315em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                  j
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.2861em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      方向不同，则
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         e 
          
          
          
            i 
           
          
            j 
           
          
         
        
       
         e_{ij}
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.7167em; vertical-align: -0.2861em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            e
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3117em;">
               <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                   ij
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.2861em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      会较小。
     </li>
    </ul>
    <h6>
     <a id="_Softmax__25">
     </a>
     <strong>
      第二步：将相似度进行 Softmax 归一化
     </strong>
    </h6>
    <ul>
     <li>
      由于点积计算出的相似度值
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         e 
          
          
          
            i 
           
          
            j 
           
          
         
        
       
         e_{ij}
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.7167em; vertical-align: -0.2861em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            e
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3117em;">
               <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                   ij
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.2861em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      可能较大，因此需要进行
      <strong>
       Softmax 归一化
      </strong>
      ，使其变成一个概率分布：
      <br/>
      <span class="katex--display">
       <span class="katex-display">
        <span class="katex">
         <span class="katex-mathml">
          a 
           
           
           
             i 
            
           
             j 
            
           
          
         
           = 
          
          
           
           
             exp 
            
           
             ⁡ 
            
           
             ( 
            
            
            
              e 
             
             
             
               i 
              
             
               j 
              
             
            
           
             ) 
            
           
           
            
            
              ∑ 
             
             
             
               j 
              
             
               ′ 
              
             
            
           
             exp 
            
           
             ⁡ 
            
           
             ( 
            
            
            
              e 
             
             
             
               i 
              
              
              
                j 
               
              
                ′ 
               
              
             
            
           
             ) 
            
           
          
         
        
          a_{ij} = \frac{\exp(e_{ij})}{\sum_{j'} \exp(e_{ij'})}
         </span>
         <span class="katex-html">
          <span class="base">
           <span class="strut" style="height: 0.7167em; vertical-align: -0.2861em;">
           </span>
           <span class="mord">
            <span class="mord mathnormal">
             a
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.3117em;">
                <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mtight">
                   <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                    ij
                   </span>
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.2861em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
           <span class="mrel">
            =
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 2.5488em; vertical-align: -1.1218em;">
           </span>
           <span class="mord">
            <span class="mopen nulldelimiter">
            </span>
            <span class="mfrac">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 1.427em;">
                <span class="" style="top: -2.314em;">
                 <span class="pstrut" style="height: 3em;">
                 </span>
                 <span class="mord">
                  <span class="mop">
                   <span class="mop op-symbol small-op" style="position: relative; top: 0em;">
                    ∑
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t vlist-t2">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.1783em;">
                       <span class="" style="top: -2.4003em; margin-left: 0em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mtight">
                          <span class="mord mtight">
                           <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                            j
                           </span>
                           <span class="msupsub">
                            <span class="vlist-t">
                             <span class="vlist-r">
                              <span class="vlist" style="height: 0.6828em;">
                               <span class="" style="top: -2.786em; margin-right: 0.0714em;">
                                <span class="pstrut" style="height: 2.5em;">
                                </span>
                                <span class="sizing reset-size3 size1 mtight">
                                 <span class="mord mtight">
                                  <span class="mord mtight">
                                   ′
                                  </span>
                                 </span>
                                </span>
                               </span>
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                      <span class="vlist-s">
                       ​
                      </span>
                     </span>
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.4358em;">
                       <span class="">
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                  <span class="mspace" style="margin-right: 0.1667em;">
                  </span>
                  <span class="mop">
                   exp
                  </span>
                  <span class="mopen">
                   (
                  </span>
                  <span class="mord">
                   <span class="mord mathnormal">
                    e
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t vlist-t2">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.328em;">
                       <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mtight">
                          <span class="mord mathnormal mtight">
                           i
                          </span>
                          <span class="mord mtight">
                           <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                            j
                           </span>
                           <span class="msupsub">
                            <span class="vlist-t">
                             <span class="vlist-r">
                              <span class="vlist" style="height: 0.6828em;">
                               <span class="" style="top: -2.786em; margin-right: 0.0714em;">
                                <span class="pstrut" style="height: 2.5em;">
                                </span>
                                <span class="sizing reset-size3 size1 mtight">
                                 <span class="mord mtight">
                                  <span class="mord mtight">
                                   ′
                                  </span>
                                 </span>
                                </span>
                               </span>
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                      <span class="vlist-s">
                       ​
                      </span>
                     </span>
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.2861em;">
                       <span class="">
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                  <span class="mclose">
                   )
                  </span>
                 </span>
                </span>
                <span class="" style="top: -3.23em;">
                 <span class="pstrut" style="height: 3em;">
                 </span>
                 <span class="frac-line" style="border-bottom-width: 0.04em;">
                 </span>
                </span>
                <span class="" style="top: -3.677em;">
                 <span class="pstrut" style="height: 3em;">
                 </span>
                 <span class="mord">
                  <span class="mop">
                   exp
                  </span>
                  <span class="mopen">
                   (
                  </span>
                  <span class="mord">
                   <span class="mord mathnormal">
                    e
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t vlist-t2">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.3117em;">
                       <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mtight">
                          <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                           ij
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                      <span class="vlist-s">
                       ​
                      </span>
                     </span>
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.2861em;">
                       <span class="">
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                  <span class="mclose">
                   )
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 1.1218em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
            <span class="mclose nulldelimiter">
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </li>
     <li>
      这样可以确保所有注意力权重
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         a 
          
          
          
            i 
           
          
            j 
           
          
         
        
       
         a_{ij}
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.7167em; vertical-align: -0.2861em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            a
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3117em;">
               <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                   ij
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.2861em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      <strong>
       的总和为 1
      </strong>
      ，便于后续加权计算。
     </li>
    </ul>
    <p>
     <strong>
      直观理解
     </strong>
     ：
    </p>
    <ul>
     <li>
      Softmax 归一化后，最相关的 Key 对应的权重
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         a 
          
          
          
            i 
           
          
            j 
           
          
         
        
       
         a_{ij}
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.7167em; vertical-align: -0.2861em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            a
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3117em;">
               <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                   ij
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.2861em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      会更大，而不相关的 Key 权重会接近 0。
     </li>
    </ul>
    <hr/>
    <h6>
     <a id="_Value_37">
     </a>
     <strong>
      第三步：加权求和 Value
     </strong>
    </h6>
    <ul>
     <li>
      计算出的注意力权重
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         a 
          
          
          
            i 
           
          
            j 
           
          
         
        
       
         a_{ij}
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.7167em; vertical-align: -0.2861em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            a
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3117em;">
               <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                   ij
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.2861em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      作用于对应的 Value（值向量），最终得到输出：
      <br/>
      <span class="katex--display">
       <span class="katex-display">
        <span class="katex">
         <span class="katex-mathml">
          o 
           
          
            i 
           
          
         
           = 
          
          
          
            ∑ 
           
          
            j 
           
          
          
          
            a 
           
           
           
             i 
            
           
             j 
            
           
          
          
          
            v 
           
          
            j 
           
          
         
        
          o_i = \sum_{j} a_{ij} v_j
         </span>
         <span class="katex-html">
          <span class="base">
           <span class="strut" style="height: 0.5806em; vertical-align: -0.15em;">
           </span>
           <span class="mord">
            <span class="mord mathnormal">
             o
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.3117em;">
                <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mathnormal mtight">
                   i
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.15em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
           <span class="mrel">
            =
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 2.4638em; vertical-align: -1.4138em;">
           </span>
           <span class="mop op-limits">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 1.05em;">
               <span class="" style="top: -1.8723em; margin-left: 0em;">
                <span class="pstrut" style="height: 3.05em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                   j
                  </span>
                 </span>
                </span>
               </span>
               <span class="" style="top: -3.05em;">
                <span class="pstrut" style="height: 3.05em;">
                </span>
                <span class="">
                 <span class="mop op-symbol large-op">
                  ∑
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 1.4138em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mspace" style="margin-right: 0.1667em;">
           </span>
           <span class="mord">
            <span class="mord mathnormal">
             a
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.3117em;">
                <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mtight">
                   <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                    ij
                   </span>
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.2861em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.0359em;">
             v
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.3117em;">
                <span class="" style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                   j
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.2861em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </li>
     <li>
      其中：
      <ul>
       <li>
        <span class="katex--inline">
         <span class="katex">
          <span class="katex-mathml">
           v 
            
           
             j 
            
           
          
         
           v_j
          </span>
          <span class="katex-html">
           <span class="base">
            <span class="strut" style="height: 0.7167em; vertical-align: -0.2861em;">
            </span>
            <span class="mord">
             <span class="mord mathnormal" style="margin-right: 0.0359em;">
              v
             </span>
             <span class="msupsub">
              <span class="vlist-t vlist-t2">
               <span class="vlist-r">
                <span class="vlist" style="height: 0.3117em;">
                 <span class="" style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;">
                  <span class="pstrut" style="height: 2.7em;">
                  </span>
                  <span class="sizing reset-size6 size3 mtight">
                   <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                    j
                   </span>
                  </span>
                 </span>
                </span>
                <span class="vlist-s">
                 ​
                </span>
               </span>
               <span class="vlist-r">
                <span class="vlist" style="height: 0.2861em;">
                 <span class="">
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
        是对应的值向量（value）
       </li>
       <li>
        <span class="katex--inline">
         <span class="katex">
          <span class="katex-mathml">
           o 
            
           
             i 
            
           
          
         
           o_i
          </span>
          <span class="katex-html">
           <span class="base">
            <span class="strut" style="height: 0.5806em; vertical-align: -0.15em;">
            </span>
            <span class="mord">
             <span class="mord mathnormal">
              o
             </span>
             <span class="msupsub">
              <span class="vlist-t vlist-t2">
               <span class="vlist-r">
                <span class="vlist" style="height: 0.3117em;">
                 <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                  <span class="pstrut" style="height: 2.7em;">
                  </span>
                  <span class="sizing reset-size6 size3 mtight">
                   <span class="mord mathnormal mtight">
                    i
                   </span>
                  </span>
                 </span>
                </span>
                <span class="vlist-s">
                 ​
                </span>
               </span>
               <span class="vlist-r">
                <span class="vlist" style="height: 0.15em;">
                 <span class="">
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
        是最终的加权求和结果（即注意力输出）
       </li>
      </ul>
     </li>
    </ul>
    <p>
     <strong>
      直观理解
     </strong>
     ：
    </p>
    <ul>
     <li>
      这个过程类似于
      <strong>
       信息检索
      </strong>
      ，即：
      <ul>
       <li>
        如果某个 Key 与 Query 相似度高（即权重
        <span class="katex--inline">
         <span class="katex">
          <span class="katex-mathml">
           a 
            
            
            
              i 
             
            
              j 
             
            
           
          
         
           a_{ij}
          </span>
          <span class="katex-html">
           <span class="base">
            <span class="strut" style="height: 0.7167em; vertical-align: -0.2861em;">
            </span>
            <span class="mord">
             <span class="mord mathnormal">
              a
             </span>
             <span class="msupsub">
              <span class="vlist-t vlist-t2">
               <span class="vlist-r">
                <span class="vlist" style="height: 0.3117em;">
                 <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                  <span class="pstrut" style="height: 2.7em;">
                  </span>
                  <span class="sizing reset-size6 size3 mtight">
                   <span class="mord mtight">
                    <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                     ij
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
                <span class="vlist-s">
                 ​
                </span>
               </span>
               <span class="vlist-r">
                <span class="vlist" style="height: 0.2861em;">
                 <span class="">
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
        大），那么它的 Value（
        <span class="katex--inline">
         <span class="katex">
          <span class="katex-mathml">
           v 
            
           
             j 
            
           
          
         
           v_j
          </span>
          <span class="katex-html">
           <span class="base">
            <span class="strut" style="height: 0.7167em; vertical-align: -0.2861em;">
            </span>
            <span class="mord">
             <span class="mord mathnormal" style="margin-right: 0.0359em;">
              v
             </span>
             <span class="msupsub">
              <span class="vlist-t vlist-t2">
               <span class="vlist-r">
                <span class="vlist" style="height: 0.3117em;">
                 <span class="" style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;">
                  <span class="pstrut" style="height: 2.7em;">
                  </span>
                  <span class="sizing reset-size6 size3 mtight">
                   <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                    j
                   </span>
                  </span>
                 </span>
                </span>
                <span class="vlist-s">
                 ​
                </span>
               </span>
               <span class="vlist-r">
                <span class="vlist" style="height: 0.2861em;">
                 <span class="">
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
        ） 会被
        <strong>
         重点关注
        </strong>
        。
       </li>
       <li>
        最终的输出
        <span class="katex--inline">
         <span class="katex">
          <span class="katex-mathml">
           o 
            
           
             i 
            
           
          
         
           o_i
          </span>
          <span class="katex-html">
           <span class="base">
            <span class="strut" style="height: 0.5806em; vertical-align: -0.15em;">
            </span>
            <span class="mord">
             <span class="mord mathnormal">
              o
             </span>
             <span class="msupsub">
              <span class="vlist-t vlist-t2">
               <span class="vlist-r">
                <span class="vlist" style="height: 0.3117em;">
                 <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                  <span class="pstrut" style="height: 2.7em;">
                  </span>
                  <span class="sizing reset-size6 size3 mtight">
                   <span class="mord mathnormal mtight">
                    i
                   </span>
                  </span>
                 </span>
                </span>
                <span class="vlist-s">
                 ​
                </span>
               </span>
               <span class="vlist-r">
                <span class="vlist" style="height: 0.15em;">
                 <span class="">
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
        是所有 Value 的
        <strong>
         加权平均
        </strong>
        。
       </li>
      </ul>
     </li>
    </ul>
    <hr/>
    <h5>
     <a id="2__51">
     </a>
     <strong>
      2. 直观理解
     </strong>
    </h5>
    <p>
     可以把
     <strong>
      注意力机制
     </strong>
     类比为
     <strong>
      搜索引擎
     </strong>
     ：
    </p>
    <ul>
     <li>
      <strong>
       Query（查询）
      </strong>
      ：用户输入的搜索关键词（如 “Transformer 论文”）。
     </li>
     <li>
      <strong>
       Keys（键）
      </strong>
      ：数据库中的所有文档标题（如 “Attention is All You Need”）。
     </li>
     <li>
      <strong>
       Values（值）
      </strong>
      ：数据库中的所有文档内容（如 Transformer 论文的正文）。
     </li>
     <li>
      <strong>
       计算相似度
      </strong>
      ：搜索引擎会计算用户输入的关键词与文档标题的相关性。
     </li>
     <li>
      <strong>
       Softmax 归一化
      </strong>
      ：搜索引擎会给每个文档一个相关性分数，并归一化为一个排名概率。
     </li>
     <li>
      <strong>
       加权求和
      </strong>
      ：最终，搜索引擎会按照相关性高低，返回最相关的文档内容。
     </li>
    </ul>
    <hr/>
    <h5>
     <a id="3__Transformer__62">
     </a>
     <strong>
      3. 在 Transformer 中的应用
     </strong>
    </h5>
    <p>
     在
     <strong>
      Transformer
     </strong>
     结构（如 BERT、GPT）中，
     <br/>
     注意力机制被用于自注意力
     <strong>
      Self-Attention
     </strong>
     计算：
    </p>
    <ul>
     <li>
      <strong>
       输入是一个句子
      </strong>
      ，每个单词都有一个 Query、Key、Value。
     </li>
     <li>
      <strong>
       计算 Query 与所有 Key 的相似度
      </strong>
      ，确定哪些单词对当前单词最重要。
     </li>
     <li>
      <strong>
       对 Value 进行加权求和
      </strong>
      ，生成新的单词表示。
     </li>
    </ul>
    <p>
     <strong>
      示例
     </strong>
     ：
    </p>
    <ul>
     <li>
      句子：
      <strong>
       “The cat sat on the mat.”
      </strong>
     </li>
     <li>
      计算 “cat” 的注意力：
      <ul>
       <li>
        “cat” 可能关注 “The” 和 “sat” 的信息，而忽略 “mat”。
       </li>
       <li>
        Transformer 通过注意力机制
        <strong>
         动态调整单词之间的关系
        </strong>
        ，提高理解能力。
       </li>
      </ul>
     </li>
    </ul>
    <hr/>
    <h5>
     <a id="4__77">
     </a>
     <strong>
      4. 计算复杂度
     </strong>
    </h5>
    <ul>
     <li>
      <strong>
       传统 RNN 计算复杂度：( O(n) )
      </strong>
      （必须按顺序计算）
     </li>
     <li>
      <strong>
       Transformer 注意力计算复杂度：( O(n^2) )
      </strong>
      （可以并行计算）
     </li>
    </ul>
    <p>
     虽然 Transformer 的注意力计算复杂度较高，但由于可以
     <strong>
      并行计算
     </strong>
     ，在实际应用中比 RNN 更高效。
    </p>
    <hr/>
    <h4>
     <a id="13__85">
     </a>
     1.3 编码器
    </h4>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/9b49333f192d4016a27d0dc0295c182c.png"/>
    </p>
    <h5>
     <a id="1__88">
     </a>
     <strong>
      1. 编码器的作用
     </strong>
    </h5>
    <p>
     编码器（Encoder）是 Transformer 结构的核心组件之一，它的主要作用是
     <strong>
      将输入数据转换为隐藏层特征
     </strong>
     ，以便后续的解码器（Decoder）进一步处理或用于下游任务（如分类、翻译等）。
    </p>
    <p>
     在 Transformer 结构中，编码器由
     <strong>
      N 个堆叠的编码器层（Encoder Layers）
     </strong>
     组成，每个编码器层都包含：
    </p>
    <ul>
     <li>
      <strong>
       多头注意力机制（Multi-Head Attention, MHA）
      </strong>
     </li>
     <li>
      <strong>
       前馈神经网络（Feed Forward Network, FFN）
      </strong>
     </li>
     <li>
      <strong>
       残差连接（Residual Connection）和层归一化（Layer Normalization）
      </strong>
     </li>
    </ul>
    <hr/>
    <h5>
     <a id="2__97">
     </a>
     <strong>
      2. 编码器的结构
     </strong>
    </h5>
    <p>
     编码器的计算流程如下：
    </p>
    <h6>
     <a id="1MultiHead_Attention_MHA_99">
     </a>
     <strong>
      （1）多头注意力（Multi-Head Attention, MHA）
     </strong>
    </h6>
    <ul>
     <li>
      计算输入序列中每个词对其他词的注意力权重，提取全局依赖关系。
     </li>
     <li>
      采用
      <strong>
       多头注意力机制
      </strong>
      （多个注意力头并行计算），以学习不同的特征表示。
     </li>
    </ul>
    <h6>
     <a id="2___103">
     </a>
     <strong>
      （2）残差连接 + 层归一化
     </strong>
    </h6>
    <ul>
     <li>
      计算多头注意力的输出后，使用
      <strong>
       残差连接
      </strong>
      （Residual Connection）：
      <br/>
      <span class="katex--display">
       <span class="katex-display">
        <span class="katex">
         <span class="katex-mathml">
          X 
           
          
            l 
           
          
            ′ 
           
          
         
           = 
          
         
           LayerNorm 
          
         
           ( 
          
         
           MHA 
          
         
           ( 
          
          
          
            X 
           
           
           
             l 
            
           
             − 
            
           
             1 
            
           
          
         
           ) 
          
         
           + 
          
          
          
            X 
           
           
           
             l 
            
           
             − 
            
           
             1 
            
           
          
         
           ) 
          
         
        
          X'_l = \text{LayerNorm}(\text{MHA}(X_{l-1}) + X_{l-1})
         </span>
         <span class="katex-html">
          <span class="base">
           <span class="strut" style="height: 1.0489em; vertical-align: -0.247em;">
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.0785em;">
             X
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.8019em;">
                <span class="" style="top: -2.453em; margin-left: -0.0785em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0197em;">
                   l
                  </span>
                 </span>
                </span>
                <span class="" style="top: -3.113em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mtight">
                   <span class="mord mtight">
                    ′
                   </span>
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.247em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
           <span class="mrel">
            =
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 1em; vertical-align: -0.25em;">
           </span>
           <span class="mord text">
            <span class="mord">
             LayerNorm
            </span>
           </span>
           <span class="mopen">
            (
           </span>
           <span class="mord text">
            <span class="mord">
             MHA
            </span>
           </span>
           <span class="mopen">
            (
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.0785em;">
             X
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.3361em;">
                <span class="" style="top: -2.55em; margin-left: -0.0785em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mtight">
                   <span class="mord mathnormal mtight" style="margin-right: 0.0197em;">
                    l
                   </span>
                   <span class="mbin mtight">
                    −
                   </span>
                   <span class="mord mtight">
                    1
                   </span>
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.2083em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mclose">
            )
           </span>
           <span class="mspace" style="margin-right: 0.2222em;">
           </span>
           <span class="mbin">
            +
           </span>
           <span class="mspace" style="margin-right: 0.2222em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 1em; vertical-align: -0.25em;">
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.0785em;">
             X
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.3361em;">
                <span class="" style="top: -2.55em; margin-left: -0.0785em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mtight">
                   <span class="mord mathnormal mtight" style="margin-right: 0.0197em;">
                    l
                   </span>
                   <span class="mbin mtight">
                    −
                   </span>
                   <span class="mord mtight">
                    1
                   </span>
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.2083em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mclose">
            )
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      <br/>
      其中：
      <ul>
       <li>
        <span class="katex--inline">
         <span class="katex">
          <span class="katex-mathml">
           X 
            
            
            
              l 
             
            
              − 
             
            
              1 
             
            
           
          
         
           X_{l-1}
          </span>
          <span class="katex-html">
           <span class="base">
            <span class="strut" style="height: 0.8917em; vertical-align: -0.2083em;">
            </span>
            <span class="mord">
             <span class="mord mathnormal" style="margin-right: 0.0785em;">
              X
             </span>
             <span class="msupsub">
              <span class="vlist-t vlist-t2">
               <span class="vlist-r">
                <span class="vlist" style="height: 0.3361em;">
                 <span class="" style="top: -2.55em; margin-left: -0.0785em; margin-right: 0.05em;">
                  <span class="pstrut" style="height: 2.7em;">
                  </span>
                  <span class="sizing reset-size6 size3 mtight">
                   <span class="mord mtight">
                    <span class="mord mathnormal mtight" style="margin-right: 0.0197em;">
                     l
                    </span>
                    <span class="mbin mtight">
                     −
                    </span>
                    <span class="mord mtight">
                     1
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
                <span class="vlist-s">
                 ​
                </span>
               </span>
               <span class="vlist-r">
                <span class="vlist" style="height: 0.2083em;">
                 <span class="">
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
        是上一层的输出
       </li>
       <li>
        MHA 是多头注意力
       </li>
       <li>
        LayerNorm 是层归一化，防止梯度消失或梯度爆炸
       </li>
      </ul>
     </li>
    </ul>
    <h6>
     <a id="3Feed_Forward_Network_FFN_111">
     </a>
     <strong>
      （3）前馈神经网络（Feed Forward Network, FFN）
     </strong>
    </h6>
    <ul>
     <li>
      由两个全连接层（MLP）组成：
      <br/>
      <span class="katex--display">
       <span class="katex-display">
        <span class="katex">
         <span class="katex-mathml">
          FFN 
          
         
           ( 
          
          
          
            X 
           
          
            ′ 
           
          
         
           ) 
          
         
           = 
          
         
           ReLU 
          
         
           ( 
          
          
          
            X 
           
          
            ′ 
           
          
          
          
            W 
           
          
            1 
           
          
         
           + 
          
          
          
            b 
           
          
            1 
           
          
         
           ) 
          
          
          
            W 
           
          
            2 
           
          
         
           + 
          
          
          
            b 
           
          
            2 
           
          
         
        
          \text{FFN}(X') = \text{ReLU}(X' W_1 + b_1) W_2 + b_2
         </span>
         <span class="katex-html">
          <span class="base">
           <span class="strut" style="height: 1.0519em; vertical-align: -0.25em;">
           </span>
           <span class="mord text">
            <span class="mord">
             FFN
            </span>
           </span>
           <span class="mopen">
            (
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.0785em;">
             X
            </span>
            <span class="msupsub">
             <span class="vlist-t">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.8019em;">
                <span class="" style="top: -3.113em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mtight">
                   <span class="mord mtight">
                    ′
                   </span>
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mclose">
            )
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
           <span class="mrel">
            =
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 1.0519em; vertical-align: -0.25em;">
           </span>
           <span class="mord text">
            <span class="mord">
             ReLU
            </span>
           </span>
           <span class="mopen">
            (
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.0785em;">
             X
            </span>
            <span class="msupsub">
             <span class="vlist-t">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.8019em;">
                <span class="" style="top: -3.113em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mtight">
                   <span class="mord mtight">
                    ′
                   </span>
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.1389em;">
             W
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.3011em;">
                <span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mtight">
                   1
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.15em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mspace" style="margin-right: 0.2222em;">
           </span>
           <span class="mbin">
            +
           </span>
           <span class="mspace" style="margin-right: 0.2222em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 1em; vertical-align: -0.25em;">
           </span>
           <span class="mord">
            <span class="mord mathnormal">
             b
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.3011em;">
                <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mtight">
                   1
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.15em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mclose">
            )
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.1389em;">
             W
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.3011em;">
                <span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mtight">
                   2
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.15em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mspace" style="margin-right: 0.2222em;">
           </span>
           <span class="mbin">
            +
           </span>
           <span class="mspace" style="margin-right: 0.2222em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 0.8444em; vertical-align: -0.15em;">
           </span>
           <span class="mord">
            <span class="mord mathnormal">
             b
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.3011em;">
                <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mtight">
                   2
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.15em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </li>
     <li>
      作用是
      <strong>
       增加非线性变换能力
      </strong>
      ，提升模型的表达能力。
     </li>
    </ul>
    <h6>
     <a id="4___116">
     </a>
     <strong>
      （4）再次残差连接 + 层归一化
     </strong>
    </h6>
    <ul>
     <li>
      计算 FFN 输出后，再次应用残差连接：
      <br/>
      <span class="katex--display">
       <span class="katex-display">
        <span class="katex">
         <span class="katex-mathml">
          X 
           
          
            l 
           
          
         
           = 
          
         
           LayerNorm 
          
         
           ( 
          
         
           FFN 
          
         
           ( 
          
          
          
            X 
           
          
            l 
           
          
            ′ 
           
          
         
           ) 
          
         
           + 
          
          
          
            X 
           
          
            l 
           
          
            ′ 
           
          
         
           ) 
          
         
        
          X_l = \text{LayerNorm}(\text{FFN}(X'_l) + X'_l)
         </span>
         <span class="katex-html">
          <span class="base">
           <span class="strut" style="height: 0.8333em; vertical-align: -0.15em;">
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.0785em;">
             X
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.3361em;">
                <span class="" style="top: -2.55em; margin-left: -0.0785em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0197em;">
                   l
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.15em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
           <span class="mrel">
            =
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 1.0519em; vertical-align: -0.25em;">
           </span>
           <span class="mord text">
            <span class="mord">
             LayerNorm
            </span>
           </span>
           <span class="mopen">
            (
           </span>
           <span class="mord text">
            <span class="mord">
             FFN
            </span>
           </span>
           <span class="mopen">
            (
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.0785em;">
             X
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.8019em;">
                <span class="" style="top: -2.453em; margin-left: -0.0785em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0197em;">
                   l
                  </span>
                 </span>
                </span>
                <span class="" style="top: -3.113em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mtight">
                   <span class="mord mtight">
                    ′
                   </span>
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.247em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mclose">
            )
           </span>
           <span class="mspace" style="margin-right: 0.2222em;">
           </span>
           <span class="mbin">
            +
           </span>
           <span class="mspace" style="margin-right: 0.2222em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 1.0519em; vertical-align: -0.25em;">
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.0785em;">
             X
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.8019em;">
                <span class="" style="top: -2.453em; margin-left: -0.0785em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0197em;">
                   l
                  </span>
                 </span>
                </span>
                <span class="" style="top: -3.113em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mtight">
                   <span class="mord mtight">
                    ′
                   </span>
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.247em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mclose">
            )
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </li>
     <li>
      这样可以
      <strong>
       稳定梯度传递，提高训练效果
      </strong>
      。
     </li>
    </ul>
    <hr/>
    <h5>
     <a id="3__123">
     </a>
     <strong>
      3. 公式解析
     </strong>
    </h5>
    <p>
     从公式来看，编码器的计算流程可以分为两步：
    </p>
    <ol>
     <li>
      <strong>
       多头注意力层（MHA）+ 残差连接 + 层归一化
      </strong>
      <br/>
      <span class="katex--display">
       <span class="katex-display">
        <span class="katex">
         <span class="katex-mathml">
          X 
           
          
            l 
           
          
            ′ 
           
          
         
           = 
          
         
           LayerNorm 
          
         
           ( 
          
         
           MHA 
          
         
           ( 
          
          
          
            X 
           
           
           
             l 
            
           
             − 
            
           
             1 
            
           
          
         
           ) 
          
         
           + 
          
          
          
            X 
           
           
           
             l 
            
           
             − 
            
           
             1 
            
           
          
         
           ) 
          
         
        
          X'_l = \text{LayerNorm}(\text{MHA}(X_{l-1}) + X_{l-1})
         </span>
         <span class="katex-html">
          <span class="base">
           <span class="strut" style="height: 1.0489em; vertical-align: -0.247em;">
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.0785em;">
             X
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.8019em;">
                <span class="" style="top: -2.453em; margin-left: -0.0785em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0197em;">
                   l
                  </span>
                 </span>
                </span>
                <span class="" style="top: -3.113em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mtight">
                   <span class="mord mtight">
                    ′
                   </span>
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.247em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
           <span class="mrel">
            =
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 1em; vertical-align: -0.25em;">
           </span>
           <span class="mord text">
            <span class="mord">
             LayerNorm
            </span>
           </span>
           <span class="mopen">
            (
           </span>
           <span class="mord text">
            <span class="mord">
             MHA
            </span>
           </span>
           <span class="mopen">
            (
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.0785em;">
             X
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.3361em;">
                <span class="" style="top: -2.55em; margin-left: -0.0785em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mtight">
                   <span class="mord mathnormal mtight" style="margin-right: 0.0197em;">
                    l
                   </span>
                   <span class="mbin mtight">
                    −
                   </span>
                   <span class="mord mtight">
                    1
                   </span>
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.2083em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mclose">
            )
           </span>
           <span class="mspace" style="margin-right: 0.2222em;">
           </span>
           <span class="mbin">
            +
           </span>
           <span class="mspace" style="margin-right: 0.2222em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 1em; vertical-align: -0.25em;">
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.0785em;">
             X
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.3361em;">
                <span class="" style="top: -2.55em; margin-left: -0.0785em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mtight">
                   <span class="mord mathnormal mtight" style="margin-right: 0.0197em;">
                    l
                   </span>
                   <span class="mbin mtight">
                    −
                   </span>
                   <span class="mord mtight">
                    1
                   </span>
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.2083em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mclose">
            )
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </li>
     <li>
      <strong>
       前馈神经网络（FFN）+ 残差连接 + 层归一化
      </strong>
      <br/>
      <span class="katex--display">
       <span class="katex-display">
        <span class="katex">
         <span class="katex-mathml">
          X 
           
          
            l 
           
          
         
           = 
          
         
           LayerNorm 
          
         
           ( 
          
         
           FFN 
          
         
           ( 
          
          
          
            X 
           
          
            l 
           
          
            ′ 
           
          
         
           ) 
          
         
           + 
          
          
          
            X 
           
          
            l 
           
          
            ′ 
           
          
         
           ) 
          
         
        
          X_l = \text{LayerNorm}(\text{FFN}(X'_l) + X'_l)
         </span>
         <span class="katex-html">
          <span class="base">
           <span class="strut" style="height: 0.8333em; vertical-align: -0.15em;">
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.0785em;">
             X
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.3361em;">
                <span class="" style="top: -2.55em; margin-left: -0.0785em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0197em;">
                   l
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.15em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
           <span class="mrel">
            =
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 1.0519em; vertical-align: -0.25em;">
           </span>
           <span class="mord text">
            <span class="mord">
             LayerNorm
            </span>
           </span>
           <span class="mopen">
            (
           </span>
           <span class="mord text">
            <span class="mord">
             FFN
            </span>
           </span>
           <span class="mopen">
            (
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.0785em;">
             X
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.8019em;">
                <span class="" style="top: -2.453em; margin-left: -0.0785em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0197em;">
                   l
                  </span>
                 </span>
                </span>
                <span class="" style="top: -3.113em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mtight">
                   <span class="mord mtight">
                    ′
                   </span>
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.247em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mclose">
            )
           </span>
           <span class="mspace" style="margin-right: 0.2222em;">
           </span>
           <span class="mbin">
            +
           </span>
           <span class="mspace" style="margin-right: 0.2222em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 1.0519em; vertical-align: -0.25em;">
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.0785em;">
             X
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.8019em;">
                <span class="" style="top: -2.453em; margin-left: -0.0785em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0197em;">
                   l
                  </span>
                 </span>
                </span>
                <span class="" style="top: -3.113em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mtight">
                   <span class="mord mtight">
                    ′
                   </span>
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.247em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mclose">
            )
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </li>
    </ol>
    <p>
     其中：
    </p>
    <ul>
     <li>
      <strong>
       ( X_{l-1} )
      </strong>
      ：表示编码器第 ( l-1 ) 层的输出
     </li>
     <li>
      <strong>
       ( X’_l )
      </strong>
      ：表示经过多头注意力后的中间结果
     </li>
     <li>
      <strong>
       ( X_l )
      </strong>
      ：表示编码器第 ( l ) 层的最终输出
     </li>
     <li>
      <strong>
       LayerNorm
      </strong>
      ：层归一化，稳定训练
     </li>
     <li>
      <strong>
       MHA
      </strong>
      ：多头注意力
     </li>
     <li>
      <strong>
       FFN
      </strong>
      ：前馈神经网络
     </li>
    </ul>
    <hr/>
    <h5>
     <a id="4__144">
     </a>
     <strong>
      4. 编码器的特点
     </strong>
    </h5>
    <ul>
     <li>
      <strong>
       并行计算
      </strong>
      ：不像 RNN 需要逐步处理序列，Transformer 编码器可以一次性处理整个输入序列，提高计算效率。
     </li>
     <li>
      <strong>
       长距离依赖建模
      </strong>
      ：通过
      <strong>
       自注意力机制（Self-Attention）
      </strong>
      ，编码器可以捕捉远距离的词语关系。
     </li>
     <li>
      <strong>
       层归一化 + 残差连接
      </strong>
      ：防止梯度消失，提高模型稳定性。
     </li>
     <li>
      <strong>
       多头注意力
      </strong>
      ：增强模型的表达能力，让不同的注意力头关注不同的信息。
     </li>
    </ul>
    <hr/>
    <h5>
     <a id="5__152">
     </a>
     <strong>
      5. 代码实现
     </strong>
    </h5>
    <p>
     <strong>
      Transformer 编码器层（Encoder Layer）的 PyTorch 实现
     </strong>
     ：
    </p>
    <pre><code class="prism language-python"><span class="token keyword">import</span> torch
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn

<span class="token keyword">class</span> <span class="token class-name">TransformerEncoderLayer</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> d_model<span class="token punctuation">,</span> num_heads<span class="token punctuation">,</span> d_ff<span class="token punctuation">,</span> dropout<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Transformer 编码器层
        
        参数：
        - d_model: 输入特征维度（如 512）
        - num_heads: 多头注意力的头数
        - d_ff: 前馈神经网络的隐藏层维度（一般是 4*d_model）
        - dropout: Dropout 概率
        """</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>TransformerEncoderLayer<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># 多头注意力层</span>
        self<span class="token punctuation">.</span>self_attn <span class="token operator">=</span> nn<span class="token punctuation">.</span>MultiheadAttention<span class="token punctuation">(</span>embed_dim<span class="token operator">=</span>d_model<span class="token punctuation">,</span> num_heads<span class="token operator">=</span>num_heads<span class="token punctuation">,</span> dropout<span class="token operator">=</span>dropout<span class="token punctuation">)</span>

        <span class="token comment"># 前馈神经网络</span>
        self<span class="token punctuation">.</span>ffn <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
            nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>d_model<span class="token punctuation">,</span> d_ff<span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>d_ff<span class="token punctuation">,</span> d_model<span class="token punctuation">)</span>
        <span class="token punctuation">)</span>

        <span class="token comment"># 层归一化</span>
        self<span class="token punctuation">.</span>norm1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>LayerNorm<span class="token punctuation">(</span>d_model<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>norm2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>LayerNorm<span class="token punctuation">(</span>d_model<span class="token punctuation">)</span>

        <span class="token comment"># Dropout</span>
        self<span class="token punctuation">.</span>dropout1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Dropout<span class="token punctuation">(</span>dropout<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>dropout2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Dropout<span class="token punctuation">(</span>dropout<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        前向传播
        
        参数：
        - x: 输入张量 (batch_size, seq_len, d_model)
        
        返回：
        - 编码器层的输出 (batch_size, seq_len, d_model)
        """</span>
        <span class="token comment"># 多头注意力</span>
        attn_output<span class="token punctuation">,</span> _ <span class="token operator">=</span> self<span class="token punctuation">.</span>self_attn<span class="token punctuation">(</span>x<span class="token punctuation">,</span> x<span class="token punctuation">,</span> x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>norm1<span class="token punctuation">(</span>x <span class="token operator">+</span> self<span class="token punctuation">.</span>dropout1<span class="token punctuation">(</span>attn_output<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 残差连接 + 层归一化</span>

        <span class="token comment"># 前馈神经网络</span>
        ffn_output <span class="token operator">=</span> self<span class="token punctuation">.</span>ffn<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>norm2<span class="token punctuation">(</span>x <span class="token operator">+</span> self<span class="token punctuation">.</span>dropout2<span class="token punctuation">(</span>ffn_output<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 残差连接 + 层归一化</span>

        <span class="token keyword">return</span> x

<span class="token comment"># 测试编码器层</span>
d_model <span class="token operator">=</span> <span class="token number">512</span>
num_heads <span class="token operator">=</span> <span class="token number">8</span>
d_ff <span class="token operator">=</span> <span class="token number">2048</span>
seq_len <span class="token operator">=</span> <span class="token number">10</span>
batch_size <span class="token operator">=</span> <span class="token number">2</span>

encoder_layer <span class="token operator">=</span> TransformerEncoderLayer<span class="token punctuation">(</span>d_model<span class="token punctuation">,</span> num_heads<span class="token punctuation">,</span> d_ff<span class="token punctuation">)</span>
input_tensor <span class="token operator">=</span> torch<span class="token punctuation">.</span>rand<span class="token punctuation">(</span>batch_size<span class="token punctuation">,</span> seq_len<span class="token punctuation">,</span> d_model<span class="token punctuation">)</span>  <span class="token comment"># 随机输入</span>
output_tensor <span class="token operator">=</span> encoder_layer<span class="token punctuation">(</span>input_tensor<span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"编码器层输出形状:"</span><span class="token punctuation">,</span> output_tensor<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>  <span class="token comment"># (batch_size, seq_len, d_model)</span>
</code></pre>
    <hr/>
    <table>
     <thead>
      <tr>
       <th>
        <strong>
         组件
        </strong>
       </th>
       <th>
        <strong>
         作用
        </strong>
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        <strong>
         多头注意力（MHA）
        </strong>
       </td>
       <td>
        计算输入序列中不同位置的相关性，提取全局信息
       </td>
      </tr>
      <tr>
       <td>
        <strong>
         前馈神经网络（FFN）
        </strong>
       </td>
       <td>
        增强特征表达能力
       </td>
      </tr>
      <tr>
       <td>
        <strong>
         残差连接（Residual）
        </strong>
       </td>
       <td>
        防止梯度消失，提升训练稳定性
       </td>
      </tr>
      <tr>
       <td>
        <strong>
         层归一化（LayerNorm）
        </strong>
       </td>
       <td>
        归一化激活值，稳定训练
       </td>
      </tr>
     </tbody>
    </table>
    <p>
     <strong>
      编码器的关键作用是将输入转换为隐藏层特征，并通过层层堆叠提取更高级的语义信息。
     </strong>
    </p>
    <h4>
     <a id="14__236">
     </a>
     1.4 解码器
    </h4>
    <h5>
     <a id="1__237">
     </a>
     <strong>
      1. 解码器的作用
     </strong>
    </h5>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/3ea5bd6fb28f4dd3aef5904028bface6.png"/>
    </p>
    <p>
     解码器（Decoder）是 Transformer 结构的另一核心组件，它的主要作用是
     <strong>
      将编码器的隐藏层特征转换为输出序列
     </strong>
     （如翻译任务中的目标语言句子）。
    </p>
    <p>
     在 Transformer 结构中，解码器由
     <strong>
      N 个堆叠的解码器层（Decoder Layers）
     </strong>
     组成，每个解码器层包含：
    </p>
    <ul>
     <li>
      <strong>
       掩码多头注意力（Masked Multi-Head Attention, Masked MHA）
      </strong>
     </li>
     <li>
      <strong>
       交叉多头注意力（Cross Multi-Head Attention, Cross MHA）
      </strong>
     </li>
     <li>
      <strong>
       前馈神经网络（Feed Forward Network, FFN）
      </strong>
     </li>
     <li>
      <strong>
       残差连接（Residual Connection）和层归一化（Layer Normalization）
      </strong>
     </li>
    </ul>
    <hr/>
    <h5>
     <a id="2__250">
     </a>
     <strong>
      2. 解码器的结构
     </strong>
    </h5>
    <p>
     解码器的计算流程如下：
    </p>
    <h6>
     <a id="1Masked_MultiHead_Attention_Masked_MHA_252">
     </a>
     <strong>
      （1）掩码多头注意力（Masked Multi-Head Attention, Masked MHA）
     </strong>
    </h6>
    <ul>
     <li>
      <strong>
       作用
      </strong>
      ：在生成序列时，模型不能看到未来的信息，因此需要掩码（Mask），确保解码器在预测第
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         t 
         
        
       
         t
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.6151em;">
          </span>
          <span class="mord mathnormal">
           t
          </span>
         </span>
        </span>
       </span>
      </span>
      个词时，只能利用
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         t 
         
        
       
         t
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.6151em;">
          </span>
          <span class="mord mathnormal">
           t
          </span>
         </span>
        </span>
       </span>
      </span>
      之前的词，而不能看到
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         t 
         
        
          + 
         
        
          1 
         
        
       
         t+1
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.6984em; vertical-align: -0.0833em;">
          </span>
          <span class="mord mathnormal">
           t
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
          <span class="mbin">
           +
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 0.6444em;">
          </span>
          <span class="mord">
           1
          </span>
         </span>
        </span>
       </span>
      </span>
      及之后的词。
     </li>
     <li>
      <strong>
       计算方式
      </strong>
      ：
      <br/>
      <span class="katex--display">
       <span class="katex-display">
        <span class="katex">
         <span class="katex-mathml">
          Y 
           
          
            l 
           
          
            ′ 
           
          
         
           = 
          
         
           LayerNorm 
          
         
           ( 
          
         
           MaskedMHA 
          
         
           ( 
          
          
          
            Y 
           
           
           
             l 
            
           
             − 
            
           
             1 
            
           
          
         
           ) 
          
         
           + 
          
          
          
            Y 
           
           
           
             l 
            
           
             − 
            
           
             1 
            
           
          
         
           ) 
          
         
        
          Y'_l = \text{LayerNorm}(\text{MaskedMHA}(Y_{l-1}) + Y_{l-1})
         </span>
         <span class="katex-html">
          <span class="base">
           <span class="strut" style="height: 1.0489em; vertical-align: -0.247em;">
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.2222em;">
             Y
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.8019em;">
                <span class="" style="top: -2.453em; margin-left: -0.2222em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0197em;">
                   l
                  </span>
                 </span>
                </span>
                <span class="" style="top: -3.113em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mtight">
                   <span class="mord mtight">
                    ′
                   </span>
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.247em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
           <span class="mrel">
            =
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 1em; vertical-align: -0.25em;">
           </span>
           <span class="mord text">
            <span class="mord">
             LayerNorm
            </span>
           </span>
           <span class="mopen">
            (
           </span>
           <span class="mord text">
            <span class="mord">
             MaskedMHA
            </span>
           </span>
           <span class="mopen">
            (
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.2222em;">
             Y
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.3361em;">
                <span class="" style="top: -2.55em; margin-left: -0.2222em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mtight">
                   <span class="mord mathnormal mtight" style="margin-right: 0.0197em;">
                    l
                   </span>
                   <span class="mbin mtight">
                    −
                   </span>
                   <span class="mord mtight">
                    1
                   </span>
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.2083em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mclose">
            )
           </span>
           <span class="mspace" style="margin-right: 0.2222em;">
           </span>
           <span class="mbin">
            +
           </span>
           <span class="mspace" style="margin-right: 0.2222em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 1em; vertical-align: -0.25em;">
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.2222em;">
             Y
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.3361em;">
                <span class="" style="top: -2.55em; margin-left: -0.2222em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mtight">
                   <span class="mord mathnormal mtight" style="margin-right: 0.0197em;">
                    l
                   </span>
                   <span class="mbin mtight">
                    −
                   </span>
                   <span class="mord mtight">
                    1
                   </span>
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.2083em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mclose">
            )
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      <ul>
       <li>
        <span class="katex--inline">
         <span class="katex">
          <span class="katex-mathml">
           Y 
            
            
            
              l 
             
            
              − 
             
            
              1 
             
            
           
          
         
           Y_{l-1}
          </span>
          <span class="katex-html">
           <span class="base">
            <span class="strut" style="height: 0.8917em; vertical-align: -0.2083em;">
            </span>
            <span class="mord">
             <span class="mord mathnormal" style="margin-right: 0.2222em;">
              Y
             </span>
             <span class="msupsub">
              <span class="vlist-t vlist-t2">
               <span class="vlist-r">
                <span class="vlist" style="height: 0.3361em;">
                 <span class="" style="top: -2.55em; margin-left: -0.2222em; margin-right: 0.05em;">
                  <span class="pstrut" style="height: 2.7em;">
                  </span>
                  <span class="sizing reset-size6 size3 mtight">
                   <span class="mord mtight">
                    <span class="mord mathnormal mtight" style="margin-right: 0.0197em;">
                     l
                    </span>
                    <span class="mbin mtight">
                     −
                    </span>
                    <span class="mord mtight">
                     1
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
                <span class="vlist-s">
                 ​
                </span>
               </span>
               <span class="vlist-r">
                <span class="vlist" style="height: 0.2083em;">
                 <span class="">
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
        是解码器前一层的输出
       </li>
       <li>
        Masked MHA 计算当前词与之前词的注意力
       </li>
       <li>
        LayerNorm 进行层归一化
       </li>
      </ul>
     </li>
    </ul>
    <hr/>
    <h6>
     <a id="2Cross_MultiHead_Attention_Cross_MHA_264">
     </a>
     <strong>
      （2）交叉多头注意力（Cross Multi-Head Attention, Cross MHA）
     </strong>
    </h6>
    <ul>
     <li>
      <strong>
       作用
      </strong>
      ：在翻译任务中，解码器需要关注编码器的输出，以获取源语言的信息。
     </li>
     <li>
      <strong>
       计算方式
      </strong>
      ：
      <br/>
      <span class="katex--display">
       <span class="katex-display">
        <span class="katex">
         <span class="katex-mathml">
          Y 
           
          
            l 
           
           
           
             ′ 
            
           
             ′ 
            
           
          
         
           = 
          
         
           LayerNorm 
          
         
           ( 
          
         
           CrossMHA 
          
         
           ( 
          
          
          
            Y 
           
          
            l 
           
          
            ′ 
           
          
         
           , 
          
          
          
            X 
           
          
            L 
           
          
         
           ) 
          
         
           + 
          
          
          
            Y 
           
          
            l 
           
          
            ′ 
           
          
         
           ) 
          
         
        
          Y''_l = \text{LayerNorm}(\text{CrossMHA}(Y'_l, X_L) + Y'_l)
         </span>
         <span class="katex-html">
          <span class="base">
           <span class="strut" style="height: 1.0489em; vertical-align: -0.247em;">
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.2222em;">
             Y
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.8019em;">
                <span class="" style="top: -2.453em; margin-left: -0.2222em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0197em;">
                   l
                  </span>
                 </span>
                </span>
                <span class="" style="top: -3.113em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mtight">
                   <span class="mord mtight">
                    ′′
                   </span>
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.247em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
           <span class="mrel">
            =
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 1.0519em; vertical-align: -0.25em;">
           </span>
           <span class="mord text">
            <span class="mord">
             LayerNorm
            </span>
           </span>
           <span class="mopen">
            (
           </span>
           <span class="mord text">
            <span class="mord">
             CrossMHA
            </span>
           </span>
           <span class="mopen">
            (
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.2222em;">
             Y
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.8019em;">
                <span class="" style="top: -2.453em; margin-left: -0.2222em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0197em;">
                   l
                  </span>
                 </span>
                </span>
                <span class="" style="top: -3.113em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mtight">
                   <span class="mord mtight">
                    ′
                   </span>
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.247em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mpunct">
            ,
           </span>
           <span class="mspace" style="margin-right: 0.1667em;">
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.0785em;">
             X
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.3283em;">
                <span class="" style="top: -2.55em; margin-left: -0.0785em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mathnormal mtight">
                   L
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.15em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mclose">
            )
           </span>
           <span class="mspace" style="margin-right: 0.2222em;">
           </span>
           <span class="mbin">
            +
           </span>
           <span class="mspace" style="margin-right: 0.2222em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 1.0519em; vertical-align: -0.25em;">
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.2222em;">
             Y
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.8019em;">
                <span class="" style="top: -2.453em; margin-left: -0.2222em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0197em;">
                   l
                  </span>
                 </span>
                </span>
                <span class="" style="top: -3.113em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mtight">
                   <span class="mord mtight">
                    ′
                   </span>
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.247em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mclose">
            )
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      <ul>
       <li>
        <span class="katex--inline">
         <span class="katex">
          <span class="katex-mathml">
           Y 
            
           
             l 
            
           
             ′ 
            
           
          
         
           Y'_l
          </span>
          <span class="katex-html">
           <span class="base">
            <span class="strut" style="height: 1.035em; vertical-align: -0.2831em;">
            </span>
            <span class="mord">
             <span class="mord mathnormal" style="margin-right: 0.2222em;">
              Y
             </span>
             <span class="msupsub">
              <span class="vlist-t vlist-t2">
               <span class="vlist-r">
                <span class="vlist" style="height: 0.7519em;">
                 <span class="" style="top: -2.4169em; margin-left: -0.2222em; margin-right: 0.05em;">
                  <span class="pstrut" style="height: 2.7em;">
                  </span>
                  <span class="sizing reset-size6 size3 mtight">
                   <span class="mord mathnormal mtight" style="margin-right: 0.0197em;">
                    l
                   </span>
                  </span>
                 </span>
                 <span class="" style="top: -3.063em; margin-right: 0.05em;">
                  <span class="pstrut" style="height: 2.7em;">
                  </span>
                  <span class="sizing reset-size6 size3 mtight">
                   <span class="mord mtight">
                    <span class="mord mtight">
                     ′
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
                <span class="vlist-s">
                 ​
                </span>
               </span>
               <span class="vlist-r">
                <span class="vlist" style="height: 0.2831em;">
                 <span class="">
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
        是掩码注意力的输出
       </li>
       <li>
        <span class="katex--inline">
         <span class="katex">
          <span class="katex-mathml">
           X 
            
           
             L 
            
           
          
         
           X_L
          </span>
          <span class="katex-html">
           <span class="base">
            <span class="strut" style="height: 0.8333em; vertical-align: -0.15em;">
            </span>
            <span class="mord">
             <span class="mord mathnormal" style="margin-right: 0.0785em;">
              X
             </span>
             <span class="msupsub">
              <span class="vlist-t vlist-t2">
               <span class="vlist-r">
                <span class="vlist" style="height: 0.3283em;">
                 <span class="" style="top: -2.55em; margin-left: -0.0785em; margin-right: 0.05em;">
                  <span class="pstrut" style="height: 2.7em;">
                  </span>
                  <span class="sizing reset-size6 size3 mtight">
                   <span class="mord mathnormal mtight">
                    L
                   </span>
                  </span>
                 </span>
                </span>
                <span class="vlist-s">
                 ​
                </span>
               </span>
               <span class="vlist-r">
                <span class="vlist" style="height: 0.15em;">
                 <span class="">
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
        是编码器的最终输出
       </li>
       <li>
        Cross MHA 计算解码器的隐藏状态与编码器输出之间的注意力关系
       </li>
      </ul>
     </li>
    </ul>
    <hr/>
    <h6>
     <a id="3Feed_Forward_Network_FFN_276">
     </a>
     <strong>
      （3）前馈神经网络（Feed Forward Network, FFN）
     </strong>
    </h6>
    <ul>
     <li>
      <strong>
       作用
      </strong>
      ：增强特征表达能力，提高模型的非线性变换能力。
     </li>
     <li>
      <strong>
       计算方式
      </strong>
      ：
      <br/>
      <span class="katex--display">
       <span class="katex-display">
        <span class="katex">
         <span class="katex-mathml">
          Y 
           
          
            l 
           
          
         
           = 
          
         
           LayerNorm 
          
         
           ( 
          
         
           FFN 
          
         
           ( 
          
          
          
            Y 
           
          
            l 
           
           
           
             ′ 
            
           
             ′ 
            
           
          
         
           ) 
          
         
           + 
          
          
          
            Y 
           
          
            l 
           
           
           
             ′ 
            
           
             ′ 
            
           
          
         
           ) 
          
         
        
          Y_l = \text{LayerNorm}(\text{FFN}(Y''_l) + Y''_l)
         </span>
         <span class="katex-html">
          <span class="base">
           <span class="strut" style="height: 0.8333em; vertical-align: -0.15em;">
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.2222em;">
             Y
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.3361em;">
                <span class="" style="top: -2.55em; margin-left: -0.2222em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0197em;">
                   l
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.15em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
           <span class="mrel">
            =
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 1.0519em; vertical-align: -0.25em;">
           </span>
           <span class="mord text">
            <span class="mord">
             LayerNorm
            </span>
           </span>
           <span class="mopen">
            (
           </span>
           <span class="mord text">
            <span class="mord">
             FFN
            </span>
           </span>
           <span class="mopen">
            (
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.2222em;">
             Y
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.8019em;">
                <span class="" style="top: -2.453em; margin-left: -0.2222em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0197em;">
                   l
                  </span>
                 </span>
                </span>
                <span class="" style="top: -3.113em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mtight">
                   <span class="mord mtight">
                    ′′
                   </span>
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.247em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mclose">
            )
           </span>
           <span class="mspace" style="margin-right: 0.2222em;">
           </span>
           <span class="mbin">
            +
           </span>
           <span class="mspace" style="margin-right: 0.2222em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 1.0519em; vertical-align: -0.25em;">
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.2222em;">
             Y
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.8019em;">
                <span class="" style="top: -2.453em; margin-left: -0.2222em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0197em;">
                   l
                  </span>
                 </span>
                </span>
                <span class="" style="top: -3.113em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mtight">
                   <span class="mord mtight">
                    ′′
                   </span>
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.247em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mclose">
            )
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      <ul>
       <li>
        FFN 由两个全连接层（MLP）组成：
        <br/>
        <span class="katex--display">
         <span class="katex-display">
          <span class="katex">
           <span class="katex-mathml">
            FFN 
            
           
             ( 
            
            
            
              Y 
             
             
             
               ′ 
              
             
               ′ 
              
             
            
           
             ) 
            
           
             = 
            
           
             ReLU 
            
           
             ( 
            
            
            
              Y 
             
             
             
               ′ 
              
             
               ′ 
              
             
            
            
            
              W 
             
            
              1 
             
            
           
             + 
            
            
            
              b 
             
            
              1 
             
            
           
             ) 
            
            
            
              W 
             
            
              2 
             
            
           
             + 
            
            
            
              b 
             
            
              2 
             
            
           
          
            \text{FFN}(Y'') = \text{ReLU}(Y'' W_1 + b_1) W_2 + b_2
           </span>
           <span class="katex-html">
            <span class="base">
             <span class="strut" style="height: 1.0519em; vertical-align: -0.25em;">
             </span>
             <span class="mord text">
              <span class="mord">
               FFN
              </span>
             </span>
             <span class="mopen">
              (
             </span>
             <span class="mord">
              <span class="mord mathnormal" style="margin-right: 0.2222em;">
               Y
              </span>
              <span class="msupsub">
               <span class="vlist-t">
                <span class="vlist-r">
                 <span class="vlist" style="height: 0.8019em;">
                  <span class="" style="top: -3.113em; margin-right: 0.05em;">
                   <span class="pstrut" style="height: 2.7em;">
                   </span>
                   <span class="sizing reset-size6 size3 mtight">
                    <span class="mord mtight">
                     <span class="mord mtight">
                      ′′
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="mclose">
              )
             </span>
             <span class="mspace" style="margin-right: 0.2778em;">
             </span>
             <span class="mrel">
              =
             </span>
             <span class="mspace" style="margin-right: 0.2778em;">
             </span>
            </span>
            <span class="base">
             <span class="strut" style="height: 1.0519em; vertical-align: -0.25em;">
             </span>
             <span class="mord text">
              <span class="mord">
               ReLU
              </span>
             </span>
             <span class="mopen">
              (
             </span>
             <span class="mord">
              <span class="mord mathnormal" style="margin-right: 0.2222em;">
               Y
              </span>
              <span class="msupsub">
               <span class="vlist-t">
                <span class="vlist-r">
                 <span class="vlist" style="height: 0.8019em;">
                  <span class="" style="top: -3.113em; margin-right: 0.05em;">
                   <span class="pstrut" style="height: 2.7em;">
                   </span>
                   <span class="sizing reset-size6 size3 mtight">
                    <span class="mord mtight">
                     <span class="mord mtight">
                      ′′
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="mord">
              <span class="mord mathnormal" style="margin-right: 0.1389em;">
               W
              </span>
              <span class="msupsub">
               <span class="vlist-t vlist-t2">
                <span class="vlist-r">
                 <span class="vlist" style="height: 0.3011em;">
                  <span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;">
                   <span class="pstrut" style="height: 2.7em;">
                   </span>
                   <span class="sizing reset-size6 size3 mtight">
                    <span class="mord mtight">
                     1
                    </span>
                   </span>
                  </span>
                 </span>
                 <span class="vlist-s">
                  ​
                 </span>
                </span>
                <span class="vlist-r">
                 <span class="vlist" style="height: 0.15em;">
                  <span class="">
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="mspace" style="margin-right: 0.2222em;">
             </span>
             <span class="mbin">
              +
             </span>
             <span class="mspace" style="margin-right: 0.2222em;">
             </span>
            </span>
            <span class="base">
             <span class="strut" style="height: 1em; vertical-align: -0.25em;">
             </span>
             <span class="mord">
              <span class="mord mathnormal">
               b
              </span>
              <span class="msupsub">
               <span class="vlist-t vlist-t2">
                <span class="vlist-r">
                 <span class="vlist" style="height: 0.3011em;">
                  <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                   <span class="pstrut" style="height: 2.7em;">
                   </span>
                   <span class="sizing reset-size6 size3 mtight">
                    <span class="mord mtight">
                     1
                    </span>
                   </span>
                  </span>
                 </span>
                 <span class="vlist-s">
                  ​
                 </span>
                </span>
                <span class="vlist-r">
                 <span class="vlist" style="height: 0.15em;">
                  <span class="">
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="mclose">
              )
             </span>
             <span class="mord">
              <span class="mord mathnormal" style="margin-right: 0.1389em;">
               W
              </span>
              <span class="msupsub">
               <span class="vlist-t vlist-t2">
                <span class="vlist-r">
                 <span class="vlist" style="height: 0.3011em;">
                  <span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;">
                   <span class="pstrut" style="height: 2.7em;">
                   </span>
                   <span class="sizing reset-size6 size3 mtight">
                    <span class="mord mtight">
                     2
                    </span>
                   </span>
                  </span>
                 </span>
                 <span class="vlist-s">
                  ​
                 </span>
                </span>
                <span class="vlist-r">
                 <span class="vlist" style="height: 0.15em;">
                  <span class="">
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="mspace" style="margin-right: 0.2222em;">
             </span>
             <span class="mbin">
              +
             </span>
             <span class="mspace" style="margin-right: 0.2222em;">
             </span>
            </span>
            <span class="base">
             <span class="strut" style="height: 0.8444em; vertical-align: -0.15em;">
             </span>
             <span class="mord">
              <span class="mord mathnormal">
               b
              </span>
              <span class="msupsub">
               <span class="vlist-t vlist-t2">
                <span class="vlist-r">
                 <span class="vlist" style="height: 0.3011em;">
                  <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                   <span class="pstrut" style="height: 2.7em;">
                   </span>
                   <span class="sizing reset-size6 size3 mtight">
                    <span class="mord mtight">
                     2
                    </span>
                   </span>
                  </span>
                 </span>
                 <span class="vlist-s">
                  ​
                 </span>
                </span>
                <span class="vlist-r">
                 <span class="vlist" style="height: 0.15em;">
                  <span class="">
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </li>
       <li>
        采用 ReLU 激活函数，增强非线性表达能力
       </li>
      </ul>
     </li>
    </ul>
    <hr/>
    <h5>
     <a id="4__290">
     </a>
     <strong>
      4. 计算解析
     </strong>
    </h5>
    <p>
     解码器的计算流程可以分为三步：
    </p>
    <ol>
     <li>
      <strong>
       掩码多头注意力（Masked MHA）+ 残差连接 + 层归一化
      </strong>
      <br/>
      <span class="katex--display">
       <span class="katex-display">
        <span class="katex">
         <span class="katex-mathml">
          Y 
           
          
            l 
           
          
            ′ 
           
          
         
           = 
          
         
           LayerNorm 
          
         
           ( 
          
         
           MaskedMHA 
          
         
           ( 
          
          
          
            Y 
           
           
           
             l 
            
           
             − 
            
           
             1 
            
           
          
         
           ) 
          
         
           + 
          
          
          
            Y 
           
           
           
             l 
            
           
             − 
            
           
             1 
            
           
          
         
           ) 
          
         
        
          Y'_l = \text{LayerNorm}(\text{MaskedMHA}(Y_{l-1}) + Y_{l-1})
         </span>
         <span class="katex-html">
          <span class="base">
           <span class="strut" style="height: 1.0489em; vertical-align: -0.247em;">
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.2222em;">
             Y
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.8019em;">
                <span class="" style="top: -2.453em; margin-left: -0.2222em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0197em;">
                   l
                  </span>
                 </span>
                </span>
                <span class="" style="top: -3.113em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mtight">
                   <span class="mord mtight">
                    ′
                   </span>
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.247em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
           <span class="mrel">
            =
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 1em; vertical-align: -0.25em;">
           </span>
           <span class="mord text">
            <span class="mord">
             LayerNorm
            </span>
           </span>
           <span class="mopen">
            (
           </span>
           <span class="mord text">
            <span class="mord">
             MaskedMHA
            </span>
           </span>
           <span class="mopen">
            (
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.2222em;">
             Y
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.3361em;">
                <span class="" style="top: -2.55em; margin-left: -0.2222em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mtight">
                   <span class="mord mathnormal mtight" style="margin-right: 0.0197em;">
                    l
                   </span>
                   <span class="mbin mtight">
                    −
                   </span>
                   <span class="mord mtight">
                    1
                   </span>
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.2083em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mclose">
            )
           </span>
           <span class="mspace" style="margin-right: 0.2222em;">
           </span>
           <span class="mbin">
            +
           </span>
           <span class="mspace" style="margin-right: 0.2222em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 1em; vertical-align: -0.25em;">
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.2222em;">
             Y
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.3361em;">
                <span class="" style="top: -2.55em; margin-left: -0.2222em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mtight">
                   <span class="mord mathnormal mtight" style="margin-right: 0.0197em;">
                    l
                   </span>
                   <span class="mbin mtight">
                    −
                   </span>
                   <span class="mord mtight">
                    1
                   </span>
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.2083em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mclose">
            )
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </li>
     <li>
      <strong>
       交叉多头注意力（Cross MHA）+ 残差连接 + 层归一化
      </strong>
      <br/>
      <span class="katex--display">
       <span class="katex-display">
        <span class="katex">
         <span class="katex-mathml">
          Y 
           
          
            l 
           
           
           
             ′ 
            
           
             ′ 
            
           
          
         
           = 
          
         
           LayerNorm 
          
         
           ( 
          
         
           CrossMHA 
          
         
           ( 
          
          
          
            Y 
           
          
            l 
           
          
            ′ 
           
          
         
           , 
          
          
          
            X 
           
          
            L 
           
          
         
           ) 
          
         
           + 
          
          
          
            Y 
           
          
            l 
           
          
            ′ 
           
          
         
           ) 
          
         
        
          Y''_l = \text{LayerNorm}(\text{CrossMHA}(Y'_l, X_L) + Y'_l)
         </span>
         <span class="katex-html">
          <span class="base">
           <span class="strut" style="height: 1.0489em; vertical-align: -0.247em;">
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.2222em;">
             Y
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.8019em;">
                <span class="" style="top: -2.453em; margin-left: -0.2222em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0197em;">
                   l
                  </span>
                 </span>
                </span>
                <span class="" style="top: -3.113em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mtight">
                   <span class="mord mtight">
                    ′′
                   </span>
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.247em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
           <span class="mrel">
            =
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 1.0519em; vertical-align: -0.25em;">
           </span>
           <span class="mord text">
            <span class="mord">
             LayerNorm
            </span>
           </span>
           <span class="mopen">
            (
           </span>
           <span class="mord text">
            <span class="mord">
             CrossMHA
            </span>
           </span>
           <span class="mopen">
            (
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.2222em;">
             Y
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.8019em;">
                <span class="" style="top: -2.453em; margin-left: -0.2222em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0197em;">
                   l
                  </span>
                 </span>
                </span>
                <span class="" style="top: -3.113em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mtight">
                   <span class="mord mtight">
                    ′
                   </span>
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.247em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mpunct">
            ,
           </span>
           <span class="mspace" style="margin-right: 0.1667em;">
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.0785em;">
             X
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.3283em;">
                <span class="" style="top: -2.55em; margin-left: -0.0785em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mathnormal mtight">
                   L
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.15em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mclose">
            )
           </span>
           <span class="mspace" style="margin-right: 0.2222em;">
           </span>
           <span class="mbin">
            +
           </span>
           <span class="mspace" style="margin-right: 0.2222em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 1.0519em; vertical-align: -0.25em;">
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.2222em;">
             Y
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.8019em;">
                <span class="" style="top: -2.453em; margin-left: -0.2222em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0197em;">
                   l
                  </span>
                 </span>
                </span>
                <span class="" style="top: -3.113em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mtight">
                   <span class="mord mtight">
                    ′
                   </span>
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.247em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mclose">
            )
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </li>
     <li>
      <strong>
       前馈神经网络（FFN）+ 残差连接 + 层归一化
      </strong>
      <br/>
      <span class="katex--display">
       <span class="katex-display">
        <span class="katex">
         <span class="katex-mathml">
          Y 
           
          
            l 
           
          
         
           = 
          
         
           LayerNorm 
          
         
           ( 
          
         
           FFN 
          
         
           ( 
          
          
          
            Y 
           
          
            l 
           
           
           
             ′ 
            
           
             ′ 
            
           
          
         
           ) 
          
         
           + 
          
          
          
            Y 
           
          
            l 
           
           
           
             ′ 
            
           
             ′ 
            
           
          
         
           ) 
          
         
        
          Y_l = \text{LayerNorm}(\text{FFN}(Y''_l) + Y''_l)
         </span>
         <span class="katex-html">
          <span class="base">
           <span class="strut" style="height: 0.8333em; vertical-align: -0.15em;">
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.2222em;">
             Y
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.3361em;">
                <span class="" style="top: -2.55em; margin-left: -0.2222em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0197em;">
                   l
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.15em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
           <span class="mrel">
            =
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 1.0519em; vertical-align: -0.25em;">
           </span>
           <span class="mord text">
            <span class="mord">
             LayerNorm
            </span>
           </span>
           <span class="mopen">
            (
           </span>
           <span class="mord text">
            <span class="mord">
             FFN
            </span>
           </span>
           <span class="mopen">
            (
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.2222em;">
             Y
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.8019em;">
                <span class="" style="top: -2.453em; margin-left: -0.2222em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0197em;">
                   l
                  </span>
                 </span>
                </span>
                <span class="" style="top: -3.113em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mtight">
                   <span class="mord mtight">
                    ′′
                   </span>
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.247em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mclose">
            )
           </span>
           <span class="mspace" style="margin-right: 0.2222em;">
           </span>
           <span class="mbin">
            +
           </span>
           <span class="mspace" style="margin-right: 0.2222em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 1.0519em; vertical-align: -0.25em;">
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.2222em;">
             Y
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.8019em;">
                <span class="" style="top: -2.453em; margin-left: -0.2222em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0197em;">
                   l
                  </span>
                 </span>
                </span>
                <span class="" style="top: -3.113em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mtight">
                   <span class="mord mtight">
                    ′′
                   </span>
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.247em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mclose">
            )
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </li>
    </ol>
    <p>
     其中：
    </p>
    <ul>
     <li>
      <strong>
       <span class="katex--inline">
        <span class="katex">
         <span class="katex-mathml">
          Y 
           
           
           
             l 
            
           
             − 
            
           
             1 
            
           
          
         
        
          Y_{l-1}
         </span>
         <span class="katex-html">
          <span class="base">
           <span class="strut" style="height: 0.8917em; vertical-align: -0.2083em;">
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.2222em;">
             Y
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.3361em;">
                <span class="" style="top: -2.55em; margin-left: -0.2222em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mtight">
                   <span class="mord mathnormal mtight" style="margin-right: 0.0197em;">
                    l
                   </span>
                   <span class="mbin mtight">
                    −
                   </span>
                   <span class="mord mtight">
                    1
                   </span>
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.2083em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
       )
      </strong>
      ：表示解码器第
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         l 
         
        
          − 
         
        
          1 
         
        
       
         l-1
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.7778em; vertical-align: -0.0833em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0197em;">
           l
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
          <span class="mbin">
           −
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 0.6444em;">
          </span>
          <span class="mord">
           1
          </span>
         </span>
        </span>
       </span>
      </span>
      层的输出
     </li>
     <li>
      <strong>
       <span class="katex--inline">
        <span class="katex">
         <span class="katex-mathml">
          Y 
           
          
            l 
           
          
            ′ 
           
          
         
        
          Y'_l
         </span>
         <span class="katex-html">
          <span class="base">
           <span class="strut" style="height: 1.035em; vertical-align: -0.2831em;">
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.2222em;">
             Y
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.7519em;">
                <span class="" style="top: -2.4169em; margin-left: -0.2222em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0197em;">
                   l
                  </span>
                 </span>
                </span>
                <span class="" style="top: -3.063em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mtight">
                   <span class="mord mtight">
                    ′
                   </span>
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.2831em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </strong>
      ：表示掩码多头注意力后的中间结果
     </li>
     <li>
      <strong>
       <span class="katex--inline">
        <span class="katex">
         <span class="katex-mathml">
          Y 
           
          
            l 
           
           
           
             ′ 
            
           
             ′ 
            
           
          
         
        
          Y''_l
         </span>
         <span class="katex-html">
          <span class="base">
           <span class="strut" style="height: 1.035em; vertical-align: -0.2831em;">
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.2222em;">
             Y
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.7519em;">
                <span class="" style="top: -2.4169em; margin-left: -0.2222em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0197em;">
                   l
                  </span>
                 </span>
                </span>
                <span class="" style="top: -3.063em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mtight">
                   <span class="mord mtight">
                    ′′
                   </span>
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.2831em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </strong>
      ：表示交叉多头注意力后的中间结果
     </li>
     <li>
      <strong>
       <span class="katex--inline">
        <span class="katex">
         <span class="katex-mathml">
          Y 
           
          
            l 
           
          
         
        
          Y_l
         </span>
         <span class="katex-html">
          <span class="base">
           <span class="strut" style="height: 0.8333em; vertical-align: -0.15em;">
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.2222em;">
             Y
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.3361em;">
                <span class="" style="top: -2.55em; margin-left: -0.2222em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0197em;">
                   l
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.15em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </strong>
      ：表示解码器第
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         l 
         
        
       
         l
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.6944em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0197em;">
           l
          </span>
         </span>
        </span>
       </span>
      </span>
      层的最终输出
     </li>
     <li>
      <strong>
       <span class="katex--inline">
        <span class="katex">
         <span class="katex-mathml">
          X 
           
          
            L 
           
          
         
        
          X_L
         </span>
         <span class="katex-html">
          <span class="base">
           <span class="strut" style="height: 0.8333em; vertical-align: -0.15em;">
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.0785em;">
             X
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.3283em;">
                <span class="" style="top: -2.55em; margin-left: -0.0785em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mathnormal mtight">
                   L
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.15em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </strong>
      ：编码器的最终输出
     </li>
     <li>
      <strong>
       LayerNorm
      </strong>
      ：层归一化，稳定训练
     </li>
     <li>
      <strong>
       Masked MHA
      </strong>
      ：掩码多头注意力（防止未来信息泄露）
     </li>
     <li>
      <strong>
       Cross MHA
      </strong>
      ：交叉多头注意力（关注编码器输出）
     </li>
     <li>
      <strong>
       FFN
      </strong>
      ：前馈神经网络
     </li>
    </ul>
    <hr/>
    <h5>
     <a id="5__vs__318">
     </a>
     <strong>
      5. 编码器 vs. 解码器
     </strong>
    </h5>
    <table>
     <thead>
      <tr>
       <th>
        <strong>
         组件
        </strong>
       </th>
       <th>
        <strong>
         编码器（Encoder）
        </strong>
       </th>
       <th>
        <strong>
         解码器（Decoder）
        </strong>
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        <strong>
         输入
        </strong>
       </td>
       <td>
        输入序列（如源语言）
       </td>
       <td>
        目标序列（如目标语言）
       </td>
      </tr>
      <tr>
       <td>
        <strong>
         多头注意力
        </strong>
       </td>
       <td>
        <strong>
         标准多头注意力
        </strong>
        （Self-Attention）
       </td>
       <td>
        <strong>
         掩码多头注意力
        </strong>
        （Masked Self-Attention）
       </td>
      </tr>
      <tr>
       <td>
        <strong>
         交叉注意力
        </strong>
       </td>
       <td>
        ❌
       </td>
       <td>
        ✅（关注编码器输出）
       </td>
      </tr>
      <tr>
       <td>
        <strong>
         前馈神经网络
        </strong>
       </td>
       <td>
        ✅
       </td>
       <td>
        ✅
       </td>
      </tr>
      <tr>
       <td>
        <strong>
         层归一化 &amp; 残差连接
        </strong>
       </td>
       <td>
        ✅
       </td>
       <td>
        ✅
       </td>
      </tr>
     </tbody>
    </table>
    <hr/>
    <h5>
     <a id="6__329">
     </a>
     <strong>
      6. 代码实现
     </strong>
    </h5>
    <p>
     下面是
     <strong>
      Transformer 解码器层（Decoder Layer）的 PyTorch 实现
     </strong>
     ：
    </p>
    <pre><code class="prism language-python"><span class="token keyword">import</span> torch
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn

<span class="token keyword">class</span> <span class="token class-name">TransformerDecoderLayer</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> d_model<span class="token punctuation">,</span> num_heads<span class="token punctuation">,</span> d_ff<span class="token punctuation">,</span> dropout<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Transformer 解码器层
        
        参数：
        - d_model: 输入特征维度（如 512）
        - num_heads: 多头注意力的头数
        - d_ff: 前馈神经网络的隐藏层维度（一般是 4*d_model）
        - dropout: Dropout 概率
        """</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>TransformerDecoderLayer<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># 掩码多头注意力</span>
        self<span class="token punctuation">.</span>masked_attn <span class="token operator">=</span> nn<span class="token punctuation">.</span>MultiheadAttention<span class="token punctuation">(</span>embed_dim<span class="token operator">=</span>d_model<span class="token punctuation">,</span> num_heads<span class="token operator">=</span>num_heads<span class="token punctuation">,</span> dropout<span class="token operator">=</span>dropout<span class="token punctuation">)</span>

        <span class="token comment"># 交叉多头注意力（关注编码器输出）</span>
        self<span class="token punctuation">.</span>cross_attn <span class="token operator">=</span> nn<span class="token punctuation">.</span>MultiheadAttention<span class="token punctuation">(</span>embed_dim<span class="token operator">=</span>d_model<span class="token punctuation">,</span> num_heads<span class="token operator">=</span>num_heads<span class="token punctuation">,</span> dropout<span class="token operator">=</span>dropout<span class="token punctuation">)</span>

        <span class="token comment"># 前馈神经网络</span>
        self<span class="token punctuation">.</span>ffn <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
            nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>d_model<span class="token punctuation">,</span> d_ff<span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>d_ff<span class="token punctuation">,</span> d_model<span class="token punctuation">)</span>
        <span class="token punctuation">)</span>

        <span class="token comment"># 层归一化</span>
        self<span class="token punctuation">.</span>norm1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>LayerNorm<span class="token punctuation">(</span>d_model<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>norm2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>LayerNorm<span class="token punctuation">(</span>d_model<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>norm3 <span class="token operator">=</span> nn<span class="token punctuation">.</span>LayerNorm<span class="token punctuation">(</span>d_model<span class="token punctuation">)</span>

        <span class="token comment"># Dropout</span>
        self<span class="token punctuation">.</span>dropout1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Dropout<span class="token punctuation">(</span>dropout<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>dropout2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Dropout<span class="token punctuation">(</span>dropout<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>dropout3 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Dropout<span class="token punctuation">(</span>dropout<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> encoder_output<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        前向传播
        
        参数：
        - x: 解码器输入 (batch_size, seq_len, d_model)
        - encoder_output: 编码器输出 (batch_size, seq_len, d_model)
        
        返回：
        - 解码器层的输出 (batch_size, seq_len, d_model)
        """</span>
        <span class="token comment"># 掩码多头注意力</span>
        masked_attn_output<span class="token punctuation">,</span> _ <span class="token operator">=</span> self<span class="token punctuation">.</span>masked_attn<span class="token punctuation">(</span>x<span class="token punctuation">,</span> x<span class="token punctuation">,</span> x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>norm1<span class="token punctuation">(</span>x <span class="token operator">+</span> self<span class="token punctuation">.</span>dropout1<span class="token punctuation">(</span>masked_attn_output<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 残差连接 + 层归一化</span>

        <span class="token comment"># 交叉多头注意力</span>
        cross_attn_output<span class="token punctuation">,</span> _ <span class="token operator">=</span> self<span class="token punctuation">.</span>cross_attn<span class="token punctuation">(</span>x<span class="token punctuation">,</span> encoder_output<span class="token punctuation">,</span> encoder_output<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>norm2<span class="token punctuation">(</span>x <span class="token operator">+</span> self<span class="token punctuation">.</span>dropout2<span class="token punctuation">(</span>cross_attn_output<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 残差连接 + 层归一化</span>

        <span class="token comment"># 前馈神经网络</span>
        ffn_output <span class="token operator">=</span> self<span class="token punctuation">.</span>ffn<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>norm3<span class="token punctuation">(</span>x <span class="token operator">+</span> self<span class="token punctuation">.</span>dropout3<span class="token punctuation">(</span>ffn_output<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 残差连接 + 层归一化</span>

        <span class="token keyword">return</span> x

<span class="token comment"># 测试解码器层</span>
decoder_layer <span class="token operator">=</span> TransformerDecoderLayer<span class="token punctuation">(</span>d_model<span class="token operator">=</span><span class="token number">512</span><span class="token punctuation">,</span> num_heads<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span> d_ff<span class="token operator">=</span><span class="token number">2048</span><span class="token punctuation">)</span>
input_tensor <span class="token operator">=</span> torch<span class="token punctuation">.</span>rand<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">)</span>  <span class="token comment"># 解码器输入</span>
encoder_output <span class="token operator">=</span> torch<span class="token punctuation">.</span>rand<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">)</span>  <span class="token comment"># 编码器输出</span>
output_tensor <span class="token operator">=</span> decoder_layer<span class="token punctuation">(</span>input_tensor<span class="token punctuation">,</span> encoder_output<span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"解码器层输出形状:"</span><span class="token punctuation">,</span> output_tensor<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>  <span class="token comment"># (batch_size, seq_len, d_model)</span>
</code></pre>
    <hr/>
    <p>
     解码器的核心在于：
    </p>
    <ul>
     <li>
      <strong>
       掩码多头注意力
      </strong>
      （Masked MHA）：防止未来信息泄露
     </li>
     <li>
      <strong>
       交叉多头注意力
      </strong>
      （Cross MHA）：关注编码器的输出
     </li>
     <li>
      <strong>
       前馈神经网络（FFN）
      </strong>
      ：增强特征表达能力
     </li>
    </ul>
    <h4>
     <a id="15__413">
     </a>
     1.5 多头注意力层
    </h4>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/793506f2d1824881b2b2643489508eb9.png"/>
    </p>
    <p>
     多头注意力（Multi-Head Attention, MHA）是 Transformer 结构的核心组件之一，它能够
     <strong>
      让模型关注输入序列中不同位置的关系
     </strong>
     ，并
     <strong>
      通过多个注意力头（heads）学习不同的特征表示
     </strong>
     。
    </p>
    <hr/>
    <h5>
     <a id="1_Scaled_DotProduct_Attention_420">
     </a>
     <strong>
      1. Scaled Dot-Product Attention（缩放点积注意力）
     </strong>
    </h5>
    <p>
     多头注意力的基础是
     <strong>
      缩放点积注意力（Scaled Dot-Product Attention）
     </strong>
     ，其计算流程如下：
    </p>
    <h6>
     <a id="1_QKV_423">
     </a>
     <strong>
      （1）输入映射到 Q、K、V
     </strong>
    </h6>
    <p>
     给定输入矩阵
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        X 
        
       
      
        X
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.6833em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0785em;">
          X
         </span>
        </span>
       </span>
      </span>
     </span>
     ，我们将其映射为：
    </p>
    <ul>
     <li>
      <strong>
       查询（Query, Q）
      </strong>
      ：
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         Q 
         
        
          = 
         
        
          X 
         
         
         
           W 
          
         
           Q 
          
         
        
       
         Q = X W^Q
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.8778em; vertical-align: -0.1944em;">
          </span>
          <span class="mord mathnormal">
           Q
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           =
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 0.8413em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0785em;">
           X
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.1389em;">
            W
           </span>
           <span class="msupsub">
            <span class="vlist-t">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.8413em;">
               <span class="" style="top: -3.063em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight">
                  Q
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </li>
     <li>
      <strong>
       键（Key, K）
      </strong>
      ：
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         K 
         
        
          = 
         
        
          X 
         
         
         
           W 
          
         
           K 
          
         
        
       
         K = X W^K
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.6833em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0715em;">
           K
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           =
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 0.8413em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0785em;">
           X
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.1389em;">
            W
           </span>
           <span class="msupsub">
            <span class="vlist-t">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.8413em;">
               <span class="" style="top: -3.063em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.0715em;">
                  K
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </li>
     <li>
      <strong>
       值（Value, V）
      </strong>
      ：$ V = X W^V$
     </li>
    </ul>
    <p>
     其中：
    </p>
    <ul>
     <li>
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         W 
          
         
           Q 
          
         
        
          , 
         
         
         
           W 
          
         
           K 
          
         
        
          , 
         
         
         
           W 
          
         
           V 
          
         
        
       
         W^Q, W^K, W^V
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 1.0358em; vertical-align: -0.1944em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.1389em;">
            W
           </span>
           <span class="msupsub">
            <span class="vlist-t">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.8413em;">
               <span class="" style="top: -3.063em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight">
                  Q
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.1389em;">
            W
           </span>
           <span class="msupsub">
            <span class="vlist-t">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.8413em;">
               <span class="" style="top: -3.063em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.0715em;">
                  K
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.1389em;">
            W
           </span>
           <span class="msupsub">
            <span class="vlist-t">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.8413em;">
               <span class="" style="top: -3.063em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.2222em;">
                  V
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      是可训练的权重矩阵
     </li>
     <li>
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         X 
         
        
       
         X
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.6833em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0785em;">
           X
          </span>
         </span>
        </span>
       </span>
      </span>
      是输入特征（如词向量）
     </li>
    </ul>
    <h6>
     <a id="2_433">
     </a>
     <strong>
      （2）计算注意力权重
     </strong>
    </h6>
    <p>
     注意力分数使用
     <strong>
      点积计算
     </strong>
     ：
     <br/>
     <span class="katex--display">
      <span class="katex-display">
       <span class="katex">
        <span class="katex-mathml">
         S 
         
        
          = 
         
        
          Q 
         
         
         
           K 
          
         
           T 
          
         
        
       
         S = QK^T
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.6833em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0576em;">
           S
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           =
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 1.0858em; vertical-align: -0.1944em;">
          </span>
          <span class="mord mathnormal">
           Q
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.0715em;">
            K
           </span>
           <span class="msupsub">
            <span class="vlist-t">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.8913em;">
               <span class="" style="top: -3.113em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.1389em;">
                  T
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     <br/>
     然后进行
     <strong>
      缩放
     </strong>
     （防止梯度爆炸）：
     <br/>
     <span class="katex--display">
      <span class="katex-display">
       <span class="katex">
        <span class="katex-mathml">
         S 
          
         
           scaled 
          
         
        
          = 
         
         
          
          
            Q 
           
           
           
             K 
            
           
             T 
            
           
          
          
           
           
             d 
            
           
             k 
            
           
          
         
        
       
         S_{\text{scaled}} = \frac{QK^T}{\sqrt{d_k}}
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.8333em; vertical-align: -0.15em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.0576em;">
            S
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3361em;">
               <span class="" style="top: -2.55em; margin-left: -0.0576em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord text mtight">
                   <span class="mord mtight">
                    scaled
                   </span>
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           =
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 2.4483em; vertical-align: -0.93em;">
          </span>
          <span class="mord">
           <span class="mopen nulldelimiter">
           </span>
           <span class="mfrac">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 1.5183em;">
               <span class="" style="top: -2.2528em;">
                <span class="pstrut" style="height: 3em;">
                </span>
                <span class="mord">
                 <span class="mord sqrt">
                  <span class="vlist-t vlist-t2">
                   <span class="vlist-r">
                    <span class="vlist" style="height: 0.8572em;">
                     <span class="svg-align" style="top: -3em;">
                      <span class="pstrut" style="height: 3em;">
                      </span>
                      <span class="mord" style="padding-left: 0.833em;">
                       <span class="mord">
                        <span class="mord mathnormal">
                         d
                        </span>
                        <span class="msupsub">
                         <span class="vlist-t vlist-t2">
                          <span class="vlist-r">
                           <span class="vlist" style="height: 0.3361em;">
                            <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                             <span class="pstrut" style="height: 2.7em;">
                             </span>
                             <span class="sizing reset-size6 size3 mtight">
                              <span class="mord mathnormal mtight" style="margin-right: 0.0315em;">
                               k
                              </span>
                             </span>
                            </span>
                           </span>
                           <span class="vlist-s">
                            ​
                           </span>
                          </span>
                          <span class="vlist-r">
                           <span class="vlist" style="height: 0.15em;">
                            <span class="">
                            </span>
                           </span>
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                     </span>
                     <span class="" style="top: -2.8172em;">
                      <span class="pstrut" style="height: 3em;">
                      </span>
                      <span class="hide-tail" style="min-width: 0.853em; height: 1.08em;">
                       <svg height="1.08em" preserveaspectratio="xMinYMin slice" viewbox="0 0 400000 1080" width="400em">
                        <path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z">
                        </path>
                       </svg>
                      </span>
                     </span>
                    </span>
                    <span class="vlist-s">
                     ​
                    </span>
                   </span>
                   <span class="vlist-r">
                    <span class="vlist" style="height: 0.1828em;">
                     <span class="">
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
               </span>
               <span class="" style="top: -3.23em;">
                <span class="pstrut" style="height: 3em;">
                </span>
                <span class="frac-line" style="border-bottom-width: 0.04em;">
                </span>
               </span>
               <span class="" style="top: -3.677em;">
                <span class="pstrut" style="height: 3em;">
                </span>
                <span class="mord">
                 <span class="mord mathnormal">
                  Q
                 </span>
                 <span class="mord">
                  <span class="mord mathnormal" style="margin-right: 0.0715em;">
                   K
                  </span>
                  <span class="msupsub">
                   <span class="vlist-t">
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.8413em;">
                      <span class="" style="top: -3.063em; margin-right: 0.05em;">
                       <span class="pstrut" style="height: 2.7em;">
                       </span>
                       <span class="sizing reset-size6 size3 mtight">
                        <span class="mord mathnormal mtight" style="margin-right: 0.1389em;">
                         T
                        </span>
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.93em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mclose nulldelimiter">
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     <br/>
     其中：
    </p>
    <ul>
     <li>
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         d 
          
         
           k 
          
         
        
       
         d_k
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.8444em; vertical-align: -0.15em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            d
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3361em;">
               <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.0315em;">
                  k
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      是键向量的维度
     </li>
     <li>
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         d 
           
          
            k 
           
          
         
        
       
         \sqrt{d_k}
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 1.04em; vertical-align: -0.1828em;">
          </span>
          <span class="mord sqrt">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.8572em;">
              <span class="svg-align" style="top: -3em;">
               <span class="pstrut" style="height: 3em;">
               </span>
               <span class="mord" style="padding-left: 0.833em;">
                <span class="mord">
                 <span class="mord mathnormal">
                  d
                 </span>
                 <span class="msupsub">
                  <span class="vlist-t vlist-t2">
                   <span class="vlist-r">
                    <span class="vlist" style="height: 0.3361em;">
                     <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                      <span class="pstrut" style="height: 2.7em;">
                      </span>
                      <span class="sizing reset-size6 size3 mtight">
                       <span class="mord mathnormal mtight" style="margin-right: 0.0315em;">
                        k
                       </span>
                      </span>
                     </span>
                    </span>
                    <span class="vlist-s">
                     ​
                    </span>
                   </span>
                   <span class="vlist-r">
                    <span class="vlist" style="height: 0.15em;">
                     <span class="">
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="" style="top: -2.8172em;">
               <span class="pstrut" style="height: 3em;">
               </span>
               <span class="hide-tail" style="min-width: 0.853em; height: 1.08em;">
                <svg height="1.08em" preserveaspectratio="xMinYMin slice" viewbox="0 0 400000 1080" width="400em">
                 <path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z">
                 </path>
                </svg>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.1828em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      作为缩放因子，防止数值过大导致梯度消失或梯度爆炸
     </li>
    </ul>
    <h6>
     <a id="3_Softmax__446">
     </a>
     <strong>
      （3）计算 Softmax 权重
     </strong>
    </h6>
    <p>
     <span class="katex--display">
      <span class="katex-display">
       <span class="katex">
        <span class="katex-mathml">
         α 
         
        
          = 
         
        
          softmax 
         
        
          ( 
         
         
         
           S 
          
         
           scaled 
          
         
        
          ) 
         
        
       
         \alpha = \text{softmax}(S_{\text{scaled}})
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.4306em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0037em;">
           α
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           =
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 1em; vertical-align: -0.25em;">
          </span>
          <span class="mord text">
           <span class="mord">
            softmax
           </span>
          </span>
          <span class="mopen">
           (
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.0576em;">
            S
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3361em;">
               <span class="" style="top: -2.55em; margin-left: -0.0576em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord text mtight">
                   <span class="mord mtight">
                    scaled
                   </span>
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mclose">
           )
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     <br/>
     Softmax 归一化后，表示不同位置的注意力分布。
    </p>
    <h6>
     <a id="4_452">
     </a>
     <strong>
      （4）加权求和
     </strong>
    </h6>
    <p>
     计算最终的注意力输出：
     <br/>
     <span class="katex--display">
      <span class="katex-display">
       <span class="katex">
        <span class="katex-mathml">
         Attention 
         
        
          ( 
         
        
          Q 
         
        
          , 
         
        
          K 
         
        
          , 
         
        
          V 
         
        
          ) 
         
        
          = 
         
        
          α 
         
        
          V 
         
        
       
         \text{Attention}(Q, K, V) = \alpha V
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 1em; vertical-align: -0.25em;">
          </span>
          <span class="mord text">
           <span class="mord">
            Attention
           </span>
          </span>
          <span class="mopen">
           (
          </span>
          <span class="mord mathnormal">
           Q
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0715em;">
           K
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.2222em;">
           V
          </span>
          <span class="mclose">
           )
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           =
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 0.6833em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0037em;">
           α
          </span>
          <span class="mord mathnormal" style="margin-right: 0.2222em;">
           V
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
    </p>
    <hr/>
    <h5>
     <a id="2_MultiHead_Attention_MHA_460">
     </a>
     <strong>
      2. 多头注意力（Multi-Head Attention, MHA）
     </strong>
    </h5>
    <p>
     在单头注意力机制中，所有信息都通过同一个注意力机制计算，可能会忽略一些重要特征。
     <strong>
      多头注意力的核心思想是：使用多个注意力头（heads），让模型关注不同的特征信息。
     </strong>
    </p>
    <h6>
     <a id="1_463">
     </a>
     <strong>
      （1）多头注意力计算流程
     </strong>
    </h6>
    <ol>
     <li>
      <p>
       <strong>
        输入映射到多个 Q、K、V
       </strong>
      </p>
      <ul>
       <li>
        对输入
        <span class="katex--inline">
         <span class="katex">
          <span class="katex-mathml">
           X 
           
          
         
           X
          </span>
          <span class="katex-html">
           <span class="base">
            <span class="strut" style="height: 0.6833em;">
            </span>
            <span class="mord mathnormal" style="margin-right: 0.0785em;">
             X
            </span>
           </span>
          </span>
         </span>
        </span>
        进行多组不同的线性变换，得到多个查询、键和值：
        <br/>
        <span class="katex--display">
         <span class="katex-display">
          <span class="katex">
           <span class="katex-mathml">
            Q 
             
            
              i 
             
            
           
             = 
            
           
             X 
            
            
            
              W 
             
            
              i 
             
            
              Q 
             
            
           
             , 
            
            
            
            
              K 
             
            
              i 
             
            
           
             = 
            
           
             X 
            
            
            
              W 
             
            
              i 
             
            
              K 
             
            
           
             , 
            
            
            
            
              V 
             
            
              i 
             
            
           
             = 
            
           
             X 
            
            
            
              W 
             
            
              i 
             
            
              V 
             
            
           
             , 
            
            
           
             i 
            
           
             = 
            
           
             1 
            
           
             , 
            
           
             2 
            
           
             , 
            
           
             … 
            
           
             , 
            
           
             h 
            
           
          
            Q_i = X W_i^Q, \quad K_i = X W_i^K, \quad V_i = X W_i^V, \quad i = 1,2,\dots,h
           </span>
           <span class="katex-html">
            <span class="base">
             <span class="strut" style="height: 0.8778em; vertical-align: -0.1944em;">
             </span>
             <span class="mord">
              <span class="mord mathnormal">
               Q
              </span>
              <span class="msupsub">
               <span class="vlist-t vlist-t2">
                <span class="vlist-r">
                 <span class="vlist" style="height: 0.3117em;">
                  <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                   <span class="pstrut" style="height: 2.7em;">
                   </span>
                   <span class="sizing reset-size6 size3 mtight">
                    <span class="mord mathnormal mtight">
                     i
                    </span>
                   </span>
                  </span>
                 </span>
                 <span class="vlist-s">
                  ​
                 </span>
                </span>
                <span class="vlist-r">
                 <span class="vlist" style="height: 0.15em;">
                  <span class="">
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="mspace" style="margin-right: 0.2778em;">
             </span>
             <span class="mrel">
              =
             </span>
             <span class="mspace" style="margin-right: 0.2778em;">
             </span>
            </span>
            <span class="base">
             <span class="strut" style="height: 1.2361em; vertical-align: -0.2769em;">
             </span>
             <span class="mord mathnormal" style="margin-right: 0.0785em;">
              X
             </span>
             <span class="mord">
              <span class="mord mathnormal" style="margin-right: 0.1389em;">
               W
              </span>
              <span class="msupsub">
               <span class="vlist-t vlist-t2">
                <span class="vlist-r">
                 <span class="vlist" style="height: 0.9592em;">
                  <span class="" style="top: -2.4231em; margin-left: -0.1389em; margin-right: 0.05em;">
                   <span class="pstrut" style="height: 2.7em;">
                   </span>
                   <span class="sizing reset-size6 size3 mtight">
                    <span class="mord mathnormal mtight">
                     i
                    </span>
                   </span>
                  </span>
                  <span class="" style="top: -3.1809em; margin-right: 0.05em;">
                   <span class="pstrut" style="height: 2.7em;">
                   </span>
                   <span class="sizing reset-size6 size3 mtight">
                    <span class="mord mathnormal mtight">
                     Q
                    </span>
                   </span>
                  </span>
                 </span>
                 <span class="vlist-s">
                  ​
                 </span>
                </span>
                <span class="vlist-r">
                 <span class="vlist" style="height: 0.2769em;">
                  <span class="">
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="mpunct">
              ,
             </span>
             <span class="mspace" style="margin-right: 1em;">
             </span>
             <span class="mspace" style="margin-right: 0.1667em;">
             </span>
             <span class="mord">
              <span class="mord mathnormal" style="margin-right: 0.0715em;">
               K
              </span>
              <span class="msupsub">
               <span class="vlist-t vlist-t2">
                <span class="vlist-r">
                 <span class="vlist" style="height: 0.3117em;">
                  <span class="" style="top: -2.55em; margin-left: -0.0715em; margin-right: 0.05em;">
                   <span class="pstrut" style="height: 2.7em;">
                   </span>
                   <span class="sizing reset-size6 size3 mtight">
                    <span class="mord mathnormal mtight">
                     i
                    </span>
                   </span>
                  </span>
                 </span>
                 <span class="vlist-s">
                  ​
                 </span>
                </span>
                <span class="vlist-r">
                 <span class="vlist" style="height: 0.15em;">
                  <span class="">
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="mspace" style="margin-right: 0.2778em;">
             </span>
             <span class="mrel">
              =
             </span>
             <span class="mspace" style="margin-right: 0.2778em;">
             </span>
            </span>
            <span class="base">
             <span class="strut" style="height: 1.1383em; vertical-align: -0.247em;">
             </span>
             <span class="mord mathnormal" style="margin-right: 0.0785em;">
              X
             </span>
             <span class="mord">
              <span class="mord mathnormal" style="margin-right: 0.1389em;">
               W
              </span>
              <span class="msupsub">
               <span class="vlist-t vlist-t2">
                <span class="vlist-r">
                 <span class="vlist" style="height: 0.8913em;">
                  <span class="" style="top: -2.453em; margin-left: -0.1389em; margin-right: 0.05em;">
                   <span class="pstrut" style="height: 2.7em;">
                   </span>
                   <span class="sizing reset-size6 size3 mtight">
                    <span class="mord mathnormal mtight">
                     i
                    </span>
                   </span>
                  </span>
                  <span class="" style="top: -3.113em; margin-right: 0.05em;">
                   <span class="pstrut" style="height: 2.7em;">
                   </span>
                   <span class="sizing reset-size6 size3 mtight">
                    <span class="mord mathnormal mtight" style="margin-right: 0.0715em;">
                     K
                    </span>
                   </span>
                  </span>
                 </span>
                 <span class="vlist-s">
                  ​
                 </span>
                </span>
                <span class="vlist-r">
                 <span class="vlist" style="height: 0.247em;">
                  <span class="">
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="mpunct">
              ,
             </span>
             <span class="mspace" style="margin-right: 1em;">
             </span>
             <span class="mspace" style="margin-right: 0.1667em;">
             </span>
             <span class="mord">
              <span class="mord mathnormal" style="margin-right: 0.2222em;">
               V
              </span>
              <span class="msupsub">
               <span class="vlist-t vlist-t2">
                <span class="vlist-r">
                 <span class="vlist" style="height: 0.3117em;">
                  <span class="" style="top: -2.55em; margin-left: -0.2222em; margin-right: 0.05em;">
                   <span class="pstrut" style="height: 2.7em;">
                   </span>
                   <span class="sizing reset-size6 size3 mtight">
                    <span class="mord mathnormal mtight">
                     i
                    </span>
                   </span>
                  </span>
                 </span>
                 <span class="vlist-s">
                  ​
                 </span>
                </span>
                <span class="vlist-r">
                 <span class="vlist" style="height: 0.15em;">
                  <span class="">
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="mspace" style="margin-right: 0.2778em;">
             </span>
             <span class="mrel">
              =
             </span>
             <span class="mspace" style="margin-right: 0.2778em;">
             </span>
            </span>
            <span class="base">
             <span class="strut" style="height: 1.1383em; vertical-align: -0.247em;">
             </span>
             <span class="mord mathnormal" style="margin-right: 0.0785em;">
              X
             </span>
             <span class="mord">
              <span class="mord mathnormal" style="margin-right: 0.1389em;">
               W
              </span>
              <span class="msupsub">
               <span class="vlist-t vlist-t2">
                <span class="vlist-r">
                 <span class="vlist" style="height: 0.8913em;">
                  <span class="" style="top: -2.453em; margin-left: -0.1389em; margin-right: 0.05em;">
                   <span class="pstrut" style="height: 2.7em;">
                   </span>
                   <span class="sizing reset-size6 size3 mtight">
                    <span class="mord mathnormal mtight">
                     i
                    </span>
                   </span>
                  </span>
                  <span class="" style="top: -3.113em; margin-right: 0.05em;">
                   <span class="pstrut" style="height: 2.7em;">
                   </span>
                   <span class="sizing reset-size6 size3 mtight">
                    <span class="mord mathnormal mtight" style="margin-right: 0.2222em;">
                     V
                    </span>
                   </span>
                  </span>
                 </span>
                 <span class="vlist-s">
                  ​
                 </span>
                </span>
                <span class="vlist-r">
                 <span class="vlist" style="height: 0.247em;">
                  <span class="">
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="mpunct">
              ,
             </span>
             <span class="mspace" style="margin-right: 1em;">
             </span>
             <span class="mspace" style="margin-right: 0.1667em;">
             </span>
             <span class="mord mathnormal">
              i
             </span>
             <span class="mspace" style="margin-right: 0.2778em;">
             </span>
             <span class="mrel">
              =
             </span>
             <span class="mspace" style="margin-right: 0.2778em;">
             </span>
            </span>
            <span class="base">
             <span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;">
             </span>
             <span class="mord">
              1
             </span>
             <span class="mpunct">
              ,
             </span>
             <span class="mspace" style="margin-right: 0.1667em;">
             </span>
             <span class="mord">
              2
             </span>
             <span class="mpunct">
              ,
             </span>
             <span class="mspace" style="margin-right: 0.1667em;">
             </span>
             <span class="minner">
              …
             </span>
             <span class="mspace" style="margin-right: 0.1667em;">
             </span>
             <span class="mpunct">
              ,
             </span>
             <span class="mspace" style="margin-right: 0.1667em;">
             </span>
             <span class="mord mathnormal">
              h
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </li>
       <li>
        其中
        <span class="katex--inline">
         <span class="katex">
          <span class="katex-mathml">
           h 
           
          
         
           h
          </span>
          <span class="katex-html">
           <span class="base">
            <span class="strut" style="height: 0.6944em;">
            </span>
            <span class="mord mathnormal">
             h
            </span>
           </span>
          </span>
         </span>
        </span>
        是注意力头的数量，每个注意力头都有自己的权重矩阵
        <span class="katex--inline">
         <span class="katex">
          <span class="katex-mathml">
           W 
            
           
             i 
            
           
             Q 
            
           
          
            , 
           
           
           
             W 
            
           
             i 
            
           
             K 
            
           
          
            , 
           
           
           
             W 
            
           
             i 
            
           
             V 
            
           
          
         
           W_i^Q, W_i^K, W_i^V
          </span>
          <span class="katex-html">
           <span class="base">
            <span class="strut" style="height: 1.2361em; vertical-align: -0.2769em;">
            </span>
            <span class="mord">
             <span class="mord mathnormal" style="margin-right: 0.1389em;">
              W
             </span>
             <span class="msupsub">
              <span class="vlist-t vlist-t2">
               <span class="vlist-r">
                <span class="vlist" style="height: 0.9592em;">
                 <span class="" style="top: -2.4231em; margin-left: -0.1389em; margin-right: 0.05em;">
                  <span class="pstrut" style="height: 2.7em;">
                  </span>
                  <span class="sizing reset-size6 size3 mtight">
                   <span class="mord mathnormal mtight">
                    i
                   </span>
                  </span>
                 </span>
                 <span class="" style="top: -3.1809em; margin-right: 0.05em;">
                  <span class="pstrut" style="height: 2.7em;">
                  </span>
                  <span class="sizing reset-size6 size3 mtight">
                   <span class="mord mathnormal mtight">
                    Q
                   </span>
                  </span>
                 </span>
                </span>
                <span class="vlist-s">
                 ​
                </span>
               </span>
               <span class="vlist-r">
                <span class="vlist" style="height: 0.2769em;">
                 <span class="">
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
            <span class="mpunct">
             ,
            </span>
            <span class="mspace" style="margin-right: 0.1667em;">
            </span>
            <span class="mord">
             <span class="mord mathnormal" style="margin-right: 0.1389em;">
              W
             </span>
             <span class="msupsub">
              <span class="vlist-t vlist-t2">
               <span class="vlist-r">
                <span class="vlist" style="height: 0.8413em;">
                 <span class="" style="top: -2.4413em; margin-left: -0.1389em; margin-right: 0.05em;">
                  <span class="pstrut" style="height: 2.7em;">
                  </span>
                  <span class="sizing reset-size6 size3 mtight">
                   <span class="mord mathnormal mtight">
                    i
                   </span>
                  </span>
                 </span>
                 <span class="" style="top: -3.063em; margin-right: 0.05em;">
                  <span class="pstrut" style="height: 2.7em;">
                  </span>
                  <span class="sizing reset-size6 size3 mtight">
                   <span class="mord mathnormal mtight" style="margin-right: 0.0715em;">
                    K
                   </span>
                  </span>
                 </span>
                </span>
                <span class="vlist-s">
                 ​
                </span>
               </span>
               <span class="vlist-r">
                <span class="vlist" style="height: 0.2587em;">
                 <span class="">
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
            <span class="mpunct">
             ,
            </span>
            <span class="mspace" style="margin-right: 0.1667em;">
            </span>
            <span class="mord">
             <span class="mord mathnormal" style="margin-right: 0.1389em;">
              W
             </span>
             <span class="msupsub">
              <span class="vlist-t vlist-t2">
               <span class="vlist-r">
                <span class="vlist" style="height: 0.8413em;">
                 <span class="" style="top: -2.4413em; margin-left: -0.1389em; margin-right: 0.05em;">
                  <span class="pstrut" style="height: 2.7em;">
                  </span>
                  <span class="sizing reset-size6 size3 mtight">
                   <span class="mord mathnormal mtight">
                    i
                   </span>
                  </span>
                 </span>
                 <span class="" style="top: -3.063em; margin-right: 0.05em;">
                  <span class="pstrut" style="height: 2.7em;">
                  </span>
                  <span class="sizing reset-size6 size3 mtight">
                   <span class="mord mathnormal mtight" style="margin-right: 0.2222em;">
                    V
                   </span>
                  </span>
                 </span>
                </span>
                <span class="vlist-s">
                 ​
                </span>
               </span>
               <span class="vlist-r">
                <span class="vlist" style="height: 0.2587em;">
                 <span class="">
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
        。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        每个头独立计算注意力
       </strong>
      </p>
      <ul>
       <li>
        每个头独立计算缩放点积注意力：
        <br/>
        <span class="katex--display">
         <span class="katex-display">
          <span class="katex">
           <span class="katex-mathml">
            Attention 
             
            
              i 
             
            
           
             ( 
            
            
            
              Q 
             
            
              i 
             
            
           
             , 
            
            
            
              K 
             
            
              i 
             
            
           
             , 
            
            
            
              V 
             
            
              i 
             
            
           
             ) 
            
           
             = 
            
           
             softmax 
            
            
            
              ( 
             
             
              
               
               
                 Q 
                
               
                 i 
                
               
               
               
                 K 
                
               
                 i 
                
               
                 T 
                
               
              
              
               
               
                 d 
                
               
                 k 
                
               
              
             
            
              ) 
             
            
            
            
              V 
             
            
              i 
             
            
           
          
            \text{Attention}_i(Q_i, K_i, V_i) = \text{softmax} \left( \frac{Q_i K_i^T}{\sqrt{d_k}} \right) V_i
           </span>
           <span class="katex-html">
            <span class="base">
             <span class="strut" style="height: 1em; vertical-align: -0.25em;">
             </span>
             <span class="mord">
              <span class="mord text">
               <span class="mord">
                Attention
               </span>
              </span>
              <span class="msupsub">
               <span class="vlist-t vlist-t2">
                <span class="vlist-r">
                 <span class="vlist" style="height: 0.3117em;">
                  <span class="" style="top: -2.55em; margin-right: 0.05em;">
                   <span class="pstrut" style="height: 2.7em;">
                   </span>
                   <span class="sizing reset-size6 size3 mtight">
                    <span class="mord mathnormal mtight">
                     i
                    </span>
                   </span>
                  </span>
                 </span>
                 <span class="vlist-s">
                  ​
                 </span>
                </span>
                <span class="vlist-r">
                 <span class="vlist" style="height: 0.15em;">
                  <span class="">
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="mopen">
              (
             </span>
             <span class="mord">
              <span class="mord mathnormal">
               Q
              </span>
              <span class="msupsub">
               <span class="vlist-t vlist-t2">
                <span class="vlist-r">
                 <span class="vlist" style="height: 0.3117em;">
                  <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                   <span class="pstrut" style="height: 2.7em;">
                   </span>
                   <span class="sizing reset-size6 size3 mtight">
                    <span class="mord mathnormal mtight">
                     i
                    </span>
                   </span>
                  </span>
                 </span>
                 <span class="vlist-s">
                  ​
                 </span>
                </span>
                <span class="vlist-r">
                 <span class="vlist" style="height: 0.15em;">
                  <span class="">
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="mpunct">
              ,
             </span>
             <span class="mspace" style="margin-right: 0.1667em;">
             </span>
             <span class="mord">
              <span class="mord mathnormal" style="margin-right: 0.0715em;">
               K
              </span>
              <span class="msupsub">
               <span class="vlist-t vlist-t2">
                <span class="vlist-r">
                 <span class="vlist" style="height: 0.3117em;">
                  <span class="" style="top: -2.55em; margin-left: -0.0715em; margin-right: 0.05em;">
                   <span class="pstrut" style="height: 2.7em;">
                   </span>
                   <span class="sizing reset-size6 size3 mtight">
                    <span class="mord mathnormal mtight">
                     i
                    </span>
                   </span>
                  </span>
                 </span>
                 <span class="vlist-s">
                  ​
                 </span>
                </span>
                <span class="vlist-r">
                 <span class="vlist" style="height: 0.15em;">
                  <span class="">
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="mpunct">
              ,
             </span>
             <span class="mspace" style="margin-right: 0.1667em;">
             </span>
             <span class="mord">
              <span class="mord mathnormal" style="margin-right: 0.2222em;">
               V
              </span>
              <span class="msupsub">
               <span class="vlist-t vlist-t2">
                <span class="vlist-r">
                 <span class="vlist" style="height: 0.3117em;">
                  <span class="" style="top: -2.55em; margin-left: -0.2222em; margin-right: 0.05em;">
                   <span class="pstrut" style="height: 2.7em;">
                   </span>
                   <span class="sizing reset-size6 size3 mtight">
                    <span class="mord mathnormal mtight">
                     i
                    </span>
                   </span>
                  </span>
                 </span>
                 <span class="vlist-s">
                  ​
                 </span>
                </span>
                <span class="vlist-r">
                 <span class="vlist" style="height: 0.15em;">
                  <span class="">
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="mclose">
              )
             </span>
             <span class="mspace" style="margin-right: 0.2778em;">
             </span>
             <span class="mrel">
              =
             </span>
             <span class="mspace" style="margin-right: 0.2778em;">
             </span>
            </span>
            <span class="base">
             <span class="strut" style="height: 2.4684em; vertical-align: -0.95em;">
             </span>
             <span class="mord text">
              <span class="mord">
               softmax
              </span>
             </span>
             <span class="mspace" style="margin-right: 0.1667em;">
             </span>
             <span class="minner">
              <span class="mopen delimcenter" style="top: 0em;">
               <span class="delimsizing size3">
                (
               </span>
              </span>
              <span class="mord">
               <span class="mopen nulldelimiter">
               </span>
               <span class="mfrac">
                <span class="vlist-t vlist-t2">
                 <span class="vlist-r">
                  <span class="vlist" style="height: 1.5183em;">
                   <span class="" style="top: -2.2528em;">
                    <span class="pstrut" style="height: 3em;">
                    </span>
                    <span class="mord">
                     <span class="mord sqrt">
                      <span class="vlist-t vlist-t2">
                       <span class="vlist-r">
                        <span class="vlist" style="height: 0.8572em;">
                         <span class="svg-align" style="top: -3em;">
                          <span class="pstrut" style="height: 3em;">
                          </span>
                          <span class="mord" style="padding-left: 0.833em;">
                           <span class="mord">
                            <span class="mord mathnormal">
                             d
                            </span>
                            <span class="msupsub">
                             <span class="vlist-t vlist-t2">
                              <span class="vlist-r">
                               <span class="vlist" style="height: 0.3361em;">
                                <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                                 <span class="pstrut" style="height: 2.7em;">
                                 </span>
                                 <span class="sizing reset-size6 size3 mtight">
                                  <span class="mord mathnormal mtight" style="margin-right: 0.0315em;">
                                   k
                                  </span>
                                 </span>
                                </span>
                               </span>
                               <span class="vlist-s">
                                ​
                               </span>
                              </span>
                              <span class="vlist-r">
                               <span class="vlist" style="height: 0.15em;">
                                <span class="">
                                </span>
                               </span>
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                         </span>
                         <span class="" style="top: -2.8172em;">
                          <span class="pstrut" style="height: 3em;">
                          </span>
                          <span class="hide-tail" style="min-width: 0.853em; height: 1.08em;">
                           <svg height="1.08em" preserveaspectratio="xMinYMin slice" viewbox="0 0 400000 1080" width="400em">
                            <path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z">
                            </path>
                           </svg>
                          </span>
                         </span>
                        </span>
                        <span class="vlist-s">
                         ​
                        </span>
                       </span>
                       <span class="vlist-r">
                        <span class="vlist" style="height: 0.1828em;">
                         <span class="">
                         </span>
                        </span>
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                   <span class="" style="top: -3.23em;">
                    <span class="pstrut" style="height: 3em;">
                    </span>
                    <span class="frac-line" style="border-bottom-width: 0.04em;">
                    </span>
                   </span>
                   <span class="" style="top: -3.677em;">
                    <span class="pstrut" style="height: 3em;">
                    </span>
                    <span class="mord">
                     <span class="mord">
                      <span class="mord mathnormal">
                       Q
                      </span>
                      <span class="msupsub">
                       <span class="vlist-t vlist-t2">
                        <span class="vlist-r">
                         <span class="vlist" style="height: 0.3117em;">
                          <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                           <span class="pstrut" style="height: 2.7em;">
                           </span>
                           <span class="sizing reset-size6 size3 mtight">
                            <span class="mord mathnormal mtight">
                             i
                            </span>
                           </span>
                          </span>
                         </span>
                         <span class="vlist-s">
                          ​
                         </span>
                        </span>
                        <span class="vlist-r">
                         <span class="vlist" style="height: 0.15em;">
                          <span class="">
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                     </span>
                     <span class="mord">
                      <span class="mord mathnormal" style="margin-right: 0.0715em;">
                       K
                      </span>
                      <span class="msupsub">
                       <span class="vlist-t vlist-t2">
                        <span class="vlist-r">
                         <span class="vlist" style="height: 0.8413em;">
                          <span class="" style="top: -2.4413em; margin-left: -0.0715em; margin-right: 0.05em;">
                           <span class="pstrut" style="height: 2.7em;">
                           </span>
                           <span class="sizing reset-size6 size3 mtight">
                            <span class="mord mathnormal mtight">
                             i
                            </span>
                           </span>
                          </span>
                          <span class="" style="top: -3.063em; margin-right: 0.05em;">
                           <span class="pstrut" style="height: 2.7em;">
                           </span>
                           <span class="sizing reset-size6 size3 mtight">
                            <span class="mord mathnormal mtight" style="margin-right: 0.1389em;">
                             T
                            </span>
                           </span>
                          </span>
                         </span>
                         <span class="vlist-s">
                          ​
                         </span>
                        </span>
                        <span class="vlist-r">
                         <span class="vlist" style="height: 0.2587em;">
                          <span class="">
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                  <span class="vlist-s">
                   ​
                  </span>
                 </span>
                 <span class="vlist-r">
                  <span class="vlist" style="height: 0.93em;">
                   <span class="">
                   </span>
                  </span>
                 </span>
                </span>
               </span>
               <span class="mclose nulldelimiter">
               </span>
              </span>
              <span class="mclose delimcenter" style="top: 0em;">
               <span class="delimsizing size3">
                )
               </span>
              </span>
             </span>
             <span class="mspace" style="margin-right: 0.1667em;">
             </span>
             <span class="mord">
              <span class="mord mathnormal" style="margin-right: 0.2222em;">
               V
              </span>
              <span class="msupsub">
               <span class="vlist-t vlist-t2">
                <span class="vlist-r">
                 <span class="vlist" style="height: 0.3117em;">
                  <span class="" style="top: -2.55em; margin-left: -0.2222em; margin-right: 0.05em;">
                   <span class="pstrut" style="height: 2.7em;">
                   </span>
                   <span class="sizing reset-size6 size3 mtight">
                    <span class="mord mathnormal mtight">
                     i
                    </span>
                   </span>
                  </span>
                 </span>
                 <span class="vlist-s">
                  ​
                 </span>
                </span>
                <span class="vlist-r">
                 <span class="vlist" style="height: 0.15em;">
                  <span class="">
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        拼接多个头的输出
       </strong>
      </p>
      <ul>
       <li>
        将所有注意力头的输出拼接在一起：
        <br/>
        <span class="katex--display">
         <span class="katex-display">
          <span class="katex">
           <span class="katex-mathml">
            MultiHead 
            
           
             ( 
            
           
             Q 
            
           
             , 
            
           
             K 
            
           
             , 
            
           
             V 
            
           
             ) 
            
           
             = 
            
           
             Concat 
            
           
             ( 
            
            
            
              head 
             
            
              1 
             
            
           
             , 
            
            
            
              head 
             
            
              2 
             
            
           
             , 
            
           
             … 
            
           
             , 
            
            
            
              head 
             
            
              h 
             
            
           
             ) 
            
            
            
              W 
             
            
              O 
             
            
           
          
            \text{MultiHead}(Q, K, V) = \text{Concat}(\text{head}_1, \text{head}_2, \dots, \text{head}_h) W^O
           </span>
           <span class="katex-html">
            <span class="base">
             <span class="strut" style="height: 1em; vertical-align: -0.25em;">
             </span>
             <span class="mord text">
              <span class="mord">
               MultiHead
              </span>
             </span>
             <span class="mopen">
              (
             </span>
             <span class="mord mathnormal">
              Q
             </span>
             <span class="mpunct">
              ,
             </span>
             <span class="mspace" style="margin-right: 0.1667em;">
             </span>
             <span class="mord mathnormal" style="margin-right: 0.0715em;">
              K
             </span>
             <span class="mpunct">
              ,
             </span>
             <span class="mspace" style="margin-right: 0.1667em;">
             </span>
             <span class="mord mathnormal" style="margin-right: 0.2222em;">
              V
             </span>
             <span class="mclose">
              )
             </span>
             <span class="mspace" style="margin-right: 0.2778em;">
             </span>
             <span class="mrel">
              =
             </span>
             <span class="mspace" style="margin-right: 0.2778em;">
             </span>
            </span>
            <span class="base">
             <span class="strut" style="height: 1.1413em; vertical-align: -0.25em;">
             </span>
             <span class="mord text">
              <span class="mord">
               Concat
              </span>
             </span>
             <span class="mopen">
              (
             </span>
             <span class="mord">
              <span class="mord text">
               <span class="mord">
                head
               </span>
              </span>
              <span class="msupsub">
               <span class="vlist-t vlist-t2">
                <span class="vlist-r">
                 <span class="vlist" style="height: 0.3011em;">
                  <span class="" style="top: -2.55em; margin-right: 0.05em;">
                   <span class="pstrut" style="height: 2.7em;">
                   </span>
                   <span class="sizing reset-size6 size3 mtight">
                    <span class="mord mtight">
                     1
                    </span>
                   </span>
                  </span>
                 </span>
                 <span class="vlist-s">
                  ​
                 </span>
                </span>
                <span class="vlist-r">
                 <span class="vlist" style="height: 0.15em;">
                  <span class="">
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="mpunct">
              ,
             </span>
             <span class="mspace" style="margin-right: 0.1667em;">
             </span>
             <span class="mord">
              <span class="mord text">
               <span class="mord">
                head
               </span>
              </span>
              <span class="msupsub">
               <span class="vlist-t vlist-t2">
                <span class="vlist-r">
                 <span class="vlist" style="height: 0.3011em;">
                  <span class="" style="top: -2.55em; margin-right: 0.05em;">
                   <span class="pstrut" style="height: 2.7em;">
                   </span>
                   <span class="sizing reset-size6 size3 mtight">
                    <span class="mord mtight">
                     2
                    </span>
                   </span>
                  </span>
                 </span>
                 <span class="vlist-s">
                  ​
                 </span>
                </span>
                <span class="vlist-r">
                 <span class="vlist" style="height: 0.15em;">
                  <span class="">
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="mpunct">
              ,
             </span>
             <span class="mspace" style="margin-right: 0.1667em;">
             </span>
             <span class="minner">
              …
             </span>
             <span class="mspace" style="margin-right: 0.1667em;">
             </span>
             <span class="mpunct">
              ,
             </span>
             <span class="mspace" style="margin-right: 0.1667em;">
             </span>
             <span class="mord">
              <span class="mord text">
               <span class="mord">
                head
               </span>
              </span>
              <span class="msupsub">
               <span class="vlist-t vlist-t2">
                <span class="vlist-r">
                 <span class="vlist" style="height: 0.3361em;">
                  <span class="" style="top: -2.55em; margin-right: 0.05em;">
                   <span class="pstrut" style="height: 2.7em;">
                   </span>
                   <span class="sizing reset-size6 size3 mtight">
                    <span class="mord mathnormal mtight">
                     h
                    </span>
                   </span>
                  </span>
                 </span>
                 <span class="vlist-s">
                  ​
                 </span>
                </span>
                <span class="vlist-r">
                 <span class="vlist" style="height: 0.15em;">
                  <span class="">
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="mclose">
              )
             </span>
             <span class="mord">
              <span class="mord mathnormal" style="margin-right: 0.1389em;">
               W
              </span>
              <span class="msupsub">
               <span class="vlist-t">
                <span class="vlist-r">
                 <span class="vlist" style="height: 0.8913em;">
                  <span class="" style="top: -3.113em; margin-right: 0.05em;">
                   <span class="pstrut" style="height: 2.7em;">
                   </span>
                   <span class="sizing reset-size6 size3 mtight">
                    <span class="mord mathnormal mtight" style="margin-right: 0.0278em;">
                     O
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </li>
       <li>
        其中
        <span class="katex--inline">
         <span class="katex">
          <span class="katex-mathml">
           W 
            
           
             O 
            
           
          
         
           W^O
          </span>
          <span class="katex-html">
           <span class="base">
            <span class="strut" style="height: 0.8413em;">
            </span>
            <span class="mord">
             <span class="mord mathnormal" style="margin-right: 0.1389em;">
              W
             </span>
             <span class="msupsub">
              <span class="vlist-t">
               <span class="vlist-r">
                <span class="vlist" style="height: 0.8413em;">
                 <span class="" style="top: -3.063em; margin-right: 0.05em;">
                  <span class="pstrut" style="height: 2.7em;">
                  </span>
                  <span class="sizing reset-size6 size3 mtight">
                   <span class="mord mathnormal mtight" style="margin-right: 0.0278em;">
                    O
                   </span>
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
        是最终的线性变换矩阵，将拼接后的结果映射回原始维度。
       </li>
      </ul>
     </li>
    </ol>
    <hr/>
    <h5>
     <a id="3__486">
     </a>
     <strong>
      3. 公式总结
     </strong>
    </h5>
    <h6>
     <a id="1Scaled_DotProduct_Attention_487">
     </a>
     <strong>
      1.单头注意力（Scaled Dot-Product Attention）
     </strong>
    </h6>
    <p>
     <span class="katex--display">
      <span class="katex-display">
       <span class="katex">
        <span class="katex-mathml">
         Attention 
         
        
          ( 
         
        
          Q 
         
        
          , 
         
        
          K 
         
        
          , 
         
        
          V 
         
        
          ) 
         
        
          = 
         
        
          softmax 
         
         
         
           ( 
          
          
           
           
             Q 
            
            
            
              K 
             
            
              T 
             
            
           
           
            
            
              d 
             
            
              k 
             
            
           
          
         
           ) 
          
         
        
          V 
         
        
       
         \text{Attention}(Q, K, V) = \text{softmax} \left( \frac{Q K^T}{\sqrt{d_k}} \right) V
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 1em; vertical-align: -0.25em;">
          </span>
          <span class="mord text">
           <span class="mord">
            Attention
           </span>
          </span>
          <span class="mopen">
           (
          </span>
          <span class="mord mathnormal">
           Q
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0715em;">
           K
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.2222em;">
           V
          </span>
          <span class="mclose">
           )
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           =
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 2.4684em; vertical-align: -0.95em;">
          </span>
          <span class="mord text">
           <span class="mord">
            softmax
           </span>
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="minner">
           <span class="mopen delimcenter" style="top: 0em;">
            <span class="delimsizing size3">
             (
            </span>
           </span>
           <span class="mord">
            <span class="mopen nulldelimiter">
            </span>
            <span class="mfrac">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 1.5183em;">
                <span class="" style="top: -2.2528em;">
                 <span class="pstrut" style="height: 3em;">
                 </span>
                 <span class="mord">
                  <span class="mord sqrt">
                   <span class="vlist-t vlist-t2">
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.8572em;">
                      <span class="svg-align" style="top: -3em;">
                       <span class="pstrut" style="height: 3em;">
                       </span>
                       <span class="mord" style="padding-left: 0.833em;">
                        <span class="mord">
                         <span class="mord mathnormal">
                          d
                         </span>
                         <span class="msupsub">
                          <span class="vlist-t vlist-t2">
                           <span class="vlist-r">
                            <span class="vlist" style="height: 0.3361em;">
                             <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                              <span class="pstrut" style="height: 2.7em;">
                              </span>
                              <span class="sizing reset-size6 size3 mtight">
                               <span class="mord mathnormal mtight" style="margin-right: 0.0315em;">
                                k
                               </span>
                              </span>
                             </span>
                            </span>
                            <span class="vlist-s">
                             ​
                            </span>
                           </span>
                           <span class="vlist-r">
                            <span class="vlist" style="height: 0.15em;">
                             <span class="">
                             </span>
                            </span>
                           </span>
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                      <span class="" style="top: -2.8172em;">
                       <span class="pstrut" style="height: 3em;">
                       </span>
                       <span class="hide-tail" style="min-width: 0.853em; height: 1.08em;">
                        <svg height="1.08em" preserveaspectratio="xMinYMin slice" viewbox="0 0 400000 1080" width="400em">
                         <path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z">
                         </path>
                        </svg>
                       </span>
                      </span>
                     </span>
                     <span class="vlist-s">
                      ​
                     </span>
                    </span>
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.1828em;">
                      <span class="">
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
                <span class="" style="top: -3.23em;">
                 <span class="pstrut" style="height: 3em;">
                 </span>
                 <span class="frac-line" style="border-bottom-width: 0.04em;">
                 </span>
                </span>
                <span class="" style="top: -3.677em;">
                 <span class="pstrut" style="height: 3em;">
                 </span>
                 <span class="mord">
                  <span class="mord mathnormal">
                   Q
                  </span>
                  <span class="mord">
                   <span class="mord mathnormal" style="margin-right: 0.0715em;">
                    K
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.8413em;">
                       <span class="" style="top: -3.063em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mathnormal mtight" style="margin-right: 0.1389em;">
                          T
                         </span>
                        </span>
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.93em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
            <span class="mclose nulldelimiter">
            </span>
           </span>
           <span class="mclose delimcenter" style="top: 0em;">
            <span class="delimsizing size3">
             )
            </span>
           </span>
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.2222em;">
           V
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
    </p>
    <h6>
     <a id="2MultiHead_Attention_492">
     </a>
     <strong>
      2.多头注意力（Multi-Head Attention）
     </strong>
    </h6>
    <p>
     <span class="katex--display">
      <span class="katex-display">
       <span class="katex">
        <span class="katex-mathml">
         MultiHead 
         
        
          ( 
         
        
          Q 
         
        
          , 
         
        
          K 
         
        
          , 
         
        
          V 
         
        
          ) 
         
        
          = 
         
        
          Concat 
         
        
          ( 
         
         
         
           head 
          
         
           1 
          
         
        
          , 
         
         
         
           head 
          
         
           2 
          
         
        
          , 
         
        
          … 
         
        
          , 
         
         
         
           head 
          
         
           h 
          
         
        
          ) 
         
         
         
           W 
          
         
           O 
          
         
        
       
         \text{MultiHead}(Q, K, V) = \text{Concat}(\text{head}_1, \text{head}_2, \dots, \text{head}_h) W^O
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 1em; vertical-align: -0.25em;">
          </span>
          <span class="mord text">
           <span class="mord">
            MultiHead
           </span>
          </span>
          <span class="mopen">
           (
          </span>
          <span class="mord mathnormal">
           Q
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0715em;">
           K
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.2222em;">
           V
          </span>
          <span class="mclose">
           )
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           =
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 1.1413em; vertical-align: -0.25em;">
          </span>
          <span class="mord text">
           <span class="mord">
            Concat
           </span>
          </span>
          <span class="mopen">
           (
          </span>
          <span class="mord">
           <span class="mord text">
            <span class="mord">
             head
            </span>
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3011em;">
               <span class="" style="top: -2.55em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  1
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord">
           <span class="mord text">
            <span class="mord">
             head
            </span>
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3011em;">
               <span class="" style="top: -2.55em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  2
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="minner">
           …
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord">
           <span class="mord text">
            <span class="mord">
             head
            </span>
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3361em;">
               <span class="" style="top: -2.55em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight">
                  h
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mclose">
           )
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.1389em;">
            W
           </span>
           <span class="msupsub">
            <span class="vlist-t">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.8913em;">
               <span class="" style="top: -3.113em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.0278em;">
                  O
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     <br/>
     其中：
     <br/>
     <span class="katex--display">
      <span class="katex-display">
       <span class="katex">
        <span class="katex-mathml">
         head 
          
         
           i 
          
         
        
          = 
         
        
          Attention 
         
        
          ( 
         
         
         
           Q 
          
         
           i 
          
         
        
          , 
         
         
         
           K 
          
         
           i 
          
         
        
          , 
         
         
         
           V 
          
         
           i 
          
         
        
          ) 
         
        
       
         \text{head}_i = \text{Attention}(Q_i, K_i, V_i)
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.8444em; vertical-align: -0.15em;">
          </span>
          <span class="mord">
           <span class="mord text">
            <span class="mord">
             head
            </span>
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3117em;">
               <span class="" style="top: -2.55em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight">
                  i
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           =
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 1em; vertical-align: -0.25em;">
          </span>
          <span class="mord text">
           <span class="mord">
            Attention
           </span>
          </span>
          <span class="mopen">
           (
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            Q
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3117em;">
               <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight">
                  i
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.0715em;">
            K
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3117em;">
               <span class="" style="top: -2.55em; margin-left: -0.0715em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight">
                  i
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.2222em;">
            V
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3117em;">
               <span class="" style="top: -2.55em; margin-left: -0.2222em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight">
                  i
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mclose">
           )
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
    </p>
    <hr/>
    <h5>
     <a id="4__503">
     </a>
     <strong>
      4. 代码实现
     </strong>
    </h5>
    <p>
     <strong>
      多头注意力（Multi-Head Attention, MHA）的 PyTorch 实现
     </strong>
     ：
    </p>
    <pre><code class="prism language-python"><span class="token keyword">import</span> torch
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn

<span class="token keyword">class</span> <span class="token class-name">MultiHeadAttention</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> d_model<span class="token punctuation">,</span> num_heads<span class="token punctuation">,</span> dropout<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        多头注意力层
        
        参数：
        - d_model: 输入特征维度（如 512）
        - num_heads: 注意力头的数量
        - dropout: Dropout 概率
        """</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>MultiHeadAttention<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">assert</span> d_model <span class="token operator">%</span> num_heads <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"d_model 必须能被 num_heads 整除"</span>

        self<span class="token punctuation">.</span>d_model <span class="token operator">=</span> d_model
        self<span class="token punctuation">.</span>num_heads <span class="token operator">=</span> num_heads
        self<span class="token punctuation">.</span>d_k <span class="token operator">=</span> d_model <span class="token operator">//</span> num_heads  <span class="token comment"># 每个头的维度</span>

        <span class="token comment"># 线性变换矩阵</span>
        self<span class="token punctuation">.</span>W_q <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>d_model<span class="token punctuation">,</span> d_model<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>W_k <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>d_model<span class="token punctuation">,</span> d_model<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>W_v <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>d_model<span class="token punctuation">,</span> d_model<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>W_o <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>d_model<span class="token punctuation">,</span> d_model<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>dropout <span class="token operator">=</span> nn<span class="token punctuation">.</span>Dropout<span class="token punctuation">(</span>dropout<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">attention</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> Q<span class="token punctuation">,</span> K<span class="token punctuation">,</span> V<span class="token punctuation">,</span> mask<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        计算缩放点积注意力
        """</span>
        scores <span class="token operator">=</span> torch<span class="token punctuation">.</span>matmul<span class="token punctuation">(</span>Q<span class="token punctuation">,</span> K<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> torch<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>self<span class="token punctuation">.</span>d_k<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> mask <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            scores <span class="token operator">=</span> scores<span class="token punctuation">.</span>masked_fill<span class="token punctuation">(</span>mask <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">'-inf'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        attn_weights <span class="token operator">=</span> torch<span class="token punctuation">.</span>softmax<span class="token punctuation">(</span>scores<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        attn_weights <span class="token operator">=</span> self<span class="token punctuation">.</span>dropout<span class="token punctuation">(</span>attn_weights<span class="token punctuation">)</span>
        <span class="token keyword">return</span> torch<span class="token punctuation">.</span>matmul<span class="token punctuation">(</span>attn_weights<span class="token punctuation">,</span> V<span class="token punctuation">)</span><span class="token punctuation">,</span> attn_weights

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> X<span class="token punctuation">)</span><span class="token punctuation">:</span>
        batch_size<span class="token punctuation">,</span> seq_len<span class="token punctuation">,</span> _ <span class="token operator">=</span> X<span class="token punctuation">.</span>shape

        <span class="token comment"># 计算 Q, K, V</span>
        Q <span class="token operator">=</span> self<span class="token punctuation">.</span>W_q<span class="token punctuation">(</span>X<span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span>batch_size<span class="token punctuation">,</span> seq_len<span class="token punctuation">,</span> self<span class="token punctuation">.</span>num_heads<span class="token punctuation">,</span> self<span class="token punctuation">.</span>d_k<span class="token punctuation">)</span><span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
        K <span class="token operator">=</span> self<span class="token punctuation">.</span>W_k<span class="token punctuation">(</span>X<span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span>batch_size<span class="token punctuation">,</span> seq_len<span class="token punctuation">,</span> self<span class="token punctuation">.</span>num_heads<span class="token punctuation">,</span> self<span class="token punctuation">.</span>d_k<span class="token punctuation">)</span><span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
        V <span class="token operator">=</span> self<span class="token punctuation">.</span>W_v<span class="token punctuation">(</span>X<span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span>batch_size<span class="token punctuation">,</span> seq_len<span class="token punctuation">,</span> self<span class="token punctuation">.</span>num_heads<span class="token punctuation">,</span> self<span class="token punctuation">.</span>d_k<span class="token punctuation">)</span><span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>

        <span class="token comment"># 计算多头注意力</span>
        attn_output<span class="token punctuation">,</span> attn_weights <span class="token operator">=</span> self<span class="token punctuation">.</span>attention<span class="token punctuation">(</span>Q<span class="token punctuation">,</span> K<span class="token punctuation">,</span> V<span class="token punctuation">)</span>

        <span class="token comment"># 拼接多个头的输出</span>
        attn_output <span class="token operator">=</span> attn_output<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>contiguous<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span>batch_size<span class="token punctuation">,</span> seq_len<span class="token punctuation">,</span> self<span class="token punctuation">.</span>d_model<span class="token punctuation">)</span>

        <span class="token comment"># 线性变换回原始维度</span>
        output <span class="token operator">=</span> self<span class="token punctuation">.</span>W_o<span class="token punctuation">(</span>attn_output<span class="token punctuation">)</span>

        <span class="token keyword">return</span> output<span class="token punctuation">,</span> attn_weights

<span class="token comment"># 测试多头注意力</span>
d_model <span class="token operator">=</span> <span class="token number">512</span>
num_heads <span class="token operator">=</span> <span class="token number">8</span>
seq_len <span class="token operator">=</span> <span class="token number">10</span>
batch_size <span class="token operator">=</span> <span class="token number">2</span>

mha <span class="token operator">=</span> MultiHeadAttention<span class="token punctuation">(</span>d_model<span class="token punctuation">,</span> num_heads<span class="token punctuation">)</span>
input_tensor <span class="token operator">=</span> torch<span class="token punctuation">.</span>rand<span class="token punctuation">(</span>batch_size<span class="token punctuation">,</span> seq_len<span class="token punctuation">,</span> d_model<span class="token punctuation">)</span>  <span class="token comment"># 随机输入</span>
output_tensor<span class="token punctuation">,</span> attention_weights <span class="token operator">=</span> mha<span class="token punctuation">(</span>input_tensor<span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"多头注意力输出形状:"</span><span class="token punctuation">,</span> output_tensor<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>  <span class="token comment"># (batch_size, seq_len, d_model)</span>
</code></pre>
    <hr/>
    <ul>
     <li>
      多头注意力（MHA）能够学习不同的注意力模式，提高模型的表达能力。
     </li>
     <li>
      通过多个注意力头，模型可以关注输入序列的不同方面。
     </li>
     <li>
      缩放点积注意力（Scaled Dot-Product Attention）是 MHA 的基础，计算 Query-Key 相关性并加权 Value。
     </li>
    </ul>
    <h4>
     <a id="16__585">
     </a>
     1.6 位置编码
    </h4>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/24f51373e75a4777b978d5259a8b58be.png">
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/4cdeb6359dc34dab809a67aebd5d046e.png"/>
     </img>
    </p>
    <p>
     在 Transformer 模型中，由于
     <strong>
      自注意力机制（Self-Attention）
     </strong>
     没有内置的序列顺序信息，因此需要
     <strong>
      位置编码（Positional Encoding）
     </strong>
     来显式地提供序列位置信息，使模型能够区分不同单词的顺序。
    </p>
    <hr/>
    <h5>
     <a id="1__593">
     </a>
     <strong>
      1. 位置编码的数学定义
     </strong>
    </h5>
    <p>
     位置编码采用
     <strong>
      正弦（sin）和余弦（cos）函数
     </strong>
     生成，如下公式：
     <br/>
     <span class="katex--display">
      <span class="katex-display">
       <span class="katex">
        <span class="katex-mathml">
         p 
          
         
           t 
          
          
          
            ( 
           
          
            i 
           
          
            ) 
           
          
         
        
          = 
         
         
         
           { 
          
          
           
            
             
              
              
                sin 
               
              
                ⁡ 
               
              
                ( 
               
               
               
                 ω 
                
               
                 k 
                
               
              
                ⋅ 
               
              
                t 
               
              
                ) 
               
              
                , 
               
              
             
            
            
             
              
              
                if  
               
              
                i 
               
              
                = 
               
              
                2 
               
              
                k 
               
              
             
            
           
           
            
             
              
              
                cos 
               
              
                ⁡ 
               
              
                ( 
               
               
               
                 ω 
                
               
                 k 
                
               
              
                ⋅ 
               
              
                t 
               
              
                ) 
               
              
                , 
               
              
             
            
            
             
              
              
                if  
               
              
                i 
               
              
                = 
               
              
                2 
               
              
                k 
               
              
                + 
               
              
                1 
               
              
             
            
           
          
         
        
       
         p_t^{(i)} = \begin{cases} \sin(\omega_k \cdot t), &amp; \text{if } i = 2k \\ \cos(\omega_k \cdot t), &amp; \text{if } i = 2k+1 \end{cases}
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 1.2906em; vertical-align: -0.2458em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            p
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 1.0448em;">
               <span class="" style="top: -2.4542em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight">
                  t
                 </span>
                </span>
               </span>
               <span class="" style="top: -3.2198em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mopen mtight">
                   (
                  </span>
                  <span class="mord mathnormal mtight">
                   i
                  </span>
                  <span class="mclose mtight">
                   )
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.2458em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           =
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 3em; vertical-align: -1.25em;">
          </span>
          <span class="minner">
           <span class="mopen delimcenter" style="top: 0em;">
            <span class="delimsizing size4">
             {
             <!-- -->
            </span>
           </span>
           <span class="mord">
            <span class="mtable">
             <span class="col-align-l">
              <span class="vlist-t vlist-t2">
               <span class="vlist-r">
                <span class="vlist" style="height: 1.69em;">
                 <span class="" style="top: -3.69em;">
                  <span class="pstrut" style="height: 3.008em;">
                  </span>
                  <span class="mord">
                   <span class="mop">
                    sin
                   </span>
                   <span class="mopen">
                    (
                   </span>
                   <span class="mord">
                    <span class="mord mathnormal" style="margin-right: 0.0359em;">
                     ω
                    </span>
                    <span class="msupsub">
                     <span class="vlist-t vlist-t2">
                      <span class="vlist-r">
                       <span class="vlist" style="height: 0.3361em;">
                        <span class="" style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;">
                         <span class="pstrut" style="height: 2.7em;">
                         </span>
                         <span class="sizing reset-size6 size3 mtight">
                          <span class="mord mathnormal mtight" style="margin-right: 0.0315em;">
                           k
                          </span>
                         </span>
                        </span>
                       </span>
                       <span class="vlist-s">
                        ​
                       </span>
                      </span>
                      <span class="vlist-r">
                       <span class="vlist" style="height: 0.15em;">
                        <span class="">
                        </span>
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                   <span class="mspace" style="margin-right: 0.2222em;">
                   </span>
                   <span class="mbin">
                    ⋅
                   </span>
                   <span class="mspace" style="margin-right: 0.2222em;">
                   </span>
                   <span class="mord mathnormal">
                    t
                   </span>
                   <span class="mclose">
                    )
                   </span>
                   <span class="mpunct">
                    ,
                   </span>
                  </span>
                 </span>
                 <span class="" style="top: -2.25em;">
                  <span class="pstrut" style="height: 3.008em;">
                  </span>
                  <span class="mord">
                   <span class="mop">
                    cos
                   </span>
                   <span class="mopen">
                    (
                   </span>
                   <span class="mord">
                    <span class="mord mathnormal" style="margin-right: 0.0359em;">
                     ω
                    </span>
                    <span class="msupsub">
                     <span class="vlist-t vlist-t2">
                      <span class="vlist-r">
                       <span class="vlist" style="height: 0.3361em;">
                        <span class="" style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;">
                         <span class="pstrut" style="height: 2.7em;">
                         </span>
                         <span class="sizing reset-size6 size3 mtight">
                          <span class="mord mathnormal mtight" style="margin-right: 0.0315em;">
                           k
                          </span>
                         </span>
                        </span>
                       </span>
                       <span class="vlist-s">
                        ​
                       </span>
                      </span>
                      <span class="vlist-r">
                       <span class="vlist" style="height: 0.15em;">
                        <span class="">
                        </span>
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                   <span class="mspace" style="margin-right: 0.2222em;">
                   </span>
                   <span class="mbin">
                    ⋅
                   </span>
                   <span class="mspace" style="margin-right: 0.2222em;">
                   </span>
                   <span class="mord mathnormal">
                    t
                   </span>
                   <span class="mclose">
                    )
                   </span>
                   <span class="mpunct">
                    ,
                   </span>
                  </span>
                 </span>
                </span>
                <span class="vlist-s">
                 ​
                </span>
               </span>
               <span class="vlist-r">
                <span class="vlist" style="height: 1.19em;">
                 <span class="">
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="arraycolsep" style="width: 1em;">
             </span>
             <span class="col-align-l">
              <span class="vlist-t vlist-t2">
               <span class="vlist-r">
                <span class="vlist" style="height: 1.69em;">
                 <span class="" style="top: -3.69em;">
                  <span class="pstrut" style="height: 3.008em;">
                  </span>
                  <span class="mord">
                   <span class="mord text">
                    <span class="mord">
                     if
                    </span>
                   </span>
                   <span class="mord mathnormal">
                    i
                   </span>
                   <span class="mspace" style="margin-right: 0.2778em;">
                   </span>
                   <span class="mrel">
                    =
                   </span>
                   <span class="mspace" style="margin-right: 0.2778em;">
                   </span>
                   <span class="mord">
                    2
                   </span>
                   <span class="mord mathnormal" style="margin-right: 0.0315em;">
                    k
                   </span>
                  </span>
                 </span>
                 <span class="" style="top: -2.25em;">
                  <span class="pstrut" style="height: 3.008em;">
                  </span>
                  <span class="mord">
                   <span class="mord text">
                    <span class="mord">
                     if
                    </span>
                   </span>
                   <span class="mord mathnormal">
                    i
                   </span>
                   <span class="mspace" style="margin-right: 0.2778em;">
                   </span>
                   <span class="mrel">
                    =
                   </span>
                   <span class="mspace" style="margin-right: 0.2778em;">
                   </span>
                   <span class="mord">
                    2
                   </span>
                   <span class="mord mathnormal" style="margin-right: 0.0315em;">
                    k
                   </span>
                   <span class="mspace" style="margin-right: 0.2222em;">
                   </span>
                   <span class="mbin">
                    +
                   </span>
                   <span class="mspace" style="margin-right: 0.2222em;">
                   </span>
                   <span class="mord">
                    1
                   </span>
                  </span>
                 </span>
                </span>
                <span class="vlist-s">
                 ​
                </span>
               </span>
               <span class="vlist-r">
                <span class="vlist" style="height: 1.19em;">
                 <span class="">
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mclose nulldelimiter">
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
    </p>
    <p>
     其中：
    </p>
    <ul>
     <li>
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         p 
          
         
           t 
          
          
          
            ( 
           
          
            i 
           
          
            ) 
           
          
         
        
       
         p_t^{(i)}
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 1.2906em; vertical-align: -0.2458em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            p
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 1.0448em;">
               <span class="" style="top: -2.4542em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight">
                  t
                 </span>
                </span>
               </span>
               <span class="" style="top: -3.2198em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mopen mtight">
                   (
                  </span>
                  <span class="mord mathnormal mtight">
                   i
                  </span>
                  <span class="mclose mtight">
                   )
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.2458em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      表示
      <strong>
       位置
       <span class="katex--inline">
        <span class="katex">
         <span class="katex-mathml">
          t 
          
         
        
          t
         </span>
         <span class="katex-html">
          <span class="base">
           <span class="strut" style="height: 0.6151em;">
           </span>
           <span class="mord mathnormal">
            t
           </span>
          </span>
         </span>
        </span>
       </span>
       处，第
       <span class="katex--inline">
        <span class="katex">
         <span class="katex-mathml">
          i 
          
         
        
          i
         </span>
         <span class="katex-html">
          <span class="base">
           <span class="strut" style="height: 0.6595em;">
           </span>
           <span class="mord mathnormal">
            i
           </span>
          </span>
         </span>
        </span>
       </span>
       维的编码值
      </strong>
      。
     </li>
     <li>
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         ω 
          
         
           k 
          
         
        
       
         \omega_k
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.5806em; vertical-align: -0.15em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.0359em;">
            ω
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3361em;">
               <span class="" style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.0315em;">
                  k
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      是不同维度的频率，定义为：
      <br/>
      <span class="katex--display">
       <span class="katex-display">
        <span class="katex">
         <span class="katex-mathml">
          ω 
           
          
            k 
           
          
         
           = 
          
          
          
            1 
           
           
           
             1000 
            
            
            
              0 
             
             
             
               2 
              
             
               k 
              
             
               / 
              
             
               d 
              
             
            
           
          
         
        
          \omega_k = \frac{1}{10000^{2k/d}}
         </span>
         <span class="katex-html">
          <span class="base">
           <span class="strut" style="height: 0.5806em; vertical-align: -0.15em;">
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.0359em;">
             ω
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.3361em;">
                <span class="" style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0315em;">
                   k
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.15em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
           <span class="mrel">
            =
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 2.0254em; vertical-align: -0.704em;">
           </span>
           <span class="mord">
            <span class="mopen nulldelimiter">
            </span>
            <span class="mfrac">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 1.3214em;">
                <span class="" style="top: -2.296em;">
                 <span class="pstrut" style="height: 3em;">
                 </span>
                 <span class="mord">
                  <span class="mord">
                   1000
                  </span>
                  <span class="mord">
                   <span class="mord">
                    0
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.814em;">
                       <span class="" style="top: -2.989em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mtight">
                          <span class="mord mtight">
                           2
                          </span>
                          <span class="mord mathnormal mtight" style="margin-right: 0.0315em;">
                           k
                          </span>
                          <span class="mord mtight">
                           /
                          </span>
                          <span class="mord mathnormal mtight">
                           d
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
                <span class="" style="top: -3.23em;">
                 <span class="pstrut" style="height: 3em;">
                 </span>
                 <span class="frac-line" style="border-bottom-width: 0.04em;">
                 </span>
                </span>
                <span class="" style="top: -3.677em;">
                 <span class="pstrut" style="height: 3em;">
                 </span>
                 <span class="mord">
                  <span class="mord">
                   1
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.704em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
            <span class="mclose nulldelimiter">
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      <br/>
      其中：
      <ul>
       <li>
        <span class="katex--inline">
         <span class="katex">
          <span class="katex-mathml">
           k 
           
          
         
           k
          </span>
          <span class="katex-html">
           <span class="base">
            <span class="strut" style="height: 0.6944em;">
            </span>
            <span class="mord mathnormal" style="margin-right: 0.0315em;">
             k
            </span>
           </span>
          </span>
         </span>
        </span>
        表示当前维度的索引（偶数维和奇数维分别使用 sin 和 cos）。
       </li>
       <li>
        <span class="katex--inline">
         <span class="katex">
          <span class="katex-mathml">
           d 
           
          
         
           d
          </span>
          <span class="katex-html">
           <span class="base">
            <span class="strut" style="height: 0.6944em;">
            </span>
            <span class="mord mathnormal">
             d
            </span>
           </span>
          </span>
         </span>
        </span>
        是隐藏层维度（例如 512）。
       </li>
       <li>
        这个公式确保
        <strong>
         不同维度的频率不同
        </strong>
        ，以捕捉不同粒度的位置信息。
       </li>
      </ul>
     </li>
    </ul>
    <hr/>
    <h5>
     <a id="2__616">
     </a>
     <strong>
      2. 位置编码的特点
     </strong>
    </h5>
    <ul>
     <li>
      <strong>
       使用不同频率的正弦和余弦函数
      </strong>
      ：
      <ul>
       <li>
        低维度使用较大的频率（变化较快），编码局部信息。
       </li>
       <li>
        高维度使用较小的频率（变化较慢），编码全局信息。
       </li>
      </ul>
     </li>
     <li>
      <strong>
       编码值是固定的，不需要训练
      </strong>
      ，不同位置的编码是固定的数学计算结果，不依赖数据训练。
     </li>
     <li>
      <strong>
       可以外推到更长的序列
      </strong>
      ，因为是基于数学函数计算的，而不是学习得到的。
     </li>
    </ul>
    <hr/>
    <h5>
     <a id="3__626">
     </a>
     <strong>
      3. 位置编码的作用
     </strong>
    </h5>
    <ul>
     <li>
      <strong>
       提供位置信息
      </strong>
      ：帮助 Transformer 区分不同单词的顺序。
     </li>
     <li>
      <strong>
       支持长序列建模
      </strong>
      ：由于编码是基于数学函数计算的，可以推广到比训练时更长的序列。
     </li>
     <li>
      <strong>
       平滑的连续变化
      </strong>
      ：由于使用正弦和余弦函数，编码值在相邻位置之间连续变化，使得模型可以更容易学习相对位置信息。
     </li>
    </ul>
    <hr/>
    <h5>
     <a id="4__633">
     </a>
     <strong>
      4. 代码实现
     </strong>
    </h5>
    <p>
     可以使用 Python（PyTorch）实现位置编码：
    </p>
    <pre><code class="prism language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt

<span class="token keyword">def</span> <span class="token function">positional_encoding</span><span class="token punctuation">(</span>seq_len<span class="token punctuation">,</span> d_model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    pos <span class="token operator">=</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>seq_len<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>newaxis<span class="token punctuation">]</span>  <span class="token comment"># 位置 (t)</span>
    i <span class="token operator">=</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>d_model<span class="token punctuation">)</span><span class="token punctuation">[</span>np<span class="token punctuation">.</span>newaxis<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>  <span class="token comment"># 维度 (i)</span>

    <span class="token comment"># 计算频率</span>
    omega <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">10000</span> <span class="token operator">**</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> <span class="token punctuation">(</span>i <span class="token operator">//</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">/</span> d_model<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># 计算位置编码</span>
    pos_encoding <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>seq_len<span class="token punctuation">,</span> d_model<span class="token punctuation">)</span><span class="token punctuation">)</span>
    pos_encoding<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>sin<span class="token punctuation">(</span>pos <span class="token operator">*</span> omega<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 偶数维</span>
    pos_encoding<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>cos<span class="token punctuation">(</span>pos <span class="token operator">*</span> omega<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 奇数维</span>

    <span class="token keyword">return</span> pos_encoding

<span class="token comment"># 生成位置编码</span>
seq_len<span class="token punctuation">,</span> d_model <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">512</span>
pos_encoding <span class="token operator">=</span> positional_encoding<span class="token punctuation">(</span>seq_len<span class="token punctuation">,</span> d_model<span class="token punctuation">)</span>

<span class="token comment"># 可视化</span>
plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>pos_encoding<span class="token punctuation">,</span> aspect<span class="token operator">=</span><span class="token string">'auto'</span><span class="token punctuation">,</span> cmap<span class="token operator">=</span><span class="token string">'coolwarm'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">"Dimension i"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">"Position t"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">"Positional Encoding Heatmap"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>colorbar<span class="token punctuation">(</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
    <hr/>
    <p>
     ✅
     <strong>
      位置编码通过 sin 和 cos 赋予 Transformer 位置信息
     </strong>
     。
     <br/>
     ✅
     <strong>
      不同维度使用不同频率，捕捉局部和全局信息
     </strong>
     。
     <br/>
     ✅
     <strong>
      数学计算得到，不需要训练，可推广到长序列
     </strong>
     。
    </p>
    <h3>
     <a id="2__672">
     </a>
     2. 问题备注
    </h3>
    <p>
     在
     <strong>
      Transformer 结构
     </strong>
     中，
     <strong>
      Q（Query）、K（Key）、V（Value）
     </strong>
     的来源在
     <strong>
      编码器（Encoder）
     </strong>
     和
     <strong>
      解码器（Decoder）
     </strong>
     中有所不同，具体如下：
    </p>
    <hr/>
    <h4>
     <a id="1_Encoder_QKV_678">
     </a>
     <strong>
      1. 编码器（Encoder）中的 Q、K、V
     </strong>
    </h4>
    <p>
     在
     <strong>
      编码器的自注意力（Self-Attention）
     </strong>
     机制中：
    </p>
    <ul>
     <li>
      <strong>
       输入
      </strong>
      ：编码器的输入是一个序列 ( X )（如源语言句子）。
     </li>
     <li>
      <strong>
       Q、K、V 的来源
      </strong>
      ：
      <br/>
      <span class="katex--display">
       <span class="katex-display">
        <span class="katex">
         <span class="katex-mathml">
          Q 
          
         
           = 
          
         
           X 
          
          
          
            W 
           
          
            Q 
           
          
         
           , 
          
          
         
           K 
          
         
           = 
          
         
           X 
          
          
          
            W 
           
          
            K 
           
          
         
           , 
          
          
         
           V 
          
         
           = 
          
         
           X 
          
          
          
            W 
           
          
            V 
           
          
         
        
          Q = X W^Q, \quad K = X W^K, \quad V = X W^V
         </span>
         <span class="katex-html">
          <span class="base">
           <span class="strut" style="height: 0.8778em; vertical-align: -0.1944em;">
           </span>
           <span class="mord mathnormal">
            Q
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
           <span class="mrel">
            =
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 1.0858em; vertical-align: -0.1944em;">
           </span>
           <span class="mord mathnormal" style="margin-right: 0.0785em;">
            X
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.1389em;">
             W
            </span>
            <span class="msupsub">
             <span class="vlist-t">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.8913em;">
                <span class="" style="top: -3.113em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mathnormal mtight">
                   Q
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mpunct">
            ,
           </span>
           <span class="mspace" style="margin-right: 1em;">
           </span>
           <span class="mspace" style="margin-right: 0.1667em;">
           </span>
           <span class="mord mathnormal" style="margin-right: 0.0715em;">
            K
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
           <span class="mrel">
            =
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 1.0858em; vertical-align: -0.1944em;">
           </span>
           <span class="mord mathnormal" style="margin-right: 0.0785em;">
            X
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.1389em;">
             W
            </span>
            <span class="msupsub">
             <span class="vlist-t">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.8913em;">
                <span class="" style="top: -3.113em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0715em;">
                   K
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mpunct">
            ,
           </span>
           <span class="mspace" style="margin-right: 1em;">
           </span>
           <span class="mspace" style="margin-right: 0.1667em;">
           </span>
           <span class="mord mathnormal" style="margin-right: 0.2222em;">
            V
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
           <span class="mrel">
            =
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 0.8913em;">
           </span>
           <span class="mord mathnormal" style="margin-right: 0.0785em;">
            X
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.1389em;">
             W
            </span>
            <span class="msupsub">
             <span class="vlist-t">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.8913em;">
                <span class="" style="top: -3.113em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.2222em;">
                   V
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      <ul>
       <li>
        <strong>
         Query（查询）
        </strong>
        ：由输入
        <span class="katex--inline">
         <span class="katex">
          <span class="katex-mathml">
           X 
           
          
         
           X
          </span>
          <span class="katex-html">
           <span class="base">
            <span class="strut" style="height: 0.6833em;">
            </span>
            <span class="mord mathnormal" style="margin-right: 0.0785em;">
             X
            </span>
           </span>
          </span>
         </span>
        </span>
        经过线性变换得到
       </li>
       <li>
        <strong>
         Key（键）
        </strong>
        ：由输入
        <span class="katex--inline">
         <span class="katex">
          <span class="katex-mathml">
           X 
           
          
         
           X
          </span>
          <span class="katex-html">
           <span class="base">
            <span class="strut" style="height: 0.6833em;">
            </span>
            <span class="mord mathnormal" style="margin-right: 0.0785em;">
             X
            </span>
           </span>
          </span>
         </span>
        </span>
        经过线性变换得到
       </li>
       <li>
        <strong>
         Value（值）
        </strong>
        ：由输入
        <span class="katex--inline">
         <span class="katex">
          <span class="katex-mathml">
           X 
           
          
         
           X
          </span>
          <span class="katex-html">
           <span class="base">
            <span class="strut" style="height: 0.6833em;">
            </span>
            <span class="mord mathnormal" style="margin-right: 0.0785em;">
             X
            </span>
           </span>
          </span>
         </span>
        </span>
        经过线性变换得到
       </li>
      </ul>
     </li>
    </ul>
    <p>
     <strong>
      特点
     </strong>
     ：
    </p>
    <ul>
     <li>
      <strong>
       自注意力（Self-Attention）
      </strong>
      ：Q、K、V 都来自相同的输入 ( X )。
     </li>
     <li>
      <strong>
       作用
      </strong>
      ：让编码器的每个词关注输入序列中的其他词，捕捉全局信息。
     </li>
    </ul>
    <hr/>
    <h4>
     <a id="2_Decoder_QKV_695">
     </a>
     <strong>
      2. 解码器（Decoder）中的 Q、K、V
     </strong>
    </h4>
    <p>
     在
     <strong>
      解码器的注意力机制
     </strong>
     中，注意力分为两种：
    </p>
    <ol>
     <li>
      <strong>
       Masked 自注意力（Masked Self-Attention）
      </strong>
     </li>
     <li>
      <strong>
       交叉注意力（Cross-Attention）
      </strong>
     </li>
    </ol>
    <h5>
     <a id="1Masked__QKV_700">
     </a>
     <strong>
      （1）Masked 自注意力中的 Q、K、V
     </strong>
    </h5>
    <ul>
     <li>
      <strong>
       输入
      </strong>
      ：解码器的输入是目标序列 ( Y )（如目标语言句子）。
     </li>
     <li>
      <strong>
       Q、K、V 的来源
      </strong>
      ：
      <br/>
      <span class="katex--display">
       <span class="katex-display">
        <span class="katex">
         <span class="katex-mathml">
          Q 
          
         
           = 
          
         
           Y 
          
          
          
            W 
           
          
            Q 
           
          
         
           , 
          
          
         
           K 
          
         
           = 
          
         
           Y 
          
          
          
            W 
           
          
            K 
           
          
         
           , 
          
          
         
           V 
          
         
           = 
          
         
           Y 
          
          
          
            W 
           
          
            V 
           
          
         
        
          Q = Y W^Q, \quad K = Y W^K, \quad V = Y W^V
         </span>
         <span class="katex-html">
          <span class="base">
           <span class="strut" style="height: 0.8778em; vertical-align: -0.1944em;">
           </span>
           <span class="mord mathnormal">
            Q
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
           <span class="mrel">
            =
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 1.0858em; vertical-align: -0.1944em;">
           </span>
           <span class="mord mathnormal" style="margin-right: 0.2222em;">
            Y
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.1389em;">
             W
            </span>
            <span class="msupsub">
             <span class="vlist-t">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.8913em;">
                <span class="" style="top: -3.113em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mathnormal mtight">
                   Q
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mpunct">
            ,
           </span>
           <span class="mspace" style="margin-right: 1em;">
           </span>
           <span class="mspace" style="margin-right: 0.1667em;">
           </span>
           <span class="mord mathnormal" style="margin-right: 0.0715em;">
            K
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
           <span class="mrel">
            =
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 1.0858em; vertical-align: -0.1944em;">
           </span>
           <span class="mord mathnormal" style="margin-right: 0.2222em;">
            Y
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.1389em;">
             W
            </span>
            <span class="msupsub">
             <span class="vlist-t">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.8913em;">
                <span class="" style="top: -3.113em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0715em;">
                   K
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mpunct">
            ,
           </span>
           <span class="mspace" style="margin-right: 1em;">
           </span>
           <span class="mspace" style="margin-right: 0.1667em;">
           </span>
           <span class="mord mathnormal" style="margin-right: 0.2222em;">
            V
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
           <span class="mrel">
            =
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 0.8913em;">
           </span>
           <span class="mord mathnormal" style="margin-right: 0.2222em;">
            Y
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.1389em;">
             W
            </span>
            <span class="msupsub">
             <span class="vlist-t">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.8913em;">
                <span class="" style="top: -3.113em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.2222em;">
                   V
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      <ul>
       <li>
        <strong>
         Query（查询）
        </strong>
        ：由目标序列
        <span class="katex--inline">
         <span class="katex">
          <span class="katex-mathml">
           Y 
           
          
         
           Y
          </span>
          <span class="katex-html">
           <span class="base">
            <span class="strut" style="height: 0.6833em;">
            </span>
            <span class="mord mathnormal" style="margin-right: 0.2222em;">
             Y
            </span>
           </span>
          </span>
         </span>
        </span>
        计算
       </li>
       <li>
        <strong>
         Key（键）
        </strong>
        ：由目标序列
        <span class="katex--inline">
         <span class="katex">
          <span class="katex-mathml">
           Y 
           
          
         
           Y
          </span>
          <span class="katex-html">
           <span class="base">
            <span class="strut" style="height: 0.6833em;">
            </span>
            <span class="mord mathnormal" style="margin-right: 0.2222em;">
             Y
            </span>
           </span>
          </span>
         </span>
        </span>
        计算
       </li>
       <li>
        <strong>
         Value（值）
        </strong>
        ：由目标序列
        <span class="katex--inline">
         <span class="katex">
          <span class="katex-mathml">
           Y 
           
          
         
           Y
          </span>
          <span class="katex-html">
           <span class="base">
            <span class="strut" style="height: 0.6833em;">
            </span>
            <span class="mord mathnormal" style="margin-right: 0.2222em;">
             Y
            </span>
           </span>
          </span>
         </span>
        </span>
        计算
       </li>
      </ul>
     </li>
    </ul>
    <p>
     <strong>
      特点
     </strong>
     ：
    </p>
    <ul>
     <li>
      <strong>
       Masked 机制
      </strong>
      ：在计算注意力时，屏蔽未来的信息，防止看到后续词语。
     </li>
     <li>
      <strong>
       作用
      </strong>
      ：让解码器的每个词只能关注当前及之前的词，确保自回归特性。
     </li>
    </ul>
    <hr/>
    <h5>
     <a id="2CrossAttention_QKV_716">
     </a>
     <strong>
      （2）交叉注意力（Cross-Attention）中的 Q、K、V
     </strong>
    </h5>
    <ul>
     <li>
      <strong>
       输入
      </strong>
      ：交叉注意力的输入是
      <strong>
       解码器的隐藏状态
      </strong>
      和
      <strong>
       编码器的输出
      </strong>
      。
     </li>
     <li>
      <strong>
       Q、K、V 的来源
      </strong>
      ：
      <br/>
      <span class="katex--display">
       <span class="katex-display">
        <span class="katex">
         <span class="katex-mathml">
          Q 
          
         
           = 
          
         
           Y 
          
          
          
            W 
           
          
            Q 
           
          
         
           , 
          
          
         
           K 
          
         
           = 
          
          
          
            X 
           
          
            L 
           
          
          
          
            W 
           
          
            K 
           
          
         
           , 
          
          
         
           V 
          
         
           = 
          
          
          
            X 
           
          
            L 
           
          
          
          
            W 
           
          
            V 
           
          
         
        
          Q = Y W^Q, \quad K = X_L W^K, \quad V = X_L W^V
         </span>
         <span class="katex-html">
          <span class="base">
           <span class="strut" style="height: 0.8778em; vertical-align: -0.1944em;">
           </span>
           <span class="mord mathnormal">
            Q
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
           <span class="mrel">
            =
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 1.0858em; vertical-align: -0.1944em;">
           </span>
           <span class="mord mathnormal" style="margin-right: 0.2222em;">
            Y
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.1389em;">
             W
            </span>
            <span class="msupsub">
             <span class="vlist-t">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.8913em;">
                <span class="" style="top: -3.113em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mathnormal mtight">
                   Q
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mpunct">
            ,
           </span>
           <span class="mspace" style="margin-right: 1em;">
           </span>
           <span class="mspace" style="margin-right: 0.1667em;">
           </span>
           <span class="mord mathnormal" style="margin-right: 0.0715em;">
            K
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
           <span class="mrel">
            =
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 1.0858em; vertical-align: -0.1944em;">
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.0785em;">
             X
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.3283em;">
                <span class="" style="top: -2.55em; margin-left: -0.0785em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mathnormal mtight">
                   L
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.15em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.1389em;">
             W
            </span>
            <span class="msupsub">
             <span class="vlist-t">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.8913em;">
                <span class="" style="top: -3.113em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0715em;">
                   K
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mpunct">
            ,
           </span>
           <span class="mspace" style="margin-right: 1em;">
           </span>
           <span class="mspace" style="margin-right: 0.1667em;">
           </span>
           <span class="mord mathnormal" style="margin-right: 0.2222em;">
            V
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
           <span class="mrel">
            =
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 1.0413em; vertical-align: -0.15em;">
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.0785em;">
             X
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.3283em;">
                <span class="" style="top: -2.55em; margin-left: -0.0785em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mathnormal mtight">
                   L
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.15em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.1389em;">
             W
            </span>
            <span class="msupsub">
             <span class="vlist-t">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.8913em;">
                <span class="" style="top: -3.113em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.2222em;">
                   V
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      <ul>
       <li>
        <strong>
         Query（查询）
        </strong>
        ：来自解码器的隐藏状态
        <span class="katex--inline">
         <span class="katex">
          <span class="katex-mathml">
           Y 
           
          
         
           Y
          </span>
          <span class="katex-html">
           <span class="base">
            <span class="strut" style="height: 0.6833em;">
            </span>
            <span class="mord mathnormal" style="margin-right: 0.2222em;">
             Y
            </span>
           </span>
          </span>
         </span>
        </span>
       </li>
       <li>
        <strong>
         Key（键）
        </strong>
        ：来自编码器的输出
        <span class="katex--inline">
         <span class="katex">
          <span class="katex-mathml">
           X 
            
           
             L 
            
           
          
         
           X_L
          </span>
          <span class="katex-html">
           <span class="base">
            <span class="strut" style="height: 0.8333em; vertical-align: -0.15em;">
            </span>
            <span class="mord">
             <span class="mord mathnormal" style="margin-right: 0.0785em;">
              X
             </span>
             <span class="msupsub">
              <span class="vlist-t vlist-t2">
               <span class="vlist-r">
                <span class="vlist" style="height: 0.3283em;">
                 <span class="" style="top: -2.55em; margin-left: -0.0785em; margin-right: 0.05em;">
                  <span class="pstrut" style="height: 2.7em;">
                  </span>
                  <span class="sizing reset-size6 size3 mtight">
                   <span class="mord mathnormal mtight">
                    L
                   </span>
                  </span>
                 </span>
                </span>
                <span class="vlist-s">
                 ​
                </span>
               </span>
               <span class="vlist-r">
                <span class="vlist" style="height: 0.15em;">
                 <span class="">
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </li>
       <li>
        <strong>
         Value（值）
        </strong>
        ：来自编码器的输出
        <span class="katex--inline">
         <span class="katex">
          <span class="katex-mathml">
           X 
            
           
             L 
            
           
          
         
           X_L
          </span>
          <span class="katex-html">
           <span class="base">
            <span class="strut" style="height: 0.8333em; vertical-align: -0.15em;">
            </span>
            <span class="mord">
             <span class="mord mathnormal" style="margin-right: 0.0785em;">
              X
             </span>
             <span class="msupsub">
              <span class="vlist-t vlist-t2">
               <span class="vlist-r">
                <span class="vlist" style="height: 0.3283em;">
                 <span class="" style="top: -2.55em; margin-left: -0.0785em; margin-right: 0.05em;">
                  <span class="pstrut" style="height: 2.7em;">
                  </span>
                  <span class="sizing reset-size6 size3 mtight">
                   <span class="mord mathnormal mtight">
                    L
                   </span>
                  </span>
                 </span>
                </span>
                <span class="vlist-s">
                 ​
                </span>
               </span>
               <span class="vlist-r">
                <span class="vlist" style="height: 0.15em;">
                 <span class="">
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </li>
      </ul>
     </li>
    </ul>
    <p>
     <strong>
      特点
     </strong>
     ：
    </p>
    <ul>
     <li>
      <strong>
       Q 来自解码器，K 和 V 来自编码器
      </strong>
      ，让解码器能够关注编码器的信息。
     </li>
     <li>
      <strong>
       作用
      </strong>
      ：让解码器在生成目标序列时，能够参考源语言的信息。
     </li>
    </ul>
    <hr/>
    <table>
     <thead>
      <tr>
       <th>
        <strong>
         位置
        </strong>
       </th>
       <th>
        <strong>
         Query（Q）来源
        </strong>
       </th>
       <th>
        <strong>
         Key（K）来源
        </strong>
       </th>
       <th>
        <strong>
         Value（V）来源
        </strong>
       </th>
       <th>
        <strong>
         作用
        </strong>
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        <strong>
         编码器（Encoder）
        </strong>
       </td>
       <td>
        输入 (X)
       </td>
       <td>
        输入 (X)
       </td>
       <td>
        输入 (X)
       </td>
       <td>
        让每个词关注整个输入序列
       </td>
      </tr>
      <tr>
       <td>
        <strong>
         解码器（Masked 自注意力）
        </strong>
       </td>
       <td>
        目标序列 (Y)
       </td>
       <td>
        目标序列 (Y)
       </td>
       <td>
        目标序列 (Y )
       </td>
       <td>
        让解码器的每个词关注当前及之前的词
       </td>
      </tr>
      <tr>
       <td>
        <strong>
         解码器（交叉注意力）
        </strong>
       </td>
       <td>
        目标序列 (Y)
       </td>
       <td>
        编码器输出
        <span class="katex--inline">
         <span class="katex">
          <span class="katex-mathml">
           X 
            
           
             L 
            
           
          
         
           X_L
          </span>
          <span class="katex-html">
           <span class="base">
            <span class="strut" style="height: 0.8333em; vertical-align: -0.15em;">
            </span>
            <span class="mord">
             <span class="mord mathnormal" style="margin-right: 0.0785em;">
              X
             </span>
             <span class="msupsub">
              <span class="vlist-t vlist-t2">
               <span class="vlist-r">
                <span class="vlist" style="height: 0.3283em;">
                 <span class="" style="top: -2.55em; margin-left: -0.0785em; margin-right: 0.05em;">
                  <span class="pstrut" style="height: 2.7em;">
                  </span>
                  <span class="sizing reset-size6 size3 mtight">
                   <span class="mord mathnormal mtight">
                    L
                   </span>
                  </span>
                 </span>
                </span>
                <span class="vlist-s">
                 ​
                </span>
               </span>
               <span class="vlist-r">
                <span class="vlist" style="height: 0.15em;">
                 <span class="">
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </td>
       <td>
        编码器输出
        <span class="katex--inline">
         <span class="katex">
          <span class="katex-mathml">
           X 
            
           
             L 
            
           
          
         
           X_L
          </span>
          <span class="katex-html">
           <span class="base">
            <span class="strut" style="height: 0.8333em; vertical-align: -0.15em;">
            </span>
            <span class="mord">
             <span class="mord mathnormal" style="margin-right: 0.0785em;">
              X
             </span>
             <span class="msupsub">
              <span class="vlist-t vlist-t2">
               <span class="vlist-r">
                <span class="vlist" style="height: 0.3283em;">
                 <span class="" style="top: -2.55em; margin-left: -0.0785em; margin-right: 0.05em;">
                  <span class="pstrut" style="height: 2.7em;">
                  </span>
                  <span class="sizing reset-size6 size3 mtight">
                   <span class="mord mathnormal mtight">
                    L
                   </span>
                  </span>
                 </span>
                </span>
                <span class="vlist-s">
                 ​
                </span>
               </span>
               <span class="vlist-r">
                <span class="vlist" style="height: 0.15em;">
                 <span class="">
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </td>
       <td>
       </td>
      </tr>
     </tbody>
    </table>
    <hr/>
    <ul>
     <li>
      <strong>
       编码器的 Q、K、V 都来自输入 ( X )
      </strong>
      ，用于捕捉全局信息。
     </li>
     <li>
      解码器的 Masked 自注意力的 Q、K、V 都来自目标序列
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         Y 
         
        
       
         Y
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.6833em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.2222em;">
           Y
          </span>
         </span>
        </span>
       </span>
      </span>
      ，用于保证自回归特性。
     </li>
     <li>
      解码器的交叉注意力的 Q 来自解码器，K 和 V 来自编码器的输出
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         X 
          
         
           L 
          
         
        
       
         X_L
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.8333em; vertical-align: -0.15em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.0785em;">
            X
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3283em;">
               <span class="" style="top: -2.55em; margin-left: -0.0785em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight">
                  L
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      **，用于关注源语言信息。
     </li>
    </ul>
    <h4>
     <a id="3DotProduct_745">
     </a>
     <strong>
      3.为什么注意力模型计算选用点积（Dot-Product）？
     </strong>
    </h4>
    <p>
     在 Transformer 的注意力机制（Self-Attention 和 Cross-Attention）中，
     <strong>
      点积（Dot-Product）
     </strong>
     是计算 Query（查询）和 Key（键）之间相似度的核心操作。主要原因包括以下几点：
    </p>
    <hr/>
    <h5>
     <a id="1__751">
     </a>
     <strong>
      1. 计算效率高
     </strong>
    </h5>
    <p>
     点积计算的核心公式是：
     <br/>
     <span class="katex--display">
      <span class="katex-display">
       <span class="katex">
        <span class="katex-mathml">
         S 
         
        
          = 
         
        
          Q 
         
         
         
           K 
          
         
           T 
          
         
        
       
         S = QK^T
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.6833em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0576em;">
           S
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           =
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 1.0858em; vertical-align: -0.1944em;">
          </span>
          <span class="mord mathnormal">
           Q
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.0715em;">
            K
           </span>
           <span class="msupsub">
            <span class="vlist-t">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.8913em;">
               <span class="" style="top: -3.113em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.1389em;">
                  T
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     <br/>
     其中：
    </p>
    <ul>
     <li>
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         Q 
         
        
       
         Q
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.8778em; vertical-align: -0.1944em;">
          </span>
          <span class="mord mathnormal">
           Q
          </span>
         </span>
        </span>
       </span>
      </span>
      （查询）：
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         ( 
         
        
          b 
         
        
          a 
         
        
          t 
         
        
          c 
         
        
          h 
         
        
          , 
         
        
          s 
         
        
          e 
         
        
          q 
         
        
          _ 
         
        
          l 
         
        
          e 
         
        
          n 
         
        
          , 
         
         
         
           d 
          
         
           k 
          
         
        
          ) 
         
        
       
         (batch, seq\_len, d_k)
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 1.06em; vertical-align: -0.31em;">
          </span>
          <span class="mopen">
           (
          </span>
          <span class="mord mathnormal">
           ba
          </span>
          <span class="mord mathnormal">
           t
          </span>
          <span class="mord mathnormal">
           c
          </span>
          <span class="mord mathnormal">
           h
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord mathnormal">
           se
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0359em;">
           q
          </span>
          <span class="mord" style="margin-right: 0.0278em;">
           _
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0197em;">
           l
          </span>
          <span class="mord mathnormal">
           e
          </span>
          <span class="mord mathnormal">
           n
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            d
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3361em;">
               <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.0315em;">
                  k
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mclose">
           )
          </span>
         </span>
        </span>
       </span>
      </span>
     </li>
     <li>
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         K 
         
        
       
         K
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.6833em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0715em;">
           K
          </span>
         </span>
        </span>
       </span>
      </span>
      （键）：
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         ( 
         
        
          b 
         
        
          a 
         
        
          t 
         
        
          c 
         
        
          h 
         
        
          , 
         
        
          s 
         
        
          e 
         
        
          q 
         
        
          _ 
         
        
          l 
         
        
          e 
         
        
          n 
         
        
          , 
         
         
         
           d 
          
         
           k 
          
         
        
          ) 
         
        
       
         (batch, seq\_len, d_k)
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 1.06em; vertical-align: -0.31em;">
          </span>
          <span class="mopen">
           (
          </span>
          <span class="mord mathnormal">
           ba
          </span>
          <span class="mord mathnormal">
           t
          </span>
          <span class="mord mathnormal">
           c
          </span>
          <span class="mord mathnormal">
           h
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord mathnormal">
           se
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0359em;">
           q
          </span>
          <span class="mord" style="margin-right: 0.0278em;">
           _
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0197em;">
           l
          </span>
          <span class="mord mathnormal">
           e
          </span>
          <span class="mord mathnormal">
           n
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            d
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3361em;">
               <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.0315em;">
                  k
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mclose">
           )
          </span>
         </span>
        </span>
       </span>
      </span>
     </li>
    </ul>
    <p>
     点积计算的时间复杂度为
     <strong>
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         O 
         
        
          ( 
         
         
         
           d 
          
         
           k 
          
         
        
          ) 
         
        
       
         O(d_k)
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 1em; vertical-align: -0.25em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0278em;">
           O
          </span>
          <span class="mopen">
           (
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            d
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3361em;">
               <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.0315em;">
                  k
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mclose">
           )
          </span>
         </span>
        </span>
       </span>
      </span>
     </strong>
     ，相比其他相似度计算方法（如欧几里得距离、余弦相似度）更加高效，尤其适用于 GPU 并行计算。
    </p>
    <p>
     <strong>
      对比计算复杂度：
     </strong>
    </p>
    <ul>
     <li>
      <strong>
       点积（Dot-Product）：
       <span class="katex--inline">
        <span class="katex">
         <span class="katex-mathml">
          O 
          
         
           ( 
          
          
          
            d 
           
          
            k 
           
          
         
           ) 
          
         
        
          O(d_k)
         </span>
         <span class="katex-html">
          <span class="base">
           <span class="strut" style="height: 1em; vertical-align: -0.25em;">
           </span>
           <span class="mord mathnormal" style="margin-right: 0.0278em;">
            O
           </span>
           <span class="mopen">
            (
           </span>
           <span class="mord">
            <span class="mord mathnormal">
             d
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.3361em;">
                <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0315em;">
                   k
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.15em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mclose">
            )
           </span>
          </span>
         </span>
        </span>
       </span>
      </strong>
      （只需乘法和加法）
     </li>
     <li>
      <strong>
       欧几里得距离（Euclidean Distance）：
       <span class="katex--inline">
        <span class="katex">
         <span class="katex-mathml">
          O 
          
         
           ( 
          
          
          
            d 
           
          
            k 
           
          
         
           ) 
          
         
        
          O(d_k)
         </span>
         <span class="katex-html">
          <span class="base">
           <span class="strut" style="height: 1em; vertical-align: -0.25em;">
           </span>
           <span class="mord mathnormal" style="margin-right: 0.0278em;">
            O
           </span>
           <span class="mopen">
            (
           </span>
           <span class="mord">
            <span class="mord mathnormal">
             d
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.3361em;">
                <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0315em;">
                   k
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.15em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mclose">
            )
           </span>
          </span>
         </span>
        </span>
       </span>
      </strong>
      （需要平方、开方）
     </li>
     <li>
      <strong>
       余弦相似度（Cosine Similarity）：
       <span class="katex--inline">
        <span class="katex">
         <span class="katex-mathml">
          O 
          
         
           ( 
          
          
          
            d 
           
          
            k 
           
          
         
           ) 
          
         
        
          O(d_k)
         </span>
         <span class="katex-html">
          <span class="base">
           <span class="strut" style="height: 1em; vertical-align: -0.25em;">
           </span>
           <span class="mord mathnormal" style="margin-right: 0.0278em;">
            O
           </span>
           <span class="mopen">
            (
           </span>
           <span class="mord">
            <span class="mord mathnormal">
             d
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.3361em;">
                <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0315em;">
                   k
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.15em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mclose">
            )
           </span>
          </span>
         </span>
        </span>
       </span>
      </strong>
      （需要归一化）
     </li>
    </ul>
    <p>
     由于 Transformer 需要处理大规模数据（如 NLP 任务中的长文本、视频分析中的时序数据），选择计算效率高的点积是更优的选择。
    </p>
    <hr/>
    <h5>
     <a id="2__771">
     </a>
     <strong>
      2. 点积能够有效衡量相似性
     </strong>
    </h5>
    <h6>
     <a id="1_772">
     </a>
     <strong>
      （1）点积的几何解释
     </strong>
    </h6>
    <p>
     点积计算：
     <br/>
     <span class="katex--display">
      <span class="katex-display">
       <span class="katex">
        <span class="katex-mathml">
         Q 
          
         
           i 
          
         
        
          ⋅ 
         
         
         
           K 
          
         
           j 
          
         
        
          = 
         
         
         
           ∑ 
          
          
          
            d 
           
          
            = 
           
          
            1 
           
          
          
          
            d 
           
          
            k 
           
          
         
         
         
           Q 
          
          
          
            i 
           
          
            d 
           
          
         
         
         
           K 
          
          
          
            j 
           
          
            d 
           
          
         
        
       
         Q_i \cdot K_j = \sum_{d=1}^{d_k} Q_{id} K_{jd}
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.8778em; vertical-align: -0.1944em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            Q
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3117em;">
               <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight">
                  i
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
          <span class="mbin">
           ⋅
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 0.9694em; vertical-align: -0.2861em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.0715em;">
            K
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3117em;">
               <span class="" style="top: -2.55em; margin-left: -0.0715em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                  j
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.2861em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           =
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 3.1551em; vertical-align: -1.3021em;">
          </span>
          <span class="mop op-limits">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 1.853em;">
              <span class="" style="top: -1.8479em; margin-left: 0em;">
               <span class="pstrut" style="height: 3.05em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mathnormal mtight">
                  d
                 </span>
                 <span class="mrel mtight">
                  =
                 </span>
                 <span class="mord mtight">
                  1
                 </span>
                </span>
               </span>
              </span>
              <span class="" style="top: -3.05em;">
               <span class="pstrut" style="height: 3.05em;">
               </span>
               <span class="">
                <span class="mop op-symbol large-op">
                 ∑
                </span>
               </span>
              </span>
              <span class="" style="top: -4.3169em; margin-left: 0em;">
               <span class="pstrut" style="height: 3.05em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mtight">
                  <span class="mord mathnormal mtight">
                   d
                  </span>
                  <span class="msupsub">
                   <span class="vlist-t vlist-t2">
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.3448em;">
                      <span class="" style="top: -2.3488em; margin-left: 0em; margin-right: 0.0714em;">
                       <span class="pstrut" style="height: 2.5em;">
                       </span>
                       <span class="sizing reset-size3 size1 mtight">
                        <span class="mord mathnormal mtight" style="margin-right: 0.0315em;">
                         k
                        </span>
                       </span>
                      </span>
                     </span>
                     <span class="vlist-s">
                      ​
                     </span>
                    </span>
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.1512em;">
                      <span class="">
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 1.3021em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            Q
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3361em;">
               <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mathnormal mtight">
                   i
                  </span>
                  <span class="mord mathnormal mtight">
                   d
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.0715em;">
            K
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3361em;">
               <span class="" style="top: -2.55em; margin-left: -0.0715em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                   j
                  </span>
                  <span class="mord mathnormal mtight">
                   d
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.2861em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
    </p>
    <ul>
     <li>
      如果
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         Q 
         
        
       
         Q
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.8778em; vertical-align: -0.1944em;">
          </span>
          <span class="mord mathnormal">
           Q
          </span>
         </span>
        </span>
       </span>
      </span>
      和
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         K 
         
        
       
         K
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.6833em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0715em;">
           K
          </span>
         </span>
        </span>
       </span>
      </span>
      的方向相同（即两个向量相似），点积值较大。
     </li>
     <li>
      如果
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         Q 
         
        
       
         Q
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.8778em; vertical-align: -0.1944em;">
          </span>
          <span class="mord mathnormal">
           Q
          </span>
         </span>
        </span>
       </span>
      </span>
      和
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         K 
         
        
       
         K
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.6833em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0715em;">
           K
          </span>
         </span>
        </span>
       </span>
      </span>
      的方向正交（即无关），点积值接近 0。
     </li>
     <li>
      如果
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         Q 
         
        
       
         Q
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.8778em; vertical-align: -0.1944em;">
          </span>
          <span class="mord mathnormal">
           Q
          </span>
         </span>
        </span>
       </span>
      </span>
      和
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         K 
         
        
       
         K
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.6833em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0715em;">
           K
          </span>
         </span>
        </span>
       </span>
      </span>
      的方向相反，点积值较小（可能为负）。
     </li>
    </ul>
    <p>
     这与注意力机制的需求一致：
     <strong>
      希望让 Query 关注与自己最相关的 Key
     </strong>
     。
    </p>
    <h6>
     <a id="2_vs__783">
     </a>
     <strong>
      （2）点积 vs. 余弦相似度
     </strong>
    </h6>
    <p>
     余弦相似度计算如下：
     <br/>
     <span class="katex--display">
      <span class="katex-display">
       <span class="katex">
        <span class="katex-mathml">
         cos 
         
        
          ⁡ 
         
        
          ( 
         
        
          θ 
         
        
          ) 
         
        
          = 
         
         
          
          
            Q 
           
          
            ⋅ 
           
          
            K 
           
          
          
          
            ∥ 
           
          
            Q 
           
          
            ∥ 
           
          
            ∥ 
           
          
            K 
           
          
            ∥ 
           
          
         
        
       
         \cos(\theta) = \frac{Q \cdot K}{\|Q\| \|K\|}
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 1em; vertical-align: -0.25em;">
          </span>
          <span class="mop">
           cos
          </span>
          <span class="mopen">
           (
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0278em;">
           θ
          </span>
          <span class="mclose">
           )
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           =
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 2.2963em; vertical-align: -0.936em;">
          </span>
          <span class="mord">
           <span class="mopen nulldelimiter">
           </span>
           <span class="mfrac">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 1.3603em;">
               <span class="" style="top: -2.314em;">
                <span class="pstrut" style="height: 3em;">
                </span>
                <span class="mord">
                 <span class="mord">
                  ∥
                 </span>
                 <span class="mord mathnormal">
                  Q
                 </span>
                 <span class="mord">
                  ∥∥
                 </span>
                 <span class="mord mathnormal" style="margin-right: 0.0715em;">
                  K
                 </span>
                 <span class="mord">
                  ∥
                 </span>
                </span>
               </span>
               <span class="" style="top: -3.23em;">
                <span class="pstrut" style="height: 3em;">
                </span>
                <span class="frac-line" style="border-bottom-width: 0.04em;">
                </span>
               </span>
               <span class="" style="top: -3.677em;">
                <span class="pstrut" style="height: 3em;">
                </span>
                <span class="mord">
                 <span class="mord mathnormal">
                  Q
                 </span>
                 <span class="mspace" style="margin-right: 0.2222em;">
                 </span>
                 <span class="mbin">
                  ⋅
                 </span>
                 <span class="mspace" style="margin-right: 0.2222em;">
                 </span>
                 <span class="mord mathnormal" style="margin-right: 0.0715em;">
                  K
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.936em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mclose nulldelimiter">
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     <br/>
     虽然余弦相似度也能衡量向量的相似性，但它需要额外的归一化操作（计算向量模长），这会增加计算成本。而点积本质上是未归一化的余弦相似度，因此可以直接用于注意力计算。
    </p>
    <hr/>
    <h5>
     <a id="3__Softmax__792">
     </a>
     <strong>
      3. 结合 Softmax 归一化
     </strong>
    </h5>
    <p>
     点积计算的结果：
     <br/>
     <span class="katex--display">
      <span class="katex-display">
       <span class="katex">
        <span class="katex-mathml">
         S 
         
        
          = 
         
        
          Q 
         
         
         
           K 
          
         
           T 
          
         
        
       
         S = QK^T
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.6833em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0576em;">
           S
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           =
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 1.0858em; vertical-align: -0.1944em;">
          </span>
          <span class="mord mathnormal">
           Q
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.0715em;">
            K
           </span>
           <span class="msupsub">
            <span class="vlist-t">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.8913em;">
               <span class="" style="top: -3.113em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.1389em;">
                  T
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     <br/>
     通常会经过
     <strong>
      Softmax 归一化
     </strong>
     ：
     <br/>
     <span class="katex--display">
      <span class="katex-display">
       <span class="katex">
        <span class="katex-mathml">
         α 
         
        
          = 
         
        
          softmax 
         
         
         
           ( 
          
          
           
           
             Q 
            
            
            
              K 
             
            
              T 
             
            
           
           
            
            
              d 
             
            
              k 
             
            
           
          
         
           ) 
          
         
        
       
         \alpha = \text{softmax} \left(\frac{QK^T}{\sqrt{d_k}}\right)
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.4306em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0037em;">
           α
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           =
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 2.4684em; vertical-align: -0.95em;">
          </span>
          <span class="mord text">
           <span class="mord">
            softmax
           </span>
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="minner">
           <span class="mopen delimcenter" style="top: 0em;">
            <span class="delimsizing size3">
             (
            </span>
           </span>
           <span class="mord">
            <span class="mopen nulldelimiter">
            </span>
            <span class="mfrac">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 1.5183em;">
                <span class="" style="top: -2.2528em;">
                 <span class="pstrut" style="height: 3em;">
                 </span>
                 <span class="mord">
                  <span class="mord sqrt">
                   <span class="vlist-t vlist-t2">
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.8572em;">
                      <span class="svg-align" style="top: -3em;">
                       <span class="pstrut" style="height: 3em;">
                       </span>
                       <span class="mord" style="padding-left: 0.833em;">
                        <span class="mord">
                         <span class="mord mathnormal">
                          d
                         </span>
                         <span class="msupsub">
                          <span class="vlist-t vlist-t2">
                           <span class="vlist-r">
                            <span class="vlist" style="height: 0.3361em;">
                             <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                              <span class="pstrut" style="height: 2.7em;">
                              </span>
                              <span class="sizing reset-size6 size3 mtight">
                               <span class="mord mathnormal mtight" style="margin-right: 0.0315em;">
                                k
                               </span>
                              </span>
                             </span>
                            </span>
                            <span class="vlist-s">
                             ​
                            </span>
                           </span>
                           <span class="vlist-r">
                            <span class="vlist" style="height: 0.15em;">
                             <span class="">
                             </span>
                            </span>
                           </span>
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                      <span class="" style="top: -2.8172em;">
                       <span class="pstrut" style="height: 3em;">
                       </span>
                       <span class="hide-tail" style="min-width: 0.853em; height: 1.08em;">
                        <svg height="1.08em" preserveaspectratio="xMinYMin slice" viewbox="0 0 400000 1080" width="400em">
                         <path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z">
                         </path>
                        </svg>
                       </span>
                      </span>
                     </span>
                     <span class="vlist-s">
                      ​
                     </span>
                    </span>
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.1828em;">
                      <span class="">
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
                <span class="" style="top: -3.23em;">
                 <span class="pstrut" style="height: 3em;">
                 </span>
                 <span class="frac-line" style="border-bottom-width: 0.04em;">
                 </span>
                </span>
                <span class="" style="top: -3.677em;">
                 <span class="pstrut" style="height: 3em;">
                 </span>
                 <span class="mord">
                  <span class="mord mathnormal">
                   Q
                  </span>
                  <span class="mord">
                   <span class="mord mathnormal" style="margin-right: 0.0715em;">
                    K
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.8413em;">
                       <span class="" style="top: -3.063em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mathnormal mtight" style="margin-right: 0.1389em;">
                          T
                         </span>
                        </span>
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.93em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
            <span class="mclose nulldelimiter">
            </span>
           </span>
           <span class="mclose delimcenter" style="top: 0em;">
            <span class="delimsizing size3">
             )
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
    </p>
    <ul>
     <li>
      <strong>
       Softmax 作用
      </strong>
      ：将点积结果转换为概率分布，使得所有注意力权重之和为 1。
     </li>
     <li>
      <strong>
       缩放因子
       <span class="katex--inline">
        <span class="katex">
         <span class="katex-mathml">
          d 
            
           
             k 
            
           
          
         
        
          \sqrt{d_k}
         </span>
         <span class="katex-html">
          <span class="base">
           <span class="strut" style="height: 1.04em; vertical-align: -0.1828em;">
           </span>
           <span class="mord sqrt">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.8572em;">
               <span class="svg-align" style="top: -3em;">
                <span class="pstrut" style="height: 3em;">
                </span>
                <span class="mord" style="padding-left: 0.833em;">
                 <span class="mord">
                  <span class="mord mathnormal">
                   d
                  </span>
                  <span class="msupsub">
                   <span class="vlist-t vlist-t2">
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.3361em;">
                      <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                       <span class="pstrut" style="height: 2.7em;">
                       </span>
                       <span class="sizing reset-size6 size3 mtight">
                        <span class="mord mathnormal mtight" style="margin-right: 0.0315em;">
                         k
                        </span>
                       </span>
                      </span>
                     </span>
                     <span class="vlist-s">
                      ​
                     </span>
                    </span>
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.15em;">
                      <span class="">
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
               </span>
               <span class="" style="top: -2.8172em;">
                <span class="pstrut" style="height: 3em;">
                </span>
                <span class="hide-tail" style="min-width: 0.853em; height: 1.08em;">
                 <svg height="1.08em" preserveaspectratio="xMinYMin slice" viewbox="0 0 400000 1080" width="400em">
                  <path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z">
                  </path>
                 </svg>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.1828em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </strong>
      ：防止点积值过大导致梯度消失。
     </li>
    </ul>
    <p>
     这种组合方式使得点积注意力（Scaled Dot-Product Attention）既高效又稳定。
    </p>
    <hr/>
    <h5>
     <a id="4__808">
     </a>
     <strong>
      4. 经验验证：点积注意力效果优于加性注意力
     </strong>
    </h5>
    <p>
     在早期的注意力机制（如 Bahdanau Attention）中，使用的是
     <strong>
      加性注意力（Additive Attention）
     </strong>
     ：
     <br/>
     <span class="katex--display">
      <span class="katex-display">
       <span class="katex">
        <span class="katex-mathml">
         score 
         
        
          ( 
         
        
          Q 
         
        
          , 
         
        
          K 
         
        
          ) 
         
        
          = 
         
         
         
           V 
          
         
           T 
          
         
        
          tanh 
         
        
          ⁡ 
         
        
          ( 
         
         
         
           W 
          
         
           q 
          
         
        
          Q 
         
        
          + 
         
         
         
           W 
          
         
           k 
          
         
        
          K 
         
        
          ) 
         
        
       
         \text{score}(Q, K) = V^T \tanh(W_q Q + W_k K)
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 1em; vertical-align: -0.25em;">
          </span>
          <span class="mord text">
           <span class="mord">
            score
           </span>
          </span>
          <span class="mopen">
           (
          </span>
          <span class="mord mathnormal">
           Q
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0715em;">
           K
          </span>
          <span class="mclose">
           )
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           =
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 1.1774em; vertical-align: -0.2861em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.2222em;">
            V
           </span>
           <span class="msupsub">
            <span class="vlist-t">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.8913em;">
               <span class="" style="top: -3.113em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.1389em;">
                  T
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mop">
           tanh
          </span>
          <span class="mopen">
           (
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.1389em;">
            W
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.1514em;">
               <span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.0359em;">
                  q
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.2861em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mord mathnormal">
           Q
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
          <span class="mbin">
           +
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 1em; vertical-align: -0.25em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.1389em;">
            W
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3361em;">
               <span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.0315em;">
                  k
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0715em;">
           K
          </span>
          <span class="mclose">
           )
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     <br/>
     但研究发现：
    </p>
    <ul>
     <li>
      <strong>
       点积注意力（Dot-Product Attention）在大规模数据上效果更好
      </strong>
      。
     </li>
     <li>
      <strong>
       点积计算可以更好地利用矩阵运算加速（GPU 友好）
      </strong>
      。
     </li>
     <li>
      <strong>
       加性注意力需要额外的参数
       <span class="katex--inline">
        <span class="katex">
         <span class="katex-mathml">
          W 
           
          
            q 
           
          
         
           , 
          
          
          
            W 
           
          
            k 
           
          
         
           , 
          
         
           V 
          
         
        
          W_q, W_k, V
         </span>
         <span class="katex-html">
          <span class="base">
           <span class="strut" style="height: 0.9694em; vertical-align: -0.2861em;">
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.1389em;">
             W
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.1514em;">
                <span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0359em;">
                   q
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.2861em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mpunct">
            ,
           </span>
           <span class="mspace" style="margin-right: 0.1667em;">
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.1389em;">
             W
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.3361em;">
                <span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0315em;">
                   k
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.15em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mpunct">
            ,
           </span>
           <span class="mspace" style="margin-right: 0.1667em;">
           </span>
           <span class="mord mathnormal" style="margin-right: 0.2222em;">
            V
           </span>
          </span>
         </span>
        </span>
       </span>
       ，而点积注意力不需要额外参数
      </strong>
      。
     </li>
    </ul>
    <p>
     因此，在 Transformer 及其变体（如 BERT、GPT、ViT）中，
     <strong>
      点积注意力成为主流选择
     </strong>
     。
    </p>
    <hr/>
    <ul>
     <li>
      <strong>
       点积计算高效，适合 GPU 并行计算
      </strong>
      （相比加性注意力更快）。
     </li>
     <li>
      <strong>
       点积能够有效衡量向量相似性
      </strong>
      （与余弦相似度类似，但计算更简单）。
     </li>
     <li>
      <strong>
       结合 Softmax 归一化，使注意力机制更加稳定
      </strong>
      （避免梯度消失）。
     </li>
     <li>
      <strong>
       实验验证：点积注意力在大规模数据上效果优于加性注意力
      </strong>
      。
     </li>
    </ul>
    <p>
     因此，
     <strong>
      Transformer 采用点积注意力（Dot-Product Attention）作为核心计算方式
     </strong>
     ，并结合 Softmax 归一化和缩放因子
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        d 
          
         
           k 
          
         
        
       
      
        \sqrt{d_k}
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 1.04em; vertical-align: -0.1828em;">
         </span>
         <span class="mord sqrt">
          <span class="vlist-t vlist-t2">
           <span class="vlist-r">
            <span class="vlist" style="height: 0.8572em;">
             <span class="svg-align" style="top: -3em;">
              <span class="pstrut" style="height: 3em;">
              </span>
              <span class="mord" style="padding-left: 0.833em;">
               <span class="mord">
                <span class="mord mathnormal">
                 d
                </span>
                <span class="msupsub">
                 <span class="vlist-t vlist-t2">
                  <span class="vlist-r">
                   <span class="vlist" style="height: 0.3361em;">
                    <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                     <span class="pstrut" style="height: 2.7em;">
                     </span>
                     <span class="sizing reset-size6 size3 mtight">
                      <span class="mord mathnormal mtight" style="margin-right: 0.0315em;">
                       k
                      </span>
                     </span>
                    </span>
                   </span>
                   <span class="vlist-s">
                    ​
                   </span>
                  </span>
                  <span class="vlist-r">
                   <span class="vlist" style="height: 0.15em;">
                    <span class="">
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="" style="top: -2.8172em;">
              <span class="pstrut" style="height: 3em;">
              </span>
              <span class="hide-tail" style="min-width: 0.853em; height: 1.08em;">
               <svg height="1.08em" preserveaspectratio="xMinYMin slice" viewbox="0 0 400000 1080" width="400em">
                <path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z">
                </path>
               </svg>
              </span>
             </span>
            </span>
            <span class="vlist-s">
             ​
            </span>
           </span>
           <span class="vlist-r">
            <span class="vlist" style="height: 0.1828em;">
             <span class="">
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     进行优化。
    </p>
    <h4>
     <a id="4__sqrtD_Scale_830">
     </a>
     4.
     <strong>
      为什么要除以
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         D 
          
         
        
       
         \sqrt{D}
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 1.04em; vertical-align: -0.1133em;">
          </span>
          <span class="mord sqrt">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.9267em;">
              <span class="svg-align" style="top: -3em;">
               <span class="pstrut" style="height: 3em;">
               </span>
               <span class="mord" style="padding-left: 0.833em;">
                <span class="mord mathnormal" style="margin-right: 0.0278em;">
                 D
                </span>
               </span>
              </span>
              <span class="" style="top: -2.8867em;">
               <span class="pstrut" style="height: 3em;">
               </span>
               <span class="hide-tail" style="min-width: 0.853em; height: 1.08em;">
                <svg height="1.08em" preserveaspectratio="xMinYMin slice" viewbox="0 0 400000 1080" width="400em">
                 <path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z">
                 </path>
                </svg>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.1133em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      （Scale）？
     </strong>
    </h4>
    <p>
     在
     <strong>
      点积注意力（Dot-Product Attention）
     </strong>
     计算中，我们使用
     <strong>
      Query（Q）和 Key（K）
     </strong>
     的点积来衡量相似性：
     <br/>
     <span class="katex--display">
      <span class="katex-display">
       <span class="katex">
        <span class="katex-mathml">
         S 
         
        
          = 
         
        
          Q 
         
         
         
           K 
          
         
           T 
          
         
        
       
         S = QK^T
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.6833em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0576em;">
           S
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           =
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 1.0858em; vertical-align: -0.1944em;">
          </span>
          <span class="mord mathnormal">
           Q
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.0715em;">
            K
           </span>
           <span class="msupsub">
            <span class="vlist-t">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.8913em;">
               <span class="" style="top: -3.113em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.1389em;">
                  T
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     <br/>
     然后通过
     <strong>
      Softmax
     </strong>
     归一化计算注意力权重：
     <br/>
     <span class="katex--display">
      <span class="katex-display">
       <span class="katex">
        <span class="katex-mathml">
         α 
         
        
          = 
         
        
          softmax 
         
        
          ( 
         
        
          S 
         
        
          ) 
         
        
          V 
         
        
       
         \alpha = \text{softmax}(S)V
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.4306em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0037em;">
           α
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           =
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 1em; vertical-align: -0.25em;">
          </span>
          <span class="mord text">
           <span class="mord">
            softmax
           </span>
          </span>
          <span class="mopen">
           (
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0576em;">
           S
          </span>
          <span class="mclose">
           )
          </span>
          <span class="mord mathnormal" style="margin-right: 0.2222em;">
           V
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     <br/>
     但是，如果不进行缩放，点积值可能会变得
     <strong>
      过大
     </strong>
     ，导致
     <strong>
      Softmax 输出极端化
     </strong>
     ，影响模型训练。
     <br/>
     因此，我们
     <strong>
      除以 ( \sqrt{D} )（D 为特征维度）
     </strong>
     来进行缩放，最终计算方式如下：
     <br/>
     <span class="katex--display">
      <span class="katex-display">
       <span class="katex">
        <span class="katex-mathml">
         S 
         
        
          = 
         
         
          
          
            Q 
           
           
           
             K 
            
           
             T 
            
           
          
          
          
            D 
           
          
         
        
       
         S = \frac{QK^T}{\sqrt{D}}
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.6833em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0576em;">
           S
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           =
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 2.4483em; vertical-align: -0.93em;">
          </span>
          <span class="mord">
           <span class="mopen nulldelimiter">
           </span>
           <span class="mfrac">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 1.5183em;">
               <span class="" style="top: -2.1833em;">
                <span class="pstrut" style="height: 3em;">
                </span>
                <span class="mord">
                 <span class="mord sqrt">
                  <span class="vlist-t vlist-t2">
                   <span class="vlist-r">
                    <span class="vlist" style="height: 0.9267em;">
                     <span class="svg-align" style="top: -3em;">
                      <span class="pstrut" style="height: 3em;">
                      </span>
                      <span class="mord" style="padding-left: 0.833em;">
                       <span class="mord mathnormal" style="margin-right: 0.0278em;">
                        D
                       </span>
                      </span>
                     </span>
                     <span class="" style="top: -2.8867em;">
                      <span class="pstrut" style="height: 3em;">
                      </span>
                      <span class="hide-tail" style="min-width: 0.853em; height: 1.08em;">
                       <svg height="1.08em" preserveaspectratio="xMinYMin slice" viewbox="0 0 400000 1080" width="400em">
                        <path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z">
                        </path>
                       </svg>
                      </span>
                     </span>
                    </span>
                    <span class="vlist-s">
                     ​
                    </span>
                   </span>
                   <span class="vlist-r">
                    <span class="vlist" style="height: 0.1133em;">
                     <span class="">
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
               </span>
               <span class="" style="top: -3.23em;">
                <span class="pstrut" style="height: 3em;">
                </span>
                <span class="frac-line" style="border-bottom-width: 0.04em;">
                </span>
               </span>
               <span class="" style="top: -3.677em;">
                <span class="pstrut" style="height: 3em;">
                </span>
                <span class="mord">
                 <span class="mord mathnormal">
                  Q
                 </span>
                 <span class="mord">
                  <span class="mord mathnormal" style="margin-right: 0.0715em;">
                   K
                  </span>
                  <span class="msupsub">
                   <span class="vlist-t">
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.8413em;">
                      <span class="" style="top: -3.063em; margin-right: 0.05em;">
                       <span class="pstrut" style="height: 2.7em;">
                       </span>
                       <span class="sizing reset-size6 size3 mtight">
                        <span class="mord mathnormal mtight" style="margin-right: 0.1389em;">
                         T
                        </span>
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.93em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mclose nulldelimiter">
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
    </p>
    <hr/>
    <h5>
     <a id="1__847">
     </a>
     <strong>
      1. 避免点积值过大，防止梯度消失
     </strong>
    </h5>
    <p>
     在高维空间（例如
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        D 
        
       
         = 
        
       
         512 
        
       
      
        D=512
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.6833em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0278em;">
          D
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
         <span class="mrel">
          =
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 0.6444em;">
         </span>
         <span class="mord">
          512
         </span>
        </span>
       </span>
      </span>
     </span>
     ，
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        Q 
        
       
      
        Q
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.8778em; vertical-align: -0.1944em;">
         </span>
         <span class="mord mathnormal">
          Q
         </span>
        </span>
       </span>
      </span>
     </span>
     和
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        K 
        
       
      
        K
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.6833em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0715em;">
          K
         </span>
        </span>
       </span>
      </span>
     </span>
     的元素通常服从
     <strong>
      均值为 0，方差为 1
     </strong>
     的正态分布（假设初始化时）。
     <br/>
     那么，点积
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        S 
        
       
      
        S
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.6833em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0576em;">
          S
         </span>
        </span>
       </span>
      </span>
     </span>
     的期望值和方差计算如下：
    </p>
    <ul>
     <li>
      <p>
       <strong>
        点积的期望值
       </strong>
       ：
       <br/>
       <span class="katex--display">
        <span class="katex-display">
         <span class="katex">
          <span class="katex-mathml">
           E 
           
          
            [ 
           
          
            Q 
           
           
           
             K 
            
           
             T 
            
           
          
            ] 
           
          
            = 
           
          
            0 
           
          
         
           \mathbb{E}[QK^T] = 0
          </span>
          <span class="katex-html">
           <span class="base">
            <span class="strut" style="height: 1.1413em; vertical-align: -0.25em;">
            </span>
            <span class="mord mathbb">
             E
            </span>
            <span class="mopen">
             [
            </span>
            <span class="mord mathnormal">
             Q
            </span>
            <span class="mord">
             <span class="mord mathnormal" style="margin-right: 0.0715em;">
              K
             </span>
             <span class="msupsub">
              <span class="vlist-t">
               <span class="vlist-r">
                <span class="vlist" style="height: 0.8913em;">
                 <span class="" style="top: -3.113em; margin-right: 0.05em;">
                  <span class="pstrut" style="height: 2.7em;">
                  </span>
                  <span class="sizing reset-size6 size3 mtight">
                   <span class="mord mathnormal mtight" style="margin-right: 0.1389em;">
                    T
                   </span>
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
            <span class="mclose">
             ]
            </span>
            <span class="mspace" style="margin-right: 0.2778em;">
            </span>
            <span class="mrel">
             =
            </span>
            <span class="mspace" style="margin-right: 0.2778em;">
            </span>
           </span>
           <span class="base">
            <span class="strut" style="height: 0.6444em;">
            </span>
            <span class="mord">
             0
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
       $$
       <br/>
       因为 ( Q ) 和 ( K ) 服从均值为 0 的分布，所以它们的点积的均值仍然是 0。
      </p>
     </li>
     <li>
      <p>
       <strong>
        点积的方差
       </strong>
       ：
       <br/>
       <span class="katex--display">
        <span class="katex-display">
         <span class="katex">
          <span class="katex-mathml">
           Var 
           
          
            ( 
           
          
            Q 
           
           
           
             K 
            
           
             T 
            
           
          
            ) 
           
          
            = 
           
          
            D 
           
          
         
           \text{Var}(QK^T) = D
          </span>
          <span class="katex-html">
           <span class="base">
            <span class="strut" style="height: 1.1413em; vertical-align: -0.25em;">
            </span>
            <span class="mord text">
             <span class="mord">
              Var
             </span>
            </span>
            <span class="mopen">
             (
            </span>
            <span class="mord mathnormal">
             Q
            </span>
            <span class="mord">
             <span class="mord mathnormal" style="margin-right: 0.0715em;">
              K
             </span>
             <span class="msupsub">
              <span class="vlist-t">
               <span class="vlist-r">
                <span class="vlist" style="height: 0.8913em;">
                 <span class="" style="top: -3.113em; margin-right: 0.05em;">
                  <span class="pstrut" style="height: 2.7em;">
                  </span>
                  <span class="sizing reset-size6 size3 mtight">
                   <span class="mord mathnormal mtight" style="margin-right: 0.1389em;">
                    T
                   </span>
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
            <span class="mclose">
             )
            </span>
            <span class="mspace" style="margin-right: 0.2778em;">
            </span>
            <span class="mrel">
             =
            </span>
            <span class="mspace" style="margin-right: 0.2778em;">
            </span>
           </span>
           <span class="base">
            <span class="strut" style="height: 0.6833em;">
            </span>
            <span class="mord mathnormal" style="margin-right: 0.0278em;">
             D
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
       <br/>
       由于点积涉及 ( D ) 个独立变量的乘积求和，方差会随着 ( D ) 增大而增大。
      </p>
     </li>
    </ul>
    <p>
     当
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        D 
        
       
      
        D
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.6833em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0278em;">
          D
         </span>
        </span>
       </span>
      </span>
     </span>
     很大时，例如
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        D 
        
       
         = 
        
       
         512 
        
       
         或 
        
       
         1024 
        
       
      
        D = 512 或 1024
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.6833em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0278em;">
          D
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
         <span class="mrel">
          =
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 0.6833em;">
         </span>
         <span class="mord">
          512
         </span>
         <span class="mord cjk_fallback">
          或
         </span>
         <span class="mord">
          1024
         </span>
        </span>
       </span>
      </span>
     </span>
     ，点积值的方差也会变得很大，导致 Softmax 计算时的指数函数
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        e 
         
        
          x 
         
        
       
      
        e^x
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.6644em;">
         </span>
         <span class="mord">
          <span class="mord mathnormal">
           e
          </span>
          <span class="msupsub">
           <span class="vlist-t">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.6644em;">
              <span class="" style="top: -3.063em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mathnormal mtight">
                 x
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     的值过大，使得：
    </p>
    <ul>
     <li>
      Softmax 输出接近
      <strong>
       one-hot
      </strong>
      （即某个值接近 1，其他值接近 0）。
     </li>
     <li>
      反向传播时梯度变得很小（梯度消失），影响模型训练。
     </li>
    </ul>
    <p>
     <strong>
      解决方案：
     </strong>
    </p>
    <ul>
     <li>
      通过
      <strong>
       除以 ( \sqrt{D} )
      </strong>
      ，让点积值的方差变为 1：
      <br/>
      <span class="katex--display">
       <span class="katex-display">
        <span class="katex">
         <span class="katex-mathml">
          Var 
          
          
          
            ( 
           
           
            
            
              Q 
             
             
             
               K 
              
             
               T 
              
             
            
            
            
              D 
             
            
           
          
            ) 
           
          
         
           = 
          
         
           1 
          
         
        
          \text{Var} \left(\frac{QK^T}{\sqrt{D}}\right) = 1
         </span>
         <span class="katex-html">
          <span class="base">
           <span class="strut" style="height: 2.4684em; vertical-align: -0.95em;">
           </span>
           <span class="mord text">
            <span class="mord">
             Var
            </span>
           </span>
           <span class="mspace" style="margin-right: 0.1667em;">
           </span>
           <span class="minner">
            <span class="mopen delimcenter" style="top: 0em;">
             <span class="delimsizing size3">
              (
             </span>
            </span>
            <span class="mord">
             <span class="mopen nulldelimiter">
             </span>
             <span class="mfrac">
              <span class="vlist-t vlist-t2">
               <span class="vlist-r">
                <span class="vlist" style="height: 1.5183em;">
                 <span class="" style="top: -2.1833em;">
                  <span class="pstrut" style="height: 3em;">
                  </span>
                  <span class="mord">
                   <span class="mord sqrt">
                    <span class="vlist-t vlist-t2">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.9267em;">
                       <span class="svg-align" style="top: -3em;">
                        <span class="pstrut" style="height: 3em;">
                        </span>
                        <span class="mord" style="padding-left: 0.833em;">
                         <span class="mord mathnormal" style="margin-right: 0.0278em;">
                          D
                         </span>
                        </span>
                       </span>
                       <span class="" style="top: -2.8867em;">
                        <span class="pstrut" style="height: 3em;">
                        </span>
                        <span class="hide-tail" style="min-width: 0.853em; height: 1.08em;">
                         <svg height="1.08em" preserveaspectratio="xMinYMin slice" viewbox="0 0 400000 1080" width="400em">
                          <path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z">
                          </path>
                         </svg>
                        </span>
                       </span>
                      </span>
                      <span class="vlist-s">
                       ​
                      </span>
                     </span>
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.1133em;">
                       <span class="">
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                 <span class="" style="top: -3.23em;">
                  <span class="pstrut" style="height: 3em;">
                  </span>
                  <span class="frac-line" style="border-bottom-width: 0.04em;">
                  </span>
                 </span>
                 <span class="" style="top: -3.677em;">
                  <span class="pstrut" style="height: 3em;">
                  </span>
                  <span class="mord">
                   <span class="mord mathnormal">
                    Q
                   </span>
                   <span class="mord">
                    <span class="mord mathnormal" style="margin-right: 0.0715em;">
                     K
                    </span>
                    <span class="msupsub">
                     <span class="vlist-t">
                      <span class="vlist-r">
                       <span class="vlist" style="height: 0.8413em;">
                        <span class="" style="top: -3.063em; margin-right: 0.05em;">
                         <span class="pstrut" style="height: 2.7em;">
                         </span>
                         <span class="sizing reset-size6 size3 mtight">
                          <span class="mord mathnormal mtight" style="margin-right: 0.1389em;">
                           T
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
                <span class="vlist-s">
                 ​
                </span>
               </span>
               <span class="vlist-r">
                <span class="vlist" style="height: 0.93em;">
                 <span class="">
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="mclose nulldelimiter">
             </span>
            </span>
            <span class="mclose delimcenter" style="top: 0em;">
             <span class="delimsizing size3">
              )
             </span>
            </span>
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
           <span class="mrel">
            =
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 0.6444em;">
           </span>
           <span class="mord">
            1
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </li>
     <li>
      这样，Softmax 输出更加平滑，梯度不会消失，有助于稳定训练。
     </li>
    </ul>
    <hr/>
    <h5>
     <a id="2__877">
     </a>
     <strong>
      2. 直观理解
     </strong>
    </h5>
    <p>
     可以用一个形象的例子来理解：
    </p>
    <ul>
     <li>
      <strong>
       未缩放的点积
      </strong>
      （大值输入 Softmax）：就像一个考试成绩满分 1000 分的系统，99 分和 100 分的差距微乎其微，但 Softmax 会放大这个差距，使得 100 分的注意力远大于 99 分。
     </li>
     <li>
      <strong>
       缩放后的点积
      </strong>
      （小值输入 Softmax）：就像一个满分 100 分的考试，99 分和 100 分的差距不会被过度放大，注意力分布更加合理。
     </li>
    </ul>
    <hr/>
    <p>
     ✅
     <strong>
      防止 Softmax 过度偏向单个 token
     </strong>
     （避免 one-hot 现象）。
     <br/>
     ✅
     <strong>
      保持梯度稳定，防止梯度消失，使模型更容易训练
     </strong>
     。
     <br/>
     ✅
     <strong>
      在高维空间（如 D=512）时，避免点积值过大，保证数值稳定性
     </strong>
     。
    </p>
    <p>
     因此，
     <strong>
      Transformer 采用 Scaled Dot-Product Attention，即在计算
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         Q 
         
         
         
           K 
          
         
           T 
          
         
        
       
         QK^T
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 1.0358em; vertical-align: -0.1944em;">
          </span>
          <span class="mord mathnormal">
           Q
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.0715em;">
            K
           </span>
           <span class="msupsub">
            <span class="vlist-t">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.8413em;">
               <span class="" style="top: -3.063em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.1389em;">
                  T
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      后除以
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         D 
          
         
        
       
         \sqrt{D}
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 1.04em; vertical-align: -0.1133em;">
          </span>
          <span class="mord sqrt">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.9267em;">
              <span class="svg-align" style="top: -3em;">
               <span class="pstrut" style="height: 3em;">
               </span>
               <span class="mord" style="padding-left: 0.833em;">
                <span class="mord mathnormal" style="margin-right: 0.0278em;">
                 D
                </span>
               </span>
              </span>
              <span class="" style="top: -2.8867em;">
               <span class="pstrut" style="height: 3em;">
               </span>
               <span class="hide-tail" style="min-width: 0.853em; height: 1.08em;">
                <svg height="1.08em" preserveaspectratio="xMinYMin slice" viewbox="0 0 400000 1080" width="400em">
                 <path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z">
                 </path>
                </svg>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.1133em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      ，确保模型训练更稳定，注意力分布更合理。
     </strong>
    </p>
    <h3>
     <a id="_890">
     </a>
     参考文献
    </h3>
    <p>
     <a href="https://www.datawhale.cn/learn/content/107/3294" rel="nofollow">
      Datawhale大模型组队学习地址
     </a>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
  <div class="blog-extension-box" id="blogExtensionBox" style="width:400px;margin:auto;margin-top:12px">
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f34323931373335322f:61727469636c652f64657461696c732f313436313435373232" class_="artid" style="display:none">
 </p>
</div>


