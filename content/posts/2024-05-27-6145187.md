---
arturl_encode: "687474:70733a2f2f626c6f672e6373646e2e6e65742f417567757364:692f61727469636c652f64657461696c732f36313435313837"
layout: post
title: "基于PCI总线加密卡硬件设计"
date: 2024-05-27 00:04:33 +08:00
description: "基于PCI总线加密卡硬件设计摘要：介绍基于PCI总线加密卡的硬件组成部分。该加密卡汲取了现代先进的加"
keywords: "一种基于pci-e接口的全算法密码卡及其加密方法"
categories: ['Pci']
tags: ['编程', '算法', '扩展', '工作', '存储', '加密']
artid: "6145187"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=6145187
    alt: "基于PCI总线加密卡硬件设计"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=6145187
featuredImagePreview: https://bing.ee123.net/img/rand?artid=6145187
---

# 基于PCI总线加密卡硬件设计

**基于PCI总线加密卡硬件设计**

**摘要：**
介绍基于PCI总线加密卡的硬件组成部分。该加密卡汲取了现代先进的加密思想，实现了高强度加密功能。

**关键词：**
加密卡 PCI总线 PCI9052 ISP 单片机

加密是对软件进行保护的一种有效手段。从加密技术的发展历程及发展趋势来看，加密可大体划分为软加密和硬加密两种。硬加密的典型产品是使用并口的软件狗，它的缺点是端口地址固定，容易被逻辑分析仪或仿真软件跟踪，并且还占用了有限的并口资源。笔者设计的基于ＰＣＩ总线的加密卡具有以下几个优点：第一，ＰＣＩ总线是当今计算机使用的主流标准总线，具有丰富的硬件资源，因此不易受资源环境限制；第二，ＰＣＩ设备配置空间采用自动配置方式，反跟踪能力强；第三，在ＰＣＩ扩展卡上易于实现先进的加密算法。

**１ 总体设计方案**

基于ＰＣＩ总线的加密卡插在计算机的ＰＣＩ总线插槽上（５Ｖ ３２Ｂｉｔ连接器），主处理器通过与加密卡通信，获取密钥及其它数据。加密卡的工作过程和工作原理是：系统动态分配给加密卡４字节Ｉ／Ｏ空间，被加密软件通过驱动程序访问该Ｉ／Ｏ空间；加密卡收到访问命令后，通过ＰＣＩ专用接口芯片，把ＰＣＩ总线访问时序转化为本地总线访问时序；本地总线信号经过转换处理后，与单片机相连，按约定的通信协议与单片机通信。上述过程实现了主处理器对加密卡的访问操作。
  
  
**[图1 硬件总体设计方案](http://www.avrw.com/article/pic/2006729183643734.gif)**
  
  


下面以主处理器对加密卡进行写操作为例，阐述具体的实现方法。加密卡采用ＰＬＸ公司的ＰＣＩ９０５２作为ＰＣＩ总线周期与本地总线周期进行转换的接口芯片。ＰＣＩ９０５２作为ＰＣＩ总线从设备，又充当了本地总线主设备，对其配置可通过ＥＥＰＲＯＭ ９３ＬＣ４６Ｂ实现。主处理器对加密卡进行写操作，ＰＣＩ９０５２把ＰＣＩ总线时序转化为８位本地数据总线写操作。这８位本地数据总线通过Ｌａｔｔｉｃｅ公司的ｉｓｐＬＳＩ２０６４与单片机ＡＴ８９Ｃ５１的Ｐ０口相连，２０６４完成ＰＣＩ９０５２本地总线与ＡＴ８９Ｃ５１之间的数据传输、握手信号转换控制等功能。２０６４对８位本地数据总线写操作进行处理，产生中断信号。该中断信号与ＡＴ８９Ｃ５１的ＩＮＴ０＃相连，使ＡＴ８９Ｃ５１产生中断。ＡＴ８９Ｃ５１产生中断后，检测与其Ｐ２口相连的本地读写信号ＷＲ＃、ＲＤ＃、ＬＷ／Ｒ＃。当ＷＲ＃为低电平、ＬＷ／Ｒ＃为高电平时，ＡＴ８９Ｃ５１判断目前的操作是否为写操作。确认是写操作后，ＡＴ８９Ｃ５１把Ｐ０口上的８位数据取下来，然后用ＲＤＹ５１＃（经２０６４转换后）通知ＰＣＩ９０５２的ＬＲＤＹｉ＃，表明自己已经把当前的８位数据取走，可以继续下面的工作。ＰＣＩ９０５２收到ＬＲＤＹｉ＃有效后，结束当前的８位数据写操作。ＰＣＩ总线的一次３２位数据写操作，ＰＣＩ９０５２本地总线需要四次８位数据写操作，通过字节使能ＬＢＥ１＃、ＬＢＥ０＃区分当前的８位数据是第几个字节有效。

加密卡硬件总体设计方案如图１所示。

**２ 硬件各组成部分说明**

２．１ ＰＣＩ９０５２部分

ＰＣＩ９０５２是ＰＣＩ总线专用接口芯片，采用ＣＭＯＳ工艺，１６０引脚ＰＱＦＰ封装，符合ＰＣＩ总线标准２．１版。其总线接口信号与ＰＣＩ总线信号位置对应，因此可直接相连，易于ＰＣＢ实现。ＰＣＩ９０５２的最大数据传输速率可达１３２ＭＢ／ｓ；本地时钟最高可至４０ＭＨｚ，且无需与ＰＣＩ时钟同步；可通过两个本地中断输入或软件设置产生ＰＣＩ中断。它支持三种本地总线工作模式，实际设计采用地址和数据线非复用、８位本地数据总线、非ＩＳＡ模式。

ＰＣＩ９０５２内部有一个６４字节ＰＣＩ配置空间，一个８４字节本地配置寄存器组。对ＰＣＩ９０５２的配置可由主机或符合３线协议的串行ＥＥＰＲＯＭ完成（注：ＩＳＡ模式必须由串行ＥＥＰＲＯＭ完成配置）。实际设计采用Ｍｉｃｒｏｃｈｉｐ公司的９３ＬＣ４６Ｂ存放配置信息。系统初始化时，自动将配置信息装入ＰＣＩ９０５２，约需７８０μｓ。如果ＥＥＰＲＯＭ不存在或检测到空设备，则ＰＣＩ９０５２设置为默认值。

在设计中，ＥＥＰＲＯＭ用到的配置项目有：设备ＩＤ：９０５０；厂商ＩＤ：１０Ｂ５；分类代码：０７８０；子系统ＩＤ：９０５０；子系统厂商ＩＤ：１０Ｂ５；支持ＩＮＴＡ＃中断，ＰＣＩ ３Ｃ：０１００；分配４字节本地Ｉ／Ｏ空间：（例ＬＡＳ０ＲＲ）０ＦＦＦＦＦＦＤ；其它本地地址空间未使用：００００００００；４字节本地Ｉ／Ｏ空间基地址（模４对齐）：（ＬＡＳ０ＢＡ）０１２００００１（仅为示例）；４字节本地Ｉ／Ｏ空间描述符：（ＬＡＳ０ＢＲＤ）００００００２２（非猝发、ＬＲＤＹｉ＃输入使能、ＢＴＥＲＭ＃输入不使能、不预取、各内部等待状态数均为０、８位本地数据总线宽度、小Ｅｎｄｉａｎ模式）；中断控制／状态，Ｌｏｃａｌ ４Ｃ：０００００１４３（ＬＩＮＴｉ１使能、ＬＩＮＴｉ１边沿触发中断选择使能、ＬＩＮＴｉ２不使能、ＰＣＩ中断使能、非软件中断、ＩＳＡ接口模式不使能）；Ｕｓｅｒ Ｉ／Ｏ、从设备应答、串行ＥＥＰＲＯＭ、初始化控制，Ｌｏｃａｌ ５０：０００２４４９２。有两点要注意：一是设计中采用ＰＬＸ公司推荐使用的串行ＥＥＰＲＯＭ ９３ＬＣ４６Ｂ按字（１６ ｂｉｔ）为单位组织；二是ＥＥＰＲＯＭ开发器编辑输入与手工书写的顺序对应关系，以厂商ＩＤ：１０Ｂ５为例，在开发器编辑输入的是ｂ５１０，而不是１０Ｂ５。

ＰＣＩ９０５２本地信号的含义是：ＬＡＤ[７．．０]：本地８位数据总线；ＷＲ＃：写有效；ＲＤ＃：读有效；ＬＷ／Ｒ＃：数据传输方向，高电平为写操作，低电平为读操作；ＬＢＥ１＃和ＬＢＥ０＃：字节使能，表明当前ＬＡＤ[７．．０]上的数据是第几个字节（０到３）；ＢＬＡＳＴ＃：ＰＣＩ９０５２写数据准备好或读数据已取走；ＬＲＤＹｉ＃：外部设备（此设计指单片机）已把ＰＣＩ９０５２写操作数据取走或读操作数据准备好；ＬＩＮＴｉ１：外部设备通过ＬＩＮＴｉ１向主机发送ＩＮＴＡ＃中断，当单片机验证密钥正确，向主处理器发送请求，表明可以开始从中读取相关数据。

需注意的是，ＰＣＩ９０５２在使用时，某些引脚要加阻值为１ｋΩ～１０ｋΩ的下拉或上拉电阻。因此在实现时，给ＭＯＤＥ、ＬＨＯＬＤ、ＬＩＮＴｉ１引脚加下拉电阻，ＣＨＲＤＹ、ＥＥＤＯ、ＬＲＤＹｉ＃引脚加上拉电阻。
  
  
**[图2 PCI9052本地写时序](http://www.avrw.com/article/pic/2006729183644580.gif)**
  
  


以主处理器向单片机写数据为例，图２给出了ＰＣＩ９０５２的本地写时序。

２．２ ｉｓｐＬＳＩ２０６４部分

为降低数据被解析的风险，应尽量减少使用分离元件。因此在设计中选用了Ｌａｔｔｉｃｅ公司的ＣＰＬＤ ｉｓｐＬＳＩ２０６４。该芯片采用ＥＥＣＭＯＳ技术，１００引脚ＴＱＦＰ封装，拥有２０００个ＰＬＤ门，６４个Ｉ／Ｏ引脚另加４个专用输入，６４个寄存器，３个全局时钟，ＴＴＬ兼容的输入输出信号。２０６４具有在系统可编程ＩＳＰ（Ｉｎ－Ｓｙｓｔｅｍ Ｐｒｏｇｒａｍｍａｂｌｅ）功能，可方便实现硬件重构，易于升级，降低了设计风险，并且安全性能高。ＰＣＩ９０５２与单片机之间的８位数据线进行双向数据传输，不能简单地直接相连，需要进行传输方向控制和数据隔离。故用２０６４作为ＰＣＩ９０５２本地信号与单片机信号进行信号传递的接口，图３给出了８位数据信号双向传输的原理图。２０６４的开发软件ｉｓｐＤｅｓｉｇｎＥｘｐｅｒｔ ８．２版支持ＶＨＤＬ、Ｖｅｒｉｌｏｇ ＨＤＬ、Ａｂｅｌ等语言及原理图输入，且通过专用下载电缆可把最终生成的ＪＥＤＥＣ文件写入２０６４，实现编程。在设计时采用了原理图输入的方法。

原理图中用到的ＢＩ１８的功能描述为：当ＯＥ＝１时，ＸＢ为输出，Ａ为输入，即ＸＢ＝Ａ；当ＯＥ＝０时，ＸＢ为输入，Ｚ为输出，即Ｚ＝ＸＢ。ＦＤ２８的功能描述为：８位Ｄ触发器（带异步清除）。结合ＰＣＩ９０５２本地读写时序，可以分析得出，在进行读写操作时，图３实现了ＬＡＤ[７．．０]与Ｄ[７．．０]之间正常的数据传输；在非读写时，双方数据处于正常隔离状态。

２．３ 单片机ＡＴ８９Ｃ５１部分

单片机采用ＡＴＭＥＬ公司的ＡＴ８９Ｃ５１。这是一个８位微处理器，采用ＣＭＯＳ工艺，４０引脚ＤＩＰ封装。它含有４Ｋ字节Ｆｌａｓｈ和１２８字节ＲＡＭ，且自身具有加密保护功能。单片机不进行外部存储器和ＲＡＭ的扩展，程序存储和运行均在片内完成，有效地保证了加密强度。
  
  
**[图3 LAD[7..0]与D[7..0]之间的数据传输](http://www.avrw.com/article/pic/2006729183644621.gif)**
  
  


单片机的Ｐ０口接图３的Ｄ[７．．０]，并加１０ｋΩ的上拉排阻。ＷＲ＃、ＲＤ＃、Ｗ／Ｒ＃、ＢＥ１＃、ＢＥ０＃作为单片机输入信号接Ｐ２口。ＰＣＩ９０５２写数据准备好或读数据已取走信号ＲＥＱ９０５２＃作为单片机输入信号接Ｐ３．２（ＩＮＴ０＃);写数据单片机已取走或读数据单片机准备好信号ＲＤＹ５１＃作为单片机输出信号接Ｐ１．０;接Ｐ１．１的ＯＶＥＲ５１＃作为单片机输出信号，经２０６４接ＰＣＩ９０５２的ＬＩＮＴｉ１，通过ＬＩＮＴｉ１向主机发送ＩＮＴＡ＃中断请求。

基于ＰＣＩ总线的加密卡，依照ＰＣＩ总线标准２．１版，通过动态分配４字节Ｉ／Ｏ空间，实现主处理器与卡上单片机之间的握手通信。被加密软件通过访问加密卡，获取软件正常执行的相关权限。在加密卡不存在的情况下，被加密软件因得不到相关授权而无法运行，从而实现了加密功能。在单片机的存储器里，除了存放密钥之外，设计者还可以把被加密软件的部分程序、算法或常数写入单片机的存储器，在加密卡不存在的情况下，被加密软件的功能是不完整的，从根本上防止了软件破解。