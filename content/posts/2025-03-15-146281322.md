---
layout: post
title: "SpringBoot最佳实践JWT结合Redis实现双Token无感刷新"
date: 2025-03-15 16:30:46 +0800
description: "JWT是全称是JSON WEB TOKEN，是一个开放标准，用于将各方数据信息作为JSON格式进行对象传递，可以对数据进行可选的数字加密，可使用RSA或ECDSA进行公钥/私钥签名。JWT最常见的使用场景就是缓存当前用户登录信息，当用户登录成功之后，拿到JWT，之后用户的每一个请求在请求头携带上字段来辨别区分请求的用户信息。且不需要额外的资源开销。"
keywords: "【SpringBoot】最佳实践——JWT结合Redis实现双Token无感刷新"
categories: ['Spring']
tags: ['后端', 'Spring', 'Redis', 'Jwt', 'Boot']
artid: "146281322"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146281322
    alt: "SpringBoot最佳实践JWT结合Redis实现双Token无感刷新"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146281322
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146281322
cover: https://bing.ee123.net/img/rand?artid=146281322
image: https://bing.ee123.net/img/rand?artid=146281322
img: https://bing.ee123.net/img/rand?artid=146281322
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     【SpringBoot】最佳实践——JWT结合Redis实现双Token无感刷新
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="JWT_0">
     </a>
     JWT概览
    </h2>
    <h3>
     <a id="JWT_1">
     </a>
     JWT概念
    </h3>
    <p>
     <code>
      JWT
     </code>
     是全称是
     <code>
      JSON WEB TOKEN
     </code>
     ，是一个开放标准，用于将各方数据信息作为JSON格式进行对象传递，可以对数据进行可选的数字加密，可使用
     <code>
      RSA
     </code>
     或
     <code>
      ECDSA
     </code>
     进行公钥/私钥签名。
     <code>
      JWT
     </code>
     最常见的使用场景就是缓存当前用户登录信息，当用户登录成功之后，拿到
     <code>
      JWT
     </code>
     ，之后用户的每一个请求在请求头携带上
     <code>
      Authorization
     </code>
     字段来辨别区分请求的用户信息。且不需要额外的资源开销。
    </p>
    <h3>
     <a id="JWT_4">
     </a>
     JWT组成部分
    </h3>
    <p>
     JWT通常由一个头部（Header）、一个负载（Payload）和一个签名（Signature）三部分组成，这三部分之间用点（.）分隔。所以，一个完整的JWT看起来像这样：
    </p>
    <pre><code class="prism language-bash">xxxxx.yyyyy.zzzzz
</code></pre>
    <p>
     下面我们来详细解析每一部分：
    </p>
    <h4>
     <a id="header_13">
     </a>
     头部(header)
    </h4>
    <p>
     头部用于
     <strong>
      描述令牌的元数据
     </strong>
     ，通常包含令牌的类型（即JWT）和所使用的签名算法（如HMAC SHA256）。
    </p>
    <ul>
     <li>
      <code>
       typ
      </code>
      ：表示令牌的类型，JWT令牌统一写为"JWT"。
     </li>
     <li>
      <code>
       alg
      </code>
      ：表示签名使用的算法，例如HMAC SHA256或RSA。
     </li>
    </ul>
    <p>
     头部信息会被进行Base64编码，形成JWT的第一部分。
    </p>
    <pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>  
  <span class="token string-property property">"typ"</span><span class="token operator">:</span> <span class="token string">"JWT"</span><span class="token punctuation">,</span>  
  <span class="token string-property property">"alg"</span><span class="token operator">:</span> <span class="token string">"HS256"</span>  
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="payload_28">
     </a>
     负载(payload)
    </h4>
    <p>
     负载包含了JWT的声明，
     <strong>
      即传递的数据，这些数据通常包括用户信息和其他相关数据
     </strong>
     。声明有三种类型：注册的声明、公共的声明和私有的声明。
    </p>
    <ul>
     <li>
      <strong>
       注册的声明
      </strong>
      ：这是一组预定义的声明，它们不是强制的，但是推荐使用，以提供一组有用的、可互操作的声明。如：
      <code>
       iat
      </code>
      （签发时间）、
      <code>
       exp
      </code>
      （过期时间）、
      <code>
       aud
      </code>
      （接收方）、
      <code>
       sub
      </code>
      （用户唯一标识）、
      <code>
       jti
      </code>
      （JWT唯一标识）等。
     </li>
     <li>
      <strong>
       公共的声明
      </strong>
      ：可以定义任何名称，但应避免与注册的声明名称冲突。
     </li>
     <li>
      <strong>
       私有的声明
      </strong>
      ：是提供者和消费者之间共同定义的声明。
     </li>
    </ul>
    <p>
     负载同样会被Base64编码，形成JWT的第二部分。
    </p>
    <pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>  
  <span class="token string-property property">"sub"</span><span class="token operator">:</span> <span class="token string">"1234567890"</span><span class="token punctuation">,</span>  
  <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"John Doe"</span><span class="token punctuation">,</span>  
  <span class="token string-property property">"jti"</span><span class="token operator">:</span> <span class="token string">"unique-jwt-id"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"admin"</span><span class="token operator">:</span> <span class="token boolean">true</span>  
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="signature_46">
     </a>
     签名(signature)
    </h4>
    <p>
     签名将头部和负载用指定的算法进行签名，
     <strong>
      验证JWT的真实性和完整性
     </strong>
     。当接收者收到JWT时，他们可以使用相同的算法和密钥（对于HMAC算法）或使用公钥（对于RSA或ECDSA算法）验证签名。如果两个签名匹配，那么JWT就是有效的。
    </p>
    <p>
     签名的过程如下：
    </p>
    <ul>
     <li>
      先将Base64编码后的头部和负载数据用点号（
      <code>
       .
      </code>
      ）连接起来。
     </li>
     <li>
      使用指定的签名算法（例如，HMAC SHA256、RSA、ECDSA）和密钥对连接后的字符串进行签名。
     </li>
     <li>
      将生成的签名部分进行Base64Url编码，形成JWT的第三部分。
     </li>
    </ul>
    <p>
     签名部分也是经过Base64Url编码的，形成JWT的第三部分。
    </p>
    <pre><code class="prism language-json"><span class="token constant">HMACSHA256</span><span class="token punctuation">(</span>
    <span class="token function">base64UrlEncode</span><span class="token punctuation">(</span>header<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"."</span> <span class="token operator">+</span>
    <span class="token function">base64UrlEncode</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">,</span>
    secret<span class="token punctuation">)</span>
</code></pre>
    <p>
     注意：虽然Base64Url编码不是加密方式，但它可以确保JWT的字符串格式是紧凑的，并且容易在URL、POST参数或HTTP头部中传输。
    </p>
    <h2>
     <a id="_66">
     </a>
     技术方案设计
    </h2>
    <h3>
     <a id="SSO_67">
     </a>
     单点登录(SSO)
    </h3>
    <ul>
     <li>
      <strong>
       单点登录（Single Sign-On, SSO）
      </strong>
      是一种身份认证机制，允许用户通过
      <strong>
       一次登录
      </strong>
      即可访问多个相互信任的应用系统，而无需重复输入认证信息。
     </li>
    </ul>
    <h3>
     <a id="font_stylecolorrgba0_0_0_09backgroundcolorrgb252_252_252Tokenfont_70">
     </a>
     双Token机制
    </h3>
    <ul>
     <li>
      <strong>
       AccessToken
      </strong>
      <ul>
       <li>
        短期有效（如30分钟），用于接口访问。
       </li>
       <li>
        客户端每次请求API时携带。
       </li>
       <li>
        不持久化存储，仅通过签名验证合法性。
       </li>
      </ul>
     </li>
     <li>
      <strong>
       RefreshToken
      </strong>
      <ul>
       <li>
        用于获取新的Access Token，有效期长（如3天）。
       </li>
       <li>
        仅在刷新令牌时传输，不直接访问业务API。
       </li>
       <li>
        <strong>
         必须持久化存储（如Redis）
        </strong>
        ，服务端可主动使其失效。
       </li>
      </ul>
     </li>
     <li>
      <strong>
       签名算法
      </strong>
      ：使用RSA非对称加密算法，减少内存占用，防止篡改，并方便后续拓展子系统。
     </li>
    </ul>
    <h3>
     <a id="Token_81">
     </a>
     无感刷新Token
    </h3>
    <ul>
     <li>
      客户端将由于AccesssToken过期失败的请求存储起来，携带RefreshToken成功刷新Token后，将存储的失败请求重新发起，以此达到用户无感的体验。
     </li>
     <li>
      服务端根据RefreshToken解析出userId和deviceId后，去Redis中查询存储的RefreshToken并进行比对，成功后生成新的AT和RT并返回
     </li>
    </ul>
    <h3>
     <a id="_85">
     </a>
     多端会话管理
    </h3>
    <ul>
     <li>
      同一账号在不同设备登录时，为每个设备生成独立的RefreshToken。
     </li>
     <li>
      Redis中以
      <code>
       userId:deviceId
      </code>
      为键存储RefreshToken，过期时间设置为RefreshToken的过期时间。
     </li>
    </ul>
    <h3>
     <a id="_89">
     </a>
     废弃令牌移除
    </h3>
    <ul>
     <li>
      Redis中以
      <code>
       blacklist:token
      </code>
      为键存储AccessToken黑名单，键值对的过期时间设置为AccessToken的剩余有效期。
     </li>
     <li>
      直接删除Redis中的RefreshToken。
     </li>
    </ul>
    <h2>
     <a id="_93">
     </a>
     最佳实践
    </h2>
    <h3>
     <a id="_94">
     </a>
     总体流程
    </h3>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/img_convert/b847386404c7ccdc9d79281cab116687.png"/>
    </p>
    <h3>
     <a id="JWT_97">
     </a>
     JWT工具类
    </h3>
    <pre><code class="prism language-java"><span class="token comment">// JWT工具类</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>jsonwebtoken<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Value</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Date</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JwtUtil</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${jwt.secret}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> secret<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${jwt.access.expiration}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> accessExpiration<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${jwt.refresh.expiration}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> refreshExpiration<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">generateAccessToken</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">Jwts</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">setSubject</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">setIssuedAt</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">setExpiration</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> accessExpiration<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">signWith</span><span class="token punctuation">(</span><span class="token class-name">SignatureAlgorithm</span><span class="token punctuation">.</span><span class="token constant">HS512</span><span class="token punctuation">,</span> secret<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">compact</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">generateRefreshToken</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">Jwts</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">setSubject</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">setIssuedAt</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">setExpiration</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> refreshExpiration<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">signWith</span><span class="token punctuation">(</span><span class="token class-name">SignatureAlgorithm</span><span class="token punctuation">.</span><span class="token constant">HS512</span><span class="token punctuation">,</span> secret<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">compact</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">validateToken</span><span class="token punctuation">(</span><span class="token class-name">String</span> token<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Jwts</span><span class="token punctuation">.</span><span class="token function">parser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setSigningKey</span><span class="token punctuation">(</span>secret<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parseClaimsJws</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ExpiredJwtException</span> <span class="token operator">|</span> <span class="token class-name">UnsupportedJwtException</span> <span class="token operator">|</span> <span class="token class-name">MalformedJwtException</span> <span class="token operator">|</span> <span class="token class-name">IllegalArgumentException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getUsernameFromToken</span><span class="token punctuation">(</span><span class="token class-name">String</span> token<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">Jwts</span><span class="token punctuation">.</span><span class="token function">parser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setSigningKey</span><span class="token punctuation">(</span>secret<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parseClaimsJws</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="Redis_149">
     </a>
     Redis服务类
    </h3>
    <pre><code class="prism language-java"><span class="token comment">// Redis服务类</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">StringRedisTemplate</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisService</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">RedisService</span><span class="token punctuation">(</span><span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>redisTemplate <span class="token operator">=</span> redisTemplate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">saveRefreshToken</span><span class="token punctuation">(</span><span class="token class-name">String</span> refreshToken<span class="token punctuation">,</span> <span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"refresh_token:"</span> <span class="token operator">+</span> refreshToken<span class="token punctuation">,</span> username<span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">DAYS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isRefreshTokenValid</span><span class="token punctuation">(</span><span class="token class-name">String</span> refreshToken<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">hasKey</span><span class="token punctuation">(</span><span class="token string">"refresh_token:"</span> <span class="token operator">+</span> refreshToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deleteRefreshToken</span><span class="token punctuation">(</span><span class="token class-name">String</span> refreshToken<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">"refresh_token:"</span> <span class="token operator">+</span> refreshToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addToBlacklist</span><span class="token punctuation">(</span><span class="token class-name">String</span> accessToken<span class="token punctuation">,</span> <span class="token keyword">long</span> expirationMs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"blacklist:"</span> <span class="token operator">+</span> accessToken<span class="token punctuation">,</span> <span class="token string">"invalid"</span><span class="token punctuation">,</span> expirationMs<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isInBlacklist</span><span class="token punctuation">(</span><span class="token class-name">String</span> accessToken<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>redisTemplate<span class="token punctuation">.</span><span class="token function">hasKey</span><span class="token punctuation">(</span><span class="token string">"blacklist:"</span> <span class="token operator">+</span> accessToken<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="Filter_186">
     </a>
     Filter过滤器
    </h3>
    <pre><code class="prism language-java"><span class="token comment">// JWT过滤器</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span></span><span class="token class-name">UsernamePasswordAuthenticationToken</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">SecurityContextHolder</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>filter<span class="token punctuation">.</span></span><span class="token class-name">OncePerRequestFilter</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">FilterChain</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">ServletException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletRequest</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletResponse</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JwtFilter</span> <span class="token keyword">extends</span> <span class="token class-name">OncePerRequestFilter</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">JwtUtil</span> jwtUtil<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">RedisService</span> redisService<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">JwtFilter</span><span class="token punctuation">(</span><span class="token class-name">JwtUtil</span> jwtUtil<span class="token punctuation">,</span> <span class="token class-name">RedisService</span> redisService<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>jwtUtil <span class="token operator">=</span> jwtUtil<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>redisService <span class="token operator">=</span> redisService<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doFilterInternal</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> filterChain<span class="token punctuation">)</span> 
        <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
        
        <span class="token class-name">String</span> token <span class="token operator">=</span> <span class="token function">resolveToken</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>token <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            filterChain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>redisService<span class="token punctuation">.</span><span class="token function">isInBlacklist</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">sendError</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">"Token invalid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>jwtUtil<span class="token punctuation">.</span><span class="token function">validateToken</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">String</span> username <span class="token operator">=</span> jwtUtil<span class="token punctuation">.</span><span class="token function">getUsernameFromToken</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">UsernamePasswordAuthenticationToken</span> authentication <span class="token operator">=</span> 
                <span class="token keyword">new</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAuthentication</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
            filterChain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">sendError</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">"Token expired or invalid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">resolveToken</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">String</span> bearerToken <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">"Authorization"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bearerToken <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> bearerToken<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"Bearer "</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> bearerToken<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">sendError</span><span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
        response<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">.</span><span class="token constant">SC_UNAUTHORIZED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="Controller_249">
     </a>
     Controller类
    </h3>
    <pre><code class="prism language-java"><span class="token comment">// 控制器类</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">ResponseEntity</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthController</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">JwtUtil</span> jwtUtil<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">RedisService</span> redisService<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">AuthController</span><span class="token punctuation">(</span><span class="token class-name">JwtUtil</span> jwtUtil<span class="token punctuation">,</span> <span class="token class-name">RedisService</span> redisService<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>jwtUtil <span class="token operator">=</span> jwtUtil<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>redisService <span class="token operator">=</span> redisService<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">LoginRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 这里应添加用户认证逻辑（如数据库验证）</span>
        <span class="token class-name">String</span> username <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token class-name">String</span> accessToken <span class="token operator">=</span> jwtUtil<span class="token punctuation">.</span><span class="token function">generateAccessToken</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> refreshToken <span class="token operator">=</span> jwtUtil<span class="token punctuation">.</span><span class="token function">generateRefreshToken</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        redisService<span class="token punctuation">.</span><span class="token function">saveRefreshToken</span><span class="token punctuation">(</span>refreshToken<span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TokenResponse</span><span class="token punctuation">(</span>accessToken<span class="token punctuation">,</span> refreshToken<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/refresh"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">refreshToken</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">RefreshRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">String</span> refreshToken <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getRefreshToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>redisService<span class="token punctuation">.</span><span class="token function">isRefreshTokenValid</span><span class="token punctuation">(</span>refreshToken<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token string">"Invalid refresh token"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">String</span> username <span class="token operator">=</span> jwtUtil<span class="token punctuation">.</span><span class="token function">getUsernameFromToken</span><span class="token punctuation">(</span>refreshToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> newAccessToken <span class="token operator">=</span> jwtUtil<span class="token punctuation">.</span><span class="token function">generateAccessToken</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> newRefreshToken <span class="token operator">=</span> jwtUtil<span class="token punctuation">.</span><span class="token function">generateRefreshToken</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 替换旧refreshToken</span>
        redisService<span class="token punctuation">.</span><span class="token function">deleteRefreshToken</span><span class="token punctuation">(</span>refreshToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
        redisService<span class="token punctuation">.</span><span class="token function">saveRefreshToken</span><span class="token punctuation">(</span>newRefreshToken<span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 将旧accessToken加入黑名单（可选）</span>
        <span class="token comment">// long expiration = jwtUtil.getExpirationFromToken(refreshToken).getTime() - System.currentTimeMillis();</span>
        <span class="token comment">// redisService.addToBlacklist(refreshToken, expiration);</span>

        <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TokenResponse</span><span class="token punctuation">(</span>newAccessToken<span class="token punctuation">,</span> newRefreshToken<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// DTO类</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">LoginRequest</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> username<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span>
        <span class="token comment">// getters/setters</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">RefreshRequest</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> refreshToken<span class="token punctuation">;</span>
        <span class="token comment">// getters/setters</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">TokenResponse</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> accessToken<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> refreshToken<span class="token punctuation">;</span>
        <span class="token comment">// constructor/getters</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h2>
     <a id="_319">
     </a>
     问题解析
    </h2>
    <h3>
     <a id="Token_320">
     </a>
     相比单Token的优势
    </h3>
    <ul>
     <li>
      <strong>
       高安全性
      </strong>
      ：用户请求仅携带过期时间较短的AccessToken，即使令牌泄露，风险时间窗口也较小；用户仅在请求刷新Token时携带RefreshToken
     </li>
     <li>
      <strong>
       长会话
      </strong>
      ：RefreshToken一般设置较长的过期时间，只要RT不过期用户就无需重复登录
     </li>
    </ul>
    <h3>
     <a id="Redis_324">
     </a>
     引入Redis的作用
    </h3>
    <ul>
     <li>
      <strong>
       方便状态管理
      </strong>
      ：如果不存在Redis，用户登出后只能等待Token过期才能被动失效，增加Token暴露风险；通过在Redis中引入黑名单blacklist，可以使得Token主动失效
     </li>
     <li>
      <strong>
       多端会话管理
      </strong>
      ：通过以
      <code>
       userId:deviceId
      </code>
      为键存储不同设备的Token，实现同用户多端登录。通过删除对应设备的键并加上黑名单，可以主动剔出对应设备
     </li>
     <li>
      <strong>
       分布式一致性
      </strong>
      ：若使用本地内存存储 RT，在分布式多节点架构中，各节点无法共享 RT 状态，导致用户在一个节点退出后，其他节点仍认为 RT 有效。Redis作为
      <strong>
       集中式存储
      </strong>
      ，确保所有服务节点访问同一份 RT 数据，状态一致。
     </li>
    </ul>
    <h3>
     <a id="Token_329">
     </a>
     保证Token安全性
    </h3>
    <ul>
     <li>
      <strong>
       存储安全性
      </strong>
      ：AT存于内存或 SessionStorage（页面关闭失效），而RT通过 HttpOnly; Secure; SameSite=Strict Cookie 存储（XSS攻击无效）。
     </li>
     <li>
      <strong>
       传输安全性
      </strong>
      ：开启HTTPS，防止中间人攻击（篡改、伪造和窃听）；AT通过
      <code>
       Authorization: Bearer {token}
      </code>
      请求头传递，避免 URL 参数（防日志泄露），而RT通过
      <code>
       Cookie
      </code>
      （标记
      <code>
       HttpOnly; Secure
      </code>
      ）传输。
     </li>
    </ul>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f:626c6f672e6373646e2e6e65742f6b3132333435366b61682f:61727469636c652f64657461696c732f313436323831333232" class_="artid" style="display:none">
 </p>
</div>


