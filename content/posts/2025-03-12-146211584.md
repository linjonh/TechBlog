---
arturl_encode: "68747470733a2f2f:626c6f672e6373646e2e6e65742f78755f77656e6d696e672f:61727469636c652f64657461696c732f313436323131353834"
layout: post
title: "apollo3-blue-plus录音的opus音频到播放记录"
date: 2025-03-12 18:20:33 +0800
description: "/ %02X 表示大写十六进制，固定2位。OPUS文件数据每一帧长度为88个字节，帧开头00 00 00 50，如下面二帧数据，保存BIN文件时，必须保证每帧数据完整，否则在转成PCM文件会出错。input/output：输入 Opus 比特流和输出文件（如 PCM）。下图出错，就是opus文件有帧不完整时，就会出现转换pcm文件时报错。channels：声道数（1/2）。"
keywords: "apollo3 blue plus录音的opus音频到播放记录"
categories: ['未分类']
tags: ['驱动开发', '音视频', '物联网', '嵌入式硬件', 'Mcu', 'Arm']
artid: "146211584"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146211584
    alt: "apollo3-blue-plus录音的opus音频到播放记录"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146211584
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146211584
cover: https://bing.ee123.net/img/rand?artid=146211584
image: https://bing.ee123.net/img/rand?artid=146211584
img: https://bing.ee123.net/img/rand?artid=146211584
---

# apollo3 blue plus录音的opus音频到播放记录

//\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*
  
//
  
// Main Function.
  
//
  
//\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*
  
int
  
main(void)
  
{
  
  
//
  
// Set the clock frequency.
  
//
  
am\_hal\_clkgen\_control(AM\_HAL\_CLKGEN\_CONTROL\_SYSCLK\_MAX, 0);

//
  
// Set the default cache configuration
  
//
  
am\_hal\_cachectrl\_config(&am\_hal\_cachectrl\_benchmark);
  
am\_hal\_cachectrl\_enable();

//
  
// Configure the board for low power operation.
  
//
  
am\_bsp\_low\_power\_init();

#if (PRINT\_UART == 1)
  
am\_bsp\_uart\_printf\_enable();

//
  
// Clear the terminal and print the banner.
  
//
  
am\_util\_stdio\_terminal\_clear();
  
am\_util\_stdio\_printf("Ambiq Micro 'while' example.\n\n");

//
  
// Brief description
  
//
  
am\_util\_stdio\_printf("Used for measuring power in an infinite while loop.\n");

//
  
// Print the compiler version.
  
//
  
am\_util\_stdio\_printf("App Compiler:    %s\n", COMPILER\_VERSION);
  
am\_util\_stdio\_printf("HAL Compiler:    %s\n", g\_ui8HALcompiler);
  
am\_util\_stdio\_printf("HAL SDK version: %d.%d.%d\n",
  
g\_ui32HALversion.s.Major,
  
g\_ui32HALversion.s.Minor,
  
g\_ui32HALversion.s.Revision);
  
am\_util\_stdio\_printf("HAL compiled with %s-style registers\n",
  
g\_ui32HALversion.s.bAMREGS ? "AM\_REG" : "CMSIS");

#endif // PRINT\_UART

amu2s\_init();
  
PDMInit();
  
am\_hal\_pdm\_enable(PDMHandle);
  
pdm\_trigger\_dma();

SEGGER\_RTT\_ConfigUpBuffer(1, "TestDataLogger", ui8RttLoggerBuffer, RTT\_LOGGER\_BUFFER\_LENGTH\_BYTE, SEGGER\_RTT\_MODE\_NO\_BLOCK\_SKIP);

#if USE\_OPUS
  
/\* initialize the audio encoder \*/
  
audio\_enc\_init(true);       // true for with header
  
#endif // #if USE\_OPUS

// master interrupt enable
  
am\_hal\_interrupt\_master\_enable();

while(1)
  
{

#if USE\_OPUS
  
if(g\_opusInputReadyFlag == true)
  
{
  
g\_opusInputReadyFlag = false;
  
// data ready to encode, run encoder

uint32\_t encoded\_bytes = audio\_enc\_encode\_frame((short\*)g\_opusAudioInputBuffer, AUDIO\_FRAME\_SIZE\_SAMPLES, (unsigned char\*)g\_opusAudioOutputBuffer);

for (int i = 0; i < encoded\_bytes; i++)
  
{
  
am\_util\_stdio\_printf("%02X ", g\_opusAudioOutputBuffer[i]); // %02X 表示大写十六进制，固定2位
  
}
  
// send to RTT
  
//SEGGER\_RTT\_Write(1, (uint8\_t\*)g\_opusAudioOutputBuffer, encoded\_bytes);

// send to AmU2S
  
amu2s\_send(Amu2s\_opus, g\_opusAudioOutputBuffer, AMU2S\_OPUS\_BYTES);

#endif // #if USE\_OPUS
  
}
  
}
  
}
  
经上述程序处理，通过串口发送给电脑串口工具接收处理，如下图：

![](https://i-blog.csdnimg.cn/direct/c868b1885db645629f1e6a4d7138cfa2.png)

Opus音频数据（压缩比8：1）可以复制串口数据，经winhex工具，直接组成BIN文件，如下图：

![](https://i-blog.csdnimg.cn/direct/f754d9ca453d4c029bce493b877406b9.png)

然后按下面步骤转换成可以正常播放的wav文件，

将opus文件转成pcm文件命令：

opus\_demo\_tools\_0.2 -d 16000 1 audio\_opus opus\_pcm

如下图：

![](https://i-blog.csdnimg.cn/direct/8a150903104c452e964a4d8dd518871b.png)

//将PCM转换成wav播放文件命令：

python bin\_to\_wav.py mono -i opus\_pcm

如下图：

![](https://i-blog.csdnimg.cn/direct/14ac00f2e302400aa47628c6436d6db8.png)

opus\_demo\_tools\_0.2 -d <sampling rate> <channels> [options] <input> <output>

必选参数：

sampling rate：输出音频的采样率（需与编码时一致）。

channels：声道数（1/2）。

input/output：输入 Opus 比特流和输出文件（如 PCM）。

常用选项：

-d：仅运行解码器。

OPUS文件数据每一帧长度为88个字节，帧开头00 00 00 50，如下面二帧数据，保存BIN文件时，必须保证每帧数据完整，否则在转成PCM文件会出错。

00 00 00 50 12 D8 E5 00 B8 51 93 9B B7 0F 96 C8 88 C1 53 EA 76 1B 12 8F 15 D5 6A 65 3C D2 D8 24 72 07 E5 72 D8 5C 36 EF 66 53 35 DE 5C C8 9D 77 E8 BE 95 DC EF FD 01 A1 2F 88 85 77 16 6B ED DD 0F DF 6A A0 30 AD 8D 02 42 82 D7 B5 FE 21 B4 0A 37 C2 0E B4 A9 A3 45 FA

00 00 00 50 2B 37 89 00 B8 51 93 B0 14 C3 B2 7E 88 83 08 5E 29 62 39 CF C8 0D E6 4A 85 80 D0 56 40 7D EE 07 46 4C B1 08 73 DD 3A DB F7 12 70 3C 7F E3 9B BD 8A E9 A7 E0 83 D7 50 95 9A 64 51 CF 97 6A 37 0E DA 0A B2 53 41 9F E1 1E B3 C1 54 9A 26 C1 4E 7B 97 28 4C 7F

下图出错，就是opus文件有帧不完整时，就会出现转换pcm文件时报错。

![](https://i-blog.csdnimg.cn/direct/ba3466043de94e7ab38ac97194c21664.png)