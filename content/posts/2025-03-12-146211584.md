---
layout: post
title: "apollo3-blue-plus录音的opus音频到播放记录"
date: 2025-03-12 18:20:33 +0800
description: "/ %02X 表示大写十六进制，固定2位。OPUS文件数据每一帧长度为88个字节，帧开头00 00 00 50，如下面二帧数据，保存BIN文件时，必须保证每帧数据完整，否则在转成PCM文件会出错。input/output：输入 Opus 比特流和输出文件（如 PCM）。下图出错，就是opus文件有帧不完整时，就会出现转换pcm文件时报错。channels：声道数（1/2）。"
keywords: "apollo3 blue plus录音的opus音频到播放记录"
categories: ['未分类']
tags: ['驱动开发', '音视频', '物联网', '嵌入式硬件', 'Mcu', 'Arm']
artid: "146211584"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146211584
    alt: "apollo3-blue-plus录音的opus音频到播放记录"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146211584
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146211584
cover: https://bing.ee123.net/img/rand?artid=146211584
image: https://bing.ee123.net/img/rand?artid=146211584
img: https://bing.ee123.net/img/rand?artid=146211584
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     apollo3 blue plus录音的opus音频到播放记录
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <p>
     //*****************************************************************************
     <br/>
     //
     <br/>
     // Main Function.
     <br/>
     //
     <br/>
     //*****************************************************************************
     <br/>
     int
     <br/>
     main(void)
     <br/>
     {
     <!-- -->
     <br/>
     <br/>
     //
     <br/>
     // Set the clock frequency.
     <br/>
     //
     <br/>
     am_hal_clkgen_control(AM_HAL_CLKGEN_CONTROL_SYSCLK_MAX, 0);
    </p>
    <p>
     //
     <br/>
     // Set the default cache configuration
     <br/>
     //
     <br/>
     am_hal_cachectrl_config(&amp;am_hal_cachectrl_benchmark);
     <br/>
     am_hal_cachectrl_enable();
    </p>
    <p>
     //
     <br/>
     // Configure the board for low power operation.
     <br/>
     //
     <br/>
     am_bsp_low_power_init();
    </p>
    <p>
     #if (PRINT_UART == 1)
     <br/>
     am_bsp_uart_printf_enable();
    </p>
    <p>
     //
     <br/>
     // Clear the terminal and print the banner.
     <br/>
     //
     <br/>
     am_util_stdio_terminal_clear();
     <br/>
     am_util_stdio_printf("Ambiq Micro 'while' example.\n\n");
    </p>
    <p>
     //
     <br/>
     // Brief description
     <br/>
     //
     <br/>
     am_util_stdio_printf("Used for measuring power in an infinite while loop.\n");
    </p>
    <p>
     //
     <br/>
     // Print the compiler version.
     <br/>
     //
     <br/>
     am_util_stdio_printf("App Compiler:    %s\n", COMPILER_VERSION);
     <br/>
     am_util_stdio_printf("HAL Compiler:    %s\n", g_ui8HALcompiler);
     <br/>
     am_util_stdio_printf("HAL SDK version: %d.%d.%d\n",
     <br/>
     g_ui32HALversion.s.Major,
     <br/>
     g_ui32HALversion.s.Minor,
     <br/>
     g_ui32HALversion.s.Revision);
     <br/>
     am_util_stdio_printf("HAL compiled with %s-style registers\n",
     <br/>
     g_ui32HALversion.s.bAMREGS ? "AM_REG" : "CMSIS");
    </p>
    <p>
     <br/>
     #endif // PRINT_UART
    </p>
    <p>
     amu2s_init();
     <br/>
     PDMInit();
     <br/>
     am_hal_pdm_enable(PDMHandle);
     <br/>
     pdm_trigger_dma();
    </p>
    <p>
     SEGGER_RTT_ConfigUpBuffer(1, "TestDataLogger", ui8RttLoggerBuffer, RTT_LOGGER_BUFFER_LENGTH_BYTE, SEGGER_RTT_MODE_NO_BLOCK_SKIP);
    </p>
    <p>
     #if USE_OPUS
     <br/>
     /* initialize the audio encoder */
     <br/>
     audio_enc_init(true);       // true for with header
     <br/>
     #endif // #if USE_OPUS
    </p>
    <p>
     // master interrupt enable
     <br/>
     am_hal_interrupt_master_enable();
    </p>
    <p>
     while(1)
     <br/>
     {
     <!-- -->
    </p>
    <p>
     #if USE_OPUS
     <br/>
     if(g_opusInputReadyFlag == true)
     <br/>
     {
     <!-- -->
     <br/>
     g_opusInputReadyFlag = false;
     <br/>
     // data ready to encode, run encoder
    </p>
    <p>
     uint32_t encoded_bytes = audio_enc_encode_frame((short*)g_opusAudioInputBuffer, AUDIO_FRAME_SIZE_SAMPLES, (unsigned char*)g_opusAudioOutputBuffer);
    </p>
    <p>
     for (int i = 0; i &lt; encoded_bytes; i++)
     <br/>
     {
     <!-- -->
     <br/>
     am_util_stdio_printf("%02X ", g_opusAudioOutputBuffer[i]); // %02X 表示大写十六进制，固定2位
     <br/>
     }
     <br/>
     // send to RTT
     <br/>
     //SEGGER_RTT_Write(1, (uint8_t*)g_opusAudioOutputBuffer, encoded_bytes);
    </p>
    <p>
     // send to AmU2S
     <br/>
     amu2s_send(Amu2s_opus, g_opusAudioOutputBuffer, AMU2S_OPUS_BYTES);
    </p>
    <p>
     #endif // #if USE_OPUS
     <br/>
     }
     <br/>
     }
     <br/>
     }
     <br/>
     经上述程序处理，通过串口发送给电脑串口工具接收处理，如下图：
    </p>
    <p>
     <img alt="" height="456" src="https://i-blog.csdnimg.cn/direct/c868b1885db645629f1e6a4d7138cfa2.png" width="672"/>
    </p>
    <p style="margin-left:0; margin-right:0; text-align:left">
     Opus音频数据（压缩比8：1）可以复制串口数据，经winhex工具，直接组成BIN文件，如下图：
    </p>
    <p style="margin-left:0; margin-right:0; text-align:left">
     <img alt="" height="679" src="https://i-blog.csdnimg.cn/direct/f754d9ca453d4c029bce493b877406b9.png" width="663"/>
    </p>
    <p style="margin-left:0; margin-right:0; text-align:left">
     然后按下面步骤转换成可以正常播放的wav文件，
    </p>
    <p style="margin-left:0; margin-right:0; text-align:left">
     将opus文件转成pcm文件命令：
    </p>
    <p style="margin-left:0; margin-right:0; text-align:left">
     opus_demo_tools_0.2 -d 16000 1 audio_opus opus_pcm
    </p>
    <p style="margin-left:0; margin-right:0; text-align:left">
     如下图：
    </p>
    <p style="margin-left:0; margin-right:0; text-align:left">
     <img alt="" height="122" src="https://i-blog.csdnimg.cn/direct/8a150903104c452e964a4d8dd518871b.png" width="944"/>
    </p>
    <p style="margin-left:0; margin-right:0; text-align:left">
     //将PCM转换成wav播放文件命令：
    </p>
    <p style="margin-left:0; margin-right:0; text-align:left">
     python bin_to_wav.py mono -i opus_pcm
    </p>
    <p style="margin-left:0; margin-right:0; text-align:left">
     如下图：
    </p>
    <p style="margin-left:0; margin-right:0; text-align:left">
     <img alt="" height="197" src="https://i-blog.csdnimg.cn/direct/14ac00f2e302400aa47628c6436d6db8.png" width="962"/>
    </p>
    <p style="margin-left:0; margin-right:0; text-align:left">
     opus_demo_tools_0.2 -d &lt;sampling rate&gt; &lt;channels&gt; [options] &lt;input&gt; &lt;output&gt;
    </p>
    <p style="margin-left:0; margin-right:0; text-align:left">
     必选参数：
    </p>
    <p style="margin-left:0; margin-right:0; text-align:left">
     sampling rate：输出音频的采样率（需与编码时一致）。
    </p>
    <p style="margin-left:0; margin-right:0; text-align:left">
     channels：声道数（1/2）。
    </p>
    <p style="margin-left:0; margin-right:0; text-align:left">
     input/output：输入 Opus 比特流和输出文件（如 PCM）。
    </p>
    <p style="margin-left:0; margin-right:0; text-align:left">
     常用选项：
    </p>
    <p style="margin-left:0; margin-right:0; text-align:left">
     -d：仅运行解码器。
    </p>
    <p style="margin-left:0; margin-right:0; text-align:left">
     OPUS文件数据每一帧长度为88个字节，帧开头00 00 00 50，如下面二帧数据，保存BIN文件时，必须保证每帧数据完整，否则在转成PCM文件会出错。
    </p>
    <p style="margin-left:0; margin-right:0; text-align:left">
     00 00 00 50 12 D8 E5 00 B8 51 93 9B B7 0F 96 C8 88 C1 53 EA 76 1B 12 8F 15 D5 6A 65 3C D2 D8 24 72 07 E5 72 D8 5C 36 EF 66 53 35 DE 5C C8 9D 77 E8 BE 95 DC EF FD 01 A1 2F 88 85 77 16 6B ED DD 0F DF 6A A0 30 AD 8D 02 42 82 D7 B5 FE 21 B4 0A 37 C2 0E B4 A9 A3 45 FA
    </p>
    <p style="margin-left:0; margin-right:0; text-align:left">
     00 00 00 50 2B 37 89 00 B8 51 93 B0 14 C3 B2 7E 88 83 08 5E 29 62 39 CF C8 0D E6 4A 85 80 D0 56 40 7D EE 07 46 4C B1 08 73 DD 3A DB F7 12 70 3C 7F E3 9B BD 8A E9 A7 E0 83 D7 50 95 9A 64 51 CF 97 6A 37 0E DA 0A B2 53 41 9F E1 1E B3 C1 54 9A 26 C1 4E 7B 97 28 4C 7F
    </p>
    <p style="margin-left:0; margin-right:0; text-align:left">
     下图出错，就是opus文件有帧不完整时，就会出现转换pcm文件时报错。
    </p>
    <p style="margin-left:0; margin-right:0; text-align:left">
     <img alt="" height="100" src="https://i-blog.csdnimg.cn/direct/ba3466043de94e7ab38ac97194c21664.png" width="792"/>
    </p>
   </div>
  </div>
 </article>
 <p alt="68747470733a2f2f:626c6f672e6373646e2e6e65742f78755f77656e6d696e672f:61727469636c652f64657461696c732f313436323131353834" class_="artid" style="display:none">
 </p>
</div>


