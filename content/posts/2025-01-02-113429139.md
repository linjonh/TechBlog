---
layout: post
title: "移远EC600S-CN-4-MQTT接入阿里云"
date: 2025-01-02 09:20:35 +0800
description: "MQTT是一种基于 发布/订阅 模式的轻量级通信协议。MQTT专门针对物联网设备开发，是一种低开销、"
keywords: "移远4g接入阿里云"
categories: ['通信协议阿里云', 'Mqtt', 'Cn', 'Cat', '4G']
tags: ['物联网', '嵌入式', 'Cat', '4G']
artid: "113429139"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=113429139
    alt: "移远EC600S-CN-4-MQTT接入阿里云"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=113429139
featuredImagePreview: https://bing.ee123.net/img/rand?artid=113429139
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     移远EC600S-CN (4) - MQTT接入阿里云
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <p style="text-indent:0;">
    </p>
    <p style="text-indent:33px;">
     MQTT是一种基于
     <strong>
      发布/订阅
     </strong>
     模式的
     <strong>
      轻量级
     </strong>
     通信协议。MQTT专门针对
     <strong>
      物联网设备
     </strong>
     开发，是一种
     <strong>
      低开销、低带宽占用的即时通讯协议
     </strong>
     。该协议构建于
     <strong>
      TCP/IP
     </strong>
     上，旨在为低带宽和不稳定网络环境中的物联网设备，提供可靠的网络服务。它的设计思想是简单、开放、规范，易于实现，这些特点使其非常适合
     <strong>
      机器间通信（M2M）
     </strong>
     、
     <strong>
      物联网（IoT）
     </strong>
     等场景。因其协议简单、数据流量开销低、时延低、对网络条件的容忍度高等特点，特别适合于硬件受限的嵌入式设备。MQTT 最大优点在于，可以以极少的代码和有限的网络带宽，为远程设备连接提供实时可靠的消息服务。
    </p>
    <p style="text-indent:33px;">
     HTTP连接并不适合于物联网设备通信，原因主要如下：
    </p>
    <ul>
     <li>
      1. 流量、功耗大。HTTP可以看作是单向连接，所以需要设备定时查询状态，导致即使设备空闲还是会产生多余的流量开销，同时增大了空闲功耗。
     </li>
     <li>
      2. 时延高。云服务器会限制HTTP接入的查询频率，例如OneNET将HTTP的最短刷新间隔限制在3s，以减轻服务器的压力。但导致从用户到设备会产生数秒的时延，用户体验非常不好。
     </li>
    </ul>
    <p style="text-indent:33px;">
    </p>
    <p style="text-indent:33px;">
     上一章使用HTTP连接OneNET，但不建议产品中这么应用，仅作为了解。实际产品肯定要MQTT，体验好太多。
    </p>
    <p style="text-indent:33px;">
     EC600S的MQTT指令支持阿里云、移动OneNET、华为IoT三种云平台，可实现云服务的快速接入，下面介绍如何用EC600S的AT指令以MQTT方式接入阿里云。
    </p>
    <p style="text-indent:33px;">
     同样也适用于 EC200S。（EC200S不支持QuecPython，体积比EC600S略大，但便宜很多）
    </p>
    <p>
    </p>
    <h2>
     1. 准备
    </h2>
    <p style="text-indent:33px;">
     QCOM_V1.6
    </p>
    <p style="text-indent:33px;">
     ma_MQTT.ini（QCOM的配置导入文件，包含我调试使用到的AT命令）
    </p>
    <p style="text-indent:33px;">
     Quectel_EC200x&amp;EC600S&amp;EG912Y系列_MQTT_应用指导_V1.0.pdf
    </p>
    <p style="text-indent:33px;">
     阿里云设备管理账号：
     <a href="https://blog.csdn.net/Mark_md/article/details/108051182">
      阿里云创建产品、设备、获取三元组
     </a>
    </p>
    <p style="text-indent:33px;">
     以上工具和文档已上传GitHub：
     <a href="https://github.com/ZhiliangMa/EC600S-CN-Application-Guidance.git">
      EC600S 文档及工具下载
     </a>
    </p>
    <p>
    </p>
    <p style="text-indent:33px;">
     对MQTT协议及帧构成有兴趣的，可以看下：（非必要可不看）
    </p>
    <p style="text-indent:33px;">
     MQTT 3.1.1报文帧详解：
     <a href="https://blog.csdn.net/Mark_md/article/details/108167143">
      MQTT报文帧详解
     </a>
    </p>
    <p style="text-indent:33px;">
     网络调试助手接入阿里云：
     <a href="https://blog.csdn.net/Mark_md/article/details/108314817">
      MQTT接入阿里云，逐字节解析
     </a>
    </p>
    <p>
    </p>
    <h2>
     2. MQTT接入阿里云 - AT操作流程
    </h2>
    <ul>
     <li>
      1. 开机，设置运营商信息，打开PDP场景。
     </li>
     <li>
      2. 设置MQTT可选参数。例如：客户端标识、接收模式、阿里云
      <strong>
       设备三元组
      </strong>
      。
     </li>
     <li>
      3. 打开客户端，连接客户端到阿里云MQTT服务器。
     </li>
     <li>
      4. 订阅/退订主题，接收/上发物模型数据报文。
     </li>
     <li>
      5. 断开客户端与MQTT服务器的连接，关机。
     </li>
    </ul>
    <p>
    </p>
    <h2>
     3. 关键AT命令格式
    </h2>
    <ul>
     <li>
      <h3>
       3.1 AT+QMTCFG 配置MQTT可选参数
      </h3>
     </li>
    </ul>
    <p style="text-indent:33px;">
     主要配置 客户端标识、接收模式、阿里云
     <strong>
      设备三元组
     </strong>
     。
    </p>
    <pre><code>（1）配置接收模式：AT+QMTCFG="recv/mode",0,0,1
（2）配置阿里云设备三元组:AT+QMTCFG="aliauth",&lt;client_idx&gt;,&lt;product_key&gt;,&lt;device_name&gt;,&lt;device_secret&gt;
例：
AT+QMTCFG="aliauth",0,"a1wFylTxYeD","co_0001","7ab0c4b3532b5783df5fdc58a2895d7a"</code></pre>
    <p style="text-indent:33px;">
     <strong>
      &lt;client_idx&gt;
     </strong>
     ：MQTT客户端标识符，范围0~5。（跟TCP使用的socket_id是差不多的意思）
    </p>
    <p style="text-indent:33px;">
     <strong>
      &lt;product_key&gt;
     </strong>
     ：阿里云设备三元组的 ProductKey。
    </p>
    <p style="text-indent:33px;">
     <strong>
      &lt;device_name&gt;
     </strong>
     ：阿里云设备三元组的 DeviceName。
    </p>
    <p style="text-indent:33px;">
     <strong>
      &lt;device_secret&gt;
     </strong>
     ：阿里云设备三元组的 DeviceSecret。
    </p>
    <p>
    </p>
    <ul>
     <li>
      <h3>
       3.2 AT+QMTOPEN 打开MQTT客户端网络
      </h3>
     </li>
    </ul>
    <pre><code>（1）查询已经打开的MQTT客户端：AT+QMTOPEN?

（2）设置并打开MQTT客户端：AT+QMTOPEN=&lt;client_idx&gt;,&lt;host_name&gt;,&lt;port&gt;
例：
AT+QMTOPEN=0,"iot-as-mqtt.cn-shanghai.aliyuncs.com",1883</code></pre>
    <p style="text-indent:33px;">
     <strong>
      &lt;client_idx&gt;
     </strong>
     ：MQTT客户端标识符，范围0~5。
    </p>
    <p style="text-indent:33px;">
     <strong>
      &lt;host_name&gt;
     </strong>
     ：MQTT服务器地址，可以是IP地址或者域名。最大长度100字节。
    </p>
    <p style="text-indent:33px;">
     <strong>
      &lt;port&gt;
     </strong>
     ：服务器端口。范围1~65535。MQTT的端口为 1883。
    </p>
    <p>
    </p>
    <ul>
     <li>
      <h3>
       3.3 AT+QMTCONN 连接客户端到MQTT服务器
      </h3>
     </li>
    </ul>
    <pre><code>（1）查询当前有哪些的连接：AT+QMTCONN?
（2）设置客户端连接：AT+QMTCONN=&lt;client_idx&gt;,&lt;clientid&gt;
例：
AT+QMTCONN=0,"clientExample_0"</code></pre>
    <p style="text-indent:33px;">
     <strong>
      &lt;client_idx&gt;
     </strong>
     ：MQTT客户端标识符，范围0~5。
    </p>
    <p style="text-indent:33px;">
     <strong>
      &lt;clientid&gt;
     </strong>
     ：客户端标识符。字符串类型。（完全自定义）
    </p>
    <p>
    </p>
    <ul>
     <li>
      <h3>
       3.4 AT+QMTSUB 订阅主题
      </h3>
     </li>
    </ul>
    <p style="text-indent:33px;">
     该命令可订阅一个或多个主题。
    </p>
    <pre><code>（1）订阅主题：AT+QMTSUB=&lt;client_idx&gt;,&lt;msgid&gt;,&lt;topic1&gt;,&lt;qos1&gt;[,&lt;topic2&gt;,&lt;qos2&gt;...]
例：
AT+QMTSUB=0,1,"/sys/a1wFylTxYeD/co_0001/thing/service/property/set",0
AT+QMTSUB=0,1,"/sys/a1wFylTxYeD/co_0001/thing/event/property/post",0</code></pre>
    <p style="text-indent:33px;">
     <strong>
      &lt;client_idx&gt;
     </strong>
     ：MQTT客户端标识符，范围0~5。
    </p>
    <p style="text-indent:33px;">
     <strong>
      &lt;msgid&gt;
     </strong>
     ：数据包标识符。范围1~65535。（完全自定义，可以与其他帧有重复，但相邻帧尽量不同，方便区分错误返回消息）
    </p>
    <p style="text-indent:33px;">
     <strong>
      &lt;topic&gt;
     </strong>
     ：订阅的主题。字符串类型。
    </p>
    <p style="text-indent:33px;">
     <strong>
      &lt;qos&gt;
     </strong>
     ：消息的QoS等级。默认0，各大厂的服务器一般也只支持0。
    </p>
    <p>
    </p>
    <p style="text-indent:33px;">
     阿里云下发开关状态、上报温湿度消息，使用的是物模型中自带的主题。可在 "
     <strong>
      产品
     </strong>
     " - "
     <strong>
      Topic类列表
     </strong>
     " 中查看。
    </p>
    <p style="text-indent:33px;">
     设备上报：/sys/a1wFylTxYeD/${deviceName}/thing/event/property/post
    </p>
    <p style="text-indent:33px;">
     阿里云下发：/sys/a1wFylTxYeD/${deviceName}/thing/service/property/set
    </p>
    <p>
     <img alt="" height="541" src="https://i-blog.csdnimg.cn/blog_migrate/05f2f52c9fca201ffcea46e3f7c66a3a.png" width="1020"/>
    </p>
    <p>
    </p>
    <ul>
     <li>
      <h3>
       3.5 AT+QMTUNS 退订主题
      </h3>
     </li>
    </ul>
    <p style="text-indent:33px;">
     该命令可退订一个或多个主题。
    </p>
    <pre><code>（1）退订一个或多个主题：AT+QMTUNS=&lt;client_idx&gt;,&lt;msgid&gt;,&lt;topic1&gt;[,&lt;topic2&gt;...]
例：
AT+QMTUNS=0,2,"/sys/a1wFylTxYeD/co_0001/thing/service/property/set"
AT+QMTUNS=0,2,"/sys/a1wFylTxYeD/co_0001/thing/event/property/post"</code></pre>
    <p style="text-indent:33px;">
     <strong>
      &lt;client_idx&gt;
     </strong>
     ：MQTT客户端标识符，范围0~5。
    </p>
    <p style="text-indent:33px;">
     <strong>
      &lt;msgid&gt;
     </strong>
     ：数据包标识符。范围1~65535。（完全自定义，可以与其他帧有重复，但相邻帧尽量不同，方便区分错误返回消息）
    </p>
    <p style="text-indent:33px;">
     <strong>
      &lt;topic&gt;
     </strong>
     ：退订的主题。字符串类型。
    </p>
    <p>
    </p>
    <ul>
     <li>
      <h3>
       3.6 AT+QMTPUBEX 发布消息
      </h3>
     </li>
    </ul>
    <p style="text-indent:33px;">
     设备通过该命令发布定长消息到服务器。
    </p>
    <pre><code>发布消息到服务器：AT+QMTPUBEX=&lt;client_idx&gt;,&lt;msgid&gt;,&lt;qos&gt;,&lt;retain&gt;,&lt;topic&gt;,&lt;length&gt;
例:
AT+QMTPUBEX=0,0,0,0,"/sys/a1wFylTxYeD/co_0001/thing/event/property/post",103
报文内容：
{"method":"thing.event.property.post","id":"1142523359","params":{"PowerSwitch_1":0},"version":"1.0.0"}</code></pre>
    <p style="text-indent:33px;">
     <strong>
      &lt;client_idx&gt;
     </strong>
     ：MQTT客户端标识符，范围0~5。
    </p>
    <p style="text-indent:33px;">
     <strong>
      &lt;msgid&gt;
     </strong>
     ：数据包标识符。范围1~65535。（完全自定义，可以与其他帧有重复，但相邻帧尽量不同，方便区分错误返回消息）
    </p>
    <p style="text-indent:33px;">
     <strong>
      &lt;qos&gt;
     </strong>
     ：消息的QoS等级。默认0，各大厂的服务器一般也只支持0。
    </p>
    <p style="text-indent:33px;">
     <strong>
      &lt;retain&gt;
     </strong>
     ：消息发送到当前订阅者后，服务器是否保持该消息。0-不保存；1-保存。默认值为0。
    </p>
    <p style="text-indent:33px;">
     <strong>
      &lt;topic&gt;
     </strong>
     ：待发布的主题。
    </p>
    <p style="text-indent:33px;">
     <strong>
      &lt;length&gt;
     </strong>
     ：待发布消息的数据长度。单位字节。
    </p>
    <p>
    </p>
    <p>
    </p>
    <h2>
     4. MQTT接入阿里云平台
    </h2>
    <p style="text-indent:33px;">
     阿里云设备管理账号：
     <a href="https://blog.csdn.net/Mark_md/article/details/108051182">
      阿里云创建产品、设备、获取三元组
     </a>
    </p>
    <p style="text-indent:33px;">
     上电后，短按POWKY，待串口接收到 RDY后，表示模块已经开机。
    </p>
    <ul>
     <li>
      <h3>
       4.1 PDP场景配置
      </h3>
     </li>
    </ul>
    <p style="text-indent:33px;">
     （设置运营商信息，与上两章TCP、HTTP连接的前半部分操作一样）
    </p>
    <pre><code>RDY
AT

OK
AT+CPIN?

+CPIN: READY

OK
AT+CREG?

+CREG: 0,1

OK
AT+CGREG?

+CGREG: 0,1

OK
AT+CEREG?

+CEREG: 0,1

OK
AT+QICSGP=1

+QICSGP: 1,"CMNET","","",1

OK
AT+QICSGP=1,1,"CMNET","","",1

OK
AT+QIACT=1

OK
AT+QIACT?

+QIACT: 1,1,1,"10.189.73.246"

OK</code></pre>
    <p>
    </p>
    <ul>
     <li>
      <h3>
       4.2 设置MQTT可选参数
      </h3>
     </li>
    </ul>
    <p style="text-indent:33px;">
     如：客户端标识、接收模式、阿里云 设备三元组。
    </p>
    <pre><code>AT+QMTCFG="recv/mode",0,0,1

OK
AT+QMTCFG="aliauth",0,"a1wFylTxYeD","co_0001","7ab0c4b3532b5783df5fdc58a2895d7a"

OK</code></pre>
    <p>
    </p>
    <ul>
     <li>
      <h3>
       4.3 打开客户端
      </h3>
     </li>
    </ul>
    <p style="text-indent:33px;">
     连接客户端到阿里云MQTT服务器。
    </p>
    <pre><code>AT+QMTOPEN=0,"iot-as-mqtt.cn-shanghai.aliyuncs.com",1883

OK

+QMTOPEN: 0,0
AT+QMTOPEN?

+QMTOPEN: 0,"iot-as-mqtt.cn-shanghai.aliyuncs.com",1883

OK
AT+QMTCONN=0,"clientExample_0"

OK

+QMTCONN: 0,0,0
AT+QMTCONN?

+QMTCONN: 0,3

OK</code></pre>
    <p style="text-indent:33px;">
     登陆阿里云，查看设备连接前后的在线状态，在线状态发送改变。
     <a href="https://iot.console.aliyun.com/product" rel="nofollow">
      阿里云设备管理平台
     </a>
    </p>
    <p>
     <img alt="" height="205" src="https://i-blog.csdnimg.cn/blog_migrate/f54443007b6db4ee70fc0ce314e62db3.png" width="696"/>
    </p>
    <p>
     <img alt="" height="204" src="https://i-blog.csdnimg.cn/blog_migrate/84e3ab638c8da1943ba0e7d07bc35076.png" width="698"/>
    </p>
    <p>
    </p>
    <p>
    </p>
    <ul>
     <li>
      <h3>
       4.4 订阅主题
      </h3>
     </li>
    </ul>
    <p style="text-indent:33px;">
     订阅两条主题。一个用于接收阿里云下发，一个用于上报。
    </p>
    <pre><code>AT+QMTSUB=0,1,"/sys/a1wFylTxYeD/co_0001/thing/service/property/set",0

OK

+QMTSUB: 0,1,0,1
AT+QMTSUB=0,1,"/sys/a1wFylTxYeD/co_0001/thing/event/property/post",0

OK

+QMTSUB: 0,1,0,1</code></pre>
    <p style="text-indent:33px;">
     登陆阿里云设备管理平台。查看到刚刚的两条主题已经存在于设备列表。
    </p>
    <p>
     <img alt="" height="443" src="https://i-blog.csdnimg.cn/blog_migrate/e4bcb71ec641b930d712c1f07b139545.png" width="787"/>
    </p>
    <p>
    </p>
    <ul>
     <li>
      <h3>
       4.5 退订主题。
      </h3>
     </li>
    </ul>
    <p style="text-indent:33px;">
     退订刚刚订阅的两个主题。
    </p>
    <pre><code>AT+QMTUNS=0,2,"/sys/a1wFylTxYeD/co_0001/thing/service/property/set"

OK

+QMTUNS: 0,2,0
AT+QMTUNS=0,2,"/sys/a1wFylTxYeD/co_0001/thing/event/property/post"

OK

+QMTUNS: 0,2,0</code></pre>
    <p style="text-indent:33px;">
     查看Topic列表，退订成功。
    </p>
    <p>
     <img alt="" height="481" src="https://i-blog.csdnimg.cn/blog_migrate/a907f1e9d9b3183e8dbf52acaa29704b.png" width="893"/>
    </p>
    <p style="text-indent:33px;">
     为了之后的测试能够正常进行，重新订阅这两个主题。
    </p>
    <p>
    </p>
    <ul>
     <li>
      <h3>
       4.6 接收阿里云下发的报文
      </h3>
     </li>
    </ul>
    <p style="text-indent:33px;">
     打开 "
     <strong>
      在线调试
     </strong>
     "，下发一次开关状态。
    </p>
    <p>
     <img alt="" height="567" src="https://i-blog.csdnimg.cn/blog_migrate/f44b7560107ca2c5bcb24eeddc22ab25.png" width="1200"/>
    </p>
    <p style="text-indent:33px;">
     几乎是与此同时，QCOM输出了阿里云下发的报文，JSON的格式。"PowerSwitch_1":1，一致。
    </p>
    <pre><code>+QMTRECV: 0,0,"/sys/a1wFylTxYeD/co_0001/thing/service/property/set",103,"{"method":"thing.service.property.set","id":"220958108","params":{"PowerSwitch_1":1},"version":"1.0.0"}"</code></pre>
    <p>
    </p>
    <ul>
     <li>
      <h3>
       4.7 上发报文到阿里云
      </h3>
     </li>
    </ul>
    <p style="text-indent:33px;">
     将刚刚下发的 JSON报文，进行一下修改。主题改为上发，变化下开关状态，上发给阿里云。
    </p>
    <pre><code>AT+QMTPUBEX=0,0,0,0,"/sys/a1wFylTxYeD/co_0001/thing/event/property/post",103

&gt; {"method":"thing.event.property.post","id":"1142523359","params":{"PowerSwitch_1":0},"version":"1.0.0"}
OK

+QMTPUBEX: 0,0,0</code></pre>
    <p>
    </p>
    <p style="text-indent:33px;">
     查看开关状态，从刚刚的1变为了0，上报成功。
    </p>
    <p>
     <img alt="" height="545" src="https://i-blog.csdnimg.cn/blog_migrate/6b6d3e8c6d3b6ff8622e6d973c6b470f.png" width="1054"/>
    </p>
    <p>
    </p>
    <p style="text-indent:33px;">
     再多发送几次，可以以列表的形式查看。
    </p>
    <p>
     <img alt="" height="374" src="https://i-blog.csdnimg.cn/blog_migrate/020051a48f30764993cafc96c363f5f9.png" width="798"/>
    </p>
    <p>
    </p>
    <ul>
     <li>
      <h3>
       4.8 测试时延
      </h3>
     </li>
    </ul>
    <p style="text-indent:33px;">
     时延测试，基本在100ms左右。算上从APP到云，再从云到设备，也不过几百ms，用户很难察觉，比HTTP方式动辄几s的延时好太多。
    </p>
    <p>
     <img alt="" height="529" src="https://i-blog.csdnimg.cn/blog_migrate/0385d1863d19cd774133e9217bd20339.png" width="921"/>
    </p>
    <p>
    </p>
    <h2>
     5. 总结
    </h2>
    <p style="text-indent:33px;">
     EC600S-CN 的MQTT指令支持阿里云、移动OneNET、华为IoT三种云平台，可实现快速接入，AT指令的操作步骤简单，有助于用户快速开发。
    </p>
    <p>
    </p>
   </div>
  </div>
 </article>
 <p alt="6874747073:3a2f2f626c6f672e6373646e2e6e65742f4d61726b5f6d642f:61727469636c652f64657461696c732f313133343239313339" class_="artid" style="display:none">
 </p>
</div>


