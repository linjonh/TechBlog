---
layout: post
title: "快速谱峭度算法解析"
date: 2025-03-10 16:24:06 +0800
description: "最近一直在研究振动信号的最优解调带宽寻找方法，而快速谱峭度算法是最常见的一种，因此本篇文章准备对该算法做个深入解析，也相当于自己的学习记录了。本篇文章对快速谱峭度算法做了一个较为详细的介绍，实际上就是通过多组滤波器将信号分解到不同的频段，再计算每个频段的峭度，从而找到值最大的频段，进一步地我们也可以选取其他指标作为频段的选择，以便更好地找到振动信号中的故障信息。"
keywords: "快速谱峭度算法解析"
categories: ['故障诊断', '信号与系统']
tags: ['信号处理', 'Python']
artid: "146050224"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146050224
    alt: "快速谱峭度算法解析"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146050224
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146050224
cover: https://bing.ee123.net/img/rand?artid=146050224
image: https://bing.ee123.net/img/rand?artid=146050224
img: https://bing.ee123.net/img/rand?artid=146050224
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     快速谱峭度算法解析
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h3>
     <a id="_0">
     </a>
     前言
    </h3>
    <p>
     最近一直在研究振动信号的最优解调带宽寻找方法，而快速谱峭度算法是最常见的一种，因此本篇文章准备对该算法做个深入解析，也相当于自己的学习记录了。
    </p>
    <h3>
     <a id="_2">
     </a>
     原理解析
    </h3>
    <p>
     谱峭度是一种信号处理中的时频分析工具，用于量化信号在不同频率成分上的非高斯性或冲击特性。它通过在频域中计算每个频率段上的峭度（统计学中衡量数据分布陡峭程度的指标，高峭度表示数据具有更尖锐的峰值和更重的尾部，如冲击信号），反映信号中瞬态成分或异常事件的分布情况。
     <br/>
     快速谱峭度算法则是Antoni提出的一种高效计算谱峭度的方法，核心思想是通过多分辨率滤波器组快速分解信号频带，并优化峭度值的计算流程，从而显著提升效率。
     <br/>
     1、信号分解
     <br/>
     通过多级滤波器组将原始信号分解为多个子频带，目前较为常用的是1/3-二叉树的结合。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/ea5cc94086404ab9a9cbcca133c70633.png#pic_center" width="400">
      <br/>
      2、频带峭度计算
      <br/>
      对每个子频带信号
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         x 
         
        
          i 
         
        
       
         ( 
        
       
         t 
        
       
         ) 
        
       
      
        x_i(t)
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 1em; vertical-align: -0.25em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            x
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3117em;">
               <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight">
                  i
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mopen">
           (
          </span>
          <span class="mord mathnormal">
           t
          </span>
          <span class="mclose">
           )
          </span>
         </span>
        </span>
       </span>
      </span>
      计算其经典峭度值
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         K 
         
        
          i 
         
        
       
      
        K_i
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.8333em; vertical-align: -0.15em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.0715em;">
            K
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3117em;">
               <span class="" style="top: -2.55em; margin-left: -0.0715em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight">
                  i
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      。
      <br/>
      <span class="katex--display">
       <span class="katex-display">
        <span class="katex">
         <span class="katex-mathml">
          K 
          
         
           i 
          
         
        
          = 
         
         
          
          
            m 
           
          
            e 
           
          
            a 
           
          
            n 
           
          
            ( 
           
          
            ∣ 
           
           
           
             x 
            
           
             i 
            
           
          
            ( 
           
          
            t 
           
          
            ) 
           
           
           
             ∣ 
            
           
             4 
            
           
          
            ) 
           
          
          
          
            m 
           
          
            e 
           
          
            a 
           
          
            n 
           
          
            ( 
           
          
            ∣ 
           
           
           
             x 
            
           
             i 
            
           
          
            ( 
           
          
            t 
           
          
            ) 
           
           
           
             ∣ 
            
           
             2 
            
           
           
           
             ) 
            
           
             2 
            
           
          
         
        
       
         K_i=\frac{mean(|x_i(t)|^4)}{mean(|x_i(t)|^2)^2}
         </span>
         <span class="katex-html">
          <span class="base">
           <span class="strut" style="height: 0.8333em; vertical-align: -0.15em;">
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.0715em;">
             K
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.3117em;">
                <span class="" style="top: -2.55em; margin-left: -0.0715em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mathnormal mtight">
                   i
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.15em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
           <span class="mrel">
            =
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 2.4271em; vertical-align: -0.936em;">
           </span>
           <span class="mord">
            <span class="mopen nulldelimiter">
            </span>
            <span class="mfrac">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 1.4911em;">
                <span class="" style="top: -2.314em;">
                 <span class="pstrut" style="height: 3em;">
                 </span>
                 <span class="mord">
                  <span class="mord mathnormal">
                   m
                  </span>
                  <span class="mord mathnormal">
                   e
                  </span>
                  <span class="mord mathnormal">
                   an
                  </span>
                  <span class="mopen">
                   (
                  </span>
                  <span class="mord">
                   ∣
                  </span>
                  <span class="mord">
                   <span class="mord mathnormal">
                    x
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t vlist-t2">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.3117em;">
                       <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mathnormal mtight">
                          i
                         </span>
                        </span>
                       </span>
                      </span>
                      <span class="vlist-s">
                       ​
                      </span>
                     </span>
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.15em;">
                       <span class="">
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                  <span class="mopen">
                   (
                  </span>
                  <span class="mord mathnormal">
                   t
                  </span>
                  <span class="mclose">
                   )
                  </span>
                  <span class="mord">
                   <span class="mord">
                    ∣
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.7401em;">
                       <span class="" style="top: -2.989em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mtight">
                          2
                         </span>
                        </span>
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                  <span class="mclose">
                   <span class="mclose">
                    )
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.7401em;">
                       <span class="" style="top: -2.989em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mtight">
                          2
                         </span>
                        </span>
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
                <span class="" style="top: -3.23em;">
                 <span class="pstrut" style="height: 3em;">
                 </span>
                 <span class="frac-line" style="border-bottom-width: 0.04em;">
                 </span>
                </span>
                <span class="" style="top: -3.677em;">
                 <span class="pstrut" style="height: 3em;">
                 </span>
                 <span class="mord">
                  <span class="mord mathnormal">
                   m
                  </span>
                  <span class="mord mathnormal">
                   e
                  </span>
                  <span class="mord mathnormal">
                   an
                  </span>
                  <span class="mopen">
                   (
                  </span>
                  <span class="mord">
                   ∣
                  </span>
                  <span class="mord">
                   <span class="mord mathnormal">
                    x
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t vlist-t2">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.3117em;">
                       <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mathnormal mtight">
                          i
                         </span>
                        </span>
                       </span>
                      </span>
                      <span class="vlist-s">
                       ​
                      </span>
                     </span>
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.15em;">
                       <span class="">
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                  <span class="mopen">
                   (
                  </span>
                  <span class="mord mathnormal">
                   t
                  </span>
                  <span class="mclose">
                   )
                  </span>
                  <span class="mord">
                   <span class="mord">
                    ∣
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.8141em;">
                       <span class="" style="top: -3.063em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mtight">
                          4
                         </span>
                        </span>
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                  <span class="mclose">
                   )
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.936em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
            <span class="mclose nulldelimiter">
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      <br/>
      快速谱峭度算法里还提供了一种基于2阶统计量的鲁棒峭度值。
      <br/>
      <span class="katex--display">
       <span class="katex-display">
        <span class="katex">
         <span class="katex-mathml">
          K 
          
         
           i 
          
         
        
          = 
         
         
          
          
            m 
           
          
            e 
           
          
            a 
           
          
            n 
           
          
            ( 
           
          
            ∣ 
           
           
           
             x 
            
           
             i 
            
           
          
            ( 
           
          
            t 
           
          
            ) 
           
           
           
             ∣ 
            
           
             2 
            
           
          
            ) 
           
          
          
          
            m 
           
          
            e 
           
          
            a 
           
          
            n 
           
          
            ( 
           
          
            ∣ 
           
           
           
             x 
            
           
             i 
            
           
          
            ( 
           
          
            t 
           
          
            ) 
           
          
            ∣ 
           
           
           
             ) 
            
           
             2 
            
           
          
         
        
       
         K_i=\frac{mean(|x_i(t)|^2)}{mean(|x_i(t)|)^2}
         </span>
         <span class="katex-html">
          <span class="base">
           <span class="strut" style="height: 0.8333em; vertical-align: -0.15em;">
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.0715em;">
             K
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.3117em;">
                <span class="" style="top: -2.55em; margin-left: -0.0715em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mathnormal mtight">
                   i
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.15em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
           <span class="mrel">
            =
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 2.4271em; vertical-align: -0.936em;">
           </span>
           <span class="mord">
            <span class="mopen nulldelimiter">
            </span>
            <span class="mfrac">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 1.4911em;">
                <span class="" style="top: -2.314em;">
                 <span class="pstrut" style="height: 3em;">
                 </span>
                 <span class="mord">
                  <span class="mord mathnormal">
                   m
                  </span>
                  <span class="mord mathnormal">
                   e
                  </span>
                  <span class="mord mathnormal">
                   an
                  </span>
                  <span class="mopen">
                   (
                  </span>
                  <span class="mord">
                   ∣
                  </span>
                  <span class="mord">
                   <span class="mord mathnormal">
                    x
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t vlist-t2">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.3117em;">
                       <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mathnormal mtight">
                          i
                         </span>
                        </span>
                       </span>
                      </span>
                      <span class="vlist-s">
                       ​
                      </span>
                     </span>
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.15em;">
                       <span class="">
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                  <span class="mopen">
                   (
                  </span>
                  <span class="mord mathnormal">
                   t
                  </span>
                  <span class="mclose">
                   )
                  </span>
                  <span class="mord">
                   ∣
                  </span>
                  <span class="mclose">
                   <span class="mclose">
                    )
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.7401em;">
                       <span class="" style="top: -2.989em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mtight">
                          2
                         </span>
                        </span>
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
                <span class="" style="top: -3.23em;">
                 <span class="pstrut" style="height: 3em;">
                 </span>
                 <span class="frac-line" style="border-bottom-width: 0.04em;">
                 </span>
                </span>
                <span class="" style="top: -3.677em;">
                 <span class="pstrut" style="height: 3em;">
                 </span>
                 <span class="mord">
                  <span class="mord mathnormal">
                   m
                  </span>
                  <span class="mord mathnormal">
                   e
                  </span>
                  <span class="mord mathnormal">
                   an
                  </span>
                  <span class="mopen">
                   (
                  </span>
                  <span class="mord">
                   ∣
                  </span>
                  <span class="mord">
                   <span class="mord mathnormal">
                    x
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t vlist-t2">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.3117em;">
                       <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mathnormal mtight">
                          i
                         </span>
                        </span>
                       </span>
                      </span>
                      <span class="vlist-s">
                       ​
                      </span>
                     </span>
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.15em;">
                       <span class="">
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                  <span class="mopen">
                   (
                  </span>
                  <span class="mord mathnormal">
                   t
                  </span>
                  <span class="mclose">
                   )
                  </span>
                  <span class="mord">
                   <span class="mord">
                    ∣
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.8141em;">
                       <span class="" style="top: -3.063em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mtight">
                          2
                         </span>
                        </span>
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                  <span class="mclose">
                   )
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.936em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
            <span class="mclose nulldelimiter">
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      <br/>
      3、生成峭度图
      <br/>
      将各频带的峭度值映射到二维平面（频率 vs. 分解层数），标记峭度最大值对应的最优频带。
      <br/>
      4、最优频带提取
      <br/>
      根据峭度图的指示，选择峭度最大的频带进行带通滤波，提取冲击成分。
     </img>
    </p>
    <h3>
     <a id="_21">
     </a>
     代码解析
    </h3>
    <p>
     快速谱峭度算法有一版Matlab程序，由Antoni老师编写的，而后笔者也找到一份Lecocq老师改写的Python版本，该代码同样通过树状滤波器来实现（也可以通过短时傅里叶变换、小波包分解等方式实现，核心就是将原信号分解到不同的频段，计算各频段的谱峭度指标，找到指标最大的频段）。
     <br/>
     为了避免影响分析，在原有的函数基础上保留了最核心的逻辑，最完整的代码会在文末给出。
    </p>
    <h4>
     <a id="Fast_Kurtogram_24">
     </a>
     Fast_Kurtogram入口函数
    </h4>
    <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">Fast_Kurtogram</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> nlevel<span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> Fs<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> NFIR<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span> fcut<span class="token operator">=</span><span class="token number">0.4</span><span class="token punctuation">,</span>
                   opt1<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> opt2<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    计算信号x分解到第nlevel层的快速谱峭度，最大的分解层数是log2(length(x))，但是推荐低于该最大层数的1/8倍，返回
    Also returns the vector of k-levels Level_w, the frequency vector
    freq_w, the complex envelope of the signal c and the extreme
    frequencies of the "best" bandpass f_lower and f_upper.
    :param x: 待分析的信号，numpy数组
    :param nlevel: 分解的层数，整数
    :param verbose: 是否输出调试信息
    :param Fs: 待分析信号的采样率
    :param NFIR: FIR滤波器的长度，整数
    :param fcut: 滤波器的截止频率，浮点数
    :param opt1: [1 | 2]:
        * opt1 = 1: 基于4阶统计量的经典峭度
        * opt1 = 2: 基于2阶统计量的鲁棒峭度（如果这两个峭度有差异，则是因为冲击噪声的存在）
    :param opt2: [1 | 2]:
        * opt2=1: 基于树状滤波器实现
        * opt2=2: 基于短时傅里叶算法实现，暂未实现（方法1更快，并且在滤波器的设计上更灵活：一个短的滤波器和方法2可以实现近乎一样的效果）
        
    :returns: Kwav, Level_w, freq_w, c, f_lower, f_upper
        * Kwav: kurtogram
        * Level_w: vector of levels
        * freq_w: frequency vector
        * c: complex envelope of the signal filtered in the frequency band that maximizes the kurtogram
        * f_lower: lower frequency of the band pass
        * f_upper: upper frequency of the band pass
    """</span>

    N <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    N2 <span class="token operator">=</span> np<span class="token punctuation">.</span>log2<span class="token punctuation">(</span>N<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">7</span>
    <span class="token keyword">if</span> nlevel <span class="token operator">&gt;</span> N2<span class="token punctuation">:</span>
        logging<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">'Please enter a smaller number of decomposition levels'</span><span class="token punctuation">)</span>

    <span class="token comment"># Fast computation of the kurtogram</span>
    <span class="token comment">####################################</span>

    <span class="token keyword">if</span> opt1 <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
        <span class="token comment"># 1) Filterbank-based kurtogram</span>
        <span class="token comment">############################</span>
        <span class="token comment"># Analytic generating filters</span>
		<span class="token comment"># h是二分段低通滤波器，g是二分段高通滤波器，h1是三分段第一段滤波器，h2是三分段第二段滤波器，h3是三分段第三段滤波器</span>
        h<span class="token punctuation">,</span> g<span class="token punctuation">,</span> h1<span class="token punctuation">,</span> h2<span class="token punctuation">,</span> h3 <span class="token operator">=</span> get_h_parameters<span class="token punctuation">(</span>NFIR<span class="token punctuation">,</span> fcut<span class="token punctuation">)</span>

		<span class="token comment"># 获取所有分解频段的谱峭度</span>
        <span class="token keyword">if</span> opt2 <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token comment"># kurtosis of the complex envelope</span>
            Kwav <span class="token operator">=</span> K_wpQ<span class="token punctuation">(</span>x<span class="token punctuation">,</span> h<span class="token punctuation">,</span> g<span class="token punctuation">,</span> h1<span class="token punctuation">,</span> h2<span class="token punctuation">,</span> h3<span class="token punctuation">,</span> nlevel<span class="token punctuation">,</span> verbose<span class="token punctuation">,</span> <span class="token string">'kurt2'</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token comment"># variance of the envelope magnitude</span>
            Kwav <span class="token operator">=</span> K_wpQ<span class="token punctuation">(</span>x<span class="token punctuation">,</span> h<span class="token punctuation">,</span> g<span class="token punctuation">,</span> h1<span class="token punctuation">,</span> h2<span class="token punctuation">,</span> h3<span class="token punctuation">,</span> nlevel<span class="token punctuation">,</span> verbose<span class="token punctuation">,</span> <span class="token string">'kurt1'</span><span class="token punctuation">)</span>

        <span class="token comment"># keep positive values only!</span>
        <span class="token comment"># 计算最后一层各频段的频率，最大频率是采样率的一半</span>
        Kwav<span class="token punctuation">[</span>Kwav <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>
        Level_w <span class="token operator">=</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> nlevel<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>
        Level_w <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span>Level_w<span class="token punctuation">,</span> Level_w <span class="token operator">+</span> np<span class="token punctuation">.</span>log2<span class="token punctuation">(</span><span class="token number">3.</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        Level_w <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>Level_w<span class="token punctuation">.</span>ravel<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        Level_w <span class="token operator">=</span> np<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> Level_w<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token operator">*</span>nlevel<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        freq_w <span class="token operator">=</span> Fs<span class="token operator">*</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token operator">*</span><span class="token number">2.0</span><span class="token operator">**</span>nlevel<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token operator">*</span><span class="token number">2</span><span class="token operator">**</span><span class="token punctuation">(</span>nlevel<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span>
                     <span class="token number">1.0</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token number">3.</span><span class="token operator">*</span><span class="token number">2.</span><span class="token operator">**</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">+</span>nlevel<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        M<span class="token punctuation">,</span> index <span class="token operator">=</span> get_GridMax<span class="token punctuation">(</span>Kwav<span class="token punctuation">)</span>
        level_index <span class="token operator">=</span> index<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        freq_index <span class="token operator">=</span> index<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
        bw<span class="token punctuation">,</span> fc<span class="token punctuation">,</span> fi<span class="token punctuation">,</span> l1 <span class="token operator">=</span> getBandwidthAndFrequency<span class="token punctuation">(</span>nlevel<span class="token punctuation">,</span> Fs<span class="token punctuation">,</span> Level_w<span class="token punctuation">,</span> freq_w<span class="token punctuation">,</span>
                                                  level_index<span class="token punctuation">,</span> freq_index<span class="token punctuation">)</span>
        <span class="token comment"># 是否绘制快速谱峭度图</span>
        <span class="token keyword">if</span> verbose<span class="token punctuation">:</span>
            logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"max kur:{}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>M<span class="token punctuation">)</span><span class="token punctuation">)</span>
            plotKurtogram<span class="token punctuation">(</span>Kwav<span class="token punctuation">,</span> freq_w<span class="token punctuation">,</span> nlevel<span class="token punctuation">,</span> Level_w<span class="token punctuation">,</span> Fs<span class="token punctuation">,</span> fi<span class="token punctuation">,</span> level_index<span class="token punctuation">)</span>

    <span class="token keyword">else</span><span class="token punctuation">:</span>
        logging<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">'stft-based is not implemented'</span><span class="token punctuation">)</span>

    <span class="token comment"># Signal filtering !</span>
    c <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    test <span class="token operator">=</span> <span class="token number">1</span>
    lev <span class="token operator">=</span> l1
    <span class="token keyword">while</span> test <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
        test <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token comment"># 找出峭度最大的频段</span>
        c<span class="token punctuation">,</span> s<span class="token punctuation">,</span> threshold<span class="token punctuation">,</span> Bw<span class="token punctuation">,</span> fc <span class="token operator">=</span> Find_wav_kurt<span class="token punctuation">(</span>x<span class="token punctuation">,</span> h<span class="token punctuation">,</span> g<span class="token punctuation">,</span> h1<span class="token punctuation">,</span> h2<span class="token punctuation">,</span> h3<span class="token punctuation">,</span>
                                                nlevel<span class="token punctuation">,</span> lev<span class="token punctuation">,</span> fi<span class="token punctuation">,</span> Fs<span class="token operator">=</span>Fs<span class="token punctuation">,</span>
                                                verbose<span class="token operator">=</span>verbose<span class="token punctuation">)</span>

    <span class="token comment"># Determine the lowest and the uppest frequencies of the bandpass</span>
    f_lower <span class="token operator">=</span> Fs<span class="token operator">*</span>np<span class="token punctuation">.</span><span class="token builtin">round</span><span class="token punctuation">(</span><span class="token punctuation">(</span>fc<span class="token operator">-</span>Bw<span class="token operator">/</span><span class="token number">2.</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">10</span><span class="token operator">**</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">10</span><span class="token operator">**</span><span class="token number">3</span>
    f_upper <span class="token operator">=</span> Fs<span class="token operator">*</span>np<span class="token punctuation">.</span><span class="token builtin">round</span><span class="token punctuation">(</span><span class="token punctuation">(</span>fc<span class="token operator">+</span>Bw<span class="token operator">/</span><span class="token number">2.</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">10</span><span class="token operator">**</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">10</span><span class="token operator">**</span><span class="token number">3</span>

    <span class="token keyword">return</span> Kwav<span class="token punctuation">,</span> Level_w<span class="token punctuation">,</span> freq_w<span class="token punctuation">,</span> c<span class="token punctuation">,</span> f_lower<span class="token punctuation">,</span> f_upper
</code></pre>
    <p>
     整个函数
    </p>
    <h4>
     <a id="get_h_parameters_119">
     </a>
     get_h_parameters构造滤波器
    </h4>
    <p>
     该函数的作用就是构造二分段滤波器和三分段滤波器。
    </p>
    <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">get_h_parameters</span><span class="token punctuation">(</span>NFIR<span class="token punctuation">,</span> fcut<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    构造FIR滤波器
    :param NFIR: FIR滤波器长度，整数
    :param fcut: 滤波器截止频率，浮点数
    
    :returns: h-parameters: h（二分段低通滤波器）, g（二分段高通滤波器）, h1（三分段第一段滤波器）, h2（三分段第二段滤波器）, h3（三分段第三段滤波器）

    """</span>
    h <span class="token operator">=</span> si<span class="token punctuation">.</span>firwin<span class="token punctuation">(</span>NFIR<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> fcut<span class="token punctuation">)</span> <span class="token operator">*</span> np<span class="token punctuation">.</span>exp<span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">*</span><span class="token number">1j</span><span class="token operator">*</span>np<span class="token punctuation">.</span>pi<span class="token operator">*</span>np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>NFIR<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.125</span><span class="token punctuation">)</span>
    n <span class="token operator">=</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> NFIR<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">)</span>
    g <span class="token operator">=</span> h<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span>n<span class="token punctuation">)</span> <span class="token operator">%</span> NFIR<span class="token punctuation">]</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1.</span><span class="token punctuation">)</span><span class="token operator">**</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span>n<span class="token punctuation">)</span>
    NFIR <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>fix<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">3.</span><span class="token operator">/</span><span class="token number">2.</span><span class="token operator">*</span>NFIR<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    h1 <span class="token operator">=</span> si<span class="token punctuation">.</span>firwin<span class="token punctuation">(</span>NFIR<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2.</span><span class="token operator">/</span><span class="token number">3</span><span class="token operator">*</span>fcut<span class="token punctuation">)</span><span class="token operator">*</span>np<span class="token punctuation">.</span>exp<span class="token punctuation">(</span><span class="token number">2j</span><span class="token operator">*</span>np<span class="token punctuation">.</span>pi<span class="token operator">*</span>np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>NFIR<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span>
                                             <span class="token number">0.25</span><span class="token operator">/</span><span class="token number">3.</span><span class="token punctuation">)</span>
    h2 <span class="token operator">=</span> h1<span class="token operator">*</span>np<span class="token punctuation">.</span>exp<span class="token punctuation">(</span><span class="token number">2j</span><span class="token operator">*</span>np<span class="token punctuation">.</span>pi<span class="token operator">*</span>np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>NFIR<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">6.</span><span class="token punctuation">)</span>
    h3 <span class="token operator">=</span> h1<span class="token operator">*</span>np<span class="token punctuation">.</span>exp<span class="token punctuation">(</span><span class="token number">2j</span><span class="token operator">*</span>np<span class="token punctuation">.</span>pi<span class="token operator">*</span>np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>NFIR<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">3.</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>h<span class="token punctuation">,</span> g<span class="token punctuation">,</span> h1<span class="token punctuation">,</span> h2<span class="token punctuation">,</span> h3<span class="token punctuation">)</span>
</code></pre>
    <p>
     由于笔者对FIR滤波器的设计并不熟悉，此处并未深入研究过其形式为何如此，感兴趣的朋友们可以自行搜索一下。
    </p>
    <h4>
     <a id="K_wpQ_143">
     </a>
     K_wpQ谱峭度计算函数
    </h4>
    <p>
     在获取到FIR滤波器参数后，下面就可以进行谱峭度的计算了，主要的函数就是K_wpQ。
    </p>
    <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">K_wpQ</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> h<span class="token punctuation">,</span> g<span class="token punctuation">,</span> h1<span class="token punctuation">,</span> h2<span class="token punctuation">,</span> h3<span class="token punctuation">,</span> nlevel<span class="token punctuation">,</span> verbose<span class="token punctuation">,</span> opt<span class="token punctuation">,</span> level<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    计算2维矩阵形式的谱峭度
    :param x: 待分析的信号
    :param h: 二分段低通滤波器
    :param g: 二分段高通滤波器
    :param h1: 三分段第一段滤波器
    :param h2: 三分段第二段滤波器
    :param h3: 三分段第三段滤波器
    :param nlevel: 分解层数
    :param verbose: 是否输出调试信息
    :param opt: ['kurt1' | 'kurt2']
        * 'kurt1' = 基于4阶统计量的经典峭度
        * 'kurt2' = 基于2阶统计量的鲁棒峭度
    :param level: 当前分解层数
    
    :returns: 二维矩阵的谱峭度
    
    """</span>

    L <span class="token operator">=</span> np<span class="token punctuation">.</span>floor<span class="token punctuation">(</span>np<span class="token punctuation">.</span>log2<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> level <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> nlevel <span class="token operator">&gt;=</span> L<span class="token punctuation">:</span>
            logging<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">'nlevel must be smaller'</span><span class="token punctuation">)</span>
        level <span class="token operator">=</span> nlevel
    x <span class="token operator">=</span> x<span class="token punctuation">.</span>ravel<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># 计算谱峭度</span>
    KD<span class="token punctuation">,</span> KQ <span class="token operator">=</span> K_wpQ_local<span class="token punctuation">(</span>x<span class="token punctuation">,</span> h<span class="token punctuation">,</span> g<span class="token punctuation">,</span> h1<span class="token punctuation">,</span> h2<span class="token punctuation">,</span> h3<span class="token punctuation">,</span> nlevel<span class="token punctuation">,</span> verbose<span class="token punctuation">,</span> opt<span class="token punctuation">,</span> level<span class="token punctuation">)</span>
    K <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">*</span>nlevel<span class="token punctuation">,</span> <span class="token number">3</span><span class="token operator">*</span><span class="token number">2</span><span class="token operator">**</span>nlevel<span class="token punctuation">)</span><span class="token punctuation">)</span>

	<span class="token comment"># KD是二分段的峭度值，KQ是三分段的峭度值，组合到一起，形成最终的K</span>
    K<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">=</span> KD<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> nlevel<span class="token punctuation">)</span><span class="token punctuation">:</span>
        K<span class="token punctuation">[</span><span class="token number">2</span><span class="token operator">*</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">=</span> KD<span class="token punctuation">[</span>i<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>
        K<span class="token punctuation">[</span><span class="token number">2</span><span class="token operator">*</span>i<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">=</span> KQ<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>

    K<span class="token punctuation">[</span><span class="token number">2</span><span class="token operator">*</span>nlevel<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">=</span> KD<span class="token punctuation">[</span>nlevel<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> K
</code></pre>
    <p>
     可以看到该函数的核心功能就是K_wpQ_local函数实现的。
    </p>
    <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">K_wpQ_local</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> h<span class="token punctuation">,</span> g<span class="token punctuation">,</span> h1<span class="token punctuation">,</span> h2<span class="token punctuation">,</span> h3<span class="token punctuation">,</span> nlevel<span class="token punctuation">,</span> verbose<span class="token punctuation">,</span> opt<span class="token punctuation">,</span> level<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    递归计算二维矩阵的谱峭度
    :param x: 待分析的信号
    :param h: 二分段低通滤波器
    :param g: 二分段高通滤波器
    :param h1: 三分段第一段滤波器
    :param h2: 三分段第二段滤波器
    :param h3: 三分段第三段滤波器
    :param nlevel: 分解层数
    :param verbose: 是否输出调试信息
    :param opt: ['kurt1' | 'kurt2']
        * 'kurt1' = 基于4阶统计量的经典峭度
        * 'kurt2' = 基于2阶统计量的鲁棒峭度
    :param level: 当前分解层数
    
    :returns: 
    	K: 二分段的谱峭度值
    	KQ: 三分段的谱峭度值

    """</span>
    <span class="token comment"># 计算低频系数a，以及高频系数d</span>
    a<span class="token punctuation">,</span> d <span class="token operator">=</span> DBFB<span class="token punctuation">(</span>x<span class="token punctuation">,</span> h<span class="token punctuation">,</span> g<span class="token punctuation">)</span>

    N <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
    <span class="token comment"># 保持频带的频率顺序，使高通序列转换为低通序列</span>
    d <span class="token operator">=</span> d<span class="token operator">*</span>np<span class="token punctuation">.</span>power<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1.</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> N<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># indices pairs multipliés par -1</span>
    <span class="token comment"># 计算低频部分峭度</span>
    K1 <span class="token operator">=</span> kurt<span class="token punctuation">(</span>a<span class="token punctuation">[</span><span class="token builtin">len</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> opt<span class="token punctuation">)</span>
    <span class="token comment"># 计算高频部分峭度</span>
    K2 <span class="token operator">=</span> kurt<span class="token punctuation">(</span>d<span class="token punctuation">[</span><span class="token builtin">len</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> opt<span class="token punctuation">)</span>

    <span class="token keyword">if</span> level <span class="token operator">&gt;</span> <span class="token number">2</span><span class="token punctuation">:</span>
    	<span class="token comment"># 计算低频段三分后的系数</span>
        a1<span class="token punctuation">,</span> a2<span class="token punctuation">,</span> a3 <span class="token operator">=</span> TBFB<span class="token punctuation">(</span>a<span class="token punctuation">,</span> h1<span class="token punctuation">,</span> h2<span class="token punctuation">,</span> h3<span class="token punctuation">)</span>
        <span class="token comment"># 计算高频段三分后的系数</span>
        d1<span class="token punctuation">,</span> d2<span class="token punctuation">,</span> d3 <span class="token operator">=</span> TBFB<span class="token punctuation">(</span>d<span class="token punctuation">,</span> h1<span class="token punctuation">,</span> h2<span class="token punctuation">,</span> h3<span class="token punctuation">)</span>
        <span class="token comment"># 计算各频段的峭度</span>
        Ka1 <span class="token operator">=</span> kurt<span class="token punctuation">(</span>a1<span class="token punctuation">[</span><span class="token builtin">len</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> opt<span class="token punctuation">)</span>
        Ka2 <span class="token operator">=</span> kurt<span class="token punctuation">(</span>a2<span class="token punctuation">[</span><span class="token builtin">len</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> opt<span class="token punctuation">)</span>
        Ka3 <span class="token operator">=</span> kurt<span class="token punctuation">(</span>a3<span class="token punctuation">[</span><span class="token builtin">len</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> opt<span class="token punctuation">)</span>
        Kd1 <span class="token operator">=</span> kurt<span class="token punctuation">(</span>d1<span class="token punctuation">[</span><span class="token builtin">len</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> opt<span class="token punctuation">)</span>
        Kd2 <span class="token operator">=</span> kurt<span class="token punctuation">(</span>d2<span class="token punctuation">[</span><span class="token builtin">len</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> opt<span class="token punctuation">)</span>
        Kd3 <span class="token operator">=</span> kurt<span class="token punctuation">(</span>d3<span class="token punctuation">[</span><span class="token builtin">len</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> opt<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        Ka1 <span class="token operator">=</span> <span class="token number">0</span>
        Ka2 <span class="token operator">=</span> <span class="token number">0</span>
        Ka3 <span class="token operator">=</span> <span class="token number">0</span>
        Kd1 <span class="token operator">=</span> <span class="token number">0</span>
        Kd2 <span class="token operator">=</span> <span class="token number">0</span>
        Kd3 <span class="token operator">=</span> <span class="token number">0</span>

    <span class="token keyword">if</span> level <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
    	<span class="token comment"># 分解到最小单元时，K保持和KQ一样的长度，直接返回这两个值</span>
    	<span class="token comment"># K = [K1, K1, K1, K2, K2, K2]</span>
        K <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span>K1<span class="token operator">*</span>np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> K2<span class="token operator">*</span>np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>flatten<span class="token punctuation">(</span><span class="token punctuation">)</span>
        KQ <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span>Ka1<span class="token punctuation">,</span> Ka2<span class="token punctuation">,</span> Ka3<span class="token punctuation">,</span> Kd1<span class="token punctuation">,</span> Kd2<span class="token punctuation">,</span> Kd3<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> level <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">:</span>
    	<span class="token comment"># 递归分解</span>
    	<span class="token comment"># level为2的时候，Ka和KaQ的长度均为6，Ka是两个频段的峭度，KaQ是将Ka的两个频段分解到六个频段(三分段滤波器)的峭度</span>
        Ka<span class="token punctuation">,</span> KaQ <span class="token operator">=</span> K_wpQ_local<span class="token punctuation">(</span>a<span class="token punctuation">,</span> h<span class="token punctuation">,</span> g<span class="token punctuation">,</span> h1<span class="token punctuation">,</span> h2<span class="token punctuation">,</span> h3<span class="token punctuation">,</span> nlevel<span class="token punctuation">,</span> verbose<span class="token punctuation">,</span> opt<span class="token punctuation">,</span>
                              level<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>

        Kd<span class="token punctuation">,</span> KdQ <span class="token operator">=</span> K_wpQ_local<span class="token punctuation">(</span>d<span class="token punctuation">,</span> h<span class="token punctuation">,</span> g<span class="token punctuation">,</span> h1<span class="token punctuation">,</span> h2<span class="token punctuation">,</span> h3<span class="token punctuation">,</span> nlevel<span class="token punctuation">,</span> verbose<span class="token punctuation">,</span> opt<span class="token punctuation">,</span>
                              level<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token comment"># K1表示Ka整个频带的峭度，K2表示Kd整个频带的峭度，每向上递归一层，K的长度乘2</span>
        K1 <span class="token operator">=</span> K1<span class="token operator">*</span>np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span>np<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>Ka<span class="token punctuation">.</span>shape<span class="token punctuation">)</span><span class="token punctuation">)</span>
        K2 <span class="token operator">=</span> K2<span class="token operator">*</span>np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span>np<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>Kd<span class="token punctuation">.</span>shape<span class="token punctuation">)</span><span class="token punctuation">)</span>
        K12 <span class="token operator">=</span> np<span class="token punctuation">.</span>append<span class="token punctuation">(</span>K1<span class="token punctuation">,</span> K2<span class="token punctuation">)</span>
        Kad <span class="token operator">=</span> np<span class="token punctuation">.</span>hstack<span class="token punctuation">(</span><span class="token punctuation">(</span>Ka<span class="token punctuation">,</span> Kd<span class="token punctuation">)</span><span class="token punctuation">)</span>
        K <span class="token operator">=</span> np<span class="token punctuation">.</span>vstack<span class="token punctuation">(</span><span class="token punctuation">(</span>K12<span class="token punctuation">,</span> Kad<span class="token punctuation">)</span><span class="token punctuation">)</span>
		
		<span class="token comment"># KQ的长度和K保持一致</span>
        Long <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token number">2.</span><span class="token operator">/</span><span class="token number">6</span><span class="token operator">*</span>np<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>KaQ<span class="token punctuation">.</span>shape<span class="token punctuation">)</span><span class="token punctuation">)</span>
        Ka1 <span class="token operator">=</span> Ka1<span class="token operator">*</span>np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span>Long<span class="token punctuation">)</span>
        Ka2 <span class="token operator">=</span> Ka2<span class="token operator">*</span>np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span>Long<span class="token punctuation">)</span>
        Ka3 <span class="token operator">=</span> Ka3<span class="token operator">*</span>np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span>Long<span class="token punctuation">)</span>
        Kd1 <span class="token operator">=</span> Kd1<span class="token operator">*</span>np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span>Long<span class="token punctuation">)</span>
        Kd2 <span class="token operator">=</span> Kd2<span class="token operator">*</span>np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span>Long<span class="token punctuation">)</span>
        Kd3 <span class="token operator">=</span> Kd3<span class="token operator">*</span>np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span>Long<span class="token punctuation">)</span>
        <span class="token comment"># tmp是将低频部分a通过二分段滤波器、三分段滤波器后的6个频段值与高频部分同样得到的6个频段峭度值组合到一起</span>
        tmp <span class="token operator">=</span> np<span class="token punctuation">.</span>hstack<span class="token punctuation">(</span><span class="token punctuation">(</span>KaQ<span class="token punctuation">,</span> KdQ<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token comment"># KQ是当前信号分解到低频部分a通过三分段滤波器后的3个频段峭度值和高频部分同样得到的3个频段峭度值组合到一起</span>
        KQ <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">(</span>Ka1<span class="token punctuation">,</span> Ka2<span class="token punctuation">,</span> Ka3<span class="token punctuation">,</span> Kd1<span class="token punctuation">,</span> Kd2<span class="token punctuation">,</span> Kd3<span class="token punctuation">)</span><span class="token punctuation">)</span>
        KQ <span class="token operator">=</span> np<span class="token punctuation">.</span>vstack<span class="token punctuation">(</span><span class="token punctuation">(</span>KQ<span class="token punctuation">,</span> tmp<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> level <span class="token operator">==</span> nlevel<span class="token punctuation">:</span>
        K1 <span class="token operator">=</span> kurt<span class="token punctuation">(</span>x<span class="token punctuation">,</span> opt<span class="token punctuation">)</span>
        K <span class="token operator">=</span> np<span class="token punctuation">.</span>vstack<span class="token punctuation">(</span><span class="token punctuation">(</span>K1<span class="token operator">*</span>np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span>np<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>K<span class="token punctuation">.</span>shape<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> K<span class="token punctuation">)</span><span class="token punctuation">)</span>
		
		<span class="token comment"># 只计算了低频部分的峭度</span>
        a1<span class="token punctuation">,</span> a2<span class="token punctuation">,</span> a3 <span class="token operator">=</span> TBFB<span class="token punctuation">(</span>x<span class="token punctuation">,</span> h1<span class="token punctuation">,</span> h2<span class="token punctuation">,</span> h3<span class="token punctuation">)</span>
        Ka1 <span class="token operator">=</span> kurt<span class="token punctuation">(</span>a1<span class="token punctuation">[</span><span class="token builtin">len</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> opt<span class="token punctuation">)</span>
        Ka2 <span class="token operator">=</span> kurt<span class="token punctuation">(</span>a2<span class="token punctuation">[</span><span class="token builtin">len</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> opt<span class="token punctuation">)</span>
        Ka3 <span class="token operator">=</span> kurt<span class="token punctuation">(</span>a3<span class="token punctuation">[</span><span class="token builtin">len</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> opt<span class="token punctuation">)</span>
        Long <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token number">1.</span><span class="token operator">/</span><span class="token number">3</span><span class="token operator">*</span>np<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>KQ<span class="token punctuation">.</span>shape<span class="token punctuation">)</span><span class="token punctuation">)</span>
        Ka1 <span class="token operator">=</span> Ka1<span class="token operator">*</span>np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span>Long<span class="token punctuation">)</span>
        Ka2 <span class="token operator">=</span> Ka2<span class="token operator">*</span>np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span>Long<span class="token punctuation">)</span>
        Ka3 <span class="token operator">=</span> Ka3<span class="token operator">*</span>np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span>Long<span class="token punctuation">)</span>
        tmp <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>KQ<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        KQ <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">(</span>Ka1<span class="token punctuation">,</span> Ka2<span class="token punctuation">,</span> Ka3<span class="token punctuation">)</span><span class="token punctuation">)</span>
        KQ <span class="token operator">=</span> np<span class="token punctuation">.</span>vstack<span class="token punctuation">(</span><span class="token punctuation">(</span>KQ<span class="token punctuation">,</span> tmp<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> K<span class="token punctuation">,</span> KQ
</code></pre>
    <p>
     DBFB函数实际上就是信号通过低通、高通滤波器后降采样，得到低频系数和高频系数。
    </p>
    <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">DBFB</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> h<span class="token punctuation">,</span> g<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    双频带滤波，计算低频近似系数a贺高频细节系数d
    :param x: 待分析的信号
    :param h: 二分段低通滤波器
    :param g: 二分段高通滤波器

    :returns: a, d

    """</span>

    <span class="token comment"># lowpass filter</span>
    a <span class="token operator">=</span> si<span class="token punctuation">.</span>lfilter<span class="token punctuation">(</span>h<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>
    a <span class="token operator">=</span> a<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>
    a <span class="token operator">=</span> a<span class="token punctuation">.</span>ravel<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># highpass filter</span>
    d <span class="token operator">=</span> si<span class="token punctuation">.</span>lfilter<span class="token punctuation">(</span>g<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>
    d <span class="token operator">=</span> d<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>
    d <span class="token operator">=</span> d<span class="token punctuation">.</span>ravel<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span> d<span class="token punctuation">)</span>
</code></pre>
    <p>
     TBFB函数实际上是计算三段频段的系数，同样是滤波后降采样，只不过这里是3倍降采样。
    </p>
    <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">TBFB</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> h1<span class="token punctuation">,</span> h2<span class="token punctuation">,</span> h3<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    三频带滤波器
    :param x: 待分析的信号
    :param h1: 三分段第一段滤波器
    :param h2: 三分段第二段滤波器
    :param h3: 三分段第三段滤波器

    :returns: a1, a2, a3

    """</span>

    <span class="token comment"># lowpass filter</span>
    a1 <span class="token operator">=</span> si<span class="token punctuation">.</span>lfilter<span class="token punctuation">(</span>h1<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>
    a1 <span class="token operator">=</span> a1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span>
    a1 <span class="token operator">=</span> a1<span class="token punctuation">.</span>ravel<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># passband filter</span>
    a2 <span class="token operator">=</span> si<span class="token punctuation">.</span>lfilter<span class="token punctuation">(</span>h2<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>
    a2 <span class="token operator">=</span> a2<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span>
    a2 <span class="token operator">=</span> a2<span class="token punctuation">.</span>ravel<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># highpass filter</span>
    a3 <span class="token operator">=</span> si<span class="token punctuation">.</span>lfilter<span class="token punctuation">(</span>h3<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>
    a3 <span class="token operator">=</span> a3<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span>
    a3 <span class="token operator">=</span> a3<span class="token punctuation">.</span>ravel<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span>a1<span class="token punctuation">,</span> a2<span class="token punctuation">,</span> a3<span class="token punctuation">)</span>
</code></pre>
    <p>
     下面我们再通过图示的方式，更为清晰地展示K_wpQ函数运算的逻辑。
     <br/>
     如果设定level为7，那么当递归到level为1的时候，我们可以得到如下图所示的K和KQ。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/128a14f52ba44793ad16ad423d98bd78.png">
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/c63ab2a4e95340c1ae0afd273e38b5f7.png"/>
     </img>
    </p>
    <p>
     当level为2的时候，可以看出K实际上就是本次待分解信号的低频峭度K1和高频峭度K2，在长度扩充后，再与低频部分a分解得到的Ka、高频部分d分解得到的Kd组合而得。此时level2层的K长度为12，即level1层K长度的一倍。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/aabe0d41d04b4ef58778ec9b58a2ee2b.png"/>
    </p>
    <p>
     而KQ则是本次待分解信号的Ka1、Ka2、Ka3、Kd1、Kd2、Kd3，在长度扩充后，再与低频部分a分解得到的KaQ、高频部分d分解得到的KdQ组合而得。此时level2层的KQ长度为12，与K一致。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/8ae579049705422ab30f15529d35b2d6.png"/>
    </p>
    <p>
     实际上后续的level都是按如此规律生成：K是本level层信号的K1、K2与level-1层的Ka、Kd组合而成，KQ是本level层信号的Ka1、Ka2、Ka3、Kd1、Kd2、Kd3、低频系数a在level-1层的KaQ、高频系数d在level-1层的KdQ组合而成。
     <br/>
     计算得到K和KQ后，我们就可以按照自上而下一层用K系数填充，一层用KQ系数填充的方式得到最终的快速谱峭度图：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/eb83e51d01134c8a9288091572e3000f.png">
      <br/>
      完整的代码可查看：https://download.csdn.net/download/qq1234534215/90471995
     </img>
    </p>
    <h3>
     <a id="_368">
     </a>
     总结
    </h3>
    <p>
     本篇文章对快速谱峭度算法做了一个较为详细的介绍，实际上就是通过多组滤波器将信号分解到不同的频段，再计算每个频段的峭度，从而找到值最大的频段，进一步地我们也可以选取其他指标作为频段的选择，以便更好地找到振动信号中的故障信息。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c:6f672e6373646e2e6e65742f7171313233343533343231352f:61727469636c652f64657461696c732f313436303530323234" class_="artid" style="display:none">
 </p>
</div>


