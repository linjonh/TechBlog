---
layout: post
title: "K210串口通信实测有用"
date: 2021-11-02 18:12:49 +0800
description: "前段时间我学习了如何使用K210训练模型做目标检测，单纯的学会训练模型并没有什么用处，要把K210应"
keywords: "k210串口通信"
categories: ['K']
tags: ['嵌入式硬件', '单片机']
artid: "121104436"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=121104436
    alt: "K210串口通信实测有用"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=121104436
featuredImagePreview: https://bing.ee123.net/img/rand?artid=121104436
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     K210+串口通信（实测有用）
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-tomorrow-night" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     前段时间我学习了如何使用K210训练模型做目标检测，单纯的学会训练模型并没有什么用处，要把K210应用到实际中去，也就是和单片机和各类模块结合使用，你必须会使用串口通信。这篇文章将教你如何使用K210进行串口通信。
    </p>
    <p>
    </p>
    <div class="toc">
     <h4>
      文章目录
     </h4>
     <ul>
      <li>
       <a href="#_8" rel="nofollow">
        前言
       </a>
      </li>
      <li>
       <a href="#_11" rel="nofollow">
        一、准备
       </a>
      </li>
      <li>
       <ul>
        <li>
         <a href="#1_13" rel="nofollow">
          1.硬件准备
         </a>
        </li>
        <li>
         <a href="#2_18" rel="nofollow">
          2.软件准备
         </a>
        </li>
       </ul>
      </li>
      <li>
       <a href="#_24" rel="nofollow">
        二、串口通信
       </a>
      </li>
      <li>
       <ul>
        <li>
         <a href="#1Maixpy_25" rel="nofollow">
          1.Maixpy
         </a>
        </li>
        <li>
         <a href="#2GPIO_28" rel="nofollow">
          2.GPIO简单介绍
         </a>
        </li>
        <li>
         <a href="#3_84" rel="nofollow">
          3.串口通信方法
         </a>
        </li>
        <li>
         <a href="#4_110" rel="nofollow">
          4.代码
         </a>
        </li>
       </ul>
      </li>
      <li>
       <a href="#_196" rel="nofollow">
        总结
       </a>
      </li>
     </ul>
    </div>
    <p>
    </p>
    <hr color="#000000" size='1"'/>
    <h2>
     <a id="_8">
     </a>
     前言
    </h2>
    <p>
     学会了训练模型，就要将它应用到实际中，这就需要我们结合51单片机、32单片机等待模块一起使用，最重要的一项便是串口通信。接下来我们进入正文
    </p>
    <h2>
     <a id="_11">
     </a>
     一、准备
    </h2>
    <h3>
     <a id="1_13">
     </a>
     1.硬件准备
    </h3>
    <p>
     1.K210开发板
     <br/>
     2.usb转ttl
    </p>
    <h3>
     <a id="2_18">
     </a>
     2.软件准备
    </h3>
    <p>
     Maixpy
     <br/>
     XCOM串口通信软件
    </p>
    <h2>
     <a id="_24">
     </a>
     二、串口通信
    </h2>
    <h3>
     <a id="1Maixpy_25">
     </a>
     1.Maixpy
    </h3>
    <p>
     看过上一篇博客后就可以直接进入正题了，打开Maixpy,接下来我们开始写串口通信部分，这里我先和电脑通信。
    </p>
    <h3>
     <a id="2GPIO_28">
     </a>
     2.GPIO简单介绍
    </h3>
    <p>
     先对K210的GPIO做个简单的介绍：
    </p>
    <p>
     K210 支持每个外设随意映射到任意引脚，K210上有高速 GPIO(GPIOHS) 和通用 GPIO
     <br/>
     在 K210 上， GPIO 有一下特征：
    </p>
    <p>
     高速 GPIO：
    </p>
    <p>
     高速 GPIO 为 GPIOHS，共 32 个。具有如下特点：
    </p>
    <p>
     可配置输入输出信号
     <br/>
     每个 IO 具有独立中断源
     <br/>
     中断支持边沿触发和电平触发
     <br/>
     每个 IO 可以分配到 FPIOA 上 48 个管脚之一
     <br/>
     可配置上下拉，或者高阻
    </p>
    <p>
     通用 GPIO：
    </p>
    <p>
     通用 GPIO 共 8 个，具有如下特点:
    </p>
    <p>
     8 个 IO 使用一个中断源
     <br/>
     可配置输入输出信号
     <br/>
     可配置触发 IO 总中断，边沿触发和电平触发
     <br/>
     每个 IO 可以分配到 FPIOA 上 48 个管脚之一
     <br/>
     下 GPIOHS 默认已经被使用， 程序中如非必要尽量不要使用：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/dfa891078fb3f301fc131bf238fbcdec.png"/>
    </p>
    <p>
     构造函数
    </p>
    <pre><code class="prism language-javascript"><span class="token keyword">class</span> <span class="token class-name">GPIO</span><span class="token punctuation">(</span><span class="token constant">ID</span><span class="token punctuation">,</span> <span class="token constant">MODE</span><span class="token punctuation">,</span> <span class="token constant">PULL</span><span class="token punctuation">,</span> <span class="token constant">VALUE</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     参数
     <br/>
     ID： 使用的 GPIO 引脚(一定要使用 GPIO 里带的常量来指定)
    </p>
    <p>
     MODE： GPIO模式
    </p>
    <p>
     • GPIO.IN就是输入模式
    </p>
    <p>
     • GPIO.OUT就是输出模式
    </p>
    <p>
     PULL： GPIO上下拉模式
    </p>
    <p>
     • GPIO.PULL_UP 上拉
    </p>
    <p>
     ​• GPIO.PULL_DOWN 下拉
    </p>
    <p>
     ​• GPIO.PULL_NONE 即不上拉也不下拉
     <br/>
     value
     <br/>
     修改/读取 GPIO 引脚状态
    </p>
    <pre><code class="prism language-c">GPIO<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">[</span>value<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     [value]： 可选参数，如果此参数不为空，则返回当前 GPIO 引脚状态
     <br/>
     如果 [value] 参数不为空，则返回当前 GPIO 引脚状态
     <br/>
     接下来直接讲串口通信.
    </p>
    <h3>
     <a id="3_84">
     </a>
     3.串口通信方法
    </h3>
    <p>
     头文件
    </p>
    <pre><code class="prism language-c">from machine import UART    #导入UART模块
</code></pre>
    <p>
     设置串口通信引脚(这里我设置10为TX,11为RX)
    </p>
    <pre><code class="prism language-c">fm<span class="token punctuation">.</span><span class="token keyword">register</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> fm<span class="token punctuation">.</span>fpioa<span class="token punctuation">.</span>UART1_TX<span class="token punctuation">,</span> force<span class="token operator">=</span>True<span class="token punctuation">)</span> #<span class="token number">10</span>为tx接rx
fm<span class="token punctuation">.</span><span class="token keyword">register</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">,</span> fm<span class="token punctuation">.</span>fpioa<span class="token punctuation">.</span>UART1_RX<span class="token punctuation">,</span> force<span class="token operator">=</span>True<span class="token punctuation">)</span> #<span class="token number">11</span>为rx接tx
</code></pre>
    <p>
     设置串口的波特率，数据位，停止位，奇偶校验位
    </p>
    <pre><code class="prism language-c">uart_A <span class="token operator">=</span> <span class="token function">UART</span><span class="token punctuation">(</span>UART<span class="token punctuation">.</span>UART1<span class="token punctuation">,</span> <span class="token number">115200</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">,</span> read_buf_len<span class="token operator">=</span><span class="token number">4096</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     串口发送数据（这里我发送的识别物体名称）
    </p>
    <pre><code class="prism language-c"> uart_A<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>classes<span class="token punctuation">[</span>i<span class="token punctuation">.</span><span class="token function">classid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token char">'\r\n'</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     将以上代码加入到你的代码里，就可以实现串口通信了
    </p>
    <h3>
     <a id="4_110">
     </a>
     4.代码
    </h3>
    <p>
     这里放入完整代码
    </p>
    <pre><code class="prism language-c">import sensor<span class="token punctuation">,</span>image<span class="token punctuation">,</span>lcd<span class="token punctuation">,</span>time  #导入sensor、image、lcd、time模块
import KPU as kpu
from machine import UART
from fpioa_manager import fm

lcd<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>freq<span class="token operator">=</span><span class="token number">15000000</span><span class="token punctuation">)</span> #初始化LCD

sensor<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   #初始化单目摄像头
sensor<span class="token punctuation">.</span><span class="token function">set_pixformat</span><span class="token punctuation">(</span>sensor<span class="token punctuation">.</span>RGB565<span class="token punctuation">)</span> #设置帧格式
sensor<span class="token punctuation">.</span><span class="token function">set_framesize</span><span class="token punctuation">(</span>sensor<span class="token punctuation">.</span>QVGA<span class="token punctuation">)</span>   #设置帧大小
sensor<span class="token punctuation">.</span><span class="token function">set_hmirror</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
sensor<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
task <span class="token operator">=</span> kpu<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token string">"/sd/yolov2.kmodel"</span><span class="token punctuation">)</span>
f<span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"anchors.txt"</span><span class="token punctuation">,</span><span class="token string">"r"</span><span class="token punctuation">)</span>
anchor_txt<span class="token operator">=</span>f<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
L<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> i in anchor_txt<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token operator">:</span>
    L<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
anchor<span class="token operator">=</span><span class="token function">tuple</span><span class="token punctuation">(</span>L<span class="token punctuation">)</span>
f<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
f<span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"classes.txt"</span><span class="token punctuation">,</span><span class="token string">"r"</span><span class="token punctuation">)</span>
lable_txt<span class="token operator">=</span>f<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
lable <span class="token operator">=</span> lable_txt<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span>
f<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
fm<span class="token punctuation">.</span><span class="token keyword">register</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> fm<span class="token punctuation">.</span>fpioa<span class="token punctuation">.</span>UART1_TX<span class="token punctuation">,</span> force<span class="token operator">=</span>True<span class="token punctuation">)</span>
fm<span class="token punctuation">.</span><span class="token keyword">register</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">,</span> fm<span class="token punctuation">.</span>fpioa<span class="token punctuation">.</span>UART1_RX<span class="token punctuation">,</span> force<span class="token operator">=</span>True<span class="token punctuation">)</span>

uart_A <span class="token operator">=</span> <span class="token function">UART</span><span class="token punctuation">(</span>UART<span class="token punctuation">.</span>UART1<span class="token punctuation">,</span> <span class="token number">115200</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">,</span> read_buf_len<span class="token operator">=</span><span class="token number">4096</span><span class="token punctuation">)</span>

anchor <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0.32</span><span class="token punctuation">,</span><span class="token number">0.68</span><span class="token punctuation">,</span><span class="token number">0.7</span><span class="token punctuation">,</span><span class="token number">0.73</span><span class="token punctuation">,</span><span class="token number">0.75</span><span class="token punctuation">,</span><span class="token number">0.75</span><span class="token punctuation">,</span><span class="token number">0.8</span><span class="token punctuation">,</span><span class="token number">0.96</span><span class="token punctuation">,</span><span class="token number">1.1</span><span class="token punctuation">,</span><span class="token number">1.63</span><span class="token punctuation">)</span>

sensor<span class="token punctuation">.</span><span class="token function">set_windowing</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
#初始化yolo2网络
a <span class="token operator">=</span> kpu<span class="token punctuation">.</span><span class="token function">init_yolo2</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> anchor<span class="token punctuation">)</span>
classes<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"apple"</span><span class="token punctuation">,</span><span class="token string">"banana"</span><span class="token punctuation">,</span><span class="token string">"oranges"</span> <span class="token punctuation">]</span> #标签名称要和你训练时的标签名称顺序相同

<span class="token keyword">while</span><span class="token punctuation">(</span>True<span class="token punctuation">)</span><span class="token operator">:</span>

     img <span class="token operator">=</span> sensor<span class="token punctuation">.</span><span class="token function">snapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    #使用摄像头拍摄一张照片
     <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">lcd</span><span class="token expression"><span class="token punctuation">.</span><span class="token function">display</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span> #在液晶屏上显示一张 image</span></span>

     code <span class="token operator">=</span> kpu<span class="token punctuation">.</span><span class="token function">run_yolo2</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> img<span class="token punctuation">)</span>  #task为 kpu_load 返回的 kpu_net 对象
                                      <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">img</span><span class="token expression">为从sensor 采集到的图像</span></span>
                                      <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">run</span><span class="token expression">_yolo2返回的值为kpu_yolo2_find 的列表</span></span>

     <span class="token keyword">if</span> code<span class="token operator">:</span>
         <span class="token keyword">for</span> i in code<span class="token operator">:</span>
             a<span class="token operator">=</span>img<span class="token punctuation">.</span><span class="token function">draw_rectangle</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span><span class="token function">rect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> #在图像上绘制一个矩形。此处为作为元组传递回坐标框出矩形
                                            #传回的是检测到的图像的四个坐标
             a <span class="token operator">=</span> lcd<span class="token punctuation">.</span><span class="token function">display</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span> #在液晶屏上显示被框框框起来的image

             <span class="token keyword">for</span> i in code<span class="token operator">:</span>
                 lcd<span class="token punctuation">.</span><span class="token function">draw_string</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> i<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> classes<span class="token punctuation">[</span>i<span class="token punctuation">.</span><span class="token function">classid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> lcd<span class="token punctuation">.</span>RED<span class="token punctuation">,</span> lcd<span class="token punctuation">.</span>WHITE<span class="token punctuation">)</span>

                 lcd<span class="token punctuation">.</span><span class="token function">draw_string</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> i<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token char">'%f'</span><span class="token operator">%</span>i<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lcd<span class="token punctuation">.</span>RED<span class="token punctuation">,</span> lcd<span class="token punctuation">.</span>WHITE<span class="token punctuation">)</span>

                 lcd<span class="token punctuation">.</span><span class="token function">draw_string</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span><span class="token function">str</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span> lcd<span class="token punctuation">.</span>RED<span class="token punctuation">,</span> lcd<span class="token punctuation">.</span>WHITE<span class="token punctuation">)</span>

                 lcd<span class="token punctuation">.</span><span class="token function">draw_string</span><span class="token punctuation">(</span><span class="token number">110</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span><span class="token function">str</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">,</span> lcd<span class="token punctuation">.</span>RED<span class="token punctuation">,</span> lcd<span class="token punctuation">.</span>WHITE<span class="token punctuation">)</span>

                 uart_A<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>classes<span class="token punctuation">[</span>i<span class="token punctuation">.</span><span class="token function">classid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token char">'\r\n'</span><span class="token punctuation">)</span>

     <span class="token keyword">else</span><span class="token operator">:</span>
         a <span class="token operator">=</span> lcd<span class="token punctuation">.</span><span class="token function">display</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span> #如果没有识别出物体，则继续呈现图像
uart_A<span class="token punctuation">.</span><span class="token function">deinit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
del uart_A
a <span class="token operator">=</span> kpu<span class="token punctuation">.</span><span class="token function">deinit</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span> #反初始化。kpu_load 返回 kpu_net 对象

</code></pre>
    <p>
     运行以上代码选择正确的com接口你会看到
     <br/>
     <img alt="请添加图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/e0ade5d7744c094eb1d62f4c965fbd7f.jpeg">
      <br/>
      当然这段代码你直接拿去可能不能用，因为SD卡里的文件名称，模型名称不一样，修改一下就可以使用，如果你需要坐标等等，直接做对应修改即可。
     </img>
    </p>
    <h2>
     <a id="_196">
     </a>
     总结
    </h2>
    <p>
     通过这篇文章相信大家已经掌握了K210的串口通信，然后你可以用K210去做一些小的项目，我用K210做了两个小项目，一个是基于K210的yolov2的口罩检测系统、一个是基于K210的垃圾分类，这两个小的项目我会在写一篇博客将他们分享出来。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/b5f8c0cbe3d81750e7717bc795123cd1.png"/>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f35313936333231362f:61727469636c652f64657461696c732f313231313034343336" class_="artid" style="display:none">
 </p>
</div>


