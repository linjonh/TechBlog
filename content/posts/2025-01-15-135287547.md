---
layout: post
title: "计算机网络DHCP动态主机配置协议"
date: 2025-01-15 17:00:09 +0800
description: "DHCP协议是从BOOTP协议发展而来。但 BOOTP 运行在相对静态的环境中，每台设备配置专门的 "
keywords: "dhcp状态机"
categories: ['计算机网络']
tags: ['计算机网络', '开发语言', 'Php']
artid: "135287547"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=135287547
    alt: "计算机网络DHCP动态主机配置协议"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=135287547
featuredImagePreview: https://bing.ee123.net/img/rand?artid=135287547
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     计算机网络【DHCP动态主机配置协议】
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     <img alt="图片" src="https://i-blog.csdnimg.cn/blog_migrate/cd4e3fb085ef89c94972de47fd090e87.png"/>
    </p>
    <h4>
     <a id="DHCP__2">
     </a>
     DHCP 出现
    </h4>
    <p>
     电脑或手机需要
     <strong>
      IP 地址
     </strong>
     才能上网。大刘有两台电脑和两台手机，小美有一台笔记本电脑、一台平板电脑和两台手机，老王、阿丽、敏敏也有几台终端设备。如果为每台设备
     <strong>
      手动配置
     </strong>
     IP 地址，那会非常繁琐，一点儿也不方便。特别是手机、笔记本电脑、平板电脑等设备，每移动到一个新的地方，接入不同的网络，都要重新设置 IP 地址，实在是
     <strong>
      太麻烦
     </strong>
     了。
    </p>
    <p>
     <img alt="图片" src="https://i-blog.csdnimg.cn/blog_migrate/9821c545329ea0e3b4da9a54a2fd43b5.png"/>
    </p>
    <p>
     于是就有了
     <strong>
      DHCP
     </strong>
     协议，会
     <strong>
      自动配置
     </strong>
     设备的网络参数，包括 IP 地址、子网掩码、网关地址、DNS 服务器等，替代手动配置。还能统一 IP 地址分配，方便网络管理。
    </p>
    <p>
     <img alt="图片" src="https://i-blog.csdnimg.cn/blog_migrate/645858b1ea9fecb8582d501c76135d8a.png"/>
    </p>
    <h4>
     <a id="DHCP__12">
     </a>
     DHCP 简介
    </h4>
    <p>
     <strong>
      DHCP
     </strong>
     协议是从
     <strong>
      BOOTP
     </strong>
     协议发展而来。但 BOOTP 运行在相对静态的环境中，每台设备配置专门的 BOOTP 参数文件，该文件会在相当长的时间内保持不变。DHCP 从以下两方面对 BOOTP 进行了扩展：
    </p>
    <ul>
     <li>
      DHCP 允许设备
      <strong>
       动态地获取
      </strong>
      IP 地址，而不是静态指定每台主机地址。
     </li>
     <li>
      DHCP 能够分配其它的配置参数，客户端仅用一个消息就获取它所需要的
      <strong>
       所有配置信息
      </strong>
      。
     </li>
    </ul>
    <p>
     <img alt="图片" src="https://i-blog.csdnimg.cn/blog_migrate/619f46e0c422f57297415126284df903.png"/>
    </p>
    <p>
     大刘他们的设备使用 DHCP 功能后，只要连接到网络，就可以进行 TCP/IP 通信。对于
     <strong>
      路由器
     </strong>
     和
     <strong>
      交换机
     </strong>
     ，通常是手动配置 IP 地址等参数。
    </p>
    <p>
     DHCP 是一种
     <strong>
      Client/Server 模式
     </strong>
     的网络协议，由 DHCP Client 向 DHCP Server 提出配置申请，DHCP Server 返回为 DHCP Client 分配的配置信息。这里的 Client 和 Server 是
     <strong>
      应用程序
     </strong>
     ，可以运行在电脑、服务器、路由器等设备上。
    </p>
    <p>
     <img alt="图片" src="https://i-blog.csdnimg.cn/blog_migrate/c0ee2f474264834943f888164ebb74e5.png"/>
    </p>
    <p>
     <strong>
      举个栗子
     </strong>
     ：
    </p>
    <p>
     大刘的电脑开机后，自动运行 DHCP Client ，DHCP Client 主动向其它设备上的 DHCP Server 提出请求，DHCP Server 根据预先配置的策略，返回相应 IP 配置信息，DHCP Client 使用获得的 IP 配置信息与其它设备进行通信。
    </p>
    <p>
     <img alt="图片" src="https://i-blog.csdnimg.cn/blog_migrate/e6071eca67820887e524056a489d1fe8.png"/>
    </p>
    <h4>
     <a id="DHCP__33">
     </a>
     DHCP 分配机制
    </h4>
    <p>
     DHCP 提供了两种地址分配机制，可以根据网络需求为不同的 Client 选择不同的分配策略。
    </p>
    <ul>
     <li>
      <strong>
       动态分配机制
      </strong>
      ：通过 DHCP 为 Client 分配一个有
      <strong>
       使用期限
      </strong>
      的 IP 地址。如果 Client 没有及时续约，到达使用期限后，这个地址可能会被其它 Client 使用。绝大多数 Client 使用的都是这种动态分配的地址。
     </li>
     <li>
      <strong>
       静态分配机制
      </strong>
      ：通过 DHCP 为特定的 Client 分配
      <strong>
       固定
      </strong>
      的 IP 地址。固定 IP 地址可以
      <strong>
       永久使用
      </strong>
      ， Client 通常是打印机、服务器等设备。
     </li>
    </ul>
    <p>
     <img alt="图片" src="https://i-blog.csdnimg.cn/blog_migrate/477d4f54ea0fee16e53637b8345f7d79.png"/>
    </p>
    <p>
     在实际情况中，我们发现 DHCP Client 重启后，也能获得相同的 IP 地址。DHCP Server 为 DHCP Client
     <strong>
      分配 IP 地址
     </strong>
     时，采用如下的
     <strong>
      顺序
     </strong>
     ：
    </p>
    <ol>
     <li>
      DHCP Server 中与 DHCP Client 的 MAC 地址
      <strong>
       静态绑定
      </strong>
      的 IP 地址；
     </li>
     <li>
      DHCP Client
      <strong>
       曾经使用过
      </strong>
      的 IP 地址；
     </li>
     <li>
      最先找到的可用 IP 地址。
     </li>
    </ol>
    <p>
     如果没找到可用的 IP 地址，就依次查询
     <strong>
      超过租期
     </strong>
     、
     <strong>
      发生冲突
     </strong>
     的 IP 地址，如果找到就进行分配，否则
     <strong>
      报错
     </strong>
     处理。
    </p>
    <p>
     <img alt="图片" src="https://i-blog.csdnimg.cn/blog_migrate/94503e7752044e2f18706fae12d29290.png"/>
    </p>
    <h4>
     <a id="DHCP__52">
     </a>
     DHCP 系统组成
    </h4>
    <p>
     DHCP 系统由
     <strong>
      DHCP Server
     </strong>
     （ DHCP 服务器）、
     <strong>
      DHCP Client
     </strong>
     （ DHCP 客户端）、
     <strong>
      DHCP Relay
     </strong>
     （ DHCP 中继）等组成。
    </p>
    <p>
     <img alt="图片" src="https://i-blog.csdnimg.cn/blog_migrate/b757763233ec56d8111cfaa5110f3054.png"/>
    </p>
    <ul>
     <li>
      <p>
       <strong>
        DHCP Server
       </strong>
      </p>
      <p>
       DHCP Server 提供
       <strong>
        网络参数
       </strong>
       给 DHCP Client ，通常是一台提供 DHCP 服务功能的服务器或网络设备（路由器或三层交换机）。比如：家里用的
       <strong>
        无线路由器
       </strong>
       。
      </p>
     </li>
    </ul>
    <p>
     <img alt="图片" src="https://i-blog.csdnimg.cn/blog_migrate/520272afcbd6eb6e92cd9691e46062f9.png"/>
    </p>
    <ul>
     <li>
      <p>
       <strong>
        DHCP Client
       </strong>
      </p>
      <p>
       DHCP Client 通过 DHCP Server
       <strong>
        获取网络参数
       </strong>
       ，通常是一台主机或网络设备。比如：大刘的
       <strong>
        电脑
       </strong>
       、小美的
       <strong>
        手机
       </strong>
       。
      </p>
     </li>
    </ul>
    <p>
     <img alt="图片" src="https://i-blog.csdnimg.cn/blog_migrate/6492a92937cef20e4772f8f5ef78d636.png"/>
    </p>
    <ul>
     <li>
      <p>
       <strong>
        DHCP Relay
       </strong>
      </p>
      <p>
       通常情况下，DHCP 采用广播方式实现报文交互，DHCP 服务仅限在本地网段使用。如果需要
       <strong>
        跨网段
       </strong>
       实现 DHCP ，那么使用
       <strong>
        DHCP Relay
       </strong>
       技术实现。
      </p>
      <p>
       在 DHCP Server 和 DHCP Client 之间转发跨网段 DHCP 报文的设备，通常是
       <strong>
        三层网络设备
       </strong>
       。
      </p>
     </li>
    </ul>
    <p>
     ![外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传](https://img-home.csdnimg.cn/images/20230724024159.png?origin_url=data%3Aimage%2Fsvg%2Bxml%2C%253C%253Fxml%20version%3D’1.0’%20encoding%3D’UTF-8’%253F%253E%253Csvg%20width%3D’1px’%20height%3D’1px’%20viewBox%3D’0%200%201%201’%20version%3D’1.1’%20xmlns%3D’http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg’%20xmlns%3Axlink%3D’http%3A%2F%2Fwww.w3.org%2F1999%2Fxlink’%253E%253Ctitle%253E%253C%2Ftitle%253E%253Cg%20stroke%3D’none’%20stroke-width%3D’1’%20fill%3D’none’%20fill-rule%3D’evenodd’%20fill-opacity%3D’0’%253E%253Cg%20transform%3D’translate(-249.000000%2C%20-126.000000&amp;pos_id=img-mDfCfCcB-1703821518097)’ fill=‘%23FFFFFF’%3E%3Crect x=‘249’ y=‘126’ width=‘1’ height=‘1’%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)
    </p>
    <h4>
     <a id="DHCP__78">
     </a>
     DHCP 基本流程
    </h4>
    <p>
     DHCP 协议报文采用
     <strong>
      UDP
     </strong>
     方式封装，DHCP Server 侦听的端口号是
     <strong>
      67
     </strong>
     ，DHCP Client 的端口号是
     <strong>
      68
     </strong>
     。DHCP 设备通过发送和接收 UDP 67 和 UDP 68 端口的报文进行协议交互。DHCP 的基本工作流程分为
     <strong>
      4
     </strong>
     个阶段，即
     <strong>
      发现阶段
     </strong>
     、
     <strong>
      提供阶段
     </strong>
     、
     <strong>
      请求阶段
     </strong>
     、
     <strong>
      确认阶段
     </strong>
     。我们假设大刘的 PC 是一台
     <strong>
      新电脑
     </strong>
     ，下面将描述 PC
     <strong>
      第一次
     </strong>
     是如何通过 DHCP 获取 IP 地址的。
    </p>
    <p>
     <img alt="图片" src="https://i-blog.csdnimg.cn/blog_migrate/ef411141762568008f1aabf7ed103a30.png"/>
    </p>
    <p>
     为方便描述，
     <strong>
      DHCP Server
     </strong>
     简称
     <strong>
      小 S
     </strong>
     ，
     <strong>
      DHCP Client
     </strong>
     简称
     <strong>
      小 C
     </strong>
     。
    </p>
    <h5>
     <a id="1_86">
     </a>
     1、发现阶段
    </h5>
    <p>
     <strong>
      小 C
     </strong>
     在本地网段中
     <strong>
      广播
     </strong>
     一个
     <strong>
      DHCP Discover
     </strong>
     报文，目的寻找能够分配 IP 地址的
     <strong>
      小 S
     </strong>
     。
    </p>
    <p>
     <img alt="图片" src="https://i-blog.csdnimg.cn/blog_migrate/36ba0baad0f391b2758c5efcb65be79c.png"/>
    </p>
    <h5>
     <a id="2_92">
     </a>
     2、提供阶段
    </h5>
    <p>
     本地网段的
     <strong>
      小 S
     </strong>
     收到 DHCP Discover 报文后，回应
     <strong>
      DHCP Offer
     </strong>
     报文。DHCP Offer 报文包含了可用
     <strong>
      IP 地址
     </strong>
     和其它
     <strong>
      网络参数
     </strong>
     。
    </p>
    <p>
     ![外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传](https://img-home.csdnimg.cn/images/20230724024159.png?origin_url=data%3Aimage%2Fsvg%2Bxml%2C%253C%253Fxml%20version%3D’1.0’%20encoding%3D’UTF-8’%253F%253E%253Csvg%20width%3D’1px’%20height%3D’1px’%20viewBox%3D’0%200%201%201’%20version%3D’1.1’%20xmlns%3D’http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg’%20xmlns%3Axlink%3D’http%3A%2F%2Fwww.w3.org%2F1999%2Fxlink’%253E%253Ctitle%253E%253C%2Ftitle%253E%253Cg%20stroke%3D’none’%20stroke-width%3D’1’%20fill%3D’none’%20fill-rule%3D’evenodd’%20fill-opacity%3D’0’%253E%253Cg%20transform%3D’translate(-249.000000%2C%20-126.000000&amp;pos_id=img-kxoAWIsP-1703821518099)’ fill=‘%23FFFFFF’%3E%3Crect x=‘249’ y=‘126’ width=‘1’ height=‘1’%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)
    </p>
    <p>
     小 C 通过
     <strong>
      对比
     </strong>
     Discover 报文和 Offer 报文中的
     <strong>
      xid 字段
     </strong>
     是否相同，来判断 Offer 报文是不是发给自己的。
    </p>
    <h5>
     <a id="3_100">
     </a>
     3、请求阶段
    </h5>
    <p>
     小 C 会收到 小 S 发送的 DHCP Offer 报文。如果有
     <strong>
      多个 小 S
     </strong>
     ，那么每个 小 S 都会回应 DHCP Offer 报文。通常 小 C 会选择
     <strong>
      最先收到
     </strong>
     的 Offer 报文，并广播
     <strong>
      DHCP Request
     </strong>
     报文来表明哪个 小 S 被选择，其余 小 S 就凉凉了。
    </p>
    <p>
     <img alt="图片" src="https://i-blog.csdnimg.cn/blog_migrate/2725651576b865ca5f16f70b7672de20.png"/>
    </p>
    <p>
     如果 小 C 在一定时间后
     <strong>
      一直没收到
     </strong>
     DHCP Offer 报文，那么它就会重新发送 DHCP Discover 报文。
    </p>
    <h5>
     <a id="4_108">
     </a>
     4、确认阶段
    </h5>
    <p>
     <strong>
      小 S
     </strong>
     收到 DHCP Request 广播报文后，发送
     <strong>
      DHCP Ack
     </strong>
     报文作为回应，其中包含 小 C 的网络参数。DHCP Ack 报文和之前 DHCP Offer 报文的
     <strong>
      参数
     </strong>
     不能有
     <strong>
      冲突
     </strong>
     ，否则 小 S 会回应一个
     <strong>
      DHCP Nak
     </strong>
     报文。
    </p>
    <p>
     <img alt="图片" src="https://i-blog.csdnimg.cn/blog_migrate/837689c35135ed989ea60dc2eacb4c7b.png"/>
    </p>
    <p>
     当 小 C 收到 DHCP Ack 报文后，会发送
     <strong>
      免费 ARP
     </strong>
     报文进行探测，目的地址为获得的 IP 地址，如果探测此地址没有被使用，那么 小 C 就会使用这个地址，并完成配置。
    </p>
    <h4>
     <a id="DHCP__116">
     </a>
     DHCP 租期
    </h4>
    <p>
     从 DHCP 协议上看，
     <strong>
      小 S
     </strong>
     才有 IP 地址的
     <strong>
      所有权
     </strong>
     ，而
     <strong>
      小 C
     </strong>
     只有 IP 地址的
     <strong>
      使用权
     </strong>
     。小 S 每次给 小 C 分配一个 IP 地址时，会约定一个 IP 地址的
     <strong>
      租期
     </strong>
     ，通常是 24 小时。在租期内，小 C 才能使用相应的 IP 地址。当租期
     <strong>
      到期后
     </strong>
     ，小 C 将
     <strong>
      不能继续使用
     </strong>
     这个 IP 地址。当然了，在租期还没到期的时候，小 C 是可以
     <strong>
      申请续租
     </strong>
     这个 IP 地址的。
    </p>
    <p>
     <strong>
      T1
     </strong>
     时刻是租期到
     <strong>
      一半
     </strong>
     的时候，
     <strong>
      T2
     </strong>
     时刻是租期到
     <strong>
      87.5%
     </strong>
     的时候。在 T1 时刻 小 C 会
     <strong>
      单播
     </strong>
     一个
     <strong>
      DHCP Request
     </strong>
     报文给 小 S ，
     <strong>
      请求续租
     </strong>
     IP 地址。如果 小 C 收到了
     <strong>
      DHCP Ack
     </strong>
     回应报文，则说明
     <strong>
      续租成功
     </strong>
     。
    </p>
    <p>
     如果直到
     <strong>
      T2
     </strong>
     时刻，小 C 都未收到 DHCP Ack 回应报文，那么会
     <strong>
      广播
     </strong>
     发送一个 DHCP Request 报文，继续请求续租 IP 地址。如果 小 C 收到了 DHCP Ack 回应报文，则说明续租成功。
    </p>
    <p>
     如果直到
     <strong>
      租期到期
     </strong>
     ， 小 C 都未收到 DHCP Ack 回应报文，那么必须
     <strong>
      停止使用
     </strong>
     原来的 IP 地址。 小 C 将从发现阶段开始，
     <strong>
      重新来申请
     </strong>
     一个 IP 地址。
    </p>
    <p>
     <img alt="图片" src="https://i-blog.csdnimg.cn/blog_migrate/f1cf466ca6166bcf9098faf07ba3d9b5.png"/>
    </p>
    <h4>
     <a id="DHCP_Relay_128">
     </a>
     DHCP Relay
    </h4>
    <p>
     动态获取 IP 地址的过程中，使用
     <strong>
      广播
     </strong>
     方式发生报文，因此 DHCP 只适用于 小 C 和 小 S 在
     <strong>
      同一个子网
     </strong>
     内的情况。如果为每个网段配置一个 小 S ，这显然太浪费了。
    </p>
    <p>
     实际上还有
     <strong>
      DHCP Relay
     </strong>
     这种角色。小 C 通过 DHCP Relay 实现
     <strong>
      跨网段
     </strong>
     与 小 S 通信，获取 IP 地址。这样，多个子网上的 小 C 可以使用同一个 小 S ，既节省成本，又方便集中管理。
    </p>
    <p>
     <img alt="图片" src="https://i-blog.csdnimg.cn/blog_migrate/02c46e83b73666f5508c36053891954c.png"/>
    </p>
    <p>
     DHCP Relay 的
     <strong>
      工作原理
     </strong>
     如下：
    </p>
    <ol>
     <li>
      小 C 发送 DHCP Discover 或 DHCP Request
      <strong>
       广播报文
      </strong>
      ，具有 DHCP Relay 功能的网络设备收到后，根据配置将报文
      <strong>
       单播
      </strong>
      给指定的 小 S ；
     </li>
     <li>
      小 S 进行 IP 地址的分配，
      <strong>
       单播
      </strong>
      发送给 DHCP Relay ，DHCP Relay 再将配置信息
      <strong>
       广播
      </strong>
      给 小 C ，完成对 小 C 的动态配置。
     </li>
    </ol>
    <p>
     ![外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传](https://img-home.csdnimg.cn/images/20230724024159.png?origin_url=data%3Aimage%2Fsvg%2Bxml%2C%253C%253Fxml%20version%3D’1.0’%20encoding%3D’UTF-8’%253F%253E%253Csvg%20width%3D’1px’%20height%3D’1px’%20viewBox%3D’0%200%201%201’%20version%3D’1.1’%20xmlns%3D’http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg’%20xmlns%3Axlink%3D’http%3A%2F%2Fwww.w3.org%2F1999%2Fxlink’%253E%253Ctitle%253E%253C%2Ftitle%253E%253Cg%20stroke%3D’none’%20stroke-width%3D’1’%20fill%3D’none’%20fill-rule%3D’evenodd’%20fill-opacity%3D’0’%253E%253Cg%20transform%3D’translate(-249.000000%2C%20-126.000000&amp;pos_id=img-FvkwImng-1703821518102)’ fill=‘%23FFFFFF’%3E%3Crect x=‘249’ y=‘126’ width=‘1’ height=‘1’%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)
    </p>
    <h4>
     <a id="DHCP__143">
     </a>
     DHCP 协议报文
    </h4>
    <p>
     前面的内容有提到 DHCP 的一些
     <strong>
      报文类型
     </strong>
     ，现在讲讲 DHCP 主要的
     <strong>
      8 种
     </strong>
     报文类型。常见的 5 种报文类型有：
     <strong>
      DHCP Discover
     </strong>
     、
     <strong>
      DHCP Offer
     </strong>
     、
     <strong>
      DHCP Request
     </strong>
     、
     <strong>
      DHCP Ack
     </strong>
     和
     <strong>
      DHCP Release
     </strong>
     ，用得少的 3 种报文类型有：
     <strong>
      DHCP Nak
     </strong>
     、
     <strong>
      DHCP Decline
     </strong>
     和
     <strong>
      DHCP Inform
     </strong>
     。
    </p>
    <ul>
     <li>
      <p>
       <strong>
        DHCP Discover 报文
       </strong>
      </p>
      <p>
       它是 DHCP Client 首次接入网络，DHCP 交互过程的
       <strong>
        第一个报文
       </strong>
       ，用来寻找 DHCP Server的请求报文。
      </p>
     </li>
     <li>
      <p>
       <strong>
        DHCP Offer 报文
       </strong>
      </p>
      <p>
       它是 DHCP Server 用来回应 DHCP Discover 报文的，并携带
       <strong>
        网络参数
       </strong>
       ，包括：IP 地址、子网掩码、默认网关、DNS 服务器等。
      </p>
     </li>
     <li>
      <p>
       <strong>
        DHCP Request 报文
       </strong>
      </p>
      <p>
       它是 DHCP Client 发送的报文，有三种使用场景：
      </p>
     </li>
     <li>
      <ul>
       <li>
        根据策略
        <strong>
         选择相应的 DHCP Server
        </strong>
        ，并回应 DHCP Offer 报文；
       </li>
       <li>
        DHCP Client 非首次接入网络，直接发送 DHCP Request 报文来
        <strong>
         申请之前使用过
        </strong>
        的 IP 地址等参数；
       </li>
       <li>
        当 IP 地址的租约到期后，发送 DHCP Request 进行
        <strong>
         租期更新
        </strong>
        。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        DHCP Ack 报文
       </strong>
      </p>
      <p>
       它是 DHCP Server 对 DHCP Request 报文的回应报文，进行
       <strong>
        最终确认
       </strong>
       。DHCP Client 收到这个报文后，才能获得 IP 地址和相应网络参数。
      </p>
     </li>
     <li>
      <p>
       <strong>
        DHCP Nak 报文
       </strong>
      </p>
      <p>
       它也是 DHCP Server 对 DHCP Request 报文的
       <strong>
        回应报文
       </strong>
       ，当 DHCP Request 报文中的各个参数都正确时，回应
       <strong>
        DHCP Ack 报文
       </strong>
       ，否则回应
       <strong>
        DHCP Nak 报文
       </strong>
       ，告诉 DHCP Client 禁止使用获得的 IP 地址。
      </p>
     </li>
     <li>
      <p>
       <strong>
        DHCP Decline 报文
       </strong>
      </p>
      <p>
       当 DHCP Client 收到 DHCP Ack 报文后，还会发送
       <strong>
        免费 ARP
       </strong>
       报文，确认申请的 IP 地址是否已经在网络上使用了。如果 IP 地址已经被其它 Client 使用，那么 DHCP Client 发送 DHCP Decline 报文，
       <strong>
        拒绝
       </strong>
       分配的 IP 地址，并重新向 DHCP Server 申请地址。
      </p>
     </li>
     <li>
      <p>
       <strong>
        DHCP Release 报文
       </strong>
      </p>
      <p>
       当 DHCP Client 想要
       <strong>
        释放获得的 IP 地址
       </strong>
       时，向 DHCP Server 发送 DHCP Release 报文，DHCP Server 收到报文后，可将这个 IP 地址分配给其它的 Client 。
      </p>
     </li>
     <li>
      <p>
       <strong>
        DHCP Inform 报文
       </strong>
      </p>
      <p>
       DHCP Client 通过手动方式获得 IP 地址后，还想向 DHCP Server
       <strong>
        获取更多网络参数
       </strong>
       时，比如：默认网关地址、DNS 服务器地址，DHCP Client 就向 DHCP Server 发送 DHCP Inform 报文进行申请。
      </p>
     </li>
    </ul>
    <h4>
     <a id="DHCP__183">
     </a>
     DHCP 状态机
    </h4>
    <p>
     如果把
     <strong>
      功能各异
     </strong>
     的 8 种报文串起来，就是整个 DHCP
     <strong>
      协议交互
     </strong>
     流程。前面讲的 4 种阶段（发现、提供、请求、确认）不能完全展现出来，这就需要使用 DHCP 协议的
     <strong>
      状态机
     </strong>
     。状态指出
     <strong>
      下一步
     </strong>
     使用的报文类型，
     <strong>
      状态转换
     </strong>
     是通过报文的接收、发送或超时。下面是 Client 的状态机。
    </p>
    <p>
     <img alt="图片" src="https://i-blog.csdnimg.cn/blog_migrate/c45c3881bbdf9689f3a65806e7b4bcfb.png"/>
    </p>
    <p>
     Client 从
     <strong>
      INIT
     </strong>
     状态开始，广播 DHCP Discover 报文。在
     <strong>
      选择
     </strong>
     状态时，它收到 DHCP Offer 报文，并决定使用哪个地址和 Server 。做出选择后，通过 DHCP Request 报文进入
     <strong>
      请求
     </strong>
     状态。如果分配的地址和曾使用过的地址不一致，那么回应 DHCP Nak 报文进行拒绝，并返回
     <strong>
      INIT
     </strong>
     状态；如果分配的地址已经被占用，那么回应 DHCP Decline 报文进行拒绝，也返回到
     <strong>
      INIT
     </strong>
     状态。通常是收到一个需要的地址，回应 DHCP Ack 报文，获得租期超时值 T1 和 T2 ，并进入
     <strong>
      绑定
     </strong>
     状态，这个时候就可以使用这个地址直到租期到期。当 T1 到期时，进入
     <strong>
      更新
     </strong>
     状态并进行续租申请。如果续租成功，那么可以收到 DHCP Ack 报文，并返回到
     <strong>
      绑定
     </strong>
     状态；如果续租不成功，那么在 T2 到期时，再次进行续租申请。如果租期最终到期，那么 Client 将禁止使用所租用的地址，并返回到
     <strong>
      INIT
     </strong>
     状态。
    </p>
    <h4>
     <a id="DHCP__191">
     </a>
     DHCP 网络实战
    </h4>
    <p>
     DHCP 协议是为解决网络问题而生，现在我们就来模拟实际环境，
     <strong>
      动手操作
     </strong>
     ，验证下 DHCP 的功能。
    </p>
    <h5>
     <a id="DHCP_Server__195">
     </a>
     DHCP Server 示例
    </h5>
    <h6>
     <a id="_197">
     </a>
     网络拓扑
    </h6>
    <p>
     <img alt="图片" src="https://i-blog.csdnimg.cn/blog_migrate/9a80f260f06dc601ac0f73d53474c088.png"/>
    </p>
    <h6>
     <a id="_201">
     </a>
     实验要求
    </h6>
    <ul>
     <li>
      RT（路由器）配置
      <strong>
       DHCP Server
      </strong>
      ，PC
      <strong>
       动态获取
      </strong>
      IP 地址等网络参数
     </li>
    </ul>
    <h6>
     <a id="_205">
     </a>
     操作步骤
    </h6>
    <p>
     配置思路：
    </p>
    <ol>
     <li>
      在 RT 上开启 DHCP 功能，
     </li>
     <li>
      创建一个地址池，
     </li>
     <li>
      配置地址池的相关参数，
     </li>
     <li>
      在 RT 的接口下引用地址池，实现 DHCP Server 功能。
     </li>
    </ol>
    <p>
     配置命令：
    </p>
    <p>
     使用 DHCP 功能之前，先要开启 DHCP 功能。系统视图下，使用命令
     <strong>
      dhcp enable
     </strong>
     启动 DHCP 功能。
    </p>
    <p>
     动态分配 IP 地址，就需要有多个可分配的 IP 地址，使用
     <strong>
      ip pool
     </strong>
     <em>
      ip-pool-name
     </em>
     命令来创建全局地址池，
     <em>
      ip-pool-name
     </em>
     表示地址池的名称。
    </p>
    <p>
     在全局地址池视图下，通过命令
     <strong>
      network
     </strong>
     <em>
      ip-address
     </em>
     [
     <strong>
      mask
     </strong>
     {
     <em>
      mask
     </em>
     |
     <em>
      mask-length
     </em>
     } ] 配置可分配的 IP 地址段。
     <strong>
      mask
     </strong>
     {
     <em>
      mask
     </em>
     |
     <em>
      mask-length
     </em>
     } 表示子网掩码，通常根据设备数量来确定掩码长度。
    </p>
    <p>
     有了 IP 地址和子网掩码，再加上默认网关，终端设备就能网络互通了。在全局地址池视图下，使用命令
     <strong>
      gateway-list
     </strong>
     <em>
      ip-address
     </em>
     配置网关 IP 地址。
    </p>
    <p>
     网络互通，还不能正常访问网站，需要配置 DNS 服务器，用于域名解析。在全局地址池视图下，使用
     <strong>
      dns-list
     </strong>
     <em>
      ip-address
     </em>
     配置 DNS 服务器的 IP 地址。
    </p>
    <p>
     地址池配置中，常用的可选命令如下，可根据需求进行选择性设置。
    </p>
    <p>
     <strong>
      lease
     </strong>
     {
     <strong>
      day
     </strong>
     <em>
      day
     </em>
     [
     <strong>
      hour
     </strong>
     <em>
      hour
     </em>
     [
     <strong>
      minute
     </strong>
     <em>
      minute
     </em>
     ] ] |
     <strong>
      unlimited
     </strong>
     } ：配置 IP 地址的租期，默认租期是 1 天。
    </p>
    <p>
     <strong>
      excluded-ip-address
     </strong>
     <em>
      start-ip-address
     </em>
     [
     <em>
      end-ip-address
     </em>
     ] ：在可分配的地址池中，设置不分配的 IP 地址。比如：地址池是 192.168.100.0/24 ，可设置 192.168.100.1 - 192.168.100.10 不参与地址分配。
    </p>
    <p>
     <strong>
      static-bind
     </strong>
     <strong>
      ip-address
     </strong>
     <em>
      ip-address
     </em>
     <strong>
      mac-address
     </strong>
     <em>
      mac-address
     </em>
     ：为 Client 固定分配一个 IP 地址。
    </p>
    <p>
     配置完地址池，还需要进行引用，DHCP Server 功能就能正常使用了。在 RT 的接口下配置引用，命令为
     <strong>
      dhcp select global
     </strong>
     。
    </p>
    <p>
     <img alt="图片" src="https://i-blog.csdnimg.cn/blog_migrate/c22e264c6f48dfd8dc923c72867425a6.png"/>
    </p>
    <h6>
     <a id="_238">
     </a>
     功能验证
    </h6>
    <p>
     配置完成后，理论上是 DHCP 功能正常工作了，实际情况的话，可通过命令
     <strong>
      display ip pool name
     </strong>
     <em>
      pool-name
     </em>
     <strong>
      used
     </strong>
     ，查看地址池的配置情况，和地址分配情况。
    </p>
    <p>
     在
     <strong>
      RT
     </strong>
     上查看 DHCP Server 地址分配状态。
    </p>
    <p>
     ![外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传](https://img-home.csdnimg.cn/images/20230724024159.png?origin_url=data%3Aimage%2Fsvg%2Bxml%2C%253C%253Fxml%20version%3D’1.0’%20encoding%3D’UTF-8’%253F%253E%253Csvg%20width%3D’1px’%20height%3D’1px’%20viewBox%3D’0%200%201%201’%20version%3D’1.1’%20xmlns%3D’http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg’%20xmlns%3Axlink%3D’http%3A%2F%2Fwww.w3.org%2F1999%2Fxlink’%253E%253Ctitle%253E%253C%2Ftitle%253E%253Cg%20stroke%3D’none’%20stroke-width%3D’1’%20fill%3D’none’%20fill-rule%3D’evenodd’%20fill-opacity%3D’0’%253E%253Cg%20transform%3D’translate(-249.000000%2C%20-126.000000&amp;pos_id=img-KRlYf7tn-1703821518105)’ fill=‘%23FFFFFF’%3E%3Crect x=‘249’ y=‘126’ width=‘1’ height=‘1’%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)
    </p>
    <p>
     同时也在
     <strong>
      PC
     </strong>
     上查看动态获取地址情况，进行双向验证。
    </p>
    <p>
     <img alt="图片" src="https://i-blog.csdnimg.cn/blog_migrate/d2527925f03fdea4caa828a2a21d401a.png"/>
    </p>
    <p>
     抓包还可以看到 DHCP
     <strong>
      报文交互
     </strong>
     的详细过程，同时也是
     <strong>
      检验理论知识
     </strong>
     是否正确。
    </p>
    <p>
     <img alt="图片" src="https://i-blog.csdnimg.cn/blog_migrate/2a5557c57ba2dff510a6be4f07610155.png"/>
    </p>
    <p>
     这里我们发现抓包看到的是 DHCP Offer
     <strong>
      单播
     </strong>
     报文，而前面介绍的时候，DHCP Offer 是
     <strong>
      广播
     </strong>
     报文。其实 DHCP Offer 报文有可能是单播，也有可能是广播。DHCP 在报文的标志字段有一个
     <strong>
      广播位
     </strong>
     ，如果 Client 支持接收 Offer 单播报文，那么 Client 就会将发送报文中的广播位设为 0 ，否则为 1 。
    </p>
    <h5>
     <a id="DHCP_Relay__256">
     </a>
     DHCP Relay 示例
    </h5>
    <h6>
     <a id="_258">
     </a>
     网络拓扑
    </h6>
    <p>
     <img alt="图片" src="https://i-blog.csdnimg.cn/blog_migrate/95ed92d720fb7eb6a2984cc287440369.png"/>
    </p>
    <h6>
     <a id="_262">
     </a>
     实验要求
    </h6>
    <ul>
     <li>
      DHCP Client 和 DHCP Server 在
      <strong>
       不同网段
      </strong>
      ，DHCP Client 通过
      <strong>
       DHCP Relay
      </strong>
      获取到 IP 地址等网络参数。
     </li>
    </ul>
    <h6>
     <a id="_266">
     </a>
     操作步骤
    </h6>
    <ol>
     <li>
      <strong>
       PC
      </strong>
      （ DHCP Client ）开启 DHCP 功能；
     </li>
    </ol>
    <p>
     ![外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传](https://img-home.csdnimg.cn/images/20230724024159.png?origin_url=data%3Aimage%2Fsvg%2Bxml%2C%253C%253Fxml%20version%3D’1.0’%20encoding%3D’UTF-8’%253F%253E%253Csvg%20width%3D’1px’%20height%3D’1px’%20viewBox%3D’0%200%201%201’%20version%3D’1.1’%20xmlns%3D’http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg’%20xmlns%3Axlink%3D’http%3A%2F%2Fwww.w3.org%2F1999%2Fxlink’%253E%253Ctitle%253E%253C%2Ftitle%253E%253Cg%20stroke%3D’none’%20stroke-width%3D’1’%20fill%3D’none’%20fill-rule%3D’evenodd’%20fill-opacity%3D’0’%253E%253Cg%20transform%3D’translate(-249.000000%2C%20-126.000000&amp;pos_id=img-wX2AcANa-1703821518108)’ fill=‘%23FFFFFF’%3E%3Crect x=‘249’ y=‘126’ width=‘1’ height=‘1’%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)
    </p>
    <ol>
     <li>
      <strong>
       RT1
      </strong>
      （ DHCP Relay ）使用
      <strong>
       dhcp select relay
      </strong>
      命令开启 DHCP Relay 功能，在 G0/0/1 口下使用
      <strong>
       dhcp relay server-ip
      </strong>
      <em>
       ip-address
      </em>
      命令，配置 DHCP Server 的 IP 地址；
     </li>
    </ol>
    <p>
     <img alt="图片" src="https://i-blog.csdnimg.cn/blog_migrate/63ea13c0926f5b50cea84267fdb80911.png"/>
    </p>
    <ol>
     <li>
      <strong>
       RT2
      </strong>
      （DHCP Server）开启 DHCP 功能，创建地址池并配置相关参数，在接口下引用地址池，实现 DHCP Server 功能。
     </li>
    </ol>
    <p>
     <img alt="图片" src="https://i-blog.csdnimg.cn/blog_migrate/492544e45eb0f420e41b11e96c3f13db.png"/>
    </p>
    <h6>
     <a id="_280">
     </a>
     功能验证
    </h6>
    <p>
     PC 端能获取到 IP 配置，并且获取的配置正确。
    </p>
    <p>
     ![外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传](https://img-home.csdnimg.cn/images/20230724024159.png?origin_url=data%3Aimage%2Fsvg%2Bxml%2C%253C%253Fxml%20version%3D’1.0’%20encoding%3D’UTF-8’%253F%253E%253Csvg%20width%3D’1px’%20height%3D’1px’%20viewBox%3D’0%200%201%201’%20version%3D’1.1’%20xmlns%3D’http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg’%20xmlns%3Axlink%3D’http%3A%2F%2Fwww.w3.org%2F1999%2Fxlink’%253E%253Ctitle%253E%253C%2Ftitle%253E%253Cg%20stroke%3D’none’%20stroke-width%3D’1’%20fill%3D’none’%20fill-rule%3D’evenodd’%20fill-opacity%3D’0’%253E%253Cg%20transform%3D’translate(-249.000000%2C%20-126.000000&amp;pos_id=img-Zuz7xT9S-1703821518110)’ fill=‘%23FFFFFF’%3E%3Crect x=‘249’ y=‘126’ width=‘1’ height=‘1’%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)
    </p>
    <p>
     在 RT1 的 G0/0/1 抓包，查看
     <strong>
      DHCP Client
     </strong>
     和 DHCP Relay 的报文交互过程。
    </p>
    <p>
     <img alt="图片" src="https://i-blog.csdnimg.cn/blog_migrate/eaaa1e7a8d02cd18d6df22f199354f87.png"/>
    </p>
    <p>
     在 RT1 的 G0/0/0 抓包，查看
     <strong>
      DHCP Server
     </strong>
     和 DHCP Relay 的报文交互过程。
    </p>
    <p>
     <img alt="图片" src="https://i-blog.csdnimg.cn/blog_migrate/2f6fe0c340c26059f2c5c07d2fc7a7a0.png"/>
    </p>
    <h4>
     <a id="DHCP__294">
     </a>
     DHCP 报文格式
    </h4>
    <p>
     如果想要更深入的了解 DHCP 协议，那就要看它的报文格式。DHCP 设备通过识别报文内容，实现协议功能。
    </p>
    <p>
     <img alt="图片" src="https://i-blog.csdnimg.cn/blog_migrate/06ea404b7b12c562ed00cf2eb0390073.png"/>
    </p>
    <ul>
     <li>
      <strong>
       op
      </strong>
      （操作类型）：表示报文的格式。当值为 1 时，表示客户端的请求报文；当值为 2 时，表示服务器的响应报文。
     </li>
     <li>
      <strong>
       htype
      </strong>
      （硬件类型）：不同的硬件类型取不同的值，最常见的以太网，值是 1 。
     </li>
     <li>
      <strong>
       hlen
      </strong>
      （硬件地址长度）：表示硬件地址长度，以太网的值是 6 ，也就是 MAC 地址的长度。
     </li>
     <li>
      <strong>
       hops
      </strong>
      （跳数）：DHCP 报文经过的 DHCP 中继的数量。
     </li>
     <li>
      <strong>
       xid
      </strong>
      （交互 ID ）：DHCP 客户端取的随机值，收到 DHCP 服务器的响应报文时，查看 xid 值是否相同，来判断报文是否是发送给自己的。
     </li>
     <li>
      <strong>
       secs
      </strong>
      （客户端启动秒数）：记录 IP 地址的使用时间。
     </li>
     <li>
      <strong>
       flags
      </strong>
      （标志）：广播响应标志位，当值为 0 时，表示服务器以单播形式发送响应报文；当值为 1 时，服务器以广播形式发送响应报文。
     </li>
     <li>
      <strong>
       ciaddr
      </strong>
      （客户端 IP 地址）：客户端的 IP 地址，可以是分配的地址，也可以是正在使用的地址，还可以是的 0.0.0.0 。0.0.0.0 是客户端初始状态没有地址的时候，仅用于临时通信，不是有效的地址。
     </li>
     <li>
      <strong>
       yiaddr
      </strong>
      （你的 IP 地址）：当服务器发送响应报文时，将分配给客户端的 IP 地址填入这个字段。
     </li>
     <li>
      <strong>
       siaddr
      </strong>
      （服务器 IP 地址）：用来标识服务器的 IP 地址。
     </li>
     <li>
      <strong>
       giaddr
      </strong>
      （中继设备 IP 地址）：表示 DHCP 中继的 IP 地址，服务器通过识别这个字段来判断出客户端的网段地址，从而选择合适的地址池，为客户端分配该网段的 IP 地址。
     </li>
     <li>
      <strong>
       chaddr
      </strong>
      （客户端硬件地址）：用来标识客户端的硬件地址，当客户端发送广播发现报文时，这个字段就是自己的硬件地址。
     </li>
     <li>
      <strong>
       sname
      </strong>
      （服务器名）：可选项，DHCP 服务器填写这个字段。
     </li>
     <li>
      <strong>
       file
      </strong>
      （引导文件名）：可选项，DHCP 服务器填写这个字段。
     </li>
     <li>
      <strong>
       options
      </strong>
      （可选项）：可选项，DHCP 客户端获取网络参数，DHCP 服务器提供网络参数，都是使用的这个字段。内容有很多，例如：租期、子网掩码、默认网关地址、DNS 服务器地址等。
     </li>
    </ul>
    <p>
     拿着 DHCP
     <strong>
      报文格式
     </strong>
     ，就可以看懂抓包获取的
     <strong>
      报文内容
     </strong>
     。
    </p>
    <p>
     DHCP Discover 报文
    </p>
    <p>
     <img alt="图片" src="https://i-blog.csdnimg.cn/blog_migrate/593780460dc851d9a2c0130f4eca923c.png"/>
    </p>
    <p>
     DHCP Offer 报文
    </p>
    <p>
     <img alt="图片" src="https://i-blog.csdnimg.cn/blog_migrate/82676983ef8e13fee7957df75e10dfa7.png"/>
    </p>
    <p>
     DHCP Request 报文
    </p>
    <p>
     ![外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传](https://img-home.csdnimg.cn/images/20230724024159.png?origin_url=data%3Aimage%2Fsvg%2Bxml%2C%253C%253Fxml%20version%3D’1.0’%20encoding%3D’UTF-8’%253F%253E%253Csvg%20width%3D’1px’%20height%3D’1px’%20viewBox%3D’0%200%201%201’%20version%3D’1.1’%20xmlns%3D’http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg’%20xmlns%3Axlink%3D’http%3A%2F%2Fwww.w3.org%2F1999%2Fxlink’%253E%253Ctitle%253E%253C%2Ftitle%253E%253Cg%20stroke%3D’none’%20stroke-width%3D’1’%20fill%3D’none’%20fill-rule%3D’evenodd’%20fill-opacity%3D’0’%253E%253Cg%20transform%3D’translate(-249.000000%2C%20-126.000000&amp;pos_id=img-XrC6frah-1703821518114)’ fill=‘%23FFFFFF’%3E%3Crect x=‘249’ y=‘126’ width=‘1’ height=‘1’%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)
    </p>
    <p>
     DHCP Ack 报文
    </p>
    <p>
     ，就可以看懂抓包获取的
     <strong>
      报文内容
     </strong>
     。
    </p>
    <p>
     DHCP Discover 报文
    </p>
    <p>
     [外链图片转存中…(img-jAhVtEBx-1703821518113)]
    </p>
    <p>
     DHCP Offer 报文
    </p>
    <p>
     [外链图片转存中…(img-HUMIi0C1-1703821518113)]
    </p>
    <p>
     DHCP Request 报文
    </p>
    <p>
     [外链图片转存中…(img-XrC6frah-1703821518114)]’ fill=‘%23FFFFFF’%3E%3Crect x=‘249’ y=‘126’ width=‘1’ height=‘1’%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)
    </p>
    <p>
     DHCP Ack 报文
    </p>
    <p>
     <img alt="图片" src="https://i-blog.csdnimg.cn/blog_migrate/48de55d10d75f59bc0cfca675f649111.png"/>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f34363634353936352f:61727469636c652f64657461696c732f313335323837353437" class_="artid" style="display:none">
 </p>
</div>


