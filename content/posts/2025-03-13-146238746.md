---
layout: post
title: "celery入门"
date: 2025-03-13 18:00:39 +0800
description: "按照Celery 官方文档，用 Django + Celery + Redis 写的一个简单项目。# Redis 作为 Broker 和 Backend。如果你这里出现了错误，可以看下我的celery报错文章。让 Django 项目启动时自动加载 Celery。# 异步调用 Celery 任务。# 设置 Django 配置文件路径。# 使用 Django 配置。# 导入 celery 应用。# 实例化 Celery。"
keywords: "celery入门"
categories: ['未分类']
tags: ['Redis', 'Django', 'Celery']
artid: "146238746"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146238746
    alt: "celery入门"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146238746
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146238746
cover: https://bing.ee123.net/img/rand?artid=146238746
image: https://bing.ee123.net/img/rand?artid=146238746
img: https://bing.ee123.net/img/rand?artid=146238746
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     celery入门
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <blockquote>
     <p>
      按照Celery 官方文档，用 Django + Celery + Redis 写的一个简单项目
     </p>
     <p>
      如需转载，标记出处
     </p>
    </blockquote>
    <p>
    </p>
    <h3>
     <strong>
      <strong>
       <strong>
        环境准备
       </strong>
      </strong>
     </strong>
    </h3>
    <h4>
     <strong>
      <strong>
       <strong>
        1. 安装依赖
       </strong>
      </strong>
     </strong>
    </h4>
    <blockquote>
     <p>
      pip install django celery redis
     </p>
    </blockquote>
    <p>
    </p>
    <h3>
     <strong>
      <strong>
       <strong>
        创建 Django 项目
       </strong>
      </strong>
     </strong>
    </h3>
    <h4>
     <strong>
      <strong>
       <strong>
        1. 创建 Django 项目和 APP
       </strong>
      </strong>
     </strong>
    </h4>
    <blockquote>
     <p>
      django-admin startproject myproject
     </p>
     <p>
      cd myproject
     </p>
     <p>
      python manage.py startapp myapp
     </p>
    </blockquote>
    <h4>
     <strong>
      <strong>
       <strong>
        2. 注册 APP
       </strong>
      </strong>
     </strong>
    </h4>
    <p>
     在 myproject/settings.py 中添加 myapp：
    </p>
    <blockquote>
     <p>
      INSTALLED_APPS = [
     </p>
     <p>
      ...,
     </p>
     <p>
      'myapp',
     </p>
     <p>
      ]
     </p>
    </blockquote>
    <p>
    </p>
    <h3>
     <strong>
      <strong>
       <strong>
        配置 Celery
       </strong>
      </strong>
     </strong>
    </h3>
    <h4>
     <strong>
      <strong>
       <strong>
        1. 创建 celery.py 文件（项目根目录）
       </strong>
      </strong>
     </strong>
    </h4>
    <p>
     在 myproject/celery.py：
    </p>
    <blockquote>
     <p>
      import os
     </p>
     <p>
      from celery import Celery
     </p>
     <p>
     </p>
     <p>
      # 设置 Django 配置文件路径
     </p>
     <p>
      os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'myproject.settings')
     </p>
     <p>
     </p>
     <p>
      # 实例化 Celery
     </p>
     <p>
      app = Celery('myproject')
     </p>
     <p>
     </p>
     <p>
      # 使用 Django 配置
     </p>
     <p>
      app.config_from_object('django.conf:settings', namespace='CELERY')
     </p>
     <p>
     </p>
     <p>
      # 自动发现任务
     </p>
     <p>
      app.autodiscover_tasks()
     </p>
     <p>
     </p>
     <p>
      @app.task(bind=True)
     </p>
     <p>
      def debug_task(self):
     </p>
     <p>
      print(f'Request: {self.request!r}')
     </p>
    </blockquote>
    <p>
    </p>
    <h4>
     <strong>
      <strong>
       <strong>
        2. 修改
       </strong>
      </strong>
      __init__.py
      <strong>
       <strong>
        （项目目录 myproject/）
       </strong>
      </strong>
     </strong>
    </h4>
    <p>
     让 Django 项目启动时自动加载 Celery
    </p>
    <p>
    </p>
    <blockquote>
     <p>
     </p>
     <p>
      # 导入 celery 应用
     </p>
     <p>
      from .celery import app as celery_app
     </p>
     <p>
     </p>
     <p>
      __all__ = ('celery_app',)
     </p>
    </blockquote>
    <p>
    </p>
    <hr/>
    <p>
    </p>
    <h3>
     <strong>
      <strong>
       <strong>
        Celery 配置（在 settings.py）
       </strong>
      </strong>
     </strong>
    </h3>
    <blockquote>
     <p>
      # Redis 作为 Broker 和 Backend
     </p>
     <p>
      CELERY_BROKER_URL = 'redis://localhost:6379/0'
     </p>
     <p>
      CELERY_RESULT_BACKEND = 'redis://localhost:6379/0'
     </p>
    </blockquote>
    <p>
     如果你这里出现了错误，可以看下我的celery报错文章
    </p>
    <p>
    </p>
    <hr/>
    <p>
    </p>
    <h3>
     <strong>
      <strong>
       <strong>
        创建异步任务
       </strong>
      </strong>
     </strong>
    </h3>
    <h4>
     <strong>
      <strong>
       <strong>
        在
       </strong>
      </strong>
      myapp/tasks.py
      <strong>
       <strong>
        中定义任务
       </strong>
      </strong>
     </strong>
    </h4>
    <blockquote>
     <p>
      from celery import shared_task
     </p>
     <p>
     </p>
     <p>
      @shared_task
     </p>
     <p>
      def add(x, y):
     </p>
     <p>
      return x + y
     </p>
    </blockquote>
    <p>
    </p>
    <hr/>
    <p>
    </p>
    <h3>
     <strong>
      <strong>
       <strong>
        视图中调用任务
       </strong>
      </strong>
     </strong>
    </h3>
    <p>
     在 myapp/views.py：
    </p>
    <blockquote>
     <p>
      from django.http import JsonResponse
     </p>
     <p>
      from .tasks import add
     </p>
     <p>
     </p>
     <p>
      def add_task(request):
     </p>
     <p>
      # 异步调用 Celery 任务
     </p>
     <p>
      result = add.delay(4, 6)
     </p>
     <p>
      return JsonResponse({"task_id": result.id})
     </p>
    </blockquote>
    <p>
    </p>
    <hr/>
    <p>
    </p>
    <h3>
     <strong>
      <strong>
       <strong>
        配置路由
       </strong>
      </strong>
     </strong>
    </h3>
    <p>
     在 myapp/urls.py：
    </p>
    <blockquote>
     <p>
      from django.urls import path
     </p>
     <p>
      from . import views
     </p>
     <p>
     </p>
     <p>
      urlpatterns = [
     </p>
     <p>
      path('add/', views.add_task, name='add_task'),
     </p>
     <p>
      ]
     </p>
     <p>
     </p>
    </blockquote>
    <p>
     在 myproject/urls.py：
    </p>
    <blockquote>
     <p>
      from django.contrib import admin
     </p>
     <p>
      from django.urls import path, include
     </p>
     <p>
     </p>
     <p>
      urlpatterns = [
     </p>
     <p>
      path('admin/', admin.site.urls),
     </p>
     <p>
      path('', include('myapp.urls')),
     </p>
     <p>
      ]
     </p>
    </blockquote>
    <hr/>
    <p>
    </p>
    <h3>
     <strong>
      <strong>
       <strong>
        启动服务
       </strong>
      </strong>
     </strong>
    </h3>
    <h4>
     <strong>
      <strong>
       <strong>
        1. 启动 Redis
       </strong>
      </strong>
     </strong>
    </h4>
    <p>
     redis-cli
    </p>
    <h4>
     <strong>
      <strong>
       <strong>
        2. 启动 Django
       </strong>
      </strong>
     </strong>
    </h4>
    <p>
     python manage.py runserver
    </p>
    <h4>
     <strong>
      <strong>
       <strong>
        3. 启动 Celery Worker
       </strong>
      </strong>
     </strong>
    </h4>
    <p>
     celery -A myproject worker --loglevel=info
    </p>
    <p>
    </p>
    <hr/>
    <p>
    </p>
    <h3>
     <strong>
      <strong>
       <strong>
        测试项目
       </strong>
      </strong>
     </strong>
    </h3>
    <p>
     访问异步任务接口：
    </p>
    <p>
     http://127.0.0.1:8000/add/
    </p>
   </div>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f:672e6373646e2e6e65742f323530345f39303236363737332f:61727469636c652f64657461696c732f313436323338373436" class_="artid" style="display:none">
 </p>
</div>


