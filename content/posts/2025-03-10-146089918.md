---
layout: post
title: "MySQL中-IN-到底走不走索引"
date: 2025-03-10 13:17:09 +0800
description: "在 MySQL 中，IN 语句是否能够利用索引取决于多个因素，包括但不限于查询的具体形式、表的统计信息、索引的选择度等。本文通过几个案例来帮助理解 IN 语句与索引使用的关系。"
keywords: "mysql select in 主键字段 走索引吗"
categories: ['数据库']
tags: ['数据库', 'Mysql']
artid: "146089918"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146089918
    alt: "MySQL中-IN-到底走不走索引"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146089918
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146089918
cover: https://bing.ee123.net/img/rand?artid=146089918
image: https://bing.ee123.net/img/rand?artid=146089918
img: https://bing.ee123.net/img/rand?artid=146089918
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     MySQL中 IN 到底走不走索引？
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <p>
    </p>
    <hr/>
    <h2>
     <a id="_4">
     </a>
     前言
    </h2>
    <p>
     在 MySQL 中，IN 语句是否能够利用索引取决于多个因素，包括但不限于查询的具体形式、表的统计信息、索引的选择度等。以下通过几个案例来帮助理解 IN 语句与索引使用的关系。
    </p>
    <h2>
     <a id="_7">
     </a>
     数据库表结构
    </h2>
    <pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>device_record_gongdi<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'主键'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>device_code<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'设备code'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>device_type<span class="token punctuation">`</span></span> <span class="token keyword">tinyint</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'设备类型(0:微站设备 1:工地扬尘监测)'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>time_type<span class="token punctuation">`</span></span> <span class="token keyword">tinyint</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'时间类型(1:一分钟 2:五分钟 3:一小时)'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>cn<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'时间类型编码： 2011 分钟、2051 5分钟、2061 小时'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>aqi<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>level<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'等级'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>pollutions<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'首要污染物'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>zhzs<span class="token punctuation">`</span></span> <span class="token keyword">double</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'综合指数'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>pm25_avg<span class="token punctuation">`</span></span> <span class="token keyword">double</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'PM25 指定时间内平均值'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>pm10_avg<span class="token punctuation">`</span></span> <span class="token keyword">double</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'PM10 指定时间内平均值'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>so2_avg<span class="token punctuation">`</span></span> <span class="token keyword">double</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'SO2 指定时间内平均值'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>no2_avg<span class="token punctuation">`</span></span> <span class="token keyword">double</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'NO2 指定时间内平均值'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>co_avg<span class="token punctuation">`</span></span> <span class="token keyword">double</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'CO 指定时间内平均值'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>data_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'数据采集时间'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>gd_data_code_type_time<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>device_code<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>time_type<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>data_time<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4 ROW_FORMAT<span class="token operator">=</span>COMPACT <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'工地数据表'</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     复合索引(联合索引)：(device_code,time_type,data_time)
    </p>
    <h2>
     <a id="sql_32">
     </a>
     查询sql
    </h2>
    <p>
     使用EXPLAIN查看是否走索引
    </p>
    <pre><code class="prism language-sql"> <span class="token keyword">EXPLAIN</span>
 <span class="token keyword">SELECT</span> <span class="token operator">*</span>
 <span class="token keyword">FROM</span> device_record_gongdi
 <span class="token keyword">WHERE</span> device_code <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">'ZR802241106062'</span><span class="token punctuation">,</span><span class="token string">'ZR802240801012'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/bcb4f52b27da4b49a64082c0cfd52b76.png">
      <br/>
      可以看到没有走索引
     </img>
    </p>
    <h2>
     <a id="EXPLAIN_43">
     </a>
     EXPLAIN介绍
    </h2>
    <p>
     EXPLAIN 关键字在 MySQL 中是一个非常有用的工具，它可以帮助我们了解 MySQL 如何执行SQL语句。通过使用 EXPLAIN，可以获取 MySQL 执行查询的计划，这包括如何连接表、使用哪些索引、是否进行了文件排序或临时表等详细信息。
    </p>
    <h3>
     <a id="EXPLAIN__45">
     </a>
     EXPLAIN 的输出每列解释
    </h3>
    <ul>
     <li>
      id: 表示查询中每个部分的选择标识符。如果查询比较简单，可能只有一个 id。对于复杂查询（如子查询），可能会有多个 id。
     </li>
     <li>
      select_type: 显示对应行是简单还是复杂 SELECT 类型。例如：
      <ul>
       <li>
        SIMPLE: 简单查询，不包含子查询或 UNION。
       </li>
       <li>
        PRIMARY: 最外层的查询。
       </li>
       <li>
        SUBQUERY: 子查询中的第一个 SELECT。
       </li>
       <li>
        DERIVED: 派生表（在 FROM 子句中的子查询）。
       </li>
      </ul>
     </li>
     <li>
      table: 显示该行引用的表名。
     </li>
     <li>
      <strong>
       type: 显示连接类型，从最佳到最差依次为：system, const, eq_ref, ref, range, index, 和 ALL
      </strong>
      。理想情况下，应尽量避免 ALL 类型，因为它表示全表扫描。
     </li>
     <li>
      possible_keys: 显示 MySQL 在查询过程中可以使用的索引。
     </li>
     <li>
      <strong>
       key: 实际上被 MySQL 选择用来加速查询的索引
      </strong>
      。如果没有索引被使用，则值为 NULL。
     </li>
     <li>
      key_len: 被选中索引使用的字节数，可以通过这个值来判断是否使用了复合索引的部分字段。
     </li>
     <li>
      ref: 显示与索引比较的列或常量。
     </li>
     <li>
      <strong>
       rows: 估算出找到所需的记录所需要读取的行数，值越小越好
      </strong>
      。
     </li>
     <li>
      Extra: 包含不适合在其他列中显示的额外信息，比如“Using where”, “Using index”, “Using temporary”, “Using filesort”等。
     </li>
    </ul>
    <p>
     本文主要观察type、key和rows列。
    </p>
    <h2>
     <a id="_63">
     </a>
     强制走索引
    </h2>
    <p>
     通过使用force index让sql强制走索引
    </p>
    <pre><code class="prism language-sql"> <span class="token keyword">EXPLAIN</span>
 <span class="token keyword">SELECT</span> <span class="token operator">*</span>
 <span class="token keyword">FROM</span> device_record_gongdi <span class="token keyword">force</span> <span class="token keyword">index</span> <span class="token punctuation">(</span>gd_data_code_type_time<span class="token punctuation">)</span>
 <span class="token keyword">WHERE</span> device_code <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">'ZR802241106062'</span><span class="token punctuation">,</span><span class="token string">'ZR802240801012'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/b62e594a72b2436bad1c4eabdea70f44.png">
      <br/>
      可以看到强制走索引后，rows值没有减少，仍然为382258行。
      <br/>
      继续向下看
     </img>
    </p>
    <h2>
     <a id="_75">
     </a>
     查询时添加条件(复合索引字段)
    </h2>
    <p>
     <strong>
      表中time_type为时间类型，1代表一分钟数据，2代表五分钟数据，3代表一小时数据。
     </strong>
     <br/>
     表中创建了复合索引：(device_code,time_type,data_time)
    </p>
    <h3>
     <a id="_79">
     </a>
     查询小时
    </h3>
    <pre><code class="prism language-sql"> <span class="token keyword">EXPLAIN</span>
 <span class="token keyword">SELECT</span> <span class="token operator">*</span>
 <span class="token keyword">FROM</span> device_record_gongdi
 <span class="token keyword">WHERE</span> device_code <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">'ZR802241106062'</span><span class="token punctuation">,</span><span class="token string">'ZR802240801012'</span><span class="token punctuation">)</span>
  <span class="token operator">AND</span> time_type <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/a588e2de8863464587ea186577201dfc.png">
      <br/>
      可以看到in又走了索引，rows扫描的行数降到了3013
     </img>
    </p>
    <h3>
     <a id="_91">
     </a>
     查询分钟
    </h3>
    <pre><code class="prism language-sql"> <span class="token keyword">EXPLAIN</span>
 <span class="token keyword">SELECT</span> <span class="token operator">*</span>
 <span class="token keyword">FROM</span> device_record_gongdi
 <span class="token keyword">WHERE</span> device_code <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">'ZR802241106062'</span><span class="token punctuation">,</span><span class="token string">'ZR802240801012'</span><span class="token punctuation">)</span>
  <span class="token operator">AND</span> time_type <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
 <span class="token keyword">EXPLAIN</span>
 <span class="token keyword">SELECT</span> <span class="token operator">*</span>
 <span class="token keyword">FROM</span> device_record_gongdi <span class="token keyword">force</span> <span class="token keyword">index</span> <span class="token punctuation">(</span>gd_data_code_type_time<span class="token punctuation">)</span>
 <span class="token keyword">WHERE</span> device_code <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">'ZR802241106062'</span><span class="token punctuation">,</span><span class="token string">'ZR802240801012'</span><span class="token punctuation">)</span>
  <span class="token operator">AND</span> time_type <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     重点观察rows扫描的行数
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/82b6dccab0a24df7863527857ab3eb4f.png">
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/94407baa67b849f3a7223b0cf32e270d.png">
       <br/>
       这里可以发现，
       <strong>
        <code>
         在执行sql时，in一般是走索引的。只有当mysql的查询优化器认为走索引时也需要扫描大量的数据时，就会变为全表扫描。
        </code>
       </strong>
       (有些地方写的是当走索引查询后，rows值在数据表中的占比不超过 30% 时，大概率会走索引)
      </img>
     </img>
    </p>
    <p>
     分别执行这两条sql
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/663bd81d3c3544dbb7add6d03eced937.png">
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/d6902bc0c340402ea5e990b0ee6376d1.png">
       <br/>
       从这里也可以看出，当使用索引和不使用索引查询时间相差无几时，in就会不走索引。
       <br/>
       <strong>
        注意：查询出的条数不同是因为查询时有数据插入
       </strong>
      </img>
     </img>
    </p>
    <h2>
     <a id="_115">
     </a>
     总结
    </h2>
    <p>
     MySQL 中IN语句不一定会走索引，具体取决于多种因素：
    </p>
    <ul>
     <li>
      IN一般是走索引的。只有当mysql的查询优化器认为走索引时也需要扫描大量的数据时，就会变为全表扫描。
     </li>
     <li>
      当索引覆盖了IN查询的所有列，即查询所需的数据都能从索引中获取，MySQL 可以使用这个索引来加速查询。
     </li>
     <li>
      IN值列表中的值在索引的前缀位置，MySQL 能够利用索引加速查询。若IN值列表的值不在索引的前缀位置，MySQL 无法借助索引加速查询。
     </li>
     <li>
      也可以使用EXISTS替代IN，在某些场景下能显著提升查询性能。
     </li>
    </ul>
    <hr/>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f34363432353636312f:61727469636c652f64657461696c732f313436303839393138" class_="artid" style="display:none">
 </p>
</div>


