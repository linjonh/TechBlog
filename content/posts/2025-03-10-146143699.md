---
layout: post
title: "Netty-NIO"
date: 2025-03-10 17:59:59 +0800
description: "selector就是配合一个线程来管理多个channel，可以管理多个channel，获取这些channel上发生的事件，channel工作在非阻塞模式下，不会让线程吊死在一个channel上。Buffer类似内存缓冲区，暂存从Channel读取的数据，可以从。通过reset()将position重置到mark()做标记的位置。当写了a、b、c、d数据后，position指针也会往后移动。当切换为读模式，position指针回到最开始的状态。，也可以将Buffer的数据写入Channel。"
keywords: "【Netty】- NIO"
categories: ['微服务']
tags: ['Nio', 'Java']
artid: "146143699"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146143699
    alt: "Netty-NIO"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146143699
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146143699
cover: https://bing.ee123.net/img/rand?artid=146143699
image: https://bing.ee123.net/img/rand?artid=146143699
img: https://bing.ee123.net/img/rand?artid=146143699
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     【Netty】- NIO
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     NIO：non-blocking io
    </p>
    <h2>
     <a id="_1">
     </a>
     三大组件
    </h2>
    <h3>
     <a id="Channel__Buffer_2">
     </a>
     Channel &amp; Buffer
    </h3>
    <p>
     Buffer类似内存缓冲区，暂存从Channel读取的数据，可以从
     <strong>
      Channel
     </strong>
     将数据读入
     <strong>
      Buffer
     </strong>
     ，也可以将Buffer的数据写入Channel
    </p>
    <h3>
     <a id="Selector_5">
     </a>
     Selector
    </h3>
    <h4>
     <a id="_6">
     </a>
     多线程版
    </h4>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/dc5b8391b9c7413ca326843600740c22.png"/>
    </p>
    <p>
     缺点：
    </p>
    <ul>
     <li>
      内存占用高
     </li>
     <li>
      线程上下文切换成本高
     </li>
     <li>
      只适合连接数少的场景
     </li>
    </ul>
    <h4>
     <a id="_14">
     </a>
     线程池版
    </h4>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/ad5e2f4abb1143b1a7e7b35267e712ef.png"/>
    </p>
    <p>
     缺点：
    </p>
    <ul>
     <li>
      阻塞模式下，线程只能处理一个socket连接
     </li>
     <li>
      只适合短连接场景
     </li>
    </ul>
    <h4>
     <a id="Selector_21">
     </a>
     Selector版
    </h4>
    <p>
     selector就是配合一个线程来管理多个channel，可以管理多个channel，获取这些channel上发生的事件，channel工作在非阻塞模式下，不会让线程吊死在一个channel上。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/2427a0b7df66472195494d32db03bcf3.png"/>
    </p>
    <blockquote>
     <p>
      适合连接数特别多，但是流量（数据量）低的场景
     </p>
    </blockquote>
    <h2>
     <a id="ByteBuffer_26">
     </a>
     ByteBuffer
    </h2>
    <h3>
     <a id="_27">
     </a>
     使用
    </h3>
    <p>
     步骤：
    </p>
    <ol>
     <li>
      向Buffer写入数据
     </li>
     <li>
      调用flip()切换
      <strong>
       读模式
      </strong>
     </li>
     <li>
      从Buffer读取数据
     </li>
     <li>
      调用clear() 或 compact()切换到
      <strong>
       写模式
      </strong>
     </li>
    </ol>
    <pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// FileChannel</span>
    <span class="token comment">// 输入输出流</span>
    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">FileChannel</span> channel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">"data.txt"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 准备缓冲区</span>
        <span class="token class-name">ByteBuffer</span> buffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 划分一段内存作为缓冲区</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 因为缓冲区只有10字节，所以需要分多次读取</span>
            <span class="token comment">// 从 channel 读取数据，向 buffer 写入</span>
            <span class="token keyword">int</span> len <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 表示读到的字节数</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 没有内容了</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 打印 buffer 的内容</span>
            buffer<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 切换至读模式</span>
            <span class="token keyword">while</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">hasRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 是否还有剩余未读数据</span>
                <span class="token keyword">byte</span> b <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 一次读一个字节</span>
                log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"实际字节 {}"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            buffer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 切换为写模式</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="_59">
     </a>
     结构
    </h3>
    <p>
     几个重要属性：
    </p>
    <ul>
     <li>
      capacity：容量（能装多少数据）
     </li>
     <li>
      position：读写指针（索引下标）
     </li>
     <li>
      limit：读写限制
     </li>
    </ul>
    <ol>
     <li>
      初始状态：
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/4457089200e64b3cb2475c0281694ae6.png"/>
     </li>
     <li>
      写入数据
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/48c382ceefaa4ef7afb471dd88767d96.png"/>
     </li>
    </ol>
    <blockquote>
     <p>
      当写了a、b、c、d数据后，position指针也会往后移动
     </p>
    </blockquote>
    <ol start="3">
     <li>
      切换读模式
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/89fbaf13bd9e4fd69b144ad54786b485.png"/>
     </li>
    </ol>
    <blockquote>
     <p>
      当切换为读模式，position指针回到最开始的状态
     </p>
    </blockquote>
    <ol start="4">
     <li>
      切换写模式
     </li>
    </ol>
    <ul>
     <li>
      clear()：直接回到开头写
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/4e9e096ebee04688bbd610dbaf5af73c.png"/>
     </li>
     <li>
      compact()：未读的往前移，从未读完的开始写
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/a3ab027cf44140809c922f3af16d2a02.png"/>
     </li>
    </ul>
    <h3>
     <a id="_79">
     </a>
     常见方法
    </h3>
    <ol>
     <li>
      分配空间
     </li>
    </ol>
    <pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  	<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// class java.nio.HeapByteBuffer：java 堆内存，读写效率较低，受到 GC 的影响</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocateDirect</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// class java.nio.DirectByteBuffer：直接内存，读写效率高（少一次拷贝），不会受 GC 影响，分配的效率低</span>
 <span class="token punctuation">}</span>
</code></pre>
    <ol start="2">
     <li>
      写入数据
     </li>
    </ol>
    <ul>
     <li>
      调用channel的read方法
     </li>
    </ul>
    <pre><code class="prism language-java"><span class="token keyword">int</span> readBytes <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <ul>
     <li>
      调用buffer的put方法
     </li>
    </ul>
    <pre><code class="prism language-java">buffer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span><span class="token number">127</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <ol start="3">
     <li>
      读取数据
     </li>
    </ol>
    <ul>
     <li>
      调用channel的write方法
     </li>
    </ul>
    <pre><code class="prism language-java"><span class="token keyword">int</span> writeBytes <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <ul>
     <li>
      调用buffer自己的get方法
     </li>
    </ul>
    <pre><code class="prism language-java"><span class="token keyword">byte</span> b <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 一次读取1个字节</span>
buffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 一次读取4个字节</span>
</code></pre>
    <blockquote>
     <p>
      可以通过rewind从头开始读
      <br/>
      mark() + reset()：
      <br/>
      通过mark()做标记
      <br/>
      通过reset()将position重置到mark()做标记的位置
     </p>
    </blockquote>
    <ol start="4">
     <li>
      字符串和ByteBuffer互相转换
     </li>
    </ol>
    <pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 1. 字符串转为 ByteBuffer</span>
    <span class="token class-name">ByteBuffer</span> buffer1 <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    buffer1<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">debugAll</span><span class="token punctuation">(</span>buffer1<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 2. Charset</span>
    <span class="token class-name">ByteBuffer</span> buffer2 <span class="token operator">=</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">debugAll</span><span class="token punctuation">(</span>buffer2<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 3. wrap</span>
    <span class="token class-name">ByteBuffer</span> buffer3 <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">debugAll</span><span class="token punctuation">(</span>buffer3<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 4. 转为字符串</span>
    <span class="token class-name">String</span> str1 <span class="token operator">=</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>buffer2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>str1<span class="token punctuation">)</span><span class="token punctuation">;</span>

    buffer1<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 如果是第一种方式，需要先切换到读模式，再转换</span>
    <span class="token class-name">String</span> str2 <span class="token operator">=</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>buffer1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>str2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f35373838323939372f:61727469636c652f64657461696c732f313436313433363939" class_="artid" style="display:none">
 </p>
</div>


