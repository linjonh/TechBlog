---
layout: post
title: "nettrace-rtt分析器"
date: 2025-03-11 11:44:56 +0800
description: "文章介绍:本篇文章围绕腾讯开源项目 nettrace 中涉及到的rtt分析器 进行源码梳理介绍"
keywords: "nettrace rtt分析器"
categories: ['开源项目学习']
tags: ['运维开发', '运维', '腾讯云', '网络安全', '网络协议', '网络', 'Linux']
artid: "146174707"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146174707
    alt: "nettrace-rtt分析器"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146174707
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146174707
cover: https://bing.ee123.net/img/rand?artid=146174707
image: https://bing.ee123.net/img/rand?artid=146174707
img: https://bing.ee123.net/img/rand?artid=146174707
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     nettrace rtt分析器
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="_0">
     </a>
     开源工具学习记录之流程梳理
    </h2>
    <p>
     近期对腾讯的的开源项目: nettrace(网络故障分析工具) ,进行源码学习。
     <br/>
     开源仓库：
     <a href="https://github.com/OpenCloudOS/nettrace">
      Nettrace开源仓库
     </a>
     <br/>
     开源工具实现注释：
     <a href="https://github.com/albertxu216/nettrace_learning">
      nettrace学习记录
     </a>
    </p>
    <ul>
     <li>
      <a href="https://blog.csdn.net/abobob/article/details/146094075?">
       Nettrace学习记录之流程梳理
      </a>
     </li>
     <li>
      <a href="https://blog.csdn.net/abobob/article/details/146112089">
       Nettrace eBPF程序自动挂载方式探究
      </a>
     </li>
    </ul>
    <h2>
     <a id="nettrace_rtt_7">
     </a>
     nettrace rtt分析器
    </h2>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/d3e870055b0542ea98df860e0b6d4429.png#pic_center"/>
    </p>
    <pre><code>DEFINE_ANALYZER_ENTRY(rtt, TRACE_MODE_ALL_MASK)
{
	/*1.通过define_pure_event提取rtt事件数据*/
	define_pure_event(rtt_event_t, event, e-&gt;event);
	char *msg = malloc(1024);

	msg[0] = '\0';
	/*2.将first_rtt和last_rtt格式化成字符串，用于输出和日志记录*/
	sprintf(msg, PFMT_EMPH_STR(" *rtt:%ums, rtt_min:%ums*"),
		event-&gt;first_rtt, event-&gt;last_rtt);
	/*3.entry_set_msg将聚合后的消息绑定到当前分析条目analy_entry_t*/
	entry_set_msg(e, msg);

	return RESULT_CONT;
}
DEFINE_ANALYZER_EXIT_FUNC_DEFAULT(rtt)
</code></pre>
    <h3>
     <a id="1_rtt_31">
     </a>
     1. rtt分析器逻辑
    </h3>
    <h4>
     <a id="11__33">
     </a>
     1.1 逻辑梳理
    </h4>
    <p>
     首先看一下哪些跟踪点会触发该分析器:
    </p>
    <pre><code class="prism language-c"><span class="token class-name">trace_t</span> trace_tcp_ack_update_rtt <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span>desc <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>type <span class="token operator">=</span> TRACE_FUNCTION<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>analyzer <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token function">ANALYZER</span><span class="token punctuation">(</span>rtt<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>is_backup <span class="token operator">=</span> false<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>probe <span class="token operator">=</span> false<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"tcp_ack_update_rtt"</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>sk <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>custom <span class="token operator">=</span> true<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>def <span class="token operator">=</span> true<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>index <span class="token operator">=</span> INDEX_tcp_ack_update_rtt<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>prog <span class="token operator">=</span> <span class="token string">"__trace_tcp_ack_update_rtt"</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>parent <span class="token operator">=</span> <span class="token operator">&amp;</span>group_tcp_state<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>rules <span class="token operator">=</span> <span class="token function">LIST_HEAD_INIT</span><span class="token punctuation">(</span>trace_tcp_ack_update_rtt<span class="token punctuation">.</span>rules<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">trace_list_t</span> trace_tcp_ack_update_rtt_list <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span>trace <span class="token operator">=</span> <span class="token operator">&amp;</span>trace_tcp_ack_update_rtt<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>list <span class="token operator">=</span> <span class="token function">LIST_HEAD_INIT</span><span class="token punctuation">(</span>trace_tcp_ack_update_rtt_list<span class="token punctuation">.</span>list<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     在跟踪点的定义中,发现
     <code>
      tcp_ack_update_rtt
     </code>
     触发该分析器;
    </p>
    <p>
     看一下该分析器的具体逻辑:
    </p>
    <pre><code class="prism language-c"><span class="token class-name">analyzer_result_t</span> <span class="token function">analyzer_rtt_exit</span><span class="token punctuation">(</span><span class="token class-name">trace_t</span> <span class="token operator">*</span>trace<span class="token punctuation">,</span> <span class="token class-name">analy_exit_t</span> <span class="token operator">*</span>e<span class="token punctuation">)</span> <span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>weak<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">analyzer_result_t</span> <span class="token function">analyzer_rtt_entry</span><span class="token punctuation">(</span><span class="token class-name">trace_t</span> <span class="token operator">*</span>trace<span class="token punctuation">,</span> <span class="token class-name">analy_entry_t</span> <span class="token operator">*</span>e<span class="token punctuation">)</span> <span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>weak<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*analyzer_rtt结构体，trace_t中的.analyzer指向的就是这个结构体*/</span>
<span class="token class-name">analyzer_t</span> analyzer_rtt <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span>analy_entry <span class="token operator">=</span> analyzer_rtt_entry<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>analy_exit <span class="token operator">=</span> analyzer_rtt_exit<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>mode <span class="token operator">=</span> TRACE_MODE_ALL_MASK<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">analyzer_result_t</span> <span class="token function">analyzer_rtt_entry</span><span class="token punctuation">(</span><span class="token class-name">trace_t</span> <span class="token operator">*</span>trace<span class="token punctuation">,</span> <span class="token class-name">analy_entry_t</span> <span class="token operator">*</span>e<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  	<span class="token comment">/*1.通过define_pure_event提取rtt事件数据*/</span>
	<span class="token function">define_pure_event</span><span class="token punctuation">(</span><span class="token class-name">rtt_event_t</span><span class="token punctuation">,</span> event<span class="token punctuation">,</span> e<span class="token operator">-&gt;</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>msg <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	msg<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>
	<span class="token comment">/*2.将first_rtt和last_rtt格式化成字符串，用于输出和日志记录*/</span>
	<span class="token function">sprintf</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token function">PFMT_EMPH_STR</span><span class="token punctuation">(</span><span class="token string">" *rtt:%ums, rtt_min:%ums*"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		event<span class="token operator">-&gt;</span>first_rtt<span class="token punctuation">,</span> event<span class="token operator">-&gt;</span>last_rtt<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/*3.entry_set_msg将聚合后的消息绑定到当前分析条目analy_entry_t*/</span>
	<span class="token function">entry_set_msg</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> RESULT_CONT<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">analyzer_result_t</span> <span class="token function">analyzer_rtt_exit</span><span class="token punctuation">(</span><span class="token class-name">trace_t</span> <span class="token operator">*</span>trace<span class="token punctuation">,</span> <span class="token class-name">analy_exit_t</span> <span class="token operator">*</span>e<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">rule_run_ret</span><span class="token punctuation">(</span>e<span class="token operator">-&gt;</span>entry<span class="token punctuation">,</span> trace<span class="token punctuation">,</span> e<span class="token operator">-&gt;</span>event<span class="token punctuation">.</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> RESULT_CONT<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     该分析器首先先通过
     <code>
      define_pure_event
     </code>
     定义
     <code>
      pure_rtt_event_t
     </code>
     类型的指针event、并指向采集到的原始数据；接着将数据
     <code>
      first_rtt
     </code>
     ,
     <code>
      last_rtt
     </code>
     等写入msg中；最终调用
     <code>
      entry_set_msg
     </code>
     将数据放入对应分析器msg中；
    </p>
    <h4>
     <a id="12__97">
     </a>
     1.2 详细分析
    </h4>
    <p>
     上面简单介绍了rtt分析器的实现过程，重点可以放在
     <code>
      define_pure_event
     </code>
     ，以及
     <code>
      entry_set_msg
     </code>
     上，前者获取到原始数据， 后者将有用的数据存入分析器
     <code>
      analy_entry_t
     </code>
     中的msg中；
    </p>
    <h5>
     <a id="121__101">
     </a>
     1.2.1 获取原始数据
    </h5>
    <p>
     在
     <code>
      shared.h
     </code>
     文件中定义了三个变量：
     <code>
      rtt_event_t
     </code>
     ，
     <code>
      detail_rtt_event_t
     </code>
     ，
     <code>
      pure_rtt_event_t
     </code>
     ,
    </p>
    <p>
     这三个变量都包含与rtt分析器相关的信息：
     <code>
      state
     </code>
     ,
     <code>
      flags
     </code>
     ,
     <code>
      last_update
     </code>
     ,
     <code>
      qlen
     </code>
    </p>
    <pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">DEFINE_EVENT</span><span class="token expression"><span class="token punctuation">(</span>name<span class="token punctuation">,</span> fields<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>		</span><span class="token punctuation">\</span>
<span class="token expression"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>				</span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token class-name">event_t</span> event<span class="token punctuation">;</span>				</span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token keyword">int</span> __event_filed<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>			</span><span class="token punctuation">\</span>
	<span class="token expression">fields					</span><span class="token punctuation">\</span>
<span class="token expression"><span class="token punctuation">}</span> name<span class="token punctuation">;</span>						</span><span class="token punctuation">\</span>
<span class="token expression"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>				</span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token class-name">detail_event_t</span> event<span class="token punctuation">;</span>			</span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token keyword">int</span> __event_filed<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>			</span><span class="token punctuation">\</span>
	<span class="token expression">fields					</span><span class="token punctuation">\</span>
<span class="token expression"><span class="token punctuation">}</span> detail_</span><span class="token punctuation">##</span><span class="token expression">name<span class="token punctuation">;</span>				</span><span class="token punctuation">\</span>
<span class="token expression"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>				</span><span class="token punctuation">\</span>
	<span class="token expression">fields					</span><span class="token punctuation">\</span>
<span class="token expression"><span class="token punctuation">}</span> pure_</span><span class="token punctuation">##</span><span class="token expression">name<span class="token punctuation">;</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">event_field</span><span class="token expression"><span class="token punctuation">(</span>type<span class="token punctuation">,</span> name<span class="token punctuation">)</span> type name<span class="token punctuation">;</span></span></span>

<span class="token function">DEFINE_EVENT</span><span class="token punctuation">(</span><span class="token class-name">rtt_event_t</span><span class="token punctuation">,</span>
	<span class="token function">event_field</span><span class="token punctuation">(</span>u32<span class="token punctuation">,</span> first_rtt<span class="token punctuation">)</span>
	<span class="token function">event_field</span><span class="token punctuation">(</span>u32<span class="token punctuation">,</span> last_rtt<span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre>
    <p>
     <code>
      define_pure_event
     </code>
     函数根据是否需要detail信息，来选择所定义的变量event指向
     <code>
      rtt_event_t
     </code>
     或
     <code>
      detail_rtt_event_t
     </code>
     对应的
     <code>
      __event_filed
     </code>
     ，从而获取到原始数据；
    </p>
    <pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">define_pure_event</span><span class="token expression"><span class="token punctuation">(</span>type<span class="token punctuation">,</span> name<span class="token punctuation">,</span> data<span class="token punctuation">)</span>			</span><span class="token punctuation">\</span>
	<span class="token expression">pure_</span><span class="token punctuation">##</span><span class="token expression">type <span class="token operator">*</span>name <span class="token operator">=</span>					</span><span class="token punctuation">\</span>
		<span class="token expression"><span class="token punctuation">(</span><span class="token operator">!</span>trace_ctx<span class="token punctuation">.</span>detail <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">+</span>		</span><span class="token punctuation">\</span>
			<span class="token expression"><span class="token function">offsetof</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> __event_filed<span class="token punctuation">)</span> <span class="token operator">:</span>		</span><span class="token punctuation">\</span>
			<span class="token expression"><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">+</span>			</span><span class="token punctuation">\</span>
			<span class="token expression"><span class="token function">offsetof</span><span class="token punctuation">(</span>detail_</span><span class="token punctuation">##</span><span class="token expression">type<span class="token punctuation">,</span> __event_filed<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
</code></pre>
    <h5>
     <a id="122_141">
     </a>
     1.2.2数据处理与记录
    </h5>
    <p>
     通过
     <code>
      entry_set_msg
     </code>
     将有用数据记录到
     <code>
      analy_entry_t
     </code>
     中的
     <code>
      msg
     </code>
     字段；
    </p>
    <pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">entry_set_msg</span><span class="token punctuation">(</span><span class="token class-name">analy_entry_t</span> <span class="token operator">*</span>e<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>info<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	e<span class="token operator">-&gt;</span>msg <span class="token operator">=</span> info<span class="token punctuation">;</span>
	e<span class="token operator">-&gt;</span>status <span class="token operator">|=</span> ANALY_ENTRY_MSG<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="2_rtt_155">
     </a>
     2. rtt全流程分析案例
    </h3>
    <p>
     nettrace提供了 基于RTT的性能分析 功能，rtt模式下可以去分析连接的RTT变化，支持根据rtt和srtt来进行过滤。这里是通过跟踪tcp_ack_update_rtt内核函数的调用来获取套接口的rtt更新事件的，默认情况下是统计RTT的分布情况的，使用方式如下：
    </p>
    <pre><code class="prism language-c"><span class="token punctuation">.</span><span class="token operator">/</span>nettrace <span class="token operator">--</span>rtt
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/bbb8e507157d4910bc359a47d72b28a2.png#pic_center"/>
    </p>
    <p>
     可以通过-detail来输出详细的数据：
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/506db5e8d72349729b86b3dba237e63b.png#pic_center"/>
    </p>
    <p>
     该功能通过
     <code>
      tcp_ack_update_rtt
     </code>
     挂载点获取rtt‘更新数据的时间， 当获取到的数据进入到perf_buffer缓冲区后，会触发数据处理函数
     <code>
      stats_poll_handler
     </code>
     执行相应的数据处理逻辑，在该逻辑中便会触发rtt分析器，去分析数据的时延以及时延分布直方图；
    </p>
    <p>
     详细流程如下：
    </p>
    <h4>
     <a id="21__177">
     </a>
     2.1 数据采集
    </h4>
    <p>
     用户通过
     <code>
      ./nettrace -rtt
     </code>
     来开启rtt 功能, nettrace识别到–rtt ,将模式设定为RTT跟踪模式, 并根据RTT跟踪模式初始化其对应的操作函数
     <code>
      stats_poll_handler
     </code>
     ,在加载和挂载bpf程序时将
     <code>
      tcp_ack_update_rtt
     </code>
     挂载到内核上；
    </p>
    <p>
     在成功将ebpf程序挂载之后，便初始化perfbuffer缓冲区持续等待内核中数据，当缓冲区中收到了关于rtt的数据之后，便根据
     <code>
      trace_poll() -&gt;poll_handler_wrap-&gt;trace_ctx.ops-&gt;trace_poll
     </code>
     去执行与RTT模式绑定的数据处理回调函数
     <code>
      stats_poll_handler
     </code>
     ;
    </p>
    <p>
     <code>
      stats_poll_handler
     </code>
     是如何进行数据处理的，将会在后面介绍
    </p>
    <pre><code class="prism language-C">int main(int argc, char *argv[])
{
	/*1.初始化跟踪组*/
	init_trace_group();
	do_parse_args(argc, argv);
	/*2.跟踪点有效性标记*/
	if (trace_prepare())
		goto err;
	/*3.加载并附加eBPF程序*/
	if (trace_bpf_load_and_attach()) {
		pr_err("failed to load bpf\n");
		goto err;
	}
	/*4.启动网络追踪功能*/
	trace_poll(trace_ctx);

}
</code></pre>
    <p>
     在trace_prepare中进行跟踪模式设定、操作集初始化、挂载点预选；
    </p>
    <pre><code class="prism language-c"><span class="token comment">/*遍历所有挂载点,通过比对内核符号表对每个跟踪点进行有效性标记*/</span>
<span class="token keyword">int</span> <span class="token function">trace_prepare</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">/*1.BTF支持检查*/</span>
	<span class="token comment">/*2.内核版本兼容检查*/</span>
	
	<span class="token comment">/*3.跟踪模式设定*/</span>
	err <span class="token operator">=</span> <span class="token function">trace_prepare_args</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">/*4.初始化操作集
	 *  遍历trace_ops_all选择支持当前系统的操作集
	 */</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">ARRAY_SIZE</span><span class="token punctuation">(</span>trace_ops_all<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>trace_ops_all<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span><span class="token function">trace_supported</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">set_trace_ops</span><span class="token punctuation">(</span>trace_ops_all<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	
	<span class="token comment">/*5.挂载点的预处理*/</span>
	err <span class="token operator">=</span> <span class="token function">trace_prepare_traces</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">/*6.确保以root权限运行*/</span>
	<span class="token comment">/*7.检查内核特性*/</span>
	<span class="token comment">/*8.只启用第一个有校挂载点,其他的备用挂载点标记为无效*/</span>
	<span class="token comment">/*9.打印所有有效挂载点*/</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     在trace_bpf_load_and_attach 中将bpf程序加载并挂载在预选的跟踪点上，并根据RTT跟踪模式将数据处理回调函数设定为
     <code>
      stats_poll_handler
     </code>
     ；
    </p>
    <pre><code class="prism language-c"><span class="token comment">/*加载并附加eBPF程序*/</span>
<span class="token keyword">int</span> <span class="token function">trace_bpf_load_and_attach</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">/*1.load_bpf*/</span>
	<span class="token function">trace_bpf_load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/*2.attach bpf*/</span>

	<span class="token comment">/*3.准备ops操作函数*/</span>
	<span class="token function">trace_prepare_ops</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h5>
     <a id="211_RTT_252">
     </a>
     2.1.1 RTT跟踪模式设定
    </h5>
    <p>
     main-&gt;trace_prepare-&gt;trace_prepare_args 设定为RTT跟踪模式:
    </p>
    <pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">trace_prepare_args</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token function">ASSIGN_MODE</span><span class="token punctuation">(</span>rtt<span class="token punctuation">,</span> RTT<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>bpf_args<span class="token operator">-&gt;</span>first_rtt <span class="token operator">||</span> bpf_args<span class="token operator">-&gt;</span>last_rtt<span class="token punctuation">)</span>
		trace_tcp_ack_update_rtt<span class="token punctuation">.</span>monitor <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
	<span class="token comment">/*根据当前的跟踪模式，对相应的追踪点进行标记*/</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">trace_prepare_mode</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">goto</span> err<span class="token punctuation">;</span>
     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token punctuation">}</span>
</code></pre>
    <h5>
     <a id="212_RTT_271">
     </a>
     2.1.2 RTT数据处理
    </h5>
    <p>
     main-&gt;trace_bpf_load_and_attach-&gt;trace_prepare_ops设定RTT模式下的数据处理函数
    </p>
    <pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">trace_prepare_ops</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token keyword">switch</span> <span class="token punctuation">(</span>trace_ctx<span class="token punctuation">.</span>mode<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token keyword">case</span> TRACE_MODE_RTT<span class="token operator">:</span>
		trace_ctx<span class="token punctuation">.</span>ops<span class="token operator">-&gt;</span>raw_poll <span class="token operator">=</span> stats_poll_handler<span class="token punctuation">;</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token punctuation">}</span>	
</code></pre>
    <h5>
     <a id="213__287">
     </a>
     2.1.3 数据监听
    </h5>
    <p>
     点那个ebpf程序加载并挂载之后，便开始在内核中采集相应的数据，并将数据发送至perfbuffer, 并触发回调函数
     <code>
      stats_poll_handler
     </code>
     进行数据处理；
    </p>
    <pre><code>int trace_poll()
{
	/*1.获取map描述符*/
	
	/*2.创建perf_buffer 用于监听eBPF程序的输出；
	 *  poll_handler_wrap函数根据指定的模式进行数据的聚合与分析；
	 *  trace_on_lost 用于处理丢失事件的回调函数；
	 */
	struct perf_buffer_opts pb_opts = {
		.sample_cb = poll_handler_wrap,
		.lost_cb = trace_on_lost,
	};
	
	/*3. 检查perf buffer是否创建成功*/
	 
	/*4.开始监听数据
	 *  调用perf_buffer__poll 监听数据,每次有数据进来，都会触发回调函数poll_handler_wrap；
	*/
	while ((err = perf_buffer__poll(pb, 1000)) &gt;= 0) {
		if (poll_timeout(err))
			break;
	}
}
</code></pre>
    <h4>
     <a id="22__317">
     </a>
     2.2 数据处理
    </h4>
    <p>
     RTT跟踪模式下对应的数据处理回调函数是
     <code>
      stats_poll_handler
     </code>
     ；该函数持续接收来自bpf_map中的数据，并将其
    </p>
    <pre><code class="prism language-c"><span class="token comment">/**
 * stats_poll_handler - 处理统计数据并以指定格式输出的处理器函数
 * 
 * 功能：
 * - 读取 BPF map `m_stats` 中的统计数据。
 * - 根据模式选择不同的统计类型（RTT 或延迟）。
 * - 输出统计分布信息。
 *
 * 返回值：
 * - 成功时返回 0，失败时返回错误码。
 */</span>
<span class="token keyword">int</span> <span class="token function">stats_poll_handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">/*1. 获取名为 "m_stats" 的 BPF map 文件描述符*/</span>
    <span class="token keyword">int</span> map_fd <span class="token operator">=</span> <span class="token function">bpf_object__find_map_fd_by_name</span><span class="token punctuation">(</span>trace_ctx<span class="token punctuation">.</span>obj<span class="token punctuation">,</span> <span class="token string">"m_stats"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">/*2. 持续循环处理统计数据，直到追踪停止*/</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">trace_stopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> start <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> j<span class="token punctuation">;</span>
        __u64 total <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 统计总数</span>

        <span class="token comment">// 从 BPF map 中读取统计数据，并计算总数</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">16</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">bpf_map_lookup_elem</span><span class="token punctuation">(</span>map_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>i<span class="token punctuation">,</span> count <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            total <span class="token operator">+=</span> count<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 打印统计分布的标题和总数</span>
        <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"%-34s%llu\n"</span><span class="token punctuation">,</span> header<span class="token punctuation">,</span> total<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 遍历每个桶并输出统计分布</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">16</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            bool has_count <span class="token operator">=</span> false<span class="token punctuation">;</span> <span class="token comment">// 标志当前桶及其后续桶是否有数据</span>
            <span class="token keyword">int</span> p <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> t <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>       <span class="token comment">// 百分比和精确度的临时变量</span>

            <span class="token comment">// 检查当前桶及其后续桶是否有数据</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> i<span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">16</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>count<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span>
                    has_count <span class="token operator">=</span> true<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 如果当前桶及后续桶都没有数据，且索引已超过 8，则提前结束循环</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>has_count <span class="token operator">&amp;&amp;</span> i <span class="token operator">&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>

            <span class="token comment">// 计算当前桶的范围</span>
            start <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> i<span class="token punctuation">;</span> <span class="token comment">// 当前桶的起始值（指数）</span>
            <span class="token function">sprintf</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token string">"%d - %5d%s"</span><span class="token punctuation">,</span> start <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> start<span class="token punctuation">,</span>
                    <span class="token punctuation">(</span>start <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> unit<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 生成桶范围字符串</span>

            <span class="token comment">// 如果总数不为零，则计算百分比</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>total<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                p <span class="token operator">=</span> count<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">/</span> total<span class="token punctuation">;</span>              <span class="token comment">// 整数部分</span>
                t <span class="token operator">=</span> <span class="token punctuation">(</span>count<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">%</span> total<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">10000</span> <span class="token operator">/</span> total<span class="token punctuation">;</span> <span class="token comment">// 小数部分（四位精度）</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 打印当前桶的统计信息</span>
            <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"%32s: %-8llu %d.%04d\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> count<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> p<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 休眠 1 秒后继续处理下一轮统计数据</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 处理成功返回 0</span>
<span class="token punctuation">}</span>

</code></pre>
    <h4>
     <a id="23__394">
     </a>
     2.3 数据分析
    </h4>
    <p>
     见1.rtt分析逻辑
    </p>
    <pre><code>            p = count[i] / total;              // 整数部分
            t = (count[i] % total) * 10000 / total; // 小数部分（四位精度）
        }

        // 打印当前桶的统计信息
        pr_info("%32s: %-8llu %d.%04d\n", buf, count[i], p, t);
    }

    // 休眠 1 秒后继续处理下一轮统计数据
    sleep(1);
}

return 0; // 处理成功返回 0
</code></pre>
    <p>
     }
    </p>
    <pre><code>
</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470:733a2f2f626c6f672e6373646e2e6e65742f61626f626f622f:61727469636c652f64657461696c732f313436313734373037" class_="artid" style="display:none">
 </p>
</div>


