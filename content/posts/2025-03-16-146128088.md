---
layout: post
title: "Day5-结构体文字显示与GDTIDT初始化"
date: 2025-03-16 22:54:27 +0800
description: "使用OSASK字体数据（记录在hankaku.txt文件中），并使用专用工具makefont.exe将hankaku.txt文件制作成一个bin文件，接着使用bin2obj.exe工具使其生成目标文件，就可以连接到可执行文件中。各个设备有变化时就会产生中断，中断发生后，CPU暂时停止正在处理的任务，并做好接下来能够继续处理的准备，转而执行中断程序。段寄存器的低3bits不允许使用，因此段号可以是0 ~ 8191之间的数字，因此最多可以设置8192个段，存储这么多段的信息总共需要。"
keywords: "Day5 结构体、文字显示与GDT/IDT初始化"
categories: ['川合秀实', '30天自制操作系统']
tags: ['笔记']
artid: "146128088"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146128088
    alt: "Day5-结构体文字显示与GDTIDT初始化"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146128088
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146128088
cover: https://bing.ee123.net/img/rand?artid=146128088
image: https://bing.ee123.net/img/rand?artid=146128088
img: https://bing.ee123.net/img/rand?artid=146128088
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Day5 结构体、文字显示与GDT/IDT初始化
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <p>
    </p>
    <h4>
     <a id="1_harib02b_1">
     </a>
     1. harib02b用例（使用结构体）
    </h4>
    <p>
     由于在asmhead.nas中已经定义好的：
    </p>
    <pre><code class="prism language-shell"><span class="token comment"># asmhead.nas 节选</span>
CYLS	EQU		0x0ff0			<span class="token punctuation">;</span> 设定启动区地址
LEDS	EQU		0x0ff1
VMODE	EQU		0x0ff2			<span class="token punctuation">;</span> 关于颜色的信息的地址，颜色的位数
SCRNX	EQU		0x0ff4			<span class="token punctuation">;</span> 分辨率X地址
SCRNY	EQU		0x0ff6			<span class="token punctuation">;</span> 分辨率Y地址
VRAM	EQU		0x0ff8			<span class="token punctuation">;</span> 图像缓冲区的开始地址

MOV		BYTE <span class="token punctuation">[</span>VMODE<span class="token punctuation">]</span>,8	<span class="token punctuation">;</span> 记录画面模式
MOV		WORD <span class="token punctuation">[</span>SCRNX<span class="token punctuation">]</span>,320
MOV		WORD <span class="token punctuation">[</span>SCRNY<span class="token punctuation">]</span>,200
MOV		DWORD <span class="token punctuation">[</span>VRAM<span class="token punctuation">]</span>,0x000a0000
</code></pre>
    <p>
     可以在bootpack.c中封装一个struct BOOTINFO，并通过访问结构体成员的方法，直接访问对应地址的内容。这样就可以直接从asmhead.nas访问到已定义好的屏幕显示信息，当屏幕显示信息修改时，显示图案可以随之修改。（BOOTINFO结构体中的字段顺序不可改变，与asmhead.nas定义好的地址强关联。）
    </p>
    <pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">BOOTINFO</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">char</span> cyls<span class="token punctuation">,</span> leds<span class="token punctuation">,</span> vmode<span class="token punctuation">,</span> reserve<span class="token punctuation">;</span>
	<span class="token keyword">short</span> scrnx<span class="token punctuation">,</span> scrny<span class="token punctuation">;</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>vram<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">HariMain</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">char</span> <span class="token operator">*</span>vram<span class="token punctuation">;</span>
	<span class="token keyword">int</span> xsize<span class="token punctuation">,</span> ysize<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">BOOTINFO</span> <span class="token operator">*</span>binfo<span class="token punctuation">;</span>

	<span class="token function">init_palette</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	binfo <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">BOOTINFO</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token number">0x0ff0</span><span class="token punctuation">;</span>
	xsize <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>binfo<span class="token punctuation">)</span><span class="token punctuation">.</span>scrnx<span class="token punctuation">;</span>
	ysize <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>binfo<span class="token punctuation">)</span><span class="token punctuation">.</span>scrny<span class="token punctuation">;</span>
	vram <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>binfo<span class="token punctuation">)</span><span class="token punctuation">.</span>vram<span class="token punctuation">;</span>

	<span class="token function">init_screen</span><span class="token punctuation">(</span>vram<span class="token punctuation">,</span> xsize<span class="token punctuation">,</span> ysize<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">io_hlt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="2_harib02c_44">
     </a>
     2. harib02c用例
    </h4>
    <p>
     除了使用*解引用结构体指针外，还可以使用-&gt;直接访问结构体指针的成员。因此，修改bootpack.c：
    </p>
    <pre><code class="prism language-c">	<span class="token keyword">struct</span> <span class="token class-name">BOOTINFO</span> <span class="token operator">*</span>binfo <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">BOOTINFO</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token number">0x0ff0</span><span class="token punctuation">;</span><span class="token punctuation">;</span>

	<span class="token function">init_palette</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">init_screen</span><span class="token punctuation">(</span>binfo<span class="token operator">-&gt;</span>vram<span class="token punctuation">,</span> binfo<span class="token operator">-&gt;</span>scrnx<span class="token punctuation">,</span> binfo<span class="token operator">-&gt;</span>scrny<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <h4>
     <a id="3_harib02d_52">
     </a>
     3. harib02d用例（显示字符图案）
    </h4>
    <p>
     可以通过8*16的长方形像素点阵表示字符图案，8bits是一个字节，显示一个字符图案需要使用16个字节。例如：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/4f7648ead8d94687a39aa34e6938edd7.png">
      <br/>
      类似这种描绘文字图案的数据称为字体（font）数据。暂时使用这样一个数组表示上图中的字符“A”：
     </img>
    </p>
    <pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">char</span> font_A<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
	<span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x18</span><span class="token punctuation">,</span> <span class="token number">0x18</span><span class="token punctuation">,</span> <span class="token number">0x18</span><span class="token punctuation">,</span> <span class="token number">0x18</span><span class="token punctuation">,</span> <span class="token number">0x24</span>， <span class="token number">0x24</span><span class="token punctuation">,</span> <span class="token number">0x24</span><span class="token punctuation">,</span>
	<span class="token number">0x24</span><span class="token punctuation">,</span> <span class="token number">0x7e</span><span class="token punctuation">,</span> <span class="token number">0x42</span><span class="token punctuation">,</span> <span class="token number">0x42</span><span class="token punctuation">,</span> <span class="token number">0x42</span><span class="token punctuation">,</span> <span class="token number">0xe7</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     将显示字符的功能封装为一个函数，并在HariMain中调用它：
    </p>
    <pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">putfont8</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>vram<span class="token punctuation">,</span> <span class="token keyword">int</span> xsize<span class="token punctuation">,</span> <span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">,</span> <span class="token keyword">char</span> c<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>font<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> i<span class="token punctuation">;</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>p<span class="token punctuation">,</span> d <span class="token comment">/* data */</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">16</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		p <span class="token operator">=</span> vram <span class="token operator">+</span> <span class="token punctuation">(</span>y <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">*</span> xsize <span class="token operator">+</span> x<span class="token punctuation">;</span>
		d <span class="token operator">=</span> font<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token comment">// 按像素逐个将font表示出来</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>d <span class="token operator">&amp;</span> <span class="token number">0x80</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> p<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> c<span class="token punctuation">;</span> <span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>d <span class="token operator">&amp;</span> <span class="token number">0x40</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> p<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> c<span class="token punctuation">;</span> <span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>d <span class="token operator">&amp;</span> <span class="token number">0x20</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> p<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> c<span class="token punctuation">;</span> <span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>d <span class="token operator">&amp;</span> <span class="token number">0x10</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> p<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> c<span class="token punctuation">;</span> <span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>d <span class="token operator">&amp;</span> <span class="token number">0x08</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> p<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> c<span class="token punctuation">;</span> <span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>d <span class="token operator">&amp;</span> <span class="token number">0x04</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> p<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> c<span class="token punctuation">;</span> <span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>d <span class="token operator">&amp;</span> <span class="token number">0x02</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> p<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> c<span class="token punctuation">;</span> <span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>d <span class="token operator">&amp;</span> <span class="token number">0x01</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> p<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> c<span class="token punctuation">;</span> <span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">HariMain</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">BOOTINFO</span> <span class="token operator">*</span>binfo <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">BOOTINFO</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token number">0x0ff0</span><span class="token punctuation">;</span>
	<span class="token keyword">static</span> <span class="token keyword">char</span> font_A<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
		<span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x18</span><span class="token punctuation">,</span> <span class="token number">0x18</span><span class="token punctuation">,</span> <span class="token number">0x18</span><span class="token punctuation">,</span> <span class="token number">0x18</span><span class="token punctuation">,</span> <span class="token number">0x24</span><span class="token punctuation">,</span> <span class="token number">0x24</span><span class="token punctuation">,</span> <span class="token number">0x24</span><span class="token punctuation">,</span>
		<span class="token number">0x24</span><span class="token punctuation">,</span> <span class="token number">0x7e</span><span class="token punctuation">,</span> <span class="token number">0x42</span><span class="token punctuation">,</span> <span class="token number">0x42</span><span class="token punctuation">,</span> <span class="token number">0x42</span><span class="token punctuation">,</span> <span class="token number">0xe7</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>

	<span class="token function">init_palette</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">init_screen</span><span class="token punctuation">(</span>binfo<span class="token operator">-&gt;</span>vram<span class="token punctuation">,</span> binfo<span class="token operator">-&gt;</span>scrnx<span class="token punctuation">,</span> binfo<span class="token operator">-&gt;</span>scrny<span class="token punctuation">)</span><span class="token punctuation">;</span>				<span class="token comment">// 界面设计</span>
	<span class="token function">putfont8</span><span class="token punctuation">(</span>binfo<span class="token operator">-&gt;</span>vram<span class="token punctuation">,</span> binfo<span class="token operator">-&gt;</span>scrnx<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> COL8_FFFFFF<span class="token punctuation">,</span> font_A<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 白色线条显示文字</span>

	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">io_hlt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     显示结果为：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/84a051937d2b4920a302d459c554b865.png"/>
    </p>
    <h4>
     <a id="3_harib02e_103">
     </a>
     3. harib02e用例（增加字符图案）
    </h4>
    <p>
     使用OSASK字体数据（记录在hankaku.txt文件中），并使用专用工具makefont.exe将hankaku.txt文件制作成一个bin文件，接着使用bin2obj.exe工具使其生成目标文件，就可以连接到可执行文件中。最终仅需要在bootpack.c文件中
     <code>
      extern char hankaku[4096];
     </code>
     即可。
     <br/>
     A的字符编码是0x41，因此A的字体图案数据的地址为
     <code>
      hankaku+0x41*16
     </code>
     也可以写成
     <code>
      hankaku+'A'*16
     </code>
     ，在源文件bootpack.c添加显示字符的语句：
    </p>
    <pre><code class="prism language-c">	<span class="token function">putfont8</span><span class="token punctuation">(</span>binfo<span class="token operator">-&gt;</span>vram<span class="token punctuation">,</span> binfo<span class="token operator">-&gt;</span>scrnx<span class="token punctuation">,</span>  <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> COL8_FFFFFF<span class="token punctuation">,</span> hankaku <span class="token operator">+</span> <span class="token char">'A'</span> <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">putfont8</span><span class="token punctuation">(</span>binfo<span class="token operator">-&gt;</span>vram<span class="token punctuation">,</span> binfo<span class="token operator">-&gt;</span>scrnx<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> COL8_FFFFFF<span class="token punctuation">,</span> hankaku <span class="token operator">+</span> <span class="token char">'B'</span> <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">putfont8</span><span class="token punctuation">(</span>binfo<span class="token operator">-&gt;</span>vram<span class="token punctuation">,</span> binfo<span class="token operator">-&gt;</span>scrnx<span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> COL8_FFFFFF<span class="token punctuation">,</span> hankaku <span class="token operator">+</span> <span class="token char">'C'</span> <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">putfont8</span><span class="token punctuation">(</span>binfo<span class="token operator">-&gt;</span>vram<span class="token punctuation">,</span> binfo<span class="token operator">-&gt;</span>scrnx<span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> COL8_FFFFFF<span class="token punctuation">,</span> hankaku <span class="token operator">+</span> <span class="token char">'1'</span> <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">putfont8</span><span class="token punctuation">(</span>binfo<span class="token operator">-&gt;</span>vram<span class="token punctuation">,</span> binfo<span class="token operator">-&gt;</span>scrnx<span class="token punctuation">,</span> <span class="token number">48</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> COL8_FFFFFF<span class="token punctuation">,</span> hankaku <span class="token operator">+</span> <span class="token char">'2'</span> <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">putfont8</span><span class="token punctuation">(</span>binfo<span class="token operator">-&gt;</span>vram<span class="token punctuation">,</span> binfo<span class="token operator">-&gt;</span>scrnx<span class="token punctuation">,</span> <span class="token number">56</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> COL8_FFFFFF<span class="token punctuation">,</span> hankaku <span class="token operator">+</span> <span class="token char">'3'</span> <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     显示效果为：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/26482e418b0f4fa6b9099c168920e27e.png"/>
    </p>
    <h4>
     <a id="4_harib02g_116">
     </a>
     4. harib02g用例
    </h4>
    <h5>
     <a id="41__117">
     </a>
     4.1 显示字符串
    </h5>
    <p>
     由于字符串的结尾会存在一个
     <code>
      \0
     </code>
     ，因此可以封装一个函数，传入字符串的首地址，循环字符读取，当读到0时返回：
    </p>
    <pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">putfonts8_asc</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>vram<span class="token punctuation">,</span> <span class="token keyword">int</span> xsize<span class="token punctuation">,</span> <span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">,</span> <span class="token keyword">char</span> c<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>s<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">extern</span> <span class="token keyword">char</span> hankaku<span class="token punctuation">[</span><span class="token number">4096</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> <span class="token operator">*</span>s <span class="token operator">!=</span> <span class="token number">0x00</span><span class="token punctuation">;</span> s<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">putfont8</span><span class="token punctuation">(</span>vram<span class="token punctuation">,</span> xsize<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> c<span class="token punctuation">,</span> hankaku <span class="token operator">+</span> <span class="token operator">*</span>s <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		x <span class="token operator">+=</span> <span class="token number">8</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 调用</span>
<span class="token keyword">void</span> <span class="token function">HariMain</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">BOOTINFO</span> <span class="token operator">*</span>binfo <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">BOOTINFO</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token number">0x0ff0</span><span class="token punctuation">;</span>

	<span class="token function">init_palette</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">init_screen</span><span class="token punctuation">(</span>binfo<span class="token operator">-&gt;</span>vram<span class="token punctuation">,</span> binfo<span class="token operator">-&gt;</span>scrnx<span class="token punctuation">,</span> binfo<span class="token operator">-&gt;</span>scrny<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">putfonts8_asc</span><span class="token punctuation">(</span>binfo<span class="token operator">-&gt;</span>vram<span class="token punctuation">,</span> binfo<span class="token operator">-&gt;</span>scrnx<span class="token punctuation">,</span>  <span class="token number">8</span><span class="token punctuation">,</span>  <span class="token number">8</span><span class="token punctuation">,</span> COL8_FFFFFF<span class="token punctuation">,</span> <span class="token string">"ABC 123"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">putfonts8_asc</span><span class="token punctuation">(</span>binfo<span class="token operator">-&gt;</span>vram<span class="token punctuation">,</span> binfo<span class="token operator">-&gt;</span>scrnx<span class="token punctuation">,</span> <span class="token number">31</span><span class="token punctuation">,</span> <span class="token number">31</span><span class="token punctuation">,</span> COL8_000000<span class="token punctuation">,</span> <span class="token string">"Haribote OS."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">putfonts8_asc</span><span class="token punctuation">(</span>binfo<span class="token operator">-&gt;</span>vram<span class="token punctuation">,</span> binfo<span class="token operator">-&gt;</span>scrnx<span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> COL8_FFFFFF<span class="token punctuation">,</span> <span class="token string">"Haribote OS."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">io_hlt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     显示效果为如下图，在"Haribote OS."字符串中显示出了阴影的立体效果。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/20cb1f2c57d1442caa7a9e0ca16f79c9.png"/>
    </p>
    <h5>
     <a id="42__148">
     </a>
     4.2 显示变量值
    </h5>
    <p>
     期望显示变量值，可以使用C库函数sprintf，作用就是将格式化字符串写到一个内存地址中，
    </p>
    <pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">HariMain</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">BOOTINFO</span> <span class="token operator">*</span>binfo <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">BOOTINFO</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token number">0x0ff0</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> s<span class="token punctuation">[</span><span class="token number">40</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

	<span class="token function">init_palette</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">init_screen</span><span class="token punctuation">(</span>binfo<span class="token operator">-&gt;</span>vram<span class="token punctuation">,</span> binfo<span class="token operator">-&gt;</span>scrnx<span class="token punctuation">,</span> binfo<span class="token operator">-&gt;</span>scrny<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">putfonts8_asc</span><span class="token punctuation">(</span>binfo<span class="token operator">-&gt;</span>vram<span class="token punctuation">,</span> binfo<span class="token operator">-&gt;</span>scrnx<span class="token punctuation">,</span>  <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> COL8_FFFFFF<span class="token punctuation">,</span> <span class="token string">"ABC 123"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">putfonts8_asc</span><span class="token punctuation">(</span>binfo<span class="token operator">-&gt;</span>vram<span class="token punctuation">,</span> binfo<span class="token operator">-&gt;</span>scrnx<span class="token punctuation">,</span> <span class="token number">31</span><span class="token punctuation">,</span> <span class="token number">31</span><span class="token punctuation">,</span> COL8_000000<span class="token punctuation">,</span> <span class="token string">"Haribote OS."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">putfonts8_asc</span><span class="token punctuation">(</span>binfo<span class="token operator">-&gt;</span>vram<span class="token punctuation">,</span> binfo<span class="token operator">-&gt;</span>scrnx<span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> COL8_FFFFFF<span class="token punctuation">,</span> <span class="token string">"Haribote OS."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sprintf</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">"scrnx = %d"</span><span class="token punctuation">,</span> binfo<span class="token operator">-&gt;</span>scrnx<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// 格式化字符串写到s中</span>
	<span class="token function">putfonts8_asc</span><span class="token punctuation">(</span>binfo<span class="token operator">-&gt;</span>vram<span class="token punctuation">,</span> binfo<span class="token operator">-&gt;</span>scrnx<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> COL8_FFFFFF<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">io_hlt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     显示效果为：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/235cad91337941e1a037d0a44b988bdb.png"/>
    </p>
    <h4>
     <a id="5_harib02h_171">
     </a>
     5. harib02h用例（显示鼠标）
    </h4>
    <p>
     定义鼠标的图案为16*16：
    </p>
    <pre><code class="prism language-c"><span class="token comment">// 初始化一个鼠标图案</span>
<span class="token keyword">void</span> <span class="token function">init_mouse_cursor8</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>mouse<span class="token punctuation">,</span> <span class="token keyword">char</span> bc<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">static</span> <span class="token keyword">char</span> cursor<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
		<span class="token string">"**************.."</span><span class="token punctuation">,</span>
		<span class="token string">"*OOOOOOOOOOO*..."</span><span class="token punctuation">,</span>
		<span class="token string">"*OOOOOOOOOO*...."</span><span class="token punctuation">,</span>
		<span class="token string">"*OOOOOOOOO*....."</span><span class="token punctuation">,</span>
		<span class="token string">"*OOOOOOOO*......"</span><span class="token punctuation">,</span>
		<span class="token string">"*OOOOOOO*......."</span><span class="token punctuation">,</span>
		<span class="token string">"*OOOOOOO*......."</span><span class="token punctuation">,</span>
		<span class="token string">"*OOOOOOOO*......"</span><span class="token punctuation">,</span>
		<span class="token string">"*OOOO**OOO*....."</span><span class="token punctuation">,</span>
		<span class="token string">"*OOO*..*OOO*...."</span><span class="token punctuation">,</span>
		<span class="token string">"*OO*....*OOO*..."</span><span class="token punctuation">,</span>
		<span class="token string">"*O*......*OOO*.."</span><span class="token punctuation">,</span>
		<span class="token string">"**........*OOO*."</span><span class="token punctuation">,</span>
		<span class="token string">"*..........*OOO*"</span><span class="token punctuation">,</span>
		<span class="token string">"............*OO*"</span><span class="token punctuation">,</span>
		<span class="token string">".............***"</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> x<span class="token punctuation">,</span> y<span class="token punctuation">;</span>

	<span class="token keyword">for</span> <span class="token punctuation">(</span>y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> y <span class="token operator">&lt;</span> <span class="token number">16</span><span class="token punctuation">;</span> y<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> <span class="token number">16</span><span class="token punctuation">;</span> x<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>cursor<span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token punctuation">[</span>x<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'*'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				mouse<span class="token punctuation">[</span>y <span class="token operator">*</span> <span class="token number">16</span> <span class="token operator">+</span> x<span class="token punctuation">]</span> <span class="token operator">=</span> COL8_000000<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>cursor<span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token punctuation">[</span>x<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'O'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				mouse<span class="token punctuation">[</span>y <span class="token operator">*</span> <span class="token number">16</span> <span class="token operator">+</span> x<span class="token punctuation">]</span> <span class="token operator">=</span> COL8_FFFFFF<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>cursor<span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token punctuation">[</span>x<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'.'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				mouse<span class="token punctuation">[</span>y <span class="token operator">*</span> <span class="token number">16</span> <span class="token operator">+</span> x<span class="token punctuation">]</span> <span class="token operator">=</span> bc<span class="token punctuation">;</span>		<span class="token comment">// bc: back-color 背景色</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 将鼠标图案显示在屏幕上</span>
<span class="token comment">// vram: VRAM address</span>
<span class="token comment">// vxsize: screen display size</span>
<span class="token comment">// pxsize: pattern(mouse) x size</span>
<span class="token comment">// pysize: pattern(mouse) y size</span>
<span class="token comment">// px0: mouse location x of screen display</span>
<span class="token comment">// py0: mouse location y of screen display</span>
<span class="token comment">// buf: pattern address</span>
<span class="token comment">// bxsize: roughly equal to pxsize</span>
<span class="token keyword">void</span> <span class="token function">putblock8_8</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>vram<span class="token punctuation">,</span> <span class="token keyword">int</span> vxsize<span class="token punctuation">,</span> <span class="token keyword">int</span> pxsize<span class="token punctuation">,</span>
	<span class="token keyword">int</span> pysize<span class="token punctuation">,</span> <span class="token keyword">int</span> px0<span class="token punctuation">,</span> <span class="token keyword">int</span> py0<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token keyword">int</span> bxsize<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> x<span class="token punctuation">,</span> y<span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> y <span class="token operator">&lt;</span> pysize<span class="token punctuation">;</span> y<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> pxsize<span class="token punctuation">;</span> x<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			vram<span class="token punctuation">[</span><span class="token punctuation">(</span>py0 <span class="token operator">+</span> y<span class="token punctuation">)</span> <span class="token operator">*</span> vxsize <span class="token operator">+</span> <span class="token punctuation">(</span>px0 <span class="token operator">+</span> x<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> buf<span class="token punctuation">[</span>y <span class="token operator">*</span> bxsize <span class="token operator">+</span> x<span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     对函数的调用：
    </p>
    <pre><code class="prism language-c">	mx <span class="token operator">=</span> <span class="token punctuation">(</span>binfo<span class="token operator">-&gt;</span>scrnx <span class="token operator">-</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">/* 夋柺拞墰偵側傞傛偆偵嵗昗寁嶼 */</span>
	my <span class="token operator">=</span> <span class="token punctuation">(</span>binfo<span class="token operator">-&gt;</span>scrny <span class="token operator">-</span> <span class="token number">28</span> <span class="token operator">-</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
	<span class="token function">init_mouse_cursor8</span><span class="token punctuation">(</span>mcursor<span class="token punctuation">,</span> COL8_008484<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">putblock8_8</span><span class="token punctuation">(</span>binfo<span class="token operator">-&gt;</span>vram<span class="token punctuation">,</span> binfo<span class="token operator">-&gt;</span>scrnx<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> mx<span class="token punctuation">,</span> my<span class="token punctuation">,</span> mcursor<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     显示效果如图所示，可以显示鼠标为白色黑框，并且在左上角显示了鼠标的坐标：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/1c69c818f2524f099f69cce35d7ede69.png"/>
    </p>
    <h4>
     <a id="6_harib02iGDTIDT_243">
     </a>
     6. harib02i用例（GDT与IDT的初始化）
    </h4>
    <p>
     GDT与IDT都是与CPU有关的设定。
     <br/>
     为了解决多个进程访问的内存发生重叠，就需要对内存
     <mark>
      分段
     </mark>
     。将4GB的内存分成很多块（block），每一段的起始地址看起来都是0，此时任何程序都可以先写上一句
     <code>
      ORG 0
     </code>
     ，像这样分割出来的块就称作
     <code>
      段（segment）
     </code>
     。也可以用
     <code>
      分页（paging）
     </code>
     解决问题，但是当前过多讨论。
     <a href="https://blog.csdn.net/liuxiangshuai1/article/details/145624607">
      Day3
     </a>
     中引入的段寄存器，目的就是用于分段。
     <br/>
     为了表示一个段，需要明确一下信息：
    </p>
    <ul>
     <li>
      段的大小。
     </li>
     <li>
      段的起始地址。
     </li>
     <li>
      段的管理属性（禁止写入，禁止执行，系统专用）
     </li>
    </ul>
    <p>
     CPU用64bits的数据表示这些信息，但是用于指定段的寄存器只有16bits。模拟调色板的方法，预先设定好段号和段的对应关系，将段号存放在段寄存器中。
     <br/>
     段寄存器的低3bits不允许使用，因此段号可以是0 ~ 8191之间的数字，因此最多可以设置8192个段，存储这么多段的信息总共需要
     <code>
      8192*8 = 65536Byte = 64KB
     </code>
     （每个段的信息需要8Byte存储）。由于段号与外设无关，因此不需要使用
     <code>
      io_out
     </code>
     这类函数接口的调用。
     <br/>
     这64KB的数据就被称为GDT（global segment describer table），全局段描述符表。这部分内容需要顺序写入到内存中，然后将内存地址和有效的设定个数放在CPU的GDTR（global segment describer table register）的特殊寄存器中，设定就完成了。
     <br/>
     IDT（interrupt describer table），中断记录表。当CPU遇到外部状况变化，或内部偶然发生某些错误时，就会临时切换过去处理这种情况，被称为中断功能。
     <br/>
     各个设备有变化时就会产生中断，中断发生后，CPU暂时停止正在处理的任务，并做好接下来能够继续处理的准备，转而执行中断程序。中断程序执行完之后，再调用事先设定好的函数，返回处理中的任务。
     <br/>
     正式得益于中断机制，CPU可以不用一直查询键盘，鼠标，网卡等设备状态，从而专注于处理任务。
     <br/>
     IDT记录了0 ~ 255的中断号码与调用函数的对应关系。设定GDT之前需要设定好IDT。
    </p>
    <pre><code class="prism language-c"><span class="token comment">// GDT结构体，全局段号记录表，占8个字节</span>
<span class="token keyword">struct</span> <span class="token class-name">SEGMENT_DESCRIPTOR</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">short</span> limit_low<span class="token punctuation">,</span> base_low<span class="token punctuation">;</span>
	<span class="token keyword">char</span> base_mid<span class="token punctuation">,</span> access_right<span class="token punctuation">;</span>
	<span class="token keyword">char</span> limit_high<span class="token punctuation">,</span> base_high<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// IDT结构体，中断记录表，占8个字节</span>
<span class="token keyword">struct</span> <span class="token class-name">GATE_DESCRIPTOR</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">short</span> offset_low<span class="token punctuation">,</span> selector<span class="token punctuation">;</span>
	<span class="token keyword">char</span> dw_count<span class="token punctuation">,</span> access_right<span class="token punctuation">;</span>
	<span class="token keyword">short</span> offset_high<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">init_gdtidt</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 0x27 0000 ~ 0x27ffff 共8192*8 = 65536个Byte</span>
	<span class="token comment">// 由于段寄存器只有2^11 = 8192个状态</span>
	<span class="token keyword">struct</span> <span class="token class-name">SEGMENT_DESCRIPTOR</span> <span class="token operator">*</span>gdt <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">SEGMENT_DESCRIPTOR</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token number">0x00270000</span><span class="token punctuation">;</span>
	<span class="token comment">// 0x26 f800 ~ 0x26 ffff 共256*8 = 2048个Byte</span>
	<span class="token comment">// 由于中断号码共256个</span>
	<span class="token keyword">struct</span> <span class="token class-name">GATE_DESCRIPTOR</span>    <span class="token operator">*</span>idt <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">GATE_DESCRIPTOR</span>    <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token number">0x0026f800</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> i<span class="token punctuation">;</span>

	<span class="token comment">/* GDT中所有段初始化为0 */</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8192</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">set_segmdesc</span><span class="token punctuation">(</span>gdt <span class="token operator">+</span> i<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 分别对段号为1和2的两个段单独设置属性</span>
	<span class="token comment">// 1、地址为0，上限为4G，表示全部的内存本身</span>
	<span class="token function">set_segmdesc</span><span class="token punctuation">(</span>gdt <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0xffffffff</span><span class="token punctuation">,</span> <span class="token number">0x00000000</span><span class="token punctuation">,</span> <span class="token number">0x4092</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 2、地址为0x280000，大小为512K，主要用作bootpack.hrb启动程序</span>
	<span class="token function">set_segmdesc</span><span class="token punctuation">(</span>gdt <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0x0007ffff</span><span class="token punctuation">,</span> <span class="token number">0x00280000</span><span class="token punctuation">,</span> <span class="token number">0x409a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token function">load_gdtr</span><span class="token punctuation">(</span><span class="token number">0xffff</span><span class="token punctuation">,</span> <span class="token number">0x00270000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// 汇编实现定义，赋值GDTR</span>

	<span class="token comment">/* IDT的初始化 */</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">256</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">set_gatedesc</span><span class="token punctuation">(</span>idt <span class="token operator">+</span> i<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">load_idtr</span><span class="token punctuation">(</span><span class="token number">0x7ff</span><span class="token punctuation">,</span> <span class="token number">0x0026f800</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// 汇编实现定义，赋值IDTR</span>

	<span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">set_segmdesc</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">SEGMENT_DESCRIPTOR</span> <span class="token operator">*</span>sd<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> limit<span class="token punctuation">,</span> <span class="token keyword">int</span> base<span class="token punctuation">,</span> <span class="token keyword">int</span> ar<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>limit <span class="token operator">&gt;</span> <span class="token number">0xfffff</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		ar <span class="token operator">|=</span> <span class="token number">0x8000</span><span class="token punctuation">;</span> <span class="token comment">/* G_bit = 1 */</span>
		limit <span class="token operator">/=</span> <span class="token number">0x1000</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	sd<span class="token operator">-&gt;</span>limit_low    <span class="token operator">=</span> limit <span class="token operator">&amp;</span> <span class="token number">0xffff</span><span class="token punctuation">;</span>
	sd<span class="token operator">-&gt;</span>base_low     <span class="token operator">=</span> base <span class="token operator">&amp;</span> <span class="token number">0xffff</span><span class="token punctuation">;</span>
	sd<span class="token operator">-&gt;</span>base_mid     <span class="token operator">=</span> <span class="token punctuation">(</span>base <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">;</span>
	sd<span class="token operator">-&gt;</span>access_right <span class="token operator">=</span> ar <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">;</span>
	sd<span class="token operator">-&gt;</span>limit_high   <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>limit <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0f</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ar <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xf0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	sd<span class="token operator">-&gt;</span>base_high    <span class="token operator">=</span> <span class="token punctuation">(</span>base <span class="token operator">&gt;&gt;</span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">set_gatedesc</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">GATE_DESCRIPTOR</span> <span class="token operator">*</span>gd<span class="token punctuation">,</span> <span class="token keyword">int</span> offset<span class="token punctuation">,</span> <span class="token keyword">int</span> selector<span class="token punctuation">,</span> <span class="token keyword">int</span> ar<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	gd<span class="token operator">-&gt;</span>offset_low   <span class="token operator">=</span> offset <span class="token operator">&amp;</span> <span class="token number">0xffff</span><span class="token punctuation">;</span>
	gd<span class="token operator">-&gt;</span>selector     <span class="token operator">=</span> selector<span class="token punctuation">;</span>
	gd<span class="token operator">-&gt;</span>dw_count     <span class="token operator">=</span> <span class="token punctuation">(</span>ar <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">;</span>
	gd<span class="token operator">-&gt;</span>access_right <span class="token operator">=</span> ar <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">;</span>
	gd<span class="token operator">-&gt;</span>offset_high  <span class="token operator">=</span> <span class="token punctuation">(</span>offset <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xffff</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     <code>
      SEGMENT_DESCRIPTOR
     </code>
     和
     <code>
      GATE_DESCRIPTOR
     </code>
     都是以CPU资料为基础定义的结构体，结构体size为8字节。
     <br/>
     SEGMENT_DESCRIPTOR的指针变量初始化为0x00270000，本意是将
     <code>
      0x00270000 ~ 0x0027ffff
     </code>
     共64KB空间作为GDT，同样只是因为这一块区域在内存分布图中显示没有被使用，所以就直接用作GDT。同理，IDT的起始地址空间为
     <code>
      0x0026f800 ~ 0x0026ffff
     </code>
     。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f67:2e6373646e2e6e65742f6c69757869616e677368756169312f:61727469636c652f64657461696c732f313436313238303838" class_="artid" style="display:none">
 </p>
</div>


