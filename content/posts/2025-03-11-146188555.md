---
layout: post
title: "002-告别乱码-libiconv-C开源库108杰"
date: 2025-03-11 20:44:27 +0800
description: "1. 理解乱码产生的原因2. 手把手教学如何封装 libiconv 的转换操作3. 借助封装成果，解决 fswatch 库示例项目的乱码问题"
keywords: "002-告别乱码-libiconv-C++开源库108杰"
categories: ['C']
tags: ['编码转换', '开源库', '字符集', '乱码', 'Unicode', 'Gbk', 'C']
artid: "146188555"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146188555
    alt: "002-告别乱码-libiconv-C开源库108杰"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146188555
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146188555
cover: https://bing.ee123.net/img/rand?artid=146188555
image: https://bing.ee123.net/img/rand?artid=146188555
img: https://bing.ee123.net/img/rand?artid=146188555
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     002-告别乱码-libiconv-C++开源库108杰
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     本课文包含三个视频！
    </p>
    <blockquote>
     <p>
      为什么中文版Windows是编程出现乱码的高发地带？怎么用 libiconv 把国标编码的汉字转换成宇宙统一码？怎么简化 libiconv 那些充满坑的 纯C 函数API？
     </p>
    </blockquote>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/img_convert/a72ff904dc6e06032d073e810b09211f.png#pic_center" width="220"/>
    </p>
    <h2>
     <a id="1__libiconv_7">
     </a>
     1. 安装 libiconv
    </h2>
    <p>
     通常，你在 MSYS2 中安装过 GCC 编译套件，你的 msys2 系统中就会有 libiconv 开发库可用。可通过如下指令验证：
    </p>
    <pre><code class="prism language-shell">pacman <span class="token parameter variable">-S</span> libiconv
</code></pre>
    <p>
     查看是否出现带有 “[已安装]” （或 installed）的 libiconv 库？
    </p>
    <p>
     如果确实需要单独安装，指令为：
    </p>
    <pre><code class="prism language-shell">pacman <span class="token parameter variable">-S</span> mingw-w64-ucrt-x86_64-libiconv 
</code></pre>
    <blockquote>
     <p>
      再次提醒，如果你使用的 GCC 不是 UCRT64 版本，那么你可能需要的库名称应是
      <code>
       mingw-w64-x86_64-libiconv
      </code>
      （64位OS）或
      <code>
       mingw-w64-i686-libiconv
      </code>
      （32位OS，不敢相信你在还在用）
     </p>
    </blockquote>
    <h2>
     <a id="2___23">
     </a>
     2. 转码基础知识 🎥
    </h2>
    <p>
     Windows （中文版）是 编程出现乱码的高发地带之一。原因来自历史包袱：当年，各国政府（自然包括我国）都要求微软出的本地语言版本的操作系统，其字符编码，必须遵守当年各国国标。
    </p>
    <p>
    </p>
    <div class="video">
     <iframe allowfullscreen="true" data-mediaembed="csdn" frameborder="0" id="VEsk5KBh-1741696720303" src="https://live.csdn.net/v/embed/468315" style="width:100%;height:100%;">
     </iframe>
     <p>
      004-libiconv编码转换-1基础知识-c++108杰
     </p>
    </div>
    <p>
    </p>
    <h2>
     <a id="3__30">
     </a>
     3. 函数使用包装
    </h2>
    <h3>
     <a id="31__32">
     </a>
     3.1 主要函数介绍
    </h3>
    <p>
     libiconv 主要函数有三个：
    </p>
    <ul>
     <li>
      iconv_open
     </li>
    </ul>
    <p>
     原型：
    </p>
    <pre><code class="prism language-cpp">iconv_t <span class="token function">iconv_open</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token keyword">const</span><span class="token operator">*</span> toCode<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token keyword">const</span> <span class="token operator">*</span> fromcode<span class="token punctuation">)</span>
</code></pre>
    <ul>
     <li>
      其中, iconv_t 为 “void *” 的别名
     </li>
     <li>
      函数失败时，并不返回 nullptr，而是返回 (iconv_t)(-1)
     </li>
     <li>
      入参依序为：目标编码名称，源编码名称
     </li>
    </ul>
    <p>
     以下称该函数打开成功得到的结果为 “句柄”。
    </p>
    <ul>
     <li>
      iconv
     </li>
    </ul>
    <p>
     原型：
    </p>
    <pre><code class="prism language-cpp">size_t <span class="token function">iconv</span><span class="token punctuation">(</span> iconv_t cd<span class="token punctuation">,</span>
              <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> in<span class="token punctuation">,</span> size_t<span class="token operator">*</span> inBytesLeft<span class="token punctuation">,</span> 
              <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> out<span class="token punctuation">,</span> size_t<span class="token operator">*</span> outBytesLeft<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     第一个参数为句柄。其余四个参数都既为入参也为出参。
    </p>
    <ol>
     <li>
      <p>
       in：作入参，用于指示当前待转换的源字符串缓存区开始位置；作出参，用于告诉调用者，本次转换的结束位置（即下次转换的开始位置）；
      </p>
     </li>
     <li>
      <p>
       inByteLeft：作入参，指示当前待转换的源字符串缓存区有多大；作出参，告诉调用者，本次转换后还剩下多少字节未转换；
      </p>
     </li>
     <li>
      <p>
       out: 作入参，用于指示可用于存储转换结果的缓存区开始位置；作出参，用于告诉调用者，本次转换后，结果存放的结束位置（可考虑作为下次用于存储结果的开始位置，本课堂出于简化，未采用此方法）；
      </p>
     </li>
     <li>
      <p>
       outBytesLeft: 作入参，用于指示本次转换可用来存储结果的缓存区大小（字节数）；作出参，用于告诉调用者，本次转换后，用于存储结果的缓存区还剩余多少字节。
      </p>
     </li>
    </ol>
    <p>
     in 和 out 的内容都有可能造成本函数转换中途停下。最典型的如：out ，也就是输出缓存区大小不够了。比如说，源字符串有 61 字节，但目标输出缓存区（也就是 out）只有20个字节，就会造成 iconv() 转换若干字节后，就停下，并借助 errno （C库的一个宏，类似全局变量，但本质是对应到一个函数调用，且线程安全），告诉调用者：输出缓存区不足。
    </p>
    <blockquote>
     <p>
      注意，编码转换并非 1:1 转换，由于源编码和目标编码用以表达单一个本地字符（比如一个汉字）的长度不一样，因此二者之间并不存在某个简单的比例关系。典型的如使用 UTF-8 编码表达一个汉字，可能是 2字节，也可能是 3字节、4字节。
     </p>
    </blockquote>
    <p>
     为了避免 “输出缓存区不足” ，最粗暴的方法就是为 out 分配一个 “巨大” 的空间——比如，是源字符串长度的 4 倍、5 倍……这种方法既浪费内存，并且通常需要使用到 new 来动态分配内存，进一步拉低性能。
    </p>
    <p>
     我们的解决方法相对复杂，但高效（或者说性能均衡）：采用固定大小的临时连续内存来存储每次转换的结果，同时准备一个字符串流（std::stringstream）来连续存储每次转换的结果（新结果追加到旧结果之后）。
    </p>
    <h3>
     <a id="32___75">
     </a>
     3.2 函数简化封装 🎥
    </h3>
    <p>
    </p>
    <div class="csdn-video-box" data-report-view='{"spm":"3001.10261","extra":{"id":"73JeVP9f-1741696756026"}}'>
     <iframe allowfullscreen="true" data-mediaembed="csdn" frameborder="0" id="73JeVP9f-1741696756026" src="https://live.csdn.net/v/embed/468316">
     </iframe>
     <p>
      005-libiconv编码转换-2简化函数-C++108杰
     </p>
    </div>
    <p>
    </p>
    <h3>
     <a id="33__79">
     </a>
     3.3 函数封装主要代码
    </h3>
    <pre><code class="prism language-cpp"><span class="token keyword">namespace</span> d2<span class="token double-colon punctuation">::</span>myiconv
<span class="token punctuation">{<!-- --></span>

<span class="token comment">// 转换结构</span>
<span class="token keyword">struct</span> <span class="token class-name">IConvResult</span>
<span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>string result<span class="token punctuation">;</span> <span class="token comment">// 转换成功得到的，使用新编码的字符串</span>

    <span class="token keyword">int</span> errorNumber <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 对应 errno, 出错号</span>
    std<span class="token double-colon punctuation">::</span>string errorMessage<span class="token punctuation">;</span> <span class="token comment">// 出错信息</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 转换函数</span>
IConvResult <span class="token function">Convert</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>string_view in<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token keyword">const</span><span class="token operator">*</span> fromCode<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token keyword">const</span><span class="token operator">*</span> toCode<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>

IConvResult <span class="token function">Convert</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>string_view in<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token keyword">const</span><span class="token operator">*</span> fromCode<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token keyword">const</span><span class="token operator">*</span> toCode<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    IConvResult ir<span class="token punctuation">;</span>

    <span class="token comment">// 调用 iconv_open</span>
    iconv_t cd <span class="token operator">=</span> <span class="token function">iconv_open</span><span class="token punctuation">(</span>toCode<span class="token punctuation">,</span> fromCode<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>cd <span class="token operator">==</span><span class="token punctuation">(</span>iconv_t<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 打开失败</span>
    <span class="token punctuation">{<!-- --></span>
        ir<span class="token punctuation">.</span>errorNumber <span class="token operator">=</span> errno<span class="token punctuation">;</span> <span class="token comment">// C -&gt; C++</span>

        <span class="token keyword">switch</span> <span class="token punctuation">(</span>ir<span class="token punctuation">.</span>errorNumber<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">case</span> EINVAL<span class="token operator">:</span>
            ir<span class="token punctuation">.</span>errorMessage <span class="token operator">=</span> <span class="token string">"不支持的编码"</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> ENOMEM<span class="token operator">:</span>
            ir<span class="token punctuation">.</span>errorMessage <span class="token operator">=</span> <span class="token string">"内存不足"</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            ir<span class="token punctuation">.</span>errorMessage <span class="token operator">=</span> <span class="token string">"未知错误"</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> ir<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">char</span><span class="token operator">*</span> inBufferPtr <span class="token operator">=</span> <span class="token generic-function"><span class="token function">const_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>in<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 指向输入缓存位置 （非常量）</span>
    size_t inBytesLeft <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输入缓存大小</span>

    std<span class="token double-colon punctuation">::</span>stringstream ss<span class="token punctuation">;</span>

    std<span class="token double-colon punctuation">::</span>size_t <span class="token keyword">const</span> sizeOfOutBuffer <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span> <span class="token comment">// 输出缓存区大小</span>
    <span class="token keyword">char</span> outBuffer<span class="token punctuation">[</span>sizeOfOutBuffer<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 输出缓存</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>inBytesLeft <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// 输入缓存中，还有剩余字符未被转换</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">char</span> <span class="token operator">*</span>outBufferPtr <span class="token operator">=</span> outBuffer<span class="token punctuation">;</span>
        size_t outBufferLeft <span class="token operator">=</span> sizeOfOutBuffer<span class="token punctuation">;</span>

        size_t result <span class="token operator">=</span> <span class="token function">iconv</span><span class="token punctuation">(</span>cd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>inBufferPtr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>inBytesLeft<span class="token punctuation">,</span> <span class="token operator">&amp;</span>outBufferPtr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>outBufferLeft<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token punctuation">(</span>size_t<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 转换停止了</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">auto</span> n <span class="token operator">=</span> errno<span class="token punctuation">;</span>

            <span class="token keyword">switch</span> <span class="token punctuation">(</span>n<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">case</span> E2BIG<span class="token operator">:</span> <span class="token comment">// 输出缓存区不够用了……</span>
                <span class="token punctuation">{<!-- --></span>                
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">case</span> EILSEQ<span class="token operator">:</span> 
                <span class="token punctuation">{<!-- --></span>
                    ir<span class="token punctuation">.</span>errorNumber <span class="token operator">=</span> n<span class="token punctuation">;</span>
                    ir<span class="token punctuation">.</span>errorMessage <span class="token operator">=</span> <span class="token string">"输入字符序列不符合指定编码规则"</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">case</span> EINVAL<span class="token operator">:</span>
                <span class="token punctuation">{<!-- --></span>
                    ir<span class="token punctuation">.</span>errorNumber <span class="token operator">=</span> n<span class="token punctuation">;</span>
                    ir<span class="token punctuation">.</span>errorMessage <span class="token operator">=</span> <span class="token string">"输入的字符序列不完整"</span><span class="token punctuation">;</span> 
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                
                <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token punctuation">{<!-- --></span>
                    ir<span class="token punctuation">.</span>errorNumber <span class="token operator">=</span> n<span class="token punctuation">;</span>
                    ir<span class="token punctuation">.</span>errorMessage <span class="token operator">=</span> <span class="token string">"转换过程发生未知错误"</span><span class="token punctuation">;</span>                
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>ir<span class="token punctuation">.</span>errorNumber <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// while</span>
        <span class="token punctuation">}</span>

        ss<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>outBuffer<span class="token punctuation">,</span> sizeOfOutBuffer <span class="token operator">-</span> outBufferLeft<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将本轮的输出结果，写入输出流</span>
    <span class="token punctuation">}</span> <span class="token comment">// while</span>

    <span class="token function">iconv_close</span><span class="token punctuation">(</span>cd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ir<span class="token punctuation">.</span>errorNumber <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        ir<span class="token punctuation">.</span>result <span class="token operator">=</span> ss<span class="token punctuation">.</span><span class="token function">str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> ir<span class="token punctuation">;</span>
<span class="token punctuation">}</span>       

<span class="token punctuation">}</span> <span class="token comment">//namespace d2::myiconv</span>
</code></pre>
    <p>
     使用示例：
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">char</span> <span class="token keyword">const</span><span class="token operator">*</span> gbk <span class="token operator">=</span> <span class="token string">"假设这是一个GBK编码的字符串"</span><span class="token punctuation">;</span>

<span class="token keyword">auto</span> ir <span class="token operator">=</span> d2<span class="token operator">:</span>myiconv<span class="token double-colon punctuation">::</span><span class="token function">Convert</span><span class="token punctuation">(</span>gbk<span class="token punctuation">,</span> <span class="token string">"GBK"</span><span class="token punctuation">,</span> <span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>ir<span class="token punctuation">.</span>errorNumber <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> ir<span class="token punctuation">.</span>errorNumber <span class="token operator">&lt;&lt;</span> <span class="token string">" : "</span> <span class="token operator">&lt;&lt;</span> ir<span class="token punctuation">.</span>errorMessage <span class="token operator">&lt;&lt;</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 转换成功：</span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> ir<span class="token punctuation">.</span>result <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
    <p>
     对应的 CMakeLists.txt 示例：
    </p>
    <pre><code class="prism language-cmake">cmake_minimum_required(VERSION 3.10.0)
project(HelloLibIconv VERSION 0.1.0 LANGUAGES C CXX)

add_executable(HelloLibIconv main.cpp gbk_str.cpp)

target_link_libraries(${PROJECT_NAME} PRIVATE iconv)
target_link_directories(${PROJECT_NAME} PRIVATE "c:/msys64/ucrt64/lib")
</code></pre>
    <p>
     其中的 gbk_str.cpp 在 VSCODE 中应明确使用 GBK 编码保存，其内容为：
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">char</span> <span class="token keyword">const</span><span class="token operator">*</span> gbk_str <span class="token operator">=</span> <span class="token string">"我是一个GBK字符编码的字符串！请保障我所在的CPP文件编码为GBK！"</span><span class="token punctuation">;</span> 
</code></pre>
    <h2>
     <a id="4___232">
     </a>
     4. 项目应用 🎥
    </h2>
    <p>
     上一节中 libfswatch 在监控 Windows 下名字带汉字的文件对象时，文件名输出会出现乱码。其原因于：libfswatch 从 Windows 读文件对象信息时，未使用特定的 UNICODE 版本的 API，而是使用 Windows 本地语言版 API，因此读到的文件名中的中文字符是 GBxxxx 编码（既中国国标），但 libfswatch 将它视为 UTF-8 编码。
    </p>
    <p>
     基于 libiconv，使用我们所包装的函数，解决乱码的核心代码是：
    </p>
    <pre><code class="prism language-cpp">        <span class="token comment">// 输出变动的文件路径：</span>
        <span class="token keyword">auto</span> utf8Path <span class="token operator">=</span> d2<span class="token double-colon punctuation">::</span>myiconv<span class="token double-colon punctuation">::</span><span class="token function">Convert</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">get_path</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"GBK"</span><span class="token punctuation">,</span> <span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 编码转换</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>utf8Path<span class="token punctuation">.</span>errorNumber <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> utf8Path<span class="token punctuation">.</span>errorMessage <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> utf8Path<span class="token punctuation">.</span>result <span class="token operator">&lt;&lt;</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     下面的视频给出了采用我们所写的 Convert() 的解决方案。
    </p>
    <p>
    </p>
    <div class="csdn-video-box" data-report-view='{"spm":"3001.10261","extra":{"id":"bah8VLZG-1741696837606"}}'>
     <iframe allowfullscreen="true" data-mediaembed="csdn" frameborder="0" id="bah8VLZG-1741696837606" src="https://live.csdn.net/v/embed/468317">
     </iframe>
     <p>
      006-libiconv编码转换-3项目应用-C++108杰
     </p>
    </div>
    <p>
    </p>
    <h2>
     <a id="5_C__254">
     </a>
     5. C++ 封装
    </h2>
    <p>
     d2::myiconv::Convert（）函数使用起来，比原来的纯C函数“三板斧”组合，要方便不少，但也有个比较明显的缺点：无法复用 iconv_open() 得到的句柄，每次转换都需要先打开最后再关闭。如果仅是一次性转换无所谓，但有时有多个字符串需要分开转换，句柄不能复用的弊端就比较明显了。
    </p>
    <p>
     解决方法是使用 C++ 面向对象的思想进一步加以封装，我们给出一种思路的类设计（仅 class 设计）：
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">namespace</span> d2<span class="token double-colon punctuation">::</span>myiconv
<span class="token punctuation">{<!-- --></span>

<span class="token comment">// 转换结果</span>
<span class="token keyword">struct</span> <span class="token class-name">IConvResult</span>
<span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>string result<span class="token punctuation">;</span> <span class="token comment">// 转换成功得到的，使用新编码的字符串</span>

    <span class="token keyword">int</span> errorNumber <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 对应 errno, 出错号</span>
    std<span class="token double-colon punctuation">::</span>string errorMessage<span class="token punctuation">;</span> <span class="token comment">// 出错信息</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">IconvHelper</span> <span class="token keyword">final</span> <span class="token comment">// 注：实现为 final 类</span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token comment">// 构造（失败时可抛出异常）</span>
    <span class="token function">IconvHelper</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token keyword">const</span><span class="token operator">*</span> fromCode<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token keyword">const</span><span class="token operator">*</span> toCode<span class="token punctuation">)</span> <span class="token keyword">noexcept</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   
    <span class="token function">IconvHelper</span><span class="token punctuation">(</span>IconvHelper <span class="token keyword">const</span><span class="token operator">&amp;</span> <span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span> <span class="token comment">// 不允许复制</span>
    IconvHelper<span class="token operator">&amp;</span> <span class="token keyword">operator</span> <span class="token operator">=</span> <span class="token punctuation">(</span>IconvHelper <span class="token keyword">const</span><span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>

    <span class="token function">IconvHelper</span><span class="token punctuation">(</span>IconvHelper<span class="token operator">&amp;&amp;</span> ih<span class="token punctuation">)</span> <span class="token keyword">noexcept</span><span class="token punctuation">;</span> <span class="token comment">// 支持转移</span>
    IconvHelper<span class="token operator">&amp;</span> <span class="token keyword">operator</span> <span class="token operator">=</span> <span class="token punctuation">(</span>IconvHelper<span class="token operator">&amp;&amp;</span> ih<span class="token punctuation">)</span> <span class="token keyword">noexcept</span><span class="token punctuation">;</span> 

    <span class="token operator">~</span><span class="token function">IconvHelper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">noexcept</span><span class="token punctuation">;</span> <span class="token comment">// 析构</span>

    <span class="token comment">// 静态转换，方便一次性转换 (不允许抛出异常)</span>
    <span class="token keyword">static</span> IConvResult <span class="token function">Convert</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>string_view in<span class="token punctuation">,</span>
                  <span class="token keyword">char</span> <span class="token keyword">const</span><span class="token operator">*</span> fromCode<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token keyword">const</span><span class="token operator">*</span> toCode<span class="token punctuation">)</span> <span class="token keyword">noexcept</span><span class="token punctuation">;</span>

    <span class="token comment">// 非静态的转换方法，方便多次复用 (不允许抛出异常)</span>
    IConvResult <span class="token function">Convert</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>string_view in<span class="token punctuation">)</span> <span class="token keyword">noexcept</span><span class="token punctuation">;</span>  

<span class="token keyword">private</span><span class="token operator">:</span>
    iconv_t cd<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span> <span class="token comment">//  namespace d2::myiconv</span>

</code></pre>
    <p>
     请进入
     <a href="https://www.d2school.com" rel="nofollow">
      d2school 网站
     </a>
     本课的作业区，完成符合上述类定义的 C++ 版本的 libiconv 封装，并及时交作业。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="687474:70733a2f2f626c6f672e6373646e2e6e65742f6e616e79752f:61727469636c652f64657461696c732f313436313838353535" class_="artid" style="display:none">
 </p>
</div>


