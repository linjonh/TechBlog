---
layout: post
title: "002-å‘Šåˆ«ä¹±ç -libiconv-Cå¼€æºåº“108æ°"
date: 2025-03-11 20:44:27 +0800
description: "1. ç†è§£ä¹±ç äº§ç”Ÿçš„åŸå› 2. æ‰‹æŠŠæ‰‹æ•™å­¦å¦‚ä½•å°è£… libiconv çš„è½¬æ¢æ“ä½œ3. å€ŸåŠ©å°è£…æˆæœï¼Œè§£å†³ fswatch åº“ç¤ºä¾‹é¡¹ç›®çš„ä¹±ç é—®é¢˜"
keywords: "002-å‘Šåˆ«ä¹±ç -libiconv-C++å¼€æºåº“108æ°"
categories: ['C']
tags: ['ç¼–ç è½¬æ¢', 'å¼€æºåº“', 'å­—ç¬¦é›†', 'ä¹±ç ', 'Unicode', 'Gbk', 'C']
artid: "146188555"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146188555
    alt: "002-å‘Šåˆ«ä¹±ç -libiconv-Cå¼€æºåº“108æ°"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146188555
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146188555
cover: https://bing.ee123.net/img/rand?artid=146188555
image: https://bing.ee123.net/img/rand?artid=146188555
img: https://bing.ee123.net/img/rand?artid=146188555
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     002-å‘Šåˆ«ä¹±ç -libiconv-C++å¼€æºåº“108æ°
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     æœ¬è¯¾æ–‡åŒ…å«ä¸‰ä¸ªè§†é¢‘ï¼
    </p>
    <blockquote>
     <p>
      ä¸ºä»€ä¹ˆä¸­æ–‡ç‰ˆWindowsæ˜¯ç¼–ç¨‹å‡ºç°ä¹±ç çš„é«˜å‘åœ°å¸¦ï¼Ÿæ€ä¹ˆç”¨ libiconv æŠŠå›½æ ‡ç¼–ç çš„æ±‰å­—è½¬æ¢æˆå®‡å®™ç»Ÿä¸€ç ï¼Ÿæ€ä¹ˆç®€åŒ– libiconv é‚£äº›å……æ»¡å‘çš„ çº¯C å‡½æ•°APIï¼Ÿ
     </p>
    </blockquote>
    <p>
     <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://i-blog.csdnimg.cn/img_convert/a72ff904dc6e06032d073e810b09211f.png#pic_center" width="220"/>
    </p>
    <h2>
     <a id="1__libiconv_7">
     </a>
     1. å®‰è£… libiconv
    </h2>
    <p>
     é€šå¸¸ï¼Œä½ åœ¨ MSYS2 ä¸­å®‰è£…è¿‡ GCC ç¼–è¯‘å¥—ä»¶ï¼Œä½ çš„ msys2 ç³»ç»Ÿä¸­å°±ä¼šæœ‰ libiconv å¼€å‘åº“å¯ç”¨ã€‚å¯é€šè¿‡å¦‚ä¸‹æŒ‡ä»¤éªŒè¯ï¼š
    </p>
    <pre><code class="prism language-shell">pacman <span class="token parameter variable">-S</span> libiconv
</code></pre>
    <p>
     æŸ¥çœ‹æ˜¯å¦å‡ºç°å¸¦æœ‰ â€œ[å·²å®‰è£…]â€ ï¼ˆæˆ– installedï¼‰çš„ libiconv åº“ï¼Ÿ
    </p>
    <p>
     å¦‚æœç¡®å®éœ€è¦å•ç‹¬å®‰è£…ï¼ŒæŒ‡ä»¤ä¸ºï¼š
    </p>
    <pre><code class="prism language-shell">pacman <span class="token parameter variable">-S</span> mingw-w64-ucrt-x86_64-libiconv 
</code></pre>
    <blockquote>
     <p>
      å†æ¬¡æé†’ï¼Œå¦‚æœä½ ä½¿ç”¨çš„ GCC ä¸æ˜¯ UCRT64 ç‰ˆæœ¬ï¼Œé‚£ä¹ˆä½ å¯èƒ½éœ€è¦çš„åº“åç§°åº”æ˜¯
      <code>
       mingw-w64-x86_64-libiconv
      </code>
      ï¼ˆ64ä½OSï¼‰æˆ–
      <code>
       mingw-w64-i686-libiconv
      </code>
      ï¼ˆ32ä½OSï¼Œä¸æ•¢ç›¸ä¿¡ä½ åœ¨è¿˜åœ¨ç”¨ï¼‰
     </p>
    </blockquote>
    <h2>
     <a id="2___23">
     </a>
     2. è½¬ç åŸºç¡€çŸ¥è¯† ğŸ¥
    </h2>
    <p>
     Windows ï¼ˆä¸­æ–‡ç‰ˆï¼‰æ˜¯ ç¼–ç¨‹å‡ºç°ä¹±ç çš„é«˜å‘åœ°å¸¦ä¹‹ä¸€ã€‚åŸå› æ¥è‡ªå†å²åŒ…è¢±ï¼šå½“å¹´ï¼Œå„å›½æ”¿åºœï¼ˆè‡ªç„¶åŒ…æ‹¬æˆ‘å›½ï¼‰éƒ½è¦æ±‚å¾®è½¯å‡ºçš„æœ¬åœ°è¯­è¨€ç‰ˆæœ¬çš„æ“ä½œç³»ç»Ÿï¼Œå…¶å­—ç¬¦ç¼–ç ï¼Œå¿…é¡»éµå®ˆå½“å¹´å„å›½å›½æ ‡ã€‚
    </p>
    <p>
    </p>
    <div class="video">
     <iframe allowfullscreen="true" data-mediaembed="csdn" frameborder="0" id="VEsk5KBh-1741696720303" src="https://live.csdn.net/v/embed/468315" style="width:100%;height:100%;">
     </iframe>
     <p>
      004-libiconvç¼–ç è½¬æ¢-1åŸºç¡€çŸ¥è¯†-c++108æ°
     </p>
    </div>
    <p>
    </p>
    <h2>
     <a id="3__30">
     </a>
     3. å‡½æ•°ä½¿ç”¨åŒ…è£…
    </h2>
    <h3>
     <a id="31__32">
     </a>
     3.1 ä¸»è¦å‡½æ•°ä»‹ç»
    </h3>
    <p>
     libiconv ä¸»è¦å‡½æ•°æœ‰ä¸‰ä¸ªï¼š
    </p>
    <ul>
     <li>
      iconv_open
     </li>
    </ul>
    <p>
     åŸå‹ï¼š
    </p>
    <pre><code class="prism language-cpp">iconv_t <span class="token function">iconv_open</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token keyword">const</span><span class="token operator">*</span> toCode<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token keyword">const</span> <span class="token operator">*</span> fromcode<span class="token punctuation">)</span>
</code></pre>
    <ul>
     <li>
      å…¶ä¸­, iconv_t ä¸º â€œvoid *â€ çš„åˆ«å
     </li>
     <li>
      å‡½æ•°å¤±è´¥æ—¶ï¼Œå¹¶ä¸è¿”å› nullptrï¼Œè€Œæ˜¯è¿”å› (iconv_t)(-1)
     </li>
     <li>
      å…¥å‚ä¾åºä¸ºï¼šç›®æ ‡ç¼–ç åç§°ï¼Œæºç¼–ç åç§°
     </li>
    </ul>
    <p>
     ä»¥ä¸‹ç§°è¯¥å‡½æ•°æ‰“å¼€æˆåŠŸå¾—åˆ°çš„ç»“æœä¸º â€œå¥æŸ„â€ã€‚
    </p>
    <ul>
     <li>
      iconv
     </li>
    </ul>
    <p>
     åŸå‹ï¼š
    </p>
    <pre><code class="prism language-cpp">size_t <span class="token function">iconv</span><span class="token punctuation">(</span> iconv_t cd<span class="token punctuation">,</span>
              <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> in<span class="token punctuation">,</span> size_t<span class="token operator">*</span> inBytesLeft<span class="token punctuation">,</span> 
              <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> out<span class="token punctuation">,</span> size_t<span class="token operator">*</span> outBytesLeft<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºå¥æŸ„ã€‚å…¶ä½™å››ä¸ªå‚æ•°éƒ½æ—¢ä¸ºå…¥å‚ä¹Ÿä¸ºå‡ºå‚ã€‚
    </p>
    <ol>
     <li>
      <p>
       inï¼šä½œå…¥å‚ï¼Œç”¨äºæŒ‡ç¤ºå½“å‰å¾…è½¬æ¢çš„æºå­—ç¬¦ä¸²ç¼“å­˜åŒºå¼€å§‹ä½ç½®ï¼›ä½œå‡ºå‚ï¼Œç”¨äºå‘Šè¯‰è°ƒç”¨è€…ï¼Œæœ¬æ¬¡è½¬æ¢çš„ç»“æŸä½ç½®ï¼ˆå³ä¸‹æ¬¡è½¬æ¢çš„å¼€å§‹ä½ç½®ï¼‰ï¼›
      </p>
     </li>
     <li>
      <p>
       inByteLeftï¼šä½œå…¥å‚ï¼ŒæŒ‡ç¤ºå½“å‰å¾…è½¬æ¢çš„æºå­—ç¬¦ä¸²ç¼“å­˜åŒºæœ‰å¤šå¤§ï¼›ä½œå‡ºå‚ï¼Œå‘Šè¯‰è°ƒç”¨è€…ï¼Œæœ¬æ¬¡è½¬æ¢åè¿˜å‰©ä¸‹å¤šå°‘å­—èŠ‚æœªè½¬æ¢ï¼›
      </p>
     </li>
     <li>
      <p>
       out: ä½œå…¥å‚ï¼Œç”¨äºæŒ‡ç¤ºå¯ç”¨äºå­˜å‚¨è½¬æ¢ç»“æœçš„ç¼“å­˜åŒºå¼€å§‹ä½ç½®ï¼›ä½œå‡ºå‚ï¼Œç”¨äºå‘Šè¯‰è°ƒç”¨è€…ï¼Œæœ¬æ¬¡è½¬æ¢åï¼Œç»“æœå­˜æ”¾çš„ç»“æŸä½ç½®ï¼ˆå¯è€ƒè™‘ä½œä¸ºä¸‹æ¬¡ç”¨äºå­˜å‚¨ç»“æœçš„å¼€å§‹ä½ç½®ï¼Œæœ¬è¯¾å ‚å‡ºäºç®€åŒ–ï¼Œæœªé‡‡ç”¨æ­¤æ–¹æ³•ï¼‰ï¼›
      </p>
     </li>
     <li>
      <p>
       outBytesLeft: ä½œå…¥å‚ï¼Œç”¨äºæŒ‡ç¤ºæœ¬æ¬¡è½¬æ¢å¯ç”¨æ¥å­˜å‚¨ç»“æœçš„ç¼“å­˜åŒºå¤§å°ï¼ˆå­—èŠ‚æ•°ï¼‰ï¼›ä½œå‡ºå‚ï¼Œç”¨äºå‘Šè¯‰è°ƒç”¨è€…ï¼Œæœ¬æ¬¡è½¬æ¢åï¼Œç”¨äºå­˜å‚¨ç»“æœçš„ç¼“å­˜åŒºè¿˜å‰©ä½™å¤šå°‘å­—èŠ‚ã€‚
      </p>
     </li>
    </ol>
    <p>
     in å’Œ out çš„å†…å®¹éƒ½æœ‰å¯èƒ½é€ æˆæœ¬å‡½æ•°è½¬æ¢ä¸­é€”åœä¸‹ã€‚æœ€å…¸å‹çš„å¦‚ï¼šout ï¼Œä¹Ÿå°±æ˜¯è¾“å‡ºç¼“å­˜åŒºå¤§å°ä¸å¤Ÿäº†ã€‚æ¯”å¦‚è¯´ï¼Œæºå­—ç¬¦ä¸²æœ‰ 61 å­—èŠ‚ï¼Œä½†ç›®æ ‡è¾“å‡ºç¼“å­˜åŒºï¼ˆä¹Ÿå°±æ˜¯ outï¼‰åªæœ‰20ä¸ªå­—èŠ‚ï¼Œå°±ä¼šé€ æˆ iconv() è½¬æ¢è‹¥å¹²å­—èŠ‚åï¼Œå°±åœä¸‹ï¼Œå¹¶å€ŸåŠ© errno ï¼ˆCåº“çš„ä¸€ä¸ªå®ï¼Œç±»ä¼¼å…¨å±€å˜é‡ï¼Œä½†æœ¬è´¨æ˜¯å¯¹åº”åˆ°ä¸€ä¸ªå‡½æ•°è°ƒç”¨ï¼Œä¸”çº¿ç¨‹å®‰å…¨ï¼‰ï¼Œå‘Šè¯‰è°ƒç”¨è€…ï¼šè¾“å‡ºç¼“å­˜åŒºä¸è¶³ã€‚
    </p>
    <blockquote>
     <p>
      æ³¨æ„ï¼Œç¼–ç è½¬æ¢å¹¶é 1:1 è½¬æ¢ï¼Œç”±äºæºç¼–ç å’Œç›®æ ‡ç¼–ç ç”¨ä»¥è¡¨è¾¾å•ä¸€ä¸ªæœ¬åœ°å­—ç¬¦ï¼ˆæ¯”å¦‚ä¸€ä¸ªæ±‰å­—ï¼‰çš„é•¿åº¦ä¸ä¸€æ ·ï¼Œå› æ­¤äºŒè€…ä¹‹é—´å¹¶ä¸å­˜åœ¨æŸä¸ªç®€å•çš„æ¯”ä¾‹å…³ç³»ã€‚å…¸å‹çš„å¦‚ä½¿ç”¨ UTF-8 ç¼–ç è¡¨è¾¾ä¸€ä¸ªæ±‰å­—ï¼Œå¯èƒ½æ˜¯ 2å­—èŠ‚ï¼Œä¹Ÿå¯èƒ½æ˜¯ 3å­—èŠ‚ã€4å­—èŠ‚ã€‚
     </p>
    </blockquote>
    <p>
     ä¸ºäº†é¿å… â€œè¾“å‡ºç¼“å­˜åŒºä¸è¶³â€ ï¼Œæœ€ç²—æš´çš„æ–¹æ³•å°±æ˜¯ä¸º out åˆ†é…ä¸€ä¸ª â€œå·¨å¤§â€ çš„ç©ºé—´â€”â€”æ¯”å¦‚ï¼Œæ˜¯æºå­—ç¬¦ä¸²é•¿åº¦çš„ 4 å€ã€5 å€â€¦â€¦è¿™ç§æ–¹æ³•æ—¢æµªè´¹å†…å­˜ï¼Œå¹¶ä¸”é€šå¸¸éœ€è¦ä½¿ç”¨åˆ° new æ¥åŠ¨æ€åˆ†é…å†…å­˜ï¼Œè¿›ä¸€æ­¥æ‹‰ä½æ€§èƒ½ã€‚
    </p>
    <p>
     æˆ‘ä»¬çš„è§£å†³æ–¹æ³•ç›¸å¯¹å¤æ‚ï¼Œä½†é«˜æ•ˆï¼ˆæˆ–è€…è¯´æ€§èƒ½å‡è¡¡ï¼‰ï¼šé‡‡ç”¨å›ºå®šå¤§å°çš„ä¸´æ—¶è¿ç»­å†…å­˜æ¥å­˜å‚¨æ¯æ¬¡è½¬æ¢çš„ç»“æœï¼ŒåŒæ—¶å‡†å¤‡ä¸€ä¸ªå­—ç¬¦ä¸²æµï¼ˆstd::stringstreamï¼‰æ¥è¿ç»­å­˜å‚¨æ¯æ¬¡è½¬æ¢çš„ç»“æœï¼ˆæ–°ç»“æœè¿½åŠ åˆ°æ—§ç»“æœä¹‹åï¼‰ã€‚
    </p>
    <h3>
     <a id="32___75">
     </a>
     3.2 å‡½æ•°ç®€åŒ–å°è£… ğŸ¥
    </h3>
    <p>
    </p>
    <div class="csdn-video-box" data-report-view='{"spm":"3001.10261","extra":{"id":"73JeVP9f-1741696756026"}}'>
     <iframe allowfullscreen="true" data-mediaembed="csdn" frameborder="0" id="73JeVP9f-1741696756026" src="https://live.csdn.net/v/embed/468316">
     </iframe>
     <p>
      005-libiconvç¼–ç è½¬æ¢-2ç®€åŒ–å‡½æ•°-C++108æ°
     </p>
    </div>
    <p>
    </p>
    <h3>
     <a id="33__79">
     </a>
     3.3 å‡½æ•°å°è£…ä¸»è¦ä»£ç 
    </h3>
    <pre><code class="prism language-cpp"><span class="token keyword">namespace</span> d2<span class="token double-colon punctuation">::</span>myiconv
<span class="token punctuation">{<!-- --></span>

<span class="token comment">// è½¬æ¢ç»“æ„</span>
<span class="token keyword">struct</span> <span class="token class-name">IConvResult</span>
<span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>string result<span class="token punctuation">;</span> <span class="token comment">// è½¬æ¢æˆåŠŸå¾—åˆ°çš„ï¼Œä½¿ç”¨æ–°ç¼–ç çš„å­—ç¬¦ä¸²</span>

    <span class="token keyword">int</span> errorNumber <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// å¯¹åº” errno, å‡ºé”™å·</span>
    std<span class="token double-colon punctuation">::</span>string errorMessage<span class="token punctuation">;</span> <span class="token comment">// å‡ºé”™ä¿¡æ¯</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// è½¬æ¢å‡½æ•°</span>
IConvResult <span class="token function">Convert</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>string_view in<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token keyword">const</span><span class="token operator">*</span> fromCode<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token keyword">const</span><span class="token operator">*</span> toCode<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>

IConvResult <span class="token function">Convert</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>string_view in<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token keyword">const</span><span class="token operator">*</span> fromCode<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token keyword">const</span><span class="token operator">*</span> toCode<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    IConvResult ir<span class="token punctuation">;</span>

    <span class="token comment">// è°ƒç”¨ iconv_open</span>
    iconv_t cd <span class="token operator">=</span> <span class="token function">iconv_open</span><span class="token punctuation">(</span>toCode<span class="token punctuation">,</span> fromCode<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>cd <span class="token operator">==</span><span class="token punctuation">(</span>iconv_t<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// æ‰“å¼€å¤±è´¥</span>
    <span class="token punctuation">{<!-- --></span>
        ir<span class="token punctuation">.</span>errorNumber <span class="token operator">=</span> errno<span class="token punctuation">;</span> <span class="token comment">// C -&gt; C++</span>

        <span class="token keyword">switch</span> <span class="token punctuation">(</span>ir<span class="token punctuation">.</span>errorNumber<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">case</span> EINVAL<span class="token operator">:</span>
            ir<span class="token punctuation">.</span>errorMessage <span class="token operator">=</span> <span class="token string">"ä¸æ”¯æŒçš„ç¼–ç "</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> ENOMEM<span class="token operator">:</span>
            ir<span class="token punctuation">.</span>errorMessage <span class="token operator">=</span> <span class="token string">"å†…å­˜ä¸è¶³"</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            ir<span class="token punctuation">.</span>errorMessage <span class="token operator">=</span> <span class="token string">"æœªçŸ¥é”™è¯¯"</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> ir<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">char</span><span class="token operator">*</span> inBufferPtr <span class="token operator">=</span> <span class="token generic-function"><span class="token function">const_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>in<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æŒ‡å‘è¾“å…¥ç¼“å­˜ä½ç½® ï¼ˆéå¸¸é‡ï¼‰</span>
    size_t inBytesLeft <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// è¾“å…¥ç¼“å­˜å¤§å°</span>

    std<span class="token double-colon punctuation">::</span>stringstream ss<span class="token punctuation">;</span>

    std<span class="token double-colon punctuation">::</span>size_t <span class="token keyword">const</span> sizeOfOutBuffer <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span> <span class="token comment">// è¾“å‡ºç¼“å­˜åŒºå¤§å°</span>
    <span class="token keyword">char</span> outBuffer<span class="token punctuation">[</span>sizeOfOutBuffer<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// è¾“å‡ºç¼“å­˜</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>inBytesLeft <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// è¾“å…¥ç¼“å­˜ä¸­ï¼Œè¿˜æœ‰å‰©ä½™å­—ç¬¦æœªè¢«è½¬æ¢</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">char</span> <span class="token operator">*</span>outBufferPtr <span class="token operator">=</span> outBuffer<span class="token punctuation">;</span>
        size_t outBufferLeft <span class="token operator">=</span> sizeOfOutBuffer<span class="token punctuation">;</span>

        size_t result <span class="token operator">=</span> <span class="token function">iconv</span><span class="token punctuation">(</span>cd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>inBufferPtr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>inBytesLeft<span class="token punctuation">,</span> <span class="token operator">&amp;</span>outBufferPtr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>outBufferLeft<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token punctuation">(</span>size_t<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// è½¬æ¢åœæ­¢äº†</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">auto</span> n <span class="token operator">=</span> errno<span class="token punctuation">;</span>

            <span class="token keyword">switch</span> <span class="token punctuation">(</span>n<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">case</span> E2BIG<span class="token operator">:</span> <span class="token comment">// è¾“å‡ºç¼“å­˜åŒºä¸å¤Ÿç”¨äº†â€¦â€¦</span>
                <span class="token punctuation">{<!-- --></span>                
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">case</span> EILSEQ<span class="token operator">:</span> 
                <span class="token punctuation">{<!-- --></span>
                    ir<span class="token punctuation">.</span>errorNumber <span class="token operator">=</span> n<span class="token punctuation">;</span>
                    ir<span class="token punctuation">.</span>errorMessage <span class="token operator">=</span> <span class="token string">"è¾“å…¥å­—ç¬¦åºåˆ—ä¸ç¬¦åˆæŒ‡å®šç¼–ç è§„åˆ™"</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">case</span> EINVAL<span class="token operator">:</span>
                <span class="token punctuation">{<!-- --></span>
                    ir<span class="token punctuation">.</span>errorNumber <span class="token operator">=</span> n<span class="token punctuation">;</span>
                    ir<span class="token punctuation">.</span>errorMessage <span class="token operator">=</span> <span class="token string">"è¾“å…¥çš„å­—ç¬¦åºåˆ—ä¸å®Œæ•´"</span><span class="token punctuation">;</span> 
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                
                <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token punctuation">{<!-- --></span>
                    ir<span class="token punctuation">.</span>errorNumber <span class="token operator">=</span> n<span class="token punctuation">;</span>
                    ir<span class="token punctuation">.</span>errorMessage <span class="token operator">=</span> <span class="token string">"è½¬æ¢è¿‡ç¨‹å‘ç”ŸæœªçŸ¥é”™è¯¯"</span><span class="token punctuation">;</span>                
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>ir<span class="token punctuation">.</span>errorNumber <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// while</span>
        <span class="token punctuation">}</span>

        ss<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>outBuffer<span class="token punctuation">,</span> sizeOfOutBuffer <span class="token operator">-</span> outBufferLeft<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å°†æœ¬è½®çš„è¾“å‡ºç»“æœï¼Œå†™å…¥è¾“å‡ºæµ</span>
    <span class="token punctuation">}</span> <span class="token comment">// while</span>

    <span class="token function">iconv_close</span><span class="token punctuation">(</span>cd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ir<span class="token punctuation">.</span>errorNumber <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        ir<span class="token punctuation">.</span>result <span class="token operator">=</span> ss<span class="token punctuation">.</span><span class="token function">str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> ir<span class="token punctuation">;</span>
<span class="token punctuation">}</span>       

<span class="token punctuation">}</span> <span class="token comment">//namespace d2::myiconv</span>
</code></pre>
    <p>
     ä½¿ç”¨ç¤ºä¾‹ï¼š
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">char</span> <span class="token keyword">const</span><span class="token operator">*</span> gbk <span class="token operator">=</span> <span class="token string">"å‡è®¾è¿™æ˜¯ä¸€ä¸ªGBKç¼–ç çš„å­—ç¬¦ä¸²"</span><span class="token punctuation">;</span>

<span class="token keyword">auto</span> ir <span class="token operator">=</span> d2<span class="token operator">:</span>myiconv<span class="token double-colon punctuation">::</span><span class="token function">Convert</span><span class="token punctuation">(</span>gbk<span class="token punctuation">,</span> <span class="token string">"GBK"</span><span class="token punctuation">,</span> <span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>ir<span class="token punctuation">.</span>errorNumber <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> ir<span class="token punctuation">.</span>errorNumber <span class="token operator">&lt;&lt;</span> <span class="token string">" : "</span> <span class="token operator">&lt;&lt;</span> ir<span class="token punctuation">.</span>errorMessage <span class="token operator">&lt;&lt;</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// è½¬æ¢æˆåŠŸï¼š</span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> ir<span class="token punctuation">.</span>result <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
    <p>
     å¯¹åº”çš„ CMakeLists.txt ç¤ºä¾‹ï¼š
    </p>
    <pre><code class="prism language-cmake">cmake_minimum_required(VERSION 3.10.0)
project(HelloLibIconv VERSION 0.1.0 LANGUAGES C CXX)

add_executable(HelloLibIconv main.cpp gbk_str.cpp)

target_link_libraries(${PROJECT_NAME} PRIVATE iconv)
target_link_directories(${PROJECT_NAME} PRIVATE "c:/msys64/ucrt64/lib")
</code></pre>
    <p>
     å…¶ä¸­çš„ gbk_str.cpp åœ¨ VSCODE ä¸­åº”æ˜ç¡®ä½¿ç”¨ GBK ç¼–ç ä¿å­˜ï¼Œå…¶å†…å®¹ä¸ºï¼š
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">char</span> <span class="token keyword">const</span><span class="token operator">*</span> gbk_str <span class="token operator">=</span> <span class="token string">"æˆ‘æ˜¯ä¸€ä¸ªGBKå­—ç¬¦ç¼–ç çš„å­—ç¬¦ä¸²ï¼è¯·ä¿éšœæˆ‘æ‰€åœ¨çš„CPPæ–‡ä»¶ç¼–ç ä¸ºGBKï¼"</span><span class="token punctuation">;</span> 
</code></pre>
    <h2>
     <a id="4___232">
     </a>
     4. é¡¹ç›®åº”ç”¨ ğŸ¥
    </h2>
    <p>
     ä¸Šä¸€èŠ‚ä¸­ libfswatch åœ¨ç›‘æ§ Windows ä¸‹åå­—å¸¦æ±‰å­—çš„æ–‡ä»¶å¯¹è±¡æ—¶ï¼Œæ–‡ä»¶åè¾“å‡ºä¼šå‡ºç°ä¹±ç ã€‚å…¶åŸå› äºï¼šlibfswatch ä» Windows è¯»æ–‡ä»¶å¯¹è±¡ä¿¡æ¯æ—¶ï¼Œæœªä½¿ç”¨ç‰¹å®šçš„ UNICODE ç‰ˆæœ¬çš„ APIï¼Œè€Œæ˜¯ä½¿ç”¨ Windows æœ¬åœ°è¯­è¨€ç‰ˆ APIï¼Œå› æ­¤è¯»åˆ°çš„æ–‡ä»¶åä¸­çš„ä¸­æ–‡å­—ç¬¦æ˜¯ GBxxxx ç¼–ç ï¼ˆæ—¢ä¸­å›½å›½æ ‡ï¼‰ï¼Œä½† libfswatch å°†å®ƒè§†ä¸º UTF-8 ç¼–ç ã€‚
    </p>
    <p>
     åŸºäº libiconvï¼Œä½¿ç”¨æˆ‘ä»¬æ‰€åŒ…è£…çš„å‡½æ•°ï¼Œè§£å†³ä¹±ç çš„æ ¸å¿ƒä»£ç æ˜¯ï¼š
    </p>
    <pre><code class="prism language-cpp">        <span class="token comment">// è¾“å‡ºå˜åŠ¨çš„æ–‡ä»¶è·¯å¾„ï¼š</span>
        <span class="token keyword">auto</span> utf8Path <span class="token operator">=</span> d2<span class="token double-colon punctuation">::</span>myiconv<span class="token double-colon punctuation">::</span><span class="token function">Convert</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">get_path</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"GBK"</span><span class="token punctuation">,</span> <span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ç¼–ç è½¬æ¢</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>utf8Path<span class="token punctuation">.</span>errorNumber <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> utf8Path<span class="token punctuation">.</span>errorMessage <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> utf8Path<span class="token punctuation">.</span>result <span class="token operator">&lt;&lt;</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     ä¸‹é¢çš„è§†é¢‘ç»™å‡ºäº†é‡‡ç”¨æˆ‘ä»¬æ‰€å†™çš„ Convert() çš„è§£å†³æ–¹æ¡ˆã€‚
    </p>
    <p>
    </p>
    <div class="csdn-video-box" data-report-view='{"spm":"3001.10261","extra":{"id":"bah8VLZG-1741696837606"}}'>
     <iframe allowfullscreen="true" data-mediaembed="csdn" frameborder="0" id="bah8VLZG-1741696837606" src="https://live.csdn.net/v/embed/468317">
     </iframe>
     <p>
      006-libiconvç¼–ç è½¬æ¢-3é¡¹ç›®åº”ç”¨-C++108æ°
     </p>
    </div>
    <p>
    </p>
    <h2>
     <a id="5_C__254">
     </a>
     5. C++ å°è£…
    </h2>
    <p>
     d2::myiconv::Convertï¼ˆï¼‰å‡½æ•°ä½¿ç”¨èµ·æ¥ï¼Œæ¯”åŸæ¥çš„çº¯Cå‡½æ•°â€œä¸‰æ¿æ–§â€ç»„åˆï¼Œè¦æ–¹ä¾¿ä¸å°‘ï¼Œä½†ä¹Ÿæœ‰ä¸ªæ¯”è¾ƒæ˜æ˜¾çš„ç¼ºç‚¹ï¼šæ— æ³•å¤ç”¨ iconv_open() å¾—åˆ°çš„å¥æŸ„ï¼Œæ¯æ¬¡è½¬æ¢éƒ½éœ€è¦å…ˆæ‰“å¼€æœ€åå†å…³é—­ã€‚å¦‚æœä»…æ˜¯ä¸€æ¬¡æ€§è½¬æ¢æ— æ‰€è°“ï¼Œä½†æœ‰æ—¶æœ‰å¤šä¸ªå­—ç¬¦ä¸²éœ€è¦åˆ†å¼€è½¬æ¢ï¼Œå¥æŸ„ä¸èƒ½å¤ç”¨çš„å¼Šç«¯å°±æ¯”è¾ƒæ˜æ˜¾äº†ã€‚
    </p>
    <p>
     è§£å†³æ–¹æ³•æ˜¯ä½¿ç”¨ C++ é¢å‘å¯¹è±¡çš„æ€æƒ³è¿›ä¸€æ­¥åŠ ä»¥å°è£…ï¼Œæˆ‘ä»¬ç»™å‡ºä¸€ç§æ€è·¯çš„ç±»è®¾è®¡ï¼ˆä»… class è®¾è®¡ï¼‰ï¼š
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">namespace</span> d2<span class="token double-colon punctuation">::</span>myiconv
<span class="token punctuation">{<!-- --></span>

<span class="token comment">// è½¬æ¢ç»“æœ</span>
<span class="token keyword">struct</span> <span class="token class-name">IConvResult</span>
<span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>string result<span class="token punctuation">;</span> <span class="token comment">// è½¬æ¢æˆåŠŸå¾—åˆ°çš„ï¼Œä½¿ç”¨æ–°ç¼–ç çš„å­—ç¬¦ä¸²</span>

    <span class="token keyword">int</span> errorNumber <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// å¯¹åº” errno, å‡ºé”™å·</span>
    std<span class="token double-colon punctuation">::</span>string errorMessage<span class="token punctuation">;</span> <span class="token comment">// å‡ºé”™ä¿¡æ¯</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">IconvHelper</span> <span class="token keyword">final</span> <span class="token comment">// æ³¨ï¼šå®ç°ä¸º final ç±»</span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token comment">// æ„é€ ï¼ˆå¤±è´¥æ—¶å¯æŠ›å‡ºå¼‚å¸¸ï¼‰</span>
    <span class="token function">IconvHelper</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token keyword">const</span><span class="token operator">*</span> fromCode<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token keyword">const</span><span class="token operator">*</span> toCode<span class="token punctuation">)</span> <span class="token keyword">noexcept</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   
    <span class="token function">IconvHelper</span><span class="token punctuation">(</span>IconvHelper <span class="token keyword">const</span><span class="token operator">&amp;</span> <span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span> <span class="token comment">// ä¸å…è®¸å¤åˆ¶</span>
    IconvHelper<span class="token operator">&amp;</span> <span class="token keyword">operator</span> <span class="token operator">=</span> <span class="token punctuation">(</span>IconvHelper <span class="token keyword">const</span><span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>

    <span class="token function">IconvHelper</span><span class="token punctuation">(</span>IconvHelper<span class="token operator">&amp;&amp;</span> ih<span class="token punctuation">)</span> <span class="token keyword">noexcept</span><span class="token punctuation">;</span> <span class="token comment">// æ”¯æŒè½¬ç§»</span>
    IconvHelper<span class="token operator">&amp;</span> <span class="token keyword">operator</span> <span class="token operator">=</span> <span class="token punctuation">(</span>IconvHelper<span class="token operator">&amp;&amp;</span> ih<span class="token punctuation">)</span> <span class="token keyword">noexcept</span><span class="token punctuation">;</span> 

    <span class="token operator">~</span><span class="token function">IconvHelper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">noexcept</span><span class="token punctuation">;</span> <span class="token comment">// ææ„</span>

    <span class="token comment">// é™æ€è½¬æ¢ï¼Œæ–¹ä¾¿ä¸€æ¬¡æ€§è½¬æ¢ (ä¸å…è®¸æŠ›å‡ºå¼‚å¸¸)</span>
    <span class="token keyword">static</span> IConvResult <span class="token function">Convert</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>string_view in<span class="token punctuation">,</span>
                  <span class="token keyword">char</span> <span class="token keyword">const</span><span class="token operator">*</span> fromCode<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token keyword">const</span><span class="token operator">*</span> toCode<span class="token punctuation">)</span> <span class="token keyword">noexcept</span><span class="token punctuation">;</span>

    <span class="token comment">// éé™æ€çš„è½¬æ¢æ–¹æ³•ï¼Œæ–¹ä¾¿å¤šæ¬¡å¤ç”¨ (ä¸å…è®¸æŠ›å‡ºå¼‚å¸¸)</span>
    IConvResult <span class="token function">Convert</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>string_view in<span class="token punctuation">)</span> <span class="token keyword">noexcept</span><span class="token punctuation">;</span>  

<span class="token keyword">private</span><span class="token operator">:</span>
    iconv_t cd<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span> <span class="token comment">//  namespace d2::myiconv</span>

</code></pre>
    <p>
     è¯·è¿›å…¥
     <a href="https://www.d2school.com" rel="nofollow">
      d2school ç½‘ç«™
     </a>
     æœ¬è¯¾çš„ä½œä¸šåŒºï¼Œå®Œæˆç¬¦åˆä¸Šè¿°ç±»å®šä¹‰çš„ C++ ç‰ˆæœ¬çš„ libiconv å°è£…ï¼Œå¹¶åŠæ—¶äº¤ä½œä¸šã€‚
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="687474:70733a2f2f626c6f672e6373646e2e6e65742f6e616e79752f:61727469636c652f64657461696c732f313436313838353535" class_="artid" style="display:none">
 </p>
</div>


