---
layout: post
title: "用IdleHandler来性能优化及原理源码分析"
date: 2025-03-06 21:41:57 +0800
description: "因此，在 UI 主线程相对繁忙时，通过 IdleHandler 来分摊任务，可以让系统先处理用户的核心交互，就比如onCreate是生命周期方法，如理里面初始化太多东西影响冷启动速度，针对一些可以延后不那么紧急任务可以待系统空闲时再处理任务，充分利用 CPU 空闲时间。它允许开发者在主线程处于空闲时，执行一些低优先级的任务。3、如果IdleHandler的queueIdle返回false则会从mIdleHandlers删除，下次空闲就不会在执行这个IdleHandler，否则true的话会每次空闲都执行。"
keywords: "用IdleHandler来性能优化及原理源码分析"
categories: ['性能优化']
tags: ['性能优化', '安卓窗口系统', '安卓Framework开发', 'Queueidle', 'Idlehandler', 'Framework', 'Android']
artid: "146072811"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146072811
    alt: "用IdleHandler来性能优化及原理源码分析"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146072811
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146072811
cover: https://bing.ee123.net/img/rand?artid=146072811
image: https://bing.ee123.net/img/rand?artid=146072811
img: https://bing.ee123.net/img/rand?artid=146072811
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     用IdleHandler来性能优化及原理源码分析
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h3>
     <a id="_0">
     </a>
     背景：
    </h3>
    <p>
     经常在做一些app冷启动速度优化等性能优化工作时候，经常可能会发现有时候需要引入一些第三方sdk，或者库，这些库一般会要求我们在onCreate中进行初始化等，但是onCreate属于生命周期的回调方法，如果onCreate中业务过多就会影响整个app的冷启动时长，很多人这个时候第一想到可能是放入子线程等，但是经常又发现有的调用还要求在主线程调用等限制，所以针对这种情况下就经常会使用到一个IdleHandler，这个当初使用时候大家可能就只是字面意思理解为空闲的Handler，在空闲时候执行，其实没有深入去看看它到底实现原理是什么，今天刚好有机会就来给大家进行一个剖析。
    </p>
    <h3>
     <a id="IdleHandler__3">
     </a>
     IdleHandler 的概念
    </h3>
    <p>
     IdleHandler 是 MessageQueue 提供的一个接口，用于监听消息队列的空闲状态。它允许开发者在主线程处于空闲时，执行一些低优先级的任务。IdleHandler 的核心方法 queueIdle() 会在系统检测到消息队列空闲时调用。返回值决定了 IdleHandler 是否继续在队列中保留：若返回 true，则该回调在下次队列空闲时继续执行；反之，返回 false 则表示仅执行一次后移除。
    </p>
    <h3>
     <a id="IdleHandler__7">
     </a>
     IdleHandler 和性能优化
    </h3>
    <p>
     IdleHandler 的出现正好迎合了性能优化的需求。在实际开发中，有一些任务并非必须实时完成，例如日志上报、资源预加载、缓存清理、数据统计、一些动画或预渲染任务等。利用 IdleHandler，可以将这些不紧急的任务推迟到主线程消息队列空闲时再执行，从而避免干扰用户看到的实时界面更新，提高整体界面流畅度和响应速度。因此，在 UI 主线程相对繁忙时，通过 IdleHandler 来分摊任务，可以让系统先处理用户的核心交互，就比如onCreate是生命周期方法，如理里面初始化太多东西影响冷启动速度，针对一些可以延后不那么紧急任务可以待系统空闲时再处理任务，充分利用 CPU 空闲时间。
    </p>
    <h3>
     <a id="IdleHandler_11">
     </a>
     源码分析IdleHandler
    </h3>
    <p>
     为了更加全面了解IdleHandler，下面将要从以下几个部分进行IdleHandler的源码分析。
     <br/>
     1、
     <br/>
     <strong>
      IdleHandler的接口解释：
     </strong>
     <br/>
     frameworks/base/core/java/android/os/MessageQueue.java
    </p>
    <pre><code class="prism language-cpp">    <span class="token comment">/**
     * Callback interface for discovering when a thread is going to block
     * waiting for more messages.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> interface IdleHandler <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/**
         * Called when the message queue has run out of messages and will now
         * wait for more.  Return true to keep your idle handler active, false
         * to have it removed.  This may be called if there are still messages
         * pending in the queue, but they are all scheduled to be dispatched
         * after the current time.
         */</span>
        boolean <span class="token function">queueIdle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
    <p>
     上面注释就可以看出来，这个IdleHandler属于一个回调接口，这个接口在线程即将要阻塞等待更多消息时候会被调用。
     <br/>
     queueIdle就是对应的回调函数，这个queueIdle有一个返回值true或false，这两个值分别有如下区别：
     <br/>
     如果返回true意味着下一次空闲依旧会执行这个IdleHandler的回调函数。
     <br/>
     如果返回false就代表当前IdleHandler已经执行完毕，下次空闲不会再执行该IdleHandler。
    </p>
    <p>
     <strong>
      添加IdleHandler接口
     </strong>
    </p>
    <pre><code class="prism language-cpp">    <span class="token comment">/**
     * Add a new {@link IdleHandler} to this message queue.  This may be
     * removed automatically for you by returning false from
     * {@link IdleHandler#queueIdle IdleHandler.queueIdle()} when it is
     * invoked, or explicitly removing it with {@link #removeIdleHandler}.
     *
     * &lt;p&gt;This method is safe to call from any thread.
     *
     * @param handler The IdleHandler to be added.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addIdleHandler</span><span class="token punctuation">(</span>@NonNull IdleHandler handler<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>handler <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token function">NullPointerException</span><span class="token punctuation">(</span><span class="token string">"Can't add a null IdleHandler"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
           <span class="token comment">//这里其实就是加入到mIdleHandlers这个集合中</span>
            mIdleHandlers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
    <p>
     这里的addIdleHandler添加就是简单加入的mIdleHandlers这个集合中，方便后面执行时候进行遍历
    </p>
    <p>
     <strong>
      IdleHandler的触发执行
     </strong>
    </p>
    <pre><code class="prism language-cpp">    @UnsupportedAppUsage
    Message <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> pendingIdleHandlerCount <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// -1 only during first iteration</span>
        <span class="token keyword">int</span> nextPollTimeoutMillis <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
           <span class="token comment">//进入等待消息，要被唤醒2种情况，1被其他函数wake，2等待时间nextPollTimeoutMillis到</span>
            <span class="token function">nativePollOnce</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> nextPollTimeoutMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token function">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// Try to retrieve the next message.  Return if found.</span>
                <span class="token keyword">final</span> <span class="token keyword">long</span> now <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Message prevMsg <span class="token operator">=</span> null<span class="token punctuation">;</span>
                Message msg <span class="token operator">=</span> mMessages<span class="token punctuation">;</span>
                <span class="token comment">//当消息的Handler为空时，则查询异步消息</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> msg<span class="token punctuation">.</span>target <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// Stalled by a barrier.  Find the next asynchronous message in the queue.</span>
                     <span class="token comment">//当查询到异步消息，则立刻退出循环</span>
                    <span class="token keyword">do</span> <span class="token punctuation">{<!-- --></span>
                        prevMsg <span class="token operator">=</span> msg<span class="token punctuation">;</span>
                        msg <span class="token operator">=</span> msg<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>msg <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>msg<span class="token punctuation">.</span><span class="token function">isAsynchronous</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
               	 <span class="token comment">//检测msg时间是还没到了</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">&lt;</span> msg<span class="token punctuation">.</span>when<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">// Next message is not ready.  Set a timeout to wake up when it is ready.</span>
                        <span class="token comment">//还没到msg的处理时间，那么就会与当前时间进行差值，这个差值就是等待时间nextPollTimeoutMillis</span>
                        nextPollTimeoutMillis <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>when <span class="token operator">-</span> now<span class="token punctuation">,</span> Integer<span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">// Got a message.</span>
                        mBlocked <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>prevMsg <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            prevMsg<span class="token punctuation">.</span>next <span class="token operator">=</span> msg<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">//设置下一个消息为mMessages</span>
                            mMessages <span class="token operator">=</span> msg<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        msg<span class="token punctuation">.</span>next <span class="token operator">=</span> null<span class="token punctuation">;</span>
                        msg<span class="token punctuation">.</span><span class="token function">markInUse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">//直接return回去消息，也就是有消息都在这里return了不会执行下面业务</span>
                        <span class="token keyword">return</span> msg<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//没有找到消息</span>
                    <span class="token comment">// No more messages.</span>
                    nextPollTimeoutMillis <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// If first time idle, then get the number of idlers to run.</span>
                <span class="token comment">// Idle handles only run if the queue is empty or if the first message</span>
                <span class="token comment">// in the queue (possibly a barrier) is due to be handled in the future.</span>
                <span class="token comment">//找了一圈发现没有要处理的消息了，那么就开始判断是否有IdleHandler的消息要处理</span>
                <span class="token comment">//注意这里的pendingIdleHandlerCount第一次进入才是-1，后续一旦执行IdleHandler都是变成0，不会再进入</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>pendingIdleHandlerCount <span class="token operator">&lt;</span> <span class="token number">0</span>
                        <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>mMessages <span class="token operator">==</span> null <span class="token operator">||</span> now <span class="token operator">&lt;</span> mMessages<span class="token punctuation">.</span>when<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//把mIdleHandlers集合大小赋值给pendingIdleHandlerCount</span>
                    pendingIdleHandlerCount <span class="token operator">=</span> mIdleHandlers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//如果发现没有IdleHandler，那么就返回循环进行block阻塞等待唤醒</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>pendingIdleHandlerCount <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// No idle handlers to run.  Loop and wait some more.</span>
                    mBlocked <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
							<span class="token comment">//如果mPendingIdleHandlers这个数组没有初始化就进行初始化，这里最小大小为4应该是为了性能以防频繁扩容</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mPendingIdleHandlers <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    mPendingIdleHandlers <span class="token operator">=</span> <span class="token keyword">new</span> IdleHandler<span class="token punctuation">[</span>Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>pendingIdleHandlerCount<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//mIdleHandlers转成了数组mPendingIdleHandlers</span>
                mPendingIdleHandlers <span class="token operator">=</span> mIdleHandlers<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span>mPendingIdleHandlers<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// Run the idle handlers.</span>
            <span class="token comment">// We only ever reach this code block during the first iteration.</span>
            <span class="token comment">//开始正式执行对应的IdleHandler</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> pendingIdleHandlerCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">final</span> IdleHandler idler <span class="token operator">=</span> mPendingIdleHandlers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                mPendingIdleHandlers<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> null<span class="token punctuation">;</span> <span class="token comment">// release the reference to the handler</span>

                boolean keep <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//执行IdleHandler的对应回调业务方法</span>
                    keep <span class="token operator">=</span> idler<span class="token punctuation">.</span><span class="token function">queueIdle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>Throwable t<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    Log<span class="token punctuation">.</span><span class="token function">wtf</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"IdleHandler threw exception"</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
								<span class="token comment">//这里的keep就是queueIdle的返回值，如果返回false就会从mIdleHandlers进行移除</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>keep<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        mIdleHandlers<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>idler<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
						<span class="token comment">//把pendingIdleHandlerCount变成0，不是-1，这样防止死循环执行IdleHandler</span>
            <span class="token comment">// Reset the idle handler count to 0 so we do not run them again.</span>
            pendingIdleHandlerCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
					<span class="token comment">//这里是为了让尽快遍历一下是否有消息，因为可能执行IdleHandler期间有新消息</span>
            <span class="token comment">// While calling an idle handler, a new message could have been delivered</span>
            <span class="token comment">// so go back and look again for a pending message without waiting.</span>
            nextPollTimeoutMillis <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
    <p>
     上面next方法，关于IdleHandler执行总结如下：
     <br/>
     1、next方法遍历消息队列，确实没有寻找到要处理的消息任务
     <br/>
     2、没有要处理的消息则开始处理IdleHandler相关的任务
     <br/>
     3、如果IdleHandler的queueIdle返回false则会从mIdleHandlers删除，下次空闲就不会在执行这个IdleHandler，否则true的话会每次空闲都执行
    </p>
    <h3>
     <a id="_175">
     </a>
     实战案例
    </h3>
    <p>
     测试一下queueIdle返回false,即只执行一次queueIdle
    </p>
    <pre><code class="prism language-cpp">    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>Bundle savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        super<span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setContentView</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_main2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">getMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addIdleHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> MessageQueue<span class="token punctuation">.</span><span class="token function">IdleHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            @Override
            <span class="token keyword">public</span> boolean <span class="token function">queueIdle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//TODO 执行一些不那么紧急任务                </span>
                Trace<span class="token punctuation">.</span><span class="token function">beginSection</span><span class="token punctuation">(</span><span class="token string">"queueIdle no next runing"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Log<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token string">"lsm66666"</span><span class="token punctuation">,</span><span class="token string">"queueIdle return false,no next runing"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Trace<span class="token punctuation">.</span><span class="token function">endSection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
    <p>
     验证结果：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/1421054834384f23b0b2173a883bf9d2.png"/>
    </p>
    <p>
     再测试一下queueIdle返回true,即执行多次queueIdle
    </p>
    <pre><code class="prism language-cpp">    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>Bundle savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        super<span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setContentView</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_main2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">getMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addIdleHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> MessageQueue<span class="token punctuation">.</span><span class="token function">IdleHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            @Override
            <span class="token keyword">public</span> boolean <span class="token function">queueIdle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//TODO 执行一些不那么紧急任务                </span>
                Trace<span class="token punctuation">.</span><span class="token function">beginSection</span><span class="token punctuation">(</span><span class="token string">"queueIdle has next runing"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Log<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token string">"lsm66666"</span><span class="token punctuation">,</span><span class="token string">"queueIdle return true,has next runing"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Trace<span class="token punctuation">.</span><span class="token function">endSection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
							<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
    <p>
     看看日志打印情况
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/379a0240e8aa4bc0ac198ecd02207fb4.png"/>
    </p>
    <h3>
     <a id="systraceIdleHandler_218">
     </a>
     systrace结合分析IdleHandler
    </h3>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/4381b11a96c0482382d8986735d45704.png"/>
    </p>
    <p>
     上面也可以看出来IdleHandler的执行都在没有消息可以处理了，才会执行，而且执行完成后就进入消息等待时期。
     <br/>
     从上面也可以看出来，IdleHandler确实是在主线程空闲暂时没有消息处理时候进行执行的，可以起到一个错峰执行的目的，不过也要注意以下几点：
    </p>
    <p>
     1、切勿让IdleHandler执行耗时操作，应该是可以快速完成的一些任务
    </p>
    <p>
     2、尽量都让IdleHandler执行是一次性任务，即queueIdle返回false，以防每次空闲都有重复调用
    </p>
    <p>
     文章参考：
     <a href="https://mp.weixin.qq.com/s/7R2ws-6oBij3OrNMA_IfTA" rel="nofollow">
      https://mp.weixin.qq.com/s/7R2ws-6oBij3OrNMA_IfTA
     </a>
    </p>
    <p>
     更多framework实战开发干货，请关注下面“千里马学框架”
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
  <div class="blog-extension-box" id="blogExtensionBox" style="width:400px;margin:auto;margin-top:12px">
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f67:2e6373646e2e6e65742f6c6561726e6672616d65776f726b2f:61727469636c652f64657461696c732f313436303732383131" class_="artid" style="display:none">
 </p>
</div>


