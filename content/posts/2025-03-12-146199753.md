---
layout: post
title: "使用expect工具实现远程批量修改服务器密码"
date: 2025-03-12 14:35:11 +0800
description: "expect工具批量修改账号密码"
keywords: "使用expect工具实现远程批量修改服务器密码"
categories: ['未分类']
tags: ['运维', '服务器', 'Github']
artid: "146199753"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146199753
    alt: "使用expect工具实现远程批量修改服务器密码"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146199753
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146199753
cover: https://bing.ee123.net/img/rand?artid=146199753
image: https://bing.ee123.net/img/rand?artid=146199753
img: https://bing.ee123.net/img/rand?artid=146199753
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     使用expect工具实现远程批量修改服务器密码
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="expect_0">
     </a>
     使用expect工具实现远程批量修改服务器密码
    </h2>
    <h3>
     <a id="linuxExpect_2">
     </a>
     linux服务器安装Expect工具
    </h3>
    <h4>
     <a id="1expect_3">
     </a>
     1、首先查看系统中是否有安装expect。
    </h4>
    <p>
     <kbd>
      # whereis expect
     </kbd>
    </p>
    <h4>
     <a id="2Expecttcltcl_6">
     </a>
     2、Expect工具是依赖tcl的，需要先安装tcl
    </h4>
    <p>
     <kbd>
      #wget https://sourceforge.net/projects/tcl/files/Tcl/8.4.19/tcl8.4.19-src.tar.gz
      <br/>
      #tar zxvf tcl8.4.19-src.tar.gz
      <br/>
      #cd tcl8.4.19/unix
      <br/>
      #./configure
      <br/>
      #make
      <br/>
      #make install
      <br/>
     </kbd>
    </p>
    <h4>
     <a id="3Expect_15">
     </a>
     3、安装Expect工具
    </h4>
    <p>
     <kbd>
      #wget http://sourceforge.net/projects/expect/files/Expect/5.45/expect5.45.tar.gz
      <br/>
      #tar zxvf expect5.45.tar.gz
      <br/>
      #cd expect5.45
      <br/>
      #./configure --with-tcl=/usr/local/lib --with-tclinclude=…/tcl8.4.19/generic
      <br/>
      #make
      <br/>
      #make install
      <br/>
      #ln -s /usr/local/bin/expect /usr/bin/expect
      <br/>
     </kbd>
    </p>
    <h4>
     <a id="4Expect_25">
     </a>
     4、Expect简要介绍
    </h4>
    <p>
     spawn：启动进程，并跟踪后续交互信息
     <br/>
     expect： 内部命令expect，判断上次输出结果是否包含指定字符串，如果有则立即返回，否则就等待，超时后返回，只能捕捉由spawn启动的进程的输出expect。
     <br/>
     send：向进程发送字符串，模拟输入，该命令不能自动回车换行，换行一般要加\r。
     <br/>
     interact：执行完成后保存交互状态，把控制权交给控制台。
     <br/>
     set timeout 30：设置超时时间为30秒，默认超时时间为10秒，timeout -1 为永不超时。
    </p>
    <h3>
     <a id="_31">
     </a>
     远程批量修改服务器脚本
    </h3>
    <h4>
     <a id="1_32">
     </a>
     1、准备密码配置文件
    </h4>
    <p>
     配置文件serverspd.txt，每行格式为：IP:账号:原密码:新密码:root原密码:root新密码
     <br/>
     例：
     <br/>
     <kbd>
      # ip:user:password:new_password:root_password:newroot_password
      <br/>
      192.168.1.100:testuser:Redhat#2025312:test123test!@#:Redhat#2025312:testRtest!@#
      <br/>
      192.168.1.101:testuser:Redhat#2025312:test123test!@#:Redhat#2025312:testRtest!@#
      <br/>
     </kbd>
    </p>
    <h4>
     <a id="2_39">
     </a>
     2、批量修改脚本
    </h4>
    <p>
     该脚本适合不能直接使用root登录服务器，需要先使用普通账号远程登录，再切换为root账号修改密码
     <br/>
     <kbd>
      #!/bin/bash
      <br/>
      #定义配置文件，每行格式为：IP:账号:原密码:新密码:root原密码:root新密码
      <br/>
      CONFIG_FILE=“servers.txt”
      <br/>
      #读取配置文件
      <br/>
      while IFS=: read -r IP USER OLD_PASSWORD NEW_PASSWORD ROOTOLD_PASSWORD ROOTNEW_PASSWORD; do
      <br/>
      echo “Processing $IP…”
      <br/>
      # 使用普通账号登录并切换到root
      <br/>
      sshpass -p “$OLD_PASSWORD” ssh -p 9999 -o StrictHostKeyChecking=no “$USER@$IP” &lt;&lt; EOF
      <br/>
      # 提权到root
      <br/>
      expect &lt;&lt; EOD
      <br/>
      spawn su -
      <br/>
      expect “password:”
      <br/>
      send “$ROOTOLD_PASSWORD\r”
      <br/>
      expect “#”
      <br/>
      send “echo ‘$NEW_PASSWORD’ | passwd --stdin $USER\r”
      <br/>
      send “echo ‘$ROOTNEW_PASSWORD’ | passwd --stdin root\r”
      <br/>
      expect eof
      <br/>
      EOD
      <br/>
      EOF
      <br/>
      # 检查是否修改成功
      <br/>
      if [ $? -eq 0 ]; then
      <br/>
      echo “Password for $USER@$IP updated successfully.”
      <br/>
      else
      <br/>
      echo “Failed to update password for $USER@$IP.”
      <br/>
      fi
      <br/>
      done &lt; “$CONFIG_FILE”
      <br/>
     </kbd>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f:626c6f672e6373646e2e6e65742f68616e72756964696e672f:61727469636c652f64657461696c732f313436313939373533" class_="artid" style="display:none">
 </p>
</div>


