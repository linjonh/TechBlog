---
layout: post
title: "Prometheus自动化监控-自动监控上百台服务器"
date: 2024-12-09 11:22:04 +0800
description: "本文介绍了如何使用Ansible自动化部署node_exporter到多台服务器，并结合Consul"
keywords: "ansible prometheus target"
categories: ['企业运维与监控']
tags: ['无标签']
artid: "119248666"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=119248666
    alt: "Prometheus自动化监控-自动监控上百台服务器"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=119248666
featuredImagePreview: https://bing.ee123.net/img/rand?artid=119248666
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Prometheus自动化监控-自动监控上百台服务器
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h4>
     <a id="_0">
     </a>
     如何自动化监控几百台服务器思路
    </h4>
    <pre><code>老办法：
	1.要在这100台服务器安装node_exporter。
	2.在prometheus配置增加这100台机器配置。

自动化运维：
	1.ansible批量部署node_exporter
	2.基于consul的服务发现
	3.将node_exporter所在及其的IP和端口注册到consul里。
	4.prometheus从consul里获取所有IP和端口自动加入监控。
</code></pre>
    <p>
     这几百台服务器中有：
    </p>
    <pre><code>Web服务器、DB服务器、负载均衡服务器、消息队列服务器。
</code></pre>
    <p>
     实际运维过程中也是按照分组管理
    </p>
    <pre><code>"id": "web1","name": "webserver组","address": "xxxx"
"id": "web2","name": "webserver组","address": "xxxx"
"id": "web3","name": "webserver组","address": "xxxx"

"id": "db1","name": "dbserver组","address": "xxxx"
"id": "db2","name": "dbserver组","address": "xxxx"
"id": "db3","name": "dbserver组","address": "xxxx"
</code></pre>
    <h4>
     <a id="_27">
     </a>
     实现自动化监控几百台服务器
    </h4>
    <p>
     prometheus服务上安装Ansible
    </p>
    <pre><code>安装epel源
yum install epel-release -y

安装Ansible
yum install ansible -y
</code></pre>
    <p>
     把安装了exporter的服务器的node_exporter文件夹都清空：
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/a475fcb7ff5688f26aaba6830e1d3345.png"/>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/db63eb1f3a000f2dd8be66113ac90f45.png"/>
    </p>
    <p>
     删掉之后可以看到prometheus中的target中的Endpoint都挂掉了
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/7acca432752500648c6fca0b0544bc5b.png">
      <br/>
      删掉prometheus配置文件中的配置，只保留consul的配置
     </img>
    </p>
    <p>
     可以备份以下，当做以后学习用：
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/92bbfb8450d122de63b75f82bc58660c.png">
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/d29273e04d84f4a910a0314953633e79.png"/>
     </img>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/95f8c0802dc6cca429810975f2a2c3d8.png">
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/225232429ad47ec3e05d43ae841707a6.png"/>
     </img>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/b4acd8a974505b8ed123475fa658db5f.png">
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/347325ee41a50f998f1e9ad4608f4373.png">
       <br/>
       <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/3d4e221352c4a1a270cb6055bb33b5f4.png"/>
      </img>
     </img>
    </p>
    <p>
     Ansible + playbook完成任务
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/96a9b2877415018a70e26341bb2c4d05.png"/>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/21856dc7b0072e26c53dd420e1ea37aa.png"/>
    </p>
    <pre><code>[Unit]
Description=node_exporter

[Service]
ExecStart=/usr/local/node_exporter/node_exporter
ExecReload=/bin/kill -HUP $MAINPID
KillMode=process
Restart=on-failure

[Install]
WantedBy=multi-user.target
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/163ab751313115e09722d6463efe921e.png"/>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/7407c95c2599e8a02b8811750c65d0d0.png"/>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/f47064c485482c1b590a0aa4d28e5fae.png"/>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/155d995947626ce70b26cf5e59ba153c.png"/>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/b927201793d4b472a945685c9ba87ac7.png"/>
     <br/>
     有了这四个文件后，就可以编写playbook了
    </p>
    <pre><code>consul-register.sh
hosts
node_exporter-1.2.0.linux-amd64.tar.gz
node_exporter.service
playbook.yaml
</code></pre>
    <p>
     各文件的内容
    </p>
    <p>
     consul-register.sh
    </p>
    <pre><code>#!/bin/bash
service_name=$1
instance_id=$2
ip=$3
port=$4

curl -X PUT -d '{"id": "'"$instance_id"'","name": "'"$service_name"'","address": "'"$ip"'","port": '"$port"',"tags": ["'"$service_name"'"],"checks": [{"http": "http://'"$ip"':'"$port"'","interval": "5s"}]}' http://192.168.220.103:8500/v1/agent/service/register
</code></pre>
    <p>
     hosts
    </p>
    <pre><code>[webservers]
192.168.220.102 name=web1

[dbservers]
192.168.220.103 name=db1
</code></pre>
    <p>
     node_exporter.service
    </p>
    <pre><code>[Unit]
Description=node_exporter

[Service]
ExecStart=/usr/local/node_exporter/node_exporter
ExecReload=/bin/kill -HUP $MAINPID
KillMode=process
Restart=on-failure

[Install]
WantedBy=multi-user.target
</code></pre>
    <p>
     playbook.yaml
    </p>
    <pre><code>- hosts: webservers
  gather_facts: no
  vars:
    port: 9100
  tasks:
  - name: 推送二进制文件
    unarchive: src=node_exporter-1.2.0.linux-amd64.tar.gz dest=/usr/local
  - name: 重命名
    shell: |
         cd /usr/local
         if [ ! -d node_exporter ];then
             mv node_exporter-1.2.0.linux-amd64 node_exporter
         fi
 #- name: 推送配置文件
 #  copy: src=config.yml dest=/usr/local/node_exporter
  - name: 拷贝systemd文件
    copy: src=node_exporter.service dest=/usr/lib/systemd/system
  - name: 启动服务
    systemd: name=node_exporter state=started enabled=yes daemon_reload=yes
  - name: 推送注册脚本
    copy: src=consul-register.sh dest=/usr/local/bin/
  - name: 注册当前节点   
    # 服务名 实例名 IP 端口 
    shell: /bin/bash /usr/local/bin/consul-register.sh {<!-- -->{ group_names[0] }} {<!-- -->{ name }} {<!-- -->{ inventory_hostname }} {<!-- -->{ port }}
</code></pre>
    <p>
     准备齐全，ansible部署exporter到其他服务器
    </p>
    <pre><code>ansible-playbook -i hosts playbook.yaml -uroot -k 
</code></pre>
    <p>
     失败是因为需要输入用户名和密码
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/8ac87a21c5ad9a81ebaadb24be2e7eff.png"/>
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/e3524cca18892b479f0e37b47d41e99d.png"/>
    </p>
    <p>
     成功的标志：
    </p>
    <pre><code>1.Prometheus中的Target有webservers服务。
2.consul中的Services多了webservers服务。
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/0b4f0e26d90f7b9faad49a354ac7e5fc.png"/>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/2c01cb0c539c031e6bef5147aa4cc7f7.png"/>
    </p>
    <p>
     存在警告的原因是因为名字错误：port改名成exporter_port就不会有这种警告了
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/a5cfd69b0d0a8d8fe5b6d9e95bce5262.png"/>
     <br/>
     修改port成exporter_port
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/eb72bb17f6f45acab2f35c5d29db1049.png"/>
     <br/>
     不存在警告了
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/78322de3e2324897ca89a5a6af3f0dee.png"/>
    </p>
    <p>
     监控好了webservers组后，可以监控dbservers组了
    </p>
    <p>
     修改playbook.yaml文件
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/6addff813078b26208992b9dfd0b3dc9.png"/>
     <br/>
     失败了，是因为第一次需要指纹验证，
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/d40d098e5e2082d927a22d75e7bfd53f.png"/>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/58a2a3663cce60b19208f1855a147e6a.png"/>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/624dc942396eed6a1a7a3744baa80895.png"/>
     <br/>
     然后再次执行
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/89fae6559ee72f780a44dc74cf3f0a1b.png"/>
    </p>
    <p>
     执行成功。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/512950c8a8a12b33578216d7cebe9f10.png"/>
     <br/>
     执行状态为Down,查看原因
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/57fff6b2e1dbdc0cfc38323ff6ee0a74.png"/>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/b34ab842e6bd04c323f6aada65d14ff5.png"/>
     <br/>
     状态为启动，但是web页面显示错误
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/95a1cc81d25a8e8583809c279e374cdc.png"/>
     <br/>
     最后定位到配置文件没有拷贝过来
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/d0476633e8d300423bb30746ef8bb33e.png"/>
     <br/>
     kill 掉进程后重来就可以了：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/bace7f1da48636386f40e9ebe8b505c1.png"/>
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/62e43629aaae5c5d035a0b47ce14df45.png"/>
     <br/>
     因此需要重新修改以下文件：
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/2991ca8f2f8b866041d9b6f7c36153fb.png"/>
     <br/>
     重新来一下就可以了。
    </p>
    <p>
     grafana也有对应的组了。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/40427f9a8911dc63afe869b0c5f5e97e.png"/>
    </p>
    <p>
     以后添加机器时只要修改hosts文件就行
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/82b558aabbc5256d9b32d07c5fb3b967.png"/>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f33393539353736392f:61727469636c652f64657461696c732f313139323438363636" class_="artid" style="display:none">
 </p>
</div>


