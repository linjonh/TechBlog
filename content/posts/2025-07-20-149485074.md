---
layout: post
title: "UE5多人MOBAGAS-26为角色添加每秒回血回蓝番外添加到UI上"
date: 2025-07-20T18:09:53+0800
description: "本文介绍了在Unreal Engine中实现生命值和法力值状态管理系统的开发过程。主要内容包括：1) 定义生命值和法力值的满/空状态标签（Stats.Health.Full/Empty、Stats.Mana.Full/Empty）；2) 创建无限持续时间的GameplayEffect并配置其激活条件；3) 在AbilitySystemComponent中实现属性变化监听，动态添加/移除对应的状态标签；4) 开发UI组件显示每秒回复数值，包括文本格式设置和属性变化回调绑定。该系统可实时监控角色状态变化，在属性"
keywords: "UE5多人MOBA+GAS 26、为角色添加每秒回血回蓝（番外：添加到UI上）"
categories: ['Moba']
tags: ['Ui', 'Ue', 'Java']
artid: "149485074"
arturl: "https://blog.csdn.net/A99639/article/details/149485074"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=149485074
    alt: "UE5多人MOBAGAS-26为角色添加每秒回血回蓝番外添加到UI上"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=149485074
featuredImagePreview: https://bing.ee123.net/img/rand?artid=149485074
cover: https://bing.ee123.net/img/rand?artid=149485074
image: https://bing.ee123.net/img/rand?artid=149485074
img: https://bing.ee123.net/img/rand?artid=149485074
---



# UE5多人MOBA+GAS 26、为角色添加每秒回血回蓝（番外：添加到UI上）



---

## 添加生命值和蓝量的状态标签

添加新的标签

```cpp
	CRUNCH_API UE_DECLARE_GAMEPLAY_TAG_EXTERN(Stats_Health_Full)
	CRUNCH_API UE_DECLARE_GAMEPLAY_TAG_EXTERN(Stats_Health_Empty)
	CRUNCH_API UE_DECLARE_GAMEPLAY_TAG_EXTERN(Stats_Mana_Full)
	CRUNCH_API UE_DECLARE_GAMEPLAY_TAG_EXTERN(Stats_Mana_Empty)

```

```cpp
	UE_DEFINE_GAMEPLAY_TAG_COMMENT(Stats_Health_Full, "Stats.Health.Full", "生命值满")
	UE_DEFINE_GAMEPLAY_TAG_COMMENT(Stats_Mana_Full, "Stats.Mana.Full", "法术值满")
	UE_DEFINE_GAMEPLAY_TAG_COMMENT(Stats_Health_Empty, "Stats.Health.Empty", "生命值空")
	UE_DEFINE_GAMEPLAY_TAG_COMMENT(Stats_Mana_Empty, "Stats.Mana.Empty", "法术值空")

```

## 创建无限GE并应用

创建两个GE应用为无限，添加一个组件，死掉和满状态的时候不激活该GE  
 ![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/c018143e22cc4956812291a477b3c090.png)

## 监听添加和去除标签

对ASC中监听生命值和法力值的变化进行更改对其添加tag和移除tag（不知道有啥用）

```cpp
void UCAbilitySystemComponent::HealthUpdated(const FOnAttributeChangeData& ChangeData)
{
	if (!GetOwner() || !GetOwner()->HasAuthority()) return;

	// 获取当前最大生命值
	bool bFound = false;
	float MaxHealth = GetGameplayAttributeValue(UCAttributeSet::GetMaxHealthAttribute(), bFound);
    
	// 如果生命值达到最大值，添加生命值已满标签
	if (bFound && ChangeData.NewValue >= MaxHealth)
	{
		if (!HasMatchingGameplayTag(TGameplayTags::Stats_Health_Full))
		{
			// 仅本地会添加标签
			AddLooseGameplayTag(TGameplayTags::Stats_Health_Full);
		}
	}
	else
	{
		// 移除生命值已满标签
		RemoveLooseGameplayTag(TGameplayTags::Stats_Health_Full);
	}
	if (ChangeData.NewValue <= 0.0f)
	{
		if (!HasMatchingGameplayTag(TGameplayTags::Stats_Health_Empty))
		{
			// 本地添加生命值清零标签
			AddLooseGameplayTag(TGameplayTags::Stats_Health_Empty);
			// 角色死亡
			if (DeathEffect)
			{
				AuthApplyGameplayEffect(DeathEffect);
			}
		}
	}else
	{
		RemoveLooseGameplayTag(TGameplayTags::Stats_Health_Empty);
	}
}

void UCAbilitySystemComponent::ManaUpdated(const FOnAttributeChangeData& ChangeData)
{
	// 仅在拥有者存在且为服务器时执行
	if (!GetOwner() || !GetOwner()->HasAuthority()) return;

	// 获取当前最大魔法值
	bool bFound = false;
	float MaxMana = GetGameplayAttributeValue(UCAttributeSet::GetMaxManaAttribute(), bFound);
    
	// 如果魔法值达到最大值，添加魔法值已满标签
	if (bFound && ChangeData.NewValue >= MaxMana)
	{
		if (!HasMatchingGameplayTag(TGameplayTags::Stats_Mana_Full))
		{
			// 仅本地生效的标签
			AddLooseGameplayTag(TGameplayTags::Stats_Mana_Full);
		}
	}
	else
	{
		// 移除魔法值已满标签
		RemoveLooseGameplayTag(TGameplayTags::Stats_Mana_Full);
	}

	// 处理魔法值为零的情况
	if (ChangeData.NewValue <= 0)
	{
		if (!HasMatchingGameplayTag(TGameplayTags::Stats_Mana_Empty))
		{
			// 添加魔法值清零标签
			AddLooseGameplayTag(TGameplayTags::Stats_Mana_Empty);
		}
	}
	else
	{
		// 移除魔法值清零标签
		RemoveLooseGameplayTag(TGameplayTags::Stats_Mana_Empty);
	}
}

```

## 每秒回复配上UI

```cpp
public:
	// 设置每秒回复值
	void SetRegenValueTextToGameplayAttribute(UAbilitySystemComponent* AbilitySystemComponent,const FGameplayAttribute& Attribute);
	void SetRegenValue(float NewRegenValue);
private:
	void RegenValueChanged(const FOnAttributeChangeData& ChangeData);
	// 每秒回复的数值显示，默认为false，小兵不配这个
	UPROPERTY(EditAnywhere, Category = "Visual")
	bool bRegenValueTextVisible = false;

	// 放置右边显示每秒回复的数值
	UPROPERTY(VisibleAnywhere, meta = (BindWidget))
	TObjectPtr<UTextBlock> RegenValueText;

```

```cpp
void UValueGauge::NativePreConstruct()
{
	Super::NativePreConstruct();
	// 设置进度条颜色
	ProgressBar->SetFillColorAndOpacity(BarColor);
	
	ValueText->SetFont(ValueTextFont);
	RegenValueText->SetFont(ValueTextFont);
	
	ValueText->SetVisibility(bValueTextVisible ? ESlateVisibility::Visible : ESlateVisibility::Hidden);
	ProgressBar->SetVisibility(bProgressBarVisible ? ESlateVisibility::Visible : ESlateVisibility::Hidden);
	RegenValueText->SetVisibility(bRegenValueTextVisible ? ESlateVisibility::Visible : ESlateVisibility::Hidden);
}
void UValueGauge::SetRegenValueTextToGameplayAttribute(UAbilitySystemComponent* AbilitySystemComponent,
	const FGameplayAttribute& Attribute)
{
	if (AbilitySystemComponent)
	{
		bool bFound;
		float Value = AbilitySystemComponent->GetGameplayAttributeValue(Attribute, bFound);
		// 如果成功找到对应的属性值，则更新数值指示器的显示
		if (bFound)
		{
			SetRegenValue(Value);
		}
		// 注册属性变化回调，当属性值发生变化时更新数值指示器显示
		AbilitySystemComponent->GetGameplayAttributeValueChangeDelegate(Attribute).AddUObject(this, &UValueGauge::RegenValueChanged);
	}
}

void UValueGauge::SetRegenValue(float NewRegenValue)
{
	// 设置数字格式选项，最大小数位数为0
	const FNumberFormattingOptions FormatOps = FNumberFormattingOptions().SetMaximumFractionalDigits(0);
	// 更新文本显示
	RegenValueText->SetText(
		FText::Format(
			FTextFormat::FromString("{0}/s"),			 // 格式字符串
			FText::AsNumber(NewRegenValue, &FormatOps)      // 当前值
		)
	);
}

void UValueGauge::RegenValueChanged(const FOnAttributeChangeData& ChangeData)
{
	SetRegenValue(ChangeData.NewValue);
}

```

到`GameplayWidget`中添加绑定

```cpp
void UGameplayWidget::NativeConstruct()
{
	Super::NativeConstruct();
	OwnerAbilitySystemComponent = UAbilitySystemBlueprintLibrary::GetAbilitySystemComponent(GetOwningPlayerPawn());
	if (OwnerAbilitySystemComponent)
	{
		// 绑定属性回调
		HealthBar->SetAndBoundToGameplayAttribute(OwnerAbilitySystemComponent, UCAttributeSet::GetHealthAttribute(), UCAttributeSet::GetMaxHealthAttribute());
		ManaBar->SetAndBoundToGameplayAttribute(OwnerAbilitySystemComponent, UCAttributeSet::GetManaAttribute(), UCAttributeSet::GetMaxManaAttribute());

		// 绑定每秒回复的属性
		HealthBar->SetRegenValueTextToGameplayAttribute(OwnerAbilitySystemComponent, UCHeroAttributeSet::GetHealthRegenAttribute());
		ManaBar->SetRegenValueTextToGameplayAttribute(OwnerAbilitySystemComponent, UCHeroAttributeSet::GetManaRegenAttribute());
	}
}

```

构建一下把文本添加进去  
 ![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/dcf35d45c033465986e26d8a0abd76c7.png)



