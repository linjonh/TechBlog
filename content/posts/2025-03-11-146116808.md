---
layout: post
title: "Linux驱动开发-设备树"
date: 2025-03-11 11:19:51 +0800
description: "设备树：设备按照树这种结构，来描述板子上的设备信息的文件，目的是和linux内核分离开，用专属的文件格式来描述，这个文件称为设备树（.dts）。主干是系统总线，分支有GPIO控制器，SPI控制器，IIC控制器等，然后再分支，比如IIC控制器又分为IIC1和IIC2，然后继续分支，IIC1上搭载具体的设备。"
keywords: "Linux驱动开发-设备树"
categories: ['未分类']
tags: ['驱动开发', '运维', 'Ubuntu', 'Linux']
artid: "146116808"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146116808
    alt: "Linux驱动开发-设备树"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146116808
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146116808
cover: https://bing.ee123.net/img/rand?artid=146116808
image: https://bing.ee123.net/img/rand?artid=146116808
img: https://bing.ee123.net/img/rand?artid=146116808
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Linux驱动开发-设备树
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <p>
    </p>
    <h2>
     <a id="_1">
     </a>
     一，设备树简介
    </h2>
    <h3>
     <a id="1__2">
     </a>
     1. 设备树
    </h3>
    <p>
     设备树：设备按照树这种结构，来描述板子上的设备信息的文件，目的是和linux内核分离开，用专属的文件格式来描述，这个文件称为设备树（.dts）。主干是系统总线，分支有GPIO控制器，SPI控制器，IIC控制器等，然后再分支，比如IIC控制器又分为IIC1和IIC2，然后继续分支，IIC1上搭载具体的设备。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/fc4289b78bbd4dd6902f761e099cf835.png"/>
    </p>
    <h3>
     <a id="2_DTSDTBDTC_5">
     </a>
     2. DTS、DTB和DTC
    </h3>
    <p>
     dts:设备树源码文件，里面显示的是设备之间的关系网，从大类继续往下慢慢细分，最终到具体设备。
     <br/>
     dtb:将dts文件编译后得到的二进制文件，类似于将.c编译成.o文件这种。
     <br/>
     dtsi：类似于c语言中的头文件，由下面的dts代码中 #include &lt;imx6ull.dtsi&gt;，这个dtsi文件描述的是内部的外设信息（CPU架构，主频，外设寄存器的地址范围），相当于把
     <strong>
      芯片
     </strong>
     内部的共有属性都提取到一个文件夹中，然后对于不同的
     <strong>
      板子
     </strong>
     再有不同dts文件（芯片和板子不一样，针对这个alpha开发板，芯片就是这个内部小‘板子’，板子是整个带有网口等等设备的大板子）。
     <br/>
     dtc:编译所需要的工具。
    </p>
    <h2>
     <a id="DTS_10">
     </a>
     二，DTS语法
    </h2>
    <h3>
     <a id="1_11">
     </a>
     1.设备节点
    </h3>
    <p>
     每个设备都是一个节点，称为设备节点，比如代码14行的 / 称为根节点，imx6ull.dtsi和imx6ull-alientek-emc.dts都有根节点，上面也说明了这俩文件的关系，因此相当于俩根节点内容合并成一个根节点。
    </p>
    <h4>
     <a id="11__13">
     </a>
     1.1 字符串型
    </h4>
    <pre><code class="prism language-c"> model <span class="token operator">=</span> <span class="token string">"Freescale i.MX6 ULL 14x14 EVK Board"</span><span class="token punctuation">;</span>
</code></pre>
    <h4>
     <a id="12__32_18">
     </a>
     1.2 32位无符号整数
    </h4>
    <pre><code class="prism language-c"> reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x80000000</span> <span class="token number">0x20000000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
</code></pre>
    <h4>
     <a id="13__23">
     </a>
     1.3 字符串列表
    </h4>
    <pre><code class="prism language-c">compatible <span class="token operator">=</span> <span class="token string">"fsl,imx6ull-14x14-evk"</span><span class="token punctuation">,</span> <span class="token string">"fsl,imx6ull"</span><span class="token punctuation">;</span>
</code></pre>
    <h3>
     <a id="2_28">
     </a>
     2.设备属性
    </h3>
    <h4>
     <a id="21__compatible_29">
     </a>
     2.1 兼容性 compatible
    </h4>
    <p>
     格式：“厂商，模块对应的驱动的名字”，如果这个兼容性设置有两个，比如compatible = “fsl,imx6ul-evk-wm8960”,“fsl,imx-audio-wm8960”;会先去使用第一个兼容值在linux内核找查找，看看能不能找到对应的驱动文件，找不到就用第二个值去查找。
    </p>
    <h4>
     <a id="22_model_31">
     </a>
     2.2 model
    </h4>
    <p>
     字符串，用于描述设置模块信息，比如名字，model = “wm8960-audio”。
    </p>
    <h4>
     <a id="23_status_34">
     </a>
     2.3 status
    </h4>
    <p>
     字符串，设备的状态信息，一般有okay和disabled比较常用。
    </p>
    <h4>
     <a id="24_reg_37">
     </a>
     2.4 reg
    </h4>
    <p>
     reg用于描述这个设备地址空间信息。
    </p>
    <h4>
     <a id="25__addresscells_sizecells__39">
     </a>
     2.5 #address-cells 和#size-cells 属性
    </h4>
    <p>
     无符号32位整形，用于任何拥有子节点的设备中，描述子节点的地址信息。对于节点的reg属性：reg = &lt;address1 length1 address2 length2 address3 length3……&gt;,其中 address 是起始地址，length 是地址长度，#address-cells 表明 address 这个数据所占用的字长,#size-cells 表明 length 这个数据所占用的字长。
     <strong>
      字长意思就是有几个
     </strong>
     。
     <br/>
     比如父节点设置 #address-cells = &lt;1&gt;,#size-cells&lt;1&gt;,那么子节点的address1 为1，length1 为1，一一对应的关系。
    </p>
    <p>
     在I2C1中添加自己的设备wwwyyyyyttt，247-251行代码中，添加完成后，在板子上通过串口查看：
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/df4037edc3074cae8d0ae2d9f278a2f6.png"/>
    </p>
    <pre><code class="prism language-c"><span class="token comment">/*dts文件*/</span>
<span class="token comment">/*
  2  * Copyright (C) 2016 Freescale Semiconductor, Inc.
  3  *
  4  * This program is free software; you can redistribute it and/or modify
  5  * it under the terms of the GNU General Public License version 2 as
  6  * published by the Free Software Foundation.
  7  */</span>
  <span class="token number">8</span> 
  <span class="token number">9</span> <span class="token operator">/</span>dts<span class="token operator">-</span>v1<span class="token operator">/</span><span class="token punctuation">;</span>
 <span class="token number">10</span> 
 <span class="token number">11</span> #include <span class="token operator">&lt;</span>dt<span class="token operator">-</span>bindings<span class="token operator">/</span>input<span class="token operator">/</span>input<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>
 <span class="token number">12</span> #include <span class="token string">"imx6ull.dtsi"</span>
 <span class="token number">13</span> 
 <span class="token number">14</span> <span class="token operator">/</span> <span class="token punctuation">{<!-- --></span>
 <span class="token number">15</span>     model <span class="token operator">=</span> <span class="token string">"Freescale i.MX6 ULL 14x14 EVK Board"</span><span class="token punctuation">;</span>
 <span class="token number">16</span>     compatible <span class="token operator">=</span> <span class="token string">"fsl,imx6ull-14x14-evk"</span><span class="token punctuation">,</span> <span class="token string">"fsl,imx6ull"</span><span class="token punctuation">;</span>
 <span class="token number">17</span> 
 <span class="token number">18</span>     chosen <span class="token punctuation">{<!-- --></span>
 <span class="token number">19</span>         <span class="token constant">stdout</span><span class="token operator">-</span>path <span class="token operator">=</span> <span class="token operator">&amp;</span>uart1<span class="token punctuation">;</span>
 <span class="token number">20</span>     <span class="token punctuation">}</span><span class="token punctuation">;</span>
 <span class="token number">21</span> 
 <span class="token number">22</span>     memory <span class="token punctuation">{<!-- --></span>
 <span class="token number">23</span>         reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x80000000</span> <span class="token number">0x20000000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
 <span class="token number">24</span>     <span class="token punctuation">}</span><span class="token punctuation">;</span>
 <span class="token number">25</span> 
 <span class="token number">26</span>     reserved<span class="token operator">-</span>memory <span class="token punctuation">{<!-- --></span>
 <span class="token number">27</span>         #address<span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
 <span class="token number">28</span>         #size<span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
 <span class="token number">29</span>         ranges<span class="token punctuation">;</span>
 <span class="token number">30</span> 
 <span class="token number">31</span>         linux<span class="token punctuation">,</span>cma <span class="token punctuation">{<!-- --></span>
 <span class="token number">32</span>             compatible <span class="token operator">=</span> <span class="token string">"shared-dma-pool"</span><span class="token punctuation">;</span>
 <span class="token number">33</span>             reusable<span class="token punctuation">;</span>
 <span class="token number">34</span>             size <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x14000000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
 <span class="token number">35</span>             linux<span class="token punctuation">,</span>cma<span class="token operator">-</span><span class="token keyword">default</span><span class="token punctuation">;</span>
 <span class="token number">36</span>         <span class="token punctuation">}</span><span class="token punctuation">;</span>
 <span class="token number">37</span>     <span class="token punctuation">}</span><span class="token punctuation">;</span>
 <span class="token number">38</span> 
 <span class="token number">39</span>     backlight <span class="token punctuation">{<!-- --></span>
 <span class="token number">40</span>         compatible <span class="token operator">=</span> <span class="token string">"pwm-backlight"</span><span class="token punctuation">;</span>
 <span class="token number">41</span>         pwms <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>pwm1 <span class="token number">0</span> <span class="token number">5000000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
 <span class="token number">42</span>         brightness<span class="token operator">-</span>levels <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0</span> <span class="token number">4</span> <span class="token number">8</span> <span class="token number">16</span> <span class="token number">32</span> <span class="token number">64</span> <span class="token number">128</span> <span class="token number">255</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
 <span class="token number">43</span>         <span class="token keyword">default</span><span class="token operator">-</span>brightness<span class="token operator">-</span>level <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">6</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
 <span class="token number">44</span>         status <span class="token operator">=</span> <span class="token string">"okay"</span><span class="token punctuation">;</span>
 <span class="token number">45</span>     <span class="token punctuation">}</span><span class="token punctuation">;</span>
 <span class="token number">46</span> 
 <span class="token number">47</span>     pxp_v4l2 <span class="token punctuation">{<!-- --></span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token number">50</span>     <span class="token punctuation">}</span><span class="token punctuation">;</span>
     regulators <span class="token punctuation">{<!-- --></span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token number">86</span>     <span class="token punctuation">}</span><span class="token punctuation">;</span>
 <span class="token number">87</span> 
 <span class="token number">88</span>     sound <span class="token punctuation">{<!-- --></span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token number">123</span>     <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token number">124</span> 
<span class="token number">125</span>     spi4 <span class="token punctuation">{<!-- --></span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token number">148</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token number">228</span> <span class="token operator">&amp;</span>i2c1 <span class="token punctuation">{<!-- --></span>
<span class="token number">229</span>     clock<span class="token operator">-</span>frequency <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">100000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token number">230</span>     pinctrl<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"default"</span><span class="token punctuation">;</span>
<span class="token number">231</span>     pinctrl<span class="token operator">-</span><span class="token number">0</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>pinctrl_i2c1<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token number">232</span>     status <span class="token operator">=</span> <span class="token string">"okay"</span><span class="token punctuation">;</span>
<span class="token number">233</span> 
<span class="token number">234</span>     mag3110@<span class="token number">0</span>e <span class="token punctuation">{<!-- --></span>
<span class="token number">235</span>         compatible <span class="token operator">=</span> <span class="token string">"fsl,mag3110"</span><span class="token punctuation">;</span>
<span class="token number">236</span>         reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x0e</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token number">237</span>         position <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">2</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token number">238</span>     <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token number">239</span> 
<span class="token number">240</span>     fxls8471@<span class="token number">1</span>e <span class="token punctuation">{<!-- --></span>
<span class="token number">241</span>         compatible <span class="token operator">=</span> <span class="token string">"fsl,fxls8471"</span><span class="token punctuation">;</span>
<span class="token number">242</span>         reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x1e</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token number">243</span>         position <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token number">244</span>         interrupt<span class="token operator">-</span>parent <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio5<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token number">245</span>         interrupts <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0</span> <span class="token number">8</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token number">246</span>     <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token number">247</span>     wwwyyyyyttt@<span class="token number">3</span>e<span class="token punctuation">{<!-- --></span>
<span class="token number">248</span>         compatiable <span class="token operator">=</span> <span class="token string">"fsl,wwwyyyyyttt"</span><span class="token punctuation">;</span>
<span class="token number">249</span>         reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x3e</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token number">250</span>         position <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token number">251</span>     <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token number">252</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>


</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/acbbb242ac3c4711b317aabdc9f20a99.png">
      图片中显示的驱动，和dtsi中的内容也有不同，dtsi中的驱动更多，但是在板子运行后少了，因为有的找不到，因此在板子运行时就不显示了。比如这个caam@2140000。追加设备在dts文件中，一般不要在dtsi文件。
     </img>
    </p>
    <pre><code class="prism language-c">	<span class="token comment">/*这段是dtsi的代码*/</span>
		aips2<span class="token operator">:</span> aips<span class="token operator">-</span>bus@<span class="token number">02100000</span> <span class="token punctuation">{<!-- --></span>
			compatible <span class="token operator">=</span> <span class="token string">"fsl,aips-bus"</span><span class="token punctuation">,</span> <span class="token string">"simple-bus"</span><span class="token punctuation">;</span>
			<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">address</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
			<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">size</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
			reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x02100000</span> <span class="token number">0x100000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
			ranges<span class="token punctuation">;</span>

			crypto<span class="token operator">:</span> caam@<span class="token number">2140000</span> <span class="token punctuation">{<!-- --></span>
					<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
				<span class="token punctuation">}</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span><span class="token punctuation">;</span>

			usbotg1<span class="token operator">:</span> usb@<span class="token number">02184000</span> <span class="token punctuation">{<!-- --></span>
					<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
			<span class="token punctuation">}</span><span class="token punctuation">;</span>

			usbotg2<span class="token operator">:</span> usb@<span class="token number">02184200</span> <span class="token punctuation">{<!-- --></span>
					<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
			<span class="token punctuation">}</span><span class="token punctuation">;</span>

			usbmisc<span class="token operator">:</span> usbmisc@<span class="token number">02184800</span> <span class="token punctuation">{<!-- --></span>
					<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
			<span class="token punctuation">}</span><span class="token punctuation">;</span>

			fec1<span class="token operator">:</span> ethernet@<span class="token number">02188000</span> <span class="token punctuation">{<!-- --></span>
					<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                        <span class="token punctuation">}</span><span class="token punctuation">;</span>

			sim1<span class="token operator">:</span> sim@<span class="token number">0218</span>c000 <span class="token punctuation">{<!-- --></span>
					<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
			<span class="token punctuation">}</span><span class="token punctuation">;</span>

			usdhc1<span class="token operator">:</span> usdhc@<span class="token number">02190000</span> <span class="token punctuation">{<!-- --></span>
				compatible <span class="token operator">=</span> <span class="token string">"fsl,imx6ul-usdhc"</span><span class="token punctuation">,</span> <span class="token string">"fsl,imx6sx-usdhc"</span><span class="token punctuation">;</span>
				reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x02190000</span> <span class="token number">0x4000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
				interrupts <span class="token operator">=</span> <span class="token operator">&lt;</span>GIC_SPI <span class="token number">22</span> IRQ_TYPE_LEVEL_HIGH<span class="token operator">&gt;</span><span class="token punctuation">;</span>
				clocks <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>clks IMX6UL_CLK_USDHC1<span class="token operator">&gt;</span><span class="token punctuation">,</span>
					 <span class="token operator">&lt;</span><span class="token operator">&amp;</span>clks IMX6UL_CLK_USDHC1<span class="token operator">&gt;</span><span class="token punctuation">,</span>
					 <span class="token operator">&lt;</span><span class="token operator">&amp;</span>clks IMX6UL_CLK_USDHC1<span class="token operator">&gt;</span><span class="token punctuation">;</span>
				clock<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"ipg"</span><span class="token punctuation">,</span> <span class="token string">"ahb"</span><span class="token punctuation">,</span> <span class="token string">"per"</span><span class="token punctuation">;</span>
				bus<span class="token operator">-</span>width <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">4</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
				status <span class="token operator">=</span> <span class="token string">"disabled"</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span><span class="token punctuation">;</span>

			usdhc2<span class="token operator">:</span> usdhc@<span class="token number">02194000</span> <span class="token punctuation">{<!-- --></span>
				compatible <span class="token operator">=</span> <span class="token string">"fsl,imx6ul-usdhc"</span><span class="token punctuation">,</span> <span class="token string">"fsl,imx6sx-usdhc"</span><span class="token punctuation">;</span>
				reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x02194000</span> <span class="token number">0x4000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
				interrupts <span class="token operator">=</span> <span class="token operator">&lt;</span>GIC_SPI <span class="token number">23</span> IRQ_TYPE_LEVEL_HIGH<span class="token operator">&gt;</span><span class="token punctuation">;</span>
				clocks <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>clks IMX6UL_CLK_USDHC2<span class="token operator">&gt;</span><span class="token punctuation">,</span>
					 <span class="token operator">&lt;</span><span class="token operator">&amp;</span>clks IMX6UL_CLK_USDHC2<span class="token operator">&gt;</span><span class="token punctuation">,</span>
					 <span class="token operator">&lt;</span><span class="token operator">&amp;</span>clks IMX6UL_CLK_USDHC2<span class="token operator">&gt;</span><span class="token punctuation">;</span>
				clock<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"ipg"</span><span class="token punctuation">,</span> <span class="token string">"ahb"</span><span class="token punctuation">,</span> <span class="token string">"per"</span><span class="token punctuation">;</span>
				bus<span class="token operator">-</span>width <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">4</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
				status <span class="token operator">=</span> <span class="token string">"disabled"</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span><span class="token punctuation">;</span>

			adc1<span class="token operator">:</span> adc@<span class="token number">02198000</span> <span class="token punctuation">{<!-- --></span>
				compatible <span class="token operator">=</span> <span class="token string">"fsl,imx6ul-adc"</span><span class="token punctuation">,</span> <span class="token string">"fsl,vf610-adc"</span><span class="token punctuation">;</span>
				reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x02198000</span> <span class="token number">0x4000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
				interrupts <span class="token operator">=</span> <span class="token operator">&lt;</span>GIC_SPI <span class="token number">100</span> IRQ_TYPE_LEVEL_HIGH<span class="token operator">&gt;</span><span class="token punctuation">;</span>
				clocks <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>clks IMX6UL_CLK_ADC1<span class="token operator">&gt;</span><span class="token punctuation">;</span>
				num<span class="token operator">-</span>channels <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">2</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
				clock<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"adc"</span><span class="token punctuation">;</span>
				status <span class="token operator">=</span> <span class="token string">"disabled"</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span><span class="token punctuation">;</span>
			<span class="token comment">/*在dts中添加在i2c1中的设备wwwyyyyyyttt*/</span>
			i2c1<span class="token operator">:</span> i2c@<span class="token number">021</span>a0000 <span class="token punctuation">{<!-- --></span>
				<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">address</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
				<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">size</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
				compatible <span class="token operator">=</span> <span class="token string">"fsl,imx6ul-i2c"</span><span class="token punctuation">,</span> <span class="token string">"fsl,imx21-i2c"</span><span class="token punctuation">;</span>
				reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x021a0000</span> <span class="token number">0x4000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
				interrupts <span class="token operator">=</span> <span class="token operator">&lt;</span>GIC_SPI <span class="token number">36</span> IRQ_TYPE_LEVEL_HIGH<span class="token operator">&gt;</span><span class="token punctuation">;</span>
				clocks <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>clks IMX6UL_CLK_I2C1<span class="token operator">&gt;</span><span class="token punctuation">;</span>
				status <span class="token operator">=</span> <span class="token string">"disabled"</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span><span class="token punctuation">;</span>

					<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre>
    <h2>
     <a id="OF_226">
     </a>
     三，设备树常用的OF操作函数
    </h2>
    <h3>
     <a id="1_228">
     </a>
     1.操作函数
    </h3>
    <p>
     设备树就相当于一个文件，内核想要获取设备树中设备信息，因此要借助内核中的函数即OF函数，设备树中，设备类似按节点的方式放到设备树上，因此内核要获取设备树上设备信息要先获取这个设备节点，然后利用相关OF函数获取其他的属性。
     <br/>
     整体实现：
    </p>
    <pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/errno.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/gpio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/cdev.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kdev_t.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/device.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/mach/map.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/uaccess.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/io.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/delay.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fs.h&gt;</span>  <span class="token comment">// 包含 register_chrdev_region 的定义</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/device.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/of.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/of_address.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/of_irq.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h&gt;</span></span>



<span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">dtsof_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>bl_nd <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token comment">/*设置返回值*/</span>
    <span class="token keyword">struct</span> <span class="token class-name">property</span>  <span class="token operator">*</span>bl_property <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token comment">//字符串类型</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> str<span class="token punctuation">;</span>
    u32 shu_value<span class="token punctuation">;</span><span class="token comment">//数值类型</span>
    u32 kkkmmmmm<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    u32 num<span class="token punctuation">;</span>

    <span class="token comment">/*1.找节点,路径/backlight*/</span>
    bl_nd <span class="token operator">=</span> <span class="token function">of_find_node_by_path</span><span class="token punctuation">(</span><span class="token string">"/backlight"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>bl_nd <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"CCCCC\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> fail_find<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/*2.获取属性*/</span>
    bl_property <span class="token operator">=</span> <span class="token function">of_find_property</span><span class="token punctuation">(</span>bl_nd<span class="token punctuation">,</span><span class="token string">"compatible"</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>bl_property <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        ret <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> fail_find<span class="token punctuation">;</span>        
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"compatible = %s\r\n"</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>bl_property<span class="token operator">-&gt;</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>

    ret <span class="token operator">=</span> <span class="token function">of_property_read_string</span><span class="token punctuation">(</span>bl_nd<span class="token punctuation">,</span><span class="token string">"status"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">goto</span> fail_rs<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"status = %s\r\n"</span><span class="token punctuation">,</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">/*3.读取数类型*/</span>
    ret <span class="token operator">=</span> <span class="token function">of_property_read_u32</span><span class="token punctuation">(</span>bl_nd<span class="token punctuation">,</span><span class="token string">"default-brightness-level"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>shu_value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">goto</span> fail_shu<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"u32 default-brightness-level =%d\r\n"</span><span class="token punctuation">,</span>shu_value<span class="token punctuation">)</span><span class="token punctuation">;</span>

  

    <span class="token comment">/*4.获取数组类型*/</span>
    num <span class="token operator">=</span> <span class="token function">of_property_count_elems_of_size</span><span class="token punctuation">(</span>bl_nd<span class="token punctuation">,</span><span class="token string">"brightness-levels"</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"NO!\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> fail_duoshu<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"brightness-levels is  = %d 个\r\n"</span><span class="token punctuation">,</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// /*申请内存*/</span>
    <span class="token comment">// kkkmmmmm = kmalloc(num*sizeof(u32),GFP_KERNEL);</span>
    <span class="token comment">// if(!kkkmmmmm)</span>
    <span class="token comment">// {<!-- --></span>
    <span class="token comment">//     printk("malloc memory error \r\n");</span>
    <span class="token comment">//     ret = -EINVAL;</span>
    <span class="token comment">//     goto fail_memory;</span>
    <span class="token comment">// }</span>

    <span class="token comment">/*获取数组*/</span>
    ret <span class="token operator">=</span> <span class="token function">of_property_read_u32_array</span><span class="token punctuation">(</span>bl_nd<span class="token punctuation">,</span><span class="token string">"brightness-levels"</span><span class="token punctuation">,</span>kkkmmmmm<span class="token punctuation">,</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">goto</span> fail_11<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>num<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"brightness-levels[%d] =%d\r\n"</span><span class="token punctuation">,</span>i<span class="token punctuation">,</span>kkkmmmmm<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// kfree(kkkmmmmm);</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>


    
    fail_11<span class="token operator">:</span>
    <span class="token comment">//fail_memory:</span>
    fail_duoshu<span class="token operator">:</span>
    fail_shu<span class="token operator">:</span>
    fail_rs<span class="token operator">:</span>
    fail_find<span class="token operator">:</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">dtsof_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>

<span class="token punctuation">}</span>


<span class="token comment">/*模块入口出口*/</span>
<span class="token function">module_init</span><span class="token punctuation">(</span>dtsof_init<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>dtsof_exit<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"wyt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     这段利用的是数组kkkmmmmm，如果利用指针的话要先在内核中用kmalloc函数开辟内存空间，不然会有问题。因为用数组的话，相当于在内存中地址已经给出了，of_property_read_u32_array(const struct device_node *np,const char *propname,
     <br/>
     u32 *out_values, size_t sz）放得到的out_values数据就行。如果用指针类型，u32 *kkkmmmmm,要用kmalloc函数，当 kmalloc 函数成功执行时，它会返回一个指向所分配内存块起始地址的指针，然后这个指针会被赋值给 kkkmmmmm。这意味着 kkkmmmmm 现在指向了一个确定的、新分配的内存地址。然后将得到的数据out_values放到这个内存中。不利用kmalloc函数的话，得到的数据无法用这个指针指向。
    </p>
    <h3>
     <a id="2led_357">
     </a>
     2.将led寄存器信息放到设备树中
    </h3>
    <h4>
     <a id="21led_358">
     </a>
     2.1创建led节点
    </h4>
    <p>
     位置暂且放在根目录下：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/72579d05e89e40ef93591c2bf6dbfba0.png">
      ### 2.2 函数实现
     </img>
    </p>
    <pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/errno.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/gpio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/cdev.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kdev_t.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/device.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/mach/map.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/uaccess.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/io.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/delay.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fs.h&gt;</span>  <span class="token comment">// 包含 register_chrdev_region 的定义</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/device.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/of.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/of_address.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/of_irq.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEVICE_NAME</span> <span class="token string">"dtsofled"</span></span>
<span class="token comment">// /*相关寄存器对应地址*/</span>
<span class="token comment">// #define CCM_CCGR1_BASE          (0X020C406C)</span>
<span class="token comment">// #define SW_MUX_GPIO1_IO03_BASE   (0X020E0068)</span>
<span class="token comment">// #define SW_PAD_GPIO1_IO03_BASE   (0X020E02F4)</span>
<span class="token comment">// #define GPIO1_DR_BASE            (0X0209C000)</span>
<span class="token comment">// #define GPIO1_GDIR_BASE          (0X0209C004)</span>

<span class="token comment">/*虚拟地址指针*/</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> __iomem  <span class="token operator">*</span>CCM_CCGR1<span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> __iomem  <span class="token operator">*</span>SW_MUX_GPIO1_IO03<span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> __iomem  <span class="token operator">*</span>SW_PAD_GPIO1_IO03<span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> __iomem  <span class="token operator">*</span>GPIO1_DR<span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> __iomem  <span class="token operator">*</span>GPIO1_GDIR<span class="token punctuation">;</span>


<span class="token comment">/*注册和创建节点用第结构体*/</span>
<span class="token keyword">struct</span> <span class="token class-name">dtsled_dev</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">struct</span>  <span class="token class-name">class</span> <span class="token operator">*</span>class<span class="token punctuation">;</span><span class="token comment">//创建类</span>
        <span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>device<span class="token punctuation">;</span><span class="token comment">//创建节点  </span>
        <span class="token keyword">struct</span> <span class="token class-name">cdev</span> dtsofled_cdev<span class="token punctuation">;</span><span class="token comment">//字符设备</span>
        <span class="token class-name">dev_t</span> device_hao<span class="token punctuation">;</span><span class="token comment">//设备号        </span>
        <span class="token keyword">int</span> major<span class="token punctuation">;</span><span class="token comment">//主设备号</span>
        <span class="token keyword">int</span> minor<span class="token punctuation">;</span><span class="token comment">//次设备号</span>

<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">dtsled_dev</span> dtsled<span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">led_chioce</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> on_and_off<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">static</span> <span class="token keyword">int</span> register_led <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>on_and_off <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token comment">//开</span>
    <span class="token punctuation">{<!-- --></span>
        register_led <span class="token operator">=</span> <span class="token function">readl</span><span class="token punctuation">(</span>GPIO1_DR<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        register_led <span class="token operator">&amp;=</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">writel</span><span class="token punctuation">(</span>register_led<span class="token punctuation">,</span>GPIO1_DR<span class="token punctuation">)</span><span class="token punctuation">;</span>         
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>          <span class="token comment">//关 </span>
        register_led <span class="token operator">=</span> <span class="token function">readl</span><span class="token punctuation">(</span>GPIO1_DR<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        register_led <span class="token operator">|=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">writel</span><span class="token punctuation">(</span>register_led<span class="token punctuation">,</span>GPIO1_DR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">dtsofled_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">dtsofled_close</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">dtsofled_read</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">,</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span>ppos<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">dtsofled_write</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span>ppos<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> writebuff<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">__copy_from_user</span><span class="token punctuation">(</span>writebuff<span class="token punctuation">,</span>buf<span class="token punctuation">,</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">led_chioce</span><span class="token punctuation">(</span>writebuff<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token keyword">struct</span>  <span class="token class-name">file_operations</span> dtsofled_fops <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>read <span class="token operator">=</span> dtsofled_read<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>write <span class="token operator">=</span> dtsofled_write<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>open <span class="token operator">=</span> dtsofled_open<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>release <span class="token operator">=</span> dtsofled_close<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">dtsofled_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> ret<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>num<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> register_result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>led_nd <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token comment">//节点</span>
    <span class="token keyword">struct</span> <span class="token class-name">property</span> <span class="token operator">*</span>led_property <span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token comment">//属性</span>
    u32 led_reg<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//reg</span>


    <span class="token comment">/*查询设备树信息*/</span>
    <span class="token comment">/*找节点*/</span>
    led_nd <span class="token operator">=</span> <span class="token function">of_find_node_by_path</span><span class="token punctuation">(</span><span class="token string">"/alphaled"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"OK node \r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">/*获取属性*/</span>
    led_property <span class="token operator">=</span> <span class="token function">of_find_property</span><span class="token punctuation">(</span>led_nd<span class="token punctuation">,</span><span class="token string">"status"</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"led compatible = %s\r\n"</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>led_property<span class="token operator">-&gt;</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/*获取reg值*/</span>
    num <span class="token operator">=</span> <span class="token function">of_property_count_elems_of_size</span><span class="token punctuation">(</span>led_nd<span class="token punctuation">,</span><span class="token string">"reg"</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//reg里面几个值</span>
    <span class="token function">of_property_read_u32_array</span><span class="token punctuation">(</span>led_nd<span class="token punctuation">,</span><span class="token string">"reg"</span><span class="token punctuation">,</span>led_reg<span class="token punctuation">,</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"led reg[%d] = %x\r\n"</span><span class="token punctuation">,</span>i<span class="token punctuation">,</span>led_reg<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>

    <span class="token comment">/*寄存器第地址映射*/</span>
    <span class="token comment">/*1.将物理地址*_BASE和虚拟地址联系起来*/</span>
    CCM_CCGR1 <span class="token operator">=</span> <span class="token function">ioremap</span><span class="token punctuation">(</span>led_reg<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>led_reg<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//右边是实际物理地址，左边是虚拟地址</span>
    SW_MUX_GPIO1_IO03 <span class="token operator">=</span> <span class="token function">ioremap</span><span class="token punctuation">(</span>led_reg<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>led_reg<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    SW_PAD_GPIO1_IO03 <span class="token operator">=</span> <span class="token function">ioremap</span><span class="token punctuation">(</span>led_reg<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span>led_reg<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIO1_DR <span class="token operator">=</span> <span class="token function">ioremap</span><span class="token punctuation">(</span>led_reg<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span>led_reg<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIO1_GDIR <span class="token operator">=</span> <span class="token function">ioremap</span><span class="token punctuation">(</span>led_reg<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span>led_reg<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/*2.初始化*/</span>

    <span class="token comment">/*2.1 时钟初始化*/</span>
    register_result <span class="token operator">=</span> <span class="token function">readl</span><span class="token punctuation">(</span>CCM_CCGR1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    register_result <span class="token operator">|=</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token operator">&lt;&lt;</span><span class="token number">26</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">writel</span><span class="token punctuation">(</span>register_result<span class="token punctuation">,</span>CCM_CCGR1<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/*2.2复用初始化*/</span>
    <span class="token function">writel</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span>SW_MUX_GPIO1_IO03<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/*2.3电器属性初始化*/</span>
    <span class="token function">writel</span><span class="token punctuation">(</span><span class="token number">0x10b0</span><span class="token punctuation">,</span>SW_PAD_GPIO1_IO03<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/*2.4设置为输出模式*/</span>
    register_result <span class="token operator">=</span> <span class="token function">readl</span><span class="token punctuation">(</span>GPIO1_GDIR<span class="token punctuation">)</span><span class="token punctuation">;</span>   
    register_result <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">writel</span><span class="token punctuation">(</span>register_result<span class="token punctuation">,</span>GPIO1_GDIR<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/*2.5控制亮*/</span>
    register_result <span class="token operator">=</span> <span class="token function">readl</span><span class="token punctuation">(</span>GPIO1_DR<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    register_result <span class="token operator">&amp;=</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">writel</span><span class="token punctuation">(</span>register_result<span class="token punctuation">,</span>GPIO1_DR<span class="token punctuation">)</span><span class="token punctuation">;</span> 



    <span class="token comment">/*注册字符设备  设备号 注册函数 */</span>
    <span class="token comment">/*1.设备号，如果设置了设备号，还要用杂感注册函数，主要就是为了让内核承认这个设号*/</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>dtsled<span class="token punctuation">.</span>major<span class="token punctuation">)</span><span class="token comment">//如果设置了主设备号</span>
    <span class="token punctuation">{<!-- --></span>
        dtsled<span class="token punctuation">.</span>device_hao <span class="token operator">=</span> <span class="token function">MKDEV</span><span class="token punctuation">(</span>dtsled<span class="token punctuation">.</span>major<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret <span class="token operator">=</span> <span class="token function">register_chrdev_region</span><span class="token punctuation">(</span>dtsled<span class="token punctuation">.</span>device_hao<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token string">"dtsofled"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> 
    <span class="token punctuation">{<!-- --></span>
        ret <span class="token operator">=</span> <span class="token function">alloc_chrdev_region</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dtsled<span class="token punctuation">.</span>device_hao<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"dtsofled"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"major = %d，minor = %d\r\n"</span><span class="token punctuation">,</span><span class="token function">MAJOR</span><span class="token punctuation">(</span>dtsled<span class="token punctuation">.</span>device_hao<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">MINOR</span><span class="token punctuation">(</span>dtsled<span class="token punctuation">.</span>device_hao<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/*2.注册函数*/</span>
    dtsled<span class="token punctuation">.</span>dtsofled_cdev<span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">;</span>
    <span class="token function">cdev_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dtsled<span class="token punctuation">.</span>dtsofled_cdev<span class="token punctuation">,</span><span class="token operator">&amp;</span>dtsofled_fops<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//将字符设备和注册函数关联其来</span>
    <span class="token function">cdev_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dtsled<span class="token punctuation">.</span>dtsofled_cdev<span class="token punctuation">,</span>dtsled<span class="token punctuation">.</span>device_hao<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//添加到内核中</span>

    <span class="token comment">/*3.设备节点，即主动在/dev/下创建这个节点*/</span>
    dtsled<span class="token punctuation">.</span>class <span class="token operator">=</span> <span class="token function">class_create</span><span class="token punctuation">(</span>THIS_MODULE<span class="token punctuation">,</span>DEVICE_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//类创建</span>
    dtsled<span class="token punctuation">.</span>device <span class="token operator">=</span> <span class="token function">device_create</span><span class="token punctuation">(</span>dtsled<span class="token punctuation">.</span>class<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>dtsled<span class="token punctuation">.</span>device_hao<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>DEVICE_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>




     
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">dtsofled_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> register_result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">/*控制灭*/</span>
    register_result <span class="token operator">=</span> <span class="token function">readl</span><span class="token punctuation">(</span>GPIO1_DR<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    register_result <span class="token operator">|=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">writel</span><span class="token punctuation">(</span>register_result<span class="token punctuation">,</span>GPIO1_DR<span class="token punctuation">)</span><span class="token punctuation">;</span> 

    <span class="token comment">/*1.取消虚拟地址映射*/</span>
    <span class="token function">iounmap</span><span class="token punctuation">(</span>CCM_CCGR1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">iounmap</span><span class="token punctuation">(</span>SW_MUX_GPIO1_IO03<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">iounmap</span><span class="token punctuation">(</span>SW_PAD_GPIO1_IO03<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">iounmap</span><span class="token punctuation">(</span>GPIO1_DR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">iounmap</span><span class="token punctuation">(</span>GPIO1_GDIR<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"exit in linux\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//注销</span>
    <span class="token function">cdev_del</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dtsled<span class="token punctuation">.</span>dtsofled_cdev<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//先解除和注册函数的关系</span>
    <span class="token function">unregister_chrdev_region</span><span class="token punctuation">(</span>dtsled<span class="token punctuation">.</span>device_hao<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//解除和设备号的关系</span>
    <span class="token function">device_destroy</span><span class="token punctuation">(</span>dtsled<span class="token punctuation">.</span>class<span class="token punctuation">,</span>dtsled<span class="token punctuation">.</span>device_hao<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//摧毁设备</span>
    <span class="token function">class_destroy</span><span class="token punctuation">(</span>dtsled<span class="token punctuation">.</span>class<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//摧毁类</span>
<span class="token punctuation">}</span>

<span class="token comment">/*注册驱动和卸载驱动*/</span>
<span class="token function">module_init</span><span class="token punctuation">(</span>dtsofled_init<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>dtsofled_exit<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"wyt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f:626c6f672e6373646e2e6e65742f787878783132333434352f:61727469636c652f64657461696c732f313436313136383038" class_="artid" style="display:none">
 </p>
</div>


