---
layout: post
title: "MySQL-æ•°æ®å½’æ¡£è‡ªåŠ¨åŒ–Python-pt-archiver-æ‰“é€ é«˜æ•ˆè¿ç»´åˆ©å™¨"
date: 2025-03-06 17:42:38 +0800
description: "12+å½’æ¡£ä»»åŠ¡éœ€äººå·¥ç›‘æ§ï¼šæ‰‹å·¥é€æ¡æ ¸æŸ¥æ—¥å¿—ï¼ˆæˆåŠŸç‡/è€—æ—¶/æ•°æ®é‡ï¼‰ï¼šäººå·¥å·¡æ£€å­˜åœ¨æ¼æ£€é£é™©ï¼šmysql_archiver å°å·¥å…·ä¸ºäº†è§£å†³ä¸Šè¿°ç—›ç‚¹ï¼Œæˆ‘ä»¬å¼€å‘äº†ä¸€æ¬¾åä¸º mysql_archiver çš„ Python å°å·¥å…·ï¼Œæ—¨åœ¨å®ç° MySQL æ•°æ®å½’æ¡£çš„è‡ªåŠ¨åŒ–ç®¡ç†ã€‚"
keywords: "MySQL æ•°æ®å½’æ¡£è‡ªåŠ¨åŒ–ï¼šPython + pt-archiver æ‰“é€ é«˜æ•ˆè¿ç»´åˆ©å™¨"
categories: ['é—²è°ˆ', 'Python']
tags: ['è¿ç»´', 'è‡ªåŠ¨åŒ–', 'Mysql']
artid: "146075051"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146075051
    alt: "MySQL-æ•°æ®å½’æ¡£è‡ªåŠ¨åŒ–Python-pt-archiver-æ‰“é€ é«˜æ•ˆè¿ç»´åˆ©å™¨"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146075051
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146075051
cover: https://bing.ee123.net/img/rand?artid=146075051
image: https://bing.ee123.net/img/rand?artid=146075051
img: https://bing.ee123.net/img/rand?artid=146075051
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     MySQL æ•°æ®å½’æ¡£è‡ªåŠ¨åŒ–ï¼šPython + pt-archiver æ‰“é€ é«˜æ•ˆè¿ç»´åˆ©å™¨
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="MySQL_Python__ptarchiver__0">
     </a>
     MySQL æ•°æ®å½’æ¡£è‡ªåŠ¨åŒ–ï¼šPython + pt-archiver æ‰“é€ é«˜æ•ˆè¿ç»´åˆ©å™¨
    </h2>
    <h3>
     <a id="_1">
     </a>
     ä¸€ã€ç—›ç‚¹æ´å¯Ÿï¼šä»æ‰‹å·¥åˆ°è‡ªåŠ¨åŒ–çš„èœ•å˜
    </h3>
    <h4>
     <a id="_2">
     </a>
     ç”Ÿäº§ç¯å¢ƒå½’æ¡£ä¹‹æ®‡
    </h4>
    <ul>
     <li>
      <p>
       <strong>
        åœºæ™¯æŒ‘æˆ˜
       </strong>
       ï¼š12+å½’æ¡£ä»»åŠ¡éœ€äººå·¥ç›‘æ§
      </p>
     </li>
     <li>
      <p>
       <strong>
        æ•ˆç‡ç“¶é¢ˆ
       </strong>
       ï¼šæ‰‹å·¥é€æ¡æ ¸æŸ¥æ—¥å¿—ï¼ˆæˆåŠŸç‡/è€—æ—¶/æ•°æ®é‡ï¼‰
      </p>
     </li>
     <li>
      <p>
       <strong>
        è¿ç»´é£é™©
       </strong>
       ï¼šäººå·¥å·¡æ£€å­˜åœ¨æ¼æ£€é£é™©
      </p>
     </li>
     <li>
      <p>
       <strong>
        è§£å†³æ–¹æ¡ˆ
       </strong>
       ï¼šmysql_archiver å°å·¥å…·
       <br/>
       ä¸ºäº†è§£å†³ä¸Šè¿°ç—›ç‚¹ï¼Œæˆ‘ä»¬å¼€å‘äº†ä¸€æ¬¾åä¸º mysql_archiver çš„ Python å°å·¥å…·ï¼Œæ—¨åœ¨å®ç° MySQL æ•°æ®å½’æ¡£çš„è‡ªåŠ¨åŒ–ç®¡ç†ã€‚
      </p>
     </li>
     <li>
      <p>
       <strong>
        ä¸‹è½½åœ°å€
       </strong>
       ï¼š
       <a href="https://github.com/dbarun/mysql_archiver">
        Download
       </a>
      </p>
     </li>
    </ul>
    <hr/>
    <h3>
     <a id="_12">
     </a>
     äºŒã€æ¶æ„è®¾è®¡ï¼šä¸‰ä½ä¸€ä½“çš„æ™ºèƒ½ä½“ç³»
    </h3>
    <h4>
     <a id="21__13">
     </a>
     2.1 æ ¸å¿ƒåŠŸèƒ½çŸ©é˜µ
    </h4>
    <table>
     <thead>
      <tr>
       <th>
        æ¨¡å—
       </th>
       <th>
        åŠŸèƒ½æè¿°
       </th>
       <th>
        æŠ€æœ¯å®ç°
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        ä»»åŠ¡è°ƒåº¦ä¸­å¿ƒ
       </td>
       <td>
        è‡ªåŠ¨åŒ–æ‰§è¡Œå½’æ¡£ä»»åŠ¡
       </td>
       <td>
        Python + crontab
       </td>
      </tr>
      <tr>
       <td>
        å¥åº·ç›‘æ§ç³»ç»Ÿ
       </td>
       <td>
        å¼‚å¸¸å®æ—¶å‘Šè­¦
       </td>
       <td>
        Zabbix + æ—¥å¿—åˆ†æ
       </td>
      </tr>
      <tr>
       <td>
        æ•°æ®æŠ¥è¡¨å¹³å°
       </td>
       <td>
        å¤šç»´è¿è¥åˆ†æ
       </td>
       <td>
        Pandas + é‚®ä»¶æ¨é€
       </td>
      </tr>
     </tbody>
    </table>
    <hr/>
    <h3>
     <a id="_22">
     </a>
     ä¸‰ã€æ ¸å¿ƒå®ç°è§£æ
    </h3>
    <h4>
     <a id="31_db_archive_execpy_23">
     </a>
     3.1 æ™ºèƒ½è°ƒåº¦å¼•æ“ï¼ˆdb_archive_exec.pyï¼‰
    </h4>
    <h5>
     <a id="_24">
     </a>
     æ•°æ®åº“è®¾è®¡
    </h5>
    <p>
     <strong>
      ä»»åŠ¡é…ç½®è¡¨ï¼ˆdb_archive_infoï¼‰
     </strong>
    </p>
    <pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>db_archive_info<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>source_db<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'æºæ•°æ®åº“'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>archive_condition<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'å½’æ¡£æ¡ä»¶'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>batch_size<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">'1000'</span> <span class="token keyword">COMMENT</span> <span class="token string">'æ‰¹å¤„ç†é‡'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span>
</code></pre>
    <p>
     <strong>
      æ‰§è¡Œæ—¥å¿—è¡¨ï¼ˆdb_archive_logï¼‰
     </strong>
    </p>
    <pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>db_archive_log<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>task_id<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>start_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>duration<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'æ‰§è¡Œæ—¶é•¿(ç§’)'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>archived_rows<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span>
</code></pre>
    <h5>
     <a id="_48">
     </a>
     è°ƒåº¦æµç¨‹
    </h5>
    <div class="mermaid">
     <svg class="mermaid-svg" height="447" id="mermaid-svg-5U3btxMD1hEdgM6m" viewbox="0 0 298 447" width="298" xmlns="http://www.w3.org/2000/svg">
      <style>
       #mermaid-svg-5U3btxMD1hEdgM6m {font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}#mermaid-svg-5U3btxMD1hEdgM6m .error-icon{fill:#552222;}#mermaid-svg-5U3btxMD1hEdgM6m .error-text{fill:#552222;stroke:#552222;}#mermaid-svg-5U3btxMD1hEdgM6m .edge-thickness-normal{stroke-width:2px;}#mermaid-svg-5U3btxMD1hEdgM6m .edge-thickness-thick{stroke-width:3.5px;}#mermaid-svg-5U3btxMD1hEdgM6m .edge-pattern-solid{stroke-dasharray:0;}#mermaid-svg-5U3btxMD1hEdgM6m .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-svg-5U3btxMD1hEdgM6m .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-svg-5U3btxMD1hEdgM6m .marker{fill:#333333;stroke:#333333;}#mermaid-svg-5U3btxMD1hEdgM6m .marker.cross{stroke:#333333;}#mermaid-svg-5U3btxMD1hEdgM6m svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-svg-5U3btxMD1hEdgM6m .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#mermaid-svg-5U3btxMD1hEdgM6m .cluster-label text{fill:#333;}#mermaid-svg-5U3btxMD1hEdgM6m .cluster-label span{color:#333;}#mermaid-svg-5U3btxMD1hEdgM6m .label text,#mermaid-svg-5U3btxMD1hEdgM6m span{fill:#333;color:#333;}#mermaid-svg-5U3btxMD1hEdgM6m .node rect,#mermaid-svg-5U3btxMD1hEdgM6m .node circle,#mermaid-svg-5U3btxMD1hEdgM6m .node ellipse,#mermaid-svg-5U3btxMD1hEdgM6m .node polygon,#mermaid-svg-5U3btxMD1hEdgM6m .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#mermaid-svg-5U3btxMD1hEdgM6m .node .label{text-align:center;}#mermaid-svg-5U3btxMD1hEdgM6m .node.clickable{cursor:pointer;}#mermaid-svg-5U3btxMD1hEdgM6m .arrowheadPath{fill:#333333;}#mermaid-svg-5U3btxMD1hEdgM6m .edgePath .path{stroke:#333333;stroke-width:2.0px;}#mermaid-svg-5U3btxMD1hEdgM6m .flowchart-link{stroke:#333333;fill:none;}#mermaid-svg-5U3btxMD1hEdgM6m .edgeLabel{background-color:#e8e8e8;text-align:center;}#mermaid-svg-5U3btxMD1hEdgM6m .edgeLabel rect{opacity:0.5;background-color:#e8e8e8;fill:#e8e8e8;}#mermaid-svg-5U3btxMD1hEdgM6m .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#mermaid-svg-5U3btxMD1hEdgM6m .cluster text{fill:#333;}#mermaid-svg-5U3btxMD1hEdgM6m .cluster span{color:#333;}#mermaid-svg-5U3btxMD1hEdgM6m div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#mermaid-svg-5U3btxMD1hEdgM6m :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}
      </style>
      <g>
       <g class="output">
        <g class="clusters">
        </g>
        <g class="edgePaths">
         <g class="edgePath LS-A LE-B" id="L-A-B" style="opacity: 1;">
          <path class="path" d="M149,54L149,58.166666666666664C149,62.333333333333336,149,70.66666666666667,149,79C149,87.33333333333333,149,95.66666666666667,149,99.83333333333333L149,104" marker-end="url(#arrowhead319)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead319" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-B LE-C" id="L-B-C" style="opacity: 1;">
          <path class="path" d="M149,150L149,154.16666666666666C149,158.33333333333334,149,166.66666666666666,149.08333333333334,175.08333333333334C149.16666666666666,183.5,149.33333333333334,192,149.41666666666666,196.25L149.5,200.5" marker-end="url(#arrowhead320)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead320" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-C LE-D" id="L-C-D" style="opacity: 1;">
          <path class="path" d="M122.44986072423399,290.449860724234L113.04155060352832,301.208217270195C103.63324048282266,311.966573816156,84.81662024141133,333.483286908078,75.40831012070566,350.57497678737235C66,367.6666666666667,66,380.3333333333333,66,386.6666666666667L66,393" marker-end="url(#arrowhead321)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead321" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-C LE-E" id="L-C-E" style="opacity: 1;">
          <path class="path" d="M176.550139275766,290.449860724234L185.79178272980502,301.208217270195C195.033426183844,311.966573816156,213.516713091922,333.483286908078,222.758356545961,350.57497678737235C232,367.6666666666667,232,380.3333333333333,232,386.6666666666667L232,393" marker-end="url(#arrowhead322)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead322" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
        </g>
        <g class="edgeLabels">
         <g class="edgeLabel" style="opacity: 1;" transform="">
          <g class="label" transform="translate(0,0)">
           <rect height="0" rx="0" ry="0" width="0">
           </rect>
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-A' L-LE-B" id="L-L-A-B">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="">
          <g class="label" transform="translate(0,0)">
           <rect height="0" rx="0" ry="0" width="0">
           </rect>
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-B' L-LE-C" id="L-L-B-C">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="translate(66,355)">
          <g class="label" transform="translate(-16,-13)">
           <rect height="26" rx="0" ry="0" width="32">
           </rect>
           <foreignobject height="26" width="32">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-C' L-LE-D" id="L-L-C-D">
              æˆåŠŸ
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="translate(232,355)">
          <g class="label" transform="translate(-16,-13)">
           <rect height="26" rx="0" ry="0" width="32">
           </rect>
           <foreignobject height="26" width="32">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-C' L-LE-E" id="L-L-C-E">
              å¤±è´¥
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
        </g>
        <g class="nodes">
         <g class="node default" id="flowchart-A-216" style="opacity: 1;" transform="translate(149,31)">
          <rect class="label-container" height="46" rx="0" ry="0" width="116" x="-58" y="-23">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-48,-13)">
            <foreignobject height="26" width="96">
             <div style="display: inline-block; white-space: nowrap;">
              è¯»å–ä»»åŠ¡é…ç½®
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-B-217" style="opacity: 1;" transform="translate(149,127)">
          <rect class="label-container" height="46" rx="0" ry="0" width="163.77500915527344" x="-81.88750457763672" y="-23">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-71.88750457763672,-13)">
            <foreignobject height="26" width="143.77500915527344">
             <div style="display: inline-block; white-space: nowrap;">
              ç”Ÿæˆpt-archiverå‘½ä»¤
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-C-219" style="opacity: 1;" transform="translate(149,258.5)">
          <polygon class="label-container" points="58.5,0 117,-58.5 58.5,-117 0,-58.5" transform="translate(-58.5,58.5)">
          </polygon>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-32,-13)">
            <foreignobject height="26" width="64">
             <div style="display: inline-block; white-space: nowrap;">
              æ‰§è¡Œå½’æ¡£
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-D-221" style="opacity: 1;" transform="translate(66,416)">
          <rect class="label-container" height="46" rx="0" ry="0" width="116" x="-58" y="-23">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-48,-13)">
            <foreignobject height="26" width="96">
             <div style="display: inline-block; white-space: nowrap;">
              å†™å…¥æˆåŠŸæ—¥å¿—
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-E-223" style="opacity: 1;" transform="translate(232,416)">
          <rect class="label-container" height="46" rx="0" ry="0" width="116" x="-58" y="-23">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-48,-13)">
            <foreignobject height="26" width="96">
             <div style="display: inline-block; white-space: nowrap;">
              æ ‡è®°å¼‚å¸¸çŠ¶æ€
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
        </g>
       </g>
      </g>
     </svg>
    </div>
    <hr/>
    <h4>
     <a id="32_db_archive_monitorpy_59">
     </a>
     3.2 å®æ—¶ç›‘æ§ç³»ç»Ÿï¼ˆdb_archive_monitor.pyï¼‰
    </h4>
    <h5>
     <a id="_60">
     </a>
     æ ¸å¿ƒåŠŸèƒ½å®ç°
    </h5>
    <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">check_archive_status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># æŸ¥è¯¢å¤±è´¥ä»»åŠ¡è§†å›¾</span>
    failed_tasks <span class="token operator">=</span> query_sql<span class="token punctuation">(</span><span class="token triple-quoted-string string">"""
        SELECT task_name, error_message 
        FROM vw_db_archive_fail 
        WHERE log_date = CURDATE() - INTERVAL 1 DAY
    """</span><span class="token punctuation">)</span>
    
    <span class="token keyword">if</span> failed_tasks<span class="token punctuation">:</span>
        send_zabbix_alert<span class="token punctuation">(</span>
            priority<span class="token operator">=</span><span class="token string">'High'</span><span class="token punctuation">,</span>
            message<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f'å‘ç°</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">len</span><span class="token punctuation">(</span>failed_tasks<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">ä¸ªå½’æ¡£å¼‚å¸¸ä»»åŠ¡'</span></span>
        <span class="token punctuation">)</span>
        logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'å½’æ¡£å¼‚å¸¸æ˜ç»†: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>failed_tasks<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
</code></pre>
    <hr/>
    <h4>
     <a id="33_db_archive_report_weeklypy_80">
     </a>
     3.3 æ™ºèƒ½æŠ¥è¡¨ç³»ç»Ÿï¼ˆdb_archive_report_weekly.pyï¼‰
    </h4>
    <h5>
     <a id="_81">
     </a>
     æ•°æ®å¯è§†åŒ–ç¤ºä¾‹
    </h5>
    <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">generate_report</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_sql<span class="token punctuation">(</span><span class="token triple-quoted-string string">"""
        SELECT source_db, 
               SUM(archived_rows) AS total_rows,
               AVG(duration) AS avg_duration 
        FROM db_archive_log 
        WHERE log_date BETWEEN NOW() - INTERVAL 7 DAY AND NOW()
        GROUP BY source_db
    """</span><span class="token punctuation">,</span> con<span class="token operator">=</span>engine<span class="token punctuation">)</span>
    
    <span class="token comment"># ç”Ÿæˆäº¤äº’å¼å›¾è¡¨</span>
    fig <span class="token operator">=</span> px<span class="token punctuation">.</span>bar<span class="token punctuation">(</span>df<span class="token punctuation">,</span> x<span class="token operator">=</span><span class="token string">'source_db'</span><span class="token punctuation">,</span> y<span class="token operator">=</span><span class="token string">'total_rows'</span><span class="token punctuation">,</span> 
                title<span class="token operator">=</span><span class="token string">'å‘¨å½’æ¡£æ•°æ®ç»Ÿè®¡'</span><span class="token punctuation">)</span>
    fig<span class="token punctuation">.</span>write_html<span class="token punctuation">(</span><span class="token string">'/reports/weekly_summary.html'</span><span class="token punctuation">)</span>
</code></pre>
    <hr/>
    <h3>
     <a id="_101">
     </a>
     å››ã€ç”Ÿäº§éƒ¨ç½²æŒ‡å—
    </h3>
    <h4>
     <a id="41_Crontab_102">
     </a>
     4.1 Crontabé…ç½®ç¤ºä¾‹
    </h4>
    <pre><code class="prism language-bash"><span class="token comment"># æ¯å¤©å‡Œæ™¨æ‰§è¡Œå½’æ¡£</span>
<span class="token number">0</span> <span class="token number">2</span> * * * /usr/bin/python3 /opt/mysql_archiver/db_archive_exec.py <span class="token number">192.168</span>.1.100 production_db <span class="token operator">&gt;&gt;</span> /var/log/archive.log <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span>

<span class="token comment"># æ¯å‘¨ä¸€ç”ŸæˆæŠ¥å‘Š</span>
<span class="token number">0</span> <span class="token number">9</span> * * <span class="token number">1</span> /usr/bin/python3 /opt/mysql_archiver/db_archive_report_weekly.py
</code></pre>
    <h4>
     <a id="42__111">
     </a>
     4.2 ç›‘æ§é…ç½®è¦ç‚¹
    </h4>
    <ol>
     <li>
      Zabbixè§¦å‘å™¨é…ç½®ï¼šåŸºäºæ—¥å¿—é”™è¯¯å…³é”®å­—å‘Šè­¦
     </li>
     <li>
      æ€§èƒ½åŸºçº¿è®¾ç½®ï¼šå½’æ¡£è€—æ—¶é˜ˆå€¼å‘Šè­¦
     </li>
     <li>
      èµ„æºç›‘æ§ï¼šå½’æ¡£è¿‡ç¨‹CPU/IOç›‘æ§
     </li>
    </ol>
    <hr/>
    <h3>
     <a id="_118">
     </a>
     äº”ã€æ•ˆèƒ½æå‡å¯¹æ¯”
    </h3>
    <table>
     <thead>
      <tr>
       <th>
        æŒ‡æ ‡
       </th>
       <th>
        æ‰‹å·¥æ¨¡å¼
       </th>
       <th>
        è‡ªåŠ¨åŒ–æ¨¡å¼
       </th>
       <th>
        æå‡å€æ•°
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        ä»»åŠ¡æ£€æŸ¥è€—æ—¶
       </td>
       <td>
        30min/æ—¥
       </td>
       <td>
        0min
       </td>
       <td>
        âˆ
       </td>
      </tr>
      <tr>
       <td>
        å¼‚å¸¸å‘ç°æ—¶æ•ˆ
       </td>
       <td>
        æ¬¡æ—¥
       </td>
       <td>
        å®æ—¶
       </td>
       <td>
        24å€
       </td>
      </tr>
      <tr>
       <td>
        æŠ¥è¡¨ç”Ÿæˆæ•ˆç‡
       </td>
       <td>
        2h/æ¬¡
       </td>
       <td>
        è‡ªåŠ¨ç”Ÿæˆ
       </td>
       <td>
        100%
       </td>
      </tr>
     </tbody>
    </table>
    <hr/>
    <h3>
     <a id="_127">
     </a>
     å…­ã€æ¼”è¿›è·¯çº¿å›¾
    </h3>
    <ol>
     <li>
      <strong>
       V2.0è§„åˆ’
      </strong>
      ï¼šå¢åŠ å¯è§†åŒ–æ§åˆ¶å°
     </li>
     <li>
      <strong>
       æ™ºèƒ½é¢„æµ‹
      </strong>
      ï¼šåŸºäºå†å²æ•°æ®çš„å®¹é‡é¢„æµ‹
     </li>
     <li>
      <strong>
       äº‘åŸç”Ÿæ”¯æŒ
      </strong>
      ï¼šK8s Operatorç‰ˆæœ¬å¼€å‘
     </li>
     <li>
      <strong>
       AIå¢å¼º
      </strong>
      ï¼šå¼‚å¸¸æ ¹å› è‡ªåŠ¨åˆ†æ
     </li>
    </ol>
    <hr/>
    <h3>
     <a id="_135">
     </a>
     ç«‹å³è¡ŒåŠ¨
    </h3>
    <pre><code class="prism language-bash"><span class="token function">git</span> clone https://github.com/dbarun/mysql_archiver.git
<span class="token builtin class-name">cd</span> mysql_archiver <span class="token operator">&amp;&amp;</span> python setup.py <span class="token function">install</span>
</code></pre>
    <p>
     <strong>
      æ¨èå­¦ä¹ è·¯å¾„
     </strong>
     ï¼š
    </p>
    <ol>
     <li>
      <a href="https://www.percona.com/doc/percona-toolkit/LATEST/pt-archiver.html" rel="nofollow">
       pt-archiverå®˜æ–¹æ–‡æ¡£
      </a>
     </li>
     <li>
      Pythonå®šæ—¶ä»»åŠ¡è¿›é˜¶ï¼šCelery vs APScheduler
     </li>
     <li>
      ä¼ä¸šçº§ç›‘æ§æ–¹æ¡ˆï¼šPrometheus + Grafanaé›†æˆ
     </li>
    </ol>
    <hr/>
    <blockquote>
     <p>
      å¼€å‘çš„æœ¬è´¨æ˜¯é€šè¿‡è‡ªåŠ¨åŒ–å°†é‡å¤åŠ³åŠ¨è½¬åŒ–ä¸ºåˆ›é€ ä»·å€¼ï¼ ğŸ’¡
      <br/>
      æ¯ä¸€æ¬¡æŠ€æœ¯é©æ–°ï¼Œéƒ½æ˜¯å¯¹æ•ˆç‡çš„æè‡´è¿½æ±‚ã€‚
      <br/>
      è®©å·¥å…·æœåŠ¡äºäººï¼Œè€ŒéäººæœåŠ¡äºå·¥å…·ã€‚
     </p>
    </blockquote>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
  <div class="blog-vote-box" id="blogVoteBox" style="width:400px;margin:auto;margin-top:12px">
  </div>
 </article>
 <p alt="68747470733a2f2f:626c6f672e6373646e2e6e65742f5869616f52756e67656e2f:61727469636c652f64657461696c732f313436303735303531" class_="artid" style="display:none">
 </p>
</div>


