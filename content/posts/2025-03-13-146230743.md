---
layout: post
title: "centos7使用gpu加速的MinerU"
date: 2025-03-13 16:11:26 +0800
description: "由于官方只有ubantu的安装教程，并没有基于centos7的，故需要自己修改命令安装并使用。在运行此 Docker 容器之前，您可以使用以下命令检查您的设备是否支持 Docker 上的 CUDA 加速。注意cuda的版本需要和nvidia-smi中显示的一致验证结果：那就不用docker，"
keywords: "centos使用gpu"
categories: ['未分类']
tags: ['Pdf', 'Ocr']
artid: "146230743"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146230743
    alt: "centos7使用gpu加速的MinerU"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146230743
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146230743
cover: https://bing.ee123.net/img/rand?artid=146230743
image: https://bing.ee123.net/img/rand?artid=146230743
img: https://bing.ee123.net/img/rand?artid=146230743
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     centos7使用gpu加速的MinerU
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     https://mineru.readthedocs.io/zh-cn/latest/user_guide/install/boost_with_cuda.html
     <br/>
     由于官方只有ubantu的安装教程，并没有基于centos7的，故需要自己修改命令安装并使用。
    </p>
    <p>
     在运行此 Docker 容器之前，您可以使用以下命令检查您的设备是否支持 Docker 上的 CUDA 加速。
    </p>
    <pre><code class="prism language-bash"><span class="token function">docker</span> run <span class="token parameter variable">--rm</span> <span class="token parameter variable">--gpus</span><span class="token operator">=</span>all nvidia/cuda:12.1.0-base-centos7 nvidia-smi
</code></pre>
    <p>
     注意cuda的版本需要和nvidia-smi中显示的一致
     <br/>
     验证结果：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/b3c1e1c932ad4e6e9e8788565e107b06.png">
      <br/>
      那就不用docker，
      <strong>
       直接新建环境并在conda环境中使用gpu加速即可。
      </strong>
     </img>
    </p>
    <h3>
     <a id="1_magicpdf_12">
     </a>
     1.安装 magic-pdf
    </h3>
    <pre><code class="prism language-bash">conda create <span class="token parameter variable">-n</span> mineru <span class="token assign-left variable">python</span><span class="token operator">=</span><span class="token number">3.10</span>
conda activate mineru
pip <span class="token function">install</span> <span class="token parameter variable">-U</span> <span class="token string">"magic-pdf[full]"</span> --extra-index-url https://wheels.myhloli.com
</code></pre>
    <h3>
     <a id="2_20">
     </a>
     2.下载模型
    </h3>
    <p>
     将download_models_hf.py修改为使用modelscope下载
    </p>
    <pre><code class="prism language-python"><span class="token keyword">import</span> json
<span class="token keyword">import</span> os

<span class="token keyword">import</span> requests
<span class="token keyword">from</span> modelscope <span class="token keyword">import</span> snapshot_download


<span class="token keyword">def</span> <span class="token function">download_json</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 下载JSON文件</span>
    response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span>
    response<span class="token punctuation">.</span>raise_for_status<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 检查请求是否成功</span>
    <span class="token keyword">return</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">download_and_modify_json</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> local_filename<span class="token punctuation">,</span> modifications<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>local_filename<span class="token punctuation">)</span><span class="token punctuation">:</span>
        data <span class="token operator">=</span> json<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token builtin">open</span><span class="token punctuation">(</span>local_filename<span class="token punctuation">)</span><span class="token punctuation">)</span>
        config_version <span class="token operator">=</span> data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'config_version'</span><span class="token punctuation">,</span> <span class="token string">'0.0.0'</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> config_version <span class="token operator">&lt;</span> <span class="token string">'1.1.1'</span><span class="token punctuation">:</span>
            data <span class="token operator">=</span> download_json<span class="token punctuation">(</span>url<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        data <span class="token operator">=</span> download_json<span class="token punctuation">(</span>url<span class="token punctuation">)</span>

    <span class="token comment"># 修改内容</span>
    <span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token keyword">in</span> modifications<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        data<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value

    <span class="token comment"># 保存修改后的内容</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>local_filename<span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        json<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>data<span class="token punctuation">,</span> f<span class="token punctuation">,</span> ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> indent<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token comment"># ModelScope 模型路径</span>
    mineru_patterns <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token string">"models/Layout/LayoutLMv3/*"</span><span class="token punctuation">,</span>
        <span class="token string">"models/Layout/YOLO/*"</span><span class="token punctuation">,</span>
        <span class="token string">"models/MFD/YOLO/*"</span><span class="token punctuation">,</span>
        <span class="token string">"models/MFR/unimernet_small_2501/*"</span><span class="token punctuation">,</span>
        <span class="token string">"models/TabRec/TableMaster/*"</span><span class="token punctuation">,</span>
        <span class="token string">"models/TabRec/StructEqTable/*"</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
    model_dir <span class="token operator">=</span> snapshot_download<span class="token punctuation">(</span><span class="token string">'opendatalab/PDF-Extract-Kit-1.0'</span><span class="token punctuation">,</span> allow_patterns<span class="token operator">=</span>mineru_patterns<span class="token punctuation">)</span>

    layoutreader_pattern <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token string">"*.json"</span><span class="token punctuation">,</span>
        <span class="token string">"*.safetensors"</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
    <span class="token comment">#layoutreader_model_dir = snapshot_download('hantian/layoutreader', allow_patterns=layoutreader_pattern)</span>
    layoutreader_model_dir <span class="token operator">=</span> snapshot_download<span class="token punctuation">(</span><span class="token string">'zxyayase/layoutreader'</span><span class="token punctuation">,</span> allow_patterns<span class="token operator">=</span>layoutreader_pattern<span class="token punctuation">)</span>


    model_dir <span class="token operator">=</span> model_dir <span class="token operator">+</span> <span class="token string">'/models'</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'model_dir is: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>model_dir<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'layoutreader_model_dir is: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>layoutreader_model_dir<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>

    json_url <span class="token operator">=</span> <span class="token string">'https://github.com/opendatalab/MinerU/raw/master/magic-pdf.template.json'</span>
    config_file_name <span class="token operator">=</span> <span class="token string">'magic-pdf.json'</span>
    home_dir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>expanduser<span class="token punctuation">(</span><span class="token string">'~'</span><span class="token punctuation">)</span>
    config_file <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>home_dir<span class="token punctuation">,</span> config_file_name<span class="token punctuation">)</span>

    json_mods <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">'models-dir'</span><span class="token punctuation">:</span> model_dir<span class="token punctuation">,</span>
        <span class="token string">'layoutreader-model-dir'</span><span class="token punctuation">:</span> layoutreader_model_dir<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    download_and_modify_json<span class="token punctuation">(</span>json_url<span class="token punctuation">,</span> config_file<span class="token punctuation">,</span> json_mods<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'The configuration file has been configured successfully, the path is: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>config_file<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
</code></pre>
    <p>
     遇到报错说模型不存在：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/063e05821dcd4796aeb09e4392b29c91.png">
      <br/>
      修改为’zxyayase/layoutreader’即可
     </img>
    </p>
    <h3>
     <a id="3json_98">
     </a>
     3.验证json文件
    </h3>
    <p>
     如果 JSON 中不存在以下项目，请手动添加必填项目并删注释内容。
    </p>
    <pre><code class="prism language-bash"><span class="token punctuation">{<!-- --></span>
    // other config
    <span class="token string">"layout-config"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"model"</span><span class="token builtin class-name">:</span> <span class="token string">"doclayout_yolo"</span> // Please change to <span class="token string">"layoutlmv3"</span> when using layoutlmv3.
    <span class="token punctuation">}</span>,
    <span class="token string">"formula-config"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"mfd_model"</span><span class="token builtin class-name">:</span> <span class="token string">"yolo_v8_mfd"</span>,
        <span class="token string">"mfr_model"</span><span class="token builtin class-name">:</span> <span class="token string">"unimernet_small"</span>,
        <span class="token string">"enable"</span><span class="token builtin class-name">:</span> <span class="token boolean">true</span>  // The formula recognition feature is enabled by default. If you need to disable it, please change the value here to <span class="token string">"false"</span><span class="token builtin class-name">.</span>
    <span class="token punctuation">}</span>,
    <span class="token string">"table-config"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"model"</span><span class="token builtin class-name">:</span> <span class="token string">"rapid_table"</span>,  // Default to using <span class="token string">"rapid_table"</span>, can be switched to <span class="token string">"tablemaster"</span> or <span class="token string">"struct_eqtable"</span><span class="token builtin class-name">.</span>
        <span class="token string">"sub_model"</span><span class="token builtin class-name">:</span> <span class="token string">"slanet_plus"</span>,  // When the model is <span class="token string">"rapid_table"</span>, you can choose a sub_model. The options are <span class="token string">"slanet_plus"</span> and <span class="token string">"unitable"</span>
        <span class="token string">"enable"</span><span class="token builtin class-name">:</span> true, // The table recognition feature is enabled by default. If you need to disable it, please change the value here to <span class="token string">"false"</span><span class="token builtin class-name">.</span>
        <span class="token string">"max_time"</span><span class="token builtin class-name">:</span> <span class="token number">400</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/9a24ae229fca4510bd4213a8550d684d.png"/>
    </p>
    <h3>
     <a id="4cpu_123">
     </a>
     4.cpu运行
    </h3>
    <pre><code class="prism language-bash"><span class="token function">wget</span> https://gcore.jsdelivr.net/gh/opendatalab/MinerU@master/demo/small_ocr.pdf
magic-pdf <span class="token parameter variable">-p</span> small_ocr.pdf <span class="token parameter variable">-o</span> ./output
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/a746c4fc230449b996abba7e25f339f7.png"/>
    </p>
    <p>
     可见每页的处理时间大概是20多s。
    </p>
    <h3>
     <a id="5_gpu_133">
     </a>
     5. gpu运行
    </h3>
    <p>
     修改【用户目录】中配置文件 magic-pdf.json 中”device-mode”的值
    </p>
    <pre><code class="prism language-bash"><span class="token punctuation">{<!-- --></span>
  <span class="token string">"device-mode"</span><span class="token builtin class-name">:</span><span class="token string">"cuda"</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     再次执行
    </p>
    <pre><code class="prism language-bash">magic-pdf <span class="token parameter variable">-p</span> small_ocr.pdf <span class="token parameter variable">-o</span> ./output
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/e81b3da23bf047b2911359054d82e3a9.png"/>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f33353136363733302f:61727469636c652f64657461696c732f313436323330373433" class_="artid" style="display:none">
 </p>
</div>


