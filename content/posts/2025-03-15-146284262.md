---
layout: post
title: "Centos7使用docker搭建redis集群"
date: 2025-03-15 20:52:19 +0800
description: "命令搭建 Redis 集群，核心原因在于 Docker Swarm 提供了容器编排能力，而 Redis 集群的分布式特性需要依赖 Swarm 的底层架构实现多节点协同和管理。会创建 Swarm 集群的管理节点（Manager），负责调度服务、维护集群状态，并为后续加入的 Worker 节点提供通信基础‌，同时也提供了动态扩缩容能力等能力。关键参数‌：–advertise-addr 声明管理节点的通信地址，确保其他节点可访问‌36。注意：最好在服务器上找个专门的文件夹存放这些yml文件，免得后面找不到了。"
keywords: "Centos7使用docker搭建redis集群"
categories: ['架构设计与方案', 'Redis', 'Centos']
tags: ['容器', 'Redis', 'Redis', 'Docker']
artid: "146284262"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146284262
    alt: "Centos7使用docker搭建redis集群"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146284262
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146284262
cover: https://bing.ee123.net/img/rand?artid=146284262
image: https://bing.ee123.net/img/rand?artid=146284262
img: https://bing.ee123.net/img/rand?artid=146284262
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Centos7使用docker搭建redis集群
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h3>
     <a id="_0">
     </a>
     前置准备：
    </h3>
    <p>
     Centos7安装docker就不多说了…
    </p>
    <ul>
     <li>
      本次目的是搭建3主3从（当然你也可以按需扩展）
     </li>
     <li>
      准备三台服务器，假定IP分别为：192.168.75.128、192.168.75.129、192.168.75.130
     </li>
     <li>
      安装 redis：
     </li>
    </ul>
    <pre><code class="prism language-bash"><span class="token comment">#拉取redis</span>
<span class="token function">docker</span> pull redis:5.0.2
<span class="token comment">#创建容器并运行</span>
<span class="token function">docker</span> run <span class="token parameter variable">--name</span> redis  <span class="token parameter variable">-p</span> <span class="token number">6379</span>:6379 <span class="token parameter variable">-d</span> redis:5.0.2

</code></pre>
    <h3>
     <a id="1dockercomposeyml_14">
     </a>
     1、准备docker-compose.yml文件
    </h3>
    <blockquote>
     <p>
      注意：最好在服务器上找个专门的文件夹存放这些yml文件，免得后面找不到了
     </p>
    </blockquote>
    <h4>
     <a id="11_A19216875128_18">
     </a>
     1.1 服务器A【192.168.75.128】
    </h4>
    <pre><code class="prism language-yml"><span class="token comment"># 文件名: docker-compose.yml（部署在每台服务器上）</span>
<span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3.3'</span>

<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token comment"># 服务器 192.168.75.128 配置</span>
  <span class="token key atrule">redis-node1</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> redis<span class="token punctuation">:</span>5.0.2
    <span class="token key atrule">command</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>server <span class="token punctuation">-</span><span class="token punctuation">-</span>port 7001 <span class="token punctuation">-</span><span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>enabled yes <span class="token punctuation">-</span><span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>config<span class="token punctuation">-</span>file /data/nodes.conf <span class="token punctuation">-</span><span class="token punctuation">-</span>appendonly yes <span class="token punctuation">-</span><span class="token punctuation">-</span>bind 0.0.0.0 <span class="token punctuation">-</span><span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>announce<span class="token punctuation">-</span>ip 192.168.75.128
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"7001:7001"</span>
      <span class="token punctuation">-</span> <span class="token string">"17001:17001"</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ./data/node1<span class="token punctuation">:</span>/data
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> redis<span class="token punctuation">-</span>cluster

  <span class="token key atrule">redis-node2</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> redis<span class="token punctuation">:</span>5.0.2
    <span class="token key atrule">command</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>server <span class="token punctuation">-</span><span class="token punctuation">-</span>port 7002 <span class="token punctuation">-</span><span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>enabled yes <span class="token punctuation">-</span><span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>config<span class="token punctuation">-</span>file /data/nodes.conf <span class="token punctuation">-</span><span class="token punctuation">-</span>appendonly yes <span class="token punctuation">-</span><span class="token punctuation">-</span>bind 0.0.0.0 <span class="token punctuation">-</span><span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>announce<span class="token punctuation">-</span>ip 192.168.75.128
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"7002:7002"</span>
      <span class="token punctuation">-</span> <span class="token string">"17002:17002"</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ./data/node2<span class="token punctuation">:</span>/data
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> redis<span class="token punctuation">-</span>cluster

<span class="token comment"># 定义 redis-cluster 网络</span>
<span class="token key atrule">networks</span><span class="token punctuation">:</span>
  <span class="token key atrule">redis-cluster</span><span class="token punctuation">:</span>
    <span class="token key atrule">driver</span><span class="token punctuation">:</span> overlay  <span class="token comment"># 单机部署使用 bridge，多机部署可改用 overlay</span>
    <span class="token key atrule">attachable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token comment"># 允许独立容器加入网络</span>

<span class="token comment"># 服务器 192.168.75.129 和 192.168.75.130 的配置类似，需替换 IP 和数据目录：</span>
<span class="token comment"># 192.168.75.129: redis-node3 (7003), redis-node4 (7004)</span>
<span class="token comment"># 192.168.75.130: redis-node5 (7005), redis-node6 (7006)</span>
</code></pre>
    <h4>
     <a id="12_B19216875129_58">
     </a>
     1.2 服务B【192.168.75.129】
    </h4>
    <pre><code class="prism language-yml"><span class="token comment"># 文件名: docker-compose.yml（部署在每台服务器上）</span>
<span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3.3'</span>

<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token comment"># 服务器 192.168.75.129 配置</span>
  <span class="token key atrule">redis-node3</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> redis<span class="token punctuation">:</span>5.0.2
    <span class="token key atrule">command</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>server <span class="token punctuation">-</span><span class="token punctuation">-</span>port 7003 <span class="token punctuation">-</span><span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>enabled yes <span class="token punctuation">-</span><span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>config<span class="token punctuation">-</span>file /data/nodes.conf <span class="token punctuation">-</span><span class="token punctuation">-</span>appendonly yes <span class="token punctuation">-</span><span class="token punctuation">-</span>bind 0.0.0.0 <span class="token punctuation">-</span><span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>announce<span class="token punctuation">-</span>ip 192.168.75.129
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"7003:7003"</span>
      <span class="token punctuation">-</span> <span class="token string">"17003:17003"</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ./data/node3<span class="token punctuation">:</span>/data
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> redis<span class="token punctuation">-</span>cluster

  <span class="token key atrule">redis-node4</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> redis<span class="token punctuation">:</span>5.0.2
    <span class="token key atrule">command</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>server <span class="token punctuation">-</span><span class="token punctuation">-</span>port 7004 <span class="token punctuation">-</span><span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>enabled yes <span class="token punctuation">-</span><span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>config<span class="token punctuation">-</span>file /data/nodes.conf <span class="token punctuation">-</span><span class="token punctuation">-</span>appendonly yes <span class="token punctuation">-</span><span class="token punctuation">-</span>bind 0.0.0.0 <span class="token punctuation">-</span><span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>announce<span class="token punctuation">-</span>ip 192.168.75.129
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"7004:7004"</span>
      <span class="token punctuation">-</span> <span class="token string">"17004:17004"</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ./data/node4<span class="token punctuation">:</span>/data
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> redis<span class="token punctuation">-</span>cluster

<span class="token comment"># 定义 redis-cluster 网络</span>
<span class="token key atrule">networks</span><span class="token punctuation">:</span>
  <span class="token key atrule">redis-cluster</span><span class="token punctuation">:</span>
    <span class="token key atrule">driver</span><span class="token punctuation">:</span> overlay  <span class="token comment"># 单机部署使用 bridge，多机部署可改用 overlay</span>
    <span class="token key atrule">attachable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token comment"># 允许独立容器加入网络</span>

<span class="token comment"># 服务器 192.168.75.128 和 192.168.75.130 的配置类似，需替换 IP 和数据目录：</span>
<span class="token comment"># 192.168.75.128: redis-node1 (7001), redis-node2 (7002)</span>
<span class="token comment"># 192.168.75.130: redis-node5 (7005), redis-node6 (7006)</span>
</code></pre>
    <h4>
     <a id="13_C19216875130_99">
     </a>
     1.3 服务器C【192.168.75.130】
    </h4>
    <pre><code class="prism language-yml"><span class="token comment"># 文件名: docker-compose.yml（部署在每台服务器上）</span>
<span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3.3'</span>

<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token comment"># 服务器 192.168.75.130 配置</span>
  <span class="token key atrule">redis-node5</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> redis<span class="token punctuation">:</span>5.0.2
    <span class="token key atrule">command</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>server <span class="token punctuation">-</span><span class="token punctuation">-</span>port 7005 <span class="token punctuation">-</span><span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>enabled yes <span class="token punctuation">-</span><span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>config<span class="token punctuation">-</span>file /data/nodes.conf <span class="token punctuation">-</span><span class="token punctuation">-</span>appendonly yes <span class="token punctuation">-</span><span class="token punctuation">-</span>bind 0.0.0.0 <span class="token punctuation">-</span><span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>announce<span class="token punctuation">-</span>ip 192.168.75.130
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"7005:7005"</span>
      <span class="token punctuation">-</span> <span class="token string">"17005:17005"</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ./data/node5<span class="token punctuation">:</span>/data
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> redis<span class="token punctuation">-</span>cluster

  <span class="token key atrule">redis-node6</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> redis<span class="token punctuation">:</span><span class="token number">5.0</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>server <span class="token punctuation">-</span><span class="token punctuation">-</span>port 7006 <span class="token punctuation">-</span><span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>enabled yes <span class="token punctuation">-</span><span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>config<span class="token punctuation">-</span>file /data/nodes.conf <span class="token punctuation">-</span><span class="token punctuation">-</span>appendonly yes <span class="token punctuation">-</span><span class="token punctuation">-</span>bind 0.0.0.0 <span class="token punctuation">-</span><span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>announce<span class="token punctuation">-</span>ip 192.168.75.130
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"7006:7006"</span>
      <span class="token punctuation">-</span> <span class="token string">"17006:17006"</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ./data/node6<span class="token punctuation">:</span>/data
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> redis<span class="token punctuation">-</span>cluster

<span class="token comment"># 定义 redis-cluster 网络</span>
<span class="token key atrule">networks</span><span class="token punctuation">:</span>
  <span class="token key atrule">redis-cluster</span><span class="token punctuation">:</span>
    <span class="token key atrule">driver</span><span class="token punctuation">:</span> overlay  <span class="token comment"># 单机部署使用 bridge，多机部署可改用 overlay</span>
    <span class="token key atrule">attachable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token comment"># 允许独立容器加入网络</span>

<span class="token comment"># 服务器 192.168.75.128 和 192.168.75.129 的配置类似，需替换 IP 和数据目录：</span>
<span class="token comment"># 192.168.75.128: redis-node1 (7001), redis-node2 (7002)</span>
<span class="token comment"># 192.168.75.129: redis-node3 (7003), redis-node4 (7004)</span>
</code></pre>
    <h3>
     <a id="2dockercomposeyml_139">
     </a>
     2、执行docker-compose.yml文件
    </h3>
    <h4>
     <a id="21__141">
     </a>
     2.1 执行命令：
    </h4>
    <blockquote>
     <p>
      执行前先要使用安装下docker的编排组件：yum install docker-compose
     </p>
    </blockquote>
    <ul>
     <li>
      执行这个
      <code>
       yum install docker-compose
      </code>
      命令可能会提示没这个包，就需要执行如下命令：
     </li>
    </ul>
    <pre><code class="prism language-bash">更新yum源
<span class="token function">sudo</span> yum <span class="token parameter variable">-y</span> <span class="token function">install</span> epel-release
然后可以直接安装
yum <span class="token function">install</span> <span class="token function">docker-compose</span>
</code></pre>
    <ul>
     <li>
      <p>
       然后在yml文件所在目录执行如下命令：
       <code>
        docker-compose up -d
       </code>
      </p>
     </li>
     <li>
      <p>
       然后报错：
       <code>
        ERROR: This node is not a swarm manager. Use "docker swarm init" or "docker swarm join" to connect this node to swarm and try again
       </code>
       .
      </p>
     </li>
     <li>
      <p>
       这个提示需要使用
       <code>
        docker swarm init
       </code>
       命令搭建 Redis 集群，核心原因在于 Docker Swarm 提供了容器编排能力，而 Redis 集群的分布式特性需要依赖 Swarm 的底层架构实现多节点协同和管理。
       <code>
        docker swarm init
       </code>
       会创建 Swarm 集群的管理节点（Manager），负责调度服务、维护集群状态，并为后续加入的 Worker 节点提供通信基础‌，同时也提供了动态扩缩容能力等能力。
      </p>
     </li>
    </ul>
    <h4>
     <a id="22__Swarm__159">
     </a>
     2.2 初始化 Swarm 集群‌
    </h4>
    <p>
     若当前节点需作为 ‌管理节点‌（Manager）：
    </p>
    <pre><code class="prism language-bash"><span class="token comment"># 指定本机 IP 初始化 Swarm‌:ml-citation{ref="4,6" data="citationList"}  </span>
<span class="token function">docker</span> swarm init --advertise-addr <span class="token operator">&lt;</span>本机IP<span class="token operator">&gt;</span>  
</code></pre>
    <ul>
     <li>
      <p>
       关键参数‌：–advertise-addr 声明管理节点的通信地址，确保其他节点可访问‌36。
      </p>
     </li>
     <li>
      <p>
       成功标志‌：输出包含 Swarm initialized 及 Worker/Manager 加入命令‌
      </p>
     </li>
     <li>
      <p>
       有如下提示就表示加入成功：
       <br/>
       <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/6e6a0a61afab436a8b0e4bb85b080eff.png"/>
      </p>
     </li>
     <li>
      <p>
       继续执行命令：
       <code>
        docker-compose up -d
       </code>
       <br/>
       <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/6fe9a4a74f9d47bda5d20a356e545f8a.png"/>
      </p>
     </li>
    </ul>
    <h4>
     <a id="Redis_176">
     </a>
     执行Redis集群启动命令：
    </h4>
    <blockquote>
     <p>
      注意：执行前需要安装redis-cli工具，自行根据所需redis-lic版本安装
     </p>
    </blockquote>
    <pre><code class="prism language-bash"><span class="token comment"># --cluster-replicas 1‌：为每个主节点分配 1 个从节点‌</span>
‌<span class="token comment"># 自动分配规则‌：前 3 个 IP 为主节点，后 3 个 IP 为从节点‌</span>
redis-cli <span class="token parameter variable">--cluster</span> create <span class="token number">192.168</span>.75.128:7001 <span class="token number">192.168</span>.75.129:7003 <span class="token number">192.168</span>.75.130:7005 <span class="token number">192.168</span>.75.128:7002 <span class="token number">192.168</span>.75.129:7004 <span class="token number">192.168</span>.75.130:7006 --cluster-replicas <span class="token number">1</span>
</code></pre>
    <ul>
     <li>
      有如下信息表示集群启动成功：
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/51b412b512d54f3285b32aaf5a1ec865.png"/>
     </li>
     <li>
      再验证下：
      <code>
       redis-cli -h 192.168.75.128 -p 7001 cluster nodes
      </code>
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/fdb0ed04c32a4baeb79214fbe65dd054.png"/>
     </li>
    </ul>
    <p>
     爱在深秋~ peace ！
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f34303433363835342f:61727469636c652f64657461696c732f313436323834323632" class_="artid" style="display:none">
 </p>
</div>


