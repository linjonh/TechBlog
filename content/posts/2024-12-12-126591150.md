---
layout: post
title: "小程序音视频2live-player"
date: 2024-12-12 11:53:03 +0800
description: "是小程序内部用于支持音视频下行（播放）能力的功能标签，本文主要介绍该标签的使用方法。_live-pl"
keywords: "live-player resume"
categories: ['小程序']
tags: ['小程序']
artid: "126591150"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=126591150
    alt: "小程序音视频2live-player"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=126591150
featuredImagePreview: https://bing.ee123.net/img/rand?artid=126591150
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     小程序+音视频2：live-player
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <h4>
     前言：
    </h4>
    <h4>
     <a name="t1">
     </a>
     小程序中实现直播功能。
    </h4>
    <blockquote>
     <p>
      <strong>
       &lt;live-player&gt;
      </strong>
      是小程序内部用于支持音视频下行（播放）能力的功能标签，本文主要介绍该标签的使用方法。
     </p>
    </blockquote>
    <h3 id=".E7.89.88.E6.9C.AC.E6.94.AF.E6.8C.81">
     版本支持
    </h3>
    <ul>
     <li>
      微信 App iOS 最低版本要求：6.5.21 。
     </li>
     <li>
      微信 App Android 最低版本要求：6.5.19。
     </li>
     <li>
      小程序基础库最低版本要求：1.7.0。
     </li>
    </ul>
    <blockquote>
     <p>
      说明：
     </p>
     <p>
      通过 wx.getSystemInfo 可以获取当前基础库版本信息。
     </p>
    </blockquote>
    <h3 id=".E4.BD.BF.E7.94.A8.E9.99.90.E5.88.B6">
     使用限制
    </h3>
    <p>
     出于政策和合规的考虑，微信暂时没有放开所有小程序对
     <a href="https://developers.weixin.qq.com/miniprogram/dev/component/live-pusher.html" rel="nofollow" title=" &lt;live-pusher&gt;">
      &lt;live-pusher&gt;
     </a>
     和
     <a href="https://developers.weixin.qq.com/miniprogram/dev/component/live-player.html" rel="nofollow" title="&lt;live-player&gt;">
      &lt;live-player&gt;
     </a>
     标签的支持：
    </p>
    <ul>
     <li>
      个人账号和企业账号的小程序暂时只开放如下表格中的类目：
      <table>
       <tbody>
        <tr>
         <th>
          主类目
         </th>
         <th>
          子类目
         </th>
         <th>
          小程序内容场景
         </th>
        </tr>
        <tr>
         <td>
          社交
         </td>
         <td>
          直播
         </td>
         <td>
          涉及娱乐性质，如明星直播、生活趣事直播和宠物直播等。选择该类目后首次提交代码审核，需经当地互联网主管机关审核确认，预计审核时长7天左右
         </td>
        </tr>
        <tr>
         <td>
          教育
         </td>
         <td>
          在线视频课程
         </td>
         <td>
          网课、在线培训、讲座等教育类直播
         </td>
        </tr>
        <tr>
         <td>
          医疗
         </td>
         <td>
          互联网医院，公立医院
         </td>
         <td>
          问诊、大型健康讲座等直播
         </td>
        </tr>
        <tr>
         <td>
          金融
         </td>
         <td>
          银行、信托、基金、证券/期货、证券、期货投资咨询、保险、征信业务、新三板信息服务平台、股票信息服务平台（港股/美股）、消费金融
         </td>
         <td>
          金融产品视频客服理赔、金融产品推广直播等
         </td>
        </tr>
        <tr>
         <td>
          汽车
         </td>
         <td>
          汽车预售服务
         </td>
         <td>
          汽车预售、推广直播
         </td>
        </tr>
        <tr>
         <td>
          政府主体帐号
         </td>
         <td>
          -
         </td>
         <td>
          政府相关工作推广直播、领导讲话直播等
         </td>
        </tr>
        <tr>
         <td>
          工具
         </td>
         <td>
          视频客服
         </td>
         <td>
          不涉及以上几类内容的一对一视频客服服务，如企业售后一对一视频服务等
         </td>
        </tr>
        <tr>
         <td>
          IT 科技
         </td>
         <td>
          多方通信；音视频设备
         </td>
         <td>
          为多方提供电话会议/视频会议等服务；智能家居场景下控制摄像头
         </td>
        </tr>
       </tbody>
      </table>
     </li>
    </ul>
    <ul>
     <li>
      符合类目要求的小程序，需要在小程序管理后台的【设置】&gt;【接口设置】中自助开通该组件权限，如下图所示：
      <p class="img-center">
       <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/4317bb4c000fdabd5c4a8c7587af4f16.png"/>
      </p>
     </li>
    </ul>
    <blockquote>
     <p>
      注意：
     </p>
     <p>
      如果以上设置都正确，但小程序依然不能正常工作，可能是微信内部的缓存没更新，请删除小程序并重启微信后，再进行尝试。
     </p>
    </blockquote>
    <h3 id=".E5.B1.9E.E6.80.A7.E5.AE.9A.E4.B9.89">
     属性定义
    </h3>
    <table>
     <thead>
      <tr>
       <th>
        属性名
       </th>
       <th>
        类型
       </th>
       <th>
        默认值
       </th>
       <th>
        说明
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        src
       </td>
       <td>
        String
       </td>
       <td>
        -
       </td>
       <td>
        用于音视频下行的播放 URL，支持 RTMP、FLV 等协议
       </td>
      </tr>
      <tr>
       <td>
        mode
       </td>
       <td>
        String
       </td>
       <td>
        live
       </td>
       <td>
        live，RTC
       </td>
      </tr>
      <tr>
       <td>
        autoplay
       </td>
       <td>
        Boolean
       </td>
       <td>
        false
       </td>
       <td>
        是否自动播放
       </td>
      </tr>
      <tr>
       <td>
        muted
       </td>
       <td>
        Boolean
       </td>
       <td>
        false
       </td>
       <td>
        是否静音
       </td>
      </tr>
      <tr>
       <td>
        orientation
       </td>
       <td>
        String
       </td>
       <td>
        vertical
       </td>
       <td>
        vertical，horizontal
       </td>
      </tr>
      <tr>
       <td>
        object-fit
       </td>
       <td>
        String
       </td>
       <td>
        contain
       </td>
       <td>
        contain，fillCrop
       </td>
      </tr>
      <tr>
       <td>
        background-mute
       </td>
       <td>
        Boolean
       </td>
       <td>
        false
       </td>
       <td>
        当微信切到后台时，是否关闭播放声音
       </td>
      </tr>
      <tr>
       <td>
        min-cache
       </td>
       <td>
        Number
       </td>
       <td>
        1
       </td>
       <td>
        最小缓冲延迟， 单位：秒
       </td>
      </tr>
      <tr>
       <td>
        max-cache
       </td>
       <td>
        Number
       </td>
       <td>
        3
       </td>
       <td>
        最大缓冲延迟， 单位：秒
       </td>
      </tr>
      <tr>
       <td>
        bindstatechange
       </td>
       <td>
        EventHandler
       </td>
       <td>
        -
       </td>
       <td>
        用于指定一个 javascript 函数来接受播放器事件
       </td>
      </tr>
      <tr>
       <td>
        bindfullscreenchange
       </td>
       <td>
        EventHandler
       </td>
       <td>
        -
       </td>
       <td>
        用于指定一个 javascript 函数来接受全屏事件
       </td>
      </tr>
      <tr>
       <td>
        debug
       </td>
       <td>
        Boolean
       </td>
       <td>
        false
       </td>
       <td>
        是否开启调试模式
       </td>
      </tr>
     </tbody>
    </table>
    <h3 id=".E7.A4.BA.E4.BE.8B.E4.BB.A3.E7.A0.81">
     示例代码
    </h3>
    <pre><code class="language-html">&lt;view id='video-box'&gt;  
   &lt;live-player
    wx:for="{<!-- -->{player}}"
    id="player_{<!-- -->{index}}"
    mode="RTC"
    object-fit="fillCrop"
    src="{<!-- -->{item.playUrl}}" 
    autoplay='true'
    bindstatechange="onPlay"&gt;
  &lt;/live-player&gt;
&lt;/view&gt;</code></pre>
    <h3 id=".E8.B6.85.E4.BD.8E.E6.97.B6.E5.BB.B6">
     超低时延
    </h3>
    <p>
     &lt;live-player&gt; 的 RTC 模式支持500ms以内的超低时延链路，可以应用在视频通话和远程遥控等场景中，要使用超低时延播放，需要注意如下几点：
     <br/>
     （1）推流端如果是微信小程序，请使用 &lt;live-pusher&gt; 的 RTC 模式。
     <br/>
     （2）推流端如果是 iOS 或者 Android SDK，请使用 setVideoQuality 的 MAIN_PUBLISHER 模式。
     <br/>
     （3）推流端如果是 Windows，请不要使用 OBS，延时太高，可以使用我们的
     <a href="https://cloud.tencent.com/document/product/647/32689" rel="nofollow" title="Windows SDK">
      Windows SDK
     </a>
     。
     <br/>
     （4）&lt;live-player&gt; 的 min-cache 和 max-cache 请不要自行设置，使用默认值。
     <br/>
     （5）播放地址请使用超低延时播放地址，也就是带了防盗链签名的
     <code>
      rtmp://
     </code>
     地址，如下：
    </p>
    <table>
     <thead>
      <tr>
       <th>
        对比项目
       </th>
       <th>
        示例
       </th>
       <th>
        时延
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        普通直播 URL
       </td>
       <td>
        rtmp://3891.liveplay.myqcloud.com/live/3891_test_clock_for_rtmpacc
       </td>
       <td>
        &gt;2s
       </td>
      </tr>
      <tr>
       <td>
        超低延时 URL
       </td>
       <td>
        rtmp://3891.liveplay.myqcloud.com/live/3891_test_clock_for_rtmpacc?bizid=bizid&amp;txTime=5FD4431C&amp;txSerect=20e6d865f462dff61ada209d53c71cf9
       </td>
       <td>
        &lt; 500ms
       </td>
      </tr>
     </tbody>
    </table>
    <h3 id=".E5.B1.9E.E6.80.A7.E8.AF.A6.E8.A7.A3">
     属性详解
    </h3>
    <ul>
     <li>
      <p>
       <strong>
        src
       </strong>
       <br/>
       用于音视频下行的播放 URL，支持 RTMP 协议（URL 以
       <code>
        rtmp://
       </code>
       打头）和 FLV 协议（URL 以
       <code>
        http://
       </code>
       打头且以
       <code>
        .flv
       </code>
       结尾） ，腾讯云推流 URL 的获取方法见
       <a href="https://cloud.tencent.com/document/product/454/7915" rel="nofollow" title="如何生成推流 URL">
        如何生成推流 URL
       </a>
       。
      </p>
      <blockquote>
       <p>
        说明：
       </p>
       <p>
        &lt;live-player&gt; 标签是不支持 HLS（m3u8）协议的，因为 &lt;video&gt; 已经支持 HLS（m3u8）播放协议了。但直播观看不推荐使用 HLS（m3u8）协议，延迟要比 RTMP 和 FLV 协议高一个数量级。
       </p>
      </blockquote>
     </li>
     <li>
      <p>
       <strong>
        mode
       </strong>
       <br/>
       live 模式主要用于直播类场景，例如赛事直播、在线教育、远程培训等等。该模式下，小程序内部的模块会优先保证观看体验的流畅，通过调整 min-cache 和 max-cache 属性，您可以调节观众（播放）端所感受到的时间延迟的大小，文档下面会详细介绍这两个参数。
      </p>
      <p>
       RTC 则主要用于双向视频通话或多人视频通话场景，例如金融开会、在线客服、车险定损、培训会议等等。在此模式下，对 min-cache 和 max-cache 的设置不会起作用，因为小程序内部会自动将延迟控制在一个很低的水平（500ms左右）。
      </p>
     </li>
     <li>
      <p>
       <strong>
        min-cache 和 max-cache
       </strong>
       <br/>
       这两个参数分别用于指定观看端的最小缓冲时间和最大缓冲时间。所谓
       <strong>
        缓冲时间
       </strong>
       ，是指播放器为了缓解网络波动对观看流畅度的影响而引入的一个“蓄水池”，当来自网络的数据包出现卡顿甚至停滞的时候，“蓄水池”里的紧急用水可以让播放器还能坚持一小段时间，只要在这个短暂的时间内网速恢复正常，播放器就可以源源不断地渲染出流畅而平滑的视频画面。
      </p>
      <p>
       “蓄水池”里的水越多，抗网络波动的能力就越强，但代价就是观众端的延迟就越大，所以要在不同的场景下，使用不同的配置来达到体验上的平衡：
      </p>
      <ul>
       <li>
        码率比较低（1Mbps左右，画面以人物为主）的直播流，min-cache = 1，max-cache = 3 较合适。
       </li>
       <li>
        码率比较高（2Mbps - 3Mbps的高清游戏画面为主）的直播流，min-cache = 3，max-cache = 5 较合适。
       </li>
      </ul>
      <p>
       RTC 模式下这两个参数是无效的。
      </p>
     </li>
     <li>
      <p>
       <strong>
        orientation
       </strong>
       <br/>
       画面渲染角度，horizontal 代表是原始画面方向，vertical 代表向右旋转 90度。
      </p>
     </li>
     <li>
      <p>
       <strong>
        object-fit
       </strong>
       <br/>
       画面填充模式，contain 代表把画面显示完成，但如果视频画面的宽高比和 &lt;live-player&gt; 标签的宽高比不一致，那么您将看到黑边。fillCrop 代表把屏幕全部撑满，但如果视频画面的宽高比和 &lt;live-player&gt; 标签的宽高比不一致，那么画面中多余的部分会被裁剪掉。
      </p>
     </li>
    </ul>
    <ul>
     <li>
      <p>
       <strong>
        background-mute
       </strong>
       <br/>
       微信切到后台以后是否继续播放声音，用于避免锁屏对于当前小程序正在播放的视频内容的影响。
      </p>
     </li>
     <li>
      <p>
       <strong>
        sound-mode
       </strong>
       <br/>
       设置播放模式，可设值为：ear 与 speaker，ear 代表使用听筒播放， speaker 代表使用扬声器，默认为扬声器。
      </p>
     </li>
     <li>
      <p>
       <strong>
        debug
       </strong>
       <br/>
       调试音视频相关功能，如果没有很好的工具会是一个噩梦，所以小程序为 live-pusher 标签支持了 debug 模式，开始 debug 模式之后，原本用于渲染视频画面的窗口上，会显示一个半透明的 log 窗口，用于展示各项音视频指标和事件，降低您调试相关功能的难度，具体使用方法我们在
       <a href="https://cloud.tencent.com/document/product/454/7946" rel="nofollow" title="FAQ">
        FAQ
       </a>
       中有详细说明。
      </p>
     </li>
    </ul>
    <h3 id=".E5.AF.B9.E8.B1.A1.E6.93.8D.E4.BD.9C">
     对象操作
    </h3>
    <ul>
     <li>
      <p>
       <strong>
        wx.createLivePlayerContext()
       </strong>
       <br/>
       通过 wx.createLivePlayerContext() 可以将 &lt;live-player&gt; 标签和 javascript 对象关联起来，之后即可操作该对象。
      </p>
     </li>
     <li>
      <p>
       <strong>
        play
       </strong>
       <br/>
       开始播放，如果 &lt;live-player&gt; 的 autoplay 属性设置为 false（默认值），那么就可以使用 play 来手动启动播放。
      </p>
     </li>
     <li>
      <p>
       <strong>
        stop
       </strong>
       <br/>
       停止播放。
      </p>
     </li>
     <li>
      <p>
       <strong>
        pause
       </strong>
       <br/>
       暂停播放，停留在最后画面。
      </p>
     </li>
     <li>
      <p>
       <strong>
        resume
       </strong>
       <br/>
       继续播放，与 pause 成对使用。
      </p>
     </li>
     <li>
      <p>
       <strong>
        mute
       </strong>
       <br/>
       设置静音。
      </p>
     </li>
     <li>
      <p>
       <strong>
        requestFullScreen
       </strong>
       <br/>
       进入全屏幕。
      </p>
     </li>
     <li>
      <p>
       <strong>
        exitFullScreen
       </strong>
       <br/>
       退出全屏幕。
      </p>
     </li>
    </ul>
    <pre><code class="language-javascript">var player = wx.createLivePlayerContext('pusher');
player.requestFullScreen({
  success: function(){
    console.log('enter full screen mode success!')
}
fail: function(){
    console.log('enter full screen mode failed!')
}
complete: function(){
    console.log('enter full screen mode complete!')
}
});</code></pre>
    <h3 id=".E5.86.85.E9.83.A8.E4.BA.8B.E4.BB.B6">
     内部事件
    </h3>
    <p>
     通过
     <strong>
      &lt;live-player&gt;
     </strong>
     标签的
     <strong>
      bindstatechange
     </strong>
     属性可以绑定一个事件处理函数，该函数可以监听推流模块的内部事件和异常通知。
    </p>
    <p>
     1. 关键事件
    </p>
    <table>
     <thead>
      <tr>
       <th>
        code
       </th>
       <th>
        事件定义
       </th>
       <th>
        含义说明
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        2001
       </td>
       <td>
        PLAY_EVT_CONNECT_SUCC
       </td>
       <td>
        已经连接到云端服务器
       </td>
      </tr>
      <tr>
       <td>
        2002
       </td>
       <td>
        PLAY_EVT_RTMP_STREAM_BEGIN
       </td>
       <td>
        服务器开始传输音视频数据
       </td>
      </tr>
      <tr>
       <td>
        2003
       </td>
       <td>
        PLAY_EVT_RCV_FIRST_I_FRAME
       </td>
       <td>
        网络接收到首段音视频数据
       </td>
      </tr>
      <tr>
       <td>
        2004
       </td>
       <td>
        PLAY_EVT_PLAY_BEGIN
       </td>
       <td>
        视频播放开始，可以在收到此事件之前先用默认图片代表等待状态
       </td>
      </tr>
      <tr>
       <td>
        2006
       </td>
       <td>
        PLAY_EVT_PLAY_END
       </td>
       <td>
        视频播放结束
       </td>
      </tr>
      <tr>
       <td>
        2007
       </td>
       <td>
        PLAY_EVT_PLAY_LOADING
       </td>
       <td>
        进入缓冲中状态，此时播放器在等待或积攒来自服务器的数据
       </td>
      </tr>
      <tr>
       <td>
        -2301
       </td>
       <td>
        PLAY_ERR_NET_DISCONNECT
       </td>
       <td>
        网络连接断开，且重新连接亦不能恢复，播放器已停止播放
       </td>
      </tr>
     </tbody>
    </table>
    <blockquote>
     <p>
      说明：
     </p>
     <p>
      播放 HTTP:// 打头的 FLV 协议地址时，如果观众遇到播放中直播流断开的情况，小程序是不会抛出 PLAY_EVT_PLAY_END 事件的，这是因为 FLV 协议中没有定义停止事件，所以只能通过监听 PLAY_ERR_NET_DISCONNECT 来替代之。
     </p>
    </blockquote>
    <p>
     2. 警告事件
    </p>
    <p>
     内部警告并非不可恢复的错误，小程序内部的音视频 SDK 会启动相应的恢复措施，警告的目的主要用于提示开发者或者最终用户，例如：
    </p>
    <table>
     <thead>
      <tr>
       <th>
        code
       </th>
       <th>
        事件定义
       </th>
       <th>
        含义说明
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        2101
       </td>
       <td>
        PLAY_WARNING_VIDEO_DECODE_FAIL
       </td>
       <td>
        当前视频帧解码失败
       </td>
      </tr>
      <tr>
       <td>
        2102
       </td>
       <td>
        PLAY_WARNING_AUDIO_DECODE_FAIL
       </td>
       <td>
        当前音频帧解码失败
       </td>
      </tr>
      <tr>
       <td>
        2103
       </td>
       <td>
        PLAY_WARNING_RECONNECT
       </td>
       <td>
        网络断连，已启动自动重连恢复（重连超过三次就直接抛送 PLAY_ERR_NET_DISCONNECT 了）
       </td>
      </tr>
      <tr>
       <td>
        2104
       </td>
       <td>
        PLAY_WARNING_RECV_DATA_LAG
       </td>
       <td>
        视频流不太稳定，可能是观看者当前网速不充裕
       </td>
      </tr>
      <tr>
       <td>
        2105
       </td>
       <td>
        PLAY_WARNING_VIDEO_PLAY_LAG
       </td>
       <td>
        当前视频播放出现卡顿
       </td>
      </tr>
      <tr>
       <td>
        2106
       </td>
       <td>
        PLAY_WARNING_HW_ACCELERATION_FAIL
       </td>
       <td>
        硬解启动失败，采用软解
       </td>
      </tr>
      <tr>
       <td>
        2107
       </td>
       <td>
        PLAY_WARNING_VIDEO_DISCONTINUITY
       </td>
       <td>
        当前视频帧不连续，视频源可能有丢帧，可能会导致画面花屏
       </td>
      </tr>
      <tr>
       <td>
        3001
       </td>
       <td>
        PLAY_WARNING_DNS_FAIL
       </td>
       <td>
        DNS解析失败（仅播放 RTMP:// 地址时会抛送）
       </td>
      </tr>
      <tr>
       <td>
        3002
       </td>
       <td>
        PLAY_WARNING_SEVER_CONN_FAIL
       </td>
       <td>
        服务器连接失败（仅播放 RTMP:// 地址时会抛送）
       </td>
      </tr>
      <tr>
       <td>
        3003
       </td>
       <td>
        PLAY_WARNING_SHAKE_FAIL
       </td>
       <td>
        服务器握手失败（仅播放 RTMP:// 地址时会抛送）
       </td>
      </tr>
     </tbody>
    </table>
    <p>
     3. 示例代码
    </p>
    <pre><code class="language-javascript">Page({
   onPlay: function(ret) {
       if(ret.detail.code == 2004) {
            console.log('视频播放开始',ret);
       }
   },

/**
 * 生命周期函数--监听页面加载
 */
onLoad: function (options) {
//...
}
})</code></pre>
    <h3 id=".E7.89.B9.E5.88.AB.E8.AF.B4.E6.98.8E">
     特别说明
    </h3>
    <ol>
     <li>
      <p>
       &lt;live-player&gt; 组件是由客户端创建的原生组件，它的层级是最高的，可以使用 &lt;cover-view&gt; 和 &lt;cover-image&gt; 覆盖在上面。
      </p>
     </li>
     <li>
      <p>
       请勿在 &lt;scroll-view&gt; 中使用 &lt;live-player&gt; 组件。
      </p>
     </li>
    </ol>
    <p>
    </p>
    <p>
    </p>
    <p>
    </p>
   </div>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f34343732373038302f:61727469636c652f64657461696c732f313236353931313530" class_="artid" style="display:none">
 </p>
</div>


