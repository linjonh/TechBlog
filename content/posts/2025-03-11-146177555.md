---
layout: post
title: "MYSQL关于join的慢sql优化"
date: 2025-03-11 14:11:05 +0800
description: "结论：● 多表关联查询时，保证被关联的字段需要有索引**（最关键）**● 尽量避免三个表的 join。● 需要 join 的字段，数据类型必须绝对一致；● 注意排序字段，可能会导致索引失效，进行全表扫描● 只使用单一表进行orderby，不要使用两张表的字段排序。"
keywords: "[MYSQL]关于join的慢sql优化"
categories: ['Mysql']
tags: ['数据库', 'Sql', 'Mysql']
artid: "146177555"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146177555
    alt: "MYSQL关于join的慢sql优化"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146177555
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146177555
cover: https://bing.ee123.net/img/rand?artid=146177555
image: https://bing.ee123.net/img/rand?artid=146177555
img: https://bing.ee123.net/img/rand?artid=146177555
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     [MYSQL]关于join的慢sql优化
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     结论：
     <br/>
     ● 多表关联查询时，保证被关联的字段需要有索引**（最关键）**
     <br/>
     ● 尽量避免三个表的 join。
     <br/>
     ● 需要 join 的字段，数据类型必须绝对一致；
     <br/>
     ● 注意排序字段，可能会导致索引失效，进行全表扫描
     <br/>
     ● 只使用单一表进行orderby，不要使用两张表的字段排序
    </p>
    <h2>
     <a id="_7">
     </a>
     排查过程
    </h2>
    <h3>
     <a id="sql_8">
     </a>
     sql复现
    </h3>
    <pre><code class="prism language-sql"><span class="token keyword">SELECT</span>
<span class="token operator">*</span>
<span class="token keyword">FROM</span>
  <span class="token identifier"><span class="token punctuation">`</span>api_console_acq_business_task<span class="token punctuation">`</span></span> task
  <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> api_console_acq_business business <span class="token keyword">on</span> task<span class="token punctuation">.</span>business_id <span class="token operator">=</span> business<span class="token punctuation">.</span>business_id
  <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> api_console_acq_task_bill bill <span class="token keyword">on</span> task<span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>local_task_id<span class="token punctuation">`</span></span> <span class="token operator">=</span> bill<span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>task_id<span class="token punctuation">`</span></span>
<span class="token keyword">order</span> <span class="token keyword">by</span>
  id <span class="token keyword">desc</span>
<span class="token keyword">limit</span>
  <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span>
</code></pre>
    <h4>
     <a id="_21">
     </a>
     索引情况如下
    </h4>
    <p>
     task：有business_id索引,有local_task_id索引
     <br/>
     business：
     <strong>
      无business_id索引
     </strong>
     <br/>
     bill：有task_id索引
    </p>
    <h4>
     <a id="_27">
     </a>
     执行计划如下
    </h4>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/direct/116eef664e8243cfa8c6d241533af951.png"/>
    </p>
    <blockquote>
     <p>
      执行时间：120s
      <br/>
      主要都是用了全表查询，效率极低
     </p>
    </blockquote>
    <h3>
     <a id="_35">
     </a>
     异常原因
    </h3>
    <h4>
     <a id="_36">
     </a>
     多表关联查询时，关联的字段无索引
    </h4>
    <p>
     在 SQL 语句中，task是主表，而 business是关联表。
     <br/>
     ● 你 JOIN 了 business表，但该表只有 80 条数据，查询它本身应该不慢。
     <br/>
     ● 但如果
     <strong>
      B.business_id没有索引，数据库在 JOIN 时可能会进行 全表扫描（Full Table Scan）
     </strong>
     ，每次都要遍历整张表去匹配 business_id，导致查询变慢。
     <br/>
     ● 索引建立后，数据库可以直接通过索引快速查找 business_id，避免全表扫描，提高查询效率。
    </p>
    <h4>
     <a id="orderby_41">
     </a>
     orderby影响
    </h4>
    <p>
     该sql去除排序后，执行速度恢复正常；由于业务需要，该表需要按照id倒叙
    </p>
    <ol>
     <li>
      <strong>
       索引未被利用，导致全表扫描（ALL）
      </strong>
      <br/>
      ○ 如果 id 没有索引或者查询优化器选择不使用索引，MySQL 可能需要 扫描整个表，然后进行排序，速度自然会慢。
     </li>
     <li>
      <strong>
       涉及 JOIN，多表数据排序开销大
      </strong>
      <br/>
      ○ LEFT JOIN 可能导致 大量数据被合并，即使 task 表有索引，最终的 结果集仍可能较大，MySQL 可能会创建临时表并进行 filesort。
     </li>
     <li>
      <strong>
       Using filesort 导致磁盘 IO 变高
      </strong>
      <br/>
      ○ ORDER BY 在某些情况下会触发 外部排序（filesort），特别是在 未使用合适索引 或 数据量较大 的情况下。
     </li>
    </ol>
    <h2>
     <a id="_49">
     </a>
     解决如下
    </h2>
    <h3>
     <a id="_50">
     </a>
     多表关联查询时，保证被关联的字段需要有索引
    </h3>
    <p>
     给business表新增一个idx_businessId索引内容
     <br/>
     修改后，执行计划如下
     <br/>
     <img alt="" src="https://i-blog.csdnimg.cn/direct/2570970da08f4b429b8bd60ce435e7d7.png"/>
    </p>
    <blockquote>
     <p>
      执行时间：70ms
     </p>
    </blockquote>
    <h2>
     <a id="join_56">
     </a>
     join扩充
    </h2>
    <p>
     原来MySQL内部采用了一种叫做 nested loop join （嵌套循环连接） 的算法。Nested Loop Join 实际上就是通过驱动表的结果集作为循环基础数据，然后一条一条的通过
     <strong>
      该结果集中的数据作为过滤条件到下一个表中查询数据
     </strong>
     ，然后合并结果。如果还有第三个参与 Join，则再通过前两个表的 Join 结果集作为循环基础数据，再一次通过循环查询条件到第三个表中查询数据，如此往复，基本上MySQL采用的是最容易理解的算法来实现join
     <br/>
     由上述内容克制
     <br/>
     ● 每次循环都能快速匹配到 business 和 bill 的记录，所以索引要 覆盖 JOIN 条件
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e63:73646e2e6e65742f4368656e674875616e4875616e696e672f:61727469636c652f64657461696c732f313436313737353535" class_="artid" style="display:none">
 </p>
</div>


