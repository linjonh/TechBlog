---
layout: post
title: "数据库的高阶知识"
date: 2025-03-16 23:50:16 +0800
description: "数据库高阶知识涵盖了复杂查询、数据分析和优化技术，主要包括 CASE WHEN 条件表达式、嵌套查询 和 开窗函数 等内容。这些功能能够显著提升 SQL 查询的灵活性和效率，适用于复杂的数据分析和业务逻辑实现。"
keywords: "数据库的高阶知识"
categories: ['数据库']
tags: ['数据库']
artid: "146283230"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146283230
    alt: "数据库的高阶知识"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146283230
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146283230
cover: https://bing.ee123.net/img/rand?artid=146283230
image: https://bing.ee123.net/img/rand?artid=146283230
img: https://bing.ee123.net/img/rand?artid=146283230
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     数据库的高阶知识
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <p>
    </p>
    <p>
     <a href="https://blog.csdn.net/u012121721/article/details/146276460">
      数据库的基本知识
     </a>
     <br/>
     <a href="https://blog.csdn.net/u012121721/article/details/146283230">
      数据库的高阶知识
     </a>
    </p>
    <h2>
     <a id="case_when_5">
     </a>
     一、case when
    </h2>
    <p>
     在实际工作中，经常会涉及以下两类问题：
    </p>
    <ul>
     <li>
      数据的映射处理：比如将离散的数字变成有意义的业务说明，或是将连续的数值映射到离散的区间带
     </li>
     <li>
      有针对性的筛选计算：将细颗粒单位转换为粗颗粒单位的聚合运算
     </li>
    </ul>
    <p>
     这两类问题，我们通常使用case when语句来解决，case语句其实就是mysql中的控制流语句，类似于其他很多编程工具中的if …then…的分支判断逻辑。
     <br/>
     关于case when的表达方式有两种：“简单case函数法”和“case搜索函数法”。这两种方法各有优点，比如“简单case函数法”的语法更加简洁，但是
     <strong>
      只能处理等式的问题
     </strong>
     ，“case搜索函数法”更加灵活好用，可以处理等式问题也可以处理不等式问题。
    </p>
    <pre><code class="prism language-sql"><span class="token comment"># 简单case函数法</span>
<span class="token keyword">case</span> <span class="token operator">&lt;</span>name<span class="token operator">&gt;</span>
	<span class="token keyword">when</span> <span class="token operator">&lt;</span>when_condition<span class="token operator">&gt;</span> <span class="token keyword">then</span> <span class="token operator">&lt;</span>result<span class="token operator">&gt;</span>
	<span class="token punctuation">[</span><span class="token keyword">when</span> <span class="token operator">&lt;</span>when_condition<span class="token operator">&gt;</span> <span class="token keyword">then</span> <span class="token operator">&lt;</span>result<span class="token operator">&gt;</span><span class="token punctuation">]</span>
	<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
	<span class="token punctuation">[</span><span class="token keyword">else</span> <span class="token operator">&lt;</span>else_result<span class="token operator">&gt;</span><span class="token punctuation">]</span>
<span class="token keyword">end</span>
<span class="token comment">#case搜索函数法</span>
<span class="token keyword">case</span> 
	<span class="token keyword">when</span> <span class="token operator">&lt;</span>bool_condition<span class="token operator">&gt;</span> <span class="token keyword">then</span> <span class="token operator">&lt;</span>result<span class="token operator">&gt;</span>
	<span class="token punctuation">[</span><span class="token keyword">when</span> <span class="token operator">&lt;</span>bool_condition<span class="token operator">&gt;</span> <span class="token keyword">then</span> <span class="token operator">&lt;</span>result<span class="token operator">&gt;</span><span class="token punctuation">]</span>
	<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
	<span class="token punctuation">[</span><span class="token keyword">else</span> <span class="token operator">&lt;</span>else_result<span class="token operator">&gt;</span><span class="token punctuation">]</span>
<span class="token keyword">end</span>
</code></pre>
    <p>
     下面以电商数据为例学习CASE WHEN语法在数据查询中几种常见用法，该数据一共包含7个字段和1000条样本，7个字段分别是用户ID，用户出生日期、下单时间、订单ID、支付方式、支付金额和是否享受折扣。数据链接：https://pan.quark.cn/s/af980c28a2d0
    </p>
    <pre><code class="prism language-sql"><span class="token comment">-- 离散数值与实际业务含义一一对应</span>
<span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>
		<span class="token keyword">case</span> 
		<span class="token keyword">when</span> is_discount <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">then</span> <span class="token string">"享受折扣"</span>
		<span class="token keyword">else</span> <span class="token string">"无折扣"</span>
		<span class="token keyword">end</span> discount_new<span class="token punctuation">,</span>
		<span class="token keyword">case</span>
		<span class="token keyword">when</span> pay_type <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">then</span> <span class="token string">"支付宝支付"</span>
		<span class="token keyword">when</span> pay_type <span class="token operator">=</span> <span class="token number">2</span> <span class="token keyword">then</span> <span class="token string">"微信支付"</span>
		<span class="token keyword">else</span> <span class="token string">"银行卡支付"</span>
		<span class="token keyword">end</span> pay_type_new
<span class="token keyword">from</span> goods_orders


<span class="token comment">#根据用户的出生日期将用户分为70后，80后，90后,00后</span>
<span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>
		<span class="token keyword">case</span>
		<span class="token keyword">when</span> <span class="token keyword">year</span><span class="token punctuation">(</span>birthday<span class="token punctuation">)</span> <span class="token operator">between</span> <span class="token number">1970</span> <span class="token operator">and</span> <span class="token number">1979</span> <span class="token keyword">then</span> <span class="token string">'70后'</span>
		<span class="token keyword">when</span> <span class="token keyword">year</span><span class="token punctuation">(</span>birthday<span class="token punctuation">)</span> <span class="token operator">between</span> <span class="token number">1980</span> <span class="token operator">and</span> <span class="token number">1989</span> <span class="token keyword">then</span> <span class="token string">'80后'</span>
		<span class="token keyword">when</span> <span class="token keyword">year</span><span class="token punctuation">(</span>birthday<span class="token punctuation">)</span> <span class="token operator">between</span> <span class="token number">1990</span> <span class="token operator">and</span> <span class="token number">1999</span> <span class="token keyword">then</span> <span class="token string">'90后'</span>
		<span class="token keyword">else</span> <span class="token string">'00后'</span>
		<span class="token keyword">end</span> AGE_GROUP
<span class="token keyword">from</span> goods_orders

<span class="token comment">#长形统计表转换成宽形统计表</span>
<span class="token keyword">select</span> <span class="token keyword">month</span><span class="token punctuation">(</span>order_date<span class="token punctuation">)</span> <span class="token keyword">as</span> imonth<span class="token punctuation">,</span>
				<span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> pay_type <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">then</span> pay_amt <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">'ali_pay'</span><span class="token punctuation">,</span>
				<span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> pay_type <span class="token operator">=</span> <span class="token number">2</span> <span class="token keyword">then</span> pay_amt <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">'wechat'</span><span class="token punctuation">,</span>
				<span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> pay_type <span class="token operator">=</span> <span class="token number">3</span> <span class="token keyword">then</span> pay_amt <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">'bank_card'</span>
<span class="token keyword">from</span> goods_orders		
<span class="token keyword">where</span> <span class="token keyword">year</span><span class="token punctuation">(</span>order_date<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">2023</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> imonth
<span class="token keyword">order</span> <span class="token keyword">by</span> imonth
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/1ef63788899948839dc98676ebb6b6d2.png"/>
    </p>
    <h2>
     <a id="_66">
     </a>
     二、几种常见的嵌套查询
    </h2>
    <p>
     嵌套查询，也称为子查询，是实际工作中经常用到的一种查询方式。子查询其实就是在已有的查询语句中的where后面再嵌套一层查询语句，也就是把内层查询结果当做外层查询参照的数据表来使用。
     <br/>
     在工作中，经常会遇见4种子查询，即含有
     <strong>
      比较运算符
     </strong>
     (&gt;、&gt;=、&lt;、&lt;=、=、!=)、
     <strong>
      ANY/ALL关键词
     </strong>
     、
     <strong>
      IN关键词
     </strong>
     以及
     <strong>
      EXISTS关键词
     </strong>
     的嵌套查询。
     <strong>
      <font color="purple">
       数据链接
      </font>
     </strong>
     ：https://pan.quark.cn/s/223ade8607a3
    </p>
    <h3>
     <a id="21__69">
     </a>
     2.1 比较运算符
    </h3>
    <p>
     比较运算符用于比较两个值，返回布尔值（TRUE 或 FALSE）。
    </p>
    <pre><code class="prism language-sql"><span class="token comment">#创建学生信息表</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> stu_info <span class="token punctuation">(</span>
    id <span class="token keyword">INT</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span> <span class="token comment">-- 学生ID，自增主键</span>
    iname <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                 <span class="token comment">-- 学生姓名</span>
    gender <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                    <span class="token comment">-- 性别（M: 男, F: 女）</span>
    department <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token comment">-- 所属院系</span>
    age <span class="token keyword">INT</span><span class="token punctuation">,</span>                           <span class="token comment">-- 年龄</span>
    province <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>              <span class="token comment">-- 省份</span>
    email <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                 <span class="token comment">-- 邮箱</span>
    mobilephone <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span>               <span class="token comment">-- 手机号（11位）</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> stu_info <span class="token punctuation">(</span>iname<span class="token punctuation">,</span> gender<span class="token punctuation">,</span> department<span class="token punctuation">,</span> age<span class="token punctuation">,</span> province<span class="token punctuation">,</span> email<span class="token punctuation">,</span> mobilephone<span class="token punctuation">)</span>
<span class="token keyword">VALUES</span>
<span class="token punctuation">(</span><span class="token string">'张三'</span><span class="token punctuation">,</span> <span class="token string">'M'</span><span class="token punctuation">,</span> <span class="token string">'计算机'</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token string">'北京'</span><span class="token punctuation">,</span> <span class="token string">'zhangsan@example.com'</span><span class="token punctuation">,</span> <span class="token string">'13800138000'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'李四'</span><span class="token punctuation">,</span> <span class="token string">'M'</span><span class="token punctuation">,</span> <span class="token string">'数学'</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">,</span> <span class="token string">'上海'</span><span class="token punctuation">,</span> <span class="token string">'lisi@example.com'</span><span class="token punctuation">,</span> <span class="token string">'13800138001'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'王五'</span><span class="token punctuation">,</span> <span class="token string">'F'</span><span class="token punctuation">,</span> <span class="token string">'物理'</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">,</span> <span class="token string">'广东'</span><span class="token punctuation">,</span> <span class="token string">'wangwu@example.com'</span><span class="token punctuation">,</span> <span class="token string">'13800138002'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'赵六'</span><span class="token punctuation">,</span> <span class="token string">'M'</span><span class="token punctuation">,</span> <span class="token string">'化学'</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">,</span> <span class="token string">'江苏'</span><span class="token punctuation">,</span> <span class="token string">'zhaoliu@example.com'</span><span class="token punctuation">,</span> <span class="token string">'13800138003'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'孙七'</span><span class="token punctuation">,</span> <span class="token string">'F'</span><span class="token punctuation">,</span> <span class="token string">'生物'</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token string">'浙江'</span><span class="token punctuation">,</span> <span class="token string">'sunqi@example.com'</span><span class="token punctuation">,</span> <span class="token string">'13800138004'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'周八'</span><span class="token punctuation">,</span> <span class="token string">'M'</span><span class="token punctuation">,</span> <span class="token string">'计算机'</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">,</span> <span class="token string">'北京'</span><span class="token punctuation">,</span> <span class="token string">'zhouba@example.com'</span><span class="token punctuation">,</span> <span class="token string">'13800138005'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">(</span><span class="token string">'武勇'</span><span class="token punctuation">,</span> <span class="token string">'M'</span><span class="token punctuation">,</span> <span class="token string">'生物'</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">,</span> <span class="token string">'浙江'</span><span class="token punctuation">,</span> <span class="token string">'wuyong@example.com'</span><span class="token punctuation">,</span> <span class="token string">'13800138049'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">#学生成绩表</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> stu_score <span class="token punctuation">(</span>
    id <span class="token keyword">INT</span><span class="token punctuation">,</span>          <span class="token comment">-- 学生ID</span>
    Chinese <span class="token keyword">TINYINT</span><span class="token punctuation">,</span> <span class="token comment">-- 语文成绩（0-100）</span>
    Math <span class="token keyword">TINYINT</span><span class="token punctuation">,</span>    <span class="token comment">-- 数学成绩（0-100）</span>
    English <span class="token keyword">TINYINT</span>  <span class="token comment">-- 英语成绩（0-100）</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> stu_score <span class="token punctuation">(</span>id<span class="token punctuation">,</span> Chinese<span class="token punctuation">,</span> Math<span class="token punctuation">,</span> English<span class="token punctuation">)</span>
<span class="token keyword">VALUES</span>
<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">87</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">,</span> <span class="token number">83</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">78</span><span class="token punctuation">,</span> <span class="token number">85</span><span class="token punctuation">,</span> <span class="token number">88</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">92</span><span class="token punctuation">,</span> <span class="token number">76</span><span class="token punctuation">,</span> <span class="token number">81</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">87</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">83</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># 1.查询年龄超过所有学员平均年龄的学员信息</span>
<span class="token comment">#第一步先计算学员平均年龄</span>
<span class="token keyword">select</span> <span class="token function">avg</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span> <span class="token keyword">from</span> stu_info

<span class="token comment">#筛选超过平均年龄的学员信息</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> stu_info
<span class="token keyword">where</span> age <span class="token operator">&gt;=</span> <span class="token number">20.5</span>

<span class="token comment">#子查询</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> stu_info
<span class="token keyword">where</span> age <span class="token operator">&gt;=</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token function">avg</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span> <span class="token keyword">from</span> stu_info<span class="token punctuation">)</span>

<span class="token comment"># 2.查询年龄不低于所属系平均年龄的学员信息</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> stu_info <span class="token keyword">as</span> t1
<span class="token keyword">where</span> age <span class="token operator">&gt;=</span><span class="token punctuation">(</span>
<span class="token keyword">select</span> <span class="token function">avg</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span> <span class="token keyword">from</span> stu_info <span class="token keyword">as</span> t2
<span class="token keyword">where</span> t1<span class="token punctuation">.</span>department <span class="token operator">=</span> t2<span class="token punctuation">.</span>department<span class="token punctuation">)</span>
</code></pre>
    <h3>
     <a id="22_ANYALL__129">
     </a>
     2.2 ANY/ALL 关键词
    </h3>
    <p>
     对于含比较运算符的嵌套查询来说，
     <strong>
      嵌套部分的查询语句只能返回一个值
     </strong>
     。那如果子查询返回多个值，
     <strong>
      就需要用到ANY或者ALL关键词了
     </strong>
     。通常，ANY/ALL关键词经常和比较运算符连用，下面是6种比较运算符与ANY/ALL 关键词的搭配结果:
    </p>
    <table>
     <thead>
      <tr>
       <th>
        组合
       </th>
       <th>
        含义
       </th>
       <th>
        组合
       </th>
       <th>
        含义
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        &gt;ANY
       </td>
       <td>
        大于子查询结果中的某个值
       </td>
       <td>
        &gt;ALL
       </td>
       <td>
        大于子查询结果中的所有值
       </td>
      </tr>
      <tr>
       <td>
        &gt;=ANY
       </td>
       <td>
        大于等于子查询结果中的某个值
       </td>
       <td>
        &gt;=ALL
       </td>
       <td>
        大于等于子查询结果中的所有值
       </td>
      </tr>
      <tr>
       <td>
        &lt;ANY
       </td>
       <td>
        小于子查询结果中的某个值
       </td>
       <td>
        &lt;ALL
       </td>
       <td>
        小于子查询结果中的所有值
       </td>
      </tr>
      <tr>
       <td>
        &lt;=ANY
       </td>
       <td>
        小于等于子查询结果中的某个值
       </td>
       <td>
        &lt;=ALL
       </td>
       <td>
        小于等于子查询结果中的所有值
       </td>
      </tr>
      <tr>
       <td>
        =ANY
       </td>
       <td>
        等于子查询结果中的某个值
       </td>
       <td>
        =ALL
       </td>
       <td>
        等于子查询结果中的所有值
       </td>
      </tr>
      <tr>
       <td>
        !=ANY
       </td>
       <td>
        不等于子查询结果中的某个值
       </td>
       <td>
        !=ALL
       </td>
       <td>
        不等于子查询结果中的所有值
       </td>
      </tr>
     </tbody>
    </table>
    <pre><code class="prism language-sql"><span class="token comment"># 2.查询非物理系中比物理系任意一个学员年龄小的学员信息</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> stu_info 
<span class="token keyword">where</span> department <span class="token operator">!=</span> <span class="token string">'物理'</span> <span class="token operator">and</span>
age <span class="token operator">&lt;</span> <span class="token keyword">any</span><span class="token punctuation">(</span>
<span class="token keyword">select</span> <span class="token keyword">distinct</span> age 
<span class="token keyword">from</span> stu_info
<span class="token keyword">where</span> department <span class="token operator">=</span> <span class="token string">'物理'</span>
<span class="token punctuation">)</span>

<span class="token comment">#3.查询非物理系中比物理系所有学员年龄大的学员信息</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> stu_info 
<span class="token keyword">where</span> department <span class="token operator">!=</span> <span class="token string">'物理'</span> <span class="token operator">and</span>
age <span class="token operator">&gt;</span> <span class="token keyword">all</span><span class="token punctuation">(</span>
<span class="token keyword">select</span> <span class="token keyword">distinct</span> age 
<span class="token keyword">from</span> stu_info
<span class="token keyword">where</span> department <span class="token operator">=</span> <span class="token string">'物理'</span>
<span class="token punctuation">)</span>

</code></pre>
    <h3>
     <a id="23_in__159">
     </a>
     2.3 in 关键词
    </h3>
    <p>
     IN 用于判断某个值是否在指定的值列表中。它可以替代多个 OR 条件，使查询更简洁。
    </p>
    <pre><code class="prism language-sql"><span class="token comment"># 查询计算机和物理系的学员信息</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> stu_info
<span class="token keyword">where</span> department <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">"计算机"</span><span class="token punctuation">,</span><span class="token string">"物理"</span><span class="token punctuation">)</span>

<span class="token comment">#查询和张三、王五同一个系的学员信息</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> stu_info
<span class="token keyword">where</span> department <span class="token operator">in</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span> department <span class="token keyword">from</span> stu_info
<span class="token keyword">where</span> iname <span class="token operator">in</span><span class="token punctuation">(</span><span class="token string">"张三"</span><span class="token punctuation">,</span><span class="token string">"王五"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">#查询语文成绩大于85分的学员信息</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> stu_info <span class="token keyword">where</span> id <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token keyword">select</span> id <span class="token keyword">from</span> stu_score
<span class="token keyword">where</span> Chinese <span class="token operator">&gt;</span><span class="token number">85</span><span class="token punctuation">)</span>
</code></pre>
    <h3>
     <a id="24_EXISTS_176">
     </a>
     2.4 EXISTS关键词
    </h3>
    <p>
     EXISTS 用于检查子查询是否返回任何行。如果子查询返回至少一行，则 EXISTS 返回 TRUE，否则返回 FALSE。
    </p>
    <pre><code class="prism language-sql"><span class="token comment">#查询语文成绩大于85分的学员信息</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> stu_info <span class="token keyword">where</span> <span class="token keyword">exists</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> stu_score
<span class="token keyword">where</span> stu_score<span class="token punctuation">.</span>id <span class="token operator">=</span> stu_info<span class="token punctuation">.</span>id <span class="token operator">and</span> Chinese <span class="token operator">&gt;</span><span class="token number">85</span><span class="token punctuation">)</span>
</code></pre>
    <h3>
     <a id="25_inexists_183">
     </a>
     2.5 in和exists的异同点
    </h3>
    <ul>
     <li>
      使用场景对比
      <br/>
      in适合用于静态值列表或
      <strong>
       子查询结果集较小
      </strong>
      的情况。
     </li>
    </ul>
    <pre><code class="prism language-sql"><span class="token comment">-- 查询数学成绩为 85、90 或 95 的学生</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> stu_score
<span class="token keyword">WHERE</span> Math <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token number">85</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">,</span> <span class="token number">95</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 查询在某个班级的学生</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> stu_info
<span class="token keyword">WHERE</span> class_id <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> class_id <span class="token keyword">FROM</span> class <span class="token keyword">WHERE</span> class_name <span class="token operator">=</span> <span class="token string">'计算机'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     exists适合用于动态子查询或
     <strong>
      子查询结果集较大
     </strong>
     的情况。
    </p>
    <pre><code class="prism language-sql"><span class="token comment">-- 查询有成绩记录的学生</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> stu_info
<span class="token keyword">WHERE</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> <span class="token number">1</span> <span class="token keyword">FROM</span> stu_score
    <span class="token keyword">WHERE</span> stu_score<span class="token punctuation">.</span>id <span class="token operator">=</span> stu_info<span class="token punctuation">.</span>id
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 查询没有成绩记录的学生</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> stu_info
<span class="token keyword">WHERE</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> <span class="token number">1</span> <span class="token keyword">FROM</span> stu_score
    <span class="token keyword">WHERE</span> stu_score<span class="token punctuation">.</span>id <span class="token operator">=</span> stu_info<span class="token punctuation">.</span>id
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <ul>
     <li>
      <p>
       性能对比
       <br/>
       IN 的性能：
       <br/>
       当子查询结果集较小时，IN 的性能较好，因为子查询的结果会被缓存，外部查询只需要与缓存的结果进行比较。
       <br/>
       当子查询结果集较大时，IN 的性能较差，因为缓存大量数据会占用内存，且比较操作较慢。
       <br/>
       EXISTS 的性能：
       <br/>
       当子查询结果集较大时，EXISTS 的性能较好，因为它不需要缓存结果，且可以在找到第一个匹配项时立即返回 TRUE。
       <br/>
       当子查询结果集较小时，EXISTS 的性能可能略低于 IN，因为需要为外部查询的每一行执行一次子查询。
      </p>
     </li>
     <li>
      <p>
       NULL值处理区别
       <br/>
       in：如果子查询的结果中包含 NULL，
       <strong>
        IN 会忽略 NULL
       </strong>
       ，不会将其与外部查询的值进行比较。
      </p>
     </li>
    </ul>
    <pre><code class="prism language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> stu_score
<span class="token keyword">WHERE</span> Math <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token number">85</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">#如果 Math 是 NULL，上述查询不会返回该行。</span>
</code></pre>
    <p>
     EXISTS：不关心子查询的具体值，只关心是否存在匹配的行。
    </p>
    <pre><code class="prism language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> stu_info
<span class="token keyword">WHERE</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> <span class="token number">1</span> <span class="token keyword">FROM</span> stu_score
    <span class="token keyword">WHERE</span> stu_score<span class="token punctuation">.</span>id <span class="token operator">=</span> stu_info<span class="token punctuation">.</span>id <span class="token operator">AND</span> Math <span class="token operator">IS</span> <span class="token boolean">NULL</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <h2>
     <a id="_234">
     </a>
     三、开窗函数
    </h2>
    <p>
     结合order by关键词和limit关键词是可以解决很多的topN问题，比如从二手房数据集中查询出某个地区的最贵的10套房，从电商交易数据集中查询出实付金额最高的5笔交易，从学员信息表中查询出年龄最小的3个学员等。但是，如果需求变成从二手房数据集中查询出各个地区最贵的10套房，从电商数据集中查询出每月实付金额最高的5笔交易，从学员信息表中查询出各个科系下年龄最小的3个学员，该如何解决呢?
     <br/>
     其实这类问题的核心就是，筛选出组内的topN，而不是从全部数据集中挑选出topN。遇到这种既需要分组也需要排序的问题，直接上开窗函数就能解决了。
     <br/>
     （1）开窗函数定义
     <br/>
     开窗函数是 SQL 中一种特殊的函数，用于在查询结果集的“窗口”（即一组相关行）上执行计算。与普通的聚合函数（如 SUM、AVG）不同，
     <strong>
      开窗函数不会将多行合并为一行，而是为每一行返回一个计算结果，同时保留原始行的详细信息。
     </strong>
     注：MySQL 8.0 及以上版本支持开窗函数，低于版本不支持。
     <br/>
     开窗函数分为两部分，一部分是函数名称，开窗函数的数量比较少，总共才11个开窗函数+聚合函数（所有聚合函数都可以用作开窗函数），根据函数的性质，有的需要写参数，有的不需要写参数。
     <br/>
     另一部分为over语句，over()语句必须要写的，里面的参数都是非必须参数，可以根据需求有选择的使用。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/8f8eece19b9d44e8989b8ab785ac6d6a.png"/>
    </p>
    <pre><code class="prism language-sql">函数名<span class="token punctuation">(</span>字段<span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span>
    <span class="token punctuation">[</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> 分组字段<span class="token punctuation">]</span> <span class="token comment">#含义是根据此字段将数据集分为多份</span>
    <span class="token punctuation">[</span><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> 排序字段<span class="token punctuation">]</span> <span class="token comment">#每个窗口的数据依据此字段进行升序或降序排列</span>
    <span class="token punctuation">[</span><span class="token keyword">ROWS</span><span class="token operator">/</span>RANGE 窗口范围<span class="token punctuation">]</span>
<span class="token punctuation">)</span>

函数名：开窗函数的名称，如 ROW_NUMBER<span class="token punctuation">(</span><span class="token punctuation">)</span>、RANK<span class="token punctuation">(</span><span class="token punctuation">)</span>、<span class="token function">SUM</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 等。
<span class="token keyword">OVER</span>：定义窗口的范围和规则。
<span class="token keyword">PARTITION</span> <span class="token keyword">BY</span>：将数据分组，类似于 <span class="token keyword">GROUP</span> <span class="token keyword">BY</span>，但不会合并行。
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span>：指定窗口内的排序规则。
<span class="token keyword">ROWS</span><span class="token operator">/</span>RANGE：定义窗口的物理或逻辑范围。
</code></pre>
    <pre><code class="prism language-sql"><span class="token comment">#创建虚拟的业务员销售数据</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> Sales<span class="token punctuation">(</span>
						idate <span class="token keyword">date</span><span class="token punctuation">,</span>
						iname <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
						sales <span class="token keyword">int</span><span class="token punctuation">)</span>
<span class="token comment">#向表中插入数据</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> Sales <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">'2024-01-01'</span><span class="token punctuation">,</span> <span class="token string">'张三'</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span>


<span class="token comment">-- 插入50行模拟数据</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> Sales <span class="token punctuation">(</span>idate<span class="token punctuation">,</span> iname<span class="token punctuation">,</span> sales<span class="token punctuation">)</span>
<span class="token keyword">VALUES</span>
<span class="token punctuation">(</span><span class="token string">'2024-01-01'</span><span class="token punctuation">,</span> <span class="token string">'张三'</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'2024-01-02'</span><span class="token punctuation">,</span> <span class="token string">'张三'</span><span class="token punctuation">,</span> <span class="token number">650</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'2024-01-03'</span><span class="token punctuation">,</span> <span class="token string">'王五'</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'2024-01-04'</span><span class="token punctuation">,</span> <span class="token string">'赵六'</span><span class="token punctuation">,</span> <span class="token number">250</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'2024-01-05'</span><span class="token punctuation">,</span> <span class="token string">'王五'</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">(</span><span class="token string">'2024-02-18'</span><span class="token punctuation">,</span> <span class="token string">'苏勇'</span><span class="token punctuation">,</span> <span class="token number">2500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># 一、查询各月中销售业绩最差的业务员</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span><span class="token punctuation">(</span>
<span class="token keyword">select</span> <span class="token keyword">month</span><span class="token punctuation">(</span>idate<span class="token punctuation">)</span><span class="token punctuation">,</span>iname<span class="token punctuation">,</span>sales<span class="token punctuation">,</span>row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> <span class="token keyword">month</span><span class="token punctuation">(</span>idate<span class="token punctuation">)</span> <span class="token keyword">order</span> <span class="token keyword">by</span> sales<span class="token punctuation">)</span> <span class="token keyword">as</span> sales_order <span class="token keyword">from</span> sales<span class="token punctuation">)</span> <span class="token keyword">as</span> t  <span class="token comment">#易错点：在 SQL 中，所有的派生表必须有一个别名，没有指定别名，MySQL 报错</span>
<span class="token keyword">where</span> sales_order<span class="token operator">=</span> <span class="token number">1</span>

<span class="token comment"># row_number()、rank()、dense_rank()的区别</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span><span class="token punctuation">(</span>
<span class="token keyword">select</span> <span class="token keyword">month</span><span class="token punctuation">(</span>idate<span class="token punctuation">)</span><span class="token punctuation">,</span>iname<span class="token punctuation">,</span>sales<span class="token punctuation">,</span>row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> <span class="token keyword">month</span><span class="token punctuation">(</span>idate<span class="token punctuation">)</span> <span class="token keyword">order</span> <span class="token keyword">by</span> sales<span class="token punctuation">)</span> <span class="token keyword">as</span> row_order<span class="token punctuation">,</span>
								rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> <span class="token keyword">month</span><span class="token punctuation">(</span>idate<span class="token punctuation">)</span> <span class="token keyword">order</span> <span class="token keyword">by</span> sales<span class="token punctuation">)</span> <span class="token keyword">as</span> rank_order<span class="token punctuation">,</span>
								dense_rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> <span class="token keyword">month</span><span class="token punctuation">(</span>idate<span class="token punctuation">)</span> <span class="token keyword">order</span> <span class="token keyword">by</span> sales<span class="token punctuation">)</span> <span class="token keyword">as</span> dense_order <span class="token keyword">from</span> sales<span class="token punctuation">)</span> <span class="token keyword">as</span> t

<span class="token comment"># 连续登录的问题：创建虚拟的用户登录表</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> user_login<span class="token punctuation">(</span>
				user_id <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
				login_time <span class="token keyword">datetime</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment"># 二、查看每位用户连续登录的情况</span>
<span class="token comment">#1、时间戳格式修改为时间格式</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> user_login_date <span class="token punctuation">(</span>
<span class="token keyword">select</span> <span class="token keyword">distinct</span> user_id<span class="token punctuation">,</span><span class="token keyword">date</span><span class="token punctuation">(</span>login_time<span class="token punctuation">)</span> login_date
<span class="token keyword">from</span> user_login<span class="token punctuation">)</span>

<span class="token comment"># login_date - irank 相等表示连续登录</span>
<span class="token comment">-- select * from user_login_date</span>

<span class="token comment">#2、对用户登录数据进行排序</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> user_login_data_1 <span class="token punctuation">(</span>
			<span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> user_id <span class="token keyword">order</span> <span class="token keyword">by</span> login_date<span class="token punctuation">)</span> irank
			<span class="token keyword">from</span> user_login_date<span class="token punctuation">)</span>

<span class="token comment">-- select * from user_login_data_1</span>

<span class="token comment"># 3、date_sub 从指定的日期减去指定的时间间隔</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> user_login_data_2<span class="token punctuation">(</span>
<span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>date_sub<span class="token punctuation">(</span>login_date<span class="token punctuation">,</span><span class="token keyword">interval</span> irank <span class="token keyword">day</span><span class="token punctuation">)</span> idate <span class="token keyword">from</span> user_login_data_1<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- select * from user_login_data_2</span>
<span class="token comment"># 4、计算连续登录的用户情况</span>

<span class="token keyword">select</span> user_id<span class="token punctuation">,</span><span class="token function">min</span><span class="token punctuation">(</span>login_date<span class="token punctuation">)</span> <span class="token keyword">as</span> start_date<span class="token punctuation">,</span>
							<span class="token function">max</span><span class="token punctuation">(</span>login_date<span class="token punctuation">)</span> <span class="token keyword">as</span> end_date<span class="token punctuation">,</span>
							<span class="token function">count</span><span class="token punctuation">(</span>login_date<span class="token punctuation">)</span> <span class="token keyword">as</span> days
<span class="token keyword">from</span> user_login_data_2
<span class="token keyword">group</span> <span class="token keyword">by</span> user_id<span class="token punctuation">,</span>idate


<span class="token comment">#整合代码</span>
<span class="token keyword">select</span> user_id<span class="token punctuation">,</span><span class="token function">min</span><span class="token punctuation">(</span>login_date<span class="token punctuation">)</span> <span class="token keyword">as</span> start_date<span class="token punctuation">,</span>
							<span class="token function">max</span><span class="token punctuation">(</span>login_date<span class="token punctuation">)</span> <span class="token keyword">as</span> end_date<span class="token punctuation">,</span>
							<span class="token function">count</span><span class="token punctuation">(</span>login_date<span class="token punctuation">)</span> <span class="token keyword">as</span> days
<span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>date_sub<span class="token punctuation">(</span>login_date<span class="token punctuation">,</span><span class="token keyword">interval</span> irank <span class="token keyword">day</span><span class="token punctuation">)</span> idate <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> user_id <span class="token keyword">order</span> <span class="token keyword">by</span> login_date<span class="token punctuation">)</span> irank
			<span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token keyword">distinct</span> user_id<span class="token punctuation">,</span><span class="token keyword">date</span><span class="token punctuation">(</span>login_time<span class="token punctuation">)</span> login_date
<span class="token keyword">from</span> user_login<span class="token punctuation">)</span> <span class="token keyword">as</span> c<span class="token punctuation">)</span> <span class="token keyword">as</span> b<span class="token punctuation">)</span> <span class="token keyword">as</span> a 
<span class="token keyword">group</span> <span class="token keyword">by</span> user_id<span class="token punctuation">,</span>idate


<span class="token comment"># 三、查看每位用户最大连续登录的天数</span>
<span class="token keyword">select</span> user_id<span class="token punctuation">,</span><span class="token function">max</span><span class="token punctuation">(</span>days<span class="token punctuation">)</span> 
     <span class="token keyword">from</span><span class="token punctuation">(</span><span class="token keyword">select</span> user_id<span class="token punctuation">,</span><span class="token function">min</span><span class="token punctuation">(</span>login_date<span class="token punctuation">)</span> <span class="token keyword">as</span> start_date<span class="token punctuation">,</span>
							<span class="token function">max</span><span class="token punctuation">(</span>login_date<span class="token punctuation">)</span> <span class="token keyword">as</span> end_date<span class="token punctuation">,</span>
							<span class="token function">count</span><span class="token punctuation">(</span>login_date<span class="token punctuation">)</span> <span class="token keyword">as</span> days
<span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>date_sub<span class="token punctuation">(</span>login_date<span class="token punctuation">,</span><span class="token keyword">interval</span> irank <span class="token keyword">day</span><span class="token punctuation">)</span> idate <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> user_id <span class="token keyword">order</span> <span class="token keyword">by</span> login_date<span class="token punctuation">)</span> irank
			<span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token keyword">distinct</span> user_id<span class="token punctuation">,</span><span class="token keyword">date</span><span class="token punctuation">(</span>login_time<span class="token punctuation">)</span> login_date
<span class="token keyword">from</span> user_login<span class="token punctuation">)</span> <span class="token keyword">as</span> c<span class="token punctuation">)</span> <span class="token keyword">as</span> b<span class="token punctuation">)</span> <span class="token keyword">as</span> a 
<span class="token keyword">group</span> <span class="token keyword">by</span> user_id<span class="token punctuation">,</span>idate<span class="token punctuation">)</span> <span class="token keyword">as</span> d
<span class="token keyword">group</span> <span class="token keyword">by</span> user_id

<span class="token comment"># 四、查看在这段时间内连续登录天数&gt;=5天的用户</span>
<span class="token comment">#方案1：</span>
<span class="token keyword">select</span> <span class="token keyword">distinct</span> user_id <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> user_id<span class="token punctuation">,</span><span class="token function">min</span><span class="token punctuation">(</span>login_date<span class="token punctuation">)</span> <span class="token keyword">as</span> start_date<span class="token punctuation">,</span>
							<span class="token function">max</span><span class="token punctuation">(</span>login_date<span class="token punctuation">)</span> <span class="token keyword">as</span> end_date<span class="token punctuation">,</span>
							<span class="token function">count</span><span class="token punctuation">(</span>login_date<span class="token punctuation">)</span> <span class="token keyword">as</span> days
<span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>date_sub<span class="token punctuation">(</span>login_date<span class="token punctuation">,</span><span class="token keyword">interval</span> irank <span class="token keyword">day</span><span class="token punctuation">)</span> idate <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> user_id <span class="token keyword">order</span> <span class="token keyword">by</span> login_date<span class="token punctuation">)</span> irank
			<span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token keyword">distinct</span> user_id<span class="token punctuation">,</span><span class="token keyword">date</span><span class="token punctuation">(</span>login_time<span class="token punctuation">)</span> login_date
<span class="token keyword">from</span> user_login<span class="token punctuation">)</span> <span class="token keyword">as</span> c<span class="token punctuation">)</span> <span class="token keyword">as</span> b<span class="token punctuation">)</span> <span class="token keyword">as</span> a 
<span class="token keyword">group</span> <span class="token keyword">by</span> user_id<span class="token punctuation">,</span>idate
<span class="token keyword">having</span> days <span class="token operator">&gt;=</span><span class="token number">5</span><span class="token punctuation">)</span> d 

<span class="token comment">#方案2：</span>
<span class="token comment">#lead()函数：静态窗口函数</span>
<span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>lead<span class="token punctuation">(</span>login_date<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> user_id <span class="token keyword">order</span> <span class="token keyword">by</span> login_date <span class="token punctuation">)</span> <span class="token keyword">as</span> idate5
<span class="token keyword">from</span> user_login_date

<span class="token comment">#计算第5次登录与当天的差值</span>
<span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>datediff<span class="token punctuation">(</span>idate5<span class="token punctuation">,</span>login_date<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span> days
<span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>lead<span class="token punctuation">(</span>login_date<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> user_id <span class="token keyword">order</span> <span class="token keyword">by</span> login_date <span class="token punctuation">)</span> <span class="token keyword">as</span> idate5
<span class="token keyword">from</span> user_login_date<span class="token punctuation">)</span> <span class="token keyword">as</span> a 

<span class="token comment">#查找相差天数为5的记录</span>
<span class="token keyword">select</span> <span class="token keyword">distinct</span> user_id <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>datediff<span class="token punctuation">(</span>idate5<span class="token punctuation">,</span>login_date<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span> days
<span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>lead<span class="token punctuation">(</span>login_date<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> user_id <span class="token keyword">order</span> <span class="token keyword">by</span> login_date <span class="token punctuation">)</span> <span class="token keyword">as</span> idate5
<span class="token keyword">from</span> user_login_date<span class="token punctuation">)</span> <span class="token keyword">as</span> a <span class="token punctuation">)</span><span class="token keyword">as</span> b 
<span class="token keyword">where</span> days <span class="token operator">=</span> <span class="token number">5</span>
</code></pre>
    <p>
     DATE_SUB 是 SQL 中用于从日期中减去指定时间间隔的函数。它通常用于计算过去某个时间点的日期。以下是 DATE_SUB 函数的详细用法及解释：
    </p>
    <pre><code class="prism language-sql">DATE_SUB<span class="token punctuation">(</span><span class="token keyword">date</span><span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token keyword">value</span> unit<span class="token punctuation">)</span>
<span class="token comment"># date：要操作的日期或日期时间值。</span>
<span class="token comment"># INTERVAL：表示时间间隔的关键字。</span>
<span class="token comment"># value：要减去的时间间隔值，必须是一个整数。</span>
<span class="token comment"># unit：时间间隔的单位，支持以下值：秒、分钟、小时、天、周、月、季度、年</span>
示例：
<span class="token keyword">SELECT</span> DATE_SUB<span class="token punctuation">(</span><span class="token string">'2023-10-01'</span><span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token number">5</span> <span class="token keyword">DAY</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment"># 从 2023-10-01 减去 5 天：结果：2023-09-26</span>
</code></pre>
    <p>
     LEAD() 是 SQL 中的一种 窗口函数（Window Function），用于获取当前行之后的某一行数据。它通常用于分析时间序列数据或计算相邻行之间的差异。
    </p>
    <pre><code class="prism language-sql">LEAD<span class="token punctuation">(</span>column_name<span class="token punctuation">,</span> <span class="token keyword">offset</span><span class="token punctuation">,</span> default_value<span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span>
    <span class="token punctuation">[</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> partition_expression<span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> sort_expression<span class="token punctuation">]</span>
<span class="token punctuation">)</span>
<span class="token comment"># column_name：需要获取值的列名。</span>
<span class="token comment"># offset（可选）：指定要获取的行数偏移量。默认值为 1，表示获取下一行。</span>
<span class="token comment"># default_value（可选）：如果偏移量超出范围（如最后一行没有下一行），则返回的默认值。如果未指定，默认返回 NULL。</span>
<span class="token comment"># PARTITION BY（可选）：将数据分组，LEAD() 函数会在每个分组内单独计算。</span>
<span class="token comment"># ORDER BY（可选）：指定窗口内的排序规则。</span>
</code></pre>
    <p>
     LEAD() 函数的作用：获取当前行之后的某一行数据；常用于计算相邻行之间的差异，或分析时间序列数据。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f:626c6f672e6373646e2e6e65742f753031323132313732312f:61727469636c652f64657461696c732f313436323833323330" class_="artid" style="display:none">
 </p>
</div>


