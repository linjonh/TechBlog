---
layout: post
title: "DeepSeek大模型-全维度技术解析"
date: 2025-03-06 17:39:49 +0800
description: "DeepSeek大模型采用分层的模块化设计，整体架构分为输入层、动态嵌入层、MoE编码器层、自适应注意力层、专家选择网络、残差压缩模块和任务特定输出头。DeepSeek采用混合精度训练（Mixed Precision Training），结合FP16和FP32的优势，在保证数值稳定性的同时提升训练速度。DeepSeek的MoE层通过动态路由算法选择最合适的专家网络。DeepSeek支持3D并行训练（数据并行、张量并行、流水线并行），充分利用大规模计算集群的资源。"
keywords: "DeepSeek大模型 —— 全维度技术解析"
categories: ['智能Ai']
tags: ['人工智能', 'Ai']
artid: "146075698"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146075698
    alt: "DeepSeek大模型-全维度技术解析"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146075698
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146075698
cover: https://bing.ee123.net/img/rand?artid=146075698
image: https://bing.ee123.net/img/rand?artid=146075698
img: https://bing.ee123.net/img/rand?artid=146075698
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     DeepSeek大模型 —— 全维度技术解析
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-tomorrow-night-eighties" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="DeepSeek___0">
     </a>
     DeepSeek大模型 —— 全维度技术解析
    </h2>
    <hr/>
    <p>
     前些天发现了一个巨牛的人工智能学习网站，通俗易懂，风趣幽默，可以分享一下给大家。点击跳转到网站。
     <br/>
     <a href="https://www.captainbed.cn/ccc" rel="nofollow">
      https://www.captainbed.cn/ccc
     </a>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/21d512e13d13431aa967469dee897c2e.gif"/>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/3d262b48c2f4440d95032b8b0d55cd95.png"/>
    </p>
    <p>
    </p>
    <p>
    </p>
    <h3>
     <a id="_23">
     </a>
     一、模型架构全景解析
    </h3>
    <h4>
     <a id="11__25">
     </a>
     1.1 分层架构设计
    </h4>
    <p>
     DeepSeek大模型采用分层的模块化设计，整体架构分为输入层、动态嵌入层、MoE编码器层、自适应注意力层、专家选择网络、残差压缩模块和任务特定输出头。这种分层设计不仅提升了模型的表达能力，还增强了模块的可复用性和可扩展性。
    </p>
    <div class="mermaid">
     <svg class="mermaid-svg" height="638" id="mermaid-svg-UkGe4YJJJ6li381b" viewbox="0 0 148 638" width="148" xmlns="http://www.w3.org/2000/svg">
      <style>
       #mermaid-svg-UkGe4YJJJ6li381b {font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}#mermaid-svg-UkGe4YJJJ6li381b .error-icon{fill:#552222;}#mermaid-svg-UkGe4YJJJ6li381b .error-text{fill:#552222;stroke:#552222;}#mermaid-svg-UkGe4YJJJ6li381b .edge-thickness-normal{stroke-width:2px;}#mermaid-svg-UkGe4YJJJ6li381b .edge-thickness-thick{stroke-width:3.5px;}#mermaid-svg-UkGe4YJJJ6li381b .edge-pattern-solid{stroke-dasharray:0;}#mermaid-svg-UkGe4YJJJ6li381b .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-svg-UkGe4YJJJ6li381b .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-svg-UkGe4YJJJ6li381b .marker{fill:#333333;stroke:#333333;}#mermaid-svg-UkGe4YJJJ6li381b .marker.cross{stroke:#333333;}#mermaid-svg-UkGe4YJJJ6li381b svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-svg-UkGe4YJJJ6li381b .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#mermaid-svg-UkGe4YJJJ6li381b .cluster-label text{fill:#333;}#mermaid-svg-UkGe4YJJJ6li381b .cluster-label span{color:#333;}#mermaid-svg-UkGe4YJJJ6li381b .label text,#mermaid-svg-UkGe4YJJJ6li381b span{fill:#333;color:#333;}#mermaid-svg-UkGe4YJJJ6li381b .node rect,#mermaid-svg-UkGe4YJJJ6li381b .node circle,#mermaid-svg-UkGe4YJJJ6li381b .node ellipse,#mermaid-svg-UkGe4YJJJ6li381b .node polygon,#mermaid-svg-UkGe4YJJJ6li381b .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#mermaid-svg-UkGe4YJJJ6li381b .node .label{text-align:center;}#mermaid-svg-UkGe4YJJJ6li381b .node.clickable{cursor:pointer;}#mermaid-svg-UkGe4YJJJ6li381b .arrowheadPath{fill:#333333;}#mermaid-svg-UkGe4YJJJ6li381b .edgePath .path{stroke:#333333;stroke-width:2.0px;}#mermaid-svg-UkGe4YJJJ6li381b .flowchart-link{stroke:#333333;fill:none;}#mermaid-svg-UkGe4YJJJ6li381b .edgeLabel{background-color:#e8e8e8;text-align:center;}#mermaid-svg-UkGe4YJJJ6li381b .edgeLabel rect{opacity:0.5;background-color:#e8e8e8;fill:#e8e8e8;}#mermaid-svg-UkGe4YJJJ6li381b .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#mermaid-svg-UkGe4YJJJ6li381b .cluster text{fill:#333;}#mermaid-svg-UkGe4YJJJ6li381b .cluster span{color:#333;}#mermaid-svg-UkGe4YJJJ6li381b div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#mermaid-svg-UkGe4YJJJ6li381b :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}
      </style>
      <g>
       <g class="output">
        <g class="clusters">
        </g>
        <g class="edgePaths">
         <g class="edgePath LS-A LE-B" id="L-A-B" style="opacity: 1;">
          <path class="path" d="M74,54L74,58.166666666666664C74,62.333333333333336,74,70.66666666666667,74,79C74,87.33333333333333,74,95.66666666666667,74,99.83333333333333L74,104" marker-end="url(#arrowhead246)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead246" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-B LE-C" id="L-B-C" style="opacity: 1;">
          <path class="path" d="M74,150L74,154.16666666666666C74,158.33333333333334,74,166.66666666666666,74,175C74,183.33333333333334,74,191.66666666666666,74,195.83333333333334L74,200" marker-end="url(#arrowhead247)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead247" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-C LE-D" id="L-C-D" style="opacity: 1;">
          <path class="path" d="M74,246L74,250.16666666666666C74,254.33333333333334,74,262.6666666666667,74,271C74,279.3333333333333,74,287.6666666666667,74,291.8333333333333L74,296" marker-end="url(#arrowhead248)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead248" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-D LE-E" id="L-D-E" style="opacity: 1;">
          <path class="path" d="M74,342L74,346.1666666666667C74,350.3333333333333,74,358.6666666666667,74,367C74,375.3333333333333,74,383.6666666666667,74,387.8333333333333L74,392" marker-end="url(#arrowhead249)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead249" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-E LE-F" id="L-E-F" style="opacity: 1;">
          <path class="path" d="M74,438L74,442.1666666666667C74,446.3333333333333,74,454.6666666666667,74,463C74,471.3333333333333,74,479.6666666666667,74,483.8333333333333L74,488" marker-end="url(#arrowhead250)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead250" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-F LE-G" id="L-F-G" style="opacity: 1;">
          <path class="path" d="M74,534L74,538.1666666666666C74,542.3333333333334,74,550.6666666666666,74,559C74,567.3333333333334,74,575.6666666666666,74,579.8333333333334L74,584" marker-end="url(#arrowhead251)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead251" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
        </g>
        <g class="edgeLabels">
         <g class="edgeLabel" style="opacity: 1;" transform="">
          <g class="label" transform="translate(0,0)">
           <rect height="0" rx="0" ry="0" width="0">
           </rect>
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-A' L-LE-B" id="L-L-A-B">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="">
          <g class="label" transform="translate(0,0)">
           <rect height="0" rx="0" ry="0" width="0">
           </rect>
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-B' L-LE-C" id="L-L-B-C">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="">
          <g class="label" transform="translate(0,0)">
           <rect height="0" rx="0" ry="0" width="0">
           </rect>
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-C' L-LE-D" id="L-L-C-D">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="">
          <g class="label" transform="translate(0,0)">
           <rect height="0" rx="0" ry="0" width="0">
           </rect>
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-D' L-LE-E" id="L-L-D-E">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="">
          <g class="label" transform="translate(0,0)">
           <rect height="0" rx="0" ry="0" width="0">
           </rect>
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-E' L-LE-F" id="L-L-E-F">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="">
          <g class="label" transform="translate(0,0)">
           <rect height="0" rx="0" ry="0" width="0">
           </rect>
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-F' L-LE-G" id="L-L-F-G">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
        </g>
        <g class="nodes">
         <g class="node default" id="flowchart-A-180" style="opacity: 1;" transform="translate(74,31)">
          <rect class="label-container" height="46" rx="0" ry="0" width="68" x="-34" y="-23">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-24,-13)">
            <foreignobject height="26" width="48">
             <div style="display: inline-block; white-space: nowrap;">
              输入层
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-B-181" style="opacity: 1;" transform="translate(74,127)">
          <rect class="label-container" height="46" rx="0" ry="0" width="100" x="-50" y="-23">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-40,-13)">
            <foreignobject height="26" width="80">
             <div style="display: inline-block; white-space: nowrap;">
              动态嵌入层
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-C-183" style="opacity: 1;" transform="translate(74,223)">
          <rect class="label-container" height="46" rx="0" ry="0" width="112.51042175292969" x="-56.255210876464844" y="-23">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-46.255210876464844,-13)">
            <foreignobject height="26" width="92.51042175292969">
             <div style="display: inline-block; white-space: nowrap;">
              MoE编码器层
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-D-185" style="opacity: 1;" transform="translate(74,319)">
          <rect class="label-container" height="46" rx="0" ry="0" width="132" x="-66" y="-23">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-56,-13)">
            <foreignobject height="26" width="112">
             <div style="display: inline-block; white-space: nowrap;">
              自适应注意力层
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-E-187" style="opacity: 1;" transform="translate(74,415)">
          <rect class="label-container" height="46" rx="0" ry="0" width="116" x="-58" y="-23">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-48,-13)">
            <foreignobject height="26" width="96">
             <div style="display: inline-block; white-space: nowrap;">
              专家选择网络
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-F-189" style="opacity: 1;" transform="translate(74,511)">
          <rect class="label-container" height="46" rx="0" ry="0" width="116" x="-58" y="-23">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-48,-13)">
            <foreignobject height="26" width="96">
             <div style="display: inline-block; white-space: nowrap;">
              残差压缩模块
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-G-191" style="opacity: 1;" transform="translate(74,607)">
          <rect class="label-container" height="46" rx="0" ry="0" width="132" x="-66" y="-23">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-56,-13)">
            <foreignobject height="26" width="112">
             <div style="display: inline-block; white-space: nowrap;">
              任务特定输出头
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
        </g>
       </g>
      </g>
     </svg>
    </div>
    <ul>
     <li>
      <strong>
       输入层
      </strong>
      ：支持多模态输入（文本、图像、代码等），通过统一的输入接口进行数据预处理。
     </li>
     <li>
      <strong>
       动态嵌入层
      </strong>
      ：根据输入数据的特性动态调整嵌入表示，提升模型对多样化数据的适应能力。
     </li>
     <li>
      <strong>
       MoE编码器层
      </strong>
      ：采用混合专家系统（Mixture of Experts, MoE），通过动态路由机制选择最合适的专家网络处理输入。
     </li>
     <li>
      <strong>
       自适应注意力层
      </strong>
      ：引入稀疏注意力和局部注意力机制，降低计算复杂度。
     </li>
     <li>
      <strong>
       专家选择网络
      </strong>
      ：基于输入特征动态分配计算资源，提升模型效率。
     </li>
     <li>
      <strong>
       残差压缩模块
      </strong>
      ：通过压缩和恢复机制减少内存占用。
     </li>
     <li>
      <strong>
       任务特定输出头
      </strong>
      ：根据不同任务（如文本生成、分类、推理）动态调整输出结构。
     </li>
    </ul>
    <h4>
     <a id="12_Transformer_47">
     </a>
     1.2 改进型Transformer层
    </h4>
    <p>
     DeepSeek在传统Transformer的基础上进行了多项创新，主要包括：
    </p>
    <ul>
     <li>
      <strong>
       Flash Attention
      </strong>
      ：利用硬件加速实现高效注意力计算。
     </li>
     <li>
      <strong>
       混合专家系统（MoE）
      </strong>
      ：将模型划分为多个专家网络，动态选择激活的专家。
     </li>
     <li>
      <strong>
       残差连接优化
      </strong>
      ：引入RMSNorm替代LayerNorm，提升训练稳定性。
     </li>
    </ul>
    <p>
     以下是改进型Transformer层的代码实现：
    </p>
    <pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">DeepSeekTransformerBlock</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>attention <span class="token operator">=</span> FlashMultiHeadAttention<span class="token punctuation">(</span>
            embed_dim<span class="token operator">=</span>config<span class="token punctuation">.</span>hidden_size<span class="token punctuation">,</span>
            num_heads<span class="token operator">=</span>config<span class="token punctuation">.</span>num_attention_heads<span class="token punctuation">,</span>
            dropout<span class="token operator">=</span>config<span class="token punctuation">.</span>attention_dropout
        <span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>moe <span class="token operator">=</span> MoELayer<span class="token punctuation">(</span>
            num_experts<span class="token operator">=</span>config<span class="token punctuation">.</span>moe_num_experts<span class="token punctuation">,</span>
            expert_capacity<span class="token operator">=</span>config<span class="token punctuation">.</span>expert_capacity<span class="token punctuation">,</span>
            hidden_size<span class="token operator">=</span>config<span class="token punctuation">.</span>hidden_size<span class="token punctuation">,</span>
            top_k<span class="token operator">=</span>config<span class="token punctuation">.</span>moe_top_k
        <span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>norm1 <span class="token operator">=</span> RMSNorm<span class="token punctuation">(</span>config<span class="token punctuation">.</span>hidden_size<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>norm2 <span class="token operator">=</span> RMSNorm<span class="token punctuation">(</span>config<span class="token punctuation">.</span>hidden_size<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>dropout <span class="token operator">=</span> nn<span class="token punctuation">.</span>Dropout<span class="token punctuation">(</span>config<span class="token punctuation">.</span>hidden_dropout<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 混合注意力路径</span>
        attn_out <span class="token operator">=</span> self<span class="token punctuation">.</span>attention<span class="token punctuation">(</span>self<span class="token punctuation">.</span>norm1<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
        x <span class="token operator">=</span> x <span class="token operator">+</span> self<span class="token punctuation">.</span>dropout<span class="token punctuation">(</span>attn_out<span class="token punctuation">)</span>
        
        <span class="token comment"># 混合专家路径</span>
        moe_out <span class="token operator">=</span> self<span class="token punctuation">.</span>moe<span class="token punctuation">(</span>self<span class="token punctuation">.</span>norm2<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
        x <span class="token operator">=</span> x <span class="token operator">+</span> self<span class="token punctuation">.</span>dropout<span class="token punctuation">(</span>moe_out<span class="token punctuation">)</span>
        <span class="token keyword">return</span> x
</code></pre>
    <hr/>
    <h3>
     <a id="_88">
     </a>
     二、核心技术创新详解
    </h3>
    <h4>
     <a id="21__90">
     </a>
     2.1 动态专家选择算法
    </h4>
    <p>
     DeepSeek的MoE层通过动态路由算法选择最合适的专家网络。其核心思想是根据输入特征动态分配计算资源，避免对所有专家进行计算，从而提升效率。
    </p>
    <div class="mermaid">
     <svg class="mermaid-svg" height="639" id="mermaid-svg-qk5QuzbiPAMDFKpD" viewbox="0 0 266 639" width="266" xmlns="http://www.w3.org/2000/svg">
      <style>
       #mermaid-svg-qk5QuzbiPAMDFKpD {font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}#mermaid-svg-qk5QuzbiPAMDFKpD .error-icon{fill:#552222;}#mermaid-svg-qk5QuzbiPAMDFKpD .error-text{fill:#552222;stroke:#552222;}#mermaid-svg-qk5QuzbiPAMDFKpD .edge-thickness-normal{stroke-width:2px;}#mermaid-svg-qk5QuzbiPAMDFKpD .edge-thickness-thick{stroke-width:3.5px;}#mermaid-svg-qk5QuzbiPAMDFKpD .edge-pattern-solid{stroke-dasharray:0;}#mermaid-svg-qk5QuzbiPAMDFKpD .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-svg-qk5QuzbiPAMDFKpD .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-svg-qk5QuzbiPAMDFKpD .marker{fill:#333333;stroke:#333333;}#mermaid-svg-qk5QuzbiPAMDFKpD .marker.cross{stroke:#333333;}#mermaid-svg-qk5QuzbiPAMDFKpD svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-svg-qk5QuzbiPAMDFKpD .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#mermaid-svg-qk5QuzbiPAMDFKpD .cluster-label text{fill:#333;}#mermaid-svg-qk5QuzbiPAMDFKpD .cluster-label span{color:#333;}#mermaid-svg-qk5QuzbiPAMDFKpD .label text,#mermaid-svg-qk5QuzbiPAMDFKpD span{fill:#333;color:#333;}#mermaid-svg-qk5QuzbiPAMDFKpD .node rect,#mermaid-svg-qk5QuzbiPAMDFKpD .node circle,#mermaid-svg-qk5QuzbiPAMDFKpD .node ellipse,#mermaid-svg-qk5QuzbiPAMDFKpD .node polygon,#mermaid-svg-qk5QuzbiPAMDFKpD .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#mermaid-svg-qk5QuzbiPAMDFKpD .node .label{text-align:center;}#mermaid-svg-qk5QuzbiPAMDFKpD .node.clickable{cursor:pointer;}#mermaid-svg-qk5QuzbiPAMDFKpD .arrowheadPath{fill:#333333;}#mermaid-svg-qk5QuzbiPAMDFKpD .edgePath .path{stroke:#333333;stroke-width:2.0px;}#mermaid-svg-qk5QuzbiPAMDFKpD .flowchart-link{stroke:#333333;fill:none;}#mermaid-svg-qk5QuzbiPAMDFKpD .edgeLabel{background-color:#e8e8e8;text-align:center;}#mermaid-svg-qk5QuzbiPAMDFKpD .edgeLabel rect{opacity:0.5;background-color:#e8e8e8;fill:#e8e8e8;}#mermaid-svg-qk5QuzbiPAMDFKpD .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#mermaid-svg-qk5QuzbiPAMDFKpD .cluster text{fill:#333;}#mermaid-svg-qk5QuzbiPAMDFKpD .cluster span{color:#333;}#mermaid-svg-qk5QuzbiPAMDFKpD div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#mermaid-svg-qk5QuzbiPAMDFKpD :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}
      </style>
      <g>
       <g class="output">
        <g class="clusters">
        </g>
        <g class="edgePaths">
         <g class="edgePath LS-A LE-B" id="L-A-B" style="opacity: 1;">
          <path class="path" d="M141,54L141,58.166666666666664C141,62.333333333333336,141,70.66666666666667,141,79C141,87.33333333333333,141,95.66666666666667,141,99.83333333333333L141,104" marker-end="url(#arrowhead281)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead281" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-B LE-C" id="L-B-C" style="opacity: 1;">
          <path class="path" d="M141,150L141,154.16666666666666C141,158.33333333333334,141,166.66666666666666,141,175C141,183.33333333333334,141,191.66666666666666,141,195.83333333333334L141,200" marker-end="url(#arrowhead282)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead282" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-C LE-D" id="L-C-D" style="opacity: 1;">
          <path class="path" d="M141,246L141,250.16666666666666C141,254.33333333333334,141,262.6666666666667,141.08333333333334,271.0833333333333C141.16666666666666,279.5,141.33333333333334,288,141.41666666666666,292.25L141.5,296.5" marker-end="url(#arrowhead283)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead283" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-D LE-E" id="L-D-E" style="opacity: 1;">
          <path class="path" d="M115.91690962099125,387.91690962099125L107.59742468415936,398.43075801749274C99.2779397473275,408.9446064139941,82.63896987366375,429.9723032069971,74.31948493683187,446.8194849368319C66,463.6666666666667,66,476.3333333333333,66,482.6666666666667L66,489" marker-end="url(#arrowhead284)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead284" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-D LE-F" id="L-D-F" style="opacity: 1;">
          <path class="path" d="M167.08309037900875,387.91690962099125L175.23590864917398,398.43075801749274C183.38872691933918,408.9446064139941,199.6943634596696,429.9723032069971,207.8471817298348,446.8194849368319C216,463.6666666666667,216,476.3333333333333,216,482.6666666666667L216,489" marker-end="url(#arrowhead285)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead285" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-E LE-G" id="L-E-G" style="opacity: 1;">
          <path class="path" d="M66,535L66,539.1666666666666C66,543.3333333333334,66,551.6666666666666,66,560C66,568.3333333333334,66,576.6666666666666,66,580.8333333333334L66,585" marker-end="url(#arrowhead286)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead286" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
        </g>
        <g class="edgeLabels">
         <g class="edgeLabel" style="opacity: 1;" transform="">
          <g class="label" transform="translate(0,0)">
           <rect height="0" rx="0" ry="0" width="0">
           </rect>
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-A' L-LE-B" id="L-L-A-B">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="">
          <g class="label" transform="translate(0,0)">
           <rect height="0" rx="0" ry="0" width="0">
           </rect>
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-B' L-LE-C" id="L-L-B-C">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="">
          <g class="label" transform="translate(0,0)">
           <rect height="0" rx="0" ry="0" width="0">
           </rect>
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-C' L-LE-D" id="L-L-C-D">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="translate(66,451)">
          <g class="label" transform="translate(-19.94270896911621,-13)">
           <rect height="26" rx="0" ry="0" width="39.88541793823242">
           </rect>
           <foreignobject height="26" width="39.88541793823242">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-D' L-LE-E" id="L-L-D-E">
              Top-K
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="translate(216,451)">
          <g class="label" transform="translate(-24,-13)">
           <rect height="26" rx="0" ry="0" width="48">
           </rect>
           <foreignobject height="26" width="48">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-D' L-LE-F" id="L-L-D-F">
              未选中
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="">
          <g class="label" transform="translate(0,0)">
           <rect height="0" rx="0" ry="0" width="0">
           </rect>
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-E' L-LE-G" id="L-L-E-G">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
        </g>
        <g class="nodes">
         <g class="node default" id="flowchart-A-204" style="opacity: 1;" transform="translate(141,31)">
          <rect class="label-container" height="46" rx="0" ry="0" width="84" x="-42" y="-23">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-32,-13)">
            <foreignobject height="26" width="64">
             <div style="display: inline-block; white-space: nowrap;">
              输入特征
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-B-205" style="opacity: 1;" transform="translate(141,127)">
          <rect class="label-container" height="46" rx="0" ry="0" width="84" x="-42" y="-23">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-32,-13)">
            <foreignobject height="26" width="64">
             <div style="display: inline-block; white-space: nowrap;">
              门控网络
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-C-207" style="opacity: 1;" transform="translate(141,223)">
          <rect class="label-container" height="46" rx="0" ry="0" width="116" x="-58" y="-23">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-48,-13)">
            <foreignobject height="26" width="96">
             <div style="display: inline-block; white-space: nowrap;">
              计算专家权重
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-D-209" style="opacity: 1;" transform="translate(141,354.5)">
          <polygon class="label-container" points="58.5,0 117,-58.5 58.5,-117 0,-58.5" transform="translate(-58.5,58.5)">
          </polygon>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-32,-13)">
            <foreignobject height="26" width="64">
             <div style="display: inline-block; white-space: nowrap;">
              权重排序
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-E-211" style="opacity: 1;" transform="translate(66,512)">
          <rect class="label-container" height="46" rx="0" ry="0" width="116" x="-58" y="-23">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-48,-13)">
            <foreignobject height="26" width="96">
             <div style="display: inline-block; white-space: nowrap;">
              激活专家网络
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-F-213" style="opacity: 1;" transform="translate(216,512)">
          <rect class="label-container" height="46" rx="0" ry="0" width="84" x="-42" y="-23">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-32,-13)">
            <foreignobject height="26" width="64">
             <div style="display: inline-block; white-space: nowrap;">
              跳过计算
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-G-215" style="opacity: 1;" transform="translate(66,608)">
          <rect class="label-container" height="46" rx="0" ry="0" width="84" x="-42" y="-23">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-32,-13)">
            <foreignobject height="26" width="64">
             <div style="display: inline-block; white-space: nowrap;">
              输出结果
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
        </g>
       </g>
      </g>
     </svg>
    </div>
    <p>
     <strong>
      改进型门控网络
     </strong>
     ：
    </p>
    <pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">DynamicRouter</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> input_dim<span class="token punctuation">,</span> num_experts<span class="token punctuation">,</span> top_k<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>top_k <span class="token operator">=</span> top_k
        self<span class="token punctuation">.</span>gate <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
            nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>input_dim<span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>GELU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> num_experts<span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>Softmax<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>noise <span class="token operator">=</span> nn<span class="token punctuation">.</span>Parameter<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>randn<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> num_experts<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">0.1</span><span class="token punctuation">)</span>
        
    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        logits <span class="token operator">=</span> self<span class="token punctuation">.</span>gate<span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> self<span class="token punctuation">.</span>noise
        probs <span class="token operator">=</span> F<span class="token punctuation">.</span>softmax<span class="token punctuation">(</span>logits<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        topk_probs<span class="token punctuation">,</span> topk_indices <span class="token operator">=</span> torch<span class="token punctuation">.</span>topk<span class="token punctuation">(</span>probs<span class="token punctuation">,</span> self<span class="token punctuation">.</span>top_k<span class="token punctuation">)</span>
        <span class="token keyword">return</span> topk_probs<span class="token punctuation">,</span> topk_indices
</code></pre>
    <p>
     <strong>
      动态路由的优势
     </strong>
     ：
    </p>
    <ul>
     <li>
      <strong>
       计算效率
      </strong>
      ：仅激活部分专家网络，减少计算量。
     </li>
     <li>
      <strong>
       灵活性
      </strong>
      ：根据输入特性动态调整计算资源分配。
     </li>
     <li>
      <strong>
       可扩展性
      </strong>
      ：支持专家网络的横向扩展。
     </li>
    </ul>
    <h4>
     <a id="22__130">
     </a>
     2.2 高效训练策略
    </h4>
    <h5>
     <a id="221__132">
     </a>
     2.2.1 混合精度训练
    </h5>
    <p>
     DeepSeek采用混合精度训练（Mixed Precision Training），结合FP16和FP32的优势，在保证数值稳定性的同时提升训练速度。
    </p>
    <pre><code class="prism language-yaml"><span class="token comment"># deepseek_train_config.yaml</span>
<span class="token key atrule">training</span><span class="token punctuation">:</span>
  <span class="token key atrule">precision</span><span class="token punctuation">:</span> bfloat16
  <span class="token key atrule">optimizer</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> Lion
    <span class="token key atrule">params</span><span class="token punctuation">:</span>
      <span class="token key atrule">lr</span><span class="token punctuation">:</span> <span class="token number">3e-5</span>
      <span class="token key atrule">weight_decay</span><span class="token punctuation">:</span> <span class="token number">0.01</span>
      <span class="token key atrule">beta1</span><span class="token punctuation">:</span> <span class="token number">0.9</span>
      <span class="token key atrule">beta2</span><span class="token punctuation">:</span> <span class="token number">0.99</span>
  <span class="token key atrule">gradient_clipping</span><span class="token punctuation">:</span> <span class="token number">1.0</span>
  <span class="token key atrule">batch_scheduler</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> linear_warmup_cosine_decay
    <span class="token key atrule">warmup_steps</span><span class="token punctuation">:</span> <span class="token number">2000</span>
    <span class="token key atrule">total_steps</span><span class="token punctuation">:</span> <span class="token number">100000</span>
  <span class="token key atrule">checkpoint</span><span class="token punctuation">:</span>
    <span class="token key atrule">interval</span><span class="token punctuation">:</span> <span class="token number">1000</span>
    <span class="token key atrule">keep_last</span><span class="token punctuation">:</span> <span class="token number">3</span>
</code></pre>
    <h5>
     <a id="222__157">
     </a>
     2.2.2 分布式训练
    </h5>
    <p>
     DeepSeek支持3D并行训练（数据并行、张量并行、流水线并行），充分利用大规模计算集群的资源。
    </p>
    <div class="mermaid">
     <svg class="mermaid-svg" height="446" id="mermaid-svg-oJoEkrlvjb7oJDGy" viewbox="0 0 448 446" width="448" xmlns="http://www.w3.org/2000/svg">
      <style>
       #mermaid-svg-oJoEkrlvjb7oJDGy {font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}#mermaid-svg-oJoEkrlvjb7oJDGy .error-icon{fill:#552222;}#mermaid-svg-oJoEkrlvjb7oJDGy .error-text{fill:#552222;stroke:#552222;}#mermaid-svg-oJoEkrlvjb7oJDGy .edge-thickness-normal{stroke-width:2px;}#mermaid-svg-oJoEkrlvjb7oJDGy .edge-thickness-thick{stroke-width:3.5px;}#mermaid-svg-oJoEkrlvjb7oJDGy .edge-pattern-solid{stroke-dasharray:0;}#mermaid-svg-oJoEkrlvjb7oJDGy .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-svg-oJoEkrlvjb7oJDGy .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-svg-oJoEkrlvjb7oJDGy .marker{fill:#333333;stroke:#333333;}#mermaid-svg-oJoEkrlvjb7oJDGy .marker.cross{stroke:#333333;}#mermaid-svg-oJoEkrlvjb7oJDGy svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-svg-oJoEkrlvjb7oJDGy .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#mermaid-svg-oJoEkrlvjb7oJDGy .cluster-label text{fill:#333;}#mermaid-svg-oJoEkrlvjb7oJDGy .cluster-label span{color:#333;}#mermaid-svg-oJoEkrlvjb7oJDGy .label text,#mermaid-svg-oJoEkrlvjb7oJDGy span{fill:#333;color:#333;}#mermaid-svg-oJoEkrlvjb7oJDGy .node rect,#mermaid-svg-oJoEkrlvjb7oJDGy .node circle,#mermaid-svg-oJoEkrlvjb7oJDGy .node ellipse,#mermaid-svg-oJoEkrlvjb7oJDGy .node polygon,#mermaid-svg-oJoEkrlvjb7oJDGy .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#mermaid-svg-oJoEkrlvjb7oJDGy .node .label{text-align:center;}#mermaid-svg-oJoEkrlvjb7oJDGy .node.clickable{cursor:pointer;}#mermaid-svg-oJoEkrlvjb7oJDGy .arrowheadPath{fill:#333333;}#mermaid-svg-oJoEkrlvjb7oJDGy .edgePath .path{stroke:#333333;stroke-width:2.0px;}#mermaid-svg-oJoEkrlvjb7oJDGy .flowchart-link{stroke:#333333;fill:none;}#mermaid-svg-oJoEkrlvjb7oJDGy .edgeLabel{background-color:#e8e8e8;text-align:center;}#mermaid-svg-oJoEkrlvjb7oJDGy .edgeLabel rect{opacity:0.5;background-color:#e8e8e8;fill:#e8e8e8;}#mermaid-svg-oJoEkrlvjb7oJDGy .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#mermaid-svg-oJoEkrlvjb7oJDGy .cluster text{fill:#333;}#mermaid-svg-oJoEkrlvjb7oJDGy .cluster span{color:#333;}#mermaid-svg-oJoEkrlvjb7oJDGy div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#mermaid-svg-oJoEkrlvjb7oJDGy :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}
      </style>
      <g>
       <g class="output">
        <g class="clusters">
        </g>
        <g class="edgePaths">
         <g class="edgePath LS-A LE-B" id="L-A-B" style="opacity: 1;">
          <path class="path" d="M66,54L66,58.166666666666664C66,62.333333333333336,66,70.66666666666667,66,79C66,87.33333333333333,66,95.66666666666667,66,99.83333333333333L66,104" marker-end="url(#arrowhead313)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead313" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-B LE-C" id="L-B-C" style="opacity: 1;">
          <path class="path" d="M66,150L66,154.16666666666666C66,158.33333333333334,66,166.66666666666666,66,175C66,183.33333333333334,66,191.66666666666666,66,195.83333333333334L66,200" marker-end="url(#arrowhead314)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead314" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-C LE-D" id="L-C-D" style="opacity: 1;">
          <path class="path" d="M66,246L66,250.16666666666666C66,254.33333333333334,66,262.6666666666667,66,271C66,279.3333333333333,66,287.6666666666667,66,291.8333333333333L66,296" marker-end="url(#arrowhead315)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead315" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-D LE-E" id="L-D-E" style="opacity: 1;">
          <path class="path" d="M66,342L66,346.1666666666667C66,350.3333333333333,66,358.6666666666667,66,367C66,375.3333333333333,66,383.6666666666667,66,387.8333333333333L66,392" marker-end="url(#arrowhead316)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead316" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-F LE-G" id="L-F-G" style="opacity: 1;">
          <path class="path" d="M216,54L216,58.166666666666664C216,62.333333333333336,216,70.66666666666667,216,79C216,87.33333333333333,216,95.66666666666667,216,99.83333333333333L216,104" marker-end="url(#arrowhead317)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead317" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-G LE-H" id="L-G-H" style="opacity: 1;">
          <path class="path" d="M216,150L216,154.16666666666666C216,158.33333333333334,216,166.66666666666666,216,175C216,183.33333333333334,216,191.66666666666666,216,195.83333333333334L216,200" marker-end="url(#arrowhead318)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead318" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-H LE-I" id="L-H-I" style="opacity: 1;">
          <path class="path" d="M216,246L216,250.16666666666666C216,254.33333333333334,216,262.6666666666667,216,271C216,279.3333333333333,216,287.6666666666667,216,291.8333333333333L216,296" marker-end="url(#arrowhead319)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead319" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-J LE-K" id="L-J-K" style="opacity: 1;">
          <path class="path" d="M374,54L374,58.166666666666664C374,62.333333333333336,374,70.66666666666667,374,79C374,87.33333333333333,374,95.66666666666667,374,99.83333333333333L374,104" marker-end="url(#arrowhead320)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead320" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-K LE-L" id="L-K-L" style="opacity: 1;">
          <path class="path" d="M374,150L374,154.16666666666666C374,158.33333333333334,374,166.66666666666666,374,175C374,183.33333333333334,374,191.66666666666666,374,195.83333333333334L374,200" marker-end="url(#arrowhead321)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead321" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
        </g>
        <g class="edgeLabels">
         <g class="edgeLabel" style="opacity: 1;" transform="">
          <g class="label" transform="translate(0,0)">
           <rect height="0" rx="0" ry="0" width="0">
           </rect>
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-A' L-LE-B" id="L-L-A-B">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="">
          <g class="label" transform="translate(0,0)">
           <rect height="0" rx="0" ry="0" width="0">
           </rect>
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-B' L-LE-C" id="L-L-B-C">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="">
          <g class="label" transform="translate(0,0)">
           <rect height="0" rx="0" ry="0" width="0">
           </rect>
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-C' L-LE-D" id="L-L-C-D">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="">
          <g class="label" transform="translate(0,0)">
           <rect height="0" rx="0" ry="0" width="0">
           </rect>
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-D' L-LE-E" id="L-L-D-E">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="">
          <g class="label" transform="translate(0,0)">
           <rect height="0" rx="0" ry="0" width="0">
           </rect>
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-F' L-LE-G" id="L-L-F-G">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="">
          <g class="label" transform="translate(0,0)">
           <rect height="0" rx="0" ry="0" width="0">
           </rect>
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-G' L-LE-H" id="L-L-G-H">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="">
          <g class="label" transform="translate(0,0)">
           <rect height="0" rx="0" ry="0" width="0">
           </rect>
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-H' L-LE-I" id="L-L-H-I">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="">
          <g class="label" transform="translate(0,0)">
           <rect height="0" rx="0" ry="0" width="0">
           </rect>
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-J' L-LE-K" id="L-L-J-K">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="">
          <g class="label" transform="translate(0,0)">
           <rect height="0" rx="0" ry="0" width="0">
           </rect>
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-K' L-LE-L" id="L-L-K-L">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
        </g>
        <g class="nodes">
         <g class="node default" id="flowchart-A-234" style="opacity: 1;" transform="translate(66,31)">
          <rect class="label-container" height="46" rx="0" ry="0" width="84" x="-42" y="-23">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-32,-13)">
            <foreignobject height="26" width="64">
             <div style="display: inline-block; white-space: nowrap;">
              数据并行
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-B-235" style="opacity: 1;" transform="translate(66,127)">
          <rect class="label-container" height="46" rx="0" ry="0" width="84" x="-42" y="-23">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-32,-13)">
            <foreignobject height="26" width="64">
             <div style="display: inline-block; white-space: nowrap;">
              分片数据
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-C-237" style="opacity: 1;" transform="translate(66,223)">
          <rect class="label-container" height="46" rx="0" ry="0" width="116" x="-58" y="-23">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-48,-13)">
            <foreignobject height="26" width="96">
             <div style="display: inline-block; white-space: nowrap;">
              独立计算梯度
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-D-239" style="opacity: 1;" transform="translate(66,319)">
          <rect class="label-container" height="46" rx="0" ry="0" width="84" x="-42" y="-23">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-32,-13)">
            <foreignobject height="26" width="64">
             <div style="display: inline-block; white-space: nowrap;">
              梯度聚合
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-E-241" style="opacity: 1;" transform="translate(66,415)">
          <rect class="label-container" height="46" rx="0" ry="0" width="84" x="-42" y="-23">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-32,-13)">
            <foreignobject height="26" width="64">
             <div style="display: inline-block; white-space: nowrap;">
              参数更新
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-F-242" style="opacity: 1;" transform="translate(216,31)">
          <rect class="label-container" height="46" rx="0" ry="0" width="84" x="-42" y="-23">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-32,-13)">
            <foreignobject height="26" width="64">
             <div style="display: inline-block; white-space: nowrap;">
              张量并行
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-G-243" style="opacity: 1;" transform="translate(216,127)">
          <rect class="label-container" height="46" rx="0" ry="0" width="116" x="-58" y="-23">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-48,-13)">
            <foreignobject height="26" width="96">
             <div style="display: inline-block; white-space: nowrap;">
              分片模型参数
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-H-245" style="opacity: 1;" transform="translate(216,223)">
          <rect class="label-container" height="46" rx="0" ry="0" width="84" x="-42" y="-23">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-32,-13)">
            <foreignobject height="26" width="64">
             <div style="display: inline-block; white-space: nowrap;">
              局部计算
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-I-247" style="opacity: 1;" transform="translate(216,319)">
          <rect class="label-container" height="46" rx="0" ry="0" width="100" x="-50" y="-23">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-40,-13)">
            <foreignobject height="26" width="80">
             <div style="display: inline-block; white-space: nowrap;">
              跨设备通信
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-J-248" style="opacity: 1;" transform="translate(374,31)">
          <rect class="label-container" height="46" rx="0" ry="0" width="100" x="-50" y="-23">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-40,-13)">
            <foreignobject height="26" width="80">
             <div style="display: inline-block; white-space: nowrap;">
              流水线并行
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-K-249" style="opacity: 1;" transform="translate(374,127)">
          <rect class="label-container" height="46" rx="0" ry="0" width="100" x="-50" y="-23">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-40,-13)">
            <foreignobject height="26" width="80">
             <div style="display: inline-block; white-space: nowrap;">
              分阶段计算
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-L-251" style="opacity: 1;" transform="translate(374,223)">
          <rect class="label-container" height="46" rx="0" ry="0" width="132" x="-66" y="-23">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-56,-13)">
            <foreignobject height="26" width="112">
             <div style="display: inline-block; white-space: nowrap;">
              阶段间数据传输
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
        </g>
       </g>
      </g>
     </svg>
    </div>
    <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">setup_3d_parallelism</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 张量并行配置</span>
    tp_config <span class="token operator">=</span> TensorParallelConfig<span class="token punctuation">(</span>
        tensor_parallel_degree<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span>
        pipeline_parallel_degree<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span>
        data_parallel_degree<span class="token operator">=</span><span class="token number">16</span>
    <span class="token punctuation">)</span>
    
    <span class="token comment"># 流水线阶段划分</span>
    pipeline_stages <span class="token operator">=</span> split_layers_into_stages<span class="token punctuation">(</span>
        model<span class="token punctuation">,</span>
        num_stages<span class="token operator">=</span>tp_config<span class="token punctuation">.</span>pipeline_parallel_degree
    <span class="token punctuation">)</span>
    
    <span class="token comment"># 优化器分片</span>
    enable_optimizer_sharding<span class="token punctuation">(</span>
        optimizer<span class="token punctuation">,</span>
        data_parallel_group<span class="token operator">=</span>data_parallel_group
    <span class="token punctuation">)</span>
</code></pre>
    <h4>
     <a id="23__198">
     </a>
     2.3 记忆压缩技术
    </h4>
    <p>
     DeepSeek通过记忆压缩技术减少内存占用，同时保持模型性能。
    </p>
    <pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">MemoryCompression</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> in_dim<span class="token punctuation">,</span> ratio<span class="token operator">=</span><span class="token number">0.4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>encoder <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>in_dim<span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>in_dim<span class="token operator">*</span>ratio<span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>decoder <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>in_dim<span class="token operator">*</span>ratio<span class="token punctuation">)</span><span class="token punctuation">,</span> in_dim<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>ln <span class="token operator">=</span> nn<span class="token punctuation">.</span>LayerNorm<span class="token punctuation">(</span>in_dim<span class="token punctuation">)</span>
        
    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> hidden_states<span class="token punctuation">)</span><span class="token punctuation">:</span>
        compressed <span class="token operator">=</span> F<span class="token punctuation">.</span>gelu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>encoder<span class="token punctuation">(</span>hidden_states<span class="token punctuation">)</span><span class="token punctuation">)</span>
        restored <span class="token operator">=</span> self<span class="token punctuation">.</span>decoder<span class="token punctuation">(</span>compressed<span class="token punctuation">)</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>ln<span class="token punctuation">(</span>hidden_states <span class="token operator">+</span> restored<span class="token punctuation">)</span>
</code></pre>
    <hr/>
    <h3>
     <a id="_218">
     </a>
     三、全流程训练实践
    </h3>
    <h4>
     <a id="31__220">
     </a>
     3.1 数据预处理流程
    </h4>
    <p>
     DeepSeek的数据预处理流程包括文本清洗、分词、动态填充和多模态数据对齐。
    </p>
    <pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">DeepSeekDataProcessor</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> tokenizer<span class="token punctuation">,</span> max_length<span class="token operator">=</span><span class="token number">4096</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>tokenizer <span class="token operator">=</span> tokenizer
        self<span class="token punctuation">.</span>max_length <span class="token operator">=</span> max_length
        
    <span class="token keyword">def</span> <span class="token function">process</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> examples<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 多模态数据拼接</span>
        texts <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>title<span class="token punctuation">}</span></span><span class="token string"> [SEP] </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>content<span class="token punctuation">}</span></span><span class="token string">"</span></span> <span class="token keyword">for</span> title<span class="token punctuation">,</span> content <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>
            examples<span class="token punctuation">[</span><span class="token string">"title"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> examples<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        
        <span class="token comment"># 动态填充策略</span>
        batch <span class="token operator">=</span> self<span class="token punctuation">.</span>tokenizer<span class="token punctuation">(</span>
            texts<span class="token punctuation">,</span>
            max_length<span class="token operator">=</span>self<span class="token punctuation">.</span>max_length<span class="token punctuation">,</span>
            padding<span class="token operator">=</span><span class="token string">"max_length"</span><span class="token punctuation">,</span>
            truncation<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
            return_tensors<span class="token operator">=</span><span class="token string">"pt"</span>
        <span class="token punctuation">)</span>
        
        <span class="token comment"># 注意力掩码增强</span>
        batch<span class="token punctuation">[</span><span class="token string">"attention_mask"</span><span class="token punctuation">]</span> <span class="token operator">=</span> create_sparse_mask<span class="token punctuation">(</span>
            batch<span class="token punctuation">[</span><span class="token string">"input_ids"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            block_size<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span>
            num_random_blocks<span class="token operator">=</span><span class="token number">3</span>
        <span class="token punctuation">)</span>
        <span class="token keyword">return</span> batch
</code></pre>
    <h4>
     <a id="32__253">
     </a>
     3.2 完整训练循环
    </h4>
    <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">train_epoch</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> dataloader<span class="token punctuation">,</span> optimizer<span class="token punctuation">,</span> scheduler<span class="token punctuation">,</span> device<span class="token punctuation">)</span><span class="token punctuation">:</span>
    model<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>
    total_loss <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> batch_idx<span class="token punctuation">,</span> batch <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>dataloader<span class="token punctuation">)</span><span class="token punctuation">:</span>
        batch <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>k<span class="token punctuation">:</span>v<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span> <span class="token keyword">for</span> k<span class="token punctuation">,</span>v <span class="token keyword">in</span> batch<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
        
        <span class="token comment"># 梯度累积</span>
        <span class="token keyword">with</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>amp<span class="token punctuation">.</span>autocast<span class="token punctuation">(</span>dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>bfloat16<span class="token punctuation">)</span><span class="token punctuation">:</span>
            outputs <span class="token operator">=</span> model<span class="token punctuation">(</span><span class="token operator">**</span>batch<span class="token punctuation">)</span>
            loss <span class="token operator">=</span> outputs<span class="token punctuation">.</span>loss <span class="token operator">/</span> ACCUMULATION_STEPS
            
        <span class="token comment"># 反向传播</span>
        scaler<span class="token punctuation">.</span>scale<span class="token punctuation">(</span>loss<span class="token punctuation">)</span><span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span>batch_idx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> ACCUMULATION_STEPS <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token comment"># 梯度裁剪</span>
            torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>clip_grad_norm_<span class="token punctuation">(</span>
                model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
                MAX_GRAD_NORM
            <span class="token punctuation">)</span>
            
            <span class="token comment"># 参数更新</span>
            scaler<span class="token punctuation">.</span>step<span class="token punctuation">(</span>optimizer<span class="token punctuation">)</span>
            scaler<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">)</span>
            optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
            scheduler<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>
            
        total_loss <span class="token operator">+=</span> loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
    <span class="token keyword">return</span> total_loss <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>dataloader<span class="token punctuation">)</span>
</code></pre>
    <hr/>
    <h3>
     <a id="_290">
     </a>
     四、推理优化技术
    </h3>
    <h4>
     <a id="41__292">
     </a>
     4.1 动态批处理实现
    </h4>
    <pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">DynamicBatcher</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> max_batch_size<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span> max_seq_len<span class="token operator">=</span><span class="token number">4096</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span><span class="token builtin">buffer</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>max_batch_size <span class="token operator">=</span> max_batch_size
        self<span class="token punctuation">.</span>max_seq_len <span class="token operator">=</span> max_seq_len
        
    <span class="token keyword">def</span> <span class="token function">add_request</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span><span class="token builtin">buffer</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>request<span class="token punctuation">)</span>
        
    <span class="token keyword">def</span> <span class="token function">generate_batch</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        sorted_requests <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>
            self<span class="token punctuation">.</span><span class="token builtin">buffer</span><span class="token punctuation">,</span>
            key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token builtin">len</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>input_ids<span class="token punctuation">)</span><span class="token punctuation">,</span>
            reverse<span class="token operator">=</span><span class="token boolean">True</span>
        <span class="token punctuation">)</span>
        
        batches <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        current_batch <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        current_max_len <span class="token operator">=</span> <span class="token number">0</span>
        
        <span class="token keyword">for</span> req <span class="token keyword">in</span> sorted_requests<span class="token punctuation">:</span>
            seq_len <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>input_ids<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>current_batch<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> self<span class="token punctuation">.</span>max_batch_size <span class="token keyword">or</span> \
               current_max_len <span class="token operator">+</span> seq_len <span class="token operator">&gt;</span> self<span class="token punctuation">.</span>max_seq_len<span class="token punctuation">:</span>
                batches<span class="token punctuation">.</span>append<span class="token punctuation">(</span>current_batch<span class="token punctuation">)</span>
                current_batch <span class="token operator">=</span> <span class="token punctuation">[</span>req<span class="token punctuation">]</span>
                current_max_len <span class="token operator">=</span> seq_len
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                current_batch<span class="token punctuation">.</span>append<span class="token punctuation">(</span>req<span class="token punctuation">)</span>
                current_max_len <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>current_max_len<span class="token punctuation">,</span> seq_len<span class="token punctuation">)</span>
                
        <span class="token keyword">return</span> batches
</code></pre>
    <h4>
     <a id="42__329">
     </a>
     4.2 量化部署方案
    </h4>
    <pre><code class="prism language-python"><span class="token comment"># 后训练量化</span>
<span class="token keyword">from</span> neural_compressor <span class="token keyword">import</span> quantization
quant_config <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"approach"</span><span class="token punctuation">:</span> <span class="token string">"post_training_static_quant"</span><span class="token punctuation">,</span>
    <span class="token string">"op_type_dict"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"Linear"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"weight"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">"dtype"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"int8"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token string">"scheme"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"sym"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token string">"granularity"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"per_channel"</span><span class="token punctuation">]</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">"activation"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">"dtype"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"uint8"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token string">"scheme"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"asym"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token string">"granularity"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"per_tensor"</span><span class="token punctuation">]</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

quantized_model <span class="token operator">=</span> quantization<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>
    model<span class="token punctuation">,</span>
    quant_config<span class="token punctuation">,</span>
    calib_dataloader<span class="token operator">=</span>calib_loader
<span class="token punctuation">)</span>

<span class="token comment"># 保存量化模型</span>
quantized_model<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token string">"deepseek-7b-int8"</span><span class="token punctuation">)</span>
</code></pre>
    <hr/>
    <h3>
     <a id="_364">
     </a>
     五、性能评估与分析
    </h3>
    <h4>
     <a id="51__366">
     </a>
     5.1 基准测试对比
    </h4>
    <table>
     <thead>
      <tr>
       <th>
        指标
       </th>
       <th>
        DeepSeek-7B
       </th>
       <th>
        LLaMA2-7B
       </th>
       <th>
        GPT-3.5
       </th>
       <th>
        优化幅度
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        MMLU
       </td>
       <td>
        68.9
       </td>
       <td>
        63.5
       </td>
       <td>
        70.1
       </td>
       <td>
        +8.5% vs LLaMA2
       </td>
      </tr>
      <tr>
       <td>
        GSM8K
       </td>
       <td>
        78.3
       </td>
       <td>
        56.2
       </td>
       <td>
        79.5
       </td>
       <td>
        +39.3% vs LLaMA2
       </td>
      </tr>
      <tr>
       <td>
        HumanEval
       </td>
       <td>
        45.7
       </td>
       <td>
        31.2
       </td>
       <td>
        48.1
       </td>
       <td>
        +46.5% vs LLaMA2
       </td>
      </tr>
      <tr>
       <td>
        推理延迟
       </td>
       <td>
        38ms/tok
       </td>
       <td>
        45ms/tok
       </td>
       <td>
        25ms/tok
       </td>
       <td>
        -15.5% vs LLaMA2
       </td>
      </tr>
     </tbody>
    </table>
    <hr/>
    <h3>
     <a id="_377">
     </a>
     六、未来演进方向
    </h3>
    <ol>
     <li>
      <strong>
       多模态扩展架构
      </strong>
      ：支持文本、图像、音频等多模态输入。
     </li>
     <li>
      <strong>
       持续学习机制
      </strong>
      ：通过弹性权重固化（Elastic Weight Consolidation, EWC）实现持续学习。
     </li>
     <li>
      <strong>
       安全对齐技术
      </strong>
      ：增强模型的安全性和可控性。
     </li>
    </ol>
    <hr/>
    <p>
     *******************************************
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/bd53d2b049c34398930b044a4a2c7db0.gif"/>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
  <div class="blog-extension-box" id="blogExtensionBox" style="width:400px;margin:auto;margin-top:12px">
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f33343431393331322f:61727469636c652f64657461696c732f313436303735363938" class_="artid" style="display:none">
 </p>
</div>


