---
layout: post
title: "Android-Activity的启动器ActivityStarter入口"
date: 2025-03-09 23:57:48 +0800
description: "这里是启动Activity的实现。首先是需要执行一系列检查，主要是权限和拦截的处理。接着处理主要分可以重用的Task，还是新建Task。对于可以重用的Task，还是要区分里面是否已经存在Activity实例（SingleTask、SingleInstance、SingleTop模式的Activity）进行处理。最后会将满足条件的Activty启动起来。"
keywords: "Android Activity的启动器ActivityStarter入口"
categories: ['未分类']
tags: ['Android']
artid: "143101112"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=143101112
    alt: "Android-Activity的启动器ActivityStarter入口"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=143101112
featuredImagePreview: https://bing.ee123.net/img/rand?artid=143101112
cover: https://bing.ee123.net/img/rand?artid=143101112
image: https://bing.ee123.net/img/rand?artid=143101112
img: https://bing.ee123.net/img/rand?artid=143101112
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Android Activity的启动器ActivityStarter入口
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="Activity_0">
     </a>
     Activity启动器入口
    </h2>
    <p>
     Android的Activity的启动入口是在ActivityStarter类的execute()，在该方法里面继续调用executeRequest(Request request) ，相应的参数都设置在方法参数request中。代码挺长，分段现在看下它的实现，分段一：
    </p>
    <pre><code class="prism language-java">    <span class="token comment">/**
     * Executing activity start request and starts the journey of starting an activity. Here
     * begins with performing several preliminary checks. The normally activity launch flow will
     * go through {@link #startActivityUnchecked} to {@link #startActivityInner}.
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">executeRequest</span><span class="token punctuation">(</span><span class="token class-name">Request</span> request<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">TextUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>reason<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Need to specify a reason."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mLastStartReason <span class="token operator">=</span> request<span class="token punctuation">.</span>reason<span class="token punctuation">;</span>
        mLastStartActivityTimeMs <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mLastStartActivityRecord <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token class-name">IApplicationThread</span> caller <span class="token operator">=</span> request<span class="token punctuation">.</span>caller<span class="token punctuation">;</span>
        <span class="token class-name">Intent</span> intent <span class="token operator">=</span> request<span class="token punctuation">.</span>intent<span class="token punctuation">;</span>
        <span class="token class-name">NeededUriGrants</span> intentGrants <span class="token operator">=</span> request<span class="token punctuation">.</span>intentGrants<span class="token punctuation">;</span>
        <span class="token class-name">String</span> resolvedType <span class="token operator">=</span> request<span class="token punctuation">.</span>resolvedType<span class="token punctuation">;</span>
        <span class="token class-name">ActivityInfo</span> aInfo <span class="token operator">=</span> request<span class="token punctuation">.</span>activityInfo<span class="token punctuation">;</span>
        <span class="token class-name">ResolveInfo</span> rInfo <span class="token operator">=</span> request<span class="token punctuation">.</span>resolveInfo<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">IVoiceInteractionSession</span> voiceSession <span class="token operator">=</span> request<span class="token punctuation">.</span>voiceSession<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">IBinder</span> resultTo <span class="token operator">=</span> request<span class="token punctuation">.</span>resultTo<span class="token punctuation">;</span>
        <span class="token class-name">String</span> resultWho <span class="token operator">=</span> request<span class="token punctuation">.</span>resultWho<span class="token punctuation">;</span>
        <span class="token keyword">int</span> requestCode <span class="token operator">=</span> request<span class="token punctuation">.</span>requestCode<span class="token punctuation">;</span>
        <span class="token keyword">int</span> callingPid <span class="token operator">=</span> request<span class="token punctuation">.</span>callingPid<span class="token punctuation">;</span>
        <span class="token keyword">int</span> callingUid <span class="token operator">=</span> request<span class="token punctuation">.</span>callingUid<span class="token punctuation">;</span>
        <span class="token class-name">String</span> callingPackage <span class="token operator">=</span> request<span class="token punctuation">.</span>callingPackage<span class="token punctuation">;</span>
        <span class="token class-name">String</span> callingFeatureId <span class="token operator">=</span> request<span class="token punctuation">.</span>callingFeatureId<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> realCallingPid <span class="token operator">=</span> request<span class="token punctuation">.</span>realCallingPid<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> realCallingUid <span class="token operator">=</span> request<span class="token punctuation">.</span>realCallingUid<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> startFlags <span class="token operator">=</span> request<span class="token punctuation">.</span>startFlags<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">SafeActivityOptions</span> options <span class="token operator">=</span> request<span class="token punctuation">.</span>activityOptions<span class="token punctuation">;</span>
        <span class="token class-name">Task</span> inTask <span class="token operator">=</span> request<span class="token punctuation">.</span>inTask<span class="token punctuation">;</span>

        <span class="token keyword">int</span> err <span class="token operator">=</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span><span class="token constant">START_SUCCESS</span><span class="token punctuation">;</span>
        <span class="token comment">// Pull the optional Ephemeral Installer-only bundle out of the options early.</span>
        <span class="token keyword">final</span> <span class="token class-name">Bundle</span> verificationBundle <span class="token operator">=</span>
                options <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> options<span class="token punctuation">.</span><span class="token function">popAppVerificationBundle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token class-name">WindowProcessController</span> callerApp <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>caller <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            callerApp <span class="token operator">=</span> mService<span class="token punctuation">.</span><span class="token function">getProcessController</span><span class="token punctuation">(</span>caller<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>callerApp <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                callingPid <span class="token operator">=</span> callerApp<span class="token punctuation">.</span><span class="token function">getPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                callingUid <span class="token operator">=</span> callerApp<span class="token punctuation">.</span>mInfo<span class="token punctuation">.</span>uid<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"Unable to find app for caller "</span> <span class="token operator">+</span> caller <span class="token operator">+</span> <span class="token string">" (pid="</span> <span class="token operator">+</span> callingPid
                        <span class="token operator">+</span> <span class="token string">") when starting: "</span> <span class="token operator">+</span> intent<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                err <span class="token operator">=</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span><span class="token constant">START_PERMISSION_DENIED</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> <span class="token keyword">int</span> userId <span class="token operator">=</span> aInfo <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> aInfo<span class="token punctuation">.</span>applicationInfo <span class="token operator">!=</span> <span class="token keyword">null</span>
                <span class="token operator">?</span> <span class="token class-name">UserHandle</span><span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span>aInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">==</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span><span class="token constant">START_SUCCESS</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"START u"</span> <span class="token operator">+</span> userId <span class="token operator">+</span> <span class="token string">" {"</span> <span class="token operator">+</span> intent<span class="token punctuation">.</span><span class="token function">toShortString</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
                    <span class="token operator">+</span> <span class="token string">"} from uid "</span> <span class="token operator">+</span> callingUid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">ActivityRecord</span> sourceRecord <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">ActivityRecord</span> resultRecord <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>resultTo <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            sourceRecord <span class="token operator">=</span> mRootWindowContainer<span class="token punctuation">.</span><span class="token function">isInAnyTask</span><span class="token punctuation">(</span>resultTo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_RESULTS</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG_RESULTS</span><span class="token punctuation">,</span> <span class="token string">"Will send result to "</span> <span class="token operator">+</span> resultTo <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> sourceRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sourceRecord <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>requestCode <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>sourceRecord<span class="token punctuation">.</span>finishing<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    resultRecord <span class="token operator">=</span> sourceRecord<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> <span class="token keyword">int</span> launchFlags <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>launchFlags <span class="token operator">&amp;</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">FLAG_ACTIVITY_FORWARD_RESULT</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> sourceRecord <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// Transfer the result target from the source activity to the new one being started,</span>
            <span class="token comment">// including any failures.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>requestCode <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">SafeActivityOptions</span><span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span><span class="token constant">START_FORWARD_AND_REQUEST_CONFLICT</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            resultRecord <span class="token operator">=</span> sourceRecord<span class="token punctuation">.</span>resultTo<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>resultRecord <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>resultRecord<span class="token punctuation">.</span><span class="token function">isInRootTaskLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                resultRecord <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            resultWho <span class="token operator">=</span> sourceRecord<span class="token punctuation">.</span>resultWho<span class="token punctuation">;</span>
            requestCode <span class="token operator">=</span> sourceRecord<span class="token punctuation">.</span>requestCode<span class="token punctuation">;</span>
            sourceRecord<span class="token punctuation">.</span>resultTo <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>resultRecord <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                resultRecord<span class="token punctuation">.</span><span class="token function">removeResultsLocked</span><span class="token punctuation">(</span>sourceRecord<span class="token punctuation">,</span> resultWho<span class="token punctuation">,</span> requestCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sourceRecord<span class="token punctuation">.</span>launchedFromUid <span class="token operator">==</span> callingUid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// The new activity is being launched from the same uid as the previous activity</span>
                <span class="token comment">// in the flow, and asking to forward its result back to the previous.  In this</span>
                <span class="token comment">// case the activity is serving as a trampoline between the two, so we also want</span>
                <span class="token comment">// to update its launchedFromPackage to be the same as the previous activity.</span>
                <span class="token comment">// Note that this is safe, since we know these two packages come from the same</span>
                <span class="token comment">// uid; the caller could just as well have supplied that same package name itself</span>
                <span class="token comment">// . This specifially deals with the case of an intent picker/chooser being</span>
                <span class="token comment">// launched in the app flow to redirect to an activity picked by the user, where</span>
                <span class="token comment">// we want the final activity to consider it to have been launched by the</span>
                <span class="token comment">// previous app activity.</span>
                callingPackage <span class="token operator">=</span> sourceRecord<span class="token punctuation">.</span>launchedFromPackage<span class="token punctuation">;</span>
                callingFeatureId <span class="token operator">=</span> sourceRecord<span class="token punctuation">.</span>launchedFromFeatureId<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">==</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span><span class="token constant">START_SUCCESS</span> <span class="token operator">&amp;&amp;</span> intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// We couldn't find a class that can handle the given Intent.</span>
            <span class="token comment">// That's the end of that!</span>
            err <span class="token operator">=</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span><span class="token constant">START_INTENT_NOT_RESOLVED</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">==</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span><span class="token constant">START_SUCCESS</span> <span class="token operator">&amp;&amp;</span> aInfo <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// We couldn't find the specific class specified in the Intent.</span>
            <span class="token comment">// Also the end of the line.</span>
            err <span class="token operator">=</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span><span class="token constant">START_CLASS_NOT_FOUND</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">==</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span><span class="token constant">START_SUCCESS</span> <span class="token operator">&amp;&amp;</span> sourceRecord <span class="token operator">!=</span> <span class="token keyword">null</span>
                <span class="token operator">&amp;&amp;</span> sourceRecord<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>voiceSession <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// If this activity is being launched as part of a voice session, we need to ensure</span>
            <span class="token comment">// that it is safe to do so.  If the upcoming activity will also be part of the voice</span>
            <span class="token comment">// session, we can only launch it if it has explicitly said it supports the VOICE</span>
            <span class="token comment">// category, or it is a part of the calling app.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>launchFlags <span class="token operator">&amp;</span> <span class="token constant">FLAG_ACTIVITY_NEW_TASK</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span>
                    <span class="token operator">&amp;&amp;</span> sourceRecord<span class="token punctuation">.</span>info<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid <span class="token operator">!=</span> aInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                    intent<span class="token punctuation">.</span><span class="token function">addCategory</span><span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">CATEGORY_VOICE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mService<span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">activitySupportsIntent</span><span class="token punctuation">(</span>
                            intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> intent<span class="token punctuation">,</span> resolvedType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"Activity being started in current voice task does not support "</span>
                                <span class="token operator">+</span> <span class="token string">"voice: "</span> <span class="token operator">+</span> intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        err <span class="token operator">=</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span><span class="token constant">START_NOT_VOICE_COMPATIBLE</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"Failure checking voice capabilities"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    err <span class="token operator">=</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span><span class="token constant">START_NOT_VOICE_COMPATIBLE</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">==</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span><span class="token constant">START_SUCCESS</span> <span class="token operator">&amp;&amp;</span> voiceSession <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// If the caller is starting a new voice session, just make sure the target</span>
            <span class="token comment">// is actually allowing it to run this way.</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mService<span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">activitySupportsIntent</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        intent<span class="token punctuation">,</span> resolvedType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span>
                            <span class="token string">"Activity being started in new voice task does not support: "</span> <span class="token operator">+</span> intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    err <span class="token operator">=</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span><span class="token constant">START_NOT_VOICE_COMPATIBLE</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"Failure checking voice capabilities"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                err <span class="token operator">=</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span><span class="token constant">START_NOT_VOICE_COMPATIBLE</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> <span class="token class-name">Task</span> resultRootTask <span class="token operator">=</span> resultRecord <span class="token operator">==</span> <span class="token keyword">null</span>
                <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> resultRecord<span class="token punctuation">.</span><span class="token function">getRootTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">!=</span> <span class="token constant">START_SUCCESS</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>resultRecord <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                resultRecord<span class="token punctuation">.</span><span class="token function">sendResult</span><span class="token punctuation">(</span><span class="token constant">INVALID_UID</span><span class="token punctuation">,</span> resultWho<span class="token punctuation">,</span> requestCode<span class="token punctuation">,</span> <span class="token constant">RESULT_CANCELED</span><span class="token punctuation">,</span>
                        <span class="token keyword">null</span> <span class="token comment">/* data */</span><span class="token punctuation">,</span> <span class="token keyword">null</span> <span class="token comment">/* dataGrants */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">SafeActivityOptions</span><span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> err<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre>
    <p>
     首先从类Request中取得对应值赋值给变量。
     <br/>
     先将变量err设置为ActivityManager.START_SUCCESS。
     <br/>
     caller是应用进程Java服务代理对象。如果它被设置过，通过mService.getProcessController(caller)得到对应的WindowProcessController对象，mService是ActivityTaskManagerService对象（它里面维护着它们俩的对应关系），如果它不为null，则将局部变量callingPid、callingUid设置为它的对应的值。如果mService中没有找到caller（不为null）对应的WindowProcessController对象，则会将err设置为ActivityManager.START_PERMISSION_DENIED。
     <br/>
     下面通过应用Uid（aInfo.applicationInfo.uid）得到用户id。
     <br/>
     接下来sourceRecord和resultRecord和请求参数resultTo有关。resultTo是对应将启动Activity之后的应答发回到对应的Activity。在需要应答时，还和requestCode有关，需要将它设置为一个非负整数。所以下面通过resultTo得到sourceRecord，然后通过判断requestCode &gt;= 0 &amp;&amp; !sourceRecord.finishing之后，才给resultRecord赋值。
     <br/>
     接下来是处理标识Intent.FLAG_ACTIVITY_FORWARD_RESULT的情况。
     <br/>
     在sourceRecord不为null的情况下，如果设置了FLAG_ACTIVITY_FORWARD_RESULT标识，就不能设置requestCode，如果设置了requestCode（为非负数），就直接返回ActivityManager.START_FORWARD_AND_REQUEST_CONFLICT。
     <br/>
     设置了FLAG_ACTIVITY_FORWARD_RESULT标识，是为了将结果转移到启动了sourceRecord的那个Activity。所以将resultRecord设置为sourceRecord.resultTo。如果resultRecord不在根任务的包括层级中，会将resultRecord = null。也会将resultWho、requestCode设置成sourceRecord的对应值。并将sourceRecord.resultTo = null。如果resultRecord != null，则将resultRecord中和sourceRecord、resultWho、requestCode相关的结果删除。如果sourceRecord的启动应用和当前要启动的应用相同，会将callingPackage、callingFeatureId设置为启动sourceRecord的包名和launchedFromFeatureId。
     <br/>
     接下来判断如果intent.getComponent()为null，会将err设置为ActivityManager.START_INTENT_NOT_RESOLVED。代表没有找到对应的启动的类。
     <br/>
     如果aInfo == null，代表也是没找到对应的类，将err设置为ActivityManager.START_CLASS_NOT_FOUND。
     <br/>
     如果现在还没出错（err为ActivityManager.START_SUCCESS ），并且sourceRecord在一个语音交互任务（sourceRecord.getTask().voiceSession != null）中，需要检查新启动的Activity是否能支持。没有FLAG_ACTIVITY_NEW_TASK标识，并且和sourceRecord不在同一个应用进程中，在该种条件先需要去检测。先给intent添加Intent.CATEGORY_VOICE的Category。下面是通过mService.getPackageManager().activitySupportsIntent()来检查的，最终是进入到PackageManagerService中去做检测的，这里主要检查的意思就是，启动的Activity是需要配置Intent.CATEGORY_VOICE的。如果检测没有通过，会将err = ActivityManager.START_NOT_VOICE_COMPATIBLE。
     <br/>
     如果目前需要启动一个语音交互任务，这里也是调用mService.getPackageManager().activitySupportsIntent()来检查的，不过它没有加Intent.CATEGORY_VOICE。这里也就是检查，它能运行。如果没通过检查，同样将err = ActivityManager.START_NOT_VOICE_COMPATIBLE。
     <br/>
     如果resultRecord不为null，会将它的根任务赋值给局部变量resultRootTask。
     <br/>
     如果现在err != START_SUCCESS，则代表出错了，不需要往下执行了。如果此时resultRecord不为null，则调用它的sendResult方法，该方法主要做：如果状态为RESUMED，并且在应用进程中运行，则直接通知它。如果不是会将结果存在resultRecord中（它是ActivityRecord类，存在它的成员results中）。再处理一下options，之后就将错误代码返回。
     <br/>
     继续往下看下分段二：
     <br/>
    </p>
    <pre><code class="prism language-java">        <span class="token keyword">boolean</span> abort <span class="token operator">=</span> <span class="token operator">!</span>mSupervisor<span class="token punctuation">.</span><span class="token function">checkStartAnyActivityPermission</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> aInfo<span class="token punctuation">,</span> resultWho<span class="token punctuation">,</span>
                requestCode<span class="token punctuation">,</span> callingPid<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span> callingPackage<span class="token punctuation">,</span> callingFeatureId<span class="token punctuation">,</span>
                request<span class="token punctuation">.</span>ignoreTargetSecurity<span class="token punctuation">,</span> inTask <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> callerApp<span class="token punctuation">,</span> resultRecord<span class="token punctuation">,</span>
                resultRootTask<span class="token punctuation">)</span><span class="token punctuation">;</span>
        abort <span class="token operator">|=</span> <span class="token operator">!</span>mService<span class="token punctuation">.</span>mIntentFirewall<span class="token punctuation">.</span><span class="token function">checkStartActivity</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span>
                callingPid<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span> aInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        abort <span class="token operator">|=</span> <span class="token operator">!</span>mService<span class="token punctuation">.</span><span class="token function">getPermissionPolicyInternal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">checkStartActivity</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span>
                callingPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">boolean</span> restrictedBgActivity <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>abort<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_WINDOW_MANAGER</span><span class="token punctuation">,</span>
                        <span class="token string">"shouldAbortBackgroundActivityStart"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                restrictedBgActivity <span class="token operator">=</span> <span class="token function">shouldAbortBackgroundActivityStart</span><span class="token punctuation">(</span>callingUid<span class="token punctuation">,</span>
                        callingPid<span class="token punctuation">,</span> callingPackage<span class="token punctuation">,</span> realCallingUid<span class="token punctuation">,</span> realCallingPid<span class="token punctuation">,</span> callerApp<span class="token punctuation">,</span>
                        request<span class="token punctuation">.</span>originatingPendingIntent<span class="token punctuation">,</span> request<span class="token punctuation">.</span>allowBackgroundActivityStart<span class="token punctuation">,</span>
                        intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_WINDOW_MANAGER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Merge the two options bundles, while realCallerOptions takes precedence.</span>
        <span class="token class-name">ActivityOptions</span> checkedOptions <span class="token operator">=</span> options <span class="token operator">!=</span> <span class="token keyword">null</span>
                <span class="token operator">?</span> options<span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> aInfo<span class="token punctuation">,</span> callerApp<span class="token punctuation">,</span> mSupervisor<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>allowPendingRemoteAnimationRegistryLookup<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            checkedOptions <span class="token operator">=</span> mService<span class="token punctuation">.</span><span class="token function">getActivityStartController</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">getPendingRemoteAnimationRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">overrideOptionsIfNeeded</span><span class="token punctuation">(</span>callingPackage<span class="token punctuation">,</span> checkedOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mController <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// The Intent we give to the watcher has the extra data stripped off, since it</span>
                <span class="token comment">// can contain private information.</span>
                <span class="token class-name">Intent</span> watchIntent <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">cloneFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                abort <span class="token operator">|=</span> <span class="token operator">!</span>mService<span class="token punctuation">.</span>mController<span class="token punctuation">.</span><span class="token function">activityStarting</span><span class="token punctuation">(</span>watchIntent<span class="token punctuation">,</span>
                        aInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                mService<span class="token punctuation">.</span>mController <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        mInterceptor<span class="token punctuation">.</span><span class="token function">setStates</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> realCallingPid<span class="token punctuation">,</span> realCallingUid<span class="token punctuation">,</span> startFlags<span class="token punctuation">,</span> callingPackage<span class="token punctuation">,</span>
                callingFeatureId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mInterceptor<span class="token punctuation">.</span><span class="token function">intercept</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> rInfo<span class="token punctuation">,</span> aInfo<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span> inTask<span class="token punctuation">,</span> callingPid<span class="token punctuation">,</span>
                callingUid<span class="token punctuation">,</span> checkedOptions<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// activity start was intercepted, e.g. because the target user is currently in quiet</span>
            <span class="token comment">// mode (turn off work) or the target application is suspended</span>
            intent <span class="token operator">=</span> mInterceptor<span class="token punctuation">.</span>mIntent<span class="token punctuation">;</span>
            rInfo <span class="token operator">=</span> mInterceptor<span class="token punctuation">.</span>mRInfo<span class="token punctuation">;</span>
            aInfo <span class="token operator">=</span> mInterceptor<span class="token punctuation">.</span>mAInfo<span class="token punctuation">;</span>
            resolvedType <span class="token operator">=</span> mInterceptor<span class="token punctuation">.</span>mResolvedType<span class="token punctuation">;</span>
            inTask <span class="token operator">=</span> mInterceptor<span class="token punctuation">.</span>mInTask<span class="token punctuation">;</span>
            callingPid <span class="token operator">=</span> mInterceptor<span class="token punctuation">.</span>mCallingPid<span class="token punctuation">;</span>
            callingUid <span class="token operator">=</span> mInterceptor<span class="token punctuation">.</span>mCallingUid<span class="token punctuation">;</span>
            checkedOptions <span class="token operator">=</span> mInterceptor<span class="token punctuation">.</span>mActivityOptions<span class="token punctuation">;</span>

            <span class="token comment">// The interception target shouldn't get any permission grants</span>
            <span class="token comment">// intended for the original destination</span>
            intentGrants <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>abort<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>resultRecord <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                resultRecord<span class="token punctuation">.</span><span class="token function">sendResult</span><span class="token punctuation">(</span><span class="token constant">INVALID_UID</span><span class="token punctuation">,</span> resultWho<span class="token punctuation">,</span> requestCode<span class="token punctuation">,</span> <span class="token constant">RESULT_CANCELED</span><span class="token punctuation">,</span>
                        <span class="token keyword">null</span> <span class="token comment">/* data */</span><span class="token punctuation">,</span> <span class="token keyword">null</span> <span class="token comment">/* dataGrants */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// We pretend to the caller that it was really started, but they will just get a</span>
            <span class="token comment">// cancel result.</span>
            <span class="token class-name">ActivityOptions</span><span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span>checkedOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token constant">START_ABORTED</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// If permissions need a review before any of the app components can run, we</span>
        <span class="token comment">// launch the review activity and pass a pending intent to start the activity</span>
        <span class="token comment">// we are to launching now after the review is completed.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>aInfo <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mService<span class="token punctuation">.</span><span class="token function">getPackageManagerInternalLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isPermissionsReviewRequired</span><span class="token punctuation">(</span>
                    aInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">final</span> <span class="token class-name">IIntentSender</span> target <span class="token operator">=</span> mService<span class="token punctuation">.</span><span class="token function">getIntentSenderLocked</span><span class="token punctuation">(</span>
                        <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span><span class="token constant">INTENT_SENDER_ACTIVITY</span><span class="token punctuation">,</span> callingPackage<span class="token punctuation">,</span> callingFeatureId<span class="token punctuation">,</span>
                        callingUid<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span>intent<span class="token punctuation">}</span><span class="token punctuation">,</span>
                        <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span>resolvedType<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">PendingIntent</span><span class="token punctuation">.</span><span class="token constant">FLAG_CANCEL_CURRENT</span>
                                <span class="token operator">|</span> <span class="token class-name">PendingIntent</span><span class="token punctuation">.</span><span class="token constant">FLAG_ONE_SHOT</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token class-name">Intent</span> newIntent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">ACTION_REVIEW_PERMISSIONS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">int</span> flags <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                flags <span class="token operator">|=</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">FLAG_ACTIVITY_EXCLUDE_FROM_RECENTS</span><span class="token punctuation">;</span>

                <span class="token comment">/*
                 * Prevent reuse of review activity: Each app needs their own review activity. By
                 * default activities launched with NEW_TASK or NEW_DOCUMENT try to reuse activities
                 * with the same launch parameters (extras are ignored). Hence to avoid possible
                 * reuse force a new activity via the MULTIPLE_TASK flag.
                 *
                 * Activities that are not launched with NEW_TASK or NEW_DOCUMENT are not re-used,
                 * hence no need to add the flag in this case.
                 */</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token constant">FLAG_ACTIVITY_NEW_TASK</span> <span class="token operator">|</span> <span class="token constant">FLAG_ACTIVITY_NEW_DOCUMENT</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    flags <span class="token operator">|=</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">FLAG_ACTIVITY_MULTIPLE_TASK</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                newIntent<span class="token punctuation">.</span><span class="token function">setFlags</span><span class="token punctuation">(</span>flags<span class="token punctuation">)</span><span class="token punctuation">;</span>

                newIntent<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">EXTRA_PACKAGE_NAME</span><span class="token punctuation">,</span> aInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                newIntent<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">EXTRA_INTENT</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">IntentSender</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>resultRecord <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    newIntent<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">EXTRA_RESULT_NEEDED</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                intent <span class="token operator">=</span> newIntent<span class="token punctuation">;</span>

                <span class="token comment">// The permissions review target shouldn't get any permission</span>
                <span class="token comment">// grants intended for the original destination</span>
                intentGrants <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

                resolvedType <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                callingUid <span class="token operator">=</span> realCallingUid<span class="token punctuation">;</span>
                callingPid <span class="token operator">=</span> realCallingPid<span class="token punctuation">;</span>

                rInfo <span class="token operator">=</span> mSupervisor<span class="token punctuation">.</span><span class="token function">resolveIntent</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
                        <span class="token function">computeResolveFilterUid</span><span class="token punctuation">(</span>
                                callingUid<span class="token punctuation">,</span> realCallingUid<span class="token punctuation">,</span> request<span class="token punctuation">.</span>filterCallingUid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                aInfo <span class="token operator">=</span> mSupervisor<span class="token punctuation">.</span><span class="token function">resolveActivity</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> rInfo<span class="token punctuation">,</span> startFlags<span class="token punctuation">,</span>
                        <span class="token keyword">null</span> <span class="token comment">/*profilerInfo*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_PERMISSIONS_REVIEW</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">final</span> <span class="token class-name">Task</span> focusedRootTask <span class="token operator">=</span>
                            mRootWindowContainer<span class="token punctuation">.</span><span class="token function">getTopDisplayFocusedRootTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"START u"</span> <span class="token operator">+</span> userId <span class="token operator">+</span> <span class="token string">" {"</span> <span class="token operator">+</span> intent<span class="token punctuation">.</span><span class="token function">toShortString</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                            <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"} from uid "</span> <span class="token operator">+</span> callingUid <span class="token operator">+</span> <span class="token string">" on display "</span>
                            <span class="token operator">+</span> <span class="token punctuation">(</span>focusedRootTask <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token constant">DEFAULT_DISPLAY</span>
                                    <span class="token operator">:</span> focusedRootTask<span class="token punctuation">.</span><span class="token function">getDisplayId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre>
    <p>
     mSupervisor是ActivityTaskSupervisor对象，它的checkStartAnyActivityPermission方法主要是检查应用进程是否有START_ANY_ACTIVITY权限，如果取得，则返回true。如果没有获取到START_ANY_ACTIVITY权限，还会去检查待启动的Activity所需要的权限（如果存在）是否被应用拒绝、Action对应的权限是否被应用拒绝、如果被限制，则返回false。如果没有限制，也返回true。
     <br/>
     mService.mIntentFirewall是IntentFirewall对象，看名字是Intent防火墙的意思。它的checkStartActivity方法是检查它的一些规则，如果不满足，这里会进行拦截，将abort设置为true。
     <br/>
     mService.getPermissionPolicyInternal()是PermissionPolicyService类中的Internal对象。它主要检测Action为TelecomManager.ACTION_CHANGE_DEFAULT_DIALER和Telephony.Sms.Intents.ACTION_CHANGE_DEFAULT时，如果调用应用的目标SDK大于等于Q时，是拦截，不允许启动的。
     <br/>
     在现在没有出现问题的情况下（abort为false），会调用shouldAbortBackgroundActivityStart方法来检查是否允许背景应用来启动Activity。并且将返回结果存储在变量restrictedBgActivity中。
     <br/>
     接下来就是处理参数选项类options的getOptions()方法，它会检查其中的一些权限，并且它会合并它里面的选项，转为ActivityOptions类对象checkedOptions。
     <br/>
     mService.mController在这里是一个观察者。这里是调用它的activityStarting方法通知它。
     <br/>
     mInterceptor是ActivityStartInterceptor对象，它是一个启动拦截器。它在符合特定条件下，会进行拦截，改变对应的Intent和其他对应值，下面再跳转就是到拦截的界面了。mInterceptor.intercept()在符合拦截的情况下，是返回true的。在这个方法里面，会将mInterceptor对象的相应进行更改，下面就用它里面的对应值设置局部变量intent等。如果用户是在Quiet模式、应用被暂停、锁任务模式下应用不允许启动、启动的应用有有害警告时都会进行拦截。
     <br/>
     接下来，如果abort为true，代表出现问题，需要终止，如果resultRecord不为null，将相应结果（RESULT_CANCELED，取消的结果）设置到里面，返回结果START_ABORTED。
     <br/>
     接下来处理的是如果启动的Activity有review权限，则会启动这个review Activity。它会在review 完成之后，再启动目标Activity。这个权限是目标SDK在Build.VERSION_CODES.M之前才适用，新的权限模式不支持。最后这段代码，就是处理我说的这些。将目标Activity的启动Intent封装成IIntentSender对象，传递给review Activity。之后就是解析出来它的ResolveInfo对象、ActivityInfo对象。
     <br/>
     继续往下看下分段三：
    </p>
    <pre><code class="prism language-java">        <span class="token comment">// If we have an ephemeral app, abort the process of launching the resolved intent.</span>
        <span class="token comment">// Instead, launch the ephemeral installer. Once the installer is finished, it</span>
        <span class="token comment">// starts either the intent we resolved here [on install error] or the ephemeral</span>
        <span class="token comment">// app [on install success].</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rInfo <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> rInfo<span class="token punctuation">.</span>auxiliaryInfo <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            intent <span class="token operator">=</span> <span class="token function">createLaunchIntent</span><span class="token punctuation">(</span>rInfo<span class="token punctuation">.</span>auxiliaryInfo<span class="token punctuation">,</span> request<span class="token punctuation">.</span>ephemeralIntent<span class="token punctuation">,</span>
                    callingPackage<span class="token punctuation">,</span> callingFeatureId<span class="token punctuation">,</span> verificationBundle<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            resolvedType <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            callingUid <span class="token operator">=</span> realCallingUid<span class="token punctuation">;</span>
            callingPid <span class="token operator">=</span> realCallingPid<span class="token punctuation">;</span>

            <span class="token comment">// The ephemeral installer shouldn't get any permission grants</span>
            <span class="token comment">// intended for the original destination</span>
            intentGrants <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

            aInfo <span class="token operator">=</span> mSupervisor<span class="token punctuation">.</span><span class="token function">resolveActivity</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> rInfo<span class="token punctuation">,</span> startFlags<span class="token punctuation">,</span> <span class="token keyword">null</span> <span class="token comment">/*profilerInfo*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// TODO (b/187680964) Correcting the caller/pid/uid when start activity from shortcut</span>
        <span class="token comment">// Pending intent launched from systemui also depends on caller app</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>callerApp <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> realCallingPid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">final</span> <span class="token class-name">WindowProcessController</span> wpc <span class="token operator">=</span> mService<span class="token punctuation">.</span>mProcessMap<span class="token punctuation">.</span><span class="token function">getProcess</span><span class="token punctuation">(</span>realCallingPid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>wpc <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                callerApp <span class="token operator">=</span> wpc<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">final</span> <span class="token class-name">ActivityRecord</span> r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActivityRecord<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span>mService<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setCaller</span><span class="token punctuation">(</span>callerApp<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setLaunchedFromPid</span><span class="token punctuation">(</span>callingPid<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setLaunchedFromUid</span><span class="token punctuation">(</span>callingUid<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setLaunchedFromPackage</span><span class="token punctuation">(</span>callingPackage<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setLaunchedFromFeature</span><span class="token punctuation">(</span>callingFeatureId<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setIntent</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setResolvedType</span><span class="token punctuation">(</span>resolvedType<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setActivityInfo</span><span class="token punctuation">(</span>aInfo<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setConfiguration</span><span class="token punctuation">(</span>mService<span class="token punctuation">.</span><span class="token function">getGlobalConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setResultTo</span><span class="token punctuation">(</span>resultRecord<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setResultWho</span><span class="token punctuation">(</span>resultWho<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setRequestCode</span><span class="token punctuation">(</span>requestCode<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setComponentSpecified</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>componentSpecified<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setRootVoiceInteraction</span><span class="token punctuation">(</span>voiceSession <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setActivityOptions</span><span class="token punctuation">(</span>checkedOptions<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setSourceRecord</span><span class="token punctuation">(</span>sourceRecord<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        mLastStartActivityRecord <span class="token operator">=</span> r<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>appTimeTracker <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> sourceRecord <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// If the caller didn't specify an explicit time tracker, we want to continue</span>
            <span class="token comment">// tracking under any it has.</span>
            r<span class="token punctuation">.</span>appTimeTracker <span class="token operator">=</span> sourceRecord<span class="token punctuation">.</span>appTimeTracker<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Only allow app switching to be resumed if activity is not a restricted background</span>
        <span class="token comment">// activity and target app is not home process, otherwise any background activity</span>
        <span class="token comment">// started in background task can stop home button protection mode.</span>
        <span class="token comment">// As the targeted app is not a home process and we don't need to wait for the 2nd</span>
        <span class="token comment">// activity to be started to resume app switching, we can just enable app switching</span>
        <span class="token comment">// directly.</span>
        <span class="token class-name">WindowProcessController</span> homeProcess <span class="token operator">=</span> mService<span class="token punctuation">.</span>mHomeProcess<span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> isHomeProcess <span class="token operator">=</span> homeProcess <span class="token operator">!=</span> <span class="token keyword">null</span>
                <span class="token operator">&amp;&amp;</span> aInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid <span class="token operator">==</span> homeProcess<span class="token punctuation">.</span>mUid<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>restrictedBgActivity <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isHomeProcess<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            mService<span class="token punctuation">.</span><span class="token function">resumeAppSwitches</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        mLastStartActivityResult <span class="token operator">=</span> <span class="token function">startActivityUnchecked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> sourceRecord<span class="token punctuation">,</span> voiceSession<span class="token punctuation">,</span>
                request<span class="token punctuation">.</span>voiceInteractor<span class="token punctuation">,</span> startFlags<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/* doResume */</span><span class="token punctuation">,</span> checkedOptions<span class="token punctuation">,</span> inTask<span class="token punctuation">,</span>
                restrictedBgActivity<span class="token punctuation">,</span> intentGrants<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>outActivity <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            request<span class="token punctuation">.</span>outActivity<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> mLastStartActivityRecord<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> mLastStartActivityResult<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
    <p>
     rInfo.auxiliaryInfo是和安装Instant应用有关，如果启动的是Instant应用，则会启动Instant安装者。
     <br/>
     接着下面处理的是从快捷方式启动Activity的情况，这种情况下，callerApp == null，realCallingPid &gt; 0，所以取出realCallingPid对应的应用，赋值给callerApp 。
     <br/>
     接下来就是构建ActivityRecord对象，它是应用端Activity在系统框架层中对应的对象。它的创建是采用了建造者模式。里面用到的变量，前面大多都涉及到了，这里不详细说了。
     <br/>
     创建完之后，将创建的对象赋值给mLastStartActivityRecord。
     <br/>
     r.appTimeTracker是用来跟踪用户使用应用时间，如果没有设置它，则将它设置为sourceRecord对象（它不为null的情况下）的appTimeTracker。
     <br/>
     如果不是背景应用启动Activity并且启动的Activity不是Launcher进程，可以直接使APP切换开关打开。看着注释的解释是，背景应用如果是APP切换开关打开，会停止Home按键的保护模式。启动的Activity如果在Launcher进程中，需要等待Activity启动之后，才能打开APP切换开关。
     <br/>
     再接下来就是调用startActivityUnchecked方法来启动Activity了。并将结果存储在mLastStartActivityResult中。
     <br/>
     request.outActivity不为null，会将它设置为启动的ActivityRecord对象mLastStartActivityRecord。
     <br/>
     最后将结果返回。
     <br/>
     可见该方法主要就是做了一些检查，主要是一些权限和拦截的处理。
     <br/>
     executeRequest(Request request)的代码说完了，Activity启动的代码是在方法startActivityUnchecked方法中，所以，我们继续看它的实现。
    </p>
    <h3>
     <a id="startActivityUnchecked_426">
     </a>
     检查之后的startActivityUnchecked方法
    </h3>
    <p>
     看一下startActivityUnchecked方法的实现：
    </p>
    <pre><code class="prism language-java">    <span class="token comment">/**
     * Start an activity while most of preliminary checks has been done and caller has been
     * confirmed that holds necessary permissions to do so.
     * Here also ensures that the starting activity is removed if the start wasn't successful.
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">startActivityUnchecked</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ActivityRecord</span> r<span class="token punctuation">,</span> <span class="token class-name">ActivityRecord</span> sourceRecord<span class="token punctuation">,</span>
                <span class="token class-name">IVoiceInteractionSession</span> voiceSession<span class="token punctuation">,</span> <span class="token class-name">IVoiceInteractor</span> voiceInteractor<span class="token punctuation">,</span>
                <span class="token keyword">int</span> startFlags<span class="token punctuation">,</span> <span class="token keyword">boolean</span> doResume<span class="token punctuation">,</span> <span class="token class-name">ActivityOptions</span> options<span class="token punctuation">,</span> <span class="token class-name">Task</span> inTask<span class="token punctuation">,</span>
                <span class="token keyword">boolean</span> restrictedBgActivity<span class="token punctuation">,</span> <span class="token class-name">NeededUriGrants</span> intentGrants<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token constant">START_CANCELED</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">Task</span> startedActivityRootTask<span class="token punctuation">;</span>

        <span class="token comment">// Create a transition now to record the original intent of actions taken within</span>
        <span class="token comment">// startActivityInner. Otherwise, logic in startActivityInner could start a different</span>
        <span class="token comment">// transition based on a sub-action.</span>
        <span class="token comment">// Only do the create here (and defer requestStart) since startActivityInner might abort.</span>
        <span class="token keyword">final</span> <span class="token class-name">Transition</span> newTransition <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">!</span>mService<span class="token punctuation">.</span><span class="token function">getTransitionController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isCollecting</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token operator">&amp;&amp;</span> mService<span class="token punctuation">.</span><span class="token function">getTransitionController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTransitionPlayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token operator">?</span> mService<span class="token punctuation">.</span><span class="token function">getTransitionController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createTransition</span><span class="token punctuation">(</span><span class="token constant">TRANSIT_OPEN</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">IRemoteTransition</span> remoteTransition <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">takeRemoteTransition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>newTransition <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> remoteTransition <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            newTransition<span class="token punctuation">.</span><span class="token function">setRemoteTransition</span><span class="token punctuation">(</span>remoteTransition<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mService<span class="token punctuation">.</span><span class="token function">getTransitionController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            mService<span class="token punctuation">.</span><span class="token function">deferWindowLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_WINDOW_MANAGER</span><span class="token punctuation">,</span> <span class="token string">"startActivityInner"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            result <span class="token operator">=</span> <span class="token function">startActivityInner</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> sourceRecord<span class="token punctuation">,</span> voiceSession<span class="token punctuation">,</span> voiceInteractor<span class="token punctuation">,</span>
                    startFlags<span class="token punctuation">,</span> doResume<span class="token punctuation">,</span> options<span class="token punctuation">,</span> inTask<span class="token punctuation">,</span> restrictedBgActivity<span class="token punctuation">,</span> intentGrants<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_WINDOW_MANAGER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            startedActivityRootTask <span class="token operator">=</span> <span class="token function">handleStartResult</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mService<span class="token punctuation">.</span><span class="token function">continueWindowLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mSupervisor<span class="token punctuation">.</span>mUserLeaving <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

            <span class="token comment">// Transition housekeeping</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">ActivityManager</span><span class="token punctuation">.</span><span class="token function">isStartResultSuccessful</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>newTransition <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    newTransition<span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mAvoidMoveToFront <span class="token operator">&amp;&amp;</span> mDoResume
                        <span class="token operator">&amp;&amp;</span> mRootWindowContainer<span class="token punctuation">.</span><span class="token function">hasVisibleWindowAboveButDoesNotOwnNotificationShade</span><span class="token punctuation">(</span>
                            r<span class="token punctuation">.</span>launchedFromUid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// If the UID launching the activity has a visible window on top of the</span>
                    <span class="token comment">// notification shade and it's launching an activity that's going to be at the</span>
                    <span class="token comment">// front, we should move the shade out of the way so the user can see it.</span>
                    <span class="token comment">// We want to avoid the case where the activity is launched on top of a</span>
                    <span class="token comment">// background task which is not moved to the front.</span>
                    <span class="token class-name">StatusBarManagerInternal</span> statusBar <span class="token operator">=</span> mService<span class="token punctuation">.</span><span class="token function">getStatusBarManagerInternal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>statusBar <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">// This results in a async call since the interface is one-way</span>
                        statusBar<span class="token punctuation">.</span><span class="token function">collapsePanels</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token constant">START_SUCCESS</span> <span class="token operator">||</span> result <span class="token operator">==</span> <span class="token constant">START_TASK_TO_FRONT</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// The activity is started new rather than just brought forward, so record</span>
                    <span class="token comment">// it as an existence change.</span>
                    mService<span class="token punctuation">.</span><span class="token function">getTransitionController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collectExistenceChange</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>newTransition <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    mService<span class="token punctuation">.</span><span class="token function">getTransitionController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">requestStartTransition</span><span class="token punctuation">(</span>newTransition<span class="token punctuation">,</span>
                            mTargetTask<span class="token punctuation">,</span> remoteTransition<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// Make the collecting transition wait until this request is ready.</span>
                    mService<span class="token punctuation">.</span><span class="token function">getTransitionController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setReady</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token function">postStartActivityProcessing</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> result<span class="token punctuation">,</span> startedActivityRootTask<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
    <p>
     Transition和Activity的转场动画相关，调用mService.getTransitionController()的collect®方法将ActivityRecord对象收集到转换中。
     <br/>
     接着mService.deferWindowLayout()是延迟窗口布局。
     <br/>
     调用startActivityInner()方法，实现启动Activity。
     <br/>
     handleStartResult(r, result)是处理启动的结果，如果启动成功，会返回它的RootTask。
     <br/>
     mService.continueWindowLayout()是恢复窗口布局。
     <br/>
     mSupervisor.mUserLeaving是一个状态，如果用户没有明确设定FLAG_ACTIVITY_NO_USER_ACTION标识，在前面startActivityInner()方法中，mSupervisor.mUserLeaving会被设置为true，这样会在Activity执行onPause之前，通知用户离开方法onUserLeaveHint()。执行完毕之后，在这里将它设置为false。
     <br/>
     如果启动Activity的结果不是成功的状态，如果前面创建的newTransition不为null，设置它的abort状态。
     <br/>
     如果是启动成功，在不是避免移到前面的条件下，如果启动的应用在通知栏打开的上层有打开窗口，这里将通知栏关闭。
     <br/>
     接下来是处理转场相关。如果返回结果为START_SUCCESS或START_TASK_TO_FRONT的情况下，这里将启动的ActivityRecord对象的改变状态记录下来（Activity打开或关闭）。START_SUCCESS代表正常启动一个Activity，START_TASK_TO_FRONT是一种什么情况呢？它代表Activity已经在任务栈中，并且将任务栈挪到根任务的最前端，包括根任务也会移动到TaskDisplayArea对象的最前端（这里根任务和任务有可能是同一个）。还有一个返回值为START_DELIVERED_TO_TOP，它则是代表在任务栈顶上和被启动的Activity是相同的，不需要再次启动一个新的。
     <br/>
     如果newTransition是在这里新创建的，这里就开始请求开始。如果不是，则是等待，直到请求是准备好。
     <br/>
     最后是调用postStartActivityProcessing方法。它是处理启动Activity之后的工作。
    </p>
    <h4>
     <a id="startActivityInner_516">
     </a>
     startActivityInner()方法
    </h4>
    <p>
     接下来看看startActivityInner()方法：
    </p>
    <pre><code class="prism language-java">    <span class="token comment">/**
     * Start an activity and determine if the activity should be adding to the top of an existing
     * task or delivered new intent to an existing activity. Also manipulating the activity task
     * onto requested or valid root-task/display.
     *
     * Note: This method should only be called from {@link #startActivityUnchecked}.
     */</span>

    <span class="token comment">// TODO(b/152429287): Make it easier to exercise code paths through startActivityInner</span>
    <span class="token annotation punctuation">@VisibleForTesting</span>
    <span class="token keyword">int</span> <span class="token function">startActivityInner</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ActivityRecord</span> r<span class="token punctuation">,</span> <span class="token class-name">ActivityRecord</span> sourceRecord<span class="token punctuation">,</span>
            <span class="token class-name">IVoiceInteractionSession</span> voiceSession<span class="token punctuation">,</span> <span class="token class-name">IVoiceInteractor</span> voiceInteractor<span class="token punctuation">,</span>
            <span class="token keyword">int</span> startFlags<span class="token punctuation">,</span> <span class="token keyword">boolean</span> doResume<span class="token punctuation">,</span> <span class="token class-name">ActivityOptions</span> options<span class="token punctuation">,</span> <span class="token class-name">Task</span> inTask<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> restrictedBgActivity<span class="token punctuation">,</span> <span class="token class-name">NeededUriGrants</span> intentGrants<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">setInitialState</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> options<span class="token punctuation">,</span> inTask<span class="token punctuation">,</span> doResume<span class="token punctuation">,</span> startFlags<span class="token punctuation">,</span> sourceRecord<span class="token punctuation">,</span> voiceSession<span class="token punctuation">,</span>
                voiceInteractor<span class="token punctuation">,</span> restrictedBgActivity<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">computeLaunchingTaskFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">computeSourceRootTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        mIntent<span class="token punctuation">.</span><span class="token function">setFlags</span><span class="token punctuation">(</span>mLaunchFlags<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token class-name">Task</span> reusedTask <span class="token operator">=</span> <span class="token function">getReusableTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// If requested, freeze the task list</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mOptions <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> mOptions<span class="token punctuation">.</span><span class="token function">freezeRecentTasksReordering</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token operator">&amp;&amp;</span> mSupervisor<span class="token punctuation">.</span>mRecentTasks<span class="token punctuation">.</span><span class="token function">isCallerRecents</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>launchedFromUid<span class="token punctuation">)</span>
                <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mSupervisor<span class="token punctuation">.</span>mRecentTasks<span class="token punctuation">.</span><span class="token function">isFreezeTaskListReorderingSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            mFrozeTaskList <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            mSupervisor<span class="token punctuation">.</span>mRecentTasks<span class="token punctuation">.</span><span class="token function">setFreezeTaskListReordering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Compute if there is an existing task that should be used for.</span>
        <span class="token keyword">final</span> <span class="token class-name">Task</span> targetTask <span class="token operator">=</span> reusedTask <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> reusedTask <span class="token operator">:</span> <span class="token function">computeTargetTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> newTask <span class="token operator">=</span> targetTask <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        mTargetTask <span class="token operator">=</span> targetTask<span class="token punctuation">;</span>

        <span class="token function">computeLaunchParams</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> sourceRecord<span class="token punctuation">,</span> targetTask<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Check if starting activity on given task or on a new task is allowed.</span>
        <span class="token keyword">int</span> startResult <span class="token operator">=</span> <span class="token function">isAllowedToStart</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> newTask<span class="token punctuation">,</span> targetTask<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>startResult <span class="token operator">!=</span> <span class="token constant">START_SUCCESS</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> startResult<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> <span class="token class-name">ActivityRecord</span> targetTaskTop <span class="token operator">=</span> newTask
                <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> targetTask<span class="token punctuation">.</span><span class="token function">getTopNonFinishingActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>targetTaskTop <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// Recycle the target task for this launch.</span>
            startResult <span class="token operator">=</span> <span class="token function">recycleTask</span><span class="token punctuation">(</span>targetTask<span class="token punctuation">,</span> targetTaskTop<span class="token punctuation">,</span> reusedTask<span class="token punctuation">,</span> intentGrants<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>startResult <span class="token operator">!=</span> <span class="token constant">START_SUCCESS</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> startResult<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            mAddingToTask <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// If the activity being launched is the same as the one currently at the top, then</span>
        <span class="token comment">// we need to check if it should only be launched once.</span>
        <span class="token keyword">final</span> <span class="token class-name">Task</span> topRootTask <span class="token operator">=</span> mPreferredTaskDisplayArea<span class="token punctuation">.</span><span class="token function">getFocusedRootTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>topRootTask <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            startResult <span class="token operator">=</span> <span class="token function">deliverToCurrentTopIfNeeded</span><span class="token punctuation">(</span>topRootTask<span class="token punctuation">,</span> intentGrants<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>startResult <span class="token operator">!=</span> <span class="token constant">START_SUCCESS</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> startResult<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>mTargetRootTask <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            mTargetRootTask <span class="token operator">=</span> <span class="token function">getLaunchRootTask</span><span class="token punctuation">(</span>mStartActivity<span class="token punctuation">,</span> mLaunchFlags<span class="token punctuation">,</span> targetTask<span class="token punctuation">,</span> mOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>newTask<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">final</span> <span class="token class-name">Task</span> taskToAffiliate <span class="token operator">=</span> <span class="token punctuation">(</span>mLaunchTaskBehind <span class="token operator">&amp;&amp;</span> mSourceRecord <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                    <span class="token operator">?</span> mSourceRecord<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token function">setNewTask</span><span class="token punctuation">(</span>taskToAffiliate<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mAddingToTask<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">addOrReparentStartingActivity</span><span class="token punctuation">(</span>targetTask<span class="token punctuation">,</span> <span class="token string">"adding to task"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mAvoidMoveToFront <span class="token operator">&amp;&amp;</span> mDoResume<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            mTargetRootTask<span class="token punctuation">.</span><span class="token function">getRootTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">moveToFront</span><span class="token punctuation">(</span><span class="token string">"reuseOrNewTask"</span><span class="token punctuation">,</span> targetTask<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mOptions <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mOptions<span class="token punctuation">.</span><span class="token function">getTaskAlwaysOnTop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    mTargetRootTask<span class="token punctuation">.</span><span class="token function">setAlwaysOnTop</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mTargetRootTask<span class="token punctuation">.</span><span class="token function">isTopRootTaskInDisplayArea</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> mService<span class="token punctuation">.</span>mInternal<span class="token punctuation">.</span><span class="token function">isDreaming</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// Launching underneath dream activity (fullscreen, always-on-top). Run the launch-</span>
                <span class="token comment">// -behind transition so the Activity gets created and starts in visible state.</span>
                mLaunchTaskBehind <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                r<span class="token punctuation">.</span>mLaunchTaskBehind <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        mService<span class="token punctuation">.</span>mUgmInternal<span class="token punctuation">.</span><span class="token function">grantUriPermissionUncheckedFromIntent</span><span class="token punctuation">(</span>intentGrants<span class="token punctuation">,</span>
                mStartActivity<span class="token punctuation">.</span><span class="token function">getUriPermissionsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mStartActivity<span class="token punctuation">.</span>resultTo <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> mStartActivity<span class="token punctuation">.</span>resultTo<span class="token punctuation">.</span>info <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// we need to resolve resultTo to a uid as grantImplicitAccess deals explicitly in UIDs</span>
            <span class="token keyword">final</span> <span class="token class-name">PackageManagerInternal</span> pmInternal <span class="token operator">=</span>
                    mService<span class="token punctuation">.</span><span class="token function">getPackageManagerInternalLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> resultToUid <span class="token operator">=</span> pmInternal<span class="token punctuation">.</span><span class="token function">getPackageUid</span><span class="token punctuation">(</span>
                    mStartActivity<span class="token punctuation">.</span>resultTo<span class="token punctuation">.</span>info<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token comment">/* flags */</span><span class="token punctuation">,</span>
                    mStartActivity<span class="token punctuation">.</span>mUserId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            pmInternal<span class="token punctuation">.</span><span class="token function">grantImplicitAccess</span><span class="token punctuation">(</span>mStartActivity<span class="token punctuation">.</span>mUserId<span class="token punctuation">,</span> mIntent<span class="token punctuation">,</span>
                    <span class="token class-name">UserHandle</span><span class="token punctuation">.</span><span class="token function">getAppId</span><span class="token punctuation">(</span>mStartActivity<span class="token punctuation">.</span>info<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid<span class="token punctuation">)</span> <span class="token comment">/*recipient*/</span><span class="token punctuation">,</span>
                    resultToUid <span class="token comment">/*visible*/</span><span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/*direct*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>newTask<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">EventLogTags</span><span class="token punctuation">.</span><span class="token function">writeWmCreateTask</span><span class="token punctuation">(</span>mStartActivity<span class="token punctuation">.</span>mUserId<span class="token punctuation">,</span>
                    mStartActivity<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mTaskId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mStartActivity<span class="token punctuation">.</span><span class="token function">logStartActivity</span><span class="token punctuation">(</span>
                <span class="token class-name">EventLogTags</span><span class="token punctuation">.</span><span class="token constant">WM_CREATE_ACTIVITY</span><span class="token punctuation">,</span> mStartActivity<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        mTargetRootTask<span class="token punctuation">.</span>mLastPausedActivity <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        mRootWindowContainer<span class="token punctuation">.</span><span class="token function">startPowerModeLaunchIfNeeded</span><span class="token punctuation">(</span>
                <span class="token boolean">false</span> <span class="token comment">/* forceSend */</span><span class="token punctuation">,</span> mStartActivity<span class="token punctuation">)</span><span class="token punctuation">;</span>

        mTargetRootTask<span class="token punctuation">.</span><span class="token function">startActivityLocked</span><span class="token punctuation">(</span>mStartActivity<span class="token punctuation">,</span>
                topRootTask <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> topRootTask<span class="token punctuation">.</span><span class="token function">getTopNonFinishingActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> newTask<span class="token punctuation">,</span>
                mKeepCurTransition<span class="token punctuation">,</span> mOptions<span class="token punctuation">,</span> sourceRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mDoResume<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">final</span> <span class="token class-name">ActivityRecord</span> topTaskActivity <span class="token operator">=</span>
                    mStartActivity<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">topRunningActivityLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mTargetRootTask<span class="token punctuation">.</span><span class="token function">isTopActivityFocusable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token operator">||</span> <span class="token punctuation">(</span>topTaskActivity <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> topTaskActivity<span class="token punctuation">.</span><span class="token function">isTaskOverlay</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token operator">&amp;&amp;</span> mStartActivity <span class="token operator">!=</span> topTaskActivity<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// If the activity is not focusable, we can't resume it, but still would like to</span>
                <span class="token comment">// make sure it becomes visible as it starts (this will also trigger entry</span>
                <span class="token comment">// animation). An example of this are PIP activities.</span>
                <span class="token comment">// Also, we don't want to resume activities in a task that currently has an overlay</span>
                <span class="token comment">// as the starting activity just needs to be in the visible paused state until the</span>
                <span class="token comment">// over is removed.</span>
                <span class="token comment">// Passing {@code null} as the start parameter ensures all activities are made</span>
                <span class="token comment">// visible.</span>
                mTargetRootTask<span class="token punctuation">.</span><span class="token function">ensureActivitiesVisible</span><span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token comment">/* starting */</span><span class="token punctuation">,</span>
                        <span class="token number">0</span> <span class="token comment">/* configChanges */</span><span class="token punctuation">,</span> <span class="token operator">!</span><span class="token constant">PRESERVE_WINDOWS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// Go ahead and tell window manager to execute app transition for this activity</span>
                <span class="token comment">// since the app transition will not be triggered through the resume channel.</span>
                mTargetRootTask<span class="token punctuation">.</span>mDisplayContent<span class="token punctuation">.</span><span class="token function">executeAppTransition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// If the target root-task was not previously focusable (previous top running</span>
                <span class="token comment">// activity on that root-task was not visible) then any prior calls to move the</span>
                <span class="token comment">// root-task to the will not update the focused root-task.  If starting the new</span>
                <span class="token comment">// activity now allows the task root-task to be focusable, then ensure that we</span>
                <span class="token comment">// now update the focused root-task accordingly.</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mTargetRootTask<span class="token punctuation">.</span><span class="token function">isTopActivityFocusable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mRootWindowContainer<span class="token punctuation">.</span><span class="token function">isTopDisplayFocusedRootTask</span><span class="token punctuation">(</span>mTargetRootTask<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    mTargetRootTask<span class="token punctuation">.</span><span class="token function">moveToFront</span><span class="token punctuation">(</span><span class="token string">"startActivityInner"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                mRootWindowContainer<span class="token punctuation">.</span><span class="token function">resumeFocusedTasksTopActivities</span><span class="token punctuation">(</span>
                        mTargetRootTask<span class="token punctuation">,</span> mStartActivity<span class="token punctuation">,</span> mOptions<span class="token punctuation">,</span> mTransientLaunch<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        mRootWindowContainer<span class="token punctuation">.</span><span class="token function">updateUserRootTask</span><span class="token punctuation">(</span>mStartActivity<span class="token punctuation">.</span>mUserId<span class="token punctuation">,</span> mTargetRootTask<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Update the recent tasks list immediately when the activity starts</span>
        mSupervisor<span class="token punctuation">.</span>mRecentTasks<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>mStartActivity<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mSupervisor<span class="token punctuation">.</span><span class="token function">handleNonResizableTaskIfNeeded</span><span class="token punctuation">(</span>mStartActivity<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                mPreferredWindowingMode<span class="token punctuation">,</span> mPreferredTaskDisplayArea<span class="token punctuation">,</span> mTargetRootTask<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token constant">START_SUCCESS</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
    <p>
     setInitialState()主要用来初始化ActivityStarter对象的成员变量，
     <br/>
     computeLaunchingTaskFlags()是用来计算启动任务的标识mLaunchFlags。这里注意的一点是，在没指定Task的情况下，如果启动的Activity模式是LAUNCH_SINGLE_INSTANCE或LAUNCH_SINGLE_TASK，会给mLaunchFlags添加FLAG_ACTIVITY_NEW_TASK标识。
     <br/>
     computeSourceRootTask()是用来得到源根任务mSourceRootTask。
     <br/>
     接下来将mLaunchFlags设置到mIntent中。
     <br/>
     getReusableTask()得到新启动Activity应该添加进的Task。主要处理启动标识FLAG_ACTIVITY_NEW_TASK标识，还有启动模式为LAUNCH_SINGLE_INSTANCE、LAUNCH_SINGLE_TASK的情况，这样得到包含对应Activity的Task。
     <br/>
     接下来，如果设置参数里面请求冻结任务链，设置冻结任务链属性。
     <br/>
     targetTask是启动的Activity使用的Task，它可能存在，也可能不存在，需要创建。这里如果上面得到的reusedTask不为null，就使用它；如果他为null，再通过computeTargetTask()计算得到。computeTargetTask()会在有FLAG_ACTIVITY_NEW_TASK标识的情况下，返回null。代表需要新建Task。computeTargetTask()在其他的情况下，如果启动Activity不为null，就返回它的Task。如果指定Task，就使用指定Task。
     <br/>
     如果targetTask为null，则代表需要新建Task。
     <br/>
     给成员变量mTargetTask赋值。
     <br/>
     computeLaunchParams用来计算成员变量mLaunchParams。
     <br/>
     isAllowedToStart()用来判断是否允许启动Activity。它主要用来判断ACTIVITY_TYPE_HOME类型Activity能否在显示屏上启动、后台启动的Activity是否终止、是否违法锁任务模式。如果返回的结果不为START_SUCCESS，则返回对应结果。
     <br/>
     下面如果目标Task不为null，则得到目标Task上面的不为finishing的ActivityRecord targetTaskTop。
     <br/>
     如果目标Task上的不为finishing的ActivityRecord targetTaskTop不为null，则调用recycleTask()处理。注意，这里的targetTaskTop可不见得就是启动的Activity，像SINGLE_TASK模式启动的Activity，它所属的任务栈里在它上面可能存在其他的Activity。recycleTask主要是对于目标Task的重用处理。如果目标Task的根Task不是当前获取焦点的根Task，它会将目标Task的根Task移动到最前面。处理启动的标识，在这里，它可能会将Task里面的Activity给去除（对应启动SingleTask的Activity，它的实现是由complyActivityFlags()实现）。它还决定是在Task顶端添加Activity还是将Task放到最前端。如果是在Task顶端添加Activity，它会将成员变量mAddingToTask设置为true。
     <br/>
     注意，如果recycleTask()返回的结果不为START_SUCCESS，则不会再往下执行，直接返回对应的结果。这里返回START_SUCCESS也即在Task顶端添加Activity。它会继续向下处理。像我们平时启动模式为SingleTask、SingleInstance的Activity，并且已经存在Task的情况下，就不会继续向下执行了。
     <br/>
     如果目标Task上的不为finishing的ActivityRecord targetTaskTop为null，则将变量mAddingToTask = true，代表需要将Activity添加到Task中。
     <br/>
     接下来，是判断启动的Activity是否和当前Task最顶的Activity是不是相同，如果相同，检查是不是需要重新启动一个新的Activity。下面的deliverToCurrentTopIfNeeded(topRootTask, intentGrants)就是做这个事情的。像我们平时启动模式为SingleTop的Activity就是在这里处理的。如果不用新启动Activity，返回START_DELIVERED_TO_TOP。
     <br/>
     再接下来，如果mTargetRootTask为null的话，通过getLaunchRootTask()方法来获得。getLaunchRootTask()如果不能得到目前存在的Task，它会新建一个Task。
     <br/>
     下面继续是新建Task（newTask决定），还是将Activity添加到Task中（mAddingToTask决定）。如果是新建Task，在新建之后，还需要将Activity添加到Task中的最顶端。在这里由于上一步可能通过getLaunchRootTask()新建了RootTask，在这里也可能是使用的上一步新建的RootTask。如果不需要新建Task，只是将Activity加入到Task中，这里是调用addOrReparentStartingActivity(targetTask, “adding to task”)完成的。
     <br/>
     下面，如果mAvoidMoveToFront为false，代表将任务移动到前面。mDoResume为true，代表需要将Activity启动。这里会调用根Task的moveToFront()将任务移动到前面。
     <br/>
     下面是检测Uri权限。
     <br/>
     如果启动Activity之后，返回结果给对应Activity存在（mStartActivity.resultTo != null）。这里获取返回接收者应用对启动应用的可见性。
     <br/>
     下面继续将mTargetRootTask.mLastPausedActivity = null。
     <br/>
     mTargetRootTask.startActivityLocked()主要是将Activity放置到Task的最上端。然后显示应用的StartingWindow。
     <br/>
     mDoResume代表需要恢复Activity。
     <br/>
     得到启动Activity的所在任务的最顶端可以运行的Activity topTaskActivity。
     <br/>
     如果根任务的顶端Activity不是可以取得焦点的或者任务的顶端有一个遮罩并且不是启动的Activity，这样的情况下，也不恢复Activity，只是让它可见。
     <br/>
     除了上面那两种情况下，就需要恢复Activity。还是检查如果根任务不是顶端获取焦点的根任务，需要将它挪到最前端。接着就调用mRootWindowContainer.resumeFocusedTasksTopActivities()来恢复目标Activity的执行。在它里面会执行根Task的resumeTopActivityUncheckedLocked()方法。由于在前面已经将Activity添加到Task的最顶端，所以这里就会将之前的处于Resumed状态的Activity给暂停，然后将新添加的Activity启动，并且将它状态改成Resumed。
     <br/>
     接下来调用mRootWindowContainer.updateUserRootTask()方法来更新对应用户的根Task。
     <br/>
     会将启动的Activity的Task添加到mSupervisor.mRecentTasks中。
     <br/>
     接着调用mSupervisor的handleNonResizableTaskIfNeeded()方法来处理不是可变大小的Task。
     <br/>
     最后返回结果START_SUCCESS。
    </p>
    <h2>
     <a id="_715">
     </a>
     总结
    </h2>
    <p>
     这里是启动Activity的实现。
     <br/>
     首先是需要执行一系列检查，主要是权限和拦截的处理。
     <br/>
     接着处理主要分可以重用的Task，还是新建Task。对于可以重用的Task，还是要区分里面是否已经存在Activity实例（SingleTask、SingleInstance、SingleTop模式的Activity）进行处理。
     <br/>
     最后会将满足条件的Activty启动起来。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71313136353332383936332f:61727469636c652f64657461696c732f313433313031313132" class_="artid" style="display:none">
 </p>
</div>


