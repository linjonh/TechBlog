---
layout: post
title: "vue3-xlsx-实现导入导出表格,导出动态获取表头和数据"
date: 2025-03-10 17:32:08 +0800
description: "vue3 + xlsx 实现导入导出表格，导出动态获取表头和数据"
keywords: "worksheet['!cols'] = headerorder.map((header) => { console.log(header, '----"
categories: ['未分类']
tags: ['前端', 'Vue', 'Javascript']
artid: "146159387"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146159387
    alt: "vue3-xlsx-实现导入导出表格,导出动态获取表头和数据"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146159387
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146159387
cover: https://bing.ee123.net/img/rand?artid=146159387
image: https://bing.ee123.net/img/rand?artid=146159387
img: https://bing.ee123.net/img/rand?artid=146159387
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     vue3 + xlsx 实现导入导出表格，导出动态获取表头和数据
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h3>
     <a id="_xlsxts__0">
     </a>
     封装 xlsx.ts 文件
    </h3>
    <pre><code class="prism language-javascript">npm i xlsx element<span class="token operator">-</span>plus
</code></pre>
    <pre><code class="prism language-javascript"><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> <span class="token constant">XLSX</span> <span class="token keyword">from</span> <span class="token string">"xlsx"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> ElMessageBox<span class="token punctuation">,</span> ElMessage <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"element-plus"</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 导出表格数据为 Excel 文件，自动匹配 el-table 或 vxe-table 表头和数据字段
 * element-plus 2.7.6 版本支持动态获取列
 * @param {Object} [tableRef] - 表格组件的 ref 引用（可选）
 * @param {String} fileName - 导出文件名（默认：export.xlsx）
 * @param {Object} options - 配置项（可选）
 * @param {Array} options.headers - 自定义表头（可选）
 * @param {Array} options.dataKeys - 自定义数据字段（可选）
 * @param {Array} options.data - 要导出的数据（可选，如果没有 tableRef 则必须提供）
 * 
 * 使用示例：
 * exportExcel(tableRef.value, '用户数据.xlsx')
 * 
 * 自定义表头和数据字段 示例：
 * exportExcel(tableRef.value, '用户数据.xlsx', {
    headers: ['姓名', '城市'], // 自定义表头
    dataKeys: ['name', 'city'] // 自定义数据字段
  })
 *
 * 如果没有 tableRef，则需要提供自定义表头和数据：
 * exportExcel(null, '用户数据.xlsx', {
    headers: ['姓名', '城市'],
    data: [{name: '张三', city: '北京'}, {name: '李四', city: '上海'}]
  })
 */</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> exportExcel <span class="token operator">=</span> <span class="token punctuation">(</span>
  <span class="token literal-property property">tableRef</span><span class="token operator">:</span> any <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  fileName <span class="token operator">=</span> <span class="token string">"export.xlsx"</span><span class="token punctuation">,</span>
  <span class="token literal-property property">options</span><span class="token operator">:</span> any <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">let</span> headers <span class="token operator">=</span> options<span class="token punctuation">.</span>headers <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> data <span class="token operator">=</span> options<span class="token punctuation">.</span>data <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>tableRef<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tableRef<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">"VxeTable"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      headers <span class="token operator">=</span>
        headers<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span>
          <span class="token operator">?</span> headers
          <span class="token operator">:</span> tableRef<span class="token punctuation">.</span><span class="token function">getColumns</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">col</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> col<span class="token punctuation">.</span>title<span class="token punctuation">)</span><span class="token punctuation">;</span>
      data <span class="token operator">=</span> data<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">?</span> data <span class="token operator">:</span> tableRef<span class="token punctuation">.</span><span class="token function">getTableData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>fullData<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tableRef<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">"ElTable"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      headers <span class="token operator">=</span>
        headers<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span>
          <span class="token operator">?</span> headers
          <span class="token operator">:</span> tableRef<span class="token punctuation">.</span>columns<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">col</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> col<span class="token punctuation">.</span>label<span class="token punctuation">)</span><span class="token punctuation">;</span>
      data <span class="token operator">=</span> data<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">?</span> data <span class="token operator">:</span> tableRef<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"不支持的表格组件类型"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>dataKeys<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      data <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">item</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
        options<span class="token punctuation">.</span>dataKeys<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span>
          <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">obj</span><span class="token operator">:</span> any<span class="token punctuation">,</span> <span class="token literal-property property">key</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token operator">...</span>obj<span class="token punctuation">,</span> <span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token operator">:</span> item<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
        <span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>headers<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"缺少必要的表头"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 构建工作表数据</span>
  <span class="token keyword">const</span> worksheetData <span class="token operator">=</span> <span class="token punctuation">[</span>
    headers<span class="token punctuation">,</span> <span class="token comment">// 表头行</span>
    <span class="token operator">...</span>data<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">item</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
      headers<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">header</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">const</span> key <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>
          <span class="token punctuation">(</span><span class="token parameter">k</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> k<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> header<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> key <span class="token operator">?</span> item<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token comment">// 创建 workbook</span>
  <span class="token keyword">const</span> workbook <span class="token operator">=</span> <span class="token constant">XLSX</span><span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">book_new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> worksheet <span class="token operator">=</span> <span class="token constant">XLSX</span><span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">aoa_to_sheet</span><span class="token punctuation">(</span>worksheetData<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 添加样式</span>
  worksheet<span class="token punctuation">[</span><span class="token string">"!cols"</span><span class="token punctuation">]</span> <span class="token operator">=</span> headers<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">wch</span><span class="token operator">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 列宽</span>

  <span class="token comment">// 组合并导出</span>
  <span class="token constant">XLSX</span><span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">book_append_sheet</span><span class="token punctuation">(</span>workbook<span class="token punctuation">,</span> worksheet<span class="token punctuation">,</span> <span class="token string">"Sheet1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token constant">XLSX</span><span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span>workbook<span class="token punctuation">,</span> fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 从Excel文件导入数据，并可以选择性地更新指定表格组件的数据。
 * @param {Object} [tableRef] - 表格组件的 ref 引用（可选）
 * @param {string[]} [requiredFields] - 必填字段的表头名称数组（可选）
 * @returns {Promise&lt;any[]&gt;} 解析后的数据数组
 *
 * 示例：仅导入数据
 * importExcel().then(data =&gt; console.log('导入的数据:', data));
 *
 * 示例：导入数据并更新指定的表格组件
 * importExcel(tableRef).then(() =&gt; console.log('表格已更新'));
 *
 * 示例：导入数据并校验必填字段
 * importExcel(null, ['名称']).then(data =&gt; console.log('导入的数据:', data));
 */</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">importExcel</span> <span class="token operator">=</span> <span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">tableRef</span><span class="token operator">:</span> any <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">requiredFields</span><span class="token operator">:</span> string<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> input <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"input"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    input<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">"type"</span><span class="token punctuation">,</span> <span class="token string">"file"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    input<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">"accept"</span><span class="token punctuation">,</span> <span class="token string">".xlsx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 限制只能选择 .xlsx 文件</span>
    input<span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    input<span class="token punctuation">.</span><span class="token function-variable function">onchange</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">e</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">const</span> files <span class="token operator">=</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>files<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>files<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"没有选择文件"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">const</span> file <span class="token operator">=</span> files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">// 校验文件类型</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>file<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">".xlsx"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"只能导入 .xlsx 文件"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">const</span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      reader<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">event</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">const</span> workbook <span class="token operator">=</span> <span class="token constant">XLSX</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">"array"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">const</span> firstSheetName <span class="token operator">=</span> workbook<span class="token punctuation">.</span>SheetNames<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token keyword">const</span> worksheet <span class="token operator">=</span> workbook<span class="token punctuation">.</span>Sheets<span class="token punctuation">[</span>firstSheetName<span class="token punctuation">]</span><span class="token punctuation">;</span>

		  <span class="token comment">// 提取并校验表头</span>
          <span class="token keyword">const</span> <span class="token literal-property property">headerData</span><span class="token operator">:</span> any <span class="token operator">=</span> <span class="token constant">XLSX</span><span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">sheet_to_json</span><span class="token punctuation">(</span>worksheet<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
            <span class="token literal-property property">header</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 获取第一行作为表头</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>requiredFields<span class="token punctuation">.</span><span class="token function">every</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">field</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> headerData<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"导入的表格表头与要求不符，请使用正确的模板！"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>

          <span class="token comment">// 直接转换数据（自动跳过表头行）</span>
          <span class="token keyword">const</span> newData <span class="token operator">=</span> <span class="token constant">XLSX</span><span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">sheet_to_json</span><span class="token punctuation">(</span>worksheet<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
            <span class="token literal-property property">defval</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token comment">// 将空值默认为空字符串</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token comment">// 校验必填字段</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>requiredFields<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">const</span> missingFieldsMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 用于记录缺失必填字段的行号</span>
            newData<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">row</span><span class="token operator">:</span> any<span class="token punctuation">,</span> <span class="token literal-property property">index</span><span class="token operator">:</span> number</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
              requiredFields<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">field</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">const</span> fieldValue <span class="token operator">=</span> row<span class="token punctuation">[</span>field<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 获取字段值</span>

                <span class="token comment">// 判断字段值是否为空（允许 0 和 false）</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>
                  fieldValue <span class="token operator">===</span> <span class="token string">""</span> <span class="token operator">||</span>
                  fieldValue <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span>
                  fieldValue <span class="token operator">===</span> <span class="token keyword">undefined</span>
                <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                  <span class="token comment">// 记录缺失字段的行号（index + 2，因为表头占一行，且数组从0开始）</span>
                  <span class="token keyword">const</span> rowNumber <span class="token operator">=</span> index <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">;</span>
                  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>missingFieldsMap<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>rowNumber<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    missingFieldsMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>rowNumber<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">}</span>
                  missingFieldsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>rowNumber<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 如果有缺失字段，弹出错误提示</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>missingFieldsMap<span class="token punctuation">.</span>size <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              <span class="token keyword">let</span> errorMessage <span class="token operator">=</span> <span class="token string">"以下行的必填字段缺失：&lt;br&gt;"</span><span class="token punctuation">;</span> <span class="token comment">// 使用 &lt;br&gt; 换行</span>
              missingFieldsMap<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">fields<span class="token punctuation">,</span> rowNumber</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
                errorMessage <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">第 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>rowNumber<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 行缺失字段：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>fields<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>
                  <span class="token string">", "</span>
                <span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;br&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span> <span class="token comment">// 使用 &lt;br&gt; 换行</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

              <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>errorMessage<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 同时 reject Promise</span>
              <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>

          <span class="token comment">// 如果提供了 tableRef，则更新表格数据</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>tableRef<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">let</span> existingData<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>tableRef<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">"VxeTable"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              existingData <span class="token operator">=</span> tableRef<span class="token punctuation">.</span><span class="token function">getTableData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>fullData<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tableRef<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">"ElTable"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              existingData <span class="token operator">=</span> tableRef<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">const</span> combinedData <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>existingData<span class="token punctuation">,</span> <span class="token operator">...</span>newData<span class="token punctuation">]</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>tableRef<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">"VxeTable"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              tableRef<span class="token punctuation">.</span><span class="token function">loadData</span><span class="token punctuation">(</span>combinedData<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tableRef<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">"ElTable"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              tableRef<span class="token punctuation">.</span>data <span class="token operator">=</span> combinedData<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>

          <span class="token function">resolve</span><span class="token punctuation">(</span>newData<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回不包含表头的数据</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      reader<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"读取文件时出错"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      reader<span class="token punctuation">.</span><span class="token function">readAsArrayBuffer</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 导入数据并插入到数据库
 * @param {any[]} data - 导入的数据
 * @param {Function} insertApi - 插入数据的接口函数
 * @param {Function} refreshTable - 刷新表格的函数
 * @param {Function} setLoading - 控制 loading 状态的函数
 */</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">importAndInsertData</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>
  <span class="token literal-property property">data</span><span class="token operator">:</span> any<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token function-variable function">insertApi</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">item</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Promise<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  <span class="token function-variable function">refreshTable</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">,</span>
  <span class="token function-variable function">setLoading</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">isLoading</span><span class="token operator">:</span> boolean</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span>
<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">setLoading</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 存储所有插入操作的 Promise</span>
    <span class="token keyword">const</span> insertPromises <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
      <span class="token function">insertApi</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 如果插入失败，返回失败的数据和错误信息</span>
        <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span> item<span class="token punctuation">,</span> error <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 等待所有插入操作完成</span>
    <span class="token keyword">const</span> results <span class="token operator">=</span> <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>insertPromises<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 检查是否有插入失败的数据</span>
    <span class="token keyword">const</span> failedItems <span class="token operator">=</span> results<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">result</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> result <span class="token operator">&amp;&amp;</span> result<span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>failedItems<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 如果有插入失败的数据，提示失败的具体信息</span>
      <span class="token keyword">let</span> errorMessage <span class="token operator">=</span> <span class="token string">"以下数据插入失败：&lt;br&gt;"</span><span class="token punctuation">;</span>
      failedItems<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{<!-- --></span> item<span class="token punctuation">,</span> error <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        errorMessage <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">数据：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">，错误：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>
          error<span class="token punctuation">.</span>message
        <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;br&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      ElMessageBox<span class="token punctuation">.</span><span class="token function">alert</span><span class="token punctuation">(</span>errorMessage<span class="token punctuation">,</span> <span class="token string">"导入失败"</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
        <span class="token literal-property property">confirmButtonText</span><span class="token operator">:</span> <span class="token string">"确定"</span><span class="token punctuation">,</span>
        <span class="token literal-property property">dangerouslyUseHTMLString</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 如果全部插入成功，提示成功并刷新表格</span>
      ElMessage<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token string">"导入成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">refreshTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token operator">:</span> any<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 捕获全局错误</span>
    ElMessageBox<span class="token punctuation">.</span><span class="token function">alert</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">导入过程中发生错误：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>error<span class="token punctuation">.</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token string">"导入失败"</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">confirmButtonText</span><span class="token operator">:</span> <span class="token string">"确定"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">setLoading</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 无论成功或失败，最终关闭 loading</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * importAndInsertData 函数使用示例
 * 处理导入数据的函数
    const handleImport = async () =&gt; {
      try {
        // 必填字段
        let requiredFields = ['费用类型(ID)', '加成率(ID)', '名称', '拼音码', '规格', '价格', '最小单位', '库房转换率(整数)', '进货单位', '五笔码', '库房地点(ID)']
        const data: any = await importExcel(null, requiredFields);
        if (data.length === 0) {
          ElMessage.warning("导入的数据为空");
          return;
        }

        // 定义插入数据的接口函数
        const insertApi = async (item: any) =&gt; {
          const form = {
            code_item_cls: 0,
            code_item_id: 0,
          }
          const response = await api(form);
          if (response.data[0].success != 'T') {
            throw new Error(response.message || "插入数据失败");
          }
          return response;
        };

        // 调用导入并插入数据的函数
        await importAndInsertData(data, insertApi, handleLoadChargeItemlist, (isLoading) =&gt; {
          importLoading.value = isLoading; // 控制 loading 状态
        });
      } catch (error: any) {
        ElMessageBox.alert(error.message, "导入失败", {
          confirmButtonText: "确定",
          dangerouslyUseHTMLString: true,
        });
      }
    };
 */</span>

</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f36313736393939382f:61727469636c652f64657461696c732f313436313539333837" class_="artid" style="display:none">
 </p>
</div>


