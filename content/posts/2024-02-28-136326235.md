---
arturl_encode: "68747470733a2f2f:626c6f672e6373646e2e6e65742f59616f79616f323032342f:61727469636c652f64657461696c732f313336333236323335"
layout: post
title: "QT-Cå®è·µè¶…è¯¦ç»†æ•°æ®åº“çš„è¿æ¥å’Œå¢åˆ æ”¹æŸ¥æ“ä½œé™„æºç "
date: 2024-02-28 17:16:55 +08:00
description: "ğŸª§ä»€ä¹ˆæƒ…å†µéœ€è¦æ•°æ®åº“?å¦‚æœä¸æ˜¯ä¸Šé¢çš„åŸå› åŒ–ï¼ŒğŸª§äºŒè€…åŒºåˆ«åœ¨äºï¼Œå‰è€…"
keywords: "c++è¿æ¥mysqlæ•°æ®åº“å¢åˆ æ”¹æŸ¥"
categories: ['Qt']
tags: ['æ•°æ®åº“', 'Qt', 'C']
artid: "136326235"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=136326235
    alt: "QT-Cå®è·µè¶…è¯¦ç»†æ•°æ®åº“çš„è¿æ¥å’Œå¢åˆ æ”¹æŸ¥æ“ä½œé™„æºç "
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=136326235
featuredImagePreview: https://bing.ee123.net/img/rand?artid=136326235
---

# QT C++å®è·µ|è¶…è¯¦ç»†æ•°æ®åº“çš„è¿æ¥å’Œå¢åˆ æ”¹æŸ¥æ“ä½œ|é™„æºç 

## 0ï¼šå‰è¨€

ğŸª§
**ä»€ä¹ˆæƒ…å†µéœ€è¦æ•°æ®åº“?**

* 1 å¤§è§„æ¨¡çš„æ•°æ®éœ€è¦å¤„ç†ï¼ˆæ¯”å¦‚ä¸Šåƒä¸Šä¸‡çš„æ•°æ®é‡ï¼‰
* 2 éœ€è¦æŠŠæ•°æ®ä¿¡æ¯å­˜å‚¨èµ·æ¥ï¼Œæ— è®ºæ˜¯æœ¬åœ°è¿˜æ˜¯æœåŠ¡ä¸Šï¼Œè€Œä¸æ˜¯æ–­ç”µåæ•°æ®ä¿¡æ¯å°±æ¶ˆå¤±äº†ã€‚

å¦‚æœä¸æ˜¯ä¸Šé¢çš„åŸå› åŒ–ï¼Œä¸€èˆ¬å¯ä»¥ä½¿ç”¨æ•°ç»„æ¥å¤„ç†ã€‚

ğŸª§ä¸€èˆ¬å¸¸ä½¿ç”¨çš„æ•°æ®åº“é©±åŠ¨æ˜¯
**MYSQL**
å’Œ
**QSQLITE**
ã€‚äºŒè€…åŒºåˆ«åœ¨äºï¼Œå‰è€…ç”¨äºæœåŠ¡å™¨å­˜å‚¨ä¿¡æ¯ï¼Œåè€…ç”¨äºæœ¬åœ°å­˜å‚¨ä¿¡æ¯ã€‚å¹¶ä¸”QSQLITEä¸»è¦ç”¨äºåµŒå…¥å¼ï¼Œå ç”¨èµ„æºéå¸¸ä½ï¼Œå ç”¨å†…å­˜å°ï¼Œé€šå¸¸å‡ ç™¾kå°±æå®šã€‚â€™

> è¿™é‡Œåšä¸»å› ä¸ºå¯¹
> `MySQL`
> ç†Ÿæ‚‰ä¸€äº›ï¼Œå°±ä½¿ç”¨
> `MySQL`
> æ¥è¿›è¡Œæ•°æ®åº“çš„è¿æ¥

## ä¸€ã€Mysqlçš„å®‰è£…

å› ä¸ºæˆ‘ä»¬é¡¹ç›®çš„æ–¹æ¡ˆæ˜¯ç¨‹åºçš„è¿è¡Œä»¥åŠç›¸å…³æ•°æ®çš„å­˜å‚¨éƒ½åœ¨ä¸€å°ä¸»æœºä¸Šï¼Œæ‰€ä»¥ä¸è®ºæ‰“ä¸æ‰“åŒ…ã€‚é¦–å…ˆè¦åœ¨ä¸»æœºä¸Šå®‰è£…
`Mysql`
çš„ã€‚
`Mysql`
çš„å®‰è£…æ•™ç¨‹æˆ‘å‚è€ƒçš„æ˜¯è¿™ä¸ªï¼š
[MySQLå®‰è£…å’Œé…ç½®æ•™ç¨‹ï¼ˆè¶…è¯¦ç»†ç‰ˆæœ¬ï¼‰](https://zhuanlan.zhihu.com/p/654087404)

å®‰è£…å¥½åï¼Œåˆ©ç”¨å‘½ä»¤è¡Œæˆ–å…¶ä»–å·¥å…·åœ¨MySQLä¸­åˆ›å»ºä¸€ä¸ªå­˜å‚¨é¡¹ç›®æ•°æ®çš„æ•°æ®åº“ï¼Œæ–¹ä¾¿ä¹‹åä½¿ç”¨QTç”¨ä»£ç å¯¹æ•°æ®åº“è¿›è¡Œè¿æ¥ã€å»ºè¡¨å’Œå¢åˆ æ”¹æŸ¥çš„æ“ä½œï¼š

* `Win+r`
  æ‰“å¼€cmdï¼šè¾“å…¥å‘½ä»¤â€œmysql -u root -pâ€ï¼ŒæŒ‰ä¸‹å›è½¦é”®
* è¾“å…¥MySQLå¯†ç ï¼ŒæŒ‰ä¸‹å›è½¦é”®
* åˆ›å»ºæ•°æ®åº“

```sql
create database [if not exists] æ•°æ®åº“å [default charset å­—ç¬¦é›†] [collate æ’åºè§„åˆ™];

```

> æ³¨æ„ï¼šä¸è¦å¿˜è®°æœ«å°¾çš„åˆ†å·

## äºŒã€é€šè¿‡ODBCè¿æ¥MySQLæ•°æ®åº“

å®˜æ–¹è§£é‡Š:
  
ODBCï¼ˆOpen Database Connectivityï¼Œå¼€æ”¾æ•°æ®åº“äº’è¿ï¼‰æä¾›äº†ä¸€ç§æ ‡å‡†çš„APIï¼ˆåº”ç”¨ç¨‹åºç¼–ç¨‹æ¥å£ï¼‰æ–¹æ³•æ¥è®¿é—®æ•°æ®åº“ç®¡ç†ç³»ç»Ÿï¼ˆDBMSï¼‰ã€‚è¿™äº›APIåˆ©ç”¨SQLæ¥å®Œæˆå…¶å¤§éƒ¨åˆ†ä»»åŠ¡ã€‚ODBCæœ¬èº«ä¹Ÿæä¾›äº†å¯¹SQLè¯­è¨€çš„æ”¯æŒï¼Œç”¨æˆ·å¯ä»¥ç›´æ¥å°†SQLè¯­å¥é€ç»™ODBCã€‚ODBCçš„è®¾è®¡è€…ä»¬åŠªåŠ›ä½¿å®ƒå…·æœ‰æœ€å¤§çš„ç‹¬ç«‹æ€§å’Œå¼€æ”¾æ€§ï¼šä¸å…·ä½“çš„ç¼–ç¨‹è¯­è¨€æ— å…³ï¼Œä¸å…·ä½“çš„æ•°æ®åº“ç³»ç»Ÿæ— å…³ï¼Œä¸å…·ä½“çš„æ“ä½œç³»ç»Ÿæ— å…³ã€‚
  
ç®€å•çš„è¯´å°±æ˜¯æˆ‘çš„qtä¸­å«æœ‰ODBCçš„é©±åŠ¨ï¼š
  
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/6183365bcea5b3d21ff316c18632b9df.png)
  
æ‰€ä»¥åˆ©ç”¨ODBCå»ä½¿ç”¨MySQLçš„æ•°æ®åº“

### 2.1ï¼šä¸‹è½½ODBC

[å®˜ç½‘](https://dev.mysql.com/downloads/connector/odbc/)

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/4edd13a0af9c444d48c36ba0b976bbe7.png)

> é€‰æ‹©å’Œqtç¼–è¯‘å™¨ç›¸åŒçš„å­—èŠ‚æ¯”å¦‚æˆ‘çš„qtä½¿ç”¨çš„æ˜¯64å­—èŠ‚çš„

ä¸‹è½½å®Œæˆåï¼Œç‚¹å¡ä¸‹è½½ä¸‹æ¥çš„
`.msi`
æ–‡ä»¶å¹¶è¿è¡Œï¼š

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/bc5b29092d5d8f0f809c4500431e4c29.png)
  
ä¸‹è½½ä¸€ç›´ç‚¹å‡»
`next`
ï¼š
  
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/680afba31875409819f234978a55aea4.png)

é€‰æ‹©
`custom`
,è¡¨ç¤ºè‡ªå®šä¹‰å®‰è£…ï¼ˆä»¥ä¾¿ä¿®æ”¹å®‰è£…ä½ç½®ï¼‰

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/c0efc6a051cff19e8706dd97eb72182d.png)
  
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/3af118316d47692ec28ce531c27e21ca.png)

æœ€åä¸€ç›´ç‚¹å‡»
`next`
ç„¶åå†
`install`
å³å¯ï¼Œç­‰å¾…å®‰è£…å¥½åå³å¯ã€‚

å®‰è£…å¥½ä¹‹åï¼Œå…³é—­çª—å£ï¼Œæœç´¢
`ODBC`
,å¹¶è¿è¡Œç¨‹åºï¼š
  
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/796a98b8518b1094bc6f511ad8155bdb.png)

### 2.2ï¼šä½¿ç”¨ODBCè¿æ¥MySQLæ•°æ®åº“

æ·»åŠ MySQLçš„DSN

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/4bde30100e848277db26e14206876fd3.png)

çº¢è‰²çš„å¯ä»¥éšä¾¿å¡«,æ˜¯è‡ªå·±å¯¹äºODBCé©±åŠ¨çš„æè¿°,ç²‰è‰²çš„æ˜¯MySQLçš„ç”¨æˆ·åå’Œå¯†ç ,æ•°æ®åº“é€‰æ‹©ä½ åœ¨MySQLä¸­åˆ›å»ºçš„æ•°æ®åº“åå­—å³å¯ï¼š
  
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/64bd94efb5544bb4c827047a74bd494a.png)

ç‚¹å‡»
`Test`
ï¼Œæµ‹è¯•æ˜¯å¦èƒ½å¤ŸæˆåŠŸè¿æ¥ï¼›å¦‚æœå‡ºç°ä¸‹å›¾è¯´æ˜è¿æ¥æˆåŠŸ

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/a0b9191bbb5cf0a2973442a939535f34.png)

ç„¶åç‚¹å‡»
`åº”ç”¨`
å’Œ
`ç¡®å®š`
è¿›è¡Œæ·»åŠ ï¼š
  
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/5f6904874b87d80068425855122cd9cc.png)

### 2.3ï¼šqté€šè¿‡ODBCè¿æ¥MySQL

ç°åœ¨
`main.cpp`
ä¸­åŠ å…¥ä¸‹é¢ä»£ç æµ‹è¯•ä¸€ä¸‹èƒ½ä¸èƒ½åœ¨qtä¸­è¿æ¥æˆåŠŸï¼š

```cpp
QSqlDatabase db = QSqlDatabase::addDatabase("QODBC");
    db.setHostName("127.0.0.1");
    db.setPort(3306);
    db.setDatabaseName("æ˜¯ä½ åœ¨ODBCä¸­åˆ›å»ºçš„Dataã€€sourceã€€ï½ï½ï½ï½…");
    db.setUserName("ç”¨æˆ·å");
    db.setPassword("å¯†ç ");
    bool ok = db.open();
    if (ok){
        QMessageBox::information(this, "infor", "success");
    }
    else {
        QMessageBox::information(this, "infor", "open failed");
        qDebug()<<"error open database because"<<db.lastError().text();
    }


```

Tips:è¿™é‡Œå¯èƒ½ä¼šæŠ¥é”™ï¼šVS2019 C1083 æ— æ³•æ‰“å¼€åŒ…æ‹¬æ–‡ä»¶: â€œQSqlDatabaseâ€

æ˜¯vsé‡Œé¢é¡¹ç›®é…ç½®çš„é—®é¢˜ã€‚
  
çœ‹åˆ°è¿™ä¸ªé”™è¯¯åº”è¯¥æ˜¯æ²¡æœ‰dllï¼Œç„¶åsqlå¾ˆå®¹æ˜“æƒ³åˆ°æ•°æ®åº“ï¼Œæ‰€ä»¥åœ¨qtæ¨¡å—é‡Œæ·»åŠ ï¼Œæ¯”è¾ƒæ–¹ä¾¿ã€‚
  
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/64646509d6dff35c680e7b5aae339ccf.png)
  
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/a834a6dbadb2f1e66f8ddcfe19006e54.png)

ä¸å‡ºæ„å¤–è¿è¡Œç¨‹åºå¯ä»¥æˆåŠŸè¿æ¥ï¼š
  
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/40c136332a61f703a239bf9eadd94f8c.png)

> ä¹‹ååœ¨ä¸»æœºè¿›è¡Œå®‰è£…æ—¶ï¼Œé™¤äº†æ‰“åŒ…ç¨‹åºï¼Œåº”è¯¥è¿˜éœ€è¦å®‰è£…å¯¹åº”çš„Mysqlå’ŒODBC

### 2.4ï¼šqté€šè¿‡ODBCæ“ä½œæ•°æ®åº“

è¿æ¥ä¸Šæ•°æ®åº“ä¸€èˆ¬å°±æ˜¯ä½¿ç”¨æ•°æ®åº“ï¼Œè¿›è¡Œå¯¹æ•°æ®åº“çš„å¢åˆ æ”¹æŸ¥ã€‚
  
è¿™é‡Œæœ‰ä¸‰ç§æ–¹æ³•ã€‚

#### 2.4.0ï¼šå‰è¨€

ğŸª§
**é¦–å…ˆå•ç‹¬å»ºç«‹ä¸€ä¸ªå¤´æ–‡ä»¶æ¥å¤„ç†æ•°æ®åº“è¿æ¥ï¼Œå¦‚å»ºç«‹å¤´æ–‡ä»¶
`connection.h`
:**

```cpp
#ifndef CONNECTION_H
#define CONNECTION_H

#include <QMessageBox>
#include <QSqlDatabase>
#include <QSqlQuery>
#include <QDebug>

static bool createConnection(){
    //è¿æ¥ç¬¬ä¸€ä¸ªæ•°æ®åº“
    //QMYSQL
    QSqlDatabase db = QSqlDatabase::addDatabase("QMYSQL", "connection1");//éœ€è¦ä½¿ç”¨çš„æ•°æ®åº“é©±åŠ¨å’Œè”æ£€å»ºç«‹çš„åç§°ï¼ˆæ–¹ä¾¿å»ºç«‹å¤šä¸ªæ•°æ®åº“è¿æ¥ã€ä½¿ç”¨ä¸åŒçš„æ•°æ®åº“æ—¶ã€‘åŒºåˆ†ï¼‰
    db.setHostName("127.0.0.1");//è¿æ¥åœ°å€
    db.setUserName("root");//æ•°æ®åº“è´¦æˆ·
    db.setPassword("root");//å¯†ç 
    db.setPort(8889);//ç«¯å£
    //test_majiang.db
    db.setDatabaseName("test_majiang");//éœ€è¦ç”¨åˆ°çš„æ•°æ®åº“

    if (!db.open()) {//å¦‚æœæ•°æ®åº“è¿æ¥å¤±è´¥ï¼Œåˆ™å¼¹å‡º
        //critical(QWidget *parent, const QString &title,
        //const QString &text,
        //QMessageBox::StandardButtons buttons = Ok,
        //QMessageBox::StandardButton defaultButton = NoButton)
           QMessageBox::critical(0, "Cannot open database",
                                 "Unable to establish a database connection", QMessageBox::Cancel);
           return false;
       }

    return true;
}

#endif // CONNECTION_H

```

å¦‚æœéœ€è¦ç§»é™¤ä¸€ä¸ªæ•°æ®åº“è¿æ¥ï¼Œå¯ä»¥ä½¿ç”¨:

```cpp
 QSqlDatabase::close();//å…³é—­æ•°æ®åº“
 QSqlDatabase::removeDatabase();//ç§»é™¤è¯¥è¿æ¥

```

åœ¨ Qt ä¸­ï¼ŒQSqlDatabase::close() å’Œ QSqlDatabase::removeDatabase() æ˜¯ç”¨æ¥å…³é—­å’Œç§»é™¤æ•°æ®åº“è¿æ¥çš„ã€‚è¿™ä¸¤ä¸ªå‡½æ•°é€šå¸¸ä¸€èµ·ä½¿ç”¨ï¼Œé¦–å…ˆå…³é—­æ•°æ®åº“è¿æ¥ï¼Œç„¶åç§»é™¤è¯¥è¿æ¥ã€‚è¿™æ˜¯ä¸ºäº†ç¡®ä¿èµ„æºè¢«æ­£ç¡®åœ°é‡Šæ”¾ã€‚
  
ä»¥ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œå±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨è¿™ä¸¤ä¸ªå‡½æ•°ï¼š

```cpp
#include <QSqlDatabase>

// å‡è®¾ä½ å·²ç»åˆ›å»ºäº†ä¸€ä¸ªåä¸º "MyDbConnection" çš„æ•°æ®åº“è¿æ¥

// é¦–å…ˆï¼Œå…³é—­æ•°æ®åº“è¿æ¥
QSqlDatabase db = QSqlDatabase::database("MyDbConnection");
if (db.isOpen()) {
    db.close();
}

// ç„¶åï¼Œä»è¿æ¥æ± ä¸­ç§»é™¤è¯¥è¿æ¥
QSqlDatabase::removeDatabase("MyDbConnection");

```

é‡è¦çš„æ˜¯è¦æ³¨æ„ï¼Œä½ åº”è¯¥åªåœ¨ç¡®ä¿
**æ²¡æœ‰å…¶ä»– QSqlDatabase å¯¹è±¡ä½¿ç”¨åŒä¸€ä¸ªè¿æ¥åæ—¶æ‰ç§»é™¤è¯¥æ•°æ®åº“è¿æ¥**
ã€‚è¿™æ˜¯å› ä¸º QSqlDatabase ä½¿ç”¨çš„æ˜¯
**å…±äº«è¿æ¥**
ï¼Œå³å¦‚æœä½ æœ‰å¤šä¸ª QSqlDatabase å¯¹è±¡ä½¿ç”¨ç›¸åŒçš„è¿æ¥åï¼Œå®ƒä»¬å®é™…ä¸Šæ˜¯åœ¨ä½¿ç”¨åŒä¸€ä¸ªè¿æ¥ã€‚
**å½“æœ€åä¸€ä¸ªä½¿ç”¨è¯¥è¿æ¥çš„ QSqlDatabase å¯¹è±¡è¢«é”€æ¯æˆ–å…³é—­æ—¶ï¼Œè¿æ¥æ‰ä¼šè¢«çœŸæ­£å…³é—­**
ã€‚æ‰€ä»¥åœ¨è°ƒç”¨ removeDatabase() å‰è¦ç¡®ä¿æ‰€æœ‰çš„ QSqlDatabase å¯¹è±¡éƒ½å·²ç»ä¸å†éœ€è¦è¿™ä¸ªè¿æ¥äº†

#### 2.4.1ï¼šä½¿ç”¨QSqlQuery

å¤´æ–‡ä»¶

```cpp
#include "connection.h"
#include <QVariant>
#include <QSqlDriver>
#include <QSqlRecord>
#include <QSqlField>
#include <QSqlError>

```

* ***ä½¿ç”¨æ•°æ®åº“å‰çš„å‡†å¤‡ï¼š***

```cpp
    //åˆ›å»ºæ•°æ®åº“è¿æ¥
    if(!createConnection()) return 1;//è¿”å›æƒ…å†µå¯ä»¥æ›¿æ¢ï¼Œè§†ä¸åŒæƒ…å†µè€Œå®š
	//æŒ‡å®šæŸä¸ªæ•°æ®åº“è¿æ¥
    QSqlDatabase db2 = QSqlDatabase::database("connection1");

```

* ***å¼€å§‹å¯¹æ•°æ®è¿›è¡Œæ“ä½œï¼š
    
  é¦–å…ˆåˆ›å»ºQSqlQuery å¯¹è±¡ï¼Œç„¶åè¿›è¡Œæ“ä½œã€‚***

```cpp
    QSqlQuery query2(db2);

```

* ***è¿›è¡Œåˆ›è¡¨å’Œæ’å…¥å€¼ï¼š***

```cpp
   // qDebug() << "connection2:";
   //åˆ›å»ºè¡¨ï¼Œå¹¶æ’å…¥å€¼
       query2.exec("create table student (id int primary key,"
               "name varchar(20))");
    query2.exec("insert into student values(0, 'Mike')");
    query2.exec("insert into student values(1, 'Lili')");
    query2.exec("insert into student values(2, 'Jame')");

```

* ***whereæ¡ä»¶æ›´æ–°***

```cpp
 //åˆ›å»ºæ•°æ®åº“è¿æ¥(å°†ç»“æœå†™å…¥æ•°æ®åº“ï¼‰
   if (!createConnection()) return;
   //æŒ‡å®šæŸä¸ªæ•°æ®åº“è¿æ¥
   QSqlDatabase db = QSqlDatabase::database("connection1");
   QSqlQuery query(db);
   query.prepare("UPDATE floor SET ActNutCnt = :ActNutCnt WHERE floorID = :floorID AND wtID = :wtID");

   query.bindValue(":ActNutCnt", 20);
   query.bindValue(":floorID", "F001");
   query.bindValue(":wtID", "W001");

   if (query.exec()) {
       qDebug() << "Update successful";
   }
   else {
       // æŸ¥è¯¢æ‰§è¡Œå¤±è´¥
       QSqlError error = query.lastError();
       QString errorMessage = error.text();
       QMessageBox::about(NULL, "æ•°æ®åº“é”™è¯¯", "æ£€æµ‹ç»“æœå†™å…¥å¤±è´¥ï¼š" + errorMessage);
   }
   // å…³é—­æ•°æ®åº“è¿æ¥
   db.close();


```

* ***æ‰¹é‡å¤„ç†
    
  ä¸Šé¢çš„å•æ¡æ’å…¥è¯­å¥æ˜æ˜¾æ¯”è¾ƒéº»çƒ¦ï¼Œå¯ä»¥ä½¿ç”¨æ‰¹é‡æ’å…¥æ•°æ®ï¼š***

```cpp
    query2.exec("insert into student(id,name) values(3,'Qinsong')");//å•æŒ‘æ“ä½œ

    //åç§°ç»‘å®š
    query2.prepare("insert into student(id, name) values(:id, :name)");
    int idValue = 4;
    QString nameValue = "Songjiang";
    query2.bindValue(":id", idValue);//ç»‘å®šæ•°æ®
    query2.bindValue(":name", nameValue);
    query2.exec();//æ‰§è¡Œ

    //ä½ç½®ç»‘å®š
    query2.prepare("insert into student(id, name) values(?, ?)");
    int idValue2 = 5;
    QString nameValue2 = "LingChong";
    query2.addBindValue(idValue2);//ç»‘å®šæ•°æ®
    query2.addBindValue(nameValue2);
    if(!query2.execBatch()) qDebug() <<"ä½ç½®ç»‘å®šï¼š" <<query2.lastError() <<endl;//å¦‚æœæ‰§è¡Œä¸æˆåŠŸæ‰§è¡Œ

    //æ‰¹é‡å¤„ç†
    query2.prepare("insert into student(id, name) values(?,?)");
    QVariantList ids;
    ids << 6 << 7 << 8;
    query2.addBindValue(ids);
    QVariantList names;
    names << "Qinghua" << "Nanda" << "Zhongkeda";
    query2.addBindValue(names);
    if(!query2.execBatch()) qDebug() << query2.lastError()<< endl;


```

* ***è¿›è¡ŒæŸ¥è¯¢å¹¶è¾“å‡ºæŸ¥è¯¢ç»“æœï¼š***

```cpp
    query2.exec("select * from student");//æ‰§è¡Œsqlè¯­å¥
    while(query2.next()){
        qDebug()<< query2.value(0).toInt() << query2.value(1).toString();
    }

```

```cpp
#include <QSqlQuery>
#include <QSqlError>
#include <QVariant>

// ...

QSqlQuery query;
// ä»¥SELECTè¯­å¥ä¸ºä¾‹ï¼ŒæŸ¥è¯¢ä½ æ„Ÿå…´è¶£çš„è¡¨å’Œå­—æ®µ
if (query.exec("SELECT column1, column2 FROM your_table")) {
    while (query.next()) {
        // ä½¿ç”¨value()æ–¹æ³•è·å–å­—æ®µå€¼
        QVariant column1 = query.value(0); // 0 æ˜¯ column1 çš„ç´¢å¼•
        QVariant column2 = query.value(1); // 1 æ˜¯ column2 çš„ç´¢å¼•

        // ä½ å¯ä»¥ä½¿ç”¨QVariantçš„è½¬æ¢å‡½æ•°ï¼Œä¾‹å¦‚toInt(), toString()ç­‰æ¥è·å–å…·ä½“çš„ç±»å‹
        int intValue = column1.toInt();
        QString stringValue = column2.toString();

        // æ ¹æ®ä½ çš„éœ€è¦å¤„ç†è¿™äº›æ•°æ®
        // ...
    }
} else {
    // æŸ¥è¯¢å¤±è´¥ï¼Œä½ å¯ä»¥è·å–å¹¶å¤„ç†é”™è¯¯ä¿¡æ¯
    QSqlError error = query.lastError();
    // å¤„ç†é”™è¯¯ï¼Œä¾‹å¦‚æ‰“å°é”™è¯¯æ¶ˆæ¯
    qDebug() << "Query failed:" << error.text();
}

```

* ***æŸ¥çœ‹æ•°æ®é©±åŠ¨æ”¯æŒç‰¹æ€§
    
  æŸ¥çœ‹å½“å‰æ•°æ®åº“æ˜¯å¦æ˜¯æ”¯æŒæŸç‰¹æ€§ï¼Œæ¯”å¦‚å½“å‰è®°å½•çš„ç´¢å¼•æ•°ï¼ˆå³ç»“æœæ¡æ•°ï¼‰ï¼š***

```cpp
    int numRows;
    if(db2.driver()->hasFeature(QSqlDriver::QuerySize)){//æ˜¯å¦è¯¥ç‰¹æ€§
        qDebug()<< "has feature:query size";
        numRows = query2.size();
    }else{
        qDebug() << "no feature:query size";
        query2.last();
        numRows = query2.at() + 1;//ä½¿ç”¨atï¼Œéœ€è¦ä¹‹å‰ä½¿ç”¨quey2.next()éå†æ‰€æœ‰selectæœç´¢åçš„ç»“æœ,è€Œä½¿ç”¨query2.size()åˆ™ä¸éœ€è¦
    }
    
    //æ­¤å¤„æ‰§è¡Œä¸Šé¢çš„æŸ¥è¯¢æ“ä½œï¼Œä¸‹é¢çš„æ“ä½œæ‰æœ‰æ„ä¹‰
    qDebug() << "row number: " << numRows;
    //æŒ‡å‘ç´¢å¼•ä¸º1çš„è®°å½•ï¼Œå³ç¬¬äºŒæ¡è®°å½•
    query2.seek(1);
    //è¿”å›å½“å‰ç´¢å¼•å€¼
    qDebug() << "current index:" << query2.at();
    //è·å¾—å½“å‰è¡Œçš„è®°å½•
    QSqlRecord record = query2.record();

    //è·å¾—è®°å½•ä¸­"id"å’Œ"name"ä¸¤ä¸ªå­—æ®µçš„å€¼
    int id = record.value("id").toInt();
    QString name = record.value("name").toString();
    qDebug() <<"id" << id << "name:" <<name;

    //è·å¾—ç´¢å¼•ä¸º1çš„å­—æ®µï¼Œå³ç¬¬äºŒä¸ªå­—æ®µ
    QSqlField field = record.field(1);

    //è¾“å‡ºå­—æ®µåå’Œå­—æ®µå€¼ï¼Œç»“æœä¸º"name"å’Œ"MaLiang"
    qDebug() << "second field:" << field.name()
             << "field value:" << field.value().toString();


```

* ***äº‹åŠ¡ï¼ˆä½¿æ•°æ®æ“ä½œå˜ä¸ºåŸå­æ€§ï¼‰
    
  å¦‚æœä¸­é—´æœ‰ä¸€æ­¥sqlæ“ä½œæ‰§è¡Œå‡ºé”™ï¼Œåˆ™å…¨éƒ¨sqlæ“ä½œéƒ½ä¸æ‰§è¡Œã€‚***

```cpp
    QSqlDatabase db2 = QSqlDatabase::database("connection2");
    QSqlDatabase::database().transaction();//å¼€å§‹ï¼ˆç±»ä¼¼äºmutexçº¿ç¨‹é”ï¼‰
    QSqlQuery query(db2);//æ­¤è¯­å¥å¿…é¡»åœ¨ä¸Šé¢ä¸€æ¡è¯­å¥çš„åé¢
    //æ‰§è¡Œsqlæ“ä½œ
    QSqlDatabase::database().commit();//ç»“æŸ

```

#### 2.4.2ï¼šä½¿ç”¨QSqlQueryModelæŸ¥è¯¢æ¨¡å‹

ä¼˜åŠ¿ï¼š

* è¿™æ˜¯åŸºäºsqlæŸ¥è¯¢çš„åªè¯»æ¨¡å‹ï¼Œç¼–å†™sqlè¯­å¥å˜å¾—å®¹æ˜“ã€‚

æ–‡ä»¶å¤´ï¼š

```cpp
#include <QSqlQueryModel>

```

æ ¸å¿ƒä»£ç ï¼š

```cpp
  QSqlDatabase db = QSqlDatabase::database("connection1");

    QSqlQueryModel *model = new QSqlQueryModel(this);


    model->setQuery("select * from student", db);
    model->setHeaderData(0, Qt::Horizontal, tr("å­¦å·"));
    model->setHeaderData(1, Qt::Horizontal, tr("å§“å"));
    model->setHeaderData(2, Qt::Horizontal, tr("è¯¾ç¨‹"));

    QTableView *view = new QTableView(this);
    view->setModel(model);

    setCentralWidget(view);

```

#### 2.4.3ï¼šä½¿ç”¨QSqlTableModelè¡¨æ ¼æ¨¡å‹â­

å…ˆä¸Šç»“æœ
  
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/7769c31db24143f7feffb6ac0881166b.png)

**ä¼˜åŠ¿ï¼š**

* ç¼–è¯‘çš„ä»£ç å¾ˆå®¹æ˜“é€‚åº”å…¶ä»–çš„æ•°æ®æºï¼Œä¾‹å¦‚åé¢å¦‚æœè¦ä½¿ç”¨xmlæ–‡ä»¶æ¥å­˜å‚¨æ•°æ®ï¼Œåªéœ€è¦æ›´æ¢æ•°æ®æ¨¡å‹ã€‚
* æä¾›äº†ä¸€æ¬¡åªèƒ½æ“ä½œä¸€ä¸ªsqlè¡¨çš„è¯»/å†™æ¨¡å‹ï¼Œå¯ä»¥æµè§ˆå’Œä¿®æ”¹ç‹¬ç«‹çš„sqlè¡¨ï¼Œå¹¶ä¸”åªéœ€ç¼–å†™å¾ˆå°‘çš„ä»£ç ï¼Œæ— éœ€äº†è§£sqlè¯­å¥ã€‚
* ***1 å‡†å¤‡
    
  å¤´æ–‡ä»¶ï¼š***

```cpp
#include <QSqlTableModel>

```

```cpp
    QSqlTableModel* model;//åˆ›å»ºå¯¹è±¡æŒ‡é’ˆ

```

* ***2 è¿›è¡Œæ“ä½œï¼š***

```cpp
    QSqlDatabase db = QSqlDatabase::database("connection1");
    model = new QSqlTableModel(this, db);//ç”±äºåœ¨çª—å£çš„ç±»ä¸­åˆ›å»ºå¯¹è±¡ï¼Œå› æ­¤å®ä¾‹åŒ–å¯¹è±¡æ—¶ï¼Œä½¿ç”¨thisæŒ‡é’ˆï¼ˆæŒ‡å‘æ“ä½œå‡½æ•°çš„æŒ‡é’ˆï¼‰ä½œä¸ºçˆ¶å¯¹è±¡

    model->setTable("student");
    model->select();//æ‰§è¡Œ
    //è®¾ç½®ç¼–è¾‘ç­–ç•¥
    model->setEditStrategy(QSqlTableModel::OnManualSubmit);//å¯¹æ‰€æœ‰æ¨¡å‹æ”¹å˜ç«‹å³ç”¨åˆ°æ•°æ®åº“
    ui->tableView->setModel(model);

```

* ***UIè®¾è®¡ï¼š
    
  ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/5f601beabc25dcb500a41930c144f9ae.png)***
* ***å¯¹åº”æ§½å‡½æ•°ï¼š***

```cpp
// æäº¤ä¿®æ”¹æŒ‰é’®
void MainWindow::on_pushButton_clicked()
{
    // å¼€å§‹äº‹åŠ¡æ“ä½œ
    model->database().transaction();
    if (model->submitAll()) {
        if(model->database().commit()) // æäº¤
            QMessageBox::information(this, tr("tableModel"),
                                     tr("æ•°æ®ä¿®æ”¹æˆåŠŸï¼"));
    } else {
        model->database().rollback(); // å›æ»š
        QMessageBox::warning(this, tr("tableModel"),
                             tr("æ•°æ®åº“é”™è¯¯: %1").arg(model->lastError().text()),
                             QMessageBox::Ok);
    }
}

// æ’¤é”€ä¿®æ”¹æŒ‰é’®
void MainWindow::on_pushButton_2_clicked()
{
    model->revertAll();
}

// æŸ¥è¯¢æŒ‰é’®ï¼Œè¿›è¡Œç­›é€‰
void MainWindow::on_pushButton_5_clicked()
{
    QString name = ui->lineEdit->text();

    // æ ¹æ®å§“åè¿›è¡Œç­›é€‰ï¼Œä¸€å®šè¦ä½¿ç”¨å•å¼•å·
    model->setFilter(QString("name = '%1'").arg(name));
    model->select();
}

// æ˜¾ç¤ºå…¨è¡¨æŒ‰é’®
void MainWindow::on_pushButton_6_clicked()
{
    model->setTable("student");
    model->select();
}

// æŒ‰idå‡åºæ’åˆ—æŒ‰é’®
void MainWindow::on_pushButton_7_clicked()
{
    //idå­—æ®µï¼Œå³ç¬¬0åˆ—ï¼Œå‡åºæ’åˆ—
    model->setSort(0, Qt::AscendingOrder);
    model->select();

}

// æŒ‰idé™åºæ’åˆ—æŒ‰é’®
void MainWindow::on_pushButton_8_clicked()
{
    model->setSort(0, Qt::DescendingOrder);
    model->select();

}
// åˆ é™¤é€‰ä¸­è¡ŒæŒ‰é’®
void MainWindow::on_pushButton_4_clicked()
{
    // è·å–é€‰ä¸­çš„è¡Œ
    int curRow = ui->tableView->currentIndex().row();

    // åˆ é™¤è¯¥è¡Œ
    model->removeRow(curRow);
    int ok = QMessageBox::warning(this,tr("åˆ é™¤å½“å‰è¡Œ!"),
                                  tr("ä½ ç¡®å®šåˆ é™¤å½“å‰è¡Œå—ï¼Ÿ"), QMessageBox::Yes, QMessageBox::No);
    if(ok == QMessageBox::No)
    { // å¦‚æœä¸åˆ é™¤ï¼Œåˆ™æ’¤é”€
        model->revertAll();
    } else { // å¦åˆ™æäº¤ï¼Œåœ¨æ•°æ®åº“ä¸­åˆ é™¤è¯¥è¡Œ
        model->submitAll();
    }

}
// æ·»åŠ è®°å½•æŒ‰é’®
void MainWindow::on_pushButton_3_clicked()
{
    // è·å¾—è¡¨çš„è¡Œæ•°
    int rowNum = model->rowCount();
    int id = 10;

    // æ·»åŠ ä¸€è¡Œ
    model->insertRow(rowNum);
    model->setData(model->index(rowNum, 0), id);

    // å¯ä»¥ç›´æ¥æäº¤
    //model->submitAll();
}



```

## ä¸‰ã€é¡¹ç›®å®æˆ˜

`connection.h`
æ˜¯è´Ÿè´£è¿æ¥æ•°æ®åº“å’Œåˆ›å»ºè¡¨çš„å¤´æ–‡ä»¶ï¼š

```cpp
#ifndef CONNECTION_H
#define CONNECTION_H

#include <QMessageBox>
#include <QSqlDatabase>
#include <QSqlQuery>
#include <QDebug>
#pragma execution_character_set("utf-8"); 

static bool createConnection() {
    //è¿æ¥ç¬¬ä¸€ä¸ªæ•°æ®åº“
    //QMYSQL
    QSqlDatabase db = QSqlDatabase::addDatabase("QODBC", "connection1");//éœ€è¦ä½¿ç”¨çš„æ•°æ®åº“é©±åŠ¨å’Œè”æ£€å»ºç«‹çš„åç§°ï¼ˆæ–¹ä¾¿å»ºç«‹å¤šä¸ªæ•°æ®åº“è¿æ¥ã€ä½¿ç”¨ä¸åŒçš„æ•°æ®åº“æ—¶ã€‘åŒºåˆ†ï¼‰
    db.setHostName("127.0.0.1");//è¿æ¥åœ°å€
    db.setUserName("root");//æ•°æ®åº“è´¦æˆ·
    db.setPassword("55667788");//å¯†ç 
    db.setPort(3306);//ç«¯å£
    //test.db
    db.setDatabaseName("test");//éœ€è¦ç”¨åˆ°çš„æ•°æ®åº“

    if (!db.open()) {//å¦‚æœæ•°æ®åº“è¿æ¥å¤±è´¥ï¼Œåˆ™å¼¹å‡º
        //critical(QWidget *parent, const QString &title,
        //const QString &text,
        //QMessageBox::StandardButtons buttons = Ok,
        //QMessageBox::StandardButton defaultButton = NoButton)
        QMessageBox::critical(0, "Cannot open database",
            "Unable to establish a database connection", QMessageBox::Cancel);
        return false;
    }
    else {
        QMessageBox::information(NULL, "infor", "link success");
    }
    //ä¸‹é¢æ¥åˆ›å»ºè¡¨
    //å¦‚æœMySQLæ•°æ®åº“ä¸­å·²ç»å­˜åœ¨åŒåçš„è¡¨ï¼Œåˆ™ä¸‹é¢ä»£ç ä¸ä¼šæ‰§è¡Œ
    QSqlQuery query2(db);
    
   
    // qDebug() << "connection2:";
//åˆ›å»ºè¡¨ï¼Œå¹¶æ’å…¥å€¼
    query2.exec("create table student (id int primary key,"
        "name varchar(20))");
    query2.exec("insert into student values(0, 'Mike')");
    query2.exec("insert into student values(1, 'Lili')");
    query2.exec("insert into student values(2, 'Jame')");

}

#endif // CONNECTION_H

```

`Admin`
æ˜¯æ“ä½œæ•°æ®åº“çš„ç®¡ç†ç•Œé¢ï¼š
  
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/24a4e8efcefa6c27bac8a04139210151.png)
  
`Admin.h`
:

```cpp
#pragma once

#include <QMainWindow>
#include "ui_Admin.h"
#include <QSqlTableModel>
#pragma execution_character_set("utf-8"); 

class Admin : public QMainWindow
{
	Q_OBJECT

public:
	Admin(QWidget *parent = nullptr);
	~Admin();
	QSqlTableModel* model;//åˆ›å»ºå¯¹è±¡æŒ‡é’ˆ


private:
	Ui::AdminClass ui;

private slots:
	void on_add_clicked();
	void on_modify_clicked();
	void on_del_clicked();
	void on_rollback_clicked();
	void on_show_all_clicked();
};


```

`Admin.cpp`
:

```cpp
#include "Admin.h"
#include <qmessagebox.h>
#include <QSqlDatabase>
#include <QMessageBox>
#include <qsqlerror.h>
#include "connection.h"
#include <QSqlTableModel>

Admin::Admin(QWidget *parent)
	: QMainWindow(parent)
{
	ui.setupUi(this);

	if (!createConnection()) {
		return;
	}
    QSqlDatabase db = QSqlDatabase::database("connection1");
    model = new QSqlTableModel(this, db);//ç”±äºåœ¨çª—å£çš„ç±»ä¸­åˆ›å»ºå¯¹è±¡ï¼Œå› æ­¤å®ä¾‹åŒ–å¯¹è±¡æ—¶ï¼Œä½¿ç”¨thisæŒ‡é’ˆï¼ˆæŒ‡å‘æ“ä½œå‡½æ•°çš„æŒ‡é’ˆï¼‰ä½œä¸ºçˆ¶å¯¹è±¡

    model->setTable("student");
    model->select();//æ‰§è¡Œ
    QTableView* view = new QTableView;
    view->setModel(model);

    // ä½ å¯ä»¥æ ¹æ®ä½ æ•°æ®åº“è¡¨çš„å®é™…åˆ—åè¿›è¡Œè®¾ç½®
    QHeaderView* header = view->horizontalHeader();
    header->setModel(model);
    header->setSectionResizeMode(QHeaderView::Stretch);

    // è®¾ç½®æ˜¾ç¤ºåç§°ï¼Œä»0å¼€å§‹è®¡æ•°
    model->setHeaderData(0, Qt::Horizontal, tr("åˆ—å1"));
    model->setHeaderData(1, Qt::Horizontal, tr("åˆ—å2"));
    model->setHeaderData(2, Qt::Horizontal, tr("åˆ—å3"));
    //è®¾ç½®ç¼–è¾‘ç­–ç•¥
    model->setEditStrategy(QSqlTableModel::OnManualSubmit);//å¯¹æ‰€æœ‰æ¨¡å‹æ”¹å˜ç«‹å³ç”¨åˆ°æ•°æ®åº“
    ui.tableView->setModel(model);


}

Admin::~Admin()
{}

// æ·»åŠ è®°å½•æŒ‰é’®
void Admin::on_add_clicked()
{
    // è·å¾—è¡¨çš„è¡Œæ•°
    int rowNum = model->rowCount();
    int id = 10;

    // æ·»åŠ ä¸€è¡Œ
    model->insertRow(rowNum);
    model->setData(model->index(rowNum, 0), id);

    // å¯ä»¥ç›´æ¥æäº¤
    //model->submitAll();
}

// åˆ é™¤é€‰ä¸­è¡ŒæŒ‰é’®
void Admin::on_del_clicked()
{
    // è·å–é€‰ä¸­çš„è¡Œ
    int curRow = ui.tableView->currentIndex().row();

    // åˆ é™¤è¯¥è¡Œ
    model->removeRow(curRow);
    int ok = QMessageBox::warning(this, tr("åˆ é™¤å½“å‰è¡Œ!"),
        tr("ä½ ç¡®å®šåˆ é™¤å½“å‰è¡Œå—ï¼Ÿ"), QMessageBox::Yes, QMessageBox::No);
    if (ok == QMessageBox::No)
    { // å¦‚æœä¸åˆ é™¤ï¼Œåˆ™æ’¤é”€
        model->revertAll();
    }
    else { // å¦åˆ™æäº¤ï¼Œåœ¨æ•°æ®åº“ä¸­åˆ é™¤è¯¥è¡Œ
        model->submitAll();
    }

}
// æ’¤é”€ä¿®æ”¹æŒ‰é’®
void Admin::on_rollback_clicked()
{
    model->revertAll();
}

// æäº¤ä¿®æ”¹æŒ‰é’®
void Admin::on_modify_clicked()
{
    // å¼€å§‹äº‹åŠ¡æ“ä½œ
    model->database().transaction();
    if (model->submitAll()) {
        if (model->database().commit()) // æäº¤
            QMessageBox::information(this, tr("tableModel"),
                tr("æ•°æ®ä¿®æ”¹æˆåŠŸï¼"));
    }
    else {
        model->database().rollback(); // å›æ»š
        QMessageBox::warning(this, tr("tableModel"),
            tr("æ•°æ®åº“é”™è¯¯: %1").arg(model->lastError().text()),
            QMessageBox::Ok);
    }
}
// æ˜¾ç¤ºå…¨è¡¨æŒ‰é’®
void Admin::on_show_all_clicked() {
    model->setTable("student");
    model->select();
}


```

åŠŸèƒ½æ­£å¸¸ï¼š
  
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/c563894fd0bef5cb30f2a5a31d59cfa4.png)