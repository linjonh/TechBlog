---
layout: post
title: "SICK-Ranger3源码分析断线重连"
date: 2025-03-11 03:05:42 +0800
description: "简单分析Ranger3源码断线重连的实现"
keywords: "SICK Ranger3源码分析——断线重连"
categories: ['工业相机']
tags: ['C']
artid: "146168190"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146168190
    alt: "SICK-Ranger3源码分析断线重连"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146168190
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146168190
cover: https://bing.ee123.net/img/rand?artid=146168190
image: https://bing.ee123.net/img/rand?artid=146168190
img: https://bing.ee123.net/img/rand?artid=146168190
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     SICK Ranger3源码分析——断线重连
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="_1">
     </a>
     前言
    </h2>
    <p>
     本文可在
     <a href="https://paw5zx.github.io/SICK-Ranger3-source-code-analysis-01/" rel="nofollow">
      https://paw5zx.github.io/SICK-Ranger3-source-code-analysis-01/
     </a>
     中阅读，体验更佳
    </p>
    <p>
     简单分析一下SICK Ranger3源码中断线重连的实现，这一块算是比较容易的，先择出来分析一下。
    </p>
    <p>
     代码示例仅贴出关键部分以便分析
    </p>
    <p>
     使用SDK版本为3.4.2.6
    </p>
    <p>
     断线重连官方例程：Demo_R3_callback_with_heartbeat.cpp
    </p>
    <h2>
     <a id="_11">
     </a>
     断线检测
    </h2>
    <p>
     断线重连可以划分为两步，首先检测相机断线并通知，然后用户在收到通知后进行重连操作。我们先看SICK如何实现断线检测。
    </p>
    <p>
     断线检测机制内置于SICK SDK中，由SICK SDK管理：
    </p>
    <pre><code class="prism language-cpp"><span class="token comment">// file: Ranger.cpp</span>
EXPORT_TO_DLL CAM_STATUS
<span class="token class-name">Ranger3</span><span class="token double-colon punctuation">::</span><span class="token function">connectCamera</span><span class="token punctuation">(</span>CallbackEvent_HeartBeats pCallback<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">uint32_t</span><span class="token operator">&amp;</span> microSecond<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span> any<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">try</span><span class="token punctuation">{<!-- --></span>
		<span class="token keyword">auto</span> e <span class="token operator">=</span> <span class="token function">connectCamera</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>e <span class="token operator">==</span> CAM_STATUS<span class="token double-colon punctuation">::</span>All_OK<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
            m_heartbeat_is_on <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token comment">// 开启心跳检测线程</span>
			<span class="token keyword">auto</span> _thread <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>thread<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Ranger3<span class="token double-colon punctuation">::</span>_check_HeartBeats_run<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			_thread<span class="token operator">-&gt;</span><span class="token function">detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> e<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span>
<span class="token class-name">Ranger3</span><span class="token double-colon punctuation">::</span><span class="token function">_check_HeartBeats_run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>m_heartbeat_is_on<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">__sleep1MS</span><span class="token punctuation">(</span>m_heartbeat_interval<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            Str <span class="token function">value</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 设备在线，不抛异常，反之，抛出异常</span>
            m_Param<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>m_deviceNodeMap<span class="token punctuation">,</span> <span class="token string">"DeviceTemperature"</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     可以看出，断线检测机制很简单，就是分离一个线程，循环访问相机寄存器（SICK的实现是通过定时获取设备温度访问相机寄存器），若访问不到（失败），就意味着相机已离线。
    </p>
    <p>
     {% notel purple Paw5zx注： %}
    </p>
    <p>
     {% endnotel %}
    </p>
    <h2>
     <a id="_64">
     </a>
     断线通知
    </h2>
    <p>
     断线通知机制同样内置于SICK SDK中：在检测到设备离线后，调用注册好的回调函数（注册过程将在下文介绍）
    </p>
    <pre><code class="prism language-cpp"><span class="token comment">// file: Ranger.cpp</span>
<span class="token keyword">void</span>
<span class="token class-name">Ranger3</span><span class="token double-colon punctuation">::</span><span class="token function">_check_HeartBeats_run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>m_heartbeat_is_on<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">__sleep1MS</span><span class="token punctuation">(</span>m_heartbeat_interval<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            Str <span class="token function">value</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 设备在线，不抛异常，反之，抛出异常</span>
            m_Param<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>m_deviceNodeMap<span class="token punctuation">,</span> <span class="token string">"DeviceTemperature"</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 一些资源释放操作</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token comment">// m_on_lost_function为注册好的回调函数对象</span>
            <span class="token comment">// 设备离线，访问寄存器失败，捕获异常，调用m_on_lost_function</span>
            <span class="token keyword">auto</span> _thread <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>thread<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>m_on_lost_function<span class="token punctuation">,</span> <span class="token operator">&amp;</span>m_DeviceName<span class="token punctuation">,</span> <span class="token operator">&amp;</span>m_DeviceIP<span class="token punctuation">,</span> <span class="token operator">&amp;</span>m_on_lost_mac<span class="token punctuation">,</span> <span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> m_on_lost_inputs<span class="token punctuation">)</span><span class="token punctuation">;</span>
			_thread<span class="token operator">-&gt;</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h2>
     <a id="_95">
     </a>
     重连实现
    </h2>
    <p>
     重连机制的具体实现由用户进行。在例程
     <code>
      Demo_R3_callback_with_heartbeat.cpp
     </code>
     中，由用户自定义一个回调函数（在相机离线时会被调用），回调内循环对相机进行重连操作。用户在连接相机时注册这个回调
    </p>
    <p>
     用户层代码：
    </p>
    <pre><code class="prism language-cpp"><span class="token comment">// file: Demo_R3_callback_with_heartbeat.cpp</span>

<span class="token comment">// 用户定义的回调函数，在相机断开连接时被调用</span>
<span class="token keyword">void</span> SICK_CALLBACK
<span class="token function">on_lost_device_Demo_R3_callback_with_heartbeat</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">*</span> name<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">*</span> ip<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">*</span> mac<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">*</span> msg<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span> pR3<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">auto</span> pCam <span class="token operator">=</span> <span class="token punctuation">(</span>SickCam<span class="token double-colon punctuation">::</span>Ranger3<span class="token operator">*</span><span class="token punctuation">)</span>pR3<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 根据相机对象存储的设备信息对物理相机进行重连操作，不展开说明了</span>
        <span class="token keyword">auto</span> ec <span class="token operator">=</span> pCam<span class="token operator">-&gt;</span><span class="token function">reconnectCamera</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token function">__sleep1MS</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 连接相机时注册回调</span>
<span class="token keyword">auto</span> err <span class="token operator">=</span> pCam1<span class="token operator">-&gt;</span><span class="token function">connectCamera</span><span class="token punctuation">(</span>on_lost_device_Demo_R3_callback_with_heartbeat<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> pCam1<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     在SICK SDK中，注册过程会：
    </p>
    <ul>
     <li>
      将用户注册的
      <code>
       on_lost_device_Demo_R3_callback_with_heartbeat
      </code>
      赋值给
      <code>
       m_on_lost_function
      </code>
     </li>
     <li>
      将用户传递上下文信息
      <code>
       any
      </code>
      赋值给
      <code>
       m_on_lost_inputs
      </code>
     </li>
    </ul>
    <pre><code class="prism language-cpp"><span class="token comment">// file: Ranger3.h</span>
<span class="token keyword">typedef</span> std<span class="token double-colon punctuation">::</span>function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">*</span> name<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">*</span> ip<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">*</span> mac<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">*</span> msg<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> any<span class="token punctuation">)</span><span class="token operator">&gt;</span>  CallbackEvent_HeartBeats<span class="token punctuation">;</span>

<span class="token comment">// file: Ranger.cpp</span>
<span class="token comment">/*
[in] – pCallback 当失去心跳时，将调用由用户定义的回调函数。相应的处理可以在此函数中执行。
[in] – microSecond 读取心跳的时间间隔，单位毫秒，推荐值为 10 000;
[in] – any 在失去心跳的响应函数（CallbackEvent_HeartBeats）中，该指针将作为输入参数，由用户定义。
*/</span>
EXPORT_TO_DLL CAM_STATUS
<span class="token class-name">Ranger3</span><span class="token double-colon punctuation">::</span><span class="token function">connectCamera</span><span class="token punctuation">(</span>CallbackEvent_HeartBeats pCallback<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">uint32_t</span><span class="token operator">&amp;</span> microSecond<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span> any<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">try</span><span class="token punctuation">{<!-- --></span>
		<span class="token keyword">auto</span> e <span class="token operator">=</span> <span class="token function">connectCamera</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>e <span class="token operator">==</span> CAM_STATUS<span class="token double-colon punctuation">::</span>All_OK<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            m_on_lost_function <span class="token operator">=</span> pCallback<span class="token punctuation">;</span>
			m_on_lost_inputs <span class="token operator">=</span> any<span class="token punctuation">;</span>
			<span class="token keyword">auto</span> _thread <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>thread<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Ranger3<span class="token double-colon punctuation">::</span>_check_HeartBeats_run<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			_thread<span class="token operator">-&gt;</span><span class="token function">detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> e<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     注册完毕后，当相机出现离线情况，就如
     <a href="./#%E6%96%AD%E7%BA%BF%E9%80%9A%E7%9F%A5" rel="nofollow">
      上文所述
     </a>
     ，SDK会调用注册的回调函数进行重连。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f34343732373439352f:61727469636c652f64657461696c732f313436313638313930" class_="artid" style="display:none">
 </p>
</div>


