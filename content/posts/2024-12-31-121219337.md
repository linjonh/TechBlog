---
layout: post
title: "Unity3D网络游戏实战通用服务器框架"
date: 2024-12-31 15:08:47 +0800
description: "前言网络游戏涉及客户端和服务端。服务端程序记录玩家数据，处理客户端发来的协议。本文就介绍一套通用客户"
keywords: "架设本地c# unity游戏服务器"
categories: ['网络编程', 'Unity']
tags: ['服务器', 'Unity', '3D']
artid: "121219337"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=121219337
    alt: "Unity3D网络游戏实战通用服务器框架"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=121219337
featuredImagePreview: https://bing.ee123.net/img/rand?artid=121219337
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Unity3D网络游戏实战——通用服务器框架
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="_0">
     </a>
     前言
    </h2>
    <p>
     网络游戏涉及客户端和服务端。服务端程序记录玩家数据，处理客户端发来的协议。本文就介绍一套通用客户端的实现。
     <br/>
     该框架基于Select多路复用处理网络消息，具有粘包半包处理、心跳机制等功能，还是用MySQL数据库存储玩家数据，是一套功能较完备的C#服务端程序。一般单个服务端进程可以承载数百名玩家，如果更多就需要改为分布式架构。
    </p>
    <h2>
     <a id="71_4">
     </a>
     7.1服务端架构
    </h2>
    <p>
     服务端两大核心是处理客户端的消息和存储玩家数据。
     <br/>
     客户端与服务端通过TCP连接，使两者可以传递数据，服务端还连接着MySQL数据库，可将玩家数据保存到数据库中。
    </p>
    <h3>
     <a id="712_7">
     </a>
     7.1.2模块划分
    </h3>
    <ul>
     <li>
      逻辑层：消息处理，事件处理，存储结构。
     </li>
     <li>
      网络底层：连接客户端，消息处理，事件处理
     </li>
     <li>
      数据库底层：连接数据库，存储结构。
     </li>
    </ul>
    <h2>
     <a id="72Json_13">
     </a>
     7.2Json编码解码
    </h2>
    <p>
     和客户端不同的是，因为服务端程序和Unity无关，无法使用JsonUtility，所以改用System.Web提供的方法实现。(需要手动引用System.web.Extensions)
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/d218f37f42cb363c445de63ede0cfb59.png"/>
    </p>
    <p>
     新建一个控制台程序，将协议文件全部放在
     <strong>
      proto
     </strong>
     下。
    </p>
    <h3>
     <a id="723MsgBase_18">
     </a>
     7.2.3修改MsgBase
    </h3>
    <p>
     引入System.Web.Script.Serialization头文件后，和JsonUtility调用方法不同。因为JavaScriptSerializer不是静态类，需要定义一个该类型的对象，再让对象调用Serialize和Deserialize方法进行编码解码
    </p>
    <h2>
     <a id="73_21">
     </a>
     7.3网络模块
    </h2>
    <h3>
     <a id="731_22">
     </a>
     7.3.1整体架构
    </h3>
    <ul>
     <li>
      协议解析
     </li>
     <li>
      处理select多路复用的网络管理器NetManager（核心）
     </li>
     <li>
      定义客户端信息ClientState类
     </li>
     <li>
      处理网络消息的MsgHandler类，但是把不同消息类型的处理分拆到多个文件中。（BattleMsgHandler处理战斗协议、SysMsgHandler处理ping、pong协议）
     </li>
     <li>
      事件处理类EventHandler
     </li>
    </ul>
    <h3>
     <a id="732ClientState_30">
     </a>
     7.3.2ClientState
    </h3>
    <p>
     客户端信息，每一个客户端连接对应一个ClientState，含有与客户端连接的套接字socket和读缓冲区readBuff，以及对应的玩家数据和最后一次收到ping的时间。
    </p>
    <pre><code class="prism language-csharp"><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Net<span class="token punctuation">.</span>Sockets</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClientState</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">public</span> <span class="token class-name">Socket</span> socket<span class="token punctuation">;</span> 
	<span class="token keyword">public</span> <span class="token class-name">ByteArray</span> readBuff <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token comment">//Ping</span>
	<span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">long</span></span> lastPingTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token comment">//玩家</span>
	<span class="token keyword">public</span> <span class="token class-name">Player</span> player<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="733_45">
     </a>
     7.3.3开启监听和多路复用
    </h3>
    <p>
     客户端和服务端的NetManager功能相似，都是处理链接、粉发消息和网络事件。
     <br/>
     但是为了管理多个连接，服务端采用了多路复用技术。
    </p>
    <pre><code class="prism language-csharp"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">StartLoop</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> listenPort<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token comment">//Socket</span>
		listenfd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Socket</span><span class="token punctuation">(</span>AddressFamily<span class="token punctuation">.</span>InterNetwork<span class="token punctuation">,</span>
			SocketType<span class="token punctuation">.</span>Stream<span class="token punctuation">,</span> ProtocolType<span class="token punctuation">.</span>Tcp<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//Bind</span>
		<span class="token class-name">IPAddress</span> ipAdr <span class="token operator">=</span> IPAddress<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token string">"0.0.0.0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">IPEndPoint</span> ipEp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">IPEndPoint</span><span class="token punctuation">(</span>ipAdr<span class="token punctuation">,</span> listenPort<span class="token punctuation">)</span><span class="token punctuation">;</span>
		listenfd<span class="token punctuation">.</span><span class="token function">Bind</span><span class="token punctuation">(</span>ipEp<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//Listen</span>
		listenfd<span class="token punctuation">.</span><span class="token function">Listen</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"[服务器]启动成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//循环</span>
		<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">ResetCheckRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//重置checkRead</span>
			Socket<span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>checkRead<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//检查可读对象</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> checkRead<span class="token punctuation">.</span>Count <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token class-name">Socket</span> s <span class="token operator">=</span> checkRead<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> listenfd<span class="token punctuation">)</span>
				<span class="token punctuation">{<!-- --></span>
					<span class="token function">ReadListenfd</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">else</span>
				<span class="token punctuation">{<!-- --></span>
					<span class="token function">ReadClientfd</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			<span class="token comment">//超时</span>
			<span class="token function">Timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
</code></pre>
    <p>
     服务端开启了端口监听后，进入循环。针对Select返回的列表，程序遍历它判断有新的客户端连接还是某个客户端发来消息，然后分别调用处理函数ReadListenfd和ReadClientfd。
     <br/>
     当程序在Select有可读事件和超时都会调用Timer，空闲状态每秒调用一次。
    </p>
    <p>
     处理监听消息以及处理客户端消息和前面写的都差不多，就不详细介绍了。
    </p>
    <h2>
     <a id="74_90">
     </a>
     7.4心跳机制
    </h2>
    <p>
     我们在前面的clientstate已经加入了lastpingtime，注意是long，游戏客户端只运行几小时，unity提供的Time.time即可记录。但是服务端可能运行纪念，所以要用long保存。
    </p>
    <h3>
     <a id="742_92">
     </a>
     7.4.2时间戳
    </h3>
    <p>
     时间戳是一种记录时间的方法，也就是1970年1月1日零点到现在的秒数。
    </p>
    <pre><code class="prism language-csharp"><span class="token comment">//获取时间戳</span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">long</span></span> <span class="token function">GetTimeStamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token class-name">TimeSpan</span> ts <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>UtcNow <span class="token operator">-</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">DateTime</span><span class="token punctuation">(</span><span class="token number">1970</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> Convert<span class="token punctuation">.</span><span class="token function">ToInt64</span><span class="token punctuation">(</span>ts<span class="token punctuation">.</span>TotalSeconds<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="743MsgPing_103">
     </a>
     7.4.3回应MsgPing协议
    </h3>
    <p>
     更新lastPingTime并回应
    </p>
    <pre><code class="prism language-csharp"><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">partial</span> <span class="token keyword">class</span> <span class="token class-name">MsgHandler</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">MsgPing</span><span class="token punctuation">(</span><span class="token class-name">ClientState</span> c<span class="token punctuation">,</span><span class="token class-name">MsgBase</span> msgBase<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"MsgPing"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        c<span class="token punctuation">.</span>lastPingTime <span class="token operator">=</span> NetManager<span class="token punctuation">.</span><span class="token function">GetTimeStamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MsgPong</span> msgPong <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MsgPong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        NetManager<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> msgPong<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="744_120">
     </a>
     7.4.4超时处理
    </h3>
    <p>
     遍历客户端连接，太久没收到就断开连接，并删除clients列表元素。注意这是在遍历clients，删除后再遍历会出错，所以直接break。每次checkping最多断开一个连接。
     <br/>
     在ontimer中调用，ontimer是在timer里通过反射调用，timer在startloop里调用
    </p>
    <pre><code class="prism language-csharp"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">CheckPing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//Ping检查</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">CheckPing</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//现在的时间戳</span>
        <span class="token class-name"><span class="token keyword">long</span></span> timeNow <span class="token operator">=</span> NetManager<span class="token punctuation">.</span><span class="token function">GetTimeStamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//遍历，删除</span>
        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name">ClientState</span> s <span class="token keyword">in</span> NetManager<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>Values<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>timeNow <span class="token operator">-</span> s<span class="token punctuation">.</span>lastPingTime <span class="token operator">&gt;</span> NetManager<span class="token punctuation">.</span>pingInterval <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Ping Close "</span> <span class="token operator">+</span> s<span class="token punctuation">.</span>socket<span class="token punctuation">.</span>RemoteEndPoint<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                NetManager<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
    <h2>
     <a id="75_148">
     </a>
     7.5玩家的数据结构
    </h2>
    <h3>
     <a id="752Player_149">
     </a>
     7.5.2Player
    </h3>
    <p>
     我们需要Player和PlayerData，Player里有id、socket，playerdata（存入数据库），临时坐标（无需存入数据库）
    </p>
    <pre><code class="prism language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PlayerData</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//金币</span>
    <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">int</span></span> coin <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">//记事本</span>
    <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">string</span></span> text <span class="token operator">=</span> <span class="token string">"new text"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <pre><code class="prism language-csharp"><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Linq</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Text</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Player</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//id</span>
    <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">string</span></span> id <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
    <span class="token comment">//指向ClientState</span>
    <span class="token keyword">public</span> <span class="token class-name">ClientState</span> state<span class="token punctuation">;</span>
    <span class="token comment">//临时数据，如：坐标</span>
    <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">int</span></span> x<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">int</span></span> y<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">int</span></span> z<span class="token punctuation">;</span>
    <span class="token comment">//数据库数据</span>
    <span class="token keyword">public</span> <span class="token class-name">PlayerData</span> data<span class="token punctuation">;</span>

    <span class="token comment">//construct</span>
    <span class="token keyword">public</span> <span class="token function">Player</span><span class="token punctuation">(</span><span class="token class-name">ClientState</span> state<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> state<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//发送消息</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Send</span><span class="token punctuation">(</span><span class="token class-name">MsgBase</span> msgBase<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        NetManager<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> msgBase<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>相互引用

</code></pre>
    <h3>
     <a id="753PlayerManager_194">
     </a>
     7.5.3PlayerManager
    </h3>
    <p>
     用id作为player(字典)的key来获取player，而不是ip+port，因为随时会变。
     <br/>
     NetManager.clients保存所有客户端信息(ClientState)，PlayerManager.players保存所有玩家对象(player)，客户端信息通过clientState.player引用玩家对象，玩家对象通过player.state引用客户端信息，两者相互引用配合。
    </p>
    <h2>
     <a id="76MySQL_198">
     </a>
     7.6配置MySQL数据库
    </h2>
    <p>
     两部分
    </p>
    <ol>
     <li>
      安装和启动MySQL服务器，让它监听某个端口
     </li>
     <li>
      使用第三方库编码和解码MySQL特定形式的协议
     </li>
    </ol>
    <h3>
     <a id="761MySQL_203">
     </a>
     7.6.1安装并启动MySQL数据库
    </h3>
    <p>
     这里安装配置好的集成环境
     <a href="https://xampp-windows.en.softonic.com/" rel="nofollow">
      xampp
     </a>
    </p>
    <blockquote>
     <p>
      XAMPP是apache 、mysql、PHP 的集成的web 服务器软件
     </p>
    </blockquote>
    <p>
     简单地说就是个数据库服务器！
     <br/>
     安装完成后点击MySQL后方的Start按钮即可。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/587ba765c3e03a22231460444419a2c4.png"/>
    </p>
    <h3>
     <a id="762Navicat_for_MySQL_212">
     </a>
     7.6.2Navicat for MySQL
    </h3>
    <p>
     这是一套专为MySQL数据库服务的管理工具，可以用它建立数据库并查看数据表的内容，比直接使用MySQL的命令行语句方便。
     <br/>
     安装好点击连接，新建连接，填入MySQL数据库的IP、端口用户名和密码，登陆数据库。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/d2e84c6d27d17bf70c8b499bafdc429c.png">
      <br/>
      在这里我们自己创建game库，下面包含account和player两个表，分别记录id和password以及id和playerdata（都将键长度为20的id作为主键）。账号和游戏数据分开的好处是，一个账号可对应多个游戏的数据。
     </img>
    </p>
    <h3>
     <a id="764connector_217">
     </a>
     7.6.4安装connector
    </h3>
    <p>
     为解析MySQL的网络数据，我们需要引用connector这个第三方库，可以直接从书中资源下载。
     <br/>
     添加MySql.Data.dll和System.Data.dll的依赖。
    </p>
    <h2>
     <a id="77_221">
     </a>
     7.7数据库模块
    </h2>
    <p>
     在服务端编写DbManager.cs，用于处理数据库相关事务。提供从数据库读取玩家数据、将玩家数据保存到数据库、注册、检测密码是否正确等功能。
     <br/>
     因为connector的.Net Framework版本是4.5.2，所以我们需要将服务端程序的框架也改为这个，防止引用不到MySql.Data。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/840cc8a9c0cf0abc845080f51394d6ee.png"/>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/781cf7b76dcbc1c9f2baed5c29b233ab.png"/>
    </p>
    <h3>
     <a id="771_227">
     </a>
     7.7.1连接数据库
    </h3>
    <p>
     连接MySQL第一步就是发起对数据库的网络连接。connector封装了所有与数据库交互的方法。
     <br/>
     在引用"MySql.Data.MySqlClient"后，新建一个MySQL连接对象，设置数据库、用户名、密码后调用Open即可发起连接。
     <br/>
     该连接对象和socket相似，我们将数据库名、数据库IP、数据库端口号及用户名密码等组装成ConnectionString所需的格式再调用open即可。
    </p>
    <pre><code class="prism language-csharp"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">MySqlConnection</span> mysql<span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token class-name">JavaScriptSerializer</span> Js <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JavaScriptSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//用于调用一些序列化方法的对象</span>

    <span class="token comment">//连接mysql数据库</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token function">Connect</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> db<span class="token punctuation">,</span><span class="token class-name"><span class="token keyword">string</span></span> ip<span class="token punctuation">,</span><span class="token class-name"><span class="token keyword">int</span></span> port<span class="token punctuation">,</span><span class="token class-name"><span class="token keyword">string</span></span> user<span class="token punctuation">,</span><span class="token class-name"><span class="token keyword">string</span></span> pw<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//创建mysqlconnection对象</span>
        mysql <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MySqlConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//连接参数</span>
        <span class="token class-name"><span class="token keyword">string</span></span> s <span class="token operator">=</span> <span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">"Database={0}; Data Source={1}; port={2}; User Id={3}; Password={4}"</span><span class="token punctuation">,</span> db<span class="token punctuation">,</span> ip<span class="token punctuation">,</span> port<span class="token punctuation">,</span> user<span class="token punctuation">,</span> pw<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mysql<span class="token punctuation">.</span>ConnectionString <span class="token operator">=</span> s<span class="token punctuation">;</span>
        <span class="token comment">//连接</span>
        <span class="token keyword">try</span>
        <span class="token punctuation">{<!-- --></span>
            mysql<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"[数据库] Connect succ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"[数据库] Connect fail"</span> <span class="token operator">+</span> e<span class="token punctuation">.</span>Message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
    <p>
     先开启数据库服务器，再开启服务端程序，就可以显示连接成功。
    </p>
    <h3>
     <a id="712SQL_260">
     </a>
     7.1.2防止SQL注入
    </h3>
    <p>
     SQL注入，就是通过输入请求，把SQL命令插入到SQL语句中，已达到欺骗服务期执行恶意SQL命令的目的。比如取一个"xiaoming;delete * from player;"的名字，这样就会在操作这条用户名的时候删除player表。
     <br/>
     所以为了防止SQL注入，我们把含有逗号、分号等特殊字符的字符串判定为不安全字符串，在拼装SQL语句前就进行安全监测。
    </p>
    <pre><code class="prism language-csharp"><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Text<span class="token punctuation">.</span>RegularExpressions</span><span class="token punctuation">;</span>
<span class="token comment">//判定安全字符串</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token function">IsSafeString</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> str<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token operator">!</span>Regex<span class="token punctuation">.</span><span class="token function">IsMatch</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token string">@"[-|;|,|\/|\(|\)|\[|\]|\}|]{|%|@|\*|!\']"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="773IsAccountExist_273">
     </a>
     7.7.3IsAccountExist
    </h3>
    <p>
     注册账号时判断账号是否已存在，不能再次注册。MySqlDataReader提供遍历数据集的方法，HasRows指明数据及是否包含数据。
    </p>
    <pre><code class="prism language-csharp"><span class="token comment">//是否存在该用户</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token function">IsAccountExist</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> id<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//防SQL注入</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>DbManager<span class="token punctuation">.</span><span class="token function">IsSafeString</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//SQL语句</span>
        <span class="token class-name"><span class="token keyword">string</span></span> s <span class="token operator">=</span> <span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">"select * from account where id='{0}';"</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//查询</span>
        <span class="token keyword">try</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">MySqlCommand</span> cmd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MySqlCommand</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> mysql<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">MySqlDataReader</span> dataReader <span class="token operator">=</span> cmd<span class="token punctuation">.</span><span class="token function">ExecuteReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">bool</span></span> hasRows <span class="token operator">=</span> dataReader<span class="token punctuation">.</span>HasRows<span class="token punctuation">;</span>
            dataReader<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">!</span>hasRows<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"[数据库] IsSafeString err,"</span> <span class="token operator">+</span> e<span class="token punctuation">.</span>Message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="774Register_303">
     </a>
     7.7.4Register
    </h3>
    <p>
     通过insert into account set id=***, pw=***向account表插入数据。
     <br/>
     但是一般不会吧明文的password存入数据库，而是先加密，比如加上md5加密，这样数据库被盗仍然不能从加密的密码获取用户信息。
    </p>
    <pre><code class="prism language-csharp"> <span class="token comment">//注册</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token function">Register</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> id<span class="token punctuation">,</span><span class="token class-name"><span class="token keyword">string</span></span> pw<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//防SQL注入</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>DbManager<span class="token punctuation">.</span><span class="token function">IsSafeString</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"[数据库] Register fail, id not safe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>DbManager<span class="token punctuation">.</span><span class="token function">IsSafeString</span><span class="token punctuation">(</span>pw<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"[数据库] Register fail, pw not safe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//能否注册</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">IsAccountExist</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"[数据库] Register fail, id exist"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//写入数据库User表</span>
        <span class="token class-name"><span class="token keyword">string</span></span> sql <span class="token operator">=</span> <span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">"insert into account set id ='{0}',pw = '{1}';"</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span> pw<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">MySqlCommand</span> cmd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MySqlCommand</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> mysql<span class="token punctuation">)</span><span class="token punctuation">;</span>
            cmd<span class="token punctuation">.</span><span class="token function">ExecuteNonQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"[数据库] Register fail"</span> <span class="token operator">+</span> e<span class="token punctuation">.</span>Message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="775CreatePlayer_342">
     </a>
     7.7.5CreatePlayer
    </h3>
    <p>
     1.将默认的PlayerData对象序列化成Json数据
     <br/>
     2.将数据保存到player表的data栏位中
    </p>
    <pre><code class="prism language-csharp"><span class="token comment">//创建角色</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token function">CreatePlayer</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> id<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//防sql注入</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>DbManager<span class="token punctuation">.</span><span class="token function">IsSafeString</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"[数据库] CreatePlayer fail, id not safe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//序列化</span>
        <span class="token class-name">PlayerData</span> playerData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">PlayerData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">string</span></span> data <span class="token operator">=</span> Js<span class="token punctuation">.</span><span class="token function">Serialize</span><span class="token punctuation">(</span>playerData<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//写入数据库</span>
        <span class="token class-name"><span class="token keyword">string</span></span> sql <span class="token operator">=</span> <span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">"insert into player set id = '{0}',data = '{1}';"</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">MySqlCommand</span> cmd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MySqlCommand</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> mysql<span class="token punctuation">)</span><span class="token punctuation">;</span>
            cmd<span class="token punctuation">.</span><span class="token function">ExecuteNonQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"[数据库] CreatePlayer err,"</span> <span class="token operator">+</span> e<span class="token punctuation">.</span>Message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="776CheckPassword_374">
     </a>
     7.7.6CheckPassword
    </h3>
    <p>
     通过select * from account where id=*** and pw= ***查询数据库，如果有数据dataReader.HasRows==true说明id和pw正确。
    </p>
    <h3>
     <a id="777GetPlayerData_377">
     </a>
     7.7.7GetPlayerData
    </h3>
    <p>
     读取玩家数据，通过id在player表中搜寻数据，player表以id为key，以字符串的形式存放着序列化后的Json数据。
     <br/>
     先用dataReader获取到对应账号的玩家数据，再将字符串反序列化PlayerData对象返回。
    </p>
    <pre><code class="prism language-csharp"><span class="token comment">//创建角色</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token function">CreatePlayer</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> id<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//防sql注入</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>DbManager<span class="token punctuation">.</span><span class="token function">IsSafeString</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"[数据库] CreatePlayer fail, id not safe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//序列化</span>
        <span class="token class-name">PlayerData</span> playerData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">PlayerData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">string</span></span> data <span class="token operator">=</span> Js<span class="token punctuation">.</span><span class="token function">Serialize</span><span class="token punctuation">(</span>playerData<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//写入数据库</span>
        <span class="token class-name"><span class="token keyword">string</span></span> sql <span class="token operator">=</span> <span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">"insert into player set id = '{0}',data = '{1}';"</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">MySqlCommand</span> cmd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MySqlCommand</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> mysql<span class="token punctuation">)</span><span class="token punctuation">;</span>
            cmd<span class="token punctuation">.</span><span class="token function">ExecuteNonQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"[数据库] CreatePlayer err,"</span> <span class="token operator">+</span> e<span class="token punctuation">.</span>Message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="778UpdatePlayerData_410">
     </a>
     7.7.8UpdatePlayerData
    </h3>
    <p>
     将玩家数据playerData序列化成字符串，然后用形如"update player set data="{“coin”:100}" where id= “lpy”;"的SQL语句更新数据库中的数据
    </p>
    <pre><code class="prism language-csharp"><span class="token comment">//保存角色</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token function">UpdatePlayerData</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> id<span class="token punctuation">,</span> <span class="token class-name">PlayerData</span> playerData<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//序列化</span>
        <span class="token class-name"><span class="token keyword">string</span></span> data <span class="token operator">=</span> Js<span class="token punctuation">.</span><span class="token function">Serialize</span><span class="token punctuation">(</span>playerData<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//sql</span>
        <span class="token class-name"><span class="token keyword">string</span></span> sql <span class="token operator">=</span> <span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">"update player set data='{0}' where id ='{1}';"</span><span class="token punctuation">,</span> data<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//更新</span>
        <span class="token keyword">try</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">MySqlCommand</span> cmd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MySqlCommand</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> mysql<span class="token punctuation">)</span><span class="token punctuation">;</span>
            cmd<span class="token punctuation">.</span><span class="token function">ExecuteNonQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"[数据库] UpdatePlayerData err, "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span>Message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
    <h2>
     <a id="78_436">
     </a>
     7.8登录注册功能
    </h2>
    <p>
     接下来用一个记事本跑通前面的流程。
    </p>
    <h3>
     <a id="781_438">
     </a>
     7.8.1注册登陆协议
    </h3>
    <p>
     LoginMsg中包含了注册、登陆和踢出三条协议，均为服务端回应客户端的，一般有result和reason说明成功与否或者失败的原因
    </p>
    <pre><code class="prism language-csharp"><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic</span><span class="token punctuation">;</span>

<span class="token comment">//注册</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MsgRegister</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">MsgBase</span></span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token function">MsgRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> protoName <span class="token operator">=</span> <span class="token string">"MsgRegister"</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token comment">//客户端发，协议内容</span>
    <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">string</span></span> id <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">string</span></span> pw <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
    <span class="token comment">//服务端回(0-成功，1-失败)</span>
    <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">int</span></span> result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//登陆</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MsgLogin</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">MsgBase</span></span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token function">MsgLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> protoName <span class="token operator">=</span> <span class="token string">"MsgLogin"</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token comment">//客户端发</span>
    <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">string</span></span> id <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">string</span></span> pw <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
    <span class="token comment">//服务端回(0-成功，1-失败)</span>
    <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">int</span></span> result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//踢下线(服务端推送)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MsgKick</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">MsgBase</span></span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token function">MsgKick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> protoName <span class="token operator">=</span> <span class="token string">"MsgKick"</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token comment">//原因(0-其他人登陆同一账号)</span>
    <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">int</span></span> reason <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
    <h3>
     <a id="783_476">
     </a>
     7.8.3注册功能
    </h3>
    <p>
     添加LoginMsgHandle.cs，在其中编写MsgHandler(partial)，先注册，再创建角色。
    </p>
    <pre><code class="prism language-csharp"><span class="token comment">//注册协议处理</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">MsgRegister</span><span class="token punctuation">(</span><span class="token class-name">ClientState</span> c<span class="token punctuation">,</span> <span class="token class-name">MsgBase</span> msgBase<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">MsgRegister</span> msg <span class="token operator">=</span> <span class="token punctuation">(</span>MsgRegister<span class="token punctuation">)</span>msgBase<span class="token punctuation">;</span>
        <span class="token comment">//注册</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>DbManager<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>id<span class="token punctuation">,</span> msg<span class="token punctuation">.</span>pw<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            DbManager<span class="token punctuation">.</span><span class="token function">CreatePlayer</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            msg<span class="token punctuation">.</span>result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{<!-- --></span>
            msg<span class="token punctuation">.</span>result <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        NetManager<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="784_497">
     </a>
     7.8.4登陆功能
    </h3>
    <ol>
     <li>
      验证密码
     </li>
     <li>
      状态判断（是否已经登陆）
     </li>
     <li>
      踢下线，后上的踢掉先上的
     </li>
     <li>
      读取playerData构建player对象，并加入到PlayerManager的列表中
     </li>
    </ol>
    <pre><code class="prism language-csharp"><span class="token comment">//登陆协议处理</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">MsgLogin</span><span class="token punctuation">(</span><span class="token class-name">ClientState</span> c<span class="token punctuation">,</span><span class="token class-name">MsgBase</span> msgBase<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">MsgLogin</span> msg <span class="token operator">=</span> <span class="token punctuation">(</span>MsgLogin<span class="token punctuation">)</span>msgBase<span class="token punctuation">;</span>
        <span class="token comment">//密码校验</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>DbManager<span class="token punctuation">.</span><span class="token function">CheckPassword</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>id<span class="token punctuation">,</span> msg<span class="token punctuation">.</span>pw<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            msg<span class="token punctuation">.</span>result <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            NetManager<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//不允许再次登陆</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>player <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            msg<span class="token punctuation">.</span>result <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            NetManager<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//如果已经登陆，踢下线</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>PlayerManager<span class="token punctuation">.</span><span class="token function">IsOnline</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//发送踢下线协议</span>
            <span class="token class-name">Player</span> other <span class="token operator">=</span> PlayerManager<span class="token punctuation">.</span><span class="token function">GetPlayer</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">MsgKick</span> msgKick <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MsgKick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            msgKick<span class="token punctuation">.</span>reason <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            other<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>msgKick<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//断开连接</span>
            NetManager<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//获取玩家数据</span>
        <span class="token class-name">PlayerData</span> playerData <span class="token operator">=</span> DbManager<span class="token punctuation">.</span><span class="token function">GetPlayerData</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>playerData <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            msg<span class="token punctuation">.</span>result <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            NetManager<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//构建player</span>
        <span class="token class-name">Player</span> player <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Player</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
        player<span class="token punctuation">.</span>id <span class="token operator">=</span> msg<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
        player<span class="token punctuation">.</span>data <span class="token operator">=</span> playerData<span class="token punctuation">;</span>
        PlayerManager<span class="token punctuation">.</span><span class="token function">AddPlayer</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>id<span class="token punctuation">,</span> player<span class="token punctuation">)</span><span class="token punctuation">;</span>
        c<span class="token punctuation">.</span>player <span class="token operator">=</span> player<span class="token punctuation">;</span>
        <span class="token comment">//返回协议</span>
        msg<span class="token punctuation">.</span>result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        player<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="789_553">
     </a>
     7.8.9客户端监听
    </h3>
    <p>
     先把服务端的两个协议文件复制到客户端中，在start进行协议的监听！
    </p>
    <pre><code class="prism language-csharp"><span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        NetManager<span class="token punctuation">.</span><span class="token function">AddEventListener</span><span class="token punctuation">(</span>NetManager<span class="token punctuation">.</span>NetEvent<span class="token punctuation">.</span>ConnectSucc<span class="token punctuation">,</span> OnConnectSucc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        NetManager<span class="token punctuation">.</span><span class="token function">AddEventListener</span><span class="token punctuation">(</span>NetManager<span class="token punctuation">.</span>NetEvent<span class="token punctuation">.</span>ConnectFail<span class="token punctuation">,</span> OnConnectFail<span class="token punctuation">)</span><span class="token punctuation">;</span>
        NetManager<span class="token punctuation">.</span><span class="token function">AddEventListener</span><span class="token punctuation">(</span>NetManager<span class="token punctuation">.</span>NetEvent<span class="token punctuation">.</span>Close<span class="token punctuation">,</span> OnConnectClose<span class="token punctuation">)</span><span class="token punctuation">;</span>
        NetManager<span class="token punctuation">.</span><span class="token function">AddMsgListener</span><span class="token punctuation">(</span><span class="token string">"MsgMove"</span><span class="token punctuation">,</span> OnMsgMove<span class="token punctuation">)</span><span class="token punctuation">;</span>
        NetManager<span class="token punctuation">.</span><span class="token function">AddMsgListener</span><span class="token punctuation">(</span><span class="token string">"MsgRegister"</span><span class="token punctuation">,</span> OnMsgRegister<span class="token punctuation">)</span><span class="token punctuation">;</span>
        NetManager<span class="token punctuation">.</span><span class="token function">AddMsgListener</span><span class="token punctuation">(</span><span class="token string">"MsgLogin"</span><span class="token punctuation">,</span> OnMsgLogin<span class="token punctuation">)</span><span class="token punctuation">;</span>
        NetManager<span class="token punctuation">.</span><span class="token function">AddMsgListener</span><span class="token punctuation">(</span><span class="token string">"MsgKick"</span><span class="token punctuation">,</span> OnMsgKick<span class="token punctuation">)</span><span class="token punctuation">;</span>
        NetManager<span class="token punctuation">.</span><span class="token function">AddMsgListener</span><span class="token punctuation">(</span><span class="token string">"MsgGetText"</span><span class="token punctuation">,</span> OnMsgGetText<span class="token punctuation">)</span><span class="token punctuation">;</span>
        NetManager<span class="token punctuation">.</span><span class="token function">AddMsgListener</span><span class="token punctuation">(</span><span class="token string">"MsgSaveText"</span><span class="token punctuation">,</span> OnMsgSaveText<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="7810_570">
     </a>
     7.8.10注册功能
    </h3>
    <pre><code class="prism language-csharp"><span class="token comment">//收到服务端发送的注册协议后，自动调用的回调方法</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnMsgRegister</span><span class="token punctuation">(</span><span class="token class-name">MsgBase</span> msgBase<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">MsgRegister</span> msg <span class="token operator">=</span> <span class="token punctuation">(</span>MsgRegister<span class="token punctuation">)</span>msgBase<span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>result <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            Debug<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">"注册成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{<!-- --></span>
            Debug<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">"注册失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//发送注册协议</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnRegisterClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">MsgRegister</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MsgRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        msg<span class="token punctuation">.</span>id <span class="token operator">=</span> idInput<span class="token punctuation">.</span>text<span class="token punctuation">;</span>
        msg<span class="token punctuation">.</span>pw <span class="token operator">=</span> pwInput<span class="token punctuation">.</span>text<span class="token punctuation">;</span>
        NetManager<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="7811_596">
     </a>
     7.8.11登陆
    </h3>
    <pre><code class="prism language-csharp"><span class="token comment">//收到服务端发送的注册协议后，自动调用的回调方法</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnMsgRegister</span><span class="token punctuation">(</span><span class="token class-name">MsgBase</span> msgBase<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">MsgRegister</span> msg <span class="token operator">=</span> <span class="token punctuation">(</span>MsgRegister<span class="token punctuation">)</span>msgBase<span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>result <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            Debug<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">"注册成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{<!-- --></span>
            Debug<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">"注册失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//发送注册协议</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnRegisterClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">MsgRegister</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MsgRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        msg<span class="token punctuation">.</span>id <span class="token operator">=</span> idInput<span class="token punctuation">.</span>text<span class="token punctuation">;</span>
        msg<span class="token punctuation">.</span>pw <span class="token operator">=</span> pwInput<span class="token punctuation">.</span>text<span class="token punctuation">;</span>
        NetManager<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f4a5f617661536d616c6c57686974652f:61727469636c652f64657461696c732f313231323139333337" class_="artid" style="display:none">
 </p>
</div>


