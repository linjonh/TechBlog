---
layout: post
title: "SOMEIP-SD-协议英文原文讲解8"
date: 2025-03-13 14:58:40 +0800
description: "这段注释解释了 **SOME/IP 服务发现（SD）客户端状态机** 中，当客户端处于 **“服务就绪（Service Ready）”** 状态时，**TTL（Time To Live，存活时间）到期** 的可能原因及其设计意图。这段描述是关于 **SOME/IP 服务发现（SD）服务器状态机** 中 **重复阶段（Repetition Phase）** 和 **主阶段（Main Phase）** 的状态转换规则。"
keywords: "SOME/IP-SD -- 协议英文原文讲解8"
categories: ['Some']
tags: ['网络协议', '网络', 'Tcp']
artid: "146229254"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146229254
    alt: "SOMEIP-SD-协议英文原文讲解8"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146229254
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146229254
cover: https://bing.ee123.net/img/rand?artid=146229254
image: https://bing.ee123.net/img/rand?artid=146229254
img: https://bing.ee123.net/img/rand?artid=146229254
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     SOME/IP-SD -- 协议英文原文讲解8
    </h1>
   </div>
   <div class="article-resource-info-box">
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <p>
     前言
     <br/>
     SOME/IP协议越来越多的用于汽车电子行业中，关于协议详细完全的中文资料却没有，所以我将结合工作经验并对照英文原版协议做一系列的文章。基本分三大块：
    </p>
    <p>
     1. SOME/IP协议讲解
    </p>
    <p>
     2. SOME/IP-SD协议讲解
    </p>
    <p>
     3. python/C++举例调试讲解
    </p>
    <hr/>
    <p>
     5.1.4.4 State Machines
     <br/>
     [PRS_SOMEIPSD_00433]
     <br/>
     Upstream requirements: RS_SOMEIPSD_00025
     <br/>
     In this section the state machines of the client and server are shown.
     <br/>
     这章节展示server和client之间的状态机
     <br/>
     -- 用来理解之前讲的规范
    </p>
    <p>
     5.1.4.4 State Machines
     <br/>
     [PRS_SOMEIPSD_00433]
     <br/>
     Upstream requirements: RS_SOMEIPSD_00025
     <br/>
     In this section the state machines of the client and server are shown.
     <br/>
     这章节展示server和client之间的状态机
     <br/>
     -- 用来理解之前讲的规范 --- 主要用来做编程指导
     <br/>
     SOME/IP Service State Machine Server is described as follows:
     <br/>
     States inside SD Server State Machine(Service) are defined as follows:
     <br/>
     • SD Server State Machine(Service)
     <br/>
     – Not Ready
     <br/>
     – Ready
     <br/>
     ∗ Initial Wait Phase
     <br/>
     · Timer Set
     <br/>
     ∗ Repetition Phase
     <br/>
     · Timer Set
     <br/>
     ∗ Main Phase
     <br/>
     · Timer Set
     <br/>
     Initial entry points of SD Server State Machine(Service) are inside the following states:
     <br/>
     • SD Server State Machine(Service)
     <br/>
     – Ready
     <br/>
     ∗ Initial Wait Phase
     <br/>
     ∗ Repetition Phase
     <br/>
     ∗ Main Phase
     <br/>
     Transitions inside SD Server State Machine(Service) are defined as follows:
     <br/>
     FROM entry point SD Server State Machine(Service)
     <br/>
     TO Not Ready
     <br/>
     WITH [ifstatus!=up_and_configured or service-status==down]
     <br/>
     FROM entry point SD Server State Machine(Service)
     <br/>
     TO Not Ready
     <br/>
     WITH [ifstatus==up_and_configured or service-status==up]
     <br/>
     FROM Not Ready
     <br/>
     TO Ready
     <br/>
     WITH if-status-changed() or service-status-changed() [ifstatus==up_and_configured and service-status==up]
     <br/>
     FROM Ready
     <br/>
     TO Not Ready
     <br/>
     WITH if-status-changed [ifstatus!=up_and_configured] /clearAllTimers()
     <br/>
     FROM Ready
     <br/>
     TO Not Ready
     <br/>
     WITH service-status==down /clearAllTimers()
     <br/>
     send(StopOfferService)
     <br/>
     FROM TimerSet
     <br/>
     OF Initial Wait Phase
     <br/>
     TO Repetition Phase
     <br/>
     WITH Timer expired /send(OfferService)
    </p>
    <p>
     **SOME/IP 服务发现（SD）服务器状态机**定义了服务在可用性和与客户端通信方面的行为。以下是基于你描述的状态机的详细解释：
    </p>
    <p>
     ---
    </p>
    <p>
     ### **SD 服务器状态机（服务）中的状态**
    </p>
    <p>
     1. **未就绪（Not Ready）**
     <br/>
     - 服务不可用，无法进行通信。
     <br/>
     - 进入此状态的条件：
     <br/>
     - 接口状态不是 `up_and_configured`（未启动并配置）。
     <br/>
     - 服务状态为 `down`（关闭）。
    </p>
    <p>
     2. **就绪（Ready）**
     <br/>
     - 服务可用，可以与客户端通信。
     <br/>
     - 包含三个阶段：
     <br/>
     - **初始等待阶段（Initial Wait Phase）**：
     <br/>
     - 设置一个计时器，延迟服务的广告启动。
     <br/>
     - **重复阶段（Repetition Phase）**：
     <br/>
     - 服务周期性地广播其可用性。
     <br/>
     - **主阶段（Main Phase）**：
     <br/>
     - 服务持续运行，等待客户端请求。
    </p>
    <p>
     ---
    </p>
    <p>
     ### **SD 服务器状态机（服务）的初始入口点**
    </p>
    <p>
     - 状态机的初始入口点位于以下状态：
     <br/>
     - **就绪（Ready）**：
     <br/>
     - 初始等待阶段（Initial Wait Phase）。
     <br/>
     - 重复阶段（Repetition Phase）。
     <br/>
     - 主阶段（Main Phase）。
    </p>
    <p>
     ---
    </p>
    <p>
     ### **SD 服务器状态机（服务）中的状态转换**
    </p>
    <p>
     1. **从入口点到未就绪（Not Ready）**：
     <br/>
     - 条件：`ifstatus != up_and_configured` 或 `service-status == down`。
     <br/>
     - 动作：无。
    </p>
    <p>
     2. **从入口点到未就绪（Not Ready）**：
     <br/>
     - 条件：`ifstatus == up_and_configured` 或 `service-status == up`。
     <br/>
     - 动作：无。
    </p>
    <p>
     3. **从未就绪（Not Ready）到就绪（Ready）**：
     <br/>
     - 条件：`if-status-changed()` 或 `service-status-changed()`，且 `ifstatus == up_and_configured` 且 `service-status == up`。
     <br/>
     - 动作：无。
    </p>
    <p>
     4. **从就绪（Ready）到未就绪（Not Ready）**：
     <br/>
     - 条件：`if-status-changed` 且 `ifstatus != up_and_configured`。
     <br/>
     - 动作：清除所有计时器（`clearAllTimers()`）。
    </p>
    <p>
     5. **从就绪（Ready）到未就绪（Not Ready）**：
     <br/>
     - 条件：`service-status == down`。
     <br/>
     - 动作：清除所有计时器（`clearAllTimers()`）并发送 `StopOfferService` 消息。
    </p>
    <p>
     6. **从初始等待阶段（Initial Wait Phase）的计时器设置（TimerSet）到重复阶段（Repetition Phase）**：
     <br/>
     - 条件：计时器到期（`Timer expired`）。
     <br/>
     - 动作：发送 `OfferService` 消息。
    </p>
    <p>
     FROM TimerSet
     <br/>
     OF Repetition Phase
     <br/>
     TO TimerSet
     <br/>
     OF Repetition Phase
     <br/>
     WITH receive(FindService) /waitAndSend(OfferService) ResetTimer()
     <br/>
     FROM TimerSet
     <br/>
     OF Repetition Phase
     <br/>
     TO TimerSet
     <br/>
     OF Repetition Phase
     <br/>
     WITH Timer expired [run&lt;REPETITIONS_MAX] /send(OfferService)
     <br/>
     run++ setTimer((2ˆrun)*REPETITIONS_BASE_DELAY
     <br/>
     FROM TimerSet
     <br/>
     OF Repetition Phase
     <br/>
     TO Main Phase
     <br/>
     WITH Timer expired [run==REPETITIONS_MAX]
     <br/>
     FROM entry point Ready
     <br/>
     TO Initial Wait Phase
     <br/>
     FROM entry point Initial Wait Phase
     <br/>
     TO Timer Set
     <br/>
     OF Initial Wait Phase
     <br/>
     WITH SetTimerInRange(INITIAL_DELAY_MIN,INITIAL_DELAY_MAX)
     <br/>
     FROM entry point Repetition Phase
     <br/>
     TO Timer Set
     <br/>
     OF Repetition Phase
     <br/>
     WITH [REPETITIONS_MAX&gt;0] /run=0 setTimer((2ˆrun)*REPETITIONS_BASE_DELAY)
     <br/>
     FROM entry point Repetition Phase
     <br/>
     TO Main Phase
     <br/>
     WITH [REPETITIONS_MAX==0]
     <br/>
     FROM entry point Main Phase
     <br/>
     TO Timer Set
     <br/>
     OF Main Phase
     <br/>
     WITH /setTimer(CYCLIC_ANNOUNCE_DELAY) send(OfferService)
     <br/>
     FROM Timer Set
     <br/>
     OF Main Phase
     <br/>
     TO Timer Set
     <br/>
     OF Main Phase
     <br/>
     WITH Timer expired /setTimer(CYCLIC_ANNOUNCE_DELAY)
     <br/>
     send(OfferService)
     <br/>
     FROM Timer Set
     <br/>
     OF Main Phase
     <br/>
     TO Timer Set
     <br/>
     OF Main Phase
     <br/>
     WITH receive(FindService) /waitAndSend(OfferService) resetTimer()
    </p>
    <p>
     这段描述是关于 **SOME/IP 服务发现（SD）服务器状态机** 中 **重复阶段（Repetition Phase）** 和 **主阶段（Main Phase）** 的状态转换规则。以下是逐条解释：
    </p>
    <p>
     ---
    </p>
    <p>
     ### **1. 重复阶段（Repetition Phase）的状态转换**
    </p>
    <p>
     #### **(1) 从重复阶段的 TimerSet 到重复阶段的 TimerSet**
     <br/>
     - **条件**：接收到 `FindService` 消息。
     <br/>
     - **动作**：
     <br/>
     - 等待并发送 `OfferService` 消息（`waitAndSend(OfferService)`）。
     <br/>
     - 重置计时器（`ResetTimer()`）。
     <br/>
     - **说明**：当客户端发送 `FindService` 请求时，服务器会立即响应 `OfferService`，并重置计时器以继续周期性广播。
    </p>
    <p>
     #### **(2) 从重复阶段的 TimerSet 到重复阶段的 TimerSet**
     <br/>
     - **条件**：计时器到期（`Timer expired`），且当前重复次数 `run` 小于最大重复次数 `REPETITIONS_MAX`。
     <br/>
     - **动作**：
     <br/>
     - 发送 `OfferService` 消息。
     <br/>
     - 增加重复次数 `run++`。
     <br/>
     - 设置新的计时器，延迟时间为 `(2^run) * REPETITIONS_BASE_DELAY`。
     <br/>
     - **说明**：在重复阶段，服务器会周期性地广播 `OfferService` 消息，每次广播的间隔时间会指数级增长（`2^run`），直到达到最大重复次数。
    </p>
    <p>
     #### **(3) 从重复阶段的 TimerSet 到主阶段（Main Phase）**
     <br/>
     - **条件**：计时器到期（`Timer expired`），且当前重复次数 `run` 等于最大重复次数 `REPETITIONS_MAX`。
     <br/>
     - **动作**：无。
     <br/>
     - **说明**：当达到最大重复次数后，状态机进入主阶段，开始稳定的周期性广播。
    </p>
    <p>
     ---
    </p>
    <p>
     ### **2. 初始入口点的状态转换**
    </p>
    <p>
     #### **(1) 从入口点 Ready 到初始等待阶段（Initial Wait Phase）**
     <br/>
     - **说明**：状态机从就绪状态进入初始等待阶段。
    </p>
    <p>
     #### **(2) 从初始等待阶段（Initial Wait Phase）到 TimerSet**
     <br/>
     - **条件**：设置计时器，延迟时间在 `INITIAL_DELAY_MIN` 和 `INITIAL_DELAY_MAX` 之间随机选择。
     <br/>
     - **动作**：设置计时器（`SetTimerInRange(INITIAL_DELAY_MIN, INITIAL_DELAY_MAX)`）。
     <br/>
     - **说明**：在初始等待阶段，服务器会随机延迟一段时间，以避免多个服务同时启动导致的网络拥塞。
    </p>
    <p>
     #### **(3) 从入口点重复阶段（Repetition Phase）到 TimerSet**
     <br/>
     - **条件**：最大重复次数 `REPETITIONS_MAX &gt; 0`。
     <br/>
     - **动作**：
     <br/>
     - 初始化重复次数 `run = 0`。
     <br/>
     - 设置计时器，延迟时间为 `(2^run) * REPETITIONS_BASE_DELAY`。
     <br/>
     - **说明**：进入重复阶段后，初始化计时器并开始周期性广播。
    </p>
    <p>
     #### **(4) 从入口点重复阶段（Repetition Phase）到主阶段（Main Phase）**
     <br/>
     - **条件**：最大重复次数 `REPETITIONS_MAX == 0`。
     <br/>
     - **动作**：无。
     <br/>
     - **说明**：如果不需要重复广播，则直接进入主阶段。
    </p>
    <p>
     ---
    </p>
    <p>
     ### **3. 主阶段（Main Phase）的状态转换**
    </p>
    <p>
     #### **(1) 从入口点主阶段（Main Phase）到 TimerSet**
     <br/>
     - **条件**：无。
     <br/>
     - **动作**：
     <br/>
     - 设置计时器，延迟时间为 `CYCLIC_ANNOUNCE_DELAY`。
     <br/>
     - 发送 `OfferService` 消息。
     <br/>
     - **说明**：进入主阶段后，服务器会以固定间隔 `CYCLIC_ANNOUNCE_DELAY` 周期性广播 `OfferService` 消息。
    </p>
    <p>
     #### **(2) 从主阶段的 TimerSet 到 TimerSet**
     <br/>
     - **条件**：计时器到期（`Timer expired`）。
     <br/>
     - **动作**：
     <br/>
     - 设置计时器，延迟时间为 `CYCLIC_ANNOUNCE_DELAY`。
     <br/>
     - 发送 `OfferService` 消息。
     <br/>
     - **说明**：在主阶段，服务器会持续以固定间隔广播 `OfferService` 消息。
    </p>
    <p>
     #### **(3) 从主阶段的 TimerSet 到 TimerSet**
     <br/>
     - **条件**：接收到 `FindService` 消息。
     <br/>
     - **动作**：
     <br/>
     - 等待并发送 `OfferService` 消息（`waitAndSend(OfferService)`）。
     <br/>
     - 重置计时器（`resetTimer()`）。
     <br/>
     - **说明**：当客户端发送 `FindService` 请求时，服务器会立即响应 `OfferService`，并重置计时器以继续周期性广播。
     <br/>
     <img alt="" height="1064" src="https://i-blog.csdnimg.cn/direct/23bb07cae8e14c9d92dd42f2663b3381.png" width="794"/>
    </p>
    <p>
     [PRS_SOMEIPSD_00435]
     <br/>
     Upstream requirements: RS_SOMEIPSD_00025
     <br/>
     SOME/IP Service State Machine Client is described as follows:
     <br/>
     States inside SD Client State Machine(Service) are defined as follows:
     <br/>
     • SD Client State Machine(Service)
     <br/>
     – Not Requested
     <br/>
     ∗ Service Not Seen
     <br/>
     ∗ Service Seen
     <br/>
     – Requested_but_not_ready
     <br/>
     – Main
     <br/>
     ∗ Service Ready
     <br/>
     ∗ Stopped
     <br/>
     – Searching for Service
     <br/>
     ∗ Initial Wait Phase
     <br/>
     · Timer Set
     <br/>
     ∗ Repetition Phase
     <br/>
     · Timer Set
     <br/>
     Initial entry points of SD Client State Machine(Service) are inside the following states:
     <br/>
     • SD Client State Machine(Service)
     <br/>
     – Not Requested
     <br/>
     • Searching for Service
     <br/>
     – Initial Wait Phase
     <br/>
     – Repetition Phase
     <br/>
     Transitions inside SD Client State Machine(Service) are defined as follows:
     <br/>
     FROM entry point SD Client State Machine(Service)
     <br/>
     TO Not Requested
     <br/>
     WITH [Service Not Requestedd]
     <br/>
     FROM entry point SD Client State Machine(Service)
     <br/>
     TO Requested_but_not_ready
     <br/>
     WITH Service Not Requested and ifstatus!=up_and_configured
     <br/>
     FROM entry point SD Client State Machine(Service)
     <br/>
     TO Searching for Service
     <br/>
     WITH Service Requested and ifstatus==up_and_configured
     <br/>
     FROM entry point Not Requested TO Service Not Seen
     <br/>
     FROM Not Requested TO Requested_but_not_ready
     <br/>
     WITH InternalServiceRequest [ifstatus!=up_and_configured]
     <br/>
     FROM Service Not Seen
     <br/>
     TO Service Seen
     <br/>
     WITH receive(OfferService) /setTimer(TTL)
     <br/>
     FROM Repetition Phase
     <br/>
     TO Stopped
     <br/>
     WITH Repetition Expired
     <br/>
     FROM Repetition Phase
     <br/>
     TO Stopped
     <br/>
     WITH receive(StopOfferService)
     <br/>
     FROM Stopped
     <br/>
     TO Service Not Seen
     <br/>
     WITH [ServiceNotRequired]
     <br/>
     FROM Service Seen
     <br/>
     TO Service Not Seen
     <br/>
     WITH if-status-changed() [ifstatus!=up_and_configured]
     <br/>
     FROM Service Seen
     <br/>
     TO Service Not Seen
     <br/>
     WITH Timer expired (TTL)
     <br/>
     FROM Repetition Phase
     <br/>
     TO Stopped
     <br/>
     WITH Repetition Expired
    </p>
    <p>
     ### **1. 客户端状态机中的状态**
    </p>
    <p>
     1. **未请求（Not Requested）**：
     <br/>
     - 客户端尚未请求服务。
     <br/>
     - 包含两个子状态：
     <br/>
     - **服务未发现（Service Not Seen）**：客户端未收到服务的 `OfferService` 消息。
     <br/>
     - **服务已发现（Service Seen）**：客户端收到了服务的 `OfferService` 消息。
    </p>
    <p>
     2. **已请求但未就绪（Requested_but_not_ready）**：
     <br/>
     - 客户端已请求服务，但服务尚未就绪（例如，网络接口未配置完成）。
    </p>
    <p>
     3. **主状态（Main）**：
     <br/>
     - 客户端已请求服务，并且服务已就绪。
     <br/>
     - 包含两个子状态：
     <br/>
     - **服务就绪（Service Ready）**：服务可用，客户端可以正常使用。
     <br/>
     - **服务停止（Stopped）**：服务不可用。
    </p>
    <p>
     4. **搜索服务（Searching for Service）**：
     <br/>
     - 客户端正在主动搜索服务。
     <br/>
     - 包含两个阶段：
     <br/>
     - **初始等待阶段（Initial Wait Phase）**：设置计时器，延迟搜索。
     <br/>
     - **重复阶段（Repetition Phase）**：周期性发送 `FindService` 请求。
    </p>
    <p>
     ---
    </p>
    <p>
     ### **2. 客户端状态机的初始入口点**
    </p>
    <p>
     - 状态机的初始入口点位于以下状态：
     <br/>
     - **未请求（Not Requested）**。
     <br/>
     - **搜索服务（Searching for Service）**：
     <br/>
     - 初始等待阶段（Initial Wait Phase）。
     <br/>
     - 重复阶段（Repetition Phase）。
    </p>
    <p>
     ---
    </p>
    <p>
     ### **3. 客户端状态机中的状态转换**
    </p>
    <p>
     #### **(1) 从入口点到未请求（Not Requested）**
     <br/>
     - **条件**：服务未被请求（`Service Not Requested`）。
     <br/>
     - **动作**：无。
    </p>
    <p>
     #### **(2) 从入口点到已请求但未就绪（Requested_but_not_ready）**
     <br/>
     - **条件**：服务未被请求（`Service Not Requested`），且网络接口未配置完成（`ifstatus != up_and_configured`）。
     <br/>
     - **动作**：无。
    </p>
    <p>
     #### **(3) 从入口点到搜索服务（Searching for Service）**
     <br/>
     - **条件**：服务已被请求（`Service Requested`），且网络接口已配置完成（`ifstatus == up_and_configured`）。
     <br/>
     - **动作**：无。
    </p>
    <p>
     #### **(4) 从未请求（Not Requested）到服务未发现（Service Not Seen）**
     <br/>
     - **说明**：初始状态为服务未发现。
    </p>
    <p>
     #### **(5) 从未请求（Not Requested）到已请求但未就绪（Requested_but_not_ready）**
     <br/>
     - **条件**：客户端内部请求服务（`InternalServiceRequest`），且网络接口未配置完成（`ifstatus != up_and_configured`）。
     <br/>
     - **动作**：无。
    </p>
    <p>
     #### **(6) 从服务未发现（Service Not Seen）到服务已发现（Service Seen）**
     <br/>
     - **条件**：接收到服务的 `OfferService` 消息。
     <br/>
     - **动作**：设置计时器（`setTimer(TTL)`），用于检查服务的存活时间（TTL）。
    </p>
    <p>
     #### **(7) 从重复阶段（Repetition Phase）到服务停止（Stopped）**
     <br/>
     - **条件**：重复阶段计时器到期（`Repetition Expired`）。
     <br/>
     - **动作**：无。
    </p>
    <p>
     #### **(8) 从重复阶段（Repetition Phase）到服务停止（Stopped）**
     <br/>
     - **条件**：接收到服务的 `StopOfferService` 消息。
     <br/>
     - **动作**：无。
    </p>
    <p>
     #### **(9) 从服务停止（Stopped）到服务未发现（Service Not Seen）**
     <br/>
     - **条件**：服务不再需要（`ServiceNotRequired`）。
     <br/>
     - **动作**：无。
    </p>
    <p>
     #### **(10) 从服务已发现（Service Seen）到服务未发现（Service Not Seen）**
     <br/>
     - **条件**：网络接口状态变化（`if-status-changed()`），且网络接口未配置完成（`ifstatus != up_and_configured`）。
     <br/>
     - **动作**：无。
    </p>
    <p>
     #### **(11) 从服务已发现（Service Seen）到服务未发现（Service Not Seen）**
     <br/>
     - **条件**：计时器到期（`Timer expired (TTL)`）。
     <br/>
     - **动作**：无。
    </p>
    <p>
     #### **(12) 从重复阶段（Repetition Phase）到服务停止（Stopped）**
     <br/>
     - **条件**：重复阶段计时器到期（`Repetition Expired`）。
     <br/>
     - **动作**：无。
    </p>
    <p>
     ---
     <br/>
     FROM Service Seen
     <br/>
     TO Service Not Seen
     <br/>
     WITH receive(StopServiceOffer)
     <br/>
     FROM Service Seen
     <br/>
     TO Service Seen
     <br/>
     FROM Service Seen
     <br/>
     TO Service Ready
     <br/>
     WITH InternalServiceRequest [ifstatus==up_and_configured]
     <br/>
     FROM Service Ready
     <br/>
     TO Service Seen
     <br/>
     WITH [ServiceNotRequest]
     <br/>
     FROM Service Ready
     <br/>
     TO Service Ready
     <br/>
     WITH receive(OfferService) /resetTimer(TTL)
     <br/>
     FROM Service Ready
     <br/>
     TO Stopped
     <br/>
     WITH receive(StopOfferService) / cancelTimer(TTL)
     <br/>
     FROM Stopped
     <br/>
     TO Service Ready
     <br/>
     WITH receive(OfferService) /resetTimer(TTL)
     <br/>
     FROM Service Ready
     <br/>
     TO Searching for Service
     <br/>
     WITH Timer expired (TTL)
     <br/>
     FROM Searching for Service
     <br/>
     TO Service Ready
     <br/>
     WITH receive(OfferService) /setTimer(TTL)
     <br/>
     FROM Searching for Service
     <br/>
     TO Requested_but_not_ready
     <br/>
     WITH if-status-changed() [ifstatus!=up_and_configured] /cancelTimer(TTL)
     <br/>
     FROM Requested_but_not_ready
     <br/>
     TO Searching for Service
     <br/>
     WITH if-status-changed() [ifstatus!=up_and_configured]
     <br/>
     FROM entry point Searching for Service
     <br/>
     TO Initial Wait Phase
     <br/>
     FROM entry point Initial Wait Phase
     <br/>
     TO Timer Set
     <br/>
     OF Initial Wait Phase
     <br/>
     WITH /setTimerInRange(INITIAL_DELAY_MIN, INITIAL_DELAY_MAX)
     <br/>
     FROM Timer Set
     <br/>
     OF Initial Wait Phase
     <br/>
     TO Repetition Phase
     <br/>
     WITH TimerExpired /send(FindService)
     <br/>
     FROM entry point Repetition Phase
     <br/>
     TO Timer Set
     <br/>
     OF Repetition Phase
     <br/>
     WITH [REPETITONS_MAX&gt;0] /run=0 setTimer((2ˆrun)*REPETITIONS_BASE_DELAY)
     <br/>
     FROM Timer Set
     <br/>
     OF Repetition Phase
     <br/>
     TO Timer Set
     <br/>
     OF Repetition Phase
     <br/>
     FROM Not Requested
     <br/>
     TO Requested_but_not_ready
     <br/>
     WITH InternalServiceRequest [ifstatus!=up_and_configured]
    </p>
    <p>
     Note: Graphical information of the SOME/IP Service State Machine Client is shown in
     <br/>
     Figure 5.17
    </p>
    <p>
     ### **1. 从服务已发现（Service Seen）到服务未发现（Service Not Seen）**
     <br/>
     - **条件**：接收到 `StopServiceOffer` 消息。
     <br/>
     - **动作**：无。
     <br/>
     - **说明**：当客户端收到服务的 `StopServiceOffer` 消息时，表示服务不再可用，客户端将状态切换为“服务未发现”。
    </p>
    <p>
     ---
    </p>
    <p>
     ### **2. 从服务已发现（Service Seen）到服务已发现（Service Seen）**
     <br/>
     - **说明**：状态保持不变。
    </p>
    <p>
     ---
    </p>
    <p>
     ### **3. 从服务已发现（Service Seen）到服务就绪（Service Ready）**
     <br/>
     - **条件**：客户端内部请求服务（`InternalServiceRequest`），且网络接口已配置完成（`ifstatus == up_and_configured`）。
     <br/>
     - **动作**：无。
     <br/>
     - **说明**：当客户端请求服务且网络接口已就绪时，状态切换到“服务就绪”。
    </p>
    <p>
     ---
    </p>
    <p>
     ### **4. 从服务就绪（Service Ready）到服务已发现（Service Seen）**
     <br/>
     - **条件**：服务不再需要（`ServiceNotRequest`）。
     <br/>
     - **动作**：无。
     <br/>
     - **说明**：当客户端不再需要服务时，状态切换回“服务已发现”。
    </p>
    <p>
     ---
    </p>
    <p>
     ### **5. 从服务就绪（Service Ready）到服务就绪（Service Ready）**
     <br/>
     - **条件**：接收到 `OfferService` 消息。
     <br/>
     - **动作**：重置计时器（`resetTimer(TTL)`）。
     <br/>
     - **说明**：当客户端收到服务的 `OfferService` 消息时，重置服务的存活时间计时器（TTL）。
    </p>
    <p>
     ---
    </p>
    <p>
     ### **6. 从服务就绪（Service Ready）到服务停止（Stopped）**
     <br/>
     - **条件**：接收到 `StopOfferService` 消息。
     <br/>
     - **动作**：取消计时器（`cancelTimer(TTL)`）。
     <br/>
     - **说明**：当客户端收到 `StopOfferService` 消息时，表示服务停止，客户端取消计时器并切换到“服务停止”状态。
    </p>
    <p>
     ---
    </p>
    <p>
     ### **7. 从服务停止（Stopped）到服务就绪（Service Ready）**
     <br/>
     - **条件**：接收到 `OfferService` 消息。
     <br/>
     - **动作**：重置计时器（`resetTimer(TTL)`）。
     <br/>
     - **说明**：当客户端再次收到 `OfferService` 消息时，重置计时器并切换到“服务就绪”状态。
    </p>
    <p>
     ---
    </p>
    <p>
     ### **8. 从服务就绪（Service Ready）到搜索服务（Searching for Service）**
     <br/>
     - **条件**：计时器到期（`Timer expired (TTL)`）。
     <br/>
     - **动作**：无。
     <br/>
     - **说明**：当服务的存活时间计时器到期时，客户端开始重新搜索服务。
    </p>
    <p>
     ---
    </p>
    <p>
     ### **9. 从搜索服务（Searching for Service）到服务就绪（Service Ready）**
     <br/>
     - **条件**：接收到 `OfferService` 消息。
     <br/>
     - **动作**：设置计时器（`setTimer(TTL)`）。
     <br/>
     - **说明**：当客户端在搜索阶段收到 `OfferService` 消息时，设置计时器并切换到“服务就绪”状态。
    </p>
    <p>
     ---
    </p>
    <p>
     ### **10. 从搜索服务（Searching for Service）到已请求但未就绪（Requested_but_not_ready）**
     <br/>
     - **条件**：网络接口状态变化（`if-status-changed()`），且网络接口未配置完成（`ifstatus != up_and_configured`）。
     <br/>
     - **动作**：取消计时器（`cancelTimer(TTL)`）。
     <br/>
     - **说明**：当网络接口未就绪时，客户端取消搜索并切换到“已请求但未就绪”状态。
    </p>
    <p>
     ---
    </p>
    <p>
     ### **11. 从已请求但未就绪（Requested_but_not_ready）到搜索服务（Searching for Service）**
     <br/>
     - **条件**：网络接口状态变化（`if-status-changed()`），且网络接口已配置完成（`ifstatus == up_and_configured`）。
     <br/>
     - **动作**：无。
     <br/>
     - **说明**：当网络接口恢复就绪时，客户端重新开始搜索服务。
    </p>
    <p>
     ---
    </p>
    <p>
     ### **12. 从入口点搜索服务（Searching for Service）到初始等待阶段（Initial Wait Phase）**
     <br/>
     - **说明**：客户端进入搜索服务的初始等待阶段。
    </p>
    <p>
     ---
    </p>
    <p>
     ### **13. 从初始等待阶段（Initial Wait Phase）到 Timer Set**
     <br/>
     - **条件**：无。
     <br/>
     - **动作**：设置计时器，延迟时间在 `INITIAL_DELAY_MIN` 和 `INITIAL_DELAY_MAX` 之间随机选择（`setTimerInRange(INITIAL_DELAY_MIN, INITIAL_DELAY_MAX)`）。
     <br/>
     - **说明**：在初始等待阶段，客户端随机延迟一段时间，以避免多个客户端同时发送请求导致的网络拥塞。
    </p>
    <p>
     ---
    </p>
    <p>
     ### **14. 从 Timer Set（初始等待阶段）到重复阶段（Repetition Phase）**
     <br/>
     - **条件**：计时器到期（`TimerExpired`）。
     <br/>
     - **动作**：发送 `FindService` 请求。
     <br/>
     - **说明**：初始等待阶段结束后，客户端发送 `FindService` 请求并进入重复阶段。
    </p>
    <p>
     ---
    </p>
    <p>
     ### **15. 从入口点重复阶段（Repetition Phase）到 Timer Set**
     <br/>
     - **条件**：最大重复次数 `REPETITIONS_MAX &gt; 0`。
     <br/>
     - **动作**：
     <br/>
     - 初始化重复次数 `run = 0`。
     <br/>
     - 设置计时器，延迟时间为 `(2^run) * REPETITIONS_BASE_DELAY`。
     <br/>
     - **说明**：进入重复阶段后，客户端以指数级增长的间隔时间周期性发送 `FindService` 请求。
    </p>
    <p>
     ---
    </p>
    <p>
     ### **16. 从 Timer Set（重复阶段）到 Timer Set（重复阶段）**
     <br/>
     - **说明**：状态保持不变。
    </p>
    <p>
     ---
    </p>
    <p>
     ### **17. 从未请求（Not Requested）到已请求但未就绪（Requested_but_not_ready）**
     <br/>
     - **条件**：客户端内部请求服务（`InternalServiceRequest`），且网络接口未配置完成（`ifstatus != up_and_configured`）。
     <br/>
     - **动作**：无。
     <br/>
     - **说明**：当客户端请求服务但网络接口未就绪时，切换到“已请求但未就绪”状态。
    </p>
    <p>
     <img alt="" height="1041" src="https://i-blog.csdnimg.cn/direct/ce1ae892677a4af0bf248030daac46a1.png" width="927"/>
    </p>
    <p>
     Note: The most likely assumed cause for a TTL expiry while the client’s state machine resides in state "Service Ready" is the temporary (duration in the order of the
     <br/>
     CYCLIC_OFFER_DELAY or smaller) failure of an intermediate link (i.e., a link along
     <br/>
     the path from client to server which, however, is not directly connected to the client
     <br/>
     ECU and thus this link failure is not perceivable via a change in the ifstatus). Thus,
     <br/>
     the specified reaction - namely transition into "Searching for Service" state (and thus
     <br/>
     into the initial wait phase) - in case of a TTL expiry is deliberately different from the
     <br/>
     specified reactions in case of received StopOfferService entries and detected server
     <br/>
     reboots, where a transition into the "Stopped" state takes place. Transiting back into
     <br/>
     the "Searching for Service" state in case of TTL expiries caused by temporary intermediate link failures speeds up recovery by approx. a factor of 10 (depending on
     <br/>
     the configuration of the INITIAL_DELAY, the REQUEST_RESPONSE_DELAY, and the
     <br/>
     CYCLIC_OFFER_DELAY) through the explicit sending of FindService entries by the
     <br/>
     client which are answered by OfferService entries of the server (even if the server itself
     <br/>
     resides in the main phase).
     <br/>
     这段注释解释了 **SOME/IP 服务发现（SD）客户端状态机** 中，当客户端处于 **“服务就绪（Service Ready）”** 状态时，**TTL（Time To Live，存活时间）到期** 的可能原因及其设计意图。以下是详细解释：
    </p>
    <p>
     ---
    </p>
    <p>
     ### **1. TTL 到期的可能原因**
     <br/>
     - **中间链路临时故障**：
     <br/>
     - 当客户端处于“服务就绪”状态时，TTL 到期的**最可能原因**是客户端与服务器之间的**中间链路发生了临时故障**。
     <br/>
     - 这种故障的持续时间通常与 `CYCLIC_OFFER_DELAY`（周期性广播延迟）相当或更短。
     <br/>
     - 中间链路故障**不会直接导致客户端感知到网络接口状态变化（`ifstatus` 不变）**，因为故障发生在客户端 ECU（电子控制单元）之外的链路上。
    </p>
    <p>
     ---
    </p>
    <p>
     ### **2. 设计意图：TTL 到期后的状态转换**
     <br/>
     - **状态转换**：
     <br/>
     - 当 TTL 到期时，客户端会从 **“服务就绪（Service Ready）”** 状态切换到 **“搜索服务（Searching for Service）”** 状态。
     <br/>
     - 这种设计是**有意为之**，与以下两种情况不同：
     <br/>
     1. **接收到 `StopOfferService` 消息**：客户端会切换到 **“服务停止（Stopped）”** 状态。
     <br/>
     2. **检测到服务器重启**：客户端也会切换到 **“服务停止（Stopped）”** 状态。
    </p>
    <p>
     - **目的**：
     <br/>
     - 通过切换到 **“搜索服务”** 状态，客户端会**主动发送 `FindService` 请求**，服务器会立即响应 `OfferService` 消息。
     <br/>
     - 这种方式可以**加快服务恢复速度**，大约提高 10 倍（具体取决于 `INITIAL_DELAY`、`REQUEST_RESPONSE_DELAY` 和 `CYCLIC_OFFER_DELAY` 的配置）。
    </p>
    <p>
     ---
    </p>
    <p>
     ### **3. 为什么切换到“搜索服务”状态能加快恢复？**
     <br/>
     - **主动发送 `FindService` 请求**：
     <br/>
     - 在 **“搜索服务”** 状态下，客户端会主动发送 `FindService` 请求，服务器会立即响应 `OfferService` 消息。
     <br/>
     - 这种方式比等待服务器周期性广播 `OfferService` 消息（`CYCLIC_OFFER_DELAY`）更快。
    </p>
    <p>
     - **避免等待周期性广播**：
     <br/>
     - 如果客户端切换到 **“服务停止”** 状态，它需要等待服务器重新广播 `OfferService` 消息，这可能会引入额外的延迟。
    </p>
    <p>
     ---
    </p>
    <p>
     ### **4. 与 `StopOfferService` 和服务器重启的区别**
     <br/>
     - **接收到 `StopOfferService` 消息**：
     <br/>
     - 表示服务器明确告知服务已停止，客户端应切换到 **“服务停止”** 状态。
    </p>
    <p>
     - **检测到服务器重启**：
     <br/>
     - 表示服务器已重启，客户端应切换到 **“服务停止”** 状态。
    </p>
    <p>
     - **TTL 到期**：
     <br/>
     - 可能是由于中间链路临时故障，客户端应切换到 **“搜索服务”** 状态以快速恢复。
    </p>
    <p>
     ---
    </p>
    <p>
     ### **5. 配置参数的影响**
     <br/>
     - **`INITIAL_DELAY`**：初始等待阶段的延迟时间。
     <br/>
     - **`REQUEST_RESPONSE_DELAY`**：客户端发送 `FindService` 请求后等待服务器响应的延迟时间。
     <br/>
     - **`CYCLIC_OFFER_DELAY`**：服务器周期性广播 `OfferService` 消息的间隔时间。
    </p>
    <p>
     这些参数的配置会影响服务恢复的速度。通过主动发送 `FindService` 请求，客户端可以绕过 `CYCLIC_OFFER_DELAY` 的等待时间，从而显著加快恢复。
    </p>
    <p>
    </p>
   </div>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f34343230393131312f:61727469636c652f64657461696c732f313436323239323534" class_="artid" style="display:none">
 </p>
</div>


