---
layout: post
title: "网络编程事件选择模型"
date: 2025-03-09 21:30:27 +0800
description: "事件选择(WSAEventSelect)  模型是另一个有用的异步 I/O  模型。和 WSAAsyncSelect  模 型类似的是，它也允许应用程序在一个或多个套接字上接收以事件为基础的网络事件通知，最 主要的差别在于网络事件会投递至一个事件对象句柄，而非投递到一个窗口例程。"
keywords: "【网络编程】事件选择模型"
categories: ['网络编程']
tags: ['网络', 'C']
artid: "146138668"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146138668
    alt: "网络编程事件选择模型"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146138668
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146138668
cover: https://bing.ee123.net/img/rand?artid=146138668
image: https://bing.ee123.net/img/rand?artid=146138668
img: https://bing.ee123.net/img/rand?artid=146138668
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     【网络编程】事件选择模型
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="IO_0">
     </a>
     十、基于I/O模型的网络开发
    </h2>
    <h3>
     <a id="109__2">
     </a>
     10.9 事件选择模型
    </h3>
    <h4>
     <a id="1001__3">
     </a>
     10.0.1 基本概念
    </h4>
    <p>
     事件选择(WSAEventSelect) 模型是另一个有用的异步 I/O 模型。和 WSAAsyncSelect 模 型类似的是，它也允许应用程序在一个或多个套接字上接收以事件为基础的网络事件通知，最 主要的差别在于网络事件会投递至一个事件对象句柄，而非投递到一个窗口例程。
    </p>
    <h4>
     <a id="1092_WSAEventSelect_5">
     </a>
     10.9.2 WSAEventSelect函数
    </h4>
    <p>
     WSAEventSelect 模型主要由函数WSAEventSelect 来实现。注意，这里用了“主要由”, 说明还有其他配套函数一起辅助来实现这个模型。
    </p>
    <p>
     后面会讲到其他函数。这里先看一下 WSAEventSelect。
    </p>
    <p>
     WSAEventSelect 函数将一个已经创建好的事件对象(由WSACreateEvent 创建)与某个套 接字关联在一起，同时注册自己感兴趣的网络事件类型。WSAEventSelect 的函数声明如下：
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">int</span> WSAAPI <span class="token function">WSAEventSelect</span><span class="token punctuation">(</span>
    SOCKET S<span class="token punctuation">,</span>
    WSAEVENT hEventObject<span class="token punctuation">,</span> <span class="token keyword">long</span> lNetworkEvents<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <ul>
     <li>
      <p>
       其中，s 是套接字描述符；
      </p>
     </li>
     <li>
      <p>
       hEventObject标识要与指定的网络事件集关联的事件对象的句 柄 ；
      </p>
     </li>
     <li>
      <p>
       INetworkEvents指定应用程序感兴趣的网络事件组合的位掩码。
      </p>
     </li>
     <li>
      <p>
       如果函数成功，那么返回值为零；否则，将返回值SOCKET_ERROR, 并且可以通过调用 WSAGetLastError来获取特定的错误号。
      </p>
     </li>
     <li>
      <p>
       与select 和 WSAAsyncSelect 函数一样，WSAEventSelect 通常用于确定何时可以进行数据 收发操作(确定调用send或 recv能立即成功的时间点)。如果时间点没到，那么函数会返回 WSAEWOULDBLOCK, 此时我们要正确处理这个错误码。
      </p>
     </li>
    </ul>
    <h4>
     <a id="1093_____WSAEventSelect_25">
     </a>
     10.9.3 实 战WSAEventSelect模型
    </h4>
    <p>
     事件选择模型的基本思路是：为感兴趣的一组网络事件创建一个事件对象，再调用 WSAEventSelect 函数将网络事件和事件对象关联起来。当网络事件发生时，Winsock 会使相 应的事件对象收到通知，在事件对象上等待的函数就会返回。之后，再调用 WSAEnumNetworkEvents函数便可获取发生了什么网络事件。
     <br/>
     事件选择模型写的TCP 服务器实现的过程如下：
    </p>
    <ul>
     <li>
      (1)创建事件对象和套接字。创建一个事件对象的方法是调用 WSACreateEvent 函数， 它的定义如下：
     </li>
    </ul>
    <pre><code class="prism language-cpp">WSAEVENT WSAAPI <span class="token function">WSACreateEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <ul>
     <li>
      <p>
       如果没有发生错误，那么函数将返回事件对象的句柄；
      </p>
     </li>
     <li>
      <p>
       否则，返回值为 WSA_INVALID_EVENT, 可以通过WSAGetLastError 函数获取更多的错误信息。这个事件对 象创建后，其初始状态为“未受信”,就是没有收到通知状态。
      </p>
     </li>
     <li>
      <p>
       WSACreateEvent 创建的事件有两种工作状态以及两种工作模式：工作状态分别是“有信 号 " (signaled) 和“无信号" (nonsignaled), 工作模式包括“人工重设” (manual reset) 和“自动重设” (auto reset) 。WSACreateEvent 创建的事件开始是处于一种无信号的工作状 态，并用一种人工重设模式来创建事件句柄。
      </p>
     </li>
     <li>
      <p>
       (2)将事件对象与套接字关联在一起，同时注册自己感兴趣的网络事件类型(FD_READ、 FD_WRITE、FD_ACCEPT、FD_CONNECT、FD_CLOSE 等),这个过程通过函数 WSAEventSelect实现。
      </p>
     </li>
     <li>
      <p>
       (3)调用事件等待函数WSAWaitForMultipleEvents在所有事件对象上等待，该函数返回后，我们就可以确认在哪些套接字上发生了网络事件。 当一个或所有指定的事件对象处于信号状态、超时或执行了 I/O 完成例程时，函数 WSAWaitForMultipleEvents返回，该函数声明如下：
      </p>
     </li>
    </ul>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;winsock2.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression"><span class="token function">comment</span><span class="token punctuation">(</span>lib<span class="token punctuation">,</span> </span><span class="token string">"Ws232.lib"</span><span class="token expression"><span class="token punctuation">)</span></span></span>
DWORD WSAAPI <span class="token function">WSAWaitForMultipleEvents</span><span class="token punctuation">(</span>DWORD CEvents<span class="token punctuation">,</span>
                                      <span class="token keyword">const</span> WSAEVENT <span class="token operator">*</span>lphEvents<span class="token punctuation">,</span> BOOL fWaitAll<span class="token punctuation">,</span>
                                      DWORD dwTimeout<span class="token punctuation">,</span>
                                      BOOL fAlertable<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <ul>
     <li>
      cEvents: 表 示lphEvent 所指数组中的事件对象句柄数，事件对象句柄的最大数量是 WSA_MAXIMUM_WAIT_EVENTS, 必须指定一个或多个事件。
     </li>
     <li>
      lphEvents: 指向事件对象句柄数组的指针，数组可以包含不同类型对象的句柄，如果 后面参数fWaitAll 设置为TRUE, 那么它不能包含同一句柄的多个副本，如果在等待 仍处于挂起状态时关闭其中一个句柄，那么WSAWaitForMultipleEvents 的行为将不 可知。另外，句柄必须具有同步访问权限。
     </li>
     <li>
      fWaitAll: 输入参数，用于指定等待类型的值。如果赋值为TRUE, 那么当lphEvents 数组中所有对象的状态都处于有信号时，函数将返回。注意，是所有对象都处于信号 状态才返回。如果赋值为FALSE, 则当向任一事件对象发出信号时，函数返回。在 这一种情况下，返回值减去WSA_WAIT_EVENT_0 表示其状态导致函数返回的事件 对象的索引。如果在调用期间有多个事件对象发出信号，那么返回值指示信号事件对 象的lphEvents 数组索引的最小值。
     </li>
     <li>
      dwTimeout: 超时时间，单位是毫秒。如果超时时间到，则函数返回，即使不满足 fWaitAll 参数指定的条件。如果 dw Timeout参数为零，则函数将测试指定事件对象的 状态并立即返回。如果dwTimeout 是 WSA_INFINITE, 则函数将永远等待。
     </li>
     <li>
      fAlertable: 指定线程是否处于可警报的等待状态，以便系统可以执行I/O 完成例程。 如果为TRUE, 则线程将处于可警报的等待状态，并且当系统执行I/O 完成例程时， 函数可以返回。在这种情况下，将返回 WSA_WAIT_IO_COMPLETION, 并且尚未 发出正在等待的事件的信号。应用程序必须再次调用WSAWaitForMultipleEvents 函 数。如果为FALSE, 则线程不会处于可警报的等待状态，也不会执行I/O 完成例程。
     </li>
    </ul>
    <p>
     如果函数成功，那么返回值为以下值之一：
    </p>
    <ul>
     <li>
      WSA_WAIT_EVEN_0 到 (WSA_WAIT_EVENT_0+cEvents-1): 如果参数 fWaitAll 参数为 TRUE, 则返回值指示已向所有指定的事件对象发出信号。如果 fWaitAll 参数为FALSE, 则返回值减去WSA_WAIT_EVENT_0 表示其状态导致函数 返回的事件对象的索引。如果在调用期间有多个事件对象发出信号，则返回值指示信 号事件对象的lphEvents 数组索引的最小值。
     </li>
     <li>
      WSA_WAIT_IO_COMPLETION:等待被执行的一个或多个I/O 完成例程结束。正在 等待的事件尚未发出信号，应用程序必须再次调用WSAWaitForMultipleEvents 函数。 只有fAlertable 参数为TRUE 时，才能返回此返回值。
     </li>
     <li>
      WSA_WAIT_TIMEOUT: 超时间隔已过，并且未满足fWaitAll参数指定的条件，未
      <br/>
      执行任何I/O完成例程。
     </li>
    </ul>
    <p>
     如果函数失败，则返回值为WSA_WAIT_FAILED。此时可以通过函数WSAGetLastError 获取更多错误码，常见错误码如下：
    </p>
    <ul>
     <li>
      <p>
       WSANOTINITIALISED: 在调用本API 之前应成功调用WSAStartup()。
      </p>
     </li>
     <li>
      <p>
       WSAENETDOWN: 网络子系统失效。
      </p>
     </li>
     <li>
      <p>
       WSA_NOT_ENOUGH_MEMORY: 无足够内存完成该操作。
      </p>
     </li>
     <li>
      <p>
       WSA_INVALID_HANDLE:lphEvents 数组中的一个或多个值不是合法的事件对象句柄。
      </p>
     </li>
     <li>
      <p>
       WSA_INVALID_PARAMETER:cEvents参数未包含合法的句柄数目。
      </p>
     </li>
     <li>
      <p>
       (4)检测所指定套接字上发生网络事件，然后处理发生的网络事件，完毕继续在事件对 象上等待。检测所指定套接字上发生网络事件是通过函数WSAEnumNetworkEvents 来实现， 该函数声明如下：
      </p>
     </li>
    </ul>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;winsock2.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression"><span class="token function">comment</span><span class="token punctuation">(</span>lib<span class="token punctuation">,</span> </span><span class="token string">"Ws232.lib"</span><span class="token expression"><span class="token punctuation">)</span></span></span>

<span class="token keyword">int</span> WSAAPI <span class="token function">WSAEnumNetworkEvents</span><span class="token punctuation">(</span>
    SOCKET s<span class="token punctuation">,</span>
    WSAEVENT hEventObject<span class="token punctuation">,</span>
    LPWSANETWORKEVENTS lpNetworkEvents<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <ul>
     <li>
      s: 套接字描述符。
     </li>
     <li>
      hEventObject: 标识要重置的关联事件对象的可选句柄。
     </li>
     <li>
      lpNetworkEvents: 指 向WSANETWORKEVENTS 结构的指针，该结构由发生的网络 事件和任何相关错误代码的记录填充。
     </li>
    </ul>
    <p>
     如果操作成功，函数返回值为零；否则，将返回值SOCKET ERROR, 并且可以通过调用WSAGetLastError来获取特定的错误码。
    </p>
    <p>
     以上4步是使用事件选择模型的基本步骤。下面我们看一个实例。
    </p>
    <p>
     <strong>
      服务端
     </strong>
    </p>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_WINSOCK_DEPRECATED_NO_WARNINGS</span></span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;winsock2.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;Windows.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression"><span class="token function">comment</span><span class="token punctuation">(</span>lib<span class="token punctuation">,</span></span><span class="token string">"ws2_32.lib"</span><span class="token expression"><span class="token punctuation">)</span></span></span>

<span class="token keyword">using</span> std<span class="token double-colon punctuation">::</span>cout<span class="token punctuation">;</span>
<span class="token keyword">using</span> std<span class="token double-colon punctuation">::</span>cin<span class="token punctuation">;</span>
<span class="token keyword">using</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
<span class="token keyword">using</span> std<span class="token double-colon punctuation">::</span>ends<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">WSAEventServerSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	SOCKET server <span class="token operator">=</span> <span class="token double-colon punctuation">::</span><span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> IPPROTO_TCP<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>server <span class="token operator">==</span> INVALID_SOCKET<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		cout <span class="token operator">&lt;&lt;</span> <span class="token string">"创建SOCKET失败！,错误代码："</span> <span class="token operator">&lt;&lt;</span> <span class="token function">WSAGetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">int</span> error <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	sockaddr_in addr_in<span class="token punctuation">;</span>
	addr_in<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
	addr_in<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">6000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	addr_in<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> INADDR_ANY<span class="token punctuation">;</span>
	error <span class="token operator">=</span> <span class="token double-colon punctuation">::</span><span class="token function">bind</span><span class="token punctuation">(</span>server<span class="token punctuation">,</span> <span class="token punctuation">(</span>sockaddr<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>addr_in<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>sockaddr_in<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">==</span> SOCKET_ERROR<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		cout <span class="token operator">&lt;&lt;</span> <span class="token string">"绑定端口失败！,错误代码："</span> <span class="token operator">&lt;&lt;</span> <span class="token function">WSAGetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">listen</span><span class="token punctuation">(</span>server<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">==</span> SOCKET_ERROR<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		cout <span class="token operator">&lt;&lt;</span> <span class="token string">"监听失败！,错误代码："</span> <span class="token operator">&lt;&lt;</span> <span class="token function">WSAGetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	cout <span class="token operator">&lt;&lt;</span> <span class="token string">"成功监听端口 :"</span> <span class="token operator">&lt;&lt;</span> <span class="token function">ntohs</span><span class="token punctuation">(</span>addr_in<span class="token punctuation">.</span>sin_port<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>

	WSAEVENT eventArray<span class="token punctuation">[</span>WSA_MAXIMUM_WAIT_EVENTS<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token comment">// 事件对象数组</span>
	SOCKET sockArray<span class="token punctuation">[</span>WSA_MAXIMUM_WAIT_EVENTS<span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token comment">// 事件对象数组对应的SOCKET句柄</span>
	<span class="token keyword">int</span> nEvent <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                    <span class="token comment">// 事件对象数组的数量 </span>

	WSAEVENT event0 <span class="token operator">=</span> <span class="token double-colon punctuation">::</span><span class="token function">WSACreateEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token double-colon punctuation">::</span><span class="token function">WSAEventSelect</span><span class="token punctuation">(</span>server<span class="token punctuation">,</span> event0<span class="token punctuation">,</span> FD_ACCEPT <span class="token operator">|</span> FD_CLOSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	eventArray<span class="token punctuation">[</span>nEvent<span class="token punctuation">]</span> <span class="token operator">=</span> event0<span class="token punctuation">;</span>
	sockArray<span class="token punctuation">[</span>nEvent<span class="token punctuation">]</span> <span class="token operator">=</span> server<span class="token punctuation">;</span>
	nEvent<span class="token operator">++</span><span class="token punctuation">;</span>

	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">int</span> nIndex <span class="token operator">=</span> <span class="token double-colon punctuation">::</span><span class="token function">WSAWaitForMultipleEvents</span><span class="token punctuation">(</span>nEvent<span class="token punctuation">,</span> eventArray<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> WSA_INFINITE<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>nIndex <span class="token operator">==</span> WSA_WAIT_IO_COMPLETION <span class="token operator">||</span> nIndex <span class="token operator">==</span> WSA_WAIT_TIMEOUT<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			cout <span class="token operator">&lt;&lt;</span> <span class="token string">"等待时发生错误！错误代码："</span> <span class="token operator">&lt;&lt;</span> <span class="token function">WSAGetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		nIndex <span class="token operator">=</span> nIndex <span class="token operator">-</span> WSA_WAIT_EVENT_0<span class="token punctuation">;</span>
		WSANETWORKEVENTS event<span class="token punctuation">;</span>
		SOCKET sock <span class="token operator">=</span> sockArray<span class="token punctuation">[</span>nIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token double-colon punctuation">::</span><span class="token function">WSAEnumNetworkEvents</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> eventArray<span class="token punctuation">[</span>nIndex<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>lNetworkEvents <span class="token operator">&amp;</span> FD_ACCEPT<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>iErrorCode<span class="token punctuation">[</span>FD_ACCEPT_BIT<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>nEvent <span class="token operator">&gt;=</span> WSA_MAXIMUM_WAIT_EVENTS<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					cout <span class="token operator">&lt;&lt;</span> <span class="token string">"事件对象太多，拒绝连接"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
					<span class="token keyword">continue</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				sockaddr_in addr<span class="token punctuation">;</span>
				<span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>sockaddr_in<span class="token punctuation">)</span><span class="token punctuation">;</span>
				SOCKET client <span class="token operator">=</span> <span class="token double-colon punctuation">::</span><span class="token function">accept</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> <span class="token punctuation">(</span>sockaddr<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>addr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>client <span class="token operator">!=</span> INVALID_SOCKET<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					cout <span class="token operator">&lt;&lt;</span> <span class="token string">"接受了一个客户端连接 "</span> <span class="token operator">&lt;&lt;</span> <span class="token function">inet_ntoa</span><span class="token punctuation">(</span>addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">":"</span> <span class="token operator">&lt;&lt;</span> <span class="token function">ntohs</span><span class="token punctuation">(</span>addr<span class="token punctuation">.</span>sin_port<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
					WSAEVENT eventNew <span class="token operator">=</span> <span class="token double-colon punctuation">::</span><span class="token function">WSACreateEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token double-colon punctuation">::</span><span class="token function">WSAEventSelect</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> eventNew<span class="token punctuation">,</span> FD_READ <span class="token operator">|</span> FD_CLOSE <span class="token operator">|</span> FD_WRITE<span class="token punctuation">)</span><span class="token punctuation">;</span>
					eventArray<span class="token punctuation">[</span>nEvent<span class="token punctuation">]</span> <span class="token operator">=</span> eventNew<span class="token punctuation">;</span>
					sockArray<span class="token punctuation">[</span>nEvent<span class="token punctuation">]</span> <span class="token operator">=</span> client<span class="token punctuation">;</span>
					nEvent<span class="token operator">++</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>lNetworkEvents <span class="token operator">&amp;</span> FD_READ<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>iErrorCode<span class="token punctuation">[</span>FD_READ_BIT<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">2500</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
				<span class="token function">ZeroMemory</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">2500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">int</span> nRecv <span class="token operator">=</span> <span class="token double-colon punctuation">::</span><span class="token function">recv</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">2500</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>nRecv <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					cout <span class="token operator">&lt;&lt;</span> <span class="token string">"收到一个消息 :"</span> <span class="token operator">&lt;&lt;</span> buf <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
					<span class="token keyword">char</span> strSend<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"hi,client,I am server, I recvived your message."</span><span class="token punctuation">;</span>
					<span class="token double-colon punctuation">::</span><span class="token function">send</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> strSend<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>strSend<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>lNetworkEvents <span class="token operator">&amp;</span> FD_CLOSE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token double-colon punctuation">::</span><span class="token function">WSACloseEvent</span><span class="token punctuation">(</span>eventArray<span class="token punctuation">[</span>nIndex<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token double-colon punctuation">::</span><span class="token function">closesocket</span><span class="token punctuation">(</span>sockArray<span class="token punctuation">[</span>nIndex<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			cout <span class="token operator">&lt;&lt;</span> <span class="token string">"一个客户端连接已经断开了连接"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> nIndex<span class="token punctuation">;</span> j <span class="token operator">&lt;</span> nEvent <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				eventArray<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> eventArray<span class="token punctuation">[</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
				sockArray<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> sockArray<span class="token punctuation">[</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			nEvent<span class="token operator">--</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>lNetworkEvents <span class="token operator">&amp;</span> FD_WRITE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			cout <span class="token operator">&lt;&lt;</span> <span class="token string">"一个客户端连接允许写入数据"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span> <span class="token comment">// end while</span>
	<span class="token double-colon punctuation">::</span><span class="token function">closesocket</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	WSADATA wsaData<span class="token punctuation">;</span>
	<span class="token keyword">int</span> error<span class="token punctuation">;</span>
	WORD wVersionRequested<span class="token punctuation">;</span>
	wVersionRequested <span class="token operator">=</span> WINSOCK_VERSION<span class="token punctuation">;</span>
	error <span class="token operator">=</span> <span class="token function">WSAStartup</span><span class="token punctuation">(</span>wVersionRequested<span class="token punctuation">,</span> <span class="token operator">&amp;</span>wsaData<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">WSACleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">WSAEventServerSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">WSACleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
    <p>
     <strong>
      客户端
     </strong>
    </p>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_WINSOCK_DEPRECATED_NO_WARNINGS</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;WINSOCK2.H&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;windows.h&gt;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;process.h&gt;</span>  </span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;string&gt;</span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BUF_SIZE</span> <span class="token expression"><span class="token number">64</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression"><span class="token function">comment</span><span class="token punctuation">(</span>lib<span class="token punctuation">,</span></span><span class="token string">"WS2_32.lib"</span><span class="token expression"><span class="token punctuation">)</span></span></span>


<span class="token keyword">void</span> <span class="token function">recv</span><span class="token punctuation">(</span>PVOID pt<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	SOCKET  sHost <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>SOCKET<span class="token operator">*</span><span class="token punctuation">)</span>pt<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">char</span> buf<span class="token punctuation">[</span>BUF_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//清空接收数据的缓冲区</span>
		<span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> BUF_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> retVal <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>sHost<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>SOCKET_ERROR <span class="token operator">==</span> retVal<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">int</span>  err <span class="token operator">=</span> <span class="token function">WSAGetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//无法立即完成非阻塞Socket上的操作</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">==</span> WSAEWOULDBLOCK<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token comment">//printf("\nwaiting  reply!");</span>
				<span class="token keyword">continue</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">==</span> WSAETIMEDOUT <span class="token operator">||</span> err <span class="token operator">==</span> WSAENETDOWN <span class="token operator">||</span> err <span class="token operator">==</span> WSAECONNRESET<span class="token punctuation">)</span><span class="token comment">//已建立连接</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"recv failed!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">closesocket</span><span class="token punctuation">(</span>sHost<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">WSACleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

		<span class="token punctuation">}</span>

		<span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n%s"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//break;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	WSADATA wsd<span class="token punctuation">;</span>
	SOCKET sHost<span class="token punctuation">;</span>
	SOCKADDR_IN servAddr<span class="token punctuation">;</span><span class="token comment">//服务器地址</span>
	<span class="token keyword">int</span> retVal<span class="token punctuation">;</span><span class="token comment">//调用Socket函数的返回值</span>
	<span class="token keyword">char</span> buf<span class="token punctuation">[</span>BUF_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token comment">//初始化Socket环境</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">WSAStartup</span><span class="token punctuation">(</span><span class="token function">MAKEWORD</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>wsd<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"WSAStartup failed!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	sHost <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> IPPROTO_TCP<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//设置服务器Socket地址</span>
	servAddr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
	servAddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>S_un<span class="token punctuation">.</span>S_addr <span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//在实际应用中，建议将服务器的IP地址和端口号保存在配置文件中</span>
	servAddr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">6000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//计算地址的长度</span>
	<span class="token keyword">int</span> sServerAddlen <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>servAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>



	<span class="token comment">//调用ioctlsocket（）将其设置为非阻塞模式</span>
	<span class="token keyword">int</span> iMode <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	retVal <span class="token operator">=</span> <span class="token function">ioctlsocket</span><span class="token punctuation">(</span>sHost<span class="token punctuation">,</span> FIONBIO<span class="token punctuation">,</span> <span class="token punctuation">(</span>u_long FAR<span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> iMode<span class="token punctuation">)</span><span class="token punctuation">;</span>


	<span class="token keyword">if</span> <span class="token punctuation">(</span>retVal <span class="token operator">==</span> SOCKET_ERROR<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ioctlsocket failed!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">WSACleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>


	<span class="token comment">//循环等待</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token comment">//连接到服务器</span>
		retVal <span class="token operator">=</span> <span class="token function">connect</span><span class="token punctuation">(</span>sHost<span class="token punctuation">,</span> <span class="token punctuation">(</span>LPSOCKADDR<span class="token punctuation">)</span><span class="token operator">&amp;</span>servAddr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>servAddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>SOCKET_ERROR <span class="token operator">==</span> retVal<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">int</span> err <span class="token operator">=</span> <span class="token function">WSAGetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//无法立即完成非阻塞Socket上的操作</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">==</span> WSAEWOULDBLOCK <span class="token operator">||</span> err <span class="token operator">==</span> WSAEINVAL<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"check  connect!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">continue</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">==</span> WSAEISCONN<span class="token punctuation">)</span><span class="token comment">//已建立连接</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"connection failed!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">closesocket</span><span class="token punctuation">(</span>sHost<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">WSACleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>


	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> threadId <span class="token operator">=</span> <span class="token function">_beginthread</span><span class="token punctuation">(</span>recv<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>sHost<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//启动一个线程接收数据的线程   </span>

	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token comment">//向服务器发送字符串，并显示反馈信息</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"input a string to send:\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		std<span class="token double-colon punctuation">::</span>string str<span class="token punctuation">;</span>
		<span class="token comment">//接收输入的数据</span>
		std<span class="token double-colon punctuation">::</span>cin <span class="token operator">&gt;&gt;</span> str<span class="token punctuation">;</span>
		<span class="token comment">//将用户输入的数据复制到buf中</span>
		<span class="token function">ZeroMemory</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> BUF_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">strcpy_s</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> str<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token string">"quit"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"quit!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			retVal <span class="token operator">=</span> <span class="token function">send</span><span class="token punctuation">(</span>sHost<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>SOCKET_ERROR <span class="token operator">==</span> retVal<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token keyword">int</span> err <span class="token operator">=</span> <span class="token function">WSAGetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">==</span> WSAEWOULDBLOCK<span class="token punctuation">)</span>
				<span class="token punctuation">{<!-- --></span>
					<span class="token comment">//无法立即完成非阻塞Socket上的操作</span>
					<span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">continue</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>

				<span class="token keyword">else</span>
				<span class="token punctuation">{<!-- --></span>
					<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"send failed!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token function">closesocket</span><span class="token punctuation">(</span>sHost<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token function">WSACleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
    <p>
     参考书籍《Visual C++2017 网络编程实战》
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f:626c6f672e6373646e2e6e65742f416e746f6e696f3931352f:61727469636c652f64657461696c732f313436313338363638" class_="artid" style="display:none">
 </p>
</div>


