---
arturl_encode: "68747470733a2f2f62:6c6f672e6373646e2e6e65742f6d305f36333934393230332f:61727469636c652f64657461696c732f313436313238393737"
layout: post
title: "Seata-åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ"
date: 2025-03-09 11:03:48 +08:00
description: "Seata--åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ"
keywords: "Seata--åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ"
categories: ['Springcloud']
tags: ['åˆ†å¸ƒå¼', 'Springcloud']
artid: "146128977"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146128977
    alt: "Seata-åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146128977
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146128977
cover: https://bing.ee123.net/img/rand?artid=146128977
image: https://bing.ee123.net/img/rand?artid=146128977
img: https://bing.ee123.net/img/rand?artid=146128977
---

# Seata--åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ

## Seataâ€“åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ

### ç®€ä»‹

Seata æ˜¯é˜¿é‡Œå¼€æºçš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼Œæä¾›
**AT**
ã€
**XA**
ã€
**TCC**
ã€
**Saga**
å››ç§äº‹åŠ¡æ¨¡å¼ï¼Œæ”¯æŒå¾®æœåŠ¡æ¶æ„ä¸‹çš„æ•°æ®ä¸€è‡´æ€§ã€‚

å®˜ç½‘ï¼šhttps://seata.apache.org/zh-cn/

#### åŒç±»äº§å“å¯¹æ¯”

| æ–¹æ¡ˆ | æ ¸å¿ƒç‰¹ç‚¹ | é€‚ç”¨åœºæ™¯ |
| --- | --- | --- |
| **Seata** | å¤šæ¨¡å¼æ”¯æŒï¼Œä»£ç ä¾µå…¥æ€§ä½ï¼Œç¤¾åŒºæ´»è·ƒ | å¤æ‚ä¸šåŠ¡åœºæ™¯ï¼Œéœ€çµæ´»é€‰æ‹©æ¨¡å¼ |
| **é˜¿é‡Œäº‘ GTS** | å•†ä¸šç‰ˆæ–¹æ¡ˆï¼ŒåŠŸèƒ½å…¨é¢ï¼Œæ€§èƒ½å¼º | ä¼ä¸šçº§ä»˜è´¹åœºæ™¯ |
| **RocketMQ äº‹åŠ¡æ¶ˆæ¯** | åŸºäºæ¶ˆæ¯é˜Ÿåˆ—å®ç°æœ€ç»ˆä¸€è‡´æ€§ | å¼‚æ­¥é«˜åååœºæ™¯ |
| **LCN** | åŸºäºä»£ç†æ¨¡å¼ï¼Œå®ç°ç®€å• | è½»é‡çº§å¿«é€Ÿæ¥å…¥ |

---

### 1 ç¯å¢ƒæ­å»º

#### 1.1 å¾®æœåŠ¡

åˆ›å»º Spring Cloud é¡¹ç›®ï¼Œæ¨èä½¿ç”¨ä»¥ä¸‹ç»„ä»¶ï¼š

```xml
<!-- Spring Cloud Alibaba ä¾èµ– -->
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-seata</artifactId>
</dependency>

```

#### 1.2 SQL

æ¯ä¸ªå¾®æœåŠ¡æ•°æ®åº“éœ€åˆ›å»º
**undo_log**
è¡¨ï¼ˆATæ¨¡å¼å¿…éœ€ï¼‰ï¼š

```sql
-- æ¯ä¸ªä¸šåŠ¡æ•°æ®åº“å‡éœ€æ‰§è¡Œ
CREATE TABLE IF NOT EXISTS `undo_log`
(
    `id`            BIGINT(20)   NOT NULL AUTO_INCREMENT,
    `branch_id`     BIGINT(20)   NOT NULL,
    `xid`           VARCHAR(100) NOT NULL,
    `context`       VARCHAR(128) NOT NULL,
    `rollback_info` LONGBLOB     NOT NULL,
    `log_status`    INT(11)      NOT NULL,
    `log_created`   DATETIME     NOT NULL,
    `log_modified`  DATETIME     NOT NULL,
    PRIMARY KEY (`id`),
    UNIQUE KEY `ux_undo_log` (`xid`, `branch_id`)
) ENGINE = InnoDB
  AUTO_INCREMENT = 1
  DEFAULT CHARSET = utf8;

```

#### 1.3 seata-server

1. ä¸‹è½½ :https://seata.apache.org/zh-cn/download/seata-server

   â€‹
   [ğŸ“apache-seata-2.1.0-incubating-bin.tar.gz](https://www.yuque.com/attachments/yuque/0/2025/gz/1613913/1736420650170-1143baab-fbe9-4114-b7e0-515349276444.gz)

â€‹ 2.è§£å‹å¹¶å¯åŠ¨ï¼šseata-server.bat

â€‹ 3.æ§åˆ¶å°:http://127.0.0.1:7091/#/transaction/list

#### 1.4 å¾®æœåŠ¡é…ç½®

##### 1.4.1 ä¾èµ–

é™¤åŸºç¡€ä¾èµ–å¤–éœ€æ·»åŠ ï¼š

```xml
<dependency>
  <groupId>com.alibaba.cloud</groupId>
  <artifactId>spring-cloud-starter-alibaba-seata</artifactId>
</dependency>

```

##### 1.4.2 é…ç½®

æ¯ä¸ªå¾®æœåŠ¡åˆ›å»º
`file.conf`
æ–‡ä»¶ï¼Œå®Œæ•´å†…å®¹å¦‚ä¸‹ï¼›

ã€å¾®æœåŠ¡åªéœ€è¦å¤åˆ¶
`service å—`
é…ç½®å³å¯ã€‘

```yaml
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

transport {
  # tcp, unix-domain-socket
  type = "TCP"
  #NIO, NATIVE
  server = "NIO"
  #enable heartbeat
  heartbeat = true
  # the tm client batch send request enable
  enableTmClientBatchSendRequest = false
  # the rm client batch send request enable
  enableRmClientBatchSendRequest = true
   # the rm client rpc request timeout
  rpcRmRequestTimeout = 2000
  # the tm client rpc request timeout
  rpcTmRequestTimeout = 30000
  # the rm client rpc request timeout
  rpcRmRequestTimeout = 15000
  #thread factory for netty
  threadFactory {
    bossThreadPrefix = "NettyBoss"
    workerThreadPrefix = "NettyServerNIOWorker"
    serverExecutorThread-prefix = "NettyServerBizHandler"
    shareBossWorker = false
    clientSelectorThreadPrefix = "NettyClientSelector"
    clientSelectorThreadSize = 1
    clientWorkerThreadPrefix = "NettyClientWorkerThread"
    # netty boss thread size
    bossThreadSize = 1
    #auto default pin or 8
    workerThreadSize = "default"
  }
  shutdown {
    # when destroy server, wait seconds
    wait = 3
  }
  serialization = "seata"
  compressor = "none"
}
service {
  #transaction service group mapping
  vgroupMapping.default_tx_group = "default"
  #only support when registry.type=file, please don't set multiple addresses
  default.grouplist = "127.0.0.1:8091"
  #degrade, current not support
  enableDegrade = false
  #disable seata
  disableGlobalTransaction = false
}

client {
  rm {
    asyncCommitBufferLimit = 10000
    lock {
      retryInterval = 10
      retryTimes = 30
      retryPolicyBranchRollbackOnConflict = true
    }
    reportRetryCount = 5
    tableMetaCheckEnable = false
    tableMetaCheckerInterval = 60000
    reportSuccessEnable = false
    sagaBranchRegisterEnable = false
    sagaJsonParser = "fastjson"
    sagaRetryPersistModeUpdate = false
    sagaCompensatePersistModeUpdate = false
    tccActionInterceptorOrder = -2147482648 #Ordered.HIGHEST_PRECEDENCE + 1000
    sqlParserType = "druid"
    branchExecutionTimeoutXA = 60000
    connectionTwoPhaseHoldTimeoutXA = 10000
  }
  tm {
    commitRetryCount = 5
    rollbackRetryCount = 5
    defaultGlobalTransactionTimeout = 60000
    degradeCheck = false
    degradeCheckPeriod = 2000
    degradeCheckAllowTimes = 10
    interceptorOrder = -2147482648 #Ordered.HIGHEST_PRECEDENCE + 1000
  }
  undo {
    dataValidation = true
    onlyCareUpdateColumns = true
    logSerialization = "jackson"
    logTable = "undo_log"
    compress {
      enable = true
      # allow zip, gzip, deflater, lz4, bzip2, zstd default is zip
      type = zip
      # if rollback info size > threshold, then will be compress
      # allow k m g t
      threshold = 64k
    }
  }
  loadBalance {
      type = "XID"
      virtualNodes = 10
  }
}
log {
  exceptionRate = 100
}
tcc {
  fence {
    # tcc fence log table name
    logTableName = tcc_fence_log
    # tcc fence log clean period
    cleanPeriod = 1h
  }
}

```

---

### 2 äº‹åŠ¡æ¨¡å¼

#### 2.1 ATæ¨¡å¼ï¼ˆæ¨è:è‡ªåŠ¨è¡¥å¿ï¼‰

> äºŒé˜¶æäº¤åè®®åŸç†

**åŸç†**
ï¼šåŸºäºåå‘SQLè¡¥å¿ï¼Œè‡ªåŠ¨ç”Ÿæˆå›æ»šæ—¥å¿—

![SpringCloud-ç¬¬ 2 é¡µ.drawio.png](https://i-blog.csdnimg.cn/img_convert/469d3ddbec2dd2a73cdf5b6d3a1bf2a2.png)

**ä½¿ç”¨**
ï¼š

```java
@Service
public class OrderService {
    @GlobalTransactional(name = "createOrder", timeoutMills = 60000)
    public void createOrder(OrderDTO order) {
        // 1. æ‰£å‡åº“å­˜ï¼ˆè°ƒç”¨åº“å­˜æœåŠ¡ï¼‰
        storageFeignClient.deduct(order.getProductId());
        // 2. åˆ›å»ºè®¢å•ï¼ˆæœ¬åœ°äº‹åŠ¡ï¼‰
        orderMapper.insert(order);
        // 3. æ¨¡æ‹Ÿå¼‚å¸¸è§¦å‘å›æ»š
        int i = 1 / 0; 
    }
}

```

**å…³é”®æœºåˆ¶**
ï¼š

* ä¸€é˜¶æ®µï¼šæäº¤æœ¬åœ°äº‹åŠ¡ï¼Œç”Ÿæˆå›æ»šæ—¥å¿—ï¼ˆundo_logï¼‰
* äºŒé˜¶æ®µï¼šæˆåŠŸåˆ™å¼‚æ­¥åˆ é™¤æ—¥å¿—ï¼Œå¤±è´¥åˆ™é€šè¿‡æ—¥å¿—åå‘è¡¥å¿

**ç‰¹ç‚¹**
ï¼š

* å¯¹ä»£ç æ— ä¾µå…¥
* éœ€åˆ›å»ºundo_logè¡¨
* é€‚ç”¨äºå¤§å¤šæ•°CRUDåœºæ™¯

#### 2.2 XAæ¨¡å¼ï¼ˆå¼ºä¸€è‡´ï¼‰

**åŸç†**
ï¼šåŸºäºæ•°æ®åº“XAåè®®çš„ä¸¤é˜¶æ®µæäº¤
  
**é…ç½®**
ï¼š

```yaml
seata:
  data-source-proxy-mode: XA  # é»˜è®¤AT

```

##### ç‰¹ç‚¹

* åŸºäºæ•°æ®åº“XAåè®®
* ä¸¤é˜¶æ®µæäº¤ï¼ˆ2PCï¼‰
* äº‹åŠ¡æŒæœ‰é”æ—¶é—´è¾ƒé•¿ï¼Œé€‚åˆçŸ­äº‹åŠ¡

**é€‚ç”¨åœºæ™¯**
ï¼šå¼ºä¸€è‡´æ€§éœ€æ±‚ï¼Œæ”¯æŒXAåè®®çš„æ•°æ®åº“ï¼ˆå¦‚MySQL 5.7+ï¼‰

#### 2.3 TCCæ¨¡å¼ï¼ˆæ‰‹åŠ¨è¡¥å¿ï¼‰

**åŸç†**
ï¼šTry-Confirm-Cancel ä¸‰é˜¶æ®µæ§åˆ¶
  
**å®ç°**
ï¼š

```java
// 1. å®šä¹‰TCCæ¥å£
public interface StorageTccService {
    @TwoPhaseBusinessAction(name = "deduct", 
                          commitMethod = "confirm", 
                          rollbackMethod = "cancel")
    boolean deduct(@BusinessActionContextParameter(paramName = "productId") String productId,
                   @BusinessActionContextParameter(paramName = "count") Integer count);
    
    boolean confirm(BusinessActionContext context);
    boolean cancel(BusinessActionContext context);
}

// 2. å®ç°Tryé€»è¾‘
@Service
public class StorageTccServiceImpl implements StorageTccService {
    @Override
    public boolean deduct(String productId, Integer count) {
        // Tryé˜¶æ®µï¼šèµ„æºé¢„ç•™ï¼ˆä¾‹å¦‚å†»ç»“åº“å­˜ï¼‰
        return storageMapper.freezeStock(productId, count) > 0;
    }
    
    @Override
    public boolean confirm(BusinessActionContext context) {
        // Confirmé˜¶æ®µï¼šçœŸå®æ‰£å‡ï¼ˆä¾‹å¦‚åˆ é™¤å†»ç»“è®°å½•ï¼‰
        String productId = context.getActionContext("productId");
        Integer count = context.getActionContext("count");
        return storageMapper.reduceStock(productId, count) > 0;
    }
    
    @Override
    public boolean cancel(BusinessActionContext context) {
        // Cancelé˜¶æ®µï¼šé‡Šæ”¾èµ„æºï¼ˆä¾‹å¦‚æ¢å¤å†»ç»“åº“å­˜ï¼‰
        String productId = context.getActionContext("productId");
        Integer count = context.getActionContext("count");
        return storageMapper.unfreezeStock(productId, count) > 0;
    }
}

```

##### ä½¿ç”¨é™åˆ¶

* éœ€è‡ªè¡Œå®ç°Try/Confirm/Cancelæ–¹æ³•
* Confirmå’ŒCanceléœ€ä¿è¯å¹‚ç­‰æ€§

**ç‰¹ç‚¹**
ï¼šé«˜æ€§èƒ½ï¼Œä½†éœ€æ‰‹åŠ¨ç¼–å†™è¡¥å¿é€»è¾‘

#### 2.4 Sagaæ¨¡å¼ï¼ˆé•¿äº‹åŠ¡ï¼‰

##### å®ç°æ–¹å¼

é€šè¿‡çŠ¶æ€æœºé…ç½®è¡¥å¿ç­–ç•¥ï¼š

```java
@SagaStart
public void createOrderSaga(Order order) {
    // 1. åˆ›å»ºè®¢å•
    orderService.create(order);
    // 2. è°ƒç”¨æ”¯ä»˜æœåŠ¡ï¼ˆè‹¥å¤±è´¥åˆ™è§¦å‘é€†å‘æ“ä½œï¼‰
    paymentService.pay(order.getId());
}
// å®šä¹‰è¡¥å¿æ–¹æ³•
@Compensate
public void compensateOrder(Order order) {
    orderService.delete(order.getId());
}

```

**åŸç†**
ï¼šé•¿äº‹åŠ¡æ‹†åˆ†+é€†å‘è¡¥å¿
  
**é€‚ç”¨åœºæ™¯**
ï¼šè·¨ç³»ç»Ÿé•¿æ—¶é—´æ“ä½œï¼ˆå¦‚è®¢å•+ç‰©æµ+æ”¯ä»˜ï¼‰

---

### 3. æ€»ç»“

#### æ¨¡å¼é€‰å‹å¯¹ç…§è¡¨

| æ¨¡å¼ | ä¸€è‡´æ€§ | æ€§èƒ½ | ä¾µå…¥æ€§ | é€‚ç”¨åœºæ™¯ |
| --- | --- | --- | --- | --- |
| **AT** | å¼±ä¸€è‡´ | é«˜ | ä½ | å¸¸è§„ä¸šåŠ¡ï¼ˆåº“å­˜æ‰£å‡ã€è®¢å•åˆ›å»ºï¼‰ |
| **TCC** | å¼ºä¸€è‡´ | ä¸­ | é«˜ | èµ„é‡‘äº¤æ˜“ã€éœ€ç²¾å‡†æ§åˆ¶ |
| **XA** | å¼ºä¸€è‡´ | ä½ | ä½ | é“¶è¡Œè½¬è´¦ã€çŸ­äº‹åŠ¡ |
| **Saga** | æœ€ç»ˆä¸€è‡´ | é«˜ | ä¸­ | è·¨ç³»ç»Ÿé•¿æµç¨‹ï¼ˆè®¢å•+ç‰©æµ+æ”¯ä»˜ï¼‰ |

#### æ ¸å¿ƒè¦ç‚¹

| åˆ†ç±» | è¦ç‚¹è¯´æ˜ |
| --- | --- |
| **é€‰å‹** | **ATæ¨¡å¼é€‚ç”¨äºå¤§å¤šæ•°åœºæ™¯ï¼ŒTCCé€‚åˆé«˜æ€§èƒ½è¦æ±‚ï¼ŒXAé€‚åˆå¼ºä¸€è‡´æ€§** |
| **é…ç½®** | ç¡®ä¿seata-serverä¸å¾®æœåŠ¡çš„registryé…ç½®ä¸€è‡´ |
| **äº‹åŠ¡ID** | é€šè¿‡ `RootContext.getXID()` å¯è·å–å½“å‰äº‹åŠ¡ID |
| **æ’é”™** | æ£€æŸ¥undo_logè¡¨è®°å½•ï¼ŒæŸ¥çœ‹seata-serveræ§åˆ¶å°æ—¥å¿— |

#### æœ€ä½³å®è·µ

1. ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨Nacosä½œä¸ºé…ç½®ä¸­å¿ƒ
2. ATæ¨¡å¼éœ€è¦å¼€å¯æ•°æ®åº“çš„æœ¬åœ°äº‹åŠ¡æ”¯æŒï¼ˆå¦‚MySQLçš„InnoDBå¼•æ“ï¼‰
3. å…¨å±€äº‹åŠ¡è¶…æ—¶æ—¶é—´å»ºè®®è®¾ç½®ï¼š
   `seata.tx.timeout=60000`
   ï¼ˆå•ä½æ¯«ç§’ï¼‰