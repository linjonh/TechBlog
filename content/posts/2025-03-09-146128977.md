---
layout: post
title: "Seata-åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ"
date: 2025-03-09 11:03:48 +0800
description: "Seata--åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ"
keywords: "Seata--åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ"
categories: ['Springcloud']
tags: ['åˆ†å¸ƒå¼', 'Springcloud']
artid: "146128977"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146128977
    alt: "Seata-åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146128977
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146128977
cover: https://bing.ee123.net/img/rand?artid=146128977
image: https://bing.ee123.net/img/rand?artid=146128977
img: https://bing.ee123.net/img/rand?artid=146128977
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Seata--åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="Seata_0">
     </a>
     Seataâ€“åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ
    </h2>
    <h3>
     <a id="_2">
     </a>
     ç®€ä»‹
    </h3>
    <p>
     Seata æ˜¯é˜¿é‡Œå¼€æºçš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼Œæä¾›
     <strong>
      AT
     </strong>
     ã€
     <strong>
      XA
     </strong>
     ã€
     <strong>
      TCC
     </strong>
     ã€
     <strong>
      Saga
     </strong>
     å››ç§äº‹åŠ¡æ¨¡å¼ï¼Œæ”¯æŒå¾®æœåŠ¡æ¶æ„ä¸‹çš„æ•°æ®ä¸€è‡´æ€§ã€‚
    </p>
    <p>
     å®˜ç½‘ï¼šhttps://seata.apache.org/zh-cn/
    </p>
    <h4>
     <a id="_8">
     </a>
     åŒç±»äº§å“å¯¹æ¯”
    </h4>
    <table>
     <thead>
      <tr>
       <th>
        æ–¹æ¡ˆ
       </th>
       <th>
        æ ¸å¿ƒç‰¹ç‚¹
       </th>
       <th align="center">
        é€‚ç”¨åœºæ™¯
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        <strong>
         Seata
        </strong>
       </td>
       <td>
        å¤šæ¨¡å¼æ”¯æŒï¼Œä»£ç ä¾µå…¥æ€§ä½ï¼Œç¤¾åŒºæ´»è·ƒ
       </td>
       <td align="center">
        å¤æ‚ä¸šåŠ¡åœºæ™¯ï¼Œéœ€çµæ´»é€‰æ‹©æ¨¡å¼
       </td>
      </tr>
      <tr>
       <td>
        <strong>
         é˜¿é‡Œäº‘ GTS
        </strong>
       </td>
       <td>
        å•†ä¸šç‰ˆæ–¹æ¡ˆï¼ŒåŠŸèƒ½å…¨é¢ï¼Œæ€§èƒ½å¼º
       </td>
       <td align="center">
        ä¼ä¸šçº§ä»˜è´¹åœºæ™¯
       </td>
      </tr>
      <tr>
       <td>
        <strong>
         RocketMQ äº‹åŠ¡æ¶ˆæ¯
        </strong>
       </td>
       <td>
        åŸºäºæ¶ˆæ¯é˜Ÿåˆ—å®ç°æœ€ç»ˆä¸€è‡´æ€§
       </td>
       <td align="center">
        å¼‚æ­¥é«˜åååœºæ™¯
       </td>
      </tr>
      <tr>
       <td>
        <strong>
         LCN
        </strong>
       </td>
       <td>
        åŸºäºä»£ç†æ¨¡å¼ï¼Œå®ç°ç®€å•
       </td>
       <td align="center">
        è½»é‡çº§å¿«é€Ÿæ¥å…¥
       </td>
      </tr>
     </tbody>
    </table>
    <hr/>
    <h3>
     <a id="1__19">
     </a>
     1 ç¯å¢ƒæ­å»º
    </h3>
    <h4>
     <a id="11__21">
     </a>
     1.1 å¾®æœåŠ¡
    </h4>
    <p>
     åˆ›å»º Spring Cloud é¡¹ç›®ï¼Œæ¨èä½¿ç”¨ä»¥ä¸‹ç»„ä»¶ï¼š
    </p>
    <pre><code class="prism language-xml"><span class="token comment">&lt;!-- Spring Cloud Alibaba ä¾èµ– --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-seata<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre>
    <h4>
     <a id="12_SQL_33">
     </a>
     1.2 SQL
    </h4>
    <p>
     æ¯ä¸ªå¾®æœåŠ¡æ•°æ®åº“éœ€åˆ›å»º
     <strong>
      undo_log
     </strong>
     è¡¨ï¼ˆATæ¨¡å¼å¿…éœ€ï¼‰ï¼š
    </p>
    <pre><code class="prism language-sql"><span class="token comment">-- æ¯ä¸ªä¸šåŠ¡æ•°æ®åº“å‡éœ€æ‰§è¡Œ</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token identifier"><span class="token punctuation">`</span>undo_log<span class="token punctuation">`</span></span>
<span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span>            <span class="token keyword">BIGINT</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>   <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>branch_id<span class="token punctuation">`</span></span>     <span class="token keyword">BIGINT</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>   <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>xid<span class="token punctuation">`</span></span>           <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>context<span class="token punctuation">`</span></span>       <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>rollback_info<span class="token punctuation">`</span></span> <span class="token keyword">LONGBLOB</span>     <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>log_status<span class="token punctuation">`</span></span>    <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span>      <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>log_created<span class="token punctuation">`</span></span>   <span class="token keyword">DATETIME</span>     <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>log_modified<span class="token punctuation">`</span></span>  <span class="token keyword">DATETIME</span>     <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>ux_undo_log<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>xid<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>branch_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span>
  <span class="token keyword">AUTO_INCREMENT</span> <span class="token operator">=</span> <span class="token number">1</span>
  <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span> <span class="token operator">=</span> utf8<span class="token punctuation">;</span>
</code></pre>
    <h4>
     <a id="13_seataserver_56">
     </a>
     1.3 seata-server
    </h4>
    <ol>
     <li>
      <p>
       ä¸‹è½½ :https://seata.apache.org/zh-cn/download/seata-server
      </p>
      <p>
       â€‹
       <a href="https://www.yuque.com/attachments/yuque/0/2025/gz/1613913/1736420650170-1143baab-fbe9-4114-b7e0-515349276444.gz" rel="nofollow">
        ğŸ“apache-seata-2.1.0-incubating-bin.tar.gz
       </a>
      </p>
     </li>
    </ol>
    <p>
     â€‹ 2.è§£å‹å¹¶å¯åŠ¨ï¼šseata-server.bat
    </p>
    <p>
     â€‹ 3.æ§åˆ¶å°:http://127.0.0.1:7091/#/transaction/list
    </p>
    <h4>
     <a id="14__66">
     </a>
     1.4 å¾®æœåŠ¡é…ç½®
    </h4>
    <h5>
     <a id="141__68">
     </a>
     1.4.1 ä¾èµ–
    </h5>
    <p>
     é™¤åŸºç¡€ä¾èµ–å¤–éœ€æ·»åŠ ï¼š
    </p>
    <pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-seata<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre>
    <h5>
     <a id="142__79">
     </a>
     1.4.2 é…ç½®
    </h5>
    <p>
     æ¯ä¸ªå¾®æœåŠ¡åˆ›å»º
     <code>
      file.conf
     </code>
     æ–‡ä»¶ï¼Œå®Œæ•´å†…å®¹å¦‚ä¸‹ï¼›
    </p>
    <p>
     ã€å¾®æœåŠ¡åªéœ€è¦å¤åˆ¶
     <code>
      service å—
     </code>
     é…ç½®å³å¯ã€‘
    </p>
    <pre><code class="prism language-yaml"><span class="token comment">#</span>
<span class="token comment"># Licensed to the Apache Software Foundation (ASF) under one or more</span>
<span class="token comment"># contributor license agreements.  See the NOTICE file distributed with</span>
<span class="token comment"># this work for additional information regarding copyright ownership.</span>
<span class="token comment"># The ASF licenses this file to You under the Apache License, Version 2.0</span>
<span class="token comment"># (the "License"); you may not use this file except in compliance with</span>
<span class="token comment"># the License.  You may obtain a copy of the License at</span>
<span class="token comment">#</span>
<span class="token comment">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="token comment">#</span>
<span class="token comment"># Unless required by applicable law or agreed to in writing, software</span>
<span class="token comment"># distributed under the License is distributed on an "AS IS" BASIS,</span>
<span class="token comment"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="token comment"># See the License for the specific language governing permissions and</span>
<span class="token comment"># limitations under the License.</span>
<span class="token comment">#</span>

transport <span class="token punctuation">{<!-- --></span>
  <span class="token comment"># tcp, unix-domain-socket</span>
  type = "TCP"
  <span class="token comment">#NIO, NATIVE</span>
  server = "NIO"
  <span class="token comment">#enable heartbeat</span>
  heartbeat = true
  <span class="token comment"># the tm client batch send request enable</span>
  enableTmClientBatchSendRequest = false
  <span class="token comment"># the rm client batch send request enable</span>
  enableRmClientBatchSendRequest = true
   <span class="token comment"># the rm client rpc request timeout</span>
  rpcRmRequestTimeout = 2000
  <span class="token comment"># the tm client rpc request timeout</span>
  rpcTmRequestTimeout = 30000
  <span class="token comment"># the rm client rpc request timeout</span>
  rpcRmRequestTimeout = 15000
  <span class="token comment">#thread factory for netty</span>
  threadFactory <span class="token punctuation">{<!-- --></span>
    bossThreadPrefix = "NettyBoss"
    workerThreadPrefix = "NettyServerNIOWorker"
    serverExecutorThread<span class="token punctuation">-</span>prefix = "NettyServerBizHandler"
    shareBossWorker = false
    clientSelectorThreadPrefix = "NettyClientSelector"
    clientSelectorThreadSize = 1
    clientWorkerThreadPrefix = "NettyClientWorkerThread"
    <span class="token comment"># netty boss thread size</span>
    bossThreadSize = 1
    <span class="token comment">#auto default pin or 8</span>
    workerThreadSize = "default"
  <span class="token punctuation">}</span>
  shutdown <span class="token punctuation">{<!-- --></span>
    <span class="token comment"># when destroy server, wait seconds</span>
    wait = 3
  <span class="token punctuation">}</span>
  serialization = "seata"
  compressor = "none"
<span class="token punctuation">}</span>
service <span class="token punctuation">{<!-- --></span>
  <span class="token comment">#transaction service group mapping</span>
  vgroupMapping.default_tx_group = "default"
  <span class="token comment">#only support when registry.type=file, please don't set multiple addresses</span>
  default.grouplist = "127.0.0.1<span class="token punctuation">:</span>8091"
  <span class="token comment">#degrade, current not support</span>
  enableDegrade = false
  <span class="token comment">#disable seata</span>
  disableGlobalTransaction = false
<span class="token punctuation">}</span>

client <span class="token punctuation">{<!-- --></span>
  rm <span class="token punctuation">{<!-- --></span>
    asyncCommitBufferLimit = 10000
    lock <span class="token punctuation">{<!-- --></span>
      retryInterval = 10
      retryTimes = 30
      retryPolicyBranchRollbackOnConflict = true
    <span class="token punctuation">}</span>
    reportRetryCount = 5
    tableMetaCheckEnable = false
    tableMetaCheckerInterval = 60000
    reportSuccessEnable = false
    sagaBranchRegisterEnable = false
    sagaJsonParser = "fastjson"
    sagaRetryPersistModeUpdate = false
    sagaCompensatePersistModeUpdate = false
    tccActionInterceptorOrder = <span class="token punctuation">-</span><span class="token number">2147482648</span> <span class="token comment">#Ordered.HIGHEST_PRECEDENCE + 1000</span>
    sqlParserType = "druid"
    branchExecutionTimeoutXA = 60000
    connectionTwoPhaseHoldTimeoutXA = 10000
  <span class="token punctuation">}</span>
  tm <span class="token punctuation">{<!-- --></span>
    commitRetryCount = 5
    rollbackRetryCount = 5
    defaultGlobalTransactionTimeout = 60000
    degradeCheck = false
    degradeCheckPeriod = 2000
    degradeCheckAllowTimes = 10
    interceptorOrder = <span class="token punctuation">-</span><span class="token number">2147482648</span> <span class="token comment">#Ordered.HIGHEST_PRECEDENCE + 1000</span>
  <span class="token punctuation">}</span>
  undo <span class="token punctuation">{<!-- --></span>
    dataValidation = true
    onlyCareUpdateColumns = true
    logSerialization = "jackson"
    logTable = "undo_log"
    compress <span class="token punctuation">{<!-- --></span>
      enable = true
      <span class="token comment"># allow zip, gzip, deflater, lz4, bzip2, zstd default is zip</span>
      type = zip
      <span class="token comment"># if rollback info size &gt; threshold, then will be compress</span>
      <span class="token comment"># allow k m g t</span>
      threshold = 64k
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  loadBalance <span class="token punctuation">{<!-- --></span>
      type = "XID"
      virtualNodes = 10
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
log <span class="token punctuation">{<!-- --></span>
  exceptionRate = 100
<span class="token punctuation">}</span>
tcc <span class="token punctuation">{<!-- --></span>
  fence <span class="token punctuation">{<!-- --></span>
    <span class="token comment"># tcc fence log table name</span>
    logTableName = tcc_fence_log
    <span class="token comment"># tcc fence log clean period</span>
    cleanPeriod = 1h
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <hr/>
    <h3>
     <a id="2__216">
     </a>
     2 äº‹åŠ¡æ¨¡å¼
    </h3>
    <h4>
     <a id="21_AT_218">
     </a>
     2.1 ATæ¨¡å¼ï¼ˆæ¨è:è‡ªåŠ¨è¡¥å¿ï¼‰
    </h4>
    <blockquote>
     <p>
      äºŒé˜¶æäº¤åè®®åŸç†
     </p>
    </blockquote>
    <p>
     <strong>
      åŸç†
     </strong>
     ï¼šåŸºäºåå‘SQLè¡¥å¿ï¼Œè‡ªåŠ¨ç”Ÿæˆå›æ»šæ—¥å¿—
    </p>
    <p>
     <img alt="SpringCloud-ç¬¬ 2 é¡µ.drawio.png" src="https://i-blog.csdnimg.cn/img_convert/469d3ddbec2dd2a73cdf5b6d3a1bf2a2.png"/>
    </p>
    <p>
     <strong>
      ä½¿ç”¨
     </strong>
     ï¼š
    </p>
    <pre><code class="prism language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderService</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@GlobalTransactional</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"createOrder"</span><span class="token punctuation">,</span> timeoutMills <span class="token operator">=</span> <span class="token number">60000</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createOrder</span><span class="token punctuation">(</span><span class="token class-name">OrderDTO</span> order<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 1. æ‰£å‡åº“å­˜ï¼ˆè°ƒç”¨åº“å­˜æœåŠ¡ï¼‰</span>
        storageFeignClient<span class="token punctuation">.</span><span class="token function">deduct</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getProductId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. åˆ›å»ºè®¢å•ï¼ˆæœ¬åœ°äº‹åŠ¡ï¼‰</span>
        orderMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3. æ¨¡æ‹Ÿå¼‚å¸¸è§¦å‘å›æ»š</span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">0</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     <strong>
      å…³é”®æœºåˆ¶
     </strong>
     ï¼š
    </p>
    <ul>
     <li>
      ä¸€é˜¶æ®µï¼šæäº¤æœ¬åœ°äº‹åŠ¡ï¼Œç”Ÿæˆå›æ»šæ—¥å¿—ï¼ˆundo_logï¼‰
     </li>
     <li>
      äºŒé˜¶æ®µï¼šæˆåŠŸåˆ™å¼‚æ­¥åˆ é™¤æ—¥å¿—ï¼Œå¤±è´¥åˆ™é€šè¿‡æ—¥å¿—åå‘è¡¥å¿
     </li>
    </ul>
    <p>
     <strong>
      ç‰¹ç‚¹
     </strong>
     ï¼š
    </p>
    <ul>
     <li>
      å¯¹ä»£ç æ— ä¾µå…¥
     </li>
     <li>
      éœ€åˆ›å»ºundo_logè¡¨
     </li>
     <li>
      é€‚ç”¨äºå¤§å¤šæ•°CRUDåœºæ™¯
     </li>
    </ul>
    <h4>
     <a id="22_XA_254">
     </a>
     2.2 XAæ¨¡å¼ï¼ˆå¼ºä¸€è‡´ï¼‰
    </h4>
    <p>
     <strong>
      åŸç†
     </strong>
     ï¼šåŸºäºæ•°æ®åº“XAåè®®çš„ä¸¤é˜¶æ®µæäº¤
     <br/>
     <strong>
      é…ç½®
     </strong>
     ï¼š
    </p>
    <pre><code class="prism language-yaml"><span class="token key atrule">seata</span><span class="token punctuation">:</span>
  <span class="token key atrule">data-source-proxy-mode</span><span class="token punctuation">:</span> XA  <span class="token comment"># é»˜è®¤AT</span>
</code></pre>
    <h5>
     <a id="_264">
     </a>
     ç‰¹ç‚¹
    </h5>
    <ul>
     <li>
      åŸºäºæ•°æ®åº“XAåè®®
     </li>
     <li>
      ä¸¤é˜¶æ®µæäº¤ï¼ˆ2PCï¼‰
     </li>
     <li>
      äº‹åŠ¡æŒæœ‰é”æ—¶é—´è¾ƒé•¿ï¼Œé€‚åˆçŸ­äº‹åŠ¡
     </li>
    </ul>
    <p>
     <strong>
      é€‚ç”¨åœºæ™¯
     </strong>
     ï¼šå¼ºä¸€è‡´æ€§éœ€æ±‚ï¼Œæ”¯æŒXAåè®®çš„æ•°æ®åº“ï¼ˆå¦‚MySQL 5.7+ï¼‰
    </p>
    <h4>
     <a id="23_TCC_272">
     </a>
     2.3 TCCæ¨¡å¼ï¼ˆæ‰‹åŠ¨è¡¥å¿ï¼‰
    </h4>
    <p>
     <strong>
      åŸç†
     </strong>
     ï¼šTry-Confirm-Cancel ä¸‰é˜¶æ®µæ§åˆ¶
     <br/>
     <strong>
      å®ç°
     </strong>
     ï¼š
    </p>
    <pre><code class="prism language-java"><span class="token comment">// 1. å®šä¹‰TCCæ¥å£</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">StorageTccService</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@TwoPhaseBusinessAction</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"deduct"</span><span class="token punctuation">,</span> 
                          commitMethod <span class="token operator">=</span> <span class="token string">"confirm"</span><span class="token punctuation">,</span> 
                          rollbackMethod <span class="token operator">=</span> <span class="token string">"cancel"</span><span class="token punctuation">)</span>
    <span class="token keyword">boolean</span> <span class="token function">deduct</span><span class="token punctuation">(</span><span class="token annotation punctuation">@BusinessActionContextParameter</span><span class="token punctuation">(</span>paramName <span class="token operator">=</span> <span class="token string">"productId"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> productId<span class="token punctuation">,</span>
                   <span class="token annotation punctuation">@BusinessActionContextParameter</span><span class="token punctuation">(</span>paramName <span class="token operator">=</span> <span class="token string">"count"</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">boolean</span> <span class="token function">confirm</span><span class="token punctuation">(</span><span class="token class-name">BusinessActionContext</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token class-name">BusinessActionContext</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 2. å®ç°Tryé€»è¾‘</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StorageTccServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">StorageTccService</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">deduct</span><span class="token punctuation">(</span><span class="token class-name">String</span> productId<span class="token punctuation">,</span> <span class="token class-name">Integer</span> count<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// Tryé˜¶æ®µï¼šèµ„æºé¢„ç•™ï¼ˆä¾‹å¦‚å†»ç»“åº“å­˜ï¼‰</span>
        <span class="token keyword">return</span> storageMapper<span class="token punctuation">.</span><span class="token function">freezeStock</span><span class="token punctuation">(</span>productId<span class="token punctuation">,</span> count<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">confirm</span><span class="token punctuation">(</span><span class="token class-name">BusinessActionContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// Confirmé˜¶æ®µï¼šçœŸå®æ‰£å‡ï¼ˆä¾‹å¦‚åˆ é™¤å†»ç»“è®°å½•ï¼‰</span>
        <span class="token class-name">String</span> productId <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getActionContext</span><span class="token punctuation">(</span><span class="token string">"productId"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Integer</span> count <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getActionContext</span><span class="token punctuation">(</span><span class="token string">"count"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> storageMapper<span class="token punctuation">.</span><span class="token function">reduceStock</span><span class="token punctuation">(</span>productId<span class="token punctuation">,</span> count<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token class-name">BusinessActionContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// Cancelé˜¶æ®µï¼šé‡Šæ”¾èµ„æºï¼ˆä¾‹å¦‚æ¢å¤å†»ç»“åº“å­˜ï¼‰</span>
        <span class="token class-name">String</span> productId <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getActionContext</span><span class="token punctuation">(</span><span class="token string">"productId"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Integer</span> count <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getActionContext</span><span class="token punctuation">(</span><span class="token string">"count"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> storageMapper<span class="token punctuation">.</span><span class="token function">unfreezeStock</span><span class="token punctuation">(</span>productId<span class="token punctuation">,</span> count<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h5>
     <a id="_317">
     </a>
     ä½¿ç”¨é™åˆ¶
    </h5>
    <ul>
     <li>
      éœ€è‡ªè¡Œå®ç°Try/Confirm/Cancelæ–¹æ³•
     </li>
     <li>
      Confirmå’ŒCanceléœ€ä¿è¯å¹‚ç­‰æ€§
     </li>
    </ul>
    <p>
     <strong>
      ç‰¹ç‚¹
     </strong>
     ï¼šé«˜æ€§èƒ½ï¼Œä½†éœ€æ‰‹åŠ¨ç¼–å†™è¡¥å¿é€»è¾‘
    </p>
    <h4>
     <a id="24_Saga_324">
     </a>
     2.4 Sagaæ¨¡å¼ï¼ˆé•¿äº‹åŠ¡ï¼‰
    </h4>
    <h5>
     <a id="_326">
     </a>
     å®ç°æ–¹å¼
    </h5>
    <p>
     é€šè¿‡çŠ¶æ€æœºé…ç½®è¡¥å¿ç­–ç•¥ï¼š
    </p>
    <pre><code class="prism language-java"><span class="token annotation punctuation">@SagaStart</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createOrderSaga</span><span class="token punctuation">(</span><span class="token class-name">Order</span> order<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 1. åˆ›å»ºè®¢å•</span>
    orderService<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2. è°ƒç”¨æ”¯ä»˜æœåŠ¡ï¼ˆè‹¥å¤±è´¥åˆ™è§¦å‘é€†å‘æ“ä½œï¼‰</span>
    paymentService<span class="token punctuation">.</span><span class="token function">pay</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// å®šä¹‰è¡¥å¿æ–¹æ³•</span>
<span class="token annotation punctuation">@Compensate</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">compensateOrder</span><span class="token punctuation">(</span><span class="token class-name">Order</span> order<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    orderService<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     <strong>
      åŸç†
     </strong>
     ï¼šé•¿äº‹åŠ¡æ‹†åˆ†+é€†å‘è¡¥å¿
     <br/>
     <strong>
      é€‚ç”¨åœºæ™¯
     </strong>
     ï¼šè·¨ç³»ç»Ÿé•¿æ—¶é—´æ“ä½œï¼ˆå¦‚è®¢å•+ç‰©æµ+æ”¯ä»˜ï¼‰
    </p>
    <hr/>
    <h3>
     <a id="3__350">
     </a>
     3. æ€»ç»“
    </h3>
    <h4>
     <a id="_352">
     </a>
     æ¨¡å¼é€‰å‹å¯¹ç…§è¡¨
    </h4>
    <table>
     <thead>
      <tr>
       <th align="left">
        æ¨¡å¼
       </th>
       <th align="left">
        ä¸€è‡´æ€§
       </th>
       <th align="left">
        æ€§èƒ½
       </th>
       <th align="left">
        ä¾µå…¥æ€§
       </th>
       <th align="left">
        é€‚ç”¨åœºæ™¯
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td align="left">
        <strong>
         AT
        </strong>
       </td>
       <td align="left">
        å¼±ä¸€è‡´
       </td>
       <td align="left">
        é«˜
       </td>
       <td align="left">
        ä½
       </td>
       <td align="left">
        å¸¸è§„ä¸šåŠ¡ï¼ˆåº“å­˜æ‰£å‡ã€è®¢å•åˆ›å»ºï¼‰
       </td>
      </tr>
      <tr>
       <td align="left">
        <strong>
         TCC
        </strong>
       </td>
       <td align="left">
        å¼ºä¸€è‡´
       </td>
       <td align="left">
        ä¸­
       </td>
       <td align="left">
        é«˜
       </td>
       <td align="left">
        èµ„é‡‘äº¤æ˜“ã€éœ€ç²¾å‡†æ§åˆ¶
       </td>
      </tr>
      <tr>
       <td align="left">
        <strong>
         XA
        </strong>
       </td>
       <td align="left">
        å¼ºä¸€è‡´
       </td>
       <td align="left">
        ä½
       </td>
       <td align="left">
        ä½
       </td>
       <td align="left">
        é“¶è¡Œè½¬è´¦ã€çŸ­äº‹åŠ¡
       </td>
      </tr>
      <tr>
       <td align="left">
        <strong>
         Saga
        </strong>
       </td>
       <td align="left">
        æœ€ç»ˆä¸€è‡´
       </td>
       <td align="left">
        é«˜
       </td>
       <td align="left">
        ä¸­
       </td>
       <td align="left">
        è·¨ç³»ç»Ÿé•¿æµç¨‹ï¼ˆè®¢å•+ç‰©æµ+æ”¯ä»˜ï¼‰
       </td>
      </tr>
     </tbody>
    </table>
    <h4>
     <a id="_361">
     </a>
     æ ¸å¿ƒè¦ç‚¹
    </h4>
    <table>
     <thead>
      <tr>
       <th align="left">
        åˆ†ç±»
       </th>
       <th align="center">
        è¦ç‚¹è¯´æ˜
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td align="left">
        <strong>
         é€‰å‹
        </strong>
       </td>
       <td align="center">
        <strong>
         ATæ¨¡å¼é€‚ç”¨äºå¤§å¤šæ•°åœºæ™¯ï¼ŒTCCé€‚åˆé«˜æ€§èƒ½è¦æ±‚ï¼ŒXAé€‚åˆå¼ºä¸€è‡´æ€§
        </strong>
       </td>
      </tr>
      <tr>
       <td align="left">
        <strong>
         é…ç½®
        </strong>
       </td>
       <td align="center">
        ç¡®ä¿seata-serverä¸å¾®æœåŠ¡çš„registryé…ç½®ä¸€è‡´
       </td>
      </tr>
      <tr>
       <td align="left">
        <strong>
         äº‹åŠ¡ID
        </strong>
       </td>
       <td align="center">
        é€šè¿‡
        <code>
         RootContext.getXID()
        </code>
        å¯è·å–å½“å‰äº‹åŠ¡ID
       </td>
      </tr>
      <tr>
       <td align="left">
        <strong>
         æ’é”™
        </strong>
       </td>
       <td align="center">
        æ£€æŸ¥undo_logè¡¨è®°å½•ï¼ŒæŸ¥çœ‹seata-serveræ§åˆ¶å°æ—¥å¿—
       </td>
      </tr>
     </tbody>
    </table>
    <h4>
     <a id="_370">
     </a>
     æœ€ä½³å®è·µ
    </h4>
    <ol>
     <li>
      ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨Nacosä½œä¸ºé…ç½®ä¸­å¿ƒ
     </li>
     <li>
      ATæ¨¡å¼éœ€è¦å¼€å¯æ•°æ®åº“çš„æœ¬åœ°äº‹åŠ¡æ”¯æŒï¼ˆå¦‚MySQLçš„InnoDBå¼•æ“ï¼‰
     </li>
     <li>
      å…¨å±€äº‹åŠ¡è¶…æ—¶æ—¶é—´å»ºè®®è®¾ç½®ï¼š
      <code>
       seata.tx.timeout=60000
      </code>
      ï¼ˆå•ä½æ¯«ç§’ï¼‰
     </li>
    </ol>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f6d305f36333934393230332f:61727469636c652f64657461696c732f313436313238393737" class_="artid" style="display:none">
 </p>
</div>


