---
layout: post
title: "Nginxä¸­http_hosthostproxy_hostçš„åŒºåˆ«"
date: 2025-03-07 22:30:58 +0800
description: "å˜é‡æ˜¯å¦æ˜¾ç¤ºç«¯å£å€¼æ˜¯å¦å­˜åœ¨hostæµè§ˆå™¨è¯·æ±‚çš„ipï¼Œä¸æ˜¾ç¤ºç«¯å£å¦\"Host:value\"æ˜¾ç¤ºå€¼ä¸ºa:bçš„æ—¶å€™ï¼Œåªæ˜¾ç¤ºahttp_hostæµè§ˆå™¨è¯·æ±‚çš„ipå’Œç«¯å£å·æ˜¯â€œHost:valueâ€ï¼Œvalueå­˜åœ¨å°±æ˜¾ç¤ºproxy_hostè¢«ä»£ç†æœåŠ¡çš„ipå’Œç«¯å£å·é»˜è®¤80ä¸æ˜¾ç¤ºå…¶ä»–ç«¯å£æ˜¾ç¤º\"Host:value\"æ˜¾ç¤ºé…ç½®åå‘ä»£ç†æ—¶ï¼Œæ¥å£è¯·æ±‚æŠ¥404é—®é¢˜åº”ç”¨æè¿°ï¼šå‰ç«¯åº”ç”¨åŸŸåä¸ºAï¼ˆww.a.comï¼‰, åç«¯æœåŠ¡åŸŸåä¸ºBï¼ˆwww.b.comï¼‰;"
keywords: "Nginxä¸­$http_hostã€$hostã€$proxy_hostçš„åŒºåˆ«"
categories: ['é¢è¯•', 'é˜¿é‡Œå·´å·´', 'å­¦ä¹ è·¯çº¿']
tags: ['è¿ç»´', 'Nginx', 'Http']
artid: "146106966"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146106966
    alt: "Nginxä¸­http_hosthostproxy_hostçš„åŒºåˆ«"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146106966
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146106966
cover: https://bing.ee123.net/img/rand?artid=146106966
image: https://bing.ee123.net/img/rand?artid=146106966
img: https://bing.ee123.net/img/rand?artid=146106966
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Nginxä¸­$http_hostã€$hostã€$proxy_hostçš„åŒºåˆ«
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     <strong>
      çŸ¥è¯†å·©å›ºï¼
     </strong>
    </p>
    <p>
     <strong>
      ç½‘ä¸Šçœ‹åˆ°è¿™ç¯‡æ–‡ç« ï¼Œè¿™é‡Œè½¬è½½è®°å½•ä¸€ä¸‹ã€‚
     </strong>
    </p>
    <h3>
     <a id="_8">
     </a>
     ç®€ä»‹
    </h3>
    <p>
     å˜é‡
    </p>
    <p>
     æ˜¯å¦æ˜¾ç¤ºç«¯å£
    </p>
    <p>
     å€¼æ˜¯å¦å­˜åœ¨
    </p>
    <p>
     host
    </p>
    <p>
     æµè§ˆå™¨è¯·æ±‚çš„ipï¼Œä¸æ˜¾ç¤ºç«¯å£
    </p>
    <p>
     å¦
    </p>
    <p>
     "Host:value"æ˜¾ç¤º
    </p>
    <p>
     å€¼ä¸ºa:bçš„æ—¶å€™ï¼Œåªæ˜¾ç¤ºa
    </p>
    <p>
     http_host
    </p>
    <p>
     æµè§ˆå™¨è¯·æ±‚çš„ipå’Œç«¯å£å·
    </p>
    <p>
     æ˜¯
    </p>
    <p>
     â€œHost:valueâ€ï¼Œvalueå­˜åœ¨å°±æ˜¾ç¤º
    </p>
    <p>
     proxy_host
    </p>
    <p>
     è¢«ä»£ç†æœåŠ¡çš„ipå’Œç«¯å£å·
    </p>
    <p>
     é»˜è®¤80ä¸æ˜¾ç¤º
    </p>
    <p>
     å…¶ä»–ç«¯å£æ˜¾ç¤º
    </p>
    <p>
     "Host:value"æ˜¾ç¤º
    </p>
    <p>
     é…ç½®åå‘ä»£ç†æ—¶ï¼Œæ¥å£è¯·æ±‚æŠ¥404é—®é¢˜
    </p>
    <p>
     åº”ç”¨æè¿°ï¼šå‰ç«¯åº”ç”¨åŸŸåä¸ºAï¼ˆww.a.comï¼‰, åç«¯æœåŠ¡åŸŸåä¸ºBï¼ˆwww.b.comï¼‰; ä¸ºäº†è§£å†³è·¨åŸŸé—®é¢˜ï¼Œé…ç½®nginxåå‘ä»£ç†å¦‚ä¸‹ï¼š
    </p>
    <p>
     â€¦
     <br/>
     proxy_set_header Host
     <span class="katex--inline">
      KaTeX parse error: Undefined control sequence: \* at position 54: â€¦write "^/api/(.\Ì²*Ì²)
     </span>
     " /$1 break;
     <br/>
     proxy_pass http://www.b.com;
     <br/>
     }
     <br/>
     é—®é¢˜ï¼šè¿™æ ·é…ç½®å®Œæˆåï¼Œæ¥å£æŠ¥404é—®é¢˜ã€‚
    </p>
    <p>
     è§£å†³ï¼š
     <br/>
     æ–¹æ¡ˆä¸€ï¼šå°†proxy_set_headeræ³¨é‡Šæ‰
     <br/>
     æ–¹æ¡ˆäºŒï¼šä¿®æ”¹åå‘ä»£ç†é…ç½®ï¼Œè®¾ç½®è¯·æ±‚å¤´Hostï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <p>
     location ^~ /api/ {
     <!-- -->
     <br/>
     rewrite â€œ^/api/(.*)$â€ /$1 break;
     <br/>
     proxy_pass http://www.b.com;
     <br/>
     <strong>
      proxy_set_header Host $proxy_host; //æ–¹å¼ä¸€ï¼šè®¾ç½®è¯·æ±‚å¤´hostä¸ºwww.b.comçš„ipå’Œç«¯å£å·
      <br/>
      proxy_set_header Host www.b.com; //æ–¹å¼äºŒï¼šè®¾ç½®è¯·æ±‚hostä¸ºwww.b.com
     </strong>
     <br/>
     }
    </p>
    <h3>
     <a id="nginxproxy_set_header_Host_host_70">
     </a>
     nginxä¸­proxy_set_header Host $hostçš„ä½œç”¨
    </h3>
    <p>
     nginxä¸ºäº†å®ç°åå‘ä»£ç†çš„éœ€æ±‚è€Œå¢åŠ äº†ä¸€ä¸ªngx_http_proxy_moduleæ¨¡å—ã€‚å…¶ä¸­proxy_set_headeræŒ‡ä»¤å°±æ˜¯è¯¥æ¨¡å—éœ€è¦è¯»å–çš„é…ç½®æ–‡ä»¶ã€‚åœ¨è¿™é‡Œï¼Œæ‰€æœ‰è®¾ç½®çš„å€¼çš„å«ä¹‰å’Œhttpè¯·æ±‚ä½“ä¸­çš„å«ä¹‰å®Œå…¨ç›¸åŒï¼Œé™¤äº†Hostå¤–è¿˜æœ‰X-Forward-Forã€‚
    </p>
    <p>
     Hostçš„å«ä¹‰æ˜¯è¡¨æ˜è¯·æ±‚çš„ä¸»æœºåï¼Œå› ä¸ºnginxä½œä¸ºåå‘ä»£ç†ä½¿ç”¨ï¼Œ
     <strong>
      è€Œå¦‚æœåç«¯çœŸå®æœåŠ¡å™¨è®¾ç½®æœ‰ç±»ä¼¼é˜²ç›—é“¾æˆ–è€…æ ¹æ®httpè¯·æ±‚å¤´ä¸­çš„hostå­—æ®µæ¥è¿›è¡Œè·¯ç”±æˆ–åˆ¤æ–­åŠŸèƒ½çš„è¯ï¼Œå¦‚æœåå‘ä»£ç†å±‚çš„nginxä¸é‡å†™è¯·æ±‚å¤´ä¸­çš„hostå­—æ®µï¼Œå°†ä¼šå¯¼è‡´è¯·æ±‚å¤±è´¥
     </strong>
     ã€é»˜è®¤åå‘ä»£ç†æœåŠ¡å™¨ä¼šå‘åç«¯çœŸå®æœåŠ¡å™¨å‘é€è¯·æ±‚ï¼Œå¹¶ä¸”è¯·æ±‚å¤´ä¸­çš„hostå­—æ®µåº”ä¸ºproxy_passæŒ‡ä»¤è®¾ç½®çš„æœåŠ¡å™¨ã€‘
    </p>
    <p>
     åŒç†ï¼ŒX_Forward_Forå­—æ®µè¡¨ç¤ºè¯¥æ¡httpè¯·æ±‚æ˜¯ç”±è°å‘èµ·çš„ï¼Ÿå¦‚æœåå‘ä»£ç†æœåŠ¡å™¨ä¸é‡å†™è¯¥è¯·æ±‚å¤´çš„è¯ï¼Œé‚£ä¹ˆåç«¯çœŸå®æœåŠ¡å™¨åœ¨å¤„ç†æ—¶ä¼šè®¤ä¸ºæ‰€æœ‰çš„è¯·æ±‚éƒ½æ¥åœ¨åå‘ä»£ç†æœåŠ¡å™¨ï¼Œå¦‚æœåç«¯æœ‰é˜²æ”»å‡»ç­–ç•¥çš„è¯ï¼Œé‚£ä¹ˆæœºå™¨å°±è¢«å°æ‰äº†ã€‚å› æ­¤ï¼Œåœ¨é…ç½®ç”¨ä½œåå‘ä»£ç†çš„nginxä¸­ä¸€èˆ¬ä¼šå¢åŠ ä¸¤æ¡é…ç½®ï¼Œä¿®æ”¹httpçš„è¯·æ±‚å¤´ã€‚
    </p>
    <p>
     1
    </p>
    <p>
     2
    </p>
    <p>
     <code>
      proxy_set_header Host $http_host;
     </code>
    </p>
    <p>
     <code>
      proxy_set_header X-Forward-For $remote_addr;
     </code>
    </p>
    <p>
     è¿™é‡Œçš„
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        h 
        
       
         t 
        
       
         t 
        
       
         p 
        
       
         _ 
        
       
         h 
        
       
         o 
        
       
         s 
        
       
         t 
        
       
         å’Œ 
        
       
      
        http\_hostå’Œ
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 1.0044em; vertical-align: -0.31em;">
         </span>
         <span class="mord mathnormal">
          h
         </span>
         <span class="mord mathnormal">
          ttp
         </span>
         <span class="mord" style="margin-right: 0.0278em;">
          _
         </span>
         <span class="mord mathnormal">
          h
         </span>
         <span class="mord mathnormal">
          os
         </span>
         <span class="mord mathnormal">
          t
         </span>
         <span class="mord cjk_fallback">
          å’Œ
         </span>
        </span>
       </span>
      </span>
     </span>
     remote_addréƒ½æ˜¯nginxçš„å¯¼å‡ºå˜é‡ï¼Œå¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­ç›´æ¥ä½¿ç”¨ã€‚å¦‚æœHostè¯·æ±‚å¤´éƒ¨æ²¡æœ‰å‡ºç°åœ¨è¯·æ±‚å¤´ä¸­ï¼Œåˆ™
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        h 
        
       
         t 
        
       
         t 
        
       
         p 
        
       
         _ 
        
       
         h 
        
       
         o 
        
       
         s 
        
       
         t 
        
       
         å€¼ä¸ºç©ºï¼Œä½†æ˜¯ 
        
       
      
        http\_hostå€¼ä¸ºç©ºï¼Œä½†æ˜¯
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 1.0044em; vertical-align: -0.31em;">
         </span>
         <span class="mord mathnormal">
          h
         </span>
         <span class="mord mathnormal">
          ttp
         </span>
         <span class="mord" style="margin-right: 0.0278em;">
          _
         </span>
         <span class="mord mathnormal">
          h
         </span>
         <span class="mord mathnormal">
          os
         </span>
         <span class="mord mathnormal">
          t
         </span>
         <span class="mord cjk_fallback">
          å€¼ä¸ºç©ºï¼Œä½†æ˜¯
         </span>
        </span>
       </span>
      </span>
     </span>
     hostå€¼ä¸ºä¸»åŸŸåã€‚å› æ­¤ï¼Œä¸€èˆ¬è€Œè¨€ï¼Œä¼šç”¨
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        h 
        
       
         o 
        
       
         s 
        
       
         t 
        
       
         ä»£æ›¿ 
        
       
      
        hostä»£æ›¿
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.6944em;">
         </span>
         <span class="mord mathnormal">
          h
         </span>
         <span class="mord mathnormal">
          os
         </span>
         <span class="mord mathnormal">
          t
         </span>
         <span class="mord cjk_fallback">
          ä»£æ›¿
         </span>
        </span>
       </span>
      </span>
     </span>
     http_hostå˜é‡ï¼Œä»è€Œé¿å…httpè¯·æ±‚ä¸­ä¸¢å¤±Hostå¤´éƒ¨çš„æƒ…å†µä¸‹Hostä¸è¢«é‡å†™çš„å¤±è¯¯ã€‚
    </p>
    <p>
     X-Forwarded-Forï¼šç®€ç§°XFFå¤´ï¼Œå®ƒä»£è¡¨å®¢æˆ·ç«¯ï¼Œä¹Ÿå°±æ˜¯HTTPçš„è¯·æ±‚ç«¯çœŸå®çš„IPï¼Œåªæœ‰åœ¨é€šè¿‡äº†HTTP ä»£ç†æˆ–è€…è´Ÿè½½å‡è¡¡æœåŠ¡å™¨æ—¶æ‰ä¼šæ·»åŠ è¯¥é¡¹ã€‚ å®ƒä¸æ˜¯RFCä¸­å®šä¹‰çš„æ ‡å‡†è¯·æ±‚å¤´ä¿¡æ¯ï¼Œåœ¨squidç¼“å­˜ä»£ç†æœåŠ¡å™¨å¼€å‘æ–‡æ¡£ä¸­å¯ä»¥æ‰¾åˆ°è¯¥é¡¹çš„è¯¦ç»†ä»‹ç»ã€‚æ ‡å‡†æ ¼å¼å¦‚ä¸‹ï¼šX-Forwarded-For: client1, proxy1, proxy2ã€‚
    </p>
    <p>
     è¿™ä¸€HTTPå¤´ä¸€èˆ¬æ ¼å¼å¦‚ä¸‹ï¼šX-Forwarded-For: client1, proxy1, proxy2ã€‚å…¶ä¸­çš„å€¼é€šè¿‡ä¸€ä¸ªâ€œé€—å·+ç©ºæ ¼â€æŠŠå¤šä¸ªIPåœ°å€åŒºåˆ†å¼€, æœ€å·¦è¾¹(client1)æ˜¯æœ€åŸå§‹å®¢æˆ·ç«¯çš„IPåœ°å€, ä»£ç†æœåŠ¡å™¨æ¯æˆåŠŸæ”¶åˆ°ä¸€ä¸ªè¯·æ±‚ï¼Œå°±æŠŠ
     <strong>
      è¯·æ±‚æ¥æºIPåœ°å€
     </strong>
     æ·»åŠ åˆ°å³è¾¹ã€‚
    </p>
    <p>
     åœ¨ä¸Šé¢è¿™ä¸ªä¾‹å­ä¸­ï¼Œè¿™ä¸ªè¯·æ±‚æˆåŠŸé€šè¿‡äº†ä¸‰å°ä»£ç†æœåŠ¡å™¨ï¼šproxy1, proxy2 åŠ proxy3ã€‚è¯·æ±‚ç”±client1å‘å‡ºï¼Œåˆ°è¾¾äº†proxy3(proxy3å¯èƒ½æ˜¯è¯·æ±‚çš„ç»ˆç‚¹)ã€‚è¯·æ±‚åˆšä»client1ä¸­å‘å‡ºæ—¶ï¼ŒXFFæ˜¯ç©ºçš„ï¼Œè¯·æ±‚è¢«å‘å¾€proxy1ï¼›é€šè¿‡proxy1çš„æ—¶å€™ï¼Œclient1è¢«æ·»åŠ åˆ°XFFä¸­ï¼Œä¹‹åè¯·æ±‚è¢«å‘å¾€proxy2;é€šè¿‡proxy2çš„æ—¶å€™ï¼Œproxy1è¢«æ·»åŠ åˆ°XFFä¸­ï¼Œä¹‹åè¯·æ±‚è¢«å‘å¾€proxy3ï¼›é€šè¿‡proxy3æ—¶ï¼Œproxy2è¢«æ·»åŠ åˆ°XFFä¸­ï¼Œä¹‹åè¯·æ±‚çš„çš„å»å‘ä¸æ˜ï¼Œå¦‚æœproxy3ä¸æ˜¯è¯·æ±‚ç»ˆç‚¹ï¼Œè¯·æ±‚ä¼šè¢«ç»§ç»­è½¬å‘ã€‚
    </p>
    <p>
     é‰´äºä¼ªé€ è¿™ä¸€å­—æ®µéå¸¸å®¹æ˜“ï¼Œåº”è¯¥è°¨æ…ä½¿ç”¨X-Forwarded-Forå­—æ®µã€‚æ­£å¸¸æƒ…å†µä¸‹XFFä¸­æœ€åä¸€ä¸ªIPåœ°å€æ˜¯æœ€åä¸€ä¸ªä»£ç†æœåŠ¡å™¨çš„IPåœ°å€, è¿™é€šå¸¸æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¯é çš„ä¿¡æ¯æ¥æºã€‚
    </p>
    <h3>
     <a id="proxy_set_headerHostproxy_hosthostlocal_host_97">
     </a>
     proxy_set_headerè®¾ç½®Hostä¸º
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        p 
        
       
         r 
        
       
         o 
        
       
         x 
        
       
         y 
        
       
         _ 
        
       
         h 
        
       
         o 
        
       
         s 
        
       
         t 
        
       
         ï¼Œ 
        
       
      
        proxy\_hostï¼Œ
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 1.0044em; vertical-align: -0.31em;">
         </span>
         <span class="mord mathnormal">
          p
         </span>
         <span class="mord mathnormal">
          ro
         </span>
         <span class="mord mathnormal">
          x
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0359em;">
          y
         </span>
         <span class="mord" style="margin-right: 0.0278em;">
          _
         </span>
         <span class="mord mathnormal">
          h
         </span>
         <span class="mord mathnormal">
          os
         </span>
         <span class="mord mathnormal">
          t
         </span>
         <span class="mord cjk_fallback">
          ï¼Œ
         </span>
        </span>
       </span>
      </span>
     </span>
     hostä¸$local_hostçš„åŒºåˆ«
    </h3>
    <p>
     å…ˆæ¥çœ‹ä¸‹proxy_set_headerçš„è¯­æ³•ï¼š
     <code>
      **proxy_set_header**?`field``value`;
     </code>
    </p>
    <p>
     é»˜è®¤å€¼ï¼š
    </p>
    <p>
     1
    </p>
    <p>
     2
    </p>
    <p>
     <code>
      proxy_set_header Host $proxy_host;
     </code>
    </p>
    <p>
     <code>
      proxy_set_header Connection close;
     </code>
    </p>
    <p>
     ä¸Šä¸‹æ–‡ï¼š
     <code>
      http
     </code>
     ,
     <code>
      server
     </code>
     ,
     <code>
      location
     </code>
    </p>
    <p>
     ä½œç”¨ï¼šå…è®¸é‡æ–°å®šä¹‰æˆ–è€…æ·»åŠ å‘å¾€åç«¯æœåŠ¡å™¨çš„è¯·æ±‚å¤´ã€‚
     <code>
      value
     </code>
     å¯ä»¥åŒ…å«æ–‡æœ¬ã€å˜é‡æˆ–è€…å®ƒä»¬çš„ç»„åˆã€‚ å½“ä¸”ä»…å½“å½“å‰é…ç½®çº§åˆ«ä¸­æ²¡æœ‰å®šä¹‰
     <code>
      proxy_set_header
     </code>
     æŒ‡ä»¤æ—¶ï¼Œä¼šä»ä¸Šé¢çš„çº§åˆ«ç»§æ‰¿é…ç½®ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼Œåªæœ‰ä¸¤ä¸ªè¯·æ±‚å¤´ä¼šè¢«é‡æ–°å®šä¹‰ï¼š
    </p>
    <p>
     1
    </p>
    <p>
     2
    </p>
    <p>
     <code>
      proxy_set_header Host?????? $proxy_host;
     </code>
    </p>
    <p>
     <code>
      proxy_set_header Connection close;
     </code>
    </p>
    <p>
     nginxå¯¹äºupstreamé»˜è®¤ä½¿ç”¨çš„æ˜¯åŸºäºIPçš„è½¬å‘ï¼Œå› æ­¤å¯¹äºä»¥ä¸‹é…ç½®ï¼š
    </p>
    <p>
     1
    </p>
    <p>
     2
    </p>
    <p>
     3
    </p>
    <p>
     4
    </p>
    <p>
     5
    </p>
    <p>
     6
    </p>
    <p>
     7
    </p>
    <p>
     8
    </p>
    <p>
     9
    </p>
    <p>
     10
    </p>
    <p>
     11
    </p>
    <p>
     12
    </p>
    <p>
     13
    </p>
    <p>
     14
    </p>
    <p>
     15
    </p>
    <p>
     16
    </p>
    <p>
     17
    </p>
    <p>
     18
    </p>
    <p>
     19
    </p>
    <p>
     20
    </p>
    <p>
     21
    </p>
    <p>
     22
    </p>
    <p>
     23
    </p>
    <p>
     24
    </p>
    <p>
     25
    </p>
    <p>
     26
    </p>
    <p>
     <code>
      upstream backend {?
     </code>
    </p>
    <p>
     <code>
      ????????``server 127.0.0.1:8080;?
     </code>
    </p>
    <p>
     <code>
      ????``}?
     </code>
    </p>
    <p>
     <code>
      ????``upstream crmtest {?
     </code>
    </p>
    <p>
     <code>
      ????????``server crmtest.aty.sohuno.com;?
     </code>
    </p>
    <p>
     <code>
      ????``}?
     </code>
    </p>
    <p>
     <code>
      ????``server {?
     </code>
    </p>
    <p>
     <code>
      ????????????``listen?????? 80;?
     </code>
    </p>
    <p>
     <code>
      ????????????``server_name? chuan.aty.sohuno.com;?
     </code>
    </p>
    <p>
     <code>
      ????????????``proxy_set_header Host $http_host;?
     </code>
    </p>
    <p>
     <code>
      ????????????``proxy_set_header x-forwarded-for? $remote_addr;?
     </code>
    </p>
    <p>
     <code>
      ????????????``proxy_buffer_size???????? 64k;?
     </code>
    </p>
    <p>
     <code>
      ????????????``proxy_buffers???????????? 32 64k;?
     </code>
    </p>
    <p>
     <code>
      ????????????``charset utf-8;?
     </code>
    </p>
    <p>
     <code>
      ????????????``access_log? logs/host.access.log? main;?
     </code>
    </p>
    <p>
     <code>
      ????????????``location = /50x.html {?
     </code>
    </p>
    <p>
     <code>
      ????????????????``root?? html;?
     </code>
    </p>
    <p>
     <code>
      ????????????``}?
     </code>
    </p>
    <p>
     <code>
      ????????``location / {?
     </code>
    </p>
    <p>
     <code>
      ????????????``proxy_pass backend ;?
     </code>
    </p>
    <p>
     <code>
      ????????``}?
     </code>
    </p>
    <p>
     <code>
      ????????``location = /customer/straightcustomer/download {?
     </code>
    </p>
    <p>
     <code>
      ????????????``proxy_pass http://crmtest;?
     </code>
    </p>
    <p>
     <code>
      ????????????``proxy_set_header Host $proxy_host;?
     </code>
    </p>
    <p>
     <code>
      ????????``}?
     </code>
    </p>
    <p>
     <code>
      ????``}
     </code>
    </p>
    <p>
     å½“åŒ¹é…åˆ° /customer/straightcustomer/downloadæ—¶ï¼Œä½¿ç”¨crmtestå¤„ç†ï¼Œåˆ°upstreamå°±åŒ¹é…åˆ°crmtest.aty.sohuno.comï¼Œè¿™é‡Œç›´æ¥è½¬æ¢æˆIPè¿›è¡Œè½¬å‘äº†ã€‚å‡å¦‚crmtest.aty.sohuno.comæ˜¯åœ¨å¦ä¸€å°nginxä¸‹é…ç½®çš„ï¼Œipä¸º10.22.10.116ï¼Œåˆ™$proxy_hoståˆ™å¯¹åº”ä¸º10.22.10.116ã€‚æ­¤æ—¶ç›¸å½“äºè®¾ç½®äº†Hostä¸º10.22.10.116ã€‚
    </p>
    <p>
     1
    </p>
    <p>
     2
    </p>
    <p>
     3
    </p>
    <p>
     4
    </p>
    <p>
     5
    </p>
    <p>
     6
    </p>
    <p>
     7
    </p>
    <p>
     8
    </p>
    <p>
     9
    </p>
    <p>
     10
    </p>
    <p>
     11
    </p>
    <p>
     <code>
      // å¦‚æœæƒ³è®©Hostæ˜¯crmtest.aty.sohuno.comï¼Œåˆ™è¿›è¡Œå¦‚ä¸‹è®¾ç½®ï¼š
     </code>
    </p>
    <p>
     <code>
      proxy_set_header Host crmtest.aty.sohuno.com;
     </code>
    </p>
    <p>
     <code>
      // å¦‚æœä¸æƒ³æ”¹å˜è¯·æ±‚å¤´â€œHostâ€çš„å€¼ï¼Œå¯ä»¥è¿™æ ·æ¥è®¾ç½®ï¼š
     </code>
    </p>
    <p>
     <code>
      proxy_set_header Host $http_host;
     </code>
    </p>
    <p>
     <code>
      // ä½†æ˜¯ï¼Œå¦‚æœå®¢æˆ·ç«¯è¯·æ±‚å¤´ä¸­æ²¡æœ‰æºå¸¦è¿™ä¸ªå¤´éƒ¨ï¼Œé‚£ä¹ˆä¼ é€’åˆ°åç«¯æœåŠ¡å™¨çš„è¯·æ±‚ä¹Ÿä¸å«è¿™ä¸ªå¤´éƒ¨ã€‚
     </code>
    </p>
    <p>
     <code>
      // è¿™ç§æƒ…å†µä¸‹ï¼Œæ›´å¥½çš„æ–¹å¼æ˜¯ä½¿ç”¨$hostå˜é‡â€”â€”å®ƒçš„å€¼åœ¨è¯·æ±‚åŒ…å«â€œHostâ€è¯·æ±‚å¤´æ—¶ä¸ºâ€œHostâ€å­—æ®µçš„å€¼ï¼Œåœ¨è¯·æ±‚æœªæºå¸¦â€œHostâ€è¯·æ±‚å¤´æ—¶ä¸ºè™šæ‹Ÿä¸»æœºçš„ä¸»åŸŸåï¼š
     </code>
    </p>
    <p>
     <code>
      proxy_set_header Host?????? $host;
     </code>
    </p>
    <p>
     <code>
      // æ­¤å¤–ï¼ŒæœåŠ¡å™¨åå¯ä»¥å’Œåç«¯æœåŠ¡å™¨çš„ç«¯å£ä¸€èµ·ä¼ é€ï¼š
     </code>
    </p>
    <p>
     <code>
      proxy_set_header Host $host:$proxy_port;
     </code>
    </p>
    <p>
     <code>
      // å¦‚æœæŸä¸ªè¯·æ±‚å¤´çš„å€¼ä¸ºç©ºï¼Œé‚£ä¹ˆè¿™ä¸ªè¯·æ±‚å¤´å°†ä¸ä¼šä¼ é€ç»™åç«¯æœåŠ¡å™¨ï¼š
     </code>
    </p>
    <p>
     <code>
      proxy_set_header Accept-Encoding "";
     </code>
    </p>
    <h3>
     <a id="Nginx_276">
     </a>
     é€šè¿‡Nginxé…ç½®æ¼”ç¤ºï¼š
    </h3>
    <p>
     [root@ans3 conf]# cat nginx.conf
    </p>
    <pre><code>#user  nobody;
worker_processes  1;

#error_log  logs/error.log;
#error_log  logs/error.log  notice;
error_log  logs/error.log  info;
#pid        logs/nginx.pid;

events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  logs/access.log  main;
    sendfile        on;
    tcp_nopush     on;
    keepalive_timeout  65;

    server {
       listen       80;
       server_name  a.test.com;

       location / {
            proxy_pass http://10.0.0.50:8080;
            proxy_set_header X-Proxy-Host $proxy_host;
            proxy_set_header Host $http_host;
            index index.html index.htm;
       }
    }
}
</code></pre>
    <p>
     å¦ä¸€å°æœåŠ¡å™¨é…ç½®
    </p>
    <p>
     [root@master conf]# cat nginx.conf
    </p>
    <pre><code>#user  nobody;
worker_processes  1;

#error_log  logs/error.log;
#error_log  logs/error.log  notice;
#error_log  logs/error.log  info;
#pid        logs/nginx.pid;

events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    sendfile        on;
    keepalive_timeout  65;

    server {
        listen       8080;
        server_name  www.test.com aa.test.com;

        location / {
              return 200 'http_host=[$http_host] host=[$host] proxy_host=[$http_x_proxy_host]
';
        }
    }
}
</code></pre>
    <h4>
     <a id="_Host_353">
     </a>
     ä¸æºå¸¦è¯·æ±‚å¤´ Host
    </h4>
    <p>
     [root@ans3 conf]# curl -H â€˜Host:â€™ --http1.0 http://a.test.com
    </p>
    <p>
     http_host=[]
     <br/>
     host=[www.test.com]
     <br/>
     proxy_host=[10.0.0.50:8080]
    </p>
    <p>
     å˜é‡
    </p>
    <p>
     å€¼
    </p>
    <p>
     è¯´æ˜
    </p>
    <p>
     http_host
    </p>
    <p>
     è¯·æ±‚æ—  Host, åˆ™ http_host ä¸ºç©º, ç»§è€Œæ—  Host ä¼ åˆ° proxy
    </p>
    <p>
     host
    </p>
    <p>
     www.test.com
    </p>
    <p>
     proxy æ—  Host ä¼ å…¥, åˆ™ä½¿ç”¨å…¶ server_name çš„ç¬¬ä¸€é¡¹
    </p>
    <p>
     proxy_host
    </p>
    <p>
     10.0.0.50:8080
    </p>
    <p>
     å–è‡ªäº proxy_pass çš„å‚æ•°
    </p>
    <h4>
     <a id="_Host_383">
     </a>
     æºå¸¦è¯·æ±‚å¤´ Host
    </h4>
    <p>
     [root@ans3 conf]# curl -H â€˜HostğŸ”¤123â€™ --http1.0 http://a.test.com
    </p>
    <p>
     http_host=[abc:123]
     <br/>
     host=[abc]
     <br/>
     proxy_host=[10.0.0.50:8080]
    </p>
    <p>
     å˜é‡
    </p>
    <p>
     å€¼
    </p>
    <p>
     è¯´æ˜
    </p>
    <p>
     http_host
    </p>
    <p>
     abc:123
    </p>
    <p>
     ç»™å•¥æ‹¿å•¥
    </p>
    <p>
     host
    </p>
    <p>
     abc
    </p>
    <p>
     ç¬¬ä¸€ä¸ª
     <code>
      :
     </code>
     å‰çš„å†…å®¹(å°å†™)
    </p>
    <p>
     proxy_host
    </p>
    <p>
     10.0.0.50:8080
    </p>
    <p>
     å¸¦ç«¯å£æ˜¾ç¤º
    </p>
    <p>
     ä¿®æ”¹çœŸå®æœåŠ¡å™¨çš„ç«¯å£ä¸ºé»˜è®¤ç«¯å£
    </p>
    <p>
     http {
     <!-- -->
     <br/>
     include mime.types;
     <br/>
     default_type application/octet-stream;
    </p>
    <pre><code>log\_format  main  '$remote\_addr - $remote\_user \[$time\_local\] "$request" '
                  '$status $body\_bytes\_sent "$http\_referer" '
                  '"$http\_user\_agent" "$http\_x\_forwarded\_for"';

access\_log  logs/access.log  main;
sendfile        on;
tcp\_nopush     on;
keepalive\_timeout  65;

server {
    listen  80;
    server\_name  a.test.com;
    
    location / {
        proxy\_pass http://10.0.0.50:80;
        proxy\_set\_header X-Proxy-Host $proxy\_host;
        proxy\_set\_header Host $http\_host;
        index index.html index.htm;
   }
</code></pre>
    <p>
     }
     <br/>
     }
    </p>
    <p>
     http {
     <!-- -->
     <br/>
     include mime.types;
     <br/>
     default_type application/octet-stream;
    </p>
    <pre><code>sendfile        on;
keepalive\_timeout  65;

server {
    listen       80;
    server\_name www.test.com aa.test.com;


    location / {
         return 200 'http\_host=\[$http\_host\] host=\[$host\] proxy\_host= \[$http\_x\_proxy\_host\]
</code></pre>
    <p>
     ';
     <br/>
     }
     <br/>
     }
     <br/>
     }
    </p>
    <p>
     è®¿é—®æ—¶proxy_hostä¼šçœç•¥80ç«¯å£
    </p>
    <p>
     [root@ans3 conf]# curl -H
     <strong>
      â€˜HostğŸ”¤123â€™
     </strong>
     --http1.0 http://a.test.com
    </p>
    <p>
     http_host=[abc:123]
     <br/>
     host=[abc]
     <br/>
     proxy_host=[10.0.0.50]
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f6d305f37343832333433342f:61727469636c652f64657461696c732f313436313036393636" class_="artid" style="display:none">
 </p>
</div>


