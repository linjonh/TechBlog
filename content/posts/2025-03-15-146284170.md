---
layout: post
title: "IMX6ULL学习整理篇Linux驱动开发的基础3向新框架迁移"
date: 2025-03-15 19:34:31 +0800
description: "​\t我们知道Linux给我们的设备提供了文件的抽象，这里，我们看到了open和release中，可以指定操作具体的设备名称，办法就是设置file结构体中的private_data，也就是设置私有成员。\\n\");return 0;\\n\");return 0;​\t这样我们就可以在多设备中区分我们再操作哪一个设备了，当然LED我们看不出来。int major;int minor;} MyLED;return!\\n\");"
keywords: "IMX6ULL学习整理篇——Linux驱动开发的基础3：向新框架迁移"
categories: ['从0开始的学习Armv7A', 'Imx']
tags: ['驱动开发', '教程', '嵌入式硬件', '学习', 'Linux']
artid: "146284170"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146284170
    alt: "IMX6ULL学习整理篇Linux驱动开发的基础3向新框架迁移"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146284170
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146284170
cover: https://bing.ee123.net/img/rand?artid=146284170
image: https://bing.ee123.net/img/rand?artid=146284170
img: https://bing.ee123.net/img/rand?artid=146284170
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     IMX6ULL学习整理篇——Linux驱动开发的基础3：向新框架迁移
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="IMX6ULLLinux3_0">
     </a>
     IMX6ULL学习整理篇——Linux驱动开发的基础3：向新框架迁移
    </h2>
    <h3>
     <a id="_2">
     </a>
     前言
    </h3>
    <p>
     ​ 笔者说过，咱们之前使用的框架是老框架，开发是不推介使用的。我们学习只是为了先入门，理解一下流程，下面，我们来学习一下新框架字符设备的注册办法。
    </p>
    <h3>
     <a id="_6">
     </a>
     老字符设备框架为什么不好？
    </h3>
    <p>
     ​ 两个原因：
    </p>
    <ul>
     <li>
      <strong>
       设备号分配的局限性：
      </strong>
      使用
      <code>
       register_chrdev
      </code>
      时，开发者需要指定主设备号（
      <code>
       major
      </code>
      ）。如果将
      <code>
       major
      </code>
      参数设置为 0，系统会动态分配一个未使用的主设备号。然而，这种方式可能导致设备号冲突，或者占用不必要的次设备号范围，造成资源浪费。
     </li>
     <li>
      <strong>
       资源管理的复杂性：
      </strong>
      <code>
       register_chrdev
      </code>
      函数在注册字符设备时，会自动分配并注册一个字符设备结构（
      <code>
       cdev
      </code>
      ）。这种自动管理方式可能导致资源管理上的复杂性，增加了驱动程序的维护难度。
     </li>
     <li>
      没有剥离：申请设备号和建立对字符设备管理的分离，造成很高的耦合。
     </li>
    </ul>
    <p>
     ​ 举个例子，我只是想点一个LED，结果把所有主设备号为114下的次设备号全给占用了，而且，还不够智能。所以，我们需要一个资源分配更加细腻的框架，这就是为什么我们要向新框架迁移的原因。不必担心，改动几乎不大。这就是抽象的好处。
    </p>
    <h3>
     <a id="_16">
     </a>
     所以，在新的框架中，我们如何改进我们的程序？
    </h3>
    <h4>
     <a id="_18">
     </a>
     善用结构体完成我们的抽象
    </h4>
    <p>
     ​ 我们可以使用结构体来增加自己的实现，而无需改动接口来完成我们的抽象。这一点，笔者设计了一个结构体。
    </p>
    <pre><code class="prism language-c"><span class="token comment">/* we use a device struct */</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">__myled</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">cdev</span> char_dev_handle<span class="token punctuation">;</span>
    <span class="token class-name">dev_t</span>       dev_id<span class="token punctuation">;</span>
    <span class="token keyword">int</span>         major<span class="token punctuation">;</span>
    <span class="token keyword">int</span>         minor<span class="token punctuation">;</span>
<span class="token punctuation">}</span>MyLED<span class="token punctuation">;</span>

<span class="token keyword">static</span> MyLED myled<span class="token punctuation">;</span>
</code></pre>
    <p>
     ​ 关于cdev，我们下面会展开详细的介绍，这里先不着急说明。
    </p>
    <h4>
     <a id="register_chrdev_regionalloc_chrdev_regionunregister_chrdev_region_36">
     </a>
     使用register_chrdev_region和alloc_chrdev_region函数来完善我们的申请机制，使用unregister_chrdev_region来完成设备号的归还
    </h4>
    <p>
     ​
     <code>
      register_chrdev_region
     </code>
     和
     <code>
      alloc_chrdev_region
     </code>
     是用于分配和注册字符设备号的两个重要函数。它们的主要区别在于设备号的分配方式：
     <code>
      register_chrdev_region
     </code>
     需要开发者提供主设备号，而
     <code>
      alloc_chrdev_region
     </code>
     则由内核动态分配主设备号。
    </p>
    <h5>
     <a id="register_chrdev_region__40">
     </a>
     <strong>
      <code>
       register_chrdev_region
      </code>
      函数：
     </strong>
    </h5>
    <p>
     该函数用于在已知主设备号的情况下，注册一组连续的字符设备号。当开发者已经确定要使用的主设备号且确保其未被占用时，使用此函数。需要注意的是，使用前应检查
     <code>
      /proc/devices
     </code>
     以确保所选的主设备号未被占用。
    </p>
    <pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">register_chrdev_region</span><span class="token punctuation">(</span><span class="token class-name">dev_t</span> from<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> count<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <ul>
     <li>
      <code>
       from
      </code>
      ：要分配的设备编号范围的起始值，包含主设备号和次设备号。
     </li>
     <li>
      <code>
       count
      </code>
      ：需要分配的连续设备号的数量。
     </li>
     <li>
      <code>
       name
      </code>
      ：与设备号关联的设备名称。
     </li>
    </ul>
    <h5>
     <a id="alloc_chrdev_region__52">
     </a>
     <strong>
      <code>
       alloc_chrdev_region
      </code>
      函数：
     </strong>
    </h5>
    <p>
     该函数用于在主设备号未知的情况下，向内核动态申请未被占用的设备号。当开发者不确定或不关心具体的主设备号时，使用此函数让内核自动分配一个未被使用的主设备号。这种方式更简便，避免了手动选择主设备号可能引发的冲突。
    </p>
    <pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">alloc_chrdev_region</span><span class="token punctuation">(</span><span class="token class-name">dev_t</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> baseminor<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> count<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <ul>
     <li>
      <code>
       dev
      </code>
      ：指向
      <code>
       dev_t
      </code>
      类型的指针，用于存储分配到的设备号。
     </li>
     <li>
      <code>
       baseminor
      </code>
      ：次设备号的起始值。
     </li>
     <li>
      <code>
       count
      </code>
      ：需要分配的连续设备号的数量。
     </li>
     <li>
      <code>
       name
      </code>
      ：与设备号关联的设备名称。
     </li>
    </ul>
    <h5>
     <a id="unregister_chrdev_region__65">
     </a>
     <code>
      unregister_chrdev_region
     </code>
     函数
    </h5>
    <p>
     <code>
      unregister_chrdev_region
     </code>
     函数用于释放之前通过
     <code>
      register_chrdev_region
     </code>
     或
     <code>
      alloc_chrdev_region
     </code>
     分配的设备号。
    </p>
    <pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">unregister_chrdev_region</span><span class="token punctuation">(</span><span class="token class-name">dev_t</span> from<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <ul>
     <li>
      <code>
       from
      </code>
      ：要释放的设备号范围的起始值，通常使用
      <code>
       MKDEV(major, minor)
      </code>
      宏来生成。
     </li>
     <li>
      <code>
       count
      </code>
      ：需要释放的连续设备号的数量。
     </li>
    </ul>
    <p>
     在字符设备驱动程序的卸载函数中，
     <code>
      unregister_chrdev_region
     </code>
     通常与
     <code>
      cdev_del
     </code>
     搭配使用，以确保设备号和字符设备对象都被正确释放，避免资源泄漏。 通过正确使用
     <code>
      unregister_chrdev_region
     </code>
     ，可以确保字符设备驱动在卸载时释放相应的设备号资源，维护系统资源的有效管理。
    </p>
    <h4>
     <a id="cdev_78">
     </a>
     使用cdev体系升级我们的字符设备管理
    </h4>
    <p>
     ​ 现在，需要出场我们的cdev体系下的函数了。一般的，我们实际上就是用下面这三个函数完成管理一个字符设备：
     <code>
      cdev_init
     </code>
     、
     <code>
      cdev_add
     </code>
     和
     <code>
      cdev_del
     </code>
    </p>
    <h5>
     <a id="cdev_init__82">
     </a>
     <strong>
      <code>
       cdev_init
      </code>
      函数：
     </strong>
    </h5>
    <p>
     <code>
      cdev_init
     </code>
     用于初始化
     <code>
      cdev
     </code>
     结构体，并将其与文件操作结构体（
     <code>
      file_operations
     </code>
     ）关联。我们在注册字符设备之前，必须先初始化
     <code>
      cdev
     </code>
     结构体，并将其与相应的文件操作函数关联。
    </p>
    <pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">cdev_init</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">cdev</span> <span class="token operator">*</span>cdev<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> <span class="token operator">*</span>fops<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <ul>
     <li>
      <code>
       cdev
      </code>
      ：指向需要初始化的
      <code>
       cdev
      </code>
      结构体的指针。
     </li>
     <li>
      <code>
       fops
      </code>
      ：指向实现该设备操作的
      <code>
       file_operations
      </code>
      结构体的指针。
     </li>
    </ul>
    <h5>
     <a id="cdev_add__93">
     </a>
     <strong>
      <code>
       cdev_add
      </code>
      函数：
     </strong>
    </h5>
    <p>
     <code>
      cdev_add
     </code>
     将初始化后的
     <code>
      cdev
     </code>
     结构体添加到内核，使其在系统中生效。在初始化
     <code>
      cdev
     </code>
     结构体后，调用
     <code>
      cdev_add
     </code>
     将其注册到内核，使设备可供用户空间访问。
    </p>
    <pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">cdev_add</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">cdev</span> <span class="token operator">*</span>p<span class="token punctuation">,</span> <span class="token class-name">dev_t</span> dev<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <ul>
     <li>
      <p>
       <code>
        p
       </code>
       ：指向已初始化的
       <code>
        cdev
       </code>
       结构体的指针。
      </p>
     </li>
     <li>
      <p>
       <code>
        dev
       </code>
       ：设备号，包含主设备号和次设备号。
      </p>
     </li>
     <li>
      <p>
       <code>
        count
       </code>
       ：要注册的连续设备号的数量。
      </p>
     </li>
     <li>
      <p>
       成功时返回 0；失败时返回负的错误码。
      </p>
     </li>
    </ul>
    <h5>
     <a id="cdev_del__107">
     </a>
     <strong>
      <code>
       cdev_del
      </code>
      函数：
     </strong>
    </h5>
    <p>
     <code>
      cdev_del
     </code>
     从内核中移除已注册的
     <code>
      cdev
     </code>
     结构体，通常在驱动卸载时调用。在卸载字符设备驱动时，调用
     <code>
      cdev_del
     </code>
     从内核中移除设备，释放资源。
    </p>
    <pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">cdev_del</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">cdev</span> <span class="token operator">*</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <ul>
     <li>
      <code>
       p
      </code>
      ：指向要删除的
      <code>
       cdev
      </code>
      结构体的指针。
     </li>
    </ul>
    <h3>
     <a id="_117">
     </a>
     实际升级的结果
    </h3>
    <pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fs.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/uaccess.h&gt;</span>	</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/io.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/cdev.h&gt;</span></span>

<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"charliechen&lt;charliechen114514@demo.com&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LED_DEV_NAME</span>            <span class="token expression"><span class="token punctuation">(</span></span><span class="token string">"charlies_led"</span><span class="token expression"><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LED_DEV_N</span>               <span class="token expression"><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></span></span>
<span class="token comment">/* 
    LED Physical Address 
        See the manual
*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CCM_CCGR1_BASE</span>          <span class="token expression"><span class="token punctuation">(</span><span class="token number">0x020C406C</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIO1_IOLED_BASE</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token number">0x020E0068</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIO1_IOPAD_BASE</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token number">0x020E02F4</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIO1_IODR_BASE</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token number">0x0209C000</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIO1_GDIR_BASE</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token number">0x0209C004</span><span class="token punctuation">)</span></span></span>

<span class="token comment">/* mappings of the io phe*/</span>
<span class="token keyword">static</span> <span class="token keyword">void</span><span class="token operator">*</span> __iomem LED_CCGR1<span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">void</span><span class="token operator">*</span> __iomem LEDBASE<span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">void</span><span class="token operator">*</span> __iomem LEDPAD_BASE<span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">void</span><span class="token operator">*</span> __iomem LEDDR_BASE<span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">void</span><span class="token operator">*</span> __iomem LEDGDIR_BASE<span class="token punctuation">;</span>

<span class="token comment">/* we use a device struct */</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">__myled</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">cdev</span> char_dev_handle<span class="token punctuation">;</span>
    <span class="token class-name">dev_t</span>       dev_id<span class="token punctuation">;</span>
    <span class="token keyword">int</span>         major<span class="token punctuation">;</span>
    <span class="token keyword">int</span>         minor<span class="token punctuation">;</span>
<span class="token punctuation">}</span>MyLED<span class="token punctuation">;</span>

<span class="token keyword">static</span> MyLED myled<span class="token punctuation">;</span>

<span class="token comment">/* operations cached */</span>
<span class="token keyword">static</span> <span class="token keyword">char</span> operations_cached<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">;</span>


<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">__led_turn_on</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    u32 val <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    val <span class="token operator">=</span> <span class="token function">readl</span><span class="token punctuation">(</span>LEDDR_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    val <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">writel</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> LEDDR_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">__led_turn_off</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    u32 val <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    val <span class="token operator">=</span> <span class="token function">readl</span><span class="token punctuation">(</span>LEDDR_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    val <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">writel</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> LEDDR_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> u8 <span class="token function">__fetch_led_status</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    u32 val <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    val <span class="token operator">=</span> <span class="token function">readl</span><span class="token punctuation">(</span>LEDDR_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">!</span><span class="token punctuation">(</span>val <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">__enable_led_mappings</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> val <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"Ready to mappings the registers...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    LED_CCGR1 <span class="token operator">=</span> <span class="token function">ioremap</span><span class="token punctuation">(</span>CCM_CCGR1_BASE<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    LEDBASE <span class="token operator">=</span> <span class="token function">ioremap</span><span class="token punctuation">(</span>GPIO1_IOLED_BASE<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    LEDPAD_BASE <span class="token operator">=</span> <span class="token function">ioremap</span><span class="token punctuation">(</span>GPIO1_IOPAD_BASE<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    LEDDR_BASE <span class="token operator">=</span> <span class="token function">ioremap</span><span class="token punctuation">(</span>GPIO1_IODR_BASE<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    LEDGDIR_BASE <span class="token operator">=</span> <span class="token function">ioremap</span><span class="token punctuation">(</span>GPIO1_GDIR_BASE<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"mappings the registers done!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"LED_CCGR1     ioremap to: %p\n"</span><span class="token punctuation">,</span> LED_CCGR1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"LEDBASE       ioremap to: %p\n"</span><span class="token punctuation">,</span> LEDBASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"LEDPAD_BASE   ioremap to: %p\n"</span><span class="token punctuation">,</span> LEDPAD_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"LEDDR_BASE    ioremap to: %p\n"</span><span class="token punctuation">,</span> LEDDR_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"LEDGDIR_BASE  ioremap to: %p\n"</span><span class="token punctuation">,</span> LEDGDIR_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"initialize the led registers\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    val <span class="token operator">=</span> <span class="token function">readl</span><span class="token punctuation">(</span>LED_CCGR1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// clear the bits</span>
    val <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">&lt;&lt;</span> <span class="token number">26</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    val <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">&lt;&lt;</span> <span class="token number">26</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">writel</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> LED_CCGR1<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">writel</span><span class="token punctuation">(</span><span class="token number">0x5</span><span class="token punctuation">,</span> LEDBASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">writel</span><span class="token punctuation">(</span><span class="token number">0x10B0</span><span class="token punctuation">,</span> LEDPAD_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    val <span class="token operator">=</span> <span class="token function">readl</span><span class="token punctuation">(</span>LEDGDIR_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    val <span class="token operator">|=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token function">writel</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> LEDGDIR_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"operations of led is accessable!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">__disable_led_mappings</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">__led_turn_off</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"set the led turning off...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"set the led turning off done!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"Ready to unmappings the registers...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token function">iounmap</span><span class="token punctuation">(</span>LED_CCGR1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">iounmap</span><span class="token punctuation">(</span>LEDBASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">iounmap</span><span class="token punctuation">(</span>LEDPAD_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">iounmap</span><span class="token punctuation">(</span>LEDDR_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">iounmap</span><span class="token punctuation">(</span>LEDGDIR_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"unmappings the registers done\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">led_read</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span><span class="token operator">*</span> filp<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> buffer<span class="token punctuation">,</span> 
    <span class="token class-name">size_t</span> count<span class="token punctuation">,</span> <span class="token class-name">loff_t</span><span class="token operator">*</span> ppos<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> status <span class="token operator">=</span> <span class="token string">"opened"</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"\nled device is reading!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">__fetch_led_status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        status <span class="token operator">=</span> <span class="token string">"closed"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 
    ret <span class="token operator">=</span> <span class="token function">copy_to_user</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> status<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">pr_warn</span><span class="token punctuation">(</span><span class="token string">"Copy to the user failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">led_write</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span><span class="token operator">*</span> filp<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> buffer<span class="token punctuation">,</span> 
    <span class="token class-name">size_t</span> count<span class="token punctuation">,</span> <span class="token class-name">loff_t</span><span class="token operator">*</span> ppos<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> check <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"\nled device is ready writing!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    check <span class="token operator">=</span> <span class="token function">copy_from_user</span><span class="token punctuation">(</span>operations_cached<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>check <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">pr_warn</span><span class="token punctuation">(</span><span class="token string">"Can not copy from user!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>operations_cached<span class="token punctuation">,</span> <span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">__led_turn_on</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>operations_cached<span class="token punctuation">,</span> <span class="token string">"close"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">__led_turn_off</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">pr_warn</span><span class="token punctuation">(</span><span class="token string">"Can not find the indications operations!\n"</span>
                <span class="token string">"check the business: %s"</span><span class="token punctuation">,</span> operations_cached<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">led_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span><span class="token operator">*</span> inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span><span class="token operator">*</span> filp<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"\nled device is opened!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">led_close</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span><span class="token operator">*</span> inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span><span class="token operator">*</span> filp<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"\nled device is released!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> led_ops <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>open <span class="token operator">=</span> led_open<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>release <span class="token operator">=</span> led_close<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>write <span class="token operator">=</span> led_write<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>read <span class="token operator">=</span> led_read
<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token comment">/* register the device */</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">led_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>myled<span class="token punctuation">.</span>major<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        myled<span class="token punctuation">.</span>dev_id <span class="token operator">=</span> <span class="token function">MKDEV</span><span class="token punctuation">(</span>myled<span class="token punctuation">.</span>major<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret <span class="token operator">=</span> <span class="token function">register_chrdev_region</span><span class="token punctuation">(</span>myled<span class="token punctuation">.</span>dev_id<span class="token punctuation">,</span> LED_DEV_N<span class="token punctuation">,</span> LED_DEV_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        ret <span class="token operator">=</span> <span class="token function">alloc_chrdev_region</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>myled<span class="token punctuation">.</span>dev_id<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> LED_DEV_N<span class="token punctuation">,</span> LED_DEV_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
        myled<span class="token punctuation">.</span>major <span class="token operator">=</span> <span class="token function">MAJOR</span><span class="token punctuation">(</span>myled<span class="token punctuation">.</span>dev_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        myled<span class="token punctuation">.</span>minor <span class="token operator">=</span> <span class="token function">MINOR</span><span class="token punctuation">(</span>myled<span class="token punctuation">.</span>dev_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">pr_warn</span><span class="token punctuation">(</span><span class="token string">"Error in registering the device! Failed to register the region\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EIO<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"Success in registering the device major=%d, minor=%d\n"</span><span class="token punctuation">,</span>
            myled<span class="token punctuation">.</span>major<span class="token punctuation">,</span> myled<span class="token punctuation">.</span>minor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    myled<span class="token punctuation">.</span>char_dev_handle<span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">;</span>
    <span class="token function">cdev_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>myled<span class="token punctuation">.</span>char_dev_handle<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>led_ops<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">cdev_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>myled<span class="token punctuation">.</span>char_dev_handle<span class="token punctuation">)</span><span class="token punctuation">,</span> myled<span class="token punctuation">.</span>dev_id<span class="token punctuation">,</span> LED_DEV_N<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">__enable_led_mappings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">led_deinit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">cdev_del</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>myled<span class="token punctuation">.</span>char_dev_handle<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">unregister_chrdev_region</span><span class="token punctuation">(</span>myled<span class="token punctuation">.</span>dev_id<span class="token punctuation">,</span> LED_DEV_N<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">__disable_led_mappings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"Successfully unregister the device\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">module_init</span><span class="token punctuation">(</span>led_init<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>led_deinit<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     ​ 重点看看led_init和led_deinit函数，我们改造的区域就在这里。
    </p>
    <h3>
     <a id="_339">
     </a>
     测试
    </h3>
    <p>
     ​ 用户程序不用改，直接拿来用，现象和上一篇博客是一致的！
    </p>
    <pre><code>/module_test # ls
chrdev_application  led.ko
/module_test # insmod led.ko
Success in registering the device major=249, minor=0
Ready to mappings the registers...
mappings the registers done!
LED_CCGR1     ioremap to: f42c406c
LEDBASE       ioremap to: f42e0068
LEDPAD_BASE   ioremap to: f42e02f4
LEDDR_BASE    ioremap to: a09e6000
LEDGDIR_BASE  ioremap to: a09ee004
initialize the led registers
operations of led is accessable!
/module_test # mknod /dev/ccled c 249 0
/module_test # ./chrdev_application /dev/ccled read

led device is opened!
user process the read issue
led device is reading!

user receive from driver: closed
led device is released!
v 
/module_test # ./chrdev_application /dev/ccled write open

led device is opened!
args: 4
led device is ready writing!

user process the write issue: o
led device is released!
pen
/module_test # ./chrdev_application /dev/ccled write close

led device is opened!
args: 4
led device is ready writing!

user process the write issue: c
led device is released!
lose
/module_test # rmmod led.ko 
set the led turning off...
set the led turning off done!
Ready to unmappings the registers...
unmappings the registers done
Successfully unregister the device
</code></pre>
    <h3>
     <a id="device_393">
     </a>
     使用device类将我们的创建设备文件自动化
    </h3>
    <p>
     ​ 妈蛋！实在太麻烦了，我们还要看申请到了啥设备号才能创建设备文件，多麻烦啊，能不能自动申请呢？答案是可以的！
    </p>
    <h4>
     <a id="device_397">
     </a>
     device文件框架
    </h4>
    <p>
     ​ 在之前的 Linux 驱动开发实验中，我们在使用
     <code>
      modprobe
     </code>
     加载驱动程序后，需要通过
     <code>
      mknod
     </code>
     命令手动创建设备节点。然而，通过在驱动程序中实现自动创建设备节点的功能，我们可以在使用
     <code>
      modprobe
     </code>
     加载驱动模块成功后，自动在
     <code>
      /dev
     </code>
     目录下创建相应的设备文件。
    </p>
    <h5>
     <a id="mdev__401">
     </a>
     <strong>
      mdev 机制
     </strong>
    </h5>
    <p>
     ​ 在 Linux 系统中，
     <code>
      udev
     </code>
     是一个用户空间程序，用于动态管理设备文件的创建与删除。它能够检测系统中的硬件设备状态，根据变化来创建或删除设备文件。例如，当使用
     <code>
      modprobe
     </code>
     命令成功加载驱动模块后，
     <code>
      udev
     </code>
     会自动在
     <code>
      /dev
     </code>
     目录下创建对应的设备节点文件；使用
     <code>
      rmmod
     </code>
     命令卸载驱动模块后，
     <code>
      udev
     </code>
     会删除
     <code>
      /dev
     </code>
     目录下的相应设备节点文件。在嵌入式 Linux 中，
     <code>
      busybox
     </code>
     提供了一个简化版的
     <code>
      udev
     </code>
     ，称为
     <code>
      mdev
     </code>
     。
     <code>
      mdev
     </code>
     适用于嵌入式环境，用于实现设备节点文件的自动创建与删除。Linux 系统中的热插拔事件也由
     <code>
      mdev
     </code>
     管理。
    </p>
    <p>
     ​ 为了使
     <code>
      mdev
     </code>
     管理热插拔事件，需要在系统启动脚本（例如
     <code>
      /etc/init.d/rcS
     </code>
     ）中添加如下语句：
    </p>
    <pre><code class="prism language-bash"><span class="token builtin class-name">echo</span> /sbin/mdev <span class="token operator">&gt;</span> /proc/sys/kernel/hotplug
</code></pre>
    <p>
     上述命令设置热插拔事件由
     <code>
      mdev
     </code>
     来管理。
    </p>
    <p>
     <strong>
      创建和删除类
     </strong>
    </p>
    <p>
     要实现自动创建设备节点的功能，首先需要在驱动程序的入口函数中创建一个类（
     <code>
      class
     </code>
     ）。
     <code>
      class
     </code>
     是一个结构体，定义在内核头文件
     <code>
      include/linux/device.h
     </code>
     中。这个class可以认为是内核类的父类！可以使用
     <code>
      class_create
     </code>
     函数来创建类，其宏定义如下：
    </p>
    <pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">class_create</span><span class="token expression"><span class="token punctuation">(</span>owner<span class="token punctuation">,</span> name<span class="token punctuation">)</span>     </span><span class="token punctuation">\</span>
<span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>                                        </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">lock_class_key</span> __key<span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token function">__class_create</span><span class="token punctuation">(</span>owner<span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token operator">&amp;</span>__key<span class="token punctuation">)</span><span class="token punctuation">;</span>    </span><span class="token punctuation">\</span>
<span class="token expression"><span class="token punctuation">}</span><span class="token punctuation">)</span></span></span>
</code></pre>
    <p>
     展开宏后，函数原型为：
    </p>
    <pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">class</span> <span class="token operator">*</span><span class="token function">__class_create</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">module</span> <span class="token operator">*</span>owner<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">,</span>
                                  <span class="token keyword">struct</span> <span class="token class-name">lock_class_key</span> <span class="token operator">*</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     其中，参数
     <code>
      owner
     </code>
     一般为
     <code>
      THIS_MODULE
     </code>
     ，参数
     <code>
      name
     </code>
     是类的名称。返回值是指向结构体
     <code>
      class
     </code>
     的指针，即创建的类。在卸载驱动程序时，需要删除创建的类，使用
     <code>
      class_destroy
     </code>
     函数，其原型为：
    </p>
    <pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">class_destroy</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">class</span> <span class="token operator">*</span>cls<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     参数
     <code>
      cls
     </code>
     是要删除的类。
    </p>
    <p>
     <strong>
      创建设备
     </strong>
    </p>
    <p>
     创建好类后，还需要在该类下创建设备。可以使用
     <code>
      device_create
     </code>
     函数在类下创建设备，其原型为：
    </p>
    <pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span><span class="token function">device_create</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">class</span> <span class="token operator">*</span>class<span class="token punctuation">,</span>
                              <span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>parent<span class="token punctuation">,</span>
                              <span class="token class-name">dev_t</span> devt<span class="token punctuation">,</span>
                              <span class="token keyword">void</span> <span class="token operator">*</span>drvdata<span class="token punctuation">,</span>
                              <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>fmt<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <ul>
     <li>
      <code>
       class
      </code>
      ：设备要创建在哪个类下。
     </li>
     <li>
      <code>
       parent
      </code>
      ：父设备，通常为
      <code>
       NULL
      </code>
      ，表示没有父设备。
     </li>
     <li>
      <code>
       devt
      </code>
      ：设备号。
     </li>
     <li>
      <code>
       drvdata
      </code>
      ：设备可能会使用的一些数据，通常为
      <code>
       NULL
      </code>
      。
     </li>
     <li>
      <code>
       fmt
      </code>
      ：设备名称，如果设置为
      <code>
       xxx
      </code>
      ，则会生成
      <code>
       /dev/xxx
      </code>
      这个设备文件。
     </li>
    </ul>
    <p>
     返回值是创建的设备指针。同样地，在卸载驱动时，需要删除创建的设备，使用
     <code>
      device_destroy
     </code>
     函数，其原型为：
    </p>
    <pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">device_destroy</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">class</span> <span class="token operator">*</span>class<span class="token punctuation">,</span> <span class="token class-name">dev_t</span> devt<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     参数
     <code>
      class
     </code>
     是要删除的设备所处的类，参数
     <code>
      devt
     </code>
     是要删除的设备号。
    </p>
    <h3>
     <a id="_466">
     </a>
     完善我们的设备驱动
    </h3>
    <pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fs.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/uaccess.h&gt;</span>	</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/io.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/cdev.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/device.h&gt;</span></span>


<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"charliechen&lt;charliechen114514@demo.com&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LED_DEV_NAME</span>            <span class="token expression"><span class="token punctuation">(</span></span><span class="token string">"charlies_led"</span><span class="token expression"><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LED_DEV_N</span>               <span class="token expression"><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></span></span>
<span class="token comment">/* 
    LED Physical Address 
        See the manual
*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CCM_CCGR1_BASE</span>          <span class="token expression"><span class="token punctuation">(</span><span class="token number">0x020C406C</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIO1_IOLED_BASE</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token number">0x020E0068</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIO1_IOPAD_BASE</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token number">0x020E02F4</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIO1_IODR_BASE</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token number">0x0209C000</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIO1_GDIR_BASE</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token number">0x0209C004</span><span class="token punctuation">)</span></span></span>

<span class="token comment">/* mappings of the io phe*/</span>
<span class="token keyword">static</span> <span class="token keyword">void</span><span class="token operator">*</span> __iomem LED_CCGR1<span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">void</span><span class="token operator">*</span> __iomem LEDBASE<span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">void</span><span class="token operator">*</span> __iomem LEDPAD_BASE<span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">void</span><span class="token operator">*</span> __iomem LEDDR_BASE<span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">void</span><span class="token operator">*</span> __iomem LEDGDIR_BASE<span class="token punctuation">;</span>

<span class="token comment">/* we use a device struct */</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">__myled</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">cdev</span> char_dev_handle<span class="token punctuation">;</span>
    <span class="token class-name">dev_t</span>       dev_id<span class="token punctuation">;</span>
    <span class="token keyword">int</span>         major<span class="token punctuation">;</span>
    <span class="token keyword">int</span>         minor<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">class</span><span class="token operator">*</span>   led_class_handle<span class="token punctuation">;</span> 
    <span class="token keyword">struct</span> <span class="token class-name">device</span><span class="token operator">*</span>  led_handle_device<span class="token punctuation">;</span>
<span class="token punctuation">}</span>MyLED<span class="token punctuation">;</span>

<span class="token keyword">static</span> MyLED myled<span class="token punctuation">;</span>

<span class="token comment">/* operations cached */</span>
<span class="token keyword">static</span> <span class="token keyword">char</span> operations_cached<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">;</span>


<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">__led_turn_on</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    u32 val <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    val <span class="token operator">=</span> <span class="token function">readl</span><span class="token punctuation">(</span>LEDDR_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    val <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">writel</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> LEDDR_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">__led_turn_off</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    u32 val <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    val <span class="token operator">=</span> <span class="token function">readl</span><span class="token punctuation">(</span>LEDDR_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    val <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">writel</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> LEDDR_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> u8 <span class="token function">__fetch_led_status</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    u32 val <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    val <span class="token operator">=</span> <span class="token function">readl</span><span class="token punctuation">(</span>LEDDR_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">!</span><span class="token punctuation">(</span>val <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">__enable_led_mappings</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> val <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"Ready to mappings the registers...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    LED_CCGR1 <span class="token operator">=</span> <span class="token function">ioremap</span><span class="token punctuation">(</span>CCM_CCGR1_BASE<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    LEDBASE <span class="token operator">=</span> <span class="token function">ioremap</span><span class="token punctuation">(</span>GPIO1_IOLED_BASE<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    LEDPAD_BASE <span class="token operator">=</span> <span class="token function">ioremap</span><span class="token punctuation">(</span>GPIO1_IOPAD_BASE<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    LEDDR_BASE <span class="token operator">=</span> <span class="token function">ioremap</span><span class="token punctuation">(</span>GPIO1_IODR_BASE<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    LEDGDIR_BASE <span class="token operator">=</span> <span class="token function">ioremap</span><span class="token punctuation">(</span>GPIO1_GDIR_BASE<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"mappings the registers done!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"LED_CCGR1     ioremap to: %p\n"</span><span class="token punctuation">,</span> LED_CCGR1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"LEDBASE       ioremap to: %p\n"</span><span class="token punctuation">,</span> LEDBASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"LEDPAD_BASE   ioremap to: %p\n"</span><span class="token punctuation">,</span> LEDPAD_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"LEDDR_BASE    ioremap to: %p\n"</span><span class="token punctuation">,</span> LEDDR_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"LEDGDIR_BASE  ioremap to: %p\n"</span><span class="token punctuation">,</span> LEDGDIR_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"initialize the led registers\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    val <span class="token operator">=</span> <span class="token function">readl</span><span class="token punctuation">(</span>LED_CCGR1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// clear the bits</span>
    val <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">&lt;&lt;</span> <span class="token number">26</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    val <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">&lt;&lt;</span> <span class="token number">26</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">writel</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> LED_CCGR1<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">writel</span><span class="token punctuation">(</span><span class="token number">0x5</span><span class="token punctuation">,</span> LEDBASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">writel</span><span class="token punctuation">(</span><span class="token number">0x10B0</span><span class="token punctuation">,</span> LEDPAD_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    val <span class="token operator">=</span> <span class="token function">readl</span><span class="token punctuation">(</span>LEDGDIR_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    val <span class="token operator">|=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token function">writel</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> LEDGDIR_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"operations of led is accessable!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">__disable_led_mappings</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">__led_turn_off</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"set the led turning off...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"set the led turning off done!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"Ready to unmappings the registers...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token function">iounmap</span><span class="token punctuation">(</span>LED_CCGR1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">iounmap</span><span class="token punctuation">(</span>LEDBASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">iounmap</span><span class="token punctuation">(</span>LEDPAD_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">iounmap</span><span class="token punctuation">(</span>LEDDR_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">iounmap</span><span class="token punctuation">(</span>LEDGDIR_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"unmappings the registers done\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">led_read</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span><span class="token operator">*</span> filp<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> buffer<span class="token punctuation">,</span> 
    <span class="token class-name">size_t</span> count<span class="token punctuation">,</span> <span class="token class-name">loff_t</span><span class="token operator">*</span> ppos<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> status <span class="token operator">=</span> <span class="token string">"opened"</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"\nled device is reading!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">__fetch_led_status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        status <span class="token operator">=</span> <span class="token string">"closed"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 
    ret <span class="token operator">=</span> <span class="token function">copy_to_user</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> status<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">pr_warn</span><span class="token punctuation">(</span><span class="token string">"Copy to the user failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">led_write</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span><span class="token operator">*</span> filp<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> buffer<span class="token punctuation">,</span> 
    <span class="token class-name">size_t</span> count<span class="token punctuation">,</span> <span class="token class-name">loff_t</span><span class="token operator">*</span> ppos<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> check <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"\nled device is ready writing!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    check <span class="token operator">=</span> <span class="token function">copy_from_user</span><span class="token punctuation">(</span>operations_cached<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>check <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">pr_warn</span><span class="token punctuation">(</span><span class="token string">"Can not copy from user!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>operations_cached<span class="token punctuation">,</span> <span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">__led_turn_on</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>operations_cached<span class="token punctuation">,</span> <span class="token string">"close"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">__led_turn_off</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">pr_warn</span><span class="token punctuation">(</span><span class="token string">"Can not find the indications operations!\n"</span>
                <span class="token string">"check the business: %s"</span><span class="token punctuation">,</span> operations_cached<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">led_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span><span class="token operator">*</span> inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span><span class="token operator">*</span> filp<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"\nled device is opened!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">led_close</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span><span class="token operator">*</span> inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span><span class="token operator">*</span> filp<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"\nled device is released!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> led_ops <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>open <span class="token operator">=</span> led_open<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>release <span class="token operator">=</span> led_close<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>write <span class="token operator">=</span> led_write<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>read <span class="token operator">=</span> led_read
<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token comment">/* register the device */</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">led_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>myled<span class="token punctuation">.</span>major<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        myled<span class="token punctuation">.</span>dev_id <span class="token operator">=</span> <span class="token function">MKDEV</span><span class="token punctuation">(</span>myled<span class="token punctuation">.</span>major<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret <span class="token operator">=</span> <span class="token function">register_chrdev_region</span><span class="token punctuation">(</span>myled<span class="token punctuation">.</span>dev_id<span class="token punctuation">,</span> LED_DEV_N<span class="token punctuation">,</span> LED_DEV_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        ret <span class="token operator">=</span> <span class="token function">alloc_chrdev_region</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>myled<span class="token punctuation">.</span>dev_id<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> LED_DEV_N<span class="token punctuation">,</span> LED_DEV_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
        myled<span class="token punctuation">.</span>major <span class="token operator">=</span> <span class="token function">MAJOR</span><span class="token punctuation">(</span>myled<span class="token punctuation">.</span>dev_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        myled<span class="token punctuation">.</span>minor <span class="token operator">=</span> <span class="token function">MINOR</span><span class="token punctuation">(</span>myled<span class="token punctuation">.</span>dev_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">pr_warn</span><span class="token punctuation">(</span><span class="token string">"Error in registering the device! Failed to register the region\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EIO<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"Success in registering the device major=%d, minor=%d\n"</span><span class="token punctuation">,</span>
            myled<span class="token punctuation">.</span>major<span class="token punctuation">,</span> myled<span class="token punctuation">.</span>minor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    myled<span class="token punctuation">.</span>char_dev_handle<span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">;</span>
    <span class="token function">cdev_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>myled<span class="token punctuation">.</span>char_dev_handle<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>led_ops<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">cdev_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>myled<span class="token punctuation">.</span>char_dev_handle<span class="token punctuation">)</span><span class="token punctuation">,</span> myled<span class="token punctuation">.</span>dev_id<span class="token punctuation">,</span> LED_DEV_N<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">__enable_led_mappings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"Prepare to create the device class file...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    myled<span class="token punctuation">.</span>led_class_handle <span class="token operator">=</span> <span class="token function">class_create</span><span class="token punctuation">(</span>THIS_MODULE<span class="token punctuation">,</span> LED_DEV_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>myled<span class="token punctuation">.</span>led_class_handle<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>myled<span class="token punctuation">.</span>led_class_handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    myled<span class="token punctuation">.</span>led_handle_device <span class="token operator">=</span> <span class="token function">device_create</span><span class="token punctuation">(</span>
        myled<span class="token punctuation">.</span>led_class_handle<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> myled<span class="token punctuation">.</span>dev_id<span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> LED_DEV_NAME
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>myled<span class="token punctuation">.</span>led_handle_device<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>myled<span class="token punctuation">.</span>led_handle_device<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">led_deinit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"Ready to remove the hook of the device operating file\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">device_destroy</span><span class="token punctuation">(</span>myled<span class="token punctuation">.</span>led_class_handle<span class="token punctuation">,</span> myled<span class="token punctuation">.</span>dev_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">class_destroy</span><span class="token punctuation">(</span>myled<span class="token punctuation">.</span>led_class_handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"Ready to release the char dev handle\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">cdev_del</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>myled<span class="token punctuation">.</span>char_dev_handle<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"Ready to unhook the device region\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">unregister_chrdev_region</span><span class="token punctuation">(</span>myled<span class="token punctuation">.</span>dev_id<span class="token punctuation">,</span> LED_DEV_N<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">__disable_led_mappings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"Successfully unregister the device\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">module_init</span><span class="token punctuation">(</span>led_init<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>led_deinit<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <h3>
     <a id="_706">
     </a>
     测试
    </h3>
    <pre><code>/module_test # ls
chrdev_application  led.ko
/module_test # insmod led.ko 
Success in registering the device major=249, minor=0
Ready to mappings the registers...
mappings the registers done!
LED_CCGR1     ioremap to: f42c406c
LEDBASE       ioremap to: f42e0068
LEDPAD_BASE   ioremap to: f42e02f4
LEDDR_BASE    ioremap to: a09f6000
LEDGDIR_BASE  ioremap to: a09fe004
initialize the led registers
operations of led is accessable!
Prepare to create the device class file...
/module_test # ls /dev | grep charlies_led
charlies_led
/module_test # ./chrdev_application /dev/charlies_led read

led device is opened!
user process the read issue
led device is reading!

user receive from driver: closed
led device is released!
v 
/module_test # ./chrdev_application /dev/charlies_led write open

led device is opened!
args: 4
led device is ready writing!

user process the write issue: o
led device is released!
pen
/module_test # ./chrdev_application /dev/charlies_led write close

led device is opened!
args: 4
led device is ready writing!

user process the write issue: c
led device is released!
lose
/module_test # rmmod led.ko 
Ready to remove the hook of the device operating file
Ready to release the char dev handle
Ready to unhook the device region
set the led turning off...
set the led turning off done!
Ready to unmappings the registers...
unmappings the registers done
Successfully unregister the device
/module_test # ls /dev | grep charlies_led
</code></pre>
    <p>
     ​ 可以看到我们自动创建了设备文件！太裤了！
    </p>
    <h3>
     <a id="_766">
     </a>
     最后的完善：正式化我们的字符设备
    </h3>
    <h4>
     <a id="_768">
     </a>
     设置私有成员
    </h4>
    <p>
     ​ 我们知道Linux给我们的设备提供了文件的抽象，这里，我们看到了open和release中，可以指定操作具体的设备名称，办法就是设置file结构体中的private_data，也就是设置私有成员。
    </p>
    <pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">led_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span><span class="token operator">*</span> inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span><span class="token operator">*</span> filp<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"\nled device is opened!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    filp<span class="token operator">-&gt;</span>private_data <span class="token operator">=</span> <span class="token operator">&amp;</span>myled<span class="token punctuation">;</span> <span class="token comment">// private data here</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">led_close</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span><span class="token operator">*</span> inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span><span class="token operator">*</span> filp<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"\nled device is released!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     ​ 这样我们就可以在多设备中区分我们再操作哪一个设备了，当然LED我们看不出来。
    </p>
    <h4>
     <a id="gotorollback_789">
     </a>
     设置基于goto的rollback机制
    </h4>
    <p>
     ​ 我们多步申请资源的时候，出现了其中一步资源申请失败的场景时，就要回退。我们C语言只可使用rollback机制来进行回退，请看VCR：
    </p>
    <pre><code class="prism language-c"><span class="token comment">/* register the device */</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">led_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>myled<span class="token punctuation">.</span>major<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        myled<span class="token punctuation">.</span>dev_id <span class="token operator">=</span> <span class="token function">MKDEV</span><span class="token punctuation">(</span>myled<span class="token punctuation">.</span>major<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret <span class="token operator">=</span> <span class="token function">register_chrdev_region</span><span class="token punctuation">(</span>myled<span class="token punctuation">.</span>dev_id<span class="token punctuation">,</span> LED_DEV_N<span class="token punctuation">,</span> LED_DEV_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        ret <span class="token operator">=</span> <span class="token function">alloc_chrdev_region</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>myled<span class="token punctuation">.</span>dev_id<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> LED_DEV_N<span class="token punctuation">,</span> LED_DEV_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
        myled<span class="token punctuation">.</span>major <span class="token operator">=</span> <span class="token function">MAJOR</span><span class="token punctuation">(</span>myled<span class="token punctuation">.</span>dev_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        myled<span class="token punctuation">.</span>minor <span class="token operator">=</span> <span class="token function">MINOR</span><span class="token punctuation">(</span>myled<span class="token punctuation">.</span>dev_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">pr_warn</span><span class="token punctuation">(</span><span class="token string">"Error in registering the device! Failed to register the region\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> failed_register_chrdev_region<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"Success in registering the device major=%d, minor=%d\n"</span><span class="token punctuation">,</span>
            myled<span class="token punctuation">.</span>major<span class="token punctuation">,</span> myled<span class="token punctuation">.</span>minor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    myled<span class="token punctuation">.</span>char_dev_handle<span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">;</span>
    <span class="token function">cdev_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>myled<span class="token punctuation">.</span>char_dev_handle<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>led_ops<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">cdev_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>myled<span class="token punctuation">.</span>char_dev_handle<span class="token punctuation">)</span><span class="token punctuation">,</span> myled<span class="token punctuation">.</span>dev_id<span class="token punctuation">,</span> LED_DEV_N<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">pr_warn</span><span class="token punctuation">(</span><span class="token string">"Failed to add chardev into the kernel_list!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> failed_add_chardev<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"Prepare to create the device class file...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    myled<span class="token punctuation">.</span>led_class_handle <span class="token operator">=</span> <span class="token function">class_create</span><span class="token punctuation">(</span>THIS_MODULE<span class="token punctuation">,</span> LED_DEV_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>myled<span class="token punctuation">.</span>led_class_handle<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">// class creation failed, rollback!</span>
        <span class="token function">pr_warn</span><span class="token punctuation">(</span><span class="token string">"Failed to create the led class handle...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> failed_create_class<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    myled<span class="token punctuation">.</span>led_handle_device <span class="token operator">=</span> <span class="token function">device_create</span><span class="token punctuation">(</span>
        myled<span class="token punctuation">.</span>led_class_handle<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> myled<span class="token punctuation">.</span>dev_id<span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> LED_DEV_NAME
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>myled<span class="token punctuation">.</span>led_handle_device<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">pr_warn</span><span class="token punctuation">(</span><span class="token string">"Failed to create the led device ...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> failed_create_device<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">__enable_led_mappings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

failed_create_device<span class="token operator">:</span>
    <span class="token function">class_destroy</span><span class="token punctuation">(</span>myled<span class="token punctuation">.</span>led_class_handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
failed_create_class<span class="token operator">:</span>
    <span class="token function">cdev_del</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>myled<span class="token punctuation">.</span>char_dev_handle<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
failed_add_chardev<span class="token operator">:</span>
    <span class="token function">unregister_chrdev_region</span><span class="token punctuation">(</span>myled<span class="token punctuation">.</span>dev_id<span class="token punctuation">,</span> LED_DEV_N<span class="token punctuation">)</span><span class="token punctuation">;</span>
failed_register_chrdev_region<span class="token operator">:</span>
    <span class="token keyword">return</span> <span class="token operator">-</span>EIO<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     ​ 这种方法在 Linux 内核开发中被广泛采用，旨在确保在初始化过程中一旦发生错误，能够有序地释放已分配的资源，避免资源泄漏。函数开始时，尝试使用
     <code>
      register_chrdev_region
     </code>
     或
     <code>
      alloc_chrdev_region
     </code>
     注册字符设备区域，具体取决于是否已分配主设备号 (
     <code>
      myled.major
     </code>
     )。如果注册失败（即
     <code>
      ret &lt; 0
     </code>
     ），函数会记录警告信息，并跳转到标签
     <code>
      failed_register_chrdev_region
     </code>
     ，在该标签处，函数返回
     <code>
      -EIO
     </code>
     错误码，表示输入/输出错误。如果设备区域注册成功，函数继续初始化字符设备结构（
     <code>
      cdev_init
     </code>
     ）并将其添加到内核（
     <code>
      cdev_add
     </code>
     ）。如果
     <code>
      cdev_add
     </code>
     失败，函数会记录警告信息，并跳转到标签
     <code>
      failed_add_chardev
     </code>
     。在该标签处，函数调用
     <code>
      unregister_chrdev_region
     </code>
     注销之前注册的字符设备区域，以释放资源，然后返回错误码。接下来，函数尝试创建设备类（
     <code>
      class_create
     </code>
     ）。如果创建失败，函数会记录警告信息，并跳转到标签
     <code>
      failed_create_class
     </code>
     。在该标签处，函数首先调用
     <code>
      cdev_del
     </code>
     删除已添加的字符设备，然后调用
     <code>
      unregister_chrdev_region
     </code>
     注销字符设备区域，最后返回错误码。如果设备类创建成功，函数继续创建设备（
     <code>
      device_create
     </code>
     ）。如果设备创建失败，函数会记录警告信息，并跳转到标签
     <code>
      failed_create_device
     </code>
     。在该标签处，函数首先调用
     <code>
      class_destroy
     </code>
     销毁已创建的设备类，然后跳转到
     <code>
      failed_create_class
     </code>
     标签，执行后续的资源释放操作。
    </p>
    <h3>
     <a id="_853">
     </a>
     走到这里，我们最后的成果
    </h3>
    <pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fs.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/uaccess.h&gt;</span>	</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/io.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/types.h&gt;</span><span class="token expression">c</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/cdev.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/device.h&gt;</span></span>


<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"charliechen&lt;charliechen114514@demo.com&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LED_DEV_NAME</span>            <span class="token expression"><span class="token punctuation">(</span></span><span class="token string">"charlies_led"</span><span class="token expression"><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LED_DEV_N</span>               <span class="token expression"><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></span></span>
<span class="token comment">/* 
    LED Physical Address 
        See the manual
*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CCM_CCGR1_BASE</span>          <span class="token expression"><span class="token punctuation">(</span><span class="token number">0x020C406C</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIO1_IOLED_BASE</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token number">0x020E0068</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIO1_IOPAD_BASE</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token number">0x020E02F4</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIO1_IODR_BASE</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token number">0x0209C000</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIO1_GDIR_BASE</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token number">0x0209C004</span><span class="token punctuation">)</span></span></span>

<span class="token comment">/* mappings of the io phe*/</span>
<span class="token keyword">static</span> <span class="token keyword">void</span><span class="token operator">*</span> __iomem LED_CCGR1<span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">void</span><span class="token operator">*</span> __iomem LEDBASE<span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">void</span><span class="token operator">*</span> __iomem LEDPAD_BASE<span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">void</span><span class="token operator">*</span> __iomem LEDDR_BASE<span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">void</span><span class="token operator">*</span> __iomem LEDGDIR_BASE<span class="token punctuation">;</span>

<span class="token comment">/* we use a device struct */</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">__myled</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">cdev</span> char_dev_handle<span class="token punctuation">;</span>
    <span class="token class-name">dev_t</span>       dev_id<span class="token punctuation">;</span>
    <span class="token keyword">int</span>         major<span class="token punctuation">;</span>
    <span class="token keyword">int</span>         minor<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">class</span><span class="token operator">*</span>   led_class_handle<span class="token punctuation">;</span> 
    <span class="token keyword">struct</span> <span class="token class-name">device</span><span class="token operator">*</span>  led_handle_device<span class="token punctuation">;</span>
<span class="token punctuation">}</span>MyLED<span class="token punctuation">;</span>

<span class="token keyword">static</span> MyLED myled<span class="token punctuation">;</span>

<span class="token comment">/* operations cached */</span>
<span class="token keyword">static</span> <span class="token keyword">char</span> operations_cached<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">;</span>


<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">__led_turn_on</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    u32 val <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    val <span class="token operator">=</span> <span class="token function">readl</span><span class="token punctuation">(</span>LEDDR_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    val <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">writel</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> LEDDR_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">__led_turn_off</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    u32 val <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    val <span class="token operator">=</span> <span class="token function">readl</span><span class="token punctuation">(</span>LEDDR_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    val <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">writel</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> LEDDR_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> u8 <span class="token function">__fetch_led_status</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    u32 val <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    val <span class="token operator">=</span> <span class="token function">readl</span><span class="token punctuation">(</span>LEDDR_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">!</span><span class="token punctuation">(</span>val <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">__enable_led_mappings</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> val <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"Ready to mappings the registers...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    LED_CCGR1 <span class="token operator">=</span> <span class="token function">ioremap</span><span class="token punctuation">(</span>CCM_CCGR1_BASE<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    LEDBASE <span class="token operator">=</span> <span class="token function">ioremap</span><span class="token punctuation">(</span>GPIO1_IOLED_BASE<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    LEDPAD_BASE <span class="token operator">=</span> <span class="token function">ioremap</span><span class="token punctuation">(</span>GPIO1_IOPAD_BASE<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    LEDDR_BASE <span class="token operator">=</span> <span class="token function">ioremap</span><span class="token punctuation">(</span>GPIO1_IODR_BASE<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    LEDGDIR_BASE <span class="token operator">=</span> <span class="token function">ioremap</span><span class="token punctuation">(</span>GPIO1_GDIR_BASE<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"mappings the registers done!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"LED_CCGR1     ioremap to: %p\n"</span><span class="token punctuation">,</span> LED_CCGR1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"LEDBASE       ioremap to: %p\n"</span><span class="token punctuation">,</span> LEDBASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"LEDPAD_BASE   ioremap to: %p\n"</span><span class="token punctuation">,</span> LEDPAD_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"LEDDR_BASE    ioremap to: %p\n"</span><span class="token punctuation">,</span> LEDDR_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"LEDGDIR_BASE  ioremap to: %p\n"</span><span class="token punctuation">,</span> LEDGDIR_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"initialize the led registers\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    val <span class="token operator">=</span> <span class="token function">readl</span><span class="token punctuation">(</span>LED_CCGR1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// clear the bits</span>
    val <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">&lt;&lt;</span> <span class="token number">26</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    val <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">&lt;&lt;</span> <span class="token number">26</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">writel</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> LED_CCGR1<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">writel</span><span class="token punctuation">(</span><span class="token number">0x5</span><span class="token punctuation">,</span> LEDBASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">writel</span><span class="token punctuation">(</span><span class="token number">0x10B0</span><span class="token punctuation">,</span> LEDPAD_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    val <span class="token operator">=</span> <span class="token function">readl</span><span class="token punctuation">(</span>LEDGDIR_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    val <span class="token operator">|=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token function">writel</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> LEDGDIR_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"operations of led is accessable!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">__disable_led_mappings</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">__led_turn_off</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"set the led turning off...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"set the led turning off done!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"Ready to unmappings the registers...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token function">iounmap</span><span class="token punctuation">(</span>LED_CCGR1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">iounmap</span><span class="token punctuation">(</span>LEDBASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">iounmap</span><span class="token punctuation">(</span>LEDPAD_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">iounmap</span><span class="token punctuation">(</span>LEDDR_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">iounmap</span><span class="token punctuation">(</span>LEDGDIR_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"unmappings the registers done\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">led_read</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span><span class="token operator">*</span> filp<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> buffer<span class="token punctuation">,</span> 
    <span class="token class-name">size_t</span> count<span class="token punctuation">,</span> <span class="token class-name">loff_t</span><span class="token operator">*</span> ppos<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> status <span class="token operator">=</span> <span class="token string">"opened"</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"\nled device is reading!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">__fetch_led_status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        status <span class="token operator">=</span> <span class="token string">"closed"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 
    ret <span class="token operator">=</span> <span class="token function">copy_to_user</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> status<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">pr_warn</span><span class="token punctuation">(</span><span class="token string">"Copy to the user failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">led_write</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span><span class="token operator">*</span> filp<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> buffer<span class="token punctuation">,</span> 
    <span class="token class-name">size_t</span> count<span class="token punctuation">,</span> <span class="token class-name">loff_t</span><span class="token operator">*</span> ppos<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> check <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"\nled device is ready writing!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    check <span class="token operator">=</span> <span class="token function">copy_from_user</span><span class="token punctuation">(</span>operations_cached<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>check <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">pr_warn</span><span class="token punctuation">(</span><span class="token string">"Can not copy from user!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>operations_cached<span class="token punctuation">,</span> <span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">__led_turn_on</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>operations_cached<span class="token punctuation">,</span> <span class="token string">"close"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">__led_turn_off</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">pr_warn</span><span class="token punctuation">(</span><span class="token string">"Can not find the indications operations!\n"</span>
                <span class="token string">"check the business: %s"</span><span class="token punctuation">,</span> operations_cached<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">led_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span><span class="token operator">*</span> inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span><span class="token operator">*</span> filp<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"\nled device is opened!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    filp<span class="token operator">-&gt;</span>private_data <span class="token operator">=</span> <span class="token operator">&amp;</span>myled<span class="token punctuation">;</span> <span class="token comment">/* 设置私有数据 */</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">led_close</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span><span class="token operator">*</span> inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span><span class="token operator">*</span> filp<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"\nled device is released!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> led_ops <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>open <span class="token operator">=</span> led_open<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>release <span class="token operator">=</span> led_close<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>write <span class="token operator">=</span> led_write<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>read <span class="token operator">=</span> led_read
<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token comment">/* register the device */</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">led_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>myled<span class="token punctuation">.</span>major<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        myled<span class="token punctuation">.</span>dev_id <span class="token operator">=</span> <span class="token function">MKDEV</span><span class="token punctuation">(</span>myled<span class="token punctuation">.</span>major<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret <span class="token operator">=</span> <span class="token function">register_chrdev_region</span><span class="token punctuation">(</span>myled<span class="token punctuation">.</span>dev_id<span class="token punctuation">,</span> LED_DEV_N<span class="token punctuation">,</span> LED_DEV_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        ret <span class="token operator">=</span> <span class="token function">alloc_chrdev_region</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>myled<span class="token punctuation">.</span>dev_id<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> LED_DEV_N<span class="token punctuation">,</span> LED_DEV_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
        myled<span class="token punctuation">.</span>major <span class="token operator">=</span> <span class="token function">MAJOR</span><span class="token punctuation">(</span>myled<span class="token punctuation">.</span>dev_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        myled<span class="token punctuation">.</span>minor <span class="token operator">=</span> <span class="token function">MINOR</span><span class="token punctuation">(</span>myled<span class="token punctuation">.</span>dev_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">pr_warn</span><span class="token punctuation">(</span><span class="token string">"Error in registering the device! Failed to register the region\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> failed_register_chrdev_region<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"Success in registering the device major=%d, minor=%d\n"</span><span class="token punctuation">,</span>
            myled<span class="token punctuation">.</span>major<span class="token punctuation">,</span> myled<span class="token punctuation">.</span>minor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    myled<span class="token punctuation">.</span>char_dev_handle<span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">;</span>
    <span class="token function">cdev_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>myled<span class="token punctuation">.</span>char_dev_handle<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>led_ops<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">cdev_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>myled<span class="token punctuation">.</span>char_dev_handle<span class="token punctuation">)</span><span class="token punctuation">,</span> myled<span class="token punctuation">.</span>dev_id<span class="token punctuation">,</span> LED_DEV_N<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">pr_warn</span><span class="token punctuation">(</span><span class="token string">"Failed to add chardev into the kernel_list!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> failed_add_chardev<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"Prepare to create the device class file...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    myled<span class="token punctuation">.</span>led_class_handle <span class="token operator">=</span> <span class="token function">class_create</span><span class="token punctuation">(</span>THIS_MODULE<span class="token punctuation">,</span> LED_DEV_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>myled<span class="token punctuation">.</span>led_class_handle<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">// class creation failed, rollback!</span>
        <span class="token function">pr_warn</span><span class="token punctuation">(</span><span class="token string">"Failed to create the led class handle...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> failed_create_class<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    myled<span class="token punctuation">.</span>led_handle_device <span class="token operator">=</span> <span class="token function">device_create</span><span class="token punctuation">(</span>
        myled<span class="token punctuation">.</span>led_class_handle<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> myled<span class="token punctuation">.</span>dev_id<span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> LED_DEV_NAME
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>myled<span class="token punctuation">.</span>led_handle_device<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">pr_warn</span><span class="token punctuation">(</span><span class="token string">"Failed to create the led device ...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> failed_create_device<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">__enable_led_mappings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

failed_create_device<span class="token operator">:</span>
    <span class="token function">class_destroy</span><span class="token punctuation">(</span>myled<span class="token punctuation">.</span>led_class_handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
failed_create_class<span class="token operator">:</span>
    <span class="token function">cdev_del</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>myled<span class="token punctuation">.</span>char_dev_handle<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
failed_add_chardev<span class="token operator">:</span>
    <span class="token function">unregister_chrdev_region</span><span class="token punctuation">(</span>myled<span class="token punctuation">.</span>dev_id<span class="token punctuation">,</span> LED_DEV_N<span class="token punctuation">)</span><span class="token punctuation">;</span>
failed_register_chrdev_region<span class="token operator">:</span>
    <span class="token keyword">return</span> <span class="token operator">-</span>EIO<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">led_deinit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"Ready to remove the hook of the device operating file\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">device_destroy</span><span class="token punctuation">(</span>myled<span class="token punctuation">.</span>led_class_handle<span class="token punctuation">,</span> myled<span class="token punctuation">.</span>dev_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">class_destroy</span><span class="token punctuation">(</span>myled<span class="token punctuation">.</span>led_class_handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"Ready to release the char dev handle\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">cdev_del</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>myled<span class="token punctuation">.</span>char_dev_handle<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"Ready to unhook the device region\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">unregister_chrdev_region</span><span class="token punctuation">(</span>myled<span class="token punctuation">.</span>dev_id<span class="token punctuation">,</span> LED_DEV_N<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">__disable_led_mappings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"Successfully unregister the device\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">module_init</span><span class="token punctuation">(</span>led_init<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>led_deinit<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <h3>
     <a id="_1112">
     </a>
     测试
    </h3>
    <pre><code>/module_test # ls
chrdev_application  led.ko
/module_test # insmod led.ko 
Success in registering the device major=249, minor=0
Ready to mappings the registers...
mappings the registers done!
LED_CCGR1     ioremap to: f42c406c
LEDBASE       ioremap to: f42e0068
LEDPAD_BASE   ioremap to: f42e02f4
LEDDR_BASE    ioremap to: a09f6000
LEDGDIR_BASE  ioremap to: a09fe004
initialize the led registers
operations of led is accessable!
Prepare to create the device class file...
/module_test # ls /dev | grep charlies_led
charlies_led
/module_test # ./chrdev_application /dev/charlies_led read

led device is opened!
user process the read issue
led device is reading!

user receive from driver: closed
led device is released!
v 
/module_test # ./chrdev_application /dev/charlies_led write open

led device is opened!
args: 4
led device is ready writing!

user process the write issue: o
led device is released!
pen
/module_test # ./chrdev_application /dev/charlies_led write close

led device is opened!
args: 4
led device is ready writing!

user process the write issue: c
led device is released!
lose
/module_test # rmmod led.ko 
Ready to remove the hook of the device operating file
Ready to release the char dev handle
Ready to unhook the device region
set the led turning off...
set the led turning off done!
Ready to unmappings the registers...
unmappings the registers done
Successfully unregister the device
/module_test # ls /dev | grep charlies_led
</code></pre>
    <p>
     ​ 现象一致！
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e63:73646e2e6e65742f636861726c69653131343531343139312f:61727469636c652f64657461696c732f313436323834313730" class_="artid" style="display:none">
 </p>
</div>


