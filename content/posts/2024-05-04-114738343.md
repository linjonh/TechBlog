---
layout: post
title: "Node-Metadata-Protection-节点的元数据保护"
date: 2024-05-04 11:34:03 +0800
description: "1. 关于元数据kubernets集群不管是运行与公有云还是私有云，都是有些元数据的资源的各种各样的"
keywords: "metadata节点"
categories: ['Cks']
tags: ['容器', 'Kubernetes', 'K', 'Docker']
artid: "114738343"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=114738343
    alt: "Node-Metadata-Protection-节点的元数据保护"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=114738343
featuredImagePreview: https://bing.ee123.net/img/rand?artid=114738343
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Node Metadata  Protection--节点的元数据保护
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     <img alt="image.png" src="https://i-blog.csdnimg.cn/blog_migrate/0a8ea9b1e62d675a4aa6b7083dcd497a.png"/>
    </p>
    <h3>
     <a id="1__1">
     </a>
     1. 关于元数据
    </h3>
    <p>
     kubernets集群不管是运行与公有云还是私有云，都是有些元数据的资源的各种各样的标签。比如镜像id，网络设备id,硬盘的唯一id等。
    </p>
    <h3>
     <a id="2__3">
     </a>
     2. 举一个例子
    </h3>
    <h4>
     <a id="21_cloud_platform_node_metadata____4">
     </a>
     2.1 cloud platform node metadata 云平台节点元数据
    </h4>
    <ol>
     <li>
      拿谷歌云和亚马逊云来说
     </li>
     <li>
      默认的情况下可以从虚拟机vm（云主机）访问元数据服务的api
     </li>
     <li>
      元数据中保护有vm节点（云主机）的各种凭据信息。如网络id,镜像id vpcid.硬盘等待各种相关信息。具体详细度要看云商平台或者私有云架构
     </li>
     <li>
      可以包含诸如kubelet凭证之类的置备数据
     </li>
    </ol>
    <p>
     <img alt="image.png" src="https://i-blog.csdnimg.cn/blog_migrate/1e63f6e854308c8a800e441f08ef1892.png"/>
    </p>
    <h4>
     <a id="22_access_sensitive_node_metadta_____12">
     </a>
     2.2 access sensitive node metadta 访问敏感节点元数据的原则
    </h4>
    <p>
     2.2.1 最常说的权限控制原则
    </p>
    <ol>
     <li>
      Limitat permissions for instance credentials 权限最小化原则。
     </li>
     <li>
      确保cloud-instance-account仅具有必要的权限
     </li>
     <li>
      每个云提供商都应遵循一系列建议
     </li>
     <li>
      权限控制不在kubernetes中
     </li>
    </ol>
    <p>
     <img alt="image.png" src="https://i-blog.csdnimg.cn/blog_migrate/f6aa44627911c7d5ab8ae7022d4a542a.png"/>
    </p>
    <h3>
     <a id="3_restrict_access_using_networkpolicies__25">
     </a>
     3. restrict access using networkpolicies 使用网络策略限制访问
    </h3>
    <p>
     <img alt="image.png" src="https://i-blog.csdnimg.cn/blog_migrate/8bb33eab705ad623f9899c615175f170.png"/>
    </p>
    <h4>
     <a id="31__29">
     </a>
     3.1 限制访问云商的元数据
    </h4>
    <p>
     <img alt="image.png" src="https://i-blog.csdnimg.cn/blog_migrate/8ad74b212cab9504d6ee6805845bc36c.png">
      <br/>
      由于没有谷歌云拿腾讯云意淫下了，可能理解的不是很对。往指教：
      <br/>
      翻了下腾讯云的文档关于元数据也有文档：
      <a href="https://cloud.tencent.com/document/product/213/4934?from=10680" rel="nofollow">
       https://cloud.tencent.com/document/product/213/4934?from=10680
      </a>
      <br/>
      <img alt="image.png" src="https://i-blog.csdnimg.cn/blog_migrate/6cd659ee5366b8dea32f2d515d40ea33.png">
       <br/>
       就简单的证明一下，node节点和pod节点都可以访问云商的源数据。相对于谷歌云的文档，腾讯的还是略简单，想比着课程查询下硬盘，貌似还是没有这接口的。不过觉得下面这话说的很对，能访问实例就可以查看元数据。关于元数据的安全也很重要啊…
       <br/>
       <img alt="image.png" src="https://i-blog.csdnimg.cn/blog_migrate/22a30d559c7bef03b3d9186c376b6e62.png"/>
      </img>
     </img>
    </p>
    <h4>
     <a id="32networkpolicy__36">
     </a>
     3.2通过networkpolicy 限制对元数据的访问
    </h4>
    <p>
     ping metadata.tencentyun.com得到medata的地址169.254.0.23，依然是命名空间级别的限制
     <br/>
     <img alt="image.png" src="https://i-blog.csdnimg.cn/blog_migrate/a6edab776aeb3fa89933d422e437f9ac.png"/>
    </p>
    <pre><code class="prism language-html">kubectl apply -f deny.yaml
kubectl -n metadata  exec nginx -it bash
curl http://metadata.tencentyun.com/latest/meta-data/instance/image-id
</code></pre>
    <p>
     OK,如下图获取不了元数据中的镜像id了
     <br/>
     <img alt="image.png" src="https://i-blog.csdnimg.cn/blog_migrate/384822e3060d4461c2cea41dfb999fe0.png"/>
     <br/>
     然后我如何运行一组pod去访问元数据呢？
     <br/>
     <img alt="image.png" src="https://i-blog.csdnimg.cn/blog_migrate/09cfedc8df9b780dc6656910b6241036.png"/>
    </p>
    <pre><code class="prism language-html">kubectl apply -f allow.yaml
</code></pre>
    <p>
     嗯 matchLabels我设置了一个不存在的，然后给pods加上labels
    </p>
    <pre><code class="prism language-html">kubectl get pods --show-labels -n metadata
kubectl label pod nginx role=metadata-accessor -n metadata
kubectl get pods --show-labels -n metadata
kubectl -n metadata  exec nginx -it bash
</code></pre>
    <p>
     <img alt="image.png" src="https://i-blog.csdnimg.cn/blog_migrate/58ed032b8bbc9474942536a9ca8022f1.png"/>
     <br/>
     OK,可以返回元数据了。now现在去掉role=metadata-accessor 的标签
     <br/>
     <img alt="image.png" src="https://i-blog.csdnimg.cn/blog_migrate/74c77474a9b9d1e86c12025db56c3611.png"/>
     <br/>
     验证通过，其实我觉这节课主要的还是再强调networkpolicy。不仅仅是元数据的保护。networkpolicy是很重要的基石。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a:2f2f626c6f672e6373646e2e6e65742f7361796e616968652f:61727469636c652f64657461696c732f313134373338333433" class_="artid" style="display:none">
 </p>
</div>


