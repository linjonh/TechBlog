---
layout: post
title: "数据库版本问题导致的查询bug"
date: 2025-03-14 10:02:05 +0800
description: "我觉得难道是这里不能用外查询？然后测试站没有报错，很奇怪，一样的SQL，一个报错一个不报错，唯一的变量就是MySQL的版本了，测试站是8.0.28，正式站是8.0.16，应该是版本问题。但是有个问题困扰着我，就是外查询这么通用的功能，怎么可能在这么小的版本里面进行更新修复或者开发出来，而且当我把这行注释掉，正式站又可以跑的通，可是我这个SQL又不止这个地方用到了外查询这个特性。后面思考了一下，可能不是外查询的问题，我把过滤条件放在where语句就能跑的通，我很兴奋，原来是外查询放在join中是跑不通的。"
keywords: "数据库版本问题导致的查询bug"
categories: ['Mysql', 'Debug']
tags: ['数据库', 'Bug']
artid: "146250151"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146250151
    alt: "数据库版本问题导致的查询bug"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146250151
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146250151
cover: https://bing.ee123.net/img/rand?artid=146250151
image: https://bing.ee123.net/img/rand?artid=146250151
img: https://bing.ee123.net/img/rand?artid=146250151
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     数据库版本问题导致的查询bug
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     一个比较有意思的数据库查询bug，SQL如下：
    </p>
    <pre><code class="prism language-sql"><span class="token keyword">SELECT</span> agvo1<span class="token punctuation">.</span>org_id org_ids<span class="token punctuation">,</span> ptd<span class="token punctuation">.</span>deadline<span class="token punctuation">,</span>
    t<span class="token punctuation">.</span><span class="token operator">*</span>
     <span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> JSON_ARRAYAGG<span class="token punctuation">(</span>
                       JSON_OBJECT<span class="token punctuation">(</span>
                               <span class="token string">'annualGoalValueId'</span><span class="token punctuation">,</span> atv<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
                               <span class="token string">'goalValue'</span><span class="token punctuation">,</span> atv<span class="token punctuation">.</span>goal_value<span class="token punctuation">,</span>
                               <span class="token string">'orderNo'</span><span class="token punctuation">,</span> atv<span class="token punctuation">.</span>order_no<span class="token punctuation">,</span>
                               <span class="token string">'attachments'</span><span class="token punctuation">,</span> atv<span class="token punctuation">.</span>attachments<span class="token punctuation">,</span>
                               <span class="token string">'orgs'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> JSON_ARRAYAGG<span class="token punctuation">(</span>
                                                       JSON_OBJECT<span class="token punctuation">(</span>
                                                               <span class="token string">'orgId'</span><span class="token punctuation">,</span> org<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
                                                               <span class="token string">'orgName'</span><span class="token punctuation">,</span> org<span class="token punctuation">.</span>name
                                                       <span class="token punctuation">)</span>
                                               <span class="token punctuation">)</span>
                                          <span class="token keyword">FROM</span> org
                                                   <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> annual_goal_value_org atvo2 <span class="token keyword">ON</span> org<span class="token punctuation">.</span>id <span class="token operator">=</span> atvo2<span class="token punctuation">.</span>org_id
                                              <span class="token operator">AND</span> atvo2<span class="token punctuation">.</span>org_id <span class="token operator">=</span> agvo1<span class="token punctuation">.</span>org_id <span class="token comment">-- *这里报错！</span>
                                         <span class="token keyword">WHERE</span> atvo2<span class="token punctuation">.</span>annual_goal_value_id <span class="token operator">=</span> atv<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
                       <span class="token punctuation">)</span>
               <span class="token punctuation">)</span>
          <span class="token keyword">FROM</span> annual_goal_value atv
         <span class="token keyword">WHERE</span> atv<span class="token punctuation">.</span>target_id <span class="token operator">=</span> t<span class="token punctuation">.</span>id
         <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> order_no<span class="token punctuation">)</span> <span class="token keyword">AS</span> annual_goal_values_json
     <span class="token punctuation">,</span> pto<span class="token punctuation">.</span>name office_name
     <span class="token punctuation">,</span> ts<span class="token punctuation">.</span>scope_name scope_name
  <span class="token keyword">FROM</span> annual_goal_value_org agvo1
           <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> annual_goal_value agv <span class="token keyword">ON</span> agvo1<span class="token punctuation">.</span>annual_goal_value_id <span class="token operator">=</span> agv<span class="token punctuation">.</span>id
           <span class="token keyword">JOIN</span> target t <span class="token keyword">ON</span> agv<span class="token punctuation">.</span>target_id <span class="token operator">=</span> t<span class="token punctuation">.</span>id <span class="token operator">AND</span> t<span class="token punctuation">.</span>deleted_at <span class="token operator">IS</span> <span class="token boolean">NULL</span>
      <span class="token operator">AND</span> t<span class="token punctuation">.</span><span class="token keyword">status</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">AND</span> t<span class="token punctuation">.</span>submit_type <span class="token operator">=</span> <span class="token number">1</span>
           <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> <span class="token keyword">user</span> u <span class="token keyword">ON</span> t<span class="token punctuation">.</span>created_by <span class="token operator">=</span> u<span class="token punctuation">.</span>id
           <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> target_scope ts <span class="token keyword">ON</span> t<span class="token punctuation">.</span>target_scope_id <span class="token operator">=</span> ts<span class="token punctuation">.</span>id
           <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> pt_office pto <span class="token keyword">ON</span> t<span class="token punctuation">.</span>office_id <span class="token operator">=</span> pto<span class="token punctuation">.</span>id
           <span class="token keyword">JOIN</span> pt_task_deadline ptd <span class="token keyword">ON</span> ptd<span class="token punctuation">.</span>org_id <span class="token operator">=</span> agvo1<span class="token punctuation">.</span>org_id <span class="token operator">AND</span> ptd<span class="token punctuation">.</span>pt_task_id <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> id
                                                                                          <span class="token keyword">FROM</span> pt_task
                                                                                         <span class="token keyword">WHERE</span> FIND_IN_SET<span class="token punctuation">(</span>agvo1<span class="token punctuation">.</span>org_id<span class="token punctuation">,</span> org_ids<span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token keyword">WHERE</span> t<span class="token punctuation">.</span><span class="token keyword">year</span> <span class="token operator">=</span> ?
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> t<span class="token punctuation">.</span>created_at <span class="token keyword">DESC</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     标注的地方报错，
     <code>
      &gt; 1054 - Unknown column 'agvo1.org_id' in 'on clause'
     </code>
     ，我觉得难道是这里不能用外查询？就是子查询借用主查询中遍历的字段值。然后测试站没有报错，很奇怪，一样的SQL，一个报错一个不报错，唯一的变量就是MySQL的版本了，测试站是8.0.28，正式站是8.0.16，应该是版本问题。但是有个问题困扰着我，就是外查询这么通用的功能，怎么可能在这么小的版本里面进行更新修复或者开发出来，而且当我把这行注释掉，正式站又可以跑的通，可是我这个SQL又不止这个地方用到了外查询这个特性。太奇怪了。后面思考了一下，可能不是外查询的问题，我把过滤条件放在where语句就能跑的通，我很兴奋，原来是外查询放在join中是跑不通的。原本想就此结束，但是打这篇记录的时候发现，在后面的地方在join中也用到了外查询过滤，没有报错。所以问题到底是啥呢。
    </p>
    <p>
     后续改成这个了：
    </p>
    <pre><code class="prism language-sql"><span class="token keyword">SELECT</span> agvo1<span class="token punctuation">.</span>org_id org_ids<span class="token punctuation">,</span> ptd<span class="token punctuation">.</span>deadline<span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token operator">*</span>
     <span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> JSON_ARRAYAGG<span class="token punctuation">(</span>
                       JSON_OBJECT<span class="token punctuation">(</span>
                               <span class="token string">'annualGoalValueId'</span><span class="token punctuation">,</span> atv<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
                               <span class="token string">'goalValue'</span><span class="token punctuation">,</span> atv<span class="token punctuation">.</span>goal_value<span class="token punctuation">,</span>
                               <span class="token string">'orderNo'</span><span class="token punctuation">,</span> atv<span class="token punctuation">.</span>order_no<span class="token punctuation">,</span>
                               <span class="token string">'attachments'</span><span class="token punctuation">,</span> atv<span class="token punctuation">.</span>attachments
                                <span class="token punctuation">,</span><span class="token string">'orgs'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> JSON_ARRAYAGG<span class="token punctuation">(</span>
                                                       JSON_OBJECT<span class="token punctuation">(</span>
                                                               <span class="token string">'orgId'</span><span class="token punctuation">,</span> org<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
                                                               <span class="token string">'orgName'</span><span class="token punctuation">,</span> org<span class="token punctuation">.</span>name
                                                       <span class="token punctuation">)</span>
                                               <span class="token punctuation">)</span>
                                          <span class="token keyword">FROM</span> org
                                                   <span class="token keyword">left</span> <span class="token keyword">JOIN</span> annual_goal_value_org atvo2 <span class="token keyword">ON</span> org<span class="token punctuation">.</span>id <span class="token operator">=</span> atvo2<span class="token punctuation">.</span>org_id
                                         <span class="token keyword">WHERE</span> atvo2<span class="token punctuation">.</span>annual_goal_value_id <span class="token operator">=</span> atv<span class="token punctuation">.</span>id
                                           <span class="token operator">AND</span> atvo2<span class="token punctuation">.</span>org_id <span class="token operator">=</span> agvo1<span class="token punctuation">.</span>org_id <span class="token comment">-- 放入到where过滤</span>
                                         <span class="token punctuation">)</span>
                       <span class="token punctuation">)</span>
               <span class="token punctuation">)</span>
          <span class="token keyword">FROM</span> annual_goal_value atv <span class="token keyword">join</span> shmec<span class="token punctuation">.</span>annual_goal_value_org agvo3 <span class="token keyword">ON</span> atv<span class="token punctuation">.</span>id <span class="token operator">=</span> agvo3<span class="token punctuation">.</span>annual_goal_value_id
         <span class="token keyword">WHERE</span> atv<span class="token punctuation">.</span>target_id <span class="token operator">=</span> t<span class="token punctuation">.</span>id
         <span class="token operator">AND</span> agvo3<span class="token punctuation">.</span>org_id <span class="token operator">=</span> agvo1<span class="token punctuation">.</span>org_id  <span class="token comment">-- 根据业务，增加了一个过滤</span>
         <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> order_no<span class="token punctuation">)</span> <span class="token keyword">AS</span> annual_goal_values_json <span class="token comment">-- 某高校在某任务下被分配的年度目标值</span>
     <span class="token punctuation">,</span> pto<span class="token punctuation">.</span>name office_name
     <span class="token punctuation">,</span> ts<span class="token punctuation">.</span>scope_name scope_name
  <span class="token keyword">FROM</span> annual_goal_value_org agvo1
           <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> annual_goal_value agv <span class="token keyword">ON</span> agvo1<span class="token punctuation">.</span>annual_goal_value_id <span class="token operator">=</span> agv<span class="token punctuation">.</span>id
           <span class="token keyword">JOIN</span> target t <span class="token keyword">ON</span> agv<span class="token punctuation">.</span>target_id <span class="token operator">=</span> t<span class="token punctuation">.</span>id <span class="token operator">AND</span> t<span class="token punctuation">.</span>deleted_at <span class="token operator">IS</span> <span class="token boolean">NULL</span>
      <span class="token operator">AND</span> t<span class="token punctuation">.</span><span class="token keyword">status</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">AND</span> t<span class="token punctuation">.</span>submit_type <span class="token operator">=</span> <span class="token number">1</span>
           <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> <span class="token keyword">user</span> u <span class="token keyword">ON</span> t<span class="token punctuation">.</span>created_by <span class="token operator">=</span> u<span class="token punctuation">.</span>id
           <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> target_scope ts <span class="token keyword">ON</span> t<span class="token punctuation">.</span>target_scope_id <span class="token operator">=</span> ts<span class="token punctuation">.</span>id
           <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> pt_office pto <span class="token keyword">ON</span> t<span class="token punctuation">.</span>office_id <span class="token operator">=</span> pto<span class="token punctuation">.</span>id
           <span class="token keyword">JOIN</span> pt_task_deadline ptd <span class="token keyword">ON</span> ptd<span class="token punctuation">.</span>org_id <span class="token operator">=</span> agvo1<span class="token punctuation">.</span>org_id <span class="token operator">AND</span> ptd<span class="token punctuation">.</span>pt_task_id <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> id
                                                                                          <span class="token keyword">FROM</span> pt_task
                                                                                         <span class="token keyword">WHERE</span> FIND_IN_SET<span class="token punctuation">(</span>agvo1<span class="token punctuation">.</span>org_id<span class="token punctuation">,</span> org_ids<span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token keyword">WHERE</span> t<span class="token punctuation">.</span><span class="token keyword">year</span> <span class="token operator">=</span> <span class="token number">2024</span>
 <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> t<span class="token punctuation">.</span>created_at <span class="token keyword">DESC</span><span class="token punctuation">;</span>

</code></pre>
    <h2>
     <a id="_89">
     </a>
    </h2>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f34383131383136372f:61727469636c652f64657461696c732f313436323530313531" class_="artid" style="display:none">
 </p>
</div>


