---
layout: post
title: "音视频缓存数学模型"
date: 2025-03-16 18:13:25 +0800
description: "播放器作为消费者，缓存作为生产者。"
keywords: "音视频缓存数学模型"
categories: ['安卓Android应用开发相关']
tags: ['音视频', '缓存']
artid: "146298706"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146298706
    alt: "音视频缓存数学模型"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146298706
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146298706
cover: https://bing.ee123.net/img/rand?artid=146298706
image: https://bing.ee123.net/img/rand?artid=146298706
img: https://bing.ee123.net/img/rand?artid=146298706
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     音视频缓存数学模型
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <blockquote>
     <p>
      2024年8月的笔记
      <br/>
      <a href="https://iwesley.top/article/36f6f986/" rel="nofollow">
       音视频缓存数学模型 - Wesley’s Blog
      </a>
     </p>
    </blockquote>
    <p>
     播放器作为消费者，缓存作为生产者。
    </p>
    <h3>
     <a id="_5">
     </a>
     进入缓冲一次
    </h3>
    <p>
     设消费者速率为v1，生产者为v2，视频长度为l，x为生产者至少距离消费者多远才能保证在播完视频前两者重合。实际上就是一个追及问题。
    </p>
    <p>
     v1
     <em>
      t = v2
     </em>
     t + x，即 l = v2*l/v1 + x，因为播放器速度是1，继续简化得 x = l(1 - v2)
    </p>
    <p>
     如果v2大于1，即满足消费者需求时，可以流畅播放。
    </p>
    <p>
     设l是一部45分钟的电视剧，即x = 45
     <em>
      60
     </em>
     (1 - v2)
    </p>
    <p>
     如果v2是1，即1s可以缓存1s时长视频，则x = 0
    </p>
    <p>
     v2是0.9，即1s可以缓存0.9s时长视频，则 x = 270，意味着要提前缓存270s的视频才可以后续不进入缓冲状态。
    </p>
    <p>
     同理，v2=0.8，x= 540
    </p>
    <p>
     …
    </p>
    <p>
     v2 = 0.1，x=2430
    </p>
    <p>
     斜率是-2700，意味着每变化百分之0.1，缓存长度都要增加270s。
    </p>
    <p>
     拿v2=0.9，x= 270作为例子，要提前缓存270s，需要花费的时间是t=270/0.9=300s
    </p>
    <p>
     同理，v2=0.8，x= 540，t=540/0.8=675s
    </p>
    <p>
     …
    </p>
    <p>
     v2 = 0.1，x=2430,t=2430/0.1=24300s=405分钟
    </p>
    <h3>
     <a id="_35">
     </a>
     进入缓冲多次
    </h3>
    <p>
     实际上，用户是不能容忍等这么久的，所以意味着播放开始后会反复进入缓冲状态。
    </p>
    <p>
     假设缓存1s播1s，
    </p>
    <p>
     v2=1，是可以正常播放
    </p>
    <p>
     v2=0.9，则用户要等待时长为 1/0.9=1.1111s，先缓存1s，则平均1/（1-0.9）=10s进入缓冲状态，每次1.1111s
    </p>
    <p>
     v2=0.8，则用户要等待时长为 1/0.8=1.25s，先缓存1s，则平均1/（1-0.8）=5s进入缓冲状态，每次1.25s
    </p>
    <p>
     …
    </p>
    <p>
     v2=0.1，则用户要等待时长为 1/0.1=10s，先缓存1s，则平均1/（1-0.1）=1.1111s进入缓冲状态，每次10s
    </p>
    <p>
     同理每次缓存多1s再播放，都会增加一倍进入缓冲的时间和等待时间。
    </p>
    <p>
     意味着，如果通过多线程不能显著提高v2速度超过1，对用户来说都是卡顿，无法忍受的。
    </p>
    <p>
     当然，上面只是一个理论模型，实际上要复杂一些，因为每个ts包含的播放时间是不一样的。
    </p>
    <h3>
     <a id="_57">
     </a>
     情况分析
    </h3>
    <p>
     若带宽小于CDN速度，即v2总是小于v1，这样无论怎么优化都会卡顿。
    </p>
    <p>
     若带宽大于CDN速度，若v2大于v1则可以正常播放；若单线程不能满足v2大于v1，多线程时v2大于v1，也可以正常播放。
    </p>
    <h3>
     <a id="_63">
     </a>
     缓存策略
    </h3>
    <p>
     对于下载时间小于ts文件时长的，则串行下载，不需要并发。
    </p>
    <p>
     以下是针对CDN速度小于网络带宽的：
    </p>
    <h4>
     <a id="1__69">
     </a>
     1.
     <strong>
      初始下载设置
     </strong>
    </h4>
    <ul>
     <li>
      <strong>
       初始并发数
      </strong>
      ：从1个文件开始下载。
     </li>
     <li>
      <strong>
       监控下载速度
      </strong>
      ：监控下载速度和记录最大下载速度。
     </li>
    </ul>
    <h4>
     <a id="2__74">
     </a>
     2. 逐步增加并发
    </h4>
    <ul>
     <li>
      <strong>
       逐步增加
      </strong>
      ：下载成功后，增加一个并发下载任务。
     </li>
     <li>
      <strong>
       监控变化
      </strong>
      ：每次增加并发后，观察单个文件的下载速度变化。
     </li>
    </ul>
    <h4>
     <a id="3__79">
     </a>
     3.
     <strong>
      检测瓶颈
     </strong>
    </h4>
    <ul>
     <li>
      <strong>
       观察限速
      </strong>
      ：当下载速度达到某个稳定值（和最大下载速度相比不超过百分之十），或者单个文件下载速度显著下降时，说明可能触摸到了带宽上限或服务器限速。
     </li>
     <li>
      <strong>
       回退优化
      </strong>
      ：如果发现并发数增加反而导致下载速度下降，要减少并发数，找到一个最佳的下载量。
     </li>
    </ul>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470:733a2f2f626c6f672e6373646e2e6e65742f53756e494f542f:61727469636c652f64657461696c732f313436323938373036" class_="artid" style="display:none">
 </p>
</div>


