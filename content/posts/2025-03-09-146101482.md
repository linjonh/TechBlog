---
layout: post
title: "springcloud快速搭建一套分布式服务springcloudalibaba二"
date: 2025-03-09 19:15:00 +0800
description: "第二篇 基于nacos搭建分布式项目 网关本文通过网关实现用户登录拦截，网关系统/用户系统/商品系统 用户未带token请求除登录以外的任何操作都被拦截返回登录页面。在分布式系统中，网关（Gateway） 是一个非常重要的组件，它充当了系统的统一入口，负责处理外部请求并将其路由到内部服务。"
keywords: "【springcloud】快速搭建一套分布式服务springcloudalibaba（二）"
categories: ['Springcloud', 'Others']
tags: ['后端', 'Spring', 'Spring', 'Cloud']
artid: "146101482"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146101482
    alt: "springcloud快速搭建一套分布式服务springcloudalibaba二"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146101482
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146101482
cover: https://bing.ee123.net/img/rand?artid=146101482
image: https://bing.ee123.net/img/rand?artid=146101482
img: https://bing.ee123.net/img/rand?artid=146101482
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     【springcloud】快速搭建一套分布式服务springcloudalibaba（二）
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     第二篇 基于nacos搭建分布式项目 网关
     <br/>
     项目所需 maven + nacos + java8 + idea + git + mysql(用户信息) + redis(用于限流)
     <br/>
     本文通过网关实现用户登录拦截，网关系统/用户系统/商品系统 用户未带token请求除登录以外的任何操作都被拦截返回登录页面。
     <br/>
     请先准备好环境，可以直接clone下来项目去部署。
    </p>
    <p>
    </p>
    <p>
    </p>
    <h2>
     <a id="_6">
     </a>
     分布式系统为什么需要网关
    </h2>
    <p>
     在分布式系统中，网关（Gateway） 是一个非常重要的组件，它充当了系统的统一入口，负责处理外部请求并将其路由到内部服务。
    </p>
    <ol>
     <li>
      统一入口（客户端只需与网关交互，而不需要直接访问内部服务）
     </li>
     <li>
      路由与负载均衡（请求 /user/** 路由到用户服务，请求 /order/** 路由到订单服务）
     </li>
     <li>
      安全与认证（网关可以集中处理身份验证（如 JWT、OAuth2）和授权（如权限校验）
     </li>
     <li>
      限流与熔断（支持熔断和限流机制，当某个服务不可用或者超出瞬时流量限制时，快速失败并返回降级响应。）
     </li>
     <li>
      日志与监控 （网关可以集中记录请求日志，便于问题排查和性能分析）
     </li>
     <li>
      跨域支持（网关可以统一处理跨域请求（CORS），避免每个服务单独配置）
     </li>
     <li>
      灰度发布与流量控制（网关可以根据请求的 Header、参数或其他条件，将流量分发到不同版本的服务。）
      <br/>
      <strong>
       接下里我们一个一个实现看看
      </strong>
     </li>
    </ol>
    <p>
     图内各个服务节点可以集群部署。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/d4d8e51551964ebb960d8a051146e1aa.png"/>
    </p>
    <h2>
     <a id="_19">
     </a>
     项目结构
    </h2>
    <p>
     <a href="https://blog.csdn.net/YiQieFuCong/article/details/145811706">
      快速部署分布式项目
     </a>
    </p>
    <pre><code class="prism language-xml">
git clone git@gitee.com:goodluckv/ali-cloud-common.git
git clone git@gitee.com:goodluckv/ali-cloud-gateway.git
git clone git@gitee.com:goodluckv/ali-cloud-user.git
git clone git@gitee.com:goodluckv/ali-cloud-goods.git

</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/4b1f5839a848485fa0fc430b0409e4fb.png"/>
    </p>
    <h2>
     <a id="_35">
     </a>
     创建项目
    </h2>
    <p>
     快速创建，可参考第一篇快速搭建，加入spring-cloud-starter-gateway。gateway网关项目不需要spring-boot-starter-web包。
     <strong>
      Spring MVC 是基于阻塞式 I/O 的传统 Web 框架，通常用于构建同步的 Web 应用程序。
      <br/>
      Spring Cloud Gateway 是基于 Spring WebFlux 的响应式编程框架，使用非阻塞式 I/O，适用于构建异步、高性能的网关服务。
     </strong>
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/ec1cf08749464fe893e607486e66a18e.png"/>
    </p>
    <p>
     nacos 中的config
    </p>
    <p>
     命名gateway-service-dev.yaml
    </p>
    <pre><code class="prism language-yml">
<span class="token key atrule">user</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> 自动刷新
  <span class="token key atrule">age</span><span class="token punctuation">:</span> <span class="token number">30</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> user<span class="token punctuation">-</span>service
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//user<span class="token punctuation">-</span>service
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/user/<span class="token important">**</span>
          <span class="token key atrule">filters</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> StripPrefix=1
            <span class="token comment"># 熔断</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> CircuitBreaker
              <span class="token key atrule">args</span><span class="token punctuation">:</span>
                <span class="token key atrule">name</span><span class="token punctuation">:</span> systemBreaker
                <span class="token key atrule">fallbackUri</span><span class="token punctuation">:</span> forward<span class="token punctuation">:</span>/system/fallback/tip
            <span class="token comment"># 限流</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> RequestRateLimiter
              <span class="token key atrule">args</span><span class="token punctuation">:</span>
                <span class="token key atrule">redis-rate-limiter.replenishRate</span><span class="token punctuation">:</span> <span class="token number">1</span> <span class="token comment"># 每秒允许的请求数</span>
                <span class="token key atrule">redis-rate-limiter.burstCapacity</span><span class="token punctuation">:</span> <span class="token number">5</span> <span class="token comment"># 每秒最大请求数</span>
                <span class="token key atrule">key-resolver</span><span class="token punctuation">:</span> <span class="token string">"#{@pathKeyResolver}"</span>  <span class="token comment"># 限流的键解析器</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> login<span class="token punctuation">-</span>service
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//user<span class="token punctuation">-</span>service
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/account/<span class="token important">**</span>
</code></pre>
    <h3>
     <a id="_76">
     </a>
     路由参数解析
    </h3>
    <p>
     <strong>
      路由可以直接配置在nacos的动态配置中
     </strong>
    </p>
    <p>
     *[HTML]:
    </p>
    <table>
     <thead>
      <tr>
       <th>
        <mark class="flexible-marker flexible-marker-default">
         ‌
         <strong>
          配置分类
         </strong>
         ‌
        </mark>
       </th>
       <th>
        <mark class="flexible-marker flexible-marker-default">
         ‌
         <strong>
          配置项
         </strong>
         ‌
        </mark>
       </th>
       <th>
        <mark class="flexible-marker flexible-marker-default">
         ‌
         <strong>
          用途说明
         </strong>
         ‌
        </mark>
       </th>
       <th>
        <mark class="flexible-marker flexible-marker-default">
         ‌
         <strong>
          示例值/配置
         </strong>
         ‌
        </mark>
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        <mark class="flexible-marker flexible-marker-default">
         ‌
         <strong>
          路由配置
         </strong>
         ‌
        </mark>
        ‌
       </td>
       <td>
        <code>
         spring.cloud.gateway.routes.id
        </code>
       </td>
       <td>
        路由唯一标识符，用于区分不同路由规则
       </td>
       <td>
        <code>
         user-service
        </code>
       </td>
      </tr>
      <tr>
       <td>
       </td>
       <td>
        <code>
         spring.cloud.gateway.routes.uri
        </code>
       </td>
       <td>
        目标服务URI（支持
        <code>
         http
        </code>
        、
        <code>
         lb
        </code>
        负载均衡模式）
       </td>
       <td>
        <code>
         lb://user-service
        </code>
        或
        <code>
         http://localhost:8080
        </code>
       </td>
      </tr>
      <tr>
       <td>
       </td>
       <td>
        <code>
         spring.cloud.gateway.routes.predicates
        </code>
       </td>
       <td>
        断言条件集合，用于匹配HTTP请求特征（如路径、请求头等）
       </td>
       <td>
        <code>
         - Path=/api/**
        </code>
        <br/>
        <code>
         - Method=GET
        </code>
       </td>
      </tr>
      <tr>
       <td>
       </td>
       <td>
        <code>
         spring.cloud.gateway.routes.filters
        </code>
       </td>
       <td>
        过滤器集合，用于修改请求/响应（如添加头、路径重写等）
       </td>
       <td>
        <code>
         - AddRequestHeader=X-Request-Id,123
        </code>
        <br/>
        <code>
         - StripPrefix=2 （去除前缀）
        </code>
       </td>
      </tr>
      <tr>
       <td>
        <mark class="flexible-marker flexible-marker-default">
         ‌
         <strong>
          全局配置
         </strong>
         ‌
        </mark>
        ‌
       </td>
       <td>
        <code>
         spring.cloud.gateway.discovery.locator.enabled
        </code>
       </td>
       <td>
        是否与服务发现组件集成（如Eureka），启用动态路由
       </td>
       <td>
        <code>
         true
        </code>
       </td>
      </tr>
      <tr>
       <td>
       </td>
       <td>
        <code>
         spring.cloud.gateway.default-filters
        </code>
       </td>
       <td>
        全局过滤器列表，作用于所有路由
       </td>
       <td>
        <code>
         - DedupeResponseHeader=Access-Control-Allow-Origin
        </code>
       </td>
      </tr>
      <tr>
       <td>
        <mark class="flexible-marker flexible-marker-default">
         ‌
         <strong>
          跨域配置
         </strong>
         ‌
        </mark>
        ‌
       </td>
       <td>
        <code>
         spring.cloud.gateway.globalcors.cors-configurations
        </code>
       </td>
       <td>
        配置跨域资源共享（CORS）规则
       </td>
       <td>
        <code>
         '/**':
        </code>
        <br/>
        <code>
         allowedOrigins: "*"
        </code>
        <br/>
        <code>
         allowedMethods: ["GET", "POST"]
        </code>
       </td>
      </tr>
      <tr>
       <td>
        <mark class="flexible-marker flexible-marker-default">
         ‌
         <strong>
          HTTP客户端配置
         </strong>
         ‌
        </mark>
        ‌
       </td>
       <td>
        <code>
         spring.cloud.gateway.httpclient.pool.max-connections
        </code>
       </td>
       <td>
        设置HTTP连接池最大连接数（优化高并发场景）
       </td>
       <td>
        <code>
         500
        </code>
       </td>
      </tr>
      <tr>
       <td>
       </td>
       <td>
        <code>
         spring.cloud.gateway.httpclient.connect-timeout
        </code>
       </td>
       <td>
        连接超时时间（毫秒）
       </td>
       <td>
        <code>
         30000
        </code>
       </td>
      </tr>
      <tr>
       <td>
        <mark class="flexible-marker flexible-marker-default">
         ‌
         <strong>
          限流配置
         </strong>
         ‌
        </mark>
        ‌
       </td>
       <td>
        <code>
         spring.cloud.gateway.ratelimiter.enabled
        </code>
       </td>
       <td>
        是否启用请求速率限制（需配合Redis等存储）
       </td>
       <td>
        <code>
         true
        </code>
       </td>
      </tr>
      <tr>
       <td>
       </td>
       <td>
        <code>
         spring.cloud.gateway.ratelimiter.redis-rate-limiter.replenishRate
        </code>
       </td>
       <td>
        每秒允许的请求数
       </td>
       <td>
        <code>
         10
        </code>
       </td>
      </tr>
      <tr>
       <td>
        <mark class="flexible-marker flexible-marker-default">
         ‌
         <strong>
          指标监控
         </strong>
         ‌
        </mark>
        ‌
       </td>
       <td>
        <code>
         spring.cloud.gateway.metrics.enabled
        </code>
       </td>
       <td>
        启用Prometheus等监控指标采集
       </td>
       <td>
        <code>
         true
        </code>
       </td>
      </tr>
      <tr>
       <td>
        <mark class="flexible-marker flexible-marker-default">
         ‌
         <strong>
          超时配置
         </strong>
         ‌
        </mark>
        ‌
       </td>
       <td>
        <code>
         spring.cloud.gateway.httpclient.response-timeout
        </code>
       </td>
       <td>
        响应超时时间（毫秒）
       </td>
       <td>
        <code>
         60000
        </code>
       </td>
      </tr>
     </tbody>
    </table>
    <h4>
     <a id="_172">
     </a>
     其实主要用到的就那几个就可以实现。（示例）
    </h4>
    <pre><code class="prism language-yml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> user<span class="token punctuation">-</span>service
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//user<span class="token punctuation">-</span>service
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/user/<span class="token important">**</span>
          <span class="token key atrule">filters</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> StripPrefix=1
</code></pre>
    <h4>
     <a id="springcloudgatewayroutesfilters_186">
     </a>
     spring.cloud.gateway.routes.filters
    </h4>
    <p>
     关于过滤器 又有很多 参数 ，比如熔断与限流都可以在这里面配置
    </p>
    <p>
     *[HTML]:
    </p>
    <table>
     <thead>
      <tr>
       <th>
        <mark class="flexible-marker flexible-marker-default">
         ‌
         <strong>
          过滤器名称
         </strong>
         ‌
        </mark>
       </th>
       <th>
        <mark class="flexible-marker flexible-marker-default">
         ‌
         <strong>
          用途说明
         </strong>
         ‌
        </mark>
       </th>
       <th>
        <mark class="flexible-marker flexible-marker-default">
         ‌
         <strong>
          示例配置
         </strong>
         ‌
        </mark>
       </th>
       <th>
        <mark class="flexible-marker flexible-marker-default">
         ‌
         <strong>
          来源
         </strong>
         ‌
        </mark>
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        <code>
         AddRequestHeader
        </code>
       </td>
       <td>
        添加请求头，常用于传递认证信息或自定义标识
       </td>
       <td>
        <code>
         - AddRequestHeader=X-User-Id, 1001
        </code>
       </td>
       <td>
        ‌
       </td>
      </tr>
      <tr>
       <td>
        <code>
         AddRequestParameter
        </code>
       </td>
       <td>
        添加请求参数，常用于补充请求参数
       </td>
       <td>
        <code>
         - AddRequestParameter=key1, value1
        </code>
       </td>
       <td>
        ‌
       </td>
      </tr>
      <tr>
       <td>
        <code>
         PrefixPath
        </code>
       </td>
       <td>
        在请求路径前添加前缀，用于统一接口前缀
       </td>
       <td>
        <code>
         - PrefixPath=/api/v1
        </code>
       </td>
       <td>
        ‌
       </td>
      </tr>
      <tr>
       <td>
        <code>
         StripPrefix
        </code>
       </td>
       <td>
        去除路径前缀，将请求转发到后端时忽略指定层级的路径
       </td>
       <td>
        <code>
         - StripPrefix=2
        </code>
        （移除路径前两个层级）
       </td>
       <td>
        ‌
       </td>
      </tr>
      <tr>
       <td>
        <code>
         RewritePath
        </code>
       </td>
       <td>
        重写请求路径，支持正则表达式匹配和替换
       </td>
       <td>
        <code>
         - RewritePath=/old/(?&lt;segment&gt;.*), /new/$\{segment}
        </code>
       </td>
       <td>
        ‌
       </td>
      </tr>
      <tr>
       <td>
        <code>
         Retry
        </code>
       </td>
       <td>
        配置请求重试策略（如超时重试次数、状态码触发条件）
       </td>
       <td>
        <code>
         - Retry=3
        </code>
        （默认重试3次）
        <br/>
        <code>
         - Retry=retries=3,statuses=500,methods=GET
        </code>
       </td>
       <td>
        ‌
       </td>
      </tr>
      <tr>
       <td>
        <code>
         RequestRateLimiter
        </code>
       </td>
       <td>
        基于令牌桶算法限流，需配合 Redis 或其他存储实现
       </td>
       <td>
        <code>
         - RequestRateLimiter=10, 20, #{@userKeyResolver}
        </code>
        （每秒10令牌，容量20）
       </td>
       <td>
        ‌
       </td>
      </tr>
      <tr>
       <td>
        <code>
         SetStatus
        </code>
       </td>
       <td>
        强制修改响应状态码，常用于统一异常处理
       </td>
       <td>
        <code>
         - SetStatus=401
        </code>
       </td>
       <td>
        ‌
       </td>
      </tr>
      <tr>
       <td>
        <code>
         RemoveRequestHeader
        </code>
       </td>
       <td>
        移除指定请求头，用于敏感信息过滤
       </td>
       <td>
        <code>
         - RemoveRequestHeader=Authorization
        </code>
       </td>
       <td>
        ‌
       </td>
      </tr>
      <tr>
       <td>
        <code>
         RemoveResponseHeader
        </code>
       </td>
       <td>
        移除指定响应头，用于隐藏后端服务细节
       </td>
       <td>
        <code>
         - RemoveResponseHeader=Server
        </code>
       </td>
       <td>
        ‌
       </td>
      </tr>
      <tr>
       <td>
        <code>
         SaveSession
        </code>
       </td>
       <td>
        强制保存 WebSession，用于需要会话管理的场景
       </td>
       <td>
        <code>
         - SaveSession
        </code>
       </td>
       <td>
        ‌
       </td>
      </tr>
      <tr>
       <td>
        <code>
         RedirectTo
        </code>
       </td>
       <td>
        重定向请求，支持 HTTP 状态码和 URL 配置
       </td>
       <td>
        <code>
         - RedirectTo=302, http://example.com
        </code>
       </td>
       <td>
        ‌
       </td>
      </tr>
     </tbody>
    </table>
    <h4>
     <a id="_275">
     </a>
     过滤器示例(熔断器与限流)
    </h4>
    <pre><code class="prism language-yml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> user<span class="token punctuation">-</span>service
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//user<span class="token punctuation">-</span>service
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
          <span class="token comment"># 请求头为/user开头的uri都路由到userservice服务</span>
            <span class="token punctuation">-</span> Path=/user/<span class="token important">**</span>
          <span class="token key atrule">filters</span><span class="token punctuation">:</span>
          <span class="token comment"># StripPrefix 转发的路径第一个/user会被去掉 比如 请求/user/info 实际请求 http://user-service/info 这么配置是为了更好区分各个服务， </span>
            <span class="token punctuation">-</span> StripPrefix=1
            <span class="token comment"># 熔断</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> CircuitBreaker
              <span class="token key atrule">args</span><span class="token punctuation">:</span>
                <span class="token key atrule">name</span><span class="token punctuation">:</span> systemBreaker
                <span class="token key atrule">fallbackUri</span><span class="token punctuation">:</span> forward<span class="token punctuation">:</span>/system/fallback/tip
            <span class="token comment"># 限流</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> RequestRateLimiter
              <span class="token key atrule">args</span><span class="token punctuation">:</span>
                <span class="token key atrule">redis-rate-limiter.replenishRate</span><span class="token punctuation">:</span> <span class="token number">1</span> <span class="token comment"># 每秒允许的请求数</span>
                <span class="token key atrule">redis-rate-limiter.burstCapacity</span><span class="token punctuation">:</span> <span class="token number">5</span> <span class="token comment"># 每秒最大请求数</span>
                <span class="token key atrule">key-resolver</span><span class="token punctuation">:</span> <span class="token string">"#{@pathKeyResolver}"</span>  <span class="token comment"># 限流的键解析器</span>
</code></pre>
    <h3>
     <a id="_304">
     </a>
     用户认证与日志监控
    </h3>
    <p>
     示例代码中 加入了jwt，我们只需要实现GlobalFilter, Ordered 这俩接口 ，然后重写filter 方法即可实现过滤。可以配置多个过滤器。
    </p>
    <h4>
     <a id="_306">
     </a>
     示例代码
    </h4>
    <p>
     order 数字越小执行优先级越高(可以写负数)。
    </p>
    <pre><code class="prism language-java">
<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GatewayJwtTokenFilter</span> <span class="token keyword">implements</span> <span class="token class-name">GlobalFilter</span><span class="token punctuation">,</span> <span class="token class-name">Ordered</span> <span class="token punctuation">{<!-- --></span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">GatewayFilterChain</span> chain<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ServerHttpRequest</span> request <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> rawPath <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRawPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HttpHeaders</span> headers <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"rawPath: {}"</span><span class="token punctuation">,</span> rawPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rawPath<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"/account"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 检查用户是否登录，这里假设通过检查请求头中的某个字段来判断</span>
            <span class="token class-name">String</span> token <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFirst</span><span class="token punctuation">(</span><span class="token string">"Authorization"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Res</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserAccount</span><span class="token punctuation">&gt;</span></span> res <span class="token operator">=</span> <span class="token class-name">JwtUtil</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> <span class="token class-name">UserAccountSecretInit</span><span class="token punctuation">.</span><span class="token constant">ACCOUNT_SECRETKEY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Res</span><span class="token punctuation">.</span><span class="token constant">SUCCESS_CODE</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 未登录，重定向到 /login 页面</span>
                exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setStatusCode</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">FOUND</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"Location"</span><span class="token punctuation">,</span> <span class="token string">"/account/login.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre>
    <h3>
     <a id="_346">
     </a>
     熔断与限流
    </h3>
    <h4>
     <a id="_347">
     </a>
     熔断
    </h4>
    <p>
     <strong>
      当某个服务或组件出现故障时，快速失败并停止对其的调用，避免故障扩散到整个系统。有好几种组件，本文用的reactor-resilience4j，阿里的spring-cloud-starter-alibaba-sentinel也不错。
     </strong>
     <br/>
     <strong>
      默认情况下服务不可用的话页面返回503
     </strong>
     <br/>
     需要使用到spring-cloud-starter-circuitbreaker-reactor-resilience4j
    </p>
    <pre><code class="prism language-java">        <span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
            <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
            <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>spring<span class="token operator">-</span>cloud<span class="token operator">-</span>starter<span class="token operator">-</span>circuitbreaker<span class="token operator">-</span>reactor<span class="token operator">-</span>resilience4j<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/921cf9c597a748868ee998dd62928587.png">
      <br/>
      模拟用户登录服务崩溃的情况（user-service没有启动）
      <br/>
      访问 http://127.0.0.1:8010/account/login.html 网关系统自动重定向到熔断页面，如果不配置熔断页面会提示503
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/6e16dda0989147e9b7ffb909e4049d52.png"/>
     </img>
    </p>
    <h4>
     <a id="_362">
     </a>
     限流
    </h4>
    <p>
     <strong>
      分布式系统限流 是一种用于控制系统中请求流量的技术，目的是在系统资源有限的情况下，确保系统能够稳定运行，避免因流量过大而导致系统崩溃或性能下降。
     </strong>
     <br/>
     可以限制ip，url，不同用户，每秒请求次数，最大请求次数。
     <br/>
     需要使用到redis用于存储key
    </p>
    <pre><code class="prism language-java">    <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> <span class="token class-name">Redis</span> <span class="token class-name">Reactive</span> <span class="token punctuation">(</span>用于限流<span class="token punctuation">)</span> <span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
        <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
        <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>spring<span class="token operator">-</span>boot<span class="token operator">-</span>starter<span class="token operator">-</span>data<span class="token operator">-</span>redis<span class="token operator">-</span>reactive<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
</code></pre>
    <h5>
     <a id="key_377">
     </a>
     自定义限流key
    </h5>
    <pre><code class="prism language-java">
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">KeyResolver</span> <span class="token function">pathKeyResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">KeyResolver</span> keyResolver <span class="token operator">=</span> <span class="token function">pathKeyGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>keyResolver<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"创建限流key存入redis: {} "</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>keyResolver<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> keyResolver<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">KeyResolver</span> <span class="token function">pathKeyGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> exchange <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 获取请求路径</span>
            <span class="token class-name">String</span> path <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> hostAddress <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRemoteAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHostAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> key <span class="token operator">=</span> hostAddress <span class="token operator">+</span> <span class="token string">"_"</span> <span class="token operator">+</span> path<span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"compositeKey 限流key:{}"</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
    <h5>
     <a id="_401">
     </a>
     测试
    </h5>
    <p>
     我设置的同一ip每秒请求同一url不能超过3次，在我本地测试第四次会出现该页面。计算方式根据控制台结果是按第一次请求时间开始算的，如果第一次请求过了一秒，按顺序从第二次请求时间开始算。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/b5c50d39c4a84300ad439595c6d43c94.png"/>
    </p>
    <h3>
     <a id="_406">
     </a>
     灰度发布与流量控制
    </h3>
    <h4>
     <a id="_408">
     </a>
     基于路径的流量分发
    </h4>
    <p>
     可以直接将user服务前置一个版本的uri，比如/v1/user/xxx /v2/user/xxx
    </p>
    <pre><code class="prism language-java">spring<span class="token operator">:</span>
  cloud<span class="token operator">:</span>
    gateway<span class="token operator">:</span>
      routes<span class="token operator">:</span>
        <span class="token operator">-</span> id<span class="token operator">:</span> v1_route
          uri<span class="token operator">:</span> lb<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>user<span class="token operator">-</span>service<span class="token operator">-</span>v1
          predicates<span class="token operator">:</span>
            <span class="token operator">-</span> <span class="token class-name">Path</span><span class="token operator">=</span><span class="token operator">/</span>v1<span class="token operator">/</span>user<span class="token comment">/**
          filters:
            - StripPrefix=2
        - id: v2_route
          uri: lb://user-service-v2
          predicates:
            - Path=/v2/user/**
         filters:
            - StripPrefix=2
</span></code></pre>
    <h4>
     <a id="_Header__430">
     </a>
     基于 Header 的流量分发
    </h4>
    <p>
     通过请求头中（如 version）将流量分发到不同版本的服务
    </p>
    <pre><code class="prism language-yml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> v1_route
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//user<span class="token punctuation">-</span>service<span class="token punctuation">-</span>v1
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Header=version<span class="token punctuation">,</span> v1  <span class="token comment"># 匹配请求头 version=v1</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> v2_route
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//user<span class="token punctuation">-</span>service<span class="token punctuation">-</span>v2
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Header=version<span class="token punctuation">,</span> v2  <span class="token comment"># 匹配请求头 version=v2</span>
</code></pre>
    <h4>
     <a id="_447">
     </a>
     基于权重的流量分发
    </h4>
    <p>
     Weight 过滤器用于按权重分发流量。
     <br/>
     group1 是分组的名称，相同分组的权重总和应为 100。
    </p>
    <pre><code class="prism language-yml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> weight_route
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//user<span class="token punctuation">-</span>service<span class="token punctuation">-</span>v1
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/service/<span class="token important">**</span>
          <span class="token key atrule">filters</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Weight=group1<span class="token punctuation">,</span> <span class="token number">80</span>  <span class="token comment"># 80% 的流量</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> weight_route_v2
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//user<span class="token punctuation">-</span>service<span class="token punctuation">-</span>v2
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/service/<span class="token important">**</span>
          <span class="token key atrule">filters</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Weight=group1<span class="token punctuation">,</span> <span class="token number">20</span>  <span class="token comment"># 20% 的流量</span>
</code></pre>
    <h2>
     <a id="_472">
     </a>
     结尾
    </h2>
    <p>
     <a href="https://blog.csdn.net/YiQieFuCong/article/details/145811706">
      第一篇快速部署一套分布式服务
     </a>
    </p>
    <p>
     希望本文可以帮到你。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f59695169654675436f6e672f:61727469636c652f64657461696c732f313436313031343832" class_="artid" style="display:none">
 </p>
</div>


