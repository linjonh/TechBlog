---
layout: post
title: "数据迁移基于模板方法模式"
date: 2025-03-11 00:38:51 +0800
description: "本节概述了整体设计思路和核心实现模式本代码实现了一个数据迁移方案，采用模板方法模式（Template Method Pattern）组织迁移逻辑。核心类作为抽象基类，定义了通用的迁移流程，而具体的迁移逻辑由等子类实现。"
keywords: "数据迁移（基于模板方法模式）"
categories: ['设计模式', '后端']
tags: ['模板方法模式']
artid: "146167521"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146167521
    alt: "数据迁移基于模板方法模式"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146167521
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146167521
cover: https://bing.ee123.net/img/rand?artid=146167521
image: https://bing.ee123.net/img/rand?artid=146167521
img: https://bing.ee123.net/img/rand?artid=146167521
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     数据迁移（基于模板方法模式）
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <blockquote>
     <p>
      <a href="https://blog.csdn.net/weixin_45970964/article/details/144446211?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522fc28c669837212b1284fe795272d37a7%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fblog.%2522%257D&amp;request_id=fc28c669837212b1284fe795272d37a7&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_ecpm_v1~rank_v31_ecpm-1-144446211-null-null.nonecase&amp;utm_term=%E6%A8%A1%E6%9D%BF&amp;spm=1018.2226.3001.4450">
       模板方法模式详解：定义程序骨架与框架设计
      </a>
     </p>
    </blockquote>
    <h3>
     <a id="1__2">
     </a>
     1. 代码概述
    </h3>
    <blockquote>
     <p>
      <em>
       本节概述了整体设计思路和核心实现模式
      </em>
     </p>
    </blockquote>
    <p>
     本代码实现了一个
     <strong>
      数据迁移
     </strong>
     方案，采用
     <strong>
      模板方法模式（Template Method Pattern）
     </strong>
     组织迁移逻辑。核心类
     <code>
      AbstractMigrationService
     </code>
     作为抽象基类，定义了通用的迁移流程，而具体的迁移逻辑由
     <code>
      MigrationService
     </code>
     等子类实现。
    </p>
    <hr/>
    <h3>
     <a id="2__10">
     </a>
     2. 主要代码结构
    </h3>
    <blockquote>
     <p>
      <em>
       这部分详细介绍了代码的分层结构和主要组件
      </em>
     </p>
    </blockquote>
    <h4>
     <a id="21_AbstractMigrationServiceT_D_14">
     </a>
     2.1
     <code>
      AbstractMigrationService&lt;T, D&gt;
     </code>
     （抽象基类）
    </h4>
    <blockquote>
     <p>
      <em>
       抽象基类定义了通用迁移流程，是模板方法模式的核心
      </em>
     </p>
    </blockquote>
    <p>
     该类是所有迁移服务的基类，定义了通用的数据迁移流程。
    </p>
    <h5>
     <a id="_20">
     </a>
     关键方法：
    </h5>
    <pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractMigrationService</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span><span class="token class-name">D</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">D</span><span class="token punctuation">&gt;</span></span> <span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token class-name">Long</span> lastProcessedId<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 读取源数据</span>
    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token class-name">T</span> <span class="token function">transformData</span><span class="token punctuation">(</span><span class="token class-name">D</span> dto<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 数据转换</span>
    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">saveData</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> dataList<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 存储数据</span>
    
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">migrate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Long</span> lastProcessedId <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">)</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"migration:lastProcessedId"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">D</span><span class="token punctuation">&gt;</span></span> dtoList <span class="token operator">=</span> <span class="token function">fetchData</span><span class="token punctuation">(</span>lastProcessedId<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 读取数据</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> entityList <span class="token operator">=</span> dtoList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">::</span><span class="token function">transformData</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 转换数据</span>
        <span class="token function">saveData</span><span class="token punctuation">(</span>entityList<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 存储数据</span>
        
        <span class="token comment">// 更新 Redis 中的最大 ID，支持断点续传</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dtoList<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Long</span> newLastProcessedId <span class="token operator">=</span> dtoList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>dtoList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"migration:lastProcessedId"</span><span class="token punctuation">,</span> newLastProcessedId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="22_MigrationService_42">
     </a>
     2.2
     <code>
      MigrationService
     </code>
     （具体实现类）
    </h4>
    <blockquote>
     <p>
      <em>
       具体实现类负责具体业务逻辑，遵循基类定义的流程
      </em>
     </p>
    </blockquote>
    <p>
     该类继承
     <code>
      AbstractMigrationService
     </code>
     ，实现具体的迁移逻辑。
    </p>
    <h5>
     <a id="_48">
     </a>
     关键实现：
    </h5>
    <pre><code class="prism language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MigrationService</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractMigrationService</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SourceData</span><span class="token punctuation">,</span> <span class="token class-name">TargetDataDTO</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">JdbcTemplate</span> jdbcTemplate<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">MigrationLogService</span> migrationLogService<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">ExecutorService</span> executorService<span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TargetDataDTO</span><span class="token punctuation">&gt;</span></span> <span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token class-name">Long</span> lastProcessedId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> jdbcTemplate<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"SELECT * FROM table_name WHERE id &gt; ? ORDER BY id LIMIT 1000"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span>lastProcessedId<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TdTjMhkrstDTOMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">SourceData</span> <span class="token function">transformData</span><span class="token punctuation">(</span><span class="token class-name">TargetDataDTO</span> dto<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SourceData</span><span class="token punctuation">(</span>dto<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dto<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">saveData</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SourceData</span><span class="token punctuation">&gt;</span></span> dataList<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        executorService<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            mongoTemplate<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>dataList<span class="token punctuation">,</span> <span class="token string">"target_collection"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            migrationLogService<span class="token punctuation">.</span><span class="token function">logMigration</span><span class="token punctuation">(</span><span class="token string">"Batch migration successful"</span><span class="token punctuation">,</span> dataList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <hr/>
    <h3>
     <a id="3__81">
     </a>
     3. 运行机制解析
    </h3>
    <blockquote>
     <p>
      <em>
       本节解析了整个迁移流程的工作原理和关键特性
      </em>
     </p>
    </blockquote>
    <ol>
     <li>
      <strong>
       模板方法执行流程
      </strong>
      ：
      <code>
       migrate()
      </code>
      作为
      <strong>
       模板方法
      </strong>
      ，按照固定的步骤执行：
      <ul>
       <li>
        <code>
         fetchData(lastProcessedId)
        </code>
        ：从数据库读取数据，支持断点续传。
       </li>
       <li>
        <code>
         transformData()
        </code>
        ：将数据转换为目标格式。
       </li>
       <li>
        <code>
         saveData()
        </code>
        ：多线程存储数据，提高性能。
       </li>
       <li>
        <strong>
         日志记录
        </strong>
        ：每次批量迁移后，记录日志。
       </li>
       <li>
        <strong>
         Redis 断点续传
        </strong>
        ：存储已迁移的最大 ID，避免重复迁移。
       </li>
      </ul>
     </li>
     <li>
      <strong>
       扩展性
      </strong>
      ：具体子类实现
      <strong>
       不同的数据源和存储方式
      </strong>
      ，但遵循统一的流程。
     </li>
    </ol>
    <hr/>
    <h3>
     <a id="4__95">
     </a>
     4. 实战示例
    </h3>
    <blockquote>
     <p>
      <em>
       基于真实业务场景的完整实现示例
      </em>
     </p>
    </blockquote>
    <blockquote>
     <p>
      博主前段时间进行数据迁移的一个案例，任务是一个MongoDB数据迁移到Oracle数据库，由于源数据都在Mongo一个文档内，需要将这部份数据按业务迁移到多个Oracle表中，所以使用了模板方法模式，来定义一个规范的流程，简单说是读数据，清洗数据，存储数据。用了数据分片多线程处理来提升效率。
     </p>
    </blockquote>
    <h4>
     <a id="41__102">
     </a>
     4.1 迁移服务抽象基类
    </h4>
    <blockquote>
     <p>
      <em>
       增强版迁移服务基类，支持多线程处理和完善的日志记录
      </em>
     </p>
    </blockquote>
    <pre><code class="prism language-java"><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractMigrationService</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span><span class="token class-name">D</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">"oracleTransactionTemplate"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">TransactionTemplate</span> transactionTemplate<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> prefixRedis <span class="token operator">=</span> <span class="token string">"migration:"</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">MigrationLogService</span> migrationLogService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">ExecutorService</span> executorService<span class="token punctuation">;</span>


    <span class="token comment">// 模板方法，定义迁移的步骤</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">startMigration</span><span class="token punctuation">(</span><span class="token keyword">int</span> batchSize<span class="token punctuation">,</span> <span class="token keyword">boolean</span> restart<span class="token punctuation">,</span> <span class="token class-name">String</span> tableName<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">String</span> lastMigratedId <span class="token operator">=</span> <span class="token function">getLastMigratedId</span><span class="token punctuation">(</span>tableName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> documents <span class="token operator">=</span> <span class="token function">readFromSource</span><span class="token punctuation">(</span>lastMigratedId<span class="token punctuation">,</span> batchSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>documents<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">logMigrationBatch</span><span class="token punctuation">(</span>tableName<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> lastMigratedId<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> tableName<span class="token operator">+</span><span class="token string">" Migration SUCCESS"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"数据为空，退出程序！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//开始迁移数据</span>
           <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//多线程来做 每一千条切为一个线程</span>
                    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> batches <span class="token operator">=</span> <span class="token function">splitIntoBatches</span><span class="token punctuation">(</span>documents<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> allFutures <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">allOf</span><span class="token punctuation">(</span>batches<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>batch <span class="token operator">-&gt;</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">D</span><span class="token punctuation">&gt;</span></span> transformedData <span class="token operator">=</span> <span class="token function">transformData</span><span class="token punctuation">(</span>batch<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">writeToTarget</span><span class="token punctuation">(</span>transformedData<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span> executorService<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exceptionally</span><span class="token punctuation">(</span>
                            ex <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"线程执行异常"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CompletionException</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 抛出包装后的异常</span>
                            <span class="token punctuation">}</span>
                    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token class-name">CompletableFuture</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    allFutures<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">// 提交迁移状态</span>
                   <span class="token class-name">String</span> endId <span class="token operator">=</span> <span class="token function">updateMigrationStatus</span><span class="token punctuation">(</span>tableName<span class="token punctuation">,</span> documents<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">// 记录成功日志</span>
                    <span class="token function">logMigrationBatch</span><span class="token punctuation">(</span>tableName<span class="token punctuation">,</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lastMigratedId<span class="token punctuation">,</span> endId<span class="token punctuation">,</span>
                            documents<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"SUCCESS"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 记录失败日志</span>
                    <span class="token function">logMigrationBatch</span><span class="token punctuation">(</span>tableName<span class="token punctuation">,</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lastMigratedId<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
                            documents<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"FAILED"</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"迁移过程中出现错误，"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//把错误往外抛出</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

      <span class="token comment">// 具体步骤由子类实现</span>
    <span class="token comment">//读取数据 lastMigratedId:最大id batchSize:每次读取多少条数据</span>
    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">readFromSource</span><span class="token punctuation">(</span><span class="token class-name">String</span> lastMigratedId<span class="token punctuation">,</span> <span class="token keyword">int</span> batchSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//转换数据 此处使用泛型D，转换后的数据类型</span>
    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">D</span><span class="token punctuation">&gt;</span></span> <span class="token function">transformData</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> documents<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 使用泛型T</span>
    <span class="token comment">//写入数据 此处使用泛型D，写入的目标数据类型</span>
    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">writeToTarget</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">D</span><span class="token punctuation">&gt;</span></span> transformedData<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 读取最后一次迁移的ID，用于续传</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getLastMigratedId</span><span class="token punctuation">(</span><span class="token class-name">String</span> tableName<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">String</span> o <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>prefixRedis<span class="token operator">+</span>tableName<span class="token punctuation">)</span><span class="token punctuation">;</span>
         log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"缓存值："</span><span class="token operator">+</span>tableName<span class="token operator">+</span><span class="token string">"-"</span><span class="token operator">+</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> o<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
   

   <span class="token comment">// 更新迁移状态，并返回最新的ID</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">updateMigrationStatus</span><span class="token punctuation">(</span><span class="token class-name">String</span> tableName<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> documents<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>documents<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 找出ID最大的文档</span>
            <span class="token class-name">T</span> lastDocument <span class="token operator">=</span> documents<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token class-name">Comparator</span><span class="token punctuation">.</span><span class="token function">comparing</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">::</span><span class="token function">getLastId</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">String</span> lastId <span class="token operator">=</span> <span class="token function">getLastId</span><span class="token punctuation">(</span>lastDocument<span class="token punctuation">)</span><span class="token punctuation">;</span>
            redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>prefixRedis<span class="token operator">+</span>tableName<span class="token punctuation">,</span> lastId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> lastId<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    

    <span class="token comment">// 获取文档的ID，用于存在redis中记录上次迁移的ID，以便下次续传</span>
    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token class-name">String</span> <span class="token function">getLastId</span><span class="token punctuation">(</span><span class="token class-name">T</span> document<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">// 将数据分片以便多线程处理</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">splitIntoBatches</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> documents<span class="token punctuation">,</span> <span class="token keyword">int</span> batchSize<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> batches <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> documents<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">+=</span> batchSize<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            batches<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>documents<span class="token punctuation">.</span><span class="token function">subList</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>i <span class="token operator">+</span> batchSize<span class="token punctuation">,</span> documents<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> batches<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 日志记录方法,用于单独记录迁移日志</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">logMigrationBatch</span><span class="token punctuation">(</span><span class="token class-name">String</span> tableName<span class="token punctuation">,</span> <span class="token class-name">String</span> batchId<span class="token punctuation">,</span> <span class="token class-name">String</span> startId<span class="token punctuation">,</span>
                                   <span class="token class-name">String</span> endId<span class="token punctuation">,</span> <span class="token keyword">int</span> recordCount<span class="token punctuation">,</span> <span class="token class-name">String</span> status<span class="token punctuation">,</span> <span class="token class-name">String</span> errorMessage<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">MigrationLog</span> migrationLog <span class="token operator">=</span> <span class="token class-name">MigrationLog</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">tableName</span><span class="token punctuation">(</span>tableName<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">batchId</span><span class="token punctuation">(</span>batchId<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">startId</span><span class="token punctuation">(</span>startId<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">endId</span><span class="token punctuation">(</span>endId<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">recordCount</span><span class="token punctuation">(</span>recordCount<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">errorMessage</span><span class="token punctuation">(</span>errorMessage<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">createTime</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        migrationLogService<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>migrationLog<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="42__238">
     </a>
     4.2 具体实现子类
    </h4>
    <blockquote>
     <p>
      <em>
       特定业务场景的实现，包含了MongoDB到Oracle的数据转换逻辑
      </em>
     </p>
    </blockquote>
    <pre><code class="prism language-java"><span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MigrationService</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractMigrationService</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SourceData</span><span class="token punctuation">,</span><span class="token class-name">TargetDataDTO</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">MongoTemplate</span> mongoTemplate<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">JdbcTemplate</span> oracleJdbcTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">public</span> <span class="token class-name">MigrationService</span><span class="token punctuation">(</span>
            <span class="token class-name">MongoTemplate</span> mongoTemplate<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">"oracleJdbcTemplate"</span><span class="token punctuation">)</span> <span class="token class-name">JdbcTemplate</span> oracleJdbcTemplate
    <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>mongoTemplate <span class="token operator">=</span> mongoTemplate<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>oracleJdbcTemplate <span class="token operator">=</span> oracleJdbcTemplate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SourceData</span><span class="token punctuation">&gt;</span></span> <span class="token function">readFromSource</span><span class="token punctuation">(</span><span class="token class-name">String</span> lastMigratedId<span class="token punctuation">,</span> <span class="token keyword">int</span> batchSize<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 构造查询条件</span>
        <span class="token class-name">Query</span> query <span class="token operator">=</span> <span class="token class-name">BaseQueryToMongodb</span><span class="token punctuation">.</span><span class="token function">getBaseQueryByMigration</span><span class="token punctuation">(</span>lastMigratedId<span class="token punctuation">,</span>batchSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 执行查询，返回结果</span>
        <span class="token keyword">return</span> mongoTemplate<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> <span class="token class-name">SourceData</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">TJDECRP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TargetDataDTO</span><span class="token punctuation">&gt;</span></span> <span class="token function">transformData</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SourceData</span><span class="token punctuation">&gt;</span></span> documents<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span>  documents<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">map</span><span class="token punctuation">(</span>sourceData <span class="token operator">-&gt;</span>
                       <span class="token class-name">TargetDataDTO</span> targetDataDTO  <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TargetDataDTO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                       <span class="token comment">//此处省略转换逻辑，仅为示意</span>
                       <span class="token keyword">return</span> targetDataDTO<span class="token punctuation">;</span>
                       <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">writeToTarget</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TargetDataDTO</span><span class="token punctuation">&gt;</span></span> transformedData<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>transformedData<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"传入的数据列表为空，跳过写入"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//sql插入预处理语句 也可以使用其他方法去写插入</span>
            <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">"INSERT INTO xxx (ID, CREATE_DATE)"</span> <span class="token operator">+</span>
                    <span class="token string">"VALUES (?, ?)"</span><span class="token punctuation">;</span>
            <span class="token class-name">List</span><span class="token operator">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> batchArgs <span class="token operator">=</span> transformedData<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>dto <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span>
                            dto<span class="token punctuation">.</span><span class="token function">getRid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token keyword">new</span> <span class="token class-name">Timestamp</span><span class="token punctuation">(</span>dto<span class="token punctuation">.</span><span class="token function">getCREATE_DATE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> updateCounts <span class="token operator">=</span> oracleJdbcTemplate<span class="token punctuation">.</span><span class="token function">batchUpdate</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> batchArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"成功写入 {} 条数据到Oracle数据库；插入语句：{}"</span><span class="token punctuation">,</span> updateCounts<span class="token punctuation">.</span>length<span class="token punctuation">,</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>batchArgs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">DataAccessException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"数据库写入失败"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">getLastId</span><span class="token punctuation">(</span><span class="token class-name">SourceData</span> document<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> document<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="43_API_311">
     </a>
     4.3 通过API启动迁移
    </h4>
    <blockquote>
     <p>
      <em>
       提供RESTful接口启动迁移任务，支持参数化配置
      </em>
     </p>
    </blockquote>
    <pre><code class="prism language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MigrationController</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">MigrationService</span> migrationService<span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/migrate/start"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">startMigration</span><span class="token punctuation">(</span>
            <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>defaultValue <span class="token operator">=</span> <span class="token string">"4000"</span><span class="token punctuation">)</span> <span class="token keyword">int</span> batchSize<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>defaultValue <span class="token operator">=</span> <span class="token string">"false"</span><span class="token punctuation">)</span> <span class="token keyword">boolean</span> restart<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            migrationService<span class="token punctuation">.</span><span class="token function">startMigration</span><span class="token punctuation">(</span>batchSize<span class="token punctuation">,</span> restart<span class="token punctuation">,</span> <span class="token string">"TableName"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token string">"Migration started"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="5__333">
     </a>
     5. 实现说明与优化建议
    </h3>
    <blockquote>
     <p>
      <em>
       关于实现细节的补充说明和潜在的改进方向
      </em>
     </p>
    </blockquote>
    <h4>
     <a id="51__337">
     </a>
     5.1 事务处理说明
    </h4>
    <blockquote>
     <p>
      关于事务，在插入时是按分片每个1000，差分成多个线程去执行，事务是没法保证的，因为每个线程都是一个独立的连接。如果出现问题导致程序中断，那就从Redis中查最后成功的那个ID，手动去回滚大于这个ID的数据，然后修改异常后重新运行，程序会从最后成功的那个批次的最大ID开始迁移（断点续传）。
     </p>
    </blockquote>
    <h4>
     <a id="52__341">
     </a>
     5.2 潜在改进方向
    </h4>
    <ul>
     <li>
      <strong>
       事务管理
      </strong>
      ：考虑在每个线程内部使用事务模板，确保单批次的原子性
     </li>
     <li>
      <strong>
       错误恢复
      </strong>
      ：增加自动回滚机制，减少人工干预
     </li>
     <li>
      <strong>
       性能监控
      </strong>
      ：添加迁移性能指标收集，便于调优
     </li>
     <li>
      <strong>
       数据校验
      </strong>
      ：增加源数据和目标数据的一致性校验机制
     </li>
    </ul>
    <blockquote>
     <p>
      有好的想法或者改进的思路还请和博主分享呀~~~
     </p>
    </blockquote>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f34353937303936342f:61727469636c652f64657461696c732f313436313637353231" class_="artid" style="display:none">
 </p>
</div>


