---
layout: post
title: "SQLite数据库版本升级"
date: 2024-08-18 16:26:21 +0800
description: "一.简介        我们在开发应用的时候，存储数据可能会用到数据库。第一个版本时所设计的数据库结"
keywords: "sqlite数据库升级"
categories: ['Android']
tags: ['数据库', '升级', 'Sqlite', 'Android']
artid: "79526187"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=79526187
    alt: "SQLite数据库版本升级"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=79526187
featuredImagePreview: https://bing.ee123.net/img/rand?artid=79526187
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     SQLite数据库版本升级
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     <img alt="大纲" src="https://img-blog.csdn.net/20180312171037379?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZmVpYmVuZGV4aWFvbWE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" title=""/>
    </p>
    <p>
     <strong>
      一.简介
     </strong>
     <br/>
     我们在开发应用的时候，存储数据可能会用到数据库。第一个版本时所设计的数据库结构，如果在以后的app版本中需要增加业务逻辑，数据库的表可能要做相应的修改，那么原来的数据库结构就不能用了，这时就需要对数据库进行升级。
    </p>
    <p>
     <strong>
      二.升级方案
     </strong>
     <br/>
     1.让用户将应用卸载然后再安装最新版本的app
     <br/>
     2.对数据库进行升级
     <br/>
     对于第一种方案，用户卸载老版本就会造成数据丢失，这样对于用户的体验性极差，不到万不得已的时候不要做。
     <br/>
     我们倾向于选择第二项方案。
    </p>
    <p>
     <strong>
      三.不同版本升级分析
     </strong>
     <br/>
     3.1.Version1.0
     <br/>
     当我们开发第一个版本数据库的时候，SQLiteOpenHelper的继承类里会走onCreate()方法，即 —-&gt;v1.0 走onCreate()，这时候并不涉及更新的方法。
     <br/>
     3.2.Version2.0
     <br/>
     当我们开发到第二个数据库版本的时候，分两种情况：
     <br/>
     (1) 用户从1.0版本升级到2.0版本 SQLiteOpenHelper的继承类里会走onUpgrade()方法,不走onCreate()方法。即v1.0—-&gt;v2.0 走onUpgrade()；
     <br/>
     (2) 如果是用户直接安装v2.0 ， SQLiteOpenHelper的继承类里会走onCreate()方法,不走onUpgrade()方法。即 —-&gt;v2.0 走onCreate()
    </p>
    <p>
     3.3.Version3.0
     <br/>
     (1) 用户从1.0版本升级到3.0版本 ，SQLiteOpenHelper的继承类里会走onUpgrade()方法,不走onCreate()方法。即v1.0—-&gt;v3.0 走onUpgrade()
     <br/>
     (2) 用户从2.0版本升级到3.0版本 ，SQLiteOpenHelper的继承类里会走onUpgrade()方法,不走onCreate()方法。即v2.0—-&gt;v3.0 走onUpgrade()
     <br/>
     (3) 如果是用户直接安装3.0 ，SQLiteOpenHelper的继承类里会走onCreate()方法,不走onUpgrade()方法。即 —-&gt;v3.0 走onCreate()
    </p>
    <p>
     如下图
     <br/>
     <img alt="版本升级方法分析" src="https://img-blog.csdn.net/20180312143532704?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZmVpYmVuZGV4aWFvbWE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" title=""/>
    </p>
    <p>
     只要是第一次安装或者第一个数据库版本的都走onCreate()方法，而不走onUpgrade()方法，从低版本升级到高版本的都走onUpgrade()方法而不走onCreate()方法。
    </p>
    <p>
     <strong>
      四.代码分析
     </strong>
     <br/>
     <strong>
      4.1第一个版本的数据库
     </strong>
     <br/>
     第一个版本只走onCreate()，所以我们可以把创建表的方法写在这个方法里，
    </p>
    <pre class="prettyprint"><code class="hljs java">  <span class="hljs-annotation">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onCreate</span>(SQLiteDatabase db) {
        <span class="hljs-keyword">try</span> {
            db.execSQL(DataBaseConfig.FIRST_VERSION_INFO);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            Log.e(tag,<span class="hljs-string">"e=="</span>+e);
        }
    }</code></pre>
    <p>
     另外需要注意的是，我们要把创建SQLiteOpenHelper子类的地方写成单例模式，这样可以避免重复创建，出现问题。
    </p>
    <pre class="prettyprint"><code class="hljs java">
     <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">volatile</span> MySqliteOpenHelper instance = <span class="hljs-keyword">null</span>;
     <span class="hljs-javadoc">/**
     * 第一个参数 context 上下文
     * 第二个参数 name  数据库名称
     * 第三个参数 factory 为了创建cursor对象, 默认为空
     * 第四个参数 version 数据库版本
     *<span class="hljs-javadoctag"> @param</span> context
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title">MySqliteOpenHelper</span>(Context context) {
        <span class="hljs-keyword">super</span>(context, DataBaseConfig.DATABASE_NAME, <span class="hljs-keyword">null</span>, DataBaseConfig.DATABASE_NEW_VERSION);
        db = <span class="hljs-keyword">this</span>.getWritableDatabase();<span class="hljs-comment">//调用此方法时数据库才算真正创建</span>
    }
    <span class="hljs-javadoc">/**
     * 创建实例
     *
     *<span class="hljs-javadoctag"> @param</span> context
     *<span class="hljs-javadoctag"> @return</span>
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> MySqliteOpenHelper <span class="hljs-title">getDBHelper</span>(Context context) {
        <span class="hljs-keyword">if</span> (instance == <span class="hljs-keyword">null</span>) {
            <span class="hljs-keyword">synchronized</span> (MySqliteOpenHelper.class) {
                <span class="hljs-keyword">if</span> (instance == <span class="hljs-keyword">null</span>)
                    instance = <span class="hljs-keyword">new</span> MySqliteOpenHelper(context);
            }
        }
        <span class="hljs-keyword">return</span> instance;
    }
       <span class="hljs-annotation">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onCreate</span>(SQLiteDatabase db) {
        <span class="hljs-keyword">try</span> {
            db.execSQL(DataBaseConfig.FIRST_VERSION_INFO);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            Log.e(tag,<span class="hljs-string">"e=="</span>+e);
        }
    }
</code></pre>
    <pre class="prettyprint"><code class="hljs sql">//第一个版本的sql
    String FIRST_VERSION_INFO ="<span class="hljs-operator"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">exists</span> <span class="hljs-string">"+TABLE_TEST1+"</span>( <span class="hljs-string">" +
            "</span> id      <span class="hljs-keyword">varchar</span>     <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">''</span>,<span class="hljs-string">" +
            "</span> name    <span class="hljs-keyword">varchar</span>     <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">''</span>,<span class="hljs-string">" +
            "</span> age     <span class="hljs-keyword">varchar</span>     <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">''</span>)<span class="hljs-string">";</span></span></code></pre>
    <p>
     此时的DataBaseConfig.DATABASE_NEW_VERSION 为1
     <br/>
     <img alt="数据库版本1" src="https://img-blog.csdn.net/20180312154618181?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZmVpYmVuZGV4aWFvbWE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" title=""/>
    </p>
    <p>
     如果以后的需求改变，需要往数据库里加字段或者改字段，需要升级数据库。
     <br/>
     <strong>
      4.2第二个版本的数据库
     </strong>
     <br/>
     如果是从v1.0升级到v2.0，则走onUpgrade,如果是直接安装v2.0，则走onCreate()
     <br/>
     <strong>
      4.2.1. 比如从v1.0升级到v2.0 需要增加字段
     </strong>
    </p>
    <pre class="prettyprint"><code class="hljs java"><span class="hljs-javadoc">/**
     * 新版本比旧版本高就会走这个方法
     */</span>
    <span class="hljs-annotation">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onUpgrade</span>(SQLiteDatabase db, <span class="hljs-keyword">int</span> oldVersion, <span class="hljs-keyword">int</span> newVersion) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = oldVersion; i &lt; newVersion; i++) {
            <span class="hljs-keyword">switch</span> (i) {
                <span class="hljs-keyword">case</span> DataBaseConfig.DATABASE_FIRST_VERSION:
                    addUpgradeToVersion2(db);<span class="hljs-comment">//添加两个字段</span>
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">default</span>:
                    <span class="hljs-keyword">break</span>;
            }
        }
    }
 <span class="hljs-javadoc">/**
     * 新版本增加了两个字段
     *
     *<span class="hljs-javadoctag"> @param</span> db
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addUpgradeToVersion2</span>(SQLiteDatabase db) {<!-- --><span class="hljs-comment">//注意添加两个字段时要分开写</span>
        String sql1 = <span class="hljs-string">"ALTER TABLE "</span> + DataBaseConfig.TABLE_TEST1 + <span class="hljs-string">" ADD COLUMN sex  varchar"</span>;
        String sql2 = <span class="hljs-string">"ALTER TABLE "</span> + DataBaseConfig.TABLE_TEST1 + <span class="hljs-string">" ADD COLUMN address varchar"</span>;
        db.execSQL(sql1);
        db.execSQL(sql2);
    }</code></pre>
    <p>
     此时 新版本 DataBaseConfig.DATABASE_NEW_VERSION 为2 ，DataBaseConfig.DATABASE_FIRST_VERSION为1
     <br/>
     <img alt="这里写图片描述" src="https://img-blog.csdn.net/2018031215473059?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZmVpYmVuZGV4aWFvbWE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" title=""/>
    </p>
    <p>
     版本2比版本1中新增了sex,和address字段，图中的列表中选项比版本1多了两项，由于代码中默认的性别是女，所以前三个的性别是女，这个是测试所致。
    </p>
    <p>
     <strong>
      还要再处理onCreate(),因为用户可能是直接安装V2.0
     </strong>
     <br/>
     有两种方法：
     <br/>
     （1）执行旧版数据库sql,则后面还要调用onUpgrade
    </p>
    <pre class="prettyprint"><code class="hljs java"><span class="hljs-annotation">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onCreate</span>(SQLiteDatabase db) {
        <span class="hljs-keyword">try</span> {
            db.execSQL(DataBaseConfig.FIRST_VERSION_INFO);
            onUpgrade(db,DataBaseConfig.DATABASE_FIRST_VERSION,DataBaseConfig.DATABASE_NEW_VERSION);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            Log.e(tag,<span class="hljs-string">"e=="</span>+e);
        }
    }</code></pre>
    <p>
     （2）执行新版数据库sql，不需要调用onUpgrade
    </p>
    <pre class="prettyprint"><code class="hljs sql"> @Override
    public void onCreate(SQLiteDatabase db) {
        try {
            db.execSQL(DataBaseConfig.NEW_VERSION_INFO);
        } catch (Exception e) {
            Log.e(tag,"e=="+e);
        }
    }
 //增加两个字段
    String NEW_VERSION_INFO ="<span class="hljs-operator"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">exists</span> <span class="hljs-string">"+TABLE_TEST1+"</span>( <span class="hljs-string">" +
            "</span> id      <span class="hljs-keyword">varchar</span>     <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">''</span>,<span class="hljs-string">" +
            "</span> name    <span class="hljs-keyword">varchar</span>     <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">''</span>,<span class="hljs-string">" +
            "</span> age     <span class="hljs-keyword">varchar</span>     <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">''</span>,<span class="hljs-string">"+
            "</span> sex     <span class="hljs-keyword">varchar</span>     <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">''</span>,<span class="hljs-string">"+
            "</span> address  <span class="hljs-keyword">varchar</span>     <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">''</span>)<span class="hljs-string">";</span></span></code></pre>
    <p>
     <strong>
      4.2.2. 第二个版本数据库需要新增并修改字段
     </strong>
     <br/>
     <em>
      * 1. 比如从v1.0升级到v2.0 需要增加字段*
     </em>
     <br/>
     新增sex,address字段，修改age–&gt;sign
    </p>
    <pre class="prettyprint"><code class="hljs java"> <span class="hljs-javadoc">/**
     * 新版本比旧版本高就会走这个方法
     */</span>
    <span class="hljs-annotation">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onUpgrade</span>(SQLiteDatabase db, <span class="hljs-keyword">int</span> oldVersion, <span class="hljs-keyword">int</span> newVersion) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = oldVersion; i &lt; newVersion; i++) {
            <span class="hljs-keyword">switch</span> (i) {
                <span class="hljs-keyword">case</span> DataBaseConfig.DATABASE_FIRST_VERSION:
                    updateUpgradeToVersion2(db);<span class="hljs-comment">//修改表原有字段并新增字段</span>
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">default</span>:
                    <span class="hljs-keyword">break</span>;
            }
        }
    }
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">updateUpgradeToVersion2</span>(SQLiteDatabase db) {
        <span class="hljs-keyword">try</span>{
            db.beginTransaction();
            <span class="hljs-comment">// 1, 将表TABLE_TEST1重命名为TABLE_TEST1+"_temp"</span>
            String tempTableName = DataBaseConfig.TABLE_TEST1 + <span class="hljs-string">"_temp"</span>;
            String sql = <span class="hljs-string">"ALTER TABLE "</span> + DataBaseConfig.TABLE_TEST1 + <span class="hljs-string">" RENAME TO "</span> + tempTableName;
            db.execSQL(sql);
            <span class="hljs-comment">// 2, 创建用户表(字段id、name改变、并新增了以个字段phone)</span>
            db.execSQL(DataBaseConfig.NEW_VERSION_INFO);
            <span class="hljs-comment">// 3, 将旧表数据导入到新表中,旧表中的id,name,age分别查到新表中的id,name,sign</span>
            sql = <span class="hljs-string">"INSERT INTO "</span> + DataBaseConfig.TABLE_TEST1 + <span class="hljs-string">" ("</span> + <span class="hljs-string">"id,name,sign"</span> + <span class="hljs-string">") "</span> + <span class="hljs-string">" SELECT "</span> + <span class="hljs-string">"id,name,age"</span> + <span class="hljs-string">" FROM "</span> + tempTableName;
            db.execSQL(sql);
            <span class="hljs-comment">// 4, 删除旧的表</span>
            db.execSQL(<span class="hljs-string">"DROP TABLE IF EXISTS "</span> + tempTableName);
            db.setTransactionSuccessful();
            db.setVersion(<span class="hljs-number">2</span>);

        }<span class="hljs-keyword">catch</span> (SQLException e) {
            e.printStackTrace();
        } <span class="hljs-keyword">catch</span> (Exception e) {
            e.printStackTrace();
        }<span class="hljs-keyword">finally</span> {
            db.endTransaction();
        }

    }</code></pre>
    <p>
     此时 DataBaseConfig.DATABASE_NEW_VERSION 为2 ，DataBaseConfig.DATABASE_FIRST_VERSION为1
    </p>
    <p>
     <img alt="这里写图片描述" src="https://img-blog.csdn.net/20180312165606382?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZmVpYmVuZGV4aWFvbWE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" title=""/>
    </p>
    <p>
     从图中可以看出，将age修改为sign字段，增加了sex,address两项。
     <br/>
     处理onCreate()方法同增加字段里的处理一致。
    </p>
    <p>
     <strong>
      五.总结
     </strong>
     <br/>
     本文总结了数据库升级的相关内容，包括为什么要升级数据库，怎么升级数据库，新增字段和修改字段怎么处理，如有发现问题，欢迎讨论，共同学习。
    </p>
    <p>
     Demo 源码地址：
     <a href="https://download.csdn.net/download/feibendexiaoma/10282319">
      https://download.csdn.net/download/feibendexiaoma/10282319
     </a>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f:672e6373646e2e6e65742f66656962656e64657869616f6d61:2f61727469636c652f64657461696c732f3739353236313837" class_="artid" style="display:none">
 </p>
</div>


