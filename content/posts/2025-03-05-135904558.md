---
layout: post
title: "Azure-架构师学习笔记-Azure-Databricks-16-Delta-Lake-和-ADLS整合"
date: 2025-03-05 17:24:14 +0800
description: "上文提到了Delta Lake， 但是这是一个概念，如果落实到具体的资源服务上，又会有一定的修改和限制。本文介绍一下Delta Lake如何跟Azure Data Lake Store 整合。Delta Lake是一个开源框架，可以构建在ADLS之上。ADLS 并不内置事务保障或者Delta Lake提供的性能优化。所以单纯ADLS 很难满足现今的数据需求。"
keywords: "【Azure 架构师学习笔记】- Azure Databricks (16) -- Delta Lake 和 ADLS整合"
categories: ['架构师学习笔记', 'Databrikcs', 'Azure', 'Azure']
tags: ['Azuredatabricks', 'Azure']
artid: "135904558"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=135904558
    alt: "Azure-架构师学习笔记-Azure-Databricks-16-Delta-Lake-和-ADLS整合"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=135904558
featuredImagePreview: https://bing.ee123.net/img/rand?artid=135904558
cover: https://bing.ee123.net/img/rand?artid=135904558
image: https://bing.ee123.net/img/rand?artid=135904558
img: https://bing.ee123.net/img/rand?artid=135904558
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     【Azure 架构师学习笔记】- Azure Databricks (16) -- Delta Lake 和 ADLS整合
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <blockquote>
     <p>
      本文属于
      <a href="https://blog.csdn.net/dba_huangzj/category_12145228.html">
       【Azure 架构师学习笔记】系列
      </a>
      。
      <br/>
      本文属于【Azure Databricks】系列。
      <br/>
      接上文
      <a href="https://blog.csdn.net/DBA_Huangzj/article/details/145638901">
       【【Azure 架构师学习笔记】- Azure Databricks (15) --Delta Lake 和Data Lake
      </a>
     </p>
    </blockquote>
    <h2>
     <a id="_6">
     </a>
     前言
    </h2>
    <p>
     上文提到了Delta Lake， 但是这是一个概念，如果落实到具体的资源服务上，又会有一定的修改和限制。本文介绍一下Delta Lake如何跟Azure Data Lake Store 整合。
    </p>
    <p>
     Delta Lake是一个开源框架，可以构建在ADLS之上。ADLS 并不内置事务保障或者Delta Lake提供的性能优化。所以单纯ADLS 很难满足现今的数据需求。
    </p>
    <h2>
     <a id="Delta_Lake_ADLS__11">
     </a>
     Delta Lake 与ADLS 的优势互补
    </h2>
    <p>
     ADLS 对于“存”操作是很快速的，但是对于“搜索、list”文件则很慢。Delta Lake通过减少昂贵的文件列举操作而加快数据检索。
     <br/>
     所有的云存储系统使用扁平的命名空间。不像文件系统的层级结构，所以在list文件时很慢，就类似没有索引的数据库中的数据表，需要遍历所有数据。 ADLS 没有真正的目录，而是在对象名字前面添加前缀来实现。所以list 文件意味着系统要扫描全部文件，并且用前缀筛选。
    </p>
    <p>
     另外， ADLS 上如果受到API 过度调用， 则会出现瓶颈，特别是对大数据集。如果一个大表的数据被拆分到ADLS 上的很多文件，那么ADLS 就要遍历所有文件，然后筛选，从而导致额外的延时。
    </p>
    <p>
     对此，Delta Lake把文件路径存储在一个事务日志文件中，就如数据库中的索引，list文件时先从事务日志文件中查找，然后再去具体的路径中检索数据。
    </p>
    <h2>
     <a id="_19">
     </a>
     使用演示
    </h2>
    <p>
     下面使用Spark来演示一下如何操作Delta Lake，这里借用前面的ADB 环境，ADB 实际上非必须，只是借用上面的Spark环境。
    </p>
    <h3>
     <a id="_23">
     </a>
     环境配置
    </h3>
    <p>
     使用下面python命令配置Spark和Delta， 替换代码中的中文字部分即可。
    </p>
    <pre><code class="prism language-python"><span class="token operator">%</span>python
<span class="token keyword">import</span> pyspark
<span class="token keyword">from</span> delta <span class="token keyword">import</span> <span class="token operator">*</span>

extra_packages <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">"org.apache.hadoop:hadoop-azure:3.3.4"</span><span class="token punctuation">,</span>
    <span class="token comment"># version must match hadoop-client-runtime</span>
<span class="token punctuation">]</span>

builder <span class="token operator">=</span> <span class="token punctuation">(</span>
    pyspark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>SparkSession<span class="token punctuation">.</span>builder<span class="token punctuation">.</span>appName<span class="token punctuation">(</span><span class="token string">"DeltaOnADLS"</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>config<span class="token punctuation">(</span><span class="token string">"spark.sql.catalog.spark_catalog"</span><span class="token punctuation">,</span> <span class="token string">"org.apache.spark.sql.delta.catalog.DeltaCatalog"</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>config<span class="token punctuation">(</span><span class="token string">"spark.sql.extensions"</span><span class="token punctuation">,</span> <span class="token string">"io.delta.sql.DeltaSparkSessionExtension"</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>config<span class="token punctuation">(</span><span class="token string">"spark.hadoop.fs.azurebfs.impl"</span><span class="token punctuation">,</span> <span class="token string">"org.apache.hadoop.fs.azurebfs.AzureBlobFileSystem"</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>config<span class="token punctuation">(</span><span class="token string">"fs.azure.account.key.ADLS 名字.dfs.core.windows.net"</span><span class="token punctuation">,</span> <span class="token string">"你的ADLS 的access key"</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>

spark <span class="token operator">=</span> configure_spark_with_delta_pip<span class="token punctuation">(</span>
    builder<span class="token punctuation">,</span> extra_packages<span class="token operator">=</span>extra_packages
<span class="token punctuation">)</span><span class="token punctuation">.</span>getOrCreate<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/ae7eea91ad1640779ab7b78240984f9a.png">
      <br/>
      如果过程中报这样的错： “org.apache.hadoop.fs.FileAlreadyExistsException: Operation failed: “This endpoint does not support BlobStorageEvents or SoftDelete. Please disable these account features if you would like to use this endpoint.”
      <br/>
      ”
      <br/>
      需要禁用ADLS 中这个设置，因为它影响了Delta的ACID 特性。
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/542270c404904888b18d8e1e996ed37e.png"/>
     </img>
    </p>
    <h3>
     <a id="_55">
     </a>
     写入数据
    </h3>
    <pre><code class="prism language-python">
<span class="token comment"># Create sample data</span>
data <span class="token operator">=</span> spark<span class="token punctuation">.</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>

<span class="token comment"># Write data to a Delta table in ADLS</span>
data<span class="token punctuation">.</span>write<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">"delta"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token string">"abfss://bronze@medallionadls01.dfs.core.windows.net/delta-table"</span><span class="token punctuation">)</span>

</code></pre>
    <p>
     写入后从ADLS 上可以看到新建了一个文件夹：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/0178298944e34c6383923ef9661e55b8.png">
      <br/>
      文件夹内部是具有transaction log (这里是_delta_log)的文件集合。
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/6dfefdc4412849fda2d7ac79a1d6014e.png"/>
     </img>
    </p>
    <h3>
     <a id="_70">
     </a>
     读取数据
    </h3>
    <p>
     执行下面命令，注意修改路径为上面写入数据的路径和文件夹
    </p>
    <pre><code class="prism language-python"><span class="token comment"># Read Delta table from ADLS</span>
df <span class="token operator">=</span> spark<span class="token punctuation">.</span>read<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">"delta"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">"abfss://bronze@medallionadls01.dfs.core.windows.net/delta-table"</span><span class="token punctuation">)</span>
df<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     结果如下：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/6be8b907e66143bda266dddbd5c153e5.png"/>
    </p>
    <h3>
     <a id="_80">
     </a>
     更新和删除数据
    </h3>
    <pre><code class="prism language-python"><span class="token keyword">from</span> delta<span class="token punctuation">.</span>tables <span class="token keyword">import</span> DeltaTable

<span class="token comment"># Load Delta table</span>
deltaTable <span class="token operator">=</span> DeltaTable<span class="token punctuation">.</span>forPath<span class="token punctuation">(</span>spark<span class="token punctuation">,</span> <span class="token string">"abfss://bronze@medallionadls01.dfs.core.windows.net/delta-table"</span><span class="token punctuation">)</span>

<span class="token comment"># Update rows where id is less than 4</span>
deltaTable<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token string">"id &lt; 4"</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token string">"id + 20"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment"># Delete rows where id is less than 5</span>
deltaTable<span class="token punctuation">.</span>delete<span class="token punctuation">(</span><span class="token string">"id &lt; 5"</span><span class="token punctuation">)</span>

<span class="token comment"># Read Delta table from ADLS</span>
df <span class="token operator">=</span> spark<span class="token punctuation">.</span>read<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">"delta"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">"abfss://bronze@medallionadls01.dfs.core.windows.net/delta-table"</span><span class="token punctuation">)</span>
df<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     结果如下：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/843678e93b9b478ca9176aad470e70ab.png"/>
    </p>
    <h3>
     <a id="Merge_100">
     </a>
     Merge数据
    </h3>
    <pre><code class="prism language-python"><span class="token comment"># Merge new data into Delta table</span>
new_data <span class="token operator">=</span> spark<span class="token punctuation">.</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span>

deltaTable<span class="token punctuation">.</span>alias<span class="token punctuation">(</span><span class="token string">"old"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>merge<span class="token punctuation">(</span>
    new_data<span class="token punctuation">.</span>alias<span class="token punctuation">(</span><span class="token string">"new"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">"old.id = new.id"</span>
<span class="token punctuation">)</span><span class="token punctuation">.</span>whenMatchedUpdate<span class="token punctuation">(</span><span class="token builtin">set</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token string">"new.id"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>whenNotMatchedInsert<span class="token punctuation">(</span>values<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token string">"new.id"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># Read Delta table from ADLS</span>
df <span class="token operator">=</span> spark<span class="token punctuation">.</span>read<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">"delta"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">"abfss://bronze@medallionadls01.dfs.core.windows.net/delta-table"</span><span class="token punctuation">)</span>
df<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/c711303c2cea4af2a5d22f60f1432b16.png"/>
    </p>
    <h2>
     <a id="_119">
     </a>
     小结
    </h2>
    <p>
     本文演示了如何在ADLS 上搭建delta并进行了简单的数据操作。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f4442415f4875616e677a6a2f:61727469636c652f64657461696c732f313335393034353538" class_="artid" style="display:none">
 </p>
</div>


