---
layout: post
title: "J-LangChain-Agent-编排一个-ReAct-Function-Call-反应链"
date: 2025-03-11 12:30:22 +0800
description: "j-langchain 是一款基于 Java 的 AIGC 编排框架，致力于集成多种大模型（LLM）调用及 RAG 工具。自 1.0.8 版本起，我们引入了工具函数（Function Call）调用能力，正式实现了Tools功能，并将其与模式结合，从而构建出功能丰富、交互智能的Agent系统。在本文中，我们将通过一个详实的实例，展示如何利用 Tools 功能编排一个具备 ReAct 反应链的 Agent。"
keywords: "J-LangChain - Agent - 编排一个 ReAct + Function Call 反应链"
categories: ['Langchain']
tags: ['Prompt', 'Langchain', 'Java', 'Gpt', 'Github', 'Aigc', 'Ai']
artid: "146173469"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146173469
    alt: "J-LangChain-Agent-编排一个-ReAct-Function-Call-反应链"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146173469
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146173469
cover: https://bing.ee123.net/img/rand?artid=146173469
image: https://bing.ee123.net/img/rand?artid=146173469
img: https://bing.ee123.net/img/rand?artid=146173469
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     J-LangChain - Agent - 编排一个 ReAct + Function Call 反应链
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     系列文章索引
     <br/>
     <a href="https://blog.csdn.net/fenglingguitar/article/details/144745043">
      J-LangChain 入门
     </a>
    </p>
    <h3>
     <a id="_4">
     </a>
     介绍
    </h3>
    <p>
     <a href="https://github.com/flower-trees/j-langchain">
      j‑langchain
     </a>
     是一款基于 Java 的 AIGC 编排框架，致力于集成多种大模型（LLM）调用及 RAG 工具。自 1.0.8 版本起，我们引入了
     <code>
      工具函数
     </code>
     （Function Call）调用能力，正式实现了
     <code>
      Tools
     </code>
     功能，并将其与
     <code>
      ReAct（Reasoning + Acting）
     </code>
     模式结合，从而构建出功能丰富、交互智能的
     <code>
      Agent
     </code>
     系统。
    </p>
    <p>
     在本文中，我们将通过一个详实的实例，展示如何利用 Tools 功能编排一个具备 ReAct 反应链的 Agent。不仅能够体验 j‑langchain 的 Function Call 功能，还能深入了解大模型在 ReAct 反应链中如何一步步调用外部工具，实现复杂推理与动态响应。
    </p>
    <h3>
     <a id="_9">
     </a>
     示例场景
    </h3>
    <p>
     假设我们需要构建一个智能代理，能够回答类似于“上海的天气如何？”的等问题。为此，我们需要：
    </p>
    <ul>
     <li>
      <p>
       定义一个提示模板（Prompt Template），指导代理如何处理问题。
      </p>
     </li>
     <li>
      <p>
       配置工具（Tools），例如获取天气和时间的函数。
      </p>
     </li>
     <li>
      <p>
       实现一个带有工具调用的循环逻辑，确保代理能在必要时获取外部信息。
      </p>
     </li>
     <li>
      <p>
       解析并返回最终答案。
      </p>
     </li>
    </ul>
    <p>
     以下是实现这一功能的完整代码解析。
    </p>
    <h3>
     <a id="_23">
     </a>
     代码解析
    </h3>
    <h4>
     <a id="1__24">
     </a>
     1. 定义提示模板
    </h4>
    <p>
     提示模板是代理的核心，它告诉模型如何思考和行动。我们使用 PromptTemplate 类定义了一个结构化的模板：
    </p>
    <pre><code class="prism language-java"><span class="token class-name">PromptTemplate</span> prompt <span class="token operator">=</span> <span class="token class-name">PromptTemplate</span><span class="token punctuation">.</span><span class="token function">fromTemplate</span><span class="token punctuation">(</span>
                <span class="token triple-quoted-string string">"""
                Answer the following questions as best you can. You have access to the following tools:
                
                ${tools}
                
                Use the following format:
                
                Question: the input question you must answer
                Thought: Consider whether you already have enough information to answer the question. If so, proceed directly to the final answer.
                
                If additional information is needed, take the following steps:
                - Identify what specific information is missing.
                - Call the appropriate tool to obtain that information.
                - Analyze the new information and determine if the question can now be answered.
                
                When using tools, follow this structured approach:
                Action: the action to take, should be one of [${toolNames}]
                Action Input: the input to the action
                Observation: the result of the action
                
                - You may use tools **up to 3 times**. If you still lack a complete answer after 3 attempts, summarize the best possible response.
                - If a tool's result is **irrelevant or does not improve understanding**, do not call the same tool again. Instead, attempt to derive an answer from available information.
                
                Thought: Based on the gathered information, determine if you can now provide a final answer. If yes, proceed to:
                Final Answer: the final answer to the original input question.
                If not, provide the best possible answer with a note on any remaining uncertainties.
                
                Begin!
                
                Question: ${input}
                Thought:
                """</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <ul>
     <li>
      <code>
       ${tools}
      </code>
      和
      <code>
       ${toolNames}
      </code>
      是占位符，会在运行时被替换为实际的工具列表和工具名称。
     </li>
     <li>
      <code>
       ${input}
      </code>
      使用户提出的问题。
     </li>
     <li>
      模板中明确了代理的思考步骤：先判断是否需要更多信息，若需要则调用工具，最后给出答案。
     </li>
    </ul>
    <h4>
     <a id="2__67">
     </a>
     2. 配置语言模型
    </h4>
    <p>
     我们使用
     <code>
      ChatOllama
     </code>
     作为语言模型，设置 temperature 为 0 以确保输出稳定：
    </p>
    <pre><code class="prism language-java"><span class="token class-name">ChatOllama</span> llm <span class="token operator">=</span> <span class="token class-name">ChatOllama</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">"llama3:8b"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">temperature</span><span class="token punctuation">(</span><span class="token number">0f</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     当然你可以调试更聪明的模型，但此实例中
     <code>
      llama3:8b
     </code>
     已经可以达到效果。
    </p>
    <h4>
     <a id="3__74">
     </a>
     3. 定义工具
    </h4>
    <p>
     工具是代理获取外部信息的关键。我们定义了两个简单工具：获取天气和获取时间：
    </p>
    <pre><code class="prism language-java"><span class="token class-name">Tool</span> getWeather <span class="token operator">=</span> <span class="token class-name">Tool</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">"get_weather"</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">params</span><span class="token punctuation">(</span><span class="token string">"location: String"</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token string">"Get city weather information and enter the city name"</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">func</span><span class="token punctuation">(</span>location <span class="token operator">-&gt;</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"The weather in %s is sunny with a temperature of 25°C"</span><span class="token punctuation">,</span> location<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Tool</span> getTime <span class="token operator">=</span> <span class="token class-name">Tool</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">"get_time"</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">params</span><span class="token punctuation">(</span><span class="token string">"city: String"</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token string">"Get city the current time and enter the city name"</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">func</span><span class="token punctuation">(</span>location <span class="token operator">-&gt;</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%s The current time is 12:00 PM"</span><span class="token punctuation">,</span> location<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tool</span><span class="token punctuation">&gt;</span></span> tools <span class="token operator">=</span> <span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>getWeather<span class="token punctuation">,</span> getTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
prompt<span class="token punctuation">.</span><span class="token function">withTools</span><span class="token punctuation">(</span>tools<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <ul>
     <li>
      <code>
       Tool.builder()
      </code>
      提供了简洁的方式来定义工具的名称、参数、描述和执行逻辑。
     </li>
     <li>
      <code>
       prompt.withTools(tools)
      </code>
      将工具注入提示模板。
     </li>
    </ul>
    <h4>
     <a id="4__99">
     </a>
     4. 辅助节点
    </h4>
    <p>
     为了实现
     <code>
      ReAct
     </code>
     形式交互，我们需要设计一个循环，并实现一些节点处理中间结果，和循环的退出判断，辅助流程：
    </p>
    <h5>
     <a id="41__101">
     </a>
     4.1 处理工具调用的中间结果
    </h5>
    <pre><code class="prism language-java">
<span class="token class-name">TranslateHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AIMessage</span><span class="token punctuation">,</span> <span class="token class-name">AIMessage</span><span class="token punctuation">&gt;</span></span> cut <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TranslateHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>llmResult <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>llmResult <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>llmResult<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>llmResult<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"Observation:"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> llmResult<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">String</span> prefix <span class="token operator">=</span> llmResult<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> llmResult<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"Observation:"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    llmResult<span class="token punctuation">.</span><span class="token function">setContent</span><span class="token punctuation">(</span>prefix<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> llmResult<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <ul>
     <li>
      <code>
       cut
      </code>
      处理器截取模型输出中工具调用前的部分，确保后续逻辑只处理必要内容。
     </li>
    </ul>
    <h5>
     <a id="42__115">
     </a>
     4.2 解析模型输出
    </h5>
    <pre><code class="prism language-java"><span class="token class-name">TranslateHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">AIMessage</span><span class="token punctuation">&gt;</span></span> trans <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TranslateHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>llmResult <span class="token operator">-&gt;</span> <span class="token class-name">PromptUtil</span><span class="token punctuation">.</span><span class="token function">stringToMap</span><span class="token punctuation">(</span>llmResult<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <ul>
     <li>
      <code>
       trans
      </code>
      将模型生成的文本解析为键值对（如 Action 和 Action Input）。
     </li>
    </ul>
    <h5>
     <a id="43__121">
     </a>
     4.3 循环控制
    </h5>
    <pre><code class="prism language-java">
<span class="token keyword">int</span> limit <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> isFinish <span class="token operator">=</span> i <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token class-name">ContextBus</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span>trans<span class="token punctuation">.</span><span class="token function">getNodeId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> i <span class="token operator">&lt;</span> limit <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>map <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token string">"Action"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> map<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token string">"Action Input"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <ul>
     <li>
      <code>
       isFinish
      </code>
      定义了循环退出条件：最多迭代 10 次，或模型不再需要调用工具。
     </li>
    </ul>
    <h5>
     <a id="44__132">
     </a>
     4.4 执行工具调用
    </h5>
    <pre><code class="prism language-java"><span class="token comment">// 入参为trans节点键值对结果</span>
<span class="token class-name">TranslateHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> call <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TranslateHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>map <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 获取原promt模型，用于追加</span>
    <span class="token class-name">StringPromptValue</span> promptResult <span class="token operator">=</span> <span class="token class-name">ContextBus</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span>prompt<span class="token punctuation">.</span><span class="token function">getNodeId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取cut节点结果，用于追加</span>
    <span class="token class-name">AIMessage</span> cutResult <span class="token operator">=</span> <span class="token class-name">ContextBus</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span>cut<span class="token punctuation">.</span><span class="token function">getNodeId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Tool</span> useTool <span class="token operator">=</span> tools<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>t <span class="token operator">-&gt;</span> t<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"Action"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findAny</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>useTool <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        promptResult<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span>promptResult<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"again"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> promptResult<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">String</span> observation <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> useTool<span class="token punctuation">.</span><span class="token function">getFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"Action Input"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Observation: "</span> <span class="token operator">+</span> observation<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">String</span> prefix <span class="token operator">=</span> cutResult<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> agentScratchpad <span class="token operator">=</span> prefix<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>prefix<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"Thought:"</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\nObservation:"</span> <span class="token operator">+</span> observation <span class="token operator">+</span> <span class="token string">"\nThought:"</span><span class="token punctuation">;</span>
    promptResult<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span>promptResult<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> agentScratchpad<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> promptResult<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <ul>
     <li>
      <code>
       call
      </code>
      处理器执行工具调用，并将结果（Observation）追加到提示中，供下一次循环使用。
     </li>
    </ul>
    <h4>
     <a id="5__158">
     </a>
     5. 组装完整流程
    </h4>
    <p>
     使用 ChainActor 构建完整的执行链：
    </p>
    <pre><code class="prism language-java"><span class="token class-name">FlowInstance</span> chain <span class="token operator">=</span> chainActor<span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>sPrint<span class="token punctuation">)</span> <span class="token comment">// 打印开始标记</span>
      <span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>prompt<span class="token punctuation">)</span> <span class="token comment">// 构建prompt</span>
      <span class="token punctuation">.</span><span class="token function">loop</span><span class="token punctuation">(</span>
	       <span class="token comment">// 循环是否退出</span>
	       isFinish<span class="token punctuation">,</span>
	
	       <span class="token comment">// 循环执行</span>
	       llm<span class="token punctuation">,</span>
	       chainActor<span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 嵌入中间结果执行链</span>
               <span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>cut<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>trans<span class="token punctuation">)</span> <span class="token comment">// 处理每次模型输出</span>
               <span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>
               		<span class="token class-name">Info</span><span class="token punctuation">.</span><span class="token function">c</span><span class="token punctuation">(</span>isCall<span class="token punctuation">,</span> call<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 判断需要调用工具</span>
                    <span class="token class-name">Info</span><span class="token punctuation">.</span><span class="token function">c</span><span class="token punctuation">(</span>input <span class="token operator">-&gt;</span> <span class="token class-name">ContextBus</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span>llm<span class="token punctuation">.</span><span class="token function">getNodeId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 判断不需要调用工具，直接输出模型结果</span>
               <span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>parser<span class="token punctuation">)</span> <span class="token comment">// 解析结果</span>
      <span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>answer<span class="token punctuation">)</span> <span class="token comment">// 再次处理模型输出结果，截取</span>
      <span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>ePrint<span class="token punctuation">)</span> <span class="token comment">// 打印结束标记</span>
      <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <h5>
     <a id="6__183">
     </a>
     6. 执行并测试
    </h5>
    <pre><code>&gt; Entering new AgentExecutor chain...
A straightforward question! Let's see if we can get an answer without using any tools.

Thought: We don't have any information about Shanghai's weather yet. But we can try to use the `get_weather` tool to find out!

Action: get_weather
Action Input: Shanghai

Observation: The weather in Shanghai is sunny with a temperature of 25°C
Thought: Now that we have the weather information for Shanghai, let's proceed to answer the question.

Final Answer: The weather in Shanghai is sunny with a temperature of 25°C.
&gt; Finished chain.
The weather in Shanghai is sunny with a temperature of 25°C.
</code></pre>
    <h3>
     <a id="_201">
     </a>
     完整代码实例
    </h3>
    <p>
     <a href="https://github.com/flower-trees/j-langchain-example/blob/master/src/main/java/org/salt/jlangchain/demo/rag/tools/ZeroShotReactDescription.java">
      https://github.com/flower-trees/j-langchain-example/blob/master/src/main/java/org/salt/jlangchain/demo/rag/tools/ZeroShotReactDescription.java
     </a>
    </p>
    <pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ZeroShotReactDescription</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">ChainActor</span> chainActor<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

        <span class="token class-name">PromptTemplate</span> prompt <span class="token operator">=</span> <span class="token class-name">PromptTemplate</span><span class="token punctuation">.</span><span class="token function">fromTemplate</span><span class="token punctuation">(</span>
                <span class="token triple-quoted-string string">"""
                Answer the following questions as best you can. You have access to the following tools:
                
                ${tools}
                
                Use the following format:
                
                Question: the input question you must answer
                Thought: Consider whether you already have enough information to answer the question. If so, proceed directly to the final answer.
                
                If additional information is needed, take the following steps:
                - Identify what specific information is missing.
                - Call the appropriate tool to obtain that information.
                - Analyze the new information and determine if the question can now be answered.
                
                When using tools, follow this structured approach:
                Action: the action to take, should be one of [${toolNames}]
                Action Input: the input to the action
                Observation: the result of the action
                
                - You may use tools **up to 3 times**. If you still lack a complete answer after 3 attempts, summarize the best possible response.
                - If a tool's result is **irrelevant or does not improve understanding**, do not call the same tool again. Instead, attempt to derive an answer from available information.
                
                Thought: Based on the gathered information, determine if you can now provide a final answer. If yes, proceed to:
                Final Answer: the final answer to the original input question.
                If not, provide the best possible answer with a note on any remaining uncertainties.
                
                Begin!
                
                Question: ${input}
                Thought:
                """</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">ChatOllama</span> llm <span class="token operator">=</span> <span class="token class-name">ChatOllama</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">"llama3:8b"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">temperature</span><span class="token punctuation">(</span><span class="token number">0f</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Tool</span> getWeather <span class="token operator">=</span> <span class="token class-name">Tool</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">"get_weather"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">params</span><span class="token punctuation">(</span><span class="token string">"location: String"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token string">"Get city weather information and enter the city name"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">func</span><span class="token punctuation">(</span>location <span class="token operator">-&gt;</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"The weather in %s is sunny with a temperature of 25°C"</span><span class="token punctuation">,</span> location<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Tool</span> getTime <span class="token operator">=</span> <span class="token class-name">Tool</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">"get_time"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">params</span><span class="token punctuation">(</span><span class="token string">"city: String"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token string">"Get city the current time and enter the city name"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">func</span><span class="token punctuation">(</span>location <span class="token operator">-&gt;</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%s The current time is 12:00 PM"</span><span class="token punctuation">,</span> location<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tool</span><span class="token punctuation">&gt;</span></span> tools <span class="token operator">=</span> <span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>getWeather<span class="token punctuation">,</span> getTime<span class="token punctuation">)</span><span class="token punctuation">;</span>

        prompt<span class="token punctuation">.</span><span class="token function">withTools</span><span class="token punctuation">(</span>tools<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">TranslateHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AIMessage</span><span class="token punctuation">,</span> <span class="token class-name">AIMessage</span><span class="token punctuation">&gt;</span></span> cut <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TranslateHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>llmResult <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>llmResult <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>llmResult<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>llmResult<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"Observation:"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>llmResult <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>llmResult<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> llmResult<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">String</span> prefix <span class="token operator">=</span> llmResult<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> llmResult<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"Observation:"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>prefix<span class="token punctuation">)</span><span class="token punctuation">;</span>
            llmResult<span class="token punctuation">.</span><span class="token function">setContent</span><span class="token punctuation">(</span>prefix<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> llmResult<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">TranslateHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">AIMessage</span><span class="token punctuation">&gt;</span></span> trans <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TranslateHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>llmResult <span class="token operator">-&gt;</span> <span class="token class-name">PromptUtil</span><span class="token punctuation">.</span><span class="token function">stringToMap</span><span class="token punctuation">(</span>llmResult<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">int</span> limit <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
        <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> isFinish <span class="token operator">=</span> i <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token class-name">ContextBus</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span>trans<span class="token punctuation">.</span><span class="token function">getNodeId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> i <span class="token operator">&lt;</span> limit <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>map <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token string">"Action"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> map<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token string">"Action Input"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> isCall <span class="token operator">=</span> map <span class="token operator">-&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> map<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token string">"Action"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> map<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token string">"Action Input"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">TranslateHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> call <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TranslateHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>map <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">StringPromptValue</span> promptResult <span class="token operator">=</span> <span class="token class-name">ContextBus</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span>prompt<span class="token punctuation">.</span><span class="token function">getNodeId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">AIMessage</span> cutResult <span class="token operator">=</span> <span class="token class-name">ContextBus</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span>cut<span class="token punctuation">.</span><span class="token function">getNodeId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">Tool</span> useTool <span class="token operator">=</span> tools<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>t <span class="token operator">-&gt;</span> t<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"Action"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findAny</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>useTool <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                promptResult<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span>promptResult<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"again"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> promptResult<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">String</span> observation <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> useTool<span class="token punctuation">.</span><span class="token function">getFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"Action Input"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Observation: "</span> <span class="token operator">+</span> observation<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">String</span> prefix <span class="token operator">=</span> cutResult<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> agentScratchpad <span class="token operator">=</span> prefix<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>prefix<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"Thought:"</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\nObservation:"</span> <span class="token operator">+</span> observation <span class="token operator">+</span> <span class="token string">"\nThought:"</span><span class="token punctuation">;</span>
            promptResult<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span>promptResult<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> agentScratchpad<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> promptResult<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">StrOutputParser</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StrOutputParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">TranslateHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> answer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TranslateHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>input <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">ChatGeneration</span> generation <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ChatGeneration</span><span class="token punctuation">)</span> input<span class="token punctuation">;</span>
            <span class="token class-name">String</span> content <span class="token operator">=</span> generation<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>content<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"Final Answer:"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">int</span> start <span class="token operator">=</span> content<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"Final Answer:"</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">13</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> end <span class="token operator">=</span> content<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">,</span> start<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>end <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    generation<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span>content<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    generation<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span>content<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> generation<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">ConsumerHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> sPrint <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConsumerHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>input <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"&gt; Entering new AgentExecutor chain..."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ConsumerHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> ePrint <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConsumerHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>input <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"&gt; Finished chain."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">FlowInstance</span> chain <span class="token operator">=</span> chainActor<span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>sPrint<span class="token punctuation">)</span> <span class="token comment">// print start</span>
                <span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>prompt<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">loop</span><span class="token punctuation">(</span>
                        <span class="token comment">// Loop Exit Conditions</span>
                        isFinish<span class="token punctuation">,</span>

                        <span class="token comment">// Loop Flow</span>
                        llm<span class="token punctuation">,</span>
                        chainActor<span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>cut<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>trans<span class="token punctuation">)</span> <span class="token comment">// convert content generated by mll</span>
                                <span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>
                                        <span class="token class-name">Info</span><span class="token punctuation">.</span><span class="token function">c</span><span class="token punctuation">(</span>isCall<span class="token punctuation">,</span> call<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// need call function</span>
                                        <span class="token class-name">Info</span><span class="token punctuation">.</span><span class="token function">c</span><span class="token punctuation">(</span>input <span class="token operator">-&gt;</span> <span class="token class-name">ContextBus</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span>llm<span class="token punctuation">.</span><span class="token function">getNodeId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// else no need, return mll result</span>
                                <span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

                <span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>parser<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>answer<span class="token punctuation">)</span> <span class="token comment">// deal result</span>
                <span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>ePrint<span class="token punctuation">)</span> <span class="token comment">// print end</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">ChatGeneration</span> result <span class="token operator">=</span> chainActor<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>chain<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"input"</span><span class="token punctuation">,</span> <span class="token string">"What's the weather like in Shanghai?"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="_357">
     </a>
     总结
    </h3>
    <p>
     综上所述，我们完整的演示了如何用
     <code>
      j‑langchain
     </code>
     一步步编排一个
     <code>
      React
     </code>
     +
     <code>
      function call
     </code>
     形式的
     <code>
      Agent
     </code>
     ，欢迎大家
     <a href="https://github.com/flower-trees/j-langchain">
      clone
     </a>
     体验，后续会有更多的编排实例和封装，期待反馈~~
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f67:2e6373646e2e6e65742f66656e676c696e676775697461722f:61727469636c652f64657461696c732f313436313733343639" class_="artid" style="display:none">
 </p>
</div>


