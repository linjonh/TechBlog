---
layout: post
title: "用Haskell语言和wreq库配合HTTP写个爬虫程序"
date: 2025-03-10 11:27:50 +0800
description: "在 Haskell 中，wreq 库是一个非常方便的 HTTP 请求库，适合用来编写爬虫程序。你可以使用它来发送 GET 或 POST 请求，抓取网页内容，处理响应数据等。我们可以结合 HTTP 代理配置来实现网络请求。"
keywords: "用Haskell语言和wreq库配合HTTP写个爬虫程序"
categories: ['未分类']
tags: ['网络协议', '爬虫', 'Http']
artid: "146148705"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146148705
    alt: "用Haskell语言和wreq库配合HTTP写个爬虫程序"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146148705
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146148705
cover: https://bing.ee123.net/img/rand?artid=146148705
image: https://bing.ee123.net/img/rand?artid=146148705
img: https://bing.ee123.net/img/rand?artid=146148705
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     用Haskell语言和wreq库配合HTTP写个爬虫程序
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     在 Haskell 中，
     <code>
      wreq
     </code>
     库是一个非常方便的 HTTP 请求库，适合用来编写爬虫程序。你可以使用它来发送 GET 或 POST 请求，抓取网页内容，处理响应数据等。我们可以结合 HTTP 代理配置来实现网络请求。
    </p>
    <p>
     下面我将展示如何在 Haskell 中使用
     <code>
      wreq
     </code>
     库配合 HTTP 请求编写一个爬虫程序。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/51f3c5e46a2f4fa1b25aa4e3c94a2e46.png#pic_center"/>
    </p>
    <p>
     <strong>
      1、安装
      <code>
       wreq
      </code>
      和
      <code>
       http-client
      </code>
      库
     </strong>
    </p>
    <p>
     首先，确保你已安装
     <code>
      wreq
     </code>
     库。你可以通过
     <code>
      cabal
     </code>
     安装它。
     <code>
      wreq
     </code>
     依赖于
     <code>
      http-client
     </code>
     和
     <code>
      http-client-tls
     </code>
     库，因此需要一起安装。
    </p>
    <pre><code class="prism language-bash">cabal update
cabal <span class="token function">install</span> wreq
</code></pre>
    <p>
     <strong>
      2、、导入必要模块
     </strong>
    </p>
    <p>
     在 Haskell 中，我们需要导入以下模块：
    </p>
    <pre><code class="prism language-haskell"><span class="token import-statement"><span class="token keyword">import</span> Control<span class="token punctuation">.</span>Lens</span>
<span class="token import-statement"><span class="token keyword">import</span> Network<span class="token punctuation">.</span>Wreq</span>
<span class="token import-statement"><span class="token keyword">import</span> <span class="token keyword">qualified</span> Data<span class="token punctuation">.</span>ByteString<span class="token punctuation">.</span>Lazy<span class="token punctuation">.</span>Char8 <span class="token keyword">as</span> L8</span>
<span class="token import-statement"><span class="token keyword">import</span> Network<span class="token punctuation">.</span>HTTP<span class="token punctuation">.</span>Client</span> <span class="token punctuation">(</span><span class="token hvariable">newManager</span><span class="token punctuation">,</span> <span class="token hvariable">defaultManagerSettings</span><span class="token punctuation">)</span>
<span class="token import-statement"><span class="token keyword">import</span> Network<span class="token punctuation">.</span>Wreq<span class="token punctuation">.</span>Session</span> <span class="token punctuation">(</span><span class="token hvariable">withSession</span><span class="token punctuation">)</span>
<span class="token import-statement"><span class="token keyword">import</span> Data<span class="token punctuation">.</span>Aeson</span>
</code></pre>
    <ul>
     <li>
      <code>
       Control.Lens
      </code>
      : 用于从 HTTP 请求和响应中提取数据。
     </li>
     <li>
      <code>
       Network.Wreq
      </code>
      : 提供了发送 HTTP 请求的功能。
     </li>
     <li>
      <code>
       Data.ByteString.Lazy.Char8
      </code>
      : 用于处理响应的字节流。
     </li>
     <li>
      <code>
       Network.HTTP.Client
      </code>
      : 负责创建 HTTP 客户端和配置代理。
     </li>
     <li>
      <code>
       Network.Wreq.Session
      </code>
      : 用于创建带有会话状态的请求，适合需要持续会话的爬虫任务。
     </li>
    </ul>
    <p>
     <strong>
      3、设置 HTTP 代理
     </strong>
    </p>
    <p>
     假设你需要使用 HTTP 代理服务器来发送请求，首先需要配置代理：
    </p>
    <pre><code class="prism language-haskell"><span class="token import-statement"><span class="token keyword">import</span> Network<span class="token punctuation">.</span>Wreq</span>
<span class="token import-statement"><span class="token keyword">import</span> Network<span class="token punctuation">.</span>HTTP<span class="token punctuation">.</span>Client</span> <span class="token punctuation">(</span><span class="token hvariable">newManager</span><span class="token punctuation">,</span> <span class="token hvariable">defaultManagerSettings</span><span class="token punctuation">,</span> <span class="token hvariable">managerModifyRequest</span><span class="token punctuation">)</span>
<span class="token import-statement"><span class="token keyword">import</span> Network<span class="token punctuation">.</span>HTTP<span class="token punctuation">.</span>Client<span class="token punctuation">.</span>TLS</span> <span class="token punctuation">(</span><span class="token hvariable">tlsManagerSettings</span><span class="token punctuation">)</span>

<span class="token comment">-- 设置 HTTP 代理</span>
<span class="token hvariable">setupProxy</span> <span class="token operator">::</span> <span class="token constant">IO</span> <span class="token constant">Manager</span>
<span class="token hvariable">setupProxy</span> <span class="token operator">=</span> <span class="token keyword">do</span>
  <span class="token hvariable">manager</span> <span class="token operator">&lt;-</span> <span class="token hvariable">newManager</span> <span class="token hvariable">tlsManagerSettings</span>
  <span class="token builtin">return</span> <span class="token operator">$</span> <span class="token hvariable">managerModifyRequest</span> <span class="token hvariable">manager</span> <span class="token operator">$</span> <span class="token operator">\</span><span class="token hvariable">req</span> <span class="token operator">-&gt;</span> <span class="token keyword">do</span>
    <span class="token keyword">let</span> <span class="token hvariable">proxy</span> <span class="token operator">=</span> <span class="token string">"http://localhost:8080"</span>  <span class="token comment">-- 代理地址</span>
    <span class="token hvariable">setRequestProxy</span> <span class="token hvariable">proxy</span> <span class="token hvariable">req</span>
</code></pre>
    <p>
     在上面的代码中，我们创建了一个
     <code>
      setupProxy
     </code>
     函数，它将设置代理服务器地址。你可以根据实际需要修改代理的 URL。
    </p>
    <p>
     <strong>
      4、发送 HTTP 请求并获取网页内容
     </strong>
    </p>
    <p>
     我们将通过
     <code>
      wreq
     </code>
     库发送 HTTP 请求，抓取网页内容，并使用
     <code>
      Lens
     </code>
     提取响应体中的内容。以下是一个抓取网页内容并打印响应的简单例子：
    </p>
    <pre><code class="prism language-haskell"><span class="token import-statement"><span class="token keyword">import</span> Network<span class="token punctuation">.</span>Wreq</span>
<span class="token import-statement"><span class="token keyword">import</span> Control<span class="token punctuation">.</span>Lens</span>
<span class="token import-statement"><span class="token keyword">import</span> Data<span class="token punctuation">.</span>ByteString<span class="token punctuation">.</span>Lazy<span class="token punctuation">.</span>Char8 <span class="token keyword">as</span> L8</span>

<span class="token comment">-- 使用代理发送 GET 请求并打印网页内容</span>
<span class="token hvariable">fetchPage</span> <span class="token operator">::</span> <span class="token constant">IO</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token hvariable">fetchPage</span> <span class="token operator">=</span> <span class="token keyword">do</span>
    <span class="token hvariable">manager</span> <span class="token operator">&lt;-</span> <span class="token hvariable">setupProxy</span>
    <span class="token keyword">let</span> <span class="token hvariable">opts</span> <span class="token operator">=</span> <span class="token hvariable">defaults</span> <span class="token operator">&amp;</span> <span class="token hvariable">manager</span> <span class="token operator">.~</span> <span class="token constant">Just</span> <span class="token hvariable">manager</span>
    <span class="token hvariable">response</span> <span class="token operator">&lt;-</span> <span class="token hvariable">getWith</span> <span class="token hvariable">opts</span> <span class="token string">"https://www.example.com"</span>  <span class="token comment">-- 目标网页</span>
    <span class="token constant">L8</span><span class="token punctuation">.</span><span class="token builtin">putStrLn</span> <span class="token punctuation">(</span><span class="token hvariable">response</span> <span class="token operator">^.</span> <span class="token hvariable">responseBody</span><span class="token punctuation">)</span>  <span class="token comment">-- 打印网页的响应体</span>
</code></pre>
    <p>
     在这个例子中，
     <code>
      getWith
     </code>
     函数通过代理发送 GET 请求，并获取目标网页的响应内容。
     <code>
      responseBody
     </code>
     是通过 Lens 提取响应体内容，我们将其打印到控制台。
    </p>
    <p>
     <strong>
      5、处理 JSON 响应
     </strong>
    </p>
    <p>
     如果你抓取的是 JSON 数据，可以使用
     <code>
      aeson
     </code>
     库来解析 JSON 响应。
     <code>
      wreq
     </code>
     与
     <code>
      aeson
     </code>
     库结合得很好，允许你直接将 JSON 响应转化为 Haskell 数据类型。
    </p>
    <p>
     假设我们从 API 获取 JSON 数据，并解析它：
    </p>
    <pre><code class="prism language-haskell"><span class="token import-statement"><span class="token keyword">import</span> Network<span class="token punctuation">.</span>Wreq</span>
<span class="token import-statement"><span class="token keyword">import</span> Control<span class="token punctuation">.</span>Lens</span>
<span class="token import-statement"><span class="token keyword">import</span> Data<span class="token punctuation">.</span>Aeson</span>
<span class="token import-statement"><span class="token keyword">import</span> Data<span class="token punctuation">.</span>Maybe</span> <span class="token punctuation">(</span><span class="token hvariable">fromJust</span><span class="token punctuation">)</span>

<span class="token comment">-- 假设我们有一个 JSON 响应，格式为：{"id": 1, "name": "example"}</span>
<span class="token keyword">data</span> <span class="token constant">Response</span> <span class="token operator">=</span> <span class="token constant">Response</span> <span class="token punctuation">{<!-- --></span>
    <span class="token builtin">id</span> <span class="token operator">::</span> <span class="token constant">Int</span><span class="token punctuation">,</span>
    <span class="token hvariable">name</span> <span class="token operator">::</span> <span class="token constant">String</span>
<span class="token punctuation">}</span> <span class="token keyword">deriving</span> <span class="token punctuation">(</span><span class="token constant">Show</span><span class="token punctuation">)</span>

<span class="token keyword">instance</span> <span class="token constant">FromJSON</span> <span class="token constant">Response</span> <span class="token keyword">where</span>
    <span class="token hvariable">parseJSON</span> <span class="token operator">=</span> <span class="token hvariable">withObject</span> <span class="token string">"Response"</span> <span class="token operator">$</span> <span class="token operator">\</span><span class="token hvariable">v</span> <span class="token operator">-&gt;</span> <span class="token constant">Response</span>
        <span class="token operator">&lt;$&gt;</span> <span class="token hvariable">v</span> <span class="token operator">.:</span> <span class="token string">"id"</span>
        <span class="token operator">&lt;*&gt;</span> <span class="token hvariable">v</span> <span class="token operator">.:</span> <span class="token string">"name"</span>

<span class="token comment">-- 使用代理发送 GET 请求并解析 JSON 响应</span>
<span class="token hvariable">fetchJson</span> <span class="token operator">::</span> <span class="token constant">IO</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token hvariable">fetchJson</span> <span class="token operator">=</span> <span class="token keyword">do</span>
    <span class="token hvariable">manager</span> <span class="token operator">&lt;-</span> <span class="token hvariable">setupProxy</span>
    <span class="token keyword">let</span> <span class="token hvariable">opts</span> <span class="token operator">=</span> <span class="token hvariable">defaults</span> <span class="token operator">&amp;</span> <span class="token hvariable">manager</span> <span class="token operator">.~</span> <span class="token constant">Just</span> <span class="token hvariable">manager</span>
    <span class="token hvariable">response</span> <span class="token operator">&lt;-</span> <span class="token hvariable">getWith</span> <span class="token hvariable">opts</span> <span class="token string">"https://jsonplaceholder.typicode.com/users/1"</span>
    
    <span class="token keyword">let</span> <span class="token hvariable">jsonResponse</span> <span class="token operator">=</span> <span class="token hvariable">response</span> <span class="token operator">^.</span> <span class="token hvariable">responseBody</span>
    <span class="token keyword">let</span> <span class="token hvariable">parsedData</span> <span class="token operator">=</span> <span class="token hvariable">decode</span> <span class="token hvariable">jsonResponse</span> <span class="token operator">::</span> <span class="token constant">Maybe</span> <span class="token constant">Response</span>
    <span class="token keyword">case</span> <span class="token hvariable">parsedData</span> <span class="token keyword">of</span>
        <span class="token constant">Just</span> <span class="token keyword">data</span>' <span class="token operator">-&gt;</span> <span class="token builtin">print</span> <span class="token keyword">data</span>'
        <span class="token constant">Nothing</span> <span class="token operator">-&gt;</span> <span class="token builtin">putStrLn</span> <span class="token string">"Failed to parse JSON"</span>
</code></pre>
    <p>
     在这个例子中，
     <code>
      Response
     </code>
     是我们定义的一个数据类型，用来表示 JSON 响应的数据结构。
     <code>
      FromJSON
     </code>
     实例使得我们能够从 JSON 数据中提取字段。
     <code>
      decode
     </code>
     函数将 JSON 响应解析为
     <code>
      Response
     </code>
     类型。
    </p>
    <p>
     <strong>
      6、完整示例：通过代理抓取网页并解析数据
     </strong>
    </p>
    <p>
     最后，以下是一个完整的示例，展示如何使用
     <code>
      wreq
     </code>
     配合代理抓取网页，并解析其 JSON 数据：
    </p>
    <pre><code class="prism language-haskell"><span class="token import-statement"><span class="token keyword">import</span> Network<span class="token punctuation">.</span>Wreq</span>
<span class="token import-statement"><span class="token keyword">import</span> Control<span class="token punctuation">.</span>Lens</span>
<span class="token import-statement"><span class="token keyword">import</span> Network<span class="token punctuation">.</span>HTTP<span class="token punctuation">.</span>Client</span> <span class="token punctuation">(</span><span class="token hvariable">newManager</span><span class="token punctuation">,</span> <span class="token hvariable">defaultManagerSettings</span><span class="token punctuation">,</span> <span class="token hvariable">managerModifyRequest</span><span class="token punctuation">)</span>
<span class="token import-statement"><span class="token keyword">import</span> Network<span class="token punctuation">.</span>HTTP<span class="token punctuation">.</span>Client<span class="token punctuation">.</span>TLS</span> <span class="token punctuation">(</span><span class="token hvariable">tlsManagerSettings</span><span class="token punctuation">)</span>
<span class="token import-statement"><span class="token keyword">import</span> Data<span class="token punctuation">.</span>Aeson</span>
<span class="token import-statement"><span class="token keyword">import</span> <span class="token keyword">qualified</span> Data<span class="token punctuation">.</span>ByteString<span class="token punctuation">.</span>Lazy<span class="token punctuation">.</span>Char8 <span class="token keyword">as</span> L8</span>
<span class="token import-statement"><span class="token keyword">import</span> Data<span class="token punctuation">.</span>Maybe</span> <span class="token punctuation">(</span><span class="token hvariable">fromJust</span><span class="token punctuation">)</span>

<span class="token comment">-- 设置代理</span>
<span class="token hvariable">setupProxy</span> <span class="token operator">::</span> <span class="token constant">IO</span> <span class="token constant">Manager</span>
<span class="token hvariable">setupProxy</span> <span class="token operator">=</span> <span class="token keyword">do</span>
    <span class="token hvariable">manager</span> <span class="token operator">&lt;-</span> <span class="token hvariable">newManager</span> <span class="token hvariable">tlsManagerSettings</span>
    <span class="token builtin">return</span> <span class="token operator">$</span> <span class="token hvariable">managerModifyRequest</span> <span class="token hvariable">manager</span> <span class="token operator">$</span> <span class="token operator">\</span><span class="token hvariable">req</span> <span class="token operator">-&gt;</span> <span class="token keyword">do</span>
        <span class="token keyword">let</span> <span class="token hvariable">proxy</span> <span class="token operator">=</span> <span class="token string">"http://localhost:8080"</span>  <span class="token comment">-- 设置代理地址</span>
        <span class="token hvariable">setRequestProxy</span> <span class="token hvariable">proxy</span> <span class="token hvariable">req</span>

<span class="token comment">-- 数据类型用于解析 JSON</span>
<span class="token keyword">data</span> <span class="token constant">Response</span> <span class="token operator">=</span> <span class="token constant">Response</span> <span class="token punctuation">{<!-- --></span>
    <span class="token builtin">id</span> <span class="token operator">::</span> <span class="token constant">Int</span><span class="token punctuation">,</span>
    <span class="token hvariable">name</span> <span class="token operator">::</span> <span class="token constant">String</span>
<span class="token punctuation">}</span> <span class="token keyword">deriving</span> <span class="token punctuation">(</span><span class="token constant">Show</span><span class="token punctuation">)</span>

<span class="token keyword">instance</span> <span class="token constant">FromJSON</span> <span class="token constant">Response</span> <span class="token keyword">where</span>
    <span class="token hvariable">parseJSON</span> <span class="token operator">=</span> <span class="token hvariable">withObject</span> <span class="token string">"Response"</span> <span class="token operator">$</span> <span class="token operator">\</span><span class="token hvariable">v</span> <span class="token operator">-&gt;</span> <span class="token constant">Response</span>
        <span class="token operator">&lt;$&gt;</span> <span class="token hvariable">v</span> <span class="token operator">.:</span> <span class="token string">"id"</span>
        <span class="token operator">&lt;*&gt;</span> <span class="token hvariable">v</span> <span class="token operator">.:</span> <span class="token string">"name"</span>

<span class="token comment">-- 使用代理发送 GET 请求并解析 JSON</span>
<span class="token hvariable">fetchJson</span> <span class="token operator">::</span> <span class="token constant">IO</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token hvariable">fetchJson</span> <span class="token operator">=</span> <span class="token keyword">do</span>
    <span class="token hvariable">manager</span> <span class="token operator">&lt;-</span> <span class="token hvariable">setupProxy</span>
    <span class="token keyword">let</span> <span class="token hvariable">opts</span> <span class="token operator">=</span> <span class="token hvariable">defaults</span> <span class="token operator">&amp;</span> <span class="token hvariable">manager</span> <span class="token operator">.~</span> <span class="token constant">Just</span> <span class="token hvariable">manager</span>
    <span class="token hvariable">response</span> <span class="token operator">&lt;-</span> <span class="token hvariable">getWith</span> <span class="token hvariable">opts</span> <span class="token string">"https://jsonplaceholder.typicode.com/users/1"</span>
    
    <span class="token comment">-- 解析 JSON 响应</span>
    <span class="token keyword">let</span> <span class="token hvariable">jsonResponse</span> <span class="token operator">=</span> <span class="token hvariable">response</span> <span class="token operator">^.</span> <span class="token hvariable">responseBody</span>
    <span class="token keyword">let</span> <span class="token hvariable">parsedData</span> <span class="token operator">=</span> <span class="token hvariable">decode</span> <span class="token hvariable">jsonResponse</span> <span class="token operator">::</span> <span class="token constant">Maybe</span> <span class="token constant">Response</span>
    <span class="token keyword">case</span> <span class="token hvariable">parsedData</span> <span class="token keyword">of</span>
        <span class="token constant">Just</span> <span class="token keyword">data</span>' <span class="token operator">-&gt;</span> <span class="token builtin">print</span> <span class="token keyword">data</span>'
        <span class="token constant">Nothing</span> <span class="token operator">-&gt;</span> <span class="token builtin">putStrLn</span> <span class="token string">"Failed to parse JSON"</span>

<span class="token hvariable">main</span> <span class="token operator">::</span> <span class="token constant">IO</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token hvariable">main</span> <span class="token operator">=</span> <span class="token hvariable">fetchJson</span>
</code></pre>
    <p>
     <strong>
      7、总结
     </strong>
    </p>
    <p>
     在这个 Haskell 示例中，我们展示了如何使用
     <code>
      wreq
     </code>
     库配合 HTTP 代理进行网络请求，并抓取网页内容或 API 返回的 JSON 数据。主要步骤包括：
    </p>
    <ol>
     <li>
      配置 HTTP 代理。
     </li>
     <li>
      使用
      <code>
       wreq
      </code>
      发送 HTTP 请求。
     </li>
     <li>
      使用
      <code>
       Lens
      </code>
      提取响应体内容。
     </li>
     <li>
      使用
      <code>
       Aeson
      </code>
      库解析 JSON 数据。
     </li>
    </ol>
    <p>
     我们可以根据需要扩展这个爬虫程序，添加更多的请求头、POST 请求支持、错误处理等。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f34343631373635312f:61727469636c652f64657461696c732f313436313438373035" class_="artid" style="display:none">
 </p>
</div>


