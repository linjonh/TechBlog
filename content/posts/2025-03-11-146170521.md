---
layout: post
title: "带有LBS_OWNERDRAWFIXED-样式的列表框,系统在什么时候向窗口发送WM_DRAWITEM-和WM_MEASUREITEM消息de呢"
date: 2025-03-11 09:43:26 +0800
description: "每次列表项需要显示时（如窗口滚动、刷新），系统都会发送。"
keywords: "带有LBS_OWNERDRAWFIXED 样式的列表框，系统在什么时候向窗口发送WM_DRAWITEM 和WM_MEASUREITEM消息de呢？"
categories: ['从入门到精通', 'Visual', 'C', '2017']
tags: ['Windows', 'Mfc']
artid: "146170521"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146170521
    alt: "带有LBS_OWNERDRAWFIXED-样式的列表框,系统在什么时候向窗口发送WM_DRAWITEM-和WM_MEASUREITEM消息de呢"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146170521
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146170521
cover: https://bing.ee123.net/img/rand?artid=146170521
image: https://bing.ee123.net/img/rand?artid=146170521
img: https://bing.ee123.net/img/rand?artid=146170521
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     带有LBS_OWNERDRAWFIXED 样式的列表框，系统在什么时候向窗口发送WM_DRAWITEM 和WM_MEASUREITEM消息de呢？
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <p>
     说明：以下内容主要来自腾讯元宝。
    </p>
    <p>
     以下是 ​
     <strong>
      带有
      <code>
       LBS_OWNERDRAWFIXED
      </code>
      样式的列表框
     </strong>
     触发
     <code>
      WM_MEASUREITEM
     </code>
     和
     <code>
      WM_DRAWITEM
     </code>
     消息的具体时机和场景：
    </p>
    <hr/>
    <h4>
     ​
     <strong>
      1. WM_MEASUREITEM 消息的触发时机
     </strong>
    </h4>
    <p>
     <code>
      WM_MEASUREITEM
     </code>
     在以下情况下被系统发送：
    </p>
    <h5>
     ​**(1) 列表框首次创建时**
    </h5>
    <ul>
     <li>
      当窗口过程通过
      <span style="color:#fe2c24">
       <code>
        CreateWindow
       </code>
       创建列表框
      </span>
      后，系统会立即发送
      <code>
       WM_MEASUREITEM
      </code>
      消息，以确定列表项的尺寸（尤其是高度）。
     </li>
    </ul>
    <h5>
     ​**(2) 列表框窗口大小调整时**
    </h5>
    <ul>
     <li>
      如果
      <span style="color:#fe2c24">
       列表框的父窗口大小发生变化
      </span>
      ，导致列表框的布局需要重新计算，系统可能触发
      <code>
       WM_MEASUREITEM
      </code>
      。
     </li>
    </ul>
    <h5>
     ​**(3) 列表框样式动态修改时**
    </h5>
    <ul>
     <li>
      如果运行时
      <span style="color:#fe2c24">
       修改了列表框的样式
      </span>
      （如添加
      <code>
       LBS_OWNERDRAWFIXED
      </code>
      ），系统可能发送
      <code>
       WM_MEASUREITEM
      </code>
      。
     </li>
    </ul>
    <h5>
     ​**(4) 通过代码显式触发**
    </h5>
    <ul>
     <li>
      调用
      <span style="color:#fe2c24">
       <code>
        InvalidateRect
       </code>
       或
       <code>
        UpdateWindow
       </code>
      </span>
      强制重绘列表框窗口时，可能间接触发
      <code>
       WM_MEASUREITEM
      </code>
      。
     </li>
    </ul>
    <hr/>
    <h4>
     ​
     <strong>
      2. WM_DRAWITEM 消息的触发时机
     </strong>
    </h4>
    <p>
     <code>
      WM_DRAWITEM
     </code>
     在以下情况下被系统发送：
    </p>
    <h5>
     ​**(1) 列表框首次显示时**
    </h5>
    <ul>
     <li>
      当窗口过程调用
      <span style="color:#fe2c24">
       <code>
        ShowWindow
       </code>
       或
       <code>
        UpdateWindow
       </code>
       显示列表框
      </span>
      时，系统会触发
      <code>
       WM_PAINT
      </code>
      消息，进而引发
      <code>
       WM_DRAWITEM
      </code>
      ，以绘制所有列表项。
     </li>
    </ul>
    <h5>
     ​**(2) 列表项内容发生变化时**
    </h5>
    <ul>
     <li>
      ​
      <strong>
       添加/删除项
      </strong>
      ：调用
      <span style="color:#fe2c24">
       <code>
        LB_ADDSTRING
       </code>
       、
       <code>
        LB_DELETESTRING
       </code>
       等函数
      </span>
      后，若列表框需要刷新显示，系统会发送
      <code>
       WM_DRAWITEM
      </code>
      。
     </li>
     <li>
      ​
      <strong>
       示例代码
      </strong>
      ：
      <pre><code class="language-cpp">SendMessage(hListBox, LB_ADDSTRING, 0, (LPARAM)_T("中国")); // 添加项
InvalidateRect(hWnd, NULL, FALSE); // 强制重绘，触发 WM_PAINT → WM_DRAWITEM</code></pre>
     </li>
    </ul>
    <h5>
     ​**(3) 用户交互触发**
    </h5>
    <ul>
     <li>
      ​
      <strong>
       滚动列表框
      </strong>
      ：
      <span style="color:#fe2c24">
       滚动时
      </span>
      系统会动态发送
      <code>
       WM_DRAWITEM
      </code>
      ，仅绘制当前可见区域的项。
     </li>
     <li>
      ​
      <strong>
       窗口激活/最小化恢复
      </strong>
      ：窗口状态变化时触发重绘。
     </li>
    </ul>
    <h5>
     ​**(4) 程序主动触发**
    </h5>
    <ul>
     <li>
      通过
      <code>
       SendMessage
      </code>
      发送
      <span style="color:#fe2c24">
       <code>
        LB_RESETCONTENT
       </code>
       清空列表框后重新填充数据
      </span>
      ，强制触发重绘。
     </li>
    </ul>
    <hr/>
    <h4>
     ​
     <strong>
      3. LBS_OWNERDRAWFIXED 样式的特殊行为
     </strong>
    </h4>
    <ul>
     <li>
      <p>
       ​
       <strong>
        固定高度
       </strong>
       ：
       <br/>
       <code>
        LBS_OWNERDRAWFIXED
       </code>
       样式要求所有列表项的高度统一。系统在首次创建列表框时会发送一次
       <code>
        WM_MEASUREITEM
       </code>
       ，开发者需在此消息中设置固定高度（如
       <code>
        lpmis-&gt;itemHeight = 30
       </code>
       ）。后续即使项的内容变化，也不会重复发送
       <code>
        WM_MEASUREITEM
       </code>
       （除非列表框窗口被销毁并重新创建）。
      </p>
     </li>
     <li>
      <p>
       ​
       <strong>
        自定义绘制
       </strong>
       ：
       <br/>
       每次列表项需要显示时（如窗口滚动、刷新），系统都会发送
       <code>
        WM_DRAWITEM
       </code>
       ，开发者需在此消息中完成背景和文本的自定义绘制。
      </p>
     </li>
    </ul>
    <hr/>
    <h4>
     ​
     <strong>
      4. 消息触发流程示例
     </strong>
    </h4>
    <h5>
     ​
     <strong>
      步骤 1：创建列表框（启用
      <code>
       LBS_OWNERDRAWFIXED
      </code>
      ）​
     </strong>
    </h5>
    <pre><code class="language-cpp">hListBox = CreateWindow(
    _T("ListBox"), NULL,
    WS_CHILD | WS_VISIBLE | WS_VSCROLL | LBS_OWNERDRAWFIXED | LBS_HASSTRINGS,
    20, 20, 60, 120,
    hWnd, (HMENU)ID_MYLIST,
    hInst, NULL);</code></pre>
    <h5>
     ​
     <strong>
      步骤 2：触发 WM_MEASUREITEM（首次创建时自动触发）​
     </strong>
    </h5>
    <ul>
     <li>
      系统发送
      <code>
       WM_MEASUREITEM
      </code>
      ，窗口过程设置项高度为 30 像素。
     </li>
    </ul>
    <h5>
     ​
     <strong>
      步骤 3：触发 WM_DRAWITEM（首次显示时自动触发）​
     </strong>
    </h5>
    <ul>
     <li>
      系统发送
      <code>
       WM_PAINT
      </code>
      ，窗口过程调用
      <code>
       DefWindowProc
      </code>
      ，进而触发
      <code>
       WM_DRAWITEM
      </code>
      ，绘制所有列表项。
     </li>
    </ul>
    <h5>
     ​
     <strong>
      步骤 4：动态添加项并触发 WM_DRAWITEM
     </strong>
    </h5>
    <pre><code class="language-cpp">SendMessage(hListBox, LB_ADDSTRING, 0, (LPARAM)_T("英国"));
InvalidateRect(hWnd, NULL, FALSE); // 触发重绘</code></pre>
    <hr/>
    <h4>
     ​
     <strong>
      5. 对比 LBS_STANDARD 和 LBS_OWNERDRAWFIXED
     </strong>
    </h4>
    <table>
     <thead>
      <tr>
       <th>
        ​
        <strong>
         样式
        </strong>
       </th>
       <th>
        ​
        <strong>
         WM_MEASUREITEM
        </strong>
        触发条件
       </th>
       <th>
        ​
        <strong>
         WM_DRAWITEM
        </strong>
        触发条件
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        ​
        <strong>
         LBS_STANDARD
        </strong>
       </td>
       <td>
        从不触发（系统自动管理项尺寸）
       </td>
       <td>
        从不触发（系统自动绘制项内容）
       </td>
      </tr>
      <tr>
       <td>
        ​
        <strong>
         LBS_OWNERDRAWFIXED
        </strong>
       </td>
       <td>
        创建时、窗口大小调整时、样式修改时
       </td>
       <td>
        显示时、项变化时、滚动时、程序触发重绘时
       </td>
      </tr>
     </tbody>
    </table>
    <hr/>
    <h4>
     ​
     <strong>
      6. 注意事项
     </strong>
    </h4>
    <ol>
     <li>
      <p>
       ​
       <strong>
        必须处理 WM_MEASUREITEM
       </strong>
       ：
       <br/>
       <span style="color:#fe2c24">
        若未处理此消息，列表项的高度可能为默认值（基于字体大小），导致布局错乱。
       </span>
      </p>
     </li>
     <li>
      <p>
       ​
       <strong>
        必须处理 WM_DRAWITEM
       </strong>
       ：
       <br/>
       若未处理此消息，列表项将无法显示内容，甚至导致窗口崩溃。
      </p>
     </li>
     <li>
      <p>
       ​
       <strong>
        性能优化
       </strong>
       ：
      </p>
      <ul>
       <li>
        在
        <code>
         WM_DRAWITEM
        </code>
        中避免重复创建 GDI 对象（如刷子），可缓存常用资源。
       </li>
       <li>
        仅在必要时调用
        <code>
         InvalidateRect
        </code>
        ，避免频繁重绘。
       </li>
      </ul>
     </li>
    </ol>
    <hr/>
    <h4>
     ​
     <strong>
      总结
     </strong>
    </h4>
    <ul>
     <li>
      ​
      <strong>
       WM_MEASUREITEM
      </strong>
      ：用于初始化或调整列表项的高度（仅在
      <code>
       LBS_OWNERDRAWFIXED
      </code>
      或
      <code>
       LBS_OWNERDRAWVARIABLE
      </code>
      样式下触发）。
     </li>
     <li>
      ​
      <strong>
       WM_DRAWITEM
      </strong>
      ：用于自定义绘制列表项的内容（每次项需要显示时触发）。
     </li>
     <li>
      ​
      <strong>
       LBS_OWNERDRAWFIXED
      </strong>
      的列表框需通过这两个消息实现完全的自定义控制。
     </li>
    </ul>
   </div>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f32303732353232312f:61727469636c652f64657461696c732f313436313730353231" class_="artid" style="display:none">
 </p>
</div>


