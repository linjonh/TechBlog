---
layout: post
title: "Elasticsearch-提升查询精度"
date: 2025-03-10 16:30:23 +0800
description: "在Elasticsearch中，查询精度（即查准率，Precision）是衡量搜索结果相关性的重要指标。如果查询结果包含许多无关文档，用户体验会大打折扣。"
keywords: "Elasticsearch 提升查询精度"
categories: ['未分类']
tags: ['大数据', 'Jenkins', 'Elasticsearch']
artid: "146157458"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146157458
    alt: "Elasticsearch-提升查询精度"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146157458
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146157458
cover: https://bing.ee123.net/img/rand?artid=146157458
image: https://bing.ee123.net/img/rand?artid=146157458
img: https://bing.ee123.net/img/rand?artid=146157458
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Elasticsearch 提升查询精度
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="./../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="./../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     在Elasticsearch中，查询精度（即查准率，Precision）是衡量搜索结果相关性的重要指标。如果查询结果包含许多无关文档，用户体验会大打折扣。以下是提升查询精度的几种方法：
    </p>
    <h2>
     <a id="1__1">
     </a>
     1.
     <strong>
      优化查询方式
     </strong>
    </h2>
    <ul>
     <li>
      <strong>
       使用
       <code>
        match_phrase
       </code>
       代替
       <code>
        match
       </code>
      </strong>
      <br/>
      <code>
       match_phrase
      </code>
      查询会严格匹配短语，而
      <code>
       match
      </code>
      可能会拆分词语后进行匹配。例如：
      <pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"match_phrase"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"content"</span><span class="token operator">:</span> <span class="token string">"machine learning"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
      这样可以确保搜索的短语是完整的，而不是仅匹配单个单词。
     </li>
     <li>
      <strong>
       使用
       <code>
        term
       </code>
       查询
      </strong>
      <br/>
      <code>
       term
      </code>
      查询适用于精确匹配（如ID、状态字段等），避免分词带来的误差。例如：
      <pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"term"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"status"</span><span class="token operator">:</span> <span class="token string">"active"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
      适用于结构化数据字段，而非全文搜索。
     </li>
     <li>
      <strong>
       使用
       <code>
        bool
       </code>
       组合查询
      </strong>
      <br/>
      通过
      <code>
       must
      </code>
      和
      <code>
       should
      </code>
      组合提高精度。例如：
      <pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"bool"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"must"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"match"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"title"</span><span class="token operator">:</span> <span class="token string">"Elasticsearch"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token string-property property">"should"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"match"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"description"</span><span class="token operator">:</span> <span class="token string">"search engine"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token string-property property">"minimum_should_match"</span><span class="token operator">:</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
      这样可以确保匹配
      <code>
       title
      </code>
      ，但如果
      <code>
       description
      </code>
      也匹配，则得分更高。
     </li>
    </ul>
    <h2>
     <a id="2__44">
     </a>
     2.
     <strong>
      优化分词和分析器
     </strong>
    </h2>
    <ul>
     <li>
      <p>
       <strong>
        选择合适的分词器
       </strong>
      </p>
      <ul>
       <li>
        使用
        <code>
         standard
        </code>
        分词器适用于常规搜索
       </li>
       <li>
        使用
        <code>
         ik_smart
        </code>
        或
        <code>
         ik_max_word
        </code>
        提高中文搜索效果
       </li>
       <li>
        使用
        <code>
         ngram
        </code>
        提高部分匹配能力（但可能降低精度）
       </li>
      </ul>
      <p>
       可以创建自定义分词索引：
      </p>
      <pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"settings"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"analysis"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"analyzer"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"my_analyzer"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"custom"</span><span class="token punctuation">,</span>
          <span class="token string-property property">"tokenizer"</span><span class="token operator">:</span> <span class="token string">"ik_max_word"</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"content"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"my_analyzer"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
     </li>
     <li>
      <p>
       <strong>
        使用
        <code>
         keyword
        </code>
        类型字段
       </strong>
       <br/>
       对于需要精确匹配的字段，可以使用
       <code>
        keyword
       </code>
       类型，而不是
       <code>
        text
       </code>
       ，例如：
      </p>
      <pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"category"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
      <p>
       这样
       <code>
        category
       </code>
       字段不会被分词，查询时更加精确。
      </p>
     </li>
    </ul>
    <h2>
     <a id="3__87">
     </a>
     3.
     <strong>
      调整查询参数
     </strong>
    </h2>
    <ul>
     <li>
      <p>
       <strong>
        提高
        <code>
         minimum_should_match
        </code>
       </strong>
       <br/>
       可以增加匹配度的最低要求，例如：
      </p>
      <pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"match"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"content"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token string">"deep learning"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"minimum_should_match"</span><span class="token operator">:</span> <span class="token string">"75%"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
      <p>
       这样会要求查询的词语至少匹配 75%，减少噪声数据。
      </p>
     </li>
     <li>
      <p>
       <strong>
        降低
        <code>
         fuzziness
        </code>
        （模糊匹配程度）
       </strong>
       <br/>
       如果使用了
       <code>
        fuzziness: "AUTO"
       </code>
       ，Elasticsearch 会自动允许一定的拼写错误，这可能降低精度。可以手动调整：
      </p>
      <pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"match"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"content"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token string">"machine learning"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"fuzziness"</span><span class="token operator">:</span> <span class="token string">"1"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
      <p>
       设置
       <code>
        fuzziness: 0
       </code>
       可以完全禁用模糊匹配，提高精度。
      </p>
     </li>
    </ul>
    <h2>
     <a id="4__boost__119">
     </a>
     4.
     <strong>
      利用
      <code>
       boost
      </code>
      调整权重
     </strong>
    </h2>
    <ul>
     <li>
      <strong>
       提高重要字段的权重
      </strong>
      <br/>
      可以使用
      <code>
       boost
      </code>
      来提高某些字段的权重，例如：
      <pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"multi_match"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token string">"Elasticsearch query"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"fields"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"title^3"</span><span class="token punctuation">,</span> <span class="token string">"description^1"</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
      这里
      <code>
       title
      </code>
      字段的权重是
      <code>
       3
      </code>
      ，
      <code>
       description
      </code>
      只有
      <code>
       1
      </code>
      ，这样
      <code>
       title
      </code>
      的匹配更重要。
     </li>
    </ul>
    <h2>
     <a id="5__slop__133">
     </a>
     5.
     <strong>
      使用
      <code>
       slop
      </code>
      允许短语匹配的灵活性
     </strong>
    </h2>
    <ul>
     <li>
      <strong>
       适用于
       <code>
        match_phrase
       </code>
       查询
      </strong>
      <br/>
      如果短语顺序稍有不同，可以使用
      <code>
       slop
      </code>
      让它们仍然匹配：
      <pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"match_phrase"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"content"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token string">"big data processing"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"slop"</span><span class="token operator">:</span> <span class="token number">2</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
      这样
      <code>
       "data big processing"
      </code>
      仍然能匹配，提高搜索体验。
     </li>
    </ul>
    <h2>
     <a id="6__149">
     </a>
     6.
     <strong>
      减少不相关文档的影响
     </strong>
    </h2>
    <ul>
     <li>
      <p>
       <strong>
        使用
        <code>
         post_filter
        </code>
        进行精确过滤
       </strong>
       <br/>
       可以在查询后再进行精确过滤，而不会影响
       <code>
        score
       </code>
       计算：
      </p>
      <pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"match"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"content"</span><span class="token operator">:</span> <span class="token string">"Elasticsearch"</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"post_filter"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"term"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"status"</span><span class="token operator">:</span> <span class="token string">"published"</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
      <p>
       这样
       <code>
        status=published
       </code>
       只是一个过滤条件，不会影响排序。
      </p>
     </li>
     <li>
      <p>
       <strong>
        避免
        <code>
         wildcard
        </code>
        和
        <code>
         regexp
        </code>
        查询
       </strong>
       <br/>
       这些查询可能导致太多无关匹配，例如：
      </p>
      <pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"wildcard"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"content"</span><span class="token operator">:</span> <span class="token string">"*search*"</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
      <p>
       这种查询范围过大，建议使用
       <code>
        ngram
       </code>
       或
       <code>
        edge_ngram
       </code>
       替代。
      </p>
     </li>
    </ul>
    <h2>
     <a id="7__174">
     </a>
     7.
     <strong>
      优化索引结构
     </strong>
    </h2>
    <ul>
     <li>
      <strong>
       避免
       <code>
        all
       </code>
       字段匹配
      </strong>
      （已被弃用）
      <br/>
      以前
      <code>
       _all
      </code>
      字段会合并所有字段进行匹配，导致查询结果不够精准。现在建议使用
      <code>
       copy_to
      </code>
      ：
      <pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"title"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"copy_to"</span><span class="token operator">:</span> <span class="token string">"combined_text"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">"description"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"copy_to"</span><span class="token operator">:</span> <span class="token string">"combined_text"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">"combined_text"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
      这样可以在
      <code>
       combined_text
      </code>
      字段上搜索，提高相关性控制。
     </li>
    </ul>
    <h2>
     <a id="_197">
     </a>
     <strong>
      总结
     </strong>
    </h2>
    <table>
     <thead>
      <tr>
       <th>
        方法
       </th>
       <th>
        说明
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        <code>
         match_phrase
        </code>
       </td>
       <td>
        短语匹配，避免拆分单词
       </td>
      </tr>
      <tr>
       <td>
        <code>
         term
        </code>
       </td>
       <td>
        精确匹配字段（如ID、状态）
       </td>
      </tr>
      <tr>
       <td>
        <code>
         bool
        </code>
        查询
       </td>
       <td>
        组合
        <code>
         must
        </code>
        和
        <code>
         should
        </code>
        提高匹配
       </td>
      </tr>
      <tr>
       <td>
        分词优化
       </td>
       <td>
        选择合适分词器，如
        <code>
         ik_max_word
        </code>
       </td>
      </tr>
      <tr>
       <td>
        <code>
         keyword
        </code>
        类型
       </td>
       <td>
        避免不必要的分词
       </td>
      </tr>
      <tr>
       <td>
        <code>
         minimum_should_match
        </code>
       </td>
       <td>
        控制最少匹配词数
       </td>
      </tr>
      <tr>
       <td>
        降低
        <code>
         fuzziness
        </code>
       </td>
       <td>
        限制拼写错误匹配
       </td>
      </tr>
      <tr>
       <td>
        <code>
         boost
        </code>
       </td>
       <td>
        提高重要字段的权重
       </td>
      </tr>
      <tr>
       <td>
        <code>
         slop
        </code>
       </td>
       <td>
        允许短语匹配灵活性
       </td>
      </tr>
      <tr>
       <td>
        <code>
         post_filter
        </code>
       </td>
       <td>
        先查询，再过滤无关文档
       </td>
      </tr>
     </tbody>
    </table>
    <p>
     这些方法可以帮助你提高 Elasticsearch 的查询精度，使返回的结果更符合用户的预期。
    </p>
   </div>
   <link href="./../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="./../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f34313839333530352f:61727469636c652f64657461696c732f313436313537343538" class_="artid" style="display:none">
 </p>
</div>


