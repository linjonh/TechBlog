---
layout: post
title: "从连接到交互SDN-架构下-OpenFlow-协议的流程与报文剖析"
date: 2025-03-07 21:21:09 +0800
description: "在SDN架构中，交换机与控制器之间的通信基于 OpenFlow协议，其设计目的是实现控制平面与数据平面的解耦。"
keywords: "openflow指向端口6653"
categories: ['网络技术进阶通途']
tags: ['Sdn', 'Openflow']
artid: "145750287"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=145750287
    alt: "从连接到交互SDN-架构下-OpenFlow-协议的流程与报文剖析"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=145750287
featuredImagePreview: https://bing.ee123.net/img/rand?artid=145750287
cover: https://bing.ee123.net/img/rand?artid=145750287
image: https://bing.ee123.net/img/rand?artid=145750287
img: https://bing.ee123.net/img/rand?artid=145750287
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     从连接到交互：SDN 架构下 OpenFlow 协议的流程与报文剖析
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/ebb61e4f7dbf42f3ada79aaa76ddb120.png"/>
    </p>
    <p>
     在SDN架构中，交换机与控制器之间的通信基于
     <strong>
      OpenFlow协议
     </strong>
     ，其设计目的是实现控制平面与数据平面的解耦。以下是
     <strong>
      交换机连接控制器
     </strong>
     和
     <strong>
      数据包进入交换机触发交互
     </strong>
     的详细流程及协议报文分析：
    </p>
    <hr/>
    <h4>
     <a id="_7">
     </a>
     <strong>
      一、交换机连接控制器的流程（初始化阶段）
     </strong>
    </h4>
    <h5>
     <a id="1_TCPTLS__8">
     </a>
     <strong>
      1. TCP/TLS 连接建立
     </strong>
    </h5>
    <ul>
     <li>
      <strong>
       协议
      </strong>
      ：OpenFlow默认使用
      <strong>
       TCP端口6653
      </strong>
      （或6633），支持TLS加密（可选）。
     </li>
     <li>
      <strong>
       步骤
      </strong>
      ：
      <ol>
       <li>
        交换机主动向控制器IP地址发起TCP连接。
       </li>
       <li>
        若启用TLS，双方进行证书交换和加密协商。
       </li>
      </ol>
     </li>
    </ul>
    <h5>
     <a id="2_OpenFlow__14">
     </a>
     <strong>
      2. OpenFlow 握手（版本协商）
     </strong>
    </h5>
    <ul>
     <li>
      <strong>
       关键报文
      </strong>
      ：
      <ul>
       <li>
        <strong>
         <code>
          OFPT_HELLO
         </code>
        </strong>
        （消息类型0）：
        <ul>
         <li>
          <strong>
           作用
          </strong>
          ：交换支持的OpenFlow版本。
         </li>
         <li>
          <strong>
           流程
          </strong>
          ：
          <ol>
           <li>
            交换机发送
            <code>
             OFPT_HELLO
            </code>
            ，携带支持的版本（如1.0, 1.3）。
           </li>
           <li>
            控制器回复
            <code>
             OFPT_HELLO
            </code>
            ，选择双方共有的最高版本（如1.3）。
           </li>
           <li>
            若版本不匹配，控制器发送
            <code>
             OFPT_ERROR
            </code>
            并断开连接。
           </li>
          </ol>
         </li>
        </ul>
       </li>
      </ul>
     </li>
    </ul>
    <h5>
     <a id="3__23">
     </a>
     <strong>
      3. 交换机能力交换
     </strong>
    </h5>
    <ul>
     <li>
      <strong>
       关键报文
      </strong>
      ：
      <ul>
       <li>
        <strong>
         <code>
          OFPT_FEATURES_REQUEST
         </code>
        </strong>
        （类型5）：
        <ul>
         <li>
          <strong>
           作用
          </strong>
          ：控制器主动请求交换机的硬件能力。
         </li>
        </ul>
       </li>
       <li>
        <strong>
         <code>
          OFPT_FEATURES_REPLY
         </code>
        </strong>
        （类型6）：
        <ul>
         <li>
          <strong>
           内容
          </strong>
          ：
          <ul>
           <li>
            <code>
             datapath_id
            </code>
            （交换机唯一标识）
           </li>
           <li>
            支持的流表数量、端口列表（端口号、MAC地址等）。
           </li>
           <li>
            支持的OpenFlow动作（如
            <code>
             OUTPUT
            </code>
            ,
            <code>
             SET_FIELD
            </code>
            ）。
           </li>
          </ul>
         </li>
        </ul>
       </li>
      </ul>
     </li>
    </ul>
    <h5>
     <a id="4__33">
     </a>
     <strong>
      4. 控制器配置交换机
     </strong>
    </h5>
    <ul>
     <li>
      <strong>
       关键报文
      </strong>
      ：
      <ul>
       <li>
        <strong>
         <code>
          OFPT_SET_CONFIG
         </code>
        </strong>
        （类型9）：
        <ul>
         <li>
          <strong>
           作用
          </strong>
          ：控制器下发基础配置参数。
         </li>
         <li>
          <strong>
           配置项
          </strong>
          ：
          <ul>
           <li>
            <code>
             flags
            </code>
            ：是否发送非缓存Packet-In（
            <code>
             OFPCML_NO_BUFFER
            </code>
            ）。
           </li>
           <li>
            <code>
             miss_send_len
            </code>
            ：Packet-In消息中截取的数据包长度。
           </li>
          </ul>
         </li>
        </ul>
       </li>
      </ul>
     </li>
    </ul>
    <h5>
     <a id="_41">
     </a>
     <strong>
      初始化完成标志
     </strong>
    </h5>
    <ul>
     <li>
      控制器通过下发
      <strong>
       默认流表
      </strong>
      （如
      <code>
       table-miss
      </code>
      流表项）完成初始化，将未知流量导向控制器。
     </li>
    </ul>
    <hr/>
    <h4>
     <a id="_46">
     </a>
     <strong>
      二、数据包进入交换机的流程（运行时阶段）
     </strong>
    </h4>
    <p>
     当交换机收到数据包且无匹配流表项时，触发以下交互：
    </p>
    <h5>
     <a id="1__OFPT_PACKET_IN10_49">
     </a>
     <strong>
      1. 交换机发送
      <code>
       OFPT_PACKET_IN
      </code>
      （类型10）
     </strong>
    </h5>
    <ul>
     <li>
      <strong>
       报文结构
      </strong>
      ：
      <pre><code class="prism language-plaintext">| Header (OFPT_PACKET_IN) | buffer_id | total_len | reason | table_id | cookie | match字段 | 数据包内容（截断部分） |
</code></pre>
      <ul>
       <li>
        <strong>
         关键字段
        </strong>
        ：
        <ul>
         <li>
          <code>
           buffer_id
          </code>
          ：交换机缓存的数据包ID（避免重复传输完整数据）。
         </li>
         <li>
          <code>
           reason
          </code>
          ：触发原因（如
          <code>
           OFPR_NO_MATCH
          </code>
          表示无流表匹配）。
         </li>
         <li>
          <code>
           match
          </code>
          ：入端口（
          <code>
           in_port
          </code>
          ）、数据包元数据（如MAC地址）。
         </li>
        </ul>
       </li>
      </ul>
     </li>
    </ul>
    <h5>
     <a id="2__PacketIn__59">
     </a>
     <strong>
      2. 控制器处理
      <code>
       Packet-In
      </code>
      事件
     </strong>
    </h5>
    <ul>
     <li>
      <strong>
       逻辑步骤
      </strong>
      ：
      <ol>
       <li>
        <strong>
         解析数据包
        </strong>
        ：提取源/目的MAC、IP等信息。
       </li>
       <li>
        <strong>
         决策转发路径
        </strong>
        ：基于网络策略（如MAC学习、ACL规则）。
       </li>
       <li>
        <strong>
         下发流表项
        </strong>
        ：通过
        <code>
         OFPT_FLOW_MOD
        </code>
        （类型14）动态添加流表。
       </li>
       <li>
        <strong>
         转发数据包
        </strong>
        ：通过
        <code>
         OFPT_PACKET_OUT
        </code>
        （类型13）立即转发缓存的数据包。
       </li>
      </ol>
     </li>
    </ul>
    <h5>
     <a id="3_OFPT_FLOW_MOD_66">
     </a>
     <strong>
      3. 控制器下发流表（
      <code>
       OFPT_FLOW_MOD
      </code>
      ）
     </strong>
    </h5>
    <ul>
     <li>
      <strong>
       报文结构
      </strong>
      ：
      <pre><code class="prism language-plaintext">| Header | cookie | command（ADD/MODIFY） | idle_timeout | priority | match字段 | instructions |
</code></pre>
      <ul>
       <li>
        <strong>
         关键指令
        </strong>
        ：
        <ul>
         <li>
          <code>
           OFPIT_APPLY_ACTIONS
          </code>
          ：立即执行动作（如
          <code>
           OUTPUT:port
          </code>
          ）。
         </li>
         <li>
          <code>
           OFPIT_WRITE_ACTIONS
          </code>
          ：写入动作到动作集（用于多级流表）。
         </li>
        </ul>
       </li>
      </ul>
     </li>
    </ul>
    <h5>
     <a id="4_OFPT_PACKET_OUT_75">
     </a>
     <strong>
      4. 交换机执行转发（
      <code>
       OFPT_PACKET_OUT
      </code>
      ）
     </strong>
    </h5>
    <ul>
     <li>
      <strong>
       报文结构
      </strong>
      ：
      <pre><code class="prism language-plaintext">| Header | buffer_id | in_port | actions | data（完整数据包，若buffer_id为-1） |
</code></pre>
      <ul>
       <li>
        <strong>
         作用
        </strong>
        ：指示交换机将缓存的数据包（通过
        <code>
         buffer_id
        </code>
        ）从指定端口转发。
       </li>
      </ul>
     </li>
    </ul>
    <hr/>
    <h4>
     <a id="_84">
     </a>
     <strong>
      三、协议交互流程图
     </strong>
    </h4>
    <pre><code class="prism language-plaintext">交换机                         控制器
 |                               |
 | ---- TCP Connect ------------&gt;|    建立TCP连接
 | &lt;---- OFPT_HELLO ------------ |    版本协商
 | ---- OFPT_HELLO ------------&gt; |
 |                               |
 | &lt;--- OFPT_FEATURES_REQUEST -- |    请求交换机能力
 | ---- OFPT_FEATURES_REPLY ---&gt; |
 |                               |
 | &lt;--- OFPT_SET_CONFIG -------- |    配置交换机参数
 |                               |
 | ==== 初始化完成，进入运行状态 ====|
 |                               |
 | ---- OFPT_PACKET_IN --------&gt; |    数据包无匹配流表
 | &lt;--- OFPT_FLOW_MOD ---------- |    下发新流表
 | &lt;--- OFPT_PACKET_OUT -------- |    转发缓存数据包
 |                               |
</code></pre>
    <hr/>
    <h4>
     <a id="_107">
     </a>
     <strong>
      四、设计逻辑与关键机制
     </strong>
    </h4>
    <ol>
     <li>
      <p>
       <strong>
        状态分离
       </strong>
       ：
      </p>
      <ul>
       <li>
        <strong>
         控制平面
        </strong>
        ：控制器维护全局网络视图（如拓扑、流表）。
       </li>
       <li>
        <strong>
         数据平面
        </strong>
        ：交换机仅负责高速转发，依赖流表匹配。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        异步事件驱动
       </strong>
       ：
      </p>
      <ul>
       <li>
        控制器通过事件（如
        <code>
         Packet-In
        </code>
        、
        <code>
         Port-Status
        </code>
        ）感知网络变化。
       </li>
       <li>
        交换机通过
        <code>
         Flow-Mod
        </code>
        被动接收流表更新。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        性能优化
       </strong>
       ：
      </p>
      <ul>
       <li>
        <strong>
         Buffer ID
        </strong>
        ：减少重复数据传输，提升效率。
       </li>
       <li>
        <strong>
         流表优先级
        </strong>
        ：高优先级流表优先匹配，支持复杂策略叠加。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        容错与安全
       </strong>
       ：
      </p>
      <ul>
       <li>
        <strong>
         Echo Request/Reply
        </strong>
        （类型2/3）：用于心跳检测连接存活。
       </li>
       <li>
        <strong>
         TLS加密
        </strong>
        ：防止中间人攻击（需预配置证书）。
       </li>
      </ul>
     </li>
    </ol>
    <hr/>
    <h4>
     <a id="OpenFlow_13__126">
     </a>
     <strong>
      五、OpenFlow 1.3 报文示例
     </strong>
    </h4>
    <h5>
     <a id="1_OFPT_HELLO__127">
     </a>
     <strong>
      1.
      <code>
       OFPT_HELLO
      </code>
      消息（简略格式）
     </strong>
    </h5>
    <pre><code class="prism language-plaintext">| version (0x04) | type (0) | length | xid | elements (版本列表) |
</code></pre>
    <ul>
     <li>
      <code>
       version=0x04
      </code>
      ：表示OpenFlow 1.3。
     </li>
    </ul>
    <h5>
     <a id="2_OFPT_PACKET_IN__133">
     </a>
     <strong>
      2.
      <code>
       OFPT_PACKET_IN
      </code>
      消息（简略格式）
     </strong>
    </h5>
    <pre><code class="prism language-plaintext">| version | type (10) | length | xid | buffer_id | total_len | reason | table_id | match | data |
</code></pre>
    <hr/>
    <h4>
     <a id="_140">
     </a>
     <strong>
      六、总结
     </strong>
    </h4>
    <p>
     OpenFlow协议通过严格的
     <strong>
      请求-响应模型
     </strong>
     和
     <strong>
      事件驱动机制
     </strong>
     ，实现了SDN控制器与交换机的高效协作。其设计核心是：
    </p>
    <ul>
     <li>
      <strong>
       控制集中化
      </strong>
      ：控制器掌握全局网络状态。
     </li>
     <li>
      <strong>
       数据平面可编程
      </strong>
      ：通过动态流表实现灵活转发。
      <br/>
      理解这些协议细节，有助于优化SDN应用性能（如减少
      <code>
       Packet-In
      </code>
      频率）和调试网络问题（如流表冲突）。
     </li>
    </ul>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f72656e6368616f373036302f:61727469636c652f64657461696c732f313435373530323837" class_="artid" style="display:none">
 </p>
</div>


