---
layout: post
title: "C20-中-stdmake_shared-的数组支持深入解析与实践"
date: 2025-03-16 00:00:00 +0800
description: "C++20 对的增强使其能够直接支持数组的创建和管理，这不仅简化了代码，还提高了内存管理的安全性和效率。通过本文的介绍，希望你能够更好地理解和使用这一特性，写出更优雅、更安全的现代 C++ 代码。"
keywords: "C++20 中 `std::make_shared` 的数组支持：深入解析与实践"
categories: ['C']
tags: ['算法', 'C']
artid: "146278803"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146278803
    alt: "C20-中-stdmake_shared-的数组支持深入解析与实践"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146278803
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146278803
cover: https://bing.ee123.net/img/rand?artid=146278803
image: https://bing.ee123.net/img/rand?artid=146278803
img: https://bing.ee123.net/img/rand?artid=146278803
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     C++20 中 `std::make_shared` 的数组支持：深入解析与实践
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/img_convert/a2bc6722be21401bd3a72b95113288e4.png"/>
    </p>
    <p>
    </p>
    <p>
    </p>
    <h5>
     <a id="_3">
     </a>
     引言
    </h5>
    <p>
     C++20 对
     <code>
      std::make_shared
     </code>
     的增强是现代 C++ 内存管理的一个重要进步。在 C++20 之前，
     <code>
      std::make_shared
     </code>
     仅支持单个对象的创建，而数组的管理需要借助
     <code>
      std::unique_ptr
     </code>
     或手动管理
     <code>
      new[]
     </code>
     和
     <code>
      delete[]
     </code>
     。C++20 的更新填补了这一空白，使得
     <code>
      std::make_shared
     </code>
     能够直接支持数组的创建和管理。
    </p>
    <p>
     本文将深入探讨
     <code>
      std::make_shared
     </code>
     在 C++20 中对数组的支持，包括其语法、用法、性能优势以及最佳实践。
    </p>
    <hr/>
    <h4>
     <a id="1__11">
     </a>
     1. 背景与动机
    </h4>
    <h5>
     <a id="11__stdmake_shared__13">
     </a>
     1.1 回顾
     <code>
      std::make_shared
     </code>
     的演变
    </h5>
    <p>
     <code>
      std::make_shared
     </code>
     是 C++11 引入的一个高效工具，用于创建
     <code>
      std::shared_ptr
     </code>
     。它通过一次内存分配同时创建对象和控制块，减少了内存分配的开销并提高了缓存友好性。然而，C++11 和 C++14 中的
     <code>
      std::make_shared
     </code>
     不支持数组的直接创建，这限制了其在某些场景中的应用。
    </p>
    <h5>
     <a id="12__17">
     </a>
     1.2 为什么需要支持数组
    </h5>
    <p>
     在实际开发中，数组是常见的数据结构，尤其是在处理批量数据（如图像处理、科学计算等）时。支持数组的
     <code>
      std::make_shared
     </code>
     可以简化代码，减少手动管理内存的复杂性，并提供更安全的生命周期管理。
    </p>
    <hr/>
    <h4>
     <a id="2_C20__stdmake_shared__23">
     </a>
     2. C++20 中
     <code>
      std::make_shared
     </code>
     的数组支持
    </h4>
    <h5>
     <a id="21__25">
     </a>
     2.1 基本语法
    </h5>
    <p>
     C++20 扩展了
     <code>
      std::make_shared
     </code>
     的功能，使其能够支持数组的创建。以下是支持数组的
     <code>
      std::make_shared
     </code>
     的几种用法：
    </p>
    <ol>
     <li>
      <p>
       <strong>
        动态数组
       </strong>
       ：
      </p>
      <pre><code class="prism language-cpp"><span class="token keyword">auto</span> arrPtr <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
      <p>
       这会创建一个动态大小的数组，
       <code>
        size
       </code>
       表示数组的元素个数。
      </p>
     </li>
     <li>
      <p>
       <strong>
        固定大小数组
       </strong>
       ：
      </p>
      <pre><code class="prism language-cpp"><span class="token keyword">auto</span> arrPtr <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
      <p>
       这会创建一个固定大小的数组，大小在编译时确定。
      </p>
     </li>
     <li>
      <p>
       <strong>
        带初始化值的数组
       </strong>
       ：
      </p>
      <pre><code class="prism language-cpp"><span class="token keyword">auto</span> arrPtr <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> initialValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
      <p>
       这会创建一个动态数组，并将所有元素初始化为
       <code>
        initialValue
       </code>
       。
      </p>
     </li>
    </ol>
    <h5>
     <a id="22__47">
     </a>
     2.2 示例代码
    </h5>
    <p>
     以下是一个简单的示例，展示如何使用
     <code>
      std::make_shared
     </code>
     创建和管理数组：
    </p>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;memory&gt;</span></span>

<span class="token keyword">void</span> <span class="token function">processArray</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token operator">&amp;</span> arrPtr<span class="token punctuation">,</span> size_t size<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        arrPtr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>i <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> arrPtr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" "</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">auto</span> arrPtr <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 创建一个大小为 10 的动态数组</span>
    <span class="token function">processArray</span><span class="token punctuation">(</span>arrPtr<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     输出：
    </p>
    <pre><code>0 2 4 6 8 10 12 14 16 18
</code></pre>
    <p>
     在这个示例中，
     <code>
      arrPtr
     </code>
     是一个指向动态数组的智能指针，其生命周期由
     <code>
      std::shared_ptr
     </code>
     管理。
    </p>
    <hr/>
    <h4>
     <a id="3__81">
     </a>
     3. 性能与内存管理
    </h4>
    <p>
     <code>
      std::make_shared
     </code>
     的一个主要优势是其高效的内存管理。与传统的
     <code>
      new[]
     </code>
     和
     <code>
      std::shared_ptr
     </code>
     的组合相比，
     <code>
      std::make_shared
     </code>
     通过一次分配内存来存储对象和控制块，减少了内存碎片化。
    </p>
    <p>
     此外，
     <code>
      std::make_shared
     </code>
     对数组的支持也提供了自动的析构管理。当引用计数归零时，数组的所有元素会被自动销毁，避免了内存泄漏。
    </p>
    <hr/>
    <h4>
     <a id="4__89">
     </a>
     4. 最佳实践与注意事项
    </h4>
    <h5>
     <a id="41__91">
     </a>
     4.1 适用场景
    </h5>
    <ul>
     <li>
      <strong>
       批量数据处理
      </strong>
      ：需要创建和管理大量元素时，
      <code>
       std::make_shared
      </code>
      提供了简洁的解决方案。
     </li>
     <li>
      <strong>
       共享所有权
      </strong>
      ：当数组需要在多个模块或线程之间共享时，
      <code>
       std::shared_ptr
      </code>
      的引用计数机制非常有用。
     </li>
     <li>
      <strong>
       简化代码
      </strong>
      ：减少了手动管理数组生命周期的复杂性。
     </li>
    </ul>
    <h5>
     <a id="42__97">
     </a>
     4.2 不适用场景
    </h5>
    <ul>
     <li>
      <strong>
       极端性能要求
      </strong>
      ：在对性能要求极高的场景中（如嵌入式系统），
      <code>
       std::make_shared
      </code>
      的引用计数可能会带来额外开销。
     </li>
     <li>
      <strong>
       多维数组
      </strong>
      ：C++20 并不直接支持多维数组的创建，需要通过嵌套数组或容器来实现。
     </li>
    </ul>
    <h5>
     <a id="43__102">
     </a>
     4.3 注意事项
    </h5>
    <ul>
     <li>
      <strong>
       越界访问
      </strong>
      ：
      <code>
       std::shared_ptr&lt;int[]&gt;
      </code>
      不会自动检查数组越界，开发者需要确保索引合法。
     </li>
     <li>
      <strong>
       初始化限制
      </strong>
      ：目前
      <code>
       std::make_shared
      </code>
      不支持一次性初始化数组的所有元素，需要通过循环或其他方式赋值。
     </li>
    </ul>
    <hr/>
    <h4>
     <a id="5__109">
     </a>
     5. 未来展望
    </h4>
    <p>
     尽管 C++20 已经为
     <code>
      std::make_shared
     </code>
     提供了数组支持，但在多维数组和复杂初始化方面仍有改进空间。未来版本可能会引入更灵活的接口，支持多维数组和初始化列表。
    </p>
    <hr/>
    <h4>
     <a id="_115">
     </a>
     结语
    </h4>
    <p>
     C++20 对
     <code>
      std::make_shared
     </code>
     的增强使其能够直接支持数组的创建和管理，这不仅简化了代码，还提高了内存管理的安全性和效率。通过本文的介绍，希望你能够更好地理解和使用这一特性，写出更优雅、更安全的现代 C++ 代码。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
  <div class="blog-extension-box" id="blogExtensionBox" style="width:400px;margin:auto;margin-top:12px">
  </div>
 </article>
 <p alt="68747470733a2f2f:626c6f672e6373646e2e6e65742f5a5f6f696f69686f69692f:61727469636c652f64657461696c732f313436323738383033" class_="artid" style="display:none">
 </p>
</div>


