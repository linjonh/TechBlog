---
layout: post
title: "Linux-网络skb-数据管理"
date: 2025-03-11 20:05:19 +0800
description: "Linux，网络，skb"
keywords: "Linux 网络：skb 数据管理"
categories: ['网络']
tags: ['网络', 'Skb', 'Linux']
artid: "146035316"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146035316
    alt: "Linux-网络skb-数据管理"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146035316
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146035316
cover: https://bing.ee123.net/img/rand?artid=146035316
image: https://bing.ee123.net/img/rand?artid=146035316
img: https://bing.ee123.net/img/rand?artid=146035316
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Linux 网络：skb 数据管理
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <p>
    </p>
    <h2>
     <a id="1__2">
     </a>
     1. 前言
    </h2>
    <p>
     限于作者能力水平，本文可能存在谬误，因此而给读者带来的损失，作者不做任何承诺。
    </p>
    <h2>
     <a id="2_skb__6">
     </a>
     2. skb 数据管理
    </h2>
    <p>
     数据结构：
    </p>
    <pre><code class="prism language-c"><span class="token comment">/* include/linux/skbuff.h */</span>

<span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token comment">/*
	 * @len: sk_buff 包含的数据长度(sk_buff::tail - sk_buff::data). 
	 *       当在协议层间移动时, @len 会改变: 添加(往下层)或移除(往上层)
	 *		 操作接口 skb_reserve(), skb_put(), skb_push(), skb_pull()
	 */</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>		len<span class="token punctuation">,</span>
				data_len<span class="token comment">/* 仅用于分片场景下分片(fragment)数据的长度 */</span><span class="token punctuation">;</span>
	__u16			mac_len<span class="token comment">/* MAC 头部长度 */</span><span class="token punctuation">,</span>
				hdr_len<span class="token punctuation">;</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	__be16			protocol<span class="token punctuation">;</span> <span class="token comment">/* ETH_P_IP, ... */</span>
	__u16			transport_header<span class="token punctuation">;</span> <span class="token comment">/* 传输层数据偏移 */</span>
	__u16			network_header<span class="token punctuation">;</span> <span class="token comment">/* 网络层数据偏移 */</span>
	__u16			mac_header<span class="token punctuation">;</span> <span class="token comment">/* MAC/Linker 层数据偏移 */</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token comment">/* These elements must be at the end, see alloc_skb() for details.  */</span>
	<span class="token comment">/*
	 * head --&gt; -------------------
	 *         | reserved headroom |
	 * data --&gt;|-------------------|
	 *         |///|
	 *         |///|
	 * tail --&gt;|-------------------|
	 *         |      tailroom     |
	 * end  --&gt;|-------------------|
	 *         |  skb_shared_info  |
	 *         |-------------------|
	 *         |       PAD         |
	 *          -------------------
	 */</span>
	<span class="token class-name">sk_buff_data_t</span>		tail<span class="token punctuation">;</span> <span class="token comment">/* 偏移位置: 指向当前数据的尾部，随数据的添加、移除而改变 */</span>
	<span class="token class-name">sk_buff_data_t</span>		end<span class="token punctuation">;</span> <span class="token comment">/* 偏移位置: 可用数据空间的尾部。end 后还跟有 skb_shared_info */</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span>		<span class="token operator">*</span>head<span class="token punctuation">,</span> <span class="token comment">/* 数据指针: 指向可用数据空间数据头部 */</span>
						<span class="token operator">*</span>data<span class="token punctuation">;</span> <span class="token comment">/* 数据指针: 指向当前数据开始位置 */</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>		truesize<span class="token punctuation">;</span> <span class="token comment">/* sizeof(sk_buff) + size(数据空间大小) + sizeof(skb_shared_info), 由 alloc_skb() 初始化 */</span>
	<span class="token class-name">refcount_t</span>			users<span class="token punctuation">;</span> <span class="token comment">/* sk_buff 引用计数. skb_get(), kfree_skb() 接口影响 */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <h3>
     <a id="21__54">
     </a>
     2.1 初始化
    </h3>
    <p>
     创建
     <code>
      skb
     </code>
     时的初始化：
    </p>
    <pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span>skb<span class="token punctuation">;</span>
<span class="token keyword">int</span> frame_len<span class="token punctuation">;</span> <span class="token comment">/* 网卡接收的数据帧长度 */</span>

frame_len <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
skb <span class="token operator">=</span> <span class="token function">netdev_alloc_skb_ip_align</span><span class="token punctuation">(</span>priv<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> frame_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <pre><code class="prism language-c"><span class="token comment">/* include/linux/skbuff.h */</span>

<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span><span class="token function">netdev_alloc_skb_ip_align</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">net_device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span>
		<span class="token keyword">unsigned</span> <span class="token keyword">int</span> length<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token function">__netdev_alloc_skb_ip_align</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> length<span class="token punctuation">,</span> GFP_ATOMIC<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span><span class="token function">__netdev_alloc_skb_ip_align</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">net_device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span>
		<span class="token keyword">unsigned</span> <span class="token keyword">int</span> length<span class="token punctuation">,</span> <span class="token class-name">gfp_t</span> gfp<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span>skb <span class="token operator">=</span> <span class="token function">__netdev_alloc_skb</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> length <span class="token operator">+</span> NET_IP_ALIGN<span class="token punctuation">,</span> gfp<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>NET_IP_ALIGN <span class="token operator">&amp;&amp;</span> skb<span class="token punctuation">)</span>
		<span class="token function">skb_reserve</span><span class="token punctuation">(</span>skb<span class="token punctuation">,</span> NET_IP_ALIGN<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 在数据头部保留部分空间 */</span>
	<span class="token keyword">return</span> skb<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <pre><code class="prism language-c"><span class="token comment">/* net/core/skbuff.c */</span>

<span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span><span class="token function">__netdev_alloc_skb</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">net_device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> len<span class="token punctuation">,</span>
				   <span class="token class-name">gfp_t</span> gfp_mask<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">page_frag_cache</span> <span class="token operator">*</span>nc<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> flags<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span>skb<span class="token punctuation">;</span>
	bool pfmemalloc<span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">;</span>

	<span class="token comment">/*
	 * 数据长度对齐：
	 * 没有特别定义 NET_SKB_PAD 时，是对齐到 cache 行。
	 */</span>
	len <span class="token operator">+=</span> NET_SKB_PAD<span class="token punctuation">;</span>

	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

	<span class="token comment">/* skb_shared_info 包含在 skb 的数据(长度)内 */</span>
	len <span class="token operator">+=</span> <span class="token function">SKB_DATA_ALIGN</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">skb_shared_info</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
	len <span class="token operator">=</span> <span class="token function">SKB_DATA_ALIGN</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	data <span class="token operator">=</span> <span class="token function">page_frag_alloc</span><span class="token punctuation">(</span>nc<span class="token punctuation">,</span> len<span class="token punctuation">,</span> gfp_mask<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 分配 @len 数据空间 */</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

	skb <span class="token operator">=</span> <span class="token function">__build_skb</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 用 @len 长度数据 @data 构建 skb */</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

skb_success<span class="token operator">:</span>
	<span class="token function">skb_reserve</span><span class="token punctuation">(</span>skb<span class="token punctuation">,</span> NET_SKB_PAD<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 在数据头部保留部分空间 */</span>
	skb<span class="token operator">-&gt;</span>dev <span class="token operator">=</span> dev<span class="token punctuation">;</span> <span class="token comment">/* 设定 skb 的 所属的 网卡设备对象 */</span>

skb_fail<span class="token operator">:</span>
	<span class="token keyword">return</span> skb<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span><span class="token function">__build_skb</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> frag_size<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">skb_shared_info</span> <span class="token operator">*</span>shinfo<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span>skb<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> size <span class="token operator">=</span> frag_size <span class="token operator">?</span> <span class="token operator">:</span> <span class="token function">ksize</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* 创建 skb 对象 */</span>
	skb <span class="token operator">=</span> <span class="token function">kmem_cache_alloc</span><span class="token punctuation">(</span>skbuff_head_cache<span class="token punctuation">,</span> GFP_ATOMIC<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

	size <span class="token operator">-=</span> <span class="token function">SKB_DATA_ALIGN</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">skb_shared_info</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">memset</span><span class="token punctuation">(</span>skb<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">offsetof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sk_buff</span><span class="token punctuation">,</span> tail<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* skb-&gt;tail 之前的所有成员清 0 */</span>
	skb<span class="token operator">-&gt;</span>truesize <span class="token operator">=</span> <span class="token function">SKB_TRUESIZE</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">refcount_set</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>skb<span class="token operator">-&gt;</span>users<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	skb<span class="token operator">-&gt;</span>head <span class="token operator">=</span> data<span class="token punctuation">;</span>
	skb<span class="token operator">-&gt;</span>data <span class="token operator">=</span> data<span class="token punctuation">;</span>
	<span class="token function">skb_reset_tail_pointer</span><span class="token punctuation">(</span>skb<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 初始化 tail: 指向数据开始的偏移位置，即 skb-&gt;data 所在的偏移位置 */</span>
	skb<span class="token operator">-&gt;</span>end <span class="token operator">=</span> skb<span class="token operator">-&gt;</span>tail <span class="token operator">+</span> size<span class="token punctuation">;</span>
	skb<span class="token operator">-&gt;</span>mac_header <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>skb<span class="token operator">-&gt;</span>mac_header<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">~</span><span class="token number">0U</span><span class="token punctuation">;</span>
	skb<span class="token operator">-&gt;</span>transport_header <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>skb<span class="token operator">-&gt;</span>transport_header<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">~</span><span class="token number">0U</span><span class="token punctuation">;</span>

	<span class="token comment">/* make sure we initialize shinfo sequentially */</span>
	shinfo <span class="token operator">=</span> <span class="token function">skb_shinfo</span><span class="token punctuation">(</span>skb<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">memset</span><span class="token punctuation">(</span>shinfo<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">offsetof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">skb_shared_info</span><span class="token punctuation">,</span> dataref<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">atomic_set</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>shinfo<span class="token operator">-&gt;</span>dataref<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> skb<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     我们用一张图来描述
     <code>
      skb
     </code>
     的初始状态：
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/d69982e4a28b462e906eaab40937ab76.png"/>
    </p>
    <p>
     <code>
      skb
     </code>
     数据管理，主要依靠
     <code>
      tail, end, head, data
     </code>
     这几个成员。从图中可见，在初始时：
    </p>
    <pre><code class="prism language-bash">head: 指向数据的开始位置。
data: 指向可用数据的开始位置，跳过了头部保留空间。
tail: 当前已填充数据的结尾位置偏移。
end: 数据可用空间结尾位置偏移。
</code></pre>
    <h3>
     <a id="22__169">
     </a>
     2.2 数据的插入
    </h3>
    <p>
     数据插入位置可以是
     <code>
      头部
     </code>
     和
     <code>
      尾部
     </code>
     。
    </p>
    <h4>
     <a id="221__173">
     </a>
     2.2.1 在头部插入数据
    </h4>
    <p>
     在
     <code>
      头部
     </code>
     插入数据，首先通过
     <code>
      *skb_push()
     </code>
     系列 API 按插入数据长度移动数据位置指针，然后执行数据拷贝。
    </p>
    <p>
     如进行
     <code>
      IP 数据分片
     </code>
     时：
    </p>
    <pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">ip_do_fragment</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">net</span> <span class="token operator">*</span>net<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sock</span> <span class="token operator">*</span>sk<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span>skb<span class="token punctuation">,</span>
		   <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>output<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">net</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sock</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token function">skb_reset_transport_header</span><span class="token punctuation">(</span>frag<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 设置 传输层 数据偏移位置 */</span>
	<span class="token function">__skb_push</span><span class="token punctuation">(</span>frag<span class="token punctuation">,</span> hlen<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 往后移动数据指针，在头部为 网络层协议头(L3) 划分一部分空间 */</span>
	<span class="token function">skb_reset_network_header</span><span class="token punctuation">(</span>frag<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 设置 网络层 数据偏移位置 */</span>
	<span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token function">skb_network_header</span><span class="token punctuation">(</span>frag<span class="token punctuation">)</span><span class="token punctuation">,</span> iph<span class="token punctuation">,</span> hlen<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 在 头部 插入 网络层 数据 */</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre>
    <pre><code class="prism language-c"><span class="token comment">/* include/linux/skbuff.h */</span>

<span class="token comment">/* 设置 传输层(L4) TCP/UDP 头部数据偏移位置 */</span>
<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">skb_reset_transport_header</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span>skb<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	skb<span class="token operator">-&gt;</span>transport_header <span class="token operator">=</span> skb<span class="token operator">-&gt;</span>data <span class="token operator">-</span> skb<span class="token operator">-&gt;</span>head<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * 从头部增加 @len 长度数据后调用: 
 * . skb-&gt;data 后退 @len 个位置 (skb-&gt;data -= len)
 * . skb-&gt;len 增大 @len
 */</span>
<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">skb_push</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span>skb<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">__skb_push</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span>skb<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	skb<span class="token operator">-&gt;</span>data <span class="token operator">-=</span> len<span class="token punctuation">;</span>
	skb<span class="token operator">-&gt;</span>len  <span class="token operator">+=</span> len<span class="token punctuation">;</span>
	<span class="token keyword">return</span> skb<span class="token operator">-&gt;</span>data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* 设置 网络层(L3) IP 头部数据偏移位置 */</span>
<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">skb_reset_network_header</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span>skb<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	skb<span class="token operator">-&gt;</span>network_header <span class="token operator">=</span> skb<span class="token operator">-&gt;</span>data <span class="token operator">-</span> skb<span class="token operator">-&gt;</span>head<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* 返回 网络层 (L3) IP 头部位置 (struct ip_header *) */</span>
<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">skb_network_header</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span>skb<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> skb<span class="token operator">-&gt;</span>head <span class="token operator">+</span> skb<span class="token operator">-&gt;</span>network_header<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     从这里的示例代码可以看到，在
     <code>
      头部
     </code>
     插入数据，分为两步：
    </p>
    <pre><code class="prism language-bash"><span class="token number">1</span>. 通过 __skb_push<span class="token punctuation">(</span><span class="token punctuation">)</span> 移动数据指针
<span class="token number">2</span>. 然后再将数据拷贝到指定位置
</code></pre>
    <p>
     可见，
     <code>
      *skb_push()
     </code>
     系列 API 只会移动数据指针，并不会做数据拷贝操作。
    </p>
    <h4>
     <a id="222__236">
     </a>
     2.2.2 在尾部插入数据
    </h4>
    <p>
     在
     <code>
      尾部
     </code>
     插入数据，首先执行数据拷贝，然后通过
     <code>
      *skb_put()
     </code>
     系列 API 按拷贝的数据长度移动
     <code>
      skb
     </code>
     数据位置指针。
    </p>
    <p>
     如网卡接收数据时：
    </p>
    <pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">stmmac_rx</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">stmmac_priv</span> <span class="token operator">*</span>priv<span class="token punctuation">,</span> <span class="token keyword">int</span> limit<span class="token punctuation">,</span> u32 queue<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token comment">/* 分配 skb 缓冲（细节见前面分析） */</span>     
	skb <span class="token operator">=</span> <span class="token function">netdev_alloc_skb_ip_align</span><span class="token punctuation">(</span>priv<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> frame_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/* 拷贝接收的数据(RING BUFFE 中的数据)到 skb 缓冲 */</span>
	<span class="token function">skb_copy_to_linear_data</span><span class="token punctuation">(</span>skb<span class="token punctuation">,</span>
							rx_q<span class="token operator">-&gt;</span>rx_skbuff<span class="token punctuation">[</span>entry<span class="token punctuation">]</span><span class="token operator">-&gt;</span>data<span class="token punctuation">,</span>
							frame_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">skb_put</span><span class="token punctuation">(</span>skb<span class="token punctuation">,</span> frame_len<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 移动数据指针 */</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre>
    <pre><code class="prism language-c"><span class="token comment">/* include/linux/skbuff.h */</span>

<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">skb_copy_to_linear_data</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span>skb<span class="token punctuation">,</span>
					   <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>from<span class="token punctuation">,</span>
					   <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">memcpy</span><span class="token punctuation">(</span>skb<span class="token operator">-&gt;</span>data<span class="token punctuation">,</span> from<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">NET_SKBUFF_DATA_USES_OFFSET</span></span>
<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">skb_tail_pointer</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span>skb<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> skb<span class="token operator">-&gt;</span>head <span class="token operator">+</span> skb<span class="token operator">-&gt;</span>tail<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">skb_reset_tail_pointer</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span>skb<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	skb<span class="token operator">-&gt;</span>tail <span class="token operator">=</span> skb<span class="token operator">-&gt;</span>data <span class="token operator">-</span> skb<span class="token operator">-&gt;</span>head<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">skb_set_tail_pointer</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span>skb<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">int</span> offset<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">skb_reset_tail_pointer</span><span class="token punctuation">(</span>skb<span class="token punctuation">)</span><span class="token punctuation">;</span>
	skb<span class="token operator">-&gt;</span>tail <span class="token operator">+=</span> offset<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span> <span class="token comment">/* NET_SKBUFF_DATA_USES_OFFSET */</span></span>
<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">skb_tail_pointer</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span>skb<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> skb<span class="token operator">-&gt;</span>tail<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">skb_reset_tail_pointer</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span>skb<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	skb<span class="token operator">-&gt;</span>tail <span class="token operator">=</span> skb<span class="token operator">-&gt;</span>data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">skb_set_tail_pointer</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span>skb<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">int</span> offset<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	skb<span class="token operator">-&gt;</span>tail <span class="token operator">=</span> skb<span class="token operator">-&gt;</span>data <span class="token operator">+</span> offset<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* NET_SKBUFF_DATA_USES_OFFSET */</span></span>
</code></pre>
    <pre><code class="prism language-c"><span class="token comment">/* net/core/skbuff.c */</span>

<span class="token comment">/*
 * 增加数据长度，在【尾部】增加数据时使用: 
 * . 前进数据【尾部偏移】 skb-&gt;tail += len
 * . 增大数据长度 skb-&gt;len += len
 * 返回: 数据旧的尾部位置数据指针。
 */</span>
<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">skb_put</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span>skb<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">void</span> <span class="token operator">*</span>tmp <span class="token operator">=</span> <span class="token function">skb_tail_pointer</span><span class="token punctuation">(</span>skb<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">SKB_LINEAR_ASSERT</span><span class="token punctuation">(</span>skb<span class="token punctuation">)</span><span class="token punctuation">;</span>
	skb<span class="token operator">-&gt;</span>tail <span class="token operator">+=</span> len<span class="token punctuation">;</span>
	skb<span class="token operator">-&gt;</span>len  <span class="token operator">+=</span> len<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span>skb<span class="token operator">-&gt;</span>tail <span class="token operator">&gt;</span> skb<span class="token operator">-&gt;</span>end<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">/* 超出了数据尾部空间 */</span>
		<span class="token function">skb_over_panic</span><span class="token punctuation">(</span>skb<span class="token punctuation">,</span> len<span class="token punctuation">,</span> <span class="token function">__builtin_return_address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> tmp<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">EXPORT_SYMBOL</span><span class="token punctuation">(</span>skb_put<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <h3>
     <a id="22__325">
     </a>
     2.2 数据的移除
    </h3>
    <p>
     处于效率的考虑，
     <code>
      skb
     </code>
     数据的移除，并不是真的移除，而是仅仅移动数据指针位置。通过
     <code>
      *skb_pull()
     </code>
     系列 API 执行数据的移除：
    </p>
    <pre><code class="prism language-c"><span class="token comment">/* net/core/skbuff.c */</span>

<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">skb_pull</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span>skb<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token function">skb_pull_inline</span><span class="token punctuation">(</span>skb<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">EXPORT_SYMBOL</span><span class="token punctuation">(</span>skb_pull<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <pre><code class="prism language-c"><span class="token comment">/* include/linux/skbuff.h */</span>

<span class="token comment">/*
 * 从头部拉取 @len 长度数据后调用: 
 * . skb-&gt;data 前进 @len 个位置 (skb-&gt;data += len)
 * . skb-&gt;len 减小 @len
 */</span>
<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">skb_pull_inline</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span>skb<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token function">unlikely</span><span class="token punctuation">(</span>len <span class="token operator">&gt;</span> skb<span class="token operator">-&gt;</span>len<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token constant">NULL</span> <span class="token operator">:</span> <span class="token function">__skb_pull</span><span class="token punctuation">(</span>skb<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * 从头部拉取 @len 长度数据后调用: 
 * . skb-&gt;data 前进 @len 个位置 (skb-&gt;data += len)
 * . skb-&gt;len 减小 @len
 */</span>
<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">skb_pull</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span>skb<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">__skb_pull</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span>skb<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	skb<span class="token operator">-&gt;</span>len <span class="token operator">-=</span> len<span class="token punctuation">;</span>
	<span class="token function">BUG_ON</span><span class="token punctuation">(</span>skb<span class="token operator">-&gt;</span>len <span class="token operator">&lt;</span> skb<span class="token operator">-&gt;</span>data_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> skb<span class="token operator">-&gt;</span>data <span class="token operator">+=</span> len<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h2>
     <a id="3__366">
     </a>
     3. 小结
    </h2>
    <p>
     本文简答的对
     <code>
      skb
     </code>
     数据管理的最基本情形 -
     <code>
      线性数据的插入删除
     </code>
     - 做了描述，事实上，
     <code>
      skb
     </code>
     的数据的管理，远比这个要更复杂，譬如 IP 分片的
     <code>
      非线性数据管理
     </code>
     、
     <code>
      skb_shared_info
     </code>
     的管理等等，以后有机会再和大家一起探讨。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e63:73646e2e6e65742f4a694d6f4b75616e675869616e6751752f:61727469636c652f64657461696c732f313436303335333136" class_="artid" style="display:none">
 </p>
</div>


